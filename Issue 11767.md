# Issue 11767: Notebook "ulimit -v" does not work

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-10-18 10:22:46

Assignee: jason, mpatel, was

CC:  chapoton

The `ulimit -v` argument does not do anything at all (I have not tested other options), neither locally nor remote.  Both commands

```
notebook(ulimit="-v 1")
```

and

```
notebook(server_pool=["jdemeyer`@`localhost"], ulimit="-v 1")
```

don't seem to put any limit.


---

Comment by ppurka created at 2011-10-18 12:35:57

I looked at the code couple of months ago and what it does is baffling. It parses all the parameters and then recombines them and tries to call ulimit. No idea why it does so.

In my opinion, setting ulimit should be an argument to `SAGE_ROOT/sage`, i.e., `SAGE_ROOT/local/bin/sage-sage`. Then ulimit should be set by running `ulimit <along with the options passed without parsing them>` and then Sage or the Sage notebook should be launched. Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.


---

Comment by jdemeyer created at 2011-10-18 13:43:31

Replying to [comment:2 ppurka]:
> Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.

This is not true for remote notebook workers, so we need something more clever.


---

Comment by leif created at 2011-10-18 13:46:54

It seems at least _your example_ (`-v 1`) yields a zero limit, since the value is first divided by `1000.0`, then gets converted back to an `int`, and *afterwards* gets multiplied by `1000` again.


---

Comment by ppurka created at 2011-10-18 13:52:47

Even with all the conversions, I am pretty sure ulimit does not work. That's what brought down our servers on the first day of classes. Everyone had -v set to 2G and yet the Sage process of one person was allowed to run up 20G+ of memory, eating up all the available ram and swap.


---

Comment by leif created at 2011-10-18 13:55:59

You may try this (haven't tested the notebook at all):

```diff
diff --git a/sagenb/interfaces/expect.py b/sagenb/interfaces/expect.py
--- a/sagenb/interfaces/expect.py
+++ b/sagenb/interfaces/expect.py
`@``@` -47,7 +47,7 `@``@`
         if process_limits:
             u = ''
             if process_limits.max_vmem is not None:
-                u += ' -v %s'%(int(process_limits.max_vmem)*1000)
+                u += ' -v %s'%(int(process_limits.max_vmem*1000))
             if process_limits.max_cputime is not None:
                 u += ' -t %s'%(int(process_limits.max_cputime))
             if process_limits.max_processes is not None:
```



---

Comment by ppurka created at 2011-10-18 13:57:50

Oh, also you can check whether ulimit is set by running this from a worksheet:

```
import os
os.system("ulimit -a")
```



---

Comment by leif created at 2011-10-18 15:07:36

*Hahahahaha!!!1! *


```python

    def command(self):
        return self._python
        # TODO: The following simply doesn't work -- this is not a valid way to run
        # ulimited.  Also we should check if ulimit is available before even
        # doing this.   
        return '&&'.join([x for x in [self._ulimit, self._python] if x])

```

(This is `WorksheetProcess_ExpectImplementation.command()`.)


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by novoselt created at 2013-01-21 18:25:52

In my experience the only working way to set limits is to edit the sage script to call ulimit if the username is "Sage worker". It is quite annoying to remember to do it between upgrades and in any case this is not what the documentation tells us to do...


---

Comment by kcrisman created at 2014-09-18 02:51:29

See https://github.com/sagemath/sagenb/issues/235


---

Comment by mkoeppe created at 2020-08-18 00:36:52

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-08-18 00:36:52

Proposing to close all sagenb tickets as outdated, so that all remaining open tickets in the notebook component are about the Jupyter notebook.


---

Comment by chapoton created at 2020-08-19 08:59:08

Resolution: invalid
