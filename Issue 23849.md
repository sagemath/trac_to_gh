# Issue 23849: Atkin-Lehner normalisation issue

archive/issues_023849.json:
```json
{
    "body": "Keywords: atkin-lehner\n\nThis ticket is a follow-up to #18061, concerning Atkin--Lehner actions.\n\nAccording to the docstring of `sage.modular.modform.element.ModularForm_abstract.atkin_lehner_action`, our conventions are supposed to be that the pseudo-eigenvalues of the Atkin--Lehner operator W_d should have absolute value d<sup>k/2</sup> - 1. However, it doesn't seem that this convention is being enforced very consistently:\n\n```\nsage: f = Newforms(24, 4)[0]\nsage: f\nq + 3*q^3 + 14*q^5 + O(q^6)\nsage: f.atkin_lehner_eigenvalue(8)\n-1\nsage: f.atkin_lehner_eigenvalue(3)\n-3\n```\n\n\nThe problem seems to be this:\n\n```\nsage: f._atkin_lehner_action_from_qexp(3)\n(-3, q + 3*q^3 + 14*q^5 + O(q^6))\nsage: f._atkin_lehner_action_from_modsym(3)\n(-1, q + 3*q^3 + 14*q^5 + O(q^6))\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24086\n\n",
    "created_at": "2017-10-22T12:17:59Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Atkin-Lehner normalisation issue",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23849",
    "user": "@loefflerd"
}
```
Keywords: atkin-lehner

This ticket is a follow-up to #18061, concerning Atkin--Lehner actions.

According to the docstring of `sage.modular.modform.element.ModularForm_abstract.atkin_lehner_action`, our conventions are supposed to be that the pseudo-eigenvalues of the Atkin--Lehner operator W_d should have absolute value d<sup>k/2</sup> - 1. However, it doesn't seem that this convention is being enforced very consistently:

```
sage: f = Newforms(24, 4)[0]
sage: f
q + 3*q^3 + 14*q^5 + O(q^6)
sage: f.atkin_lehner_eigenvalue(8)
-1
sage: f.atkin_lehner_eigenvalue(3)
-3
```


The problem seems to be this:

```
sage: f._atkin_lehner_action_from_qexp(3)
(-3, q + 3*q^3 + 14*q^5 + O(q^6))
sage: f._atkin_lehner_action_from_modsym(3)
(-1, q + 3*q^3 + 14*q^5 + O(q^6))
```


Issue created by migration from https://trac.sagemath.org/ticket/24086





---

archive/issue_comments_334192.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-23T14:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334192",
    "user": "@loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334193.json:
```json
{
    "body": "Here's a patch. As well as fixing the normalisation issue, I've readjusted our conventions to be more consistent with the standard reference (Atkin--Li 1978) -- the previous version was out by a root of unity in some cases -- and added some more examples and doctests.\n----\nNew commits:",
    "created_at": "2017-10-23T14:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334193",
    "user": "@loefflerd"
}
```

Here's a patch. As well as fixing the normalisation issue, I've readjusted our conventions to be more consistent with the standard reference (Atkin--Li 1978) -- the previous version was out by a root of unity in some cases -- and added some more examples and doctests.
----
New commits:



---

archive/issue_comments_334194.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-23T20:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334194",
    "user": "@adeines"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_334195.json:
```json
{
    "body": "This is a small thing, in src/sage/modular/modsym/ambient.py in documentation for the method _compute_atkin_lehner_matrix, there should be an example where the sign isn't 0 so that it hits the ValueError.\n\nThe rest looks good so far.",
    "created_at": "2017-10-23T20:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334195",
    "user": "@adeines"
}
```

This is a small thing, in src/sage/modular/modsym/ambient.py in documentation for the method _compute_atkin_lehner_matrix, there should be an example where the sign isn't 0 so that it hits the ValueError.

The rest looks good so far.



---

archive/issue_comments_334196.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-24T08:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334196",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334197.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-24T08:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334197",
    "user": "@loefflerd"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_334198.json:
```json
{
    "body": "Good point. I've added a doctest for this case (and another one for a GammaH level, since there weren't any of these before).",
    "created_at": "2017-10-24T08:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334198",
    "user": "@loefflerd"
}
```

Good point. I've added a doctest for this case (and another one for a GammaH level, since there weren't any of these before).



---

archive/issue_comments_334199.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-24T09:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334199",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334200.json:
```json
{
    "body": "The last commit is just a tiny ReST formatting fix (to correct an error picked up by the patchbot)",
    "created_at": "2017-10-24T09:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334200",
    "user": "@loefflerd"
}
```

The last commit is just a tiny ReST formatting fix (to correct an error picked up by the patchbot)



---

archive/issue_comments_334201.json:
```json
{
    "body": "Hold it, there's a doctest failing.",
    "created_at": "2017-10-24T09:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334201",
    "user": "@loefflerd"
}
```

Hold it, there's a doctest failing.



---

archive/issue_comments_334202.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-24T09:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334202",
    "user": "@loefflerd"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_334203.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-24T15:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334203",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334204.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-24T15:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334204",
    "user": "@loefflerd"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_334205.json:
```json
{
    "body": "That was embarrassing: I broke the test case from #18061 (which I reported initially -- oops!). This was an issue with determining when the AL eigenvalue exists in `atkin_lehner_eigenvalue` -- we need to determine when it doesn't exist, and raise an error in that case, without needing to fix the choices of embedding needed for more general pseudo-eigenvalues. (I also adjusted the test case to make it run quicker, and removed the ` #\u00a0long time` flag.)\n\nI've also moved `atkin_lehner_action` out of the abstract modular form element class into the Newform class; eigenvalues make sense for any form, but pseudo-eigenvalues only for newforms.",
    "created_at": "2017-10-24T15:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334205",
    "user": "@loefflerd"
}
```

That was embarrassing: I broke the test case from #18061 (which I reported initially -- oops!). This was an issue with determining when the AL eigenvalue exists in `atkin_lehner_eigenvalue` -- we need to determine when it doesn't exist, and raise an error in that case, without needing to fix the choices of embedding needed for more general pseudo-eigenvalues. (I also adjusted the test case to make it run quicker, and removed the ` # long time` flag.)

I've also moved `atkin_lehner_action` out of the abstract modular form element class into the Newform class; eigenvalues make sense for any form, but pseudo-eigenvalues only for newforms.



---

archive/issue_comments_334206.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-24T20:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334206",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334207.json:
```json
{
    "body": "I'm uploading a new, completely rewritten branch, which sorts out the normalisations so they're consistent with Atkin-Li, and also covers all the previously non-implemented cases using a trick based on twisting maps for modular symbols.\n----\nNew commits:",
    "created_at": "2018-05-01T11:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334207",
    "user": "@loefflerd"
}
```

I'm uploading a new, completely rewritten branch, which sorts out the normalisations so they're consistent with Atkin-Li, and also covers all the previously non-implemented cases using a trick based on twisting maps for modular symbols.
----
New commits:



---

archive/issue_comments_334208.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-05T07:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334208",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_334209.json:
```json
{
    "body": "2 failing doctests in \n\n```\nsage -t --long src/sage/modular/abvar/lseries.py \n```\n\nbecause of precision issues in L functions",
    "created_at": "2018-05-05T07:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334209",
    "user": "@fchapoton"
}
```

2 failing doctests in 

```
sage -t --long src/sage/modular/abvar/lseries.py 
```

because of precision issues in L functions



---

archive/issue_comments_334210.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-07T17:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334210",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334211.json:
```json
{
    "body": "This is just harmless fuzz. The discrepancies are all in the last one or two decimal digits, and in the first example, the output from the new code was actually closer to the correct answer than the old one was. I've changed the doctest to be more noise-tolerant.",
    "created_at": "2018-05-07T17:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334211",
    "user": "@loefflerd"
}
```

This is just harmless fuzz. The discrepancies are all in the last one or two decimal digits, and in the first example, the output from the new code was actually closer to the correct answer than the old one was. I've changed the doctest to be more noise-tolerant.



---

archive/issue_comments_334212.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-07T17:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334212",
    "user": "@loefflerd"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_334213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-17T06:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334213",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334214.json:
```json
{
    "body": "ok, let it be. I cannot vouch for the math, but I will take your word for it.",
    "created_at": "2018-05-17T06:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334214",
    "user": "@fchapoton"
}
```

ok, let it be. I cannot vouch for the math, but I will take your word for it.



---

archive/issue_comments_334215.json:
```json
{
    "body": "Merge conflict\n\nAlso, Frederic's last name shoud probably be capitalized...",
    "created_at": "2018-05-17T18:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334215",
    "user": "@vbraun"
}
```

Merge conflict

Also, Frederic's last name shoud probably be capitalized...



---

archive/issue_comments_334216.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-17T18:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334216",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_334217.json:
```json
{
    "body": "ok, will wait for the next beta.",
    "created_at": "2018-05-17T18:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334217",
    "user": "@fchapoton"
}
```

ok, will wait for the next beta.



---

archive/issue_comments_334218.json:
```json
{
    "body": "The conflict is from #23510 apparently.",
    "created_at": "2018-05-17T20:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334218",
    "user": "@loefflerd"
}
```

The conflict is from #23510 apparently.



---

archive/issue_comments_334219.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-19T06:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334219",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334220.json:
```json
{
    "body": "merged, and set back to positive",
    "created_at": "2018-05-19T06:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334220",
    "user": "@fchapoton"
}
```

merged, and set back to positive



---

archive/issue_comments_334221.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-05-19T06:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334221",
    "user": "@fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_334222.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-05-19T09:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334222",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_334223.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2018-05-19T09:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334223",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_334224.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-19T09:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334224",
    "user": "@loefflerd"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334225.json:
```json
{
    "body": "The auto-merge algorithm isn't quite clever enough to avoid re-introducing some of the unneeded imports which were removed by #23510. I've pushed a tiny patch to get rid of them again. These changes were already reviewed as part of #23510 so I am setting this back to positive review.",
    "created_at": "2018-05-19T09:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334225",
    "user": "@loefflerd"
}
```

The auto-merge algorithm isn't quite clever enough to avoid re-introducing some of the unneeded imports which were removed by #23510. I've pushed a tiny patch to get rid of them again. These changes were already reviewed as part of #23510 so I am setting this back to positive review.



---

archive/issue_comments_334226.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-20T22:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23849",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23849#issuecomment-334226",
    "user": "@vbraun"
}
```

Resolution: fixed
