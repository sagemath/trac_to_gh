# Issue 23849: Atkin-Lehner normalisation issue

Issue created by migration from Trac.

Original creator: davidloeffler

Original creation time: 2017-10-22 12:17:59

Keywords: atkin-lehner

This ticket is a follow-up to #18061, concerning Atkin--Lehner actions.

According to the docstring of `sage.modular.modform.element.ModularForm_abstract.atkin_lehner_action`, our conventions are supposed to be that the pseudo-eigenvalues of the Atkin--Lehner operator W_d should have absolute value d<sup>k/2</sup> - 1. However, it doesn't seem that this convention is being enforced very consistently:

```
sage: f = Newforms(24, 4)[0]
sage: f
q + 3*q^3 + 14*q^5 + O(q^6)
sage: f.atkin_lehner_eigenvalue(8)
-1
sage: f.atkin_lehner_eigenvalue(3)
-3
```


The problem seems to be this:

```
sage: f._atkin_lehner_action_from_qexp(3)
(-3, q + 3*q^3 + 14*q^5 + O(q^6))
sage: f._atkin_lehner_action_from_modsym(3)
(-1, q + 3*q^3 + 14*q^5 + O(q^6))
```



---

Comment by davidloeffler created at 2017-10-23 14:33:41

Changing status from new to needs_review.


---

Comment by davidloeffler created at 2017-10-23 14:33:41

Here's a patch. As well as fixing the normalisation issue, I've readjusted our conventions to be more consistent with the standard reference (Atkin--Li 1978) -- the previous version was out by a root of unity in some cases -- and added some more examples and doctests.
----
New commits:


---

Comment by aly.deines created at 2017-10-23 20:45:18

Changing status from needs_review to needs_work.


---

Comment by aly.deines created at 2017-10-23 20:45:18

This is a small thing, in src/sage/modular/modsym/ambient.py in documentation for the method _compute_atkin_lehner_matrix, there should be an example where the sign isn't 0 so that it hits the ValueError.

The rest looks good so far.


---

Comment by git created at 2017-10-24 08:28:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-10-24 08:29:49

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2017-10-24 08:29:49

Good point. I've added a doctest for this case (and another one for a GammaH level, since there weren't any of these before).


---

Comment by git created at 2017-10-24 09:01:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-10-24 09:02:45

The last commit is just a tiny ReST formatting fix (to correct an error picked up by the patchbot)


---

Comment by davidloeffler created at 2017-10-24 09:55:55

Hold it, there's a doctest failing.


---

Comment by davidloeffler created at 2017-10-24 09:55:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-24 15:00:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-10-24 15:09:21

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2017-10-24 15:09:21

That was embarrassing: I broke the test case from #18061 (which I reported initially -- oops!). This was an issue with determining when the AL eigenvalue exists in `atkin_lehner_eigenvalue` -- we need to determine when it doesn't exist, and raise an error in that case, without needing to fix the choices of embedding needed for more general pseudo-eigenvalues. (I also adjusted the test case to make it run quicker, and removed the ` #Â long time` flag.)

I've also moved `atkin_lehner_action` out of the abstract modular form element class into the Newform class; eigenvalues make sense for any form, but pseudo-eigenvalues only for newforms.


---

Comment by git created at 2017-10-24 20:40:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2018-05-01 11:25:49

I'm uploading a new, completely rewritten branch, which sorts out the normalisations so they're consistent with Atkin-Li, and also covers all the previously non-implemented cases using a trick based on twisting maps for modular symbols.
----
New commits:


---

Comment by chapoton created at 2018-05-05 07:20:46

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-05-05 07:20:46

2 failing doctests in 

```
sage -t --long src/sage/modular/abvar/lseries.py 
```

because of precision issues in L functions


---

Comment by git created at 2018-05-07 17:53:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2018-05-07 17:57:24

This is just harmless fuzz. The discrepancies are all in the last one or two decimal digits, and in the first example, the output from the new code was actually closer to the correct answer than the old one was. I've changed the doctest to be more noise-tolerant.


---

Comment by davidloeffler created at 2018-05-07 17:57:39

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-05-17 06:41:50

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-05-17 06:41:50

ok, let it be. I cannot vouch for the math, but I will take your word for it.


---

Comment by vbraun created at 2018-05-17 18:38:29

Merge conflict

Also, Frederic's last name shoud probably be capitalized...


---

Comment by vbraun created at 2018-05-17 18:38:29

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2018-05-17 18:39:17

ok, will wait for the next beta.


---

Comment by davidloeffler created at 2018-05-17 20:18:24

The conflict is from #23510 apparently.


---

Comment by git created at 2018-05-19 06:52:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-19 06:54:58

merged, and set back to positive


---

Comment by chapoton created at 2018-05-19 06:54:58

Changing status from needs_work to positive_review.


---

Comment by git created at 2018-05-19 09:25:56

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-05-19 09:25:56

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by davidloeffler created at 2018-05-19 09:29:12

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2018-05-19 09:29:12

The auto-merge algorithm isn't quite clever enough to avoid re-introducing some of the unneeded imports which were removed by #23510. I've pushed a tiny patch to get rid of them again. These changes were already reviewed as part of #23510 so I am setting this back to positive review.


---

Comment by vbraun created at 2018-05-20 22:55:28

Resolution: fixed
