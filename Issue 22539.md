# Issue 22539: Python 2/3, exit build with error if extension modules fail to build

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-04-07 12:38:36

This was motivated by, but does not solve #22768.

Currently the `spkg-install` for the pythons does a post-install check that some of the compiled extension modules are actually importable.  The problem with this is that it's post-install, so one can still wind up with a partially broken python install.

Unfortunately, there's no good way (without patching, at least) for Python's build to exit if one of the extension modules (which are ostensibly optional) fails to build.  So this patch just scans the build output for the magic string "Failed to build these modules:" and treats the build as failed if found.

This still might not be fool-proof (an extension module might somehow compile but still not be working), so this keeps the post-install checks as well.  But this will at least catch more issues in build, before install.


---

Comment by embray created at 2017-04-07 12:39:32

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-04-11 10:10:14

Isn't it a problem with Python build system? No upstream report?


---

Comment by embray created at 2017-04-11 12:31:51

I don't know that it's really a _problem_ per se.  The way it is is intentional.  Though it might be nice to at least have an option to fail in this case?


---

Comment by jhpalmieri created at 2017-04-11 18:15:12

Do we care if some of the extension modules are broken? Wouldn't it be better to test the ones that matter to us, one by one? That is what is currently done with `python2` and the `_scproxy` module on Darwin.


---

Comment by embray created at 2017-04-12 13:12:28

There are two output sections: One that lists extension modules that were not built at all, due to some dependencies being missing or something.  For now I'm assuming that's fine.  This just catches extension modules that it tries to build, but has errors with (e.g. the error building the _sqlite3 module that motivated this).  If it was trying to build an extension module that we explicitly didn't want and failed that would be a different issue.


---

Comment by jhpalmieri created at 2017-04-12 15:31:57

Replying to [comment:5 embray]:
> If it was trying to build an extension module that we explicitly didn't want and failed that would be a different issue.

This is what I was asking about. One general philosophy is to test only for the features you need and to not care if other parts are broken. You are taking a different approach: test everything, and then if someone eventually points out a feature that is broken that we don't need, then we can decide to ignore it. Please justify your choice of approach.


---

Comment by embray created at 2017-04-13 09:21:02

> Please justify your choice of approach.

It solves the actual problem I encountered and not hypothetical ones.


---

Comment by embray created at 2017-04-13 09:48:28

Here's a different idea--it should be possible to move the import tests for various modules (https://git.sagemath.org/sage.git/tree/build/pkgs/python2/spkg-install?id=ee3a5d29bd4b25f964077fc6c9e8baf6bd906f61#n155) to after `make` is run but before `make install`, by using the just-built Python for the tests, and not the installed version.  That should be good enough for my purposes and I think would address your concerns.


---

Comment by jdemeyer created at 2017-10-30 10:20:05

Since the checking has been fixed, can this be closed?


---

Comment by embray created at 2017-10-30 14:18:03

Yes, I don't think this is needed now.  One thing that might be good is to add more modules to the list of modules that are tested for importability after the Python build.  For example, this ticket added a test to see if sqlite3 is importable which previously was not tested for.

I could either rewrite this ticket just to add sqlite3 to that list, or open a new ticket for it.


---

Comment by jdemeyer created at 2017-10-30 15:27:42

Replying to [comment:10 embray]:
> I could either rewrite this ticket just to add sqlite3 to that list

Fine for me.


---

Comment by jdemeyer created at 2017-11-28 09:57:46

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-02-10 01:43:23

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-02-10 01:43:23

This is a dup of #27705 and should be closed.


---

Comment by dimpase created at 2020-02-21 21:55:40

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-02-22 19:31:19

Resolution: duplicate
