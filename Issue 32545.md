# Issue 32545: use PARI's qfbsolve() in BinaryQF.solve_integer()

archive/issues_032545.json:
```json
{
    "body": "CC:  @collares\n\nCurrently, solving binary quadratic forms uses a straightforward exponential-time search:\u2002https://github.com/sagemath/sage/blob/9.4/src/sage/quadratic_forms/binary_qf.py#L1469\n\nThis patch calls PARI's `qfbsolve()` instead, which is exponentially faster in many cases.\n\nSage 9.4:\n\n```\nsage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))\n1.86 ms \u00b1 552 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\n\nUsing `qfbsolve()`:\n\n```\nsage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))\n38.4 \u00b5s \u00b1 673 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32782\n\n",
    "created_at": "2021-10-27T07:56:30Z",
    "labels": [
        "quadratic forms",
        "major",
        "enhancement"
    ],
    "title": "use PARI's qfbsolve() in BinaryQF.solve_integer()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32545",
    "user": "lorenz"
}
```
CC:  @collares

Currently, solving binary quadratic forms uses a straightforward exponential-time search: https://github.com/sagemath/sage/blob/9.4/src/sage/quadratic_forms/binary_qf.py#L1469

This patch calls PARI's `qfbsolve()` instead, which is exponentially faster in many cases.

Sage 9.4:

```
sage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))
1.86 ms ± 552 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


Using `qfbsolve()`:

```
sage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))
38.4 µs ± 673 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


Issue created by migration from https://trac.sagemath.org/ticket/32782





---

archive/issue_comments_464284.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-27T08:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464284",
    "user": "lorenz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464285.json:
```json
{
    "body": "Bot is green except for #32737 and #32783.",
    "created_at": "2021-10-27T10:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464285",
    "user": "lorenz"
}
```

Bot is green except for #32737 and #32783.



---

archive/issue_comments_464286.json:
```json
{
    "body": "Nice improvement!\n\nTiny cosmetic changes if you care:\n\n\n```diff\n-            sage: Q = BinaryQF([randrange(-10^3,10^3) for _ in 'abc'])\n+            sage: Q = BinaryQF([randrange(-10^3, 10^3) for _ in 'abc'])\n```\n\n\n\n```diff\n-            sage: xy is None or Q(*xy)==0\n+            sage: xy is None or Q(*xy) == 0\n```\n\n\n\n```diff\n-        if self.is_negative_definite():     # not supported by Pari\n+        if self.is_negative_definite():  # not supported by PARI\n```\n\n\n\n```diff\n-        flag = 2    # single solution, possibly imprimitive\n+        flag = 2  # single solution, possibly imprimitive\n```\n\n\nOther than that, good to go.",
    "created_at": "2021-10-27T13:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464286",
    "user": "slelievre"
}
```

Nice improvement!

Tiny cosmetic changes if you care:


```diff
-            sage: Q = BinaryQF([randrange(-10^3,10^3) for _ in 'abc'])
+            sage: Q = BinaryQF([randrange(-10^3, 10^3) for _ in 'abc'])
```



```diff
-            sage: xy is None or Q(*xy)==0
+            sage: xy is None or Q(*xy) == 0
```



```diff
-        if self.is_negative_definite():     # not supported by Pari
+        if self.is_negative_definite():  # not supported by PARI
```



```diff
-        flag = 2    # single solution, possibly imprimitive
+        flag = 2  # single solution, possibly imprimitive
```


Other than that, good to go.



---

archive/issue_comments_464287.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-27T14:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464287",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464288.json:
```json
{
    "body": "Thank you! Done.",
    "created_at": "2021-10-27T14:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464288",
    "user": "lorenz"
}
```

Thank you! Done.



---

archive/issue_comments_464289.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-18T16:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464289",
    "user": "slelievre"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464290.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-05T11:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464290",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_464291.json:
```json
{
    "body": "I am seeing test failures such as the one below. Could it be due to this change? This is with Pari 2.13.3.\n\n\n```\nsage -t --long --random-seed=18889643490698285570903197615695620531 /nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py\n**********************************************************************\nFile \"/nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py\", line 1497, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer\nFailed example:\n    xy = Q.solve_integer(n)\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1096, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.quadratic_forms.binary_qf.BinaryQF.solve_integer[9]>\", line 1, in <module>\n        xy = Q.solve_integer(n)\n      File \"/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/quadratic_forms/binary_qf.py\", line 1506, in solve_integer\n        sol = self.__pari__().qfbsolve(n, flag)\n      File \"sage/structure/sage_object.pyx\", line 955, in sage.structure.sage_object.SageObject.__pari__ (build/cythonized/sage/structure/sage_object.c:11148)\n        x = pari(self._pari_init_())\n      File \"cypari2/pari_instance.pyx\", line 841, in cypari2.pari_instance.Pari.__call__\n      File \"cypari2/gen.pyx\", line 4813, in cypari2.gen.objtogen\n      File \"cypari2/convert.pyx\", line 557, in cypari2.convert.PyObject_AsGEN\n      File \"cypari2/handle_error.pyx\", line 213, in cypari2.handle_error._pari_err_handle\n    cypari2.handle_error.PariError: Qfb: domain error in Qfb: issquare(disc) = 1\n```\n",
    "created_at": "2021-12-14T21:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464291",
    "user": "@collares"
}
```

I am seeing test failures such as the one below. Could it be due to this change? This is with Pari 2.13.3.


```
sage -t --long --random-seed=18889643490698285570903197615695620531 /nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py
**********************************************************************
File "/nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py", line 1497, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
Failed example:
    xy = Q.solve_integer(n)
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 1096, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.quadratic_forms.binary_qf.BinaryQF.solve_integer[9]>", line 1, in <module>
        xy = Q.solve_integer(n)
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/quadratic_forms/binary_qf.py", line 1506, in solve_integer
        sol = self.__pari__().qfbsolve(n, flag)
      File "sage/structure/sage_object.pyx", line 955, in sage.structure.sage_object.SageObject.__pari__ (build/cythonized/sage/structure/sage_object.c:11148)
        x = pari(self._pari_init_())
      File "cypari2/pari_instance.pyx", line 841, in cypari2.pari_instance.Pari.__call__
      File "cypari2/gen.pyx", line 4813, in cypari2.gen.objtogen
      File "cypari2/convert.pyx", line 557, in cypari2.convert.PyObject_AsGEN
      File "cypari2/handle_error.pyx", line 213, in cypari2.handle_error._pari_err_handle
    cypari2.handle_error.PariError: Qfb: domain error in Qfb: issquare(disc) = 1
```




---

archive/issue_comments_464292.json:
```json
{
    "body": "Thanks for reporting the failure! I created #33026 for this.",
    "created_at": "2021-12-15T07:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464292",
    "user": "lorenz"
}
```

Thanks for reporting the failure! I created #33026 for this.



---

archive/issue_comments_464293.json:
```json
{
    "body": "Another failure:\n\n\n```\nsage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py\n**********************************************************************\nFile \"src/sage/quadratic_forms/binary_qf.py\", line 1498, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer\nFailed example:\n    xy is None or Q(*xy) == 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of  12 in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer\n    [282 tests, 1 failure, 0.21 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py  # 1 doctest failed\n```\n",
    "created_at": "2021-12-17T14:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464293",
    "user": "@kliem"
}
```

Another failure:


```
sage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py
**********************************************************************
File "src/sage/quadratic_forms/binary_qf.py", line 1498, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
Failed example:
    xy is None or Q(*xy) == 0
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  12 in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
    [282 tests, 1 failure, 0.21 s]
----------------------------------------------------------------------
sage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py  # 1 doctest failed
```




---

archive/issue_comments_464294.json:
```json
{
    "body": "Replying to [comment:10 gh-kliem]:\n> Another failure:\n\nThis one is also fixed by #33026.",
    "created_at": "2021-12-19T04:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32545",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32545#issuecomment-464294",
    "user": "lorenz"
}
```

Replying to [comment:10 gh-kliem]:
> Another failure:

This one is also fixed by #33026.
