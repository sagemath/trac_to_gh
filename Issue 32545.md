# Issue 32545: use PARI's qfbsolve() in BinaryQF.solve_integer()

Issue created by migration from https://trac.sagemath.org/ticket/32782

Original creator: lorenz

Original creation time: 2021-10-27 07:56:30

CC:  @collares

Currently, solving binary quadratic forms uses a straightforward exponential-time search: https://github.com/sagemath/sage/blob/9.4/src/sage/quadratic_forms/binary_qf.py#L1469

This patch calls PARI's `qfbsolve()` instead, which is exponentially faster in many cases.

Sage 9.4:

```
sage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))
1.86 ms ± 552 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


Using `qfbsolve()`:

```
sage: %timeit BinaryQF([randrange(1,10^4), 0, randrange(1,10^4)]).solve_integer(randrange(10^7))
38.4 µs ± 673 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```



---

Comment by lorenz created at 2021-10-27 08:00:25

Changing status from new to needs_review.


---

Comment by lorenz created at 2021-10-27 10:52:34

Bot is green except for #32737 and #32783.


---

Comment by slelievre created at 2021-10-27 13:22:42

Nice improvement!

Tiny cosmetic changes if you care:


```diff
-            sage: Q = BinaryQF([randrange(-10^3,10^3) for _ in 'abc'])
+            sage: Q = BinaryQF([randrange(-10^3, 10^3) for _ in 'abc'])
```



```diff
-            sage: xy is None or Q(*xy)==0
+            sage: xy is None or Q(*xy) == 0
```



```diff
-        if self.is_negative_definite():     # not supported by Pari
+        if self.is_negative_definite():  # not supported by PARI
```



```diff
-        flag = 2    # single solution, possibly imprimitive
+        flag = 2  # single solution, possibly imprimitive
```


Other than that, good to go.


---

Comment by git created at 2021-10-27 14:54:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-10-27 14:54:38

Thank you! Done.


---

Comment by slelievre created at 2021-11-18 16:26:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-05 11:15:30

Resolution: fixed


---

Comment by @collares created at 2021-12-14 21:36:11

I am seeing test failures such as the one below. Could it be due to this change? This is with Pari 2.13.3.


```
sage -t --long --random-seed=18889643490698285570903197615695620531 /nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py
**********************************************************************
File "/nix/store/ya46cp37kqbknk3zbvbnlac6h9r77agx-sage-src-9.5.beta8/src/sage/quadratic_forms/binary_qf.py", line 1497, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
Failed example:
    xy = Q.solve_integer(n)
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 1096, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.quadratic_forms.binary_qf.BinaryQF.solve_integer[9]>", line 1, in <module>
        xy = Q.solve_integer(n)
      File "/nix/store/1q3qn2sgdwklw2jrpz7mafj81linr6hd-python3-3.9.6-env/lib/python3.9/site-packages/sage/quadratic_forms/binary_qf.py", line 1506, in solve_integer
        sol = self.__pari__().qfbsolve(n, flag)
      File "sage/structure/sage_object.pyx", line 955, in sage.structure.sage_object.SageObject.__pari__ (build/cythonized/sage/structure/sage_object.c:11148)
        x = pari(self._pari_init_())
      File "cypari2/pari_instance.pyx", line 841, in cypari2.pari_instance.Pari.__call__
      File "cypari2/gen.pyx", line 4813, in cypari2.gen.objtogen
      File "cypari2/convert.pyx", line 557, in cypari2.convert.PyObject_AsGEN
      File "cypari2/handle_error.pyx", line 213, in cypari2.handle_error._pari_err_handle
    cypari2.handle_error.PariError: Qfb: domain error in Qfb: issquare(disc) = 1
```



---

Comment by lorenz created at 2021-12-15 07:45:41

Thanks for reporting the failure! I created #33026 for this.


---

Comment by @kliem created at 2021-12-17 14:35:13

Another failure:


```
sage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py
**********************************************************************
File "src/sage/quadratic_forms/binary_qf.py", line 1498, in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
Failed example:
    xy is None or Q(*xy) == 0
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  12 in sage.quadratic_forms.binary_qf.BinaryQF.solve_integer
    [282 tests, 1 failure, 0.21 s]
----------------------------------------------------------------------
sage -t --long --random-seed=129865150212556213443045001147722733023 src/sage/quadratic_forms/binary_qf.py  # 1 doctest failed
```



---

Comment by lorenz created at 2021-12-19 04:52:10

Replying to [comment:10 gh-kliem]:
> Another failure:

This one is also fixed by #33026.
