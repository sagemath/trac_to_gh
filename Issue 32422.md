# Issue 32422: sdh_pip_install: Force reinstallation of built wheels

Issue created by migration from https://trac.sagemath.org/ticket/32659

Original creator: mkoeppe

Original creation time: 2021-10-09 23:03:51

CC:  jhpalmieri vbraun lorenz

After #32492, we may get 

```
[sage_conf-9.5.beta2] sage-conf is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```

Because of this behavior of pip, some configuration changes made in `configure` will not be updated in an incremental build. Likewise for other Python packages when we add a patch, or for `sage-setup` when we edit files there (as happened in #32607).

However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.


---

Comment by mkoeppe created at 2021-10-09 23:12:57

A solution provided by https://github.com/pypa/pip/pull/9147 (was merged in pip 20.3) is to use a specification `sage-conf `@` file:///.....` (see https://github.com/pypa/pip/issues/8711#issuecomment-731618898), which will ensure reinstallation.


---

Comment by mkoeppe created at 2021-10-09 23:50:25

Unfortunately this does not fix the issue:

```
[sage_setup-9.5.beta2] Processing /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```

----
New commits:


---

Comment by mkoeppe created at 2021-10-09 23:52:48

This behavior of pip is subject to current discussion/development - 

Un-deprecate source distribution re-installation behaviour 
https://github.com/pypa/pip/pull/10543

Rewrite direct URL reinstallation logic by uranusjr 
https://github.com/pypa/pip/pull/10564

Updating remote links with new URLs for PEP508 functionallity 
https://github.com/pypa/pip/issues/5780


---

Comment by mkoeppe created at 2021-10-09 23:55:39

Another possible workaround is proposed in https://github.com/pypa/pip/issues/8711#issuecomment-669760276


---

Comment by git created at 2021-10-10 00:20:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-10 00:21:30

Unfortunately also that does not fix the issue:

```
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl?hash=sha256:285343dcfde7ad2e51f630591faba468aad4875ee0f15398346642092a8e842b) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```



---

Comment by mkoeppe created at 2021-10-10 02:30:18

Also another approach, providing a `--hash` (via a requirements file) fails.

```diff
diff --git a/build/bin/sage-dist-helpers b/build/bin/sage-dist-helpers
index 4a8862d50f..e7b8fc8677 100644
--- a/build/bin/sage-dist-helpers
+++ b/build/bin/sage-dist-helpers
@@ -271,7 +271,20 @@ sdh_store_wheel() {
     mkdir -p "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}" && \
         $sudo mv "$wheel" "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/" || \
         sdh_die "Error storing $wheel"
+    wheel_basename="${wheel##*/}"
     wheel="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/${wheel##*/}"
+    # Trac #32659: pip no longer reinstalls local wheels if the version is the same.
+    # Because neither (1) applying patches nor (2) local changes (in the case
+    # of sage-conf, sage-setup, etc.) bump the version number, we need to
+    # override this behavior.  The pip install option --force-reinstall does too
+    # much -- it also reinstalls all dependencies, which we do not want.
+    # We override it by specifying the hash -- but this can only be done using a
+    # requirements file, not using flags on the command line,
+    # https://github.com/pypa/pip/issues/3257
+    distname="${wheel_basename%%-*}"
+    hasharg=$(python3 -m pip hash "$wheel" | sed -n /--hash=/p)
+    requirements_file="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/requirements-$distname.txt"
+    echo "$distname @ file://$wheel $hasharg" | $sudo tee $requirements_file > /dev/null
 }
 
 sdh_store_and_pip_install_wheel() {
@@ -306,7 +319,7 @@ sdh_store_and_pip_install_wheel() {
         local sudo=""
         local root=""
     fi
-    $sudo sage-pip-install $root $pip_options "$wheel" || \
+    $sudo sage-pip-install $root $pip_options -v -v -v -r "$requirements_file" || \
         sdh_die "Error installing ${wheel##*/}"
     if [ -n "${SAGE_PKG_DIR}" ]; then
         # Record name of installed distribution name for uninstallation.
```

It still says:

```
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```



---

Comment by mkoeppe created at 2021-10-10 04:03:31

I think we will need either https://github.com/pypa/pip/pull/10564 (and use `--upgrade` with `pip install`); or go back to `pip uninstall` before `pip install` (a simple version of what was removed in #31816).


---

Comment by git created at 2021-10-10 04:26:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-10 04:27:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-10 04:29:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-12 02:05:37

A new pip version is out (#32671); it makes some changes closely related to this issue but does not solve anything.

Needs review


---

Comment by lorenz created at 2021-10-18 03:36:31

Is it intended that `sdh_store_and_pip_install_wheel` invokes `python3 -m pip uninstall` rather than `sage-pip-uninstall`?


---

Comment by git created at 2021-10-18 03:51:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-18 03:52:28

Looks like I introduced `sage-pip-uninstall` to avoid a duplication but then forgot to use it in one of the two cases


---

Comment by lorenz created at 2021-10-18 10:54:59

Thanks, looks good to me.


---

Comment by lorenz created at 2021-10-18 10:54:59

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-18 16:09:40

Thanks for reviewing!


---

Comment by vbraun created at 2021-10-20 23:01:04

Resolution: fixed


---

Comment by mkoeppe created at 2022-09-30 21:29:46

Replying to [ticket:32659 Matthias KÃ¶ppe]:
> However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.

This discussion is still ongoing and has moved to https://github.com/pypa/pip/pull/10564 (most recent activity: June 2022)
