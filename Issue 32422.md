# Issue 32422: sdh_pip_install: Force reinstallation of built wheels

archive/issues_032422.json:
```json
{
    "body": "CC:  @jhpalmieri @vbraun @yyyyx4\n\nAfter #32492, we may get \n\n```\n[sage_conf-9.5.beta2] sage-conf is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\n\nBecause of this behavior of pip, some configuration changes made in `configure` will not be updated in an incremental build. Likewise for other Python packages when we add a patch, or for `sage-setup` when we edit files there (as happened in #32607).\n\nHowever, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32659\n\n",
    "created_at": "2021-10-09T23:03:51Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "sdh_pip_install: Force reinstallation of built wheels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32422",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @vbraun @yyyyx4

After #32492, we may get 

```
[sage_conf-9.5.beta2] sage-conf is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```

Because of this behavior of pip, some configuration changes made in `configure` will not be updated in an incremental build. Likewise for other Python packages when we add a patch, or for `sage-setup` when we edit files there (as happened in #32607).

However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.

Issue created by migration from https://trac.sagemath.org/ticket/32659





---

archive/issue_comments_461984.json:
```json
{
    "body": "A solution provided by https://github.com/pypa/pip/pull/9147 (was merged in pip 20.3) is to use a specification `sage-conf `@` file:///.....` (see https://github.com/pypa/pip/issues/8711#issuecomment-731618898), which will ensure reinstallation.",
    "created_at": "2021-10-09T23:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461984",
    "user": "https://github.com/mkoeppe"
}
```

A solution provided by https://github.com/pypa/pip/pull/9147 (was merged in pip 20.3) is to use a specification `sage-conf `@` file:///.....` (see https://github.com/pypa/pip/issues/8711#issuecomment-731618898), which will ensure reinstallation.



---

archive/issue_comments_461985.json:
```json
{
    "body": "Unfortunately this does not fix the issue:\n\n```\n[sage_setup-9.5.beta2] Processing /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl\n[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl) (1.5.5)\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\n\n----\nNew commits:",
    "created_at": "2021-10-09T23:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461985",
    "user": "https://github.com/mkoeppe"
}
```

Unfortunately this does not fix the issue:

```
[sage_setup-9.5.beta2] Processing /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```

----
New commits:



---

archive/issue_comments_461986.json:
```json
{
    "body": "This behavior of pip is subject to current discussion/development - \n\nUn-deprecate source distribution re-installation behaviour \nhttps://github.com/pypa/pip/pull/10543\n\nRewrite direct URL reinstallation logic by uranusjr \nhttps://github.com/pypa/pip/pull/10564\n\nUpdating remote links with new URLs for PEP508 functionallity \nhttps://github.com/pypa/pip/issues/5780",
    "created_at": "2021-10-09T23:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461986",
    "user": "https://github.com/mkoeppe"
}
```

This behavior of pip is subject to current discussion/development - 

Un-deprecate source distribution re-installation behaviour 
https://github.com/pypa/pip/pull/10543

Rewrite direct URL reinstallation logic by uranusjr 
https://github.com/pypa/pip/pull/10564

Updating remote links with new URLs for PEP508 functionallity 
https://github.com/pypa/pip/issues/5780



---

archive/issue_comments_461987.json:
```json
{
    "body": "Another possible workaround is proposed in https://github.com/pypa/pip/issues/8711#issuecomment-669760276",
    "created_at": "2021-10-09T23:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461987",
    "user": "https://github.com/mkoeppe"
}
```

Another possible workaround is proposed in https://github.com/pypa/pip/issues/8711#issuecomment-669760276



---

archive/issue_comments_461988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-10T00:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461989.json:
```json
{
    "body": "Unfortunately also that does not fix the issue:\n\n```\n[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl?hash=sha256:285343dcfde7ad2e51f630591faba468aad4875ee0f15398346642092a8e842b) (1.5.5)\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\n",
    "created_at": "2021-10-10T00:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461989",
    "user": "https://github.com/mkoeppe"
}
```

Unfortunately also that does not fix the issue:

```
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl?hash=sha256:285343dcfde7ad2e51f630591faba468aad4875ee0f15398346642092a8e842b) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```




---

archive/issue_comments_461990.json:
```json
{
    "body": "Also another approach, providing a `--hash` (via a requirements file) fails.\n\n```diff\ndiff --git a/build/bin/sage-dist-helpers b/build/bin/sage-dist-helpers\nindex 4a8862d50f..e7b8fc8677 100644\n--- a/build/bin/sage-dist-helpers\n+++ b/build/bin/sage-dist-helpers\n@@ -271,7 +271,20 @@ sdh_store_wheel() {\n     mkdir -p \"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}\" && \\\n         $sudo mv \"$wheel\" \"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/\" || \\\n         sdh_die \"Error storing $wheel\"\n+    wheel_basename=\"${wheel##*/}\"\n     wheel=\"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/${wheel##*/}\"\n+    # Trac #32659: pip no longer reinstalls local wheels if the version is the same.\n+    # Because neither (1) applying patches nor (2) local changes (in the case\n+    # of sage-conf, sage-setup, etc.) bump the version number, we need to\n+    # override this behavior.  The pip install option --force-reinstall does too\n+    # much -- it also reinstalls all dependencies, which we do not want.\n+    # We override it by specifying the hash -- but this can only be done using a\n+    # requirements file, not using flags on the command line,\n+    # https://github.com/pypa/pip/issues/3257\n+    distname=\"${wheel_basename%%-*}\"\n+    hasharg=$(python3 -m pip hash \"$wheel\" | sed -n /--hash=/p)\n+    requirements_file=\"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/requirements-$distname.txt\"\n+    echo \"$distname @ file://$wheel $hasharg\" | $sudo tee $requirements_file > /dev/null\n }\n \n sdh_store_and_pip_install_wheel() {\n@@ -306,7 +319,7 @@ sdh_store_and_pip_install_wheel() {\n         local sudo=\"\"\n         local root=\"\"\n     fi\n-    $sudo sage-pip-install $root $pip_options \"$wheel\" || \\\n+    $sudo sage-pip-install $root $pip_options -v -v -v -r \"$requirements_file\" || \\\n         sdh_die \"Error installing ${wheel##*/}\"\n     if [ -n \"${SAGE_PKG_DIR}\" ]; then\n         # Record name of installed distribution name for uninstallation.\n```\n\nIt still says:\n\n```\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\n",
    "created_at": "2021-10-10T02:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461990",
    "user": "https://github.com/mkoeppe"
}
```

Also another approach, providing a `--hash` (via a requirements file) fails.

```diff
diff --git a/build/bin/sage-dist-helpers b/build/bin/sage-dist-helpers
index 4a8862d50f..e7b8fc8677 100644
--- a/build/bin/sage-dist-helpers
+++ b/build/bin/sage-dist-helpers
@@ -271,7 +271,20 @@ sdh_store_wheel() {
     mkdir -p "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}" && \
         $sudo mv "$wheel" "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/" || \
         sdh_die "Error storing $wheel"
+    wheel_basename="${wheel##*/}"
     wheel="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/${wheel##*/}"
+    # Trac #32659: pip no longer reinstalls local wheels if the version is the same.
+    # Because neither (1) applying patches nor (2) local changes (in the case
+    # of sage-conf, sage-setup, etc.) bump the version number, we need to
+    # override this behavior.  The pip install option --force-reinstall does too
+    # much -- it also reinstalls all dependencies, which we do not want.
+    # We override it by specifying the hash -- but this can only be done using a
+    # requirements file, not using flags on the command line,
+    # https://github.com/pypa/pip/issues/3257
+    distname="${wheel_basename%%-*}"
+    hasharg=$(python3 -m pip hash "$wheel" | sed -n /--hash=/p)
+    requirements_file="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/requirements-$distname.txt"
+    echo "$distname @ file://$wheel $hasharg" | $sudo tee $requirements_file > /dev/null
 }
 
 sdh_store_and_pip_install_wheel() {
@@ -306,7 +319,7 @@ sdh_store_and_pip_install_wheel() {
         local sudo=""
         local root=""
     fi
-    $sudo sage-pip-install $root $pip_options "$wheel" || \
+    $sudo sage-pip-install $root $pip_options -v -v -v -r "$requirements_file" || \
         sdh_die "Error installing ${wheel##*/}"
     if [ -n "${SAGE_PKG_DIR}" ]; then
         # Record name of installed distribution name for uninstallation.
```

It still says:

```
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```




---

archive/issue_comments_461991.json:
```json
{
    "body": "I think we will need either https://github.com/pypa/pip/pull/10564 (and use `--upgrade` with `pip install`); or go back to `pip uninstall` before `pip install` (a simple version of what was removed in #31816).",
    "created_at": "2021-10-10T04:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461991",
    "user": "https://github.com/mkoeppe"
}
```

I think we will need either https://github.com/pypa/pip/pull/10564 (and use `--upgrade` with `pip install`); or go back to `pip uninstall` before `pip install` (a simple version of what was removed in #31816).



---

archive/issue_comments_461992.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-10T04:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_461993.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-10T04:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461994.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-10T04:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461994",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461995.json:
```json
{
    "body": "A new pip version is out (#32671); it makes some changes closely related to this issue but does not solve anything.\n\nNeeds review",
    "created_at": "2021-10-12T02:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461995",
    "user": "https://github.com/mkoeppe"
}
```

A new pip version is out (#32671); it makes some changes closely related to this issue but does not solve anything.

Needs review



---

archive/issue_comments_461996.json:
```json
{
    "body": "Is it intended that `sdh_store_and_pip_install_wheel` invokes `python3 -m pip uninstall` rather than `sage-pip-uninstall`?",
    "created_at": "2021-10-18T03:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461996",
    "user": "https://github.com/yyyyx4"
}
```

Is it intended that `sdh_store_and_pip_install_wheel` invokes `python3 -m pip uninstall` rather than `sage-pip-uninstall`?



---

archive/issue_comments_461997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T03:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461997",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461998.json:
```json
{
    "body": "Looks like I introduced `sage-pip-uninstall` to avoid a duplication but then forgot to use it in one of the two cases",
    "created_at": "2021-10-18T03:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461998",
    "user": "https://github.com/mkoeppe"
}
```

Looks like I introduced `sage-pip-uninstall` to avoid a duplication but then forgot to use it in one of the two cases



---

archive/issue_comments_461999.json:
```json
{
    "body": "Thanks, looks good to me.",
    "created_at": "2021-10-18T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-461999",
    "user": "https://github.com/yyyyx4"
}
```

Thanks, looks good to me.



---

archive/issue_comments_462000.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-18T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-462000",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_462001.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2021-10-18T16:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-462001",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_462002.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-462002",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_029415.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-20T23:01:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32422#event-29415"
}
```



---

archive/issue_comments_462003.json:
```json
{
    "body": "Replying to [ticket:32659 Matthias K\u00f6ppe]:\n> However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.\n\nThis discussion is still ongoing and has moved to https://github.com/pypa/pip/pull/10564 (most recent activity: June 2022)",
    "created_at": "2022-09-30T21:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32422#issuecomment-462003",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32659 Matthias Köppe]:
> However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.

This discussion is still ongoing and has moved to https://github.com/pypa/pip/pull/10564 (most recent activity: June 2022)
