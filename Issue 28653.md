# Issue 28653: Install fewer static libraries

Issue created by migration from https://trac.sagemath.org/ticket/28890

Original creator: embray

Original creation time: 2019-12-16 13:44:32

CC:  mmezzarobba dimpase mjo jhpalmieri vdelecroix

Keywords: static

As pointed out [on sage-devel](https://groups.google.com/d/msg/sage-devel/ON2MC0n2iUE/Qt4axoa0AQAJ), by default many SPKGs install static libraries in addition to their associated dynamic libs.

I usually ignored this as harmless, but as Marc pointed out, some of them are quite large, especially libgiac.a.  Almost none of these are actually needed either at build or runtime and do not need to be installed by default in SAGE_LOCAL.

I think by default we should configure the relevant packages to _not_ install static libs, or remove them manually if the packages' build system installs them forcibly.  This could be overridden with `<PKGNAME>_CONFIGURE` variables if someone needs the static lib for some reason.


---

Comment by embray created at 2019-12-16 17:43:50

Passing `--disable-static` to all autoconf-compatible packages by default takes care of most of them, narrowing the list down to:


```
ecl-16.1.2.p5
ecm-7.0.4.p1
libatomic_ops-7.6.2
mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0
ntl-11.3.2
numpy-1.16.1
pari-2.11.1.p2
python2-2.7.15.p1
python3-3.7.3.p1
ratpoints-2.1.3.p5
symmetrica-2.0.p11
yasm-1.3.0.p0
```


Left libatomic_ops static since I think gc likes to link to it statically for performance reasons, but I need to double-check that it's actually doing that.

The rest I'm not sure about yet.  
----
New commits:


---

Comment by dimpase created at 2019-12-16 17:55:45

OK, let me run tests...


---

Comment by dimpase created at 2019-12-16 23:55:54

the branch looks good, do you want it to be reviewed?


---

Comment by mmezzarobba created at 2019-12-17 09:09:55

Thanks a lot for taking care of that. (You are crossing an item off the depths of my todo-list!)

I just rebuilt sage from scratch with this branch. With standard packages only and using system packages when possible, the remaining static libraries are

```
107M    ./local/lib/libpari.a
48M     ./local/lib/libsymmetrica.a
31M     ./local/lib/python3.7/config-3.7m-x86_64-linux-gnu/libpython3.7m.a
7,7M    ./local/lib/ecl-16.1.2/libcmp.a
7,5M    ./local/lib/libbraiding.a
5,4M    ./local/lib/libyasm.a
4,5M    ./local/lib/ecl-16.1.2/libasdf.a
3,1M    ./local/lib/libecm.a
880K    ./local/lib/ecl-16.1.2/libdefsystem.a
564K    ./local/lib/ecl-16.1.2/libdeflate.a
448K    ./local/lib/ecl-16.1.2/libsockets.a
372K    ./local/lib/python3.7/site-packages/numpy/core/lib/libnpymath.a
232K    ./local/lib/ecl-16.1.2/libecl-help.a
200K    ./local/lib/ecl-16.1.2/libprofile.a
184K    ./local/lib/ecl-16.1.2/librt.a
176K    ./local/lib/libratpoints.a
172K    ./local/lib/libhomfly.a
172K    ./local/lib/ecl-16.1.2/libecl-cdb.a
140K    ./local/lib/ecl-16.1.2/libecl-curl.a
132K    ./local/lib/ecl-16.1.2/libserve-event.a
132K    ./local/lib/ecl-16.1.2/libql-minitar.a
96K     ./local/lib/ecl-16.1.2/libecl-quicklisp.a
72K     ./local/lib/ecl-16.1.2/libsb-bsd-sockets.a
32K     ./local/lib/libatomic_ops_gpl.a
24K     ./local/lib/libatomic_ops.a
```

So most of the large ones are gone, and those that remain may have a good reason to be there. Like Dima, I'm ready to give this branch positive review if you want.


---

Comment by embray created at 2019-12-17 12:48:48

I want to have a look at a few of the remaining libs.  Also, I got a few test failures with this branch, but I don't know if they're at all related (shouldn't be...)


---

Comment by embray created at 2019-12-17 12:53:08

Replying to [comment:7 embray]:
> Also, I got a few test failures with this branch, but I don't know if they're at all related (shouldn't be...)

They weren't related.  It was the problem that #28289 is intended to fix.  Turns out my develop branch was a little behind.


---

Comment by embray created at 2019-12-30 14:45:18

Since we are apparently already moving 9.0 towards a release candidate, this will probably have to wait a bit.


---

Comment by git created at 2019-12-30 15:12:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-12-30 15:14:41

Updated to remove libpari.a.  Apparently we had been explicitly installing it pretty much forever, so I couldn't find a clear record of _why_, but I don't think there's any need for it currently.

My only concern here is there no easy way (since it is not a flag that can be passed to PARI_CONFIGURE) to force installation of the static lib.  But if someone asks for it for some reason it can be added later.


---

Comment by dimpase created at 2019-12-30 15:20:33

Replying to [comment:11 embray]:
> Updated to remove libpari.a.  Apparently we had been explicitly installing it pretty much forever, so I couldn't find a clear record of _why_, but I don't think there's any need for it currently.
> 

pari/gp upstream claims that statically linked gp is faster than dynamically linked one.


---

Comment by embray created at 2019-12-30 15:28:49

Replying to [comment:12 dimpase]:
> Replying to [comment:11 embray]:
> > Updated to remove libpari.a.  Apparently we had been explicitly installing it pretty much forever, so I couldn't find a clear record of _why_, but I don't think there's any need for it currently.
> > 
> 
> pari/gp upstream claims that statically linked gp is faster than dynamically linked one.

If so, it appears we are already _not_ doing this, though we could.  Regardless, this can be done during PARI/GP build: there is no need to install the static lib after the fact.


---

Comment by embray created at 2019-12-30 16:39:42

libbraiding and libhomfly will be handled by this as well once #28927 is in.


---

Comment by embray created at 2019-12-30 17:21:42

Changing status from new to needs_review.


---

Comment by embray created at 2019-12-30 17:21:42

I think that with the last commit this pretty much covers everything.  I looked into all the other packages that are installing static libs, and determined that it's either on purpose, or too much trouble to mess with as part of this ticket.


---

Comment by mmezzarobba created at 2020-01-09 10:30:00

Thank you again!


---

Comment by mmezzarobba created at 2020-01-09 10:30:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-11 17:45:23

Resolution: fixed


---

Comment by vbraun created at 2020-01-15 23:58:29

Resolution changed from fixed to 


---

Comment by vbraun created at 2020-01-15 23:58:29


```
****************************************************
Configuring zlib-1.2.11.p0
unknown option: --disable-static
./configure --help for help
** ./configure aborting.
unknown option: --disable-static
./configure --help for help
** ./configure aborting.
********************************************************************************
Error configuring zlib-1.2.11.p0
********************************************************************************
```



---

Comment by vbraun created at 2020-01-15 23:58:29

Changing status from closed to new.


---

Comment by embray created at 2020-01-16 14:08:22

New commits:


---

Comment by embray created at 2020-01-16 14:08:22

Set assignee to embray.


---

Comment by embray created at 2020-01-16 14:12:09

Hrm, that's annoying.  Thanks, zlib...


---

Comment by git created at 2020-01-16 14:13:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-01-16 14:13:53

New commits:


---

Comment by embray created at 2020-01-16 14:13:53

Changing status from new to needs_review.


---

Comment by embray created at 2020-01-16 14:14:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-19 10:43:40

I'm getting libpng build errors on KuCalc (Debian 9 x86_64) because something is wrong with zlib dynamic linking:

```
libtool: link: gcc -fPIC -g -Wl,-rpath -Wl,/var/lib/buildbot/slave/sage_git/build/local/lib -o .libs/pngunknown contrib/libtests/pngunknown.o  -L/var/lib/buildbot/slave/sage_git/build/local/lib ./.libs/libpng16.so -lz -lm -Wl,-rpath -Wl,/var/lib/buildbot/slave/sage_git/build/local/lib
collect2: error: ld returned 1 exit status
Makefile:1026: recipe for target 'pngtest' failed
make[5]: *** [pngtest] Error 1
./.libs/libpng16.so: undefined reference to `inflateValidate'
```



---

Comment by vbraun created at 2020-01-19 10:43:53

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2020-01-19 11:02:03

I presume build/pkgs/libpng/spkg-install needs LDFLAGS set to point at $SAGE_LOCAL/lib/
in the case of zlib not coming from the system.
(and the same for the other zlib deps, I guess)


---

Comment by embray created at 2020-01-22 12:42:01

Replying to [comment:30 dimpase]:
> I presume build/pkgs/libpng/spkg-install needs LDFLAGS set to point at $SAGE_LOCAL/lib/
> in the case of zlib not coming from the system.
> (and the same for the other zlib deps, I guess)

Don't we already do that for all packages?  The failing command Volker posted already had `-L/var/lib/buildbot/slave/sage_git/build/local/lib` as well as `-lz`.


---

Comment by dimpase created at 2020-01-22 12:51:31

could it be the order of libs issue?

Or something to do with libpng using to carry its own zlib...


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-05-13 21:47:39

See also: #23519 - SAGE_FAT_BINARY fails on Debian 9 64-bit


---

Comment by mkoeppe created at 2020-09-12 19:38:42

New commits:


---

Comment by mjo created at 2020-09-13 12:43:34

Replying to [comment:36 mkoeppe]:
> New commits:
> ...

Should this be Needs Review now?


---

Comment by mjo created at 2020-09-13 12:45:24

I've removed the note about symmetrica from the description, since we took over maintenance and added an autotools build system.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-04-09 05:54:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-04-09 05:56:29

Dusted off this ticket. It will be helpful to reduce the size of wheels in #31396


---

Comment by mkoeppe created at 2021-04-09 05:58:30

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-04-09 06:08:34

Tests running at https://github.com/mkoeppe/sage/actions/runs/732049335


---

Comment by mkoeppe created at 2021-04-09 17:29:27

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-09 17:29:27

A typo in the change to zlib broke lots of platforms


---

Comment by git created at 2021-04-09 17:31:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-09 17:38:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-09 17:46:29

Now testing at https://github.com/mkoeppe/sage/actions/runs/733869032


---

Comment by mkoeppe created at 2021-04-09 17:46:58

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-04-11 03:47:40

On OS X (with a bunch of homebrew packages), this prevents building of the following:

```
libbraiding.a
libcdd.a
libcddgmp.a
libec.a
libecm.a
libfplll.a
libgf2x.a
libgivaro.a
libhomfly.a
libiml.a
liblrcalc.a
libpari.a
libplanarity.a
libratpoints.a
librw.a
libsymmetrica.a
```

`libecm.a` and `libratpoints.a` are still built, as it says in the ticket description.

We should probably build without as many homebrew packages, to make sure things still work.


---

Comment by jhpalmieri created at 2021-04-11 06:09:15

With `./configure --with-system-python3=no --with-system-ntl=no --with-system-gmp=no`, I see `libgmp.a`, `libgmpxx.a`, and `libntl.a` still present. I think this is still consistent with the ticket description.


---

Comment by mkoeppe created at 2021-04-11 16:41:51

The runs at https://github.com/mkoeppe/sage/actions/runs/733869032 (linux/macos), https://github.com/mkoeppe/sage/actions/runs/732049334 (optional packages), were also successful.

On `cygwin-standard` (https://github.com/mkoeppe/sage/runs/2309214385), there is an issue with the standard package `libbraiding` - for which building shared libraries is broken (#30814)


---

Comment by mkoeppe created at 2021-04-11 16:41:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-11 16:55:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-11 16:55:33

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-04-11 17:04:23

New test on cygwin at https://github.com/mkoeppe/sage/actions/runs/738661838


---

Comment by git created at 2021-04-11 17:06:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-05-21 20:24:29

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-05-21 20:24:29

I'm not sure why I can't view the branch attached to this ticket, but it merges cleanly with Sage 9.3. I think we should add this to an early beta of 9.4 (or 9.5 if 9.4 is a bug-fix release) to make sure it gets tested thoroughly.


---

Comment by mkoeppe created at 2021-05-21 20:38:27

Thanks!


---

Comment by vbraun created at 2021-06-06 13:19:31

Resolution: fixed
