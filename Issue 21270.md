# Issue 21270: Make sagelib a PyPI package

Issue created by migration from https://trac.sagemath.org/ticket/21507

Original creator: mkoeppe

Original creation time: 2016-09-16 16:05:10

CC:  jdemeyer was vbraun vdelecroix dimpase fbissey embray leif aenge nthiery mmarco klee robertwb infinity0 thansen defeo slelievre @timokau klui isuruf jhpalmieri

This is a task ticket organizing the steps necessary to eventually provide sagelib via PyPI.

It would be used by a Python user as follows. Let's assume a user has already installed every package that sage-the-distribution provides on their distribution.
Then a simple

```
  pip install sagelib
```

would install sagelib in the user's Python installation. Then the user could do `from sage.all import *`.

Here are the steps:
 - #21480: Make `sagelib setup.py` self-contained, independent of `SAGE_ROOT`, and handle `--build-base`
 - Make `setup.py sdist` work
 - ...


---

Comment by embray created at 2016-09-22 15:15:12

Thanks for taking the lead on this.  There's more still be to added to the list of issues, such as providing binary wheels and how that will be handled.  I think it will be important to also make more progress on making some hard dependencies optional (that is, allow optional features to fail gracefully if a dependency for that feature is not found).


---

Comment by mkoeppe created at 2016-09-22 17:01:21

Replying to [comment:10 embray]:
> There's more still be to added to the list of issues, such as providing binary wheels and how that will be handled.  

Definitely. I'm hoping that we can use this ticket to organize it.

> I think it will be important to also make more progress on making some hard dependencies optional (that is, allow optional features to fail gracefully if a dependency for that feature is not found).

I agree.


---

Comment by mkoeppe created at 2016-09-22 19:29:03

Here's a question for the distutils experts. Is a Python package allowed to install things in `bin/`? Do any other Python packages do that? 
Where would one install helper scripts? Is there a Python equivalent of `$prefix/libexec`?


---

Comment by was created at 2016-09-22 20:26:38

This Python package, which is part of SMC, installs many things to /usr/local/bin using completely standard approaches: https://github.com/sagemathinc/smc/tree/master/src/smc_pyutil.  See, in particular, the console_scripts section of setup.py: https://github.com/sagemathinc/smc/blob/master/src/smc_pyutil/setup.py#L58


---

Comment by mkoeppe created at 2016-09-22 20:57:44

Thanks a lot! Following your pointer, I've found this documentation: http://python-packaging.readthedocs.io/en/latest/command-line-scripts.html, which I will refer to alongside the example that you pointed out.


---

Comment by mkoeppe created at 2016-09-22 22:14:00

This now #21569.


---

Comment by embray created at 2016-09-23 11:13:50

I don't like the phrasing "PyPI package".  There's no such thing as a "PyPI package" per se.  
Let's be more clear about what we want here--should it be buildable from a source package?  Or are we providing binary wheels?  Both? Neither?


---

Comment by embray created at 2016-09-23 13:38:37

I wonder if this work might not also benefit from adopting portions of [astropy-helpers](https://github.com/astropy/astropy-helpers/tree/master/astropy_helpers) into Sage's build tools.  I don't think it would necessarily be appropriate to use directly--although there's nothing very "astropy" specific in astropy-helpers, a lot of it does assume one is using the astropy project template, or something close to it.  But large swaths of it are very generic, and I put a lot of work into developing tools for build sanity of large Python projects.

Some key features that I think might benefit sage include:

* per-subpackage `setup_package.py` modules, which can contain any number of a [(mostly) well-documented](http://docs.astropy.org/en/stable/development/building.html#customizing-setup-build-for-subpackages) hooks for building compiled modules in that sub-package.  This provides a clear and explicit alternative to a monolithic module_list.py (see the discussion [here](https://github.com/cython/cython/pull/466#issuecomment-249185195)), and would also make it easier to break off some of Sage's subpackages into standalone packages should the time ever come for that.
* one of the less-well-documented features is also that `setup_package.py` can contain hooks for setup.py commands.  For example, if a module contains some generated code (a la `sage_setup.autogen`), it can include a `pre_build_ext` hook to make sure the generated code is up to date before running the `./setup.py build_ext` command (either explicitly, or implicitly as a sub-command).  This makes it relatively easy for individual submodules to put hooks into the build process without having to write complicated command subclasses cluttered with subpackage-specific crud.
* smarter handling of Cython modules--for example, when creating a source tarball it will make sure all Cython modules have been Cythonized, and it will include the resulting C/C++ sources in the source tarball.  This ensures that the user does not need Cython to be installed in order to build from source (which is good, because even if they do have Cython it will often be the wrong version--and in Sage's case missing important patches as well).

Those are the main ones for now but I could probably think of more.


---

Comment by mkoeppe created at 2016-09-23 15:17:17

Replying to [comment:21 embray]:
> I don't like the phrasing "PyPI package".  There's no such thing as a "PyPI package" per se.  
> Let's be more clear about what we want here--should it be buildable from a source package?  Or are we providing binary wheels?  Both? Neither?

The scope of this ticket is a source package that is pip-installable and would be listed as such on PyPI.

Binary packaging (about which I don't know anything at the moment) is beyond the scope of this ticket.


---

Comment by mkoeppe created at 2016-09-23 15:18:45

Replying to [comment:22 embray]:
> I wonder if this work might not also benefit from adopting portions of [astropy-helpers](https://github.com/astropy/astropy-helpers/tree/master/astropy_helpers) into Sage's build tools.  

This all sounds great and seems like it could be part of #21508 or be a follow up to it.


---

Comment by mkoeppe created at 2016-09-23 17:39:21

I've updated the description to explain the scope of the ticket better.


---

Comment by fbissey created at 2016-10-23 07:42:06

I have a request: currently the sage kernel for `jupyter` is created directly in place on the file system rather than being "installed". Similarly there are 3 links created by the `jupyter` kernel installation. That's not ideal from a distro point of view, and I am not sure that's acceptable from `pip` point of view.


---

Comment by jdemeyer created at 2016-10-23 09:31:32

Replying to [comment:31 fbissey]:
> That's not ideal from a distro point of view, and I am not sure that's acceptable from `pip` point of view.

Can you elaborate why that is an issue?


---

Comment by fbissey created at 2016-10-23 09:47:49

Very simple. From a distro point of view (and good build system), you only build in a sandbox isolated from the main system. Then you stage your installation, if you are using autotools, by using DESTDIR, if using setup.py usually with --root. At no point you do something to the live system before the "merge", moving the staged install to the live file system.

I know we had some discussion when the current mechanic has been put in place as part of the install phase, unfortunately it doesn't obey --root. I will run a new check since it's been a while since I hit this.

Prior to 7.5.beta0 I have been patching to build `kernel.json` and then install it with python_package_data. I have decided that the patching to `setup.py` would be to invasive now and currently in 7.5.beta0+ I install manually at the package manager level.


---

Comment by jdemeyer created at 2016-10-23 09:54:23

Replying to [comment:33 fbissey]:
> Very simple. From a distro point of view (and good build system), you only build in a sandbox isolated from the main system. Then you stage your installation, if you are using autotools, by using DESTDIR, if using setup.py usually with --root. At no point you do something to the live system before the "merge", moving the staged install to the live file system.
> 
> I know we had some discussion when the current mechanic has been put in place as part of the install phase, unfortunately it doesn't obey --root. I will run a new check since it's been a while since I hit this.
> 
> Prior to 7.5.beta0 I have been patching to build `kernel.json` and then install it with python_package_data. I have decided that the patching to `setup.py` would be to invasive now and currently in 7.5.beta0+ I install manually at the package manager level.

Sorry, but I don't see how the above is an answer to my question.


---

Comment by jdemeyer created at 2016-10-23 09:55:39

...or maybe the problem is that the kernel spec is generated during the _install_ phase.

Then the problem is not the fact that it is generated, but _when_ it is generated.


---

Comment by jdemeyer created at 2016-10-23 09:57:34

Replying to [comment:33 fbissey]:
> Very simple. From a distro point of view (and good build system), you only build in a sandbox isolated from the main system. Then you stage your installation, if you are using autotools, by using DESTDIR, if using setup.py usually with --root.

Just to make me understand better, what are the commands that you would typically run to install a Python package this way?


---

Comment by fbissey created at 2016-10-23 10:02:36

Would be worse during the build phase

```
        self.kernel_dir = os.path.join(JUPYTER_PATH, "kernels", self.identifier())
```

that's straight on the file system.

For the installation, instead of just doing `python setup.py install` you do `python setup.py install --root=$DESTDIR`. It's supposed to do the same thing than using `DESTDIR` in autotool, everything will be installed as it normally should except that all the paths will be prefixed with DESTDIR.


---

Comment by jdemeyer created at 2016-10-23 10:11:19

Replying to [comment:37 fbissey]:
> For the installation, instead of just doing `python setup.py install` you do `python setup.py install --root=$DESTDIR`.

And why does it make a difference then whether the kernel spec files are generated or copied during that `install` step? I am a bit lost here...


---

Comment by fbissey created at 2016-10-23 10:20:26

The problem is that it created directly on the file system rather than in `DESTDIR`, not a problem for sage the distribution but a pain in the ass for the other people

```
>>> Install sage-9999 into /scratch2/portage/sci-mathematics/sage-9999/image/ category sci-mathematics
 * python2_7: running distutils-r1_run_phase distutils-r1_python_install
/usr/bin/python2.7 setup.py install --root=/scratch2/portage/sci-mathematics/sage-9999/image/_python2.7
make: Nothing to be done for 'all'.
....
....
byte-compiling /scratch2/portage/sci-mathematics/sage-9999/image/_python2.7/usr/lib64/python2.7/site-packages/sage/structure/all.py to all.pyc
writing byte-compilation script '/scratch2/portage/sci-mathematics/sage-9999/temp/tmpoErZMu.py'
/usr/bin/python2.7 -OO /scratch2/portage/sci-mathematics/sage-9999/temp/tmpoErZMu.py
removing /scratch2/portage/sci-mathematics/sage-9999/temp/tmpoErZMu.py
running install_egg_info
Writing /scratch2/portage/sci-mathematics/sage-9999/image/_python2.7/usr/lib64/python2.7/site-packages/sage-9999-py2.7.egg-info
error: [Errno 13] Permission denied: '/usr/share/jupyter/kernels/sagemath/kernel.json'
```

The correct jargon for this is "sandbox violation", the build process is not supposed to write on the live file system at this stage.


---

Comment by jdemeyer created at 2016-10-23 10:31:24

In that case, I would prefer to fix the problem by _generating_ the files in the correct place. That should not be so hard, feel free to create a ticket for that.


---

Comment by fbissey created at 2016-10-23 10:41:14

I wish, `--root` is not very well documented as far as I can see. `DESTDIR` is quite easy we know the variable name. I am not sure there is a real equivalent variable for `setup.py`, otherwise I would have filled a trivial ticket long ago. I'll look again.


---

Comment by embray created at 2016-11-07 13:44:58

I think the distinction of when or how the file is generated is mostly irrelevant, but fbissey is right that it should be generated in the right location, and not directly to JUPYTER_PATH.


---

Comment by fbissey created at 2016-11-07 19:44:00

Replying to [comment:45 embray]:
> I think the distinction of when or how the file is generated is mostly irrelevant, but fbissey is right that it should be generated in the right location, and not directly to JUPYTER_PATH.

That would be OK if it was done relative to the argument of `--root`, you wouldn't know how to get to that Erik? I meant to look it up deeper but stuff is piling on me.


---

Comment by embray created at 2016-11-08 11:17:10

Yeah, I'd be willing to look into it.  There should maybe be yet another ticket opened specifically for this issue.


---

Comment by slelievre created at 2018-02-14 10:55:50

Changing keywords from "" to "pip, PyPI".


---

Comment by slelievre created at 2018-02-14 10:55:50

There is interest in this process, see
[Ask Sage #40947: SageMath as a regular python package](https://ask.sagemath.org/question/40947/sagemath-as-a-regular-python-package/).


---

Comment by jdemeyer created at 2018-06-08 18:17:14

Added #25546


---

Comment by mkoeppe created at 2020-01-18 18:15:19

I propose that we get this task ticket done in 2020.


---

Comment by @Shlokatadistance created at 2020-03-21 05:23:35

The major problem I feel with making something like Sage into a python package is owing to the enormous complexity of Sagemath, the application itself has such major features , and I am not sure how much would we need to modify the application in order to help the proper incorporation of Sage into ordinary python code.


---

Comment by mkoeppe created at 2020-03-21 13:52:07

Yes, the complexity is why we use a meta-ticket to organize the necessary steps.

If you want to help, you can work on a well-defined ticket such as #21516.


---

Comment by @Shlokatadistance created at 2020-03-30 05:42:32

Hi sorry for the delay, I'll start working on this right away
Replying to [comment:62 mkoeppe]:
> Yes, the complexity is why we use a meta-ticket to organize the necessary steps.
> 
> If you want to help, you can work on a well-defined ticket such as #21516.


---

Comment by mkoeppe created at 2020-10-26 21:29:37

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-10-26 21:29:37

Let's close this ticket. Meta-ticket #29705 describes the updated plan.


---

Comment by dimpase created at 2020-10-27 07:57:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-13 06:40:58

Resolution: invalid
