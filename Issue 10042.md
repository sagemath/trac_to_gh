# Issue 10042: Complete rewrite of LP solver interfaces

Issue created by migration from https://trac.sagemath.org/ticket/10043

Original creator: ncohen

Original creation time: 2010-09-30 22:43:20

Assignee: ncohen

CC:  malb mvngu schilly leif

This (large) patch creates a `backends` directory in the `numerical/` folder.

It adds the following files :

    * glpk_backend.pyx/pxd
    * coin_backend.pyx/pxd
    * cplex_backend.pyx/pxd
    * generic_backend.pyx/pxd

It removes the following files from `numerical`

    * mip_glpk.pyx/pxd
    * mip_coin.pyx/pxd
    * mip_cplex.pyx/pxd
    * osi_interface.pyx/pxd

What for ? There is no a real interface between Sage and all these solvers. Not just a "solve"function that does everything at the same time. It is now much clearer, much more efficient, and it will be faaaaaaaar easier to use solver-specific features. It can now be used directly in Cython, and we can now deal with constraint generation (see patches XXX and XXX), which is a great news.

I know this patch is huge, and I swear I tried to avoid it by considering step-by-step patches, which slowly became a nightmare... The good point in all this is that all the LP-related methods are extensively tested through all the graph methods, which are very likely to detect the important mistakes. I do not doubt there are many left, and I expect this patch to be followed by several "fixes" as these new features are being used, but.... I hope this review will get us rid of most of them !

Thankssssssssss !!!

Nathann


---

Comment by ncohen created at 2010-10-01 08:42:22

Changing status from new to needs_review.


---

Comment by ncohen created at 2010-10-01 13:12:16

(updated to be compatible with alpha2)


---

Comment by ncohen created at 2010-10-11 07:59:07

Rebased on #10043

Nathann


---

Comment by malb created at 2010-10-12 14:29:52

I applied the patch to 4.6.alpha3 without problems and doctests pass. The overall design looks good. However, the documentation is much much too sparse, especially since this is supposed to be a generic interface. All functions should get a docstring describing their expected behaviour and all instantiations should have docstrings testing them (of course, only indirectly since they are cdef'ed). I know it is a lot of work I'm asking for, but I think it is necessary.


---

Comment by malb created at 2010-10-12 14:29:52

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2010-10-12 14:37:47

Replying to [comment:5 malb]:

Hello !

> I applied the patch to 4.6.alpha3 without problems and doctests pass. 

Before anything else, thank you for that `:-)`

> The overall design looks good. However, the documentation is much much too sparse, especially since this is supposed to be a generic interface. All functions should get a docstring describing their expected behaviour and all instantiations should have docstrings testing them (of course, only indirectly since they are cdef'ed). 

Got it. I will document the expected INPUT/OUTPUT, but do you really think doctests are necessary at this level ? As you say, it will be indirect as these methods are all cdef (sage -coverage answers 100% on these files because of that), so as there is a wealth of methods testing them all in the graph/ and numerical/ directory... That's an honest question, as I do not see how to write smarter doctests than just a short example of how LP is used in Sage, and copy/paste it in each function as the same code would test them all...

> I know it is a lot of work I'm asking for, but I think it is necessary.

Indeed. As long as you ask it knowing it means a lot of time, I do not mind doing it (as soon as I will have your advise onthe previous question)

Thanks

Nathann


---

Comment by malb created at 2010-10-12 14:45:45

Replying to [comment:6 ncohen]:
> Got it. I will document the expected INPUT/OUTPUT, but do you really think 
> doctests are necessary at this level ? As you say, it will be indirect as these 
> methods are all cdef (sage -coverage answers 100% on these files because of that), 
> so as there is a wealth of methods testing them all in the graph/ and numerical/ 
> directory... That's an honest question, as I do not see how to write smarter 
> doctests than just a short example of how LP is used in Sage, and copy/paste it in 
> each function as the same code would test them all...

There should at least be doctests in the generic backend class, which highlight how these cdef functions are used. My reason for asking for doctests for all functions in the instantiations is that e.g. the graph class will only test the default LP backend and would not check the other (optional) backends. I'm happy to have the same doctests in all instantiations except that a different solver is used each time. In fact, we could write a template file which has all the doctests in it, and one string replace of e.g. "YOUR_SOLVER" with e.g. "SCIP" would make it easy to have nice coverage of all the functions. Also, the more low level a doctest is, the easier it is to debug a failure.


---

Comment by ncohen created at 2010-10-17 12:41:30

Rewritten... Again. With proper documentation which appear in the reference manual and for each backend (and not only generic_backend), with tests, with.... Well, just improved I hope `:-)`

Nathann


---

Comment by ncohen created at 2010-10-17 12:41:30

Changing status from needs_work to needs_review.


---

Attachment

Hi, a few comments. They are rather nitpicky but since you're defining an interface it would be hard to change any of this at a later time.

 * there is one doctest failure, where you forgot to catch the `NotImplementedError`
 * `getSolver` should be `get_solver` according to Python coding conventions
 * Sage matrices use `ncols()` instead of `n_cols()`, I suggest to do the same for consistency (same for (`nrows`, `add_column` instead of `add_col`)
 * Isn't `set_sense()` the canonical vocabulary instead of `set_direction()`?
 * I think we have a bias in Sage to using `coefficient` instead of `coeff` in function names
 * One could rename `set_log_level` to `set_verbose(_level)()` to match the global function names already defined in Sage (see below for comments on getters and setters)
 * I wonder if it would make sense to rename `add_constraint` to `add_linear_constraint`. Of course, this is a linear programming backend but many of the solvers we support also support non-linear constraints.
 * Sage matrices define `row()` instead of `get_row()`. I guess if you change the name then maybe all `get_XXX()` might be replaced by `XXX()` which seems to conform to Python conventions.
 * In the same spirit one could replace `get/set_variable_min/max` by functions `variable_min/max` which return the value if no optional argument is given and set the value if it is given. Same for similar functions. It seems getter and setter functions are considered unpythonic. http://tomayko.com/writings/getters-setters-fuxors


---

Comment by malb created at 2010-10-18 11:37:25

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2010-10-18 16:46:15

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2010-10-18 16:46:15

After several more hours... All of it is addressed :-)

Nathann


---

Attachment


---

Attachment

I've attached a referee patch which fixes the following issues:
 * Nathan didn't claim copyright but he should, I've also added him as AUTHOR in the docstring
 * `get_objective_coeff` -> `get_objective_coefficient`, it seems to be an oversight that it wasn't renamed
 * removed the optional modules Coin and CPLEX from the reference manual (the produce errors since they cannot be found if they are not installed)

I guess it would be nice to have pickling for these backends but it is unrealistic that it can be implemented for all (or even most) of them. Thus, I'd say if my referee patch is accepted by Nathann, this is good to go.


---

Comment by ncohen created at 2010-10-19 17:52:13

Sorry for this coefficient thing.... I was convinced to have changed it but `^^;`

You're right about this cplex/cbc thing. But maybe we will also have to deal with optional doc, as we already deal with libraries conditionally built according to the spkg installed.

About the copyright, I have a *technical* question : why do you think I should ?.. I often see people adding their names in methods they add, or at the head of files, and I really do not mind as they wrote them themselves... But I tried to "forget it" when I could, not willing to play a patent game I do not like.... Philosophically, I prefer to contribute without really leaving my name, but why do you think these files should be copyrighted ? Isn't it some "sage copyright" by default ?

Nathann


---

Comment by schilly created at 2010-10-19 18:03:23

Replying to [comment:12 ncohen]:
> About the copyright, I have a *technical* question : why do you think I should ?

We license this software via GPLv2+ to everybody. To license something, it needs to have a copyright (reversed, you cannot license something that has no assigned creator). Also, internationally there is nothing like "public domain" like in the usa. We can rely on mercurial to do this, but if somebody only looks at the source there has this to be. You can read more about this in the history of international copyright (e.g. berne convention) and of course in the text of the GPL itself.


---

Comment by ncohen created at 2010-10-19 18:27:41

> We license this software via GPLv2+ to everybody. To license something, it needs to have a copyright (reversed, you cannot license something that has no assigned creator). Also, internationally there is nothing like "public domain" like in the usa. We can rely on mercurial to do this, but if somebody only looks at the source there has this to be. You can read more about this in the history of international copyright (e.g. berne convention) and of course in the text of the GPL itself.

Well, the book I'm reading these days is actually entitled "intellectual property", I'll probably learn about all this pretty soon... It's french law though... I really had no idea there was nothing like "public domain" in the USA !

Thank you for this lesson. 

And thank you *very much* Mike for your help with this ticket !!! :-)

All tests pass. Nothing that worries me for the moment. Positive review to this ticket !

Nathann


---

Comment by ncohen created at 2010-10-19 18:27:41

Changing status from needs_review to positive_review.


---

Comment by schilly created at 2010-10-19 18:34:50

Replying to [comment:14 ncohen]:
> Well, the book I'm reading these days is actually entitled "intellectual property", I'll probably learn about all this pretty soon... 

soon we will consult you about these matters ;)

> It's french law though... I really had no idea there was nothing like "public domain" in the USA !
> 

uhm, i meant, internationally. in the usa exists public domain, but not in other countries and afaik there is no way to apply this us copyright law automatically outside the usa ;) There is also a difference if you want to make something public domain right now or if you want to wait ~80 years.

... and on top of that, things are even more complicated because law changes all the time.


---

Comment by jdemeyer created at 2010-10-23 12:05:38

Same as trac_10043 - review 1.patch


---

Attachment

Please don't put "strange" characters such as spaces in patch filenames.


---

Comment by jdemeyer created at 2010-10-23 12:30:07

Please update the commit message of trac_10043_review1.patch


---

Comment by jdemeyer created at 2010-10-23 12:30:07

Changing status from positive_review to needs_work.


---

Attachment

updated version or review 1 patch : with commit message and no spaces


---

Comment by ncohen created at 2010-10-23 15:47:36

Done !


---

Comment by ncohen created at 2010-10-23 15:47:36

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2010-11-01 10:13:32

Resolution: fixed
