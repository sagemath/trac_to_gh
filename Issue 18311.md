# Issue 18311: Fix a bug introduced in #17792

Issue created by migration from https://trac.sagemath.org/ticket/18548

Original creator: mmasdeu

Original creation time: 2015-05-29 16:15:22

CC:  cremona

Ticket #17792 implemented the solution for the word problem for congruence subgroups of (P)SL2(Z). However, the element represented by the output word sometimes differs from the original element by at most one generator.

Here is an example:

```
sage: G = Gamma0(10)
sage: F = G.farey_symbol()
sage: g = G([-701,-137,4600,899])
sage: word = F.word_problem(g, output = 'syllables')
sage: g1 = prod(F.generators()[i]**a for i,a in word)
sage: g == g1 or g * G([-1,0,0,-1]) == g1
False # Should be True
```


This ticket solves this. I have ran the code below to test:

```
for N in range(2,500):
    G = Gamma0(N)
    print "N = %s"%N
    gens = G.generators()
    F = G.farey_symbol()
    i = 0
    I = G([1,0,0,1])
    E = G([-1,0,0,-1])
    while i < 200:
        c = ZZ.random_element(1000)
        d = ZZ.random_element(1000)
        if gcd(c*N,d) > 1:
            continue
        i += 1
        _,a,b = xgcd(d,-c * N)
        g = G([a,b,c*N,d])
        wd = F.word_problem(g, output = 'syllables')
        g1 = prod(gens[j]**n for j,n in wd)
        assert g * g1**-1 ==  I or g * g1**-1 == E
```

(and also a modification to check Gamma_1(N).


---

Comment by mmasdeu created at 2015-05-29 16:20:05

Changing status from new to needs_review.


---

Comment by chapoton created at 2015-06-01 07:50:46

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-06-01 07:50:46

doc does not build, see patchbot reports


---

Comment by chapoton created at 2015-06-01 07:52:52

you wrongly used `TESTS ::` with one spurious space


---

Comment by git created at 2015-06-01 08:50:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2015-06-01 08:50:38

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2015-06-01 08:50:38

OK, just fixed that. Sorry!


---

Comment by chapoton created at 2015-06-01 08:54:11

In fact, this was not the exact problem. You are misplacing the ::

They should be as follows in your case.

```
TESTS:

some text here::

    sage: 2 + 2
    4
```


And please add doctests to the functions you introduce


---

Comment by git created at 2015-06-01 09:29:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2015-06-01 09:30:38

Hopefully better now. Thanks!


---

Comment by davidloeffler created at 2015-07-02 14:23:37

Looks fine to me.


---

Comment by davidloeffler created at 2015-07-02 14:23:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-02 20:11:21

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-07-02 20:11:21

author name is missing


---

Comment by mmasdeu created at 2015-07-02 22:11:50

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-07-03 10:32:06

Resolution: fixed
