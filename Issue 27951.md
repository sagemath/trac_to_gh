# Issue 27951: MeatAxe arithmetic tables

archive/issues_027951.json:
```json
{
    "body": "CC:  arojas was schilly hsnyder\n\nKeywords: meataxe\n\nIt was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables cannot be found.\n\nThis ticket is to solve that problem. Sage uses a fork of MeatAxe anyway (called SharedMeatAxe) maintained by Simon King, and so one potential solution is to fix it in the fork.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28188\n\n",
    "created_at": "2019-07-13T13:15:20Z",
    "labels": [
        "packages: optional",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "MeatAxe arithmetic tables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27951",
    "user": "SimonKing"
}
```
CC:  arojas was schilly hsnyder

Keywords: meataxe

It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables cannot be found.

This ticket is to solve that problem. Sage uses a fork of MeatAxe anyway (called SharedMeatAxe) maintained by Simon King, and so one potential solution is to fix it in the fork.

Issue created by migration from https://trac.sagemath.org/ticket/28188





---

archive/issue_comments_394759.json:
```json
{
    "body": "In the original report, the problem was on CoCalC. From the description, it didn't become clear to me if the users do not have write permission on `DOT_SAGE` (which would explain the problem) or if `DOT_SAGE` is a symbolic link (which perhaps can be troublesome, too).\n\nCurrently, the arithmetic tables of (Shared)MeatAxe are sought in `$DOT_SAGE/meataxe`, and are created there when they aren't present. I see the following potential solutions:\n1. Instead of using `DOT_SAGE`, use `SAGE_EXT`: The user may not have write permissions, but since MeatAxe can only deal with field sizes less than 255, it would be easy to just create *all* arithmetic tables during package installation (hence, in a situation where write permission is granted and from where all users can read).\n2. It is a design choice of upstream MeatAxe to use arithmetic tables on disk, and load them when the current field is changed. But in our fork SharedMeatAxe, we could of course differ. Hence, whenever the current field is changed, we could compute the arithmetic table on the spot. Of course, when during a session different fields are used, it would avoid some overhead to keep all arithmetic tables in memory, and reuse them.\n3. In case that symbolic links are to blame (I don't know if they are), just address that problem, but keep the design as it is.",
    "created_at": "2019-07-13T13:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394759",
    "user": "SimonKing"
}
```

In the original report, the problem was on CoCalC. From the description, it didn't become clear to me if the users do not have write permission on `DOT_SAGE` (which would explain the problem) or if `DOT_SAGE` is a symbolic link (which perhaps can be troublesome, too).

Currently, the arithmetic tables of (Shared)MeatAxe are sought in `$DOT_SAGE/meataxe`, and are created there when they aren't present. I see the following potential solutions:
1. Instead of using `DOT_SAGE`, use `SAGE_EXT`: The user may not have write permissions, but since MeatAxe can only deal with field sizes less than 255, it would be easy to just create *all* arithmetic tables during package installation (hence, in a situation where write permission is granted and from where all users can read).
2. It is a design choice of upstream MeatAxe to use arithmetic tables on disk, and load them when the current field is changed. But in our fork SharedMeatAxe, we could of course differ. Hence, whenever the current field is changed, we could compute the arithmetic table on the spot. Of course, when during a session different fields are used, it would avoid some overhead to keep all arithmetic tables in memory, and reuse them.
3. In case that symbolic links are to blame (I don't know if they are), just address that problem, but keep the design as it is.



---

archive/issue_comments_394760.json:
```json
{
    "body": "I'd say that the communication with meataxe library can be done via sscanf/sprintf functions\nrather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.",
    "created_at": "2019-07-13T14:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394760",
    "user": "dimpase"
}
```

I'd say that the communication with meataxe library can be done via sscanf/sprintf functions
rather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.



---

archive/issue_comments_394761.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> I'd say that the commincation with meataxe library can be done via sscanf/sprintf functions\n> rather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.\n\nThe routine writing/reading the table doesn't invoke fscanf/fprintf, if I understand correctly (at least not directly). It uses fread/fwrite.\n\nIn any case, I think the first question to be addressed is whether we do want to keep the tables in memory (and potentially lose time for table creation), or want them permanently stored in a file (and potentially lose time because of a slow disk, and have the trouble with write permission).",
    "created_at": "2019-07-13T14:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394761",
    "user": "SimonKing"
}
```

Replying to [comment:2 dimpase]:
> I'd say that the commincation with meataxe library can be done via sscanf/sprintf functions
> rather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.

The routine writing/reading the table doesn't invoke fscanf/fprintf, if I understand correctly (at least not directly). It uses fread/fwrite.

In any case, I think the first question to be addressed is whether we do want to keep the tables in memory (and potentially lose time for table creation), or want them permanently stored in a file (and potentially lose time because of a slow disk, and have the trouble with write permission).



---

archive/issue_comments_394762.json:
```json
{
    "body": "This could also help with the troubles with the data dir creation. Currently, meataxe crashes if MTXLIB(=~/.sage/meataxe) doesn't exist. This doesn't affect sage-the-distro, since the dir is created in meataxe's spkg-install. It does affect distros though, where the package manager is not allowed to touch /home. My current workaround is to create the dir in sage-env, but it would be nice if meataxe itself took care of this.",
    "created_at": "2019-07-13T14:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394762",
    "user": "arojas"
}
```

This could also help with the troubles with the data dir creation. Currently, meataxe crashes if MTXLIB(=~/.sage/meataxe) doesn't exist. This doesn't affect sage-the-distro, since the dir is created in meataxe's spkg-install. It does affect distros though, where the package manager is not allowed to touch /home. My current workaround is to create the dir in sage-env, but it would be nice if meataxe itself took care of this.



---

archive/issue_comments_394763.json:
```json
{
    "body": "If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?\n(If one actually does need to copy them, rather than just to access them directly)",
    "created_at": "2019-07-13T15:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394763",
    "user": "dimpase"
}
```

If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?
(If one actually does need to copy them, rather than just to access them directly)



---

archive/issue_comments_394764.json:
```json
{
    "body": "It looks weird to me to have these files generated along the way. If generating the tables is time consuming (is it?) then the data would better be shipped with the MeatAxe library itself (in some convenient binary format). The data should not take a lot of memory\n\n```\nsage: sum(i*i for i in range(256) if is_prime_power(i) and not is_prime(i)) / 10.**3\n150.113000000000\n```\n\n(the above are supposed to be Ko)",
    "created_at": "2019-07-13T18:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394764",
    "user": "vdelecroix"
}
```

It looks weird to me to have these files generated along the way. If generating the tables is time consuming (is it?) then the data would better be shipped with the MeatAxe library itself (in some convenient binary format). The data should not take a lot of memory

```
sage: sum(i*i for i in range(256) if is_prime_power(i) and not is_prime(i)) / 10.**3
150.113000000000
```

(the above are supposed to be Ko)



---

archive/issue_comments_394765.json:
```json
{
    "body": "these files may be generated during the installation of meataxe, as well.",
    "created_at": "2019-07-13T18:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394765",
    "user": "dimpase"
}
```

these files may be generated during the installation of meataxe, as well.



---

archive/issue_comments_394766.json:
```json
{
    "body": "BTW, have you tried using LinBox? givaro is supposed to support finite fields and the linear algebra in linbox is highly optimized (when it works :-).",
    "created_at": "2019-07-13T18:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394766",
    "user": "vdelecroix"
}
```

BTW, have you tried using LinBox? givaro is supposed to support finite fields and the linear algebra in linbox is highly optimized (when it works :-).



---

archive/issue_comments_394767.json:
```json
{
    "body": "meataxe does representation theory stuff, that's its main purpose; that it can be used just for fast matrix operations is an extra.",
    "created_at": "2019-07-13T18:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394767",
    "user": "dimpase"
}
```

meataxe does representation theory stuff, that's its main purpose; that it can be used just for fast matrix operations is an extra.



---

archive/issue_comments_394768.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?\n> (If one actually does need to copy them, rather than just to access them directly)\n\nI think the idea really is to avoid re-creation of the tables. Compute them once, store them, reload them another day.",
    "created_at": "2019-07-13T20:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394768",
    "user": "SimonKing"
}
```

Replying to [comment:5 dimpase]:
> If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?
> (If one actually does need to copy them, rather than just to access them directly)

I think the idea really is to avoid re-creation of the tables. Compute them once, store them, reload them another day.



---

archive/issue_comments_394769.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> these files may be generated during the installation of meataxe, as well.\n\nThat is one of the potential ways out asmentioned in comment:1.",
    "created_at": "2019-07-13T20:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394769",
    "user": "SimonKing"
}
```

Replying to [comment:7 dimpase]:
> these files may be generated during the installation of meataxe, as well.

That is one of the potential ways out asmentioned in comment:1.



---

archive/issue_comments_394770.json:
```json
{
    "body": "I created tables for all field sizes that meataxe can deal with (i.e., less than 255).\n\n- It was very quick and could thus be done during package installation.\n- The total size of the tables is 9.5MB",
    "created_at": "2019-07-13T20:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394770",
    "user": "SimonKing"
}
```

I created tables for all field sizes that meataxe can deal with (i.e., less than 255).

- It was very quick and could thus be done during package installation.
- The total size of the tables is 9.5MB



---

archive/issue_comments_394771.json:
```json
{
    "body": "FYI: If nobody stops me, I will change `spkg-install` so that the tables will henceforth be ALL installed in `%SAGE_SHARE/meataxe`during package installation.\n\nRationale: Creation of the tables takes at most a few seconds. Moreover, I will not need to change the existing SharedMeatAxe tarball, as the path to the tables is defined by code in the Sage library.",
    "created_at": "2019-07-15T10:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394771",
    "user": "SimonKing"
}
```

FYI: If nobody stops me, I will change `spkg-install` so that the tables will henceforth be ALL installed in `%SAGE_SHARE/meataxe`during package installation.

Rationale: Creation of the tables takes at most a few seconds. Moreover, I will not need to change the existing SharedMeatAxe tarball, as the path to the tables is defined by code in the Sage library.



---

archive/issue_comments_394772.json:
```json
{
    "body": "Yes please, go ahead, I'll be happy to approve this.",
    "created_at": "2019-07-15T10:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394772",
    "user": "dimpase"
}
```

Yes please, go ahead, I'll be happy to approve this.



---

archive/issue_comments_394773.json:
```json
{
    "body": "It is (I think) required that the tables are created, BEFORE the optional `matrix_gfpn_dense` Cython module is available.\n\nTherefore, I want to trigger creation of the tables using one of the MeatAxe executables. I find `zcv` convenient --- to some extent:\n- Let `input` be a file consisting of the single line `matrix field=25 rows=0 cols=0`.\n- Then, the command `zcv input output` will create a file called `output` describing an empty matrix in binary format, and will, as a side-effect, create `p025.zzz` in the current directory. Of course I am only interested in the side-effect; the file `output` can safely be deleted.\n\nThe question is how to do the above in a loop, where `field=...` runs over all available field sizes. According to [MeatAxe documentation](https://www.mankier.com/1/zcv), `zcv - output` should read the input from stdin, but apparently it doesn't.\n\nIs there a way to pretend that a program such as `zcv` reads input from a file? If not: How do I create the input file using a shell script and apply `zcv` to it without risking to be affected by race conditions?",
    "created_at": "2019-07-15T11:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394773",
    "user": "SimonKing"
}
```

It is (I think) required that the tables are created, BEFORE the optional `matrix_gfpn_dense` Cython module is available.

Therefore, I want to trigger creation of the tables using one of the MeatAxe executables. I find `zcv` convenient --- to some extent:
- Let `input` be a file consisting of the single line `matrix field=25 rows=0 cols=0`.
- Then, the command `zcv input output` will create a file called `output` describing an empty matrix in binary format, and will, as a side-effect, create `p025.zzz` in the current directory. Of course I am only interested in the side-effect; the file `output` can safely be deleted.

The question is how to do the above in a loop, where `field=...` runs over all available field sizes. According to [MeatAxe documentation](https://www.mankier.com/1/zcv), `zcv - output` should read the input from stdin, but apparently it doesn't.

Is there a way to pretend that a program such as `zcv` reads input from a file? If not: How do I create the input file using a shell script and apply `zcv` to it without risking to be affected by race conditions?



---

archive/issue_comments_394774.json:
```json
{
    "body": "Would the following be safe against race conditions?\n\n```\nfor i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251\ndo\n  echo \"matrix field=$i rows=0 cols=0\">test | zcv test outtest\ndone\n```\n\nPS: The above takes about 1 second on my laptop.",
    "created_at": "2019-07-15T11:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394774",
    "user": "SimonKing"
}
```

Would the following be safe against race conditions?

```
for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
  echo "matrix field=$i rows=0 cols=0">test | zcv test outtest
done
```

PS: The above takes about 1 second on my laptop.



---

archive/issue_comments_394775.json:
```json
{
    "body": "No need to create a file, just do\n\n```\n$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251\ndo\n   zcv <(echo \"matrix field=$i rows=0 cols=0\") /dev/null\ndone\n```\n",
    "created_at": "2019-07-15T12:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394775",
    "user": "dimpase"
}
```

No need to create a file, just do

```
$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null
done
```




---

archive/issue_comments_394776.json:
```json
{
    "body": "Replying to [comment:17 dimpase]:\n> No need to create a file, just do\n> {{{\n> $ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251\n> do\n>    zcv <(echo \"matrix field=$i rows=0 cols=0\") /dev/null\n> done\n> }}}\n\nThank you! That was exactly what I was looking for.\n\nBefore I create a branch: The upstream tarball will not change. But shall the Sage package version be bumped from `1.0` to `1.0.p0`?",
    "created_at": "2019-07-15T20:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394776",
    "user": "SimonKing"
}
```

Replying to [comment:17 dimpase]:
> No need to create a file, just do
> {{{
> $ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
> do
>    zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null
> done
> }}}

Thank you! That was exactly what I was looking for.

Before I create a branch: The upstream tarball will not change. But shall the Sage package version be bumped from `1.0` to `1.0.p0`?



---

archive/issue_comments_394777.json:
```json
{
    "body": "yes, do bump up the version, to cause the reinstallation of the package.",
    "created_at": "2019-07-15T20:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394777",
    "user": "dimpase"
}
```

yes, do bump up the version, to cause the reinstallation of the package.



---

archive/issue_comments_394778.json:
```json
{
    "body": "Ideally, when `zcv` fails in one iteration of the loop, the install script should abort. How to achieve this?\n\n```\n$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251\ndo\n   zcv <(echo \"matrix field=$i rows=0 cols=0\") /dev/null  ||  sdh_die\ndone\n```\n\n?",
    "created_at": "2019-07-15T22:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394778",
    "user": "SimonKing"
}
```

Ideally, when `zcv` fails in one iteration of the loop, the install script should abort. How to achieve this?

```
$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null  ||  sdh_die
done
```

?



---

archive/issue_comments_394779.json:
```json
{
    "body": "well, if `zcv` produces an error code, indeed, then something like this ought to work.\nYou may try to see if this works by passing it `i=6`, say...",
    "created_at": "2019-07-15T22:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394779",
    "user": "dimpase"
}
```

well, if `zcv` produces an error code, indeed, then something like this ought to work.
You may try to see if this works by passing it `i=6`, say...



---

archive/issue_comments_394780.json:
```json
{
    "body": "Can someone please explain what is going wrong here?\n\n```\n# Delete old (Shared)MeatAxe libraries. This ensures a sane state if\n# installation of this package fails: the mtx library should exist if\n# and only if meataxe is installed. In detail: the build-time check in\n# src/module_list.py checks whether or not the \"meataxe\" package is\n# marked as installed but the run-time check for the matrix_gfpn_dense\n# module checks whether it can be imported. We need to ensure that these\n# two conditions are equivalent, otherwise strange things can happen.\n# See also https://trac.sagemath.org/ticket/24359#comment:154\n#\n# This also deletes the static library left behind from the installation\n# of MeatAxe (as opposed to SharedMeatAxe).\nrm -f \"$SAGE_LOCAL\"/lib/libmtx.*\n\n# This is the place where arithmetic tables and some other input files\n# are searched by default.\nexport MTXLIB=\"$SAGE_SHARE\"/meataxe\n\n# Directory where executables are installed.\nexport MTXBIN=\"$SAGE_LOCAL\"/bin\n\n# Field size up to GF(256)\nexport ZZZ=0\n\n# We create a directory for the multiplication tables\nmkdir -p $MTXLIB || \\\n    sdh_die \"Error creating directory for multiplication tables\"\n\ncd src\nsdh_configure\nsdh_make\nsdh_make_install\n\nif [ \"$SAGE_SPKG_INSTALL_DOCS\" = yes ] ; then\n    $MAKE doc || sdh_die \"Error documenting SharedMeatAxe\"\nfi\n\ncd $MTXLIB\nfor i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251\ndo\n   zcv <(echo \"matrix field=$i rows=0 cols=0\") /dev/null  ||  sdh_die \"Error creating multiplication table for field of size $i\"\ndone\n```\n\nThe above spkg-install script is supposed to install the MeatAxe executables (including zcv) in `$SAGE_LOCAL/bin`. It DOES install it when the spkg-install script ends before `cd $MTXLIB`.\n\nHowever, according to the error message, zcv is in fact not installed when it is needed. Why?\n\nOn the bright side, `... || sdh_die` works as expected.",
    "created_at": "2019-07-15T22:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394780",
    "user": "SimonKing"
}
```

Can someone please explain what is going wrong here?

```
# Delete old (Shared)MeatAxe libraries. This ensures a sane state if
# installation of this package fails: the mtx library should exist if
# and only if meataxe is installed. In detail: the build-time check in
# src/module_list.py checks whether or not the "meataxe" package is
# marked as installed but the run-time check for the matrix_gfpn_dense
# module checks whether it can be imported. We need to ensure that these
# two conditions are equivalent, otherwise strange things can happen.
# See also https://trac.sagemath.org/ticket/24359#comment:154
#
# This also deletes the static library left behind from the installation
# of MeatAxe (as opposed to SharedMeatAxe).
rm -f "$SAGE_LOCAL"/lib/libmtx.*

# This is the place where arithmetic tables and some other input files
# are searched by default.
export MTXLIB="$SAGE_SHARE"/meataxe

# Directory where executables are installed.
export MTXBIN="$SAGE_LOCAL"/bin

# Field size up to GF(256)
export ZZZ=0

# We create a directory for the multiplication tables
mkdir -p $MTXLIB || \
    sdh_die "Error creating directory for multiplication tables"

cd src
sdh_configure
sdh_make
sdh_make_install

if [ "$SAGE_SPKG_INSTALL_DOCS" = yes ] ; then
    $MAKE doc || sdh_die "Error documenting SharedMeatAxe"
fi

cd $MTXLIB
for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null  ||  sdh_die "Error creating multiplication table for field of size $i"
done
```

The above spkg-install script is supposed to install the MeatAxe executables (including zcv) in `$SAGE_LOCAL/bin`. It DOES install it when the spkg-install script ends before `cd $MTXLIB`.

However, according to the error message, zcv is in fact not installed when it is needed. Why?

On the bright side, `... || sdh_die` works as expected.



---

archive/issue_comments_394781.json:
```json
{
    "body": "I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; \nprobably due to the fact that before `spkg-install` terminates, the access to its result is not assured.",
    "created_at": "2019-07-15T22:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394781",
    "user": "dimpase"
}
```

I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; 
probably due to the fact that before `spkg-install` terminates, the access to its result is not assured.



---

archive/issue_comments_394782.json:
```json
{
    "body": "Replying to [comment:23 dimpase]:\n> I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; \n> probably due to the fact that before `spkg-install` terminates, the access to its result is not assured.\n\nYes, this seems to work!\n\nShall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.",
    "created_at": "2019-07-15T22:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394782",
    "user": "SimonKing"
}
```

Replying to [comment:23 dimpase]:
> I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; 
> probably due to the fact that before `spkg-install` terminates, the access to its result is not assured.

Yes, this seems to work!

Shall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.



---

archive/issue_comments_394783.json:
```json
{
    "body": "Replying to [comment:24 SimonKing]:\n\n> Shall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.\n\nif it works then there is no need to fiddle around more with it, IMHO.",
    "created_at": "2019-07-15T23:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394783",
    "user": "dimpase"
}
```

Replying to [comment:24 SimonKing]:

> Shall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.

if it works then there is no need to fiddle around more with it, IMHO.



---

archive/issue_comments_394784.json:
```json
{
    "body": "Good news: The rather minimal change (which doesn't affect the upstream tarball) works. Bad news: I will need to change `p_group_cohomology', as apparently the old location of the meataxe tables is hard-coded in `p_group_cohomology`.\n\nDo you see a way out?\n\nEDIT: The group cohomology package fails because I explicitly deleted `$DOT_SAGE/meataxe`. A user who does not manually delete `$DOT_SAGE/meataxe` will not be affected: `p_group_cohomology` will simply create new tables in `$DOT_SAGE/meataxe`.",
    "created_at": "2019-07-15T23:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394784",
    "user": "SimonKing"
}
```

Good news: The rather minimal change (which doesn't affect the upstream tarball) works. Bad news: I will need to change `p_group_cohomology', as apparently the old location of the meataxe tables is hard-coded in `p_group_cohomology`.

Do you see a way out?

EDIT: The group cohomology package fails because I explicitly deleted `$DOT_SAGE/meataxe`. A user who does not manually delete `$DOT_SAGE/meataxe` will not be affected: `p_group_cohomology` will simply create new tables in `$DOT_SAGE/meataxe`.



---

archive/issue_comments_394785.json:
```json
{
    "body": "well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...",
    "created_at": "2019-07-15T23:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394785",
    "user": "dimpase"
}
```

well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...



---

archive/issue_comments_394786.json:
```json
{
    "body": "Replying to [comment:27 dimpase]:\n> well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...\n\nProbably not. As mentioned in comment:26, `p_group_cohomology` expects the location of the tables in `$DOT_SAGE/meataxe`. Really the location should be exposed in `sage/libs/meataxe` and imported from there. So, there must be a follow-up ticket for `p_group_cohomology`",
    "created_at": "2019-07-15T23:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394786",
    "user": "SimonKing"
}
```

Replying to [comment:27 dimpase]:
> well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...

Probably not. As mentioned in comment:26, `p_group_cohomology` expects the location of the tables in `$DOT_SAGE/meataxe`. Really the location should be exposed in `sage/libs/meataxe` and imported from there. So, there must be a follow-up ticket for `p_group_cohomology`



---

archive/issue_comments_394787.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-16T00:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394787",
    "user": "SimonKing"
}
```

New commits:



---

archive/issue_comments_394788.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-16T00:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394788",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_394789.json:
```json
{
    "body": "The follow-up ticket is #28204",
    "created_at": "2019-07-16T00:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394789",
    "user": "SimonKing"
}
```

The follow-up ticket is #28204



---

archive/issue_comments_394790.json:
```json
{
    "body": "Concerning #28204: `p_group_cohomology` uses some MeatAxe \"applications\", which learn the location of the multiplication tables from an environment variable. Would you think that **here** we should add the corresponding environment variable to `sage_env`?\n\nEDIT: Shall `MTXLIB` be exported even if `meataxe` is not installed?",
    "created_at": "2019-07-16T00:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394790",
    "user": "SimonKing"
}
```

Concerning #28204: `p_group_cohomology` uses some MeatAxe "applications", which learn the location of the multiplication tables from an environment variable. Would you think that **here** we should add the corresponding environment variable to `sage_env`?

EDIT: Shall `MTXLIB` be exported even if `meataxe` is not installed?



---

archive/issue_comments_394791.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-07-16T00:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394791",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_394792.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-16T07:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394792",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394793.json:
```json
{
    "body": "Questions: How can I achieve that `MTXLIB` (which is defined in `sage.env` by the new commit) will be exported into the sage shell? Would it be OK to automatically export it?\n\nMeatAxe \"applications\" (i.e., stand-alone programs) need that environment variable to properly work (otherwise, they don't know where to find multiplication tables and will thus create new tables in the current directory).",
    "created_at": "2019-07-16T07:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394793",
    "user": "SimonKing"
}
```

Questions: How can I achieve that `MTXLIB` (which is defined in `sage.env` by the new commit) will be exported into the sage shell? Would it be OK to automatically export it?

MeatAxe "applications" (i.e., stand-alone programs) need that environment variable to properly work (otherwise, they don't know where to find multiplication tables and will thus create new tables in the current directory).



---

archive/issue_comments_394794.json:
```json
{
    "body": "AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.",
    "created_at": "2019-07-16T08:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394794",
    "user": "dimpase"
}
```

AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.



---

archive/issue_comments_394795.json:
```json
{
    "body": "Replying to [comment:36 dimpase]:\n> AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.\n\nI see. Perhaps I could do both? After all, we are dealing with the MeatAxe library on the one hand (for this, some `cdef extern` variable is set) and MeatAxe applications on the other hand (for this, we need an environment variable.",
    "created_at": "2019-07-16T08:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394795",
    "user": "SimonKing"
}
```

Replying to [comment:36 dimpase]:
> AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.

I see. Perhaps I could do both? After all, we are dealing with the MeatAxe library on the one hand (for this, some `cdef extern` variable is set) and MeatAxe applications on the other hand (for this, we need an environment variable.



---

archive/issue_comments_394796.json:
```json
{
    "body": "You certainly can do both, why not?",
    "created_at": "2019-07-16T08:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394796",
    "user": "dimpase"
}
```

You certainly can do both, why not?



---

archive/issue_comments_394797.json:
```json
{
    "body": "Replying to [comment:38 dimpase]:\n> You certainly can do both, why not?\n\nEnvironmental pollution...\n\nBut it would slightly simplify the install script, too.",
    "created_at": "2019-07-16T08:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394797",
    "user": "SimonKing"
}
```

Replying to [comment:38 dimpase]:
> You certainly can do both, why not?

Environmental pollution...

But it would slightly simplify the install script, too.



---

archive/issue_comments_394798.json:
```json
{
    "body": "I don't know much about Cython, except that in some cases one puts in the pxd file\nsomething like\n\n```\n# distutils: libraries = gmp flint arb\n```\n\n(this is from `src/sage/libs/arb/arb.pxd`)\nto tell the linker, in this case, to link with `-lgmp -lflint -larb`\n\nI have no idea how Cython handles linking without these sorts of directives.\n(More precisly, I know this can be done within `setup.py`, but often there is no `setup.py` for a particular Cython extension...)",
    "created_at": "2019-07-16T08:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394798",
    "user": "dimpase"
}
```

I don't know much about Cython, except that in some cases one puts in the pxd file
something like

```
# distutils: libraries = gmp flint arb
```

(this is from `src/sage/libs/arb/arb.pxd`)
to tell the linker, in this case, to link with `-lgmp -lflint -larb`

I have no idea how Cython handles linking without these sorts of directives.
(More precisly, I know this can be done within `setup.py`, but often there is no `setup.py` for a particular Cython extension...)



---

archive/issue_comments_394799.json:
```json
{
    "body": "Replying to [comment:40 dimpase]:\n> I don't know much about Cython, except that in some cases one puts in the pxd file\n> something like\n> {{{\n> # distutils: libraries = gmp flint arb\n> }}}\n> (this is from `src/sage/libs/arb/arb.pxd`)\n> to tell the linker, in this case, to link with `-lgmp -lflint -larb`\n> \n> I have no idea how Cython handles linking without these sorts of directives.\n\nIt is totally unrelated with linking. It is an `extern char*` variable that is supposed to be defined at runtime.",
    "created_at": "2019-07-16T08:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394799",
    "user": "SimonKing"
}
```

Replying to [comment:40 dimpase]:
> I don't know much about Cython, except that in some cases one puts in the pxd file
> something like
> {{{
> # distutils: libraries = gmp flint arb
> }}}
> (this is from `src/sage/libs/arb/arb.pxd`)
> to tell the linker, in this case, to link with `-lgmp -lflint -larb`
> 
> I have no idea how Cython handles linking without these sorts of directives.

It is totally unrelated with linking. It is an `extern char*` variable that is supposed to be defined at runtime.



---

archive/issue_comments_394800.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-16T08:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394800",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394801.json:
```json
{
    "body": "I think the current proposition is a clean approach: Define `MTXLIB` in `sage-env` as an environment variable, and derive all other usage of the table locations from there. In that way, there will never be an inconsistency. And in #28204, I can simplify the `p_group_cohomology` package.",
    "created_at": "2019-07-16T08:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394801",
    "user": "SimonKing"
}
```

I think the current proposition is a clean approach: Define `MTXLIB` in `sage-env` as an environment variable, and derive all other usage of the table locations from there. In that way, there will never be an inconsistency. And in #28204, I can simplify the `p_group_cohomology` package.



---

archive/issue_comments_394802.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-16T08:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394802",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_394803.json:
```json
{
    "body": "Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables? This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)",
    "created_at": "2019-07-16T10:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394803",
    "user": "arojas"
}
```

Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables? This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)



---

archive/issue_comments_394804.json:
```json
{
    "body": "Replying to [comment:44 arojas]:\n> Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?\n\nYes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.\n\n> This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)\n\nI don't understand that. Are you saying that on some platforms it will NOT be possible to let `MTXLIB` be defined by Sage as an environment variable? In any case, I was not aware that var uses the env variable when possible.",
    "created_at": "2019-07-16T10:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394804",
    "user": "SimonKing"
}
```

Replying to [comment:44 arojas]:
> Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?

Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.

> This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)

I don't understand that. Are you saying that on some platforms it will NOT be possible to let `MTXLIB` be defined by Sage as an environment variable? In any case, I was not aware that var uses the env variable when possible.



---

archive/issue_comments_394805.json:
```json
{
    "body": "In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.",
    "created_at": "2019-07-16T10:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394805",
    "user": "dimpase"
}
```

In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.



---

archive/issue_comments_394806.json:
```json
{
    "body": "Replying to [comment:45 SimonKing]:\n> Replying to [comment:44 arojas]:\n> > Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?\n> \n> Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.\n\nEvery env variable defined in sage-env has the same path set as fallback in env.py, I don't see why this one should be different - the env.py one is just a fallback, if the env variable is defined it will be used.\n\nThis is not only useful for distros that don't provide sage-env, but also for using sage as a python library - 'from sage.all import *' does not import the env variables defined in sage-env",
    "created_at": "2019-07-16T11:01:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394806",
    "user": "arojas"
}
```

Replying to [comment:45 SimonKing]:
> Replying to [comment:44 arojas]:
> > Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?
> 
> Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.

Every env variable defined in sage-env has the same path set as fallback in env.py, I don't see why this one should be different - the env.py one is just a fallback, if the env variable is defined it will be used.

This is not only useful for distros that don't provide sage-env, but also for using sage as a python library - 'from sage.all import *' does not import the env variables defined in sage-env



---

archive/issue_comments_394807.json:
```json
{
    "body": "Replying to [comment:47 arojas]:\n> Replying to [comment:45 SimonKing]:\n> > Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.\n> \n> Every env variable defined in sage-env has the same path set as fallback in env.py,\n\nI was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?",
    "created_at": "2019-07-16T12:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394807",
    "user": "SimonKing"
}
```

Replying to [comment:47 arojas]:
> Replying to [comment:45 SimonKing]:
> > Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.
> 
> Every env variable defined in sage-env has the same path set as fallback in env.py,

I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?



---

archive/issue_comments_394808.json:
```json
{
    "body": "Replying to [comment:46 dimpase]:\n> In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.\n\nI think it doesn't matter whether a system-wide meataxe or the meataxe spkg is used (except that the original `MeatAxe` is clearly inferior to its fork `SharedMeatAxe` and that the Sage wrapper uses some functions that only exist in the fork).\n\nIn any case, when a meataxe application or any program using meataxe library functions is executed, it will be needed to use arithmetic tables. When they cannot be found, they will be created.\n\nSo, the following implications hold regardless whether spkg-meataxe or system-meataxe is used:\n- If the environment variable `MTXLIB` is undefined, meataxe applications will search and potentially write tables to the current directory. If the `extern char*` variable `MtxLibDir` is undefined, meataxe library functions will search and potentially write tables to the current directory.\n\n  => Since we do not want to pollute the user's current directory, we **have to** define both environment and cdef extern variables.\n- If the tables already exist at the location pointed at by the variables, we need that the user has read permission. Otherwise, there will be an error.\n- If the tables do not already exist, the folder pointed at by the variables needs to exist and the user needs to have write permission. Otherwise. there will be an error.\n\nSo, our requirements, regardless what source we take meataxe from, are as follows:\n- Sage needs to define one environment and one extern C variable. The former should be in sage-env, the latter in sage.libs.meataxe, I suppose.\n- It is not a strict requirement that both variables are equal, but of course it would be nice. In any case, we have to make sure that either\n  * the arithmetic tables are present at the given folder (and the user can read them), or\n  * the user has write permission at the given folder.\n  \n  A system wide meataxe wouldn't mind that the folder is inside of the Sage tree.\n\n**Question:** What should we do?",
    "created_at": "2019-07-16T13:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394808",
    "user": "SimonKing"
}
```

Replying to [comment:46 dimpase]:
> In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.

I think it doesn't matter whether a system-wide meataxe or the meataxe spkg is used (except that the original `MeatAxe` is clearly inferior to its fork `SharedMeatAxe` and that the Sage wrapper uses some functions that only exist in the fork).

In any case, when a meataxe application or any program using meataxe library functions is executed, it will be needed to use arithmetic tables. When they cannot be found, they will be created.

So, the following implications hold regardless whether spkg-meataxe or system-meataxe is used:
- If the environment variable `MTXLIB` is undefined, meataxe applications will search and potentially write tables to the current directory. If the `extern char*` variable `MtxLibDir` is undefined, meataxe library functions will search and potentially write tables to the current directory.

  => Since we do not want to pollute the user's current directory, we **have to** define both environment and cdef extern variables.
- If the tables already exist at the location pointed at by the variables, we need that the user has read permission. Otherwise, there will be an error.
- If the tables do not already exist, the folder pointed at by the variables needs to exist and the user needs to have write permission. Otherwise. there will be an error.

So, our requirements, regardless what source we take meataxe from, are as follows:
- Sage needs to define one environment and one extern C variable. The former should be in sage-env, the latter in sage.libs.meataxe, I suppose.
- It is not a strict requirement that both variables are equal, but of course it would be nice. In any case, we have to make sure that either
  * the arithmetic tables are present at the given folder (and the user can read them), or
  * the user has write permission at the given folder.
  
  A system wide meataxe wouldn't mind that the folder is inside of the Sage tree.

**Question:** What should we do?



---

archive/issue_comments_394809.json:
```json
{
    "body": "Replying to [comment:48 SimonKing]:\n> I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?\n\nApparently it is the latter.",
    "created_at": "2019-07-16T13:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394809",
    "user": "SimonKing"
}
```

Replying to [comment:48 SimonKing]:
> I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?

Apparently it is the latter.



---

archive/issue_comments_394810.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-16T13:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394810",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394811.json:
```json
{
    "body": "Replying to [comment:50 SimonKing]:\n> Replying to [comment:48 SimonKing]:\n> > I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?\n> \n> Apparently it is the latter.\n\nNo, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.",
    "created_at": "2019-07-16T13:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394811",
    "user": "arojas"
}
```

Replying to [comment:50 SimonKing]:
> Replying to [comment:48 SimonKing]:
> > I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?
> 
> Apparently it is the latter.

No, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.



---

archive/issue_comments_394812.json:
```json
{
    "body": "Replying to [comment:52 arojas]:\n> No, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.\n\nMy rationale was: As stated in comment:49, if FooBar uses meataxe, then FooBar has to take care that it defines `MTXLIB` (the environment variable). Otherwise it is a bug in FooBar that results in a pollution of the current directory.\n\nSo, if FooBar uses meataxe via Sage, then the environment variable should be present.\n\nHm. I just think that one can see it the other way around: If FooBar uses meataxe only via Sage, then we cannot assume that FooBar is an expert in the internals of meataxe. So, it is Sage's responsibility to provide the environment variable, after all.\n\nHow can one define an environment variable in Python code? Would it be `os.environ['MTXLIB']=\"...\"`?",
    "created_at": "2019-07-16T13:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394812",
    "user": "SimonKing"
}
```

Replying to [comment:52 arojas]:
> No, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.

My rationale was: As stated in comment:49, if FooBar uses meataxe, then FooBar has to take care that it defines `MTXLIB` (the environment variable). Otherwise it is a bug in FooBar that results in a pollution of the current directory.

So, if FooBar uses meataxe via Sage, then the environment variable should be present.

Hm. I just think that one can see it the other way around: If FooBar uses meataxe only via Sage, then we cannot assume that FooBar is an expert in the internals of meataxe. So, it is Sage's responsibility to provide the environment variable, after all.

How can one define an environment variable in Python code? Would it be `os.environ['MTXLIB']="..."`?



---

archive/issue_comments_394813.json:
```json
{
    "body": "the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?",
    "created_at": "2019-07-16T13:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394813",
    "user": "arojas"
}
```

the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?



---

archive/issue_comments_394814.json:
```json
{
    "body": "Replying to [comment:54 arojas]:\n> the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?\n\nI don't know what you mean by \"user's global env\". It needs to be present when you call an executable in a sage shell.",
    "created_at": "2019-07-16T13:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394814",
    "user": "SimonKing"
}
```

Replying to [comment:54 arojas]:
> the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?

I don't know what you mean by "user's global env". It needs to be present when you call an executable in a sage shell.



---

archive/issue_comments_394815.json:
```json
{
    "body": "Replying to [comment:55 SimonKing]:\n> I don't know what you mean by \"user's global env\". It needs to be present when you call an executable in a sage shell.\n\nPS: You do not need it when you just use meataxe as a backend for matrices over finite fields. You do need it when you call a meataxe application, though, which is the case for `p_group_cohomology` (see #28204)",
    "created_at": "2019-07-16T13:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394815",
    "user": "SimonKing"
}
```

Replying to [comment:55 SimonKing]:
> I don't know what you mean by "user's global env". It needs to be present when you call an executable in a sage shell.

PS: You do not need it when you just use meataxe as a backend for matrices over finite fields. You do need it when you call a meataxe application, though, which is the case for `p_group_cohomology` (see #28204)



---

archive/issue_comments_394816.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-16T13:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394816",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394817.json:
```json
{
    "body": "In the latest commit, I use a fallback in sage.env, in the case that sage-env is not executed. And in addition, when sage.libs.meataxe is imported, the value `sage.env.MTXLIB` is put into os.environ. I hope that's good enough to make the presence of the environment variable MTXLIB very likely, even when sage-env isn't called.",
    "created_at": "2019-07-16T14:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394817",
    "user": "SimonKing"
}
```

In the latest commit, I use a fallback in sage.env, in the case that sage-env is not executed. And in addition, when sage.libs.meataxe is imported, the value `sage.env.MTXLIB` is put into os.environ. I hope that's good enough to make the presence of the environment variable MTXLIB very likely, even when sage-env isn't called.



---

archive/issue_comments_394818.json:
```json
{
    "body": "Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:\n\n- sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.\n- sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.\n- Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.\n\nDo you like the above better than what is in the current commits?",
    "created_at": "2019-07-16T15:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394818",
    "user": "SimonKing"
}
```

Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:

- sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.
- sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.
- Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.

Do you like the above better than what is in the current commits?



---

archive/issue_comments_394819.json:
```json
{
    "body": "Replying to [comment:59 SimonKing]:\n> Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:\n> \n> - sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.\n> - sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.\n> - Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.\n> \n> Do you like the above better than what is in the current commits?\n\nIIUC the difference between this and the current state of the branch is whether MTXLIB is defined or not in sage-env, right? In that case, either way is fine for me - I'm only worried about what happens when sage-env is not imported, and the latest commit in env.py takes care of this.",
    "created_at": "2019-07-16T16:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394819",
    "user": "arojas"
}
```

Replying to [comment:59 SimonKing]:
> Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:
> 
> - sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.
> - sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.
> - Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.
> 
> Do you like the above better than what is in the current commits?

IIUC the difference between this and the current state of the branch is whether MTXLIB is defined or not in sage-env, right? In that case, either way is fine for me - I'm only worried about what happens when sage-env is not imported, and the latest commit in env.py takes care of this.



---

archive/issue_comments_394820.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-16T17:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394820",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394821.json:
```json
{
    "body": "With the latest commit, we have this:\n- If the user exports `MTXLIB` and then installs `meataxe`, then the folder `$MTXLIB` will be created; otherwise a default location is chosen and the folder created.\n- If the user exports `MTXLIB` and then starts Sage, then sage.env.MTXLIB will be set accordingly; otherwise, a default location is used.\n- Sage will define the `extern char*` variable `MtxLibDir` to comply with sage.env.MTXLIB when sage.meataxe is first imported. That variable is all what we need in sage.matrix.matrix_gfpn_dense.\n- If someone wants to use meataxe applications, then it is not Sage's responsibility to export MTXLIB.\n\nI tested that `sage -f -c meataxe` works and `sage -t src/sage/matrix/matrix_gfpn_dense.pyx` works without error. So, needs review! And I guess it should be verified that meataxe now works in CoCalC.",
    "created_at": "2019-07-16T17:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394821",
    "user": "SimonKing"
}
```

With the latest commit, we have this:
- If the user exports `MTXLIB` and then installs `meataxe`, then the folder `$MTXLIB` will be created; otherwise a default location is chosen and the folder created.
- If the user exports `MTXLIB` and then starts Sage, then sage.env.MTXLIB will be set accordingly; otherwise, a default location is used.
- Sage will define the `extern char*` variable `MtxLibDir` to comply with sage.env.MTXLIB when sage.meataxe is first imported. That variable is all what we need in sage.matrix.matrix_gfpn_dense.
- If someone wants to use meataxe applications, then it is not Sage's responsibility to export MTXLIB.

I tested that `sage -f -c meataxe` works and `sage -t src/sage/matrix/matrix_gfpn_dense.pyx` works without error. So, needs review! And I guess it should be verified that meataxe now works in CoCalC.



---

archive/issue_comments_394822.json:
```json
{
    "body": "First of all, it would be good to update the ticket description with the problem that this ticket is trying to solve (I didn't follow all comments in this ticket). After all, it's difficult to review a solution when you don't know what problem it is meant to solve.\n\nSecond, why are you not defining `MTXLIB` in `src/bin/sage-env` like other similar environment variables? Then you can just refer to `$MTXLIB` unconditionally in your scripts.",
    "created_at": "2019-07-17T09:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394822",
    "user": "jdemeyer"
}
```

First of all, it would be good to update the ticket description with the problem that this ticket is trying to solve (I didn't follow all comments in this ticket). After all, it's difficult to review a solution when you don't know what problem it is meant to solve.

Second, why are you not defining `MTXLIB` in `src/bin/sage-env` like other similar environment variables? Then you can just refer to `$MTXLIB` unconditionally in your scripts.



---

archive/issue_comments_394823.json:
```json
{
    "body": "Replying to [ticket:28188 SimonKing]:\n> It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.\n\nDo we know what these \"some situations\" are? I'm asking because, while I agree with the patch, I disagree with the patch *as fix for this problem*. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?",
    "created_at": "2019-07-17T10:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394823",
    "user": "jdemeyer"
}
```

Replying to [ticket:28188 SimonKing]:
> It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.

Do we know what these "some situations" are? I'm asking because, while I agree with the patch, I disagree with the patch *as fix for this problem*. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?



---

archive/issue_comments_394824.json:
```json
{
    "body": "Replying to [comment:67 jdemeyer]:\n> Replying to [ticket:28188 SimonKing]:\n> > It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.\n> \n> Do we know what these \"some situations\" are? I'm asking because, while I agree with the patch, I disagree with the patch *as fix for this problem*. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?\n\n\"some situations\" arise on CoCalc. In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.",
    "created_at": "2019-07-17T10:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394824",
    "user": "dimpase"
}
```

Replying to [comment:67 jdemeyer]:
> Replying to [ticket:28188 SimonKing]:
> > It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.
> 
> Do we know what these "some situations" are? I'm asking because, while I agree with the patch, I disagree with the patch *as fix for this problem*. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?

"some situations" arise on CoCalc. In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.



---

archive/issue_comments_394825.json:
```json
{
    "body": "I'd keep `export MTXLIB=\"$SAGE_SHARE/meataxe\"` in `src/bin/sage-env`, as I gather it's needed for running `meataxe` at Sage's shell prompt. No need to break (or not to introduce) this capability with this patch.",
    "created_at": "2019-07-17T10:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394825",
    "user": "dimpase"
}
```

I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`, as I gather it's needed for running `meataxe` at Sage's shell prompt. No need to break (or not to introduce) this capability with this patch.



---

archive/issue_comments_394826.json:
```json
{
    "body": "Replying to [comment:69 dimpase]:\n> I'd keep `export MTXLIB=\"$SAGE_SHARE/meataxe\"` in `src/bin/sage-env`\n\nWhat do you mean with \"keep\"? It's not there and this branch doesn't add it.",
    "created_at": "2019-07-17T10:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394826",
    "user": "jdemeyer"
}
```

Replying to [comment:69 dimpase]:
> I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`

What do you mean with "keep"? It's not there and this branch doesn't add it.



---

archive/issue_comments_394827.json:
```json
{
    "body": "Replying to [comment:68 dimpase]:\n> In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.\n\nSure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.",
    "created_at": "2019-07-17T10:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394827",
    "user": "jdemeyer"
}
```

Replying to [comment:68 dimpase]:
> In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.

Sure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.



---

archive/issue_comments_394828.json:
```json
{
    "body": "Replying to [comment:71 jdemeyer]:\n> Replying to [comment:68 dimpase]:\n> > In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.\n> \n> Sure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.\n\nAs mentioned in the ticket description, this ticket is motivated by a report on sage-support, stating that on CoCalc matrices with meataxe as backend don't work. So, certainly it would be good if someone could test on CoCalc (whatever that is).",
    "created_at": "2019-07-17T10:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394828",
    "user": "SimonKing"
}
```

Replying to [comment:71 jdemeyer]:
> Replying to [comment:68 dimpase]:
> > In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.
> 
> Sure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.

As mentioned in the ticket description, this ticket is motivated by a report on sage-support, stating that on CoCalc matrices with meataxe as backend don't work. So, certainly it would be good if someone could test on CoCalc (whatever that is).



---

archive/issue_comments_394829.json:
```json
{
    "body": "The \"issue\" is CoCalc-specific. It has to to with accessing `$DOTSAGE`. Removing this access, as this patch does, should fix it.\n\nThe only way to test that the latter is indeed the case is on CoCalc, by someone who can modify their default Sage. (Perhaps there are other ways, on a local/sanboxed installation of CoCalc, no idea.) I cc William, Hal, and Harald, in case.",
    "created_at": "2019-07-17T10:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394829",
    "user": "dimpase"
}
```

The "issue" is CoCalc-specific. It has to to with accessing `$DOTSAGE`. Removing this access, as this patch does, should fix it.

The only way to test that the latter is indeed the case is on CoCalc, by someone who can modify their default Sage. (Perhaps there are other ways, on a local/sanboxed installation of CoCalc, no idea.) I cc William, Hal, and Harald, in case.



---

archive/issue_comments_394830.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> Replying to [comment:69 dimpase]:\n> > I'd keep `export MTXLIB=\"$SAGE_SHARE/meataxe\"` in `src/bin/sage-env`\n> \n> What do you mean with \"keep\"? It's not there and this branch doesn't add it.\nThis very line is deleted in one of commits.",
    "created_at": "2019-07-17T10:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394830",
    "user": "dimpase"
}
```

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 dimpase]:
> > I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`
> 
> What do you mean with "keep"? It's not there and this branch doesn't add it.
This very line is deleted in one of commits.



---

archive/issue_comments_394831.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> Replying to [comment:69 dimpase]:\n> > I'd keep `export MTXLIB=\"$SAGE_SHARE/meataxe\"` in `src/bin/sage-env`\n> \n> What do you mean with \"keep\"? It's not there and this branch doesn't add it.\n\nI guess it is \"keep\" in the sense of \"one early commit adds it, so, why did a later commit remove it?\".\n\nMy rationale for not adding \"environmental pollution\" (i.e., adding the `MTXLIB` environment variable) is as follows: Even with the optional meataxe spkg installed, Sage will not call any meataxe standalone programs. But perhaps a user wants to use the meataxe standalone programs? So, we should allow the user to specify `MTXLIB` in a way that is convenient to her. The current proposition is: If the user specifies `MTXLIB` then Sage will use this specification.",
    "created_at": "2019-07-17T10:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394831",
    "user": "SimonKing"
}
```

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 dimpase]:
> > I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`
> 
> What do you mean with "keep"? It's not there and this branch doesn't add it.

I guess it is "keep" in the sense of "one early commit adds it, so, why did a later commit remove it?".

My rationale for not adding "environmental pollution" (i.e., adding the `MTXLIB` environment variable) is as follows: Even with the optional meataxe spkg installed, Sage will not call any meataxe standalone programs. But perhaps a user wants to use the meataxe standalone programs? So, we should allow the user to specify `MTXLIB` in a way that is convenient to her. The current proposition is: If the user specifies `MTXLIB` then Sage will use this specification.



---

archive/issue_comments_394832.json:
```json
{
    "body": "For whatever reason, the people added in Cc by Dima got removed by my previous comment. Sorry.",
    "created_at": "2019-07-17T10:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394832",
    "user": "SimonKing"
}
```

For whatever reason, the people added in Cc by Dima got removed by my previous comment. Sorry.



---

archive/issue_comments_394833.json:
```json
{
    "body": "that's cause we try to modify the ticket more or less at the same time, this leads to such deletions etc often (there are apparently ways around it, I don't quite know).",
    "created_at": "2019-07-17T10:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394833",
    "user": "dimpase"
}
```

that's cause we try to modify the ticket more or less at the same time, this leads to such deletions etc often (there are apparently ways around it, I don't quite know).



---

archive/issue_comments_394834.json:
```json
{
    "body": "(I don't think it matters: I think that once you cc someone, they are forever cc'ed on the ticket, and I don't think there is any way for them to be removed.)",
    "created_at": "2019-07-17T17:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394834",
    "user": "jhpalmieri"
}
```

(I don't think it matters: I think that once you cc someone, they are forever cc'ed on the ticket, and I don't think there is any way for them to be removed.)



---

archive/issue_comments_394835.json:
```json
{
    "body": "Changing keywords from \"meataxe\" to \"meataxe days100\".",
    "created_at": "2019-07-19T21:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394835",
    "user": "SimonKing"
}
```

Changing keywords from "meataxe" to "meataxe days100".



---

archive/issue_comments_394836.json:
```json
{
    "body": "Not even started and we have already 4 tickets :-) These are great Sage days!\n\nEDIT: five",
    "created_at": "2019-07-19T21:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394836",
    "user": "vdelecroix"
}
```

Not even started and we have already 4 tickets :-) These are great Sage days!

EDIT: five



---

archive/issue_comments_394837.json:
```json
{
    "body": "I just tested what was happening in cocalc.\n\nApparently the DOT_SAGE folder does not contain a sub-folder `meataxe`. When MeatAxe tries to write tables into the non-existing folder, it just crashes instead of creating it. After I created `$DOT_SAGE/meataxe` manually, things worked.\n\nThe stupid thing was that during package installation I created `$DOT_SAGE/meataxe`, which of course doesn't work as soon as one has more than a single user for one Sage installation. Very stupid. VERY.\n\nSo, the potential fixes are:\n1. Change the upstream SharedMeatAxe tarball so that it creates the folder `$MTX_LIB` when needed.\n2. Change sage.libs.meataxe so that `import sage.libs.meataxe` creates the folder when needed.\n3. Install all tables in a folder that exists during package installation and can be read by all users. That's what I suggest in the current branch.\n\nWhich of these solutions do you prefer?\n\nI prefer 3., because it installs all tables once (spending a well-defined amount of disk space), rather than letting each user created his or her own tables (spending a potentially unlimited amount of disk space)",
    "created_at": "2019-07-24T15:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394837",
    "user": "SimonKing"
}
```

I just tested what was happening in cocalc.

Apparently the DOT_SAGE folder does not contain a sub-folder `meataxe`. When MeatAxe tries to write tables into the non-existing folder, it just crashes instead of creating it. After I created `$DOT_SAGE/meataxe` manually, things worked.

The stupid thing was that during package installation I created `$DOT_SAGE/meataxe`, which of course doesn't work as soon as one has more than a single user for one Sage installation. Very stupid. VERY.

So, the potential fixes are:
1. Change the upstream SharedMeatAxe tarball so that it creates the folder `$MTX_LIB` when needed.
2. Change sage.libs.meataxe so that `import sage.libs.meataxe` creates the folder when needed.
3. Install all tables in a folder that exists during package installation and can be read by all users. That's what I suggest in the current branch.

Which of these solutions do you prefer?

I prefer 3., because it installs all tables once (spending a well-defined amount of disk space), rather than letting each user created his or her own tables (spending a potentially unlimited amount of disk space)



---

archive/issue_comments_394838.json:
```json
{
    "body": "I am very much in favour of 3., as well.",
    "created_at": "2019-07-24T15:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394838",
    "user": "dimpase"
}
```

I am very much in favour of 3., as well.



---

archive/issue_comments_394839.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-24T15:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394839",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_394840.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-29T21:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27951#issuecomment-394840",
    "user": "vbraun"
}
```

Resolution: fixed
