# Issue 27951: MeatAxe arithmetic tables

Issue created by migration from https://trac.sagemath.org/ticket/28188

Original creator: SimonKing

Original creation time: 2019-07-13 13:15:20

CC:  arojas was schilly â€‹hsnyder

Keywords: meataxe

It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables cannot be found.

This ticket is to solve that problem. Sage uses a fork of MeatAxe anyway (called SharedMeatAxe) maintained by Simon King, and so one potential solution is to fix it in the fork.


---

Comment by SimonKing created at 2019-07-13 13:27:27

In the original report, the problem was on CoCalC. From the description, it didn't become clear to me if the users do not have write permission on `DOT_SAGE` (which would explain the problem) or if `DOT_SAGE` is a symbolic link (which perhaps can be troublesome, too).

Currently, the arithmetic tables of (Shared)MeatAxe are sought in `$DOT_SAGE/meataxe`, and are created there when they aren't present. I see the following potential solutions:
1. Instead of using `DOT_SAGE`, use `SAGE_EXT`: The user may not have write permissions, but since MeatAxe can only deal with field sizes less than 255, it would be easy to just create _all_ arithmetic tables during package installation (hence, in a situation where write permission is granted and from where all users can read).
2. It is a design choice of upstream MeatAxe to use arithmetic tables on disk, and load them when the current field is changed. But in our fork SharedMeatAxe, we could of course differ. Hence, whenever the current field is changed, we could compute the arithmetic table on the spot. Of course, when during a session different fields are used, it would avoid some overhead to keep all arithmetic tables in memory, and reuse them.
3. In case that symbolic links are to blame (I don't know if they are), just address that problem, but keep the design as it is.


---

Comment by dimpase created at 2019-07-13 14:03:05

I'd say that the communication with meataxe library can be done via sscanf/sprintf functions
rather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.


---

Comment by SimonKing created at 2019-07-13 14:19:58

Replying to [comment:2 dimpase]:
> I'd say that the commincation with meataxe library can be done via sscanf/sprintf functions
> rather than fscanf/fprintf, then nothing gets written to/read from the disk, problem solved via a relatively small change of the code.

The routine writing/reading the table doesn't invoke fscanf/fprintf, if I understand correctly (at least not directly). It uses fread/fwrite.

In any case, I think the first question to be addressed is whether we do want to keep the tables in memory (and potentially lose time for table creation), or want them permanently stored in a file (and potentially lose time because of a slow disk, and have the trouble with write permission).


---

Comment by arojas created at 2019-07-13 14:58:37

This could also help with the troubles with the data dir creation. Currently, meataxe crashes if MTXLIB(=~/.sage/meataxe) doesn't exist. This doesn't affect sage-the-distro, since the dir is created in meataxe's spkg-install. It does affect distros though, where the package manager is not allowed to touch /home. My current workaround is to create the dir in sage-env, but it would be nice if meataxe itself took care of this.


---

Comment by dimpase created at 2019-07-13 15:09:41

If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?
(If one actually does need to copy them, rather than just to access them directly)


---

Comment by vdelecroix created at 2019-07-13 18:20:36

It looks weird to me to have these files generated along the way. If generating the tables is time consuming (is it?) then the data would better be shipped with the MeatAxe library itself (in some convenient binary format). The data should not take a lot of memory

```
sage: sum(i*i for i in range(256) if is_prime_power(i) and not is_prime(i)) / 10.**3
150.113000000000
```

(the above are supposed to be Ko)


---

Comment by dimpase created at 2019-07-13 18:25:59

these files may be generated during the installation of meataxe, as well.


---

Comment by vdelecroix created at 2019-07-13 18:26:46

BTW, have you tried using LinBox? givaro is supposed to support finite fields and the linear algebra in linbox is highly optimized (when it works :-).


---

Comment by dimpase created at 2019-07-13 18:28:52

meataxe does representation theory stuff, that's its main purpose; that it can be used just for fast matrix operations is an extra.


---

Comment by SimonKing created at 2019-07-13 20:21:00

Replying to [comment:5 dimpase]:
> If it's fread/fwrite, why can't one just copy the data directly (with memcpy() or whatever)?
> (If one actually does need to copy them, rather than just to access them directly)

I think the idea really is to avoid re-creation of the tables. Compute them once, store them, reload them another day.


---

Comment by SimonKing created at 2019-07-13 20:21:55

Replying to [comment:7 dimpase]:
> these files may be generated during the installation of meataxe, as well.

That is one of the potential ways out asmentioned in comment:1.


---

Comment by SimonKing created at 2019-07-13 20:35:58

I created tables for all field sizes that meataxe can deal with (i.e., less than 255).

- It was very quick and could thus be done during package installation.
- The total size of the tables is 9.5MB


---

Comment by SimonKing created at 2019-07-15 10:18:18

FYI: If nobody stops me, I will change `spkg-install` so that the tables will henceforth be ALL installed in `%SAGE_SHARE/meataxe`during package installation.

Rationale: Creation of the tables takes at most a few seconds. Moreover, I will not need to change the existing SharedMeatAxe tarball, as the path to the tables is defined by code in the Sage library.


---

Comment by dimpase created at 2019-07-15 10:19:42

Yes please, go ahead, I'll be happy to approve this.


---

Comment by SimonKing created at 2019-07-15 11:33:57

It is (I think) required that the tables are created, BEFORE the optional `matrix_gfpn_dense` Cython module is available.

Therefore, I want to trigger creation of the tables using one of the MeatAxe executables. I find `zcv` convenient --- to some extent:
- Let `input` be a file consisting of the single line `matrix field=25 rows=0 cols=0`.
- Then, the command `zcv input output` will create a file called `output` describing an empty matrix in binary format, and will, as a side-effect, create `p025.zzz` in the current directory. Of course I am only interested in the side-effect; the file `output` can safely be deleted.

The question is how to do the above in a loop, where `field=...` runs over all available field sizes. According to [MeatAxe documentation](https://www.mankier.com/1/zcv), `zcv - output` should read the input from stdin, but apparently it doesn't.

Is there a way to pretend that a program such as `zcv` reads input from a file? If not: How do I create the input file using a shell script and apply `zcv` to it without risking to be affected by race conditions?


---

Comment by SimonKing created at 2019-07-15 11:58:56

Would the following be safe against race conditions?

```
for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
  echo "matrix field=$i rows=0 cols=0">test | zcv test outtest
done
```

PS: The above takes about 1 second on my laptop.


---

Comment by dimpase created at 2019-07-15 12:07:21

No need to create a file, just do

```
$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null
done
```



---

Comment by SimonKing created at 2019-07-15 20:25:11

Replying to [comment:17 dimpase]:
> No need to create a file, just do
> {{{
> $ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
> do
>    zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null
> done
> }}}

Thank you! That was exactly what I was looking for.

Before I create a branch: The upstream tarball will not change. But shall the Sage package version be bumped from `1.0` to `1.0.p0`?


---

Comment by dimpase created at 2019-07-15 20:33:19

yes, do bump up the version, to cause the reinstallation of the package.


---

Comment by SimonKing created at 2019-07-15 22:25:45

Ideally, when `zcv` fails in one iteration of the loop, the install script should abort. How to achieve this?

```
$ for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null  ||  sdh_die
done
```

?


---

Comment by dimpase created at 2019-07-15 22:40:25

well, if `zcv` produces an error code, indeed, then something like this ought to work.
You may try to see if this works by passing it `i=6`, say...


---

Comment by SimonKing created at 2019-07-15 22:42:25

Can someone please explain what is going wrong here?

```
# Delete old (Shared)MeatAxe libraries. This ensures a sane state if
# installation of this package fails: the mtx library should exist if
# and only if meataxe is installed. In detail: the build-time check in
# src/module_list.py checks whether or not the "meataxe" package is
# marked as installed but the run-time check for the matrix_gfpn_dense
# module checks whether it can be imported. We need to ensure that these
# two conditions are equivalent, otherwise strange things can happen.
# See also https://trac.sagemath.org/ticket/24359#comment:154
#
# This also deletes the static library left behind from the installation
# of MeatAxe (as opposed to SharedMeatAxe).
rm -f "$SAGE_LOCAL"/lib/libmtx.*

# This is the place where arithmetic tables and some other input files
# are searched by default.
export MTXLIB="$SAGE_SHARE"/meataxe

# Directory where executables are installed.
export MTXBIN="$SAGE_LOCAL"/bin

# Field size up to GF(256)
export ZZZ=0

# We create a directory for the multiplication tables
mkdir -p $MTXLIB || \
    sdh_die "Error creating directory for multiplication tables"

cd src
sdh_configure
sdh_make
sdh_make_install

if [ "$SAGE_SPKG_INSTALL_DOCS" = yes ] ; then
    $MAKE doc || sdh_die "Error documenting SharedMeatAxe"
fi

cd $MTXLIB
for i in 2 3 4 5 7 8 9 11 13 16 17 19 23 25 27 29 31 32 37 41 43 47 49 53 59 61 64 67 71 73 79 81 83 89 97 101 103 107 109 113 121 125 127 128 131 137 139 149 151 157 163 167 169 173 179 181 191 193 197 199 211 223 227 229 233 239 241 243 251
do
   zcv <(echo "matrix field=$i rows=0 cols=0") /dev/null  ||  sdh_die "Error creating multiplication table for field of size $i"
done
```

The above spkg-install script is supposed to install the MeatAxe executables (including zcv) in `$SAGE_LOCAL/bin`. It DOES install it when the spkg-install script ends before `cd $MTXLIB`.

However, according to the error message, zcv is in fact not installed when it is needed. Why?

On the bright side, `... || sdh_die` works as expected.


---

Comment by dimpase created at 2019-07-15 22:48:35

I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; 
probably due to the fact that before `spkg-install` terminates, the access to its result is not assured.


---

Comment by SimonKing created at 2019-07-15 22:55:42

Replying to [comment:23 dimpase]:
> I guess that loop that calls `zcv` should be moved to `spkg-postinst` script; 
> probably due to the fact that before `spkg-install` terminates, the access to its result is not assured.

Yes, this seems to work!

Shall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.


---

Comment by dimpase created at 2019-07-15 23:05:40

Replying to [comment:24 SimonKing]:

> Shall I move building the documentation to `spkg-postinst` as well? Probably not, as building the docs doesn't depend on the presence of the meataxe executables.

if it works then there is no need to fiddle around more with it, IMHO.


---

Comment by SimonKing created at 2019-07-15 23:12:23

Good news: The rather minimal change (which doesn't affect the upstream tarball) works. Bad news: I will need to change `p_group_cohomology', as apparently the old location of the meataxe tables is hard-coded in `p_group_cohomology`.

Do you see a way out?

EDIT: The group cohomology package fails because I explicitly deleted `$DOT_SAGE/meataxe`. A user who does not manually delete `$DOT_SAGE/meataxe` will not be affected: `p_group_cohomology` will simply create new tables in `$DOT_SAGE/meataxe`.


---

Comment by dimpase created at 2019-07-15 23:52:30

well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...


---

Comment by SimonKing created at 2019-07-15 23:55:33

Replying to [comment:27 dimpase]:
> well, it's a minimal change, just go ahead and do it. Then `p_group_cohomology` might work on cocalc again...

Probably not. As mentioned in comment:26, `p_group_cohomology` expects the location of the tables in `$DOT_SAGE/meataxe`. Really the location should be exposed in `sage/libs/meataxe` and imported from there. So, there must be a follow-up ticket for `p_group_cohomology`


---

Comment by SimonKing created at 2019-07-16 00:01:49

New commits:


---

Comment by SimonKing created at 2019-07-16 00:01:49

Changing status from new to needs_review.


---

Comment by SimonKing created at 2019-07-16 00:11:28

The follow-up ticket is #28204


---

Comment by SimonKing created at 2019-07-16 00:23:27

Concerning #28204: `p_group_cohomology` uses some MeatAxe "applications", which learn the location of the multiplication tables from an environment variable. Would you think that **here** we should add the corresponding environment variable to `sage_env`?

EDIT: Shall `MTXLIB` be exported even if `meataxe` is not installed?


---

Comment by SimonKing created at 2019-07-16 00:25:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-07-16 07:47:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-07-16 07:51:32

Questions: How can I achieve that `MTXLIB` (which is defined in `sage.env` by the new commit) will be exported into the sage shell? Would it be OK to automatically export it?

MeatAxe "applications" (i.e., stand-alone programs) need that environment variable to properly work (otherwise, they don't know where to find multiplication tables and will thus create new tables in the current directory).


---

Comment by dimpase created at 2019-07-16 08:15:45

AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.


---

Comment by SimonKing created at 2019-07-16 08:19:11

Replying to [comment:36 dimpase]:
> AFAIK, `src/sage/env.py` is for !Python/Cython related tasks. For the shell, you need to modify `src/bin/sage-env`.

I see. Perhaps I could do both? After all, we are dealing with the MeatAxe library on the one hand (for this, some `cdef extern` variable is set) and MeatAxe applications on the other hand (for this, we need an environment variable.


---

Comment by dimpase created at 2019-07-16 08:27:00

You certainly can do both, why not?


---

Comment by SimonKing created at 2019-07-16 08:30:36

Replying to [comment:38 dimpase]:
> You certainly can do both, why not?

Environmental pollution...

But it would slightly simplify the install script, too.


---

Comment by dimpase created at 2019-07-16 08:40:02

I don't know much about Cython, except that in some cases one puts in the pxd file
something like

```
# distutils: libraries = gmp flint arb
```

(this is from `src/sage/libs/arb/arb.pxd`)
to tell the linker, in this case, to link with `-lgmp -lflint -larb`

I have no idea how Cython handles linking without these sorts of directives.
(More precisly, I know this can be done within `setup.py`, but often there is no `setup.py` for a particular Cython extension...)


---

Comment by SimonKing created at 2019-07-16 08:42:11

Replying to [comment:40 dimpase]:
> I don't know much about Cython, except that in some cases one puts in the pxd file
> something like
> {{{
> # distutils: libraries = gmp flint arb
> }}}
> (this is from `src/sage/libs/arb/arb.pxd`)
> to tell the linker, in this case, to link with `-lgmp -lflint -larb`
> 
> I have no idea how Cython handles linking without these sorts of directives.

It is totally unrelated with linking. It is an `extern char*` variable that is supposed to be defined at runtime.


---

Comment by git created at 2019-07-16 08:48:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-07-16 08:50:46

I think the current proposition is a clean approach: Define `MTXLIB` in `sage-env` as an environment variable, and derive all other usage of the table locations from there. In that way, there will never be an inconsistency. And in #28204, I can simplify the `p_group_cohomology` package.


---

Comment by SimonKing created at 2019-07-16 08:50:46

Changing status from needs_work to needs_review.


---

Comment by arojas created at 2019-07-16 10:24:22

Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables? This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)


---

Comment by SimonKing created at 2019-07-16 10:45:48

Replying to [comment:44 arojas]:
> Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?

Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.

> This will not make any difference in practice for sage-the-distro (since var uses the env variable if it is defined), and will allow to not rely on the presence of sage-env on distros (I'm aiming to remove it completely in the near future on Arch)

I don't understand that. Are you saying that on some platforms it will NOT be possible to let `MTXLIB` be defined by Sage as an environment variable? In any case, I was not aware that var uses the env variable when possible.


---

Comment by dimpase created at 2019-07-16 10:50:15

In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.


---

Comment by arojas created at 2019-07-16 11:01:55

Replying to [comment:45 SimonKing]:
> Replying to [comment:44 arojas]:
> > Any reason you're using var('MTXLIB', os.environ['MTXLIB']) instead of var('MTXLIB', join(SAGE_SHARE, 'meataxe')) like it's done for all other variables?
> 
> Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.

Every env variable defined in sage-env has the same path set as fallback in env.py, I don't see why this one should be different - the env.py one is just a fallback, if the env variable is defined it will be used.

This is not only useful for distros that don't provide sage-env, but also for using sage as a python library - 'from sage.all import *' does not import the env variables defined in sage-env


---

Comment by SimonKing created at 2019-07-16 12:59:11

Replying to [comment:47 arojas]:
> Replying to [comment:45 SimonKing]:
> > Yes. There shall be a **single** location where the value of `MTXLIB` is defined, so that there cannot be an inconsistency.
> 
> Every env variable defined in sage-env has the same path set as fallback in env.py,

I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?


---

Comment by SimonKing created at 2019-07-16 13:12:11

Replying to [comment:46 dimpase]:
> In practice (at the moment, it's more in theory, of course :-)), Meataxe might be externally installed, and then there is no reason for `MTXLIB` to be under `SAGE_SHARE`.

I think it doesn't matter whether a system-wide meataxe or the meataxe spkg is used (except that the original `MeatAxe` is clearly inferior to its fork `SharedMeatAxe` and that the Sage wrapper uses some functions that only exist in the fork).

In any case, when a meataxe application or any program using meataxe library functions is executed, it will be needed to use arithmetic tables. When they cannot be found, they will be created.

So, the following implications hold regardless whether spkg-meataxe or system-meataxe is used:
- If the environment variable `MTXLIB` is undefined, meataxe applications will search and potentially write tables to the current directory. If the `extern char*` variable `MtxLibDir` is undefined, meataxe library functions will search and potentially write tables to the current directory.

  => Since we do not want to pollute the user's current directory, we **have to** define both environment and cdef extern variables.
- If the tables already exist at the location pointed at by the variables, we need that the user has read permission. Otherwise, there will be an error.
- If the tables do not already exist, the folder pointed at by the variables needs to exist and the user needs to have write permission. Otherwise. there will be an error.

So, our requirements, regardless what source we take meataxe from, are as follows:
- Sage needs to define one environment and one extern C variable. The former should be in sage-env, the latter in sage.libs.meataxe, I suppose.
- It is not a strict requirement that both variables are equal, but of course it would be nice. In any case, we have to make sure that either
  * the arithmetic tables are present at the given folder (and the user can read them), or
  * the user has write permission at the given folder.
  
  A system wide meataxe wouldn't mind that the folder is inside of the Sage tree.

**Question:** What should we do?


---

Comment by SimonKing created at 2019-07-16 13:24:54

Replying to [comment:48 SimonKing]:
> I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?

Apparently it is the latter.


---

Comment by git created at 2019-07-16 13:29:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2019-07-16 13:32:47

Replying to [comment:50 SimonKing]:
> Replying to [comment:48 SimonKing]:
> > I was simply unaware about it. So, are you saying that I shouldn't change env.py at all, or that I should define `MTXLIB` in env.py with an empty default?
> 
> Apparently it is the latter.

No, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.


---

Comment by SimonKing created at 2019-07-16 13:42:05

Replying to [comment:52 arojas]:
> No, I mean define join(SAGE_SHARE, 'meataxe') as fallback, similar to all other variables in env.py. Defining an empty fallback would not make any difference - the variable would be undefined if sage-env is not being imported.

My rationale was: As stated in comment:49, if FooBar uses meataxe, then FooBar has to take care that it defines `MTXLIB` (the environment variable). Otherwise it is a bug in FooBar that results in a pollution of the current directory.

So, if FooBar uses meataxe via Sage, then the environment variable should be present.

Hm. I just think that one can see it the other way around: If FooBar uses meataxe only via Sage, then we cannot assume that FooBar is an expert in the internals of meataxe. So, it is Sage's responsibility to provide the environment variable, after all.

How can one define an environment variable in Python code? Would it be `os.environ['MTXLIB']="..."`?


---

Comment by arojas created at 2019-07-16 13:47:38

the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?


---

Comment by SimonKing created at 2019-07-16 13:50:04

Replying to [comment:54 arojas]:
> the var function from env.py already injects the variable in SAGE_ENV. I take it this not enough, and using meataxe from sage actually requires the variable to be defined in the user's global env?

I don't know what you mean by "user's global env". It needs to be present when you call an executable in a sage shell.


---

Comment by SimonKing created at 2019-07-16 13:53:38

Replying to [comment:55 SimonKing]:
> I don't know what you mean by "user's global env". It needs to be present when you call an executable in a sage shell.

PS: You do not need it when you just use meataxe as a backend for matrices over finite fields. You do need it when you call a meataxe application, though, which is the case for `p_group_cohomology` (see #28204)


---

Comment by git created at 2019-07-16 13:57:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-07-16 14:00:26

In the latest commit, I use a fallback in sage.env, in the case that sage-env is not executed. And in addition, when sage.libs.meataxe is imported, the value `sage.env.MTXLIB` is put into os.environ. I hope that's good enough to make the presence of the environment variable MTXLIB very likely, even when sage-env isn't called.


---

Comment by SimonKing created at 2019-07-16 15:24:18

Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:

- sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.
- sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.
- Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.

Do you like the above better than what is in the current commits?


---

Comment by arojas created at 2019-07-16 16:45:26

Replying to [comment:59 SimonKing]:
> Another thought: In the Sage library, meataxe applications aren't called (sage.matrix.matrix_gfpn_dense entirely relies on calling meataxe library functions). Hence, Sage's only responsibility is to define `extern char* MtxLibDir`. If someone wants to call meataxe applications via Sage (this is what the p_group_cohomology spkg does), then it is not Sage's responsibility to define the environment variable MTXLIB. This gives rise to the following:
> 
> - sage-env should not define MTXLIB, because that's only used in meataxe applications that Sage isn't calling.
> - sage.env should provide a default for MTXLIB that is overridden if some user defines MTXLIB him/herself.
> - Sage uses sage.env.MTXLIB to define `MtxLibDir`, but it is entirely the user's responsibility to export MTXLIB to the shell, in case (s)he needs it.
> 
> Do you like the above better than what is in the current commits?

IIUC the difference between this and the current state of the branch is whether MTXLIB is defined or not in sage-env, right? In that case, either way is fine for me - I'm only worried about what happens when sage-env is not imported, and the latest commit in env.py takes care of this.


---

Comment by git created at 2019-07-16 17:28:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-07-16 17:38:20

With the latest commit, we have this:
- If the user exports `MTXLIB` and then installs `meataxe`, then the folder `$MTXLIB` will be created; otherwise a default location is chosen and the folder created.
- If the user exports `MTXLIB` and then starts Sage, then sage.env.MTXLIB will be set accordingly; otherwise, a default location is used.
- Sage will define the `extern char*` variable `MtxLibDir` to comply with sage.env.MTXLIB when sage.meataxe is first imported. That variable is all what we need in sage.matrix.matrix_gfpn_dense.
- If someone wants to use meataxe applications, then it is not Sage's responsibility to export MTXLIB.

I tested that `sage -f -c meataxe` works and `sage -t src/sage/matrix/matrix_gfpn_dense.pyx` works without error. So, needs review! And I guess it should be verified that meataxe now works in CoCalC.


---

Comment by jdemeyer created at 2019-07-17 09:57:15

First of all, it would be good to update the ticket description with the problem that this ticket is trying to solve (I didn't follow all comments in this ticket). After all, it's difficult to review a solution when you don't know what problem it is meant to solve.

Second, why are you not defining `MTXLIB` in `src/bin/sage-env` like other similar environment variables? Then you can just refer to `$MTXLIB` unconditionally in your scripts.


---

Comment by jdemeyer created at 2019-07-17 10:18:21

Replying to [ticket:28188 SimonKing]:
> It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.

Do we know what these "some situations" are? I'm asking because, while I agree with the patch, I disagree with the patch _as fix for this problem_. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?


---

Comment by dimpase created at 2019-07-17 10:22:25

Replying to [comment:67 jdemeyer]:
> Replying to [ticket:28188 SimonKing]:
> > It was [reported](https://groups.google.com/forum/#!topic/sage-support/zWOWtjha-H0) that in some situations using the MeatAxe backend for matrices over finite fields won't work because the arithmetic tables can neither be found nor created.
> 
> Do we know what these "some situations" are? I'm asking because, while I agree with the patch, I disagree with the patch _as fix for this problem_. Are we sure that whatever issue caused problems with `$DOT_SAGE` won't cause problems with `$MTXLIB` after this patch?

"some situations" arise on CoCalc. In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.


---

Comment by dimpase created at 2019-07-17 10:30:44

I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`, as I gather it's needed for running `meataxe` at Sage's shell prompt. No need to break (or not to introduce) this capability with this patch.


---

Comment by jdemeyer created at 2019-07-17 10:36:22

Replying to [comment:69 dimpase]:
> I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`

What do you mean with "keep"? It's not there and this branch doesn't add it.


---

Comment by jdemeyer created at 2019-07-17 10:38:12

Replying to [comment:68 dimpase]:
> In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.

Sure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.


---

Comment by SimonKing created at 2019-07-17 10:45:46

Replying to [comment:71 jdemeyer]:
> Replying to [comment:68 dimpase]:
> > In general, the less stuff goes to `$DOT_SAGE`, the better, so this is an overall improvement.
> 
> Sure, I'm not denying that. Like I said, I agree with the patch itself, but not as fix for this issue.

As mentioned in the ticket description, this ticket is motivated by a report on sage-support, stating that on CoCalc matrices with meataxe as backend don't work. So, certainly it would be good if someone could test on CoCalc (whatever that is).


---

Comment by dimpase created at 2019-07-17 10:48:15

The "issue" is CoCalc-specific. It has to to with accessing `$DOTSAGE`. Removing this access, as this patch does, should fix it.

The only way to test that the latter is indeed the case is on CoCalc, by someone who can modify their default Sage. (Perhaps there are other ways, on a local/sanboxed installation of CoCalc, no idea.) I cc William, Hal, and Harald, in case.


---

Comment by dimpase created at 2019-07-17 10:49:18

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 dimpase]:
> > I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`
> 
> What do you mean with "keep"? It's not there and this branch doesn't add it.
This very line is deleted in one of commits.


---

Comment by SimonKing created at 2019-07-17 10:51:49

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 dimpase]:
> > I'd keep `export MTXLIB="$SAGE_SHARE/meataxe"` in `src/bin/sage-env`
> 
> What do you mean with "keep"? It's not there and this branch doesn't add it.

I guess it is "keep" in the sense of "one early commit adds it, so, why did a later commit remove it?".

My rationale for not adding "environmental pollution" (i.e., adding the `MTXLIB` environment variable) is as follows: Even with the optional meataxe spkg installed, Sage will not call any meataxe standalone programs. But perhaps a user wants to use the meataxe standalone programs? So, we should allow the user to specify `MTXLIB` in a way that is convenient to her. The current proposition is: If the user specifies `MTXLIB` then Sage will use this specification.


---

Comment by SimonKing created at 2019-07-17 10:53:18

For whatever reason, the people added in Cc by Dima got removed by my previous comment. Sorry.


---

Comment by dimpase created at 2019-07-17 10:54:55

that's cause we try to modify the ticket more or less at the same time, this leads to such deletions etc often (there are apparently ways around it, I don't quite know).


---

Comment by jhpalmieri created at 2019-07-17 17:32:50

(I don't think it matters: I think that once you cc someone, they are forever cc'ed on the ticket, and I don't think there is any way for them to be removed.)


---

Comment by SimonKing created at 2019-07-19 21:04:59

Changing keywords from "meataxe" to "meataxe days100".


---

Comment by vdelecroix created at 2019-07-19 21:06:23

Not even started and we have already 4 tickets :-) These are great Sage days!

EDIT: five


---

Comment by SimonKing created at 2019-07-24 15:08:48

I just tested what was happening in cocalc.

Apparently the DOT_SAGE folder does not contain a sub-folder `meataxe`. When MeatAxe tries to write tables into the non-existing folder, it just crashes instead of creating it. After I created `$DOT_SAGE/meataxe` manually, things worked.

The stupid thing was that during package installation I created `$DOT_SAGE/meataxe`, which of course doesn't work as soon as one has more than a single user for one Sage installation. Very stupid. VERY.

So, the potential fixes are:
1. Change the upstream SharedMeatAxe tarball so that it creates the folder `$MTX_LIB` when needed.
2. Change sage.libs.meataxe so that `import sage.libs.meataxe` creates the folder when needed.
3. Install all tables in a folder that exists during package installation and can be read by all users. That's what I suggest in the current branch.

Which of these solutions do you prefer?

I prefer 3., because it installs all tables once (spending a well-defined amount of disk space), rather than letting each user created his or her own tables (spending a potentially unlimited amount of disk space)


---

Comment by dimpase created at 2019-07-24 15:15:00

I am very much in favour of 3., as well.


---

Comment by dimpase created at 2019-07-24 15:17:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-29 21:54:54

Resolution: fixed
