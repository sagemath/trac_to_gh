# Issue 16536: Analytic Rank Bound

Issue created by migration from https://trac.sagemath.org/ticket/16773

Original creator: spice

Original creation time: 2014-08-06 17:55:53




---

Comment by spice created at 2014-08-06 18:03:06

Set assignee to spice.


---

Comment by spice created at 2014-08-06 18:03:06

Changing type from PLEASE CHANGE to enhancement.


---

Comment by spice created at 2014-08-06 18:03:06

Changing component from PLEASE CHANGE to elliptic curves.


---

Comment by spice created at 2014-08-06 18:03:06

Changing keywords from "" to "elliptic curves, analytic rank, l-functions".


---

Comment by git created at 2014-08-14 19:54:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by was created at 2014-08-14 21:10:18

I'll be reviewing this.  I just read over all of the code and it's in really good shape right now.   There are a couple of minor issues that I told Simon about, which he'll address soon.

I have not compiled or run doctests yet.


---

Comment by git created at 2014-08-15 21:06:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2014-08-15 21:08:57

Changing status from new to needs_review.


---

Comment by git created at 2014-10-27 15:25:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-27 16:49:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2014-10-27 17:01:49

The elliptic_curves spkg has been updated, and version number incremented to 0.8. The zipped data file for the spkg can be obtained at
[http://www.math.washington.edu/~mlungu/files/elliptic_curves-0.8.tar.bz2](http://www.math.washington.edu/~mlungu/files/elliptic_curves-0.8.tar.bz2)


---

Comment by git created at 2014-10-28 19:06:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-28 20:39:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-28 21:55:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-30 17:49:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-30 18:01:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-10-30 20:25:20

By curiosity, on which version of sage are you working ? The branch field here above is red, and should rather be green if your commits are to be applied (see any other recent ticket, for example #17255). It is probably better to work on top of the latest development version (now 6.4.rc0).


---

Comment by spice created at 2014-10-30 20:28:08

I'm working off 6.3. Time to rebase then!


---

Comment by git created at 2014-11-04 00:47:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2014-11-04 00:48:30

Patch has been updated to Sage 6.4.rc1


---

Comment by spice created at 2014-11-04 18:32:23

Updating to 6.4.rc1 introduces some minor doctest errors, which I'll need to fix.


---

Comment by spice created at 2014-11-04 18:32:23

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-11-07 16:49:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-04 17:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2014-12-04 17:13:02

Changing status from needs_work to needs_review.


---

Comment by spice created at 2014-12-04 17:13:02

Branch rebased to 6.4.1. All tests pass, so I'm changing the patch to NEEDS_REVIEW.


---

Comment by was created at 2014-12-04 19:37:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-12-05 15:03:32

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-12-05 15:03:32


```
sage -t --long --warn-long 38.9 src/sage/lfunctions/zero_sums.pyx
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 1333, in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve.?
Failed example:
    print(E.rank(),Z._zerosum_sincsquared_parallel(Delta=1.5,ncpus=8))
Expected:
    (0, 0.01047120600865063)
Got:
    (0, 0.010471206008650615)
**********************************************************************
```



---

Comment by vbraun created at 2014-12-05 15:04:13

Also, do you really need 8 cores to test this? Is the code path different from 2 cores?


---

Comment by spice created at 2014-12-16 17:17:18

Replying to [comment:33 vbraun]:
> Also, do you really need 8 cores to test this? Is the code path different from 2 cores?

No, the code path is the same either way. I'll change the test to use only 2 cores, and add tolerances (should have done this anyway since the code is doing arithmetic over RDF). 

Should I add tolerances to my other numerical tests? Or is this only an issue because I'm using `@`parallel in this one method?


---

Comment by vbraun created at 2014-12-16 18:06:05

You need tolerances wherever the output might have numerical noise. Some floating-point operations are guaranteed by IEEE, but e.g. ``@`parallel` will add in random order and floating-point addition is not associative.


---

Comment by git created at 2014-12-18 14:50:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2014-12-18 15:04:26

Changing status from needs_work to needs_review.


---

Comment by spice created at 2014-12-18 15:04:26

Numerical error in the `@`parallel method doctest has been fixed, including reducing the number of cores to 2. Patch should be good to go.


---

Comment by vbraun created at 2014-12-18 15:43:41

Why the extra print? 

```
sage: print(Z._zerosum_sincsquared_parallel(Delta=1.5,ncpus=2))
sage: Z._zerosum_sincsquared_parallel(Delta=1.5,ncpus=2)
```



---

Comment by spice created at 2014-12-18 15:58:20

I split up the output: the numerical value should be an upper bound to the rank of an elliptic curve. The former is a floating point value, however, so there should be an allowed tolerance in the output. I thought that writing the example this way makes the comparison a bit clearer.


---

Comment by was created at 2015-02-10 17:45:46

Changing status from needs_review to positive_review.


---

Comment by was created at 2015-02-10 17:45:46

rubber stamp.


---

Comment by vbraun created at 2015-02-17 14:52:08

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-02-17 14:52:08

32-bit Linux:

```
sage -t --long src/sage/lfunctions/zero_sums.pyx
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 198, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.digamma
Failed example:
    Z.digamma(3.2)
Expected:
    0.9988388912865993
Got:
    0.9988388912865995
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 200, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.digamma
Failed example:
    Z.digamma(3.2,include_constant_term=False)
Expected:
    1.576054556188132
Got:
    1.5760545561881325
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 202, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.digamma
Failed example:
    Z.digamma(1+I)
Expected:
    0.09465032062247625 + 1.076674047468581*I
Got:
    0.09465032062247693 + 1.076674047468581*I
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 289, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.logarithmic_derivative
Failed example:
    Z.logarithmic_derivative(2.2,num_terms=50000) # long time
Expected:
    (0.5751579645060139, 0.008988775519160675)
Got:
    (0.5751579645060141, 0.008988775519160675)
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 305, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.logarithmic_derivative
Failed example:
    Z.logarithmic_derivative(complex(3,-1))
Expected:
    (0.04764548578052381 + 0.16513832809989326*I, 6.584671359095225e-06)
Got:
    (0.0476454857805238 + 0.16513832809989318*I, 6.584671359095225e-06)
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 502, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.zerosum
Failed example:
    Z.zerosum(Delta=1,tau=2.876,function="sincsquared")
Expected:
    1.075551295651154
Got:
    1.0755512956511541
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 504, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.zerosum
Failed example:
    Z.zerosum(Delta=1,tau=1.2,function="sincsquared")
Expected:
    0.10831555377490683
Got:
    0.10831555377490693
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 808, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract._zerosum_cauchy
Failed example:
    Z._zerosum_cauchy(Delta=1,tau=6.36261389)
Expected:
    2.180904626331156
Got:
    2.1809046263311567
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 815, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract._zerosum_cauchy
Failed example:
    Z._zerosum_cauchy(Delta=1,tau=1.5)
Expected:
    0.9827072037553375
Got:
    0.9827072037553374
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 824, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract._zerosum_cauchy
Failed example:
    Z._zerosum_cauchy(Delta=1.5)
Expected:
    12.93835258975716
Got:
    12.938352589757159
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 1180, in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve._zerosum_sincsquared_fast
Failed example:
    print(E.rank(),Z._zerosum_sincsquared_fast(Delta=1.5))
Expected:
    (0, 0.0104712060086507)
Got:
    (0, 0.010471206008650728)
**********************************************************************
5 items had failures:
   1 of   7 in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve._zerosum_sincsquared_fast
   3 of  10 in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract._zerosum_cauchy
   3 of   8 in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.digamma
   2 of  10 in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.logarithmic_derivative
   2 of  10 in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.zerosum
    [127 tests, 11 failures, 146.27 s]
```



---

Comment by vbraun created at 2015-02-17 14:54:40

This happens randomly, too:

```
sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_rational_field.py", line 1665, in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.?
Failed example:
    Z.analytic_rank_upper_bound(max_Delta=2.8,adaptive=False, # long time
    root_number="ignore",bad_primes=bad_primes)               # long time
Exception raised:
    Traceback (most recent call last):
      File "/scratch/buildbot/sage/redhawk-1/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/scratch/buildbot/sage/redhawk-1/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.?[26]>", line 2, in <module>
        root_number="ignore",bad_primes=bad_primes)               # long time
      File "sage/lfunctions/zero_sums.pyx", line 1728, in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve.analytic_rank_upper_bound (build/cythonized/sage/lfunctions/zero_sums.c:13597)
        return run_computation(max_Delta)
      File "sage/lfunctions/zero_sums.pyx", line 1673, in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve.analytic_rank_upper_bound.run_computation (build/cythonized/sage/lfunctions/zero_sums.c:12682)
        bound = self._zerosum_sincsquared_parallel(Delta=Delta,
      File "sage/lfunctions/zero_sums.pyx", line 1453, in sage.lfunctions.zero_sums.LFunctionZeroSum_EllipticCurve._zerosum_sincsquared_parallel (build/cythonized/sage/lfunctions/zero_sums.c:12269)
        y += summand[1]
    TypeError: unsupported operand type(s) for +=: 'float' and 'NoneType'
**********************************************************************
1 item had failures:
   1 of  94 in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.?
    [815 tests, 1 failure, 216.40 s]
```



---

Comment by git created at 2015-02-20 18:13:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2015-02-20 19:20:03

I adding tolerances to each of the numerical doctests; this should help with the numerical errors that appear when the tests are run on different architecture.

As for that one random error in ell_rational_field.py, I've tracked it to `@`parallel code being executed when ncpus is large (>8). Given that it seems to run fine on some systems but not others, my guess is that it's probably an issue somewhere in the `@`parallel framework as opposed to the new code in this patch.

Nevertheless, I've reworked the doctest in any case -- a test using that many CPUs is excessive, and it was still taking longer than the suggested ~5 seconds. It now uses smaller parameters and only calls for 2 processors. This should hopefully make it run without issue on any system.

All doctests pass on SMC architecture. I'll also run the full test suite on a different system just to be sure.


---

Comment by vbraun created at 2015-02-20 19:47:43

* Can you move `_sum_over_residues` out of the function body and document it

* `_sum_over_residues` can clearly return `None` if it falls through the last loop, which is the random error that we get. Can you start with an `assert False` (good practice anyways) at the end of it and then try it out with small residue chunks.

* addition is not associative, so parallel reductions always suffer from numerical errors. but `10^-10 =~ 10^6 ulp` is ridiculously large.

* doctests are typically run in parallel with one per (virtual) cpu, using `@`parallel is just slowing it down. Perhaps ncpus should generally return 1 or 2 in `DOCTEST_MODE`

* PEP8 whitespace style would be nice, e.g. space after comma `f(a, b, foo=bar)`.


---

Comment by spice created at 2015-02-20 20:19:01

Hi Volker

Sure, I can enact these changes. Will edit the code appropriately and resubmit in due course.

- Simon


---

Comment by git created at 2015-05-27 17:21:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by spice created at 2015-05-27 21:20:37

Patch has been rebased to Sage 6.8beta0, and I've implemented the changes suggested by Volker.

All doctests pass (except one numerical tolerance failure in src/sage/tests/french_book/linsolve_doctest.py, but this has already been pointed out by Rob Beezer in https://groups.google.com/d/msg/sage-release/QJJLny-GgRs/Agldt9D-RHYJ as an SMC architecture issue).


---

Comment by spice created at 2015-05-27 21:20:37

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-06-09 16:11:24

I have had a quick look, and things seems ok.

One typo : pathalogically

please remove changes to .gitignore

and why not use the existing dilog function ?


---

Comment by chapoton created at 2015-06-10 08:51:31

Changing status from needs_review to needs_work.


---

Comment by was created at 2015-07-08 18:54:57

I just tried to build against sage-6.8.beta7 and this fails due to using "flint_depends" in the module_list.py.  Evidently flint_depends no longer exists.


---

Comment by was created at 2015-07-08 18:55:16

And that this still hasn't got into Sage is **depressing**.


---

Comment by vbraun created at 2015-07-08 19:41:05

Well can we fix the build failure, the typo, and the .gitignore thing? That shouldn't take more than five minutes...


---

Comment by chapoton created at 2015-07-09 12:53:21

done

but still nobody has answered my question about the dilog
----
New commits:


---

Comment by vbraun created at 2015-07-09 20:03:03

Replying to [comment:55 chapoton]:
> but still nobody has answered my question about the dilog

Because its not a particularly productive or useful line of inquiry. For general discussions there is sage-devel, if you want to propose some guideline on methods vs functions then open a different ticket. Review should consist of immediately actionable items.


---

Comment by vbraun created at 2015-07-09 20:03:03

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2015-07-09 22:42:50

'''What ?!

My question was not a matter of "general discussion" but the very precise point that this ticket is 
reimplementing the dilog function instead of using the existing one. If you think that one
should not care for such a code duplication, then of course let us do whatever we want, without
boring about explaining why.


---

Comment by vbraun created at 2015-07-09 23:20:54

First of all, the ticket does not reimplement the dilog. It uses a library function. The only question is: Should RDF have a convenience .dilog() method next to .sin() etc. The answer to the latter is: I don't give a rat's ass. Its such an inconsequential detail, I want the 5 seconds of my life back that I spent thinking about it. Do you think Sage's success will depend on whether RDF elements have a dilog method? Try to contrast it with the importance of implementing the analytic rank bound.


---

Comment by vbraun created at 2015-07-11 14:03:35

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-07-11 14:03:35

Some more numerical noise on 32-bit:

```
sage -t --long src/sage/lfunctions/zero_sums.pyx
**********************************************************************
File "src/sage/lfunctions/zero_sums.pyx", line 337, in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.logarithmic_derivative
Failed example:
    Z.logarithmic_derivative(2.2,num_terms=50000) # long time
Expected:
    (0.5751579645060139, 0.008988775519160675)
Got:
    (0.5751579645060141, 0.008988775519160675)
**********************************************************************
1 item had failures:
   1 of  10 in sage.lfunctions.zero_sums.LFunctionZeroSum_abstract.logarithmic_derivative
    [132 tests, 1 failure, 8.98 s]
sage -t --long src/sage/rings/real_double.pyx
**********************************************************************
File "src/sage/rings/real_double.pyx", line 2198, in sage.rings.real_double.RealDoubleElement.dilog
Failed example:
    RDF(2).dilog()
Expected:
    2.46740110027234
Got:
    2.4674011002723395
**********************************************************************
1 item had failures:
   1 of   3 in sage.rings.real_double.RealDoubleElement.dilog
    [423 tests, 1 failure, 0.32 s]
```

Just needs a suitable `# rel tol`...


---

Comment by git created at 2015-07-12 00:17:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-07-12 09:43:08

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-07-13 17:58:45

Resolution: fixed
