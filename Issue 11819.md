# Issue 11819: record time, version in sage-starts

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-11-04 21:04:31

Assignee: leif

The message printed by sage-starts should record the time and the version of Sage, especially since the output is now logged.


---

Comment by jhpalmieri created at 2011-11-04 21:06:39

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-11-04 21:06:39

Sample output (after running `sage -sh`):

```
$ ./sage-starts

Testing that Sage starts...
[2011-11-04 14:02:56] Sage Version 4.7.2.rc1, Release Date: 2011-10-27.  
Yes, Sage starts.
```

The last two lines are logged to `start.log`.


---

Comment by leif created at 2011-11-04 23:36:42

Ahem, what if Sage doesn't start?  Then we get no date...

So you could either do something like

```sh
echo "[`date +'%Y-%m-%d %H:%M:%S'`]" \
     "`sage --version | sed -n -e '/Version/s/^[ |]\+//;s/[ |]\+$//p'`." \
    | tee -a "$SAGE_ROOT"/start.log

spkg/pipestatus "sage -c \"print 'Yes, Sage starts.'\" 2>&1" "tee -a '$SAGE_ROOT'/start.log"
```

or, directly,

```sh
echo "[`date +'%Y-%m-%d %H:%M:%S'`]" \
     "`sed -n -e '/Version/s/^[ |]\+//;/Version/s/[ |]\+$//p' "$SAGE_LOCAL"/bin/sage-banner`." \
    | tee -a "$SAGE_ROOT"/start.log

spkg/pipestatus "sage -c \"print 'Yes, Sage starts.'\" 2>&1" "tee -a '$SAGE_ROOT'/start.log"
```

(`sage --version` is currently broken w.r.t. the removal, so you could actually move the `sed` command to `sage-sage`.)

or use `sage --python -c 'your favourite Python code'` for printing the date and Sage's version (*without* importing `sage.*`).


---

Comment by leif created at 2011-11-05 00:00:32

Instead of `sage-banner` (which should have a `.txt` extension btw.), you could also use one of our `VERSION.txt` files.


---

Comment by jhpalmieri created at 2011-11-05 00:21:30

Replying to [comment:2 leif]:
> Ahem, what if Sage doesn't start?  Then we get no date...

Oops, of course you're right.  Here's a new patch, using python instead of sage for the date and version.  (Note that the file sage/version.py is extremely simple, so if Python functions, we should be able to import it.)


---

Comment by jhpalmieri created at 2011-11-05 00:21:48

scripts repo


---

Attachment

Replying to [comment:4 jhpalmieri]:
> (Note that the file sage/version.py is extremely simple, so if Python functions, we should be able to import it.)

It is, but note that also `sage/__init__.py` is executed when you import `sage.version`.

This is not a problem right now, but may become one if Sage's import mechanics change (which is work in progress).  You could perhaps modify `PYTHONPATH` and `import version`, but I haven't tried that yet<sup>*</sup>.  Maybe run Sage's Python directly then (instead of `./sage --python ...`).


----
<sup>*</sup> `PYTHONPATH="devel/sage/sage" local/bin/python -c 'import version; ...'` should work, both from within and outside a Sage environment.


---

Comment by jhpalmieri created at 2011-11-05 01:29:25

Here's another version, using VERSION.txt.  This will therefore record any update information stored there.


---

Comment by leif created at 2011-11-05 04:05:42

How about

```sh
version=spkg/standard/VERSION.txt
echo "[`date +'%Y-%m-%d %H:%M:%S'`] `cat $version 2>/dev/null`" | tee -a start.log
...
```


or


```sh
version=spkg/standard/VERSION.txt
(echo -n "[`date +'%Y-%m-%d %H:%M:%S'`] "; cat $version 2>/dev/null) | tee -a start.log
...
```


?


---

Comment by jhpalmieri created at 2011-11-05 05:33:39

Sure, that's fine.


---

Comment by leif created at 2011-11-05 07:03:11

Replying to [comment:8 jhpalmieri]:
> Sure, that's fine.

Well, if you prepend `$SAGE_ROOT/` (which isn't necessary, since we've `cd`'ed to it), then you have to quote `$version` (with double quotes). ;-)


---

Attachment

scripts repo


---

Comment by jhpalmieri created at 2011-11-05 15:21:36

Another attempt (without `$SAGE_ROOT`).


---

Comment by leif created at 2011-11-05 22:54:17

Changing status from needs_review to positive_review.


---

Comment by leif created at 2011-11-05 22:54:17

Actually only depends on _one part_ (the one to `sage-starts`) _of one patch_ ([attachment:ticket:11926:11926_sage_starts.patch]) at #11926.

`sage-starts` could by the way be more robust, i.e., it shouldn't print the following if the current working directory just happens to not be `$SAGE_ROOT`, and `SAGE_ROOT` isn't set.

```sh
$ bin/sage-starts 

Testing that Sage starts...
[2011-11-05 23:15:43] 
bin/sage-starts: line 14: spkg/pipestatus: No such file or directory
Sage failed to start up.
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and send the log file
  /home/leif/Sage/sage-4.7.2-gcc-4.5.1/local/start.log
Describe your computer, operating system, etc.
```


(Also note the logfile's name / location.  The log just contains the time stamp, and left-over files are likely to pollute repositories; only the root repository ignores `*.log` files.  I'm not saying that this is something a user will typically run into [unless e.g. he/she includes `$SAGE_LOCAL/bin` into his/her `PATH`, which apparently some do, although they clearly shouldn't<sup>*</sup>], but one shouldn't print a message that encourages people to submit useless error reports.)




Otherwise *positive review*, since that's not really related to the purpose of this ticket.  Feel free to fix it here (or elsewhere) though.


----

<sup>*</sup> We may add this to the Installation Guide (that one shouldn't put `$SAGE_ROOT/local/bin/` into `PATH`), but IMHO most scripts there should do the "usual" sanity check, i.e. for example test whether `SAGE_LOCAL` is defined, since most (or at least many) depend on the Sage environment being already set up.


---

Comment by jhpalmieri created at 2011-11-06 03:29:51

We could add something like this:

```diff
diff --git a/sage-starts b/sage-starts
--- a/sage-starts
+++ b/sage-starts
`@``@` -7,6 +7,13 `@``@` if [ -n "$SAGE_ROOT" ]; then
     cd "$SAGE_ROOT"
 fi
 
+if [This is the Trac macro *! -x spkg/pipestatus * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#! -x spkg/pipestatus -macro); then
+    echo >&2 "Error: The file spkg/pipestatus was not found or is not"
+    echo >&2 "executable, perhaps because the 'sage-starts' script was"
+    echo >&2 "not run from the \$SAGE_ROOT directory.  Exiting."
+    exit 1
+fi
+
 echo
 echo "Testing that Sage starts..."
 version=spkg/standard/VERSION.txt
```



---

Comment by leif created at 2011-11-06 03:46:18

Replying to [comment:12 jhpalmieri]:
> We could add something like this:

```diff
diff --git a/sage-starts b/sage-starts
--- a/sage-starts
+++ b/sage-starts
`@``@` -7,6 +7,13 `@``@` if [ -n "$SAGE_ROOT" ]; then
     cd "$SAGE_ROOT"
 fi
 
+if [This is the Trac macro *! -x spkg/pipestatus * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#! -x spkg/pipestatus -macro); then
+    echo >&2 "Error: The file spkg/pipestatus was not found or is not"
+    echo >&2 "executable, perhaps because the 'sage-starts' script was"
+    echo >&2 "not run from the \$SAGE_ROOT directory.  Exiting."
+    exit 1
+fi
+
 echo
 echo "Testing that Sage starts..."
 version=spkg/standard/VERSION.txt
```


I had exactly the same in mind, although I would just print: _"This script has to be run from the SAGE_ROOT directory or with SAGE_ROOT properly set."_

I won't mind if you add your suggestion to your patch.  You could prepend ``pwd`/` to `spkg/pipestatus` (in the message) and perhaps then put that filename on a line by its own.


---

Comment by leif created at 2011-11-06 03:57:48

Although we could be a bit more clever and move the test up, i.e.


```sh
if [This is the Trac macro *-x "$SAGE_ROOT"/spkg/pipestatus * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-x "$SAGE_ROOT"/spkg/pipestatus -macro); then
    cd "$SAGE_ROOT"
elif [This is the Trac macro *! -x spkg/pipestatus * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#! -x spkg/pipestatus -macro); then
    # Complain that either SAGE_ROOT isn't set properly (if it's non-empty)
    # or that we're [presumably] in the wrong directory (otherwise).
    exit 1
fi
```



---

Comment by leif created at 2011-11-06 04:09:41

`s/`Complain that either`/`Complain either that`/`, i.e.


```sh
    ...
    if [This is the Trac macro *-z $SAGE_ROOT * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-z $SAGE_ROOT -macro); then
        echo >&2 "Error: This script ($0) has to be run from the SAGE_ROOT directory."
    else
        echo >&2 "Error: SAGE_ROOT(=$SAGE_ROOT) isn't properly set."
    fi
    ...
```



---

Comment by jhpalmieri created at 2011-11-06 05:10:29

Here's version 3.  If you think it's okay, please change the ticket description to refer to this patch instead of v2.


---

Attachment

scripts repo


---

Comment by leif created at 2011-11-06 05:34:03

Replying to [comment:16 jhpalmieri]:
> Here's version 3.  If you think it's okay, please change the ticket description to refer to this patch instead of v2.

Done and done.

As a side-effect, even `SAGE_ROOT=/foo/bar local/bin/sage-starts` now works. :)


---

Comment by jdemeyer created at 2011-11-07 10:13:13

Resolution: fixed
