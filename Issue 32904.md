# Issue 32904: Fix doctests in sage_setup and sage_docbuild for sage-on-distribution

archive/issues_032904.json:
```json
{
    "body": "CC:  @antonio-rojas\n\nSome doctests in sage_setup and sage_docbuild fail in sage-on-distributions. We can either\n\n* disabled them on distribution with `# optional - build`\n* fix them when it make sense\n\nThe failing doctests are\n\n```\nsage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_setup/find.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_setup/find.py\", line 243, in sage_setup.find._cythonized_dir\nFailed example:\n    _cythonized_dir(SAGE_SRC, editable_install=False)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.find._cythonized_dir[2]>\", line 1, in <module>\n        _cythonized_dir(SAGE_SRC, editable_install=False)\n      File \"/usr/lib/python3.10/site-packages/sage_setup/find.py\", line 261, in _cythonized_dir\n        return Path(SAGE_ROOT) / \"build\" / \"pkgs\" / \"sagelib\" / \"src\" / \"build\" / \"cythonized\"\n      File \"/usr/lib/python3.10/pathlib.py\", line 958, in __new__\n        self = cls._from_parts(args)\n      File \"/usr/lib/python3.10/pathlib.py\", line 592, in _from_parts\n        drv, root, parts = self._parse_args(args)\n      File \"/usr/lib/python3.10/pathlib.py\", line 576, in _parse_args\n        a = os.fspath(a)\n    TypeError: expected str, bytes or os.PathLike object, not NoneType\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_setup/find.py\", line 303, in sage_setup.find.find_extra_files\nFailed example:\n    extras[\"sage/ext/interpreters\"]\nExpected:\n    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]\nGot:\n    ['/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pyx',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pxd',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.h',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.h',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.h',\n     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.h']\n**********************************************************************\n```\n\nand\n\n```\nsage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 108, in sage_docbuild.builder_helper\nFailed example:\n    try:\n        build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n    except Exception as E:\n        \"Non-exception during docbuild: abort pool operation\" in str(E)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 206, in sage_docbuild.DocBuilder._doctrees_dir\nFailed example:\n    b._doctrees_dir()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.DocBuilder._doctrees_dir[2]>\", line 1, in <module>\n        b._doctrees_dir()\n      File \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 210, in _doctrees_dir\n        sage_makedirs(d)\n      File \"/usr/lib/python3.10/site-packages/sage/misc/misc.py\", line 90, in sage_makedirs\n        os.makedirs(dirname)\n      File \"/usr/lib/python3.10/os.py\", line 215, in makedirs\n        makedirs(head, exist_ok=exist_ok)\n      File \"/usr/lib/python3.10/os.py\", line 215, in makedirs\n        makedirs(head, exist_ok=exist_ok)\n      File \"/usr/lib/python3.10/os.py\", line 225, in makedirs\n        mkdir(name, mode)\n    PermissionError: [Errno 13] Permission denied: '/usr/share/doc/sage-doc-9999/doctrees'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 377, in sage_docbuild.AllBuilder.get_all_documents\nFailed example:\n    'en/tutorial' in documents\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 605, in sage_docbuild.ReferenceBuilder.get_all_documents\nFailed example:\n    refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.ReferenceBuilder.get_all_documents[2]>\", line 1, in <module>\n        refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)\n      File \"/usr/lib/python3.10/os.py\", line 679, in __getitem__\n        raise KeyError(key) from None\n    KeyError: 'SAGE_DOC_SRC'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 606, in sage_docbuild.ReferenceBuilder.get_all_documents\nFailed example:\n    sorted(b.get_all_documents(refdir))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.ReferenceBuilder.get_all_documents[3]>\", line 1, in <module>\n        sorted(b.get_all_documents(refdir))\n    NameError: name 'refdir' is not defined\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 1093, in sage_docbuild.ReferenceSubBuilder.auto_rest_filename\nFailed example:\n    ReferenceSubBuilder(\"reference\").auto_rest_filename(\"sage.combinat.partition\")\nExpected:\n    '.../doc/en/reference/sage/combinat/partition.rst'\nGot:\n    '/usr/share/doc/sage-doc-9999/en/reference/sage/combinat/partition.rst'\n**********************************************************************\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33141\n\n",
    "created_at": "2022-01-10T09:20:40Z",
    "labels": [
        "component: distribution",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Fix doctests in sage_setup and sage_docbuild for sage-on-distribution",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32904",
    "user": "https://github.com/kiwifb"
}
```
CC:  @antonio-rojas

Some doctests in sage_setup and sage_docbuild fail in sage-on-distributions. We can either

* disabled them on distribution with `# optional - build`
* fix them when it make sense

The failing doctests are

```
sage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_setup/find.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 243, in sage_setup.find._cythonized_dir
Failed example:
    _cythonized_dir(SAGE_SRC, editable_install=False)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find._cythonized_dir[2]>", line 1, in <module>
        _cythonized_dir(SAGE_SRC, editable_install=False)
      File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 261, in _cythonized_dir
        return Path(SAGE_ROOT) / "build" / "pkgs" / "sagelib" / "src" / "build" / "cythonized"
      File "/usr/lib/python3.10/pathlib.py", line 958, in __new__
        self = cls._from_parts(args)
      File "/usr/lib/python3.10/pathlib.py", line 592, in _from_parts
        drv, root, parts = self._parse_args(args)
      File "/usr/lib/python3.10/pathlib.py", line 576, in _parse_args
        a = os.fspath(a)
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 303, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.h']
**********************************************************************
```

and

```
sage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 108, in sage_docbuild.builder_helper
Failed example:
    try:
        build_many(build_ref_doc, [("docname", "en", "html", {})])
    except Exception as E:
        "Non-exception during docbuild: abort pool operation" in str(E)
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 206, in sage_docbuild.DocBuilder._doctrees_dir
Failed example:
    b._doctrees_dir()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.DocBuilder._doctrees_dir[2]>", line 1, in <module>
        b._doctrees_dir()
      File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 210, in _doctrees_dir
        sage_makedirs(d)
      File "/usr/lib/python3.10/site-packages/sage/misc/misc.py", line 90, in sage_makedirs
        os.makedirs(dirname)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 225, in makedirs
        mkdir(name, mode)
    PermissionError: [Errno 13] Permission denied: '/usr/share/doc/sage-doc-9999/doctrees'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 377, in sage_docbuild.AllBuilder.get_all_documents
Failed example:
    'en/tutorial' in documents
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 605, in sage_docbuild.ReferenceBuilder.get_all_documents
Failed example:
    refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.ReferenceBuilder.get_all_documents[2]>", line 1, in <module>
        refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)
      File "/usr/lib/python3.10/os.py", line 679, in __getitem__
        raise KeyError(key) from None
    KeyError: 'SAGE_DOC_SRC'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 606, in sage_docbuild.ReferenceBuilder.get_all_documents
Failed example:
    sorted(b.get_all_documents(refdir))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.ReferenceBuilder.get_all_documents[3]>", line 1, in <module>
        sorted(b.get_all_documents(refdir))
    NameError: name 'refdir' is not defined
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 1093, in sage_docbuild.ReferenceSubBuilder.auto_rest_filename
Failed example:
    ReferenceSubBuilder("reference").auto_rest_filename("sage.combinat.partition")
Expected:
    '.../doc/en/reference/sage/combinat/partition.rst'
Got:
    '/usr/share/doc/sage-doc-9999/en/reference/sage/combinat/partition.rst'
**********************************************************************
```


Issue created by migration from https://trac.sagemath.org/ticket/33141





---

archive/issue_comments_468736.json:
```json
{
    "body": "The first failing doctest expose some funny things in testing `_cythonised_dir`. The test block is as follow\n\n```\n        sage: from sage_setup.find import _cythonized_dir\n        sage: from sage.env import SAGE_SRC\n        sage: _cythonized_dir(SAGE_SRC)  # optional - build\n        PosixPath('...')\n        sage: _cythonized_dir(SAGE_SRC, editable_install=False)\n        PosixPath('.../build/cythonized')\n```\n\nand the code\n\n```\n    from importlib import import_module\n    from pathlib import Path\n    from sage.env import SAGE_ROOT, SAGE_SRC\n    if editable_install is None:\n        if src_dir is None:\n            src_dir = SAGE_SRC\n        src_dir = Path(src_dir)\n        sage = import_module('sage')\n        d = Path(sage.__file__).resolve().parent.parent\n        editable_install = d == src_dir.resolve()\n    if editable_install:\n        # Editable install: Cython generates files in the source tree\n        return src_dir\n    else:\n        return Path(SAGE_ROOT) / \"build\" / \"pkgs\" / \"sagelib\" / \"src\" / \"build\" / \"cythonized\"\n```\n\nThe test currently marked as `# optional - build` would succeed on distro. Because `editable_install` is found to be `True` in that case and in the case of Gentoo `SAGE_SRC` is `/usr/lib/python3.10/site-packages` - which is not an editable location :).\n\nWhen `editable_install` is set to `False` the code will always fail on distros since `SAGE_ROOT` is normally `None`. \n\nFor the sake of consistency let's just make them both `# optional - build`.",
    "created_at": "2022-01-10T09:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468736",
    "user": "https://github.com/kiwifb"
}
```

The first failing doctest expose some funny things in testing `_cythonised_dir`. The test block is as follow

```
        sage: from sage_setup.find import _cythonized_dir
        sage: from sage.env import SAGE_SRC
        sage: _cythonized_dir(SAGE_SRC)  # optional - build
        PosixPath('...')
        sage: _cythonized_dir(SAGE_SRC, editable_install=False)
        PosixPath('.../build/cythonized')
```

and the code

```
    from importlib import import_module
    from pathlib import Path
    from sage.env import SAGE_ROOT, SAGE_SRC
    if editable_install is None:
        if src_dir is None:
            src_dir = SAGE_SRC
        src_dir = Path(src_dir)
        sage = import_module('sage')
        d = Path(sage.__file__).resolve().parent.parent
        editable_install = d == src_dir.resolve()
    if editable_install:
        # Editable install: Cython generates files in the source tree
        return src_dir
    else:
        return Path(SAGE_ROOT) / "build" / "pkgs" / "sagelib" / "src" / "build" / "cythonized"
```

The test currently marked as `# optional - build` would succeed on distro. Because `editable_install` is found to be `True` in that case and in the case of Gentoo `SAGE_SRC` is `/usr/lib/python3.10/site-packages` - which is not an editable location :).

When `editable_install` is set to `False` the code will always fail on distros since `SAGE_ROOT` is normally `None`. 

For the sake of consistency let's just make them both `# optional - build`.



---

archive/issue_comments_468737.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-10T21:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468737",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468738.json:
```json
{
    "body": "Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` (not going to happen after install on a distro) or that `SAGE_DOC_SRC` contains actual doc sources which isn't the case on a distro after install since `SAGE_DOC_SRC` then points to `SAGE_DOC`.\n----\nNew commits:",
    "created_at": "2022-01-10T21:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468738",
    "user": "https://github.com/kiwifb"
}
```

Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` (not going to happen after install on a distro) or that `SAGE_DOC_SRC` contains actual doc sources which isn't the case on a distro after install since `SAGE_DOC_SRC` then points to `SAGE_DOC`.
----
New commits:



---

archive/issue_comments_468739.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-10T22:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468739",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_468740.json:
```json
{
    "body": "OK, I didn't know about those. That changes a lot of things.",
    "created_at": "2022-01-10T23:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468740",
    "user": "https://github.com/kiwifb"
}
```

OK, I didn't know about those. That changes a lot of things.



---

archive/issue_comments_468741.json:
```json
{
    "body": "OK, changes from the three tickets now marked has dependencies need to be taken into account. Only one of the identified doctests is directly linked to the presence of `sage_spkg`. With a few exceptions the rest are more complicated and may require some sort of `sage_src` tag.",
    "created_at": "2022-01-12T03:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468741",
    "user": "https://github.com/kiwifb"
}
```

OK, changes from the three tickets now marked has dependencies need to be taken into account. Only one of the identified doctests is directly linked to the presence of `sage_spkg`. With a few exceptions the rest are more complicated and may require some sort of `sage_src` tag.



---

archive/issue_comments_468742.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` \n\nAs I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory",
    "created_at": "2022-01-12T04:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468742",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 fbissey]:
> Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 

As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory



---

archive/issue_comments_468743.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Replying to [comment:2 fbissey]:\n> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` \n> \n> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory\n\nI do agree that it should be done and it will help some tests. It won't help with a few tests that rely on doc sources themselves to be present.\n\n```\nFile \"/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py\", line 377, in sage_docbuild.AllBuilder.get_all_documents\nFailed example:\n    'en/tutorial' in documents\nExpected:\n    True\nGot:\n    False\n```\n\nThat may be too much to chew for 9.5.",
    "created_at": "2022-01-12T04:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468743",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:6 mkoeppe]:
> Replying to [comment:2 fbissey]:
> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 
> 
> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory

I do agree that it should be done and it will help some tests. It won't help with a few tests that rely on doc sources themselves to be present.

```
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 377, in sage_docbuild.AllBuilder.get_all_documents
Failed example:
    'en/tutorial' in documents
Expected:
    True
Got:
    False
```

That may be too much to chew for 9.5.



---

archive/issue_events_087567.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-28T23:03:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32904#event-87567"
}
```



---

archive/issue_comments_468744.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Replying to [comment:2 fbissey]:\n> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` \n> \n> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory\n\nI tried a few approaches to that. None worked in practice. I have tried to change `SAGE_DOC` at the start of test sequence, and it works when I try it manually, but not when the doctest runs. I tried to set `SAGE_DOC` at the start of `sage-runtests` and it equally failed. I have a feeling `sage_conf.py` does override a lot things.",
    "created_at": "2022-02-07T10:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468744",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:6 mkoeppe]:
> Replying to [comment:2 fbissey]:
> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 
> 
> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory

I tried a few approaches to that. None worked in practice. I have tried to change `SAGE_DOC` at the start of test sequence, and it works when I try it manually, but not when the doctest runs. I tried to set `SAGE_DOC` at the start of `sage-runtests` and it equally failed. I have a feeling `sage_conf.py` does override a lot things.



---

archive/issue_comments_468745.json:
```json
{
    "body": "Import of `SAGE_DOC` early in `__init__.py` is why stuff doesn't work as expected. Removing it from the global list at the beginning and importing it only where necessary later helped. I'll see which implementation give the best results, I'd like setting stuff from `sage-runtests` once for all, and it would be more consistent. In the alternative, setting `SAGE_DOC` in the first test involving it is enough to set it for all other tests, so `sage-runtests` would feel a less random location.\n\nAfter that, why is `SAGE_DOC_SRC` seems to be ending up as `None` instead of the same value as `SAGE_DOC` like in normal operation.",
    "created_at": "2022-02-07T21:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468745",
    "user": "https://github.com/kiwifb"
}
```

Import of `SAGE_DOC` early in `__init__.py` is why stuff doesn't work as expected. Removing it from the global list at the beginning and importing it only where necessary later helped. I'll see which implementation give the best results, I'd like setting stuff from `sage-runtests` once for all, and it would be more consistent. In the alternative, setting `SAGE_DOC` in the first test involving it is enough to set it for all other tests, so `sage-runtests` would feel a less random location.

After that, why is `SAGE_DOC_SRC` seems to be ending up as `None` instead of the same value as `SAGE_DOC` like in normal operation.



---

archive/issue_comments_468746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-07T22:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468747.json:
```json
{
    "body": "Ready for review. Using `sage_spkg` feels abusive but it is what it is.",
    "created_at": "2022-02-07T22:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468747",
    "user": "https://github.com/kiwifb"
}
```

Ready for review. Using `sage_spkg` feels abusive but it is what it is.



---

archive/issue_comments_468748.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-07T22:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468748",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_468749.json:
```json
{
    "body": "`@`arojas, since you were interested in #33256 that stuff may be on your list too.",
    "created_at": "2022-02-07T22:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468749",
    "user": "https://github.com/kiwifb"
}
```

`@`arojas, since you were interested in #33256 that stuff may be on your list too.



---

archive/issue_comments_468750.json:
```json
{
    "body": "Replying to [comment:14 fbissey]:\n> `@`arojas, since you were interested in #33256 that stuff may be on your list too.\n\nThanks. I have never actually run these tests, things building correctly is enough testing for me. I guess it's more important for a source based distro.",
    "created_at": "2022-02-08T08:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468750",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:14 fbissey]:
> `@`arojas, since you were interested in #33256 that stuff may be on your list too.

Thanks. I have never actually run these tests, things building correctly is enough testing for me. I guess it's more important for a source based distro.



---

archive/issue_comments_468751.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2022-02-08T20:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468751",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_468752.json:
```json
{
    "body": "I am having second thoughts about setting stuff in `sage-runtests`. Only stuff in `sage_docbuild` should need it. Other doctests in sage proper relies on its presence as a properly installed thing, not trying to create things in it.",
    "created_at": "2022-02-08T20:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468752",
    "user": "https://github.com/kiwifb"
}
```

I am having second thoughts about setting stuff in `sage-runtests`. Only stuff in `sage_docbuild` should need it. Other doctests in sage proper relies on its presence as a properly installed thing, not trying to create things in it.



---

archive/issue_comments_468753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-08T21:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468754.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-02-08T21:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468754",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_468755.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-01T06:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468756.json:
```json
{
    "body": "Not sure what happened when I merged develop into the branch. Looks like some commits disappeared. Will get the branch back into shape.",
    "created_at": "2022-03-01T06:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468756",
    "user": "https://github.com/kiwifb"
}
```

Not sure what happened when I merged develop into the branch. Looks like some commits disappeared. Will get the branch back into shape.



---

archive/issue_comments_468757.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-01T06:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468757",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_468758.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T07:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468758",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468759.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-01T07:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468759",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_468760.json:
```json
{
    "body": "There's an `# optional - build` in there, probably not intended",
    "created_at": "2022-03-01T07:46:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468760",
    "user": "https://github.com/mkoeppe"
}
```

There's an `# optional - build` in there, probably not intended



---

archive/issue_comments_468761.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T07:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468762.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> There's an `# optional - build` in there, probably not intended\n\nIndeed there was. Must have escaped because I didn't notice it was on two lines in a row.",
    "created_at": "2022-03-01T07:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468762",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:23 mkoeppe]:
> There's an `# optional - build` in there, probably not intended

Indeed there was. Must have escaped because I didn't notice it was on two lines in a row.



---

archive/issue_comments_468763.json:
```json
{
    "body": "I currently have a new interesting issue\n\n```\nFile \"sage_setup/find.py\", line 303, in sage_setup.find.find_extra_files\nFailed example:\n    extras[\"sage/ext/interpreters\"]\nExpected:\n    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]\nGot:\n    ['/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pxd',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pxd',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pxd',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pxd',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pxd',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pyx',\n     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pxd']\n**********************************************************************\n```\n\nthe order can be random :) I am not sure why, but with this new way of running the doctests I am trialling, a few tests like this one are off. But in this case there was never any reason for the order, it is just lucky it seemed to always follow that pattern.",
    "created_at": "2022-03-15T22:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468763",
    "user": "https://github.com/kiwifb"
}
```

I currently have a new interesting issue

```
File "sage_setup/find.py", line 303, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pxd']
**********************************************************************
```

the order can be random :) I am not sure why, but with this new way of running the doctests I am trialling, a few tests like this one are off. But in this case there was never any reason for the order, it is just lucky it seemed to always follow that pattern.



---

archive/issue_comments_468764.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-15T23:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468764",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468765.json:
```json
{
    "body": "I decided against sorting the test about `extras[\"sage/libs/mpfr\"]` run just before `extras[\"sage/ext/interpreters\"]` because the output is limited to two elements and the doctest, as written, would survive a change of order.",
    "created_at": "2022-03-15T23:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468765",
    "user": "https://github.com/kiwifb"
}
```

I decided against sorting the test about `extras["sage/libs/mpfr"]` run just before `extras["sage/ext/interpreters"]` because the output is limited to two elements and the doctest, as written, would survive a change of order.



---

archive/issue_comments_468766.json:
```json
{
    "body": "LGTM",
    "created_at": "2022-03-17T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468766",
    "user": "https://github.com/mkoeppe"
}
```

LGTM



---

archive/issue_comments_468767.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-17T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468767",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468768.json:
```json
{
    "body": "I'll need a follow up, one of my commits did not make it in the merge with the last beta and I did not notice. I suspect my tree may have been dirty. Annoying but not a show stopper for the content of this ticket.",
    "created_at": "2022-03-20T22:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468768",
    "user": "https://github.com/kiwifb"
}
```

I'll need a follow up, one of my commits did not make it in the merge with the last beta and I did not notice. I suspect my tree may have been dirty. Annoying but not a show stopper for the content of this ticket.



---

archive/issue_comments_468769.json:
```json
{
    "body": "Some bits of my missing commit were in conflict with #32987 that's probably part of how it happened.",
    "created_at": "2022-03-21T00:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468769",
    "user": "https://github.com/kiwifb"
}
```

Some bits of my missing commit were in conflict with #32987 that's probably part of how it happened.



---

archive/issue_comments_468770.json:
```json
{
    "body": "Follow up at #33538. I am preferring a follow up because Volker is currently merging this ticket and I am expecting him to close it in the next few days.",
    "created_at": "2022-03-21T00:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468770",
    "user": "https://github.com/kiwifb"
}
```

Follow up at #33538. I am preferring a follow up because Volker is currently merging this ticket and I am expecting him to close it in the next few days.



---

archive/issue_events_087568.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-21T23:34:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32904#event-87568"
}
```



---

archive/issue_comments_468771.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-21T23:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32904#issuecomment-468771",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
