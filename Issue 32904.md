# Issue 32904: Fix doctests in sage_setup and sage_docbuild for sage-on-distribution

Issue created by migration from https://trac.sagemath.org/ticket/33141

Original creator: fbissey

Original creation time: 2022-01-10 09:20:40

CC:  arojas

Some doctests in sage_setup and sage_docbuild fail in sage-on-distributions. We can either

* disabled them on distribution with `# optional - build`
* fix them when it make sense

The failing doctests are

```
sage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_setup/find.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 243, in sage_setup.find._cythonized_dir
Failed example:
    _cythonized_dir(SAGE_SRC, editable_install=False)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find._cythonized_dir[2]>", line 1, in <module>
        _cythonized_dir(SAGE_SRC, editable_install=False)
      File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 261, in _cythonized_dir
        return Path(SAGE_ROOT) / "build" / "pkgs" / "sagelib" / "src" / "build" / "cythonized"
      File "/usr/lib/python3.10/pathlib.py", line 958, in __new__
        self = cls._from_parts(args)
      File "/usr/lib/python3.10/pathlib.py", line 592, in _from_parts
        drv, root, parts = self._parse_args(args)
      File "/usr/lib/python3.10/pathlib.py", line 576, in _parse_args
        a = os.fspath(a)
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_setup/find.py", line 303, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rdf.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_py.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pyx',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.pxd',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_rr.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cc.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_cdf.h',
     '/usr/lib/python3.10/site-packages/sage/ext/interpreters/wrapper_el.h']
**********************************************************************
```

and

```
sage -t --long --random-seed=204418260052577960635697341654995479733 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 108, in sage_docbuild.builder_helper
Failed example:
    try:
        build_many(build_ref_doc, [("docname", "en", "html", {})])
    except Exception as E:
        "Non-exception during docbuild: abort pool operation" in str(E)
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 206, in sage_docbuild.DocBuilder._doctrees_dir
Failed example:
    b._doctrees_dir()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.DocBuilder._doctrees_dir[2]>", line 1, in <module>
        b._doctrees_dir()
      File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 210, in _doctrees_dir
        sage_makedirs(d)
      File "/usr/lib/python3.10/site-packages/sage/misc/misc.py", line 90, in sage_makedirs
        os.makedirs(dirname)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 215, in makedirs
        makedirs(head, exist_ok=exist_ok)
      File "/usr/lib/python3.10/os.py", line 225, in makedirs
        mkdir(name, mode)
    PermissionError: [Errno 13] Permission denied: '/usr/share/doc/sage-doc-9999/doctrees'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 377, in sage_docbuild.AllBuilder.get_all_documents
Failed example:
    'en/tutorial' in documents
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 605, in sage_docbuild.ReferenceBuilder.get_all_documents
Failed example:
    refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.ReferenceBuilder.get_all_documents[2]>", line 1, in <module>
        refdir = os.path.join(os.environ['SAGE_DOC_SRC'], 'en', b.name)
      File "/usr/lib/python3.10/os.py", line 679, in __getitem__
        raise KeyError(key) from None
    KeyError: 'SAGE_DOC_SRC'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 606, in sage_docbuild.ReferenceBuilder.get_all_documents
Failed example:
    sorted(b.get_all_documents(refdir))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.ReferenceBuilder.get_all_documents[3]>", line 1, in <module>
        sorted(b.get_all_documents(refdir))
    NameError: name 'refdir' is not defined
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 1093, in sage_docbuild.ReferenceSubBuilder.auto_rest_filename
Failed example:
    ReferenceSubBuilder("reference").auto_rest_filename("sage.combinat.partition")
Expected:
    '.../doc/en/reference/sage/combinat/partition.rst'
Got:
    '/usr/share/doc/sage-doc-9999/en/reference/sage/combinat/partition.rst'
**********************************************************************
```



---

Comment by fbissey created at 2022-01-10 09:33:34

The first failing doctest expose some funny things in testing `_cythonised_dir`. The test block is as follow

```
        sage: from sage_setup.find import _cythonized_dir
        sage: from sage.env import SAGE_SRC
        sage: _cythonized_dir(SAGE_SRC)  # optional - build
        PosixPath('...')
        sage: _cythonized_dir(SAGE_SRC, editable_install=False)
        PosixPath('.../build/cythonized')
```

and the code

```
    from importlib import import_module
    from pathlib import Path
    from sage.env import SAGE_ROOT, SAGE_SRC
    if editable_install is None:
        if src_dir is None:
            src_dir = SAGE_SRC
        src_dir = Path(src_dir)
        sage = import_module('sage')
        d = Path(sage.__file__).resolve().parent.parent
        editable_install = d == src_dir.resolve()
    if editable_install:
        # Editable install: Cython generates files in the source tree
        return src_dir
    else:
        return Path(SAGE_ROOT) / "build" / "pkgs" / "sagelib" / "src" / "build" / "cythonized"
```

The test currently marked as `# optional - build` would succeed on distro. Because `editable_install` is found to be `True` in that case and in the case of Gentoo `SAGE_SRC` is `/usr/lib/python3.10/site-packages` - which is not an editable location :).

When `editable_install` is set to `False` the code will always fail on distros since `SAGE_ROOT` is normally `None`. 

For the sake of consistency let's just make them both `# optional - build`.


---

Comment by fbissey created at 2022-01-10 21:42:22

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-01-10 21:42:22

Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` (not going to happen after install on a distro) or that `SAGE_DOC_SRC` contains actual doc sources which isn't the case on a distro after install since `SAGE_DOC_SRC` then points to `SAGE_DOC`.
----
New commits:


---

Comment by mkoeppe created at 2022-01-10 22:38:05

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2022-01-10 23:56:47

OK, I didn't know about those. That changes a lot of things.


---

Comment by fbissey created at 2022-01-12 03:57:28

OK, changes from the three tickets now marked has dependencies need to be taken into account. Only one of the identified doctests is directly linked to the presence of `sage_spkg`. With a few exceptions the rest are more complicated and may require some sort of `sage_src` tag.


---

Comment by mkoeppe created at 2022-01-12 04:17:43

Replying to [comment:2 fbissey]:
> Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 

As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory


---

Comment by fbissey created at 2022-01-12 04:25:37

Replying to [comment:6 mkoeppe]:
> Replying to [comment:2 fbissey]:
> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 
> 
> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory

I do agree that it should be done and it will help some tests. It won't help with a few tests that rely on doc sources themselves to be present.

```
File "/usr/lib/python3.10/site-packages/sage_docbuild/__init__.py", line 377, in sage_docbuild.AllBuilder.get_all_documents
Failed example:
    'en/tutorial' in documents
Expected:
    True
Got:
    False
```

That may be too much to chew for 9.5.


---

Comment by fbissey created at 2022-02-07 10:15:56

Replying to [comment:6 mkoeppe]:
> Replying to [comment:2 fbissey]:
> > Apart from one doctest, all the failing doctests in sage_docbuild require access to a writable `SAGE_DOC_SRC` 
> 
> As I said in #33064#comment:4, I think these doctests should be changed so that they temporarily set `SAGE_DOC` to a writable temporary directory

I tried a few approaches to that. None worked in practice. I have tried to change `SAGE_DOC` at the start of test sequence, and it works when I try it manually, but not when the doctest runs. I tried to set `SAGE_DOC` at the start of `sage-runtests` and it equally failed. I have a feeling `sage_conf.py` does override a lot things.


---

Comment by fbissey created at 2022-02-07 21:40:39

Import of `SAGE_DOC` early in `__init__.py` is why stuff doesn't work as expected. Removing it from the global list at the beginning and importing it only where necessary later helped. I'll see which implementation give the best results, I'd like setting stuff from `sage-runtests` once for all, and it would be more consistent. In the alternative, setting `SAGE_DOC` in the first test involving it is enough to set it for all other tests, so `sage-runtests` would feel a less random location.

After that, why is `SAGE_DOC_SRC` seems to be ending up as `None` instead of the same value as `SAGE_DOC` like in normal operation.


---

Comment by git created at 2022-02-07 22:19:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2022-02-07 22:24:11

Ready for review. Using `sage_spkg` feels abusive but it is what it is.


---

Comment by fbissey created at 2022-02-07 22:24:11

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2022-02-07 22:56:08

`@`arojas, since you were interested in #33256 that stuff may be on your list too.


---

Comment by arojas created at 2022-02-08 08:02:28

Replying to [comment:14 fbissey]:
> `@`arojas, since you were interested in #33256 that stuff may be on your list too.

Thanks. I have never actually run these tests, things building correctly is enough testing for me. I guess it's more important for a source based distro.


---

Comment by fbissey created at 2022-02-08 20:05:55

Changing status from needs_review to needs_info.


---

Comment by fbissey created at 2022-02-08 20:05:55

I am having second thoughts about setting stuff in `sage-runtests`. Only stuff in `sage_docbuild` should need it. Other doctests in sage proper relies on its presence as a properly installed thing, not trying to create things in it.


---

Comment by git created at 2022-02-08 21:41:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2022-02-08 21:43:22

Changing status from needs_info to needs_review.


---

Comment by git created at 2022-03-01 06:49:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2022-03-01 06:53:02

Not sure what happened when I merged develop into the branch. Looks like some commits disappeared. Will get the branch back into shape.


---

Comment by fbissey created at 2022-03-01 06:53:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-01 07:33:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-03-01 07:33:23

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-01 07:46:00

There's an `# optional - build` in there, probably not intended


---

Comment by git created at 2022-03-01 07:48:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-03-01 07:49:43

Replying to [comment:23 mkoeppe]:
> There's an `# optional - build` in there, probably not intended

Indeed there was. Must have escaped because I didn't notice it was on two lines in a row.


---

Comment by fbissey created at 2022-03-15 22:49:24

I currently have a new interesting issue

```
File "sage_setup/find.py", line 303, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cc.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rr.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_rdf.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_py.pxd',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_el.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pyx',
     '/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src/sage/ext/interpreters/wrapper_cdf.pxd']
**********************************************************************
```

the order can be random :) I am not sure why, but with this new way of running the doctests I am trialling, a few tests like this one are off. But in this case there was never any reason for the order, it is just lucky it seemed to always follow that pattern.


---

Comment by git created at 2022-03-15 23:01:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-03-15 23:04:42

I decided against sorting the test about `extras["sage/libs/mpfr"]` run just before `extras["sage/ext/interpreters"]` because the output is limited to two elements and the doctest, as written, would survive a change of order.


---

Comment by mkoeppe created at 2022-03-17 18:36:33

LGTM


---

Comment by mkoeppe created at 2022-03-17 18:36:33

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-03-20 22:35:00

I'll need a follow up, one of my commits did not make it in the merge with the last beta and I did not notice. I suspect my tree may have been dirty. Annoying but not a show stopper for the content of this ticket.


---

Comment by fbissey created at 2022-03-21 00:17:02

Some bits of my missing commit were in conflict with #32987 that's probably part of how it happened.


---

Comment by fbissey created at 2022-03-21 00:41:48

Follow up at #33538. I am preferring a follow up because Volker is currently merging this ticket and I am expecting him to close it in the next few days.


---

Comment by vbraun created at 2022-03-21 23:34:41

Resolution: fixed
