# Issue 12739: fix failing ipython test in tests/cmdline

archive/issues_012739.json:
```json
{
    "body": "Assignee: @jasongrout\n\nKeywords: ipython\n\nThe test\n\n```\n        sage: (out, err, ret) = test_executable([\"sage\", \"--ipython\"], \"\\n3**33\\n\")\n        sage: out.find(\"5559060566555523\") >= 0\n        True\n```\n\nfails if people have installed a newer version of ipython, which leaves incompatible files in `~/ipython/`. We might consider setting `IPYTHONDIR` to `$DOT_SAGE/ipython/` in `sage-env`, but the simplest fix seems to be to do this right before running the test.\n\nTest this by running `sage --ipython` to create config files in `~/ipython/`. Then edit `~/ipython/ipy_user_conf.py` to (for example) make it invalid Python, so it prints an error when you start `sage --ipython`. Then doctest the file `cmdline.py` before and after applying the patch.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12911\n\n",
    "created_at": "2012-05-06T15:27:32Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "fix failing ipython test in tests/cmdline",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12739",
    "user": "@jhpalmieri"
}
```
Assignee: @jasongrout

Keywords: ipython

The test

```
        sage: (out, err, ret) = test_executable(["sage", "--ipython"], "\n3**33\n")
        sage: out.find("5559060566555523") >= 0
        True
```

fails if people have installed a newer version of ipython, which leaves incompatible files in `~/ipython/`. We might consider setting `IPYTHONDIR` to `$DOT_SAGE/ipython/` in `sage-env`, but the simplest fix seems to be to do this right before running the test.

Test this by running `sage --ipython` to create config files in `~/ipython/`. Then edit `~/ipython/ipy_user_conf.py` to (for example) make it invalid Python, so it prints an error when you start `sage --ipython`. Then doctest the file `cmdline.py` before and after applying the patch.

Issue created by migration from https://trac.sagemath.org/ticket/12911





---

archive/issue_comments_152612.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-06T15:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152612",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_152613.json:
```json
{
    "body": "Attachment [trac_12911-ipython-test.patch](tarball://root/attachments/some-uuid/ticket12911/trac_12911-ipython-test.patch) by @jhpalmieri created at 2012-05-06 15:29:48",
    "created_at": "2012-05-06T15:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152613",
    "user": "@jhpalmieri"
}
```

Attachment [trac_12911-ipython-test.patch](tarball://root/attachments/some-uuid/ticket12911/trac_12911-ipython-test.patch) by @jhpalmieri created at 2012-05-06 15:29:48



---

archive/issue_comments_152614.json:
```json
{
    "body": "So this ticket depends on #12719, right?",
    "created_at": "2012-05-07T13:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152614",
    "user": "@jasongrout"
}
```

So this ticket depends on #12719, right?



---

archive/issue_comments_152615.json:
```json
{
    "body": "Oh, wait; rereading your description makes it seem like the problem is if they have a system 0.12, but Sage's 0.10, that causes a problem.\n\nSo installing #12719 won't solve the problem by itself, since modifying the global config file to be invalid python still would cause problems.  However, perhaps the IPython config directory should be set to a temporary directory that can be deleted after the doctest is run?  That would fulfill the ideal that doctests don't leave files laying around.",
    "created_at": "2012-05-07T13:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152615",
    "user": "@jasongrout"
}
```

Oh, wait; rereading your description makes it seem like the problem is if they have a system 0.12, but Sage's 0.10, that causes a problem.

So installing #12719 won't solve the problem by itself, since modifying the global config file to be invalid python still would cause problems.  However, perhaps the IPython config directory should be set to a temporary directory that can be deleted after the doctest is run?  That would fulfill the ideal that doctests don't leave files laying around.



---

archive/issue_comments_152616.json:
```json
{
    "body": "The doctest shouldn't leave any extra files lying around: on startup, Sage should create `DOT_SAGE/ipython/` (if it doesn't exist already) and populate it with various files. From the main `sage` script (`SAGE_ROOT/spkg/bin/sage`):\n\n```\n    IPYTHONDIR=\"$DOT_SAGE/ipython\" && export IPYTHONDIR\n    IPYTHONRC=\"ipythonrc\" && export IPYTHONRC\n    if [ ! -d \"$IPYTHONDIR\" ]; then\n        mkdir -p \"$DOT_SAGE\"\n        cp -r \"$SAGE_ROOT/ipython\" \"$DOT_SAGE/\"\n    fi\n```\n\nRunning the doctest shouldn't create anything new, just use the already-present config files.",
    "created_at": "2012-05-07T16:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152616",
    "user": "@jhpalmieri"
}
```

The doctest shouldn't leave any extra files lying around: on startup, Sage should create `DOT_SAGE/ipython/` (if it doesn't exist already) and populate it with various files. From the main `sage` script (`SAGE_ROOT/spkg/bin/sage`):

```
    IPYTHONDIR="$DOT_SAGE/ipython" && export IPYTHONDIR
    IPYTHONRC="ipythonrc" && export IPYTHONRC
    if [ ! -d "$IPYTHONDIR" ]; then
        mkdir -p "$DOT_SAGE"
        cp -r "$SAGE_ROOT/ipython" "$DOT_SAGE/"
    fi
```

Running the doctest shouldn't create anything new, just use the already-present config files.



---

archive/issue_comments_152617.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-14T21:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152617",
    "user": "@kini"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152618.json:
```json
{
    "body": "Oops, I didn't realize this hadn't been reviewed! The code is obviously correct. Positive review from me.",
    "created_at": "2012-06-14T21:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152618",
    "user": "@kini"
}
```

Oops, I didn't realize this hadn't been reviewed! The code is obviously correct. Positive review from me.



---

archive/issue_comments_152619.json:
```json
{
    "body": "Why not do this in `sage-env`? That would seem a lot more logical to me.",
    "created_at": "2012-06-15T20:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152619",
    "user": "@jdemeyer"
}
```

Why not do this in `sage-env`? That would seem a lot more logical to me.



---

archive/issue_comments_152620.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2012-06-15T20:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152620",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_152621.json:
```json
{
    "body": "I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.",
    "created_at": "2012-06-15T21:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152621",
    "user": "@jhpalmieri"
}
```

I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.



---

archive/issue_comments_152622.json:
```json
{
    "body": "I agree with John, for what it's worth.",
    "created_at": "2012-06-15T22:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152622",
    "user": "@kini"
}
```

I agree with John, for what it's worth.



---

archive/issue_comments_152623.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-06-15T22:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152623",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_152624.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.\nCool.  In this case, what you did is the right thing.",
    "created_at": "2012-06-15T22:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152624",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 jhpalmieri]:
> I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.
Cool.  In this case, what you did is the right thing.



---

archive/issue_comments_152625.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-15T22:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152625",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152626.json:
```json
{
    "body": "Why can't I directly change status from needs_info to positive_review?  I always find this so annoying.",
    "created_at": "2012-06-15T22:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152626",
    "user": "@jdemeyer"
}
```

Why can't I directly change status from needs_info to positive_review?  I always find this so annoying.



---

archive/issue_comments_152627.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-06-23T21:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12739#issuecomment-152627",
    "user": "@jdemeyer"
}
```

Resolution: fixed
