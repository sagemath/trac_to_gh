# Issue 12739: fix failing ipython test in tests/cmdline

Issue created by migration from https://trac.sagemath.org/ticket/12911

Original creator: jhpalmieri

Original creation time: 2012-05-06 15:27:32

Assignee: jason

Keywords: ipython

The test

```
        sage: (out, err, ret) = test_executable(["sage", "--ipython"], "\n3**33\n")
        sage: out.find("5559060566555523") >= 0
        True
```

fails if people have installed a newer version of ipython, which leaves incompatible files in `~/ipython/`. We might consider setting `IPYTHONDIR` to `$DOT_SAGE/ipython/` in `sage-env`, but the simplest fix seems to be to do this right before running the test.

Test this by running `sage --ipython` to create config files in `~/ipython/`. Then edit `~/ipython/ipy_user_conf.py` to (for example) make it invalid Python, so it prints an error when you start `sage --ipython`. Then doctest the file `cmdline.py` before and after applying the patch.


---

Comment by jhpalmieri created at 2012-05-06 15:29:48

Changing status from new to needs_review.


---

Attachment


---

Comment by jason created at 2012-05-07 13:09:21

So this ticket depends on #12719, right?


---

Comment by jason created at 2012-05-07 13:13:46

Oh, wait; rereading your description makes it seem like the problem is if they have a system 0.12, but Sage's 0.10, that causes a problem.

So installing #12719 won't solve the problem by itself, since modifying the global config file to be invalid python still would cause problems.  However, perhaps the IPython config directory should be set to a temporary directory that can be deleted after the doctest is run?  That would fulfill the ideal that doctests don't leave files laying around.


---

Comment by jhpalmieri created at 2012-05-07 16:55:42

The doctest shouldn't leave any extra files lying around: on startup, Sage should create `DOT_SAGE/ipython/` (if it doesn't exist already) and populate it with various files. From the main `sage` script (`SAGE_ROOT/spkg/bin/sage`):

```
    IPYTHONDIR="$DOT_SAGE/ipython" && export IPYTHONDIR
    IPYTHONRC="ipythonrc" && export IPYTHONRC
    if [ ! -d "$IPYTHONDIR" ]; then
        mkdir -p "$DOT_SAGE"
        cp -r "$SAGE_ROOT/ipython" "$DOT_SAGE/"
    fi
```

Running the doctest shouldn't create anything new, just use the already-present config files.


---

Comment by kini created at 2012-06-14 21:15:10

Changing status from needs_review to positive_review.


---

Comment by kini created at 2012-06-14 21:15:10

Oops, I didn't realize this hadn't been reviewed! The code is obviously correct. Positive review from me.


---

Comment by jdemeyer created at 2012-06-15 20:57:45

Why not do this in `sage-env`? That would seem a lot more logical to me.


---

Comment by jdemeyer created at 2012-06-15 20:57:45

Changing status from positive_review to needs_info.


---

Comment by jhpalmieri created at 2012-06-15 21:06:25

I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.


---

Comment by kini created at 2012-06-15 22:00:10

I agree with John, for what it's worth.


---

Comment by jdemeyer created at 2012-06-15 22:02:48

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2012-06-15 22:02:48

Replying to [comment:7 jhpalmieri]:
> I think if you run `sage --ipython`, it should not use the files in `DOT_SAGE/ipython`; otherwise, the default IPython prompt becomes `sage:`, for example.
Cool.  In this case, what you did is the right thing.


---

Comment by jdemeyer created at 2012-06-15 22:03:18

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-15 22:03:18

Why can't I directly change status from needs_info to positive_review?  I always find this so annoying.


---

Comment by jdemeyer created at 2012-06-23 21:44:47

Resolution: fixed
