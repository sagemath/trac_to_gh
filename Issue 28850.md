# Issue 28850: Add GitHub Actions workflow for testing spkg-configure / build on various Linux distributions

Issue created by migration from https://trac.sagemath.org/ticket/29087

Original creator: mkoeppe

Original creation time: 2020-01-27 16:50:37

CC:  dimpase vbraun saraedum isuruf arojas fbissey

This is a follow-up on #29053: Add debian/fedora/arch package information to build/pkgs, generate Dockerfiles and installation help

This ticket adds `.github/workflows/tox.yml`, which installs a number of system packages and then runs `./bootstrap`, `./configure` and a bit of `make`.

Most of the interesting parts are in #29053 - everything can be run "locally" (with tox and docker). This ticket only adds a simple additional file to run this automatically with several jobs on [GitHub](GitHub) Actions on a commit.

For each of the Linux distributions supported, there are two configurations: 
- `minimal` - has enough packages so that the build can succeed; 
- `standard` - has additionally all standard packages for which we have `spkg-configure.m4`.

Context: 
- #29060: Meta-ticket: Add `Dockerfile`s and CI scripts for integration testing of source and binary distributions and of downstream packages
- #27330: Meta-ticket: `spkg-configure`: Try to use as many system packages as possible


---

Comment by saraedum created at 2020-01-27 17:00:00

I am all for more CI, but would it not make more sense to add this to the existing [GitLab](GitLab) CI?


---

Comment by mkoeppe created at 2020-01-27 17:17:05

Last 10 new commits:


---

Comment by mkoeppe created at 2020-01-27 17:17:05

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-27 17:19:39

Replying to [comment:2 saraedum]:
> I am all for more CI, but would it not make more sense to add this to the existing [GitLab](GitLab) CI?

Fine with me too. I have built this on top of tox and docker. It can also run locally. The GitHub-specific part is really minimal - https://git.sagemath.org/sage.git/commit/?h=6a2bf3d2140e2d625d4ca96a40485b74fa582e7a


---

Comment by mkoeppe created at 2020-01-27 17:27:42

Changing keywords from "" to "docker, ContinuousIntegration".


---

Comment by saraedum created at 2020-01-27 17:40:24

Personally, I like [GitHub](GitHub). I like [GitLab](GitLab) a bit better because it is very easy to provision our own runners (e.g., for obscure platforms.) The problem with [GitHub](GitHub) is that some people have quite a few reservations about it (lock-in, Microsoft, …) so I think [GitLab](GitLab) is the better choice for such an extensive community.

In any case, glad to see these things happen. Feel free to ping/bug me explicitly if you need reviews on anything docker/CI.


---

Comment by git created at 2020-01-27 19:37:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-28 00:47:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-28 23:11:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-30 04:44:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-30 16:40:44

Replying to [comment:7 saraedum]:
> Personally, I like [GitHub](GitHub). I like [GitLab](GitLab) a bit better because it is very easy to provision our own runners (e.g., for obscure platforms.) The problem with [GitHub](GitHub) is that some people have quite a few reservations about it (lock-in, Microsoft, …) so I think [GitLab](GitLab) is the better choice for such an extensive community.

Yes, I understand these concerns. To avoid lock-in, in this ticket the definition of the tests (for linux) is driven by tox and docker, rather than relying on the specific environments provided by a CI vendor. Likewise for the homebrew tests for macOS on this ticket. 

I don't have the time to work on another CI platform but would certainly welcome it if other CI enthusiasts wanted to implement a solution on another platform in a follow-up ticket.

> Feel free to ping/bug me explicitly if you need reviews on anything docker/CI.

Thanks. This ticket would be ready for review.


---

Comment by git created at 2020-01-31 22:16:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-02 20:50:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-02 21:05:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-02-02 21:07:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-02-06 15:05:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-02-06 15:23:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-17 00:01:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-17 00:07:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-22 22:50:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-02 02:38:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-07 21:33:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-03-08 21:03:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-08 21:09:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-09 01:11:03

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-03-12 03:14:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-03-12 03:18:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-12 03:54:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-12 09:15:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-12 09:39:24

what's the story with AC_FC_FUNC?


---

Comment by mkoeppe created at 2020-03-12 09:41:18

See #29104 - your solution didn’t work


---

Comment by dimpase created at 2020-03-12 10:51:39

Oops, it seems there is no way to call `AC_FC_FUNC` conditionally, it is still called even if there is no Fortran detected.

Weird, I don't understand why this happens.


---

Comment by git created at 2020-03-12 16:11:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-12 16:48:12

I sent a message to autoconf bugs mailing list, asking whether inabiity to chain 
AC_FC_FREEFORM and AC_FC_FUNC is a bug.
----
New commits:


---

Comment by git created at 2020-03-12 21:46:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-12 21:46:37

New commits:


---

Comment by git created at 2020-03-12 22:37:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-13 01:01:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-13 17:52:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-13 23:21:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-14 21:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-17 21:57:54

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-03-18 03:31:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-18 18:38:43

Could you factor out into a separate ticket the fix for AC_FC_FREEFORM and AC_FC_FUNC thing? Cause it's really a bug fix.


---

Comment by mkoeppe created at 2020-03-18 18:40:11

Will do.


---

Comment by mkoeppe created at 2020-03-18 18:53:46

This is now #29361


---

Comment by git created at 2020-03-19 01:11:54

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-03-19 21:16:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-03-20 19:35:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-20 20:23:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-21 07:34:22

So do I understand correctly that merging this into a branch and pushing to github (to a repo with enabled [GitHub](GitHub) actions) will trigger the testing. This is not so nice UI. Do I miss something here?

I guess it's just one file that needs to be changed, which one?

I'd prefer to have a command-line way (perhaps using some [GitHub](GitHub) tools) to trigger GH Actions on a given branch, say.


---

Comment by mkoeppe created at 2020-03-21 12:03:53

When this ticket is merged into Sage, it will suffice to just push to github.


---

Comment by mkoeppe created at 2020-03-21 20:48:54

Because the checks run for hours, it would probably be better to run the workflow only on pull requests, rather than on all pushes.

https://help.github.com/en/actions/reference/events-that-trigger-workflows#pull-request-event-pull_request


```
on:
  pull_request:
    types: [opened, synchronize]
```



---

Comment by mkoeppe created at 2020-03-21 20:52:07

Then `gh pr create -f -d` would be a command line interface to trigger the GH actions run. https://cli.github.com/manual/gh_pr_create


---

Comment by git created at 2020-03-21 22:37:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-21 23:19:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-22 10:14:46

how does one control the platforms the tests are run on? Often one needs to check on a couple of different OSs at most, and the current setup looks quite wasteful.


---

Comment by git created at 2020-03-22 14:50:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-22 15:18:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-22 21:31:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-23 01:29:18

Replying to [comment:70 dimpase]:
> how does one control the platforms the tests are run on? Often one needs to check on a couple of different OSs at most, and the current setup looks quite wasteful.

By editing the section called `matrix` in the file `.github/workflows/tox.yml`.


---

Comment by mkoeppe created at 2020-03-23 13:02:48

https://github.com/mkoeppe/sage/runs/526226655:

```
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3638.0 seconds
    cpu time: 5482.8 seconds
    cumulative wall time: 10347.2 seconds
Error processing tar file(exit status 1): write /sage/src/build/temp.linux-x86_64-3.7/build/cythonized/sage/rings/finite_rings/integer_mod.o: no space left on device
ERROR: InvocationError: '/usr/bin/docker build . -f /home/runner/work/sage/sage/.tox/docker-ubuntu-trusty-minimal/Dockerfile --build-arg EXTRA_CONFIGURE_ARGS=   --build-arg BASE_IMAGE=ubuntu:trusty --build-arg USE_MAKEFLAGS=-k V=0 SAGE_NUM_THREADS=3 --build-arg TARGETS=build ptest'
```


docker build ends with "no space left on device" · Issue #18144 · moby/moby
https://github.com/moby/moby/issues/18144

Error pulling image (...) no space left on device · Issue #10613 · moby/moby
https://github.com/moby/moby/issues/10613

dockerd | Docker Documentation
https://docs.docker.com/engine/reference/commandline/dockerd/#storage-driver-options

Configure and troubleshoot the Docker daemon | Docker Documentation
https://docs.docker.com/config/daemon/


---

Comment by mkoeppe created at 2020-03-23 16:58:39

sysinfo at https://github.com/mkoeppe/sage/runs/526929826


---

Comment by dimpase created at 2020-03-24 17:40:57

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-24 17:40:57

this needs more documentation, I gather - on a followup ticket, something to be mentioned in README.md too. But this is good to go, I think.


---

Comment by mkoeppe created at 2020-03-24 21:52:24

Thanks! I've created #29401 - Add documentation


---

Comment by dimpase created at 2020-03-29 03:02:34

this needs a rebase.


---

Comment by git created at 2020-03-29 04:16:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-03-29 04:16:50

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-03-29 04:17:24

Merged 9.1.beta9


---

Comment by mkoeppe created at 2020-03-30 01:21:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-09 22:44:56

Resolution: fixed
