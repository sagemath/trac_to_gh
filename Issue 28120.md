# Issue 28120: Segmentation fault in pynac when getting real/imag_part of a complex expression

archive/issues_028120.json:
```json
{
    "body": "CC:  @rwst\n\nKeywords: pynac assume\n\nFrom this [ask question](https://ask.sagemath.org/question/47488/asking-real-part-of-a-function-crash-the-kernel) the following crashes pynac with a stack overflow:\n\n\n```\nsage: n=var('n')\nsage: assume(n, 'integer')\nsage: (I^n).real_part()\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x80b5)[0x7f5b6da330b5]\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8158)[0x7f5b6da33158]\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x96ad)[0x7f5b6da346ad]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x10330)[0x7f5b7cf14330]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC7numeric3gcdERKS0_+0x1d)[0x7f594bfdcd7d]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC3gcdERKNS_7numericES2_+0x9)[0x7f594bfe0e29]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add15integer_contentEv+0xcc)[0x7f594bfcc80c]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add5powerERKNS_7numericE+0x37)[0x7f594bf09d97]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x1933)[0x7f594bff6cf3]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3mul29combine_ex_with_coeff_to_pairERKNS_2exERKNS_7numericE+0xb8)[0x7f594bfbcfb8]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC9expairseq12evalchildrenEi+0xa7)[0x7f594bf31df7]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3mul4evalEi+0x36)[0x7f594bfc2d16]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add20recombine_pair_to_exERKNS_6expairE+0x5d)[0x7f594bf050bd]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add4infoEj+0x196)[0x7f594bf05ae6]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x460)[0x7f594bff5820]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x12e5)[0x7f594bff66a5]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power9real_partEv+0x50f)[0x7f594bfef0af]\n/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power9real_partEv+0x51)[0x7f594bfeebf1]\n...\n```\n\n\nfollowed by an infinite recursion in `GiNaC::power::real_part()`.  It doesn't crash without `assume(n, 'integer')`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28357\n\n",
    "created_at": "2019-08-15T13:34:07Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Segmentation fault in pynac when getting real/imag_part of a complex expression",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28120",
    "user": "https://github.com/embray"
}
```
CC:  @rwst

Keywords: pynac assume

From this [ask question](https://ask.sagemath.org/question/47488/asking-real-part-of-a-function-crash-the-kernel) the following crashes pynac with a stack overflow:


```
sage: n=var('n')
sage: assume(n, 'integer')
sage: (I^n).real_part()
/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x80b5)[0x7f5b6da330b5]
/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8158)[0x7f5b6da33158]
/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x96ad)[0x7f5b6da346ad]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x10330)[0x7f5b7cf14330]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC7numeric3gcdERKS0_+0x1d)[0x7f594bfdcd7d]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC3gcdERKNS_7numericES2_+0x9)[0x7f594bfe0e29]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add15integer_contentEv+0xcc)[0x7f594bfcc80c]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add5powerERKNS_7numericE+0x37)[0x7f594bf09d97]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x1933)[0x7f594bff6cf3]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3mul29combine_ex_with_coeff_to_pairERKNS_2exERKNS_7numericE+0xb8)[0x7f594bfbcfb8]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC9expairseq12evalchildrenEi+0xa7)[0x7f594bf31df7]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3mul4evalEi+0x36)[0x7f594bfc2d16]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add20recombine_pair_to_exERKNS_6expairE+0x5d)[0x7f594bf050bd]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC3add4infoEj+0x196)[0x7f594bf05ae6]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x460)[0x7f594bff5820]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power4evalEi+0x12e5)[0x7f594bff66a5]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x76)[0x7f594bf283a6]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power9real_partEv+0x50f)[0x7f594bfef0af]
/home/embray/src/sagemath/sage/local/lib/libpynac.so.18(_ZNK5GiNaC5power9real_partEv+0x51)[0x7f594bfeebf1]
...
```


followed by an infinite recursion in `GiNaC::power::real_part()`.  It doesn't crash without `assume(n, 'integer')`.

Issue created by migration from https://trac.sagemath.org/ticket/28357





---

archive/issue_comments_396834.json:
```json
{
    "body": "**Diagnosis:** Pynac's `power::real_part` method erroneously assumes that if `n` is a positive integer, then `((a + b*I)^n).expand()` will multiply the factors to write the expression as a sum of monomials. But this is not true when `n` is symbolic, rather than being equal to a specific integer. Instead, the expression `(a + b*I)^n` is returned with no change, which leads to an infinite loop. \n\nThis pynac patch should fix the bug (for `real_part` and `imag_part`). \n----\nNew commits:",
    "created_at": "2021-06-18T02:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396834",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Diagnosis:** Pynac's `power::real_part` method erroneously assumes that if `n` is a positive integer, then `((a + b*I)^n).expand()` will multiply the factors to write the expression as a sum of monomials. But this is not true when `n` is symbolic, rather than being equal to a specific integer. Instead, the expression `(a + b*I)^n` is returned with no change, which leads to an infinite loop. 

This pynac patch should fix the bug (for `real_part` and `imag_part`). 
----
New commits:



---

archive/issue_comments_396835.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-18T02:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396835",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396836.json:
```json
{
    "body": "Merge conflict.",
    "created_at": "2021-06-20T23:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396836",
    "user": "https://github.com/tscrim"
}
```

Merge conflict.



---

archive/issue_comments_396837.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-20T23:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396837",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_396838.json:
```json
{
    "body": "Rebased on 9.4b3\n----\nNew commits:",
    "created_at": "2021-07-02T01:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396838",
    "user": "https://github.com/DaveWitteMorris"
}
```

Rebased on 9.4b3
----
New commits:



---

archive/issue_comments_396839.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-02T01:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396839",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_396840.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-02T02:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396840",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396841.json:
```json
{
    "body": "LGTM.\n\nPlease also make a PR upstream: https://github.com/pynac/pynac.",
    "created_at": "2021-07-02T02:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396841",
    "user": "https://github.com/tscrim"
}
```

LGTM.

Please also make a PR upstream: https://github.com/pynac/pynac.



---

archive/issue_comments_396842.json:
```json
{
    "body": "Thanks! This is now [pynac PR 380](https://github.com/pynac/pynac/pull/380).",
    "created_at": "2021-07-02T03:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396842",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks! This is now [pynac PR 380](https://github.com/pynac/pynac/pull/380).



---

archive/issue_comments_396843.json:
```json
{
    "body": "\n```\n    STDOUT: CONFLICT (content): Merge conflict in build/pkgs/pynac/package-version.txt\n```\n",
    "created_at": "2021-07-06T21:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396843",
    "user": "https://github.com/vbraun"
}
```


```
    STDOUT: CONFLICT (content): Merge conflict in build/pkgs/pynac/package-version.txt
```




---

archive/issue_comments_396844.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-07-06T21:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396844",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_396845.json:
```json
{
    "body": "Rebased on #31694.\n----\nNew commits:",
    "created_at": "2021-07-07T02:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396845",
    "user": "https://github.com/DaveWitteMorris"
}
```

Rebased on #31694.
----
New commits:



---

archive/issue_comments_396846.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-07-07T02:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396846",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_396847.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-18T22:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28120",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28120#issuecomment-396847",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
