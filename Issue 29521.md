# Issue 29521: Allow longer text in Three.js viewer

archive/issues_029521.json:
```json
{
    "body": "CC:  paulmasson\n\nKeywords: threejs text length clipping\n\nThere's currently a limit to the length of text that can be displayed in the Three.js viewer before the text starts getting clipped at either end.\n\nI've updated threejs_template.html so that the dimensions of the underlying texture are set based on the fontsize and length of the text instead of being hard-coded to 128x32 pixels.\n\nI made sure to keep the pixel scaling intact and to continue using powers of two for the dimensions to prevent the text from becoming blurry. I also tried to keep the resulting size of the text onscreen the same before and after the change with some scale factors.\n\nTested on Ubuntu 18.04 using a standard display as well as on Windows 10 using a high-DPI display.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29758\n\n",
    "created_at": "2020-05-29T18:03:45Z",
    "labels": [
        "graphics",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Allow longer text in Three.js viewer",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29521",
    "user": "@jcamp0x2a"
}
```
CC:  paulmasson

Keywords: threejs text length clipping

There's currently a limit to the length of text that can be displayed in the Three.js viewer before the text starts getting clipped at either end.

I've updated threejs_template.html so that the dimensions of the underlying texture are set based on the fontsize and length of the text instead of being hard-coded to 128x32 pixels.

I made sure to keep the pixel scaling intact and to continue using powers of two for the dimensions to prevent the text from becoming blurry. I also tried to keep the resulting size of the text onscreen the same before and after the change with some scale factors.

Tested on Ubuntu 18.04 using a standard display as well as on Windows 10 using a high-DPI display.

Issue created by migration from https://trac.sagemath.org/ticket/29758





---

archive/issue_comments_419122.json:
```json
{
    "body": "Attachment [clipped.html](tarball://root/attachments/some-uuid/ticket29758/clipped.html) by @jcamp0x2a created at 2020-05-29 18:04:12",
    "created_at": "2020-05-29T18:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419122",
    "user": "@jcamp0x2a"
}
```

Attachment [clipped.html](tarball://root/attachments/some-uuid/ticket29758/clipped.html) by @jcamp0x2a created at 2020-05-29 18:04:12



---

archive/issue_comments_419123.json:
```json
{
    "body": "Attachment [unclipped.html](tarball://root/attachments/some-uuid/ticket29758/unclipped.html) by @jcamp0x2a created at 2020-05-29 18:04:21",
    "created_at": "2020-05-29T18:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419123",
    "user": "@jcamp0x2a"
}
```

Attachment [unclipped.html](tarball://root/attachments/some-uuid/ticket29758/unclipped.html) by @jcamp0x2a created at 2020-05-29 18:04:21



---

archive/issue_comments_419124.json:
```json
{
    "body": "An example that would result in clipping before:\n\n```\np1 = text3d(\"Hello world, how are you doing today?\", (10, 20, 30))\np2 = text3d(\"Just fine! Thanks for asking!\", (-30, -20, -10))\nshow(p1 + p2, projection='perspective')\n```\n",
    "created_at": "2020-05-29T18:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419124",
    "user": "@jcamp0x2a"
}
```

An example that would result in clipping before:

```
p1 = text3d("Hello world, how are you doing today?", (10, 20, 30))
p2 = text3d("Just fine! Thanks for asking!", (-30, -20, -10))
show(p1 + p2, projection='perspective')
```




---

archive/issue_comments_419125.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-29T18:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419125",
    "user": "@jcamp0x2a"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_419126.json:
```json
{
    "body": "Apologies Paul, I neglected to CC you on this when creating the ticket.",
    "created_at": "2020-06-08T23:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419126",
    "user": "@jcamp0x2a"
}
```

Apologies Paul, I neglected to CC you on this when creating the ticket.



---

archive/issue_comments_419127.json:
```json
{
    "body": "This is a good feature to add! Since you're touching the rescaling, this is also a good time to remove it. Recent versions of Three.js have a `sizeAttenuation` that can be set to `false` on `SpriteMaterial` to prevent scaling with distance. I had planned to activate that feature at some point and this is a good ticket for it. The vector `scratch` is only there for scaling so you can remove it as well.",
    "created_at": "2020-06-08T23:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419127",
    "user": "paulmasson"
}
```

This is a good feature to add! Since you're touching the rescaling, this is also a good time to remove it. Recent versions of Three.js have a `sizeAttenuation` that can be set to `false` on `SpriteMaterial` to prevent scaling with distance. I had planned to activate that feature at some point and this is a good ticket for it. The vector `scratch` is only there for scaling so you can remove it as well.



---

archive/issue_comments_419128.json:
```json
{
    "body": "You may also want to wait till the next beta to resolve the `MathUtils` issue.",
    "created_at": "2020-06-09T00:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419128",
    "user": "paulmasson"
}
```

You may also want to wait till the next beta to resolve the `MathUtils` issue.



---

archive/issue_comments_419129.json:
```json
{
    "body": "I'll look into `sizeAttenuation` so I can incorporate it into this branch once `MathUtils` is there. May help out a bit in performance for animation, too, since there's a lot more objects in the scene the rescaling is currently looping over.",
    "created_at": "2020-06-09T00:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419129",
    "user": "@jcamp0x2a"
}
```

I'll look into `sizeAttenuation` so I can incorporate it into this branch once `MathUtils` is there. May help out a bit in performance for animation, too, since there's a lot more objects in the scene the rescaling is currently looping over.



---

archive/issue_comments_419130.json:
```json
{
    "body": "When using `sizeAttenuation` the scale of the sprite needs to be decreased by something like a factor of 1/4. Need to look into the source code to figure out why...\n\nAlso since you have the proper equipment, please make sure #24601 doesn't resurface in the context of these changes. Thanks!",
    "created_at": "2020-06-09T01:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419130",
    "user": "paulmasson"
}
```

When using `sizeAttenuation` the scale of the sprite needs to be decreased by something like a factor of 1/4. Need to look into the source code to figure out why...

Also since you have the proper equipment, please make sure #24601 doesn't resurface in the context of these changes. Thanks!



---

archive/issue_comments_419131.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-07-08T16:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419131",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_419132.json:
```json
{
    "body": "I've updated the branch to work with the new version of Three.js (r117) as well as to use `sizeAttenuation=false` instead of resizing every frame. The scaling factors were also adjusted to keep the text size consistent before and after this change.",
    "created_at": "2020-07-08T17:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419132",
    "user": "@jcamp0x2a"
}
```

I've updated the branch to work with the new version of Three.js (r117) as well as to use `sizeAttenuation=false` instead of resizing every frame. The scaling factors were also adjusted to keep the text size consistent before and after this change.



---

archive/issue_comments_419133.json:
```json
{
    "body": "Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?",
    "created_at": "2020-07-12T00:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419133",
    "user": "paulmasson"
}
```

Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?



---

archive/issue_comments_419134.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-12T00:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419134",
    "user": "paulmasson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419135.json:
```json
{
    "body": "Replying to [comment:9 paulmasson]:\n> Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?\n\nThanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.",
    "created_at": "2020-07-12T05:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419135",
    "user": "@jcamp0x2a"
}
```

Replying to [comment:9 paulmasson]:
> Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?

Thanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.



---

archive/issue_comments_419136.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-15T22:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419136",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_419137.json:
```json
{
    "body": "Related frequent request: is there a hope (or a ticket) for LaTeX support in text3d?\n\n- [Ask Sage question 51073: 3D graphics, contour plot and labels](https://ask.sagemath.org/question/51073)\n\n- [Ask Sage question 46550: plot3d latex package on sagemath?](https://ask.sagemath.org/question/46550)\n\n- [Ask Sage question 26270: Labeling 3d plots](https://ask.sagemath.org/question/26270)",
    "created_at": "2020-07-26T01:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419137",
    "user": "slelievre"
}
```

Related frequent request: is there a hope (or a ticket) for LaTeX support in text3d?

- [Ask Sage question 51073: 3D graphics, contour plot and labels](https://ask.sagemath.org/question/51073)

- [Ask Sage question 46550: plot3d latex package on sagemath?](https://ask.sagemath.org/question/46550)

- [Ask Sage question 26270: Labeling 3d plots](https://ask.sagemath.org/question/26270)



---

archive/issue_comments_419138.json:
```json
{
    "body": "I'm not aware of an existing ticket, nor could I find one with a quick search, but this is something I've also been contemplating recently. \n\nThe MathJax library seems to be already included in Sage and the Jupyter notebook, so I don't think it would be much effort to get some LaTeX rendered *on the page*. The problem is getting it rendered *in the scene* so that it moves around / rotates / zooms with everything else in the scene.\n\nWe'd need an HTML canvas or a raster image that can be drawn on an HTML canvas in order to put the text in the scene, but with my current understanding of MathJax (admittedly little), it doesn't support either of those as output formats.\n\nIt *does* support SVG output, though, so perhaps we have a chance of then rendering that into a canvas using [an approach like this](https://stackoverflow.com/questions/5495952/draw-svg-on-html5-canvas-with-support-for-font-element). There's also the [html2canvas](https://github.com/niklasvh/html2canvas) library that might be able to go straight from the MathJax HTML output to canvas as mentioned in [this StackOverflow answer](https://stackoverflow.com/questions/20852529/rendering-mathjax-output-on-canvas/32528821#32528821).\n\nI'll do some more research into it and see if I can get a working example going.",
    "created_at": "2020-07-26T18:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419138",
    "user": "@jcamp0x2a"
}
```

I'm not aware of an existing ticket, nor could I find one with a quick search, but this is something I've also been contemplating recently. 

The MathJax library seems to be already included in Sage and the Jupyter notebook, so I don't think it would be much effort to get some LaTeX rendered *on the page*. The problem is getting it rendered *in the scene* so that it moves around / rotates / zooms with everything else in the scene.

We'd need an HTML canvas or a raster image that can be drawn on an HTML canvas in order to put the text in the scene, but with my current understanding of MathJax (admittedly little), it doesn't support either of those as output formats.

It *does* support SVG output, though, so perhaps we have a chance of then rendering that into a canvas using [an approach like this](https://stackoverflow.com/questions/5495952/draw-svg-on-html5-canvas-with-support-for-font-element). There's also the [html2canvas](https://github.com/niklasvh/html2canvas) library that might be able to go straight from the MathJax HTML output to canvas as mentioned in [this StackOverflow answer](https://stackoverflow.com/questions/20852529/rendering-mathjax-output-on-canvas/32528821#32528821).

I'll do some more research into it and see if I can get a working example going.



---

archive/issue_comments_419139.json:
```json
{
    "body": "Thanks! I opened #30226.",
    "created_at": "2020-07-26T19:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419139",
    "user": "slelievre"
}
```

Thanks! I opened #30226.



---

archive/issue_comments_419140.json:
```json
{
    "body": "Replying to [comment:11 gh-jcamp0x2a]:\n> Replying to [comment:9 paulmasson]:\n> > Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?\n> \n> Thanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.\n\nSorry for replying to an old ticket, but for completeness's sake: the `fontsize` parameter is being made use of as of #30614.",
    "created_at": "2020-09-19T19:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29521#issuecomment-419140",
    "user": "@jcamp0x2a"
}
```

Replying to [comment:11 gh-jcamp0x2a]:
> Replying to [comment:9 paulmasson]:
> > Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?
> 
> Thanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.

Sorry for replying to an old ticket, but for completeness's sake: the `fontsize` parameter is being made use of as of #30614.
