# Issue 29521: Allow longer text in Three.js viewer

Issue created by migration from https://trac.sagemath.org/ticket/29758

Original creator: @jcamp0x2a

Original creation time: 2020-05-29 18:03:45

CC:  paulmasson

Keywords: threejs text length clipping

There's currently a limit to the length of text that can be displayed in the Three.js viewer before the text starts getting clipped at either end.

I've updated threejs_template.html so that the dimensions of the underlying texture are set based on the fontsize and length of the text instead of being hard-coded to 128x32 pixels.

I made sure to keep the pixel scaling intact and to continue using powers of two for the dimensions to prevent the text from becoming blurry. I also tried to keep the resulting size of the text onscreen the same before and after the change with some scale factors.

Tested on Ubuntu 18.04 using a standard display as well as on Windows 10 using a high-DPI display.


---

Attachment


---

Attachment


---

Comment by @jcamp0x2a created at 2020-05-29 18:08:08

An example that would result in clipping before:

```
p1 = text3d("Hello world, how are you doing today?", (10, 20, 30))
p2 = text3d("Just fine! Thanks for asking!", (-30, -20, -10))
show(p1 + p2, projection='perspective')
```



---

Comment by @jcamp0x2a created at 2020-05-29 18:08:08

Changing status from new to needs_review.


---

Comment by @jcamp0x2a created at 2020-06-08 23:30:54

Apologies Paul, I neglected to CC you on this when creating the ticket.


---

Comment by paulmasson created at 2020-06-08 23:56:41

This is a good feature to add! Since you're touching the rescaling, this is also a good time to remove it. Recent versions of Three.js have a `sizeAttenuation` that can be set to `false` on `SpriteMaterial` to prevent scaling with distance. I had planned to activate that feature at some point and this is a good ticket for it. The vector `scratch` is only there for scaling so you can remove it as well.


---

Comment by paulmasson created at 2020-06-09 00:00:29

You may also want to wait till the next beta to resolve the `MathUtils` issue.


---

Comment by @jcamp0x2a created at 2020-06-09 00:18:09

I'll look into `sizeAttenuation` so I can incorporate it into this branch once `MathUtils` is there. May help out a bit in performance for animation, too, since there's a lot more objects in the scene the rescaling is currently looping over.


---

Comment by paulmasson created at 2020-06-09 01:26:50

When using `sizeAttenuation` the scale of the sprite needs to be decreased by something like a factor of 1/4. Need to look into the source code to figure out why...

Also since you have the proper equipment, please make sure #24601 doesn't resurface in the context of these changes. Thanks!


---

Comment by git created at 2020-07-08 16:59:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @jcamp0x2a created at 2020-07-08 17:04:57

I've updated the branch to work with the new version of Three.js (r117) as well as to use `sizeAttenuation=false` instead of resizing every frame. The scaling factors were also adjusted to keep the text size consistent before and after this change.


---

Comment by paulmasson created at 2020-07-12 00:23:09

Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?


---

Comment by paulmasson created at 2020-07-12 00:23:09

Changing status from needs_review to positive_review.


---

Comment by @jcamp0x2a created at 2020-07-12 05:23:40

Replying to [comment:9 paulmasson]:
> Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?

Thanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.


---

Comment by vbraun created at 2020-07-15 22:25:11

Resolution: fixed


---

Comment by slelievre created at 2020-07-26 01:01:53

Related frequent request: is there a hope (or a ticket) for LaTeX support in text3d?

- [Ask Sage question 51073: 3D graphics, contour plot and labels](https://ask.sagemath.org/question/51073)

- [Ask Sage question 46550: plot3d latex package on sagemath?](https://ask.sagemath.org/question/46550)

- [Ask Sage question 26270: Labeling 3d plots](https://ask.sagemath.org/question/26270)


---

Comment by @jcamp0x2a created at 2020-07-26 18:04:19

I'm not aware of an existing ticket, nor could I find one with a quick search, but this is something I've also been contemplating recently. 

The MathJax library seems to be already included in Sage and the Jupyter notebook, so I don't think it would be much effort to get some LaTeX rendered _on the page_. The problem is getting it rendered _in the scene_ so that it moves around / rotates / zooms with everything else in the scene.

We'd need an HTML canvas or a raster image that can be drawn on an HTML canvas in order to put the text in the scene, but with my current understanding of MathJax (admittedly little), it doesn't support either of those as output formats.

It _does_ support SVG output, though, so perhaps we have a chance of then rendering that into a canvas using [an approach like this](https://stackoverflow.com/questions/5495952/draw-svg-on-html5-canvas-with-support-for-font-element). There's also the [html2canvas](https://github.com/niklasvh/html2canvas) library that might be able to go straight from the MathJax HTML output to canvas as mentioned in [this StackOverflow answer](https://stackoverflow.com/questions/20852529/rendering-mathjax-output-on-canvas/32528821#32528821).

I'll do some more research into it and see if I can get a working example going.


---

Comment by slelievre created at 2020-07-26 19:28:28

Thanks! I opened #30226.


---

Comment by @jcamp0x2a created at 2020-09-19 19:19:46

Replying to [comment:11 gh-jcamp0x2a]:
> Replying to [comment:9 paulmasson]:
> > Works as described, so positive review. It did get me thinking as to how we could support multiline text since `fillText`won't do that directly. Would have to parse the string for line breaks and write on different parts of a taller canvas. Interested in adding that?
> 
> Thanks Paul. That seems like a good addition, and I'll look into doing so. I also want to be able to pass in the text size from the Python so we can make use of that `fontsize` parameter in `addLabel`.

Sorry for replying to an old ticket, but for completeness's sake: the `fontsize` parameter is being made use of as of #30614.
