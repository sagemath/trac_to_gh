# Issue 32890: Warning about missing sage-site when installing without `build` dir

Issue created by migration from https://trac.sagemath.org/ticket/33127

Original creator: tornaria

Original creation time: 2022-01-07 17:13:54

CC:  jhpalmieri

Making a package for void-linux the `build` directory is not really needed. However the main sage binary tries to run `$SAGE_ROOT/build/bin/sage-site`, causing a warning, in particular failing a few doctests in `src/sage/tests/cmdline.py`, for instance:

```
**********************************************************************
File "/usr/lib/sage-9.5.beta9/src/sage/tests/cmdline.py", line 170, in sage.tests.cmdline.test_executable
Failed example:
    err  
Expected:
    ''   
Got:
    '/usr/lib/sage-9.5.beta9/src/bin/sage: line 133: /usr/lib/sage-9.5.beta9/build/bin/sage-site: No such file or directory\n'
**********************************************************************
```

Proposed solution: test that `sage-site` exists and is executable before trying to exec it.


---

Comment by tornaria created at 2022-01-07 17:14:28

New commits:


---

Comment by tornaria created at 2022-01-07 17:14:28

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-01-07 18:45:51

I think you should just unset `SAGE_ROOT` in your distro build.


---

Comment by tornaria created at 2022-01-07 19:07:35

Replying to [comment:2 mkoeppe]:
> I think you should just unset `SAGE_ROOT` in your distro build.

I'm not setting `SAGE_ROOT`, this is set by the `sage` script itself (either the one at top-level directory, or the one in `src/bin/sage`).

I don't see an easy way to unset it.


---

Comment by mkoeppe created at 2022-01-07 19:11:00

In distribution packaging, the `SAGE_ROOT/sage` script should not be used.

The installed `src/bin/sage` script gets `SAGE_ROOT` from `sage-env-config`. This configuration file can be adjusted by your build scripts.


---

Comment by tornaria created at 2022-01-07 19:26:42

Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. How do I tell configure not to set `SAGE_ROOT`? Am I supposed to patch it myself when installing?

In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

I have the sagemath package for void linux working and I'm just trying to upstream what patches I have that seem upstreamable. At some point I'll probably move to install sage-as-library instead of sage-as-distribution (like in arch) but I'm just not ready yet (I'm missing ~30 packages).


---

Comment by mkoeppe created at 2022-01-07 19:28:14

Replying to [comment:5 tornaria]:
> Hmm... I do have `src/bin/sage-env-config` but it's setting `SAGE_ROOT`. [...] Am I supposed to patch it myself when installing?

Yes


---

Comment by mkoeppe created at 2022-01-07 19:28:50

Replying to [comment:5 tornaria]:
> In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?

Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.


---

Comment by tornaria created at 2022-01-07 19:52:19

Replying to [comment:7 mkoeppe]:
> Replying to [comment:5 tornaria]:
> > In any case, it seems to me this PR is at worst harmless, and at best it makes it so that `sage-site` is run iff `sage-site` exists and it's executable. Do you see any downside?
> 
> Yes, we cannot clutter code with ad-hoc workarounds. `SAGE_ROOT` by definition includes `build`.

My first try was using `--prefix` and installing only `SAGE_LOCAL`. However, binaries are not installed so now I install `SAGE_ROOT/local` and `SAGE_ROOT/src` which works ok. It may be better if there was an option to install the binaries into `SAGE_LOCAL/bin` with `SAGE_ROOT` unset.

OTOH, where would I place the src? Isn't it necessary for `??` to work?


---

Comment by mkoeppe created at 2022-01-07 19:53:38

Replying to [comment:8 tornaria]:
> My first try was using `--prefix` and installing only `SAGE_LOCAL`.

Yes, that's how it's done.

> However, binaries are not installed 

??


---

Comment by mkoeppe created at 2022-01-07 19:55:09

You don't need to install `src`.


---

Comment by tornaria created at 2022-01-07 19:55:48

One more question: is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Regarding binaries: I see they are installed in `.../venv.../bin` but not in `SAGE_LOCAL/bin`. I only have

```
$ ls -l /usr/lib/sage-9.5.beta9/local/bin/
total 2224
-rwxr-xr-x 1 root root   12559 Dec 31 13:58 gac
-rwxr-xr-x 1 root root     256 Dec 31 13:58 gap
-rwxr-xr-x 1 root root 2248752 Dec 31 13:58 gap-bin
-rwxr-xr-x 1 root root     453 Dec 31 13:58 jmol
```



---

Comment by mkoeppe created at 2022-01-07 19:57:41

Replying to [comment:11 tornaria]:
> is there a way to configure the path for the `venv`? In particular, can I have the `venv` directory to be the same as `SAGE_LOCAL`?

Yes, `--without-sage-venv` makes SAGE_VENV equal to SAGE_LOCAL.

This is implied by using `--prefix`.

(See https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages)


---

Comment by mkoeppe created at 2022-01-07 20:27:41

Replying to [comment:8 tornaria]:
> Isn't it necessary for `??` to work?

`SAGE_SRC` uses the installed Python package directory when `SAGE_ROOT` is unset.
https://github.com/sagemath/sage/blob/develop/src/sage/env.py#L182

This makes `??` work for `.py` files (but not `.pyx` files)


---

Comment by mkoeppe created at 2022-01-07 22:59:52

Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 

(as found by `git grep '[[].*SAGE_ROOT'`)

This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.


---

Comment by tornaria created at 2022-01-08 00:02:14

Replying to [comment:14 mkoeppe]:
> Instead of the change on the current branch, it may make sense to change tests of the form `[ -n "$SAGE_ROOT" ]` to `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> 
> (as found by `git grep '[[].*SAGE_ROOT'`)
> 
> This would then cleanly support the use case of building Sage from `SAGE_ROOT` with `--prefix` and then deleting the source tree `SAGE_ROOT`.
> 

That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?


OTOH, for a distro package I rather have `SAGE_ROOT` unset so it might be nice to have a configure option for that rather than patching.

So far I know two places where I have to patch:
 - `SAGE_LOCAL/bin/sage-env-config`
 - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.


---

Comment by mkoeppe created at 2022-01-08 00:04:21

Replying to [comment:15 tornaria]:
> There's also `src/bin/sage-src-env-config` but that doesn't seem to be installed into `SAGE_LOCAL/bin`.

That's right, it isn't.


---

Comment by mkoeppe created at 2022-01-08 00:05:13

Replying to [comment:15 tornaria]:
> So far I know two places where I have to patch:
>  - `SAGE_LOCAL/bin/sage-env-config`
>  - `SAGE_LOCAL/lib/python*/site-packages/sage-conf.py`

Yes, these are the only 2 installed configuration files.


---

Comment by mkoeppe created at 2022-01-08 00:06:56

Replying to [comment:15 tornaria]:
> Replying to [comment:14 mkoeppe]:
> > `[ -n "$SAGE_ROOT" -a -d "$SAGE_ROOT" ]`. 
> > 
> That could work... isn't `[ -d "$SAGE_ROOT" ]` equivalent?

Right, that's shorter


---

Comment by fbissey created at 2022-01-08 20:13:27

Hi there,

I can explain to you how sage-on-gentoo is packaged if you need pointers. I do remove a number of things that are not needed for distros, or that would break. Right now sage is in a transition and is splitting in a number of new packages that make things a bit awkward if you are just starting.


---

Comment by schilly created at 2022-02-09 12:47:12

I just found this ticket, I think it's related to a problem I see as well.
I'm building Sage 9.5 from source, also using `--prefix ...`.
It works fine, so, OK. But, each time it starts up:


```
/opt/sage/bin/sage-env: line 122: cd: /home/sage/sage: No such file or directory
Warning: overwriting SAGE_ROOT environment variable:
Old SAGE_ROOT=/home/sage/sage
New SAGE_ROOT=
```


In particular, there are no sources in `/home/sage/sage` any more. I think the content of `./bin/sage-env` needs to be different under these configuration settings, it shouldn't set `SAGE_ROOT`.


---

Comment by mkoeppe created at 2022-02-09 18:08:56

I think we can reuse this ticket to do what is discussed in comment:18


---

Comment by mkoeppe created at 2022-02-10 02:02:24

New commits:


---

Comment by git created at 2022-02-10 02:07:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-10 02:07:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-02-13 17:43:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-02-14 06:37:06

In the line 

```
if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
```

should at least the last `-n` be changed to `-d`? And/or later in

```
if [ -n "$NEW_SAGE_ROOT" ]; then
    export SAGE_ROOT="$NEW_SAGE_ROOT"
fi
```

I guess `NEW_SAGE_ROOT` should be a directory because of how it's defined, but why not check again?

I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).


---

Comment by mkoeppe created at 2022-02-16 19:27:43

Replying to [comment:29 jhpalmieri]:
> In the line 
> {{{
> if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
> }}}
> should at least the last `-n` be changed to `-d`? 

No, I prefer it as is - `NEW_SAGE_ROOT` is either empty or an absolute directory


---

Comment by mkoeppe created at 2022-02-16 19:29:52

Replying to [comment:29 jhpalmieri]:
> I'm not quite sure why the last `if` block that I quoted isn't nested within the earlier one (the one checking whether `"$SAGE_ROOT" != "$NEW_SAGE_ROOT"`, etc.).

Good point, I'll change this. Also some of the comments in between are outdated


---

Comment by git created at 2022-02-16 19:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-02-16 23:00:16

I built Sage with `./configure --prefix=DIR`. Then I did `cd DIR` and ran `./bin/sage -t (old_sage_root)/src/sage/tests/cmdline.py` and tests passed. Not a surprise, I think. Then I moved `(old_sage_root)` to `(new_location)` and ran `./bin/sage -t (new_location)/src/sage/tests/cmdline.py` and it failed:

```
././bin/sage-env: line 122: cd: (old_sage_root): No such file or directory
```

In fact I get the same error just running `./bin/sage`.

Line 122 is

```
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`
```

In the test a few lines earlier

```
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
```

should this be `-d`?


---

Comment by jhpalmieri created at 2022-02-16 23:04:14

I'm confused about the whole situation. The entire block

```
# New value for SAGE_ROOT: either SAGE_ROOT (if given)
# or a guessed value based on pwd.
if [ -n "$SAGE_ROOT" ]; then
    NEW_SAGE_ROOT="$SAGE_ROOT"
elif [ -f sage -a -d build ]; then
    NEW_SAGE_ROOT="."
elif [ -f ../../sage -a -d ../../build ]; then
    NEW_SAGE_ROOT="../.."
fi

if [ -n "$NEW_SAGE_ROOT" ]; then
    # Make NEW_SAGE_ROOT absolute; this will be empty if this directory does not exist.
    NEW_SAGE_ROOT=`cd "$NEW_SAGE_ROOT" && pwd -P`

    # Warn if NEW_SAGE_ROOT does not equal the old SAGE_ROOT
    if [ "$SAGE_ROOT" != "$NEW_SAGE_ROOT" -a -n "$SAGE_ROOT" -a -n "$NEW_SAGE_ROOT" ]; then
        echo >&2 "Warning: overwriting SAGE_ROOT environment variable:"
        echo >&2 "Old SAGE_ROOT=$SAGE_ROOT"
        echo >&2 "New SAGE_ROOT=$NEW_SAGE_ROOT"
        export SAGE_ROOT="$NEW_SAGE_ROOT"
    fi
fi
```

seems completely useless if `SAGE_ROOT` is no longer there.


---

Comment by jhpalmieri created at 2022-02-16 23:06:32

Toward the end, at least we want to do `export SAGE_ROOT="$NEW_SAGE_ROOT"` even if `SAGE_ROOT` is empty, don't we? I think that statement should be out of the inner-most if-block, not that this will help in the situation I'm asking about.


---

Comment by mkoeppe created at 2022-02-17 02:28:59

Yes, it's quite likely that this old code can be much simplified, I'll take a look


---

Comment by git created at 2022-02-17 06:21:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-17 06:28:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-17 06:47:20

The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. In all other situations, SAGE_ROOT is set already:

- in a configured source tree, `SAGE_ROOT` is provided to `src/bin/sage` by `src/bin/sage-src-env-config`
- in an installation tree, `SAGE_VENV/bin/sage` gets its `SAGE_ROOT` from `SAGE_VENV/bin/sage-env-config`
- when invoked from `SAGE_ROOT/sage`, that script sets `SAGE_ROOT` from $0


---

Comment by git created at 2022-02-17 06:52:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-17 06:54:15

Replying to [comment:39 mkoeppe]:
> The whole `NEW_SAGE_ROOT` code is only relevant when the script `src/bin/sage` is run directly from an unconfigured source tree. 

I don't think we need to support this, so I have removed this code.


---

Comment by jhpalmieri created at 2022-02-17 17:01:33

This doesn't work for me: if I run `./configure` with or without a prefix argument, then `make` fails immediately with

```
[ecm-7.0.4.p2] cat: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1/build/make/build/pkgs/ecm/type: No such file or directory
```

Note `build/make/build/pkgs`.


---

Comment by mkoeppe created at 2022-02-17 17:06:02

Thanks for testing!


---

Comment by git created at 2022-02-17 17:07:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-17 17:09:57

Now it might actually work


---

Comment by jhpalmieri created at 2022-02-17 19:18:17

Sage builds now, but I am still struggling with other aspects.

- `./configure --prefix=PREFIX`
- `make build`
- `cd ..; mkdir TEMP; mv SAGE_ROOT TEMP`
- `cd PREFIX`
- Then `./bin/sage` worked!
- But right after that, `./bin/sage -testall` failed, and then further attempts at `./bin/sage` failed, all with complaints from `sage-location`:

```
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X/bin/sage-location", line 102, in <module>
    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
  File "/usr/local/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/genericpath.py", line 101, in samefile
    s2 = os.stat(f2)
FileNotFoundError: [Errno 2] No such file or directory: ''
```

(The path for `sage-location` is `PREFIX/bin/sage-location`.)


---

Comment by jhpalmieri created at 2022-02-17 19:19:31

If I move `SAGE_ROOT` back to its original location and run `./bin/sage` from `PREFIX`, then I get

```
ERROR:  The Sage installation tree has moved

from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/X
  to /Users/palmieri/Desktop/Sage/sage_builds/TESTING/NEW33127/sage-9.6.beta1

This is not supported, and Sage will not work...
```



---

Comment by mkoeppe created at 2022-02-17 19:27:52

OK, so this is a great opportunity to get rid of `sage-location` altogether


---

Comment by mkoeppe created at 2022-02-17 19:40:14

... but this will best be done on top of #30649, which touches some of the `sage-location`-using code


---

Comment by jhpalmieri created at 2022-02-17 19:46:16

Well, #30649 has this as a dependency, so what order do we want to make these changes?


---

Comment by mkoeppe created at 2022-02-17 19:52:16

I've opened #33371 for it, so I'll reset the branch here to an earlier, less ambitious version


---

Comment by git created at 2022-02-17 19:53:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-02-17 20:06:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-17 20:06:40

This version may be worth testing


---

Comment by jhpalmieri created at 2022-02-17 22:52:01

Same symptom: if I move SAGE_ROOT, then I can run `PREFIX/bin/sage` once successfully, but the second time I get an error from `sage-location`. This time the error is different:

```
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/33127/sage-9.6.beta1'
```

(That is, `FileNotFoundError: ... old SAGE_ROOT`.)


---

Comment by mkoeppe created at 2022-02-17 23:11:32

Does this work without this ticket?


---

Comment by jhpalmieri created at 2022-02-17 23:20:10

Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?


---

Comment by jhpalmieri created at 2022-02-18 00:12:21

Replying to [comment:57 jhpalmieri]:
> Don't know, but how can I test the issue mentioned in the ticket description if I can't run any doctests? In general, what should I be doing to test this?

I can confirm essentially the same problem without this ticket.


---

Comment by mkoeppe created at 2022-02-18 00:14:31

Thanks for testing! Then I would suggest that we defer dealing with `sage-location` to #33371


---

Comment by mkoeppe created at 2022-02-18 00:15:20

I agree that it's not clear what exactly to test here


---

Comment by jhpalmieri created at 2022-02-19 04:08:31

The changes look fine and Sage builds and passes tests with it. Beyond that, I don't know what to test.


---

Comment by jhpalmieri created at 2022-02-19 04:08:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-02-19 05:46:38

Thank you!


---

Comment by vbraun created at 2022-02-21 21:56:23

Resolution: fixed
