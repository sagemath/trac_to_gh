# Issue 13139: alarm doesn't work with some elliptic curve functions

Issue created by migration from Trac.

Original creator: alexc

Original creation time: 2012-07-31 13:14:54

Assignee: cremona

CC:  pbruin

Keywords: alarm elliptic curve curves ellipticcurve

The following code does not work as intended (I imagine), i.e. it does not interrupt the computation after 3 seconds.


```python

#!/usr/bin/python -tt

from sage.all import *
import time

def main():
  alarm(3)
  try:
    EllipticCurve([123456, 789011]).rank()
    #time.sleep(5) #code works as intended if the above command is replaced with this
  except KeyboardInterrupt:
    print 'Took too long'

# This is the standard boilerplate that calls the main() function.
if __name__ == '__main__':
  main()
```



---

Comment by cremona created at 2012-07-31 13:28:28

I don't know anything about alarm().  In this case mwrank is being used to compute the rank and it takes more then 3s.


---

Comment by alexc created at 2012-07-31 13:34:20

Replying to [comment:1 cremona]:
> I don't know anything about alarm().  In this case mwrank is being used to compute the rank and it takes more then 3s.
alarm(timelimit) is supposed to raise a KeyboardInterrupt exception after timelimit seconds. For some reason, despite mwrank running for more than 3 seconds, the computation isn't interrupted. Documentation for alarm can be found here: http://www.sagemath.org/doc/reference/sage/misc/misc.html#sage.misc.misc.alarm


---

Comment by mderickx created at 2012-07-31 19:21:26

The following might help to locate the problem: http://www.sagemath.org/doc/developer/coding_in_cython.html#using-sig-on-and-sig-off


---

Comment by jdemeyer created at 2012-09-27 18:20:27

The problem is that the `SIGALRM` handling is completely independent of the usual signal handling, hence it doesn't work.  It simply raises a Python-level `KeyboardInterrupt`, but that's it.  It doesn't interact with any of the sophisticated `sig_on()`/`sig_off()` stuff.

As an ugly work-around, try using `signal_after_delay()` from `sage.tests.interrupt`, which generates an _actual_ interrupt.


---

Comment by jdemeyer created at 2013-03-15 22:27:16

Changing assignee from cremona to jdemeyer.


---

Comment by jdemeyer created at 2013-03-15 22:27:16

Changing keywords from "alarm elliptic curve curves ellipticcurve" to "alarm signal interrupt".


---

Comment by jdemeyer created at 2013-03-15 22:27:16

This has absolutely nothing to do with elliptic curves...


---

Comment by jdemeyer created at 2013-03-15 22:27:16

Changing component from elliptic curves to c_lib.


---

Comment by leif created at 2013-05-12 15:21:39

Replying to [comment:4 jdemeyer]:
> The problem is that the `SIGALRM` handling is completely independent of the usual signal handling, hence it doesn't work. [...]
> 
> As an ugly work-around, try using `signal_after_delay()` from `sage.tests.interrupt`, which generates an _actual_ interrupt.

A "cleaner" work-around is to use the ``@`fork` decorator, such that the computation (implemented in Cython or e.g. C/C++) runs in a subprocess, while `alarm()` is used in the main (Python) process; cf. [this solution on ask.sagemath](http://ask.sagemath.org/question/2567/kill-the-thread-in-a-long-computation).


---

Comment by jdemeyer created at 2013-05-13 07:07:58

Replying to [comment:6 leif]:
> A "cleaner" work-around is to use the ``@`fork` decorator, such that the computation (implemented in Cython or e.g. C/C++) runs in a subprocess, while `alarm()` is used in the main (Python) process; cf. [this solution on ask.sagemath](http://ask.sagemath.org/question/2567/kill-the-thread-in-a-long-computation).
I disagree with "cleaner" but that would work, yes.


---

Comment by jdemeyer created at 2013-05-13 12:29:59

Changing status from new to needs_review.


---

Comment by leif created at 2013-05-13 21:35:14

Minor things:

_"The latter signal also redirect stdin from /dev/null, to cause interactive sessions to exit *also*."_

-> _"The latter signal also redirect*s* stdin from /dev/null, to cause interactive sessions to exit."_

`s/`time out`/`time-out`/` (or timeout, which is also used later on) a couple of times, and in the doctest error message `s/`Time out`/`Timed out`/` (consistent with e.g. _Interrupt*ed*_).




In `sig_raise_exception()`, shouldn't the message in `raise SystemError("unknown signal")` contain the signal number?


---

Comment by leif created at 2013-05-15 13:46:22

Replying to [ticket:13311 jdemeyer]:
> Another cool new feature is that `alarm()` now works with a floating-point number of seconds.

Maybe on a real-time OS ... ;-)


---

Comment by leif created at 2013-05-15 13:51:34

P.S.:  Patch looks ok, but I haven't had the time to test this (and #14029) yet.


---

Comment by leif created at 2013-05-15 14:01:59

Replying to [comment:10 leif]:
> In `sig_raise_exception()`, shouldn't the message in `raise SystemError("unknown signal")` contain the signal number?

Ok, fixed now.  Or more nit-picking:

Maybe

```python
    raise SystemError("Received unknown signal number %s"%sig)
```

?


---

Comment by pbruin created at 2013-10-07 15:40:39

This doesn't apply anymore to 5.12.rc1 + #14029; the patch fails on `sage/ext/c_lib.pyx` and `sage/structure/parent.pyx`.


---

Comment by pbruin created at 2013-10-07 15:40:39

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2013-10-27 22:47:00

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2013-10-29 19:39:26

Generating a `SIGALRM` outside `sig_on()...sig_off()` calls `PyErr_SetInterrupt()`, which causes Python to raise a `KeyboardInterrupt`:

```
sage: alarm(1) 
sage: # wait 1 second
KeyboardInterrupt
```

The same thing already happens without this patch.  Wouldn't it make sense to also raise an `AlarmInterrupt` outside `sig_on()...sig_off()`, too?


---

Comment by jdemeyer created at 2013-10-29 21:48:38

Replying to [comment:19 pbruin]:
> Generating a `SIGALRM` outside `sig_on()...sig_off()` calls `PyErr_SetInterrupt()`, which causes Python to raise a `KeyboardInterrupt`
No, it doesn't. It causes IPython to print the string `"KeyboardInterrupt"`. See the difference with

```
sage: alarm(0.5); sleep(1)
---------------------------------------------------------------------------
AlarmInterrupt                            Traceback (most recent call last)
<ipython-input-3-854e6c430970> in <module>()
----> 1 alarm(RealNumber('0.5')); sleep(Integer(1))

/scratch/release/merger/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sage_python_check_interrupt (sage/ext/c_lib.c:1634)()

/scratch/release/merger/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:894)()

AlarmInterrupt: 
```



---

Comment by pbruin created at 2013-10-29 23:15:28

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 pbruin]:
> > Generating a `SIGALRM` outside `sig_on()...sig_off()` calls `PyErr_SetInterrupt()`, which causes Python to raise a `KeyboardInterrupt`
> No, it doesn't. It causes IPython to print the string `"KeyboardInterrupt"`.
I was mislead by the Python documentation, which says that `PyErr_SetInterrupt()` causes a `KeyboardInterrupt` to be raised the next time `PyErr_CheckSignals()` is called.  In fact this only describes what Python's default `SIGINT` handler does, which we don't use.

OK, so IPython prints the string `"KeyboardInterrupt"` in an `except KeyboardInterrupt` block when it is reading input.  Do I understand correctly that the `KeyboardInterrupt` is in this case actually an `AlarmInterrupt` and triggers this `except` block because it inherits from `KeyboardInterrupt`?


---

Comment by jdemeyer created at 2013-10-30 08:05:54

Replying to [comment:21 pbruin]:
> I was mislead by the Python documentation, which says that `PyErr_SetInterrupt()` causes a `KeyboardInterrupt` to be raised the next time `PyErr_CheckSignals()` is called.  In fact this only describes what Python's default `SIGINT` handler does, which we don't use.
Indeed. The Python `SIGINT` handler is changed in `_init_csage()` from `devel/sage/sage/ext/c_lib.pyx`.

> OK, so IPython prints the string `"KeyboardInterrupt"` in an `except KeyboardInterrupt` block when it is reading input.  Do I understand correctly that the `KeyboardInterrupt` is in this case actually an `AlarmInterrupt` and triggers this `except` block because it inherits from `KeyboardInterrupt`?
Exactly.


---

Comment by pbruin created at 2013-10-30 11:25:23

Replying to [comment:20 jdemeyer]:
> No, it doesn't. It causes IPython to print the string `"KeyboardInterrupt"`.
Given that an interrupt is not necessarily generated from the keyboard, it would be more logical from the user's perspective if IPython would print either (1) a generic message like `"Interrupt"`, (2) a different string for `KeyboardInterrupt` and `AlarmInterrupt`, or even (3) nothing (Bash just prints a newline when you press `^C` and nothing when you press `^\`.)

I would be in favour of (2); to implement this, IPython could print `E.__class__.__name__` inside `except KeyboardInterrupt as E` instead of the constant string `"KeyboardInterrupt"`.

In principle it would also make more sense if `KeyboardInterrupt` and `AlarmInterrupt` would derive from a common `Interrupt` exception, but this is impossible since `KeyboardInterrupt` is a built-in Python exception.


---

Comment by jdemeyer created at 2013-10-30 13:49:22

Perhaps, but I don't believe it's worth the trouble to patch IPython for this.


---

Comment by pbruin created at 2013-10-30 14:18:57

Replying to [comment:24 jdemeyer]:
> Perhaps, but I don't believe it's worth the trouble to patch IPython for this.
Maybe, maybe not; in any case we can always do it later.

That issue aside, the patch looks good, behaves as expected and passes doctests.


---

Comment by pbruin created at 2013-10-30 14:18:57

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-06 12:49:02

Resolution: fixed


---

Comment by jdemeyer created at 2014-12-01 08:16:54

I finally sent a patch to IPython about this: [https://github.com/ipython/ipython/pull/7069](https://github.com/ipython/ipython/pull/7069)
