# Issue 11509: Mac Binary distribution contains hardcoded absolute paths

Issue created by migration from https://trac.sagemath.org/ticket/11681

Original creator: AlexanderDreyer

Original creation time: 2011-08-12 09:29:03

Assignee: GeorgSWeber

Keywords: Mac build paths

At least the following image:
http://boxen.math.washington.edu/sage/osx/intel/sage-4.7-OSX-64bit-10.6-i386-Darwin.dmg
is defect. The build contains hardcode *absolute* paths the dynamic libs, e.g. something like `libpng12.dynlib` is looked up at `/Users/buildbot/build...`.

This makes it impossible to install spkgs which depend on libraries delivered by Sage. For instance, the spkg/patch from #11575 builds and installs, but is corrupted afterwards.


---

Comment by leif created at 2011-08-12 12:45:40

An ugly work-around is to create the original build directory (which ordinary users may not be able to), and make it a symbolic link to the new location (`$SAGE_ROOT`).

In principle all shared libraries should have relative `RUNPATH`s. AFAIK currently most just use the library name (i.e., no [absolute] path), but rely on `LD_LIBRARY_PATH` (`DYLD_LIBRARY_PATH` on Darwin) instead.

For ELF on UNIX / Linux etc., there is a tool `chrpath` (_change run path_) to (partially) fix such things in already built libraries and executables; I don't know if there's something similar available on Darwin.


---

Comment by GeorgSWeber created at 2011-08-13 14:51:41

The counterpart of "chrpath" on OS X is called "install_name_tool", FWIW.


---

Comment by leif created at 2011-08-13 16:55:50

Alexander, just curious:

How does your `$SAGE_ROOT/local/lib/pkgconfig/libpng12.pc` file look like (especially the first line)?


---

Comment by leif created at 2011-08-13 17:01:10

(*Any* definition of `SAGE_ROOT` in `local/lib/pkgconfig/*.pc` can and should be removed.)


---

Comment by leif created at 2011-08-14 02:45:08

Replying to [comment:4 leif]:
> (*Any* definition of `SAGE_ROOT` in `local/lib/pkgconfig/*.pc` can and should be removed.)

I'm meanwhile no longer sure about that, since (to me) it looks as if `pkg-config`'s behaviour has changed.

The following is definitely invalid and should be removed: 

(I've seen this as a result of a build from scratch; reinstalling e.g. `libpng12` cured this.)

```
SAGE_ROOT=${SAGE_ROOT}
```


The following are both ok (at least until the Sage installation moves, which `sage` will notice upon start-up, then correcting / updating the path in the `.pc` files):

```
prefix=/current/path/to/SAGE_ROOT/local
...
```


```
SAGE_ROOT=/current/path/to/SAGE_ROOT
prefix=${SAGE_ROOT}/local
...
```


----

Unfortunately, the correction of the paths in `.pc` files (as performed by `sage-location`) isn't fully reliable at the moment, as the first example above shows.

Furthermore, `sage-env` is broken in that it currently only *sets* (i.e., "overwrites") `PKG_CONFIG_PATH` to `$SAGE_ROOT/local/lib/pkgconfig/` _if it is empty_ / undefined, instead of also prepending Sage's `pkg-config` directory otherwise. 

This means that `PKG_CONFIG_PATH` should currently be unset (outside of the Sage environment) before installing or rebuilding any package.


---

Comment by kcrisman created at 2011-08-17 16:30:39

> Unfortunately, the correction of the paths in `.pc` files (as performed by `sage-location`) isn't fully reliable at the moment, as the first example above shows.

As you know, this causes problems elsewhere as well.  Is there a way to grep through this particular one and find all the places this is a problem?


---

Comment by kcrisman created at 2015-01-22 20:00:36

Is this still an issue?


---

Comment by jdemeyer created at 2016-04-11 10:03:28

Obsolete by the new binary packaging.


---

Comment by jdemeyer created at 2016-04-11 10:03:28

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-04-11 10:03:33

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2016-04-11 14:28:14

Really, are you sure there no "buildbot" or "buildslave" things?   I note that we still occasionally get such questions on ask.sagemath.


---

Comment by jdemeyer created at 2016-04-11 14:48:18

Replying to [comment:14 kcrisman]:
> I note that we still occasionally get such questions on ask.sagemath.

For recent versions of [SageMath](SageMath)?

If so, open a Trac ticket.


---

Comment by vbraun created at 2016-06-12 12:02:30

Resolution: fixed
