# Issue 10873: better numerical accuracy testing

archive/issues_010873.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  @jasongrout @kcrisman\n\nKeywords: sd32 noise noisy doctest failure error tolerance\n\nIf a line contains `tol` or `tolerance`, numerical results are only \nverified to the given tolerance. This may be prefixed by `abs[olute]` or `rel[ative]` to specify whether to measure absolute or relative error; defaults to relative error except when the expected value is exactly zero: \n\n```\n        sage: RDF(pi)                               # abs tol 1e-5 \n        3.14159 \n        sage: [10^n for n in [0.0 .. 4]]            # rel tol 2e-4 \n        [0.9999, 10.001, 100.01, 999.9, 10001] \n```\n\nThis can be useful when the exact output is subject to rounding error and/or processor floating point arithmetic variation. \n\n---\n\nRelated:\n* `.zero_at(epsilon)` methods, to fix noisy (and signed) zeroes; see for example #11848.\n\n---\n\nApply\n1. [attachment:10952-tol-bin.2.patch]\n2. [attachment:trac_10952-ref.patch]\nto the Sage **scripts repository**.\n\nApply\n1. [attachment:10952-tol-doc.2.patch]\n2. [attachment:trac_10952-reviewer-docs-v3.patch]\nto the Sage library repository.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10952\n\n",
    "closed_at": "2011-09-27T17:41:07Z",
    "created_at": "2011-03-17T08:10:07Z",
    "labels": [
        "component: doctest coverage",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "better numerical accuracy testing",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10873",
    "user": "https://github.com/robertwb"
}
```
Assignee: mvngu

CC:  @jasongrout @kcrisman

Keywords: sd32 noise noisy doctest failure error tolerance

If a line contains `tol` or `tolerance`, numerical results are only 
verified to the given tolerance. This may be prefixed by `abs[olute]` or `rel[ative]` to specify whether to measure absolute or relative error; defaults to relative error except when the expected value is exactly zero: 

```
        sage: RDF(pi)                               # abs tol 1e-5 
        3.14159 
        sage: [10^n for n in [0.0 .. 4]]            # rel tol 2e-4 
        [0.9999, 10.001, 100.01, 999.9, 10001] 
```

This can be useful when the exact output is subject to rounding error and/or processor floating point arithmetic variation. 

---

Related:
* `.zero_at(epsilon)` methods, to fix noisy (and signed) zeroes; see for example #11848.

---

Apply
1. [attachment:10952-tol-bin.2.patch]
2. [attachment:trac_10952-ref.patch]
to the Sage **scripts repository**.

Apply
1. [attachment:10952-tol-doc.2.patch]
2. [attachment:trac_10952-reviewer-docs-v3.patch]
to the Sage library repository.


Issue created by migration from https://trac.sagemath.org/ticket/10952





---

archive/issue_comments_115315.json:
```json
{
    "body": "Attachment [noise.patch](tarball://root/attachments/some-uuid/ticket10952/noise.patch) by @robertwb created at 2011-03-17 08:11:34",
    "created_at": "2011-03-17T08:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115315",
    "user": "https://github.com/robertwb"
}
```

Attachment [noise.patch](tarball://root/attachments/some-uuid/ticket10952/noise.patch) by @robertwb created at 2011-03-17 08:11:34



---

archive/issue_comments_115316.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-17T08:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115316",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_115317.json:
```json
{
    "body": "Amazing speed getting this up!  Shouldn't \"((?:abs(?:solute)?)\" be \"((?:abs(?:olute)?)\" ?",
    "created_at": "2011-03-17T13:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115317",
    "user": "https://github.com/jasongrout"
}
```

Amazing speed getting this up!  Shouldn't "((?:abs(?:solute)?)" be "((?:abs(?:olute)?)" ?



---

archive/issue_comments_115318.json:
```json
{
    "body": "Nitpicky: This comment is now incorrect:\n\n```\n# following three: used only for parsing only_optional; list of comments \n```\n\nAlso, something should be added to the docs about this new option.  Perhaps here: http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples",
    "created_at": "2011-03-17T13:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115318",
    "user": "https://github.com/jasongrout"
}
```

Nitpicky: This comment is now incorrect:

```
# following three: used only for parsing only_optional; list of comments 
```

Also, something should be added to the docs about this new option.  Perhaps here: http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples



---

archive/issue_comments_115319.json:
```json
{
    "body": "apply only this patch to the bin repo",
    "created_at": "2011-03-18T06:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115319",
    "user": "https://github.com/robertwb"
}
```

apply only this patch to the bin repo



---

archive/issue_comments_115320.json:
```json
{
    "body": "Attachment [10952-tol-bin.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-bin.patch) by @robertwb created at 2011-03-18 06:30:47",
    "created_at": "2011-03-18T06:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115320",
    "user": "https://github.com/robertwb"
}
```

Attachment [10952-tol-bin.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-bin.patch) by @robertwb created at 2011-03-18 06:30:47



---

archive/issue_comments_115321.json:
```json
{
    "body": "Attachment [10952-tol-doc.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-doc.patch) by @robertwb created at 2011-03-18 06:31:46\n\nThanks for the comments, new patches attached.",
    "created_at": "2011-03-18T06:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115321",
    "user": "https://github.com/robertwb"
}
```

Attachment [10952-tol-doc.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-doc.patch) by @robertwb created at 2011-03-18 06:31:46

Thanks for the comments, new patches attached.



---

archive/issue_comments_115322.json:
```json
{
    "body": "Would this works with test of that kind as well:\n\n```\nFile \"/usr/share/sage/devel/sage-main/sage/stats/hmm/chmm.pyx\", line 579:\n    sage: m.viterbi([-2,-1,.1,0.3])\nExpected:\n    ([1, 1, 1, 0], -9.5660236533785135)\nGot:\n    ([1, 1, 1, 0], -9.566023653378513)\n```\nor even\n\n```\nFile \"/usr/share/sage/devel/sage-main/sage/categories/examples/semigroups.py\", line 32:\n    sage: S.some_elements()\nExpected:\n    [3, 42, 'a', 3.3999999999999999, 'raton laveur']\nGot:\n    [3, 42, 'a', 3.4, 'raton laveur']\n```\n(test failures courtesy of my work on python-2.7)",
    "created_at": "2011-04-24T03:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115322",
    "user": "https://github.com/kiwifb"
}
```

Would this works with test of that kind as well:

```
File "/usr/share/sage/devel/sage-main/sage/stats/hmm/chmm.pyx", line 579:
    sage: m.viterbi([-2,-1,.1,0.3])
Expected:
    ([1, 1, 1, 0], -9.5660236533785135)
Got:
    ([1, 1, 1, 0], -9.566023653378513)
```
or even

```
File "/usr/share/sage/devel/sage-main/sage/categories/examples/semigroups.py", line 32:
    sage: S.some_elements()
Expected:
    [3, 42, 'a', 3.3999999999999999, 'raton laveur']
Got:
    [3, 42, 'a', 3.4, 'raton laveur']
```
(test failures courtesy of my work on python-2.7)



---

archive/issue_comments_115323.json:
```json
{
    "body": "Yes, it would (though you do have to explicitly annotate the test with a tolerance, and if Python 2.7 consistently gives, e.g., 3.4 then we should change the doctest rather than make it fuzzy.)",
    "created_at": "2011-04-24T04:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115323",
    "user": "https://github.com/robertwb"
}
```

Yes, it would (though you do have to explicitly annotate the test with a tolerance, and if Python 2.7 consistently gives, e.g., 3.4 then we should change the doctest rather than make it fuzzy.)



---

archive/issue_comments_115324.json:
```json
{
    "body": "In trying to review this ticket, I applied 10952-tol-bin.patch in the local/bin directory of a skynet/taurus (x86_64-Linux-nehalem) build of sage-4.7.rc2.  I next did 'sage -b'.  Yet I get\n\n```\nsage: print \"The answers are\", 1.5, 2, 1e-12 # tol 1e-3\nThe answers are 1.50000000000000 2 1.00000000000000e-12\n```\n\nAm I missing something?",
    "created_at": "2011-05-13T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115324",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

In trying to review this ticket, I applied 10952-tol-bin.patch in the local/bin directory of a skynet/taurus (x86_64-Linux-nehalem) build of sage-4.7.rc2.  I next did 'sage -b'.  Yet I get

```
sage: print "The answers are", 1.5, 2, 1e-12 # tol 1e-3
The answers are 1.50000000000000 2 1.00000000000000e-12
```

Am I missing something?



---

archive/issue_comments_115325.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-05-13T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115325",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_115326.json:
```json
{
    "body": "No, that is correct.\n\nThe example in the description is an example of something that would pass doctests (even though the true output doesn't match exactly, you're seeing what the actual output is).",
    "created_at": "2011-05-14T00:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115326",
    "user": "https://github.com/robertwb"
}
```

No, that is correct.

The example in the description is an example of something that would pass doctests (even though the true output doesn't match exactly, you're seeing what the actual output is).



---

archive/issue_comments_115327.json:
```json
{
    "body": "Another nitpicky: the doc patch misspells \"arithmetic\".  Definitely not big enough to stop a positive review, but also not big enough to be worth my effort in making a new patch right now.",
    "created_at": "2011-05-14T00:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115327",
    "user": "https://github.com/jasongrout"
}
```

Another nitpicky: the doc patch misspells "arithmetic".  Definitely not big enough to stop a positive review, but also not big enough to be worth my effort in making a new patch right now.



---

archive/issue_comments_115328.json:
```json
{
    "body": "Attachment [10952-tol-doc.2.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-doc.2.patch) by @robertwb created at 2011-05-14 00:36:56\n\nArgh. Fixed.",
    "created_at": "2011-05-14T00:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115328",
    "user": "https://github.com/robertwb"
}
```

Attachment [10952-tol-doc.2.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-doc.2.patch) by @robertwb created at 2011-05-14 00:36:56

Argh. Fixed.



---

archive/issue_comments_115329.json:
```json
{
    "body": "Thanks!  If we had a github pull system, or a system where I could edit the patch inline, I would have fixed it.",
    "created_at": "2011-05-14T00:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115329",
    "user": "https://github.com/jasongrout"
}
```

Thanks!  If we had a github pull system, or a system where I could edit the patch inline, I would have fixed it.



---

archive/issue_comments_115330.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-05-14T11:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115330",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_115331.json:
```json
{
    "body": "Replying to [comment:12 jason]:\n> Thanks!  If we had a github pull system, or a system where I could edit the patch inline, I would have fixed it.\n\nI have to admit that *would* be convenient.  But wouldn't that create a privileged class of commit people who don't need review?  At least that seems to be the model for the projects I'm familiar with.",
    "created_at": "2011-05-14T11:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115331",
    "user": "https://github.com/kcrisman"
}
```

Replying to [comment:12 jason]:
> Thanks!  If we had a github pull system, or a system where I could edit the patch inline, I would have fixed it.

I have to admit that *would* be convenient.  But wouldn't that create a privileged class of commit people who don't need review?  At least that seems to be the model for the projects I'm familiar with.



---

archive/issue_comments_115332.json:
```json
{
    "body": "That *person* would be the release manager.  He would be the only one able (or supposed to) merge into the master branch.\n\nOn the other hand, given our problems with finding release managers who could do the entire release process, maybe sharing the burden to commit patches to master wouldn't be a bad idea.",
    "created_at": "2011-05-14T15:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115332",
    "user": "https://github.com/jasongrout"
}
```

That *person* would be the release manager.  He would be the only one able (or supposed to) merge into the master branch.

On the other hand, given our problems with finding release managers who could do the entire release process, maybe sharing the burden to commit patches to master wouldn't be a bad idea.



---

archive/issue_comments_115333.json:
```json
{
    "body": "I applied 10952-tol-bin.patch in the local/bin directory of a skynet/taurus (x86_64-Linux-nehalem) build of sage-4.7.rc2. I next did 'sage -b'.  I then modified a doctest to include the lines in\nthe ticket description\n\n```\nsage: print \"The answers are\", 1.5, 2, 1e-12 # tol 1e-3\nThe answers are 1.499999 2.0001 0\n```\nI then did 'sage -b' again.  When I run the doctest, I get\n\n```\n% ./sage -t  -long -force_lib \"devel/sage/sage/symbolic/units.py\"\nsage -t -long -force_lib \"devel/sage/sage/symbolic/units.py\"\n**********************************************************************\nFile \"/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/devel/sage/sage/symbolic/units.py\", line 13:\n    sage: print \"The answers are\", 1.5, 2, 1e-12 # tol 1e-3\nException raised:\n    Traceback (most recent call last):\n      File \"/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[6]>\", line 1\n         res =  print \"The answers are\", RealNumber('1.5'), Integer(2), RealNumber('1e-12') # tol 1e-3###line 13:\n    sage: print \"The answers are\", 1.5, 2, 1e-12 # tol 1e-3\n                    ^\n     SyntaxError: invalid syntax\n**********************************************************************\n```\n\nNote that if I put the lines \n\n```\n    sage: RDF(pi)                               # abs tol 1e-5\n    3.14159\n```\nin the doctest, then the doctest passes.",
    "created_at": "2011-05-16T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115333",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

I applied 10952-tol-bin.patch in the local/bin directory of a skynet/taurus (x86_64-Linux-nehalem) build of sage-4.7.rc2. I next did 'sage -b'.  I then modified a doctest to include the lines in
the ticket description

```
sage: print "The answers are", 1.5, 2, 1e-12 # tol 1e-3
The answers are 1.499999 2.0001 0
```
I then did 'sage -b' again.  When I run the doctest, I get

```
% ./sage -t  -long -force_lib "devel/sage/sage/symbolic/units.py"
sage -t -long -force_lib "devel/sage/sage/symbolic/units.py"
**********************************************************************
File "/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/devel/sage/sage/symbolic/units.py", line 13:
    sage: print "The answers are", 1.5, 2, 1e-12 # tol 1e-3
Exception raised:
    Traceback (most recent call last):
      File "/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/mariah/sage/sage-4.7.rc2-x86_64-Linux-nehalem-fc-review-10952/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[6]>", line 1
         res =  print "The answers are", RealNumber('1.5'), Integer(2), RealNumber('1e-12') # tol 1e-3###line 13:
    sage: print "The answers are", 1.5, 2, 1e-12 # tol 1e-3
                    ^
     SyntaxError: invalid syntax
**********************************************************************
```

Note that if I put the lines 

```
    sage: RDF(pi)                               # abs tol 1e-5
    3.14159
```
in the doctest, then the doctest passes.



---

archive/issue_comments_115334.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-05-16T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115334",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_115335.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-05-16T19:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115335",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_115336.json:
```json
{
    "body": "True. It doesn't work with print (or other non-expression statements). I've created #11336 to generalize it. \n\nI think that this is still plenty useful even with that limitation, and don't know when I'll have more time to work on it--we could either get this in and start using it now or hold off until has time to write a more complete implementation at some later date (which I'd like to get to someday, but that someday list is long...)",
    "created_at": "2011-05-16T19:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115336",
    "user": "https://github.com/robertwb"
}
```

True. It doesn't work with print (or other non-expression statements). I've created #11336 to generalize it. 

I think that this is still plenty useful even with that limitation, and don't know when I'll have more time to work on it--we could either get this in and start using it now or hold off until has time to write a more complete implementation at some later date (which I'd like to get to someday, but that someday list is long...)



---

archive/issue_comments_115337.json:
```json
{
    "body": "Replying to [comment:16 robertwb]:\n> True. It doesn't work with print (or other non-expression statements). I've created #11336 to generalize it. \n> \n> I think that this is still plenty useful even with that limitation\n\n\nAgreed.  I am just doing my \"reviewer\" duty.\n\nPositive review.",
    "created_at": "2011-05-17T13:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115337",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Replying to [comment:16 robertwb]:
> True. It doesn't work with print (or other non-expression statements). I've created #11336 to generalize it. 
> 
> I think that this is still plenty useful even with that limitation


Agreed.  I am just doing my "reviewer" duty.

Positive review.



---

archive/issue_comments_115338.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-17T13:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115338",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_115339.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2011-05-17T15:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115339",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_115340.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2011-05-17T15:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115340",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_115341.json:
```json
{
    "body": "Which patches have to be applied?",
    "created_at": "2011-05-17T15:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115341",
    "user": "https://github.com/jdemeyer"
}
```

Which patches have to be applied?



---

archive/issue_events_028395.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-17T15:33:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10873#event-28395"
}
```



---

archive/issue_comments_115342.json:
```json
{
    "body": "I think the documentation should be expanded a bit to show less trivial examples, for example complex numbers or polynomials with non-exact coefficients.",
    "created_at": "2011-05-17T15:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115342",
    "user": "https://github.com/jdemeyer"
}
```

I think the documentation should be expanded a bit to show less trivial examples, for example complex numbers or polynomials with non-exact coefficients.



---

archive/issue_comments_115343.json:
```json
{
    "body": "Also matrices",
    "created_at": "2011-05-17T15:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115343",
    "user": "https://github.com/jdemeyer"
}
```

Also matrices



---

archive/issue_comments_115344.json:
```json
{
    "body": "Attachment [trac_10952-reviewer-docs.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs.patch) by @rbeezer created at 2011-08-22 06:24:44\n\nI have added an \"Apply\" list for this ticket.\n\nMy patch fixes one typo in the documentation (a missing ]).\n\nI have added some non-trivial tests.\n\nJeroen:\n\n1.  abs() for a matrix computes the determinant.  Not useful for testing.\n\n2.  Is there a class of polynomials with numerical coefficients?  Does it have abs() defined on it?\n\nI am working on this as a high-priority ticket for Bug Days 32.\n\nRob",
    "created_at": "2011-08-22T06:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115344",
    "user": "https://github.com/rbeezer"
}
```

Attachment [trac_10952-reviewer-docs.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs.patch) by @rbeezer created at 2011-08-22 06:24:44

I have added an "Apply" list for this ticket.

My patch fixes one typo in the documentation (a missing ]).

I have added some non-trivial tests.

Jeroen:

1.  abs() for a matrix computes the determinant.  Not useful for testing.

2.  Is there a class of polynomials with numerical coefficients?  Does it have abs() defined on it?

I am working on this as a high-priority ticket for Bug Days 32.

Rob



---

archive/issue_comments_115345.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-08-22T06:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115345",
    "user": "https://github.com/rbeezer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_115346.json:
```json
{
    "body": "This ticket is pretty amazing.\n\nRob, this doctest you added seems very wrong:\n\n```\n\n   A relative tolerance on a root of a polynomial.\n    \n   ::\n   \n       sage: p = (y - 10^16)*(y-10^(-13))*(y-2); p\n       y^3 + (-1e+16)*y^2 + (2e+16)*y - 2000.0\n       sage: p.roots()\n       sage: p.roots(multiplicities=False)[2]     # relative tol 1e-10\n       10^16\n```\n\nIn particular, \n\n* it seems that y isn't defined\n* the output of `p.roots()` is missing\n* I get an output of `1e16` instead of `10^16`.",
    "created_at": "2011-08-24T05:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115346",
    "user": "https://github.com/williamstein"
}
```

This ticket is pretty amazing.

Rob, this doctest you added seems very wrong:

```

   A relative tolerance on a root of a polynomial.
    
   ::
   
       sage: p = (y - 10^16)*(y-10^(-13))*(y-2); p
       y^3 + (-1e+16)*y^2 + (2e+16)*y - 2000.0
       sage: p.roots()
       sage: p.roots(multiplicities=False)[2]     # relative tol 1e-10
       10^16
```

In particular, 

* it seems that y isn't defined
* the output of `p.roots()` is missing
* I get an output of `1e16` instead of `10^16`.



---

archive/issue_comments_115347.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-24T05:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115347",
    "user": "https://github.com/rbeezer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_115348.json:
```json
{
    "body": "Replying to [comment:22 was]:\n> Rob, this doctest you added seems very wrong:\n\n\nYes, I think this was the patch missing a refresh.  I'll clean it in the AM.",
    "created_at": "2011-08-24T05:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115348",
    "user": "https://github.com/rbeezer"
}
```

Replying to [comment:22 was]:
> Rob, this doctest you added seems very wrong:


Yes, I think this was the patch missing a refresh.  I'll clean it in the AM.



---

archive/issue_comments_115349.json:
```json
{
    "body": "Attachment [trac_10952-reviewer-docs-v2.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs-v2.patch) by @rbeezer created at 2011-08-24 07:01:30",
    "created_at": "2011-08-24T07:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115349",
    "user": "https://github.com/rbeezer"
}
```

Attachment [trac_10952-reviewer-docs-v2.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs-v2.patch) by @rbeezer created at 2011-08-24 07:01:30



---

archive/issue_comments_115350.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-24T07:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115350",
    "user": "https://github.com/rbeezer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_115351.json:
```json
{
    "body": "Reviewer documentation v2 patch cleans up the mess.\n\nI used `10^16` intentionally.  The tolerance feature does *arithmetic* with the \noutput, so does not have to identically match as text.  Maybe that deserves a comment?\n\nRob",
    "created_at": "2011-08-24T07:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115351",
    "user": "https://github.com/rbeezer"
}
```

Reviewer documentation v2 patch cleans up the mess.

I used `10^16` intentionally.  The tolerance feature does *arithmetic* with the 
output, so does not have to identically match as text.  Maybe that deserves a comment?

Rob



---

archive/issue_comments_115352.json:
```json
{
    "body": "Attachment [trac_10952-reviewer-docs-v3.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs-v3.patch) by @rbeezer created at 2011-08-24 16:11:08",
    "created_at": "2011-08-24T16:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115352",
    "user": "https://github.com/rbeezer"
}
```

Attachment [trac_10952-reviewer-docs-v3.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-reviewer-docs-v3.patch) by @rbeezer created at 2011-08-24 16:11:08



---

archive/issue_comments_115353.json:
```json
{
    "body": "Reviewer documentation v3 patch adds a comment about intended output being of any form, fixes some missing quotes and expands a bit more on how this works.  Passes tests, so should be ready for review.",
    "created_at": "2011-08-24T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115353",
    "user": "https://github.com/rbeezer"
}
```

Reviewer documentation v3 patch adds a comment about intended output being of any form, fixes some missing quotes and expands a bit more on how this works.  Passes tests, so should be ready for review.



---

archive/issue_comments_115354.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-24T16:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115354",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_115355.json:
```json
{
    "body": "Nice.  Game changer!!!!   Sweet.  It's about time.  Great work!  W00t.  FTW.  Frickin' awesome.",
    "created_at": "2011-08-24T16:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115355",
    "user": "https://github.com/williamstein"
}
```

Nice.  Game changer!!!!   Sweet.  It's about time.  Great work!  W00t.  FTW.  Frickin' awesome.



---

archive/issue_comments_115356.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd32\".",
    "created_at": "2011-08-24T23:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115356",
    "user": "https://github.com/williamstein"
}
```

Changing keywords from "" to "sd32".



---

archive/issue_comments_115357.json:
```json
{
    "body": "Shouldn't the code only be included if the doctests actually contain `# tol ...`?\n\n`( +[0-9.e+-]+)?` hardly matches what we want btw.\n\n\n\n\n\nI've put this onto the 1337 ticket (#11337).",
    "created_at": "2011-09-08T23:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115357",
    "user": "https://github.com/nexttime"
}
```

Shouldn't the code only be included if the doctests actually contain `# tol ...`?

`( +[0-9.e+-]+)?` hardly matches what we want btw.





I've put this onto the 1337 ticket (#11337).



---

archive/issue_comments_115358.json:
```json
{
    "body": "This doesn't work. Re Leif's comment, I think the regexp should something like `' ((\\.[0-9]+|[0-9]+(\\.[0-9]*)?)e[+-]?[0-9]+)'`, which adds another group to the match, so we need to make this change:\n\n```diff\ndiff --git a/sage-doctest b/sage-doctest\n--- a/sage-doctest\n+++ b/sage-doctest\n@@ -217,7 +217,7 @@ if __name__ ==  '__main__':\n \"\"\" % dict\n \n NONE=0; LONG_TIME=1; RANDOM=2; OPTIONAL=3; NOT_IMPLEMENTED=4; NOT_TESTED=5; TOLERANCE=6\n-tolerance_pattern = re.compile(r'\\b((?:abs(?:olute)?)|(?:rel(?:ative)?))? *?tol(?:erance)?\\b( +[0-9.e+-]+)?')\n+tolerance_pattern = re.compile(r'\\b((?:abs(?:olute)?)|(?:rel(?:ative)?))? *?tol(?:erance)?\\b +((\\.[0-9]+|[0-9]+(\\.[0-9]*)?)e[+-]?[0-9]+)?')\n \n def comment_modifier(s):\n     sind = s.find('#')\n@@ -239,7 +239,7 @@ def comment_modifier(s):\n     m = tolerance_pattern.search(L)\n     if m:\n         v.append(TOLERANCE)\n-        rel_or_abs, epsilon = m.groups()\n+        rel_or_abs, epsilon, _, _ = m.groups()\n         if rel_or_abs is not None:\n             rel_or_abs = rel_or_abs[:3]\n         if epsilon is None:\n```\nI think this should match any of \"1.2e12\", \"1e-12\", \".1e12\", without matching \"ee12e+-122\", like the previous regexp.\n\nIn addition to this, the whole thing just flat doesn't work.  I created a Python file with some tolerance tests in it, and they all fail, and the failures print badly: they include tracebacks, for example.  I'm not sure why the rst file patched in the two \"doc\" patches isn't being doctested correctly, but as far as I can tell, no doctests are being run in that file -- just add an obviously wrong doctest, and tests still pass.  Here is a test file:\n\n```python\n\"\"\"\nHere are some examples::\n\n    sage: 3+3\n    6\n    sage: RDF(pi)                               # abs tol 1e-4\n    3.14159\n\nHere is another example::\n\n    sage: [10^n for n in [0.0 .. 4]]            # rel tol 2e-4\n    [0.9999, 10.001, 100.01, 999.9, 10001]\n\nAnd another::\n\n    sage: RDF(pi)                               # abs tol 1e-4\n    3.14159\n\nAnd that's the end.\n\"\"\"\n```\nSave this as \"new.py\" and run \"sage -t new.py\" to see some bad behavior.",
    "created_at": "2011-09-09T03:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115358",
    "user": "https://github.com/jhpalmieri"
}
```

This doesn't work. Re Leif's comment, I think the regexp should something like `' ((\.[0-9]+|[0-9]+(\.[0-9]*)?)e[+-]?[0-9]+)'`, which adds another group to the match, so we need to make this change:

```diff
diff --git a/sage-doctest b/sage-doctest
--- a/sage-doctest
+++ b/sage-doctest
@@ -217,7 +217,7 @@ if __name__ ==  '__main__':
 """ % dict
 
 NONE=0; LONG_TIME=1; RANDOM=2; OPTIONAL=3; NOT_IMPLEMENTED=4; NOT_TESTED=5; TOLERANCE=6
-tolerance_pattern = re.compile(r'\b((?:abs(?:olute)?)|(?:rel(?:ative)?))? *?tol(?:erance)?\b( +[0-9.e+-]+)?')
+tolerance_pattern = re.compile(r'\b((?:abs(?:olute)?)|(?:rel(?:ative)?))? *?tol(?:erance)?\b +((\.[0-9]+|[0-9]+(\.[0-9]*)?)e[+-]?[0-9]+)?')
 
 def comment_modifier(s):
     sind = s.find('#')
@@ -239,7 +239,7 @@ def comment_modifier(s):
     m = tolerance_pattern.search(L)
     if m:
         v.append(TOLERANCE)
-        rel_or_abs, epsilon = m.groups()
+        rel_or_abs, epsilon, _, _ = m.groups()
         if rel_or_abs is not None:
             rel_or_abs = rel_or_abs[:3]
         if epsilon is None:
```
I think this should match any of "1.2e12", "1e-12", ".1e12", without matching "ee12e+-122", like the previous regexp.

In addition to this, the whole thing just flat doesn't work.  I created a Python file with some tolerance tests in it, and they all fail, and the failures print badly: they include tracebacks, for example.  I'm not sure why the rst file patched in the two "doc" patches isn't being doctested correctly, but as far as I can tell, no doctests are being run in that file -- just add an obviously wrong doctest, and tests still pass.  Here is a test file:

```python
"""
Here are some examples::

    sage: 3+3
    6
    sage: RDF(pi)                               # abs tol 1e-4
    3.14159

Here is another example::

    sage: [10^n for n in [0.0 .. 4]]            # rel tol 2e-4
    [0.9999, 10.001, 100.01, 999.9, 10001]

And another::

    sage: RDF(pi)                               # abs tol 1e-4
    3.14159

And that's the end.
"""
```
Save this as "new.py" and run "sage -t new.py" to see some bad behavior.



---

archive/issue_comments_115359.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-09-09T03:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115359",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_115360.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> I think the regexp should something like\n\n{{{\n' ((\\.[0-9]+|[0-9]+(\\.[0-9]*)?)e[+-]?[0-9]+)'`\n}}}\n\nBut that doesn't match `1ee7` :(\n\nYou can of course match funny things first, i.e. use more general patterns, but you then have to check the matched expression further before passing it to `float()`.\n\nThe whole idea isn't that bad, but carries the danger that people simply increase the tolerance (too much) just to make doctests pass *somehow*, without caring where the variations originate from.",
    "created_at": "2011-09-09T04:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115360",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:30 jhpalmieri]:
> I think the regexp should something like

{{{
' ((\.[0-9]+|[0-9]+(\.[0-9]*)?)e[+-]?[0-9]+)'`
}}}

But that doesn't match `1ee7` :(

You can of course match funny things first, i.e. use more general patterns, but you then have to check the matched expression further before passing it to `float()`.

The whole idea isn't that bad, but carries the danger that people simply increase the tolerance (too much) just to make doctests pass *somehow*, without caring where the variations originate from.



---

archive/issue_comments_115361.json:
```json
{
    "body": "But `float(1ee7)` raises an error.  Why would we want to match that?\n\nRe the issue of raising tolerance, I hope that referees will keep an eye on that sort of thing.  Dave Kirkby, for example, is a strong advocate of not arbitrarily raising tolerance.",
    "created_at": "2011-09-09T05:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115361",
    "user": "https://github.com/jhpalmieri"
}
```

But `float(1ee7)` raises an error.  Why would we want to match that?

Re the issue of raising tolerance, I hope that referees will keep an eye on that sort of thing.  Dave Kirkby, for example, is a strong advocate of not arbitrarily raising tolerance.



---

archive/issue_comments_115362.json:
```json
{
    "body": "Attachment [10952-tol-bin.2.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-bin.2.patch) by @robertwb created at 2011-09-09 05:20:21",
    "created_at": "2011-09-09T05:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115362",
    "user": "https://github.com/robertwb"
}
```

Attachment [10952-tol-bin.2.patch](tarball://root/attachments/some-uuid/ticket10952/10952-tol-bin.2.patch) by @robertwb created at 2011-09-09 05:20:21



---

archive/issue_comments_115363.json:
```json
{
    "body": "I've fixed the issue with blanklines terminating example blocks. As for the regular expression for floats, I don't see any need to make it more complicated--I'd rather match miss-typed numbers and raise an error than silently ignore them. If you feel strongly, this could be changed.\n\nReferees should keep an eye on precision. This is back to my philosophy that a computer should run doctests and a human read the code (though we could add a patchbot plugin to flag drops in precision). It's not a new issue--we've been using \"...\" for quite a while now which is less flexible and more dangerous (as it can match more than just a single number).",
    "created_at": "2011-09-09T05:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115363",
    "user": "https://github.com/robertwb"
}
```

I've fixed the issue with blanklines terminating example blocks. As for the regular expression for floats, I don't see any need to make it more complicated--I'd rather match miss-typed numbers and raise an error than silently ignore them. If you feel strongly, this could be changed.

Referees should keep an eye on precision. This is back to my philosophy that a computer should run doctests and a human read the code (though we could add a patchbot plugin to flag drops in precision). It's not a new issue--we've been using "..." for quite a while now which is less flexible and more dangerous (as it can match more than just a single number).



---

archive/issue_comments_115364.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-09-09T05:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115364",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_115365.json:
```json
{
    "body": "How about emitting the extra code only if `# tol ...` is used at all in the file?\n\nThat's a simple `\"\"\"... %s ...\"\"\" % (tolerance_code if uses_tol else \"\")`.",
    "created_at": "2011-09-09T05:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115365",
    "user": "https://github.com/nexttime"
}
```

How about emitting the extra code only if `# tol ...` is used at all in the file?

That's a simple `"""... %s ...""" % (tolerance_code if uses_tol else "")`.



---

archive/issue_comments_115366.json:
```json
{
    "body": "You're talking about the `check_with_tolerance` function and helpers. One could add a variable to keep track of this and conditionally emit it; not sure if the added complexity is worth the tiny savings.",
    "created_at": "2011-09-09T06:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115366",
    "user": "https://github.com/robertwb"
}
```

You're talking about the `check_with_tolerance` function and helpers. One could add a variable to keep track of this and conditionally emit it; not sure if the added complexity is worth the tiny savings.



---

archive/issue_comments_115367.json:
```json
{
    "body": "Replying to [comment:36 robertwb]:\n> You're talking about the `check_with_tolerance` function and helpers. One could add a variable to keep track of this and conditionally emit it; not sure if the added complexity is worth the tiny savings. \n\n\nAdded complexity? One boolean variable, initialized to false and set to `True` in only a few places?\n\nThis not only reduces the file size and run (import!) time but also avoids more potential name clashes.\n\nWhy should one add useless code to each and every file to doctest not using `# tol`?",
    "created_at": "2011-09-09T06:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115367",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:36 robertwb]:
> You're talking about the `check_with_tolerance` function and helpers. One could add a variable to keep track of this and conditionally emit it; not sure if the added complexity is worth the tiny savings. 


Added complexity? One boolean variable, initialized to false and set to `True` in only a few places?

This not only reduces the file size and run (import!) time but also avoids more potential name clashes.

Why should one add useless code to each and every file to doctest not using `# tol`?



---

archive/issue_comments_115368.json:
```json
{
    "body": "Either we make this variable a global (ugly) or return it on from call to doc_preparse along with the parsed docstring (also ugly). All to save a fraction of a block (~1KB) of an ephemeral file and < 1ms on an already fairly expensive operation. If we're looking to cut fat, it'd be better to avoid the quadratic-time creation of the doctest file string. \n\nThe name clash is a red herring--if we avoid it only because # tol is not used, that's a potentially latent bug in my mind. The function could be renamed if need be.",
    "created_at": "2011-09-09T08:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115368",
    "user": "https://github.com/robertwb"
}
```

Either we make this variable a global (ugly) or return it on from call to doc_preparse along with the parsed docstring (also ugly). All to save a fraction of a block (~1KB) of an ephemeral file and < 1ms on an already fairly expensive operation. If we're looking to cut fat, it'd be better to avoid the quadratic-time creation of the doctest file string. 

The name clash is a red herring--if we avoid it only because # tol is not used, that's a potentially latent bug in my mind. The function could be renamed if need be.



---

archive/issue_comments_115369.json:
```json
{
    "body": "I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.\n\nMeanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures:\n\n```\nsage -t  \"builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py\"\n**********************************************************************\nFile \"/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py\", line 4:\n    sage: 3+3\nExpected:\n    8\nGot:\n    6\n**********************************************************************\nFile \"/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py\", iled example:\n    check_with_tolerance('''\n        3.14159\n    ''', res, 9.9999999999999998e-13, 'abs')\nException raised:\n    Traceback (most recent call last):\n      File \"/Applications/sage/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Applications/sage/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Applications/sage/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[11]>\", line 3, in <module>\n        ''', res, 9.9999999999999998e-13, 'abs')\n      File \"/Users/palmieri/.sage//tmp/new.py\", line 35, in check_with_tolerance\n        assert abs(expected_value - actual_value) < epsilon, \"Out of tolerance %s vs %s\" % (expected_value, actual_value)\n    AssertionError: Out of tolerance 3.14159 vs 3.14159265359\n**********************************************************************\n1 items had failures:\n   2 of  13 in __main__.example_0\n***Test Failed*** 2 failures.\nFor whitespace errors, see the file /Users/palmieri/.sage//tmp/.doctest_new.py\n\t [3.9 s]\n```\nNotice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.  For me, this gives this sort of output (with a slightly different file):\n\n```\nsage -t  \"builds/sage-4.7.2.alpha2/devel/sage-new/new.py\"   \n**********************************************************************\nFile \"/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py\", line 4:\n    sage: 3+3\nExpected:\n    8\nGot:\n    6\n**********************************************************************\nFile \"/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py\", line 6:\n    sage: RDF(pi)                               # abs tol 1e-6\nOut of tolerance 3.14159 vs 3.14159265359\n**********************************************************************\nFile \"/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py\", line 16:\n    sage: RDF(pi)                               # abs tol 1e-8\nOut of tolerance 3.14159 vs 3.14159265359\n**********************************************************************\n1 items had failures:\n   3 of  16 in __main__.example_0\n***Test Failed*** 3 failures.\nFor whitespace errors, see the file /Users/palmieri/.sage//tmp/.doctest_new.py\n\t [4.2 s]\n```\n\nSince the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.\n\nFinally, the issue with doctests in `conventions.rst` is, I think, that the various triple quotes `\"\"\"` confuse the parsing routine (the function `pythonify_rst` in particular).  This belongs on another ticket.  That file contains enough incomplete code stubs that I wonder if it shouldn't be doctested at all...",
    "created_at": "2011-09-09T22:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115369",
    "user": "https://github.com/jhpalmieri"
}
```

I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.

Meanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures:

```
sage -t  "builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py"
**********************************************************************
File "/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py", line 4:
    sage: 3+3
Expected:
    8
Got:
    6
**********************************************************************
File "/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/sage/homology/new.py", iled example:
    check_with_tolerance('''
        3.14159
    ''', res, 9.9999999999999998e-13, 'abs')
Exception raised:
    Traceback (most recent call last):
      File "/Applications/sage/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Applications/sage/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Applications/sage/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[11]>", line 3, in <module>
        ''', res, 9.9999999999999998e-13, 'abs')
      File "/Users/palmieri/.sage//tmp/new.py", line 35, in check_with_tolerance
        assert abs(expected_value - actual_value) < epsilon, "Out of tolerance %s vs %s" % (expected_value, actual_value)
    AssertionError: Out of tolerance 3.14159 vs 3.14159265359
**********************************************************************
1 items had failures:
   2 of  13 in __main__.example_0
***Test Failed*** 2 failures.
For whitespace errors, see the file /Users/palmieri/.sage//tmp/.doctest_new.py
	 [3.9 s]
```
Notice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.  For me, this gives this sort of output (with a slightly different file):

```
sage -t  "builds/sage-4.7.2.alpha2/devel/sage-new/new.py"   
**********************************************************************
File "/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py", line 4:
    sage: 3+3
Expected:
    8
Got:
    6
**********************************************************************
File "/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py", line 6:
    sage: RDF(pi)                               # abs tol 1e-6
Out of tolerance 3.14159 vs 3.14159265359
**********************************************************************
File "/Applications/sage_builds/sage-4.7.2.alpha2/devel/sage-new/new.py", line 16:
    sage: RDF(pi)                               # abs tol 1e-8
Out of tolerance 3.14159 vs 3.14159265359
**********************************************************************
1 items had failures:
   3 of  16 in __main__.example_0
***Test Failed*** 3 failures.
For whitespace errors, see the file /Users/palmieri/.sage//tmp/.doctest_new.py
	 [4.2 s]
```

Since the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.

Finally, the issue with doctests in `conventions.rst` is, I think, that the various triple quotes `"""` confuse the parsing routine (the function `pythonify_rst` in particular).  This belongs on another ticket.  That file contains enough incomplete code stubs that I wonder if it shouldn't be doctested at all...



---

archive/issue_comments_115370.json:
```json
{
    "body": "scripts repo; apply on top of other scripts patch",
    "created_at": "2011-09-09T22:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115370",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo; apply on top of other scripts patch



---

archive/issue_comments_115371.json:
```json
{
    "body": "Attachment [trac_10952-ref.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-ref.patch) by @nexttime created at 2011-09-09 22:31:48\n\nReplying to [comment:39 jhpalmieri]:\n> I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.\n\n\nYes, only\n\n```\nsage: foo   # tol 1ee7\nanything\n```\nshould always pass. ;-)\n\n\n\n\n> Meanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures [...] \n\n\n> Notice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.\n\n\nHaven't tested your patch (nor looked at it), but the output you gave looks much better.\n\n\n\n\n> Since the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.\n\n\nI won't object, though I in general don't like the idea of adding code (regardless how small the overhead or impact might be) unconditionally, i.e., if there's no need to do so.\n\nWe have similar situations all around, where everybody adds \"just a little\", IMHO.",
    "created_at": "2011-09-09T22:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115371",
    "user": "https://github.com/nexttime"
}
```

Attachment [trac_10952-ref.patch](tarball://root/attachments/some-uuid/ticket10952/trac_10952-ref.patch) by @nexttime created at 2011-09-09 22:31:48

Replying to [comment:39 jhpalmieri]:
> I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.


Yes, only

```
sage: foo   # tol 1ee7
anything
```
should always pass. ;-)




> Meanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures [...] 


> Notice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.


Haven't tested your patch (nor looked at it), but the output you gave looks much better.




> Since the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.


I won't object, though I in general don't like the idea of adding code (regardless how small the overhead or impact might be) unconditionally, i.e., if there's no need to do so.

We have similar situations all around, where everybody adds "just a little", IMHO.



---

archive/issue_comments_115372.json:
```json
{
    "body": "Replying to [comment:40 leif]:\n> Replying to [comment:39 jhpalmieri]:\n> > I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.\n\n> \n> Yes, only\n> \n> ```\n> sage: foo   # tol 1ee7\n> anything\n> ```\n> should always pass. ;-)\n\n\nCurrently, it raises an error indicating that the *doctest* itself is bad. \n\n> > Meanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures [...] \n\n\n> > Notice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.\n\n> \n> Haven't tested your patch (nor looked at it), but the output you gave looks much better.\n> \n> \n\n\n> \n> > Since the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.\n\n> \n> I won't object, though I in general don't like the idea of adding code (regardless how small the overhead or impact might be) unconditionally, i.e., if there's no need to do so.\n> \n> We have similar situations all around, where everybody adds \"just a little\", IMHO.\n\n\nYes, it's a tradeoff between adding \"just a little\" python parsing overhead to the testing infrastructure or \"just a little\" human parsing overhead to the testing infrastructure. I'd rather put the burden on machines than developers in this case. \n\nThe reviewer patches look good, certainly an improvement, so I'm setting this back to positive review unless there's something else that needs to be taken care of.",
    "created_at": "2011-09-22T21:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115372",
    "user": "https://github.com/robertwb"
}
```

Replying to [comment:40 leif]:
> Replying to [comment:39 jhpalmieri]:
> > I don't see anything wrong with more complicated regular expressions, but I like regular expressions.  So leave it as is if you want.

> 
> Yes, only
> 
> ```
> sage: foo   # tol 1ee7
> anything
> ```
> should always pass. ;-)


Currently, it raises an error indicating that the *doctest* itself is bad. 

> > Meanwhile, the output for failures using tolerances isn't nice, compared to other sorts of failures [...] 


> > Notice that the line number is missing and the traceback is present.  I'm attaching a referee patch which tries to fix this.  Please take a look.

> 
> Haven't tested your patch (nor looked at it), but the output you gave looks much better.
> 
> 


> 
> > Since the whole ticket had a positive review earlier, I think if you're happy with my changes, you can switch it back to that status.

> 
> I won't object, though I in general don't like the idea of adding code (regardless how small the overhead or impact might be) unconditionally, i.e., if there's no need to do so.
> 
> We have similar situations all around, where everybody adds "just a little", IMHO.


Yes, it's a tradeoff between adding "just a little" python parsing overhead to the testing infrastructure or "just a little" human parsing overhead to the testing infrastructure. I'd rather put the burden on machines than developers in this case. 

The reviewer patches look good, certainly an improvement, so I'm setting this back to positive review unless there's something else that needs to be taken care of.



---

archive/issue_comments_115373.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-22T21:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115373",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_115374.json:
```json
{
    "body": "Changing keywords from \"sd32\" to \"sd32 noise noisy doctest failure error tolerance\".",
    "created_at": "2011-09-26T02:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115374",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "sd32" to "sd32 noise noisy doctest failure error tolerance".



---

archive/issue_comments_115375.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-27T17:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115375",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed



---

archive/issue_events_028396.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-27T17:41:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10873#event-28396"
}
```



---

archive/issue_comments_115376.json:
```json
{
    "body": "I'd like to draw the attention of folks here to comment:7:ticket:12493.  Apparently one can't do `only-optional` tests along with `tol` tests at the same time.   My guess is that not too many people use `only-optional` and the `tol` stuff is pretty new.\n\nIn fact, I only found one occurrence in 5.0.beta3.  Can that be right?  This has been in Sage for months!\n\n```\nsage: search_src(\" tol \",\"#\")\nsymbolic/integration/integral.py:587:        sage: error.numerical_approx() # abs tol 10e-10\n```\nAnyway, even if my analysis is wrong (let's hope it's easier than that), I figure the people here can give a quick diagnosis of #12493.",
    "created_at": "2012-02-10T20:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115376",
    "user": "https://github.com/kcrisman"
}
```

I'd like to draw the attention of folks here to comment:7:ticket:12493.  Apparently one can't do `only-optional` tests along with `tol` tests at the same time.   My guess is that not too many people use `only-optional` and the `tol` stuff is pretty new.

In fact, I only found one occurrence in 5.0.beta3.  Can that be right?  This has been in Sage for months!

```
sage: search_src(" tol ","#")
symbolic/integration/integral.py:587:        sage: error.numerical_approx() # abs tol 10e-10
```
Anyway, even if my analysis is wrong (let's hope it's easier than that), I figure the people here can give a quick diagnosis of #12493.



---

archive/issue_comments_115377.json:
```json
{
    "body": "Actually, comment:8:ticket:12493 is even better!  Optional and tol don't play well together.",
    "created_at": "2012-02-10T20:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10873#issuecomment-115377",
    "user": "https://github.com/kcrisman"
}
```

Actually, comment:8:ticket:12493 is even better!  Optional and tol don't play well together.
