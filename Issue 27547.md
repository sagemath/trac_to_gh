# Issue 27547: Characteristic Classes on Manifolds

Issue created by migration from https://trac.sagemath.org/ticket/27784

Original creator: @DeRhamSource

Original creation time: 2019-05-06 13:12:30

CC:  tscrim egourgoulhon




---

Comment by @DeRhamSource created at 2019-05-06 13:16:45

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @DeRhamSource created at 2019-05-06 13:16:45

Changing component from PLEASE CHANGE to geometry.


---

Comment by @DeRhamSource created at 2019-05-06 13:16:45

Changing keywords from "" to "characteristic classes, manifolds".


---

Comment by git created at 2019-06-03 12:40:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-06 15:10:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by @DeRhamSource created at 2019-07-06 16:04:07

New commits:


---

Comment by git created at 2019-11-11 03:05:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @DeRhamSource created at 2019-11-11 03:10:17

Changing status from new to needs_review.


---

Comment by git created at 2019-11-11 14:11:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-11 18:40:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-12 10:40:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-11-12 10:45:42

I know, you are really busy right now, Eric. However, this ticket is the essence and foundation of my master thesis and I'd highly appreciate at least a short look whether the structure is okay.

Travis, could you take a short look, too?

Details can be changed later, but the rough structure should be fine before I start writing my thesis.

Thank you both! I really appreciate your effort so far. :)


---

Comment by git created at 2019-11-12 10:53:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-12 11:06:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-12 12:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-11-12 15:15:07

I won't be able to look at it for at least a few days. However, I will make it a high priority.


---

Comment by @DeRhamSource created at 2019-11-12 17:55:29

Replying to [comment:23 tscrim]:
> I won't be able to look at it for at least a few days. However, I will make it a high priority. 

Thank you so much! :)


---

Comment by tscrim created at 2019-11-15 08:39:06

Here are my comments (mostly on the technical details):

Don't feel the strict need to adhere to PEP8 when it degrades readability. In particular, don't have a line break here:

```diff
-from sage.manifolds.differentiable.vector_bundle\
-                                               import DifferentiableVectorBundle
+from sage.manifolds.differentiable.vector_bundle import DifferentiableVectorBundle
```

and similarly here

```
            sage: from sage.manifolds.differentiable.bundle_connection import \
                                                                BundleConnection
```

In contrast, you can break `.. MATH::` lines.

Remove the period/full-stop at the end here:

```
    - ``latex_name`` -- (default: ``None``) LaTeX symbol to denote the bundle
      connection; if ``None``, it is set to ``name``.
```


I don't see the point of this note:

```
    .. NOTE::

        Notice that this is a *very* rudimentary form of bundle connections.
        A more detailed implementation is devoted to :trac:`28640`.
```

The only people who will care are developers, it is irrelevant to the use of this class, and it makes it come across as less polished.

The block after `They certainly obey the structure equation::` is over-indented.

A general comment (not something you need to address here, but I noticed it now): we should have a little mix-in class for `_latex_name` objects (or perhaps more generally `NamedObject`) so we don't have so much repeated boilerplate code.

Instead of `_hash_value`, the more standard naming is `_hash`.

Error messages should follow the general Python convention:

```diff
-raise ValueError("A frame must be provided!")
+raise ValueError("a frame must be provided")
```


Is this relevant? `# TODO: Compute transformations` Should it instead raise a `NotImplementedError`?

Is there some way we can automate this?

```
        .. WARNING::

            If the connection has already forms in other frames, it is the
            user's responsibility to make sure that the 1-forms to be added
            are consistent with them.
```



```diff
-computation in SAGE.
+computation in Sage.
```

Although really I would suggest just deleting that sentence (you already are using Sage and such an  internal working, if you insist on including it, should be in an `ALGORITHM:` section).

I generally dislike these things:

```
Class Documentation
-------------------
```

They don't convey any information and just are a bit of a distraction IMO.

`_get_predefined_class` is not a static method (it is just a separate function). Also ``arg`` -> ```arg```

This should just be an `if-else` statement:

```python
    c_dict = {}
    c_dict['ChernChar'] = ('complex', 'additive', 'ch', r'\mathrm{ch}', x.exp())
    c_dict['Todd'] = ('complex', 'additive', 'Td', r'\mathrm{Td}',
                      x / (1 - (-x).exp()))
    c_dict['Chern'] = ('complex', 'multiplicative', 'c', 'c', 1 + x)
    c_dict['Pontryagin'] = ('real', 'multiplicative', 'p', 'p', 1 + x)
    c_dict['AHat'] = ('real', 'multiplicative', 'A^', r'\hat{A}',
                      x.sqrt() / (2 * (x.sqrt() / 2).sinh()))
    c_dict['Hirzebruch'] = ('real', 'multiplicative', 'L', 'L',
                            (x.sqrt() / x.sqrt().tanh()))
    c_dict['Euler'] = ('real', 'Pfaffian', 'e', 'e', x)
    # Get class from arg
    try:
        res = c_dict[arg]
    except KeyError:
        raise ValueError("the characteristic class '{}' is ".format(arg) +
                         "not predefined yet.")
```

unless you were hoping to cache `c_dict`, but I don't see the utility in that as this should not be a bottleneck.

Do not abbreviate class names and `UniqueRepresentation` is better being first in the MRO:

```diff
-class CharClass(SageObject, UniqueRepresentation):
+class CharacteristicClass(UniqueRepresentation, SageObject):
```

IMO, generally you should avoid abbreviated names for inputs/function names/etc. for the main implementation (although it is okay to have an abbreviated alias). (For another example, `get_form(self, con, cmatrices=None):` and use `connection` instead of `con` and `def char_class` to `def characteristic_class`) This better self-documents the code and can make things more discoverable with tab completion. For example, I might type `.charact<tab>` and then be surprised that nothing comes up.

In `_get_coeff_list`, there is no need for the `coef` variable (just return the result).
Also

```diff
-(self._base_space._dim / 2).floor()
+self._base_space._dim // 2
```

and make `from sage.symbolic.ring import SR` at the top-level.


```diff
-- ``cmatrix`` curvature matrix
+- ``cmatrix`` -- curvature matrix
```



---

Comment by git created at 2019-11-15 09:57:03

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @DeRhamSource created at 2019-11-15 10:00:51

Hopefully, I took everything into account you mentioned.

Thank you for the extensive feedback! :)


---

Comment by git created at 2019-11-15 10:20:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-11-15 11:32:24

I gave a quik look. It looks nice!
Thanks for having taken into account Travis' remarks. I fully agree with them. 
Here a few remarks from my side: 

- There is a failed doctest:

```
File "src/sage/manifolds/differentiable/char_class.py", line 685, in sage.manifolds.differentiable.char_class.CharacteristicClass.get_form
Failed example:
    ch_form.display()
Expected:
    ch(E, nabla^E) = ch_0(E, nabla^E) + zero + ch_1(E, nabla^E)
Got:
    ch(E, nabla^E) = ch_0.0(E, nabla^E) + zero + ch_1.0(E, nabla^E)
```

- There are two warnings when generating the documentation:

```
[manifolds] <unknown>:2566: DeprecationWarning: invalid escape sequence \c
[manifolds] <unknown>:2565: DeprecationWarning: invalid escape sequence \c
```

- in the OUTPUT section of `BundleConnection.add_connection_form()`, a back quote is missing:

```diff
- connection 1-form `\omega^i_j in the given frame, as an instance of
+ connection 1-form `\omega^i_j` in the given frame, as an instance of
```

- in the introduction to characteristic classes, `N` is not defined in the sentence

```
for any continuous map `f: M \to N`
```

- in the doctest example of `in DifferentiableVectorBundle.characteristic_class()`:

```diff
- sage: g = M.metric('g')
+ sage: g = M.metric()
```

(since `M` has been defined a Lorentzian manifold, `g` has already been initialized, with the name 'g')


---

Comment by @DeRhamSource created at 2019-11-15 12:13:50

Replying to [comment:29 egourgoulhon]:
> I gave a quik look. It looks nice!
> Thanks for having taken into account Travis' remarks. I fully agree with them. 
> Here a few remarks from my side: 
> 
> - There is a failed doctest:
> {{{
> File "src/sage/manifolds/differentiable/char_class.py", line 685, in sage.manifolds.differentiable.char_class.CharacteristicClass.get_form
> Failed example:
>     ch_form.display()
> Expected:
>     ch(E, nabla^E) = ch_0(E, nabla^E) + zero + ch_1(E, nabla^E)
> Got:
>     ch(E, nabla^E) = ch_0.0(E, nabla^E) + zero + ch_1.0(E, nabla^E)
> }}}

That's strange...I don't get this error. Travis?

The rest is in progress...


---

Comment by @DeRhamSource created at 2019-11-15 12:31:58

Ah, that might come from using Python 2.7. Hang on there.


---

Comment by egourgoulhon created at 2019-11-15 12:38:02

Replying to [comment:30 gh-DeRhamSource]:
> That's strange...I don't get this error. Travis?
> 
Are you using Python 3 Sage ?


---

Comment by egourgoulhon created at 2019-11-15 12:39:14

Replying to [comment:31 gh-DeRhamSource]:
> Ah, that might come from using Python 2.7. Hang on there.
Yes most  probably


---

Comment by git created at 2019-11-15 12:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-11-15 12:50:23

The issue about the `DeprecationWarning` referred to #28564. That has been fixed.

The other issues has been solved, too.

However, I'll build Sage from scratch, now.


---

Comment by egourgoulhon created at 2019-11-15 17:07:48

With the latest version, there are two failed doctests in `char_class.py`. I got them on my machine and they are reported by the patchbot as well.


---

Comment by git created at 2019-11-15 21:44:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-11-15 21:45:51

I guess that should be it. However, my build is not finished yet. I will start an extensive test as soon as possible.

Thanks so far! :)


---

Comment by @DeRhamSource created at 2019-11-16 13:18:44

My tests did all pass. Patchbot says so, too.

By the way: Why is the patchbot yellow and not green though all tests passed?


---

Comment by @DeRhamSource created at 2019-11-16 13:24:05

Replying to [comment:25 tscrim]:
> Is there some way we can automate this?
> {{{
>         .. WARNING::
> 
>             If the connection has already forms in other frames, it is the
>             user's responsibility to make sure that the 1-forms to be added
>             are consistent with them.
> }}}

The concept and warning is just copied from `affine_connection.py`. At least it should be possible to return an error message when some incompatibilities occur on the intersection. But that's a topic for another ticket, I'd say.


---

Comment by chapoton created at 2019-11-16 13:49:10

Patchbot says:

```
sage -t --long src/sage/parallel/map_reduce.py  # Timed out
sage -t --long src/doc/en/reference/references/index.rst  # Tab character found
```



---

Comment by @DeRhamSource created at 2019-11-16 14:07:01

Replying to [comment:41 chapoton]:
> Patchbot says:
> {{{
> sage -t --long src/sage/parallel/map_reduce.py  # Timed out
> sage -t --long src/doc/en/reference/references/index.rst  # Tab character found
> }}}

The first one has nothing to do with the changes in this ticket.

However, the second has been fixed now.

Thanks! :)


---

Comment by git created at 2019-11-16 14:07:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-11-16 15:03:06

Also, it seems there is a doctest missing in `map_reduce.py`. What's going on there? :-/


---

Comment by tscrim created at 2019-11-16 18:16:15

Patchbot has come back green.


---

Comment by egourgoulhon created at 2019-11-17 09:54:25

Replying to [comment:40 gh-DeRhamSource]:
> Replying to [comment:25 tscrim]:
> > Is there some way we can automate this?
> > {{{
> >         .. WARNING::
> > 
> >             If the connection has already forms in other frames, it is the
> >             user's responsibility to make sure that the 1-forms to be added
> >             are consistent with them.
> > }}}
> 
> The concept and warning is just copied from `affine_connection.py`. At least it should be possible to return an error message when some incompatibilities occur on the intersection. But that's a topic for another ticket, I'd say.

I agree: this could be postponed to another ticket; in particular, checking the compatibility can be computationaly demanding and one shall discuss the appropriate way to do this, with possibly an option `check=True` or `check=False`.


---

Comment by egourgoulhon created at 2019-11-17 10:00:35

Replying to [comment:45 tscrim]:
> Patchbot has come back green.

From my side, I think we are almost done here. Two last remarks:
- in the introduction to characteristic classes, `\mathfrak{g}` is not defined
- could the file `char_class.py` be renamed `characteristic_class.py`? (this would improve the readability of the directory `src/sage/manifolds/differentiable` and would match with the name of the class `CharacteristicClass`)


---

Comment by git created at 2019-11-17 13:22:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-11-17 13:45:33

I hope, I took the renaming everywhere into account...


---

Comment by egourgoulhon created at 2019-11-17 19:05:02

Replying to [comment:49 gh-DeRhamSource]:
> I hope, I took the renaming everywhere into account...

Thanks for the changes. 
I am OK for a positive review. Travis?


---

Comment by tscrim created at 2019-11-17 20:22:45

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-11-17 20:22:45

Yep, I am also good with it.


---

Comment by git created at 2019-11-18 12:58:53

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2019-11-18 12:58:53

Changing status from positive_review to needs_review.


---

Comment by @DeRhamSource created at 2019-11-18 13:01:27

Please give it a positive review again...


---

Comment by egourgoulhon created at 2019-11-18 20:57:17

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-11-18 20:57:17

The 9.0.beta6 patchbot is all green.


---

Comment by git created at 2019-11-20 14:10:11

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-11-20 14:10:11

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by @DeRhamSource created at 2019-11-20 14:12:59

That was just a very very minor thing I noticed during my thesis preparation. Sorry.

By the way: Am I allowed to switch the review status back to "positive" by myself in such cases?


---

Comment by egourgoulhon created at 2019-11-20 18:22:51

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-11-20 18:28:04

Replying to [comment:56 gh-DeRhamSource]:
> That was just a very very minor thing I noticed during my thesis preparation. Sorry.
> 

No problem. It's always good to improve the documentation!

> By the way: Am I allowed to switch the review status back to "positive" by myself in such cases?

I don't think we have very precise rules about this. IMHO, it seems better to have an external eye, even for seemingly minor changes.


---

Comment by git created at 2019-11-28 11:28:46

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2019-11-28 11:28:46

Changing status from positive_review to needs_review.


---

Comment by @DeRhamSource created at 2019-11-28 11:31:42

Please check the merge and doc change.


---

Comment by egourgoulhon created at 2019-11-28 12:26:11

Just checked that everything is in order with the new depedency #28716 and that all doctests are passed.


---

Comment by egourgoulhon created at 2019-11-28 12:26:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-11-30 13:35:55

Resolution: fixed
