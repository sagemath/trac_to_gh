# Issue 21739: multivariate laurent polynomial constructor: shortcuts for speedup

archive/issues_021739.json:
```json
{
    "body": "At the moment, (many) multivariate laurent polynomials and their rings are expensively converted when passed through `_element_constructor_`. The aim of this ticket is to detect a couple of special cases, where this can be done more directly, e.g., if the to-be-converted element has the same parent or the same polynomial ring as the laurent polynomial ring.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21976\n\n",
    "created_at": "2016-11-26T15:25:26Z",
    "labels": [
        "algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "multivariate laurent polynomial constructor: shortcuts for speedup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21739",
    "user": "dkrenn"
}
```
At the moment, (many) multivariate laurent polynomials and their rings are expensively converted when passed through `_element_constructor_`. The aim of this ticket is to detect a couple of special cases, where this can be done more directly, e.g., if the to-be-converted element has the same parent or the same polynomial ring as the laurent polynomial ring.

Issue created by migration from https://trac.sagemath.org/ticket/21976





---

archive/issue_comments_301682.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2016-11-26T15:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301682",
    "user": "dkrenn"
}
```

Last 10 new commits:



---

archive/issue_comments_301683.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-26T15:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301683",
    "user": "dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_301684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-09T09:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301684",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301685.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-02-22T15:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301685",
    "user": "cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_301686.json:
```json
{
    "body": "1. Please test new argument `mon` for `_element_constructor_`\n2. Please break long lines.",
    "created_at": "2017-02-22T15:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301686",
    "user": "cheuberg"
}
```

1. Please test new argument `mon` for `_element_constructor_`
2. Please break long lines.



---

archive/issue_comments_301687.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-26T21:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301687",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_301688.json:
```json
{
    "body": "Added, as well as some other tweaks and changes for speed and clarity.\n----\nNew commits:",
    "created_at": "2017-02-26T21:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301688",
    "user": "tscrim"
}
```

Added, as well as some other tweaks and changes for speed and clarity.
----
New commits:



---

archive/issue_comments_301689.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> Added, as well as some other tweaks and changes for speed and clarity.\n\nLooks good. I have two questions:\n\n\n```\n-        if P is self:\n-            return x\n```\n\nShouldn't we have this speedup (as there is really nothing to do in this case)?\n\n\n```\n-        elif P == self:\n-            return element_class(self, x)\n```\n\nSkipping this indeed will result in the same behavior. A question: Should we keep this after all in the spirit of \"Explicit is better than implicit\"?",
    "created_at": "2017-02-28T08:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301689",
    "user": "dkrenn"
}
```

Replying to [comment:5 tscrim]:
> Added, as well as some other tweaks and changes for speed and clarity.

Looks good. I have two questions:


```
-        if P is self:
-            return x
```

Shouldn't we have this speedup (as there is really nothing to do in this case)?


```
-        elif P == self:
-            return element_class(self, x)
```

Skipping this indeed will result in the same behavior. A question: Should we keep this after all in the spirit of "Explicit is better than implicit"?



---

archive/issue_comments_301690.json:
```json
{
    "body": "Those are both never called because the coercion framework takes care of those cases on its own before ever getting to `_element_constructor_`. So they just become wasted CPU cycles.",
    "created_at": "2017-02-28T15:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301690",
    "user": "tscrim"
}
```

Those are both never called because the coercion framework takes care of those cases on its own before ever getting to `_element_constructor_`. So they just become wasted CPU cycles.



---

archive/issue_comments_301691.json:
```json
{
    "body": "Actually, the `P == self` case could possibly come up, but you have to do strange things with pickling. I also see that as more a problem with the fact that `LaurentPolynomialRing` doesn't implement true `UniqueRepresentation` behavior:\n\n```\nsage: R.<x,y,z> = LaurentPolynomialRing(ZZ)\nsage: S.<x,y,z> = LaurentPolynomialRing(ZZ)\nsage: S is R\nTrue\nsage: S = loads(dumps(R))\nsage: S == R\nTrue\nsage: S is R\nFalse\n```\n",
    "created_at": "2017-02-28T15:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301691",
    "user": "tscrim"
}
```

Actually, the `P == self` case could possibly come up, but you have to do strange things with pickling. I also see that as more a problem with the fact that `LaurentPolynomialRing` doesn't implement true `UniqueRepresentation` behavior:

```
sage: R.<x,y,z> = LaurentPolynomialRing(ZZ)
sage: S.<x,y,z> = LaurentPolynomialRing(ZZ)
sage: S is R
True
sage: S = loads(dumps(R))
sage: S == R
True
sage: S is R
False
```




---

archive/issue_comments_301692.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Those are both never called because the coercion framework takes care of those cases on its own before ever getting to `_element_constructor_`. So they just become wasted CPU cycles.\n\nOh, good to know. They, let's skip them.",
    "created_at": "2017-03-02T11:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301692",
    "user": "dkrenn"
}
```

Replying to [comment:7 tscrim]:
> Those are both never called because the coercion framework takes care of those cases on its own before ever getting to `_element_constructor_`. So they just become wasted CPU cycles.

Oh, good to know. They, let's skip them.



---

archive/issue_comments_301693.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> Actually, the `P == self` case could possibly come up, but you have to do strange things with pickling. I also see that as more a problem with the fact that `LaurentPolynomialRing` doesn't implement true `UniqueRepresentation` behavior:\n> {{{\n> sage: R.<x,y,z> = LaurentPolynomialRing(ZZ)\n> sage: S.<x,y,z> = LaurentPolynomialRing(ZZ)\n> sage: S is R\n> True\n> sage: S = loads(dumps(R))\n> sage: S == R\n> True\n> sage: S is R\n> False\n> }}}\n\nI suggest to open a separate ticket for this pickling and unique representation issues.",
    "created_at": "2017-03-02T11:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301693",
    "user": "dkrenn"
}
```

Replying to [comment:8 tscrim]:
> Actually, the `P == self` case could possibly come up, but you have to do strange things with pickling. I also see that as more a problem with the fact that `LaurentPolynomialRing` doesn't implement true `UniqueRepresentation` behavior:
> {{{
> sage: R.<x,y,z> = LaurentPolynomialRing(ZZ)
> sage: S.<x,y,z> = LaurentPolynomialRing(ZZ)
> sage: S is R
> True
> sage: S = loads(dumps(R))
> sage: S == R
> True
> sage: S is R
> False
> }}}

I suggest to open a separate ticket for this pickling and unique representation issues.



---

archive/issue_comments_301694.json:
```json
{
    "body": "From my side this ticket is positively (cross) reviewed. (About authorship: `@`Travis, do you want yourself to be added as author? If so, I would add my self as a reviewer (for the cross-reviewing); and we could bring this ticket to an end.)",
    "created_at": "2017-03-02T11:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301694",
    "user": "dkrenn"
}
```

From my side this ticket is positively (cross) reviewed. (About authorship: `@`Travis, do you want yourself to be added as author? If so, I would add my self as a reviewer (for the cross-reviewing); and we could bring this ticket to an end.)



---

archive/issue_comments_301695.json:
```json
{
    "body": "I agree that we should have the `UniqueRepresentation` issue as a separate ticket (likely we will have to do all polynomial rings at once). I also don't think I've done enough to warrant being an author, so I'm setting a positive review. Thank you!",
    "created_at": "2017-03-02T13:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301695",
    "user": "tscrim"
}
```

I agree that we should have the `UniqueRepresentation` issue as a separate ticket (likely we will have to do all polynomial rings at once). I also don't think I've done enough to warrant being an author, so I'm setting a positive review. Thank you!



---

archive/issue_comments_301696.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-02T13:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301696",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301697.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> I agree that we should have the `UniqueRepresentation` issue as a separate ticket (likely we will have to do all polynomial rings at once). I also don't think I've done enough to warrant being an author, so I'm setting a positive review. Thank you!\n\nOk, thank you.",
    "created_at": "2017-03-02T13:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301697",
    "user": "dkrenn"
}
```

Replying to [comment:12 tscrim]:
> I agree that we should have the `UniqueRepresentation` issue as a separate ticket (likely we will have to do all polynomial rings at once). I also don't think I've done enough to warrant being an author, so I'm setting a positive review. Thank you!

Ok, thank you.



---

archive/issue_comments_301698.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-03T21:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21739#issuecomment-301698",
    "user": "vbraun"
}
```

Resolution: fixed
