# Issue 10783: behaviour of gamma strangely sensitive

archive/issues_010783.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @kcrisman\n\nWhether you get the correct result or a spurious ValueError in evaluating some gamma expressions depends upon things it shouldn't.\n\nThis comes from [a sage-support thread](http://groups.google.com/group/sage-support/browse_thread/thread/3b7126c1a29db091#); I looked and couldn't find it here, but possibly it's a duplicate.  (I have bad luck with trac.)\nSee also [this worksheet](http://demo.sagenb.org/home/pub/66/).\n\nHere's a relatively simple test case, in 4.6.1 and 4.6.2.rc0:\n\n\n```\nsage: x = var(\"x\")\nsage: f = exp(gamma(I*x-1/2).subs(x=I*x))\nsage: g=f.operands()[0]\nsage: g, type(g)\n(gamma(-x - 1/2), <type 'sage.symbolic.expression.Expression'>)\nsage: g(x=0)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/Applications/sage_devel/<ipython console> in <module>()\n\n/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.__call__ (sage/symbolic/expression.cpp:15657)()\n\n/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/ring.so in sage.symbolic.ring.SymbolicRing._call_element_ (sage/symbolic/ring.cpp:6537)()\n\n/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:15036)()\n\n/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/pynac.so in sage.symbolic.pynac.py_doublefactorial (sage/symbolic/pynac.cpp:9463)()\n\nValueError: argument must be >= -1\nsage: g(x=0)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n[ ... duplicate removed; this is merely to show it's not only the first call which has problems ]\nValueError: argument must be >= -1\nsage: gamma(-x-1/2)*g\ngamma(-x - 1/2)^2\nsage: g(x=0)\n-2*sqrt(pi)\n```\n\n\nThat is, merely performing the should-be-irrelevant \"gamma(-x-1/2)*g\" op makes g(x=0) start working.  Instrumenting it shows that that py_doublefactorial gets a -3 the first time instead of the 1 it does the second time, but I couldn't quite follow the calling order to isolate the error.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10849\n\n",
    "created_at": "2011-02-25T08:21:32Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "behaviour of gamma strangely sensitive",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10783",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```
Assignee: @burcin

CC:  @kcrisman

Whether you get the correct result or a spurious ValueError in evaluating some gamma expressions depends upon things it shouldn't.

This comes from [a sage-support thread](http://groups.google.com/group/sage-support/browse_thread/thread/3b7126c1a29db091#); I looked and couldn't find it here, but possibly it's a duplicate.  (I have bad luck with trac.)
See also [this worksheet](http://demo.sagenb.org/home/pub/66/).

Here's a relatively simple test case, in 4.6.1 and 4.6.2.rc0:


```
sage: x = var("x")
sage: f = exp(gamma(I*x-1/2).subs(x=I*x))
sage: g=f.operands()[0]
sage: g, type(g)
(gamma(-x - 1/2), <type 'sage.symbolic.expression.Expression'>)
sage: g(x=0)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/Applications/sage_devel/<ipython console> in <module>()

/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.__call__ (sage/symbolic/expression.cpp:15657)()

/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/ring.so in sage.symbolic.ring.SymbolicRing._call_element_ (sage/symbolic/ring.cpp:6537)()

/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:15036)()

/Applications/sage/local/lib/python2.6/site-packages/sage/symbolic/pynac.so in sage.symbolic.pynac.py_doublefactorial (sage/symbolic/pynac.cpp:9463)()

ValueError: argument must be >= -1
sage: g(x=0)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
[ ... duplicate removed; this is merely to show it's not only the first call which has problems ]
ValueError: argument must be >= -1
sage: gamma(-x-1/2)*g
gamma(-x - 1/2)^2
sage: g(x=0)
-2*sqrt(pi)
```


That is, merely performing the should-be-irrelevant "gamma(-x-1/2)*g" op makes g(x=0) start working.  Instrumenting it shows that that py_doublefactorial gets a -3 the first time instead of the 1 it does the second time, but I couldn't quite follow the calling order to isolate the error.

Issue created by migration from https://trac.sagemath.org/ticket/10849





---

archive/issue_comments_114002.json:
```json
{
    "body": "I'm pretty sure this issue stems from comparison of number field elements.  See #6132, #7160, #10064, and http://groups.google.com/group/sage-support/browse_thread/thread/28bbd04a78dadb57/01168722573ff736",
    "created_at": "2011-02-25T10:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114002",
    "user": "https://github.com/mwhansen"
}
```

I'm pretty sure this issue stems from comparison of number field elements.  See #6132, #7160, #10064, and http://groups.google.com/group/sage-support/browse_thread/thread/28bbd04a78dadb57/01168722573ff736



---

archive/issue_comments_114003.json:
```json
{
    "body": "What weirds me out is the side-effect aspect: I could understand getting the same wrong answer, or different answers for equivalent but non-identical inputs, or even random behaviour.  I don't see why the gamma(-x-1/2)*g call should change the state so that any element comparison would behave differently, but I understand exactly nothing about Sage internals at this level.",
    "created_at": "2011-02-25T11:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114003",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

What weirds me out is the side-effect aspect: I could understand getting the same wrong answer, or different answers for equivalent but non-identical inputs, or even random behaviour.  I don't see why the gamma(-x-1/2)*g call should change the state so that any element comparison would behave differently, but I understand exactly nothing about Sage internals at this level.



---

archive/issue_comments_114004.json:
```json
{
    "body": "Mike is right and the patch at #10064 resolves this issue.\n\nThe side effect is a result of GiNaC's reference counted pointers. Whenever two expressions compare equal, GiNaC frees the memory of one, and makes it a pointer to the other. In this example, it replaces `-x - 1/2` where the coefficient of `x` is in QQ(i), with `-x - 1/2` where the coefficient is just an `int`.\n\n\n```\nsage: t = -x -1/2\nsage: t\n-x - 1/2\nsage: t.operands()\n[-x, -1/2]\nsage: t.operands()[0]\n-x\nsage: t.operands()[0].operands()\n[x, -1]\nsage: t.operands()[0].operands()[1]\n-1\nsage: t.operands()[0].operands()[1].pyobject()\n-1\nsage: type(t.operands()[0].operands()[1].pyobject())\n<type 'int'>\n```\n\n\nOf course there is a chance that this observation changed the result. :)\n\nFor `g`, this looks like a different bug:\n\n\n```\nsage: g\ngamma(-x - 1/2)\nsage: g.operands()[0]\n-x - 1/2\nsage: g.operands()[0].operands()\n[x, -1/2]\nsage: g.operands()[0].operands()[0]\nx\nsage: g.operands()[0].operands()[0].operands()\n[]\n```\n",
    "created_at": "2011-05-26T09:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114004",
    "user": "https://github.com/burcin"
}
```

Mike is right and the patch at #10064 resolves this issue.

The side effect is a result of GiNaC's reference counted pointers. Whenever two expressions compare equal, GiNaC frees the memory of one, and makes it a pointer to the other. In this example, it replaces `-x - 1/2` where the coefficient of `x` is in QQ(i), with `-x - 1/2` where the coefficient is just an `int`.


```
sage: t = -x -1/2
sage: t
-x - 1/2
sage: t.operands()
[-x, -1/2]
sage: t.operands()[0]
-x
sage: t.operands()[0].operands()
[x, -1]
sage: t.operands()[0].operands()[1]
-1
sage: t.operands()[0].operands()[1].pyobject()
-1
sage: type(t.operands()[0].operands()[1].pyobject())
<type 'int'>
```


Of course there is a chance that this observation changed the result. :)

For `g`, this looks like a different bug:


```
sage: g
gamma(-x - 1/2)
sage: g.operands()[0]
-x - 1/2
sage: g.operands()[0].operands()
[x, -1/2]
sage: g.operands()[0].operands()[0]
x
sage: g.operands()[0].operands()[0].operands()
[]
```




---

archive/issue_comments_114005.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-10T05:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114005",
    "user": "https://github.com/burcin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_114006.json:
```json
{
    "body": "This is fixed with the patch attached to #7160. Doctests are in attachment:trac_10849-doctests.patch.",
    "created_at": "2012-01-10T05:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114006",
    "user": "https://github.com/burcin"
}
```

This is fixed with the patch attached to #7160. Doctests are in attachment:trac_10849-doctests.patch.



---

archive/issue_comments_114007.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-03T19:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114007",
    "user": "https://github.com/tkluck"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_114008.json:
```json
{
    "body": "I'll set this one to needs work because it depends on a ticket (#7160) that needs work, and it can't be reviewed before that one.",
    "created_at": "2013-01-03T19:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114008",
    "user": "https://github.com/tkluck"
}
```

I'll set this one to needs work because it depends on a ticket (#7160) that needs work, and it can't be reviewed before that one.



---

archive/issue_comments_114009.json:
```json
{
    "body": "One can also give it positive review and set it to sage-pending like at #10064.  That's a little more informative, anyway.",
    "created_at": "2013-01-03T21:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114009",
    "user": "https://github.com/kcrisman"
}
```

One can also give it positive review and set it to sage-pending like at #10064.  That's a little more informative, anyway.



---

archive/issue_comments_114010.json:
```json
{
    "body": "We'll still have to check whether the patch still applies cleanly when the other ticket has been merged (at which point a lot of unrelated changes may have made their way into Sage too). That would keep me from giving it the sort of preliminary positive review you suggest.\n\nBut if what you're saying is the standard way of handling these things, then I'll raise no objection.",
    "created_at": "2013-01-03T21:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114010",
    "user": "https://github.com/tkluck"
}
```

We'll still have to check whether the patch still applies cleanly when the other ticket has been merged (at which point a lot of unrelated changes may have made their way into Sage too). That would keep me from giving it the sort of preliminary positive review you suggest.

But if what you're saying is the standard way of handling these things, then I'll raise no objection.



---

archive/issue_comments_114011.json:
```json
{
    "body": "Replying to [comment:8 tkluck]:\n> We'll still have to check whether the patch still applies cleanly when the other ticket has been merged (at which point a lot of unrelated changes may have made their way into Sage too). That would keep me from giving it the sort of preliminary positive review you suggest.\n\nOf course you're right!  But at least this would mean that modulo those other changes, the patch does what it says.  Otherwise we might lose the info of a positive review.\n\nHow about I set it to sage-pending, and you set it to positive review if you feel that way?  :-)",
    "created_at": "2013-01-03T21:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114011",
    "user": "https://github.com/kcrisman"
}
```

Replying to [comment:8 tkluck]:
> We'll still have to check whether the patch still applies cleanly when the other ticket has been merged (at which point a lot of unrelated changes may have made their way into Sage too). That would keep me from giving it the sort of preliminary positive review you suggest.

Of course you're right!  But at least this would mean that modulo those other changes, the patch does what it says.  Otherwise we might lose the info of a positive review.

How about I set it to sage-pending, and you set it to positive review if you feel that way?  :-)



---

archive/issue_comments_114012.json:
```json
{
    "body": "Attachment [trac_10849-doctests-on_9880.patch](tarball://root/attachments/some-uuid/ticket10849/trac_10849-doctests-on_9880.patch) by @burcin created at 2013-06-03 14:14:19",
    "created_at": "2013-06-03T14:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114012",
    "user": "https://github.com/burcin"
}
```

Attachment [trac_10849-doctests-on_9880.patch](tarball://root/attachments/some-uuid/ticket10849/trac_10849-doctests-on_9880.patch) by @burcin created at 2013-06-03 14:14:19



---

archive/issue_comments_114013.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-06-03T14:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114013",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114014.json:
```json
{
    "body": "Now that #7160 is fixed, this can be reviewed. Patchbot says that the old patch applies without problems on Sage 5.10.beta4 and passes tests. I am attaching a new patch that is rebased on #9880, since both tickets add doctests to the same function and I hope #9880 will go in before this one. :)",
    "created_at": "2013-06-03T14:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114014",
    "user": "https://github.com/burcin"
}
```

Now that #7160 is fixed, this can be reviewed. Patchbot says that the old patch applies without problems on Sage 5.10.beta4 and passes tests. I am attaching a new patch that is rebased on #9880, since both tickets add doctests to the same function and I hope #9880 will go in before this one. :)



---

archive/issue_comments_114015.json:
```json
{
    "body": "This is just a doctest which passes.\n----\nNew commits:",
    "created_at": "2014-02-18T09:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114015",
    "user": "https://github.com/rwst"
}
```

This is just a doctest which passes.
----
New commits:



---

archive/issue_comments_114016.json:
```json
{
    "body": "Changing keywords from \"\" to \"doctest\".",
    "created_at": "2014-02-18T09:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114016",
    "user": "https://github.com/rwst"
}
```

Changing keywords from "" to "doctest".



---

archive/issue_comments_114017.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-18T09:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114017",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114018.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2014-02-20T17:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_114019.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-02-20T17:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114019",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_114020.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-20T17:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114020",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114021.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-20T23:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10783#issuecomment-114021",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_010911.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-02-20T23:16:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10783",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10783#event-10911"
}
```
