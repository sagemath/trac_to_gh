# Issue 13485: Rebuild GCC when Sage has been moved

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-11-06 21:52:58

Assignee: GeorgSWeber

CC:  leif

It seems `sage-location` does not properly fix GCC.  In particular, the output of `gcc -print-search-dirs` (which is used by `libtool` for example) is wrong after relocating Sage.

This can give problems in the following scenario:
 1. install Sage from source, including Sage's GCC
 2. relocate Sage
 3. rebuild PPL
 4. rebuild LinBox

The obvious solution is to rebuild GCC when needed.

Blocker because it breaks upgrading in certain cases.


---

Attachment


---

Comment by jdemeyer created at 2012-11-09 11:00:14

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-11-10 19:25:00

I haven't been able to reproduce a problem by following the directions, but I can see that some paths are wrong in `local/lib64/*.la` files, and they're fixed after upgrading from a version of Sage which includes this patch. For `libgfortran.la`, the path for `dependency_libs` is still wrong, but all of the `libdir` paths are okay. Does the wrong path for `dependency_libs` actually matter?


---

Comment by jdemeyer created at 2012-11-11 09:45:05

Replying to [comment:7 jhpalmieri]:
> I haven't been able to reproduce a problem by following the directions
Which exact version of Sage did you try?

> Does the wrong path for `dependency_libs` actually matter?
Not sure.  The main point is that this patch makes upgrading work.


---

Comment by jdemeyer created at 2012-11-11 09:49:14

Also: with #13452 and #13407, all paths would be fixed at least _after_ the build.


---

Comment by jhpalmieri created at 2012-11-11 16:23:44

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 jhpalmieri]:
> > I haven't been able to reproduce a problem by following the directions
> Which exact version of Sage did you try?

I built Sage 5.3 from scratch, moved the build directory, did `./sage -f spkg/standard/ppl-...` and `./sage -f spkg/standard/linbox-...`. No obvious errors. I also tried doing `./sage -upgrade ...`, upgrading from 5.4-rc4. This was all on sage.math.

> Also: with #13452 and #13407, all paths would be fixed at least after the build.

I'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?


---

Comment by jdemeyer created at 2012-11-12 07:36:42

Replying to [comment:10 jhpalmieri]:
> I'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?
Because I changed `sage-location` in #13407 to always relocate after the build is finished, even if no paths have changed.


---

Comment by jhpalmieri created at 2012-11-12 17:26:17

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-11-12 17:26:17

I guess I don't see anything which changes the `dependency_libs` path, before or after #13407. But that's not new to this ticket, so we won't worry about it.

The patch does fix upgrading, though, at least on sage.math. (At first I didn't see the problem because I built Sage 5.3, then _copied_ the installation elsewhere, so the hard-coded path referred to a still-existing file. When I moved the installation instead, upgrading failed unless I upgraded from a copy of 5.4.rc4 with this patch applied.)


---

Comment by jdemeyer created at 2012-11-12 21:28:53

Replying to [comment:13 jhpalmieri]:
> I guess I don't see anything which changes the `dependency_libs` path, before or after #13407.
`sage-location` doesn't specifically change `dependency_libs`, it changes the `.la` file as a whole.


---

Comment by jhpalmieri created at 2012-11-12 23:04:19

If you build sage 5.3, then move the installation, then upgrade, then dependency_libs is not fixed. The reason is that files in lib64 aren't touched by the old version of sage-location, just spkg/install, and spkg/install only fixes libdir. Then later, when sage-location is run, it looks for the path in libdir, then changes other paths in that file to match them. But once the path for dependency_libs is not in SAGE_ROOT and is not related to the path for libdir, sage-location can't fix that path.

In practice, I applied the patches here, #13407, and #13452, to sage-5.4.rc4, built a copy of sage 5.3, moved it, and upgraded it from the patched 5.4.rc4. The path for dependency_libs was not fixed.


---

Comment by jdemeyer created at 2012-11-14 08:30:32

Resolution: fixed
