# Issue 13485: Rebuild GCC when Sage has been moved

archive/issues_013485.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  leif\n\nIt seems `sage-location` does not properly fix GCC.  In particular, the output of `gcc -print-search-dirs` (which is used by `libtool` for example) is wrong after relocating Sage.\n\nThis can give problems in the following scenario:\n1. install Sage from source, including Sage's GCC\n2. relocate Sage\n3. rebuild PPL\n4. rebuild LinBox\n\nThe obvious solution is to rebuild GCC when needed.\n\nBlocker because it breaks upgrading in certain cases.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13689\n\n",
    "created_at": "2012-11-06T21:52:58Z",
    "labels": [
        "build",
        "blocker",
        "bug"
    ],
    "title": "Rebuild GCC when Sage has been moved",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13485",
    "user": "jdemeyer"
}
```
Assignee: GeorgSWeber

CC:  leif

It seems `sage-location` does not properly fix GCC.  In particular, the output of `gcc -print-search-dirs` (which is used by `libtool` for example) is wrong after relocating Sage.

This can give problems in the following scenario:
1. install Sage from source, including Sage's GCC
2. relocate Sage
3. rebuild PPL
4. rebuild LinBox

The obvious solution is to rebuild GCC when needed.

Blocker because it breaks upgrading in certain cases.

Issue created by migration from https://trac.sagemath.org/ticket/13689





---

archive/issue_comments_166305.json:
```json
{
    "body": "Attachment",
    "created_at": "2012-11-08T13:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166305",
    "user": "jdemeyer"
}
```

Attachment



---

archive/issue_comments_166306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-11-09T11:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166306",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_166307.json:
```json
{
    "body": "I haven't been able to reproduce a problem by following the directions, but I can see that some paths are wrong in `local/lib64/*.la` files, and they're fixed after upgrading from a version of Sage which includes this patch. For `libgfortran.la`, the path for `dependency_libs` is still wrong, but all of the `libdir` paths are okay. Does the wrong path for `dependency_libs` actually matter?",
    "created_at": "2012-11-10T19:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166307",
    "user": "jhpalmieri"
}
```

I haven't been able to reproduce a problem by following the directions, but I can see that some paths are wrong in `local/lib64/*.la` files, and they're fixed after upgrading from a version of Sage which includes this patch. For `libgfortran.la`, the path for `dependency_libs` is still wrong, but all of the `libdir` paths are okay. Does the wrong path for `dependency_libs` actually matter?



---

archive/issue_comments_166308.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> I haven't been able to reproduce a problem by following the directions\nWhich exact version of Sage did you try?\n\n> Does the wrong path for `dependency_libs` actually matter?\nNot sure.  The main point is that this patch makes upgrading work.",
    "created_at": "2012-11-11T09:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166308",
    "user": "jdemeyer"
}
```

Replying to [comment:7 jhpalmieri]:
> I haven't been able to reproduce a problem by following the directions
Which exact version of Sage did you try?

> Does the wrong path for `dependency_libs` actually matter?
Not sure.  The main point is that this patch makes upgrading work.



---

archive/issue_comments_166309.json:
```json
{
    "body": "Also: with #13452 and #13407, all paths would be fixed at least *after* the build.",
    "created_at": "2012-11-11T09:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166309",
    "user": "jdemeyer"
}
```

Also: with #13452 and #13407, all paths would be fixed at least *after* the build.



---

archive/issue_comments_166310.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 jhpalmieri]:\n> > I haven't been able to reproduce a problem by following the directions\n> Which exact version of Sage did you try?\n\nI built Sage 5.3 from scratch, moved the build directory, did `./sage -f spkg/standard/ppl-...` and `./sage -f spkg/standard/linbox-...`. No obvious errors. I also tried doing `./sage -upgrade ...`, upgrading from 5.4-rc4. This was all on sage.math.\n\n> Also: with #13452 and #13407, all paths would be fixed at least after the build.\n\nI'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?",
    "created_at": "2012-11-11T16:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166310",
    "user": "jhpalmieri"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 jhpalmieri]:
> > I haven't been able to reproduce a problem by following the directions
> Which exact version of Sage did you try?

I built Sage 5.3 from scratch, moved the build directory, did `./sage -f spkg/standard/ppl-...` and `./sage -f spkg/standard/linbox-...`. No obvious errors. I also tried doing `./sage -upgrade ...`, upgrading from 5.4-rc4. This was all on sage.math.

> Also: with #13452 and #13407, all paths would be fixed at least after the build.

I'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?



---

archive/issue_comments_166311.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> I'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?\nBecause I changed `sage-location` in #13407 to always relocate after the build is finished, even if no paths have changed.",
    "created_at": "2012-11-12T07:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166311",
    "user": "jdemeyer"
}
```

Replying to [comment:10 jhpalmieri]:
> I'm not sure about that. When you upgrade, the old sage-location script is run so sage-current-location.txt is changed but a few paths aren't, so how can those old paths ever be fixed?
Because I changed `sage-location` in #13407 to always relocate after the build is finished, even if no paths have changed.



---

archive/issue_comments_166312.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-11-12T17:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166312",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_166313.json:
```json
{
    "body": "I guess I don't see anything which changes the `dependency_libs` path, before or after #13407. But that's not new to this ticket, so we won't worry about it.\n\nThe patch does fix upgrading, though, at least on sage.math. (At first I didn't see the problem because I built Sage 5.3, then *copied* the installation elsewhere, so the hard-coded path referred to a still-existing file. When I moved the installation instead, upgrading failed unless I upgraded from a copy of 5.4.rc4 with this patch applied.)",
    "created_at": "2012-11-12T17:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166313",
    "user": "jhpalmieri"
}
```

I guess I don't see anything which changes the `dependency_libs` path, before or after #13407. But that's not new to this ticket, so we won't worry about it.

The patch does fix upgrading, though, at least on sage.math. (At first I didn't see the problem because I built Sage 5.3, then *copied* the installation elsewhere, so the hard-coded path referred to a still-existing file. When I moved the installation instead, upgrading failed unless I upgraded from a copy of 5.4.rc4 with this patch applied.)



---

archive/issue_comments_166314.json:
```json
{
    "body": "Replying to [comment:13 jhpalmieri]:\n> I guess I don't see anything which changes the `dependency_libs` path, before or after #13407.\n`sage-location` doesn't specifically change `dependency_libs`, it changes the `.la` file as a whole.",
    "created_at": "2012-11-12T21:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166314",
    "user": "jdemeyer"
}
```

Replying to [comment:13 jhpalmieri]:
> I guess I don't see anything which changes the `dependency_libs` path, before or after #13407.
`sage-location` doesn't specifically change `dependency_libs`, it changes the `.la` file as a whole.



---

archive/issue_comments_166315.json:
```json
{
    "body": "If you build sage 5.3, then move the installation, then upgrade, then dependency_libs is not fixed. The reason is that files in lib64 aren't touched by the old version of sage-location, just spkg/install, and spkg/install only fixes libdir. Then later, when sage-location is run, it looks for the path in libdir, then changes other paths in that file to match them. But once the path for dependency_libs is not in SAGE_ROOT and is not related to the path for libdir, sage-location can't fix that path.\n\nIn practice, I applied the patches here, #13407, and #13452, to sage-5.4.rc4, built a copy of sage 5.3, moved it, and upgraded it from the patched 5.4.rc4. The path for dependency_libs was not fixed.",
    "created_at": "2012-11-12T23:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166315",
    "user": "jhpalmieri"
}
```

If you build sage 5.3, then move the installation, then upgrade, then dependency_libs is not fixed. The reason is that files in lib64 aren't touched by the old version of sage-location, just spkg/install, and spkg/install only fixes libdir. Then later, when sage-location is run, it looks for the path in libdir, then changes other paths in that file to match them. But once the path for dependency_libs is not in SAGE_ROOT and is not related to the path for libdir, sage-location can't fix that path.

In practice, I applied the patches here, #13407, and #13452, to sage-5.4.rc4, built a copy of sage 5.3, moved it, and upgraded it from the patched 5.4.rc4. The path for dependency_libs was not fixed.



---

archive/issue_comments_166316.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-14T08:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13485#issuecomment-166316",
    "user": "jdemeyer"
}
```

Resolution: fixed
