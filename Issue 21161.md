# Issue 21161: Fix doctest failure in doctest.forker on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-09-02 14:12:31

CC:  tscrim gouezel jpflori

Keywords: windows cygwin doctest tempfile

Unfortunately this is one I don't fully understand.  At its core, this issue here is that on Windows (including Cygwin), the `tempfile.TemporaryFile` class is just an alias for `tempfile.NamedTemporaryFile`:  https://hg.python.org/cpython/file/2.7/Lib/tempfile.py#l484

This is a bit unfortunate because the two don't have fully compatible interfaces.  At any rate, a major difference between the two is that in `NamedTemporaryFile.close()` the file is deleted after the object is closed (this of course assumes the file isn't being deleted before the handle is closed).  This was leading, in these tests to `OSError` exceptions being printed to stderr, related to deleting a file that didn't already exist.  Because these exceptions were coming from a `__del__` the exception is not raised, but just printed.  This caused unpredictable test failures later on, due to the error messages being randomly inserted into test output.

The part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.  I couldn't find any place in our code that would explicitly delete them (not even `atexit` handlers).  Nor do I think the OS should be deleting them.  So that's a bit disconcerting.

I found this one place where explicitly using a `with` statement to ensure that the file was closed as soon as it was done with did the trick.  There are probably other places that could be more explicit about cleanup, but after fixing this one spot I was not able to reproduce the problem again.


---

Comment by embray created at 2016-09-02 14:12:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-09-02 15:30:39

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-09-02 15:30:39

Makes sense regardless of Cygwin issues.


---

Comment by jdemeyer created at 2016-09-02 15:42:16

Replying to [ticket:21398 embray]:
> The part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.

Just a guess: maybe it has to do with the fact that the doctester forks and that the file is deleted by each forked subprocess?


---

Comment by embray created at 2016-09-02 18:02:39

That was what I figured, but I couldn't find anything that would actually delete that file.  It's just a random temp file in `/tmp`--the subprocesses wouldn't even know about it.  I suppose maybe if I ran an `strace` on it that _might_ offer some hints, but it's not worth it now.


---

Comment by vbraun created at 2016-09-04 00:13:10

Resolution: fixed
