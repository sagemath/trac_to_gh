# Issue 30282: Fix check of orientation in volume form

Issue created by migration from https://trac.sagemath.org/ticket/30519

Original creator: egourgoulhon

Original creation time: 2020-09-06 20:18:10

CC:  @mjungmath tscrim

Keywords: orientation, volume_form

After the introduction of manifold orientation in #30178, attempting
to get the volume form of a metric on a manifold without any predefined orientation yields a weird error message:

```
sage: M = Manifold(2, 'M', structure='Riemannian')  # the 2-sphere
sage: U = M.open_subset('U'); V = M.open_subset('V')
sage: M.declare_union(U, V)
sage: c_xy.<x,y> = U.chart() # stereographic coord. from the North pole
sage: c_uv.<u,v> = V.chart() # stereographic coord. from the South pole
sage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),
....:                intersection_name='W', restrictions1= x^2+y^2!=0,
....:                restrictions2= u^2+v^2!=0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: eU = c_xy.frame(); eV = c_uv.frame()
sage: g = M.metric()
sage: g[eU,0,0], g[eU,1,1] = 4/(1+x^2+y^2)^2, 4/(1+x^2+y^2)^2
sage: g.add_comp_by_continuation(eV, U.intersection(V), chart=c_uv)
sage: g.volume_form()
Traceback (most recent call last):
...
IndexError: list index out of range
```

This surprising error message (which list index?) is due to a bad check for an orientation in `PseudoRiemannianMetric.volume_form()`; the fix is 

```diff
-        if orient is None:
+        if not orient:
```

Indeed, the attribute `_orientation` of manifolds is initialized as `[]`, not as `None`. With the fix, the error message is more expressive:

```
ValueError: 2-dimensional Riemannian manifold M must admit an orientation
```

In addition to the above fix, with a new doctest checking it, this ticket corrects some mistake in the documentation illustrating the choice of an orientation on the 2-sphere in the docstring of class `PseudoRiemannianMetric`: 

```
sage: M.set_orientation([c_xy, c_uv])
```

does not define a valid orientation because the stereographic frames from the North and South poles have opposite orientations, the Jacobian of the transition map `c_xy` --> `c_uv` being negative. It is replaced here by

```
sage: f = U.vector_frame('f', (eU[2], eU[1]))
sage: M.set_orientation([eV, f])
```



---

Comment by egourgoulhon created at 2020-09-06 20:20:04

New commits:


---

Comment by egourgoulhon created at 2020-09-06 20:21:41

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2020-09-06 20:58:29

Thank you so much for catching this bug!

Of course, the orientation changes when using stereographic projections! I just haven't thought about it in the first place, thank you for catching this, too.

This is indeed a nice improvement of the documentation as well.

---

Just one minor thing. I made the same mistake in `diff_form.py`:


```diff
diff --git a/src/sage/manifolds/differentiable/diff_form.py b/src/sage/manifolds/differentiable/diff_form.py
index 417183a..f0855ad 100644
--- a/src/sage/manifolds/differentiable/diff_form.py
+++ b/src/sage/manifolds/differentiable/diff_form.py
@@ -646,6 +646,7 @@ class DiffForm(TensorField):
             sage: uv_to_xy = xy_to_uv.inverse()
             sage: W = U.intersection(V) # The complement of the two poles
             sage: eU = c_xy.frame() ; eV = c_uv.frame()
+            sage: M.set_orientation([eU, eV])  # make M orientable
             sage: g = M.metric('g')
             sage: g[eU,1,1], g[eU,2,2] = 4/(1+x^2+y^2)^2, 4/(1+x^2+y^2)^2
             sage: g[eV,1,1], g[eV,2,2] = 4/(1+u^2+v^2)^2, 4/(1+u^2+v^2)^2
```



---

Comment by tscrim created at 2020-09-06 22:19:33

Replying to [ticket:30519 egourgoulhon]:
> In addition to the above fix, with a new doctest checking it, this ticket corrects some mistake in the documentation illustrating the choice of an orientation on the 2-sphere in the docstring of class `PseudoRiemannianMetric`: 
> {{{
> sage: M.set_orientation([c_xy, c_uv])
> }}}
> does not define a valid orientation because the stereographic frames from the North and South poles have opposite orientations, the Jacobian of the transition map `c_xy` --> `c_uv` being negative. It is replaced here by
> {{{
> sage: f = U.vector_frame('f', (eU[2], eU[1]))
> sage: M.set_orientation([eV, f])
> }}}

I recently noticed this while teaching my class as well and was going to tell you. Thank you for catching this and fixing it.


---

Comment by git created at 2020-09-06 22:39:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2020-09-06 22:42:20

Replying to [comment:3 gh-mjungmath]:
> Just one minor thing. I made the same mistake in `diff_form.py`:
Thanks for pointing this out; it's corrected in the latest commit.


---

Comment by egourgoulhon created at 2020-09-06 22:55:32

Replying to [comment:3 gh-mjungmath]:
> Thank you so much for catching this bug!

You're welcome. Thanks to you for having introduced orientations on manifolds. They were really missing!
> 
> Of course, the orientation changes when using stereographic projections! I just haven't thought about it in the first place,
No problem. The error was already there, when the volume form took the same shape, with the same sign, in the two stereographic frames. Same thing in the [S^2 example notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_sphere_S2.ipynb), which I am going to correct tomorrow.


---

Comment by @mjungmath created at 2020-09-06 23:11:30

Perfect. Thank you.

LGTM.


---

Comment by @mjungmath created at 2020-09-06 23:11:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-07 03:50:18

Changing priority from major to critical.


---

Comment by egourgoulhon created at 2020-09-07 07:57:54

Thank you for the review!


---

Comment by egourgoulhon created at 2020-09-07 15:09:53

Replying to [comment:7 egourgoulhon]:
>Same thing in the [S^2 example notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_sphere_S2.ipynb), which I am going to correct tomorrow.  
Done; see cells [221] and below.


---

Comment by vbraun created at 2020-09-15 22:01:02

Resolution: fixed
