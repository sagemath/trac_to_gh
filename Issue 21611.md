# Issue 21611: Build failure on Cygwin when linking with Singular 4

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-11-09 12:42:36

The failure looks like this:


```
[sagelib-7.5.beta1] g++ -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.5.1-x86_64-2.7/home/embray/src/sagemath/sage/src/build/cythonized/sage/libs/singular/function.o -L/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib/python2.7/config -L/home/embray/src/sagemath/sage/local/lib -lomalloc -lSingular -lpolys -lfactory -lresources -lntl -lflint -lmpfr -lgmp -lstdc++ -lpython2.7 -o build/lib.cygwin-2.5.1-x86_64-2.7/sage/libs/singular/function.dll -lpari -Ddummy
[sagelib-7.5.beta1] /home/embray/src/sagemath/sage/local/lib/libSingular.a(feread.o): In function `fe_fgets_stdin_rl':
[sagelib-7.5.beta1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/singular-4.0.3p3/src/latest/kernel/oswrapper/feread.cc:218: undefined reference to `readline'
[sagelib-7.5.beta1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/singular-4.0.3p3/src/latest/kernel/oswrapper/feread.cc:218:(.text+0x36): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `readline'
[sagelib-7.5.beta1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/singular-4.0.3p3/src/latest/kernel/oswrapper/feread.cc:228: undefined reference to `add_history'
...
```


with several more undefined references, all of which look like they belong to readline.

Manually adding `-lreadline` worked around the problem, but I haven't looked deeply into why this is needed.


---

Comment by embray created at 2016-11-10 12:19:17

Part of the issue here is that libSingular is not being built as a shared library (at least on on Cygwin).  Is this supposed to be the case, or is there an issue with Singular 4?


---

Comment by embray created at 2016-11-10 14:23:35

I think, at a bare minimum, the `LT_INIT` calls in all the `configure.ac`s in singular should look like:


```
LT_INIT([win32-dll])
```


in order to support properly linking and building DLLs with libtool on Windows.


---

Comment by embray created at 2016-11-16 12:00:51

I added `LT_INIT([win32-dll])` to all the `configure.ac`s and ran reconfigure, but that didn't quite do it.  Upon building the first "sub-component" (for lack of a better term?) of Singular, "resources", I get:


```
make  all-am
make[3]: Entering directory '/home/embray/src/sagemath/sage/local/var/tmp/sage/build/singular-4.0.3p3/src/latest/resources'
  CC       omFindExec.lo
  CXX      feResource.lo
  CXX      feFopen.lo
  CXXLD    libresources.la
libtool: warning: undefined symbols not allowed in x86_64-unknown-cygwin shared libraries; building static only
```


This I know is true--ELF shared libraries are allowed to have undefined symbols in them at link time, but DLLs are not.  I'm not sure what undefined symbols it's complaining about in this case though.  Comparing the linux, most (all?) of the undefined symbols in `libsingular_resources.so` are just libc stuff, which when building on Cygwin should be resolved at link time anyways.  So I'll need to try enabling libtool debugging and see if I can find out more.


---

Comment by embray created at 2016-11-18 13:32:54

The problems with the Singular build go quite deep.  There are several issues, but chief among them is a bit of carelessness when linking the numerous libraries that make up Singular.  This carelessness can be forgiven, because on Linux it's perfectly valid to leave some symbols unresolved at link time for shared libraries.  Windows, unfortunately, is much stricter about this and requires every symbol in a DLL to be resolved at link time, and there are a number of examples of this.

libtool, meanwhile, is a bit overly aggressive and will refuse to build a shared lib if it even _thinks_ there are symbols that won't be resolved at link time, but I think it can be mistaken about this sometimes (I'm not sure exactly why).  For example, in the case of libresources above, it only depends on libc, but libtool still complains (even though it will be linked with libc automatically).  To get around this, per libtool's own docs, it's necessary to pass `-no-undefined` to libtool at link time.  Then the onus is just on us to make sure there are _actually_ no unresolved symbols.  For most of Singular's subpackages this fixes it outright, but there are a few that are still broken.  In particular, libraries under `Singular/dyn_modules` which depend on libSingular but are built _before_ libSingular.  I'm seeing now if it's possible to build libSingular first to get around that.


---

Comment by embray created at 2017-04-11 14:14:11

This should actually be fixed in #22425.  I'm not directly aware of any build issues in the current version of Singular that wouldn't have been fixed by that upgrade.


---

Comment by embray created at 2017-04-11 14:14:11

Resolution: worksforme
