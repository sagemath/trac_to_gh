# Issue 31664: Chart: UniqueRepresentation fixes

archive/issues_031664.json:
```json
{
    "body": "CC:  egourgoulhon tscrim @mjungmath\n\nChart is missing `__classcall__` to normalize init arguments.\n\nPerhaps all string parsing in `_init_coordinates` should already be done in `__classcall__`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31901\n\n",
    "created_at": "2021-06-03T21:51:56Z",
    "labels": [
        "manifolds",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "Chart: UniqueRepresentation fixes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31664",
    "user": "mkoeppe"
}
```
CC:  egourgoulhon tscrim @mjungmath

Chart is missing `__classcall__` to normalize init arguments.

Perhaps all string parsing in `_init_coordinates` should already be done in `__classcall__`.

Issue created by migration from https://trac.sagemath.org/ticket/31901





---

archive/issue_comments_452298.json:
```json
{
    "body": "Replying to [ticket:31901 mkoeppe]:\n> In this ticket,\n> - we make it possible to pass the codomain restrictions already when initializing the chart\nThis would be nice! In the early stages of the manifold project, I did not manage to do it simply, i.e. without changing Sage's preparser, since\n\n```\nsage: D = Manifold(2, 'D')                                                                          \nsage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 \n```\n\nwould generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `\"x^2 + y^2 < 1\"`, but this is not very user-friendly. Do you already have some solution in mind?",
    "created_at": "2021-06-24T10:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452298",
    "user": "egourgoulhon"
}
```

Replying to [ticket:31901 mkoeppe]:
> In this ticket,
> - we make it possible to pass the codomain restrictions already when initializing the chart
This would be nice! In the early stages of the manifold project, I did not manage to do it simply, i.e. without changing Sage's preparser, since

```
sage: D = Manifold(2, 'D')                                                                          
sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 
```

would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `"x^2 + y^2 < 1"`, but this is not very user-friendly. Do you already have some solution in mind?



---

archive/issue_comments_452299.json:
```json
{
    "body": "Some thought: if `UniqueRepresentation` is abandoned for charts, it may be desirable to maintain `WithEqualityById` (one of the two mother classes of `UniqueRepresentation`) to have a fast equality operator. Indeed charts are heavily used as dictionary keys: for coordinates of manifold points, for coordinate expressions of scalar fields (the latter being used, among other things, to store the components of tensor fields), for coordinate expressions of continuous maps between manifolds (the keys being pairs of charts in that case), etc. Certainly `WithEqualityById` is the fastest equality operator and thus provides a fast access to the above dictionaries.",
    "created_at": "2021-06-24T12:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452299",
    "user": "egourgoulhon"
}
```

Some thought: if `UniqueRepresentation` is abandoned for charts, it may be desirable to maintain `WithEqualityById` (one of the two mother classes of `UniqueRepresentation`) to have a fast equality operator. Indeed charts are heavily used as dictionary keys: for coordinates of manifold points, for coordinate expressions of scalar fields (the latter being used, among other things, to store the components of tensor fields), for coordinate expressions of continuous maps between manifolds (the keys being pairs of charts in that case), etc. Certainly `WithEqualityById` is the fastest equality operator and thus provides a fast access to the above dictionaries.



---

archive/issue_comments_452300.json:
```json
{
    "body": "Replying to [comment:2 egourgoulhon]:\n> Replying to [ticket:31901 mkoeppe]:\n> {{{\n> sage: D = Manifold(2, 'D')                                                                          \n> sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 \n> }}}\n> would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `\"x^2 + y^2 < 1\"`, but this is not very user-friendly. Do you already have some solution in mind?\n>  \nAh! That's of course a problem, I didn't realize this",
    "created_at": "2021-06-24T16:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452300",
    "user": "mkoeppe"
}
```

Replying to [comment:2 egourgoulhon]:
> Replying to [ticket:31901 mkoeppe]:
> {{{
> sage: D = Manifold(2, 'D')                                                                          
> sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 
> }}}
> would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `"x^2 + y^2 < 1"`, but this is not very user-friendly. Do you already have some solution in mind?
>  
Ah! That's of course a problem, I didn't realize this



---

archive/issue_comments_452301.json:
```json
{
    "body": "Maybe a chart should become immutable \"upon first use\"?",
    "created_at": "2021-06-24T17:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452301",
    "user": "mkoeppe"
}
```

Maybe a chart should become immutable "upon first use"?



---

archive/issue_comments_452302.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-24T18:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452302",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_452303.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-06-30T02:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452303",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_452304.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-30T02:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452304",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452305.json:
```json
{
    "body": "The last obstacle is this code which tries to hash a chart when it is still mutable.\n\n```\n        # The null and one functions of the coordinates:\n        # Expression in self of the zero and one scalar fields of open sets\n        # containing the domain of self:\n        for dom in self.open_supersets():\n            dom._zero_scalar_field._express[chart] = chart.function_ring().zero()\n            dom._one_scalar_field._express[chart] = chart.function_ring().one()\n```\n",
    "created_at": "2021-06-30T02:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452305",
    "user": "mkoeppe"
}
```

The last obstacle is this code which tries to hash a chart when it is still mutable.

```
        # The null and one functions of the coordinates:
        # Expression in self of the zero and one scalar fields of open sets
        # containing the domain of self:
        for dom in self.open_supersets():
            dom._zero_scalar_field._express[chart] = chart.function_ring().zero()
            dom._one_scalar_field._express[chart] = chart.function_ring().one()
```




---

archive/issue_comments_452306.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-30T05:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452306",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452307.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Maybe a chart should become immutable \"upon first use\"? \n\nThis is the approach that I have been trying out in this branch. \nBut it does not work in examples like this one:\n\n```\n            sage: M = Manifold(2, 'M', structure='topological')\n            sage: X.<x,y> = M.chart()\n            sage: U = M.open_subset('U', coord_def={X: [x>1, y<pi]})\n```\n\nbecause `X` in `coord_def` is unhashable, leading to an error.\n\nSo perhaps an API change is needed, after all...",
    "created_at": "2021-06-30T05:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452307",
    "user": "mkoeppe"
}
```

Replying to [comment:6 mkoeppe]:
> Maybe a chart should become immutable "upon first use"? 

This is the approach that I have been trying out in this branch. 
But it does not work in examples like this one:

```
            sage: M = Manifold(2, 'M', structure='topological')
            sage: X.<x,y> = M.chart()
            sage: U = M.open_subset('U', coord_def={X: [x>1, y<pi]})
```

because `X` in `coord_def` is unhashable, leading to an error.

So perhaps an API change is needed, after all...



---

archive/issue_comments_452308.json:
```json
{
    "body": "In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? In particular in view of comment:3.\n\nIn the code of `__hash__`, isn't\n\n```\nif not self.is_immutable():\n    raise TypeError('Charts are unhashable until set_immutable() has been called')\n```\n\nan unnecessary limitation? \nMore generally, why do you want to make `Chart` mutable? It is logically immutable: a chart is entirely defined by its domain and its coordinates (i.e. a tuple of symbolic variables). Coordinate restrictions, which can be added only after `__init__` via `add_restrictions` in the current implementation, do not (mathematically) modify the object: there cannot be two charts with the same domain and the same coordinates, but with different coordinate restrictions.",
    "created_at": "2021-06-30T07:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452308",
    "user": "egourgoulhon"
}
```

In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? In particular in view of comment:3.

In the code of `__hash__`, isn't

```
if not self.is_immutable():
    raise TypeError('Charts are unhashable until set_immutable() has been called')
```

an unnecessary limitation? 
More generally, why do you want to make `Chart` mutable? It is logically immutable: a chart is entirely defined by its domain and its coordinates (i.e. a tuple of symbolic variables). Coordinate restrictions, which can be added only after `__init__` via `add_restrictions` in the current implementation, do not (mathematically) modify the object: there cannot be two charts with the same domain and the same coordinates, but with different coordinate restrictions.



---

archive/issue_comments_452309.json:
```json
{
    "body": "A possible option to get rid of the 2-stages construction of a chart (i.e. to get rid of the requirement of invoking `add_restriction` after `__init__`) could be to add the keyword argument `restrictions` to `Chart.__init__`, which can be either \n- a string (case with no predefined coordinate variables, i.e. chart created from scratch)\n- a nested list/tuple of symbolic expressions (case of a chart created from another one, as in `Chart.restrict`)\nAfter all, when creating a chart from scratch, we are already passing a string if we want to specify the coordinate ranges and LaTeX symbols; so maybe we could admit having a second string...\nFor instance, we could have something like\n\n```\nsage: H = Manifold(2, 'H')  # half-disk\nsage: X.<x,y> = H.chart(r\"x y:(0,+oo)\", restrictions=\"x^2 + y^2 < 1\")\n```\n\nor equivalently\n\n```\nsage: X.<x,y> = H.chart(restrictions=\"[x^2 + y^2 < 1, y>0]\")\n```\n\nThen we could get rid of the method `add_restriction` and consider that the chart is a fully immutable object (of course, technically speaking, the sheafy attributes can be muted).",
    "created_at": "2021-06-30T10:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452309",
    "user": "egourgoulhon"
}
```

A possible option to get rid of the 2-stages construction of a chart (i.e. to get rid of the requirement of invoking `add_restriction` after `__init__`) could be to add the keyword argument `restrictions` to `Chart.__init__`, which can be either 
- a string (case with no predefined coordinate variables, i.e. chart created from scratch)
- a nested list/tuple of symbolic expressions (case of a chart created from another one, as in `Chart.restrict`)
After all, when creating a chart from scratch, we are already passing a string if we want to specify the coordinate ranges and LaTeX symbols; so maybe we could admit having a second string...
For instance, we could have something like

```
sage: H = Manifold(2, 'H')  # half-disk
sage: X.<x,y> = H.chart(r"x y:(0,+oo)", restrictions="x^2 + y^2 < 1")
```

or equivalently

```
sage: X.<x,y> = H.chart(restrictions="[x^2 + y^2 < 1, y>0]")
```

Then we could get rid of the method `add_restriction` and consider that the chart is a fully immutable object (of course, technically speaking, the sheafy attributes can be muted).



---

archive/issue_comments_452310.json:
```json
{
    "body": "Replying to [comment:15 egourgoulhon]:\n> In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? \n\nYes, this part is not finished. I started with `WithEqualityById` as per your suggestion, but I wanted to implement actual pickling (not just passing the pickling-related testsuite) as a step to actual pickling of manifolds. Then the identity and unique-representation tricks are not sufficient any more, and one needs to implement full comparison.\n\nOne can still have a fast path for equality using id, and fast lookup in sets etc. via a fast hash.",
    "created_at": "2021-07-02T18:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452310",
    "user": "mkoeppe"
}
```

Replying to [comment:15 egourgoulhon]:
> In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? 

Yes, this part is not finished. I started with `WithEqualityById` as per your suggestion, but I wanted to implement actual pickling (not just passing the pickling-related testsuite) as a step to actual pickling of manifolds. Then the identity and unique-representation tricks are not sufficient any more, and one needs to implement full comparison.

One can still have a fast path for equality using id, and fast lookup in sets etc. via a fast hash.



---

archive/issue_comments_452311.json:
```json
{
    "body": "Replying to [comment:15 egourgoulhon]:\n> More generally, why do you want to make `Chart` mutable? \n\nI don't really, it was just an attempt to keep the current API (initialization, followed by `add_restrictions`) but implementing pickling.",
    "created_at": "2021-07-02T18:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452311",
    "user": "mkoeppe"
}
```

Replying to [comment:15 egourgoulhon]:
> More generally, why do you want to make `Chart` mutable? 

I don't really, it was just an attempt to keep the current API (initialization, followed by `add_restrictions`) but implementing pickling.



---

archive/issue_comments_452312.json:
```json
{
    "body": "When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n\nAre two charts with a different tuple of variables allowed to share some variables? If yes, does the shared variable have to have the same global assumptions and periodicity?\n\nAlso I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.",
    "created_at": "2021-07-02T18:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452312",
    "user": "mkoeppe"
}
```

When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.

Are two charts with a different tuple of variables allowed to share some variables? If yes, does the shared variable have to have the same global assumptions and periodicity?

Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.



---

archive/issue_comments_452313.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-02T18:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452313",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452314.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> \n> Are two charts with a different tuple of variables allowed to share some variables? \n\nYes, definitely. This is a desirable feature.\n\n> If yes, does the shared variable have to have the same global assumptions and periodicity?\n\nNo (see below).\n> \n> Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.\n\nYes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n\nA connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\n>",
    "created_at": "2021-07-02T20:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452314",
    "user": "egourgoulhon"
}
```

Replying to [comment:19 mkoeppe]:
> When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> 
> Are two charts with a different tuple of variables allowed to share some variables? 

Yes, definitely. This is a desirable feature.

> If yes, does the shared variable have to have the same global assumptions and periodicity?

No (see below).
> 
> Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.

Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 

A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

>



---

archive/issue_comments_452315.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> Replying to [comment:19 mkoeppe]:\n> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> > \n> > Are two charts with a different tuple of variables allowed to share some variables? \n> \n> Yes, definitely. This is a desirable feature.\n> \n> > If yes, does the shared variable have to have the same global assumptions and periodicity?\n> \n> No (see below).\n\nOK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n\nThen the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)\n\nWe could deprecate `add_restrictions` then.",
    "created_at": "2021-07-02T20:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452315",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> Replying to [comment:19 mkoeppe]:
> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> > 
> > Are two charts with a different tuple of variables allowed to share some variables? 
> 
> Yes, definitely. This is a desirable feature.
> 
> > If yes, does the shared variable have to have the same global assumptions and periodicity?
> 
> No (see below).

OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.

Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)

We could deprecate `add_restrictions` then.



---

archive/issue_comments_452316.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> Replying to [comment:19 mkoeppe]:\n> > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]\n> Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n\nThere is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.\n\nThe tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. A possible route is through #32089.",
    "created_at": "2021-07-02T20:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452316",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> Replying to [comment:19 mkoeppe]:
> > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]
> Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 

There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.

The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. A possible route is through #32089.



---

archive/issue_comments_452317.json:
```json
{
    "body": "I have opened #32102 (`Chart`: Add init argument `coord_restrictions`, deprecate method `add_restrictions`)",
    "created_at": "2021-07-02T20:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452317",
    "user": "mkoeppe"
}
```

I have opened #32102 (`Chart`: Add init argument `coord_restrictions`, deprecate method `add_restrictions`)



---

archive/issue_comments_452318.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\nI suppose we can go through a new method `assuming` of `CalculusMethod` that dispatches in the same way as the `simplify` method does.",
    "created_at": "2021-07-02T20:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452318",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

I suppose we can go through a new method `assuming` of `CalculusMethod` that dispatches in the same way as the `simplify` method does.



---

archive/issue_comments_452319.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> \n> OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n\nThe issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. For some reason, it is not equivalent to `assume(x, 'real')`, which is performed in `RealChart._init_coordinates` as well. Both proved to be necessary for some simplifications.\n\n> \n> Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)\n\nI don't like strings either, but I would prefer this to a 2-stage declaration involving `var`. Anyway, let us continue the discussion on #32102.\n> \n> We could deprecate `add_restrictions` then.\n\nYes.",
    "created_at": "2021-07-02T21:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452319",
    "user": "egourgoulhon"
}
```

Replying to [comment:22 mkoeppe]:
> 
> OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.

The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. For some reason, it is not equivalent to `assume(x, 'real')`, which is performed in `RealChart._init_coordinates` as well. Both proved to be necessary for some simplifications.

> 
> Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)

I don't like strings either, but I would prefer this to a 2-stage declaration involving `var`. Anyway, let us continue the discussion on #32102.
> 
> We could deprecate `add_restrictions` then.

Yes.



---

archive/issue_comments_452320.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> Replying to [comment:21 egourgoulhon]:\n> > Replying to [comment:19 mkoeppe]:\n> > > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]\n> > Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n> \n> There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.\n> \n> The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n\nI don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.",
    "created_at": "2021-07-02T21:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452320",
    "user": "egourgoulhon"
}
```

Replying to [comment:23 mkoeppe]:
> Replying to [comment:21 egourgoulhon]:
> > Replying to [comment:19 mkoeppe]:
> > > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]
> > Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 
> 
> There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.
> 
> The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 

I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.



---

archive/issue_comments_452321.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> Replying to [comment:19 mkoeppe]:\n> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> > \n> > Are two charts with a different tuple of variables allowed to share some variables? \n> \n> Yes, definitely. This is a desirable feature.\n\nA follow-up question on this:\n\n```\nsage: M = Manifold(2, 'M', structure='topological')\n....: U = M.open_subset('U')\n....: V = M.open_subset('V')\nsage: XU = U.chart(names=(\"x\", \"y\"))\nsage: XV = V.chart(names=(\"x\", \"y\"))\nsage: M.atlas()\n[Chart (U, (x, y)), Chart (V, (x, y))]\nsage: M.top_charts()\n[Chart (U, (x, y))]\n```\n\nClearly something went wrong here. \nShould there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?",
    "created_at": "2021-07-03T00:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452321",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> Replying to [comment:19 mkoeppe]:
> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> > 
> > Are two charts with a different tuple of variables allowed to share some variables? 
> 
> Yes, definitely. This is a desirable feature.

A follow-up question on this:

```
sage: M = Manifold(2, 'M', structure='topological')
....: U = M.open_subset('U')
....: V = M.open_subset('V')
sage: XU = U.chart(names=("x", "y"))
sage: XV = V.chart(names=("x", "y"))
sage: M.atlas()
[Chart (U, (x, y)), Chart (V, (x, y))]
sage: M.top_charts()
[Chart (U, (x, y))]
```

Clearly something went wrong here. 
Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?



---

archive/issue_comments_452322.json:
```json
{
    "body": "Replying to [comment:26 egourgoulhon]:\n> Replying to [comment:22 mkoeppe]:\n> I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n> \n> The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. \n\nHow about something like `M.var('x y z')` then?",
    "created_at": "2021-07-03T01:18:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452322",
    "user": "mkoeppe"
}
```

Replying to [comment:26 egourgoulhon]:
> Replying to [comment:22 mkoeppe]:
> I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.
> 
> The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. 

How about something like `M.var('x y z')` then?



---

archive/issue_comments_452323.json:
```json
{
    "body": "Replying to [comment:28 mkoeppe]:\n> \n> A follow-up question on this:\n> {{{\n> sage: M = Manifold(2, 'M', structure='topological')\n> ....: U = M.open_subset('U')\n> ....: V = M.open_subset('V')\n> sage: XU = U.chart(names=(\"x\", \"y\"))\n> sage: XV = V.chart(names=(\"x\", \"y\"))\n> sage: M.atlas()\n> [Chart (U, (x, y)), Chart (V, (x, y))]\n> sage: M.top_charts()\n> [Chart (U, (x, y))]\n> }}}\n> Clearly something went wrong here. \n\nGood catch!\n\n> Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?\n\nNo, the above is actually a bug in `Chart.__init__`. I've opened #32112 for it and submitted a fix there.",
    "created_at": "2021-07-03T14:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452323",
    "user": "egourgoulhon"
}
```

Replying to [comment:28 mkoeppe]:
> 
> A follow-up question on this:
> {{{
> sage: M = Manifold(2, 'M', structure='topological')
> ....: U = M.open_subset('U')
> ....: V = M.open_subset('V')
> sage: XU = U.chart(names=("x", "y"))
> sage: XV = V.chart(names=("x", "y"))
> sage: M.atlas()
> [Chart (U, (x, y)), Chart (V, (x, y))]
> sage: M.top_charts()
> [Chart (U, (x, y))]
> }}}
> Clearly something went wrong here. 

Good catch!

> Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?

No, the above is actually a bug in `Chart.__init__`. I've opened #32112 for it and submitted a fix there.



---

archive/issue_comments_452324.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-03T18:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452324",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-03T18:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452325",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_452326.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> > creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart.\n> \n> The assumptions should not be global but chart-wise. \n\nI've opened #32120 (Chart-wise assumptions) for this.",
    "created_at": "2021-07-04T00:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452326",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> > creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart.
> 
> The assumptions should not be global but chart-wise. 

I've opened #32120 (Chart-wise assumptions) for this.



---

archive/issue_comments_452327.json:
```json
{
    "body": "Replying to [comment:27 egourgoulhon]:\n> Replying to [comment:23 mkoeppe]:\n> > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n> \n> I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  \n\nI was thinking of computations with coordinate changes here, which involve two charts simultaneously.",
    "created_at": "2021-07-04T00:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452327",
    "user": "mkoeppe"
}
```

Replying to [comment:27 egourgoulhon]:
> Replying to [comment:23 mkoeppe]:
> > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 
> 
> I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  

I was thinking of computations with coordinate changes here, which involve two charts simultaneously.



---

archive/issue_comments_452328.json:
```json
{
    "body": "Replying to [comment:21 egourgoulhon]:\n> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\nWe already have a meta-ticket for this, #31958 (Use the SymPy assumptions facility). I was surprised that SymPy's assumptions are not really well connected to SymPy's sets (for which I have been building some glue code in #31926).",
    "created_at": "2021-07-04T00:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452328",
    "user": "mkoeppe"
}
```

Replying to [comment:21 egourgoulhon]:
> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

We already have a meta-ticket for this, #31958 (Use the SymPy assumptions facility). I was surprised that SymPy's assumptions are not really well connected to SymPy's sets (for which I have been building some glue code in #31926).



---

archive/issue_comments_452329.json:
```json
{
    "body": "Given that #32102 is making mutability unnecessary, it seems we can keep `UniqueRepresentation` for charts for now (until we see another reason to drop it - such as unbounded memory) and pickle through that.\n\nI'm setting the ticket to \"sage-wishlist\" for this reason.",
    "created_at": "2021-07-04T00:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452329",
    "user": "mkoeppe"
}
```

Given that #32102 is making mutability unnecessary, it seems we can keep `UniqueRepresentation` for charts for now (until we see another reason to drop it - such as unbounded memory) and pickle through that.

I'm setting the ticket to "sage-wishlist" for this reason.



---

archive/issue_comments_452330.json:
```json
{
    "body": "Replying to [comment:37 mkoeppe]:\n> Replying to [comment:27 egourgoulhon]:\n> > Replying to [comment:23 mkoeppe]:\n> > > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n> > \n> > I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  \n> \n> I was thinking of computations with coordinate changes here, which involve two charts simultaneously.\n\nThere should not by any issue with coordinate changes: a coordinate change `X1 --> X2` involves only a set of chart functions based on `X1` (stored as a `MultiCoordFunction` in the attribute `CoordChange._transf`). So only assumptions relative to `X1` will be invoked in calculus involving the coordinate change `X1 --> X2` (such as the Jacobian matrix). An exception is the\ncomputation of the inverse in `CoordChange.inverse`. There only assumptions on `X2` should matter. However, if `X1` and `X2` share the same variables, the inverse is trivial. To summarize, I don't think there is a case where both sets of assumptions are required simultaneously in coordinate changes.",
    "created_at": "2021-07-04T16:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452330",
    "user": "egourgoulhon"
}
```

Replying to [comment:37 mkoeppe]:
> Replying to [comment:27 egourgoulhon]:
> > Replying to [comment:23 mkoeppe]:
> > > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 
> > 
> > I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  
> 
> I was thinking of computations with coordinate changes here, which involve two charts simultaneously.

There should not by any issue with coordinate changes: a coordinate change `X1 --> X2` involves only a set of chart functions based on `X1` (stored as a `MultiCoordFunction` in the attribute `CoordChange._transf`). So only assumptions relative to `X1` will be invoked in calculus involving the coordinate change `X1 --> X2` (such as the Jacobian matrix). An exception is the
computation of the inverse in `CoordChange.inverse`. There only assumptions on `X2` should matter. However, if `X1` and `X2` share the same variables, the inverse is trivial. To summarize, I don't think there is a case where both sets of assumptions are required simultaneously in coordinate changes.



---

archive/issue_comments_452331.json:
```json
{
    "body": "Thanks for the explanation, that's good news.",
    "created_at": "2021-07-04T16:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452331",
    "user": "mkoeppe"
}
```

Thanks for the explanation, that's good news.



---

archive/issue_comments_452332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-07-12T20:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31664#issuecomment-452332",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
