# Issue 13778: rewrite sage.combinat.combinat.unordered_tuples using itertools.combinations_with_replacement

Issue created by migration from Trac.

Original creator: nbruin

Original creation time: 2013-01-22 08:54:14

Assignee: sage-combinat

CC:  tscrim

With Python 2.7 there's a native implementation in python's itertools:

```
sage: list(itertools.combinations_with_replacement([1,2,3,4],2))
[(1, 1), (1, 2), (1, 3), (1, 4), (2, 2), (2, 3), (2, 4), (3, 3), (3, 4), (4, 4)]
sage: sage.combinat.combinat.unordered_tuples([1,2,3,4],2)
[[1, 1], [1, 2], [1, 3], [1, 4], [2, 2], [2, 3], [2, 4], [3, 3], [3, 4], [4, 4]]
```

Given that the current doc of `unordered_tuples` mentions that it wraps a GAP routine and that this is undesirable, replacing it (or deprecating it!) may be a good idea.


---

Comment by tscrim created at 2014-08-22 03:43:15

Changing status from new to needs_review.


---

Comment by tscrim created at 2014-08-22 03:43:15

In order to get the behavior to match, I had to call `sorted(set(S))` on the base set `S` when using `itertools`. On using the output from GAP, I had to do `map(tuple, eval(ans))` because that returned lists (or sometimes strings). I've given the choice to the user to decide on which algorithm. Here are some timings (with GAP already running):

```
sage: %timeit unordered_tuples([1,2,3],2,algorithm='itertools')
10000 loops, best of 3: 31.9 µs per loop
sage: %timeit unordered_tuples([1,2,3],2,algorithm='gap')
1000 loops, best of 3: 1.65 ms per loop
sage: %timeit eval(gap.eval( "UnorderedTuples(%s,%s)"%([1,2,3],ZZ(2)) ))
1000 loops, best of 3: 1.65 ms per loop

sage: %timeit unordered_tuples([1,2],6)
10000 loops, best of 3: 31.4 µs per loop
sage: %timeit unordered_tuples([1,2],6,algorithm='gap')
100 loops, best of 3: 2.33 ms per loop
sage: %timeit eval(gap.eval( "UnorderedTuples(%s,%s)"%([1,2],ZZ(6)) ))
100 loops, best of 3: 2.06 ms per loop

sage: %timeit unordered_tuples(range(30), 6)
1 loops, best of 3: 590 ms per loop
sage: %timeit eval(gap.eval( "UnorderedTuples(%s,%s)"%(range(30),ZZ(6)) ))
# I got bored after a minute and killed it
```

So even with everything, there is a major speedup. Now once this gets replaced with libgap (#16719), we'll have to rerun timings.
----
New commits:


---

Comment by rws created at 2014-08-22 06:02:16

Please justify the removal of the docstring with result `['aa', 'ab', 'ac', 'bb', 'bc', 'cc']`.


---

Comment by rws created at 2014-08-22 06:02:16

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2014-08-22 13:15:27

It's an unexpected format, in particular, the results aren't tuples. One can argue from the POV of ducktyping, it's okay, but I feel the inconsistency and the fact that it would fail a more explicit `isinstance` check the behavior should be standardized for all inputs. (Side note, I feel that should be a `needs_info`.)


---

Comment by tscrim created at 2014-08-22 13:15:27

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-08-25 13:51:35

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2014-08-25 13:51:35

Hello,

Why not a deprecation? It is nowhere used in Sage code and it would be good to advertise users that it is infinitely better to use itertools directly.

Vincent


---

Comment by tscrim created at 2014-08-26 02:44:01

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2014-08-26 02:44:01

Because using the `itertools` directly for a multiset gives multiple copies of the same tuple

```
sage: list(itertools.combinations_with_replacement([1,1], 2))
[(1, 1), (1, 1), (1, 1)]
```

which is a different behavior (this should just return a single tuple of `[(1, 1)]`).


---

Comment by ncohen created at 2015-02-06 09:28:18

Needs a merge/rebase.

Nathann


---

Comment by ncohen created at 2015-02-06 09:28:18

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-07 18:29:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-02-07 18:30:23

Done.


---

Comment by tscrim created at 2015-02-07 18:30:23

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-02-07 19:00:23

What about `tuples` vs `itertools.product`

```
sage: S = [1,2]
sage: %timeit tuples(S,3)
10000 loops, best of 3: 26.9 µs per loop
sage: %timeit list(product(S,repeat=3))
100000 loops, best of 3: 1.74 µs per loop
```

And the function `number_of_tuples` should not wrap anything, the answer is just `len(S)^k`.


---

Comment by git created at 2015-02-12 07:36:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-02-12 07:38:43

I've added that as well. Note the output order has changed (and the fact that it now returns honest tuples).


---

Comment by vdelecroix created at 2015-02-15 12:14:06

Hello,

Much cleaner now! What do you think of deprecations (not necessarily in this ticket)? Do we really want to keep the interface to GAP for those two iterators?

Vincent


---

Comment by tscrim created at 2015-02-15 22:40:19

I think it is good to have access to multiple implementations since onemight be faster in certain situations and it makes for easier testing. At the very least, it doesn't do any harm being there IMO. (There's also a president for doing this with other such functions.)


---

Comment by vdelecroix created at 2015-02-18 12:18:36

Replying to [comment:18 tscrim]:
> I think it is good to have access to multiple implementations since onemight be faster in certain situations and it makes for easier testing.

In the present case `itertools` is always faster and I think people should use itertools directly.

> At the very least, it doesn't do any harm being there IMO. (There's also a president for doing this with other such functions.)

Yes it does. This is one more function in the global namespace, one more file to maintain.


---

Comment by ncohen created at 2015-02-18 12:39:27

> Yes it does. This is one more function in the global namespace, one more file to maintain.

Plus let us only keep the code that we think worthy of being used.

Nathann


---

Comment by tscrim created at 2015-02-18 14:52:04

It's not adding anything more to the global namespace. Plus it is a separate (possibly different) algorithm, and you have to prove that in *every* case that the itertools implementation is faster.


---

Comment by ncohen created at 2015-02-18 15:05:59

> It's not adding anything more to the global namespace. Plus it is a separate (possibly different) algorithm, and you have to prove that in *every* case that the itertools implementation is faster.

This seems to be a very bad political idea. It is very likely that even though nobody ever uses this implementation because it is obviously slower than itertools, nobody will ever be able to give a formal proof that it is slower in all cases.

Nathann


---

Comment by vdelecroix created at 2015-02-18 15:09:54

Replying to [comment:21 tscrim]:
> It's not adding anything more to the global namespace.

All of `tuples`, `number_of_tuples`, `unordered_tuples` and `number_of_unordered_tuples` are in the global namespace. I do not claim that your branch adds something to the namespace but that it was already useless noise.


---

Comment by tscrim created at 2015-02-18 15:19:40

`@`ncohen Even if you could show it is always slower (large sets can behave very differently, so it's not obvious to me), it makes it better testing because they are independent algorithms (although it is highly unlikely one of the algorithms has a bug).

`@`vdelecroix Sorry, I interpreted the "this" as my branch.


---

Comment by darij created at 2015-03-10 01:56:26

The "native" implementation of `tuple` is recursive, and with the current implementation it passes the string `'native'` to itself a zillion times. Am I seeing ghosts or could this be an inefficiency? (I would implement the native algorithm, if anywhere, then in a separate method `tuples_native`, which would recurse upon itself, and which I would then reference *one time* from `tuples`.)

On `number_of_tuples`, is there really any chance for a gap call to beat `return ZZ( len(set(S)) )**k` ? I imagine the `set` call could take a while if `S` consists of complex things, but then again the doc of `unordered_tuples` warns against passing complex things to gap, which I assume should also apply to `number_of_tuples`. But I am too lazy to do timings...


---

Comment by git created at 2015-03-13 16:40:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-03-13 16:42:48

Sorry for the badly named merge commit (I started writing my next console command before the pull was finished, and what I typed ended up in the merge message instead; I thought I had cleaned it). If you are fine with my changes, feel free to set this to positive review! (I have dealt with the first paragraph of my previous post; the second paragraph has become two TODOs, but they are very low-priority.)


---

Comment by tscrim created at 2015-03-13 20:14:29

The merge message is fine with me. I'm happy with your changes except I think we should remove the todo because having the Gap version allows us to do better testing by comparing the output from the algorithms. However if you really want to leave those in there, then you can go ahead and set a positive review.


---

Comment by darij created at 2015-03-13 21:50:41

Thanks -- feel free to remove the TODOs; I would do so myself but currently I'm not at my home or work computer.


---

Comment by git created at 2015-03-15 07:39:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-03-15 07:40:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-16 21:42:11

PDF docs don't bulid


---

Comment by vbraun created at 2015-03-16 21:42:11

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-03-16 22:19:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-03-16 22:20:06

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2015-03-16 22:20:06

This should fix the pdf build...


---

Comment by vbraun created at 2015-03-19 03:17:29

Resolution: fixed
