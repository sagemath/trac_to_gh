# Issue 29869: sage.libs.ecl: Fix unicode handling

archive/issues_029869.json:
```json
{
    "body": "CC:  @mwageringel @nbruin @dimpase @spaghettisalat\n\nIf we want to support Unicode variable names in `SR`, this will become a problem:\n\n\n```\nsage: from sage.libs.ecl import *\nsage: u_symbol = EclObject('\ud83d\udd25')\nsage: u_symbol\n<repr(<sage.libs.ecl.EclObject at 0x337e7b3c8>) failed: UnicodeDecodeError: 'utf-8' codec can't decode byte 0x94 in position 2: invalid start byte>\n```\n\n\nAlso note:\n\n```\nsage: b_symbol = EclObject(bytes([166]))\nsage: b_symbol\n<repr(<sage.libs.ecl.EclObject at 0x337e7b058>) failed: UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa6 in position 0: invalid start byte>\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30106\n\n",
    "created_at": "2020-07-10T21:11:07Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "sage.libs.ecl: Fix unicode handling",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29869",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @mwageringel @nbruin @dimpase @spaghettisalat

If we want to support Unicode variable names in `SR`, this will become a problem:


```
sage: from sage.libs.ecl import *
sage: u_symbol = EclObject('üî•')
sage: u_symbol
<repr(<sage.libs.ecl.EclObject at 0x337e7b3c8>) failed: UnicodeDecodeError: 'utf-8' codec can't decode byte 0x94 in position 2: invalid start byte>
```


Also note:

```
sage: b_symbol = EclObject(bytes([166]))
sage: b_symbol
<repr(<sage.libs.ecl.EclObject at 0x337e7b058>) failed: UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa6 in position 0: invalid start byte>
```


Issue created by migration from https://trac.sagemath.org/ticket/30106





---

archive/issue_comments_423775.json:
```json
{
    "body": "Not sure if there is a function in the ECL C API that constructs a Unicode Lisp string.\nSo I would just be going through `CODE-CHAR` as in\n\n```\nsage: ecl_eval('''(type-of (map 'string #'code-char '(128293))))''')\n<ECL: (SIMPLE-ARRAY CHARACTER (1))>\n```\n",
    "created_at": "2020-07-11T00:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423775",
    "user": "https://github.com/mkoeppe"
}
```

Not sure if there is a function in the ECL C API that constructs a Unicode Lisp string.
So I would just be going through `CODE-CHAR` as in

```
sage: ecl_eval('''(type-of (map 'string #'code-char '(128293))))''')
<ECL: (SIMPLE-ARRAY CHARACTER (1))>
```




---

archive/issue_comments_423776.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T02:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423776",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423777.json:
```json
{
    "body": "Now\n\n```\nsage: SR.var('\u03c0', domain='real')\n\u03c0\n```\n\nbut more work is needed.",
    "created_at": "2020-07-11T02:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423777",
    "user": "https://github.com/mkoeppe"
}
```

Now

```
sage: SR.var('œÄ', domain='real')
œÄ
```

but more work is needed.



---

archive/issue_comments_423778.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T03:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423778",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423779.json:
```json
{
    "body": "\n```\nsage: from sage.libs.ecl import *\nsage: u_symbol = EclObject('\ud83d\udd25')\nsage: u_symbol\n<ECL: \ud83d\udd25>\n```\n",
    "created_at": "2020-07-11T03:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423779",
    "user": "https://github.com/mkoeppe"
}
```


```
sage: from sage.libs.ecl import *
sage: u_symbol = EclObject('üî•')
sage: u_symbol
<ECL: üî•>
```




---

archive/issue_comments_423780.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T04:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423780",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423781.json:
```json
{
    "body": "\n```\nsage: u_string = EclObject('\"\ud83d\udc19\"')\nsage: u_string\n<ECL: \"\ud83d\udc19\">\nsage: _.python()\n'\"\ud83d\udc19\"'\n```\n",
    "created_at": "2020-07-11T04:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423781",
    "user": "https://github.com/mkoeppe"
}
```


```
sage: u_string = EclObject('"üêô"')
sage: u_string
<ECL: "üêô">
sage: _.python()
'"üêô"'
```




---

archive/issue_comments_423782.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T04:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423782",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423783.json:
```json
{
    "body": "\n```\nsage: clock = ecl_eval('''(defun clock (h) (string (elt \"\ud83d\udd5b\ud83d\udd50\ud83d\udd51\ud83d\udd52\ud83d\udd53\ud83d\udd54\ud83d\udd55\ud83d\udd56\ud83d\udd57\ud83d\udd58\ud83d\udd59\ud83d\udd5a\" (mod h 12))))''')\nsage: clock(3).python()\n'\"\ud83d\udd52\"'\n```\n",
    "created_at": "2020-07-11T04:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423783",
    "user": "https://github.com/mkoeppe"
}
```


```
sage: clock = ecl_eval('''(defun clock (h) (string (elt "üïõüïêüïëüïíüïìüïîüïïüïñüïóüïòüïôüïö" (mod h 12))))''')
sage: clock(3).python()
'"üïí"'
```




---

archive/issue_comments_423784.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-11T04:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423784",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423785.json:
```json
{
    "body": "Thank you for solving this.\n\nShould our Maxima interface support unicode with this branch now, or do you know what else is needed to make this work? The following used to give an error, but results in a crash now:\n\n\n```\nsage: var('\u03be')._maxima_()\n\nCondition of type: SIMPLE-ERROR\nCannot coerce string Cannot coerce string $_SAGE_VAR_\u03be to a base-string to a base-string\nNo restarts available.\n...\nExcessive debugger depth! Probable infinite recursion!\nQuitting.\n```\n\n\nAlso, please add a doctest for the new functionality.",
    "created_at": "2020-07-11T13:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423785",
    "user": "https://github.com/mwageringel"
}
```

Thank you for solving this.

Should our Maxima interface support unicode with this branch now, or do you know what else is needed to make this work? The following used to give an error, but results in a crash now:


```
sage: var('Œæ')._maxima_()

Condition of type: SIMPLE-ERROR
Cannot coerce string Cannot coerce string $_SAGE_VAR_Œæ to a base-string to a base-string
No restarts available.
...
Excessive debugger depth! Probable infinite recursion!
Quitting.
```


Also, please add a doctest for the new functionality.



---

archive/issue_comments_423786.json:
```json
{
    "body": "Are you on ecl 20.4 ?",
    "created_at": "2020-07-11T14:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423786",
    "user": "https://github.com/dimpase"
}
```

Are you on ecl 20.4 ?



---

archive/issue_comments_423787.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-11T15:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423787",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_423788.json:
```json
{
    "body": "Replying to [comment:15 gh-mwageringel]:\n> The following used to give an error, but results in a crash now:\n> \n> {{{\n> sage: var('\u03be')._maxima_()\n> \n> Condition of type: SIMPLE-ERROR\n> Cannot coerce string Cannot coerce string $_SAGE_VAR_\u03be to a base-string to a base-string\n> No restarts available.\n> ...\n> Excessive debugger depth! Probable infinite recursion!\n> Quitting.\n> }}}\n\nYes, I can confirm this here. I'll look into this.\n\n> Also, please add a doctest for the new functionality.\n\nSure, will do.",
    "created_at": "2020-07-11T15:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423788",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-mwageringel]:
> The following used to give an error, but results in a crash now:
> 
> {{{
> sage: var('Œæ')._maxima_()
> 
> Condition of type: SIMPLE-ERROR
> Cannot coerce string Cannot coerce string $_SAGE_VAR_Œæ to a base-string to a base-string
> No restarts available.
> ...
> Excessive debugger depth! Probable infinite recursion!
> Quitting.
> }}}

Yes, I can confirm this here. I'll look into this.

> Also, please add a doctest for the new functionality.

Sure, will do.



---

archive/issue_comments_423789.json:
```json
{
    "body": "Replying to [comment:16 dimpase]:\n> Are you on ecl 20.4 ?\n\nI'm still on 16.1.2.",
    "created_at": "2020-07-11T15:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423789",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:16 dimpase]:
> Are you on ecl 20.4 ?

I'm still on 16.1.2.



---

archive/issue_comments_423790.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T15:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423791.json:
```json
{
    "body": "I suggest we work on ecl 20.4, for uniformity",
    "created_at": "2020-07-11T16:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423791",
    "user": "https://github.com/dimpase"
}
```

I suggest we work on ecl 20.4, for uniformity



---

archive/issue_comments_423792.json:
```json
{
    "body": "The above error is due to a bug in ECL 16.1.2:\n\n```\n> (princ-to-string '\u03be)\n\"\u039e\"\n> (setf local-table (copy-readtable nil))\n> (setf (readtable-case local-table) :invert)\n> :INVERT\n> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\nCannot coerce string \u039e to a base-string\n```\n\n\nI will try with the ECL upgrade now.",
    "created_at": "2020-07-11T16:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423792",
    "user": "https://github.com/mkoeppe"
}
```

The above error is due to a bug in ECL 16.1.2:

```
> (princ-to-string 'Œæ)
"Œû"
> (setf local-table (copy-readtable nil))
> (setf (readtable-case local-table) :invert)
> :INVERT
> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'Œæ))
Cannot coerce string Œû to a base-string
```


I will try with the ECL upgrade now.



---

archive/issue_comments_423793.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-07-11T18:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423793",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_423794.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-11T18:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423795.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> The above error is due to a bug in ECL 16.1.2:\n> {{{\n> > (princ-to-string '\u03be)\n> \"\u039e\"\n> > (setf local-table (copy-readtable nil))\n> > (setf (readtable-case local-table) :invert)\n> > :INVERT\n> > (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\n> Cannot coerce string \u039e to a base-string\n> }}}\n> \n> I will try with the ECL upgrade now.\n\nThis bug is still present in ECL 20.4.24.  The above code is from Maxima's `PRINT-INVERT-CASE` function in `commac.lisp`.",
    "created_at": "2020-07-11T18:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423795",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:21 mkoeppe]:
> The above error is due to a bug in ECL 16.1.2:
> {{{
> > (princ-to-string 'Œæ)
> "Œû"
> > (setf local-table (copy-readtable nil))
> > (setf (readtable-case local-table) :invert)
> > :INVERT
> > (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'Œæ))
> Cannot coerce string Œû to a base-string
> }}}
> 
> I will try with the ECL upgrade now.

This bug is still present in ECL 20.4.24.  The above code is from Maxima's `PRINT-INVERT-CASE` function in `commac.lisp`.



---

archive/issue_comments_423796.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-11T18:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423796",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423797.json:
```json
{
    "body": "Note that after commit ee97a6d, the test case from comment 17 now gives a proper error message, no longer a crash:\n\n```\nsage: var('\u03be')._maxima_()\n....: \n<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_\u03be to a base-string>\n```\n\nFixing this ECL bug or working around it is outside of the scope of this ticket.",
    "created_at": "2020-07-11T19:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423797",
    "user": "https://github.com/mkoeppe"
}
```

Note that after commit ee97a6d, the test case from comment 17 now gives a proper error message, no longer a crash:

```
sage: var('Œæ')._maxima_()
....: 
<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_Œæ to a base-string>
```

Fixing this ECL bug or working around it is outside of the scope of this ticket.



---

archive/issue_comments_423798.json:
```json
{
    "body": "Ok, thanks for the fix. There is one more place where `ecl_string_to_python` should be used \u2013 in `print_objects`:\n\n\n```\nsage: from sage.libs.ecl import *\nsage: u_symbol = EclObject('\ud83d\udd25')\nsage: print_objects()  # crashes\n```\n\n\nMoreover, the docstring of `ecl_eval` should be changed into a raw string, as the examples contain backslashes.\n\nOnce that is fixed, you can set a positive review on my behalf.",
    "created_at": "2020-07-12T10:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423798",
    "user": "https://github.com/mwageringel"
}
```

Ok, thanks for the fix. There is one more place where `ecl_string_to_python` should be used ‚Äì in `print_objects`:


```
sage: from sage.libs.ecl import *
sage: u_symbol = EclObject('üî•')
sage: print_objects()  # crashes
```


Moreover, the docstring of `ecl_eval` should be changed into a raw string, as the examples contain backslashes.

Once that is fixed, you can set a positive review on my behalf.



---

archive/issue_comments_423799.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-12T16:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423799",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423800.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-07-12T16:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423800",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_423801.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-12T16:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423801",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423802.json:
```json
{
    "body": "Follow-up ticket to keep track of the ECL issue: #30122",
    "created_at": "2020-07-12T16:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423802",
    "user": "https://github.com/mkoeppe"
}
```

Follow-up ticket to keep track of the ECL issue: #30122



---

archive/issue_comments_423803.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-25T22:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29869#issuecomment-423803",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
