# Issue 27770: Keep upstream three.js directory structure

Issue created by migration from https://trac.sagemath.org/ticket/28007

Original creator: @timokau

Original creation time: 2019-06-17 20:00:53

CC:  arojas fbissey saraedum @timokau paulmasson

Currently sage flattens the threejs directory structure. It still needs to take the actual structure into account when using threejs from a CDN though.

I don't see a reason to flatten the structure. It should be easier for distributions (certainly is for nixos) to keep the structure.

I have only tested this with the nix package, since it is a pain to get the sage build system working on nixos. Would appreciate it if someone else could test the `build/` changes (simple `make ptestlong`).


---

Comment by @timokau created at 2019-06-17 20:09:23

Changing status from new to needs_review.


---

Comment by git created at 2019-06-17 21:00:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2019-06-17 21:20:16

If you do that, the package will need a rev-bump to be re-installed.


---

Comment by paulmasson created at 2019-06-17 22:41:48

Changing keywords from "" to "threejs".


---

Comment by paulmasson created at 2019-06-17 22:41:48

Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?


---

Comment by fbissey created at 2019-06-18 01:27:57

What are you installing in nix to find it a burden to change the structure? Because it didn't appear that we are using an upstream tarball I just used sage's one in sage-on-gentoo. Admittedly, I call the package `threejs-sage-extension` and it is installed in a sage related location rather then something more generic.

I am curious of your install procedure and if it make sense for me to follow suite.


---

Comment by fbissey created at 2019-06-18 01:31:50

Regardless of anything else `THREEJSDIR` should be used like you do in this branch even if we don't end up flattening the structure. That would be worth a ticket by itself.


---

Comment by git created at 2019-06-18 10:01:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2019-06-18 10:02:38

I bumped the patch version and made a separate commit for the `THREEJS_DIR` usage.
----
New commits:


---

Comment by @timokau created at 2019-06-18 10:08:24

Replying to [comment:5 paulmasson]:
> Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?

Well sage doesn't actually build anything, it just cherry-picks "binaries" (or as close as javascript can come to binaries) from a CDN. If you actually "build" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate "interface" package that only symlinks the two files to the places sage expects them.

`@`fbissey we have some (suboptimal) npm [infrastructure](https://nixos.org/nixpkgs/manual/#node.js-packages) to package javascript packages, that is what I'm using. As far as I understand it (I haven't really looked into it) it scrapes npm for the dependencies, generates the build recipes, fetches each package from the npm registry and then builds them. So basically a wrapper around npm that takes over all network activity while still using npm for the actual building.


---

Comment by fbissey created at 2019-06-18 10:21:20

Right, npm stuff is a pain. I don't see an updated `package-version.txt` and `checksums.ini`. But technically the real problem is you want to change the tarball without changing the version. That is a bit of a challenge. The nice way to do that is to do an upgrade at the same time so the problem with the tarball change is avoided.


---

Comment by git created at 2019-06-18 17:23:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-06-18 17:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @timokau created at 2019-06-18 17:25:39

Right, somehow failed to push that.

Why is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.


---

Comment by @timokau created at 2019-06-18 17:27:42

Replying to [comment:11 fbissey]:
> Right, npm stuff is a pain.

Life was good when there was only make and autotools. At least for packagers that is.


---

Comment by paulmasson created at 2019-06-18 19:31:16

Replying to [comment:10 gh-timokau]:
> Replying to [comment:5 paulmasson]:
> > Timo, please explain how this makes things simpler for a distribution. It seems to me like extra complication for two files. Are you thinking of having some automatic mechanism for shifting between local files and a CDN?
> 
> Well sage doesn't actually build anything, it just cherry-picks "binaries" (or as close as javascript can come to binaries) from a CDN. If you actually "build" the whole threejs package, you'll end up with the upstream directory structure. I'd need to patch sage or create a separate "interface" package that only symlinks the two files to the places sage expects them.
As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice. Given that, keeping the original directory structure really is an extra complication without much practical gain.


---

Comment by paulmasson created at 2019-06-18 19:35:56

Replying to [comment:13 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)||`Update threejs to r105`||
In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.


---

Comment by paulmasson created at 2019-06-18 19:35:56

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2019-06-18 19:37:28

Replying to [comment:16 paulmasson]:
> As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice

Yes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.

I don't really see much of a complication here. Since it makes the `offline` code closer to the one that fetches from the CDN, it may even simplify in the future. But in any case, I don't see any complication for sage.


---

Comment by git created at 2019-06-18 19:39:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2019-06-18 19:40:34

Replying to [comment:17 paulmasson]:
> Replying to [comment:13 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)||`Update threejs to r105`||
> In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.

Okay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?


---

Comment by paulmasson created at 2019-06-18 19:44:44

Replying to [comment:20 gh-timokau]:
> Replying to [comment:17 paulmasson]:
> > Replying to [comment:13 git]:
> > > Branch pushed to git repo; I updated commit sha1. New commits:
> > > ||[4a69f3b](https://git.sagemath.org/sage.git/commit/?id=4a69f3bacfbc7c0864ab4097080773bfe6590422)||`Update threejs to r105`||
> > In the context of Three.js this is a bad idea. Upgrades are very often not backward compatible. An upgrade of Three.js should always happen on a separate ticket to be sure the template I wrote still works properly with the new version. Believe me, there were definite issues the last time I did an upgrade. Unless you use Three.js on a regular basis and are certain nothing is broken, please remove this upgrade.
> 
> Okay, I've undone that commit. Does anyone know how `spkg-src` works with volkers workflow? Do I need to upload the new tarball anywhere?
Just attach it to this ticket. Volker does the rest.


---

Comment by paulmasson created at 2019-06-18 19:47:27

Replying to [comment:18 gh-timokau]:
> Replying to [comment:16 paulmasson]:
> > As the main author of the Three.js viewer, I can practically guarantee that Sage will never build all of Three.js since only a small portion of the entire library will ever get used in practice
> 
> Yes, but there is value in standardizing the directory structure. While sage only packages threejs for a single purpose, distributions usually have multiple consumers in mind. If every package expects the threejs files in a different place, everyones lives are harder.
Then I guess I donâ€™t have an objection, but would like other packagers to chime in.


---

Comment by @timokau created at 2019-06-18 19:54:41

Soruce tarball


---

Comment by @timokau created at 2019-06-18 19:55:02

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by fbissey created at 2019-06-18 20:07:36

Replying to [comment:14 gh-timokau]:
> Right, somehow failed to push that.
> 
> Why is that a challenge? Can't I just add `.p1` to the version? In any case, I also added an update.

Because pkg-$version and pkg-$version.p$number are supposed to have the same tarball in sage's package management system. Which is a problem when the online package repo has to hold tarballs for several versions of sage, see http://mirror.aarnet.edu.au/pub/sage/spkg/upstream/threejs/index.html for a relevant example. This is where patchbot gets their packages by the way.


---

Comment by @timokau created at 2019-06-18 20:13:13

Changing status from needs_review to needs_work.


---

Comment by @timokau created at 2019-06-18 20:17:04

Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?

That'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).


---

Comment by paulmasson created at 2019-06-18 21:45:34

Replying to [comment:26 gh-timokau]:
> Ah, I see. That is annoying. `@`paulmasson since you've added the package and made the last two updates, do you plan to update it again in the future? If so, would you mind just basing that update on my branch?
> 
> That'd be the easiest solution, and I'm not in a hurry (I'm already patching sage anyways).
Just did some local testing with r105 and didn't see any major problems with this version. If you want to add the upgrade back in then I'll review the ticket. Sorry for creating the extra work for you, but I always try to remind people of possible issues with upgrading Three.js.


---

Comment by git created at 2019-06-18 21:49:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @timokau created at 2019-06-18 21:50:05

Up-to-date source tarball


---

Attachment

Not a problem, dealing with backwards incompatibility is always annoying. Update re-added.
----
New commits:


---

Comment by saraedum created at 2019-06-18 22:27:12

gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)


---

Comment by fbissey created at 2019-06-18 22:31:44

I think it may indeed. It certainly addresses some points raised here. I quite like #26434 (beside the obvious reason of removing `installed_packages`).


---

Comment by fbissey created at 2019-06-18 22:39:40

To be clear, there should be coordination between the tickets. #26434 does a lot of the dealing internally with script locations. But this ticket is talking about changing the way threejs is packaged and installed. And because the cleanest way to achieve this is an upgrade, it does that too. 

Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.


---

Comment by paulmasson created at 2019-06-18 22:42:09

Replying to [comment:30 saraedum]:
> gh-timokau: #26434 might also make this problem go away? (In a somewhat brutal manner.)
That ticket appears to remove the online, i.e. CDN scripts, completely and only uses local scripts. How will that allow people to create and share notebooks? The CDN fallback was fixed in #27575 and would likely have addressed the issues you encountered at the conference.


---

Comment by fbissey created at 2019-06-18 22:46:13

`@`paulmasson the issue that #26434 originally seeks to address is that sage is calling its internal package management to figure out the version of threejs to look for. For us on distro it is not feasible or desirable.


---

Comment by @timokau created at 2019-06-19 08:57:46

Replying to [comment:32 fbissey]:
> Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.

How is that? #26434 still contains this line:


```
scripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]
```



---

Comment by fbissey created at 2019-06-19 09:01:25

Replying to [comment:35 gh-timokau]:
> Replying to [comment:32 fbissey]:
> > Adopting #26434 means this ticket can do its packaging changes without touching "sage"'s code.
> 
> How is that? #26434 still contains this line:
> 
> {{{
> scripts = [os.path.join(THREEJS_DIR, script) for script in ['three.min.js', 'OrbitControls.js']]
> }}}

You are right. I misread something this morning, I thought it was walking in any subdirectories for some reason.


---

Comment by paulmasson created at 2019-06-19 23:56:17

Changing status from needs_work to positive_review.


---

Comment by paulmasson created at 2019-06-19 23:56:17

LGTM


---

Comment by @timokau created at 2019-06-20 11:21:38

Thank you for the review!


---

Comment by vbraun created at 2019-06-28 04:29:56

Resolution: fixed
