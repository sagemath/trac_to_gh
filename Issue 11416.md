# Issue 11416: copying a linear program crashes SAGE

Issue created by migration from https://trac.sagemath.org/ticket/11588

Original creator: john_perry

Original creation time: 2011-07-11 18:55:29

Assignee: ncohen

Keywords: MixedIntegerLinearProgram, copy

It would be useful to copy a linear program, so that one doesn't have to recopy the constraints. Unfortunately, this crashes Sage, and pretty hard.

sage: eqs = MixedIntegerLinearProgram()
sage: eqs2 = copy(eqs)
sage: eqs2

------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
and is not properly wrapped with sig_on(), sig_off().
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------


---

Comment by john_perry created at 2011-07-11 18:57:33

sorry -- forgot the code block markup...


---

Comment by ncohen created at 2011-07-12 14:24:33

I curse the day I wrote this Coin Branch and Cut support in Sage `:-D`

But all in all, I got through.... Here's a patch ready for review ! Please test it extensively, as I do not know why you need to copy them for I probably did not think of enough use cases `:-)`

Neeeeeeeeds revieeeeeeeeeww !!!

Nathann


---

Comment by ncohen created at 2011-07-12 14:24:33

Changing status from new to needs_review.


---

Comment by john_perry created at 2011-07-13 15:28:36

Changing status from needs_review to needs_work.


---

Comment by john_perry created at 2011-07-13 15:28:36

Copying works only if there are no constraints... that's said, it's not clear to me where the error here lies.



```
sage: lp = MixedIntegerLinearProgram()
sage: lp.add_constraint(lp[0]-lp[1],min=1)
sage: lp.add_constraint(2*lp[1] - lp[0] - lp[2],min=1)
sage: np = copy(lp)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/atlas/perry/<ipython console> in <module>()

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)
     77     copier = getattr(cls, "__copy__", None)
     78     if copier:
---> 79         return copier(x)
     80 
     81     reductor = dispatch_table.get(cls)

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MixedIntegerLinearProgram.__copy__ (sage/numerical/mip.c:1859)()

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)
     93                 raise Error("un(shallow)copyable object of type %s" % cls)
     94 
---> 95     return _reconstruct(x, rv, 0)
     96 
     97 

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in _reconstruct(x, info, deep, memo)
    321     if deep:
    322         args = deepcopy(args, memo)
--> 323     y = callable(*args)
    324     memo[id(x)] = y
    325     if listiter is not None:

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy_reg.pyc in __newobj__(cls, *args)
     91 
     92 def __newobj__(cls, *args):
---> 93     return cls.__new__(cls, *args)
     94 
     95 def _slotnames(cls):

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MIPVariable.__cinit__ (sage/numerical/mip.c:6626)()

TypeError: __cinit__() takes at least 2 positional arguments (0 given)

```



---

Comment by john_perry created at 2011-07-13 15:29:56

Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?


---

Comment by ncohen created at 2011-07-13 17:10:47

Yo !

It actually only failed when using the lp[x] variables instead of creating new variables and using the to define the constraints `;-)`

Patch updated.

> Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?

It is better to create a new ticket as this one already has a patch and fixes a nasty bug.

Nathann


---

Comment by ncohen created at 2011-07-13 17:10:47

Changing status from needs_work to needs_review.


---

Comment by john_perry created at 2011-07-13 19:09:43

Remove assignee ncohen.


---

Comment by john_perry created at 2011-07-13 19:09:43

Did you provide the correct attachment? It has the same filename, and I'm getting the same error.


---

Comment by ncohen created at 2011-07-13 19:31:54

Yop !

It is indeed the new file. The difference with the former file is the line :


```
p._default_mipvariable = self._default_mipvariable 
```


Nathann


---

Comment by john_perry created at 2011-07-13 19:35:33

Okay, I'll try it again. I think I wrecked my sage installation anyway, so I'm reinstalling it.

BTW, I don't know how the owner was changed, and I can't figure out how it change it back to you...


---

Comment by john_perry created at 2011-07-13 20:16:37

Set assignee to ncohen.


---

Comment by john_perry created at 2011-07-13 20:16:37

I don't know what I was doing wrong there, but it looks good now.


---

Comment by john_perry created at 2011-07-13 20:18:49

Changing status from needs_review to positive_review.


---

Comment by john_perry created at 2011-07-13 20:41:19

Let me add that this halved the running time of a program. Thanks!


---

Comment by jdemeyer created at 2011-07-22 17:18:42

Instead of `free()` you should use `sage_free()`, just like you use `sage_malloc()`.


---

Comment by jdemeyer created at 2011-07-22 17:18:42

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2011-07-26 13:01:53

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2011-07-26 13:01:53

oops ! Sorry for that  `:-)`

It turns out that changing this method was not a good idea though. Avoiding to use the C++ class was intended as a way to save on unseless computations, but it looks like the Coin library transforms the arrays into the same structure immediately when called, so everything is done twice, so I removed that part `:-)`

By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc ? I always wondered `:-)`

Nathann


---

Attachment

Sorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?


---

Comment by ncohen created at 2011-08-11 14:11:00

Replying to [comment:14 john_perry]:
> Sorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?

Precisely `:-)`

Nathann


---

Comment by jdemeyer created at 2011-08-11 15:34:15

Replying to [comment:13 ncohen]:
> By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?
Interrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.


---

Comment by ncohen created at 2011-08-11 15:39:13

Replying to [comment:16 jdemeyer]:
> Replying to [comment:13 ncohen]:
> > By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?
> Interrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.

OOOOOoooooooooohhhhhhhhh !!! Thanks !!

Nathann


---

Comment by john_perry created at 2011-08-11 16:12:24

This ticket works fine for me.


---

Comment by john_perry created at 2011-08-11 16:12:24

Changing status from needs_review to positive_review.


---

Comment by leif created at 2011-09-12 19:22:18

Resolution: fixed
