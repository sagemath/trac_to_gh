# Issue 11416: copying a linear program crashes SAGE

archive/issues_011416.json:
```json
{
    "body": "Assignee: ncohen\n\nKeywords: MixedIntegerLinearProgram, copy\n\nIt would be useful to copy a linear program, so that one doesn't have to recopy the constraints. Unfortunately, this crashes Sage, and pretty hard.\n\nsage: eqs = MixedIntegerLinearProgram()\nsage: eqs2 = copy(eqs)\nsage: eqs2\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nand is not properly wrapped with sig_on(), sig_off().\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n------------------------------------------------------------\n\nIssue created by migration from https://trac.sagemath.org/ticket/11588\n\n",
    "created_at": "2011-07-11T18:55:29Z",
    "labels": [
        "linear programming",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "copying a linear program crashes SAGE",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11416",
    "user": "john_perry"
}
```
Assignee: ncohen

Keywords: MixedIntegerLinearProgram, copy

It would be useful to copy a linear program, so that one doesn't have to recopy the constraints. Unfortunately, this crashes Sage, and pretty hard.

sage: eqs = MixedIntegerLinearProgram()
sage: eqs2 = copy(eqs)
sage: eqs2

------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
and is not properly wrapped with sig_on(), sig_off().
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------

Issue created by migration from https://trac.sagemath.org/ticket/11588





---

archive/issue_comments_127144.json:
```json
{
    "body": "sorry -- forgot the code block markup...",
    "created_at": "2011-07-11T18:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127144",
    "user": "john_perry"
}
```

sorry -- forgot the code block markup...



---

archive/issue_comments_127145.json:
```json
{
    "body": "I curse the day I wrote this Coin Branch and Cut support in Sage `:-D`\n\nBut all in all, I got through.... Here's a patch ready for review ! Please test it extensively, as I do not know why you need to copy them for I probably did not think of enough use cases `:-)`\n\nNeeeeeeeeds revieeeeeeeeeww !!!\n\nNathann",
    "created_at": "2011-07-12T14:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127145",
    "user": "ncohen"
}
```

I curse the day I wrote this Coin Branch and Cut support in Sage `:-D`

But all in all, I got through.... Here's a patch ready for review ! Please test it extensively, as I do not know why you need to copy them for I probably did not think of enough use cases `:-)`

Neeeeeeeeds revieeeeeeeeeww !!!

Nathann



---

archive/issue_comments_127146.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-07-12T14:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127146",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_127147.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-07-13T15:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127147",
    "user": "john_perry"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_127148.json:
```json
{
    "body": "Copying works only if there are no constraints... that's said, it's not clear to me where the error here lies.\n\n\n\n```\nsage: lp = MixedIntegerLinearProgram()\nsage: lp.add_constraint(lp[0]-lp[1],min=1)\nsage: lp.add_constraint(2*lp[1] - lp[0] - lp[2],min=1)\nsage: np = copy(lp)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/atlas/perry/<ipython console> in <module>()\n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)\n     77     copier = getattr(cls, \"__copy__\", None)\n     78     if copier:\n---> 79         return copier(x)\n     80 \n     81     reductor = dispatch_table.get(cls)\n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MixedIntegerLinearProgram.__copy__ (sage/numerical/mip.c:1859)()\n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)\n     93                 raise Error(\"un(shallow)copyable object of type %s\" % cls)\n     94 \n---> 95     return _reconstruct(x, rv, 0)\n     96 \n     97 \n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in _reconstruct(x, info, deep, memo)\n    321     if deep:\n    322         args = deepcopy(args, memo)\n--> 323     y = callable(*args)\n    324     memo[id(x)] = y\n    325     if listiter is not None:\n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy_reg.pyc in __newobj__(cls, *args)\n     91 \n     92 def __newobj__(cls, *args):\n---> 93     return cls.__new__(cls, *args)\n     94 \n     95 def _slotnames(cls):\n\n/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MIPVariable.__cinit__ (sage/numerical/mip.c:6626)()\n\nTypeError: __cinit__() takes at least 2 positional arguments (0 given)\n\n```\n",
    "created_at": "2011-07-13T15:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127148",
    "user": "john_perry"
}
```

Copying works only if there are no constraints... that's said, it's not clear to me where the error here lies.



```
sage: lp = MixedIntegerLinearProgram()
sage: lp.add_constraint(lp[0]-lp[1],min=1)
sage: lp.add_constraint(2*lp[1] - lp[0] - lp[2],min=1)
sage: np = copy(lp)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/atlas/perry/<ipython console> in <module>()

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)
     77     copier = getattr(cls, "__copy__", None)
     78     if copier:
---> 79         return copier(x)
     80 
     81     reductor = dispatch_table.get(cls)

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MixedIntegerLinearProgram.__copy__ (sage/numerical/mip.c:1859)()

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in copy(x)
     93                 raise Error("un(shallow)copyable object of type %s" % cls)
     94 
---> 95     return _reconstruct(x, rv, 0)
     96 
     97 

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy.pyc in _reconstruct(x, info, deep, memo)
    321     if deep:
    322         args = deepcopy(args, memo)
--> 323     y = callable(*args)
    324     memo[id(x)] = y
    325     if listiter is not None:

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python/copy_reg.pyc in __newobj__(cls, *args)
     91 
     92 def __newobj__(cls, *args):
---> 93     return cls.__new__(cls, *args)
     94 
     95 def _slotnames(cls):

/usr/local/share/sage-4.7-linux-32bit-ubuntu_10.04_lts-i686-Linux/local/lib/python2.6/site-packages/sage/numerical/mip.so in sage.numerical.mip.MIPVariable.__cinit__ (sage/numerical/mip.c:6626)()

TypeError: __cinit__() takes at least 2 positional arguments (0 given)

```




---

archive/issue_comments_127149.json:
```json
{
    "body": "Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?",
    "created_at": "2011-07-13T15:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127149",
    "user": "john_perry"
}
```

Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?



---

archive/issue_comments_127150.json:
```json
{
    "body": "Yo !\n\nIt actually only failed when using the lp[x] variables instead of creating new variables and using the to define the constraints `;-)`\n\nPatch updated.\n\n> Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?\n\nIt is better to create a new ticket as this one already has a patch and fixes a nasty bug.\n\nNathann",
    "created_at": "2011-07-13T17:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127150",
    "user": "ncohen"
}
```

Yo !

It actually only failed when using the lp[x] variables instead of creating new variables and using the to define the constraints `;-)`

Patch updated.

> Incidentally, would it be possible also to add the functionality of deleting constraints? or should I open a different ticket for that?

It is better to create a new ticket as this one already has a patch and fixes a nasty bug.

Nathann



---

archive/issue_comments_127151.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-07-13T17:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127151",
    "user": "ncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_127152.json:
```json
{
    "body": "Remove assignee ncohen.",
    "created_at": "2011-07-13T19:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127152",
    "user": "john_perry"
}
```

Remove assignee ncohen.



---

archive/issue_comments_127153.json:
```json
{
    "body": "Did you provide the correct attachment? It has the same filename, and I'm getting the same error.",
    "created_at": "2011-07-13T19:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127153",
    "user": "john_perry"
}
```

Did you provide the correct attachment? It has the same filename, and I'm getting the same error.



---

archive/issue_comments_127154.json:
```json
{
    "body": "Yop !\n\nIt is indeed the new file. The difference with the former file is the line :\n\n\n```\np._default_mipvariable = self._default_mipvariable \n```\n\n\nNathann",
    "created_at": "2011-07-13T19:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127154",
    "user": "ncohen"
}
```

Yop !

It is indeed the new file. The difference with the former file is the line :


```
p._default_mipvariable = self._default_mipvariable 
```


Nathann



---

archive/issue_comments_127155.json:
```json
{
    "body": "Okay, I'll try it again. I think I wrecked my sage installation anyway, so I'm reinstalling it.\n\nBTW, I don't know how the owner was changed, and I can't figure out how it change it back to you...",
    "created_at": "2011-07-13T19:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127155",
    "user": "john_perry"
}
```

Okay, I'll try it again. I think I wrecked my sage installation anyway, so I'm reinstalling it.

BTW, I don't know how the owner was changed, and I can't figure out how it change it back to you...



---

archive/issue_comments_127156.json:
```json
{
    "body": "Set assignee to ncohen.",
    "created_at": "2011-07-13T20:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127156",
    "user": "john_perry"
}
```

Set assignee to ncohen.



---

archive/issue_comments_127157.json:
```json
{
    "body": "I don't know what I was doing wrong there, but it looks good now.",
    "created_at": "2011-07-13T20:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127157",
    "user": "john_perry"
}
```

I don't know what I was doing wrong there, but it looks good now.



---

archive/issue_comments_127158.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-07-13T20:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127158",
    "user": "john_perry"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_127159.json:
```json
{
    "body": "Let me add that this halved the running time of a program. Thanks!",
    "created_at": "2011-07-13T20:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127159",
    "user": "john_perry"
}
```

Let me add that this halved the running time of a program. Thanks!



---

archive/issue_comments_127160.json:
```json
{
    "body": "Instead of `free()` you should use `sage_free()`, just like you use `sage_malloc()`.",
    "created_at": "2011-07-22T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127160",
    "user": "jdemeyer"
}
```

Instead of `free()` you should use `sage_free()`, just like you use `sage_malloc()`.



---

archive/issue_comments_127161.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-07-22T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127161",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_127162.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-07-26T13:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127162",
    "user": "ncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_127163.json:
```json
{
    "body": "oops ! Sorry for that  `:-)`\n\nIt turns out that changing this method was not a good idea though. Avoiding to use the C++ class was intended as a way to save on unseless computations, but it looks like the Coin library transforms the arrays into the same structure immediately when called, so everything is done twice, so I removed that part `:-)`\n\nBy the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc ? I always wondered `:-)`\n\nNathann",
    "created_at": "2011-07-26T13:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127163",
    "user": "ncohen"
}
```

oops ! Sorry for that  `:-)`

It turns out that changing this method was not a good idea though. Avoiding to use the C++ class was intended as a way to save on unseless computations, but it looks like the Coin library transforms the arrays into the same structure immediately when called, so everything is done twice, so I removed that part `:-)`

By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc ? I always wondered `:-)`

Nathann



---

archive/issue_comments_127164.json:
```json
{
    "body": "Attachment [trac_11588.patch](tarball://root/attachments/some-uuid/ticket11588/trac_11588.patch) by john_perry created at 2011-08-11 13:57:53\n\nSorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?",
    "created_at": "2011-08-11T13:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127164",
    "user": "john_perry"
}
```

Attachment [trac_11588.patch](tarball://root/attachments/some-uuid/ticket11588/trac_11588.patch) by john_perry created at 2011-08-11 13:57:53

Sorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?



---

archive/issue_comments_127165.json:
```json
{
    "body": "Replying to [comment:14 john_perry]:\n> Sorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?\n\nPrecisely `:-)`\n\nNathann",
    "created_at": "2011-08-11T14:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127165",
    "user": "ncohen"
}
```

Replying to [comment:14 john_perry]:
> Sorry I didn't answer sooner; I thought jdemeyer would. I don't see any instance of either free() or sage_free() in the patch, so I don't know whether to mark it as positive_review. If I understand the conversation correctly, though, the original patch contained some free()'s that were not needed, but those have now been removed?

Precisely `:-)`

Nathann



---

archive/issue_comments_127166.json:
```json
{
    "body": "Replying to [comment:13 ncohen]:\n> By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?\nInterrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.",
    "created_at": "2011-08-11T15:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127166",
    "user": "jdemeyer"
}
```

Replying to [comment:13 ncohen]:
> By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?
Interrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.



---

archive/issue_comments_127167.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> Replying to [comment:13 ncohen]:\n> > By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?\n> Interrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.\n\nOOOOOoooooooooohhhhhhhhh !!! Thanks !!\n\nNathann",
    "created_at": "2011-08-11T15:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127167",
    "user": "ncohen"
}
```

Replying to [comment:16 jdemeyer]:
> Replying to [comment:13 ncohen]:
> > By the way, do you know what is the difference between sage_free and free, or between sage_malloc and malloc?
> Interrupts.  An interrupt during `malloc()` or `free()` will likely crash Sage but `sage_malloc()` and friends contain code to block interrupts.

OOOOOoooooooooohhhhhhhhh !!! Thanks !!

Nathann



---

archive/issue_comments_127168.json:
```json
{
    "body": "This ticket works fine for me.",
    "created_at": "2011-08-11T16:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127168",
    "user": "john_perry"
}
```

This ticket works fine for me.



---

archive/issue_comments_127169.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-11T16:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127169",
    "user": "john_perry"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_127170.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-12T19:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11416#issuecomment-127170",
    "user": "leif"
}
```

Resolution: fixed
