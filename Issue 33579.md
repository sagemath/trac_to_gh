# Issue 33579: Update gcc/gfortran to 12.1

Issue created by migration from https://trac.sagemath.org/ticket/33816

Original creator: mkoeppe

Original creation time: 2022-05-06 15:49:38

CC:  culler jhpalmieri @kliem

just released


---

Comment by mkoeppe created at 2022-05-20 02:11:11

Looks like homebrew is able to use upstream gcc 12 on M1 - https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gcc`@`12.rb


---

Comment by mkoeppe created at 2022-06-30 23:30:04

... with one big patch: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gcc`@`12.rb#L43


---

Comment by mkoeppe created at 2022-09-20 20:15:08

New commits:


---

Comment by jhpalmieri created at 2022-09-20 20:36:41

I don't know if this is ready yet but I tried it anyway on my new M2 laptop. It failed; the end of the log file reads

```
0  0x1010cc1a0  __assert_rtn + 140
1  0x100f53a8c  mach_o::relocatable::Parser<arm64>::parse(mach_o::relocatable::ParserOptions const&) + 4536
2  0x100f25d38  mach_o::relocatable::Parser<arm64>::parse(unsigned char const*, unsigned long long, char const*, long, ld::File::Ordinal, mach_o::relocatable::ParserOptions const&) + 148
3  0x100f8e4ac  ld::tool::InputFiles::makeFile(Options::FileInfo const&, bool) + 1468
4  0x100f91360  ___ZN2ld4tool10InputFilesC2ER7Options_block_invoke + 56
5  0x188a041f4  _dispatch_client_callout2 + 20
6  0x188a17954  _dispatch_apply_invoke + 224
7  0x188a041b4  _dispatch_client_callout + 20
8  0x188a15a04  _dispatch_root_queue_drain + 680
9  0x188a16104  _dispatch_worker_thread2 + 164
10  0x188bc4324  _pthread_wqthread + 228
A linker snapshot was created at:
	/tmp/libstdc++.6.dylib-2022-09-20-133305.ld-snapshot
ld: Assertion failed: (_file->_atomsArrayCount == computedAtomCount && "more atoms allocated than expected"), function parse, file macho_relocatable_file.cpp, line 2061.
```

I can post the full log file if you want.


---

Comment by mkoeppe created at 2022-09-20 20:49:18

Thanks for testing. Also on Intel I ran into a build error. This will need more work.


---

Comment by jhpalmieri created at 2022-09-20 20:56:02

I'm happy to test. It's just a MacBook Air, but it builds Sage faster than my iMac Pro, and I like giving it tasks.


---

Comment by git created at 2022-09-21 00:48:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 01:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-21 02:00:42

On Intel, this still fails `tox -e local-macos-nohomebrew -- gfortran`, but it passes with the full bootstrapped build `tox -e local-macos-nohomebrew -- gcc`.

The failure when trying to build `gfortran` using Apple's gcc (clang) is introduced by the patch - passing the argument `-nodefaultrpaths` to the compiler.


---

Comment by git created at 2022-09-21 02:29:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-21 02:29:25

This builds for me now on Intel. Haven't tested anything else yet


---

Comment by jhpalmieri created at 2022-09-21 02:44:53

Still fails for me on m2.


---

Comment by mkoeppe created at 2022-09-21 02:45:30

full log please


---

Comment by jhpalmieri created at 2022-09-21 02:46:20

Hold on, I tried `make gcc`. I'm going to try `make gfortran` and see how that goes.


---

Comment by jhpalmieri created at 2022-09-21 02:53:18

`gfortran` built successfully.


---

Comment by mkoeppe created at 2022-09-21 02:55:14

Great! I think we can ignore the failure to build gcc. We haven't been testing those in quite a while


---

Comment by mkoeppe created at 2022-09-21 02:56:10

I'll run this for the Linux platforms on CI, just to be sure that this big patch doesn't break anything for those


---

Comment by jhpalmieri created at 2022-09-21 02:59:18

I assume that it works, but I can't test it properly since `openblas` won't build on this machine, and Sage insists on trying to build its own `openblas` if it builds its own `gfortran`.


---

Comment by mkoeppe created at 2022-09-21 03:11:09

Maybe worth trying if an openblas upgrade fixes the problem?


---

Comment by mkoeppe created at 2022-09-21 03:12:36

homebrew uses 0.3.21, we are still at 0.3.20
https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/openblas.rb


---

Comment by git created at 2022-09-21 03:24:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 03:26:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by jhpalmieri created at 2022-09-21 17:25:24

This works for me on m2 and Intel.


---

Comment by mkoeppe created at 2022-09-21 17:27:02

Great, thanks for testing! The GH Actions will still need a bit of time to test on Linux, but I'm setting it to "needs_review" already


---

Comment by mkoeppe created at 2022-09-21 17:27:02

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-09-21 19:04:19

On the Intel machine I see some doctest failures involving numerical issues, for example

```
File "src/sage/tests/books/computational-mathematics-with-sagemath/float_doctest.py", line 402, in sage.tests.books.computational-mathematics-with-sagemath.float_doctest
Failed example:
    NearlySingularMatrix(RDF,n).det() == 0.0
Expected:
    True
Got:
    False
```

and

```
File "src/sage/geometry/polyhedron/base7.py", line 569, in sage.geometry.polyhedron.base7.Polyhedron_base7.volume
Failed example:
    w = Dinexact.faces(2)[2].as_polyhedron().volume(measure='induced', engine='internal'); RDF(w) # abs tol 1e-9
Expected:
    1.5340627082974878
Got:
    8.032456584010367
Tolerance exceeded:
    1.5340627082974878 vs 8.032456584010367, tolerance 7e0 > 1e-9
```



---

Comment by jhpalmieri created at 2022-09-21 19:21:18

Maybe related to #31621?


---

Comment by mkoeppe created at 2022-09-21 19:38:14

I think many of our RDF doctests are frivolous. 

The RDF determinant goes through `scipy.linalg.det` as far I can see, and that is also what goes into the volume computation


---

Comment by mkoeppe created at 2022-09-21 19:41:56

That said, the result for the dodecahedron volume is quite concerning.


---

Comment by jhpalmieri created at 2022-09-21 19:50:43

I'm attaching a file showing all of the failures.


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-21 19:52:41

And again, this is on a machine where I have seen numerical issues before, as discussed in #31621.
----
New commits:


---

Comment by mkoeppe created at 2022-09-21 19:53:14

Throwing in a GSL upgrade just so we're up to date on everything that implements RDF stuff


---

Comment by mkoeppe created at 2022-09-21 19:54:55

Replying to [comment:38 John Palmieri]:
> And again, this is on a machine where I have seen numerical issues before, as discussed in #31621.

I guess I'll have to re-read #31621 more carefully.


---

Comment by jhpalmieri created at 2022-09-21 20:00:35

One hypothesis in #31621 was the flag `-march=native` was causing problems somewhere: `openblas`, `gsl`, somewhere else?

For this ticket, it is certainly possible that these errors are not caused by building our own `gfortran` but by other packages which are built as a result of building our own `gfortran`.


---

Comment by jhpalmieri created at 2022-09-21 21:44:35

Regarding `gsl`, `gfortran`, and `openblas`: with the branch here, on two different machines, I see

- If I do `./configure --with-system-gfortran=no`, everything builds, although I get numerical failures on one of the machines (Intel).
- If I instead do `./configure --with-system-openblas=no`, then `gsl` fails to build: the error says `ld: file not found: `@`rpath/libquadmath.0.dylib for architecture x86_64` (Intel) and similar on M2 (but with `arm64` at the end). On the Intel machine at least, I see the same with the previous version of `gsl`: the upgrade had no effect.
- If I instead do `./configure --with-system-gsl=no`, then everything builds and I do not see the same numerical failures.

So it's hard to tell whether the error is coming from `gfortran` or `openblas` or something else. I will try with the Intel machine doing `./configure --with-system-gfortran=no` without this branch and see if the same errors arise.


---

Comment by jhpalmieri created at 2022-09-21 22:21:39

Replying to [comment:42 John Palmieri]:
> So it's hard to tell whether the error is coming from `gfortran` or `openblas` or something else. I will try with the Intel machine doing `./configure --with-system-gfortran=no` without this branch and see if the same errors arise.

Confirmed: I get the same errors with the `develop` branch plus `--with-system-gfortran=no`.


---

Comment by jhpalmieri created at 2022-09-21 22:45:23

Now I would like to track down two issues, perhaps neither of which are related to this ticket: 

1. the numerical failures on this machine
2. the failure of `gsl` to build with homebrew's `gfortran` and Sage's `openblas`

Could 2 be related to this message in the `openblas` log (`./configure --with-system-openblas=no`):

```
ld: warning: dylib (/usr/local/Cellar/gcc/12.2.0/lib/gcc/current/libgfortran.dylib) was built for newer macOS version (12.0) than being linked (10.8)
```



---

Comment by mkoeppe created at 2022-09-22 00:23:01

Could you post the failing gsl build log?


---

Attachment


---

Comment by jhpalmieri created at 2022-09-22 00:33:09

Here it is.


---

Comment by git created at 2022-09-22 00:56:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-22 00:57:53

Try with this please


---

Comment by git created at 2022-09-22 01:09:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-22 03:38:59

This works, thank you.


---

Comment by jhpalmieri created at 2022-09-22 04:37:20

Works well: with each of: `--with-system-gfortran=no`, `--with-system-openblas=no`, `--with-system-gsl=no`, `gsl` builds and passes its test suite on an Intel machine and on an m2 machine. With at least one of those options I also did `make ptestlong` and everything passed.


---

Comment by jhpalmieri created at 2022-09-22 18:49:37

Matthias, what's your assessment of the testing via GH Actions?


---

Comment by mkoeppe created at 2022-09-22 19:01:56

The relevant tests among the many at https://github.com/mkoeppe/sage/actions/runs/3094982876 are the ones named "minimal-pre", which builds all non-Python packages. They have succeeded for all supported platforms.
(Commit 07d2dcb fixes a mistake I made in #34266 - I had forgotten to remove one outdated 32-bit platform and forgot to update another to use GCC 8. These two show up as failing in the GH Actions run.)

Unfortunately, the 2nd build stage ("minimal"), which builds the Python packages and the documentation, and runs "make ptest", has not started to run yet (I think because of general GH Actions flakiness).

I'll test the 2nd stage either manually or on a separate GH Actions run later today.


---

Comment by git created at 2022-09-22 19:16:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-22 19:17:14

Replying to [comment:53 Matthias Köppe]:
> Unfortunately, the 2nd build stage ("minimal") [...] has not started to run yet (I think because of general GH Actions flakiness).

Actually, a typo was the cause. Fixed now


---

Comment by mkoeppe created at 2022-09-22 19:24:44

2nd stage running now at https://github.com/mkoeppe/sage/actions/runs/3108109396/jobs/5036946542


---

Comment by mkoeppe created at 2022-09-22 19:25:35

Replying to [comment:53 Matthias Köppe]:
> The relevant tests among the many at https://github.com/mkoeppe/sage/actions/runs/3094982876 are the ones named "minimal-pre", which builds all non-Python packages. They have succeeded for all supported platforms.

(although 4 timed out)


---

Comment by mkoeppe created at 2022-09-22 22:10:22

There are some failures, I'll have to investigate what's going on there.


---

Comment by mkoeppe created at 2022-09-23 00:21:08

Looks like the failures are only due to a flaw in my new 2-stage workflow, related to the use of `-arch=native`. For example, looking into the config.log of the failing `fflas_ffpack` package on `fedora-35-minimal` https://github.com/mkoeppe/sage/actions/runs/3108109396/jobs/5036948018, one sees:

```
configure:18251: checking for use of MKL
configure:18268: result: no 
configure:18288: checking for BLAS
configure:18304: g++ -std=gnu++11 -o conftest -g -O2   -I. -I.. -I. -I./fflas-ffpack -fabi-version=6   -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib  conftest.cpp  -lopenblas  >&5
configure:18304: $? = 0
configure:18304: ./conftest
./configure: line 1735: 100961 Illegal instruction     (core dumped) ./conftest$ac_exeext
```



---

Comment by mkoeppe created at 2022-09-23 00:24:47

I've opened #34572 to improve this.


---

Comment by jhpalmieri created at 2022-09-23 02:13:41

Do we need to test on OS X pre-Monterey? Otherwise, I'm ready to give this a positive review, at least from the OS X point of view.


---

Comment by mkoeppe created at 2022-09-23 05:07:05

A test on Catalina (10.15) ran at https://github.com/mkoeppe/sage/actions/runs/3094982845/jobs/5008934048, looks OK


---

Comment by mkoeppe created at 2022-09-23 05:09:47

I've manually tested `tox -e docker-fedora-35-minimal` (also ran `make ptest`), also fine. 

I've also tested `EXTRA_CONFIGURE_ARGS=--without-system-gfortran tox -e docker-ubuntu-trusty-toolchain-gcc_9-minimal`, a bit of an usual configuration, which has a failure in `src/sage/misc/inline_fortran.py`, but I don't think this is important enough to investigate more


---

Comment by mkoeppe created at 2022-09-23 05:10:36

So I think this is ready to go


---

Comment by jhpalmieri created at 2022-09-23 05:35:37

Okay, let's merge it early in this release cycle, not that too many people are building our `gfortran` anyway...


---

Comment by jhpalmieri created at 2022-09-23 05:35:37

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-09-23 05:51:31

Thanks!


---

Comment by vbraun created at 2022-09-26 22:36:31

Full run: http://build.sagemath.org/#/builders/15/builds/5

Flint testsuite dies on the kucalc buildbot (Ubuntu 16.04.5 LTS)

```
gcc -g -O2 -I/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.8.4/src -I/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.8.4/src/build -I/var/lib/buildbot/slave/sage_git/build/local/include -I/var/lib/buildbot/slave/sage_git/build/local/include -I/var/lib/buildbot/slave/sage_git/build/local/include test_helpers.o test/t-sdiv_qrnnd.c -o build/test/t-sdiv_qrnnd -L/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.8.4/src -L/var/lib/buildbot/slave/sage_git/build/local/lib -L/var/lib/buildbot/slave/sage_git/build/local/lib -L/var/lib/buildbot/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -Wl,-rpath-link,/var/lib/buildbot/slave/sage_git/build/local/lib -L/var/lib/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/slave/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/slave/sage_git/build/local/lib -L/var/lib/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/slave/sage_git/build/local/lib  -Wl,-rpath,/var/lib/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.8.4/src
(WANTDEPS=1; export WANTDEPS; BUILD_DIR=build; export BUILD_DIR; make -f Makefile.subdirs -C . check || exit $?;)
sub_dddmmmsss....invert_limb....udiv_qrnnd....add_ssssaaaaaaaa....byte_swap....umul_ppmm....add_ssaaaa....add_sssaaaaaa....udiv_qrnnd_preinv....PASS
smul_ppmm....count_leading_zeros....count_trailing_zeros....PASS
sub_ddmmss....PASS
sdiv_qrnnd....PASS
PASS
PASS
Makefile.subdirs:107: recipe for target 'build/test/t-sdiv_qrnnd_RUN' failed
make[6]: *** [build/test/t-sdiv_qrnnd_RUN] Floating point exception (core dumped)
PASS
PASS
PASS
PASS
PASS
PASS
PASS
make[6]: Target 'check' not remade because of errors.
Makefile:219: recipe for target 'check' failed
make[5]: *** [check] Error 2
```



---

Comment by vbraun created at 2022-09-26 22:36:31

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2022-09-26 22:48:24

Our web page https://trac.sagemath.org/wiki/ReleaseTours/sage-9.8#Configurationchanges says "Users of older Linux distributions (in particular, ubuntu-xenial or older, debian-stretch or older, linuxmint-18 or older) should upgrade their systems before attempting to install Sage from source." So does a test failure on Ubuntu 16.04 matter?


---

Comment by mkoeppe created at 2022-09-27 00:33:04

Yes, I think this buildbot should be updated to a supported configuration, for example using https://askubuntu.com/questions/1140183/install-gcc-9-on-ubuntu-18-04/1149383#1149383


---

Comment by jhpalmieri created at 2022-10-12 18:31:01

So do we just set this back to positive, or does someone have to do something with the buildbot first?


---

Comment by mkoeppe created at 2022-10-13 02:13:03

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-10-17 22:44:06

Resolution: fixed
