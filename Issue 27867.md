# Issue 27867: Openblas build failure

Issue created by migration from https://trac.sagemath.org/ticket/28104

Original creator: vbraun

Original creation time: 2019-07-03 12:03:21

CC:  jpflori

On some arch openblas fails to select a sgemm kernel implementation:

```
gcc -O2 -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DNO_AVX512 -DNO_WARMUP -DMAX_CPU_NUMBER=1 -DMAX_PARALLEL_NUMBER=1 -DUSE_TLS -DVERSION=\"0.3.6\" -DASMNAME=sgemm_kernel -DASMFNAME=sgemm_kernel_ -DNAME=sgemm_kernel_ -DCNAME=sgemm_kernel -DCHAR_NAME=\"sgemm_kernel_\" -DCHAR_CNAME=\"sgemm_kernel\" -DNO_AFFINITY -I.. -UDOUBLE  -UCOMPLEX -c -UDOUBLE -UCOMPLEX ../kernel/x86_64/ -o sgemm_kernel.o
gcc: warning: ../kernel/x86_64/: linker input file unused because linking not done
}}
Should have been `../kernel/x86_64/<implementation>.c`


---

Comment by pipedream created at 2019-07-03 12:20:50

This is on a kvm-qemu virtual machine with CPU set to "Hypervisor default"

0 root`@`muizenberg:~#grep odel /proc/cpuinfo

model           : 6

model name      : QEMU Virtual CPU version 2.5+


---

Comment by vbraun created at 2019-07-03 13:03:32

Can you also add your Makefile.conf and config.h from the openblas build directory?


---

Comment by pipedream created at 2019-07-03 13:15:54

Am I looking in the right place?


```
/srv/sage-8.8/build/pkgs/openblas#find
.
./spkg-install
./patches
./patches/openblas-0.2.19-SMP_conditional.patch
./SPKG.txt
./package-version.txt
./checksums.ini
./type
./dependencies
./spkg-check
./write_pc_file.py
```



---

Comment by vbraun created at 2019-07-03 14:39:29

Run `./sage -p -s openblas` and then look into the build directory..


---

Attachment


---

Attachment


---

Attachment

We build with TARGET=ATOM after the first attempt fails, I think the relevant file would be  Makefile.conf_last. Can you upload that too?


---

Attachment


---

Comment by vbraun created at 2019-07-03 18:20:33

No thats not it...


---

Comment by vbraun created at 2019-07-07 12:16:25

This ticket fixes the `TARGET=ATOM` fallback build configuraion
----
New commits:


---

Comment by vbraun created at 2019-07-07 12:16:25

Changing status from new to needs_review.


---

Attachment


---

Comment by zimmerma created at 2019-11-04 16:19:55

on my machine (Debian bullseye/sid) I have another build failure with openblas (see attached file `openblas-0.3.6.p0.log`). The failure is `/usr/bin/ld: cannot find -l4`. Should I open a new ticket? This is with Sage 8.9.


---

Comment by vbraun created at 2019-11-16 12:48:44

Depends on whether this ticket fixes it, I'd say.

Somebody please press the positive review button here so we can merge this no-brainer


---

Comment by chapoton created at 2019-11-16 13:20:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-11-16 21:59:02

Resolution: fixed


---

Comment by zimmerma created at 2019-11-19 09:58:46

> Depends on whether this ticket fixes it, I'd say. 

no it doesn't. I'll open a new ticket.


---

Comment by zimmerma created at 2019-11-19 10:05:14

the new ticket is #28768
