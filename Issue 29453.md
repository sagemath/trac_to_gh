# Issue 29453: EllipticCuvePoint_field allow zero divisors to do basic arithmetics

Issue created by migration from https://trac.sagemath.org/ticket/29690

Original creator: heluani

Original creation time: 2020-05-14 17:57:58

CC:  cremona lorenz

Keywords: elliptic curves, points

Since #1975 the _point class for EllipticCurves over Z/NZ is set to `EllipticCurvePoint_finite_field` even when N is composite to allow for basic arithmetics. However, this class does not test correctly if a point belongs to a curve because it assumes that the coefficients are not zero divisors. For a curve of the form 

`y^2 = x^3`

the current test for a point `[a:b:0]` is that `a=0` which works for fields but it should be `a^3=0` for arbitrary rings. This very simple patch allows for correct arithmetics in this case.  


---

Comment by heluani created at 2020-05-14 18:18:18

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-06-01 17:19:29

looks simple and ok, but needs an expert's opinion


---

Comment by cremona created at 2020-06-03 14:33:23

I have two issues here.  The first is a feeling that this is a rather hacky way to deal with a situation which I introduced in #1975, and it really would be better to handle elliptic curves over commutative rings which are not integral domains better.  But that is not going to happen any time soon, so never mind.

More seriously, the fix suggested only works if the z-coordinate is either 0 or 1.  It would be better to just test one homogeneous condition, namely that   `y**2*z + (a1*x+a3*z)*y*z == (((x+a2*z)*x+a4*z)*x+a6*z)`.  But more than this is needed, if you look at the full code under "if check":  it looks for a nonzero coefficient starting at the end (the z-coordinate), raises an error if there are none (OK), and otherwise divides all coefficients by that last nonzero one.  This will not work if the last nonzero coordinate is a nonzero non-unit.

So what is needed is (1) a condition to replace "not all coordinates are zero" which is tested for the list v supplied to be a valid point at all; (2) if possible, a normalisation process to scale the given coordinates to a canonical form; and (3) a fully homogeneous test that the coefficients satisfy the equation.

I think that the right answer for (1), given v=[x,y,z], is that x,y,z generate the unit ideal of the base ring R. However even R=Integers(4) does not know how to check this (try I=R.ideal([2,3]), then R.is_one() returns False.  **This is a bug quite separate from the issues of this ticket! **  For R=Integers(N) we could just directly test that gcd([N,x,y,z])==1, so it would be possible to implement this check with code for fields and Integer(N) at least.

I don't have a simple suggestion for (2).  In the implementation of modular symbols a huge effort is spent in finding canonical representatives for elements of `P^1(\ZZ/N\ZZ)`, which is not quite trivial, and here we have `P^2`.  So perhaps we should just not try any normalization at all unless R is a field.

The upshot of all this is as follows.  Within the "if check" part of the code, decide whether the base ring is a field; if it is, do what is done now; if not and it is Integers(N) for some N, then check that gcd(list(v)+[N])==1 and check the homogeneous equation; otherwise raise an error.

I don't know the best way to test if R is Integers(N) for some N, once R.is_field() has returned False (or has raised a `NotImplementedError`).  Start with checking R.is_finite().  Then possibly just test that type(R) is `<class 'sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic_with_category'>`.  To extract the modulus N don't use R.modulus()!  That returns x+3 when N=4 and is something else;  but R.characteristic() will do.

If the original author wants to code that up, I'll review again.


---

Comment by git created at 2020-06-05 12:34:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by heluani created at 2020-06-05 12:35:10

Replying to [comment:5 cremona]:

> The upshot of all this is as follows.  Within the "if check" part of the code, decide whether the base ring is a field; if it is, do what is done now; if not and it is Integers(N) for some N, then check that gcd(list(v)+[N])==1 and check the homogeneous equation; otherwise raise an error.
> 
> I don't know the best way to test if R is Integers(N) for some N, once R.is_field() has returned False (or has raised a `NotImplementedError`).  Start with checking R.is_finite().  Then possibly just test that type(R) is `<class 'sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic_with_category'>`.  To extract the modulus N don't use R.modulus()!  That returns x+3 when N=4 and is something else;  but R.characteristic() will do.
> 
> If the original author wants to code that up, I'll review again.
Hi, I could code the check for `Integers(N)` once `R.is_field()` fails as you suggest, but if we are going to have a solution that only works for fields or integers mod `N` then I propose the following: do the same check as is now, but instead of looking for a non-zero entry, look for a unit entry. If all entries are non-units then either they are all zero in which case it's not a point or we are not in a Field and we can assume it's `Integers(N)` and just check for the characteristic. This should work the same for fields as it was before. It works in all cases for Integers(N) but it may raise perhaps an obscure error in other cases. 

Here is a proposal that passes all tests in elliptic curves and seems to work for `Integers(N)`. I hope that there was a typo in your homogeneous equation cause I changed the check when all coordinates are non-zero to a different homogeneous equation. 

If you'd prefer an explicit check for `Integers(N)` I'll do that instead.
For some reason I am not getting e-mails from trac
----
New commits:


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by wuthrich created at 2021-03-28 20:45:50

Changing status from needs_review to needs_work.


---

Comment by wuthrich created at 2021-03-28 20:45:50

I don't think that the current proposal works. In the ring `R = Q[X]/(X^2-1)` of characteristic zero, I want the point (X-1:X-1:X-1) not to be allowed either. I think John's proposal, to allow for Z/NZ by testing if the ring is of that form, is safer.


I was going to propose that we may want to fall back on the existing projective space:

```
sage: P2 = ProjectiveSpace(Integers(15),2)                                                                                                         
sage: P2                                                                                                                                               
Projective Space of dimension 2 over Ring of integers modulo 15
```


However that it deeply flawed as the following shows:

```
sage: P2(3,3,3)                                                                                                                                        
(3 : 3 : 3)
sage: P = P2(3,3,3)                                                                                                                                    
sage: Q = P2(5,-5,5)                                                                                                                                   
sage: P==Q                                                                                                                                             
True
```

I guess I should open another ticket for that and propose that entries are checked there for generating the ring.


---

Comment by wuthrich created at 2021-03-28 21:03:15

It is #31576.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
