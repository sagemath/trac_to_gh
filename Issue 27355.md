# Issue 27355: Some cleanup of Graphics3d._rich_repr_threejs

Issue created by migration from https://trac.sagemath.org/ticket/27592

Original creator: embray

Original creation time: 2019-04-02 11:44:51

CC:  @jcamp0x2a

Here's a bit of improvement, I think, to the `Graphics3d._rich_repr_threejs` method implementation.

In particular, it does away with most of the manual string formatting of JavaScript in favor of just using the `json` module to do this.  It also uses jinja2 for rendering the `threejs_template.html` template.  This may prove more flexible in the future.

I did a bit of performance testing on this, and compared to the overhead of actually generating 3D models and the like, the performance difference between this approach and the old code is negligible--they are about the same.  However, I think this approach results in cleaner code.

This is just a preliminary to some more specific changes toward #22408 (making ThreeJS the default 3D graphics viewer).


---

Comment by embray created at 2019-04-02 11:45:00

Changing status from new to needs_review.


---

Comment by embray created at 2019-04-02 11:46:07

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-04-02 11:46:07

Oops, need to rebase this on a different branch.


---

Comment by git created at 2019-04-02 11:47:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-04-02 11:47:16

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2019-04-02 12:42:52

Hi Erik, happy to see that you are working on threejs!

Have you noticed the (very) recent improvements:
- #27575: Three.js: Fix CDN Fallback
- #27568: Three.js: Consolidate Surface Code
- #27561: Fix Minor Three.js Template Error
- #27560: Update Three.js Online CDN
- #26718: Upgrade to three.js r100
Does the current ticket have some articulation with those?


---

Comment by embray created at 2019-04-02 13:17:57

Thank you for pointing these out (I was aware of #27560 but not the others).  I think this will have some minor conflict with #27568, but nothing substantial.  I'll rebase this on top of it and make sure it can be incorporated.


---

Comment by embray created at 2019-04-02 13:17:57

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-04-02 13:20:37

Changing keywords from "" to "threejs".


---

Comment by git created at 2019-04-03 10:06:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-04-03 10:08:04

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-04-03 10:08:04

Rebased to incorporate the changes from #27568.  I don't think this should conflict with any of the other ongoing ThreeJS tickets.


---

Comment by egourgoulhon created at 2019-04-04 13:03:33

With this ticket branch pulled in Sage 8.8.beta0, the notebook
https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb
fails in cell [15], which regards 3D plot of lines. The error is 

```
TypeError: Object of type 'Integer' is not JSON serializable
```

and arises from line 456 of `src/sage/plot/plot3d/base.pyx`:

```
    SAGE_LINES=json.dumps(lines),
```

The full traceback is copied below.

The same notebook works well with Sage 8.8.beta0 (python3-built). 


```
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-15-61e6b42cec16> in <module>()
      8                     label_axes=False)  # phi = pi => X < 0 part
      9 show(graph_hyp, aspect_ratio=Integer(1), viewer=viewer3D, online=True,
---> 10      axes_labels=['V','X','U'])

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in show(*args, **kwds)
    256         args[0].show()
    257         return
--> 258     pretty_print(*args, **kwds)

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in pretty_print(*args, **kwds)
    227             pass
    228         elif len(args) == 1:
--> 229             dm.display_immediately(*args, **kwds)
    230         else:
    231             SequencePrettyPrinter(*args, **kwds).pretty_print()

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in display_immediately(self, obj, **rich_repr_kwds)
    833             1/2
    834         """
--> 835         plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
    836         self._backend.display_immediately(plain_text, rich_output)
    837 

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _rich_output_formatter(self, obj, rich_repr_kwds)
    623         has_rich_repr = isinstance(obj, SageObject) and hasattr(obj, '_rich_repr_')
    624         if has_rich_repr:
--> 625             rich_output = self._call_rich_repr(obj, rich_repr_kwds)
    626         if isinstance(rich_output, OutputPlainText):
    627             plain_text = rich_output

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _call_rich_repr(self, obj, rich_repr_kwds)
    581         if rich_repr_kwds:
    582             # do not ignore errors from invalid options
--> 583             return obj._rich_repr_(self, **rich_repr_kwds)
    584         try:
    585             return obj._rich_repr_(self)

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:5661)()
    171             return self._rich_repr_wavefront(**opts)
    172         elif viewer == 'threejs':
--> 173             return self._rich_repr_threejs(**opts)
    174         else:
    175             assert False   # unreachable

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:9931)()
    450                 SAGE_TEXTS=json.dumps(texts),
    451                 SAGE_POINTS=json.dumps(points),
--> 452                 SAGE_LINES=json.dumps(lines),
    453                 SAGE_SURFACES=surfaces
    454         )

/home/eric/sage/py3/local/lib/python3.6/json/__init__.py in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)
    229         cls is None and indent is None and separators is None and
    230         default is None and not sort_keys and not kw):
--> 231         return _default_encoder.encode(obj)
    232     if cls is None:
    233         cls = JSONEncoder

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in encode(self, o)
    197         # exceptions aren't as detailed.  The list call should be roughly
    198         # equivalent to the PySequence_Fast that ''.join() would do.
--> 199         chunks = self.iterencode(o, _one_shot=True)
    200         if not isinstance(chunks, (list, tuple)):
    201             chunks = list(chunks)

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in iterencode(self, o, _one_shot)
    255                 self.key_separator, self.item_separator, self.sort_keys,
    256                 self.skipkeys, _one_shot)
--> 257         return _iterencode(o, 0)
    258 
    259 def _make_iterencode(markers, _default, _encoder, _indent, _floatstr,

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in default(self, o)
    178         """
    179         raise TypeError("Object of type '%s' is not JSON serializable" %
--> 180                         o.__class__.__name__)
    181 
    182     def encode(self, o):

TypeError: Object of type 'Integer' is not JSON serializable
```



---

Comment by egourgoulhon created at 2019-04-04 13:03:33

Changing status from needs_review to needs_work.


---

Comment by egourgoulhon created at 2019-04-04 13:18:26

Replying to [comment:11 egourgoulhon]:
> With this ticket branch pulled in Sage 8.8.beta0, the notebook
> https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb
> fails in cell [15], which regards 3D plot of lines. 

A minimal example yielding to a similar error is

```
E = EuclideanSpace(3)
show(E.cartesian_coordinates().plot(), viewer='threejs')
```

One gets 

```
TypeError: Object of type 'RealDoubleElement' is not JSON serializable
```

from line 450 of `src/sage/plot/plot3d/base.pyx`:

```
    SAGE_TEXTS=json.dumps(texts),
```



---

Comment by embray created at 2019-04-04 13:48:04

Okay, I see.  What we're lacking is JSON serialization for some basic Sage types.

While it would be overkill to add that just for this ticket, it would be a useful thing to have in its own right.  I'll at least get something started for that...


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-08-12 12:08:53

Set assignee to embray.


---

Comment by embray created at 2019-08-12 12:08:53

Still need to see about adding basic support for JSON serializations of Sage Objects.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by @jcamp0x2a created at 2020-08-27 06:37:45

The manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.

The clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.

I do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:


```
{% if animate %}
<style>{% include 'animation.css' %}</style>
<script>{% include 'animation.js' %}</script>
{% include 'animation.html' %}
{% endif %}
```



---

Comment by embray created at 2020-08-31 13:38:45

Replying to [comment:19 gh-jcamp0x2a]:
> The manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.
> 
> The clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.
> 
> I do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:
> 
> {{{
> {% if animate %}
> <style>{% include 'animation.css' %}</style>
> <script>{% include 'animation.js' %}</script>
> {% include 'animation.html' %}
> {% endif %}
> }}}

Thanks for pointing it out.  That manual JSON construction was a real bummer, and I like your `threejs_repr` approach.

I completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.


---

Comment by @jcamp0x2a created at 2020-09-03 16:56:46

Replying to [comment:20 embray]:
> I completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.

That would be awesome :)

I see the JSON serialization was a hangup in the past for this ticket? I remember encountering issues with it, too. Rather than try to implement JSON serialization for a bunch of Sage types, which I agree would be ideal, I opted to do explicit conversion to int/float in the various `threejs_repr` methods since almost all of those types already supported that conversion. So I think (hope) everything is safe to send to jinja as-is.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
