# Issue 28276: Make sure sage starts before building packages that depend on sagelib

Issue created by migration from https://trac.sagemath.org/ticket/28513

Original creator: embray

Original creation time: 2019-09-18 09:57:20

A problem that is occurring frequently in reports of build problems is failures during building sagenb, like


```
[sagenb-1.1.2] reading sources... [ 15%] misc/misc
[sagenb-1.1.2]
[sagenb-1.1.2] Exception occurred:
[sagenb-1.1.2]   File "sage/misc/lazy_import.pyx", line 218, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2502)
[sagenb-1.1.2]     raise RuntimeError(f"resolving lazy import {self._name} during startup")
[sagenb-1.1.2] RuntimeError: resolving lazy import dumps during startup
[sagenb-1.1.2] The full traceback has been saved in /var/folders/qf/wr6_n5s56m780kv130nznmlc0000gn/T/sphinx-err-MzyE1A.log, if you want to report the issue to the developers.
[sagenb-1.1.2] Please also report this if it was a user error, so that a better error message can be provided next time.
```


However, the problem has nothing to do with sagenb--rather it's because sagenb's own build process uses sagelib, and if there was a problem building sagelib properly (such that the build succeeded without failure, but still has runtime problems) it means the build will fail for any packages that depend on sagelib.

We should somehow update the Makefile so that after building sagelib it is tested immediately, and the build is failed before building any further packages, if sage fails to start (and also it would be helpful to display any actual errors to the install log / stdout).

(Currently sagenb is the only standard package that depends on sagelib being built, and it is being slowly phased out.  However, there are optional packages that depend on sage, and may be more standard packages in the future.)


---

Comment by dimpase created at 2019-09-18 10:19:00

Do you know how reliably break Sage so that `./sage -f sagenb` will break as above?


---

Comment by embray created at 2019-09-18 10:23:39

You could do almost anything really--e.g. remove a module that's imported at startup.  The last two times I saw this come up it's because the sqlite3 module for Python didn't build (something which should also be checked; that's #27705).


---

Comment by dimpase created at 2019-09-18 10:35:03

Thanks, 

```
mv local/lib/python2.7/lib-dynload/_sqlite3.so local/lib/python2.7/lib-dynload/_sqlite3.so.bak
```

does the "job" :-)


---

Comment by dimpase created at 2019-09-18 10:39:44

The following makes `./sage -f sagenb` fail with a meaningful error if Sage is broken

```diff
--- a/build/pkgs/sagenb/dependencies
+++ b/build/pkgs/sagenb/dependencies
@@ -1,4 +1,4 @@
-$(PYTHON) | $(SAGERUNTIME) pip babel flask flask_autoindex flask_babel flask_oldsessions flask_openid mathjax twisted sphinx
+$(PYTHON) $(STARTED) | $(SAGERUNTIME) pip babel flask flask_autoindex flask_babel flask_oldsessions flask_openid mathjax twisted sphinx
 
 ----------
 All lines of this file are ignored except the first.
```

(and works if Sage is OK)
This obviously may be simplified to

```diff
--- a/build/pkgs/sagenb/dependencies
+++ b/build/pkgs/sagenb/dependencies
@@ -1,4 +1,4 @@
-$(PYTHON) | $(SAGERUNTIME) pip babel flask flask_autoindex flask_babel flask_oldsessions flask_openid mathjax twisted sphinx
+$(STARTED) | pip babel flask flask_autoindex flask_babel flask_oldsessions flask_openid mathjax twisted sphinx
 
 ----------
 All lines of this file are ignored except the first.
```

and possibly even more. What's a bit worrying me here is why this is not a circular dependency.


---

Comment by dimpase created at 2019-11-10 11:28:59

I have added the change in comment:4 to the branch in #28710.


---

Comment by mkoeppe created at 2020-09-23 18:03:09

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-09-23 18:03:09

The package used as an example in the description has been removed.
Should this same problem surface for any other packages, its dependencies should be changed as discussed here.
Let's close this.


---

Comment by dimpase created at 2020-09-23 18:56:22

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-09-23 18:56:22

ok


---

Comment by slelievre created at 2020-10-11 16:52:59

Resolution: duplicate
