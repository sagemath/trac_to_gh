# Issue 23217: improve CM testing for elliptic curves over number fields

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2017-07-18 14:29:02

Keywords: CM complex multiplication

Currently the test for CM (complex multiplication) is done via the cached function is_cm_j_invariant() in sage/schemes/elliptic_curves/cm.py.  After rejecting j which are not algebraic *integers* it goes straight into a fairly expensive test which requires finding all the CM j-invariants of the same degree h as the given j.  This is fast and cheap for low degree but rapidly gets more expensive, and relies completely on knowing all negative discriminants of class number h, which is only known for h up to 100.

A better test would be very easy, would eliminate essentially all non-CM j-invariants, and would give only one candidate fundamental discriminant:

  1. Replace j by an element whose parent number field K is if exact degree h (in case the original parent field has higher degree).
  2. Construct any elliptic curve E with this j.
  3. For several primes P of K where E has good reduction, compute the square-free part of the discriminant of the Frobenius polynomial, i.e. `a_P**2-4*N(P)`.  This is fast since it only involves counting points mod P for small P, and we would restrict to P of degree 1 so the point-counting would be over prime fields.
  4. If any two of these square-free parts are different then j is not CM.
  5. If all are equal to -d (negative square-free) for many P then it is likely that j has CM by an order in Q(sqrt(-d)).  Find the class number of the maximal order and hence all orders whose class number is h.  (If none, then j is not CM).  Now we have probably only one, and at most a small number, of candidate CM discriminants, of the form `-d*f**2`.
   6. Finally compute the Hilbert Class Polynomial for each `-d*f**2` and test if j is a root.  If so then we have CM and know the discriminant.  Otherwise j was not CM.


---

Comment by cremona created at 2017-07-20 12:58:01

I have implemented this and it is ready for review.  Since the original description which I have just corrected slightly (one must only use primes P for which a_P is nonzero) I added an improvement: not only does the square-free part of the Frobenius discriminant tell you which CM field you must have, but the discriminant itself, being the discriminant of the Frobenius order contained in the endomorphism ring (which in turn is contained in the maximal order), actually divides the CM discriminant.  So the final test for the correct order is a lot easier.

The code in the branch has been tested not only using all the doctests; I also tested against all elliptic curve over Q and conductor <10000 (that was before I put in the special hard-wired code for base field Q), and also over 600,000 curves currently in the LMFDB whose CM status and discriminant had been computed by the old version.  Complete agreement.


---

Comment by cremona created at 2017-07-20 12:58:24

New commits:


---

Comment by cremona created at 2017-07-20 12:58:24

Changing status from new to needs_review.


---

Comment by aly.deines created at 2017-07-20 21:53:08

Changing status from needs_review to positive_review.


---

Comment by aly.deines created at 2017-07-20 22:01:36

Changing keywords from "CM complex multiplication" to "CM complex multiplication, sd87".


---

Comment by vbraun created at 2017-07-31 20:19:49

Resolution: fixed
