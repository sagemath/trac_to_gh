# Issue 28117: pexpect GAP interface: Handle errors when subprocess isn't wait()-ed by ptyprocess

Issue created by migration from https://trac.sagemath.org/ticket/28354

Original creator: embray

Original creation time: 2019-08-14 15:06:47

Keywords: gap pexpect

As mentioned in #20178, pexpect used to leave zombie processes around upon EOF.

Now that appears to be fixed.  Unfortunately, if the EOF occurs because the process was killed and wait()-ed by a different process, and not by pexpect itself, rather than just ignore the situation and set the process as closed, pexpect (really ptyprocess in this case) _raises an exception_ and does not mark the process as terminated.

Therefore any subsequent attempt to restart the GAP process tries again to call `isalive()` and just gets the same exception again.

We should instead catch this exception and just force the process to be marked as terminated.


---

Comment by embray created at 2019-08-14 16:22:00

Changing status from new to needs_review.


---

Comment by embray created at 2019-08-14 16:22:00

This is a bit of a mess but it seems to take care of it.

Although #20178 appears to be "fixed" the fix is not so useful, because now any situation where `isalive()` gets called results in unhandled exceptions in the case described in this ticket, where the underling process died unexpectedly.


---

Comment by vbraun created at 2019-08-14 22:48:52

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2019-08-14 22:48:52

No branch?


---

Comment by git created at 2019-08-15 07:45:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-08-15 07:45:35

Didn't push, apparently.


---

Comment by embray created at 2019-08-15 07:45:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-08-15 07:47:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-08-15 07:48:16

(fixed typo in a comment)


---

Comment by vbraun created at 2019-08-15 21:06:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-08-15 22:29:54


```
File "src/sage/interfaces/gap3.py", line 568, in sage.interfaces.gap3.Gap3._install_hints
Failed example:
    gap3('3+2')
Expected:
    Traceback (most recent call last):
    ...
    TypeError: unable to start gap3 because the command '/wrongpath/gap3 ...' failed: The command was not found or was not executable: /wrongpath/gap3.
    <BLANKLINE>
        Your attempt to start GAP3 failed, either because you do not have
        have GAP3 installed, or because it is not configured correctly.
    <BLANKLINE>
        - If you do not have GAP3 installed, then you must either...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap3.Gap3._install_hints[1]>", line 1, in <module>
        gap3('3+2')
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/gap3.py", line 704, in __init__
        super(GAP3Element, self).__init__(parent, value, is_name, name)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1471, in __init__
        self._name = parent._create(value, name=name)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 491, in _create
        self.set(name, value)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 449, in set
        self.eval(cmd)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 583, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1385, in eval
        for L in code.split('\n') if L != ''])
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 786, in _eval_line
        if expect_eof:
    UnboundLocalError: local variable 'expect_eof' referenced before assignment
```



---

Comment by vbraun created at 2019-08-15 22:29:54

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-08-16 09:15:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-16 09:16:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-08-16 09:16:41

Fixed stupid coding error.  Tested directly so I'll set back to positive_review if that was the only issue.


---

Comment by embray created at 2019-08-16 09:16:41

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-08-18 18:46:47

Resolution: fixed
