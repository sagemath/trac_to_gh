# Issue 20326: Cannot compile software (e.g. SnapPy) for sage because sage's gcc is incompatible with system's as

archive/issues_020326.json:
```json
{
    "body": "CC:  @NathanDunfield @kcrisman\n\nSage comes with its own gcc but uses the system's assembler as. If the versions of gcc and the gnu assembler are two different, compilation fails with bizarre errors such as: \n       Error: no such instruction: `vfmadd312sd offset(%rip),%xmm0,%xmm3'\n\nFor example, installing SnapPy (following the instructions from its website) fails on Mac OS X 10.9 with the latest version of Xcode compatible with 10.9 for every version of Sage later than 6.7. I have encountered this problem many times for, literally, years and on both, Sage and Linux.\n\nI think that if sage continues to ship with its own gcc, it should include its own gnu assembler as well.\nWe might even consider including our own linker ld to avoid Mac OS X users to install xcode.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20563\n\n",
    "created_at": "2016-05-05T19:15:20Z",
    "labels": [
        "component: porting"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Cannot compile software (e.g. SnapPy) for sage because sage's gcc is incompatible with system's as",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20326",
    "user": "https://github.com/unhyperbolic"
}
```
CC:  @NathanDunfield @kcrisman

Sage comes with its own gcc but uses the system's assembler as. If the versions of gcc and the gnu assembler are two different, compilation fails with bizarre errors such as: 
       Error: no such instruction: `vfmadd312sd offset(%rip),%xmm0,%xmm3'

For example, installing SnapPy (following the instructions from its website) fails on Mac OS X 10.9 with the latest version of Xcode compatible with 10.9 for every version of Sage later than 6.7. I have encountered this problem many times for, literally, years and on both, Sage and Linux.

I think that if sage continues to ship with its own gcc, it should include its own gnu assembler as well.
We might even consider including our own linker ld to avoid Mac OS X users to install xcode.

Issue created by migration from https://trac.sagemath.org/ticket/20563





---

archive/issue_comments_279914.json:
```json
{
    "body": "Attachment [binutils-2.24.patch](tarball://root/attachments/some-uuid/ticket20563/binutils-2.24.patch) by @unhyperbolic created at 2016-05-05 20:23:48\n\nPatch to binutils-2.24 to make it compile with gcc-4.9.3.p1",
    "created_at": "2016-05-05T20:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279914",
    "user": "https://github.com/unhyperbolic"
}
```

Attachment [binutils-2.24.patch](tarball://root/attachments/some-uuid/ticket20563/binutils-2.24.patch) by @unhyperbolic created at 2016-05-05 20:23:48

Patch to binutils-2.24 to make it compile with gcc-4.9.3.p1



---

archive/issue_comments_279915.json:
```json
{
    "body": "The GNU assembler (gas) is part of the GNU binutils. gcc and gas (the GNU assembler) can be built together at the same time by adding softlinks to binutil's bfd, opcodes, and gas directory to gcc's src directory and compiling gcc, see https://gcc.gnu.org/install/download.html.\n\nI gave this a try by adding a few lines to gcc/spkg-install. sage's gcc is fairly old, so I ran into some problems with binutils version 2.25 and later. But I got binutils-2.24 to work (with some mild patching necessary due to stricter compiler flags) on Linux.",
    "created_at": "2016-05-05T20:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279915",
    "user": "https://github.com/unhyperbolic"
}
```

The GNU assembler (gas) is part of the GNU binutils. gcc and gas (the GNU assembler) can be built together at the same time by adding softlinks to binutil's bfd, opcodes, and gas directory to gcc's src directory and compiling gcc, see https://gcc.gnu.org/install/download.html.

I gave this a try by adding a few lines to gcc/spkg-install. sage's gcc is fairly old, so I ran into some problems with binutils version 2.25 and later. But I got binutils-2.24 to work (with some mild patching necessary due to stricter compiler flags) on Linux.



---

archive/issue_comments_279916.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2016-05-06T16:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279916",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_279917.json:
```json
{
    "body": "I'm inclined to say that this is a snappy bug, since it most likely passes options to GCC which are not supported. Do you have a complete log of the failed snappy build?",
    "created_at": "2016-05-06T16:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279917",
    "user": "https://github.com/jdemeyer"
}
```

I'm inclined to say that this is a snappy bug, since it most likely passes options to GCC which are not supported. Do you have a complete log of the failed snappy build?



---

archive/issue_comments_279918.json:
```json
{
    "body": "Build log",
    "created_at": "2016-05-06T17:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279918",
    "user": "https://github.com/NathanDunfield"
}
```

Build log



---

archive/issue_comments_279919.json:
```json
{
    "body": "Attachment [snappy_build.log](tarball://root/attachments/some-uuid/ticket20563/snappy_build.log) by @NathanDunfield created at 2016-05-06 17:56:43\n\nNo, snappy doesn't specify any additional gcc flags for the compilation step that fails, see the log I just uploaded. \n\nIf I understand things correctly, the issue is that because gcc was built against 10.11's \"as\" command, it generates asm codes that are incompatible with the older version of \"as\" that ships with, for example, 10.9.",
    "created_at": "2016-05-06T17:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279919",
    "user": "https://github.com/NathanDunfield"
}
```

Attachment [snappy_build.log](tarball://root/attachments/some-uuid/ticket20563/snappy_build.log) by @NathanDunfield created at 2016-05-06 17:56:43

No, snappy doesn't specify any additional gcc flags for the compilation step that fails, see the log I just uploaded. 

If I understand things correctly, the issue is that because gcc was built against 10.11's "as" command, it generates asm codes that are incompatible with the older version of "as" that ships with, for example, 10.9.



---

archive/issue_comments_279920.json:
```json
{
    "body": "Replying to [comment:3 dunfield]:\n> No, snappy doesn't specify any additional gcc flags for the compilation step that fails, see the log I just uploaded. \n\nDoes snappy have inline assembly? Since snappy is the only package with this problem that I know of, there must be at least something snappy-specific about this issue.",
    "created_at": "2016-05-06T18:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279920",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 dunfield]:
> No, snappy doesn't specify any additional gcc flags for the compilation step that fails, see the log I just uploaded. 

Does snappy have inline assembly? Since snappy is the only package with this problem that I know of, there must be at least something snappy-specific about this issue.



---

archive/issue_comments_279921.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Does snappy have inline assembly? Since snappy is the only package with this problem that I know of, there must be at least something snappy-specific about this issue.\n\nNo, it doesn't.  Moreover, while very small binary Python modules will compile and function, anything too complicated gives in similar errors, for example see the logs of trying to build pandas and chomp that I will upload in a second.  \n\nThis is a problem only with the binary distribution of [SageMath](SageMath) --- if you compile Sage direct from source on 10.9 (or even 10.8), then the resulting Sage will compile snappy, chomp, and pandas without any issue.",
    "created_at": "2016-05-06T19:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279921",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:4 jdemeyer]:
> Does snappy have inline assembly? Since snappy is the only package with this problem that I know of, there must be at least something snappy-specific about this issue.

No, it doesn't.  Moreover, while very small binary Python modules will compile and function, anything too complicated gives in similar errors, for example see the logs of trying to build pandas and chomp that I will upload in a second.  

This is a problem only with the binary distribution of [SageMath](SageMath) --- if you compile Sage direct from source on 10.9 (or even 10.8), then the resulting Sage will compile snappy, chomp, and pandas without any issue.



---

archive/issue_comments_279922.json:
```json
{
    "body": "Attachment [pandas.log](tarball://root/attachments/some-uuid/ticket20563/pandas.log) by @NathanDunfield created at 2016-05-06 19:07:16",
    "created_at": "2016-05-06T19:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279922",
    "user": "https://github.com/NathanDunfield"
}
```

Attachment [pandas.log](tarball://root/attachments/some-uuid/ticket20563/pandas.log) by @NathanDunfield created at 2016-05-06 19:07:16



---

archive/issue_comments_279923.json:
```json
{
    "body": "Attachment [chomp.log](tarball://root/attachments/some-uuid/ticket20563/chomp.log) by @NathanDunfield created at 2016-05-06 19:12:27\n\nMy guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of \"as\" was present when gcc was compiled, not what version is present at run time.  The version of \"as\" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.",
    "created_at": "2016-05-06T19:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279923",
    "user": "https://github.com/NathanDunfield"
}
```

Attachment [chomp.log](tarball://root/attachments/some-uuid/ticket20563/chomp.log) by @NathanDunfield created at 2016-05-06 19:12:27

My guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of "as" was present when gcc was compiled, not what version is present at run time.  The version of "as" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.



---

archive/issue_comments_279924.json:
```json
{
    "body": "Replying to [comment:6 dunfield]:\n> My guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of \"as\" was present when gcc was compiled, not what version is present at run time.  The version of \"as\" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.  \n\nNathan and I actually verified it by looking at the results of \"gcc SnapPy.c -S\" when run under \"sage -sh\" which produces the intermittent assembly code.\n\nMy guess is that the configure script of gcc follows a certain pattern to search for \"as\" and, if it finds it, probes it for its capabilities. If gcc is then compiled, the assembly produced by that gcc depends on the \"as\" found during configure time.\n\nThis problem can be avoided if sage compiled its own \"as\" and its binary distribution ships with it.\n\nThere are two ways of doing this: \n1. Making an own sage package for binutils (which contain as) and make the gcc sage package depend on it.\n2. Making the gcc sage package obtain the binutils source code and symlinking parts of it (see comment 1) into gcc's src directory.\n\nI think 1. has the danger that we need to make sure gcc's configure really picks up the \"as\" we compiled and doesn't fallback on the system's as. This might require extra parameters.\nAnd for 2., I don't know whether the sage package framework is flexible enough to download/cache the source code from two different tarballs.\n\n'''Which approach should we take?\n'''\n----\n\nIn detail:\nThe \"offending instruction\" is a movq instruction where an operand is an SSE register xmm0, ... \nWhen using the sage binary distribution, the result of the above gcc command contains the offending instruction.\nWhen Nathan compiled sage (and thus its gcc) himself on Mac OS 10.9, the result of the same command does not contain the offending instruction (though it still contained other instructions with SSE registers).\n\"as\" on 10.11 accepts the \"offending instruction\" but on 10.9 it does not (supporting of the \"offending instruction\" starting binutils version 2.17 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=43215#c7).",
    "created_at": "2016-05-06T21:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279924",
    "user": "https://github.com/unhyperbolic"
}
```

Replying to [comment:6 dunfield]:
> My guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of "as" was present when gcc was compiled, not what version is present at run time.  The version of "as" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.  

Nathan and I actually verified it by looking at the results of "gcc SnapPy.c -S" when run under "sage -sh" which produces the intermittent assembly code.

My guess is that the configure script of gcc follows a certain pattern to search for "as" and, if it finds it, probes it for its capabilities. If gcc is then compiled, the assembly produced by that gcc depends on the "as" found during configure time.

This problem can be avoided if sage compiled its own "as" and its binary distribution ships with it.

There are two ways of doing this: 
1. Making an own sage package for binutils (which contain as) and make the gcc sage package depend on it.
2. Making the gcc sage package obtain the binutils source code and symlinking parts of it (see comment 1) into gcc's src directory.

I think 1. has the danger that we need to make sure gcc's configure really picks up the "as" we compiled and doesn't fallback on the system's as. This might require extra parameters.
And for 2., I don't know whether the sage package framework is flexible enough to download/cache the source code from two different tarballs.

'''Which approach should we take?
'''
----

In detail:
The "offending instruction" is a movq instruction where an operand is an SSE register xmm0, ... 
When using the sage binary distribution, the result of the above gcc command contains the offending instruction.
When Nathan compiled sage (and thus its gcc) himself on Mac OS 10.9, the result of the same command does not contain the offending instruction (though it still contained other instructions with SSE registers).
"as" on 10.11 accepts the "offending instruction" but on 10.9 it does not (supporting of the "offending instruction" starting binutils version 2.17 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=43215#c7).



---

archive/issue_comments_279925.json:
```json
{
    "body": "Replying to [comment:3 dunfield]:\n> If I understand things correctly, the issue is that because gcc was built against 10.11's \"as\" command, it generates asm codes that are incompatible with the older version of \"as\" that ships with, for example, 10.9.  \n\nUsing binaries compiled for OS X 10.11 on OS X 10.9 is not supported anyway. So, for me, this is still a \"wontfix\"-issue.\n\nI suggest that you write to sage-devel about this, explain the problem and the proposed solution.\n----\nNew commits:",
    "created_at": "2016-05-08T06:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279925",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 dunfield]:
> If I understand things correctly, the issue is that because gcc was built against 10.11's "as" command, it generates asm codes that are incompatible with the older version of "as" that ships with, for example, 10.9.  

Using binaries compiled for OS X 10.11 on OS X 10.9 is not supported anyway. So, for me, this is still a "wontfix"-issue.

I suggest that you write to sage-devel about this, explain the problem and the proposed solution.
----
New commits:



---

archive/issue_comments_279926.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Using binaries compiled for OS X 10.11 on OS X 10.9 is not supported anyway. So, for me, this is still a \"wontfix\"-issue.\n\nAs of Sage 6.10, the only OS X binaries I see posted at http://files.sagemath.org/osx/intel/old/index.html are compiled on OS X 10.11.  Are you saying that to use Sage 6.10 (or newer) on OS X version 10.9 or 10.10, the user is expected to compile from source?  Even now, OS X 10.11 is less than seven months old, and Sage 6.10 was released back in December.  I had assumed that since the 10.11 binaries worked on earlier versions of OS X (and they do, modulo the issue at hand), that they were intended for any reasonably recent version of OS X...",
    "created_at": "2016-05-08T08:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279926",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:9 jdemeyer]:
> Using binaries compiled for OS X 10.11 on OS X 10.9 is not supported anyway. So, for me, this is still a "wontfix"-issue.

As of Sage 6.10, the only OS X binaries I see posted at http://files.sagemath.org/osx/intel/old/index.html are compiled on OS X 10.11.  Are you saying that to use Sage 6.10 (or newer) on OS X version 10.9 or 10.10, the user is expected to compile from source?  Even now, OS X 10.11 is less than seven months old, and Sage 6.10 was released back in December.  I had assumed that since the 10.11 binaries worked on earlier versions of OS X (and they do, modulo the issue at hand), that they were intended for any reasonably recent version of OS X...



---

archive/issue_comments_279927.json:
```json
{
    "body": "Not requiring xcode would be nice, though we might also depend on system headers (don't know).\n\nWould it be sufficient to make binutils optional, and you just install it by hand if your system assembler is borked?",
    "created_at": "2016-05-12T07:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279927",
    "user": "https://github.com/vbraun"
}
```

Not requiring xcode would be nice, though we might also depend on system headers (don't know).

Would it be sufficient to make binutils optional, and you just install it by hand if your system assembler is borked?



---

archive/issue_comments_279928.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> Not requiring xcode would be nice, though we might also depend on system headers (don't know).\n\nThat's the problem: to actually compile C code, you need a lot more than just GCC. You need:\n- header files like `stdio.h`\n- standard libraries like `libc`\n- an assembler\n- a linker\n\nall these are shipped with XCode but not with GCC. I don't know if it's even possible to use a complete GNU toolchain on OS X.",
    "created_at": "2016-05-12T07:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279928",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> Not requiring xcode would be nice, though we might also depend on system headers (don't know).

That's the problem: to actually compile C code, you need a lot more than just GCC. You need:
- header files like `stdio.h`
- standard libraries like `libc`
- an assembler
- a linker

all these are shipped with XCode but not with GCC. I don't know if it's even possible to use a complete GNU toolchain on OS X.



---

archive/issue_comments_279929.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:11 vbraun]:\n> > Not requiring xcode would be nice, though we might also depend on system headers (don't know).\n> \n> That's the problem: to actually compile C code, you need a lot more than just GCC. You need:\n> - header files like `stdio.h`\n> - standard libraries like `libc`\n\nI think those come with the OS and don't require xcode.\n\n> - an assembler\n\nIf you look at the binutils source code, it contains headers nominally indicating that it supports Mac's native Mach-O files, but the configure file explicitly disables building the GNU assembler for Mac OS X. I removed that and compiled a GNU assembler for Mac, but the compilation failed because gcc on Mac OS X is using some Mach-O feature that xcode's as supports but not GNU's as.\nxcode's as is from cctools http://opensource.apple.com//source/cctools/ or llvm's own assembler (depending on your xcode version).\n\n> - a linker\n\nI think binutil's ld supports Mach-O even worse than binutil's as.\n\n> \n> all these are shipped with XCode but not with GCC. I don't know if it's even possible to use a complete GNU toolchain on OS X.\n\nThe llvm project is developing its own linker, so clang/llvm will hopefully be a complete cross-platform toolchain in a couple of years. There is also llvm-gcc, a gcc compiling to llvm's IR so that the rest of the llvm toolchain can be used.\n\nI have my hopes that clang/llvm will hopefully one day replace the clunky GNU toolchain.",
    "created_at": "2016-05-12T11:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279929",
    "user": "https://github.com/unhyperbolic"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 vbraun]:
> > Not requiring xcode would be nice, though we might also depend on system headers (don't know).
> 
> That's the problem: to actually compile C code, you need a lot more than just GCC. You need:
> - header files like `stdio.h`
> - standard libraries like `libc`

I think those come with the OS and don't require xcode.

> - an assembler

If you look at the binutils source code, it contains headers nominally indicating that it supports Mac's native Mach-O files, but the configure file explicitly disables building the GNU assembler for Mac OS X. I removed that and compiled a GNU assembler for Mac, but the compilation failed because gcc on Mac OS X is using some Mach-O feature that xcode's as supports but not GNU's as.
xcode's as is from cctools http://opensource.apple.com//source/cctools/ or llvm's own assembler (depending on your xcode version).

> - a linker

I think binutil's ld supports Mach-O even worse than binutil's as.

> 
> all these are shipped with XCode but not with GCC. I don't know if it's even possible to use a complete GNU toolchain on OS X.

The llvm project is developing its own linker, so clang/llvm will hopefully be a complete cross-platform toolchain in a couple of years. There is also llvm-gcc, a gcc compiling to llvm's IR so that the rest of the llvm toolchain can be used.

I have my hopes that clang/llvm will hopefully one day replace the clunky GNU toolchain.



---

archive/issue_comments_279930.json:
```json
{
    "body": "Which instructions GCC emits depends on how you configure it during the build `--build=...`, `--with-arch-32=...`, `--with-arch-64=...`) and of course which options you pass to it at runtime when compiling other things with it (`-march=...`, `-mFOO` or `-mno-FOO`).  In practice, usually only a subset of the instructions \"allowed\" by the latter is used unless you ask for higher optimization levels (`-O2`, `-O3`).\n\nAt runtime, GCC of course doesn't check whether *the assembler* supports the instructions it emits.  (`-march=native` just checks what features *the CPU* supports, partially influenced by the operating system or VM.)\n\nThe `vmovd` vs. `vmovq` is pretty different; we could easily patch Sage's GCC on MacOS X for older versions (i.e., ancient Apple assemblers), and/or configure GCC to use clang's assembler by default when available.\n\nFor instruction set extensions like SSE2 on 32-bit or AVX on 64-bit CPUs, it's up to a package to make sure they're supported (by the assembler and the CPU) before enabling them, and to disable them in case of misleadingly so-called \"fat binary\" builds (we use for binary distributions of Sage).  AFAIK, GMP and MPIR are the only packages which build real \"fat\" binaries (where different code is selected *at runtime*, based on the actual CPU).\n\nTL;DR:  I think we don't have to ship binutils or `gas` as well.",
    "created_at": "2016-06-22T16:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279930",
    "user": "https://github.com/nexttime"
}
```

Which instructions GCC emits depends on how you configure it during the build `--build=...`, `--with-arch-32=...`, `--with-arch-64=...`) and of course which options you pass to it at runtime when compiling other things with it (`-march=...`, `-mFOO` or `-mno-FOO`).  In practice, usually only a subset of the instructions "allowed" by the latter is used unless you ask for higher optimization levels (`-O2`, `-O3`).

At runtime, GCC of course doesn't check whether *the assembler* supports the instructions it emits.  (`-march=native` just checks what features *the CPU* supports, partially influenced by the operating system or VM.)

The `vmovd` vs. `vmovq` is pretty different; we could easily patch Sage's GCC on MacOS X for older versions (i.e., ancient Apple assemblers), and/or configure GCC to use clang's assembler by default when available.

For instruction set extensions like SSE2 on 32-bit or AVX on 64-bit CPUs, it's up to a package to make sure they're supported (by the assembler and the CPU) before enabling them, and to disable them in case of misleadingly so-called "fat binary" builds (we use for binary distributions of Sage).  AFAIK, GMP and MPIR are the only packages which build real "fat" binaries (where different code is selected *at runtime*, based on the actual CPU).

TL;DR:  I think we don't have to ship binutils or `gas` as well.



---

archive/issue_comments_279931.json:
```json
{
    "body": "Replying to [comment:7 mgoerner]:\n> Replying to [comment:6 dunfield]:\n> > My guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of \"as\" was present when gcc was compiled, not what version is present at run time.  The version of \"as\" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.  \n> \n> Nathan and I actually verified it by looking at the results of \"gcc SnapPy.c -S\" when run under \"sage -sh\" which produces the intermittent assembly code.\n> \n> My guess is that the configure script of gcc follows a certain pattern to search for \"as\" and, if it finds it, probes it for its capabilities. If gcc is then compiled, the assembly produced by that gcc depends on the \"as\" found during configure time.\n\nYep (from `gcc/configure.ac`):\n\n```sh\n    gcc_GAS_CHECK_FEATURE([interunit movq mnemonic],\n      gcc_cv_as_ix86_interunit_movq,,,\n      [.code64\n       movq %mm0, %rax\n       movq %rax, %xmm0])\n    AC_DEFINE_UNQUOTED(HAVE_AS_IX86_INTERUNIT_MOVQ,\n      [`if test $gcc_cv_as_ix86_interunit_movq = yes; then echo 1; else echo 0; fi`],\n      [Define if your assembler supports interunit movq mnemonic.])\n\n```\n\n\n\\\\\n\n> <SNIP>\n> \n> In detail:\n> The \"offending instruction\" is a movq instruction where an operand is an SSE register xmm0, ... \n> When using the sage binary distribution, the result of the above gcc command contains the offending instruction.\n\nBecause the assembler (used when building GCC) on the buildbot is less broken, namely clang's / LLVM's instead of Apple's ancient GAS 1.38 fork.\n\n\\\\\n\n> When Nathan compiled sage (and thus its gcc) himself on Mac OS 10.9, the result of the same command does not contain the offending instruction (though it still contained other instructions with SSE registers).\n> \"as\" on 10.11 accepts the \"offending instruction\" but on 10.9 it does not (supporting of the \"offending instruction\" starting binutils version 2.17 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=43215#c7).\n\nUp to version 4.8 GCC still emitted the traditional, wrong instruction (`movd`; cf. the problem report above), while it was changed to the correct one (`movq`) in 4.9.\n\nTo stay compatible with \"broken\" (very old) assemblers, this has again been changed (also in 4.9) to depend on the assembler found/used *during the build of GCC* (i.e., in its `configure` run, which in the case of Sage binary dists happens on the buildbot).\n\nThe relevant PR is [https://gcc.gnu.org/bugzilla/show_bug.cgi?id=56656](https://gcc.gnu.org/bugzilla/show_bug.cgi?id=56656), [corresponding patch](https://gcc.gnu.org/ml/gcc-patches/2013-03/msg00789.html).\n\nNote that in fact the brokenness of bdists on older MacOS X versions wasn't even triggered by upgrading Sage's GCC, but by upgrading the buildbot (to a more recent OS version and hence a newer version of XCode)... XD\n\n----\n\nSo it's not really clear (from the current ticket *description*) whether this ticket is supposed to deal (only) with the specific `movd`/`movq` issue which may pop up *when compiling SnapPy* (as the title says), or the more general problem with old Apple assemblers.\n\nThe latter will presumably be solved on #20779, thereby also fixing the more specific problem here (which could easily be solved in even more ways though).",
    "created_at": "2016-06-23T22:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279931",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:7 mgoerner]:
> Replying to [comment:6 dunfield]:
> > My guess is that the trigger is that the code is such that gcc decides to optimize by issuing certain SSE instructions/operands.  Which SSE instructions/operands it generates depends on what version of "as" was present when gcc was compiled, not what version is present at run time.  The version of "as" on 10.11 knows more SSE stuff than the one on (say) 10.9, hence the issue.  
> 
> Nathan and I actually verified it by looking at the results of "gcc SnapPy.c -S" when run under "sage -sh" which produces the intermittent assembly code.
> 
> My guess is that the configure script of gcc follows a certain pattern to search for "as" and, if it finds it, probes it for its capabilities. If gcc is then compiled, the assembly produced by that gcc depends on the "as" found during configure time.

Yep (from `gcc/configure.ac`):

```sh
    gcc_GAS_CHECK_FEATURE([interunit movq mnemonic],
      gcc_cv_as_ix86_interunit_movq,,,
      [.code64
       movq %mm0, %rax
       movq %rax, %xmm0])
    AC_DEFINE_UNQUOTED(HAVE_AS_IX86_INTERUNIT_MOVQ,
      [`if test $gcc_cv_as_ix86_interunit_movq = yes; then echo 1; else echo 0; fi`],
      [Define if your assembler supports interunit movq mnemonic.])

```


\\

> <SNIP>
> 
> In detail:
> The "offending instruction" is a movq instruction where an operand is an SSE register xmm0, ... 
> When using the sage binary distribution, the result of the above gcc command contains the offending instruction.

Because the assembler (used when building GCC) on the buildbot is less broken, namely clang's / LLVM's instead of Apple's ancient GAS 1.38 fork.

\\

> When Nathan compiled sage (and thus its gcc) himself on Mac OS 10.9, the result of the same command does not contain the offending instruction (though it still contained other instructions with SSE registers).
> "as" on 10.11 accepts the "offending instruction" but on 10.9 it does not (supporting of the "offending instruction" starting binutils version 2.17 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=43215#c7).

Up to version 4.8 GCC still emitted the traditional, wrong instruction (`movd`; cf. the problem report above), while it was changed to the correct one (`movq`) in 4.9.

To stay compatible with "broken" (very old) assemblers, this has again been changed (also in 4.9) to depend on the assembler found/used *during the build of GCC* (i.e., in its `configure` run, which in the case of Sage binary dists happens on the buildbot).

The relevant PR is [https://gcc.gnu.org/bugzilla/show_bug.cgi?id=56656](https://gcc.gnu.org/bugzilla/show_bug.cgi?id=56656), [corresponding patch](https://gcc.gnu.org/ml/gcc-patches/2013-03/msg00789.html).

Note that in fact the brokenness of bdists on older MacOS X versions wasn't even triggered by upgrading Sage's GCC, but by upgrading the buildbot (to a more recent OS version and hence a newer version of XCode)... XD

----

So it's not really clear (from the current ticket *description*) whether this ticket is supposed to deal (only) with the specific `movd`/`movq` issue which may pop up *when compiling SnapPy* (as the title says), or the more general problem with old Apple assemblers.

The latter will presumably be solved on #20779, thereby also fixing the more specific problem here (which could easily be solved in even more ways though).



---

archive/issue_comments_279932.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2016-06-23T22:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279932",
    "user": "https://github.com/nexttime"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_279933.json:
```json
{
    "body": "Changing component from porting to distribution.",
    "created_at": "2016-06-23T22:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279933",
    "user": "https://github.com/nexttime"
}
```

Changing component from porting to distribution.



---

archive/issue_comments_279934.json:
```json
{
    "body": "Replying to [comment:17 leif]:\n\nThis issue was first noticed with `SnapPy`, but, yes, it is really a general problem with old Apple assemblers: for example, it also occurs when compiling pandas or the chomp optional package.  The manifestation in #20779 is the more serious form, since you can't currently even build that version of NTL from source on 10.9.  This current ticket could also be dealt with by offering binary releases of Sage built on 10.8 or 10.9 machines.  (Such binaries are now posted for Sage 7.2 thanks to mgoerner, but I believe the only build-bot is running 10.11.)",
    "created_at": "2016-06-25T02:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279934",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:17 leif]:

This issue was first noticed with `SnapPy`, but, yes, it is really a general problem with old Apple assemblers: for example, it also occurs when compiling pandas or the chomp optional package.  The manifestation in #20779 is the more serious form, since you can't currently even build that version of NTL from source on 10.9.  This current ticket could also be dealt with by offering binary releases of Sage built on 10.8 or 10.9 machines.  (Such binaries are now posted for Sage 7.2 thanks to mgoerner, but I believe the only build-bot is running 10.11.)



---

archive/issue_comments_279935.json:
```json
{
    "body": "> This issue was first noticed with `SnapPy`, but, yes, it is really a general problem with old Apple assemblers: for example, it also occurs when compiling pandas or the chomp optional package.  The manifestation in #20779 is the more serious form, since you can't currently even build that version of NTL from source on 10.9.  This current ticket could also be dealt with by offering binary releases of Sage built on 10.8 or 10.9 machines.  (Such binaries are now posted for Sage 7.2 thanks to mgoerner, but I believe the only build-bot is running 10.11.) \nAnd just for reference, I posted my last 10.7 binary for Sage 7.2 - that machine was taken back by my employer.  But I think there will still be limited, but nonzero, demand for binaries for 10.8 and 10.9.  See e.g. [the analogous situation when 10.10 was released](https://www.intego.com/mac-security-blog/os-x-market-share-statistics-1-in-5-macs-still-unsupported/).",
    "created_at": "2016-06-25T11:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279935",
    "user": "https://github.com/kcrisman"
}
```

> This issue was first noticed with `SnapPy`, but, yes, it is really a general problem with old Apple assemblers: for example, it also occurs when compiling pandas or the chomp optional package.  The manifestation in #20779 is the more serious form, since you can't currently even build that version of NTL from source on 10.9.  This current ticket could also be dealt with by offering binary releases of Sage built on 10.8 or 10.9 machines.  (Such binaries are now posted for Sage 7.2 thanks to mgoerner, but I believe the only build-bot is running 10.11.) 
And just for reference, I posted my last 10.7 binary for Sage 7.2 - that machine was taken back by my employer.  But I think there will still be limited, but nonzero, demand for binaries for 10.8 and 10.9.  See e.g. [the analogous situation when 10.10 was released](https://www.intego.com/mac-security-blog/os-x-market-share-statistics-1-in-5-macs-still-unsupported/).



---

archive/issue_comments_279936.json:
```json
{
    "body": "> And just for reference, I posted my last 10.7 binary for Sage 7.2 - that machine was taken back by my employer.  But I think there will still be limited, but nonzero, demand for binaries for 10.8 and 10.9.  See e.g. [the analogous situation when 10.10 was released](https://www.intego.com/mac-security-blog/os-x-market-share-statistics-1-in-5-macs-still-unsupported/).\n\nI have one machine running 10.8, and some main-stream apps (Chrome, Spotify) have started warning me that they will no longer be updated on that platform.  But even that is a very recent phenomena --- 10.8 is only 4 years old, after all --- so I think there may be more demand for 10.8 and 10.9 that you might think, especially given the common feeling that OS X releases are going downhill...",
    "created_at": "2016-06-25T13:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279936",
    "user": "https://github.com/NathanDunfield"
}
```

> And just for reference, I posted my last 10.7 binary for Sage 7.2 - that machine was taken back by my employer.  But I think there will still be limited, but nonzero, demand for binaries for 10.8 and 10.9.  See e.g. [the analogous situation when 10.10 was released](https://www.intego.com/mac-security-blog/os-x-market-share-statistics-1-in-5-macs-still-unsupported/).

I have one machine running 10.8, and some main-stream apps (Chrome, Spotify) have started warning me that they will no longer be updated on that platform.  But even that is a very recent phenomena --- 10.8 is only 4 years old, after all --- so I think there may be more demand for 10.8 and 10.9 that you might think, especially given the common feeling that OS X releases are going downhill...



---

archive/issue_comments_279937.json:
```json
{
    "body": "Provided one updates XCode to the latest version *available for the specific MacOS*, with how many Xcode versions for MacOS X (10.6?) 10.{7,8,9}, 10.10, 10.11 do we have to deal?\n\nWhile AFAIK Apple's old GAS assembler had not been changed/updated for years but simply been dropped at some point (XCode for 10.10+?), LLVM and clang are of course still under development, such that the versions Apple ships are a more or less moving target (presumably with a \"final\" version for each or a couple of older MacOS X releases).",
    "created_at": "2016-06-25T13:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279937",
    "user": "https://github.com/nexttime"
}
```

Provided one updates XCode to the latest version *available for the specific MacOS*, with how many Xcode versions for MacOS X (10.6?) 10.{7,8,9}, 10.10, 10.11 do we have to deal?

While AFAIK Apple's old GAS assembler had not been changed/updated for years but simply been dropped at some point (XCode for 10.10+?), LLVM and clang are of course still under development, such that the versions Apple ships are a more or less moving target (presumably with a "final" version for each or a couple of older MacOS X releases).



---

archive/issue_comments_279938.json:
```json
{
    "body": "Replying to [comment:21 leif]:\n> Provided one updates XCode to the latest version *available for the specific MacOS*, with how many Xcode versions for MacOS X (10.6?) 10.{7,8,9}, 10.10, 10.11 do we have to deal?\n\nFor 10.8 - 10.12, I think you need Xcode 5 - 8, so there's almost as many versions of Xcode as versions of OS X.  However, since Sage builds it's own gcc on OS X, it's only dependent on a small portion of Xcode's toolchain.",
    "created_at": "2016-06-25T14:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279938",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:21 leif]:
> Provided one updates XCode to the latest version *available for the specific MacOS*, with how many Xcode versions for MacOS X (10.6?) 10.{7,8,9}, 10.10, 10.11 do we have to deal?

For 10.8 - 10.12, I think you need Xcode 5 - 8, so there's almost as many versions of Xcode as versions of OS X.  However, since Sage builds it's own gcc on OS X, it's only dependent on a small portion of Xcode's toolchain.



---

archive/issue_comments_279939.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> New commits:\n> ||[afbe56b](http://git.sagemath.org/sage.git/commit/?id=afbe56b320454d496e82bf62d1a8efda15aededc)||`Adding binutils as package and making gcc depend on it. This will make sage compile its own assembler as (but not its own linker ld). Using binutils-2.24 with some patches.`||\n\nJeroen, is your binutils package still WIP?\n\nI think it's worth in general to have an optional/experimental one.\n\n(Why currently binutils 2.24?)",
    "created_at": "2016-07-19T17:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279939",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 jdemeyer]:
> New commits:
> ||[afbe56b](http://git.sagemath.org/sage.git/commit/?id=afbe56b320454d496e82bf62d1a8efda15aededc)||`Adding binutils as package and making gcc depend on it. This will make sage compile its own assembler as (but not its own linker ld). Using binutils-2.24 with some patches.`||

Jeroen, is your binutils package still WIP?

I think it's worth in general to have an optional/experimental one.

(Why currently binutils 2.24?)



---

archive/issue_comments_279940.json:
```json
{
    "body": "On a possibly related note, see the discussion at https://groups.google.com/forum/#!topic/sage-devel/JsZ9Ig10Znc",
    "created_at": "2018-10-02T15:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279940",
    "user": "https://github.com/kcrisman"
}
```

On a possibly related note, see the discussion at https://groups.google.com/forum/#!topic/sage-devel/JsZ9Ig10Znc



---

archive/issue_comments_279941.json:
```json
{
    "body": "And possibly https://bitbucket.org/t3m/snappy/issues/13/trouble-with-installing-snappy-in-sagemath",
    "created_at": "2018-10-02T15:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279941",
    "user": "https://github.com/kcrisman"
}
```

And possibly https://bitbucket.org/t3m/snappy/issues/13/trouble-with-installing-snappy-in-sagemath



---

archive/issue_comments_279942.json:
```json
{
    "body": "Is this still an issue after #12426 was closed as fixed on 2018-02-01,\nand merged in Sage 8.2.beta5?\n\nAre the Sage macOS binaries built with gcc or with clang nowadays?\n\nDo they ship gcc or rely at runtime on the user's system clang?",
    "created_at": "2019-01-14T17:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279942",
    "user": "https://github.com/slel"
}
```

Is this still an issue after #12426 was closed as fixed on 2018-02-01,
and merged in Sage 8.2.beta5?

Are the Sage macOS binaries built with gcc or with clang nowadays?

Do they ship gcc or rely at runtime on the user's system clang?



---

archive/issue_comments_279943.json:
```json
{
    "body": "Do the discussions pointed to by kcrisman in comment:24 and comment:25\nmean the issue discussed here is resolved and this ticket can be closed?",
    "created_at": "2019-01-14T17:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279943",
    "user": "https://github.com/slel"
}
```

Do the discussions pointed to by kcrisman in comment:24 and comment:25
mean the issue discussed here is resolved and this ticket can be closed?



---

archive/issue_comments_279944.json:
```json
{
    "body": "Replying to [comment:26 slelievre]:\n> Is this still an issue after #12426 was closed as fixed on 2018-02-01,\n> and merged in Sage 8.2.beta5?\n\nNo it is not.  In any event, even the original was only a problem on macOS < 10.11 which is quite old at this point. \n\n> Are the Sage macOS binaries built with gcc or with clang nowadays?\n\nclang\n\n> Do they ship gcc or rely at runtime on the user's system clang?\n\nThey only ship gfortran at this point.\n\nReplying to [comment:27 slelievre]:\n> Do the discussions pointed to by kcrisman in comment:24 and comment:25\n> mean the issue discussed here is resolved and this ticket can be closed?\n\nThat was unrelated, but regardless this ticket can safely closed.",
    "created_at": "2019-01-14T19:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279944",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:26 slelievre]:
> Is this still an issue after #12426 was closed as fixed on 2018-02-01,
> and merged in Sage 8.2.beta5?

No it is not.  In any event, even the original was only a problem on macOS < 10.11 which is quite old at this point. 

> Are the Sage macOS binaries built with gcc or with clang nowadays?

clang

> Do they ship gcc or rely at runtime on the user's system clang?

They only ship gfortran at this point.

Replying to [comment:27 slelievre]:
> Do the discussions pointed to by kcrisman in comment:24 and comment:25
> mean the issue discussed here is resolved and this ticket can be closed?

That was unrelated, but regardless this ticket can safely closed.



---

archive/issue_events_019301.json:
```json
{
    "actor": "@slel",
    "created_at": "2019-01-14T23:57:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20326#event-19301"
}
```



---

archive/issue_comments_279945.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-01-14T23:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20326#issuecomment-279945",
    "user": "https://github.com/slel"
}
```

Resolution: worksforme
