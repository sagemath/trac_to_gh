# Issue 29161: cygwin: Accept system BLAS

Issue created by migration from https://trac.sagemath.org/ticket/29398

Original creator: mkoeppe

Original creation time: 2020-03-24 02:04:24

CC:  dimpase embray isuruf arojas fbissey vbraun

As noted in #29397, Cygwin has openblas but does not provide openblas.pc; instead blas.pc, cblas.pc, lapack.pc are provided

From http://cygwin.1069669.n5.nabble.com/Updated-openblas-0-3-3-1-td142613.html:

  2) No devel package is provided as liblapack-devel already provide the needed headers and import. Openblas is fully compatible with Netlib BLAS.

  3) libopenblas consist of a single file /usr/bin/cygblas-0.dll that will precede in PATH the liblapack0 /usr/lib/lapack/cygblas-0.dll    and used instead. Removing libopenblas will restore the    usage of Netlib BLAS


---

Comment by mkoeppe created at 2020-03-24 02:05:41

Should we accept any system BLAS (blas+cblas+lapack) on cygwin, or test whether it's provided by openblas, for example by testing for `openblas_get_config` (https://github.com/xianyi/OpenBLAS/wiki/OpenBLAS-Extensions)?


---

Comment by dimpase created at 2020-03-24 02:39:10

if we use openblas we would need to generate missing openblas.pc
(same problem on fedora)

build/pkgs/openblas has a python script for this purpose, by the way.

we should ask cygwin maintainers to fix the install and provide pc file.


---

Comment by mkoeppe created at 2020-03-24 02:40:17

which of our packages depends specifically on openblas.pc?


---

Comment by mkoeppe created at 2020-03-24 02:42:12

Replying to [comment:2 dimpase]:
> build/pkgs/openblas has a python script for this purpose, by the way.

write_pc_file.py seems to do the opposite direction -- it writes blas.pc, cblas.pc, lapack.pc. Cygwin already has those


---

Comment by dimpase created at 2020-03-24 02:56:19

Replying to [comment:3 mkoeppe]:
> which of our packages depends specifically on openblas.pc?

I meant, openblas.pc may be used by our spkg-configure for openblas. Otherwise it is not needed.


---

Comment by mkoeppe created at 2020-03-24 02:57:20

Yes, that's the problem.


---

Comment by dimpase created at 2020-03-24 03:46:38

is this on top of a not yet merged ticket?
Please list it in Dependencies.

Also, what are these OPENBLAS_* variables?
----
New commits:


---

Comment by mkoeppe created at 2020-03-24 03:48:36

Not ready for review yet.

OPENBLAS_* is created by the pkgconfig macro


---

Comment by mkoeppe created at 2020-03-24 04:03:26

And "of course" it does not work at all as advertised on cygwin.


---

Comment by mkoeppe created at 2020-03-24 04:09:26

cblas.pc refers to a non-existent library "-lcblas"...


---

Comment by dimpase created at 2020-03-24 04:12:22

we can resort to shipping platform-dependent openblas.pc

or, indeed, generate it.


---

Comment by git created at 2020-03-24 19:14:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-24 19:25:03

This is a version that works for cygwin (at least configure finds blas now).
But it is not really checking that the implementation is provided by openblas. It seems that functions such as `openblas_get_config` are not accessible.


---

Comment by mkoeppe created at 2020-03-25 00:18:08

`gsl`'s `spkg-install` needs updating too -- it uses `pkgconfig cblas`


---

Comment by git created at 2020-03-25 01:43:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-25 01:44:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-25 01:45:25

Replying to [comment:16 mkoeppe]:
> `gsl`'s `spkg-install` needs updating too -- it uses `pkgconfig cblas`

Or, rather, we should be generating cblas.pc


---

Comment by mkoeppe created at 2020-03-25 01:47:34

Perhaps best to ignore the .pc files in this situation and just do AC_SEARCH_LIBS for the libraries, and then writing out facade .pc files as in #29082. This would also take care of the `fedora-32-standard` openblas, which has no .pc files at all (#29393 Use system openblas on Fedora).


---

Comment by dimpase created at 2020-03-25 02:17:59

generating *.pc files is a bit unpleasant, I did it on #28906 - I suppose one can borrow the relevant macros there (finind the absolute patch to the library was the most tricky part)


---

Comment by mkoeppe created at 2020-03-25 02:28:45

I don't think one needs an absolute path at all in this situation.


---

Comment by dimpase created at 2020-03-25 02:37:10

well, that's what you have in *.pc files, absolute paths, I don't really know why.


---

Comment by mkoeppe created at 2020-03-25 02:48:44

To my understanding, the variables at the top of the .pc files such as `prefix`, `includedir` are there only by convention and to make relocation easier. The only thing that matters is `Libs:` and `Cflags`


---

Comment by git created at 2020-03-29 02:36:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-29 02:37:06

Rebased on 9.1.beta9


---

Comment by mkoeppe created at 2020-03-29 14:58:32

Replying to [comment:22 mkoeppe]:
> Perhaps best to ignore the .pc files in this situation and just do AC_SEARCH_LIBS for the libraries, and then writing out facade .pc files as in #29082. This would also take care of the `fedora-32-standard` openblas, which has no .pc files at all (#29393 Use system openblas on Fedora).

Help with this would be welcome...


---

Comment by git created at 2020-04-01 03:01:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-01 03:02:55

This seems to work. It falls back to using AC_SEARCH_LIBS, and then constructs a minimal openblas.pc.

But I think this needs some extra checks -- otherwise this would accept just about any BLAS in the system and pretend it's openblas.


---

Comment by dimpase created at 2020-04-01 03:27:08

would it also work on Fedora (which doesn't install openblas.pc)?


---

Comment by mkoeppe created at 2020-04-01 03:29:22

I would hope so, but haven't tested yet.


---

Comment by mkoeppe created at 2020-04-01 03:31:39

Tests at https://github.com/mkoeppe/sage/actions/runs/67915244 and https://github.com/mkoeppe/sage/actions/runs/67915245


---

Comment by mkoeppe created at 2020-04-01 03:51:45

For checking whether a system blas on Linux is actually openblas, we can use a function test for openblas_get_config.

On Cygwin, I don't know a better solution than to do `strings $(which cygblas-0.dll) | grep openblas` to distinguish the good openblas from the bad generic blas.


---

Comment by dimpase created at 2020-04-01 04:04:59

Do you mean that on Cygwin they don't have `openblas_get_config` even for "real" openblas? This is a bug...


---

Comment by mkoeppe created at 2020-04-01 04:11:42

They only use openblas as a drop-in binary-compatible replacement for blas/cblas.


---

Comment by dimpase created at 2020-04-01 04:25:08

if it's cygwin-specific, maybe it's easier to call `cygcheck -c openblas` ?


---

Comment by mkoeppe created at 2020-04-01 04:51:45

That wouldn't give the correct answer when users change the PATH from the default one, so that the generic blas dll wins


---

Comment by mkoeppe created at 2020-04-01 12:19:24

Fedora seems to work too - https://github.com/mkoeppe/sage/runs/550765309


---

Comment by git created at 2020-04-02 04:24:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-02 04:56:05

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-04-02 06:03:10

lgtm


---

Comment by dimpase created at 2020-04-02 06:03:10

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-02 12:27:36

Thanks!


---

Comment by mkoeppe created at 2020-04-02 12:50:05

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-04-02 12:50:43

I guess I should remove my debugging code that disables pkgconfig detection from this!


---

Comment by mkoeppe created at 2020-04-02 12:52:23

With the pkgconfig-based detection disabled, on `debian-buster-standard` (https://github.com/mkoeppe/sage/runs/553984061) one sees the following:

```
       self._backend.solve()
      File "sage/numerical/backends/cvxopt_sdp_backend.pyx", line 369, in sage.numerical.backends.cvxopt_sdp_backend.CVXOPTSDPBackend.solve (build/cythonized/sage/numerical/backends/cvxopt_sdp_backend.c:4838)
        from cvxopt import matrix as c_matrix, solvers
      File "/sage/local/lib/python3.7/site-packages/cvxopt/__init__.py", line 279, in <module>
        from cvxopt import solvers, blas, lapack
    ImportError: /sage/local/lib/python3.7/site-packages/cvxopt/blas.cpython-37m-x86_64-linux-gnu.so: undefined symbol: dtrsm_
```



---

Comment by git created at 2020-04-02 12:53:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-02 12:54:09

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-04-02 15:27:49

Replying to [comment:52 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[0cda07c](https://git.sagemath.org/sage.git/commit/?id=0cda07c33fe26f035377c57c8982f3e2ea8da85d)||`build/pkgs/openblas/spkg-configure.m4: Make pkgconfig-based detection work again`||

oops, I missed this.


---

Comment by mkoeppe created at 2020-04-02 16:44:37

Fixed `debian-buster-standard`: https://github.com/mkoeppe/sage/runs/554994789


---

Comment by dimpase created at 2020-04-02 16:53:26

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-04-02 16:53:26

OK, looks good.
By the way (offtopic), why do we see this

```
2020-04-02T16:07:07.4502918Z **********************************************************************
2020-04-02T16:07:07.4503012Z File "src/sage/tests/cmdline.py", line 600, in sage.tests.cmdline.test_executable
2020-04-02T16:07:07.4503087Z Failed example:
2020-04-02T16:07:07.4503167Z     err
2020-04-02T16:07:07.4503245Z Expected:
2020-04-02T16:07:07.4503440Z     ''
2020-04-02T16:07:07.4503502Z Got:
2020-04-02T16:07:07.4503715Z     '/sage/src/bin/sage: line 564: exec: sqlite3: not found\n'
```

is it by design?


---

Comment by mkoeppe created at 2020-04-02 16:56:55


```
$ cat build/pkgs/sqlite/distros/debian.txt 
libsqlite3-dev
```

We can add the package with the executable `sqlite3`


---

Comment by mkoeppe created at 2020-04-09 17:23:17

Replying to [comment:57 mkoeppe]:
> We can add the package with the executable `sqlite3` 

This is now #29487


---

Comment by vbraun created at 2020-04-09 22:44:46

Resolution: fixed
