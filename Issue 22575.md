# Issue 22575: correct linking flags of gfan

Issue created by migration from https://trac.sagemath.org/ticket/22812

Original creator: dimpase

Original creation time: 2017-04-14 21:51:49

CC:  fbissey embray

sometimes LDFLAGS must come first, but in gfan's makefile LDFLAGS are put last. This makes it impossible to build on FreeBSD without extra hack, such as redefining CXX to include LDFLAGS.

We clean this mess up by making use of special variables (CDD-related) in its makefile, and remove LDFLAGS hack from spkg-install.


---

Comment by dimpase created at 2017-04-14 21:54:04

Does this work OK on OSX and Cygwin?


---

Comment by dimpase created at 2017-04-14 21:54:04

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-04-19 03:29:42

I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)

```
-ifeq ($(cddpath),)
-CDD_LINKOPTIONS = -L/usr/local -lcddgmp
+CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
 CDD_INCLUDEOPTIONS =
-else
-CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
-CDD_INCLUDEOPTIONS = -I $(cddpath)/include
-endif
```

Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.


---

Comment by dimpase created at 2017-04-19 07:33:24

Replying to [comment:2 fbissey]:
> I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)

Well, if you mean to say that I should leave the `else` part, which is never triggered under Sage, intact, I certainly can do this. (Although I see no harm in removing things which are not used).

> {{{
> -ifeq ($(cddpath),)
> -CDD_LINKOPTIONS = -L/usr/local -lcddgmp
> +CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
>  CDD_INCLUDEOPTIONS =
> -else
> -CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
> -CDD_INCLUDEOPTIONS = -I $(cddpath)/include
> -endif
> }}}
> Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.

Apart from the `if/else` thing (as I said, I can leave it in), this is done to clean up the flags a bit; presently that
`-L/usr/local -lcddgmp` is worked around in `spkg-install`, basically by appending the correct `-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm` to `LDFLAGS` (the latter are appended in the makefile). I cannot keep doing this, I really need `LDFLAGS` in front, for this to work.

Besides, needless to say, if you really happen to have `libcddgmp` in `/usr/local/`, all the bets are off, you might end up with a linker error, or worse.

I could have plugged `LDFLAGS` into the 1st position into the right line of of the makefile, and leave the rest as it is, but this is ugly IMHO.


---

Comment by fbissey created at 2017-04-19 07:41:44

OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.


---

Comment by dimpase created at 2017-04-19 07:50:20

Replying to [comment:4 fbissey]:
> OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.

I merely move adding `-lm`, needed on other systems, not only FreeBSD, from `spkg-install` to the makefile directly. 

```
-# set LDFLAGS with proper flags to link against gmp/mpir and cddlib
-LDFLAGS="-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm $LDFLAGS"
```


If you think that all this can be done better, please do a branch...


---

Comment by fbissey created at 2017-04-19 07:53:53

There are several way to skin a cat as they say, I go for either minimal or complete revamp - which would feel nice here. Quite a number of things have moved since the original `spkg-install` making it easier to be minimalistic.

I'll do a branch...


---

Comment by fbissey created at 2017-04-19 23:32:36

I invite you to test my small changes on my branch. I kept 90% of your changes, I only changed the `Makefile` patch with what I think is necessary. 
----
New commits:


---

Comment by dimpase created at 2017-04-20 11:30:50

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2017-04-20 11:30:50

looks good to me. Should we  bump the package version too?


---

Comment by dimpase created at 2017-04-20 11:42:11

Changing status from needs_info to positive_review.


---

Comment by fbissey created at 2017-04-20 12:37:39

Jeroen always wants to bump. I am not always thrilled by it, but it certainly means more testing, which is his point.


---

Comment by vbraun created at 2017-04-23 12:57:33

Resolution: fixed
