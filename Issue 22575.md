# Issue 22575: correct linking flags of gfan

archive/issues_022575.json:
```json
{
    "body": "CC:  @kiwifb @embray\n\nsometimes LDFLAGS must come first, but in gfan's makefile LDFLAGS are put last. This makes it impossible to build on FreeBSD without extra hack, such as redefining CXX to include LDFLAGS.\n\nWe clean this mess up by making use of special variables (CDD-related) in its makefile, and remove LDFLAGS hack from spkg-install.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22812\n\n",
    "created_at": "2017-04-14T21:51:49Z",
    "labels": [
        "component: porting",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "correct linking flags of gfan",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22575",
    "user": "https://github.com/dimpase"
}
```
CC:  @kiwifb @embray

sometimes LDFLAGS must come first, but in gfan's makefile LDFLAGS are put last. This makes it impossible to build on FreeBSD without extra hack, such as redefining CXX to include LDFLAGS.

We clean this mess up by making use of special variables (CDD-related) in its makefile, and remove LDFLAGS hack from spkg-install.

Issue created by migration from https://trac.sagemath.org/ticket/22812





---

archive/issue_comments_314513.json:
```json
{
    "body": "Does this work OK on OSX and Cygwin?",
    "created_at": "2017-04-14T21:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314513",
    "user": "https://github.com/dimpase"
}
```

Does this work OK on OSX and Cygwin?



---

archive/issue_comments_314514.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-14T21:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314514",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_314515.json:
```json
{
    "body": "I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)\n\n```\n-ifeq ($(cddpath),)\n-CDD_LINKOPTIONS = -L/usr/local -lcddgmp\n+CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm\n CDD_INCLUDEOPTIONS =\n-else\n-CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a\n-CDD_INCLUDEOPTIONS = -I $(cddpath)/include\n-endif\n```\n\nWhy do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.",
    "created_at": "2017-04-19T03:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314515",
    "user": "https://github.com/kiwifb"
}
```

I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)

```
-ifeq ($(cddpath),)
-CDD_LINKOPTIONS = -L/usr/local -lcddgmp
+CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
 CDD_INCLUDEOPTIONS =
-else
-CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
-CDD_INCLUDEOPTIONS = -I $(cddpath)/include
-endif
```

Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.



---

archive/issue_comments_314516.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)\n\nWell, if you mean to say that I should leave the `else` part, which is never triggered under Sage, intact, I certainly can do this. (Although I see no harm in removing things which are not used).\n\n> {{{\n> -ifeq ($(cddpath),)\n> -CDD_LINKOPTIONS = -L/usr/local -lcddgmp\n> +CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm\n>  CDD_INCLUDEOPTIONS =\n> -else\n> -CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a\n> -CDD_INCLUDEOPTIONS = -I $(cddpath)/include\n> -endif\n> }}}\n> Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.\n\nApart from the `if/else` thing (as I said, I can leave it in), this is done to clean up the flags a bit; presently that\n`-L/usr/local -lcddgmp` is worked around in `spkg-install`, basically by appending the correct `-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm` to `LDFLAGS` (the latter are appended in the makefile). I cannot keep doing this, I really need `LDFLAGS` in front, for this to work.\n\nBesides, needless to say, if you really happen to have `libcddgmp` in `/usr/local/`, all the bets are off, you might end up with a linker error, or worse.\n\nI could have plugged `LDFLAGS` into the 1st position into the right line of of the makefile, and leave the rest as it is, but this is ugly IMHO.",
    "created_at": "2017-04-19T07:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314516",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:2 fbissey]:
> I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)

Well, if you mean to say that I should leave the `else` part, which is never triggered under Sage, intact, I certainly can do this. (Although I see no harm in removing things which are not used).

> {{{
> -ifeq ($(cddpath),)
> -CDD_LINKOPTIONS = -L/usr/local -lcddgmp
> +CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
>  CDD_INCLUDEOPTIONS =
> -else
> -CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
> -CDD_INCLUDEOPTIONS = -I $(cddpath)/include
> -endif
> }}}
> Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.

Apart from the `if/else` thing (as I said, I can leave it in), this is done to clean up the flags a bit; presently that
`-L/usr/local -lcddgmp` is worked around in `spkg-install`, basically by appending the correct `-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm` to `LDFLAGS` (the latter are appended in the makefile). I cannot keep doing this, I really need `LDFLAGS` in front, for this to work.

Besides, needless to say, if you really happen to have `libcddgmp` in `/usr/local/`, all the bets are off, you might end up with a linker error, or worse.

I could have plugged `LDFLAGS` into the 1st position into the right line of of the makefile, and leave the rest as it is, but this is ugly IMHO.



---

archive/issue_comments_314517.json:
```json
{
    "body": "OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.",
    "created_at": "2017-04-19T07:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314517",
    "user": "https://github.com/kiwifb"
}
```

OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.



---

archive/issue_comments_314518.json:
```json
{
    "body": "Replying to [comment:4 fbissey]:\n> OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.\n\nI merely move adding `-lm`, needed on other systems, not only FreeBSD, from `spkg-install` to the makefile directly. \n\n```\n-# set LDFLAGS with proper flags to link against gmp/mpir and cddlib\n-LDFLAGS=\"-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm $LDFLAGS\"\n```\n\n\nIf you think that all this can be done better, please do a branch...",
    "created_at": "2017-04-19T07:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314518",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:4 fbissey]:
> OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.

I merely move adding `-lm`, needed on other systems, not only FreeBSD, from `spkg-install` to the makefile directly. 

```
-# set LDFLAGS with proper flags to link against gmp/mpir and cddlib
-LDFLAGS="-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm $LDFLAGS"
```


If you think that all this can be done better, please do a branch...



---

archive/issue_comments_314519.json:
```json
{
    "body": "There are several way to skin a cat as they say, I go for either minimal or complete revamp - which would feel nice here. Quite a number of things have moved since the original `spkg-install` making it easier to be minimalistic.\n\nI'll do a branch...",
    "created_at": "2017-04-19T07:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314519",
    "user": "https://github.com/kiwifb"
}
```

There are several way to skin a cat as they say, I go for either minimal or complete revamp - which would feel nice here. Quite a number of things have moved since the original `spkg-install` making it easier to be minimalistic.

I'll do a branch...



---

archive/issue_comments_314520.json:
```json
{
    "body": "I invite you to test my small changes on my branch. I kept 90% of your changes, I only changed the `Makefile` patch with what I think is necessary. \n----\nNew commits:",
    "created_at": "2017-04-19T23:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314520",
    "user": "https://github.com/kiwifb"
}
```

I invite you to test my small changes on my branch. I kept 90% of your changes, I only changed the `Makefile` patch with what I think is necessary. 
----
New commits:



---

archive/issue_comments_314521.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314521",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_314522.json:
```json
{
    "body": "looks good to me. Should we  bump the package version too?",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314522",
    "user": "https://github.com/dimpase"
}
```

looks good to me. Should we  bump the package version too?



---

archive/issue_comments_314523.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2017-04-20T11:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314523",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_314524.json:
```json
{
    "body": "Jeroen always wants to bump. I am not always thrilled by it, but it certainly means more testing, which is his point.",
    "created_at": "2017-04-20T12:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314524",
    "user": "https://github.com/kiwifb"
}
```

Jeroen always wants to bump. I am not always thrilled by it, but it certainly means more testing, which is his point.



---

archive/issue_events_059311.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-23T12:57:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22575#event-59311"
}
```



---

archive/issue_comments_314525.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-23T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22575#issuecomment-314525",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
