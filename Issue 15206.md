# Issue 15206: Random time outs in ecm.py

archive/issues_015206.json:
```json
{
    "body": "CC:  was robertwb roed jpflori\n\nInfrequently, I get this doctest failure:\n\n```\nsage -t --long src/sage/interfaces/ecm.py\n    Timed out\n**********************************************************************\nTests run before process (pid=8764) timed out:\nsage: f = ECM() ## line 169 ##\nsage: n = 508021860739623467191080372196682785441177798407961 ## line 170 ##\nsage: f.one_curve(n, B1=10000, sigma=11) ## line 171 ##\n[1, 508021860739623467191080372196682785441177798407961]\nsage: f.one_curve(n, B1=10000, sigma=1022170541) ## line 173 ##\n[79792266297612017, 6366805760909027985741435139224233]\nsage: n = 432132887883903108009802143314445113500016816977037257 ## line 175 ##\nsage: f.one_curve(n, B1=500000, algorithm=\"P-1\") ## line 176 ##\n[67872792749091946529, 6366805760909027985741435139224233]\nsage: n = 2088352670731726262548647919416588631875815083 ## line 178 ##\nsage: f.one_curve(n, B1=2000, algorithm=\"P+1\", x0=5) ## line 179 ##\n[328006342451, 6366805760909027985741435139224233]\nsage: sig_on_count() ## line 181 ##\n0\nsage: f = ECM() ## line 241 ##\nsage: n = 508021860739623467191080372196682785441177798407961 ## line 242 ##\nsage: f.find_factor(n) ## line 243 ##\n[79792266297612017, 6366805760909027985741435139224233]\nsage: f=2^2^14+1 ## line 247 ##\nsage: ecm.find_factor(f) ## line 248 ##\nsage: sig_on_count() ## line 252 ##\n0\nsage: ecm.factor(602400691612422154516282778947806249229526581) ## line 333 ##\n[45949729863572179, 13109994191499930367061460439]\nsage: ecm.factor((2^197 + 1)/3)           # takes a long time ## line 336 ##\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15443\n\n",
    "created_at": "2013-11-21T14:21:39Z",
    "labels": [
        "number theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Random time outs in ecm.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15206",
    "user": "vbraun"
}
```
CC:  was robertwb roed jpflori

Infrequently, I get this doctest failure:

```
sage -t --long src/sage/interfaces/ecm.py
    Timed out
**********************************************************************
Tests run before process (pid=8764) timed out:
sage: f = ECM() ## line 169 ##
sage: n = 508021860739623467191080372196682785441177798407961 ## line 170 ##
sage: f.one_curve(n, B1=10000, sigma=11) ## line 171 ##
[1, 508021860739623467191080372196682785441177798407961]
sage: f.one_curve(n, B1=10000, sigma=1022170541) ## line 173 ##
[79792266297612017, 6366805760909027985741435139224233]
sage: n = 432132887883903108009802143314445113500016816977037257 ## line 175 ##
sage: f.one_curve(n, B1=500000, algorithm="P-1") ## line 176 ##
[67872792749091946529, 6366805760909027985741435139224233]
sage: n = 2088352670731726262548647919416588631875815083 ## line 178 ##
sage: f.one_curve(n, B1=2000, algorithm="P+1", x0=5) ## line 179 ##
[328006342451, 6366805760909027985741435139224233]
sage: sig_on_count() ## line 181 ##
0
sage: f = ECM() ## line 241 ##
sage: n = 508021860739623467191080372196682785441177798407961 ## line 242 ##
sage: f.find_factor(n) ## line 243 ##
[79792266297612017, 6366805760909027985741435139224233]
sage: f=2^2^14+1 ## line 247 ##
sage: ecm.find_factor(f) ## line 248 ##
sage: sig_on_count() ## line 252 ##
0
sage: ecm.factor(602400691612422154516282778947806249229526581) ## line 333 ##
[45949729863572179, 13109994191499930367061460439]
sage: ecm.factor((2^197 + 1)/3)           # takes a long time ## line 336 ##
```


Issue created by migration from https://trac.sagemath.org/ticket/15443





---

archive/issue_comments_195349.json:
```json
{
    "body": "ecm uses different seeds all the time, for example \n\n```\necho 179424673 | /home/vbraun/Code/sage/local/bin/ecm -I 1 -c 1000000000 -cofdec -one 8.0\n```\n\nproduces a different output every time.\n\n--------------\n\nOccasionally, ecm.py does a lot more factorizations and then eventually times out. Using strace, I see that, for example, the following is run when it eventually times out;\n\n```\necho 251951573867253012259144010843 | /home/vbraun/Code/sage/local/bin/ecm -I 1 -c 1000000000 -cofdec -one 8.0\n```\n\nNote that the command is rather slow (requires hundreds of trial steps) and that this prime (251951573867253012259144010843) is usually not used as an ecm input. So occasionally (but unlikely) one of the previous computations must yield this number as candidate and then factoring it takes a really long time.",
    "created_at": "2013-11-21T14:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195349",
    "user": "vbraun"
}
```

ecm uses different seeds all the time, for example 

```
echo 179424673 | /home/vbraun/Code/sage/local/bin/ecm -I 1 -c 1000000000 -cofdec -one 8.0
```

produces a different output every time.

--------------

Occasionally, ecm.py does a lot more factorizations and then eventually times out. Using strace, I see that, for example, the following is run when it eventually times out;

```
echo 251951573867253012259144010843 | /home/vbraun/Code/sage/local/bin/ecm -I 1 -c 1000000000 -cofdec -one 8.0
```

Note that the command is rather slow (requires hundreds of trial steps) and that this prime (251951573867253012259144010843) is usually not used as an ecm input. So occasionally (but unlikely) one of the previous computations must yield this number as candidate and then factoring it takes a really long time.



---

archive/issue_comments_195350.json:
```json
{
    "body": "In fact, the problematic doctest is factoring `(2^197 + 1)/3`. Usually, this yields from ecm:\n\n```\nFactor found in step 2: 197002597249\nFound probable prime factor of 12 digits: 197002597249\nComposite cofactor 339872432034468861533158743041639097889948066859 has 48 digits\n```\n\nBut randomly (and rather unlikely):\n\n```\nFactor found in step 2: 265748496095531068869578877937\nFound composite factor of 30 digits: 265748496095531068869578877937\nProbable prime cofactor 251951573867253012259144010843 has 30 digits\n```\n\nSo this is the origin of the prime 251951573867253012259144010843, which is then subsequently factored (but apparently very slowly).",
    "created_at": "2013-11-21T14:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195350",
    "user": "vbraun"
}
```

In fact, the problematic doctest is factoring `(2^197 + 1)/3`. Usually, this yields from ecm:

```
Factor found in step 2: 197002597249
Found probable prime factor of 12 digits: 197002597249
Composite cofactor 339872432034468861533158743041639097889948066859 has 48 digits
```

But randomly (and rather unlikely):

```
Factor found in step 2: 265748496095531068869578877937
Found composite factor of 30 digits: 265748496095531068869578877937
Probable prime cofactor 251951573867253012259144010843 has 30 digits
```

So this is the origin of the prime 251951573867253012259144010843, which is then subsequently factored (but apparently very slowly).



---

archive/issue_comments_195351.json:
```json
{
    "body": "Fun find: run ecm `find_factor()` on a prime:\n\n```\nsage: f = ECM()\nsage: f.find_factor(3)\n```\n\nOMG zombies everywhere!",
    "created_at": "2013-11-21T15:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195351",
    "user": "vbraun"
}
```

Fun find: run ecm `find_factor()` on a prime:

```
sage: f = ECM()
sage: f.find_factor(3)
```

OMG zombies everywhere!



---

archive/issue_comments_195352.json:
```json
{
    "body": "Thanks for the analysis! Just a question: do you plan to write a patch (if not, I might).",
    "created_at": "2013-11-21T17:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195352",
    "user": "jdemeyer"
}
```

Thanks for the analysis! Just a question: do you plan to write a patch (if not, I might).



---

archive/issue_comments_195353.json:
```json
{
    "body": "In working on it!",
    "created_at": "2013-11-21T19:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195353",
    "user": "vbraun"
}
```

In working on it!



---

archive/issue_comments_195354.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-11-22T15:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195354",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195355.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-11-23T01:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195355",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195356.json:
```json
{
    "body": "I haven't found any other issue in repeated testing, ready for review!",
    "created_at": "2013-11-23T01:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195356",
    "user": "vbraun"
}
```

I haven't found any other issue in repeated testing, ready for review!



---

archive/issue_comments_195357.json:
```json
{
    "body": "So I got 6.0_beta4 built and I tested sage/interfaces/ecm.py a thousand time. The last one (number 1000) failed :(\n\n```\nRunning doctests with ID 2013-12-11-12-59-50-efe5883e.\nDoctesting 1 file.\nsage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py\n**********************************************************************\nFile \"local/lib/python2.7/site-packages/sage/interfaces/ecm.py\", line 606, in sage.interfaces.ecm.ECM.get_last_params\nFailed example:\n    ecm.factor((2^197 + 1)/3)             # long time\nExpected:\n    [197002597249, 1348959352853811313, 251951573867253012259144010843]\nGot:\n    [197002597249, 339872432034468861533158743041639097889948066859]\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.interfaces.ecm.ECM.get_last_params\n    [43 tests, 1 failure, 6.84 s]\n----------------------------------------------------------------------\nsage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 6.9 seconds\n    cpu time: 0.1 seconds\n    cumulative wall time: 6.8 seconds\n```\n\nHow uncool is that.",
    "created_at": "2013-12-11T00:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195357",
    "user": "fbissey"
}
```

So I got 6.0_beta4 built and I tested sage/interfaces/ecm.py a thousand time. The last one (number 1000) failed :(

```
Running doctests with ID 2013-12-11-12-59-50-efe5883e.
Doctesting 1 file.
sage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py
**********************************************************************
File "local/lib/python2.7/site-packages/sage/interfaces/ecm.py", line 606, in sage.interfaces.ecm.ECM.get_last_params
Failed example:
    ecm.factor((2^197 + 1)/3)             # long time
Expected:
    [197002597249, 1348959352853811313, 251951573867253012259144010843]
Got:
    [197002597249, 339872432034468861533158743041639097889948066859]
**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.ecm.ECM.get_last_params
    [43 tests, 1 failure, 6.84 s]
----------------------------------------------------------------------
sage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 6.9 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 6.8 seconds
```

How uncool is that.



---

archive/issue_comments_195358.json:
```json
{
    "body": "You don't happen to have a strace of the failed attempt?",
    "created_at": "2013-12-11T00:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195358",
    "user": "vbraun"
}
```

You don't happen to have a strace of the failed attempt?



---

archive/issue_comments_195359.json:
```json
{
    "body": "No haven't thought of that. I am doing another run right now to see if I can reproduce it. But I will do that if I can reproduce it. \nThe other thing that struck me is that the time to run the test is highly variable from 3 to 10 seconds and I have no idea why that would be.",
    "created_at": "2013-12-11T01:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195359",
    "user": "fbissey"
}
```

No haven't thought of that. I am doing another run right now to see if I can reproduce it. But I will do that if I can reproduce it. 
The other thing that struck me is that the time to run the test is highly variable from 3 to 10 seconds and I have no idea why that would be.



---

archive/issue_comments_195360.json:
```json
{
    "body": "Nothing on the second run. I have bumped the number to 2000 and I am recording straces in case I see something again.",
    "created_at": "2013-12-11T02:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195360",
    "user": "fbissey"
}
```

Nothing on the second run. I have bumped the number to 2000 and I am recording straces in case I see something again.



---

archive/issue_comments_195361.json:
```json
{
    "body": "Ok I am not sure what kind of fluck happened in my first run. It is still the only failure I have seen in 4000 runs of that test.",
    "created_at": "2013-12-11T08:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195361",
    "user": "fbissey"
}
```

Ok I am not sure what kind of fluck happened in my first run. It is still the only failure I have seen in 4000 runs of that test.



---

archive/issue_comments_195362.json:
```json
{
    "body": "The timing difference is because ecm is random and without a fixed seed. Sometimes it just takes longer. And also depends on which of the three factors is found first.\n\nI've run 20k iterations of `ecm.factor((2^197 + 1)/3)` without any failure so far...",
    "created_at": "2013-12-11T18:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195362",
    "user": "vbraun"
}
```

The timing difference is because ecm is random and without a fixed seed. Sometimes it just takes longer. And also depends on which of the three factors is found first.

I've run 20k iterations of `ecm.factor((2^197 + 1)/3)` without any failure so far...



---

archive/issue_comments_195363.json:
```json
{
    "body": "Ok, the 22259-th iteration did fail ;-)   Now trying again with strace...",
    "created_at": "2013-12-11T20:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195363",
    "user": "vbraun"
}
```

Ok, the 22259-th iteration did fail ;-)   Now trying again with strace...



---

archive/issue_comments_195364.json:
```json
{
    "body": "Attachment [707.out](tarball://root/attachments/some-uuid/ticket15443/707.out) by fbissey created at 2013-12-11 20:46:19\n\nstrace for ecm failure run 707",
    "created_at": "2013-12-11T20:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195364",
    "user": "fbissey"
}
```

Attachment [707.out](tarball://root/attachments/some-uuid/ticket15443/707.out) by fbissey created at 2013-12-11 20:46:19

strace for ecm failure run 707



---

archive/issue_comments_195365.json:
```json
{
    "body": "strace for ecm run 1676",
    "created_at": "2013-12-11T20:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195365",
    "user": "fbissey"
}
```

strace for ecm run 1676



---

archive/issue_comments_195366.json:
```json
{
    "body": "Attachment [1676.out](tarball://root/attachments/some-uuid/ticket15443/1676.out) by fbissey created at 2013-12-11 20:47:34\n\nstrace for ecm failure run 3822",
    "created_at": "2013-12-11T20:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195366",
    "user": "fbissey"
}
```

Attachment [1676.out](tarball://root/attachments/some-uuid/ticket15443/1676.out) by fbissey created at 2013-12-11 20:47:34

strace for ecm failure run 3822



---

archive/issue_comments_195367.json:
```json
{
    "body": "Attachment [3822.out](tarball://root/attachments/some-uuid/ticket15443/3822.out) by fbissey created at 2013-12-11 20:50:08\n\nI started a 200000 sweep which stopped at 5040 (probably run out of inodes in the folder storing the straces) I have attached the straces for the 3 failures I got.",
    "created_at": "2013-12-11T20:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195367",
    "user": "fbissey"
}
```

Attachment [3822.out](tarball://root/attachments/some-uuid/ticket15443/3822.out) by fbissey created at 2013-12-11 20:50:08

I started a 200000 sweep which stopped at 5040 (probably run out of inodes in the folder storing the straces) I have attached the straces for the 3 failures I got.



---

archive/issue_comments_195368.json:
```json
{
    "body": "I need the strace of the ecm process, not of the main Sage python process... the latter doesn't tell us much.",
    "created_at": "2013-12-11T22:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195368",
    "user": "vbraun"
}
```

I need the strace of the ecm process, not of the main Sage python process... the latter doesn't tell us much.



---

archive/issue_comments_195369.json:
```json
{
    "body": "OK I thought it was thin. How do I attach to the started ecm process? Any suggestion for doing it in an automated way? strace -f (-ff)?",
    "created_at": "2013-12-11T22:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195369",
    "user": "fbissey"
}
```

OK I thought it was thin. How do I attach to the started ecm process? Any suggestion for doing it in an automated way? strace -f (-ff)?



---

archive/issue_comments_195370.json:
```json
{
    "body": "Attachment [test_until_fail.py](tarball://root/attachments/some-uuid/ticket15443/test_until_fail.py) by vbraun created at 2013-12-11 22:47:03\n\nscript for automatted testing with strace",
    "created_at": "2013-12-11T22:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195370",
    "user": "vbraun"
}
```

Attachment [test_until_fail.py](tarball://root/attachments/some-uuid/ticket15443/test_until_fail.py) by vbraun created at 2013-12-11 22:47:03

script for automatted testing with strace



---

archive/issue_comments_195371.json:
```json
{
    "body": "Yes, or see the attached script.",
    "created_at": "2013-12-11T22:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195371",
    "user": "vbraun"
}
```

Yes, or see the attached script.



---

archive/issue_comments_195372.json:
```json
{
    "body": "I think I understand how the script works, one more turn, then.",
    "created_at": "2013-12-11T22:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195372",
    "user": "fbissey"
}
```

I think I understand how the script works, one more turn, then.



---

archive/issue_comments_195373.json:
```json
{
    "body": "OK I got a failure. Any clue to find which strace is the good one?",
    "created_at": "2013-12-13T00:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195373",
    "user": "fbissey"
}
```

OK I got a failure. Any clue to find which strace is the good one?



---

archive/issue_comments_195374.json:
```json
{
    "body": "Grep for `bin/ecm`, for starters...",
    "created_at": "2013-12-13T12:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195374",
    "user": "vbraun"
}
```

Grep for `bin/ecm`, for starters...



---

archive/issue_comments_195375.json:
```json
{
    "body": "Better idea. The failure is \n\n```\nsage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py\n**********************************************************************\nFile \"local/lib/python2.7/site-packages/sage/interfaces/ecm.py\", line 572, in sage.interfaces.ecm.ECM.factor\nFailed example:\n    ecm.factor(602400691612422154516282778947806249229526581)\nExpected:\n    [45949729863572179, 13109994191499930367061460439]\nGot:\n    [602400691612422154516282778947806249229526581]\n```\n\nGrepping for 602400691612422154516282778947806249229526581 does the trick nicely. Two hits one from sage and one from ecm.",
    "created_at": "2013-12-15T20:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195375",
    "user": "fbissey"
}
```

Better idea. The failure is 

```
sage -t --long local/lib/python2.7/site-packages/sage/interfaces/ecm.py
**********************************************************************
File "local/lib/python2.7/site-packages/sage/interfaces/ecm.py", line 572, in sage.interfaces.ecm.ECM.factor
Failed example:
    ecm.factor(602400691612422154516282778947806249229526581)
Expected:
    [45949729863572179, 13109994191499930367061460439]
Got:
    [602400691612422154516282778947806249229526581]
```

Grepping for 602400691612422154516282778947806249229526581 does the trick nicely. Two hits one from sage and one from ecm.



---

archive/issue_comments_195376.json:
```json
{
    "body": "ecm strace for the failure",
    "created_at": "2013-12-15T20:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195376",
    "user": "fbissey"
}
```

ecm strace for the failure



---

archive/issue_comments_195377.json:
```json
{
    "body": "Attachment [strace.5385.bz2](tarball://root/attachments/some-uuid/ticket15443/strace.5385.bz2) by vbraun created at 2013-12-15 22:42:56\n\nReconstructed ECM output:\n\n```\nGMP-ECM 6.4.4 [configured with MPIR 2.6.0, --enable-asm-redc] [ECM]\nInput number is 602400691612422154516282778947806249229526581 (45 digits)\nUsing B1=2000, B2=147396, polynomial x^1, sigma=4179203867\nStep 1 took 2ms\nStep 2 took 3ms\nRun 2 out of 1000000000:\nUsing B1=2399, B2=2399-186156, polynomial x^1, sigma=4164584203\nStep 1 took 2ms\nStep 2 took 4ms\nRun 3 out of 1000000000:\nUsing B1=2806, B2=2806-224406, polynomial x^1, sigma=3854196504\nStep 1 took 3ms\nStep 2 took 3ms\nRun 4 out of 1000000000:\nUsing B1=3221, B2=3221-294786, polynomial x^1, sigma=3420982637\nStep 1 took 3ms\nStep 2 took 5ms\nRun 5 out of 1000000000:\nUsing B1=3644, B2=3644-294786, polynomial x^1, sigma=1430191020\n\n[...]\n\nUsing B1=22052, B2=22052-5026572, polynomial x^1, sigma=1562069045\nStep 1 took 20ms\nStep 2 took 26ms\nRun 38 out of 1000000000:\nUsing B1=22779, B2=22779-5026572, polynomial x^1, sigma=1306733316\nStep 1 took 21ms\nStep 2 took 25ms\nRun 39 out of 1000000000:\nUsing B1=23516, B2=23516-5031192, polynomial x^1, sigma=2409042976\nStep 1 took 22ms\nStep 2 took 25ms\nRun 40 out of 1000000000:\nUsing B1=24263, B2=24263-5031192, polynomial x^1, sigma=518178309\nStep 1 took 22ms\nStep 2 took 26ms\n********** Factor found in step 2: 602400691612422154516282778947806249229526581\nFound input number N\n```\n\nSo it seems that the \"Found input number N\" output doesn't imply that it is probably prime. Some documentation would have been nice, too. Though that leaves the question: how should we decide to give up? If the number is actually prime then it always ends in \"Found input number N\", so we can't just repeat until we find a factor. The readme says\n\n```\n5 - if no factor is found, either increase D by 5 digits and go to 0, or use \n    another factorization method (MPQS, NFS)\n```\n\nbut doesn't give any probability estimate in that case. Also, one of the factors in question is only 17 digits so the B1-values tried should have been just fine.",
    "created_at": "2013-12-15T22:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195377",
    "user": "vbraun"
}
```

Attachment [strace.5385.bz2](tarball://root/attachments/some-uuid/ticket15443/strace.5385.bz2) by vbraun created at 2013-12-15 22:42:56

Reconstructed ECM output:

```
GMP-ECM 6.4.4 [configured with MPIR 2.6.0, --enable-asm-redc] [ECM]
Input number is 602400691612422154516282778947806249229526581 (45 digits)
Using B1=2000, B2=147396, polynomial x^1, sigma=4179203867
Step 1 took 2ms
Step 2 took 3ms
Run 2 out of 1000000000:
Using B1=2399, B2=2399-186156, polynomial x^1, sigma=4164584203
Step 1 took 2ms
Step 2 took 4ms
Run 3 out of 1000000000:
Using B1=2806, B2=2806-224406, polynomial x^1, sigma=3854196504
Step 1 took 3ms
Step 2 took 3ms
Run 4 out of 1000000000:
Using B1=3221, B2=3221-294786, polynomial x^1, sigma=3420982637
Step 1 took 3ms
Step 2 took 5ms
Run 5 out of 1000000000:
Using B1=3644, B2=3644-294786, polynomial x^1, sigma=1430191020

[...]

Using B1=22052, B2=22052-5026572, polynomial x^1, sigma=1562069045
Step 1 took 20ms
Step 2 took 26ms
Run 38 out of 1000000000:
Using B1=22779, B2=22779-5026572, polynomial x^1, sigma=1306733316
Step 1 took 21ms
Step 2 took 25ms
Run 39 out of 1000000000:
Using B1=23516, B2=23516-5031192, polynomial x^1, sigma=2409042976
Step 1 took 22ms
Step 2 took 25ms
Run 40 out of 1000000000:
Using B1=24263, B2=24263-5031192, polynomial x^1, sigma=518178309
Step 1 took 22ms
Step 2 took 26ms
********** Factor found in step 2: 602400691612422154516282778947806249229526581
Found input number N
```

So it seems that the "Found input number N" output doesn't imply that it is probably prime. Some documentation would have been nice, too. Though that leaves the question: how should we decide to give up? If the number is actually prime then it always ends in "Found input number N", so we can't just repeat until we find a factor. The readme says

```
5 - if no factor is found, either increase D by 5 digits and go to 0, or use 
    another factorization method (MPQS, NFS)
```

but doesn't give any probability estimate in that case. Also, one of the factors in question is only 17 digits so the B1-values tried should have been just fine.



---

archive/issue_comments_195378.json:
```json
{
    "body": "Ah, OK. I see what happens. The case you are running into really has very low probability and it is surprising you're triggering it at all. You're basically finding BOTH factors together. The idea of ECM is to choose a group E over Z together with a group element G, such that for the integer N=p*q (it works for products of more primes too) such that the order of G mod p is B-smooth (allowing some non-smoothness with \"second stage\" large prime variation). However, if G mod q is *also* B-smooth then you're detecting both factors together.\n\nIn the analysis of ECM, it turns out the optimal parameter choice is such that the probability of hitting an (E,G) pair with B-smooth order of G mod p is pretty low. The probability of G mod q also being B-smooth should be pretty much independent. If p,q are roughly of the same size and you need on average N trials to find G mod p of B-smooth order, then you expect that in 1/N of *those* cases, G mod q also has B-smooth order. If q is much larger than p then this probability should be *much* lower. I'm surprised that for N=45949729863572179*13109994191499930367061460439 you guys are encountering this at all. It suggests that the B1 value used is a little on the large side if this happens with discernable frequency (what may happen is that you're simply unlucky the first few times and then you have increased B1 to such a point that finding both G mod p and G mod q to be B-smooth isn't such an unlikely event anymore. So perhaps you're increasing B1 a little too aggressively)\n\nAnyway, as you can see, certainly for p,q of roughly the same size (not ECM's forte, but if p,q are not big, ECM can still be useful for those), finding p*q as a factor is really something that has to be counted on.\n\nYou should REALLY NOT run ECM on a number that might be prime. You should FIRST prove the number is composite for certain. In that case, you can treat finding the input as factor as finding no factor at all and simply try another time (perhaps NOT increasing B1)",
    "created_at": "2013-12-16T02:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195378",
    "user": "nbruin"
}
```

Ah, OK. I see what happens. The case you are running into really has very low probability and it is surprising you're triggering it at all. You're basically finding BOTH factors together. The idea of ECM is to choose a group E over Z together with a group element G, such that for the integer N=p*q (it works for products of more primes too) such that the order of G mod p is B-smooth (allowing some non-smoothness with "second stage" large prime variation). However, if G mod q is *also* B-smooth then you're detecting both factors together.

In the analysis of ECM, it turns out the optimal parameter choice is such that the probability of hitting an (E,G) pair with B-smooth order of G mod p is pretty low. The probability of G mod q also being B-smooth should be pretty much independent. If p,q are roughly of the same size and you need on average N trials to find G mod p of B-smooth order, then you expect that in 1/N of *those* cases, G mod q also has B-smooth order. If q is much larger than p then this probability should be *much* lower. I'm surprised that for N=45949729863572179*13109994191499930367061460439 you guys are encountering this at all. It suggests that the B1 value used is a little on the large side if this happens with discernable frequency (what may happen is that you're simply unlucky the first few times and then you have increased B1 to such a point that finding both G mod p and G mod q to be B-smooth isn't such an unlikely event anymore. So perhaps you're increasing B1 a little too aggressively)

Anyway, as you can see, certainly for p,q of roughly the same size (not ECM's forte, but if p,q are not big, ECM can still be useful for those), finding p*q as a factor is really something that has to be counted on.

You should REALLY NOT run ECM on a number that might be prime. You should FIRST prove the number is composite for certain. In that case, you can treat finding the input as factor as finding no factor at all and simply try another time (perhaps NOT increasing B1)



---

archive/issue_comments_195379.json:
```json
{
    "body": "So for a poor physicist like me, how exactly should we go about testing (probabilistically, but with very low probability of failure comparable to the probability in ECM) that a number is not composite. Is that already implemented somewhere in Sage? Rabin-Miller with some particular list of witnesses?",
    "created_at": "2013-12-17T18:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195379",
    "user": "vbraun"
}
```

So for a poor physicist like me, how exactly should we go about testing (probabilistically, but with very low probability of failure comparable to the probability in ECM) that a number is not composite. Is that already implemented somewhere in Sage? Rabin-Miller with some particular list of witnesses?



---

archive/issue_comments_195380.json:
```json
{
    "body": "Replying to [comment:26 vbraun]:\n> So for a poor physicist like me, how exactly should we go about testing (probabilistically, but with very low probability of failure comparable to the probability in ECM) that a number is not composite. Is that already implemented somewhere in Sage? Rabin-Miller with some particular list of witnesses?\n\nI'd expect it to be available somewhere, yes, at the very least in PARI/GP. Baillie-PSW seems to be particularly bullet-proof (in the physics sense), with no known pseudo-primes. Finding a counterexample could raise some money for the sage foundation.\n\nImplementation accessible in sage:\n\n```\nsage: pari(N).ispseudoprime()\n```\n\n\n(so, presently, no-one is aware of a particular composite value of N for which this returns true, although I suspect no-one would conjecture such values don't exist)",
    "created_at": "2013-12-17T19:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195380",
    "user": "nbruin"
}
```

Replying to [comment:26 vbraun]:
> So for a poor physicist like me, how exactly should we go about testing (probabilistically, but with very low probability of failure comparable to the probability in ECM) that a number is not composite. Is that already implemented somewhere in Sage? Rabin-Miller with some particular list of witnesses?

I'd expect it to be available somewhere, yes, at the very least in PARI/GP. Baillie-PSW seems to be particularly bullet-proof (in the physics sense), with no known pseudo-primes. Finding a counterexample could raise some money for the sage foundation.

Implementation accessible in sage:

```
sage: pari(N).ispseudoprime()
```


(so, presently, no-one is aware of a particular composite value of N for which this returns true, although I suspect no-one would conjecture such values don't exist)



---

archive/issue_comments_195381.json:
```json
{
    "body": "Replying to [comment:27 nbruin]:\n> (so, presently, no-one is aware of a particular composite value of N for which this returns true, although I suspect no-one would conjecture such values don't exist)\n\nAccording to the PARI guys, the standard conjecture is that there exist infinitely many counterexamples, even though no single one is known.",
    "created_at": "2013-12-17T21:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195381",
    "user": "jdemeyer"
}
```

Replying to [comment:27 nbruin]:
> (so, presently, no-one is aware of a particular composite value of N for which this returns true, although I suspect no-one would conjecture such values don't exist)

According to the PARI guys, the standard conjecture is that there exist infinitely many counterexamples, even though no single one is known.



---

archive/issue_comments_195382.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-02-12T20:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195382",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_195383.json:
```json
{
    "body": "Use pari's isprime(n,2) see\nhttp://en.wikipedia.org/wiki/Adleman%E2%80%93Pomerance%E2%80%93Rumely_primality_test",
    "created_at": "2014-02-12T20:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195383",
    "user": "rws"
}
```

Use pari's isprime(n,2) see
http://en.wikipedia.org/wiki/Adleman%E2%80%93Pomerance%E2%80%93Rumely_primality_test



---

archive/issue_comments_195384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-02-13T16:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195384",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195385.json:
```json
{
    "body": "I belive this branch now addresses all comments.",
    "created_at": "2014-02-13T16:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195385",
    "user": "vbraun"
}
```

I belive this branch now addresses all comments.



---

archive/issue_comments_195386.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-02-13T16:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195386",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_195387.json:
```json
{
    "body": "How do you address #comment:9 ?",
    "created_at": "2014-02-13T17:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195387",
    "user": "fbissey"
}
```

How do you address #comment:9 ?



---

archive/issue_comments_195388.json:
```json
{
    "body": "I'm now first using a strong primality test and only then run ecm forever. So unless you have a counterexample to Baillie-PSW you are guaranteed to get the prime decomposition.",
    "created_at": "2014-02-13T17:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195388",
    "user": "vbraun"
}
```

I'm now first using a strong primality test and only then run ecm forever. So unless you have a counterexample to Baillie-PSW you are guaranteed to get the prime decomposition.



---

archive/issue_comments_195389.json:
```json
{
    "body": "Replying to [comment:36 vbraun]:\n> I'm now first using a strong primality test and only then run ecm forever. So unless you have a counterexample to Baillie-PSW you are guaranteed to get the prime decomposition.\nTo be clearer, you mean you run the probable primality test on what ECM.factor() returns and only stop if all factors pass?\nSo in the previous failing tests from comment:9, it will continue testing other curves when we were unlucky and ECM returned the composite input number?\n\nGroumpf, or rather if it does not pass probable primality at first, you only stop when the number of returned factors is strictly greater than one?\nIf you went for that, comment:23 will be solved, but not comment:9.\nSo another question, is it still possible to call ECM without that additional probable primality test?\n\nFrom my point of view, we should just accept the fact that ECM sometimes returns the full composite number (just as it will return factors which are composite), but document it and modify the doctests.",
    "created_at": "2014-02-13T17:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195389",
    "user": "jpflori"
}
```

Replying to [comment:36 vbraun]:
> I'm now first using a strong primality test and only then run ecm forever. So unless you have a counterexample to Baillie-PSW you are guaranteed to get the prime decomposition.
To be clearer, you mean you run the probable primality test on what ECM.factor() returns and only stop if all factors pass?
So in the previous failing tests from comment:9, it will continue testing other curves when we were unlucky and ECM returned the composite input number?

Groumpf, or rather if it does not pass probable primality at first, you only stop when the number of returned factors is strictly greater than one?
If you went for that, comment:23 will be solved, but not comment:9.
So another question, is it still possible to call ECM without that additional probable primality test?

From my point of view, we should just accept the fact that ECM sometimes returns the full composite number (just as it will return factors which are composite), but document it and modify the doctests.



---

archive/issue_comments_195390.json:
```json
{
    "body": "Maybe you want to read the `factor()` method. First primality test, if that fails run ecm until it finds a factor. Repeat until you get a prime factorization.\n\nThere is already a method `find_factor()` that just runs the ECM output and may or may not return a factor. But that is a) annoying to doctest and b) not very user-friendly.",
    "created_at": "2014-02-13T18:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195390",
    "user": "vbraun"
}
```

Maybe you want to read the `factor()` method. First primality test, if that fails run ecm until it finds a factor. Repeat until you get a prime factorization.

There is already a method `find_factor()` that just runs the ECM output and may or may not return a factor. But that is a) annoying to doctest and b) not very user-friendly.



---

archive/issue_comments_195391.json:
```json
{
    "body": "Replying to [comment:38 vbraun]:\n> Maybe you want to read the `factor()` method. First primality test, if that fails run ecm until it finds a factor. Repeat until you get a prime factorization.\nSure, just had no time.\nIt looks good and I 'll try to review that tonight if I catch some time.\n> \n> There is already a method `find_factor()` that just runs the ECM output and may or may not return a factor. But that is a) annoying to doctest and b) not very user-friendly.",
    "created_at": "2014-02-13T19:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195391",
    "user": "jpflori"
}
```

Replying to [comment:38 vbraun]:
> Maybe you want to read the `factor()` method. First primality test, if that fails run ecm until it finds a factor. Repeat until you get a prime factorization.
Sure, just had no time.
It looks good and I 'll try to review that tonight if I catch some time.
> 
> There is already a method `find_factor()` that just runs the ECM output and may or may not return a factor. But that is a) annoying to doctest and b) not very user-friendly.



---

archive/issue_comments_195392.json:
```json
{
    "body": "Now that I have read the patch better (anything is better than reading a patch early in the morning after being woken up by a crying 3 year old) it looks good. I don't really have the time to give it the trashing I gave the previous one right now but I assume you did :)",
    "created_at": "2014-02-14T02:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195392",
    "user": "fbissey"
}
```

Now that I have read the patch better (anything is better than reading a patch early in the morning after being woken up by a crying 3 year old) it looks good. I don't really have the time to give it the trashing I gave the previous one right now but I assume you did :)



---

archive/issue_comments_195393.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-14T11:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195393",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_195394.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2014-02-14T14:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195394",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_195395.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-02-14T14:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195395",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_195396.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-14T19:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15206#issuecomment-195396",
    "user": "vbraun"
}
```

Resolution: fixed
