# Issue 20986: ECM segfaults in Cygwin64

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-08-11 12:09:08

CC:  jpflori tscrim

Running ECM with almost any inputs results in a segfault on Cygwin64.

More details soon.


---

Comment by embray created at 2016-08-11 12:21:02

Changing status from new to needs_review.


---

Comment by embray created at 2016-08-11 12:21:02

New commits:


---

Comment by leif created at 2016-08-11 13:20:10

ECM 7.x got "revived", see #20385.  7.0.3 is still kind of beta/rc though I'd say.


---

Comment by git created at 2016-08-11 13:21:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-08-11 13:22:41

... as is the branch on #20385; i.e., not really "needs review" yet, but you could try whether that has been fixed upstream already, probably with vanilla 7.0.3.


---

Comment by leif created at 2016-08-11 13:36:10

Replying to [comment:5 leif]:
> you could try whether that has been fixed upstream already, probably with vanilla 7.0.3.

Nope, in 7.0.3 (now `configure.ac`) there's still:

```sh
if test "x$enable_asm_redc" = xyes; then
# do the necessary definitions and includes
  AC_DEFINE([USE_ASM_REDC],1,[Define to 1 to use asm redc])
  test "x$CCAS" != x || CCAS="$CC -c"
  AC_SUBST([CCAS])
  GMP_PROG_M4
  GMP_ASM_UNDERSCORE
  GMP_ASM_TEXT
  GMP_ASM_GLOBL
  GMP_ASM_TYPE

  case $host in
    *-*-mingw32) GMP_DEFINE([WINDOWS64_ABI], 1)
                 AC_DEFINE([WINDOWS64_ABI], 1,[Define to 1 if x86_64 mulredc*() functions should be called with Windows ABI]);;
    *) ;;
  esac

  case $host in
    pentium3-*-*)
      echo "WARNING: Your processor is recognized as Pentium3."
      echo "         The asm code uses SSE2, and therefore it might"
      echo "         fail if your proc is indeed a P3, and not a"
      echo "         Pentium M. If you have compilation problems,"
      echo "         consider using --disable-asm-redc." ;;
    *)
  esac
fi
AM_CONDITIONAL([ENABLE_ASM_REDC], [test "x$enable_asm_redc" = xyes])
```



---

Comment by leif created at 2016-08-11 13:46:37

I'll take care of including this patch on #20385 if upstream won't include it soon.


---

Comment by embray created at 2016-08-11 14:00:23

Okay, thanks.


---

Comment by jdemeyer created at 2016-08-15 07:41:09

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-15 07:41:09

1. This should be reported upstream.

2. You need to patch `configure.in` _before_ `configure` otherwise the build system will want to run `autoconf` to update `configure`.

3. I cannot test this, but the patch is clear. If you say this makes ECM work on Cygwin64, that's good enough for me.


---

Comment by leif created at 2016-08-15 13:44:15

Replying to [comment:9 jdemeyer]:
> 2. You need to patch `configure.in` _before_ `configure` otherwise the build system will want to run `autoconf` to update `configure`.

Oh right, `patch` doesn't _by default_ take the modification time from the patch header (where `configure` is about a minute newer).

While it would be safer to explicitly `touch configure` after patching in `spkg-install`, `make` _should<sup>TM</sup>_ treat `configure` up-to-date if you just reverse the order in the patch.  (I'm not even sure it wouldn't as is; you'd probably need a _very slow_ machine to cause it to not do so.)


---

Comment by git created at 2016-08-16 09:08:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-08-16 13:57:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-08-16 14:03:28

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-08-16 14:03:57

I assume you actually tested this on Cygwin64 :-)


---

Comment by leif created at 2016-08-16 14:10:07

Jeroen was quicker, but I also didn't test this _on Cygwin[64]_...


---

Comment by embray created at 2016-08-16 14:28:56

Yup. Before this patch, running ecm segfaults.  Without it, no segfaults (and all the tests that invoke it pass)


---

Comment by leif created at 2016-08-16 16:05:00

FWIW, I guess similar would still happen on Cygwin*32* on some x86 CPUs at least (probably x86_64 in 32-bit mode as well), but only if one _explicitly_ configures GMP-ECM with `--enable-asm-redc`, which we _don't_ do in Sage.  (A user could still do that in _Sage's_ environment variable `ECM_CONFIGURE` though.)  The relevant asm code is in `athlon/` and `pentium4/`.

Not sure whether the NTT inline assembly code (which is only used on [some] x86 CPUs, and again probably also on x86_64 in 32-bit mode) is safe w.r.t. the Windows ABI.  (It _might_ get used on Cygwin*32*, even by default, depending on the CPU, AFAICS.)

But both is IMHO beyond this ticket, since the ticket's title mentions just Cygwin*64*.  (Feel free to try and eventually open a follow-up ticket for that... :P -- I personally won't.)


---

Comment by embray created at 2016-08-16 16:12:18

The solution in the ticket just targets "cygwin" so it's a moot point I think.

Also I'm personally _only_ targeting Sage for Cygwin64.  Reason being I hope soon (once most of the issues are worked out) to release a Windows installer for Sage that includes cygwin as a DLL.  This is for users, less so developers, and I'm not interested in non-64-bit platforms (though willing to poke at them if absolutely necessary).


---

Comment by leif created at 2016-08-16 16:35:46

Replying to [comment:19 embray]:
> The solution in the ticket just targets "cygwin" so it's a moot point I think.

Nope, that doesn't fix the two issues I mentioned above, as on 32-bit systems the x86_64 code isn't used, and (of course) only in the latter `WINDOWS64_ABI` is used at all.  (There's no macro for Windows ABI in general, nor Win32 ABI, although native Microsoft Windows -- with MS Visual Foo -- is handled.)

\\

> Also I'm personally _only_ targeting Sage for Cygwin64.  Reason being I hope soon (once most of the issues are worked out) to release a Windows installer for Sage that includes cygwin as a DLL.  This is for users, less so developers, and I'm not interested in non-64-bit platforms (though willing to poke at them if absolutely necessary).

Ok.

Other Sage-on-Cygwin developers may try.  (You could still detail your upstream report though, as it effectively only addresses Cygwin*64*.)


---

Comment by embray created at 2016-08-17 07:44:16

I'm not really sure what you're trying to say here.


---

Comment by leif created at 2016-08-17 09:43:33

Replying to [comment:21 embray]:
> I'm not really sure what you're trying to say here.

On *32-bit* systems (including Cygwin*32*), _other_ assembly files are used, which may cause similar problems (because they at least don't care about Pascal calling convention).

There's also some _inline assembly_ which is used on 32-bit (x86) systems only; there I'm not sure whether it complies also to the Win32 ABI w.r.t. register usage.


---

Comment by embray created at 2016-08-19 10:28:41

Ah, okay.  That I don't know.  If it is a problem it can be addressed in a new ticket.


---

Comment by leif created at 2016-08-19 10:58:08

Replying to [comment:23 embray]:
> Ah, okay.  That I don't know.  If it is a problem it can be addressed in a new ticket.

Sure.  In any case, it's easy to work around potential problems on Cygwin32 by simply setting `ECM_CONFIGURE="--disable-sse2 --disable-asm-redc"` before or when (re)installing the package.

Who is likely to test on Cygwin32?


---

Comment by vbraun created at 2016-08-19 22:44:59

Resolution: fixed


---

Comment by zimmerma created at 2016-08-23 06:54:11

patch applied upstream. Are you sure this is fine under 32-bit cygwin too?

Paul


---

Comment by jpflori created at 2016-08-23 08:50:36

I should be able to test Cygwin32 this afternoon.


---

Comment by zimmerma created at 2016-08-23 09:43:32

> I should be able to test Cygwin32 this afternoon.

great! Please test revision 2976 (or later) of GMP-ECM:

$ svn checkout svn://scm.gforge.inria.fr/svnroot/ecm/trunk ecm

Paul


---

Comment by leif created at 2016-08-23 11:56:11

Replying to [comment:28 jpflori]:
> I should be able to test Cygwin32 this afternoon.

I replied to Paul on the upstream bug report.  (The patch here won't _break_ anything on Cygwin32, but it won't solve potential similar issues on 32-bit Cygwin either.)

You may try trunk (outside of Sage) with `--enable-sse2` (but without `--enable-asm-redc`), perhaps running `make longcheck` instead of just `make check`, and afterwards with `--enable-asm-redc` (but without `--enable-sse2`).


---

Comment by leif created at 2016-08-23 12:15:29

Replying to [comment:30 leif]:
> Replying to [comment:28 jpflori]:
> > I should be able to test Cygwin32 this afternoon.
> You may try trunk (outside of Sage) with `--enable-sse2` (but without `--enable-asm-redc`), perhaps running `make longcheck` instead of just `make check`, and afterwards with `--enable-asm-redc` (but without `--enable-sse2`).

Also saving the `config.log`s and the build logs perhaps, to see what actually got used.  (In *6.4.4*, there's 32-bit asm code in `athlon/` and `pentium4/`, besides inline assembly in `{ntt_gfp,spv}.c`, which is less critical I think.  Just noticed ECM *7.x* now also has `x86/`, which I haven't at all looked at yet.)


---

Comment by leif created at 2016-08-23 12:30:19

Replying to [comment:31 leif]:
> (In *6.4.4*, there's 32-bit asm code in `athlon/` and `pentium4/`, besides inline assembly in `{ntt_gfp,spv}.c`, which is less critical I think.  Just noticed ECM *7.x* now also has `x86/`, which I haven't at all looked at yet.)

Oh, there's no _assembly code_ in `x86/`, just `params.h`:

```C
#define MPZMOD_THRESHOLD 135
#define REDC_THRESHOLD 200
#define MPN_MUL_LO_THRESHOLD_TABLE {0, 0, 1, 1, 0, 0, 5, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 14, 14, 16, 16, 1}
#define NTT_GFP_TWIDDLE_DIF_BREAKOVER 11
#define NTT_GFP_TWIDDLE_DIT_BREAKOVER 11
#define MUL_NTT_THRESHOLD 262144
#define PREREVERTDIVISION_NTT_THRESHOLD 128
#define POLYINVERT_NTT_THRESHOLD 65536
#define POLYEVALT_NTT_THRESHOLD 16384
#define MPZSPV_NORMALISE_STRIDE 512
```


(And there's of course also inline assembly in `longlong.h`; don't know what's used on Cygwin[32], but presumably less critical, too.)


---

Comment by jpflori created at 2016-08-23 15:39:27

Some reports using ECM trunk.
On a x86_64, with a Cygwin64 setup, outside of Sage, using my own GMP 6.1.1 (dll) and Cygwin's GCC:

```
./configure --prefix=$LOCAL --with-gmp=$LOCAL --enable-shared --disable-static
```

I get

```
...
configure: Build for host type x86_64-unknown-cygwin
configure: CC=gcc, CFLAGS=-W -Wall -Wundef -O2 -pedantic -fomit-frame-pointer -m64 -mtune=sandybridge -march=sandybridge
configure: Linking GMP with -lgmp
configure: Using asm redc code from directory x86_64
configure: Not using SSE2 instructions in NTT code
configure: Using APRCL to prove factors prime/composite
configure: Assertions enabled
configure: Shell command execution disabled
configure: OpenMP disabled
configure: Memory debugging disabled
```

and make fails with

```
m4 -I../ -DOPERATION_mulredc1 `test -f mulredc1.asm || echo './'`mulredc1.asm >mulredc1.s
/bin/sh ../libtool    --mode=compile gcc  -O2 -pedantic -fomit-frame-pointer -m64 -mtune=sandybridge -march=sandybridge -c -o mulredc1.lo mulredc1.s
libtool: compile:  gcc -O2 -pedantic -fomit-frame-pointer -m64 -mtune=sandybridge -march=sandybridge -c mulredc1.s  -DDLL_EXPORT -DPIC -o .libs/mulredc1.o
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/as: BFD assertion (GNU Binutils) 2.25.2 a échoué /cygdrive/i/szsz/tmpp/cygwin64/binutils/binutils-2.25-4.x86_64/src/binutils-gdb/bfd/coff-x86_64.c:695
mulredc1.s: Messages de l'assembleur:
mulredc1.s:59: Erreur: ne peut représenter le type de réadressage BFD_RELOC_386_GOTPC
```

Windows does not like `$_GLOBAL_OFFSET_TABLE` I would say.

Using ECM 6.4.4 on my Cygwin64 setup with the patch to use Win64 ABI, I get a similar configuration and `make` is fine.
Surely `WANT_ASSERT` gets set in one case and not in the other, leading to the invalid use of the GOT in the trunk version.
But then `make check` fails with

```
./test.pp1 ./ecm.exe
Cygwin runtime failure: /home/jp/ecm-6.4.4/.libs/ecm.exe: Invalid relocation.  Offset 0x3025f223a at address 0x100414542 doesn't fit into 32 bits
############### ERROR ###############
Expected return code 8 but got 127
make: *** [Makefile:1982: check] Error 1
```


Going back to the trunk version and passing `--disable-assert`, `make` is fine.
And `make check` runs but fail all tests.

```
FAIL: test.pp1
FAIL: test.pm1
FAIL: test.ecm
```

with the same relocation errors as in 6.4.4 as the log files tell.

On the same x86_64 machine, with the trunk version, using a Cygwin32 setup with a similar configure command, I get:

```
configure: Build for host type i686-pc-cygwin
configure: CC=gcc, CFLAGS=-W -Wall -Wundef -m32 -O2 -pedantic -fomit-frame-pointer -mtune=sandybridge -march=sandybridge
configure: Linking GMP with -lgmp
configure: Not using asm redc code
configure: Using SSE2 instructions in NTT code
configure: Using APRCL to prove factors prime/composite
configure: Assertions enabled
configure: Shell command execution disabled
configure: OpenMP disabled
configure: Memory debugging disabled
```

and `make` and `make check` are ok.


---

Comment by jpflori created at 2016-08-23 15:42:39

Just realized the "relocation" errors might just be rebasing issues...


---

Comment by embray created at 2016-08-23 16:46:20

Patch has been accepted upstream.


---

Comment by jpflori created at 2016-08-23 17:18:49

Replying to [comment:34 jpflori]:
> Just realized the "relocation" errors might just be rebasing issues...
And I can confirm  they are.


---

Comment by jpflori created at 2016-08-23 17:28:09

I'll post further experiments on #20385.


---

Comment by leif created at 2016-08-23 22:14:42

Or did I miss something?


---

Comment by embray created at 2016-08-24 08:47:09

I'm not sure I understand the meaning--I took "in a later stable release" to mean there will eventually be a stable release that contains this fix.  "Later" to me implies that it doesn't exist yet, but will.


---

Comment by leif created at 2016-08-24 10:41:26

Replying to [comment:39 embray]:
> I'm not sure I understand the meaning--I took "in a later stable release" to mean there will eventually be a stable release that contains this fix.  "Later" to me implies that it doesn't exist yet, but will.

No, "later" refers to what we currently have in Sage, so _"fixed in a later [stable] upstream release"_ means there exists some upstream version without the issue, but Sage hasn't yet upgraded to it (which is quite often the case as some upgrades aren't straight-forward, for various reasons).


---

Comment by leif created at 2016-08-24 10:45:25

So it's not as speculative as you thought... ;-)


---

Comment by embray created at 2016-08-25 09:28:58

Okay, I've been misusing that then!  Indeed I thought it was mostly speculative (but generally likely to be accurate for active projects).   Anyways, fine by me.


---

Comment by zimmerma created at 2016-08-26 13:21:30

a new release candidate is now available at

https://members.loria.fr/PZimmermann/ecm-7.0.4-rc1.tar.gz

Paul
