# Issue 16590: Use atomic_write in sage-preparse

Issue created by migration from https://trac.sagemath.org/ticket/16827

Original creator: jdemeyer

Original creation time: 2014-08-14 11:50:12

To avoid race conditions, the script `sage-preparse` should use `atomic_write`.


---

Comment by jdemeyer created at 2014-08-14 13:11:59

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-08-14 13:11:59

New commits:


---

Comment by vbraun created at 2014-09-09 21:10:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2014-09-09 21:24:37

I know this isn't part of this ticket, but there is a long-standing problem with preparsing that should be easy to fix: if you happen to give a file the same name as a Python module (which is not hard to do; I've seen people use "new.sage" and "socket.sage" before), then the preparsed file can shadow the actual Python module. I think a patch like this ought to fix it:

```diff
diff --git a/src/bin/sage-preparse b/src/bin/sage-preparse
index e2d5e9c..dff9800 100755
--- a/src/bin/sage-preparse
+++ b/src/bin/sage-preparse
@@ -86,7 +86,7 @@ def do_preparse(f, files_before=[]):
         print "%s: Unknown file type %s"%(sys.argv[0], f)
         sys.exit(1)
 
-    fname = '%s.py'%f[:-5]
+    fname = '%s_preparsed.py'%f[:-5]
     if os.path.exists(fname):
         if AUTOGEN_MSG not in open(fname).read():
             print "Refusing to overwrite existing non-autogenerated file '%s'."%os.path.abspath(fname)
diff --git a/src/bin/sage-run b/src/bin/sage-run
index 3f2700b..638c770 100755
--- a/src/bin/sage-run
+++ b/src/bin/sage-run
@@ -20,7 +20,7 @@ if fn.startswith('-'):
 if fn.endswith('.sage'):
     if call(['sage-preparse', fn]) != 0:
         sys.exit(1)
-    os.execvp('sage-python', ['sage-python', fn[:-5] + '.py'] + opts)
+    os.execvp('sage-python', ['sage-python', fn[:-5] + '_preparsed.py'] + opts)
 elif fn.endswith('.pyx') or fn.endswith('.spyx'):
     os.execvp('sage-run-cython', ['sage-run-cython', fn] + opts)
 else:
```

Alternatively, there is another approach at #11821, which also might prevent the race conditions discussed here: don't write the preparsed output to a file, just use standard output.


---

Comment by vbraun created at 2014-09-10 10:10:15

John, can you move you comment to a new ticket? I'm going to merge and close this ticket now.


---

Comment by jdemeyer created at 2014-09-10 10:14:17

New ticket: #16955


---

Comment by vbraun created at 2014-09-10 21:45:19

Resolution: fixed
