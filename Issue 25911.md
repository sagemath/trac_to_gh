# Issue 25911: infinite loop in spectral_radius for trees

archive/issues_025911.json:
```json
{
    "body": "CC:  @videlec maurimo\n\nIssue raised on https://ask.sagemath.org/question/43496/why-cant-i-find-the-spectral-radius-of-a-tree/\n\nThe following instruction will never end\n\n```\nsage: g = graphs.CompleteBipartiteGraph(1,3)\nsage: g.spectral_radius()\n```\n\n\nAdding a print in the while loop to get `e_max`, `e_min`, `c_prec`, `e_max-e_min`, `e_max * c_prec`, we get \n\n```\nsage: g.spectral_radius()\n3.0 1.0 1e-10 2.0 3e-10\n3.0 1.0 1e-10 2.0 3e-10\n3.0 1.0 1e-10 2.0 3e-10\n...\n```\n\nand its the same for every tree. It's working well if the graph has a single edge, but for the path graph of order 3, we already get the infinite loop.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26148\n\n",
    "created_at": "2018-08-28T09:49:55Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "infinite loop in spectral_radius for trees",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25911",
    "user": "https://github.com/dcoudert"
}
```
CC:  @videlec maurimo

Issue raised on https://ask.sagemath.org/question/43496/why-cant-i-find-the-spectral-radius-of-a-tree/

The following instruction will never end

```
sage: g = graphs.CompleteBipartiteGraph(1,3)
sage: g.spectral_radius()
```


Adding a print in the while loop to get `e_max`, `e_min`, `c_prec`, `e_max-e_min`, `e_max * c_prec`, we get 

```
sage: g.spectral_radius()
3.0 1.0 1e-10 2.0 3e-10
3.0 1.0 1e-10 2.0 3e-10
3.0 1.0 1e-10 2.0 3e-10
...
```

and its the same for every tree. It's working well if the graph has a single edge, but for the path graph of order 3, we already get the infinite loop.

Issue created by migration from https://trac.sagemath.org/ticket/26148





---

archive/issue_comments_365168.json:
```json
{
    "body": "I don't know how to fix that.",
    "created_at": "2018-08-28T11:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365168",
    "user": "https://github.com/dcoudert"
}
```

I don't know how to fix that.



---

archive/issue_comments_365169.json:
```json
{
    "body": "Indeed, this is very bad for any bipartite graph because the two eigenvalues are `lambda1` (the spectral radius) and `-lambda1`. Something special needs to be done in that case. One simple option is to consider the square of the adjacency matrix (reduced to one of the bi partition). I will try to provide a fix.",
    "created_at": "2018-08-29T03:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365169",
    "user": "https://github.com/videlec"
}
```

Indeed, this is very bad for any bipartite graph because the two eigenvalues are `lambda1` (the spectral radius) and `-lambda1`. Something special needs to be done in that case. One simple option is to consider the square of the adjacency matrix (reduced to one of the bi partition). I will try to provide a fix.



---

archive/issue_comments_365170.json:
```json
{
    "body": "Though, in the case of trees as requested on ask I am sure there are much more clever things to do.",
    "created_at": "2018-08-29T03:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365170",
    "user": "https://github.com/videlec"
}
```

Though, in the case of trees as requested on ask I am sure there are much more clever things to do.



---

archive/issue_comments_365171.json:
```json
{
    "body": "More precisely, here is the problem. Iterating the incidence matrix gets you into a cycle of length two\n\n```\nsage: g = graphs.CompleteBipartiteGraph(1,3)\nsage: A = g.adjacency_matrix().change_ring(RDF)\nsage: v = vector([1,2,3,4])\nsage: v = A*v; v/= v.norm(); v\n(0.9819805060619657, 0.1091089451179962, 0.1091089451179962, 0.1091089451179962)\nsage: v = A*v; v/= v.norm(); v\n(0.18898223650461365, 0.566946709513841, 0.566946709513841, 0.566946709513841)\nsage: v = A*v; v/= v.norm(); v\n(0.9819805060619656, 0.10910894511799618, 0.10910894511799618, 0.10910894511799618)\nsage: v = A*v; v/= v.norm(); v\n(0.18898223650461363, 0.5669467095138409, 0.5669467095138409, 0.5669467095138409)\n```\n\nBut with `A^2` everything is fine\n\n```\nsage: w = A**2 * v\nsage: [w[i] / v[i] for i in range(4)]\n[3.0, 3.0, 3.0, 3.0]\n```\n\n(and the eigenvalue is indeed sqrt(3) for the initial graph).",
    "created_at": "2018-08-29T03:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365171",
    "user": "https://github.com/videlec"
}
```

More precisely, here is the problem. Iterating the incidence matrix gets you into a cycle of length two

```
sage: g = graphs.CompleteBipartiteGraph(1,3)
sage: A = g.adjacency_matrix().change_ring(RDF)
sage: v = vector([1,2,3,4])
sage: v = A*v; v/= v.norm(); v
(0.9819805060619657, 0.1091089451179962, 0.1091089451179962, 0.1091089451179962)
sage: v = A*v; v/= v.norm(); v
(0.18898223650461365, 0.566946709513841, 0.566946709513841, 0.566946709513841)
sage: v = A*v; v/= v.norm(); v
(0.9819805060619656, 0.10910894511799618, 0.10910894511799618, 0.10910894511799618)
sage: v = A*v; v/= v.norm(); v
(0.18898223650461363, 0.5669467095138409, 0.5669467095138409, 0.5669467095138409)
```

But with `A^2` everything is fine

```
sage: w = A**2 * v
sage: [w[i] / v[i] for i in range(4)]
[3.0, 3.0, 3.0, 3.0]
```

(and the eigenvalue is indeed sqrt(3) for the initial graph).



---

archive/issue_comments_365172.json:
```json
{
    "body": "`@`dcoudert: do you know why `is_bipartite` is not there on directed graph? The notion of bipartiteness does not care about orientation at all.",
    "created_at": "2018-08-29T04:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365172",
    "user": "https://github.com/videlec"
}
```

`@`dcoudert: do you know why `is_bipartite` is not there on directed graph? The notion of bipartiteness does not care about orientation at all.



---

archive/issue_comments_365173.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-08-29T05:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365173",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_365174.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-29T05:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365174",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_365175.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> `@`dcoudert: do you know why `is_bipartite` is not there on directed graph? The notion of bipartiteness does not care about orientation at all.\nIt's certainly because noone asked for this feature yet? \n\nWe can move the method to `generic_graph.py`. The part that tests bipartiteness is the same. However, we must update the method for finding a cycle when the digraph is not bipartite as shortest path methods care about orientation.",
    "created_at": "2018-08-29T07:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365175",
    "user": "https://github.com/dcoudert"
}
```

Replying to [comment:5 vdelecroix]:
> `@`dcoudert: do you know why `is_bipartite` is not there on directed graph? The notion of bipartiteness does not care about orientation at all.
It's certainly because noone asked for this feature yet? 

We can move the method to `generic_graph.py`. The part that tests bipartiteness is the same. However, we must update the method for finding a cycle when the digraph is not bipartite as shortest path methods care about orientation.



---

archive/issue_comments_365176.json:
```json
{
    "body": "The test `if not G` treats the empty graph only, so it's not appropriate for graph without edges. The correct test is `if not G.size()`.\n\nThe current behavior is that a graph without edges is considered bipartite. I agree with that. For the empty graph, it's always ambiguous in definitions...\n\nConcerning the method you propose for bipartite graphs in fact you use a method similar to `project_left` in `BipartiteGraph`, except that the projection don't accept loops/multiedges.",
    "created_at": "2018-08-29T07:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365176",
    "user": "https://github.com/dcoudert"
}
```

The test `if not G` treats the empty graph only, so it's not appropriate for graph without edges. The correct test is `if not G.size()`.

The current behavior is that a graph without edges is considered bipartite. I agree with that. For the empty graph, it's always ambiguous in definitions...

Concerning the method you propose for bipartite graphs in fact you use a method similar to `project_left` in `BipartiteGraph`, except that the projection don't accept loops/multiedges.



---

archive/issue_comments_365177.json:
```json
{
    "body": "Replying to [comment:8 dcoudert]:\n> The test `if not G` treats the empty graph only, so it's not appropriate for graph without edges. The correct test is `if not G.size()`.\n> \n> The current behavior is that a graph without edges is considered bipartite. I agree with that. For the empty graph, it's always ambiguous in definitions...\n> \n> Concerning the method you propose for bipartite graphs in fact you use a method similar to `project_left` in `BipartiteGraph`, except that the projection don't accept loops/multiedges.\n\nIndeed. Note that `project_left` also produces a graph and not a digraph. Why on earth is this called `project_left`?",
    "created_at": "2018-08-29T12:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365177",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 dcoudert]:
> The test `if not G` treats the empty graph only, so it's not appropriate for graph without edges. The correct test is `if not G.size()`.
> 
> The current behavior is that a graph without edges is considered bipartite. I agree with that. For the empty graph, it's always ambiguous in definitions...
> 
> Concerning the method you propose for bipartite graphs in fact you use a method similar to `project_left` in `BipartiteGraph`, except that the projection don't accept loops/multiedges.

Indeed. Note that `project_left` also produces a graph and not a digraph. Why on earth is this called `project_left`?



---

archive/issue_comments_365178.json:
```json
{
    "body": "Well, there is also method `project_right` ;)",
    "created_at": "2018-08-29T12:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365178",
    "user": "https://github.com/dcoudert"
}
```

Well, there is also method `project_right` ;)



---

archive/issue_comments_365179.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-29T13:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365179",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365180.json:
```json
{
    "body": "I removed the call to shortest path.",
    "created_at": "2018-08-29T13:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365180",
    "user": "https://github.com/videlec"
}
```

I removed the call to shortest path.



---

archive/issue_comments_365181.json:
```json
{
    "body": "- Why not writing directly `return sqrt(e_min), sqrt(e_max)` ?\n\n- `while s is not None:` -> `while s:`\n- `u_to_root` -> `v_to_root` (you start from v)\n- before the loop `while u_to_root and w_to_root and u_to_root[-1] == w_to_root[-1]` you could add a comment like `# Search for the nearest common ancestor of v and w`. No obligation.\n\n- You must add special case for the graph with a single vertex and no edge (don't know the expected result).\n\n```\nsage: Graph(1).spectral_radius()\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-8-c8d7e35649a7> in <module>()\n----> 1 Graph(Integer(1)).spectral_radius()\n\n/home/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/base/static_sparse_graph.pyx in sage.graphs.base.static_sparse_graph.spectral_radius (build/cythonized/sage/graphs/base/static_sparse_graph.cpp:12977)()\n    984                         H.add_edge(u0, u2)\n    985 \n--> 986         e_min, e_max = spectral_radius(H, prec)\n    987         e_min = sqrt(e_min)\n    988         e_max = sqrt(e_max)\n\n/home/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/base/static_sparse_graph.pyx in sage.graphs.base.static_sparse_graph.spectral_radius (build/cythonized/sage/graphs/base/static_sparse_graph.cpp:12235)()\n    957     \"\"\"\n    958     if not G:\n--> 959         raise ValueError(\"empty graph\")\n    960     if G.is_directed():\n    961         if not G.is_strongly_connected():\n\nValueError: empty graph\n```\n\n  Note that `Graph([(0, 0)], loops=True).spectral_radius()` returns `(1.0, 1.0)`",
    "created_at": "2018-08-29T13:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365181",
    "user": "https://github.com/dcoudert"
}
```

- Why not writing directly `return sqrt(e_min), sqrt(e_max)` ?

- `while s is not None:` -> `while s:`
- `u_to_root` -> `v_to_root` (you start from v)
- before the loop `while u_to_root and w_to_root and u_to_root[-1] == w_to_root[-1]` you could add a comment like `# Search for the nearest common ancestor of v and w`. No obligation.

- You must add special case for the graph with a single vertex and no edge (don't know the expected result).

```
sage: Graph(1).spectral_radius()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-8-c8d7e35649a7> in <module>()
----> 1 Graph(Integer(1)).spectral_radius()

/home/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/base/static_sparse_graph.pyx in sage.graphs.base.static_sparse_graph.spectral_radius (build/cythonized/sage/graphs/base/static_sparse_graph.cpp:12977)()
    984                         H.add_edge(u0, u2)
    985 
--> 986         e_min, e_max = spectral_radius(H, prec)
    987         e_min = sqrt(e_min)
    988         e_max = sqrt(e_max)

/home/dcoudert/sage/local/lib/python2.7/site-packages/sage/graphs/base/static_sparse_graph.pyx in sage.graphs.base.static_sparse_graph.spectral_radius (build/cythonized/sage/graphs/base/static_sparse_graph.cpp:12235)()
    957     """
    958     if not G:
--> 959         raise ValueError("empty graph")
    960     if G.is_directed():
    961         if not G.is_strongly_connected():

ValueError: empty graph
```

  Note that `Graph([(0, 0)], loops=True).spectral_radius()` returns `(1.0, 1.0)`



---

archive/issue_comments_365182.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-29T16:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365182",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365183.json:
```json
{
    "body": "Replying to [comment:13 dcoudert]:\n\nI did implement everything excepted\n\n> - `while s is not None:` -> `while s:`\n\nNope, `s = 0` or `s = False` may be valid vertices.",
    "created_at": "2018-08-29T16:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365183",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:13 dcoudert]:

I did implement everything excepted

> - `while s is not None:` -> `while s:`

Nope, `s = 0` or `s = False` may be valid vertices.



---

archive/issue_comments_365184.json:
```json
{
    "body": "> Nope, `s = 0` or `s = False` may be valid vertices.\nRight :P",
    "created_at": "2018-08-29T16:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365184",
    "user": "https://github.com/dcoudert"
}
```

> Nope, `s = 0` or `s = False` may be valid vertices.
Right :P



---

archive/issue_comments_365185.json:
```json
{
    "body": "LGTM.",
    "created_at": "2018-08-29T16:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365185",
    "user": "https://github.com/dcoudert"
}
```

LGTM.



---

archive/issue_comments_365186.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-29T16:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365186",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_365187.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-01T09:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25911#issuecomment-365187",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_024089.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-01T09:10:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25911",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25911#event-24089"
}
```
