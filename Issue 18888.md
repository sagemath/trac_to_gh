# Issue 18888: DeprecatedMethod wrapping is broken

archive/issues_018888.json:
```json
{
    "body": "As reported on [https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ](https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ) we get the wrong result:\n\n```\nsage: var('a b c x y')\nsage: eq1 = y == a*x+x^b\nsage: eq2 = b == c/2\nsage: eq3 = c == a^2\nsage: eq1.subs_expr(eq2.subs_expr(eq3))\n\n__main__:1: DeprecationWarning: subs_expr is deprecated. Please use substitute instead.\nSee http://trac.sagemath.org/12834 for details.\n1/2*a^2 == 1/2*c\n```\n\nThis result is consistent with\n\n```\nsage: eq2.subs_expr(eq2.subs_expr(eq3))\n```\n\nwhich is indeed what the code currently effectively does. This affects any (nested) deprecated method lookup at the moment, so needs to be fixed ASAP.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19125\n\n",
    "created_at": "2015-09-01T18:33:57Z",
    "labels": [
        "misc",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "DeprecatedMethod wrapping is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18888",
    "user": "@nbruin"
}
```
As reported on [https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ](https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ) we get the wrong result:

```
sage: var('a b c x y')
sage: eq1 = y == a*x+x^b
sage: eq2 = b == c/2
sage: eq3 = c == a^2
sage: eq1.subs_expr(eq2.subs_expr(eq3))

__main__:1: DeprecationWarning: subs_expr is deprecated. Please use substitute instead.
See http://trac.sagemath.org/12834 for details.
1/2*a^2 == 1/2*c
```

This result is consistent with

```
sage: eq2.subs_expr(eq2.subs_expr(eq3))
```

which is indeed what the code currently effectively does. This affects any (nested) deprecated method lookup at the moment, so needs to be fixed ASAP.


Issue created by migration from https://trac.sagemath.org/ticket/19125





---

archive/issue_comments_258687.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-01T18:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258687",
    "user": "@nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_258688.json:
```json
{
    "body": "First try. This just reuses the DeprecatedFunction class to also represent bound methods (which it did before, but without making separate instances for doing that) One could write a subclass `DeprecatedBoundMethod` instead to make code a little more \"efficient\", but given that the code currently already calls `gc.get_referrers`, I don't think the current code change will make performance any worse.\n----\nNew commits:",
    "created_at": "2015-09-01T18:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258688",
    "user": "@nbruin"
}
```

First try. This just reuses the DeprecatedFunction class to also represent bound methods (which it did before, but without making separate instances for doing that) One could write a subclass `DeprecatedBoundMethod` instead to make code a little more "efficient", but given that the code currently already calls `gc.get_referrers`, I don't think the current code change will make performance any worse.
----
New commits:



---

archive/issue_comments_258689.json:
```json
{
    "body": "The fix should be doctested! You can adapt the current behavior of\n\n```python\nsage: from sage.misc.superseded import deprecated_function_alias\nsage: class A:\n....:    def __init__(self, x):\n....:        self.x = x\n....:    def f(self, y):\n....:        return self.x+y\n....:    g = deprecated_function_alias(42, f)\nsage: a1 = A(1)\nsage: a2 = A(2)\nsage: a1.g(a2.g(0))\ndoctest:...: DeprecationWarning: g is deprecated. Please use f instead.\nSee http://trac.sagemath.org/42 for details.\n4\nsage: a1.f(a2.f(0))\n3\n```\n",
    "created_at": "2015-09-02T01:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258689",
    "user": "@videlec"
}
```

The fix should be doctested! You can adapt the current behavior of

```python
sage: from sage.misc.superseded import deprecated_function_alias
sage: class A:
....:    def __init__(self, x):
....:        self.x = x
....:    def f(self, y):
....:        return self.x+y
....:    g = deprecated_function_alias(42, f)
sage: a1 = A(1)
sage: a2 = A(2)
sage: a1.g(a2.g(0))
doctest:...: DeprecationWarning: g is deprecated. Please use f instead.
See http://trac.sagemath.org/42 for details.
4
sage: a1.f(a2.f(0))
3
```




---

archive/issue_comments_258690.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-02T01:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258690",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_258691.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-09-02T01:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258691",
    "user": "@videlec"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_258692.json:
```json
{
    "body": "I think the name lookup is already broken. With the current change, we make it worse, though:\n\nCurrently, for methods it does a name lookup by finding all dictionaries that refer to the object in question and pick the first one that looks like it's a class namespace and then take the first name under which this object occurs. That sort-of seems to work most of the time.\n\nProblem: the `unbound` instance variable introduced here, so it's a toss-up whether you get the name reported as `unbound` or something else. We could guard against that particular reference, but if several bound instances exist at once, this gets painful (and you're really just trying to make a buggy approach work a little more often)\n\nWe could probably do a little better: I think the __get__ gets as one parameter an object from which we can find the dictionary in which the reference is stored: I think `cls.__dict__` would be a good start, but I'm afraid you'd have to walk the MRO of `cls` (and with overridden getattrs, who knows where you should look?)\n\nIn any case, the code proposed at least should ensure that results are not changed by wrapping, even if name printing is not entirely reliable.",
    "created_at": "2015-09-02T04:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258692",
    "user": "@nbruin"
}
```

I think the name lookup is already broken. With the current change, we make it worse, though:

Currently, for methods it does a name lookup by finding all dictionaries that refer to the object in question and pick the first one that looks like it's a class namespace and then take the first name under which this object occurs. That sort-of seems to work most of the time.

Problem: the `unbound` instance variable introduced here, so it's a toss-up whether you get the name reported as `unbound` or something else. We could guard against that particular reference, but if several bound instances exist at once, this gets painful (and you're really just trying to make a buggy approach work a little more often)

We could probably do a little better: I think the __get__ gets as one parameter an object from which we can find the dictionary in which the reference is stored: I think `cls.__dict__` would be a good start, but I'm afraid you'd have to walk the MRO of `cls` (and with overridden getattrs, who knows where you should look?)

In any case, the code proposed at least should ensure that results are not changed by wrapping, even if name printing is not entirely reliable.



---

archive/issue_comments_258693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-02T05:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258693",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258694.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-02T06:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258694",
    "user": "@nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_258695.json:
```json
{
    "body": "OK, resolving the name lookup thing would be good, but at least I don't think that with the change just committed, the name lookup will be much worse than it was before.",
    "created_at": "2015-09-02T06:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258695",
    "user": "@nbruin"
}
```

OK, resolving the name lookup thing would be good, but at least I don't think that with the change just committed, the name lookup will be much worse than it was before.



---

archive/issue_comments_258696.json:
```json
{
    "body": "Is this really a blocker? \n\nVincent, are you reviewing this?\n\nFYI pep8 is \n\n```\n    def __init__(self, trac_number, func, module, instance=None, unbound=None): # no space\n        search_for = self    # space around =\n```\n\nand not\n\n```\n    def __init__(self, trac_number, func, module, instance = None, unbound = None):\n        search_for=self\n```\n",
    "created_at": "2015-09-25T08:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258696",
    "user": "@vbraun"
}
```

Is this really a blocker? 

Vincent, are you reviewing this?

FYI pep8 is 

```
    def __init__(self, trac_number, func, module, instance=None, unbound=None): # no space
        search_for = self    # space around =
```

and not

```
    def __init__(self, trac_number, func, module, instance = None, unbound = None):
        search_for=self
```




---

archive/issue_comments_258697.json:
```json
{
    "body": "Replying to [comment:8 vbraun]:\n> Is this really a blocker? \n\nYes. It introduced an error in a deprecated alias.\n \n> Vincent, are you reviewing this?\n\nI am doing it.",
    "created_at": "2015-09-26T14:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258697",
    "user": "@videlec"
}
```

Replying to [comment:8 vbraun]:
> Is this really a blocker? 

Yes. It introduced an error in a deprecated alias.
 
> Vincent, are you reviewing this?

I am doing it.



---

archive/issue_comments_258698.json:
```json
{
    "body": "Nils,\n\nCould you review my two small commits?\n\nVincent\n----\nNew commits:",
    "created_at": "2015-09-26T14:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258698",
    "user": "@videlec"
}
```

Nils,

Could you review my two small commits?

Vincent
----
New commits:



---

archive/issue_comments_258699.json:
```json
{
    "body": "I don't agree with the `self.unbound or self` statement. We really want to test against a sentinel here, not whether the object `f.unbound` is bound to considers itself false. One can make \"false\" callable objects:\n\n```\nclass A:\n    def __call__(self):\n        return \"me\"\n    def __nonzero__(self):\n        return false\n```\n\n\n```\nsage: a=A()\nsage: a or 10\n10\nsage: a()\n'me'\n```\n\nWe shouldn't question or depend on the sanity of the code we're wrapping. It's deprecated code, after all, so it probably has something wrong with it. (with a little work you could extend the class A upstairs into something whose objects can be used as bindable methods: just provide the appropriate `__get__`).\n\nIf you really prefer a one-liner here, I'd be OK with\n\n```\nsearch_for = self.unbound if (self.unbound is None) else self\n```\n\n\nThe other changes are fine with me.",
    "created_at": "2015-09-26T19:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258699",
    "user": "@nbruin"
}
```

I don't agree with the `self.unbound or self` statement. We really want to test against a sentinel here, not whether the object `f.unbound` is bound to considers itself false. One can make "false" callable objects:

```
class A:
    def __call__(self):
        return "me"
    def __nonzero__(self):
        return false
```


```
sage: a=A()
sage: a or 10
10
sage: a()
'me'
```

We shouldn't question or depend on the sanity of the code we're wrapping. It's deprecated code, after all, so it probably has something wrong with it. (with a little work you could extend the class A upstairs into something whose objects can be used as bindable methods: just provide the appropriate `__get__`).

If you really prefer a one-liner here, I'd be OK with

```
search_for = self.unbound if (self.unbound is None) else self
```


The other changes are fine with me.



---

archive/issue_comments_258700.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-26T22:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258700",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258701.json:
```json
{
    "body": "Thanks! I'm fine with setting this ticket to \"positive review\".",
    "created_at": "2015-09-27T02:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258701",
    "user": "@nbruin"
}
```

Thanks! I'm fine with setting this ticket to "positive review".



---

archive/issue_comments_258702.json:
```json
{
    "body": "Let us do that!",
    "created_at": "2015-09-27T18:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258702",
    "user": "@videlec"
}
```

Let us do that!



---

archive/issue_comments_258703.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-27T18:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258703",
    "user": "@videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_258704.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-28T10:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18888#issuecomment-258704",
    "user": "@vbraun"
}
```

Resolution: fixed
