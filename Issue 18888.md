# Issue 18888: DeprecatedMethod wrapping is broken

Issue created by migration from https://trac.sagemath.org/ticket/19125

Original creator: nbruin

Original creation time: 2015-09-01 18:33:57

As reported on [https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ](https://groups.google.com/d/msg/sage-devel/nion2hqoKbE/E8Kd5OFSEAAJ) we get the wrong result:

```
sage: var('a b c x y')
sage: eq1 = y == a*x+x^b
sage: eq2 = b == c/2
sage: eq3 = c == a^2
sage: eq1.subs_expr(eq2.subs_expr(eq3))

__main__:1: DeprecationWarning: subs_expr is deprecated. Please use substitute instead.
See http://trac.sagemath.org/12834 for details.
1/2*a^2 == 1/2*c
```

This result is consistent with

```
sage: eq2.subs_expr(eq2.subs_expr(eq3))
```

which is indeed what the code currently effectively does. This affects any (nested) deprecated method lookup at the moment, so needs to be fixed ASAP.



---

Comment by nbruin created at 2015-09-01 18:39:47

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-09-01 18:39:47

First try. This just reuses the DeprecatedFunction class to also represent bound methods (which it did before, but without making separate instances for doing that) One could write a subclass `DeprecatedBoundMethod` instead to make code a little more "efficient", but given that the code currently already calls `gc.get_referrers`, I don't think the current code change will make performance any worse.
----
New commits:


---

Comment by vdelecroix created at 2015-09-02 01:32:25

The fix should be doctested! You can adapt the current behavior of

```python
sage: from sage.misc.superseded import deprecated_function_alias
sage: class A:
....:    def __init__(self, x):
....:        self.x = x
....:    def f(self, y):
....:        return self.x+y
....:    g = deprecated_function_alias(42, f)
sage: a1 = A(1)
sage: a2 = A(2)
sage: a1.g(a2.g(0))
doctest:...: DeprecationWarning: g is deprecated. Please use f instead.
See http://trac.sagemath.org/42 for details.
4
sage: a1.f(a2.f(0))
3
```



---

Comment by vdelecroix created at 2015-09-02 01:32:53

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-09-02 01:32:53

Changing type from PLEASE CHANGE to defect.


---

Comment by nbruin created at 2015-09-02 04:45:05

I think the name lookup is already broken. With the current change, we make it worse, though:

Currently, for methods it does a name lookup by finding all dictionaries that refer to the object in question and pick the first one that looks like it's a class namespace and then take the first name under which this object occurs. That sort-of seems to work most of the time.

Problem: the `unbound` instance variable introduced here, so it's a toss-up whether you get the name reported as `unbound` or something else. We could guard against that particular reference, but if several bound instances exist at once, this gets painful (and you're really just trying to make a buggy approach work a little more often)

We could probably do a little better: I think the __get__ gets as one parameter an object from which we can find the dictionary in which the reference is stored: I think `cls.__dict__` would be a good start, but I'm afraid you'd have to walk the MRO of `cls` (and with overridden getattrs, who knows where you should look?)

In any case, the code proposed at least should ensure that results are not changed by wrapping, even if name printing is not entirely reliable.


---

Comment by git created at 2015-09-02 05:58:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2015-09-02 06:07:41

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2015-09-02 06:07:41

OK, resolving the name lookup thing would be good, but at least I don't think that with the change just committed, the name lookup will be much worse than it was before.


---

Comment by vbraun created at 2015-09-25 08:32:49

Is this really a blocker? 

Vincent, are you reviewing this?

FYI pep8 is 

```
    def __init__(self, trac_number, func, module, instance=None, unbound=None): # no space
        search_for = self    # space around =
```

and not

```
    def __init__(self, trac_number, func, module, instance = None, unbound = None):
        search_for=self
```



---

Comment by vdelecroix created at 2015-09-26 14:14:47

Replying to [comment:8 vbraun]:
> Is this really a blocker? 

Yes. It introduced an error in a deprecated alias.
 
> Vincent, are you reviewing this?

I am doing it.


---

Comment by vdelecroix created at 2015-09-26 14:40:04

Nils,

Could you review my two small commits?

Vincent
----
New commits:


---

Comment by nbruin created at 2015-09-26 19:18:25

I don't agree with the `self.unbound or self` statement. We really want to test against a sentinel here, not whether the object `f.unbound` is bound to considers itself false. One can make "false" callable objects:

```
class A:
    def __call__(self):
        return "me"
    def __nonzero__(self):
        return false
```


```
sage: a=A()
sage: a or 10
10
sage: a()
'me'
```

We shouldn't question or depend on the sanity of the code we're wrapping. It's deprecated code, after all, so it probably has something wrong with it. (with a little work you could extend the class A upstairs into something whose objects can be used as bindable methods: just provide the appropriate `__get__`).

If you really prefer a one-liner here, I'd be OK with

```
search_for = self.unbound if (self.unbound is None) else self
```


The other changes are fine with me.


---

Comment by git created at 2015-09-26 22:09:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2015-09-27 02:06:37

Thanks! I'm fine with setting this ticket to "positive review".


---

Comment by vdelecroix created at 2015-09-27 18:39:08

Let us do that!


---

Comment by vdelecroix created at 2015-09-27 18:39:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-28 10:22:53

Resolution: fixed
