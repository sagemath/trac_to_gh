# Issue 32107: Add a new class to write multi-thread safe to a complete directory

Issue created by migration from https://trac.sagemath.org/ticket/32344

Original creator: soehms

Original creation time: 2021-08-07 16:38:06

Keywords: atomic write directory tempory

This new class is just a variation of the existing class `atomic_write` taking care of directory specific differences.
For a first application case see #32099.



---

Comment by soehms created at 2021-08-07 16:41:26

New commits:


---

Comment by soehms created at 2021-08-07 16:41:26

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-08-09 19:40:10

Haven't tried yet, but this part:

```
+            except OSError:
+                shutil.rmtree(self.target)
+                os.rename(self.tempname, self.target)
```

looks racy to me


---

Comment by soehms created at 2021-08-10 07:15:54

Replying to [comment:3 mkoeppe]:
> Haven't tried yet, but this part:
> {{{
> +            except OSError:
> +                shutil.rmtree(self.target)
> +                os.rename(self.tempname, self.target)
> }}}
> looks racy to me

This code is just adapted from the corresponding part of `atomic_write`. It worked fine for me in all of my tests (using Python 3.9). But indeed, the second patchbot (using Python 3.7) shows (ignored) `FileNotFoundError` in cleanup:


```
Running doctests with ID 2021-08-08-00-50-13-492edc8c.
Git branch: patchbot/ticket_merged
Using --optional=build,ccache,debian,dochtml,pip,sage,sage_spkg
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 4343 files using 5 threads.
....
sage -t --long --random-seed=0 src/doc/en/prep/Intro-Tutorial.rst
    [25 tests, 1.54 s]
Exception ignored in: <finalize object at 0x7fd572323bd0; dead>
Traceback (most recent call last):
  File "/usr/lib/python3.7/weakref.py", line 552, in __call__
    return info.func(*info.args, **(info.kwargs or {}))
  File "/usr/lib/python3.7/tempfile.py", line 934, in _cleanup
    _rmtree(name)
  File "/usr/lib/python3.7/shutil.py", line 482, in rmtree
    onerror(os.lstat, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 480, in rmtree
    orig_st = os.lstat(path)
FileNotFoundError: [Errno 2] No such file or directory: '/home/lelievre/.sage/temp/pascaline-sage-b/9091/tmp5ve0uefv'
Exception ignored in: <finalize object at 0x7fd572323bd0; dead>
Traceback (most recent call last):
  File "/usr/lib/python3.7/weakref.py", line 552, in __call__
    return info.func(*info.args, **(info.kwargs or {}))
  File "/usr/lib/python3.7/tempfile.py", line 934, in _cleanup
    _rmtree(name)
  File "/usr/lib/python3.7/shutil.py", line 482, in rmtree
    onerror(os.lstat, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 480, in rmtree
    orig_st = os.lstat(path)
FileNotFoundError: [Errno 2] No such file or directory: '/home/lelievre/.sage/temp/pascaline-sage-b/9091/tmpgp3b5u31'
Exception ignored in: <finalize object at 0x7fd572323bd0; dead>
Traceback (most recent call last):
  File "/usr/lib/python3.7/weakref.py", line 552, in __call__
    return info.func(*info.args, **(info.kwargs or {}))
  File "/usr/lib/python3.7/tempfile.py", line 934, in _cleanup
    _rmtree(name)
  File "/usr/lib/python3.7/shutil.py", line 482, in rmtree
    onerror(os.lstat, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 480, in rmtree
    orig_st = os.lstat(path)
FileNotFoundError: [Errno 2] No such file or directory: '/home/lelievre/.sage/temp/pascaline-sage-b/9091/tmpp9nuidju'
sage -t --long --random-seed=0 src/sage/misc/temporary_file.py
    [87 tests, 1.56 s]
....
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 2687.7 seconds
    cpu time: 12460.5 seconds
    cumulative wall time: 12941.0 seconds
Pytest is not installed, skip checking tests that rely on it.
```


Unfortunately, the traceback doesn't show how this is caused by my code. Do you have any ideas on how to make this part more safe?


---

Comment by mkoeppe created at 2021-08-10 16:37:45

I think a first step should be to clarify the semantics in the documentation of this class: This is for creating a directory whose contents are determined uniquely by the directory name. If multiple threads or processes attempt to create it in parallel, then it does not matter which thread created it.

If this is the intended semantics, then the following should be correct:

```
            # Success: move temporary file to target file
            try:
                os.rename(self.tempname, self.target)
            except FileExistsError:
                # Race: Another thread or process must have created the directory
                pass
```



---

Comment by git created at 2021-08-11 09:26:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-08-11 09:30:36

Replying to [comment:5 mkoeppe]:
> I think a first step should be to clarify the semantics in the documentation of this class: This is for creating a directory whose contents are determined uniquely by the directory name. If multiple threads or processes attempt to create it in parallel, then it does not matter which thread created it.
> 
> If this is the intended semantics, then the following should be correct:
> {{{
>             # Success: move temporary file to target file
>             try:
>                 os.rename(self.tempname, self.target)
>             except FileExistsError
>                 # Race: Another thread or process must have created the directory
>                 pass
> }}}
> 


Good idea! If cleaning is necessary then the calling code is responsible. If so, it can still lead to a race of removing the directory but under better controlled conditions.


---

Comment by mkoeppe created at 2021-09-07 18:25:15

LGTM


---

Comment by mkoeppe created at 2021-09-07 18:25:15

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-09-08 07:20:02

Many thanks!


---

Comment by vbraun created at 2021-09-13 22:22:23

Resolution: fixed
