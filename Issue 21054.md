# Issue 21054: speed regression in is_package_installed

Issue created by migration from https://trac.sagemath.org/ticket/21291

Original creator: mantepse

Original creation time: 2016-08-19 09:39:41

CC:  jdemeyer vdelecroix saraedum mkoeppe

In 6.9.beta5 I have:

```
sage: sage: timeit("is_package_installed('bliss')")
625 loops, best of 3: 163 µs per loop
```

w￼hereas in 7.4.beta1

```
sage: timeit("is_package_installed('bliss')")
5 loops, best of 3: 1.36 s per loop
```


possibly related: #20382


---

Comment by jdemeyer created at 2016-08-19 09:59:59

I guess this is because of the PIP stuff which got added in #19213. I see no easy fix... the only possibility is removing the use of PIP in `is_package_installed`.


---

Comment by mantepse created at 2016-08-19 10:45:15

I wonder why no speed regression was detected in #19213.


---

Comment by jdemeyer created at 2016-08-19 11:06:16

Replying to [comment:2 mantepse]:
> I wonder why no speed regression was detected in #19213.

Because nobody checked?


---

Comment by mantepse created at 2016-08-19 11:07:14

Would it perhaps be possible to recompute the list of installed packages only when a new package is installed?  Or, if that's not possible, just provide a user level function that recomputes the list of installed packages?


---

Comment by jdemeyer created at 2016-08-19 11:09:59

Replying to [comment:4 mantepse]:
> only when a new package is installed?

How are you going to detect whether a new package is installed without listing the installed packages?


---

Comment by mantepse created at 2016-08-19 11:16:02

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 mantepse]:
> > only when a new package is installed?
> 
> How are you going to detect whether a new package is installed without listing the installed packages?

I don't know, that's why I asked.


---

Comment by vdelecroix created at 2016-08-19 21:01:06

See also trouble from compiling a fresh clone at https://groups.google.com/forum/#!topic/sage-release/MhAwPVWfK28


---

Comment by jdemeyer created at 2016-08-20 08:48:17

Changing priority from major to blocker.


---

Comment by leif created at 2016-08-27 21:16:51

See also #21355 which presumably is caused by the same.

How could such crap get merged?


---

Comment by vdelecroix created at 2016-08-27 22:37:12

New commits:


---

Comment by vdelecroix created at 2016-08-27 22:37:12

Changing status from new to needs_review.


---

Comment by leif created at 2016-08-27 23:12:03

I thought of (temporarily anyway, because of #20382) adding some keyword (default: `False`) like `update` or `include_pip_packages`, passing that in addition where/when appropriate.

That way we wouldn't completely exclude "pip" packages elsewhere.


---

Comment by leif created at 2016-08-27 23:26:59

IMHO `installed` (or some related variable) should be a dictionary mapping just "base" package names to {`True`, `False`}, i.e., a `set()`.

Then `is_package_installed()` could just `return package in WHATEVER` (unless also `update=True` was passed, or the variable is yet `None`).

The package versions could be recorded in _separate_ dictionaries.


---

Comment by git created at 2016-08-28 01:02:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-08-28 01:04:19

Cleaner. But not one-line patch...


---

Comment by jdemeyer created at 2016-08-28 07:25:49

Typo: `Trure` -> `True`


---

Comment by leif created at 2016-08-28 19:43:26

Replying to [comment:16 jdemeyer]:
> Typo: `Trure` -> `True`

There's also a colon missing after `default`.

\\

Isn't the description of `exclude_pip` in `list_packages()` as wrong as that of `local`?

If the former is `True` (*not* `False`), PIP packages are excluded (not considered), or keep the `False`, and remove the "not" in _"then [also] pip packages are not considered."_.

Similar for the latter (`local`):  Either change `False` to `True`, or remove the "not".


---

Comment by git created at 2016-08-30 14:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-08-30 23:27:00

Next typo (in before):

s/if set to ``True`` *than* connection error/if set to ``True`` *then* connection error/

\\

According to [the current Sage Developer's Guide](http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings), the syntax for arguments is

```
INPUT:

- ``foo`` (default: ``'bar'``) -- I won't describe its meaning here
```

that is, with a colon after `default`, and a *double-dash* before the description.


---

Comment by leif created at 2016-08-31 00:08:12

Changing keywords from "" to "slowness, doctesting timeout, timed out".


---

Comment by tscrim created at 2016-08-31 00:10:23

*cough cough*

```
INPUT:

- ``foo`` -- (default: ``'bar'``) I won't describe its meaning here
```



---

Comment by leif created at 2016-08-31 00:13:42

Replying to [comment:21 tscrim]:
> *cough cough*
> {{{
> INPUT:
> 
> - ``foo`` -- (default: ``'bar'``) I won't describe its meaning here
> }}}

Ouch. m)


---

Comment by git created at 2016-08-31 01:05:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-31 01:06:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-09-02 14:34:26

the doc is changed (but I did not receive mail for that)


---

Comment by leif created at 2016-09-02 14:42:44

Replying to [comment:25 vdelecroix]:
> the doc is changed (but I did not receive mail for that)

Me neither, but I _almost_ never get notifications for "git comments" (i.e., when someone just pushes).


---

Comment by leif created at 2016-09-02 15:41:56

The _"*than* no error is raised"_ is still in.

Also, in _"a sublist of 'standard', 'optional', ..."_ the package type strings should have code markup (```'standard'``` etc.).

Similar further down in `package_versions()`; there, math markup (only single backticks) is used instead of double backticks.

----

(Second attempt to send this after an _internal server error_.)


---

Comment by leif created at 2016-09-02 18:58:02

`src/sage_setup/optional_extension.py` uses `list_packages()` (which currently has `exclude_pip=False` as default); should we "fix" the former, too, and if so, here?

(Changing the default in `list_packages()` is perhaps too backward-incompatible, or we'd at least have to change a couple of calls elsewhere I guess.)

----

In principle, any pip-related function here should first check whether `is_package_installed("pip")`... ;-)

(There currently seems to be a dependency missing at least, since pip meanwhile is a standard package.  Not sure whether we'll get cyclic dependencies then, though...)


---

Comment by leif created at 2016-09-07 12:50:43

Replying to [comment:28 leif]:
> `src/sage_setup/optional_extension.py` uses `list_packages()` (which currently has `exclude_pip=False` as default); should we "fix" the former, too, and if so, here?
> 
> (Changing the default in `list_packages()` is perhaps too backward-incompatible, or we'd at least have to change a couple of calls elsewhere I guess.)
> 
> ----
> 
> In principle, any pip-related function here should first check whether `is_package_installed("pip")`... ;-)
> 
> (There currently seems to be a dependency missing at least, since pip meanwhile is a standard package.  Not sure whether we'll get cyclic dependencies then, though...)

Fixed by #21403 (adding the missing dependency on `pip`); will appear in 7.4.beta4 I guess.


---

Comment by git created at 2016-09-07 12:58:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-09-08 08:56:42

doc is fixed


---

Comment by leif created at 2016-09-08 11:23:42

Replying to [comment:31 vdelecroix]:
> doc is fixed

No, you just made it worse... ;-)

I only meant replace the misspelled _"than"_ by _"then"_.

Now the _"than"_ is still in, and the description is wrong, as `ignore_URLError=True` of course means *don't* raise an exception but simply return `None` on errors, but you turned the _"no error"_ into _"an error"_ and added another logically wrong sentence.


---

Comment by leif created at 2016-09-08 11:29:18

Replying to [comment:27 leif]:
> Also, in _"a sublist of 'standard', 'optional', ..."_ the package type strings should have code markup (```'standard'``` etc.).
> 
> Similar further down in `package_versions()`; there, *math* markup (only single backticks) is used instead of double backticks.


This is also still true.


---

Comment by git created at 2016-09-08 11:53:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-09-08 11:53:43

Indeed! (fixed, I hope)


---

Comment by leif created at 2016-09-08 11:54:33

I'll push a branch with the fixes _later_ if you don't have the time.

It's still a blocker ticket...

Oh, wait, just seeing you've pushed a new one...


---

Comment by leif created at 2016-09-09 04:08:35

So I've fixed more docstrings on top of your changes.

Either check out my branch `u/leif/21291`, or simply set the ticket to positive review.

For beta4, it's unfortunately meanwhile too late.


---

Comment by vdelecroix created at 2016-09-09 11:45:39

New commits:


---

Comment by vdelecroix created at 2016-09-09 11:45:39

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-09-09 11:45:53

Thanks!


---

Comment by vbraun created at 2016-09-10 09:00:34

Resolution: fixed
