# Issue 22164: Let substitute_function handle anon functions smoothly

Issue created by migration from https://trac.sagemath.org/ticket/22401

Original creator: rws

Original creation time: 2017-02-21 09:07:55

`substitute_function` expects two function objects as argument not expressions (`f(x)`). This leads to the unexpected:

```
sage: f = function('f')(x)
....: g = function('g')(x)
....: df = f(x).diff(x)
sage: f.substitute_function(f,g)
f(x)
sage: f(1).substitute_function(f,g)
f(1)
sage: df.substitute_function(f,g)
diff(f(x), x)
sage: df(1).substitute_function(f,g)
D[0](f)(1)
```

(same with `f(x)=function...`)

The problem is that `f` and `g` are not function objects like `sin`. Taking this into account:

```
sage: f.substitute_function(f.operator(), g.operator())
g(x)
sage: f(1).substitute_function(f.operator(), g.operator())
g(1)
sage: df.substitute_function(f.operator(), g.operator())
diff(g(x), x)
sage: df(1).substitute_function(f.operator(), g.operator())
D[0](g)(1)
```

The ticket should make `substitute_function` do this automatically and ignore any arguments. Note that the mess results from `function` returning `f(x)` and users assigning this to `f` or `f(x)` instead of just doing

```
sage: function('f')(x)
f(x)
sage: f(1).substitute_function(f,g)
g(1)
```



---

Comment by nbruin created at 2017-02-21 17:35:36

The problem that "function" returned f(x) has been fixed since #17447, so I don't think this is an issue anymore. You can see it in the syntax that is used in the description: in `function('f')(x)` a function gets called explicitly to turn it into an expression.

Rather than substitute_function trying to guess how to sanitize its arguments, perhaps it should raise an exception if it can tell its argument will for sure not appear in the "function" slot.
