# Issue 30158: enhance fricas lists

Issue created by migration from https://trac.sagemath.org/ticket/30395

Original creator: chapoton

Original creation time: 2020-08-19 16:49:07

CC:  mantepse slelievre

Keywords: FriCAS

extracted from #28641 (non-controversial part)


---

Comment by chapoton created at 2020-08-19 16:49:29

Changing status from new to needs_review.


---

Comment by git created at 2020-08-19 16:49:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-08-19 17:50:36

For `__getitem__` in the case `n < -1`, would something like this make sense?


```diff
         if n < -1:
-            raise IndexError("index out of range")
+            try:
+                nn = len(self) + n + 1
+            except:
+                raise IndexError("index out of range")
+            if nn < 1:
+                raise IndexError("index out of range")
+            else:
+                return P.new("elt(%s,%s)" % (self._name, nn))
```



---

Comment by chapoton created at 2020-08-19 18:32:49

There is not way we could use the length, as this could very well be a stream (infinite sequence). See line 150 for one such use case.


---

Comment by chapoton created at 2020-08-24 09:04:22

could it please be considered as a partial enhancement, good enough for the moment ?


---

Comment by mantepse created at 2020-08-24 15:33:55

I am not sure whether this is a good idea, but provided it is, wouldn't it make more sense to support all negative indices?

I think this is similar to what slelievre proposed: if `n` is negative, `__getitem__` succeeds if and only if the length (or, if you prefer, `last`) is defined.

`__getitem__` with negative argument, applied to an infinite stream would raise an error just as it does now.


---

Comment by git created at 2020-08-27 19:28:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-08-28 06:31:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-08-28 09:03:53

I have added some kind of support for getitem of negative indices

green bot, please review


---

Comment by mkoeppe created at 2020-08-29 17:13:39


```
sage -t --random-seed=0 src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 962, in sage.interfaces.fricas.FriCASElement.__iter__
Failed example:
    list(L)               # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/expect.py", line 1469, in __init__
        self._name = parent._create(value, name=name)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 501, in _create
        self.set(name, value)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 590, in set
        self._check_errors(value, output)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 568, in _check_errors
        raise RuntimeError("An error occurred when FriCAS evaluated '%s':\n%s" % (line, output))
    RuntimeError: An error occurred when FriCAS evaluated 'elt(sage558,4)':
     
       >> Error detected within library code:
       index out of range


    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement.__iter__[1]>", line 1, in <module>
        list(L)               # optional - fricas
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 738, in __iter__
        yield self[i]
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 975, in __getitem__
        return P.new("elt(%s,%s)" % (self._name, n+1))
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 370, in new
        return self(code)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 296, in __call__
        return cls(self, x, name=name)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/expect.py", line 1474, in __init__
        raise TypeError(*x.args)
    TypeError: An error occurred when FriCAS evaluated 'elt(sage558,4)':
     
       >> Error detected within library code:
       index out of range

**********************************************************************
File "src/sage/interfaces/fricas.py", line 989, in sage.interfaces.fricas.FriCASElement.__getitem__
Failed example:
    fricas("[1,2,3]")[-1]    # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement.__getitem__[1]>", line 1, in <module>
        fricas("[1,2,3]")[-Integer(1)]    # optional - fricas
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 971, in __getitem__
        raise IndexError("index out of range")
    IndexError: index out of range
**********************************************************************
File "src/sage/interfaces/fricas.py", line 992, in sage.interfaces.fricas.FriCASElement.__getitem__
Failed example:
    fricas("[1,2,3]")[-2]    # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement.__getitem__[2]>", line 1, in <module>
        fricas("[1,2,3]")[-Integer(2)]    # optional - fricas
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/interfaces/fricas.py", line 971, in __getitem__
        raise IndexError("index out of range")
    IndexError: index out of range
**********************************************************************
2 items had failures:
   2 of   7 in sage.interfaces.fricas.FriCASElement.__getitem__
   1 of   4 in sage.interfaces.fricas.FriCASElement.__iter__
    [253 tests, 3 failures, 73.01 s]
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/interfaces/fricas.py  # 3 doctests failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2020-08-29 17:13:39

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-08-29 19:08:03

The doctests pass for me with fricas 1.3.6


---

Comment by mkoeppe created at 2020-08-29 19:22:05

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2020-08-29 19:22:05

Hm, now they pass for me, too. Not sure what I did wrong in the previous test.

The changes look good to me.


---

Comment by vbraun created at 2020-09-06 21:51:40

Resolution: fixed
