# Issue 26321: doc-pdf fails due to conflict with new babel.sty

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2018-10-25 22:31:30

On OS X with TeXLive 2018, babel.sty file version "2018/10/16 3.26", `make doc-pdf` fails with the error

```

[505]

LaTeX Warning: Hyper reference `sage/combinat/crystals/letters:kn94' on page 50
6 undefined on input line 44725.


LaTeX Warning: Hyper reference `sage/combinat/crystals/crystals:module-sage.com
binat.crystals.crystals' on page 506 undefined on input line 44736.


LaTeX Warning: Command \LaTeX invalid in math mode on input line 44737.


LaTeX Warning: Command \TeX invalid in math mode on input line 44737.

! You can't use `\spacefactor' in math mode.
\`@`->\spacefactor 
                 \`@`m {}
l.44737 ...and in particular plotting and \(\LaTeX
                                                  \) output.
? 
! Emergency stop.
\`@`->\spacefactor 
                 \`@`m {}
l.44737 ...and in particular plotting and \(\LaTeX
                                                  \) output.
!  ==> Fatal error occurred, no output PDF file produced!
```

For some reason, using (our redefined version of) `\LaTeX` in math mode gives this error. If I take the LaTeX file `combinat.tex` and comment out `\usepackage{babel}` and various lines starting `\addto\captionsenglish{...` then the build succeeds.



---

Comment by fbissey created at 2018-10-25 23:20:10

Stuff like `\usepackage{babel}` is generated by `sphinx`, I wonder if the upgrade to `sphinx-1.8.x` would help with that particular issue.


---

Comment by jhpalmieri created at 2018-10-26 00:02:47

I ran into the issue first testing #26451, and when `make doc-pdf` failed there, I tried with a plain 8.5.beta0, which is how I found this problem. In other words, I don't think upgrading Sphinx will help.


---

Comment by jdemeyer created at 2018-10-26 08:07:54

Silly question, but why would you put `\LaTeX` in math mode in the first place?


---

Comment by jhpalmieri created at 2018-10-26 17:17:59

Replying to [comment:3 jdemeyer]:
> Silly question, but why would you put `\LaTeX` in math mode in the first place?

There is no good reason. Either people don't know how to use LaTeX properly, or they think that in reST, all LaTeX commands need to be enclosed in backquotes, or they just copied what someone else had done.


---

Comment by jhpalmieri created at 2018-10-26 17:21:10

I think this is a minimal example:

```
\documentclass[english]{article}
\usepackage{babel}
\usepackage{textcomp}

\let\textLaTeX\LaTeX
\renewcommand*{\LaTeX}{\hbox{\textLaTeX}}

\begin{document}

Or it can be rendered with \(\LaTeX\).  This requires the right additions to a
standard \(\mbox{\rm\TeX}\) installation.

\end{document}
```

I need both the `babel` and `textcomp` packages to get the error.


---

Comment by jhpalmieri created at 2018-10-26 17:31:54

Replying to [comment:4 jhpalmieri]:
> Replying to [comment:3 jdemeyer]:
> > Silly question, but why would you put `\LaTeX` in math mode in the first place?
> 
> There is no good reason.

One bad reason is because if you just use `\LaTeX then some text`, when you run pdflatex, you get no space between `\LaTeX` and `then`: you should do something like `\LaTeX{} then some text`.

Edit: although the curly brackets are not necessary when using Sphinx. Edit: only because Sphinx removes the backslash and declines to typeset "\LaTeX".


---

Comment by jhpalmieri created at 2018-10-26 19:03:40

Okay, it's a little more complicated. If I use `\LaTeX` in a docstring, not in math mode, then to produce latex/pdf, Sphinx strips the backslash from it first. I can't figure out a way to do this without the something like our current hack (from `doc/common/conf.py`):

```
\let\textLaTeX\LaTeX
\renewcommand*{\LaTeX}{\hbox{\textLaTeX}}
```



---

Comment by jhpalmieri created at 2018-10-26 20:19:32

Okay, so here is the problem:

```
\usepackage{babel}
\usepackage{textcomp}
\let\textLaTeX\LaTeX
\renewcommand*{\LaTeX}{\hbox{\textLaTeX}}
```

If I include the first two lines, the last line has no effect: I can't redefine the macro `\LaTeX`. I tested this with:

```
\documentclass[english]{article}
\usepackage{babel}
\usepackage{textcomp}
\renewcommand*{\LaTeX}{hello}
\begin{document}

Testing: \LaTeX

\end{document}
```

As long as I include both `babel` and `textcomp`, then this does not produce "Testing: hello", but rather "Testing: LaTeX" (nicely typeset). A bug in LaTeX?


---

Comment by jhpalmieri created at 2018-10-26 20:59:25

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-10-26 20:59:25

The nice people at [tex.stackexchange](https://tex.stackexchange.com/questions/456959/babel-textcomp-redefining-latex/456967#456967) provided a solution. The problem is that, when `textcomp` is used, `babel` redefines the `LaTeX` macro, and this happens after our redefinition. So we just have to redefine it later than they do.

Ideally we would not use `\LaTeX` in math mode, but I don't know how to do that in Sphinx.
----
New commits:


---

Comment by jhpalmieri created at 2018-10-29 23:11:44

Another approach: stop using `\LaTeX` in math mode and instead do some Sphinx acrobatics. For example, we can tell Sphinx that in latex-mode, to replace |bs| with a backslash and to replace |braces| with `{}`, and then `|bs|\ LaTeX\ |braces|` will get converted to `\LaTeX{}` by the latex builder, and to `LaTeX` by other builders.

This works because in reST, `|text|` defines a string to be substituted. The string `"\ "` means to suppress a space, so `"\ "` gets omitted by all builders. This is necessary for Sphinx to know which substitution to try; if you just had `|bs|LaTeX|braces|`, then it could look for the substitution `|LaTeX|`.

One way to accomplish this: change the main `conf.py` as follows:

```diff
diff --git a/src/doc/common/conf.py b/src/doc/common/conf.py
index 07e6244f2e..153163317d 100644
--- a/src/doc/common/conf.py
+++ b/src/doc/common/conf.py
`@``@` -111,6 +111,17 `@``@` inheritance_graph_attrs = { 'rankdir' : 'BT' }
 inheritance_node_attrs = { 'height' : 0.5, 'fontsize' : 12, 'shape' : 'oval' }
 inheritance_edge_attrs = {}
 
+rst_prolog = r"""
+
+.. |bs| raw:: latex
+
+         \
+
+.. |braces| raw:: latex
+
+         {}
+"""
+
 # Extension configuration
 # -----------------------
 
`@``@` -402,9 +413,6 `@``@` latex_elements['preamble'] = r"""
 
     \DeclareUnicodeCharacter{2571}{/}   % Box drawings light diagonal upper right to lower left
 \fi
-
-\let\textLaTeX\LaTeX
-\renewcommand*{\LaTeX}{\hbox{\textLaTeX}}
 """
 
 # Documents to append as an appendix to all manuals.
`@``@` -570,6 +578,17 `@``@` def process_dollars(app, what, name, obj, options, docstringlines):
         for i in range(len(lines)):
             docstringlines[i] = lines[i]
 
+def process_latex_macro(app, what, name, obj, options, docstringlines):
+    r"""
+    Replace '\LaTeX' with string suitable for processing by Sphinx's
+    html and latex builders.
+    """
+    if len(docstringlines):
+        s = "\n".join(docstringlines).replace(r'\LaTeX', '|bs|\ LaTeX\ |braces|').replace(r'\TeX', '|bs|\ TeX\ |braces|')
+        lines = s.split("\n")
+        for i in range(len(lines)):
+            docstringlines[i] = lines[i]
+
 def process_inherited(app, what, name, obj, options, docstringlines):
     """
     If we're including inherited members, omit their docstrings.
`@``@` -762,6 +781,7 `@``@` def setup(app):
     app.connect('autodoc-process-docstring', process_directives)
     app.connect('autodoc-process-docstring', process_docstring_module_title)
     app.connect('autodoc-process-docstring', process_dollars)
+    app.connect('autodoc-process-docstring', process_latex_macro)
     app.connect('autodoc-process-docstring', process_inherited)
     if os.environ.get('SAGE_SKIP_TESTS_BLOCKS', False):
         app.connect('autodoc-process-docstring', skip_TESTS_block)
```

Then users would just use "\LaTeX" in docstrings. The function `process_latex_macro` would replace this with `|bs|\ LaTeX\ |braces|`, and the substitution definitions say that in latex-mode, change |bs| to a backslash, etc. In any mode except latex, ignore |bs|.

So more complicated at the backend, but a little cleaner for docstring authors. (It also means that current uses of ``\LaTeX`` have to be changed to just `\LaTeX`, but there aren't that many instances of this.)

I've marked this as "needs info" because I don't know which way to go: the current branch, which has the virtue of simplicity, or this other idea, which makes conf.py worse but makes docstrings a little nicer. Opinions?


---

Comment by jhpalmieri created at 2018-10-29 23:11:44

Changing status from needs_review to needs_info.


---

Comment by jhpalmieri created at 2018-10-29 23:14:47

By the way, as far as I can tell, and also based on advice I got in the [sphinx-users Google group](https://groups.google.com/d/msg/sphinx-users/vO0dOyf68gA/MXqvFPcmBQAJ), Sphinx has no way of defining multiple substitutions for the same string depending on the mode, so I don't see any way of simplifying this approach much.


---

Comment by strogdon created at 2018-10-31 15:51:45

Replying to [comment:12 jhpalmieri]:
> By the way, as far as I can tell, and also based on advice I got in the [sphinx-users Google group](https://groups.google.com/d/msg/sphinx-users/vO0dOyf68gA/MXqvFPcmBQAJ), Sphinx has no way of defining multiple substitutions for the same string depending on the mode, so I don't see any way of simplifying this approach much.

What about overhead? Doesn't the use of `process_latex_macro` require that every docstring be parsed?


---

Comment by jhpalmieri created at 2018-10-31 17:21:22

Replying to [comment:13 strogdon]:
> Replying to [comment:12 jhpalmieri]:
> > By the way, as far as I can tell, and also based on advice I got in the [sphinx-users Google group](https://groups.google.com/d/msg/sphinx-users/vO0dOyf68gA/MXqvFPcmBQAJ), Sphinx has no way of defining multiple substitutions for the same string depending on the mode, so I don't see any way of simplifying this approach much.
> 
> What about overhead? Doesn't the use of `process_latex_macro` require that every docstring be parsed?

I should probably try some timings, building the reference manual with and without this overhead. I think it will be a small change compared to how long it takes to build the documentation. If we're really concerned about this, we can combine several of the functions that process docstrings into one, so that each docstring is processed just once instead of multiple times.


---

Comment by jhpalmieri created at 2018-10-31 22:11:35

I didn't run many timings, but it looks like `process_latex_macro` increases the time by a little bit: building the documentation takes roughly 3% longer.


---

Comment by jhpalmieri created at 2018-11-13 16:03:42

Let's use the simple fix now. If we want to change how we use the `\LaTeX` macro, we can do that on another ticket.


---

Comment by jhpalmieri created at 2018-11-13 16:03:42

Changing status from needs_info to needs_review.


---

Comment by strogdon created at 2018-11-13 16:29:14

Changing status from needs_review to positive_review.


---

Comment by strogdon created at 2018-11-13 16:29:14

Replying to [comment:16 jhpalmieri]:
> Let's use the simple fix now. If we want to change how we use the `\LaTeX` macro, we can do that on another ticket.
I tend to agree. I've checked this with TeXLive 2018 and your commit does fix things.


---

Comment by vbraun created at 2018-11-15 22:57:36

Resolution: fixed
