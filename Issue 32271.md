# Issue 32271: Eliminate use of __init__.py files for supplying package docstrings

Issue created by migration from https://trac.sagemath.org/ticket/32508

Original creator: mkoeppe

Original creation time: 2021-09-12 06:32:02

CC:  tscrim klee nthiery

... as in `src/sage/categories/__init__.py` or `src/sage/combinat/__init__.py`

(part of #32501)


---

Comment by git created at 2021-10-28 08:57:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-10-28 09:03:17

Previously

```sage
sage: import sage.combinat
sage: sage.combinat.quickref?
```


worked. Not anymore with the patch. We should 

```sage
sage: import sage.combinat.quickref
sage: sage.combinat.quickref?
```


The same with `sage.combinat.tutorial`


---

Comment by klee created at 2021-10-29 06:50:52

More seriously, before the patch,

```sage
sage: import sage.combinat
sage: help(sage.combinat)
```

gives a nice ... help. Could we retain this functionality somehow while eliminating the content of `sage.combinat.__init__.py`?


---

Comment by mkoeppe created at 2021-10-29 07:01:17

I guess with a bit of extra code in `src/sage/misc/sagedoc.py`, where `help` is defined, we could do this


---

Comment by klee created at 2021-10-29 07:08:46

Replying to [comment:6 mkoeppe]:
> I guess with a bit of extra code in `src/sage/misc/sagedoc.py`, where `help` is defined, we could do this

I cannot guess how. Where should the content go? Do you imagine a file like `src/sage/combinat/doc.rst` or something?


---

Comment by klee created at 2021-10-29 10:44:32

`src/sage/combinat/__doc__.py` would be better name for that.


---

Comment by mkoeppe created at 2021-10-29 16:56:38

+1 on `__doc__`.


---

Comment by klee created at 2021-10-30 03:43:51

Replying to [comment:9 mkoeppe]:
> +1 on `__doc__`.

Do you mean `__doc__` without `.py` extension?


---

Comment by mkoeppe created at 2021-10-30 03:53:41

With `.py`, like you suggested


---

Comment by klee created at 2021-10-30 03:54:31

Then `__doc__.py` with a python docstring (`"""..."""`)?


---

Comment by klee created at 2021-10-30 03:58:57

On the other hand, I wonder if there is a solution(or recommendation) for this problem(package docstring) in python level as this seems a general issue with namespace packages.


---

Comment by mkoeppe created at 2021-10-30 04:17:20

Replying to [comment:12 klee]:
> Then `__doc__.py` with a python docstring (`"""..."""`)?
Yes, that's what I thought


---

Comment by mkoeppe created at 2021-10-30 04:18:14

Replying to [comment:13 klee]:
> On the other hand, I wonder if there is a solution(or recommendation) for this problem(package docstring) in python level as this seems a general issue with namespace packages.
I agree, it would be good to find out whether there are existing practices for this in the Python community.


---

Comment by klee created at 2021-11-01 00:08:25

Replying to [comment:14 mkoeppe]:
> Replying to [comment:12 klee]:
> > Then `__doc__.py` with a python docstring (`"""..."""`)?
> Yes, that's what I thought

One problem with `__doc__.py` is that it is a fake module for it cannot be imported.

How about this:

`src/sage/combinat/__init__/__init__.py`

Then the namespace package `sage.combinat` get to have a subpackage `__init__` initialized by `__init__.py`, which we perhaps may use for "some initialization" as well as for package docstring.

Is this too much or incompatible with the modularization plan?


---

Comment by klee created at 2021-11-01 00:09:51

Replying to [comment:15 mkoeppe]:
> I agree, it would be good to find out whether there are existing practices for this in the Python community.

I googled for it, but found none.


---

Comment by mkoeppe created at 2021-11-01 01:24:47

How about we just use `all.py` for this purpose? 

(Modularized packages such as *sagemath-polyhedra* (#32432) add files such as `all__sagemath_polyhedra.py`)


---

Comment by klee created at 2021-11-01 01:55:35

Replying to [comment:18 mkoeppe]:
> How about we just use `all.py` for this purpose? 
> 
> (Modularized packages such as *sagemath-polyhedra* (#32432) add files such as `all__sagemath_polyhedra.py`)

How does `all.py` work? 

(1) Does it exist by itself and import other `all__xxx` files into it? 

(2) Or is it dynamically created by combining `all__xxx` files? 

Anyway, if it is at `src/sage/combinat/all.py`, then it cannot be imported. Can it be?


---

Comment by mkoeppe created at 2021-11-01 02:03:01

Yes, `all.py` exists as a file in Sage. For namespace packages, I am modularizing it by splitting parts of the existing `all.py` out to `all__sagemath_objects.py`, `all__sagemath_categories.py`, `all__sagemath_polyhedra` etc.  When a distribution has another distribution as a dependency, then it imports the dependency's `all__...` module. For example, *sagemath-polyhedra* has *sagemath-categories* as a dependency, so you see the imports: https://git.sagemath.org/sage.git/diff/src/sage/all__sagemath_polyhedra.py?id=a58ea1f6decbb84102bd341f8b3cc20f3147452b&id2=f716a0b366e31bbb546230140489244cfb68390d and https://git.sagemath.org/sage.git/diff/src/sage/rings/all__sagemath_polyhedra.py?id=a58ea1f6decbb84102bd341f8b3cc20f3147452b&id2=f716a0b366e31bbb546230140489244cfb68390d


---

Comment by mkoeppe created at 2021-11-01 02:07:53

Generally, if the `all` module is present, then it can also be imported.
Likewise, if an `all__...` module is present, then it can also be imported.


---

Comment by mkoeppe created at 2021-11-01 02:08:50

If `sage.misc.sagedoc.help` is used on a package `P` without `__doc__` attribute, it could try to import everything in `dir(P)` whose name begins with `all` and accumulate the docstrings of the importable modules.


---

Comment by klee created at 2021-11-01 02:36:31

Replying to [comment:21 mkoeppe]:
> Generally, if the `all` module is present, then it can also be imported.
> Likewise, if an `all__...` module is present, then it can also be imported.

Hmm. if the `all` module is just below in a namespace package (without `__init__.py`), I cannot import it. Do I misunderstand something?

For experiment, I created `src/sage/namespace/all.py` but no `src/sage/namespace/__init__.py`. I get


```sage
sage: import sage.namespace.all
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-1-f30e99bc2b64> in <module>
----> 1 import sage.namespace.all

ModuleNotFoundError: No module named 'sage.namespace.all'
```



---

Comment by mkoeppe created at 2021-11-01 02:42:22

The current default build system of the Sage library does not actually understand namespace packages. If you look into the installed Sage library in `site-packages`, you will see that your file `all.py` has not been copied there. This will be fixed in #28925.

If you want to test this, you can use `./configure --enable-editable` to switch to a different build system (https://wiki.sagemath.org/ReleaseTours/sage-9.3#Editable_.28.22in-place.22.2C_.22develop.22.29_installs_of_the_Sage_library)


---

Comment by klee created at 2021-11-04 02:38:56

Replying to [comment:24 mkoeppe]:
> The current default build system of the Sage library does not actually understand namespace packages. If you look into the installed Sage library in `site-packages`, you will see that your file `all.py` has not been copied there. This will be fixed in #28925.
> 
> If you want to test this, you can use `./configure --enable-editable` to switch to a different build system (https://wiki.sagemath.org/ReleaseTours/sage-9.3#Editable_.28.22in-place.22.2C_.22develop.22.29_installs_of_the_Sage_library)

Thanks. It works.


---

Comment by klee created at 2021-11-04 02:46:08

Replying to [comment:18 mkoeppe]:
> How about we just use `all.py` for this purpose? 

I disagree. `all.py` serves its own purpose and may have its own docstring.

On the other hand, `__doc__.py` is somewhat misleading as it appears "official" as much as `__init__.py`, which is not true.

Now I suggest `doc.py` to store package docstrings. This is just a sage thing.


---

Comment by klee created at 2021-11-04 02:54:09

For the use of `doc.py`:

It seems that the package docstrings in `__init__.py` files are mostly intended for our Sphinx documentation, not for using with `help(...)`.

So in this ticket, I would focus only on Sphinx documentation and ignore possible use with `help()`. If really needed, the use with `help()` may be dealt with in other ticket in future.


---

Comment by mkoeppe created at 2021-11-04 05:43:58

Replying to [comment:26 klee]:
> Replying to [comment:18 mkoeppe]:
> > How about we just use `all.py` for this purpose? 
> 
> I disagree. `all.py` serves its own purpose and may have its own docstring.

Do you see an example of an `all` module that has a useful docstring?


---

Comment by klee created at 2021-11-04 05:54:13

Replying to [comment:28 mkoeppe]:
> Replying to [comment:26 klee]:
> > Replying to [comment:18 mkoeppe]:
> > > How about we just use `all.py` for this purpose? 
> > 
> > I disagree. `all.py` serves its own purpose and may have its own docstring.
> 
> Do you see an example of an `all` module that has a useful docstring?

I didn't examine all, but some `all` modules have docstrings. Useful or not, I don't know.

I think we overload `all.py` if we add package docstring to it...


---

Comment by klee created at 2021-11-04 05:57:40

I advocate `doc.py` since

`sage.combinat.doc`

reads better than

`sage.combinat.all`

in documentation.


---

Comment by mkoeppe created at 2021-11-04 06:30:08

`doc` is fine with me


---

Comment by klee created at 2021-11-04 07:52:26

Working on this, I now realize that what this ticket aims at goes against what the ticket #16256 achieved, which systematically used `__init__.py` for package docstrings. So whatever we do here has possibility to make the combinat people unhappy. 

For example,
`sage.combinat.crystals?` will not work. Instead 

```sage
sage: import sage.combinat.crystals.doc
sage: sage.combinat.crystals.doc?
```

would work.

Travis, what do you think?


---

Comment by tscrim created at 2021-11-04 08:37:56

While I don't use the feature `sage.combinat?`, I can certainly see it as being useful. If we can get this to continue working, then I would have no objections.

I am cc-ing Nicolas to see if he has any comments.


---

Comment by klee created at 2021-11-04 09:00:22

Replying to [comment:33 tscrim]:
> While I don't use the feature `sage.combinat?`, I can certainly see it as being useful. If we can get this to continue working, then I would have no objections.

It seems that we cannot get that to continue working unless we patch IPython, which perhaps we don't want to.


---

Comment by nthiery created at 2021-11-04 10:15:24

Thanks for working on Sage's modularization and for investigating for
solutions!

I see the technical hurdles behind, and don't have a good solution to offer,
but I advocate for finding some technical mean to keep the functionality `package?` to retrieve
information about the package. This is consistent with how users retrieve
information by introspection for all other types of objects (functions, ...),
and when it's not there I have witnessed countless users during classes or
workshops struggle to find an entry point for the documentation (having
to search for the proper submodule; or leave the interpreter to search
around from the ref manual or browsing the web).

This is indeed not a widely adopted idiom in the Python world, yet this is so
natural that I believe we should push for it.

Thanks in advance,


---

Comment by mkoeppe created at 2021-11-04 15:19:27

Thanks for all comments. I agree that thinking of the `?` functionality is important.

I think an easy solution is to have `all.py` put a `__doc__` attribute into its containing package.


---

Comment by klee created at 2021-11-05 11:45:58

New commits:


---

Comment by klee created at 2021-11-05 11:46:36

Replying to [comment:36 mkoeppe]:
> Thanks for all comments. I agree that thinking of the `?` functionality is important.
> 
> I think an easy solution is to have `all.py` put a `__doc__` attribute into its containing package.

That works. Thanks!


---

Comment by klee created at 2021-11-05 11:52:24

Replying to [comment:28 mkoeppe]: 
> > I disagree. `all.py` serves its own purpose and may have its own docstring.
> 
> Do you see an example of an `all` module that has a useful docstring?

I examined all. No I don't. Using `all` now seems a simpler solution than introducing a new file `doc.py`. Even when it has a significant docstring, we can still use `all` to have the package docstring along with it.


---

Comment by mkoeppe created at 2021-11-05 16:49:56

This looks great to me. Ready for review?


---

Comment by nthiery created at 2021-11-05 17:00:18

Great to have a simple solution! all.py is not super standard in the
Python world, but since it's a long time idiom to use it in Sage,
we might indeed as well use it for the package docstrings too.
Also, since `<package>.__doc__` is only used at runtime and not during
package loading; so having a little dynamic monkey patching of the package
causes no risk.

Hence +1 on my side on the principle. Thanks!


---

Comment by klee created at 2021-11-05 21:59:02

Changing status from new to needs_info.


---

Comment by klee created at 2021-11-05 21:59:02

Replying to [comment:40 mkoeppe]:
> This looks great to me. Ready for review?

We are supposed to deal with all `__init__` files. No?

Now that we have a solution, I think we need to polish the code, especially as it would be used as an idiom globally in Sage. 

Any ideas for improvement, in names or organization, are welcome.


---

Comment by klee created at 2021-11-05 22:03:09

Replying to [comment:41 nthiery]:
> Great to have a simple solution! all.py is not super standard in the
> Python world, but since it's a long time idiom to use it in Sage,
> we might indeed as well use it for the package docstrings too.

There seems no better place for (namespace) package docstrings. But I am open for better ideas.


---

Comment by klee created at 2021-11-05 22:03:09

Changing status from needs_info to needs_work.


---

Comment by tscrim created at 2021-11-06 01:36:09

I don't see a reason why `all.py` should have its own docstring either. I am +1 for using that.


---

Comment by mkoeppe created at 2021-11-06 19:00:35

Replying to [comment:42 klee]:
> Replying to [comment:40 mkoeppe]:
> > This looks great to me. Ready for review?
> 
> We are supposed to deal with all `__init__` files. No?

Not necessarily. Only the `__init__.py` files of packages that will become namespace packages. See explanation in #32501 (also related to our previous discussion in #32734#comment:13).


---

Comment by mkoeppe created at 2021-11-06 19:02:50

Re-running the command from the ticket description of #32501 on the present branch:

```
$ find src/sage -name '__init__.py' | xargs wc -l | grep -v '^ *0'
       2 src/sage/crypto/__init__.py
       3 src/sage/crypto/mq/__init__.py
       3 src/sage/dynamics/__init__.py
       3 src/sage/dynamics/cellular_automata/__init__.py
       1 src/sage/combinat/words/__init__.py
       1 src/sage/combinat/designs/__init__.py
       1 src/sage/combinat/chas/__init__.py
       1 src/sage/combinat/path_tableaux/__init__.py
       1 src/sage/combinat/species/__init__.py
       1 src/sage/combinat/sf/__init__.py
       1 src/sage/combinat/ncsf_qsym/__init__.py
       6 src/sage/combinat/integer_lists/__init__.py
       9 src/sage/combinat/root_system/__init__.py
       3 src/sage/doctest/__init__.py
     847 src/sage/features/__init__.py
      15 src/sage/repl/__init__.py
       4 src/sage/repl/rich_output/__init__.py
      34 src/sage/__init__.py
     358 src/sage/libs/giac/__init__.py
       2 src/sage/libs/ntl/__init__.py
       1 src/sage/libs/gap/__init__.py
     199 src/sage/libs/pari/__init__.py
      55 src/sage/cpython/__init__.py
       2 src/sage/sat/converters/__init__.py
       4 src/sage/sat/solvers/__init__.py
       1 src/sage/modular/quasimodform/__init__.py
       2 src/sage/finance/__init__.py
       2 src/sage/matroids/__init__.py
     114 src/sage/rings/polynomial/pbori/__init__.py
      10 src/sage/modules/with_basis/__init__.py
       2 src/sage/structure/__init__.py
       2 src/sage/media/__init__.py
```



---

Comment by mkoeppe created at 2021-11-06 19:26:16

To do:
- `src/sage/dynamics/__init__.py` - because `sage.dynamics.complex_dynamics` needs `sage.symbolic` and everything else does not, see #32601
- `src/sage/combinat/root_system/__init__.py` - because `git grep 'cimport' src/sage/combinat/root_system/` reveals `from sage.groups.perm_gps.permgroup_element cimport PermutationGroupElement`, and `git grep 'cimport' src/sage/groups/perm_gps` shows dependencies on numerous libraries: `gap`, `flint`
- `src/sage/matroids` - to play safe given that there's a lot of `cimport`ing

Not necessary to change:
- `src/sage/combinat/words/__init__.py` because `git grep 'cimport' src/sage/combinat/words` does not show compile-time dependencies on libraries, so `sage.combinat.words` does not have to become a namespace package
- likewise `src/sage/combinat/integer_lists/__init__.py`
- `src/sage/sat/...` because `git grep 'cimport' src/sage/sat/` is empty
- `src/sage/features/`, `src/sage/libs/...`, `src/sage/repl` because they will definitely not become namespace packages


---

Comment by git created at 2021-11-08 01:57:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-11-08 01:58:04

New commits:


---

Comment by klee created at 2021-11-08 01:58:04

Changing status from needs_work to needs_review.


---

Comment by klee created at 2021-11-08 01:59:48

Re-running the command from the ticket description of #32501 on the present branch:

```
$ find src/sage -name '__init__.py' | xargs wc -l | grep -v '^ *0'
       2 src/sage/crypto/__init__.py
       3 src/sage/crypto/mq/__init__.py
       3 src/sage/dynamics/cellular_automata/__init__.py
      41 src/sage/combinat/words/__init__.py
       1 src/sage/combinat/designs/__init__.py
       1 src/sage/combinat/chas/__init__.py
       1 src/sage/combinat/path_tableaux/__init__.py
       1 src/sage/combinat/species/__init__.py
       1 src/sage/combinat/sf/__init__.py
       1 src/sage/combinat/ncsf_qsym/__init__.py
       6 src/sage/combinat/integer_lists/__init__.py
       9 src/sage/combinat/root_system/__init__.py
       3 src/sage/doctest/__init__.py
     847 src/sage/features/__init__.py
      15 src/sage/repl/__init__.py
       4 src/sage/repl/rich_output/__init__.py
      34 src/sage/__init__.py
     358 src/sage/libs/giac/__init__.py
       2 src/sage/libs/ntl/__init__.py
       1 src/sage/libs/gap/__init__.py
     199 src/sage/libs/pari/__init__.py
      55 src/sage/cpython/__init__.py
       2 src/sage/sat/converters/__init__.py
       4 src/sage/sat/solvers/__init__.py
       1 src/sage/modular/quasimodform/__init__.py
       2 src/sage/finance/__init__.py
       2 src/sage/matroids/__init__.py
     114 src/sage/rings/polynomial/pbori/__init__.py
      10 src/sage/modules/with_basis/__init__.py
       2 src/sage/structure/__init__.py
       2 src/sage/media/__init__.py
    1727 total
```



---

Comment by mkoeppe created at 2021-11-08 03:27:06

Looking great but I'm getting a docbuild error:

```
[dochtml] [combinat ] /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages/sage/combinat/crystals/crystals.py:docstring of sage.combinat.crystals.crystals:122: WARNING: undefined label: sage.combinat.crystals
[dochtml] [combinat ] /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages/sage/combinat/quickref.py:docstring of sage.combinat.quickref:48: WARNING: undefined label: sage.combinat.root_system
[dochtml] [combinat ] /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages/sage/combinat/quickref.py:docstring of sage.combinat.quickref:54: WARNING: undefined label: sage.combinat.crystals
[dochtml] [combinat ] /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages/sage/combinat/quickref.py:docstring of sage.combinat.quickref:71: WARNING: undefined label: sage.combinat.posets
[dochtml] [combinat ] /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages/sage/combinat/root_system/root_system.py:docstring of sage.combinat.root_system.root_system:3: WARNING: undefined label: sage.combinat.root_system
[dochtml] [combinat ] dumping search index in English (code: en)... done
[dochtml] [combinat ] The HTML pages are in local/share/doc/sage/html/en/reference/combinat.
[dochtml] Error building the documentation.
```



---

Comment by git created at 2021-11-08 04:18:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-11-08 04:19:43

Strange that those errors got slipped in unnoticed...


---

Comment by mkoeppe created at 2021-11-08 04:45:21

It's working now, and the built documentation also looks fine. Thanks!


---

Comment by mkoeppe created at 2021-11-08 04:45:21

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2021-11-08 13:26:35

Looks good indeed.

Just one thing (that could possibly go in a follow up
ticket): would there be a way to maintain the validity
of cross-references like :ref:`sage.combinat` ?

First because it's easier to remember, and does not
reveal an implementation detail (that the doc is actually
stored in `sage/combinat/all.py`).

But also because, thanks to intersphinx links these
cross-references can be used from documents outside
of the Sage documentation, and this is breaking
backward compatibility for them.

Thanks,


---

Comment by klee created at 2021-11-09 00:45:37

Replying to [comment:56 nthiery]:
> Looks good indeed.
> 
> Just one thing (that could possibly go in a follow up
> ticket): would there be a way to maintain the validity
> of cross-references like :ref:`sage.combinat` ?

If you compare "before" and "after" below, we see that Sphinx recognizes regular package and treat it appropriately. Hence I think we need to wait until Sphinx gets equipped with some mechanism to deal with namespace packages appropriately. It seems that Sphinx does not have such a mechanism yet (as far as I know by googling).   
----
Before the patch: this line

```
.. toctree::    

    sage/combinat/__init__   
```

generates

```
.. nodoctest

.. _sage.combinat:

Combinatorics
=============

.. This file has been autogenerated.


.. automodule:: sage.combinat.__init__
   :members:
   :undoc-members:
   :show-inheritance:   
```


After the patch: this line

```
.. toctree::    

    sage/combinat/all  
```

generates

```
.. nodoctest

.. _sage.combinat.all:

Combinatorics
=============

.. This file has been autogenerated.


.. automodule:: sage.combinat.all
   :members:
   :undoc-members:
   :show-inheritance:  
```



---

Comment by vbraun created at 2021-11-12 21:27:46

Resolution: fixed


---

Comment by jhpalmieri created at 2022-05-29 00:46:14

The addition of

```
from . import quickref, tutorial
```

to `sage.combinat.all` broke the top-level `tutorial()` command. Maybe that command should be removed anyway, especially since no one has reported its loss, but in any case, right now `tutorial()` is broken as a command in Sage.


---

Comment by klee created at 2022-05-29 06:35:15

Replying to [comment:59 jhpalmieri]:
> The addition of
> {{{
> from . import quickref, tutorial
> }}}
> to `sage.combinat.all` broke the top-level `tutorial()` command. Maybe that command should be removed anyway, especially since no one has reported its loss, but in any case, right now `tutorial()` is broken as a command in Sage.

After 7 months, I don't remember why I put that line into `all.py`. Simply removing that line would solve the problem. Yes? We don't need `quickref` either in the global name space.


---

Comment by nthiery created at 2022-05-29 10:23:03

Indeed, there is no reason for quickref and tutorial to be in the global namespace.
All we need is to be able to do sage.combinat? sage.combinat.tutorial? and sage.combinat.quickref?


---

Comment by klee created at 2022-05-29 12:05:00

See #33933.
