# Issue 32025: docbuild errors out with "cannot copy static file FileExistsError"

archive/issues_032025.json:
```json
{
    "body": "CC:  @jhpalmieri @isuruf\n\nThis is observed with the latest beta on Linux and macOS:\n\n\n```\n...\n[dochtml] [reference] valuations: 1 todos, 14 index, 0 citations, 13 modules\n[dochtml] [reference] ... done (499 todos, 2531 index, 1644 citations,\n2153 modules)\n[dochtml] [reference] preparing documents... skipping loading of indexes... done\n[dochtml] [reference] Merging js index files...\n[dochtml] [reference] algebras: 4424 js index entries\n[dochtml] [reference] arithgroup: 1204 js index entries\n...\n\n[dochtml] [reference] topology: 1937 js index entries\n[dochtml] [reference] valuations: 973 js index entries\n[dochtml] [reference] ... done (64387 js index entries)\n[dochtml] [reference] copying static files... failed\n[dochtml] [reference] WARNING: cannot copy static file\nFileExistsError(17, 'File exists')\n[dochtml] [reference] dumping search index in English (code: en)... done\n[dochtml] [reference] The HTML pages are in\nlocal/share/doc/sage/html/en/reference.\n[dochtml] Error building the documentation.\n```\n\nbut\n\n```\nmake -j1\n```\n\nallows the docs to build (slowly)\n\nIssue created by migration from https://trac.sagemath.org/ticket/32262\n\n",
    "created_at": "2021-07-22T02:03:00Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "docbuild errors out with \"cannot copy static file FileExistsError\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32025",
    "user": "https://github.com/kwankyu"
}
```
CC:  @jhpalmieri @isuruf

This is observed with the latest beta on Linux and macOS:


```
...
[dochtml] [reference] valuations: 1 todos, 14 index, 0 citations, 13 modules
[dochtml] [reference] ... done (499 todos, 2531 index, 1644 citations,
2153 modules)
[dochtml] [reference] preparing documents... skipping loading of indexes... done
[dochtml] [reference] Merging js index files...
[dochtml] [reference] algebras: 4424 js index entries
[dochtml] [reference] arithgroup: 1204 js index entries
...

[dochtml] [reference] topology: 1937 js index entries
[dochtml] [reference] valuations: 973 js index entries
[dochtml] [reference] ... done (64387 js index entries)
[dochtml] [reference] copying static files... failed
[dochtml] [reference] WARNING: cannot copy static file
FileExistsError(17, 'File exists')
[dochtml] [reference] dumping search index in English (code: en)... done
[dochtml] [reference] The HTML pages are in
local/share/doc/sage/html/en/reference.
[dochtml] Error building the documentation.
```

but

```
make -j1
```

allows the docs to build (slowly)

Issue created by migration from https://trac.sagemath.org/ticket/32262





---

archive/issue_comments_456846.json:
```json
{
    "body": "This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines\n\n\n```diff\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" doc-inventory--reference_top\n```\n\n\nThe other issue in #32043 may be related with this.",
    "created_at": "2021-07-22T02:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456846",
    "user": "https://github.com/kwankyu"
}
```

This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines


```diff
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference_top
```


The other issue in #32043 may be related with this.



---

archive/issue_comments_456847.json:
```json
{
    "body": "`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.",
    "created_at": "2021-07-22T02:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456847",
    "user": "https://github.com/mkoeppe"
}
```

`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.



---

archive/issue_comments_456848.json:
```json
{
    "body": "This is where the error is raised: in `sphinx/builders/html/__init__.py`\n\n\n```python\n    def copy_html_static_files(self, context: Dict) -> None:\n        def onerror(filename: str, error: Exception) -> None:\n            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),\n                           filename, error)\n\n        excluded = Matcher(self.config.exclude_patterns + [\"**/.*\"])\n        for entry in self.config.html_static_path:\n            copy_asset(path.join(self.confdir, entry),\n                       path.join(self.outdir, '_static'),\n                       excluded, context=context, renderer=self.templates, onerror=onerror)\n\n    def copy_html_logo(self) -> None:\n        if self.config.html_logo and not isurl(self.config.html_logo):\n            copy_asset(path.join(self.confdir, self.config.html_logo),\n                       path.join(self.outdir, '_static'))\n\n    def copy_html_favicon(self) -> None:\n        if self.config.html_favicon and not isurl(self.config.html_favicon):\n            copy_asset(path.join(self.confdir, self.config.html_favicon),\n                       path.join(self.outdir, '_static'))\n\n    def copy_static_files(self) -> None:\n        try:\n            with progress_message(__('copying static files')):\n                ensuredir(path.join(self.outdir, '_static'))\n\n                # prepare context for templates\n                context = self.globalcontext.copy()\n                if self.indexer is not None:\n                    context.update(self.indexer.context_for_searchtool())\n\n                self.create_pygments_style_file()\n                self.copy_translation_js()\n                self.copy_stemmer_js()\n                self.copy_theme_static_files(context)\n                self.copy_html_static_files(context)\n                self.copy_html_logo()\n                self.copy_html_favicon()\n        except OSError as err:\n            logger.warning(__('cannot copy static file %r'), err)  \n```\n",
    "created_at": "2021-07-22T04:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456848",
    "user": "https://github.com/kwankyu"
}
```

This is where the error is raised: in `sphinx/builders/html/__init__.py`


```python
    def copy_html_static_files(self, context: Dict) -> None:
        def onerror(filename: str, error: Exception) -> None:
            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),
                           filename, error)

        excluded = Matcher(self.config.exclude_patterns + ["**/.*"])
        for entry in self.config.html_static_path:
            copy_asset(path.join(self.confdir, entry),
                       path.join(self.outdir, '_static'),
                       excluded, context=context, renderer=self.templates, onerror=onerror)

    def copy_html_logo(self) -> None:
        if self.config.html_logo and not isurl(self.config.html_logo):
            copy_asset(path.join(self.confdir, self.config.html_logo),
                       path.join(self.outdir, '_static'))

    def copy_html_favicon(self) -> None:
        if self.config.html_favicon and not isurl(self.config.html_favicon):
            copy_asset(path.join(self.confdir, self.config.html_favicon),
                       path.join(self.outdir, '_static'))

    def copy_static_files(self) -> None:
        try:
            with progress_message(__('copying static files')):
                ensuredir(path.join(self.outdir, '_static'))

                # prepare context for templates
                context = self.globalcontext.copy()
                if self.indexer is not None:
                    context.update(self.indexer.context_for_searchtool())

                self.create_pygments_style_file()
                self.copy_translation_js()
                self.copy_stemmer_js()
                self.copy_theme_static_files(context)
                self.copy_html_static_files(context)
                self.copy_html_logo()
                self.copy_html_favicon()
        except OSError as err:
            logger.warning(__('cannot copy static file %r'), err)  
```




---

archive/issue_comments_456849.json:
```json
{
    "body": "What is the command to reproduce the bug?",
    "created_at": "2021-07-22T04:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456849",
    "user": "https://github.com/kwankyu"
}
```

What is the command to reproduce the bug?



---

archive/issue_comments_456850.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-22T05:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456850",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_456851.json:
```json
{
    "body": "Replying to [comment:5 klee]:\n> What is the command to reproduce the bug?\ntry building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.\n\nI've opened a duplicate ticket (oops) #32263 with a bit more info.",
    "created_at": "2021-07-22T06:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456851",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:5 klee]:
> What is the command to reproduce the bug?
try building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.

I've opened a duplicate ticket (oops) #32263 with a bit more info.



---

archive/issue_comments_456852.json:
```json
{
    "body": "This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.",
    "created_at": "2021-07-25T23:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456852",
    "user": "https://github.com/jhpalmieri"
}
```

This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.



---

archive/issue_comments_456853.json:
```json
{
    "body": "Investigating this, I find somethings strange. \n\nMy sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?\n\nThe bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. \n\n#27754 made special tweaks for mac regarding parallel building. Might be related...",
    "created_at": "2021-07-26T02:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456853",
    "user": "https://github.com/kwankyu"
}
```

Investigating this, I find somethings strange. 

My sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?

The bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. 

#27754 made special tweaks for mac regarding parallel building. Might be related...



---

archive/issue_comments_456854.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.\n\nRight. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content \n\n```\n/*\n * plot_directive.css\n * ~~~~~~~~~~~~\n *\n * Stylesheet controlling images created using the `plot` directive within\n * Sphinx.\n *\n * :copyright: Copyright 2020-* by the Matplotlib development team.\n * :license: Matplotlib, see LICENSE for details.\n *\n */\n\nimg.plot-directive {\n    border: 0;\n    max-width: 100%;\n}\n```\n\ninto the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.",
    "created_at": "2021-07-26T06:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456854",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:10 jhpalmieri]:
> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.

Right. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content 

```
/*
 * plot_directive.css
 * ~~~~~~~~~~~~
 *
 * Stylesheet controlling images created using the `plot` directive within
 * Sphinx.
 *
 * :copyright: Copyright 2020-* by the Matplotlib development team.
 * :license: Matplotlib, see LICENSE for details.
 *
 */

img.plot-directive {
    border: 0;
    max-width: 100%;
}
```

into the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.



---

archive/issue_comments_456855.json:
```json
{
    "body": "In\n\nhttps://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html\n\nFind\n\n```python\ndef _copy_css_file(app, exc):\n    if exc is None and app.builder.format == 'html':\n        src = cbook._get_data_path('plot_directive/plot_directive.css')\n        dst = app.outdir / Path('_static')\n        shutil.copy(src, dst)\n```\n",
    "created_at": "2021-07-26T10:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456855",
    "user": "https://github.com/kwankyu"
}
```

In

https://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html

Find

```python
def _copy_css_file(app, exc):
    if exc is None and app.builder.format == 'html':
        src = cbook._get_data_path('plot_directive/plot_directive.css')
        dst = app.outdir / Path('_static')
        shutil.copy(src, dst)
```




---

archive/issue_comments_456856.json:
```json
{
    "body": "Ah, hence Sphinx needs to create `_static` directory before matplotlib does..",
    "created_at": "2021-07-26T10:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456856",
    "user": "https://github.com/kwankyu"
}
```

Ah, hence Sphinx needs to create `_static` directory before matplotlib does..



---

archive/issue_comments_456857.json:
```json
{
    "body": "I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.",
    "created_at": "2021-07-26T20:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456857",
    "user": "https://github.com/jhpalmieri"
}
```

I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.



---

archive/issue_comments_456858.json:
```json
{
    "body": "Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this\n\n```python\nclass AllBuilder(object):\n    \"\"\"\n    A class used to build all of the documentation.\n    \"\"\"\n    ...\n    def _wrapper(self, name, *args, **kwds):\n        \"\"\"\n        This is the function which goes through all of the documents\n        and does the actual building.\n        \"\"\"\n        ...\n        logger.warning(\"Building reference manual, second pass.\\n\")\n        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n        for document in refs:\n            getattr(get_builder(document), name)(*args, **kwds)   \n```\n\n\nI think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.\n\nI leave the necessary work to fix these to the experts on the `make` files.",
    "created_at": "2021-07-27T06:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456858",
    "user": "https://github.com/kwankyu"
}
```

Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this

```python
class AllBuilder(object):
    """
    A class used to build all of the documentation.
    """
    ...
    def _wrapper(self, name, *args, **kwds):
        """
        This is the function which goes through all of the documents
        and does the actual building.
        """
        ...
        logger.warning("Building reference manual, second pass.\n")
        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
        for document in refs:
            getattr(get_builder(document), name)(*args, **kwds)   
```


I think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.

I leave the necessary work to fix these to the experts on the `make` files.



---

archive/issue_comments_456859.json:
```json
{
    "body": "My experiments show the opposite: if creating `_static` explicitly is not done, i.e\n\n```diff\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -345,7 +345,7 @@ class AllBuilder(object):\n             getattr(get_builder(document), 'inventory')(*args, **kwds)\n \n         logger.warning(\"Building reference manual, second pass.\\n\")\n-        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n+        # sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         for document in refs:\n             getattr(get_builder(document), name)(*args, **kwds)\n```\n\nthen docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.\n`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.",
    "created_at": "2021-07-27T13:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456859",
    "user": "https://github.com/dimpase"
}
```

My experiments show the opposite: if creating `_static` explicitly is not done, i.e

```diff
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -345,7 +345,7 @@ class AllBuilder(object):
             getattr(get_builder(document), 'inventory')(*args, **kwds)
 
         logger.warning("Building reference manual, second pass.\n")
-        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
+        # sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         for document in refs:
             getattr(get_builder(document), name)(*args, **kwds)
```

then docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.
`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.



---

archive/issue_comments_456860.json:
```json
{
    "body": "oops, no, I take comment:17 back. The patch there has no effect.\n\nOn the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.",
    "created_at": "2021-07-27T14:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456860",
    "user": "https://github.com/dimpase"
}
```

oops, no, I take comment:17 back. The patch there has no effect.

On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.



---

archive/issue_comments_456861.json:
```json
{
    "body": "I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n\nThe following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n\n```diff\ndiff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\nindex b63e53539e..41140f4e1e 100644\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):\n         \"\"\"\n         # Force regeneration of all modules if the inherited\n         # and/or underscored members options have changed.\n+        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         cache = self.get_cache()\n         force = False\n         try:\n```\n",
    "created_at": "2021-07-27T16:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456861",
    "user": "https://github.com/jhpalmieri"
}
```

I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.

The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:

```diff
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index b63e53539e..41140f4e1e 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
         """
         # Force regeneration of all modules if the inherited
         # and/or underscored members options have changed.
+        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         cache = self.get_cache()
         force = False
         try:
```




---

archive/issue_comments_456862.json:
```json
{
    "body": "Replying to [comment:19 jhpalmieri]:\n> I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n> \n> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n> {{{\n> #!diff\n> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\n> index b63e53539e..41140f4e1e 100644\n> --- a/src/sage_docbuild/__init__.py\n> +++ b/src/sage_docbuild/__init__.py\n> `@``@` -783,6 +783,7 `@``@` class ReferenceSubBuilder(DocBuilder):\n>          \"\"\"\n>          # Force regeneration of all modules if the inherited\n>          # and/or underscored members options have changed.\n> +        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n>          cache = self.get_cache()\n>          force = False\n>          try:\n> }}}\n\nyes, looks like an upstream bug. Would it be better to patch matplotlib?\nAnyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428",
    "created_at": "2021-07-27T17:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456862",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:19 jhpalmieri]:
> I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.
> 
> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:
> {{{
> #!diff
> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
> index b63e53539e..41140f4e1e 100644
> --- a/src/sage_docbuild/__init__.py
> +++ b/src/sage_docbuild/__init__.py
> `@``@` -783,6 +783,7 `@``@` class ReferenceSubBuilder(DocBuilder):
>          """
>          # Force regeneration of all modules if the inherited
>          # and/or underscored members options have changed.
> +        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
>          cache = self.get_cache()
>          force = False
>          try:
> }}}

yes, looks like an upstream bug. Would it be better to patch matplotlib?
Anyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428



---

archive/issue_comments_456863.json:
```json
{
    "body": "Thank you for reporting that upstream.\n\nI prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in comment:19 in how we use Sphinx won't hurt.",
    "created_at": "2021-07-27T17:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456863",
    "user": "https://github.com/jhpalmieri"
}
```

Thank you for reporting that upstream.

I prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in comment:19 in how we use Sphinx won't hurt.



---

archive/issue_comments_456864.json:
```json
{
    "body": "Should I create a branch with my proposed change?",
    "created_at": "2021-07-27T21:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456864",
    "user": "https://github.com/jhpalmieri"
}
```

Should I create a branch with my proposed change?



---

archive/issue_comments_456865.json:
```json
{
    "body": "Replying to [comment:18 dimpase]:\n> oops, no, I take comment:17 back. The patch there has no effect.\n> \n> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. \n\nAs far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.",
    "created_at": "2021-07-28T01:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456865",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:18 dimpase]:
> oops, no, I take comment:17 back. The patch there has no effect.
> 
> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. 

As far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.



---

archive/issue_comments_456866.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> Should I create a branch with my proposed change?\n\n`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n\nThe `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?",
    "created_at": "2021-07-28T01:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456866",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:22 jhpalmieri]:
> Should I create a branch with my proposed change?

`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.

The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?



---

archive/issue_comments_456867.json:
```json
{
    "body": "Replying to [comment:24 klee]:\n> Replying to [comment:22 jhpalmieri]:\n> > Should I create a branch with my proposed change?\n> \n> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> \n> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\nEverything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\nWe didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).",
    "created_at": "2021-07-28T02:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456867",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:24 klee]:
> Replying to [comment:22 jhpalmieri]:
> > Should I create a branch with my proposed change?
> 
> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> 
> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

We didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).



---

archive/issue_comments_456868.json:
```json
{
    "body": "Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.",
    "created_at": "2021-07-28T02:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456868",
    "user": "https://github.com/jhpalmieri"
}
```

Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.



---

archive/issue_comments_456869.json:
```json
{
    "body": "Replying to [comment:25 jhpalmieri]:\n> Replying to [comment:24 klee]:\n> > Replying to [comment:22 jhpalmieri]:\n> > > Should I create a branch with my proposed change?\n> > \n> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > \n> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n> \n> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\nAlso, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.",
    "created_at": "2021-07-28T02:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456869",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:25 jhpalmieri]:
> Replying to [comment:24 klee]:
> > Replying to [comment:22 jhpalmieri]:
> > > Should I create a branch with my proposed change?
> > 
> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > 
> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 
> 
> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.



---

archive/issue_comments_456870.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> Replying to [comment:25 jhpalmieri]:\n> > Replying to [comment:24 klee]:\n> > > Replying to [comment:22 jhpalmieri]:\n> > > > Should I create a branch with my proposed change?\n> > > \n> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > > \n> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n> > \n> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n> \n> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.\n\nIsn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.",
    "created_at": "2021-07-28T03:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456870",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:27 jhpalmieri]:
> Replying to [comment:25 jhpalmieri]:
> > Replying to [comment:24 klee]:
> > > Replying to [comment:22 jhpalmieri]:
> > > > Should I create a branch with my proposed change?
> > > 
> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > > 
> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 
> > 
> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.
> 
> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.

Isn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.



---

archive/issue_comments_456871.json:
```json
{
    "body": "If someone does `make build` and then `sage --docbuild ...`, it should work.",
    "created_at": "2021-07-28T05:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456871",
    "user": "https://github.com/jhpalmieri"
}
```

If someone does `make build` and then `sage --docbuild ...`, it should work.



---

archive/issue_comments_456872.json:
```json
{
    "body": "Replying to [comment:29 jhpalmieri]:\n> If someone does `make build` and then `sage --docbuild ...`, it should work.\n\nOkay. Then I have no better idea where the fix should be placed.",
    "created_at": "2021-07-28T07:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456872",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:29 jhpalmieri]:
> If someone does `make build` and then `sage --docbuild ...`, it should work.

Okay. Then I have no better idea where the fix should be placed.



---

archive/issue_comments_456873.json:
```json
{
    "body": "To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580",
    "created_at": "2021-07-28T08:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456873",
    "user": "https://github.com/dimpase"
}
```

To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580



---

archive/issue_comments_456874.json:
```json
{
    "body": "Replying to [comment:31 dimpase]:\n> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580\n\nGood. Then there's nothing to do here.",
    "created_at": "2021-07-28T09:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456874",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:31 dimpase]:
> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580

Good. Then there's nothing to do here.



---

archive/issue_comments_456875.json:
```json
{
    "body": "I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.",
    "created_at": "2021-07-28T16:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456875",
    "user": "https://github.com/jhpalmieri"
}
```

I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.



---

archive/issue_comments_456876.json:
```json
{
    "body": "I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748",
    "created_at": "2021-07-28T22:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456876",
    "user": "https://github.com/dimpase"
}
```

I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748



---

archive/issue_comments_456877.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-28T22:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456877",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_456878.json:
```json
{
    "body": "matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)",
    "created_at": "2021-09-07T23:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456878",
    "user": "https://github.com/mkoeppe"
}
```

matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)



---

archive/issue_comments_456879.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-08T00:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456879",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_456880.json:
```json
{
    "body": "Let's close this, then.",
    "created_at": "2021-09-08T00:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456880",
    "user": "https://github.com/jhpalmieri"
}
```

Let's close this, then.



---

archive/issue_comments_456881.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-09-10T04:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-456881",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_029111.json:
```json
{
    "actor": "@mkoeppe",
    "created_at": "2021-09-10T04:50:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-29111"
}
```
