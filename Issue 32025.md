# Issue 32025: docbuild errors out with "cannot copy static file FileExistsError"

Issue created by migration from https://trac.sagemath.org/ticket/32262

Original creator: klee

Original creation time: 2021-07-22 02:03:00

CC:  jhpalmieri isuruf

This is observed with the latest beta on Linux and macOS:


```
...
[dochtml] [reference] valuations: 1 todos, 14 index, 0 citations, 13 modules
[dochtml] [reference] ... done (499 todos, 2531 index, 1644 citations,
2153 modules)
[dochtml] [reference] preparing documents... skipping loading of indexes... done
[dochtml] [reference] Merging js index files...
[dochtml] [reference] algebras: 4424 js index entries
[dochtml] [reference] arithgroup: 1204 js index entries
...

[dochtml] [reference] topology: 1937 js index entries
[dochtml] [reference] valuations: 973 js index entries
[dochtml] [reference] ... done (64387 js index entries)
[dochtml] [reference] copying static files... failed
[dochtml] [reference] WARNING: cannot copy static file
FileExistsError(17, 'File exists')
[dochtml] [reference] dumping search index in English (code: en)... done
[dochtml] [reference] The HTML pages are in
local/share/doc/sage/html/en/reference.
[dochtml] Error building the documentation.
```

but

```
make -j1
```

allows the docs to build (slowly)


---

Comment by klee created at 2021-07-22 02:10:08

This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines


```diff
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference_top
```


The other issue in #32043 may be related with this.


---

Comment by mkoeppe created at 2021-07-22 02:51:39

`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.


---

Comment by klee created at 2021-07-22 04:15:48

This is where the error is raised: in `sphinx/builders/html/__init__.py`


```python
    def copy_html_static_files(self, context: Dict) -> None:
        def onerror(filename: str, error: Exception) -> None:
            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),
                           filename, error)

        excluded = Matcher(self.config.exclude_patterns + ["**/.*"])
        for entry in self.config.html_static_path:
            copy_asset(path.join(self.confdir, entry),
                       path.join(self.outdir, '_static'),
                       excluded, context=context, renderer=self.templates, onerror=onerror)

    def copy_html_logo(self) -> None:
        if self.config.html_logo and not isurl(self.config.html_logo):
            copy_asset(path.join(self.confdir, self.config.html_logo),
                       path.join(self.outdir, '_static'))

    def copy_html_favicon(self) -> None:
        if self.config.html_favicon and not isurl(self.config.html_favicon):
            copy_asset(path.join(self.confdir, self.config.html_favicon),
                       path.join(self.outdir, '_static'))

    def copy_static_files(self) -> None:
        try:
            with progress_message(__('copying static files')):
                ensuredir(path.join(self.outdir, '_static'))

                # prepare context for templates
                context = self.globalcontext.copy()
                if self.indexer is not None:
                    context.update(self.indexer.context_for_searchtool())

                self.create_pygments_style_file()
                self.copy_translation_js()
                self.copy_stemmer_js()
                self.copy_theme_static_files(context)
                self.copy_html_static_files(context)
                self.copy_html_logo()
                self.copy_html_favicon()
        except OSError as err:
            logger.warning(__('cannot copy static file %r'), err)  
```



---

Comment by klee created at 2021-07-22 04:26:08

What is the command to reproduce the bug?


---

Comment by mkoeppe created at 2021-07-22 05:45:11

Changing priority from major to critical.


---

Comment by dimpase created at 2021-07-22 06:50:01

Replying to [comment:5 klee]:
> What is the command to reproduce the bug?
try building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.

I've opened a duplicate ticket (oops) #32263 with a bit more info.


---

Comment by jhpalmieri created at 2021-07-25 23:33:13

This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.


---

Comment by klee created at 2021-07-26 02:10:53

Investigating this, I find somethings strange. 

My sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?

The bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. 

#27754 made special tweaks for mac regarding parallel building. Might be related...


---

Comment by klee created at 2021-07-26 06:54:38

Replying to [comment:10 jhpalmieri]:
> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.

Right. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content 

```
/*
 * plot_directive.css
 * ~~~~~~~~~~~~
 *
 * Stylesheet controlling images created using the `plot` directive within
 * Sphinx.
 *
 * :copyright: Copyright 2020-* by the Matplotlib development team.
 * :license: Matplotlib, see LICENSE for details.
 *
 */

img.plot-directive {
    border: 0;
    max-width: 100%;
}
```

into the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.


---

Comment by klee created at 2021-07-26 10:51:38

In

https://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html

Find

```python
def _copy_css_file(app, exc):
    if exc is None and app.builder.format == 'html':
        src = cbook._get_data_path('plot_directive/plot_directive.css')
        dst = app.outdir / Path('_static')
        shutil.copy(src, dst)
```



---

Comment by klee created at 2021-07-26 10:56:54

Ah, hence Sphinx needs to create `_static` directory before matplotlib does..


---

Comment by jhpalmieri created at 2021-07-26 20:29:15

I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.


---

Comment by klee created at 2021-07-27 06:34:08

Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this

```python
class AllBuilder(object):
    """
    A class used to build all of the documentation.
    """
    ...
    def _wrapper(self, name, *args, **kwds):
        """
        This is the function which goes through all of the documents
        and does the actual building.
        """
        ...
        logger.warning("Building reference manual, second pass.\n")
        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
        for document in refs:
            getattr(get_builder(document), name)(*args, **kwds)   
```


I think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.

I leave the necessary work to fix these to the experts on the `make` files.


---

Comment by dimpase created at 2021-07-27 13:18:42

My experiments show the opposite: if creating `_static` explicitly is not done, i.e

```diff
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -345,7 +345,7 @@ class AllBuilder(object):
             getattr(get_builder(document), 'inventory')(*args, **kwds)
 
         logger.warning("Building reference manual, second pass.\n")
-        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
+        # sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         for document in refs:
             getattr(get_builder(document), name)(*args, **kwds)
```

then docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.
`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.


---

Comment by dimpase created at 2021-07-27 14:02:44

oops, no, I take comment:17 back. The patch there has no effect.

On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.


---

Comment by jhpalmieri created at 2021-07-27 16:20:14

I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a _file_ `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.

The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:

```diff
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index b63e53539e..41140f4e1e 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
         """
         # Force regeneration of all modules if the inherited
         # and/or underscored members options have changed.
+        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         cache = self.get_cache()
         force = False
         try:
```



---

Comment by dimpase created at 2021-07-27 17:03:50

Replying to [comment:19 jhpalmieri]:
> I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a _file_ `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.
> 
> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:
> {{{
> #!diff
> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
> index b63e53539e..41140f4e1e 100644
> --- a/src/sage_docbuild/__init__.py
> +++ b/src/sage_docbuild/__init__.py
> `@``@` -783,6 +783,7 `@``@` class ReferenceSubBuilder(DocBuilder):
>          """
>          # Force regeneration of all modules if the inherited
>          # and/or underscored members options have changed.
> +        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
>          cache = self.get_cache()
>          force = False
>          try:
> }}}

yes, looks like an upstream bug. Would it be better to patch matplotlib?
Anyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428


---

Comment by jhpalmieri created at 2021-07-27 17:27:47

Thank you for reporting that upstream.

I prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in comment:19 in how we use Sphinx won't hurt.


---

Comment by jhpalmieri created at 2021-07-27 21:48:13

Should I create a branch with my proposed change?


---

Comment by klee created at 2021-07-28 01:12:08

Replying to [comment:18 dimpase]:
> oops, no, I take comment:17 back. The patch there has no effect.
> 
> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. 

As far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.


---

Comment by klee created at 2021-07-28 01:37:26

Replying to [comment:22 jhpalmieri]:
> Should I create a branch with my proposed change?

`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.

The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?


---

Comment by jhpalmieri created at 2021-07-28 02:10:48

Replying to [comment:24 klee]:
> Replying to [comment:22 jhpalmieri]:
> > Should I create a branch with my proposed change?
> 
> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> 
> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

We didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).


---

Comment by jhpalmieri created at 2021-07-28 02:11:43

Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.


---

Comment by jhpalmieri created at 2021-07-28 02:17:40

Replying to [comment:25 jhpalmieri]:
> Replying to [comment:24 klee]:
> > Replying to [comment:22 jhpalmieri]:
> > > Should I create a branch with my proposed change?
> > 
> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > 
> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 
> 
> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.


---

Comment by klee created at 2021-07-28 03:37:38

Replying to [comment:27 jhpalmieri]:
> Replying to [comment:25 jhpalmieri]:
> > Replying to [comment:24 klee]:
> > > Replying to [comment:22 jhpalmieri]:
> > > > Should I create a branch with my proposed change?
> > > 
> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > > 
> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 
> > 
> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.
> 
> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.

Isn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.


---

Comment by jhpalmieri created at 2021-07-28 05:26:03

If someone does `make build` and then `sage --docbuild ...`, it should work.


---

Comment by klee created at 2021-07-28 07:05:24

Replying to [comment:29 jhpalmieri]:
> If someone does `make build` and then `sage --docbuild ...`, it should work.

Okay. Then I have no better idea where the fix should be placed.


---

Comment by dimpase created at 2021-07-28 08:58:34

To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580


---

Comment by klee created at 2021-07-28 09:23:14

Replying to [comment:31 dimpase]:
> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580

Good. Then there's nothing to do here.


---

Comment by jhpalmieri created at 2021-07-28 16:13:03

I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.


---

Comment by dimpase created at 2021-07-28 22:10:21

I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748


---

Comment by dimpase created at 2021-07-28 22:10:21

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-09-07 23:44:50

matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)


---

Comment by jhpalmieri created at 2021-09-08 00:06:37

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-09-08 00:06:37

Let's close this, then.


---

Comment by mkoeppe created at 2021-09-10 04:50:10

Resolution: invalid
