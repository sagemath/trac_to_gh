# Issue 12317: Fix equality of combinatorial free module on non totally ordered basis

Issue created by migration from Trac.

Original creator: hivert

Original creation time: 2012-02-10 12:54:05

Assignee: sage-combinat

CC:  sage-combinat

Keywords: CombinatorialFreeModule, equality

The following is obviously wrong:

```
sage: F = CombinatorialFreeModule(QQ, Subsets([1,2,3]))
sage: x = F.an_element()
sage: x+0 == x
False
sage: x+F.zero() == x
False
```

The reason is

```
sage: (x+F.zero()).terms()  # random
[2*B[{1}], 3*B[{2}], B[{}]]
sage: x.terms()             # random
[2*B[{1}], B[{}], 3*B[{2}]]
```



---

Comment by hivert created at 2012-02-10 13:24:53

Changing keywords from "CombinatorialFreeModule, equality" to "CombinatorialFreeModule, equality, Cernay2012".


---

Comment by hivert created at 2012-02-11 00:32:05

Changing status from new to needs_review.


---

Comment by hivert created at 2012-02-11 00:35:01

I uploaded the patch on behalf of Nicolas and put a positive review since I'm Ok with it (the test suite is currently running). 

Nicolas: I just put the correct trac ticket number and added one more test compared to your patch. I don't think this needs a new review.


---

Comment by hivert created at 2012-02-11 00:35:01

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2012-02-11 18:11:47

+1! Thanks for the review!


---

Comment by jdemeyer created at 2012-02-13 12:43:49


```
sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py", line 33:
    sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)
Expected nothing
Got:
    Failure in _test_one:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py", line 275, in run
        test_method(tester = tester)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py", line 126, in _tes
t_one
        tester.assert_(x * one == x)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py", line 420, in assertTrue
        raise self.failureException(msg)
    AssertionError: False is not true
[...]
```



---

Comment by jdemeyer created at 2012-02-13 12:43:49

Changing status from positive_review to needs_work.


---

Comment by nthiery created at 2012-02-13 15:02:29

Replying to [comment:5 jdemeyer]:
> {{{
> sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
> **********************************************************************
> File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py", line 33:
>     sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)
> Expected nothing
> Got:
>     Failure in _test_one:
>     Traceback (most recent call last):
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py", line 275, in run
>         test_method(tester = tester)
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py", line 126, in _tes
> t_one
>         tester.assert_(x * one == x)
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py", line 420, in assertTrue
>         raise self.failureException(msg)
>     AssertionError: False is not true
> [...]
> }}}

Thanks for catching that. I am working on it. First thing, I am extracting the call to _test_associativity to only set # long on it, and not on the full testsuite (otherwise I would have caught the error myself). The other thing is that the new equality test highlighted a preexisting bug: x*f.one() contains zero coefficients in its dictionary.


---

Comment by nthiery created at 2012-02-13 15:38:39

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by hivert created at 2012-02-13 19:25:27

Replying to [comment:5 jdemeyer]:
> {{{
 sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
 [...]
     AssertionError: False is not true
> }}}
Sorry for not catching this ealier ! I didn't launch the `-long` tests during my review.


---

Comment by hivert created at 2012-02-13 19:27:15

Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?

Florent


---

Comment by nthiery created at 2012-02-13 22:58:49

Replying to [comment:10 hivert]:
> Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?

Yes, that's where I ran the test mentionned above. I'll put sage-combinat-commits in CC next time.


---

Comment by hivert created at 2012-02-14 13:52:58

I put back to positive review while waiting for the result of the tests.


---

Comment by hivert created at 2012-02-14 13:52:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-22 10:46:57

Resolution: fixed
