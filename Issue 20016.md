# Issue 20016: bug in strongly connected test for static digraphs

archive/issues_020016.json:
```json
{
    "body": "CC:  @dimpase\n\nKeywords: bug\n\nUsing the strongly connected graph from [this page](https://graph-tool.skewed.de/performance) I got\n\n```\nsage: import networkx\nsage: g = networkx.read_graphml(\"pgp.xml\")\nsage: networkx.is_strongly_connected(g)\nTrue\nsage: G = DiGraph(g)\nsage: G.is_strongly_connected()\nTrue\n```\n\nBut the test goes wrong with the static sparse backend\n\n```\nsage: G2 = DiGraph(g, immutable=True)\nsage: G2.is_strongly_connected()\nFalse\nsage: G == G2\nTrue\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20253\n\n",
    "created_at": "2016-03-23T01:05:31Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "bug in strongly connected test for static digraphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20016",
    "user": "https://github.com/videlec"
}
```
CC:  @dimpase

Keywords: bug

Using the strongly connected graph from [this page](https://graph-tool.skewed.de/performance) I got

```
sage: import networkx
sage: g = networkx.read_graphml("pgp.xml")
sage: networkx.is_strongly_connected(g)
True
sage: G = DiGraph(g)
sage: G.is_strongly_connected()
True
```

But the test goes wrong with the static sparse backend

```
sage: G2 = DiGraph(g, immutable=True)
sage: G2.is_strongly_connected()
False
sage: G == G2
True
```


Issue created by migration from https://trac.sagemath.org/ticket/20253





---

archive/issue_comments_275412.json:
```json
{
    "body": "I guess that there are much more methods that actually do not work. The thing is that there are uninitialized variables used by some of the methods in `CGraph` that are not initialized by `StaticSparseCGraph`. In the current case it is `num_verts` (that is available as `self.g.n`) and `num_arcs` (that is available as `self.g.m`). Adding at the end of `__init__`.\n\n```diff\ndiff --git a/src/sage/graphs/base/static_sparse_backend.pyx b/src/sage/graphs/base/static_sparse_backend.pyx\nindex 06b19cf..2a98a96 100644\n--- a/src/sage/graphs/base/static_sparse_backend.pyx\n+++ b/src/sage/graphs/base/static_sparse_backend.pyx\n@@ -95,6 +95,9 @@ cdef class StaticSparseCGraph(CGraph):\n         bitset_init(self.active_vertices,  self.g.n+1)\n         bitset_set_first_n(self.active_vertices, self.g.n)\n \n+        self.num_verts = self.g.n\n+        self.num_arcs = self.g.m\n+\n     def __dealloc__(self):\n         r\"\"\"\n         Freeing the memory\n```\n\nBut it looks like more a \"work around\" than a \"real fix\".",
    "created_at": "2016-03-23T01:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275412",
    "user": "https://github.com/videlec"
}
```

I guess that there are much more methods that actually do not work. The thing is that there are uninitialized variables used by some of the methods in `CGraph` that are not initialized by `StaticSparseCGraph`. In the current case it is `num_verts` (that is available as `self.g.n`) and `num_arcs` (that is available as `self.g.m`). Adding at the end of `__init__`.

```diff
diff --git a/src/sage/graphs/base/static_sparse_backend.pyx b/src/sage/graphs/base/static_sparse_backend.pyx
index 06b19cf..2a98a96 100644
--- a/src/sage/graphs/base/static_sparse_backend.pyx
+++ b/src/sage/graphs/base/static_sparse_backend.pyx
@@ -95,6 +95,9 @@ cdef class StaticSparseCGraph(CGraph):
         bitset_init(self.active_vertices,  self.g.n+1)
         bitset_set_first_n(self.active_vertices, self.g.n)
 
+        self.num_verts = self.g.n
+        self.num_arcs = self.g.m
+
     def __dealloc__(self):
         r"""
         Freeing the memory
```

But it looks like more a "work around" than a "real fix".



---

archive/issue_comments_275413.json:
```json
{
    "body": "At least adding these lines at the end of the init method, with possibly other initialization, we ensure that all backends provide the same information.\nI'm surprized none of us noticed that before.\nDavid.",
    "created_at": "2016-03-23T09:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275413",
    "user": "https://github.com/dcoudert"
}
```

At least adding these lines at the end of the init method, with possibly other initialization, we ensure that all backends provide the same information.
I'm surprized none of us noticed that before.
David.



---

archive/issue_comments_275414.json:
```json
{
    "body": "There are other weird stuff\n\n```\nsage: G = Graph([(0,1)])\nsage: G2 = G.copy(immutable=True)\nsage: G2._backend.is_connected()\nTraceback (most recent call last):\n...\nAttributeError: 'sage.graphs.base.static_sparse_backend.StaticSpars'\nobject has no attribute 'num_edges'\n```\n\nThe thing is that it is not clear to me what attributes and methods should be implemented in a new backend.",
    "created_at": "2016-03-23T12:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275414",
    "user": "https://github.com/videlec"
}
```

There are other weird stuff

```
sage: G = Graph([(0,1)])
sage: G2 = G.copy(immutable=True)
sage: G2._backend.is_connected()
Traceback (most recent call last):
...
AttributeError: 'sage.graphs.base.static_sparse_backend.StaticSpars'
object has no attribute 'num_edges'
```

The thing is that it is not clear to me what attributes and methods should be implemented in a new backend.



---

archive/issue_comments_275415.json:
```json
{
    "body": "Well, at least basic features like number of nodes and edges should be in all backends.",
    "created_at": "2016-03-23T13:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275415",
    "user": "https://github.com/dcoudert"
}
```

Well, at least basic features like number of nodes and edges should be in all backends.



---

archive/issue_comments_275416.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275416",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_275417.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275417",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_275418.json:
```json
{
    "body": "the patch is working well and passes but has one doctest error (I tried `sage -tp src/sage/graphs/` \n\n```\nsage -t src/sage/graphs/base/c_graph.pyx\n    Error: Source line number found\n\n```\n\ncertainly due to:\n`doctest:858: DeprecationWarning: _out_degree is deprecated`\n\nDavid.",
    "created_at": "2016-03-23T13:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275418",
    "user": "https://github.com/dcoudert"
}
```

the patch is working well and passes but has one doctest error (I tried `sage -tp src/sage/graphs/` 

```
sage -t src/sage/graphs/base/c_graph.pyx
    Error: Source line number found

```

certainly due to:
`doctest:858: DeprecationWarning: _out_degree is deprecated`

David.



---

archive/issue_comments_275419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-23T13:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275420.json:
```json
{
    "body": "That was it! Thanks.",
    "created_at": "2016-03-23T13:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275420",
    "user": "https://github.com/videlec"
}
```

That was it! Thanks.



---

archive/issue_comments_275421.json:
```json
{
    "body": "why are you using notation `\"Graph size mismatch: %s vs. %s\" % (g.num_arcs, randg.size()))` instead of `\"Graph size mismatch: {} vs. {}\".format(g.num_arcs, randg.size()))` ?",
    "created_at": "2016-03-23T14:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275421",
    "user": "https://github.com/dcoudert"
}
```

why are you using notation `"Graph size mismatch: %s vs. %s" % (g.num_arcs, randg.size()))` instead of `"Graph size mismatch: {} vs. {}".format(g.num_arcs, randg.size()))` ?



---

archive/issue_comments_275422.json:
```json
{
    "body": "I did not change anything there. Just `g_num.verts() -> g.num_verts` and `g._num_arcs() -> g.num_arcs`. Though I can use format.",
    "created_at": "2016-03-23T14:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275422",
    "user": "https://github.com/videlec"
}
```

I did not change anything there. Just `g_num.verts() -> g.num_verts` and `g._num_arcs() -> g.num_arcs`. Though I can use format.



---

archive/issue_comments_275423.json:
```json
{
    "body": "ok, let it as is.",
    "created_at": "2016-03-23T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275423",
    "user": "https://github.com/dcoudert"
}
```

ok, let it as is.



---

archive/issue_comments_275424.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-23T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275424",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_275425.json:
```json
{
    "body": "Thanks!",
    "created_at": "2016-03-23T14:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275425",
    "user": "https://github.com/videlec"
}
```

Thanks!



---

archive/issue_comments_275426.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-26T11:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20016#issuecomment-275426",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
