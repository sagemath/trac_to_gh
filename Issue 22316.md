# Issue 22316: pynac bug -- evaluation of arctan2 fails with traceback

Issue created by migration from Trac.

Original creator: was

Original creation time: 2017-03-09 00:16:54

CC:  paulmasson rws


```
~/Sara$ sage-develop
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.6.beta5, Release Date: 2017-02-26               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: arctan2(1.5,-1.300000000000001)
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-1-ccfa336aad7e> in <module>()
----> 1 arctan2(RealNumber('1.5'),-RealNumber('1.300000000000001'))
 
/projects/sage/sage-dev/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (/projects/sage/sage-dev/src/build/cythonized/sage/symbolic/function.cp
p:11445)()
    994             res = self._evalf_try_(*args)
    995             if res is None:
--> 996                 res = super(BuiltinFunction, self).__call__(
    997                         *args, coerce=coerce, hold=hold)
    998
 
/projects/sage/sage-dev/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (/projects/sage/sage-dev/src/build/cythonized/sage/symbolic/function.cpp:6589)
()
    489                     (<Expression>args[0])._gobj, hold)
    490         elif self._nargs == 2:
--> 491             res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
    492                     (<Expression>args[1])._gobj, hold)
    493         elif self._nargs == 3:
 
/projects/sage/sage-dev/src/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_atan2 (/projects/sage/sage-dev/src/build/cythonized/sage/libs/pynac/pynac.cpp:21075)()
   1790     if P is float and parent(y) is not float:
   1791         P = RR
-> 1792     assert P is parent(y)
   1793     if P is ZZ:
   1794         P = RR
 
AssertionError:
```


In fact, pretty much **any** high precision input (even just padding with zeros) breaks this:

```
sage: atan2(2.1000000000000000000000000000000000000,-1.20000000000000000000000000000000)
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
```



Reported by: Sara Billey


---

Comment by rws created at 2017-03-09 07:01:49

This was introduced in #21371. Not Pynac but its Python interface to Sage's numeric functions.


---

Comment by rws created at 2017-03-09 08:32:42

New commits:


---

Comment by rws created at 2017-03-09 08:32:42

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-09 09:18:09

Why not use

```
from sage.structure.element cimport coercion_model

P = coercion_model.common_parent(x, y)
```



---

Comment by jdemeyer created at 2017-03-09 09:26:43

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-09 09:26:43

I'll make that change and some further changes.


---

Comment by jdemeyer created at 2017-03-09 09:40:51

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-03-09 09:40:51

New commits:


---

Comment by paulmasson created at 2017-03-09 23:14:25

Jeroen, nice work on this. I've been devising ways to get around this assertion error for some time so it's nice to be rid of it. This is an elegant solution and the code cleanup looks good.

A run of `make ptestlong` produced the following errors:


```
sage -t --long src/sage/libs/ppl.pyx  # Timed out after testing finished
sage -t --long src/sage/misc/sagedoc.py  # 3 doctests failed
```


The ppl.pyx error went away on a subsequent test of just that file. Strangely enough, so did the sagedoc.py errors, so I guess we're good to go.


---

Comment by paulmasson created at 2017-03-09 23:15:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-10 23:12:49

Resolution: fixed
