# Issue 24325: py3: fixes to sage.misc.decorators

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-01-18 13:46:30

CC:  chapoton




---

Comment by git created at 2018-01-18 13:46:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-18 13:47:34

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-01-29 14:08:01

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-01-29 14:08:01

> As far as I can tell there's only one place in Sage that uses sage_wraps on a class at all

Where is this "one place in Sage"? If you want me to test this, I guess I should know...


---

Comment by chapoton created at 2018-01-29 15:27:27

There is only one place..

```
git grep -A2 -B2 "`@`sage_wrap" | grep -B2 "class"
src/sage/misc/decorators.py-
src/sage/misc/decorators.py:        `@`sage_wraps(func)
src/sage/misc/decorators.py-        class wrapper:
```



---

Comment by jdemeyer created at 2018-01-29 16:31:19

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2018-01-29 16:31:19

The new version doesn't deal with `__doc__` correctly. Try adding this patch:

```diff
diff --git a/src/sage/misc/decorators.py b/src/sage/misc/decorators.py
index ab16139..62e8a6a 100644
--- a/src/sage/misc/decorators.py
+++ b/src/sage/misc/decorators.py
`@``@` -191,7 +191,9 `@``@` class infix_operator(object):
 
     An infix dot product operator::
 
-        sage: def dot(a,b): return a.dot_product(b)
+        sage: def dot(a,b):
+        ....:     "Dot product"
+        ....:     return a.dot_product(b)
         sage: dot=infix_operator('multiply')(dot)
         sage: u=vector([1,2,3])
         sage: v=vector([5,4,3])
```



---

Comment by chapoton created at 2018-06-12 19:29:15

branch does not apply anymore


---

Comment by git created at 2018-06-26 08:20:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-26 08:20:39

Rebased. I still need to see about addressing Jeroen's comment.


---

Comment by embray created at 2018-06-26 09:42:29

I'm thinking `sage_wraps` shouldn't actually work on classes (the fact that it happens to work on old-style classes was kind of a lucky accident.  The original `functools.wraps` doesn't work on classes, and was never designed to either, and `sage_wraps` isn't _documented_ to work with classes.  It was just used in one case (on an old-style class) and it happened to work.

It's possible to implement `wraps`-like functionality for classes but also a bit trickier (unfortunately).  I think that would be outside the scope of this ticket.


---

Comment by git created at 2018-06-26 09:49:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-26 10:06:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-06-26 10:07:15

Added a little cleanup on the tests for `infix_operator`.  Perhaps should add _more_ tests, but unique tests :)


---

Comment by embray created at 2018-06-26 10:07:49

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-07-17 15:34:55

I believe that by our policy the methods in here should have doctests. Or is there some reason why they shouldn't?


---

Comment by saraedum created at 2018-07-17 15:34:55

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-07-17 17:28:11

What methods do you think require tests?  These are mostly internal details that are tested implicitly by the existing examples.


---

Comment by embray created at 2018-07-17 17:28:11

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by embray created at 2018-08-16 10:59:19

The failures are in `-optional: magma` tests that I guess are enabled on that particular buildbot.  Nothing to do with this I don't think.


---

Comment by saraedum created at 2018-08-22 02:31:41

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-08-22 02:31:41

Replying to [comment:16 embray]:
> What methods do you think require tests?  These are mostly internal details that are tested implicitly by the existing examples.

Sorry, but I don't understand what "internal details" means. I know we had this discussion before but unless something has changed, virtually all methods should be doctested, e.g., the ones in `_infix_wrapper`. Personally, I have no opinion on whether that's a good or a bad policy (I can see valid arguments on both sides, so I am not sure) but I think it's still the way things work; which could be changed of course.

Btw, with the current state of documentation it is not immediately clear to me what `_infix_wrapper` does. A docstring that explains what this class is doing would be helpful.


---

Comment by embray created at 2018-08-22 10:06:48

It doesn't always make sense to write examples for methods that merely serve some internal purpose and are never used directly--instead the tests use these things indirectly in the process of doing the thing it is they're supposed to do.  What this leads to is tests like you can see in the original code, such as:


```
-        def left_func(self, right):
-            """
-            The function for the operation on the left (e.g., __add__).
-
-            EXAMPLES::
-
-                sage: def dot(a,b): return a.dot_product(b)
-                sage: dot=infix_operator('multiply')(dot)
-                sage: u=vector([1,2,3])
-                sage: v=vector([5,4,3])
-                sage: u *dot* v
-                22
-            """
```


This exact same test is repeated like 3 or 4 times in that module, because someone said "it needs an example block" in every method.  This should be clarified in the developer docs, but that really does not mean "literally every `def` statement".  The intention is that every function or method that someone actually uses directly is documented in this way.

Sometimes it still makes sense to have as an example of how an internal method is used, if it's unclear, or if it's an internal method that might be useful when adding new methods to a class or subclass.  But not if it means going into contortions to set up a test for a method that is never called directly in the first place.


---

Comment by embray created at 2018-08-22 10:12:21

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-08-22 10:12:21

Anyways, this ticket isn't adding particularly new code; just slightly refactoring existing code that was written in an odd way that made it needlessly non-portable.  Needlessly duplicated doctests are also removed.

If it's unclear, `_infix_wrapper` is just a base class for wrappers around a function turning that function into an infix operator.  `infix_operator` itself is just the decorator, but `_infix_wrapper` is the base for the actual wrapped functions returned by the decorator.  

This was already in the original code under just the name "wrapper", and it was a class defined inline in `infix_operator.__call__`.  I just moved it out to module level because there was no-need to create new instances of that base class for every `infix_operator` call.


---

Comment by saraedum created at 2018-08-23 16:37:39

Replying to [comment:20 embray]:
> [...] 
> This exact same test is repeated like 3 or 4 times in that module, because someone said "it needs an example block" in every method.  This should be clarified in the developer docs, but that really does not mean "literally every `def` statement".  The intention is that every function or method that someone actually uses directly is documented in this way.
I don't agree. Also internal methods should be documented that way wherever possible imo.

> Sometimes it still makes sense to have as an example of how an internal method is used, if it's unclear, or if it's an internal method that might be useful when adding new methods to a class or subclass.  But not if it means going into contortions to set up a test for a method that is never called directly in the first place.
When I'm not lazy, I try to do an "indirect doctest" when it's too much code to setup the situation where the method could be used or when the method is cleary just a backing for something else, e.g., I'd test `_add_` with `a+b` even though it that calls `__add__`.


---

Comment by saraedum created at 2018-08-23 16:41:36

Replying to [comment:21 embray]:
> Anyways, this ticket isn't adding particularly new code; just slightly refactoring existing code that was written in an odd way that made it needlessly non-portable.  Needlessly duplicated doctests are also removed.
Sure, the doctests were bad. I think we should have tried to replace them with better doctests instead of no doctests.

> If it's unclear, `_infix_wrapper` is just a base class for wrappers around a function turning that function into an infix operator.  `infix_operator` itself is just the decorator, but `_infix_wrapper` is the base for the actual wrapped functions returned by the decorator.  
Ok. This wasn't clear to me. That would almost be a valid docstring for the class.

So, I'll stop bugging you here I think as this probably won't lead anywhere. I am afraid I can't set this to positive review as is. If somebody else wants to do that I am not opposed at all.


---

Comment by embray created at 2018-09-03 11:49:20

I'm not sure why you can't.  Do you have some concrete suggestion for how this could be documented better, other than adding pointless repetitive doctests?


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by chapoton created at 2018-12-31 20:12:23

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-12-31 20:12:23

ok. I would have prefered to see stupid doctests everywhere, but let us move on.


---

Comment by vbraun created at 2019-01-02 08:17:32

Resolution: fixed
