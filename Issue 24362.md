# Issue 24362: Internal compiler error when compiling giac-1.4.9.45 with gcc-7.2.0

Issue created by migration from https://trac.sagemath.org/ticket/24599

Original creator: rws

Original creation time: 2018-01-28 07:15:11

gcc-7.2.0 is currently distributed with Sage. Complete log is attached.

```
[giac-1.4.9.45] modpoly.cc: In function 'std::complex<double> giac::horner_newton(const vecteur&, const std::complex<double>&, const giac::context*)':
[giac-1.4.9.45] modpoly.cc:5035:19: internal compiler error: Aborted
[giac-1.4.9.45]    complex<double> horner_newton(const vecteur & p,const std::complex<double> &x,GIAC_CONTEXT){
[giac-1.4.9.45]                    ^~~~~~~~~~~~~
[giac-1.4.9.45] 0xafbc6f crash_signal
[giac-1.4.9.45] 	../../src/gcc/toplev.c:337
[giac-1.4.9.45] 0x7f3e0cfeedd3 mpfr_assert_fail
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/mpfr-gmp.c:305
[giac-1.4.9.45] 0x7f3e0cfe59c1 mpfr_init2
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/init2.c:52
[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div_zero
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:31
[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:257
[giac-1.4.9.45] 0x77b6b9 do_mpc_arg2(tree_node*, tree_node*, tree_node*, int, int (*)(__mpc_struct*, __mpc_struct const*, __mpc_struct const*, int))
[giac-1.4.9.45] 	../../src/gcc/builtins.c:10179
[giac-1.4.9.45] 0x8afa0a const_binop
[giac-1.4.9.45] 	../../src/gcc/fold-const.c:1316
[giac-1.4.9.45] 0x8b0c5e const_binop(tree_code, tree_node*, tree_node*, tree_node*)
[giac-1.4.9.45] 	../../src/gcc/fold-const.c:1565
[giac-1.4.9.45] 0xdb4962 gimple_resimplify2(gimple**, code_helper*, tree_node*, tree_node**, tree_node* (*)(tree_node*))
[giac-1.4.9.45] 	../../src/gcc/gimple-match-head.c:132
[giac-1.4.9.45] 0xe384b0 gimple_simplify(gimple*, code_helper*, tree_node**, gimple**, tree_node* (*)(tree_node*), tree_node* (*)(tree_node*))
[giac-1.4.9.45] 	../../src/gcc/gimple-match-head.c:642
[giac-1.4.9.45] 0x8e4306 fold_stmt_1
[giac-1.4.9.45] 	../../src/gcc/gimple-fold.c:4362
[giac-1.4.9.45] 0xbdb5ff execute
[giac-1.4.9.45] 	../../src/gcc/tree-ssa-forwprop.c:2391
[giac-1.4.9.45] Please submit a full bug report,
```



---

Attachment

Because gcc links to mpfr/mpc and there is a change of soname from mpfr (so.4 to so.6) gcc needs to be rebuilt. Currently mpfr is only a built order dependency because there wasn't  a change in soname for a long time it was fine. But it looks like this need to be changed.


---

Comment by rws created at 2018-01-28 07:58:11

OTOH, mpfr depends on gcc so gcc cannot depend on mpfr. If gcc really uses mpfr as it looks like then I think mpfr needs to be compiled before gcc, i.e. using the system gcc.


---

Comment by fbissey created at 2018-01-28 08:04:46

mpfr doesn't depend on gcc

```
cat build/pkgs/mpfr/dependencies 
$(MP_LIBRARY)

----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```

but gcc does depend on mpfr - but only build order dependency, that is gcc is not rebuilt after an mpfr upgrade (which is fine as long as the soname doesn't change either)

```
cat build/pkgs/gcc/dependencies 
| $(MP_LIBRARY) mpfr mpc zlib xz
----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```

Same thing for `MP_LIBRARY`, `mpc` and `zlib` really. `xz` is only needed to unpack the tarball.


---

Comment by rws created at 2018-01-28 08:09:10

Well, I can only say that just now mpfr was rebuilt after I reinstalled gcc and said `make` so there is some dependency.


---

Comment by fbissey created at 2018-01-28 08:16:58

Ha! That's because of the way the gcc spkg - and the sage toolchain is set up. The gcc spkg ends with this

```
# Force re-installation of gmp, mpir, mpfr and mpc with the GCC we just built.
cd "$SAGE_SPKG_INST"
rm -f gmp-* mpir-* mpfr-* mpc-*

# Force re-configuration: the next time that "make" is run, we don't
# want GCC to be built again, see Trac #19324
touch "$SAGE_ROOT/configure"
```



---

Comment by rws created at 2018-01-28 08:28:51

As to the root cause what I don't understand is that gcc usually builds all its libraries itself, but with mpfr they depend on a shared library. I think that is the problem.


---

Comment by jdemeyer created at 2018-01-29 13:14:52

I don't see an obvious solution...


---

Comment by jdemeyer created at 2018-01-29 14:20:42

The problem is that there is no logic in `configure.ac` to check whether the Sage-installed GCC actually works... we just assume that it does.


---

Comment by jdemeyer created at 2018-01-29 14:47:12

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-01-29 14:47:12

New commits:


---

Comment by git created at 2018-01-29 15:53:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-01-29 19:28:51

Good find on the minimal example. I think this will work so it is positive for me but Ralph should test it - if he can before setting the ticket to positive review.


---

Comment by rws created at 2018-01-30 08:51:08

It seems -O3 is needed for the ICE. What I did:

```
> make distclean
> git checkout 8.2.beta3
> ./sage -f mpfr
> ./sage -f gcc
> git checkout 8.2.beta4
> ./sage -f giac
```

As expected this fails again with the same error. Then I put the snippet into `t.cpp` and did `./local/bin/g++ -c -O3 t.cpp` which also fails.


---

Comment by rws created at 2018-01-30 08:54:57

Then I did `git pull trac u/jdemeyer/ticket/24599` (EDIT: and `make start`) in a branch and gcc was recompiled.


---

Comment by rws created at 2018-01-30 08:54:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-02 12:06:21

Resolution: fixed
