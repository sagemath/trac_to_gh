# Issue 24362: Internal compiler error when compiling giac-1.4.9.45 with gcc-7.2.0

archive/issues_024362.json:
```json
{
    "body": "gcc-7.2.0 is currently distributed with Sage. Complete log is attached.\n\n```\n[giac-1.4.9.45] modpoly.cc: In function 'std::complex<double> giac::horner_newton(const vecteur&, const std::complex<double>&, const giac::context*)':\n[giac-1.4.9.45] modpoly.cc:5035:19: internal compiler error: Aborted\n[giac-1.4.9.45]    complex<double> horner_newton(const vecteur & p,const std::complex<double> &x,GIAC_CONTEXT){\n[giac-1.4.9.45]                    ^~~~~~~~~~~~~\n[giac-1.4.9.45] 0xafbc6f crash_signal\n[giac-1.4.9.45] \t../../src/gcc/toplev.c:337\n[giac-1.4.9.45] 0x7f3e0cfeedd3 mpfr_assert_fail\n[giac-1.4.9.45] \t/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/mpfr-gmp.c:305\n[giac-1.4.9.45] 0x7f3e0cfe59c1 mpfr_init2\n[giac-1.4.9.45] \t/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/init2.c:52\n[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div_zero\n[giac-1.4.9.45] \t/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:31\n[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div\n[giac-1.4.9.45] \t/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:257\n[giac-1.4.9.45] 0x77b6b9 do_mpc_arg2(tree_node*, tree_node*, tree_node*, int, int (*)(__mpc_struct*, __mpc_struct const*, __mpc_struct const*, int))\n[giac-1.4.9.45] \t../../src/gcc/builtins.c:10179\n[giac-1.4.9.45] 0x8afa0a const_binop\n[giac-1.4.9.45] \t../../src/gcc/fold-const.c:1316\n[giac-1.4.9.45] 0x8b0c5e const_binop(tree_code, tree_node*, tree_node*, tree_node*)\n[giac-1.4.9.45] \t../../src/gcc/fold-const.c:1565\n[giac-1.4.9.45] 0xdb4962 gimple_resimplify2(gimple**, code_helper*, tree_node*, tree_node**, tree_node* (*)(tree_node*))\n[giac-1.4.9.45] \t../../src/gcc/gimple-match-head.c:132\n[giac-1.4.9.45] 0xe384b0 gimple_simplify(gimple*, code_helper*, tree_node**, gimple**, tree_node* (*)(tree_node*), tree_node* (*)(tree_node*))\n[giac-1.4.9.45] \t../../src/gcc/gimple-match-head.c:642\n[giac-1.4.9.45] 0x8e4306 fold_stmt_1\n[giac-1.4.9.45] \t../../src/gcc/gimple-fold.c:4362\n[giac-1.4.9.45] 0xbdb5ff execute\n[giac-1.4.9.45] \t../../src/gcc/tree-ssa-forwprop.c:2391\n[giac-1.4.9.45] Please submit a full bug report,\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24599\n\n",
    "created_at": "2018-01-28T07:15:11Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Internal compiler error when compiling giac-1.4.9.45 with gcc-7.2.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24362",
    "user": "https://github.com/rwst"
}
```
gcc-7.2.0 is currently distributed with Sage. Complete log is attached.

```
[giac-1.4.9.45] modpoly.cc: In function 'std::complex<double> giac::horner_newton(const vecteur&, const std::complex<double>&, const giac::context*)':
[giac-1.4.9.45] modpoly.cc:5035:19: internal compiler error: Aborted
[giac-1.4.9.45]    complex<double> horner_newton(const vecteur & p,const std::complex<double> &x,GIAC_CONTEXT){
[giac-1.4.9.45]                    ^~~~~~~~~~~~~
[giac-1.4.9.45] 0xafbc6f crash_signal
[giac-1.4.9.45] 	../../src/gcc/toplev.c:337
[giac-1.4.9.45] 0x7f3e0cfeedd3 mpfr_assert_fail
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/mpfr-gmp.c:305
[giac-1.4.9.45] 0x7f3e0cfe59c1 mpfr_init2
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpfr-3.1.5.p0/src/src/init2.c:52
[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div_zero
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:31
[giac-1.4.9.45] 0x7f3e0d21b472 mpc_div
[giac-1.4.9.45] 	/home/ralf/sage/local/var/tmp/sage/build/mpc-1.1.0/src/src/div.c:257
[giac-1.4.9.45] 0x77b6b9 do_mpc_arg2(tree_node*, tree_node*, tree_node*, int, int (*)(__mpc_struct*, __mpc_struct const*, __mpc_struct const*, int))
[giac-1.4.9.45] 	../../src/gcc/builtins.c:10179
[giac-1.4.9.45] 0x8afa0a const_binop
[giac-1.4.9.45] 	../../src/gcc/fold-const.c:1316
[giac-1.4.9.45] 0x8b0c5e const_binop(tree_code, tree_node*, tree_node*, tree_node*)
[giac-1.4.9.45] 	../../src/gcc/fold-const.c:1565
[giac-1.4.9.45] 0xdb4962 gimple_resimplify2(gimple**, code_helper*, tree_node*, tree_node**, tree_node* (*)(tree_node*))
[giac-1.4.9.45] 	../../src/gcc/gimple-match-head.c:132
[giac-1.4.9.45] 0xe384b0 gimple_simplify(gimple*, code_helper*, tree_node**, gimple**, tree_node* (*)(tree_node*), tree_node* (*)(tree_node*))
[giac-1.4.9.45] 	../../src/gcc/gimple-match-head.c:642
[giac-1.4.9.45] 0x8e4306 fold_stmt_1
[giac-1.4.9.45] 	../../src/gcc/gimple-fold.c:4362
[giac-1.4.9.45] 0xbdb5ff execute
[giac-1.4.9.45] 	../../src/gcc/tree-ssa-forwprop.c:2391
[giac-1.4.9.45] Please submit a full bug report,
```


Issue created by migration from https://trac.sagemath.org/ticket/24599





---

archive/issue_comments_340968.json:
```json
{
    "body": "Attachment [giac-1.4.9.45.log](tarball://root/attachments/some-uuid/ticket24599/giac-1.4.9.45.log) by @kiwifb created at 2018-01-28 07:25:14\n\nBecause gcc links to mpfr/mpc and there is a change of soname from mpfr (so.4 to so.6) gcc needs to be rebuilt. Currently mpfr is only a built order dependency because there wasn't  a change in soname for a long time it was fine. But it looks like this need to be changed.",
    "created_at": "2018-01-28T07:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340968",
    "user": "https://github.com/kiwifb"
}
```

Attachment [giac-1.4.9.45.log](tarball://root/attachments/some-uuid/ticket24599/giac-1.4.9.45.log) by @kiwifb created at 2018-01-28 07:25:14

Because gcc links to mpfr/mpc and there is a change of soname from mpfr (so.4 to so.6) gcc needs to be rebuilt. Currently mpfr is only a built order dependency because there wasn't  a change in soname for a long time it was fine. But it looks like this need to be changed.



---

archive/issue_comments_340969.json:
```json
{
    "body": "OTOH, mpfr depends on gcc so gcc cannot depend on mpfr. If gcc really uses mpfr as it looks like then I think mpfr needs to be compiled before gcc, i.e. using the system gcc.",
    "created_at": "2018-01-28T07:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340969",
    "user": "https://github.com/rwst"
}
```

OTOH, mpfr depends on gcc so gcc cannot depend on mpfr. If gcc really uses mpfr as it looks like then I think mpfr needs to be compiled before gcc, i.e. using the system gcc.



---

archive/issue_comments_340970.json:
```json
{
    "body": "mpfr doesn't depend on gcc\n\n```\ncat build/pkgs/mpfr/dependencies \n$(MP_LIBRARY)\n\n----------\nAll lines of this file are ignored except the first.\nIt is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.\n```\n\nbut gcc does depend on mpfr - but only build order dependency, that is gcc is not rebuilt after an mpfr upgrade (which is fine as long as the soname doesn't change either)\n\n```\ncat build/pkgs/gcc/dependencies \n| $(MP_LIBRARY) mpfr mpc zlib xz\n----------\nAll lines of this file are ignored except the first.\nIt is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.\n```\n\nSame thing for `MP_LIBRARY`, `mpc` and `zlib` really. `xz` is only needed to unpack the tarball.",
    "created_at": "2018-01-28T08:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340970",
    "user": "https://github.com/kiwifb"
}
```

mpfr doesn't depend on gcc

```
cat build/pkgs/mpfr/dependencies 
$(MP_LIBRARY)

----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```

but gcc does depend on mpfr - but only build order dependency, that is gcc is not rebuilt after an mpfr upgrade (which is fine as long as the soname doesn't change either)

```
cat build/pkgs/gcc/dependencies 
| $(MP_LIBRARY) mpfr mpc zlib xz
----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```

Same thing for `MP_LIBRARY`, `mpc` and `zlib` really. `xz` is only needed to unpack the tarball.



---

archive/issue_comments_340971.json:
```json
{
    "body": "Well, I can only say that just now mpfr was rebuilt after I reinstalled gcc and said `make` so there is some dependency.",
    "created_at": "2018-01-28T08:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340971",
    "user": "https://github.com/rwst"
}
```

Well, I can only say that just now mpfr was rebuilt after I reinstalled gcc and said `make` so there is some dependency.



---

archive/issue_comments_340972.json:
```json
{
    "body": "Ha! That's because of the way the gcc spkg - and the sage toolchain is set up. The gcc spkg ends with this\n\n```\n# Force re-installation of gmp, mpir, mpfr and mpc with the GCC we just built.\ncd \"$SAGE_SPKG_INST\"\nrm -f gmp-* mpir-* mpfr-* mpc-*\n\n# Force re-configuration: the next time that \"make\" is run, we don't\n# want GCC to be built again, see Trac #19324\ntouch \"$SAGE_ROOT/configure\"\n```\n",
    "created_at": "2018-01-28T08:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340972",
    "user": "https://github.com/kiwifb"
}
```

Ha! That's because of the way the gcc spkg - and the sage toolchain is set up. The gcc spkg ends with this

```
# Force re-installation of gmp, mpir, mpfr and mpc with the GCC we just built.
cd "$SAGE_SPKG_INST"
rm -f gmp-* mpir-* mpfr-* mpc-*

# Force re-configuration: the next time that "make" is run, we don't
# want GCC to be built again, see Trac #19324
touch "$SAGE_ROOT/configure"
```




---

archive/issue_comments_340973.json:
```json
{
    "body": "As to the root cause what I don't understand is that gcc usually builds all its libraries itself, but with mpfr they depend on a shared library. I think that is the problem.",
    "created_at": "2018-01-28T08:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340973",
    "user": "https://github.com/rwst"
}
```

As to the root cause what I don't understand is that gcc usually builds all its libraries itself, but with mpfr they depend on a shared library. I think that is the problem.



---

archive/issue_comments_340974.json:
```json
{
    "body": "I don't see an obvious solution...",
    "created_at": "2018-01-29T13:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340974",
    "user": "https://github.com/jdemeyer"
}
```

I don't see an obvious solution...



---

archive/issue_comments_340975.json:
```json
{
    "body": "The problem is that there is no logic in `configure.ac` to check whether the Sage-installed GCC actually works... we just assume that it does.",
    "created_at": "2018-01-29T14:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340975",
    "user": "https://github.com/jdemeyer"
}
```

The problem is that there is no logic in `configure.ac` to check whether the Sage-installed GCC actually works... we just assume that it does.



---

archive/issue_comments_340976.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-29T14:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340976",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340977.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-01-29T14:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340977",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_340978.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-29T15:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340979.json:
```json
{
    "body": "Good find on the minimal example. I think this will work so it is positive for me but Ralph should test it - if he can before setting the ticket to positive review.",
    "created_at": "2018-01-29T19:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340979",
    "user": "https://github.com/kiwifb"
}
```

Good find on the minimal example. I think this will work so it is positive for me but Ralph should test it - if he can before setting the ticket to positive review.



---

archive/issue_comments_340980.json:
```json
{
    "body": "It seems -O3 is needed for the ICE. What I did:\n\n```\n> make distclean\n> git checkout 8.2.beta3\n> ./sage -f mpfr\n> ./sage -f gcc\n> git checkout 8.2.beta4\n> ./sage -f giac\n```\n\nAs expected this fails again with the same error. Then I put the snippet into `t.cpp` and did `./local/bin/g++ -c -O3 t.cpp` which also fails.",
    "created_at": "2018-01-30T08:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340980",
    "user": "https://github.com/rwst"
}
```

It seems -O3 is needed for the ICE. What I did:

```
> make distclean
> git checkout 8.2.beta3
> ./sage -f mpfr
> ./sage -f gcc
> git checkout 8.2.beta4
> ./sage -f giac
```

As expected this fails again with the same error. Then I put the snippet into `t.cpp` and did `./local/bin/g++ -c -O3 t.cpp` which also fails.



---

archive/issue_comments_340981.json:
```json
{
    "body": "Then I did `git pull trac u/jdemeyer/ticket/24599` (EDIT: and `make start`) in a branch and gcc was recompiled.",
    "created_at": "2018-01-30T08:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340981",
    "user": "https://github.com/rwst"
}
```

Then I did `git pull trac u/jdemeyer/ticket/24599` (EDIT: and `make start`) in a branch and gcc was recompiled.



---

archive/issue_comments_340982.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-30T08:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340982",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340983.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-02T12:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24362",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24362#issuecomment-340983",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
