# Issue 17333: ToricRationalDivisorClass: Integer/Rational mixed up

archive/issues_017333.json:
```json
{
    "body": "CC:  @vbraun @novoselt\n\nIn `src/sage/schemes/toric/divisor.py`, there is:\n\n```\nclass ToricRationalDivisorClassGroup_basis_lattice(FreeModule_ambient_pid):\n    def __init__(self, group):\n        # ...\n        super(ToricRationalDivisorClassGroup_basis_lattice, self).__init__(\n            ZZ, group.dimension())\n```\n\n(note the `ZZ`)\n\nHowever, in `src/sage/schemes/toric/divisor_class.pyx`, there is\n\n```\ncdef class ToricRationalDivisorClass(Vector_rational_dense):\n```\n\n\nSo, do we want rationals or integers? This causes segfaults when improving vectors in #17562.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17570\n\n",
    "created_at": "2014-12-30T14:38:49Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "ToricRationalDivisorClass: Integer/Rational mixed up",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17333",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @vbraun @novoselt

In `src/sage/schemes/toric/divisor.py`, there is:

```
class ToricRationalDivisorClassGroup_basis_lattice(FreeModule_ambient_pid):
    def __init__(self, group):
        # ...
        super(ToricRationalDivisorClassGroup_basis_lattice, self).__init__(
            ZZ, group.dimension())
```

(note the `ZZ`)

However, in `src/sage/schemes/toric/divisor_class.pyx`, there is

```
cdef class ToricRationalDivisorClass(Vector_rational_dense):
```


So, do we want rationals or integers? This causes segfaults when improving vectors in #17562.

Issue created by migration from https://trac.sagemath.org/ticket/17570





---

archive/issue_comments_230605.json:
```json
{
    "body": "It should be `QQ` (the \"rational\" part). I vaguely remember that this caused some problem with the old modules. If you can change it then please do.",
    "created_at": "2014-12-30T17:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230605",
    "user": "https://github.com/vbraun"
}
```

It should be `QQ` (the "rational" part). I vaguely remember that this caused some problem with the old modules. If you can change it then please do.



---

archive/issue_comments_230606.json:
```json
{
    "body": "The problem is when you're constructing a `Cone` using this as lattice (the `Kaehler_cone` or `Mori_cone`), it complains since it wants integer lattices.",
    "created_at": "2014-12-30T17:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230606",
    "user": "https://github.com/jdemeyer"
}
```

The problem is when you're constructing a `Cone` using this as lattice (the `Kaehler_cone` or `Mori_cone`), it complains since it wants integer lattices.



---

archive/issue_comments_230607.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230607",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_230608.json:
```json
{
    "body": "This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.\n----\nNew commits:",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230608",
    "user": "https://github.com/jdemeyer"
}
```

This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.
----
New commits:



---

archive/issue_comments_230609.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-12-31T05:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230609",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_230610.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.\n\nIt is most definitely not the right thing to do in the cone module - a lattice is a free module over integers and not rationals! (On the other hand there is nothing wrong with a vector over rationals related to a cone defined over integers.) I can try to figure out what is the right thing to do here, but not this minute.",
    "created_at": "2014-12-31T05:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230610",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:4 jdemeyer]:
> This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.

It is most definitely not the right thing to do in the cone module - a lattice is a free module over integers and not rationals! (On the other hand there is nothing wrong with a vector over rationals related to a cone defined over integers.) I can try to figure out what is the right thing to do here, but not this minute.



---

archive/issue_comments_230611.json:
```json
{
    "body": "So, what you really want is a free `ZZ`-module generated by vectors which might have coefficients in `QQ`, is that right?\n\nThat's actually legal:\n\n```\nsage: M = (ZZ^2).span([(1,1/3),(0,1/2)])\nsage: M\nFree module of degree 2 and rank 2 over Integer Ring\nEchelon basis matrix:\n[  1 1/3]\n[  0 1/2]\nsage: M.base_ring()\nInteger Ring\nsage: type(M.basis()[0])\n<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>\n```\n\n\nSo the problem might be solvable by deriving from\n\n```\nsage: type(M)\n<class 'sage.modules.free_module.FreeModule_submodule_pid_with_category'>\n```\n\ninstead of `FreeModule_generic_pid`.",
    "created_at": "2014-12-31T09:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230611",
    "user": "https://github.com/jdemeyer"
}
```

So, what you really want is a free `ZZ`-module generated by vectors which might have coefficients in `QQ`, is that right?

That's actually legal:

```
sage: M = (ZZ^2).span([(1,1/3),(0,1/2)])
sage: M
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[  1 1/3]
[  0 1/2]
sage: M.base_ring()
Integer Ring
sage: type(M.basis()[0])
<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>
```


So the problem might be solvable by deriving from

```
sage: type(M)
<class 'sage.modules.free_module.FreeModule_submodule_pid_with_category'>
```

instead of `FreeModule_generic_pid`.



---

archive/issue_comments_230612.json:
```json
{
    "body": "I'm wondering if we should introduce a new method `coefficient_ring` or something on the *element* class which would return `QQ` in this case.",
    "created_at": "2014-12-31T09:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230612",
    "user": "https://github.com/jdemeyer"
}
```

I'm wondering if we should introduce a new method `coefficient_ring` or something on the *element* class which would return `QQ` in this case.



---

archive/issue_comments_230613.json:
```json
{
    "body": "The more I'm thinking about this, the more I'm thinking that this is not a bug.",
    "created_at": "2014-12-31T10:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230613",
    "user": "https://github.com/jdemeyer"
}
```

The more I'm thinking about this, the more I'm thinking that this is not a bug.



---

archive/issue_comments_230614.json:
```json
{
    "body": "This is really a whole can of worms and this toric stuff is just the only place where it is exposed by doctests.\n\nA lot of code in free modules assumes that the `base_ring()` of the parent (i.e. the free module) is the same ring as the ring of coefficients of the elements.",
    "created_at": "2014-12-31T10:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230614",
    "user": "https://github.com/jdemeyer"
}
```

This is really a whole can of worms and this toric stuff is just the only place where it is exposed by doctests.

A lot of code in free modules assumes that the `base_ring()` of the parent (i.e. the free module) is the same ring as the ring of coefficients of the elements.



---

archive/issue_comments_230615.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-01-02T10:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230615",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_230616.json:
```json
{
    "body": "This is not a bug, see [https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g](https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g)",
    "created_at": "2015-01-02T10:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230616",
    "user": "https://github.com/jdemeyer"
}
```

This is not a bug, see [https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g](https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g)



---

archive/issue_events_016722.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2015-01-13T01:21:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17333#event-16722"
}
```



---

archive/issue_comments_230617.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2015-01-13T01:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17333",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17333#issuecomment-230617",
    "user": "https://github.com/vbraun"
}
```

Resolution: worksforme
