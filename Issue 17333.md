# Issue 17333: ToricRationalDivisorClass: Integer/Rational mixed up

Issue created by migration from https://trac.sagemath.org/ticket/17570

Original creator: jdemeyer

Original creation time: 2014-12-30 14:38:49

CC:  vbraun novoselt

In `src/sage/schemes/toric/divisor.py`, there is:

```
class ToricRationalDivisorClassGroup_basis_lattice(FreeModule_ambient_pid):
    def __init__(self, group):
        # ...
        super(ToricRationalDivisorClassGroup_basis_lattice, self).__init__(
            ZZ, group.dimension())
```

(note the `ZZ`)

However, in `src/sage/schemes/toric/divisor_class.pyx`, there is

```
cdef class ToricRationalDivisorClass(Vector_rational_dense):
```


So, do we want rationals or integers? This causes segfaults when improving vectors in #17562.


---

Comment by vbraun created at 2014-12-30 17:17:38

It should be `QQ` (the "rational" part). I vaguely remember that this caused some problem with the old modules. If you can change it then please do.


---

Comment by jdemeyer created at 2014-12-30 17:23:32

The problem is when you're constructing a `Cone` using this as lattice (the `Kaehler_cone` or `Mori_cone`), it complains since it wants integer lattices.


---

Comment by jdemeyer created at 2014-12-30 20:12:32

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-12-30 20:12:32

This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does _The Right Thing_.
----
New commits:


---

Comment by novoselt created at 2014-12-31 05:37:30

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2014-12-31 05:37:30

Replying to [comment:4 jdemeyer]:
> This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does _The Right Thing_.

It is most definitely not the right thing to do in the cone module - a lattice is a free module over integers and not rationals! (On the other hand there is nothing wrong with a vector over rationals related to a cone defined over integers.) I can try to figure out what is the right thing to do here, but not this minute.


---

Comment by jdemeyer created at 2014-12-31 09:34:07

So, what you really want is a free `ZZ`-module generated by vectors which might have coefficients in `QQ`, is that right?

That's actually legal:

```
sage: M = (ZZ^2).span([(1,1/3),(0,1/2)])
sage: M
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[  1 1/3]
[  0 1/2]
sage: M.base_ring()
Integer Ring
sage: type(M.basis()[0])
<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>
```


So the problem might be solvable by deriving from

```
sage: type(M)
<class 'sage.modules.free_module.FreeModule_submodule_pid_with_category'>
```

instead of `FreeModule_generic_pid`.


---

Comment by jdemeyer created at 2014-12-31 09:40:55

I'm wondering if we should introduce a new method `coefficient_ring` or something on the _element_ class which would return `QQ` in this case.


---

Comment by jdemeyer created at 2014-12-31 10:02:06

The more I'm thinking about this, the more I'm thinking that this is not a bug.


---

Comment by jdemeyer created at 2014-12-31 10:12:23

This is really a whole can of worms and this toric stuff is just the only place where it is exposed by doctests.

A lot of code in free modules assumes that the `base_ring()` of the parent (i.e. the free module) is the same ring as the ring of coefficients of the elements.


---

Comment by jdemeyer created at 2015-01-02 10:37:12

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-01-02 10:39:22

This is not a bug, see [https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g](https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g)


---

Comment by vbraun created at 2015-01-13 01:21:03

Resolution: worksforme
