# Issue 24772: move prime_pi as a standalone function

Issue created by migration from https://trac.sagemath.org/ticket/25009

Original creator: vdelecroix

Original creation time: 2018-03-18 21:53:10

CC:  mkoeppe mmarco isuruf

The `prime_pi` function is currently a symbolic function that can holds its argument as in

```
sage: n = SR.var('n')
sage: prime_pi(n)
prime_pi(n)
```

that also contains the Cython code for evaluating it

```
sage: prime_pi(13543)
1603
```

We move the evaluation part as a standalone function in `arith/` and provide alternative implementations
 - using `PARI/GP` (only efficient in the range of tabulated primes)
 - using primecount that is packaged in #24966


---

Comment by vdelecroix created at 2018-03-19 09:14:32

New commits:


---

Comment by mkoeppe created at 2021-07-06 01:09:59

The package `primecount` has been provided with Sage since version 8.3, has been updated several times and is already outdated https://repology.org/project/primecount/versions

Is it time to start using it?

Because `sage.libs.primecount` uses an optional library, in the modularization of sagelib it would have to be split out to a separate package. But since `src/sage/libs/primecount.pxd` and `src/sage/interfaces/primecount.pyx` do not depend on Sage at all (except for a use of `sage.misc.superseded`), it would be best to make it a standalone Python library, like you did with `pplpy`.


---

Comment by dimpase created at 2021-11-12 22:39:06

`prime_pi` is slow, quite buggy (see #24960), and should be ditched in favour of calling `primecount`.


---

Comment by dimpase created at 2021-11-15 11:32:16

bump to 7.1, and standard, remove deprecations
----
New commits:


---

Comment by dimpase created at 2021-11-15 11:33:11

this is a start for fixing #24960


---

Comment by dimpase created at 2021-11-16 11:10:08

I am not sure whether there is much value in the branch `u/vdelecroix/25009-draft`, 
as functions mentioned there are no longer in `primecount.hpp`, they are in `primecount-internal.hpp`, cf. https://github.com/kimwalisch/primecount

That is, they are not for public consumption. Let us use this ticket to update and promote the package to standard.


---

Comment by dimpase created at 2021-11-16 11:10:08

Changing status from new to needs_review.


---

Comment by git created at 2021-11-16 13:56:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-16 17:59:03

Changes from optional to standard require a vote on sage-devel


---

Comment by dimpase created at 2021-11-16 18:05:23

It fixes a serious bug, I can't imagine any objections. Feel free to call the vote, though.


---

Comment by mkoeppe created at 2021-11-16 18:12:00

The new version also needs portability testing


---

Comment by dimpase created at 2021-11-17 14:01:09

for what it's worth, it works on a 32-bit Ubuntu 18.04


---

Comment by git created at 2021-11-17 14:26:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-17 14:27:05

do we want to handle conversion to an external package here, or on a follow-up?


---

Comment by dimpase created at 2021-11-17 16:51:37

Replying to [comment:18 dimpase]:
> do we want to handle conversion to an external package here, or on a follow-up?

I think it's not totally trivial, as this would need `setup.py` code for calling cmake to build the C++ library (yuck).


---

Comment by mkoeppe created at 2021-11-17 17:01:29

No, the new Python package would not need to build the primecount library.
Just like pplpy - which also does not build the ppl library.


---

Comment by dimpase created at 2021-11-17 17:15:26

Replying to [comment:20 mkoeppe]:
> No, the new Python package would not need to build the primecount library.
> Just like pplpy - which also does not build the ppl library.

reading https://gitlab.com/videlec/pplpy/-/blob/master/setup.py does not make me wiser, and anyway it's not a good example, as we're building it as a part of sagelib, anyway.

As primecount isn't always available as a system library, there should be some need for configuring paths, etc. 

That all that can be done in 10 minutes is, hmm, a joke.


---

Comment by mkoeppe created at 2021-11-17 17:18:15

Replying to [comment:21 dimpase]:
> As primecount isn't always available as a system library, there should be some need for configuring paths

No, just assume that it's available and fail otherwise.


---

Comment by dimpase created at 2021-11-17 19:48:48

I've spent 180 minutes fighting idiotic Cython errors, in an attempt to make a stand-alone package. Something like

```
primecount/primecount.pyx:66:6: Function signature does not match previous declaration
warning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'
```

It's above my paygrade to create Cython setups, sorry. Put it on another ticket.
The Cython docs are a joke.


---

Comment by dimpase created at 2021-11-17 20:16:00

You may try https://github.com/dimpase/primecount at ./sage --buildsh prompt - that's as far as I got

```
$ python3 setup.py build_ext --inplace
running build_ext
Compiling primecount/primecount.pyx because it changed.
[1/1] Cythonizing primecount/primecount.pyx
warning: primecount/primecount.pyx:66:6: Function 'nth_prime' previously declared as 'cpdef'

Error compiling Cython file:
------------------------------------------------------------
...
    sig_on()
    ans = primecount.pi(s)
    sig_off()
    return PyInt_FromString(ans, NULL, 10)

cpdef int64_t nth_prime(int64_t n) except -1:
     ^
------------------------------------------------------------

primecount/primecount.pyx:66:6: Function signature does not match previous declaration
warning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'

Error compiling Cython file:
------------------------------------------------------------
...
    if _do_sig(n): sig_on()
    ans = primecount.nth_prime(n)
    if _do_sig(n): sig_off()
    return ans

cpdef int64_t phi(int64_t x, int64_t a):
     ^
------------------------------------------------------------

primecount/primecount.pyx:86:6: Function signature does not match previous declaration
Traceback (most recent call last):
  File "/home/dimpase/work/primecount/setup.py", line 28, in <module>
    setup(
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/__init__.py", line 153, in setup
    return distutils.core.setup(**attrs)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/core.py", line 148, in setup
    dist.run_commands()
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py", line 967, in run_commands
    self.run_command(cmd)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py", line 986, in run_command
    cmd_obj.run()
  File "/home/dimpase/work/primecount/setup.py", line 9, in run
    self.distribution.ext_modules[:] = cythonize(
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py", line 1102, in cythonize
    cythonize_one(*args)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py", line 1225, in cythonize_one
    raise CompileError(None, pyx_file)
Cython.Compiler.Errors.CompileError: primecount/primecount.pyx
(sage-buildsh) dimpase@penguin:primecount$ 
```



---

Comment by dimpase created at 2021-11-17 22:36:52

I've made it build, but the module doesn't have importable functions, for some reason.


---

Comment by dimpase created at 2021-11-18 10:54:36

The followup in on #32894 - and needs Cython experts attention. It's far from trivial. 

Let's meanwhile get this ticket in.


---

Comment by dimpase created at 2021-11-22 08:44:12

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-11-22 08:44:12

OK, we actaully should spin off the library primesieve (https://repology.org/project/primesieve/versions) - which is a dependency here, and (by default primecount vendors it, but has an option not to).

Many distros package primesieve separately, so in particular for using system packages it makes perfect sense. (Perhaps primesieve has potentially independent uses in Sage).


---

Comment by git created at 2021-11-22 14:50:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-22 23:33:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-23 10:34:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-23 14:19:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-11-23 14:22:03

Replying to [comment:13 mkoeppe]:
> Changes from optional to standard require a vote on sage-devel
> 
see https://groups.google.com/g/sage-devel/c/tl_fxCJEh1Y/m/y1R2O7RVBgAJ


---

Comment by dimpase created at 2021-11-23 14:25:17

the patch build/pkgs/primecount/patches/sieve_version.patch is proposed to upstream, see
https://github.com/kimwalisch/primecount/pull/47


---

Comment by dimpase created at 2021-11-23 17:11:48

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-11-23 17:11:48

Matthias, what is

```
# sage_setup: distribution = sagemath-primecount
}}} 
in the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?
(I'm testing on Fedora 34, where primecount/sieve come from the system, if it matters)


---

Comment by dimpase created at 2021-11-23 17:13:21

If it's there then the file in question is ignored by `make build`.
Is it something for optional packages, and so should be removed?


---

Comment by git created at 2021-11-23 17:29:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-23 17:54:51

The changes to `setup.cfg.m4` and `pyproject.toml.m4` make no sense. These files are for declaring dependencies on Python packages

In the `dependencies` files, `cmake` should be an order-only dependency


---

Comment by mkoeppe created at 2021-11-23 17:57:17

In the `dependencies` of sagelib, it's probably not necessary to repeat `primesieve`


---

Comment by mkoeppe created at 2021-11-23 17:58:43

`sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it


---

Comment by mkoeppe created at 2021-11-23 18:02:10

Replying to [comment:34 dimpase]:
> Matthias, what is
> {{{
> # sage_setup: distribution = sagemath-primecount
> }}} 
> in the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?

The sagelib build system removes this file when `primecount` is not present.
See https://github.com/sagemath/sage/blob/develop/pkgs/sagemath-standard/setup.py#L76


---

Comment by mkoeppe created at 2021-11-23 18:03:28

And this mechanism does not know anything about system packages.

As this ticket is making `primecount` a standard package, removing the `sage_setup: distribution` annotation is OK.


---

Comment by dimpase created at 2021-11-23 18:15:12

Replying to [comment:39 mkoeppe]:
> `sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it

```
$ git grep CMAKE_INSTALL_PREFIX 
build/bin/sage-dist-helpers:#    GNUInstallDirs module) so that `CMAKE_INSTALL_PREFIX` and
build/bin/sage-dist-helpers:    cmake . -DCMAKE_INSTALL_PREFIX="${SAGE_INST_LOCAL}" \
build/pkgs/primecount/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
build/pkgs/primesieve/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
build/pkgs/scipoptsuite/patches/0003-use-INSTALL_NAME_DIR-fix-for-libscip.patch:+    INSTALL_NAME_DIR "${CMAKE_INSTALL_PREFIX}/lib"
build/pkgs/scipoptsuite/spkg-install.in:cmake .. -DCMAKE_INSTALL_PREFIX="${SAGE_LOCAL}"/ -DCMAKE_VERBOSE_MAKEFILE=ON -DGMP_DIR="${SAGE_LOCAL}" -DZLIB_ROOT="${SAGE_LOCAL}" -DReadline_ROOT_DIR="${SAGE_LOCAL}" -DBLISS_DIR="${SAGE_LOCAL}" -DIPOPT=FALSE
build/pkgs/symengine/spkg-install.in:cmake -DCMAKE_INSTALL_PREFIX="$SAGE_LOCAL" \
src/doc/en/developer/packaging.rst:   that ``CMAKE_INSTALL_PREFIX`` and ``CMAKE_INSTALL_LIBDIR`` are set
```


so few other packages do this too - `symengine`, `scipoptsuite`


---

Comment by mkoeppe created at 2021-11-23 18:18:02

That can be cleaned up on this ticket as well, I think


---

Comment by git created at 2021-11-23 18:26:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-23 18:39:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-23 18:43:27

testing revealed  a packaging bug in Debian - they don't install cmake configs for primesieve, and so primecount (to be built) can't find it. :-( 
Has reported this...

We can instead cook up something, perhaps patch CMakeList of primecount more,
make it rely on pkg-config instead? I don't know (recognising that this is broken without
actually running cmake is no fun...)


---

Comment by mkoeppe created at 2021-11-23 18:46:43

Perhaps unvendoring `primesieve` is not strictly necessary for this ticket?


---

Comment by mkoeppe created at 2021-11-23 18:47:54

... it does not seem to be a very important use case to cater to users on systems that have primesieve but not primecount...


---

Comment by dimpase created at 2021-11-23 19:01:06

well, I don't mind banning broken system primesieves, but I don't know a sane way to test this. E.g. `cmake --find_package` should do the job, but e.g. on Fedora

```
$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=link
CMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):
  FindThreads only works if either C or CXX language is enabled
Call Stack (most recent call first):
  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)
  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)
  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)


primesieve not found.
CMake Error: Run 'cmake --help' for all supported options.
clpc171[/home/scratch2/dimpase/sage/sage-clang]$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=LINK
CMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):
  FindThreads only works if either C or CXX language is enabled
Call Stack (most recent call first):
  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)
  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)
  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)


primesieve not found.
CMake Error: Run 'cmake --help' for all supported options.
```



---

Comment by dimpase created at 2021-11-23 19:30:10

How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?


---

Comment by dimpase created at 2021-11-23 20:14:12

Debian fixed it in the latest unstable.


---

Comment by dimpase created at 2021-11-24 00:34:06

We actually have a catch-22 situation - we cannot reliably configure standard packages with `cmake`, as we don't guarantee its presence at the moment.

So cmake must be promoted to a hard pre-requisite.

I don't mind this, though...


---

Comment by mkoeppe created at 2021-11-24 00:37:36

When there's no system `cmake`, it makes no sense to look for system libraries' `cmake` information.


---

Comment by dimpase created at 2021-11-24 00:44:06

but you can't configure/build a standard package which relies on `cmake` if there is no `cmake` on the system.

While autotools can generate a configure script to be shipped, cmake only generated makefiles, not good enough for shipping.


---

Comment by dimpase created at 2021-11-24 00:48:51

we need to treat cmake spkg as we treat patch spkg.

I'd rather just get rid of patch as well, and make it a pre-req, too, though.


---

Comment by mkoeppe created at 2021-11-24 00:50:12

Why do you think that we need `cmake` earlier than at the time of building packages?


---

Comment by dimpase created at 2021-11-24 00:54:07

Replying to [comment:58 mkoeppe]:
> Why do you think that we need `cmake` earlier than at the time of building packages?

ah, right, I was actually using cmake in an spkg-configure.m4, but then decided it's too much trouble. But it's stuck in my mind that something fishy. Sorry for noise.


---

Comment by mkoeppe created at 2021-11-24 00:57:30

Replying to [comment:59 dimpase]:
> using cmake in an spkg-configure.m4

This was what I was referring to in comment:55. If there's no system cmake but finding a library has to depend on that library's installed cmake information, then the `spkg-configure.m4` should just fail.


---

Comment by dimpase created at 2021-11-24 00:59:21

Replying to [comment:51 dimpase]:
> How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?

OK, here I need a shell programming advice. The problem I don't know how to solve is that cmake triggers an exit if it fails, so it teminates spkg-install script in case of failure. But I just want to know the result, and try something different if it fails.

I hoped something like this would work:

```
primc_config() {
echo "Configuring primecount: building primesieve $1"
sdh_cmake -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DBUILD_STATIC_LIBS=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_LIBPRIMESIEVE=$1 \
          -DCMAKE_FIND_ROOT_PATH=$SAGE_LOCAL/lib/cmake \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH \
          -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
          ${EXTRA_OPTS} && echo OKOKOK && sdh_make_install
}

set -e
primc_config OFF || primc_config ON
```


but no, if the 1st call to primc_config fails in cmake, it just terminates the script.


---

Comment by mkoeppe created at 2021-11-24 01:09:07

use a sub-shell: `(exit 1) || echo survived`


---

Comment by git created at 2021-11-24 09:30:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-24 09:31:16

Replying to [comment:62 mkoeppe]:
> use a sub-shell: `(exit 1) || echo survived`

OK, great, thanks. This helps.

Now ready for review.


---

Comment by dimpase created at 2021-11-24 09:32:54

Time to ping more upstreams to package primecount and primesieve.
Debian people are already busy with it.


---

Comment by mkoeppe created at 2021-11-24 17:58:29

Needs portability testing


---

Comment by dimpase created at 2021-11-24 18:44:22

Replying to [comment:66 mkoeppe]:
> Needs portability testing
running here: https://github.com/sagemath/sagetrac-mirror/actions/runs/1500740315


---

Comment by dimpase created at 2021-11-25 11:56:13

some tests are failing due to #32828


---

Comment by mkoeppe created at 2021-11-26 21:08:57

On `fedora-30-standard` (https://github.com/sagemath/sagetrac-mirror/runs/4316021585?check_suite_focus=true): 
`Error: Unable to find a match: primecount primecount-devel`.

This means that you'll have to set `IGNORE_MISSING_SYSTEM_PACKAGES=yes` for `fedora-30` in `tox.ini`.


---

Comment by mkoeppe created at 2021-11-26 21:08:57

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-11-26 22:27:03

well, accoding to https://fedoraproject.org/wiki/End_of_life already 31 and 32 are past EOL. How many past-EOL releases should we go? OK, one or two, but three...


---

Comment by mkoeppe created at 2021-11-26 22:29:13

We are supporting this version, and it is not within the scope of this ticket to break it.


---

Comment by git created at 2021-11-26 23:46:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-26 23:47:57

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-28 19:32:46

`primesieve` does not build on some of our still supported platforms. I have a patch (https://github.com/kimwalisch/primesieve/pull/107) for fixing most of them, but upstream does not want it. With the patch, there is one remaining failing platform, `debian-jessie` (https://github.com/kimwalisch/primesieve/issues/108), upstream indicates wontfix.


---

Comment by dimpase created at 2021-11-28 19:49:59

time to drop gcc 4-based systems...


---

Comment by dimpase created at 2021-11-28 20:25:44

Please feel free to add patches.


---

Comment by mkoeppe created at 2021-11-28 20:33:59

Replying to [comment:75 dimpase]:
> time to drop gcc 4-based systems...
Yes, soon, I'd say.
It would just feel a bit excessive to do so just for a single function.

I'll see if the failure on `debian-jessie` is as easy to fix as the other failures were. If not, we can drop `debian-jessie` in 9.5 already, it seems to have a particularly messy compiler.
----
New commits:


---

Comment by dimpase created at 2021-11-29 11:44:32

IMHO the patch for `std:align` should go into `gcc` spkg, not here.
Test if it's there, if not, put it into `std` namespace, instead of patching around all the C++ code
affected by it.

While strictly speaking putting new functions into namespace `std` is undefined behaviour, with gcc is just works (IMHO).


---

Comment by mkoeppe created at 2021-11-29 17:43:07

`primesieve` is the only the package that needs it. 

And patching the system compiler sounds like a terrible idea.


---

Comment by dimpase created at 2021-11-29 19:14:04

the compiler is OK in this case, it's STL that it's not.

If I recall correctly, that's how we patched STLs for CGAL back in 1999:

All you need to to is to put `-I foo/bar/` into CXXFLAGS, and put into `foo/bar` a file named `memory`, where one puts `#include <memory>` and an implementation of `align()` inside `namespace std {...}` block.


---

Comment by mkoeppe created at 2021-11-29 19:57:30

Sure, that's another way to do this, but I don't think it's better than what's already done and tested


---

Comment by dimpase created at 2021-11-29 20:19:46

OK, I've just rebased the branch of #32894 over the branch here, and will do a run on GH Actions there.
It will test this ticket along the way, too.


---

Comment by dimpase created at 2021-11-29 20:23:49

tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1517758345 (with primecountpy)


---

Comment by mkoeppe created at 2021-12-02 18:54:48

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2021-12-02 19:24:51

Can you add `primecount` to `distros/conda.txt`?


---

Comment by dimpase created at 2021-12-02 20:42:56

Replying to [comment:88 isuruf]:
> Can you add `primecount` to `distros/conda.txt`?
done on #32894 (to minimize rebasing :))


---

Comment by vbraun created at 2021-12-12 15:09:01

Resolution: fixed
