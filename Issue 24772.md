# Issue 24772: move prime_pi as a standalone function

archive/issues_024772.json:
```json
{
    "body": "CC:  mkoeppe mmarco isuruf\n\nThe `prime_pi` function is currently a symbolic function that can holds its argument as in\n\n```\nsage: n = SR.var('n')\nsage: prime_pi(n)\nprime_pi(n)\n```\n\nthat also contains the Cython code for evaluating it\n\n```\nsage: prime_pi(13543)\n1603\n```\n\nWe move the evaluation part as a standalone function in `arith/` and provide alternative implementations\n- using `PARI/GP` (only efficient in the range of tabulated primes)\n- using primecount that is packaged in #24966\n\nIssue created by migration from https://trac.sagemath.org/ticket/25009\n\n",
    "created_at": "2018-03-18T21:53:10Z",
    "labels": [
        "basic arithmetic",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "move prime_pi as a standalone function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24772",
    "user": "vdelecroix"
}
```
CC:  mkoeppe mmarco isuruf

The `prime_pi` function is currently a symbolic function that can holds its argument as in

```
sage: n = SR.var('n')
sage: prime_pi(n)
prime_pi(n)
```

that also contains the Cython code for evaluating it

```
sage: prime_pi(13543)
1603
```

We move the evaluation part as a standalone function in `arith/` and provide alternative implementations
- using `PARI/GP` (only efficient in the range of tabulated primes)
- using primecount that is packaged in #24966

Issue created by migration from https://trac.sagemath.org/ticket/25009





---

archive/issue_comments_347704.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-19T09:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347704",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_347705.json:
```json
{
    "body": "The package `primecount` has been provided with Sage since version 8.3, has been updated several times and is already outdated https://repology.org/project/primecount/versions\n\nIs it time to start using it?\n\nBecause `sage.libs.primecount` uses an optional library, in the modularization of sagelib it would have to be split out to a separate package. But since `src/sage/libs/primecount.pxd` and `src/sage/interfaces/primecount.pyx` do not depend on Sage at all (except for a use of `sage.misc.superseded`), it would be best to make it a standalone Python library, like you did with `pplpy`.",
    "created_at": "2021-07-06T01:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347705",
    "user": "mkoeppe"
}
```

The package `primecount` has been provided with Sage since version 8.3, has been updated several times and is already outdated https://repology.org/project/primecount/versions

Is it time to start using it?

Because `sage.libs.primecount` uses an optional library, in the modularization of sagelib it would have to be split out to a separate package. But since `src/sage/libs/primecount.pxd` and `src/sage/interfaces/primecount.pyx` do not depend on Sage at all (except for a use of `sage.misc.superseded`), it would be best to make it a standalone Python library, like you did with `pplpy`.



---

archive/issue_comments_347706.json:
```json
{
    "body": "`prime_pi` is slow, quite buggy (see #24960), and should be ditched in favour of calling `primecount`.",
    "created_at": "2021-11-12T22:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347706",
    "user": "dimpase"
}
```

`prime_pi` is slow, quite buggy (see #24960), and should be ditched in favour of calling `primecount`.



---

archive/issue_comments_347707.json:
```json
{
    "body": "bump to 7.1, and standard, remove deprecations\n----\nNew commits:",
    "created_at": "2021-11-15T11:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347707",
    "user": "dimpase"
}
```

bump to 7.1, and standard, remove deprecations
----
New commits:



---

archive/issue_comments_347708.json:
```json
{
    "body": "this is a start for fixing #24960",
    "created_at": "2021-11-15T11:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347708",
    "user": "dimpase"
}
```

this is a start for fixing #24960



---

archive/issue_comments_347709.json:
```json
{
    "body": "I am not sure whether there is much value in the branch `u/vdelecroix/25009-draft`, \nas functions mentioned there are no longer in `primecount.hpp`, they are in `primecount-internal.hpp`, cf. https://github.com/kimwalisch/primecount\n\nThat is, they are not for public consumption. Let us use this ticket to update and promote the package to standard.",
    "created_at": "2021-11-16T11:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347709",
    "user": "dimpase"
}
```

I am not sure whether there is much value in the branch `u/vdelecroix/25009-draft`, 
as functions mentioned there are no longer in `primecount.hpp`, they are in `primecount-internal.hpp`, cf. https://github.com/kimwalisch/primecount

That is, they are not for public consumption. Let us use this ticket to update and promote the package to standard.



---

archive/issue_comments_347710.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-16T11:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347710",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_347711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-16T13:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347711",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347712.json:
```json
{
    "body": "Changes from optional to standard require a vote on sage-devel",
    "created_at": "2021-11-16T17:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347712",
    "user": "mkoeppe"
}
```

Changes from optional to standard require a vote on sage-devel



---

archive/issue_comments_347713.json:
```json
{
    "body": "It fixes a serious bug, I can't imagine any objections. Feel free to call the vote, though.",
    "created_at": "2021-11-16T18:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347713",
    "user": "dimpase"
}
```

It fixes a serious bug, I can't imagine any objections. Feel free to call the vote, though.



---

archive/issue_comments_347714.json:
```json
{
    "body": "The new version also needs portability testing",
    "created_at": "2021-11-16T18:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347714",
    "user": "mkoeppe"
}
```

The new version also needs portability testing



---

archive/issue_comments_347715.json:
```json
{
    "body": "for what it's worth, it works on a 32-bit Ubuntu 18.04",
    "created_at": "2021-11-17T14:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347715",
    "user": "dimpase"
}
```

for what it's worth, it works on a 32-bit Ubuntu 18.04



---

archive/issue_comments_347716.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-17T14:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347716",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347717.json:
```json
{
    "body": "do we want to handle conversion to an external package here, or on a follow-up?",
    "created_at": "2021-11-17T14:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347717",
    "user": "dimpase"
}
```

do we want to handle conversion to an external package here, or on a follow-up?



---

archive/issue_comments_347718.json:
```json
{
    "body": "Replying to [comment:18 dimpase]:\n> do we want to handle conversion to an external package here, or on a follow-up?\n\nI think it's not totally trivial, as this would need `setup.py` code for calling cmake to build the C++ library (yuck).",
    "created_at": "2021-11-17T16:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347718",
    "user": "dimpase"
}
```

Replying to [comment:18 dimpase]:
> do we want to handle conversion to an external package here, or on a follow-up?

I think it's not totally trivial, as this would need `setup.py` code for calling cmake to build the C++ library (yuck).



---

archive/issue_comments_347719.json:
```json
{
    "body": "No, the new Python package would not need to build the primecount library.\nJust like pplpy - which also does not build the ppl library.",
    "created_at": "2021-11-17T17:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347719",
    "user": "mkoeppe"
}
```

No, the new Python package would not need to build the primecount library.
Just like pplpy - which also does not build the ppl library.



---

archive/issue_comments_347720.json:
```json
{
    "body": "Replying to [comment:20 mkoeppe]:\n> No, the new Python package would not need to build the primecount library.\n> Just like pplpy - which also does not build the ppl library.\n\nreading https://gitlab.com/videlec/pplpy/-/blob/master/setup.py does not make me wiser, and anyway it's not a good example, as we're building it as a part of sagelib, anyway.\n\nAs primecount isn't always available as a system library, there should be some need for configuring paths, etc. \n\nThat all that can be done in 10 minutes is, hmm, a joke.",
    "created_at": "2021-11-17T17:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347720",
    "user": "dimpase"
}
```

Replying to [comment:20 mkoeppe]:
> No, the new Python package would not need to build the primecount library.
> Just like pplpy - which also does not build the ppl library.

reading https://gitlab.com/videlec/pplpy/-/blob/master/setup.py does not make me wiser, and anyway it's not a good example, as we're building it as a part of sagelib, anyway.

As primecount isn't always available as a system library, there should be some need for configuring paths, etc. 

That all that can be done in 10 minutes is, hmm, a joke.



---

archive/issue_comments_347721.json:
```json
{
    "body": "Replying to [comment:21 dimpase]:\n> As primecount isn't always available as a system library, there should be some need for configuring paths\n\nNo, just assume that it's available and fail otherwise.",
    "created_at": "2021-11-17T17:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347721",
    "user": "mkoeppe"
}
```

Replying to [comment:21 dimpase]:
> As primecount isn't always available as a system library, there should be some need for configuring paths

No, just assume that it's available and fail otherwise.



---

archive/issue_comments_347722.json:
```json
{
    "body": "I've spent 180 minutes fighting idiotic Cython errors, in an attempt to make a stand-alone package. Something like\n\n```\nprimecount/primecount.pyx:66:6: Function signature does not match previous declaration\nwarning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'\n```\n\nIt's above my paygrade to create Cython setups, sorry. Put it on another ticket.\nThe Cython docs are a joke.",
    "created_at": "2021-11-17T19:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347722",
    "user": "dimpase"
}
```

I've spent 180 minutes fighting idiotic Cython errors, in an attempt to make a stand-alone package. Something like

```
primecount/primecount.pyx:66:6: Function signature does not match previous declaration
warning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'
```

It's above my paygrade to create Cython setups, sorry. Put it on another ticket.
The Cython docs are a joke.



---

archive/issue_comments_347723.json:
```json
{
    "body": "You may try https://github.com/dimpase/primecount at ./sage --buildsh prompt - that's as far as I got\n\n```\n$ python3 setup.py build_ext --inplace\nrunning build_ext\nCompiling primecount/primecount.pyx because it changed.\n[1/1] Cythonizing primecount/primecount.pyx\nwarning: primecount/primecount.pyx:66:6: Function 'nth_prime' previously declared as 'cpdef'\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n    sig_on()\n    ans = primecount.pi(s)\n    sig_off()\n    return PyInt_FromString(ans, NULL, 10)\n\ncpdef int64_t nth_prime(int64_t n) except -1:\n     ^\n------------------------------------------------------------\n\nprimecount/primecount.pyx:66:6: Function signature does not match previous declaration\nwarning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n    if _do_sig(n): sig_on()\n    ans = primecount.nth_prime(n)\n    if _do_sig(n): sig_off()\n    return ans\n\ncpdef int64_t phi(int64_t x, int64_t a):\n     ^\n------------------------------------------------------------\n\nprimecount/primecount.pyx:86:6: Function signature does not match previous declaration\nTraceback (most recent call last):\n  File \"/home/dimpase/work/primecount/setup.py\", line 28, in <module>\n    setup(\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/__init__.py\", line 153, in setup\n    return distutils.core.setup(**attrs)\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/core.py\", line 148, in setup\n    dist.run_commands()\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py\", line 967, in run_commands\n    self.run_command(cmd)\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py\", line 986, in run_command\n    cmd_obj.run()\n  File \"/home/dimpase/work/primecount/setup.py\", line 9, in run\n    self.distribution.ext_modules[:] = cythonize(\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py\", line 1102, in cythonize\n    cythonize_one(*args)\n  File \"/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py\", line 1225, in cythonize_one\n    raise CompileError(None, pyx_file)\nCython.Compiler.Errors.CompileError: primecount/primecount.pyx\n(sage-buildsh) dimpase@penguin:primecount$ \n```\n",
    "created_at": "2021-11-17T20:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347723",
    "user": "dimpase"
}
```

You may try https://github.com/dimpase/primecount at ./sage --buildsh prompt - that's as far as I got

```
$ python3 setup.py build_ext --inplace
running build_ext
Compiling primecount/primecount.pyx because it changed.
[1/1] Cythonizing primecount/primecount.pyx
warning: primecount/primecount.pyx:66:6: Function 'nth_prime' previously declared as 'cpdef'

Error compiling Cython file:
------------------------------------------------------------
...
    sig_on()
    ans = primecount.pi(s)
    sig_off()
    return PyInt_FromString(ans, NULL, 10)

cpdef int64_t nth_prime(int64_t n) except -1:
     ^
------------------------------------------------------------

primecount/primecount.pyx:66:6: Function signature does not match previous declaration
warning: primecount/primecount.pyx:86:6: Function 'phi' previously declared as 'cpdef'

Error compiling Cython file:
------------------------------------------------------------
...
    if _do_sig(n): sig_on()
    ans = primecount.nth_prime(n)
    if _do_sig(n): sig_off()
    return ans

cpdef int64_t phi(int64_t x, int64_t a):
     ^
------------------------------------------------------------

primecount/primecount.pyx:86:6: Function signature does not match previous declaration
Traceback (most recent call last):
  File "/home/dimpase/work/primecount/setup.py", line 28, in <module>
    setup(
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/__init__.py", line 153, in setup
    return distutils.core.setup(**attrs)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/core.py", line 148, in setup
    dist.run_commands()
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py", line 967, in run_commands
    self.run_command(cmd)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/setuptools/_distutils/dist.py", line 986, in run_command
    cmd_obj.run()
  File "/home/dimpase/work/primecount/setup.py", line 9, in run
    self.distribution.ext_modules[:] = cythonize(
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py", line 1102, in cythonize
    cythonize_one(*args)
  File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/Cython/Build/Dependencies.py", line 1225, in cythonize_one
    raise CompileError(None, pyx_file)
Cython.Compiler.Errors.CompileError: primecount/primecount.pyx
(sage-buildsh) dimpase@penguin:primecount$ 
```




---

archive/issue_comments_347724.json:
```json
{
    "body": "I've made it build, but the module doesn't have importable functions, for some reason.",
    "created_at": "2021-11-17T22:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347724",
    "user": "dimpase"
}
```

I've made it build, but the module doesn't have importable functions, for some reason.



---

archive/issue_comments_347725.json:
```json
{
    "body": "The followup in on #32894 - and needs Cython experts attention. It's far from trivial. \n\nLet's meanwhile get this ticket in.",
    "created_at": "2021-11-18T10:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347725",
    "user": "dimpase"
}
```

The followup in on #32894 - and needs Cython experts attention. It's far from trivial. 

Let's meanwhile get this ticket in.



---

archive/issue_comments_347726.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-22T08:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347726",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347727.json:
```json
{
    "body": "OK, we actaully should spin off the library primesieve (https://repology.org/project/primesieve/versions) - which is a dependency here, and (by default primecount vendors it, but has an option not to).\n\nMany distros package primesieve separately, so in particular for using system packages it makes perfect sense. (Perhaps primesieve has potentially independent uses in Sage).",
    "created_at": "2021-11-22T08:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347727",
    "user": "dimpase"
}
```

OK, we actaully should spin off the library primesieve (https://repology.org/project/primesieve/versions) - which is a dependency here, and (by default primecount vendors it, but has an option not to).

Many distros package primesieve separately, so in particular for using system packages it makes perfect sense. (Perhaps primesieve has potentially independent uses in Sage).



---

archive/issue_comments_347728.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-22T14:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347728",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347729.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-22T23:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347729",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347730.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-23T10:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347730",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347731.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-23T14:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347731",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347732.json:
```json
{
    "body": "Replying to [comment:13 mkoeppe]:\n> Changes from optional to standard require a vote on sage-devel\n> \nsee https://groups.google.com/g/sage-devel/c/tl_fxCJEh1Y/m/y1R2O7RVBgAJ",
    "created_at": "2021-11-23T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347732",
    "user": "dimpase"
}
```

Replying to [comment:13 mkoeppe]:
> Changes from optional to standard require a vote on sage-devel
> 
see https://groups.google.com/g/sage-devel/c/tl_fxCJEh1Y/m/y1R2O7RVBgAJ



---

archive/issue_comments_347733.json:
```json
{
    "body": "the patch build/pkgs/primecount/patches/sieve_version.patch is proposed to upstream, see\nhttps://github.com/kimwalisch/primecount/pull/47",
    "created_at": "2021-11-23T14:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347733",
    "user": "dimpase"
}
```

the patch build/pkgs/primecount/patches/sieve_version.patch is proposed to upstream, see
https://github.com/kimwalisch/primecount/pull/47



---

archive/issue_comments_347734.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-23T17:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347734",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347735.json:
```json
{
    "body": "Matthias, what is\n\n```\n# sage_setup: distribution = sagemath-primecount\n```\n \nin the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?\n(I'm testing on Fedora 34, where primecount/sieve come from the system, if it matters)",
    "created_at": "2021-11-23T17:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347735",
    "user": "dimpase"
}
```

Matthias, what is

```
# sage_setup: distribution = sagemath-primecount
```
 
in the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?
(I'm testing on Fedora 34, where primecount/sieve come from the system, if it matters)



---

archive/issue_comments_347736.json:
```json
{
    "body": "If it's there then the file in question is ignored by `make build`.\nIs it something for optional packages, and so should be removed?",
    "created_at": "2021-11-23T17:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347736",
    "user": "dimpase"
}
```

If it's there then the file in question is ignored by `make build`.
Is it something for optional packages, and so should be removed?



---

archive/issue_comments_347737.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-23T17:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347737",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347738.json:
```json
{
    "body": "The changes to `setup.cfg.m4` and `pyproject.toml.m4` make no sense. These files are for declaring dependencies on Python packages\n\nIn the `dependencies` files, `cmake` should be an order-only dependency",
    "created_at": "2021-11-23T17:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347738",
    "user": "mkoeppe"
}
```

The changes to `setup.cfg.m4` and `pyproject.toml.m4` make no sense. These files are for declaring dependencies on Python packages

In the `dependencies` files, `cmake` should be an order-only dependency



---

archive/issue_comments_347739.json:
```json
{
    "body": "In the `dependencies` of sagelib, it's probably not necessary to repeat `primesieve`",
    "created_at": "2021-11-23T17:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347739",
    "user": "mkoeppe"
}
```

In the `dependencies` of sagelib, it's probably not necessary to repeat `primesieve`



---

archive/issue_comments_347740.json:
```json
{
    "body": "`sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it",
    "created_at": "2021-11-23T17:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347740",
    "user": "mkoeppe"
}
```

`sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it



---

archive/issue_comments_347741.json:
```json
{
    "body": "Replying to [comment:34 dimpase]:\n> Matthias, what is\n> {{{\n> # sage_setup: distribution = sagemath-primecount\n> }}} \n> in the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?\n\nThe sagelib build system removes this file when `primecount` is not present.\nSee https://github.com/sagemath/sage/blob/develop/pkgs/sagemath-standard/setup.py#L76",
    "created_at": "2021-11-23T18:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347741",
    "user": "mkoeppe"
}
```

Replying to [comment:34 dimpase]:
> Matthias, what is
> {{{
> # sage_setup: distribution = sagemath-primecount
> }}} 
> in the first line of `src/sage/interfaces/primecount.pyx`, and why I have to remove it in order for this branch to work?

The sagelib build system removes this file when `primecount` is not present.
See https://github.com/sagemath/sage/blob/develop/pkgs/sagemath-standard/setup.py#L76



---

archive/issue_comments_347742.json:
```json
{
    "body": "And this mechanism does not know anything about system packages.\n\nAs this ticket is making `primecount` a standard package, removing the `sage_setup: distribution` annotation is OK.",
    "created_at": "2021-11-23T18:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347742",
    "user": "mkoeppe"
}
```

And this mechanism does not know anything about system packages.

As this ticket is making `primecount` a standard package, removing the `sage_setup: distribution` annotation is OK.



---

archive/issue_comments_347743.json:
```json
{
    "body": "Replying to [comment:39 mkoeppe]:\n> `sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it\n\n```\n$ git grep CMAKE_INSTALL_PREFIX \nbuild/bin/sage-dist-helpers:#    GNUInstallDirs module) so that `CMAKE_INSTALL_PREFIX` and\nbuild/bin/sage-dist-helpers:    cmake . -DCMAKE_INSTALL_PREFIX=\"${SAGE_INST_LOCAL}\" \\\nbuild/pkgs/primecount/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \\\nbuild/pkgs/primesieve/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \\\nbuild/pkgs/scipoptsuite/patches/0003-use-INSTALL_NAME_DIR-fix-for-libscip.patch:+    INSTALL_NAME_DIR \"${CMAKE_INSTALL_PREFIX}/lib\"\nbuild/pkgs/scipoptsuite/spkg-install.in:cmake .. -DCMAKE_INSTALL_PREFIX=\"${SAGE_LOCAL}\"/ -DCMAKE_VERBOSE_MAKEFILE=ON -DGMP_DIR=\"${SAGE_LOCAL}\" -DZLIB_ROOT=\"${SAGE_LOCAL}\" -DReadline_ROOT_DIR=\"${SAGE_LOCAL}\" -DBLISS_DIR=\"${SAGE_LOCAL}\" -DIPOPT=FALSE\nbuild/pkgs/symengine/spkg-install.in:cmake -DCMAKE_INSTALL_PREFIX=\"$SAGE_LOCAL\" \\\nsrc/doc/en/developer/packaging.rst:   that ``CMAKE_INSTALL_PREFIX`` and ``CMAKE_INSTALL_LIBDIR`` are set\n```\n\n\nso few other packages do this too - `symengine`, `scipoptsuite`",
    "created_at": "2021-11-23T18:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347743",
    "user": "dimpase"
}
```

Replying to [comment:39 mkoeppe]:
> `sdh_cmake` already sets `CMAKE_INSTALL_PREFIX`, no need to repeat it

```
$ git grep CMAKE_INSTALL_PREFIX 
build/bin/sage-dist-helpers:#    GNUInstallDirs module) so that `CMAKE_INSTALL_PREFIX` and
build/bin/sage-dist-helpers:    cmake . -DCMAKE_INSTALL_PREFIX="${SAGE_INST_LOCAL}" \
build/pkgs/primecount/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
build/pkgs/primesieve/spkg-install.in:    -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
build/pkgs/scipoptsuite/patches/0003-use-INSTALL_NAME_DIR-fix-for-libscip.patch:+    INSTALL_NAME_DIR "${CMAKE_INSTALL_PREFIX}/lib"
build/pkgs/scipoptsuite/spkg-install.in:cmake .. -DCMAKE_INSTALL_PREFIX="${SAGE_LOCAL}"/ -DCMAKE_VERBOSE_MAKEFILE=ON -DGMP_DIR="${SAGE_LOCAL}" -DZLIB_ROOT="${SAGE_LOCAL}" -DReadline_ROOT_DIR="${SAGE_LOCAL}" -DBLISS_DIR="${SAGE_LOCAL}" -DIPOPT=FALSE
build/pkgs/symengine/spkg-install.in:cmake -DCMAKE_INSTALL_PREFIX="$SAGE_LOCAL" \
src/doc/en/developer/packaging.rst:   that ``CMAKE_INSTALL_PREFIX`` and ``CMAKE_INSTALL_LIBDIR`` are set
```


so few other packages do this too - `symengine`, `scipoptsuite`



---

archive/issue_comments_347744.json:
```json
{
    "body": "That can be cleaned up on this ticket as well, I think",
    "created_at": "2021-11-23T18:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347744",
    "user": "mkoeppe"
}
```

That can be cleaned up on this ticket as well, I think



---

archive/issue_comments_347745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-23T18:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347745",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-23T18:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347746",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347747.json:
```json
{
    "body": "testing revealed  a packaging bug in Debian - they don't install cmake configs for primesieve, and so primecount (to be built) can't find it. :-( \nHas reported this...\n\nWe can instead cook up something, perhaps patch CMakeList of primecount more,\nmake it rely on pkg-config instead? I don't know (recognising that this is broken without\nactually running cmake is no fun...)",
    "created_at": "2021-11-23T18:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347747",
    "user": "dimpase"
}
```

testing revealed  a packaging bug in Debian - they don't install cmake configs for primesieve, and so primecount (to be built) can't find it. :-( 
Has reported this...

We can instead cook up something, perhaps patch CMakeList of primecount more,
make it rely on pkg-config instead? I don't know (recognising that this is broken without
actually running cmake is no fun...)



---

archive/issue_comments_347748.json:
```json
{
    "body": "Perhaps unvendoring `primesieve` is not strictly necessary for this ticket?",
    "created_at": "2021-11-23T18:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347748",
    "user": "mkoeppe"
}
```

Perhaps unvendoring `primesieve` is not strictly necessary for this ticket?



---

archive/issue_comments_347749.json:
```json
{
    "body": "... it does not seem to be a very important use case to cater to users on systems that have primesieve but not primecount...",
    "created_at": "2021-11-23T18:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347749",
    "user": "mkoeppe"
}
```

... it does not seem to be a very important use case to cater to users on systems that have primesieve but not primecount...



---

archive/issue_comments_347750.json:
```json
{
    "body": "well, I don't mind banning broken system primesieves, but I don't know a sane way to test this. E.g. `cmake --find_package` should do the job, but e.g. on Fedora\n\n```\n$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=link\nCMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):\n  FindThreads only works if either C or CXX language is enabled\nCall Stack (most recent call first):\n  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)\n  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)\n  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)\n\n\nprimesieve not found.\nCMake Error: Run 'cmake --help' for all supported options.\nclpc171[/home/scratch2/dimpase/sage/sage-clang]$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=LINK\nCMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):\n  FindThreads only works if either C or CXX language is enabled\nCall Stack (most recent call first):\n  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)\n  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)\n  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)\n\n\nprimesieve not found.\nCMake Error: Run 'cmake --help' for all supported options.\n```\n",
    "created_at": "2021-11-23T19:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347750",
    "user": "dimpase"
}
```

well, I don't mind banning broken system primesieves, but I don't know a sane way to test this. E.g. `cmake --find_package` should do the job, but e.g. on Fedora

```
$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=link
CMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):
  FindThreads only works if either C or CXX language is enabled
Call Stack (most recent call first):
  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)
  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)
  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)


primesieve not found.
CMake Error: Run 'cmake --help' for all supported options.
clpc171[/home/scratch2/dimpase/sage/sage-clang]$ cmake --find-package -DNAME=primesieve -DCOMPILER_ID=GNU -DLANGUAGE=C -DMODE=LINK
CMake Error at /usr/share/cmake/Modules/FindThreads.cmake:66 (message):
  FindThreads only works if either C or CXX language is enabled
Call Stack (most recent call first):
  /usr/share/cmake/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)
  /usr/lib64/cmake/primesieve/primesieveConfig.cmake:18 (find_dependency)
  /usr/share/cmake/Modules/CMakeFindPackageMode.cmake:183 (find_package)


primesieve not found.
CMake Error: Run 'cmake --help' for all supported options.
```




---

archive/issue_comments_347751.json:
```json
{
    "body": "How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?",
    "created_at": "2021-11-23T19:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347751",
    "user": "dimpase"
}
```

How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?



---

archive/issue_comments_347752.json:
```json
{
    "body": "Debian fixed it in the latest unstable.",
    "created_at": "2021-11-23T20:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347752",
    "user": "dimpase"
}
```

Debian fixed it in the latest unstable.



---

archive/issue_comments_347753.json:
```json
{
    "body": "We actually have a catch-22 situation - we cannot reliably configure standard packages with `cmake`, as we don't guarantee its presence at the moment.\n\nSo cmake must be promoted to a hard pre-requisite.\n\nI don't mind this, though...",
    "created_at": "2021-11-24T00:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347753",
    "user": "dimpase"
}
```

We actually have a catch-22 situation - we cannot reliably configure standard packages with `cmake`, as we don't guarantee its presence at the moment.

So cmake must be promoted to a hard pre-requisite.

I don't mind this, though...



---

archive/issue_comments_347754.json:
```json
{
    "body": "When there's no system `cmake`, it makes no sense to look for system libraries' `cmake` information.",
    "created_at": "2021-11-24T00:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347754",
    "user": "mkoeppe"
}
```

When there's no system `cmake`, it makes no sense to look for system libraries' `cmake` information.



---

archive/issue_comments_347755.json:
```json
{
    "body": "but you can't configure/build a standard package which relies on `cmake` if there is no `cmake` on the system.\n\nWhile autotools can generate a configure script to be shipped, cmake only generated makefiles, not good enough for shipping.",
    "created_at": "2021-11-24T00:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347755",
    "user": "dimpase"
}
```

but you can't configure/build a standard package which relies on `cmake` if there is no `cmake` on the system.

While autotools can generate a configure script to be shipped, cmake only generated makefiles, not good enough for shipping.



---

archive/issue_comments_347756.json:
```json
{
    "body": "we need to treat cmake spkg as we treat patch spkg.\n\nI'd rather just get rid of patch as well, and make it a pre-req, too, though.",
    "created_at": "2021-11-24T00:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347756",
    "user": "dimpase"
}
```

we need to treat cmake spkg as we treat patch spkg.

I'd rather just get rid of patch as well, and make it a pre-req, too, though.



---

archive/issue_comments_347757.json:
```json
{
    "body": "Why do you think that we need `cmake` earlier than at the time of building packages?",
    "created_at": "2021-11-24T00:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347757",
    "user": "mkoeppe"
}
```

Why do you think that we need `cmake` earlier than at the time of building packages?



---

archive/issue_comments_347758.json:
```json
{
    "body": "Replying to [comment:58 mkoeppe]:\n> Why do you think that we need `cmake` earlier than at the time of building packages?\n\nah, right, I was actually using cmake in an spkg-configure.m4, but then decided it's too much trouble. But it's stuck in my mind that something fishy. Sorry for noise.",
    "created_at": "2021-11-24T00:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347758",
    "user": "dimpase"
}
```

Replying to [comment:58 mkoeppe]:
> Why do you think that we need `cmake` earlier than at the time of building packages?

ah, right, I was actually using cmake in an spkg-configure.m4, but then decided it's too much trouble. But it's stuck in my mind that something fishy. Sorry for noise.



---

archive/issue_comments_347759.json:
```json
{
    "body": "Replying to [comment:59 dimpase]:\n> using cmake in an spkg-configure.m4\n\nThis was what I was referring to in comment:55. If there's no system cmake but finding a library has to depend on that library's installed cmake information, then the `spkg-configure.m4` should just fail.",
    "created_at": "2021-11-24T00:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347759",
    "user": "mkoeppe"
}
```

Replying to [comment:59 dimpase]:
> using cmake in an spkg-configure.m4

This was what I was referring to in comment:55. If there's no system cmake but finding a library has to depend on that library's installed cmake information, then the `spkg-configure.m4` should just fail.



---

archive/issue_comments_347760.json:
```json
{
    "body": "Replying to [comment:51 dimpase]:\n> How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?\n\nOK, here I need a shell programming advice. The problem I don't know how to solve is that cmake triggers an exit if it fails, so it teminates spkg-install script in case of failure. But I just want to know the result, and try something different if it fails.\n\nI hoped something like this would work:\n\n```\nprimc_config() {\necho \"Configuring primecount: building primesieve $1\"\nsdh_cmake -DCMAKE_VERBOSE_MAKEFILE=ON \\\n          -DBUILD_STATIC_LIBS=OFF \\\n          -DBUILD_SHARED_LIBS=ON \\\n          -DBUILD_TESTS=ON \\\n          -DBUILD_LIBPRIMESIEVE=$1 \\\n          -DCMAKE_FIND_ROOT_PATH=$SAGE_LOCAL/lib/cmake \\\n          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH \\\n          -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \\\n          ${EXTRA_OPTS} && echo OKOKOK && sdh_make_install\n}\n\nset -e\nprimc_config OFF || primc_config ON\n```\n\n\nbut no, if the 1st call to primc_config fails in cmake, it just terminates the script.",
    "created_at": "2021-11-24T00:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347760",
    "user": "dimpase"
}
```

Replying to [comment:51 dimpase]:
> How about, in case of failure of cmake in spkg-install of primecount, just trying running cmake without `-DBUILD_LIBPRIMESIEVE=OFF` - then primesieve will be built ?

OK, here I need a shell programming advice. The problem I don't know how to solve is that cmake triggers an exit if it fails, so it teminates spkg-install script in case of failure. But I just want to know the result, and try something different if it fails.

I hoped something like this would work:

```
primc_config() {
echo "Configuring primecount: building primesieve $1"
sdh_cmake -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DBUILD_STATIC_LIBS=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_LIBPRIMESIEVE=$1 \
          -DCMAKE_FIND_ROOT_PATH=$SAGE_LOCAL/lib/cmake \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH \
          -DCMAKE_INSTALL_PREFIX=$SAGE_LOCAL \
          ${EXTRA_OPTS} && echo OKOKOK && sdh_make_install
}

set -e
primc_config OFF || primc_config ON
```


but no, if the 1st call to primc_config fails in cmake, it just terminates the script.



---

archive/issue_comments_347761.json:
```json
{
    "body": "use a sub-shell: `(exit 1) || echo survived`",
    "created_at": "2021-11-24T01:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347761",
    "user": "mkoeppe"
}
```

use a sub-shell: `(exit 1) || echo survived`



---

archive/issue_comments_347762.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-24T09:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347762",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347763.json:
```json
{
    "body": "Replying to [comment:62 mkoeppe]:\n> use a sub-shell: `(exit 1) || echo survived`\n\nOK, great, thanks. This helps.\n\nNow ready for review.",
    "created_at": "2021-11-24T09:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347763",
    "user": "dimpase"
}
```

Replying to [comment:62 mkoeppe]:
> use a sub-shell: `(exit 1) || echo survived`

OK, great, thanks. This helps.

Now ready for review.



---

archive/issue_comments_347764.json:
```json
{
    "body": "Time to ping more upstreams to package primecount and primesieve.\nDebian people are already busy with it.",
    "created_at": "2021-11-24T09:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347764",
    "user": "dimpase"
}
```

Time to ping more upstreams to package primecount and primesieve.
Debian people are already busy with it.



---

archive/issue_comments_347765.json:
```json
{
    "body": "Needs portability testing",
    "created_at": "2021-11-24T17:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347765",
    "user": "mkoeppe"
}
```

Needs portability testing



---

archive/issue_comments_347766.json:
```json
{
    "body": "Replying to [comment:66 mkoeppe]:\n> Needs portability testing\nrunning here: https://github.com/sagemath/sagetrac-mirror/actions/runs/1500740315",
    "created_at": "2021-11-24T18:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347766",
    "user": "dimpase"
}
```

Replying to [comment:66 mkoeppe]:
> Needs portability testing
running here: https://github.com/sagemath/sagetrac-mirror/actions/runs/1500740315



---

archive/issue_comments_347767.json:
```json
{
    "body": "some tests are failing due to #32828",
    "created_at": "2021-11-25T11:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347767",
    "user": "dimpase"
}
```

some tests are failing due to #32828



---

archive/issue_comments_347768.json:
```json
{
    "body": "On `fedora-30-standard` (https://github.com/sagemath/sagetrac-mirror/runs/4316021585?check_suite_focus=true): \n`Error: Unable to find a match: primecount primecount-devel`.\n\nThis means that you'll have to set `IGNORE_MISSING_SYSTEM_PACKAGES=yes` for `fedora-30` in `tox.ini`.",
    "created_at": "2021-11-26T21:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347768",
    "user": "mkoeppe"
}
```

On `fedora-30-standard` (https://github.com/sagemath/sagetrac-mirror/runs/4316021585?check_suite_focus=true): 
`Error: Unable to find a match: primecount primecount-devel`.

This means that you'll have to set `IGNORE_MISSING_SYSTEM_PACKAGES=yes` for `fedora-30` in `tox.ini`.



---

archive/issue_comments_347769.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-26T21:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347769",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347770.json:
```json
{
    "body": "well, accoding to https://fedoraproject.org/wiki/End_of_life already 31 and 32 are past EOL. How many past-EOL releases should we go? OK, one or two, but three...",
    "created_at": "2021-11-26T22:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347770",
    "user": "dimpase"
}
```

well, accoding to https://fedoraproject.org/wiki/End_of_life already 31 and 32 are past EOL. How many past-EOL releases should we go? OK, one or two, but three...



---

archive/issue_comments_347771.json:
```json
{
    "body": "We are supporting this version, and it is not within the scope of this ticket to break it.",
    "created_at": "2021-11-26T22:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347771",
    "user": "mkoeppe"
}
```

We are supporting this version, and it is not within the scope of this ticket to break it.



---

archive/issue_comments_347772.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-26T23:46:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347772",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347773.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-26T23:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347773",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347774.json:
```json
{
    "body": "`primesieve` does not build on some of our still supported platforms. I have a patch (https://github.com/kimwalisch/primesieve/pull/107) for fixing most of them, but upstream does not want it. With the patch, there is one remaining failing platform, `debian-jessie` (https://github.com/kimwalisch/primesieve/issues/108), upstream indicates wontfix.",
    "created_at": "2021-11-28T19:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347774",
    "user": "mkoeppe"
}
```

`primesieve` does not build on some of our still supported platforms. I have a patch (https://github.com/kimwalisch/primesieve/pull/107) for fixing most of them, but upstream does not want it. With the patch, there is one remaining failing platform, `debian-jessie` (https://github.com/kimwalisch/primesieve/issues/108), upstream indicates wontfix.



---

archive/issue_comments_347775.json:
```json
{
    "body": "time to drop gcc 4-based systems...",
    "created_at": "2021-11-28T19:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347775",
    "user": "dimpase"
}
```

time to drop gcc 4-based systems...



---

archive/issue_comments_347776.json:
```json
{
    "body": "Please feel free to add patches.",
    "created_at": "2021-11-28T20:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347776",
    "user": "dimpase"
}
```

Please feel free to add patches.



---

archive/issue_comments_347777.json:
```json
{
    "body": "Replying to [comment:75 dimpase]:\n> time to drop gcc 4-based systems...\nYes, soon, I'd say.\nIt would just feel a bit excessive to do so just for a single function.\n\nI'll see if the failure on `debian-jessie` is as easy to fix as the other failures were. If not, we can drop `debian-jessie` in 9.5 already, it seems to have a particularly messy compiler.\n----\nNew commits:",
    "created_at": "2021-11-28T20:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347777",
    "user": "mkoeppe"
}
```

Replying to [comment:75 dimpase]:
> time to drop gcc 4-based systems...
Yes, soon, I'd say.
It would just feel a bit excessive to do so just for a single function.

I'll see if the failure on `debian-jessie` is as easy to fix as the other failures were. If not, we can drop `debian-jessie` in 9.5 already, it seems to have a particularly messy compiler.
----
New commits:



---

archive/issue_comments_347778.json:
```json
{
    "body": "IMHO the patch for `std:align` should go into `gcc` spkg, not here.\nTest if it's there, if not, put it into `std` namespace, instead of patching around all the C++ code\naffected by it.\n\nWhile strictly speaking putting new functions into namespace `std` is undefined behaviour, with gcc is just works (IMHO).",
    "created_at": "2021-11-29T11:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347778",
    "user": "dimpase"
}
```

IMHO the patch for `std:align` should go into `gcc` spkg, not here.
Test if it's there, if not, put it into `std` namespace, instead of patching around all the C++ code
affected by it.

While strictly speaking putting new functions into namespace `std` is undefined behaviour, with gcc is just works (IMHO).



---

archive/issue_comments_347779.json:
```json
{
    "body": "`primesieve` is the only the package that needs it. \n\nAnd patching the system compiler sounds like a terrible idea.",
    "created_at": "2021-11-29T17:43:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347779",
    "user": "mkoeppe"
}
```

`primesieve` is the only the package that needs it. 

And patching the system compiler sounds like a terrible idea.



---

archive/issue_comments_347780.json:
```json
{
    "body": "the compiler is OK in this case, it's STL that it's not.\n\nIf I recall correctly, that's how we patched STLs for CGAL back in 1999:\n\nAll you need to to is to put `-I foo/bar/` into CXXFLAGS, and put into `foo/bar` a file named `memory`, where one puts `#include <memory>` and an implementation of `align()` inside `namespace std {...}` block.",
    "created_at": "2021-11-29T19:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347780",
    "user": "dimpase"
}
```

the compiler is OK in this case, it's STL that it's not.

If I recall correctly, that's how we patched STLs for CGAL back in 1999:

All you need to to is to put `-I foo/bar/` into CXXFLAGS, and put into `foo/bar` a file named `memory`, where one puts `#include <memory>` and an implementation of `align()` inside `namespace std {...}` block.



---

archive/issue_comments_347781.json:
```json
{
    "body": "Sure, that's another way to do this, but I don't think it's better than what's already done and tested",
    "created_at": "2021-11-29T19:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347781",
    "user": "mkoeppe"
}
```

Sure, that's another way to do this, but I don't think it's better than what's already done and tested



---

archive/issue_comments_347782.json:
```json
{
    "body": "OK, I've just rebased the branch of #32894 over the branch here, and will do a run on GH Actions there.\nIt will test this ticket along the way, too.",
    "created_at": "2021-11-29T20:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347782",
    "user": "dimpase"
}
```

OK, I've just rebased the branch of #32894 over the branch here, and will do a run on GH Actions there.
It will test this ticket along the way, too.



---

archive/issue_comments_347783.json:
```json
{
    "body": "tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1517758345 (with primecountpy)",
    "created_at": "2021-11-29T20:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347783",
    "user": "dimpase"
}
```

tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1517758345 (with primecountpy)



---

archive/issue_comments_347784.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-02T18:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347784",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_347785.json:
```json
{
    "body": "Can you add `primecount` to `distros/conda.txt`?",
    "created_at": "2021-12-02T19:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347785",
    "user": "isuruf"
}
```

Can you add `primecount` to `distros/conda.txt`?



---

archive/issue_comments_347786.json:
```json
{
    "body": "Replying to [comment:88 isuruf]:\n> Can you add `primecount` to `distros/conda.txt`?\ndone on #32894 (to minimize rebasing :))",
    "created_at": "2021-12-02T20:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347786",
    "user": "dimpase"
}
```

Replying to [comment:88 isuruf]:
> Can you add `primecount` to `distros/conda.txt`?
done on #32894 (to minimize rebasing :))



---

archive/issue_comments_347787.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24772",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24772#issuecomment-347787",
    "user": "vbraun"
}
```

Resolution: fixed
