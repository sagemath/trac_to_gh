# Issue 14674: very slow taylor epansion for composite functions

archive/issues_014674.json:
```json
{
    "body": "Assignee: @burcin\n\nKeywords: taylor expansion, symbolic function\n\nThe following\n\n```\nf=sin(x*sin(x*sin(x*sin(x))))\nf.series(x,8)\n```\n\ntakes something like 30s, which seems a bit too much. Maybe there is some bottleneck somewhere ?\n\nIn the same spirit, one could try\n\n```\nsage: x=PowerSeriesRing(QQ,'x').gen()\nsage: sin(x)\nTraceback (most recent call last):\n...\nTypeError: cannot coerce arguments: no canonical coercion from Power Series Ring in x over Rational Field to Symbolic Ring\n```\n\nIt would be good if one could apply symbolic functions to power series and get power series when possible.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14878\n\n",
    "created_at": "2013-07-11T14:29:48Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "very slow taylor epansion for composite functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14674",
    "user": "https://github.com/fchapoton"
}
```
Assignee: @burcin

Keywords: taylor expansion, symbolic function

The following

```
f=sin(x*sin(x*sin(x*sin(x))))
f.series(x,8)
```

takes something like 30s, which seems a bit too much. Maybe there is some bottleneck somewhere ?

In the same spirit, one could try

```
sage: x=PowerSeriesRing(QQ,'x').gen()
sage: sin(x)
Traceback (most recent call last):
...
TypeError: cannot coerce arguments: no canonical coercion from Power Series Ring in x over Rational Field to Symbolic Ring
```

It would be good if one could apply symbolic functions to power series and get power series when possible.

Issue created by migration from https://trac.sagemath.org/ticket/14878





---

archive/issue_comments_186574.json:
```json
{
    "body": "Being able to apply functions to power series would be useful.\n\nFor anyone looking to implement this, note that flint can now natively evaluate elementary functions over `Q[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` and `(Z/nZ)[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` (using `fmpq_poly_sin_series` in this case).",
    "created_at": "2013-07-11T16:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186574",
    "user": "https://github.com/fredrik-johansson"
}
```

Being able to apply functions to power series would be useful.

For anyone looking to implement this, note that flint can now natively evaluate elementary functions over `Q[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` and `(Z/nZ)[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` (using `fmpq_poly_sin_series` in this case).



---

archive/issue_comments_186575.json:
```json
{
    "body": "some timings:\n\n```\nsage: %timeit f.taylor(x,0,8)\n100 loops, best of 3: 6.46 ms per loop\nsage: %timeit f.series(x,8)\n1 loops, best of 3: 42.1 s per loop\n```\n",
    "created_at": "2013-07-12T07:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186575",
    "user": "https://github.com/fchapoton"
}
```

some timings:

```
sage: %timeit f.taylor(x,0,8)
100 loops, best of 3: 6.46 ms per loop
sage: %timeit f.series(x,8)
1 loops, best of 3: 42.1 s per loop
```




---

archive/issue_comments_186576.json:
```json
{
    "body": "Replying to [ticket:14878 chapoton]:\n> Maybe there is some bottleneck somewhere ?\n\nGiNaC's series expansion code seems to be designed for very small orders only. It is incredibly inefficient otherwise:\n\n\n```\nginsh - GiNaC Interactive Shell (ginac V1.6.2)\n  __,  _______  Copyright (C) 1999-2011 Johannes Gutenberg University Mainz,\n (__) *       | Germany.  This is free software with ABSOLUTELY NO WARRANTY.\n  ._) i N a C | You are welcome to redistribute it under certain conditions.\n<-------------' For details type `warranty;'.\n\nType ?? for a list of help topics.\n> time(series(sin(x*sin(x*sin(x*sin(x)))), x==0, 8));\n2.352s                                                                          \n> time(series(sin(x*sin(x*sin(x*sin(x)))), x==0, 12));                         \n40.104s                                                                         \n```\n\n\nJudging by the number of calls to `gcd`/`lcm` reported by `%prun f.series(x==0, k)` for successive `k`, the number of operations in \u211a seems to grow at least exponentially with `k`, and perhaps like `k!` (while it should be something like `O(k\u00b3)` in a naive implementation, and essentially linear in a careful one).\n\nI think that's the heart of the problem, and the difference between the timings with sage and with ginsh is pynac overhead (which should of course be minimized, but only costs a constant factor).",
    "created_at": "2014-03-05T12:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186576",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [ticket:14878 chapoton]:
> Maybe there is some bottleneck somewhere ?

GiNaC's series expansion code seems to be designed for very small orders only. It is incredibly inefficient otherwise:


```
ginsh - GiNaC Interactive Shell (ginac V1.6.2)
  __,  _______  Copyright (C) 1999-2011 Johannes Gutenberg University Mainz,
 (__) *       | Germany.  This is free software with ABSOLUTELY NO WARRANTY.
  ._) i N a C | You are welcome to redistribute it under certain conditions.
<-------------' For details type `warranty;'.

Type ?? for a list of help topics.
> time(series(sin(x*sin(x*sin(x*sin(x)))), x==0, 8));
2.352s                                                                          
> time(series(sin(x*sin(x*sin(x*sin(x)))), x==0, 12));                         
40.104s                                                                         
```


Judging by the number of calls to `gcd`/`lcm` reported by `%prun f.series(x==0, k)` for successive `k`, the number of operations in ℚ seems to grow at least exponentially with `k`, and perhaps like `k!` (while it should be something like `O(k³)` in a naive implementation, and essentially linear in a careful one).

I think that's the heart of the problem, and the difference between the timings with sage and with ginsh is pynac overhead (which should of course be minimized, but only costs a constant factor).



---

archive/issue_comments_186577.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-10-08T19:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186577",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_186578.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-09T06:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186578",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_186579.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-27T20:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_186580.json:
```json
{
    "body": "branch transfered to #20017",
    "created_at": "2016-02-05T20:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186580",
    "user": "https://github.com/fchapoton"
}
```

branch transfered to #20017



---

archive/issue_comments_186581.json:
```json
{
    "body": "The relevant Pynac ticket is https://github.com/pynac/pynac/issues/116",
    "created_at": "2016-02-15T07:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186581",
    "user": "https://github.com/rwst"
}
```

The relevant Pynac ticket is https://github.com/pynac/pynac/issues/116



---

archive/issue_comments_186582.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-10-20T15:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186582",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_186583.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-20T15:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186583",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_186584.json:
```json
{
    "body": "ok, looks good to me. Thanks for your work. Please add your name as author.",
    "created_at": "2016-11-11T21:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186584",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good to me. Thanks for your work. Please add your name as author.



---

archive/issue_comments_186585.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-11T21:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186585",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186586.json:
```json
{
    "body": "Thanks too.",
    "created_at": "2016-11-12T07:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186586",
    "user": "https://github.com/rwst"
}
```

Thanks too.



---

archive/issue_comments_186587.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-15T23:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14674#issuecomment-186587",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
