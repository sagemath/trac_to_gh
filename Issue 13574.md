# Issue 13574: lazy list

archive/issues_013574.json:
```json
{
    "body": "Assignee: jason\n\nKeywords: list, iterator\n\nLazy list are iterator that behaves like list and implement a cache mechanism.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13778\n\n",
    "created_at": "2012-11-30T05:48:05Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "title": "lazy list",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13574",
    "user": "vdelecroix"
}
```
Assignee: jason

Keywords: list, iterator

Lazy list are iterator that behaves like list and implement a cache mechanism.

Issue created by migration from https://trac.sagemath.org/ticket/13778





---

archive/issue_comments_167917.json:
```json
{
    "body": "Hmmm, haven't really checked the code, but there are a couple of typos (or grammatical errors) in the documentation (besides *\"non**-**negative\"*), and a few instances of missing mark-up (such as `self` without double-backquotes).\n\nWonder on which platform\n\n```\nsage: from sage.misc.lazy_list import lazy_list\nsage: P = lazy_list(iter(Primes()))[10::4]\nsage: P.info()\ncache length 0\nstart        10\nstop         2147483647\n...\n```\n\nwill fail (i.e., `INT_MAX` will differ)... ;-)",
    "created_at": "2012-11-30T09:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167917",
    "user": "leif"
}
```

Hmmm, haven't really checked the code, but there are a couple of typos (or grammatical errors) in the documentation (besides *"non**-**negative"*), and a few instances of missing mark-up (such as `self` without double-backquotes).

Wonder on which platform

```
sage: from sage.misc.lazy_list import lazy_list
sage: P = lazy_list(iter(Primes()))[10::4]
sage: P.info()
cache length 0
start        10
stop         2147483647
...
```

will fail (i.e., `INT_MAX` will differ)... ;-)



---

archive/issue_comments_167918.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-12-01T18:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167918",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_167919.json:
```json
{
    "body": "Hey Vincent,\n\nI've written a review patch which is mostly docstring changes (I've explicitly put in the stop so it does not depend on `INT_MAX`), but I've changed the `_repr_()` by just calculating the number of elements instead of the try-catch blocks. Everything else looks good, so if you agree with the changes, set this to positive review.\n\nBest,\n\nTravis",
    "created_at": "2012-12-01T18:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167919",
    "user": "tscrim"
}
```

Hey Vincent,

I've written a review patch which is mostly docstring changes (I've explicitly put in the stop so it does not depend on `INT_MAX`), but I've changed the `_repr_()` by just calculating the number of elements instead of the try-catch blocks. Everything else looks good, so if you agree with the changes, set this to positive review.

Best,

Travis



---

archive/issue_comments_167920.json:
```json
{
    "body": "If these lists are immutable, shouldn't they be called tuples in Python?..",
    "created_at": "2012-12-01T22:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167920",
    "user": "novoselt"
}
```

If these lists are immutable, shouldn't they be called tuples in Python?..



---

archive/issue_comments_167921.json:
```json
{
    "body": "Still some flaws, like *\"iteratable\"*.  I'd also consistently use *\"must\"* (instead of *\"should\"*) in the exceptions, as well as **either** (e.g.) *\"Returns ...\"* (descriptive) **or** *\"Return ...\"* (imperative form) in the docstrings.\n\n[I'll *perhaps<sup>TM</sup>* provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to \"positive review\" in case I don't.]",
    "created_at": "2012-12-02T03:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167921",
    "user": "leif"
}
```

Still some flaws, like *"iteratable"*.  I'd also consistently use *"must"* (instead of *"should"*) in the exceptions, as well as **either** (e.g.) *"Returns ..."* (descriptive) **or** *"Return ..."* (imperative form) in the docstrings.

[I'll *perhaps<sup>TM</sup>* provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to "positive review" in case I don't.]



---

archive/issue_comments_167922.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> Still some flaws, like *\"iteratable\"*.  I'd also consistently use *\"must\"* (instead of *\"should\"*) in the exceptions, as well as **either** (e.g.) *\"Returns ...\"* (descriptive) **or** *\"Return ...\"* (imperative form) in the docstrings.\n> \n> [I'll *perhaps<sup>TM</sup>* provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to \"positive review\" in case I don't.]\n\nRight. I correct the *\"iteratable\"*, change *\"should\"* to *\"must\"* and put everything in imperative form.",
    "created_at": "2012-12-02T09:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167922",
    "user": "vdelecroix"
}
```

Replying to [comment:5 leif]:
> Still some flaws, like *"iteratable"*.  I'd also consistently use *"must"* (instead of *"should"*) in the exceptions, as well as **either** (e.g.) *"Returns ..."* (descriptive) **or** *"Return ..."* (imperative form) in the docstrings.
> 
> [I'll *perhaps<sup>TM</sup>* provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to "positive review" in case I don't.]

Right. I correct the *"iteratable"*, change *"should"* to *"must"* and put everything in imperative form.



---

archive/issue_comments_167923.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-12-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167923",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_167924.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2012-12-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167924",
    "user": "tscrim"
}
```

Looks good to me.



---

archive/issue_comments_167925.json:
```json
{
    "body": "I am sorry. Using and reusing the code I found a mistake\n\n```\nsage: from sage.misc.lazy_list import lazy_list\nsage: lazy_list([0,0]\nTraceback (most recent call last):\n...\nIndexError: lazy list index out of range\n```\n\nThe problem comes from the fact that (stop - start) // step is not the good formula for the length. We should take the ceil and not the floor.",
    "created_at": "2012-12-07T10:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167925",
    "user": "vdelecroix"
}
```

I am sorry. Using and reusing the code I found a mistake

```
sage: from sage.misc.lazy_list import lazy_list
sage: lazy_list([0,0]
Traceback (most recent call last):
...
IndexError: lazy list index out of range
```

The problem comes from the fact that (stop - start) // step is not the good formula for the length. We should take the ceil and not the floor.



---

archive/issue_comments_167926.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-12-07T10:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167926",
    "user": "vdelecroix"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_167927.json:
```json
{
    "body": "I've reverted the `_repr_()` back and added the above as a doctest. I didn't like the control flow with asserts, but I understand why it has to be done that way now (and I tested lists of length at most 3 before I made the change). Set it to positive review if the revised patches works for you.\n\nBest,\n\nTravis",
    "created_at": "2012-12-07T23:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167927",
    "user": "tscrim"
}
```

I've reverted the `_repr_()` back and added the above as a doctest. I didn't like the control flow with asserts, but I understand why it has to be done that way now (and I tested lists of length at most 3 before I made the change). Set it to positive review if the revised patches works for you.

Best,

Travis



---

archive/issue_comments_167928.json:
```json
{
    "body": "I found a safer way to write `_repr_()` using an auxilliary `_fit()` method. I also so add additional doctests into `__getitem__()` at the very end.\n\nI switch using INT_MAX as a limiting value to PY_SSIZE_T_MAX which is defined in pyport.h (imported in Python.h). It makes more sense (and on my computer its size is larger than INT_MAX).\n\nBest,\nVincent\n\nPS (for pachbot):\n\napply trac_13778-lazy_list.patch",
    "created_at": "2012-12-08T14:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167928",
    "user": "vdelecroix"
}
```

I found a safer way to write `_repr_()` using an auxilliary `_fit()` method. I also so add additional doctests into `__getitem__()` at the very end.

I switch using INT_MAX as a limiting value to PY_SSIZE_T_MAX which is defined in pyport.h (imported in Python.h). It makes more sense (and on my computer its size is larger than INT_MAX).

Best,
Vincent

PS (for pachbot):

apply trac_13778-lazy_list.patch



---

archive/issue_comments_167929.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-12-08T14:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167929",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_167930.json:
```json
{
    "body": "Attachment\n\nreview patch",
    "created_at": "2012-12-09T22:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167930",
    "user": "tscrim"
}
```

Attachment

review patch



---

archive/issue_comments_167931.json:
```json
{
    "body": "Hey Vincent,\n\nI like this implementation much better.\n\nI've added a few tests and tweaked documentation, but I've changed the behavior of `list()` slightly by not checking if stop was large since I did not like the following behavior:\n\n```\nsage: L = lazy_list([0,1]); L\nlazy list [0, 1]\nsage: L.list()\nTraceback\n...\nValueError: stop is too large!!\n```\n\nThere definitely is a problem with determining when iterators are infinite throughout sage (for example, `vector(RR, QQ)` in ticket #13556), however I'd rather have finite lazy lists always have a `list()` method not raise an exception.\n\nI've also added a check if the input to lazy list is a list or tuple, then it sets `stop` to the length of the list if `stop` was not specified.\n\nIf you agree with the changes, feel free to set this to positive review.\n\nBest,\n\nTravis\n\n------\n\nFor patchbot:\n\nApply: trac_13778-lazy_list.patch, trac_13778-lazy_list-review-ts.patch",
    "created_at": "2012-12-09T22:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167931",
    "user": "tscrim"
}
```

Hey Vincent,

I like this implementation much better.

I've added a few tests and tweaked documentation, but I've changed the behavior of `list()` slightly by not checking if stop was large since I did not like the following behavior:

```
sage: L = lazy_list([0,1]); L
lazy list [0, 1]
sage: L.list()
Traceback
...
ValueError: stop is too large!!
```

There definitely is a problem with determining when iterators are infinite throughout sage (for example, `vector(RR, QQ)` in ticket #13556), however I'd rather have finite lazy lists always have a `list()` method not raise an exception.

I've also added a check if the input to lazy list is a list or tuple, then it sets `stop` to the length of the list if `stop` was not specified.

If you agree with the changes, feel free to set this to positive review.

Best,

Travis

------

For patchbot:

Apply: trac_13778-lazy_list.patch, trac_13778-lazy_list-review-ts.patch



---

archive/issue_comments_167932.json:
```json
{
    "body": "Hi Travis,\n\nThe doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.\n\nI also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).\n\nBest,\nVincent\n\nPS (for patchbot):\n\napply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch",
    "created_at": "2012-12-10T07:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167932",
    "user": "vdelecroix"
}
```

Hi Travis,

The doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.

I also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).

Best,
Vincent

PS (for patchbot):

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch



---

archive/issue_comments_167933.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-12-10T18:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167933",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_167934.json:
```json
{
    "body": "Replying to [comment:14 vdelecroix]:\n> The doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.\n\nSeems like it.\n\n> I also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).\n\nI trying using the python syntax for catching exceptions, and while things seemed to work fine when running in the interpreter, it caused segfaults when running `sage -t`. I have no idea how to fix this (nor I could not find how to catch python exceptions in a `cdef` extension function which is where I suspect the problem was).\n\nShort version: I'm happy with the way things currently are, so I'm setting this to positive review (hopefully for the last time XP).\n\nThanks,\n\nTravis",
    "created_at": "2012-12-10T18:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167934",
    "user": "tscrim"
}
```

Replying to [comment:14 vdelecroix]:
> The doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.

Seems like it.

> I also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).

I trying using the python syntax for catching exceptions, and while things seemed to work fine when running in the interpreter, it caused segfaults when running `sage -t`. I have no idea how to fix this (nor I could not find how to catch python exceptions in a `cdef` extension function which is where I suspect the problem was).

Short version: I'm happy with the way things currently are, so I'm setting this to positive review (hopefully for the last time XP).

Thanks,

Travis



---

archive/issue_comments_167935.json:
```json
{
    "body": "Many thanks for the review and your involvement in the ticket.\n\nVincent",
    "created_at": "2012-12-13T13:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167935",
    "user": "vdelecroix"
}
```

Many thanks for the review and your involvement in the ticket.

Vincent



---

archive/issue_comments_167936.json:
```json
{
    "body": "Please rebase this to #11795, there is a conflict in `doc/en/reference/misc.rst`",
    "created_at": "2012-12-18T12:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167936",
    "user": "jdemeyer"
}
```

Please rebase this to #11795, there is a conflict in `doc/en/reference/misc.rst`



---

archive/issue_comments_167937.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-12-18T12:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167937",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_167938.json:
```json
{
    "body": "Rebased.\n\napply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch",
    "created_at": "2012-12-19T18:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167938",
    "user": "vdelecroix"
}
```

Rebased.

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch



---

archive/issue_comments_167939.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-12-19T19:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167939",
    "user": "tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_167940.json:
```json
{
    "body": "The commit messages of the patches should be cleared up. In particular they should not refer to the filename `trac_13778-lazy_list-documentation-vd.patch`. And why does [attachment:trac_13778-lazy_list.patch] also refer to the other two patches in the commit message?",
    "created_at": "2012-12-20T13:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167940",
    "user": "jdemeyer"
}
```

The commit messages of the patches should be cleared up. In particular they should not refer to the filename `trac_13778-lazy_list-documentation-vd.patch`. And why does [attachment:trac_13778-lazy_list.patch] also refer to the other two patches in the commit message?



---

archive/issue_comments_167941.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-12-20T13:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167941",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_167942.json:
```json
{
    "body": "*** ping ***",
    "created_at": "2012-12-23T21:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167942",
    "user": "jdemeyer"
}
```

*** ping ***



---

archive/issue_comments_167943.json:
```json
{
    "body": "Attachment",
    "created_at": "2012-12-24T12:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167943",
    "user": "vdelecroix"
}
```

Attachment



---

archive/issue_comments_167944.json:
```json
{
    "body": "Attachment\n\nReplying to [comment:23 jdemeyer]:\n> *** ping ***\n\nMy apologies.",
    "created_at": "2012-12-24T12:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167944",
    "user": "vdelecroix"
}
```

Attachment

Replying to [comment:23 jdemeyer]:
> *** ping ***

My apologies.



---

archive/issue_comments_167945.json:
```json
{
    "body": "apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch",
    "created_at": "2012-12-24T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167945",
    "user": "vdelecroix"
}
```

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch



---

archive/issue_comments_167946.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-12-26T13:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13574#issuecomment-167946",
    "user": "jdemeyer"
}
```

Resolution: fixed
