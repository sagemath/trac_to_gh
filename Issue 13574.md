# Issue 13574: lazy list

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2012-11-30 05:48:05

Assignee: jason

Keywords: list, iterator

Lazy list are iterator that behaves like list and implement a cache mechanism.


---

Comment by leif created at 2012-11-30 09:33:21

Hmmm, haven't really checked the code, but there are a couple of typos (or grammatical errors) in the documentation (besides _"non*-*negative"_), and a few instances of missing mark-up (such as `self` without double-backquotes).

Wonder on which platform

```
sage: from sage.misc.lazy_list import lazy_list
sage: P = lazy_list(iter(Primes()))[10::4]
sage: P.info()
cache length 0
start        10
stop         2147483647
...
```

will fail (i.e., `INT_MAX` will differ)... ;-)


---

Comment by tscrim created at 2012-12-01 18:50:49

Changing status from new to needs_review.


---

Comment by tscrim created at 2012-12-01 18:50:49

Hey Vincent,

I've written a review patch which is mostly docstring changes (I've explicitly put in the stop so it does not depend on `INT_MAX`), but I've changed the `_repr_()` by just calculating the number of elements instead of the try-catch blocks. Everything else looks good, so if you agree with the changes, set this to positive review.

Best,

Travis


---

Comment by novoselt created at 2012-12-01 22:11:15

If these lists are immutable, shouldn't they be called tuples in Python?..


---

Comment by leif created at 2012-12-02 03:56:39

Still some flaws, like _"iteratable"_.  I'd also consistently use _"must"_ (instead of _"should"_) in the exceptions, as well as *either* (e.g.) _"Returns ..."_ (descriptive) *or* _"Return ..."_ (imperative form) in the docstrings.

[I'll _perhaps<sup>TM</sup>_ provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to "positive review" in case I don't.]


---

Comment by vdelecroix created at 2012-12-02 09:14:10

Replying to [comment:5 leif]:
> Still some flaws, like _"iteratable"_.  I'd also consistently use _"must"_ (instead of _"should"_) in the exceptions, as well as *either* (e.g.) _"Returns ..."_ (descriptive) *or* _"Return ..."_ (imperative form) in the docstrings.
> 
> [I'll _perhaps<sup>TM</sup>_ provide another reviewer patch later, but can't tell yet.  Just minor issues anyway, so feel free to set it to "positive review" in case I don't.]

Right. I correct the _"iteratable"_, change _"should"_ to _"must"_ and put everything in imperative form.


---

Comment by tscrim created at 2012-12-04 17:24:07

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-12-04 17:24:07

Looks good to me.


---

Comment by vdelecroix created at 2012-12-07 10:29:44

I am sorry. Using and reusing the code I found a mistake

```
sage: from sage.misc.lazy_list import lazy_list
sage: lazy_list([0,0]
Traceback (most recent call last):
...
IndexError: lazy list index out of range
```

The problem comes from the fact that (stop - start) // step is not the good formula for the length. We should take the ceil and not the floor.


---

Comment by vdelecroix created at 2012-12-07 10:29:44

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2012-12-07 23:33:24

I've reverted the `_repr_()` back and added the above as a doctest. I didn't like the control flow with asserts, but I understand why it has to be done that way now (and I tested lists of length at most 3 before I made the change). Set it to positive review if the revised patches works for you.

Best,

Travis


---

Comment by vdelecroix created at 2012-12-08 14:28:18

I found a safer way to write `_repr_()` using an auxilliary `_fit()` method. I also so add additional doctests into `__getitem__()` at the very end.

I switch using INT_MAX as a limiting value to PY_SSIZE_T_MAX which is defined in pyport.h (imported in Python.h). It makes more sense (and on my computer its size is larger than INT_MAX).

Best,
Vincent

PS (for pachbot):

apply trac_13778-lazy_list.patch


---

Comment by vdelecroix created at 2012-12-08 14:28:42

Changing status from needs_work to needs_review.


---

Attachment

review patch


---

Comment by tscrim created at 2012-12-09 22:27:29

Hey Vincent,

I like this implementation much better.

I've added a few tests and tweaked documentation, but I've changed the behavior of `list()` slightly by not checking if stop was large since I did not like the following behavior:

```
sage: L = lazy_list([0,1]); L
lazy list [0, 1]
sage: L.list()
Traceback
...
ValueError: stop is too large!!
```

There definitely is a problem with determining when iterators are infinite throughout sage (for example, `vector(RR, QQ)` in ticket #13556), however I'd rather have finite lazy lists always have a `list()` method not raise an exception.

I've also added a check if the input to lazy list is a list or tuple, then it sets `stop` to the length of the list if `stop` was not specified.

If you agree with the changes, feel free to set this to positive review.

Best,

Travis

------

For patchbot:

Apply: trac_13778-lazy_list.patch, trac_13778-lazy_list-review-ts.patch


---

Comment by vdelecroix created at 2012-12-10 07:52:39

Hi Travis,

The doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.

I also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).

Best,
Vincent

PS (for patchbot):

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch


---

Comment by tscrim created at 2012-12-10 18:52:56

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-12-10 18:52:56

Replying to [comment:14 vdelecroix]:
> The doctest for .info() fails on my machine and for patchbot (if the test pass on your machine, I guess that we do not have the same PY_SSIZE_T_MAX). So I changed it.

Seems like it.

> I also add a TODO in the method `._update_cache_up_to(n)` which may be enhanced (but I was not able to do it because of my poor knowledge of cython).

I trying using the python syntax for catching exceptions, and while things seemed to work fine when running in the interpreter, it caused segfaults when running `sage -t`. I have no idea how to fix this (nor I could not find how to catch python exceptions in a `cdef` extension function which is where I suspect the problem was).

Short version: I'm happy with the way things currently are, so I'm setting this to positive review (hopefully for the last time XP).

Thanks,

Travis


---

Comment by vdelecroix created at 2012-12-13 13:08:04

Many thanks for the review and your involvement in the ticket.

Vincent


---

Comment by jdemeyer created at 2012-12-18 12:55:56

Please rebase this to #11795, there is a conflict in `doc/en/reference/misc.rst`


---

Comment by jdemeyer created at 2012-12-18 12:55:56

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2012-12-19 18:08:04

Rebased.

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch


---

Comment by tscrim created at 2012-12-19 19:27:37

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2012-12-20 13:02:45

The commit messages of the patches should be cleared up. In particular they should not refer to the filename `trac_13778-lazy_list-documentation-vd.patch`. And why does [attachment:trac_13778-lazy_list.patch] also refer to the other two patches in the commit message?


---

Comment by jdemeyer created at 2012-12-20 13:02:45

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-12-23 21:16:31

** ping **


---

Attachment


---

Attachment

Replying to [comment:23 jdemeyer]:
> ** ping **

My apologies.


---

Comment by vdelecroix created at 2012-12-24 12:07:53

apply trac_13778-lazy_list.patch trac_13778-lazy_list-review-ts.patch trac_13778-lazy_list-documentation-vd.patch


---

Comment by jdemeyer created at 2012-12-26 13:20:45

Resolution: fixed
