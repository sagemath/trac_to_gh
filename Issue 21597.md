# Issue 21597: Faster minpoly function for constants in finite field extensions

Issue created by migration from https://trac.sagemath.org/ticket/21834

Original creator: jpflori

Original creation time: 2016-11-07 15:33:26

CC:  defeo jdemeyer

Keywords: finite fields minpoly

The current code constructs the multiplication matrix which is suboptimal in the trivial case where the element lies in the prime field.

Before:
sage: K.<z> = GF(461**173)
sage: %timeit K(55).minpoly()
100 loops, best of 3: 3.21 ms per loop


After:

```
sage: K.<z> = GF(461**173)
sage: %timeit K(55).minpoly()
1000 loops, best of 3: 207 Âµs per loop
```



---

Comment by jpflori created at 2016-11-07 15:33:44

Changing status from new to needs_review.


---

Comment by jpflori created at 2016-11-07 16:03:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-11-07 16:11:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-11-07 16:12:57

FYI:

```
sage: K.<z> = GF(461**173)
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
10 loops, best of 3: 103 ms per loop
sage: %timeit b.minpoly(algorithm='pari')
100 loops, best of 3: 5.28 ms per loop
```



---

Comment by jpflori created at 2016-11-07 16:16:10

Some more timings:

```
sage: K.<z> = GF(next_prime(2**30)**173)
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
1 loop, best of 3: 205 ms per loop
sage: %timeit b.minpoly(algorithm='pari')
10 loops, best of 3: 22.2 ms per loop
sage: K.<z> = GF(next_prime(2**30)**next_prime(2**10))
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
1 loop, best of 3: 19.6 s per loop
sage: %timeit b.minpoly(algorithm='pari')
1 loop, best of 3: 372 ms per loop
```



---

Comment by jpflori created at 2016-11-07 16:18:31

Something should surely be done about charpoly as well (and maybe polynomial factorization and generation of irreducible polynomials :p).


---

Comment by jpflori created at 2016-11-07 16:18:41

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2016-11-07 16:37:12

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2016-11-07 16:37:12

With my changes the doc is wrong.
E.g. for extensions using PARI, in the "matrix" case, it is actually PARI charpoly function which is used.

While fixing this, I'll also fix the charpoly general case.


---

Comment by git created at 2016-11-07 17:11:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-11-07 17:26:32

I'm not quite satisfied by the current situation:
* maybe we could have a "matrix" option for minpoly doing either the charpoly of the matrix and getting the right factor or just calling minpoly on the matrix
* the "charpoly" option for minpoly is not that useful :/ it would only be for a class implementing a very fast charpoly and no minpoly.

Does anyone think anything?


---

Comment by jpflori created at 2016-11-07 17:26:32

Changing status from needs_work to needs_review.


---

Comment by defeo created at 2016-11-10 16:54:24

The original code for `minpoly` is weird. What's a `FinitePolyExtElement` supposed to be, anyway? A superclass to any polynomial extension of a finite ring? In this case the algorithm is wrong, because it doesn't take multiplicities into account.

The name of the package is probably a misnomer, as it only seems to contain finite fields, and no more general rings. Extensions of GF(p) by non-irreducible polynomials are implemented elsewhere.

I would completely throw away the "charpoly" option, and have a dedicated generic minpoly implementation. Either "matrix", as you suggest, or something calling "berlekamp_massey".


---

Comment by git created at 2016-11-15 07:42:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-11-15 07:45:14

About the class name, it seems it was meant to represent any finite extension of a finite ring.
But it also seems it is only used for finite fields extensions at the moment.
And that some functions in there might be finite field specific...

Voucl we deal with that in another ticket?
And merge this one if you're happy with my latest changes?


---

Comment by jpflori created at 2016-11-15 13:30:43

Also note that "most" finite fields will use the "libpari" derived class which provides its own minpoly function and so won't call these methods at all...
Same is true for finite fields using NTL.


---

Comment by defeo created at 2016-11-15 16:14:30

- Maybe add a doctest for the `"matrix"` option of `minpoly()`? 
- The doctest for `charpoly()` should be changed: it tests PARI twice.
- Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.

More generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.

Similarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?

I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?


---

Comment by jpflori created at 2016-11-15 16:37:46

Replying to [comment:15 defeo]:
> - Maybe add a doctest for the `"matrix"` option of `minpoly()`? 
Ok.
> - The doctest for `charpoly()` should be changed: it tests PARI twice.
Ok.
> - Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.
You're right I spotted taht one but wanted to exercice the reviewer :/
> 
> More generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.
Sure...
We could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm.
But that sounds horrible and complicated, doesn't it?
> 
> Similarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?
> 
> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?
We could force the super class method to be called.


---

Comment by jdemeyer created at 2016-11-15 16:59:43

Replace

```
def minpoly(FiniteFieldElement_pari_ffelt self, object var='x'):
```

by

```
def minpoly(self, var='x'):
```

Both types are superfluous.


---

Comment by jdemeyer created at 2016-11-15 16:59:43

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-15 17:11:06

Replying to [comment:15 defeo]:
> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?

Create the field using

```
sage: GF(19^2, impl="pari_ffelt")
```

if you want that implementation.


---

Comment by jpflori created at 2016-11-15 17:17:03

I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.


---

Comment by defeo created at 2016-11-15 18:27:58

> Sure... We could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm. But that sounds horrible and complicated, doesn't it? 

It does.

> I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.

I think we do.


---

Comment by git created at 2016-11-17 13:38:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-11-17 13:39:08

Changing status from needs_work to needs_review.


---

Comment by defeo created at 2016-11-17 14:01:10

Good on the principle. I'm doctesting now, will give positive review when it's done.


---

Comment by defeo created at 2016-11-17 16:17:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-19 16:34:55

Resolution: fixed
