# Issue 21597: Faster minpoly function for constants in finite field extensions

archive/issues_021597.json:
```json
{
    "body": "CC:  @defeo @jdemeyer\n\nKeywords: finite fields minpoly\n\nThe current code constructs the multiplication matrix which is suboptimal in the trivial case where the element lies in the prime field.\n\nBefore:\nsage: K.<z> = GF(461**173)\nsage: %timeit K(55).minpoly()\n100 loops, best of 3: 3.21 ms per loop\n\n\nAfter:\n\n```\nsage: K.<z> = GF(461**173)\nsage: %timeit K(55).minpoly()\n1000 loops, best of 3: 207 \u00b5s per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21834\n\n",
    "created_at": "2016-11-07T15:33:26Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Faster minpoly function for constants in finite field extensions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21597",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
CC:  @defeo @jdemeyer

Keywords: finite fields minpoly

The current code constructs the multiplication matrix which is suboptimal in the trivial case where the element lies in the prime field.

Before:
sage: K.<z> = GF(461**173)
sage: %timeit K(55).minpoly()
100 loops, best of 3: 3.21 ms per loop


After:

```
sage: K.<z> = GF(461**173)
sage: %timeit K(55).minpoly()
1000 loops, best of 3: 207 Âµs per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/21834





---

archive/issue_comments_299464.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-07T15:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299464",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299465.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-07T16:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299465",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299466.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-07T16:11:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299466",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299467.json:
```json
{
    "body": "FYI:\n\n```\nsage: K.<z> = GF(461**173)\nsage: b = K.random_element()\nsage: %timeit b.minpoly(algorithm='matrix')\n10 loops, best of 3: 103 ms per loop\nsage: %timeit b.minpoly(algorithm='pari')\n100 loops, best of 3: 5.28 ms per loop\n```\n",
    "created_at": "2016-11-07T16:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299467",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

FYI:

```
sage: K.<z> = GF(461**173)
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
10 loops, best of 3: 103 ms per loop
sage: %timeit b.minpoly(algorithm='pari')
100 loops, best of 3: 5.28 ms per loop
```




---

archive/issue_comments_299468.json:
```json
{
    "body": "Some more timings:\n\n```\nsage: K.<z> = GF(next_prime(2**30)**173)\nsage: b = K.random_element()\nsage: %timeit b.minpoly(algorithm='matrix')\n1 loop, best of 3: 205 ms per loop\nsage: %timeit b.minpoly(algorithm='pari')\n10 loops, best of 3: 22.2 ms per loop\nsage: K.<z> = GF(next_prime(2**30)**next_prime(2**10))\nsage: b = K.random_element()\nsage: %timeit b.minpoly(algorithm='matrix')\n1 loop, best of 3: 19.6 s per loop\nsage: %timeit b.minpoly(algorithm='pari')\n1 loop, best of 3: 372 ms per loop\n```\n",
    "created_at": "2016-11-07T16:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299468",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Some more timings:

```
sage: K.<z> = GF(next_prime(2**30)**173)
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
1 loop, best of 3: 205 ms per loop
sage: %timeit b.minpoly(algorithm='pari')
10 loops, best of 3: 22.2 ms per loop
sage: K.<z> = GF(next_prime(2**30)**next_prime(2**10))
sage: b = K.random_element()
sage: %timeit b.minpoly(algorithm='matrix')
1 loop, best of 3: 19.6 s per loop
sage: %timeit b.minpoly(algorithm='pari')
1 loop, best of 3: 372 ms per loop
```




---

archive/issue_comments_299469.json:
```json
{
    "body": "Something should surely be done about charpoly as well (and maybe polynomial factorization and generation of irreducible polynomials :p).",
    "created_at": "2016-11-07T16:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299469",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Something should surely be done about charpoly as well (and maybe polynomial factorization and generation of irreducible polynomials :p).



---

archive/issue_comments_299470.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-07T16:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299470",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299471.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-07T16:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299471",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299472.json:
```json
{
    "body": "With my changes the doc is wrong.\nE.g. for extensions using PARI, in the \"matrix\" case, it is actually PARI charpoly function which is used.\n\nWhile fixing this, I'll also fix the charpoly general case.",
    "created_at": "2016-11-07T16:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299472",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

With my changes the doc is wrong.
E.g. for extensions using PARI, in the "matrix" case, it is actually PARI charpoly function which is used.

While fixing this, I'll also fix the charpoly general case.



---

archive/issue_comments_299473.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-07T17:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299473",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299474.json:
```json
{
    "body": "I'm not quite satisfied by the current situation:\n* maybe we could have a \"matrix\" option for minpoly doing either the charpoly of the matrix and getting the right factor or just calling minpoly on the matrix\n* the \"charpoly\" option for minpoly is not that useful :/ it would only be for a class implementing a very fast charpoly and no minpoly.\n\nDoes anyone think anything?",
    "created_at": "2016-11-07T17:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299474",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'm not quite satisfied by the current situation:
* maybe we could have a "matrix" option for minpoly doing either the charpoly of the matrix and getting the right factor or just calling minpoly on the matrix
* the "charpoly" option for minpoly is not that useful :/ it would only be for a class implementing a very fast charpoly and no minpoly.

Does anyone think anything?



---

archive/issue_comments_299475.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-07T17:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299475",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299476.json:
```json
{
    "body": "The original code for `minpoly` is weird. What's a `FinitePolyExtElement` supposed to be, anyway? A superclass to any polynomial extension of a finite ring? In this case the algorithm is wrong, because it doesn't take multiplicities into account.\n\nThe name of the package is probably a misnomer, as it only seems to contain finite fields, and no more general rings. Extensions of GF(p) by non-irreducible polynomials are implemented elsewhere.\n\nI would completely throw away the \"charpoly\" option, and have a dedicated generic minpoly implementation. Either \"matrix\", as you suggest, or something calling \"berlekamp_massey\".",
    "created_at": "2016-11-10T16:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299476",
    "user": "https://github.com/defeo"
}
```

The original code for `minpoly` is weird. What's a `FinitePolyExtElement` supposed to be, anyway? A superclass to any polynomial extension of a finite ring? In this case the algorithm is wrong, because it doesn't take multiplicities into account.

The name of the package is probably a misnomer, as it only seems to contain finite fields, and no more general rings. Extensions of GF(p) by non-irreducible polynomials are implemented elsewhere.

I would completely throw away the "charpoly" option, and have a dedicated generic minpoly implementation. Either "matrix", as you suggest, or something calling "berlekamp_massey".



---

archive/issue_comments_299477.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-15T07:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299477",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299478.json:
```json
{
    "body": "About the class name, it seems it was meant to represent any finite extension of a finite ring.\nBut it also seems it is only used for finite fields extensions at the moment.\nAnd that some functions in there might be finite field specific...\n\nVoucl we deal with that in another ticket?\nAnd merge this one if you're happy with my latest changes?",
    "created_at": "2016-11-15T07:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299478",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

About the class name, it seems it was meant to represent any finite extension of a finite ring.
But it also seems it is only used for finite fields extensions at the moment.
And that some functions in there might be finite field specific...

Voucl we deal with that in another ticket?
And merge this one if you're happy with my latest changes?



---

archive/issue_comments_299479.json:
```json
{
    "body": "Also note that \"most\" finite fields will use the \"libpari\" derived class which provides its own minpoly function and so won't call these methods at all...\nSame is true for finite fields using NTL.",
    "created_at": "2016-11-15T13:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299479",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Also note that "most" finite fields will use the "libpari" derived class which provides its own minpoly function and so won't call these methods at all...
Same is true for finite fields using NTL.



---

archive/issue_comments_299480.json:
```json
{
    "body": "- Maybe add a doctest for the `\"matrix\"` option of `minpoly()`? \n- The doctest for `charpoly()` should be changed: it tests PARI twice.\n- Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.\n\nMore generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.\n\nSimilarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?\n\nI have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?",
    "created_at": "2016-11-15T16:14:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299480",
    "user": "https://github.com/defeo"
}
```

- Maybe add a doctest for the `"matrix"` option of `minpoly()`? 
- The doctest for `charpoly()` should be changed: it tests PARI twice.
- Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.

More generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.

Similarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?

I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?



---

archive/issue_comments_299481.json:
```json
{
    "body": "Replying to [comment:15 defeo]:\n> - Maybe add a doctest for the `\"matrix\"` option of `minpoly()`? \nOk.\n> - The doctest for `charpoly()` should be changed: it tests PARI twice.\nOk.\n> - Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.\nYou're right I spotted taht one but wanted to exercice the reviewer :/\n> \n> More generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.\nSure...\nWe could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm.\nBut that sounds horrible and complicated, doesn't it?\n> \n> Similarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?\n> \n> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?\nWe could force the super class method to be called.",
    "created_at": "2016-11-15T16:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299481",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:15 defeo]:
> - Maybe add a doctest for the `"matrix"` option of `minpoly()`? 
Ok.
> - The doctest for `charpoly()` should be changed: it tests PARI twice.
Ok.
> - Are you sure the doctest of `FiniteFieldElement_pari_ffelt.minpoly()` tests the correct field? I have the impression that's a Givaro field.
You're right I spotted taht one but wanted to exercice the reviewer :/
> 
> More generally, I was wondering: some day Givaro may implement minimal polynomials, and we may override `minpoly()` in `FiniteField_givaro`. At that moment, the doctest in `element_base.pyx` may become stale without us noticing.
Sure...
We could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm.
But that sounds horrible and complicated, doesn't it?
> 
> Similarly, what if someday we decide that `GF(19^2)` should be implemented by a different subsystem?
> 
> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?
We could force the super class method to be called.



---

archive/issue_comments_299482.json:
```json
{
    "body": "Replace\n\n```\ndef minpoly(FiniteFieldElement_pari_ffelt self, object var='x'):\n```\n\nby\n\n```\ndef minpoly(self, var='x'):\n```\n\nBoth types are superfluous.",
    "created_at": "2016-11-15T16:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299482",
    "user": "https://github.com/jdemeyer"
}
```

Replace

```
def minpoly(FiniteFieldElement_pari_ffelt self, object var='x'):
```

by

```
def minpoly(self, var='x'):
```

Both types are superfluous.



---

archive/issue_comments_299483.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-15T16:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299483",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299484.json:
```json
{
    "body": "Replying to [comment:15 defeo]:\n> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?\n\nCreate the field using\n\n```\nsage: GF(19^2, impl=\"pari_ffelt\")\n```\n\nif you want that implementation.",
    "created_at": "2016-11-15T17:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299484",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 defeo]:
> I have the impression that doctests that rely on some mathematical object being implemented by some specific subclass are very brittle. Is there a better way to write these doctests so to be sure that they call the right method?

Create the field using

```
sage: GF(19^2, impl="pari_ffelt")
```

if you want that implementation.



---

archive/issue_comments_299485.json:
```json
{
    "body": "I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.",
    "created_at": "2016-11-15T17:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299485",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.



---

archive/issue_comments_299486.json:
```json
{
    "body": "> Sure... We could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm. But that sounds horrible and complicated, doesn't it? \n\nIt does.\n\n> I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.\n\nI think we do.",
    "created_at": "2016-11-15T18:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299486",
    "user": "https://github.com/defeo"
}
```

> Sure... We could also decide to implement _minpoly in subclasses and let the minpoly in Finite... class use that by default if it exist or fallback when given an algorithm. But that sounds horrible and complicated, doesn't it? 

It does.

> I guess the other issue is do we want to test the base class methods even when they are always overloaded in sub classes.

I think we do.



---

archive/issue_comments_299487.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-17T13:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299487",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299488.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-17T13:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299488",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299489.json:
```json
{
    "body": "Good on the principle. I'm doctesting now, will give positive review when it's done.",
    "created_at": "2016-11-17T14:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299489",
    "user": "https://github.com/defeo"
}
```

Good on the principle. I'm doctesting now, will give positive review when it's done.



---

archive/issue_comments_299490.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-17T16:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299490",
    "user": "https://github.com/defeo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299491.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-19T16:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21597#issuecomment-299491",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_020402.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-19T16:34:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21597",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21597#event-20402"
}
```
