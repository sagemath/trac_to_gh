# Issue 27404: SAGE_SPKG_CONFIGURE macro: Add new pre-check and post-check optional arguments

Issue created by migration from https://trac.sagemath.org/ticket/27641

Original creator: embray

Original creation time: 2019-04-11 10:39:58

CC:  dimpase

This adds two new optional arguments to the `SAGE_SPKG_CONFIGURE`.  Both are sets of actions that should be run unconditionally when running the resulting `configure` script, regardless of the outcome of checks for the package.

This demonstrates a use case for this in mpir, where no matter what else it is imperative to set a value for `SAGE_MP_LIBRARY` (even if we are not installing the mpir SPKG, or the SPKG is already installed).

It will maybe be more clear why this is needed in a follow-up I will add next.

One thing I don't like about this entirely is that it would seem clearer and more logical to make the "pre" argument come before the other arguments.  However, since it's optional, and is not used for many packages, I thought it would be better to add it to the end of the argument list and not have to update every `spkg-configure.m4` to pass an empty value for the first argument.


---

Comment by embray created at 2019-04-11 10:41:04

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-04-17 05:30:25

This seems to depend, and use the branch, of #27212, no?


---

Comment by dimpase created at 2019-04-19 11:32:56

rebased over 8.8.beta3
----
New commits:


---

Comment by embray created at 2019-04-19 15:52:49

That's a good point; yes it included #27212.  Thanks for rebasing.


---

Comment by dimpase created at 2019-04-19 19:19:20

Do you have an example use of the macro where the 3rd argument is not empty?
(Perhaps from one of the tickets on the list #27330 ?)

And, by the way, docs explaining them are hard to read, could you please instead write: 
"1st argument does this and this", "2nd argument does...", etc?


---

Comment by dimpase created at 2019-04-23 12:03:09

It looks as if it basically adds a bit of structure into spkg-configure.m4 files (i.e. logically different parts are inside `[]`), no more than that, right? Can  this wait until it gets used for actual refactoring?


---

Comment by embray created at 2019-04-23 15:11:20

Replying to [comment:6 dimpase]:
> Do you have an example use of the macro where the 3rd argument is not empty?
> (Perhaps from one of the tickets on the list #27330 ?)

The (currently) third argument is used in a few packages.  At least one example I can think of off the top of my head is yasm.  The point of the third argument is to check whether that dependency is needed at all for _anything_, as opposed to the second argument which assumes the package is required but does the check for whether it's provided already by the system.

> And, by the way, docs explaining them are hard to read, could you please instead write: 
> "1st argument does this and this", "2nd argument does...", etc?

I can try to reword it.


---

Comment by embray created at 2019-04-23 15:12:54

Replying to [comment:7 dimpase]:
> It looks as if it basically adds a bit of structure into spkg-configure.m4 files (i.e. logically different parts are inside `[]`), no more than that, right?

Essentially, yes.  It just allows insertion of commands into a couple places where it wasn't previously possible to insert them.

> Can  this wait until it gets used for actual refactoring?

I'm not sure what you mean here.  It is used for #27642 which has this ticket as a dependency.


---

Comment by dimpase created at 2019-04-23 17:45:34

Replying to [comment:9 embray]:
> Replying to [comment:7 dimpase]:
> > It looks as if it basically adds a bit of structure into spkg-configure.m4 files (i.e. logically different parts are inside `[]`), no more than that, right?
> 
> Essentially, yes.  It just allows insertion of commands into a couple places where it wasn't previously possible to insert them.
> 
> > Can  this wait until it gets used for actual refactoring?
> I'm not sure what you mean here.  It is used for #27642 which has this ticket as a dependency.

I mean to say, I'd like to see this ticket "in action", by itself it does not make much sense. How about reviewing once #27642 is done?


---

Comment by embray created at 2019-04-24 13:12:20

I think #27642 already demonstrates in "in action".  The only bits missing from #27642, if any (that I'm aware of) is ensuring that configure is re-run with its previous arguments.  I would go ahead and start playing with #27642.


---

Comment by dimpase created at 2019-05-03 14:52:40

Trying this with `./configure` leaves `gmp` not marked as an not to be installed, while `mpir` is marked as not to be installed.


---

Comment by dimpase created at 2019-05-03 14:52:40

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-05-03 15:23:30

I had a problem like that much earlier when I was working on this, but I thought I fixed that.


---

Comment by embray created at 2019-05-03 15:38:18

Yes, I see the problem.  The change in `build/pkgs/gmp/spkg-configure.m4` is not correct.

Nothing in the "PRE" argument should set the `sage_spkg_install_<pkgname>`, and if the second argument (the one that's supposed to actually check whether or not to install the SPKG) is empty then it will force `sage_spkg_install_gmp=yes`:


```
m4_ifval(
 [$2],
 [AS_VAR_SET_IF(SPKG_INSTALL_VAR, [], SPKG_INSTALL_VAR[=no])],
 [AS_VAR_SET_IF(SPKG_INSTALL_VAR, [], SPKG_INSTALL_VAR[=yes])])
```


That's what's going on in the above lines in SAGE_SPKG_CONFIGURE


---

Comment by git created at 2019-05-03 15:39:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-05-03 15:39:51

Try now.


---

Comment by embray created at 2019-05-03 15:39:51

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-05-03 17:09:32

OK, good.


---

Comment by dimpase created at 2019-05-03 17:09:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-06 11:56:28

Resolution: fixed
