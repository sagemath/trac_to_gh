# Issue 21204: Old version of Cython might be used

Issue created by migration from https://trac.sagemath.org/ticket/21441

Original creator: jdemeyer

Original creation time: 2016-09-06 20:28:34

CC:  embray

On a machine which had on older version of Cython installed but which was upgraded recently after #20218 was merged:

```
$ ls -ld local/lib/python/site-packages/Cython*
drwxrwxr-x 12 jdemeyer jdemeyer 4096 Sep  6 21:23 local/lib/python/site-packages/Cython
drwxrwxr-x  5 jdemeyer jdemeyer 4096 Sep  6 21:22 local/lib/python/site-packages/Cython-0.23.3-py2.7-linux-i686.egg
drwxrwxr-x  2 jdemeyer jdemeyer 4096 Sep  6 21:14 local/lib/python/site-packages/Cython-0.24.1-py2.7.egg-info
```



```
>>> import Cython
>>> Cython.__version__
'0.23.3'
>>> import sys
>>> [x for x in sys.path if 'Cython' in x]
['/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-i686.egg']
```


This causes breakage when building the Sage library.


---

Comment by embray created at 2016-09-07 09:03:39

Wow, I see the issue.  When you use pip with the `--ignore-installed` option it also does not uninstall existing versions of the package (at the very least if it's an old .egg).  I would say that's undocumented behavior.


---

Comment by embray created at 2016-09-07 09:33:14

I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.  That will also make `./sage -f` work properly since it will force reinstall of the package even if the same version was already installed.


---

Comment by jdemeyer created at 2016-09-07 12:09:03

Replying to [comment:6 embray]:
> I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.

That is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.

Other than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.


---

Comment by embray created at 2016-09-07 13:06:47

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 embray]:
> > I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.
> 
> That is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.

Fair point.  A broader idea I had is that as many of the `spkg-install`s (but not all!) have sections for uninstalling previous installations, that step should maybe be broken out to a separate `spkg-uninstall` script.  Another step in making the packages a little more uniform in how they are managed.  But my hope was to find a simple way to address this specific issue _now_.

I'm sort of of the mind that `pip uninstall .` _should_ work.  If there's a local `setup.py` it should use that to figure out the package's name, and then uninstall that.  

> Other than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.

I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.  It seems that `--ignore-installed` is just very literal in its intent.  It really means "pay no attention whatsoever to what I already have installed".


---

Comment by embray created at 2016-09-07 13:09:25

I think what pip really needs here is an option to _explicitly_ ensure that conflicting packages are uninstalled, even if I said `--ignore-installed`.


---

Comment by embray created at 2016-09-07 14:17:54

Here's an initial stab at a fix.  Adds a new `sage-pip-install` script to wrap `pip`, since otherwise this got too unwieldy.  It just ensures that any previous installations of the package are thoroughly uninstalled before the actual `pip install` call.

In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really _only_ print the package's name (if it prints anything else it should be to stderr).  This is easy enough to work around, but I wonder what other packages make this mistake, and I'm testing for that now...
----
New commits:


---

Comment by git created at 2016-09-07 14:25:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-07 14:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-08 06:01:05

`#!/bin/bash` should be `#!/usr/bin/env bash`


---

Comment by jdemeyer created at 2016-09-08 06:05:01

Replying to [comment:8 embray]:
> I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.

The whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.


---

Comment by jdemeyer created at 2016-09-08 07:48:29

Replying to [comment:10 embray]:
> In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really _only_ print the package's name

Is Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.


---

Comment by embray created at 2016-09-09 08:13:34

Replying to [comment:13 jdemeyer]:
> `#!/bin/bash` should be `#!/usr/bin/env bash`

Sure, will do.


---

Comment by embray created at 2016-09-09 08:15:54

Replying to [comment:14 jdemeyer]:
> Replying to [comment:8 embray]:
> > I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.
> 
> The whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.

That makes sense.  I think for the purposes of this ticket we shouldn't mess with it though--it's already working as is (minus this issue).  I'd rather get the uninstallation fixed, and then worry about further tweaking the install options.

I'm also going to write up something about this experience for the pip mailing list.  As `pip` is now the de-facto installer for Python packages it ought to be easier for system integrators to control it a bit (though I still maintain that as system integrators dependency management is our job, not pip's).


---

Comment by embray created at 2016-09-09 08:18:06

Replying to [comment:15 jdemeyer]:
> Replying to [comment:10 embray]:
> > In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really _only_ print the package's name
> 
> Is Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.

There are a few others I've found:

* pari_jupyter
* widgetsnbextension
* giacpy
* matplotlib

I've already opened an issue for matplotlib, though I don't have a patch.  I think the check is good to leave in even if these are fixed because you never know when another package is going to be added, or updated in such a way that it breaks this.


---

Comment by jdemeyer created at 2016-09-09 08:39:47

I see. For `pari_jupyter`, I need Cython 0.25 to fix that: https://github.com/jdemeyer/pari_jupyter/pull/1


---

Comment by jdemeyer created at 2016-09-09 08:55:05

Erik, I agree with everything you said. Remember to fix [comment:13] and set this to needs review when you feel like it is ready.


---

Comment by jdemeyer created at 2016-09-09 09:00:38

Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.


---

Comment by embray created at 2016-09-09 12:33:18

Replying to [comment:21 jdemeyer]:
> Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.

Doesn't that mean basically any package that uses pip?  I avoided doing that in #20218 since there was no real change in the packages themselves.  How they are installed is changed, but it shouldn't have otherwise impacted their functionality.

I'm not opposed to doing it anyways, but I'm not sure it's really needed either.


---

Comment by git created at 2016-09-09 13:27:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-09 13:50:54

Replying to [comment:22 embray]:
> Doesn't that mean basically any package that uses pip?

Yes indeed.

> I avoided doing that in #20218 since there was no real change in the packages themselves.  

The _intent_ was to have no real change. But this whole ticket is about an accidental change.

> How they are installed is changed, but it shouldn't have otherwise impacted their functionality.

Given that the packages were installed badly, the change _does_ impact the functionality.

Another example of breakage is the patchbot report of #20767: it reports a failure because the Cython update #21126 didn't work. If you don't force a rebuild, it will keep using the wrong version.


---

Comment by embray created at 2016-09-09 14:50:50

But that was only an issue specifically because Cython was updated.  The version number of Cython was bumped, at it was reinstalled.  It just didn't uninstall the old version.  Neither the old version nor the new version were "installed badly" on their own--only insofar as two copies were installed.

If a package wasn't otherwise updated there's no reason to reinstall it.


---

Comment by jdemeyer created at 2016-09-09 19:09:08

Replying to [comment:25 embray]:
> But that was only an issue specifically because Cython was updated.

...in the latest beta. If you assume that people upgrade at every beta release, then you might be right. But people might have skipped some beta releases (upgrading from an older version to the current version) and then more packages might be affected. I suggest we don't guess and just upgrade all `pip`-installed packages.

> Neither the old version nor the new version were "installed badly" on their own--only insofar as two copies were installed.

Right, it wasn't "installed badly" in the strict sense. But still, the packages are installed badly in the sense that if you try to `import` them, you get the wrong version.


---

Comment by jdemeyer created at 2016-09-11 07:17:43

Anyway, this is not something I want to fight about. My main concern is that this bug gets fixed :-)


---

Comment by jdemeyer created at 2016-09-13 14:31:42

I think the `pushd`/`popd` logic is not needed since this script will be run in a separate process. A simple `cd` should work.


---

Comment by jdemeyer created at 2016-09-18 12:00:17

Erik, do you plan to work on this or should I take over?


---

Comment by jdemeyer created at 2016-09-20 09:52:46

Replying to [comment:18 embray]:
> There are a few others I've found:
> 
> * widgetsnbextension

For widgetsnbextension, see https://github.com/ipython/ipywidgets/pull/781


---

Comment by jdemeyer created at 2016-09-20 10:13:10

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-09-20 10:13:10

New commits:


---

Comment by git created at 2016-09-20 13:08:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-09-22 16:04:10

I think the mass replacement of `PIP_INSTALL` with `sage-pip-install` was excessive.  I deliberately did not do that in the first place, because

a) I wanted to avoid another mass update of `spkg-installs` when that was already done to put `PIP_INSTALL` everywhere, and

b) Leaving `PIP_INSTALL` as a variable means such mass updates can be avoided in the future.  For example, future improvements in pip itself might render the `sage-pip-install` script superfluous, at which point it might be nice to remove it.

I also have ideas for more work to generalize common installation steps so that maybe many of these spkg-installs will just be pointers to a common install script for Python packages, so that will reduce duplication as well, at which point `PIP_INSTALL` might not be as useful.  But for now I think it's easier to leave it so that this can be changed in one place.


---

Comment by embray created at 2016-09-22 16:07:44

(Also, sorry, I was on vacation last week.  No disagreement with anything else here.)


---

Comment by jdemeyer created at 2016-09-22 21:07:18

To be honest, I never liked the `PIP_INSTALL` the environment variable in the first place. And if that variable would just be the name of a script, why bother with the environment variable? And mass replacements are really not a big deal, that's trivially done with some `sed` script or other tool.

However, for the sake of peace, I don't mind to change this back if that's the only issue you have.


---

Comment by jdemeyer created at 2016-09-23 09:26:23

`@`embray: please clearly state what you require to set this to positive_review.


---

Comment by embray created at 2016-09-23 11:31:22

Just removing the change to `PIP_INSTALL`.

I don't like adding yet another "sage-" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.


---

Comment by git created at 2016-09-23 12:02:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-09-23 12:09:57

Replying to [comment:40 embray]:
> I don't like adding yet another "sage-" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.

I would argue that adding a new environment variable in `sage-env` is uglier than a clean self-contained script. But here is what you asked for...


---

Comment by embray created at 2016-09-23 12:43:30

I wouldn't have removed the `.` either.  `sage-pip-install` takes that as an argument.  The idea was to keep the interface otherwise the same, and minimize the changes needed to work around this issue, which I think represents deficiencies in pip more than anything else.


---

Comment by jdemeyer created at 2016-09-23 12:47:43

Replying to [comment:43 embray]:
> I wouldn't have removed the `.` either.

I know. However, Sage _only_ uses `.` as directory, so I didn't see the point of supporting a directory argument (it's extra complexity without a use case). We could also keep the `.` and just ignore it in `sage-pip-install`, but that looked like a worse solution.


---

Comment by embray created at 2016-09-23 12:48:05

(I do agree having it as an environment variable sucks--in the future we'll want to redo how `spkg-install` works so that it instead sources what it needs instead of relying as much on environment variables).


---

Comment by embray created at 2016-09-29 14:53:43

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-09-29 14:53:43

See above.


---

Comment by jdemeyer created at 2016-09-29 14:56:00

Replying to [comment:46 embray]:
> See above.

Can you give a little more detail?


---

Comment by jdemeyer created at 2016-09-29 14:56:38

In other words: what would you like me to do concretely?


---

Comment by embray created at 2016-09-29 15:56:13

Remove any changes to `spkg-install`s.


---

Comment by git created at 2016-09-30 08:44:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-09-30 08:46:01

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-09-30 08:46:01

Not fully tested yet, but this reverts all changes to `spkg-install`, except for the `pip` package.


---

Comment by embray created at 2016-09-30 10:16:14

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-09-30 10:16:14

Looks good to me.


---

Comment by vbraun created at 2016-10-02 17:43:38

Reviewer name...


---

Comment by vbraun created at 2016-10-02 21:27:13

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2016-10-03 02:53:21

The patch bumps the version numbers of dozens of packages without making changes to them. This seems unnecessary.


---

Comment by jdemeyer created at 2016-10-03 06:03:39

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2016-10-03 06:03:39

Replying to [comment:55 mkoeppe]:
> The patch bumps the version numbers of dozens of packages without making changes to them.

This patch _does_ make implicit changes to all those `spkg-install` scripts because it changes `$PIP_INSTALL`. See [comment:21] and following.

In any case, if this is merged with  #21552, then all Python packages need to be rebuilt anyway so it wouldn't matter.


---

Comment by embray created at 2016-10-03 09:50:41

I don't personally think it's terribly important to bump all these package versions since it doesn't actually change all of them--for example packages that did not use setuptools (and thus are not installed as .egg directories) really aren't changed _at all_.  For those that are changed, this changes some small details about how they are installed, but nothing about how they run.

That said, strictly speaking, Jeroen is right that this does change runtime behavior since it will change what `sys.path` looks like.  Also nice to bump the version numbers to force all the .egg installs to be removed.


---

Comment by vbraun created at 2016-10-03 17:41:44

Resolution: fixed


---

Comment by mkoeppe created at 2016-10-03 18:16:10

OK, thanks for the explanation.
