# Issue 21204: Old version of Cython might be used

archive/issues_021204.json:
```json
{
    "body": "CC:  @embray\n\nOn a machine which had on older version of Cython installed but which was upgraded recently after #20218 was merged:\n\n```\n$ ls -ld local/lib/python/site-packages/Cython*\ndrwxrwxr-x 12 jdemeyer jdemeyer 4096 Sep  6 21:23 local/lib/python/site-packages/Cython\ndrwxrwxr-x  5 jdemeyer jdemeyer 4096 Sep  6 21:22 local/lib/python/site-packages/Cython-0.23.3-py2.7-linux-i686.egg\ndrwxrwxr-x  2 jdemeyer jdemeyer 4096 Sep  6 21:14 local/lib/python/site-packages/Cython-0.24.1-py2.7.egg-info\n```\n\n\n\n```\n>>> import Cython\n>>> Cython.__version__\n'0.23.3'\n>>> import sys\n>>> [x for x in sys.path if 'Cython' in x]\n['/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-i686.egg']\n```\n\n\nThis causes breakage when building the Sage library.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21441\n\n",
    "created_at": "2016-09-06T20:28:34Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Old version of Cython might be used",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21204",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @embray

On a machine which had on older version of Cython installed but which was upgraded recently after #20218 was merged:

```
$ ls -ld local/lib/python/site-packages/Cython*
drwxrwxr-x 12 jdemeyer jdemeyer 4096 Sep  6 21:23 local/lib/python/site-packages/Cython
drwxrwxr-x  5 jdemeyer jdemeyer 4096 Sep  6 21:22 local/lib/python/site-packages/Cython-0.23.3-py2.7-linux-i686.egg
drwxrwxr-x  2 jdemeyer jdemeyer 4096 Sep  6 21:14 local/lib/python/site-packages/Cython-0.24.1-py2.7.egg-info
```



```
>>> import Cython
>>> Cython.__version__
'0.23.3'
>>> import sys
>>> [x for x in sys.path if 'Cython' in x]
['/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-i686.egg']
```


This causes breakage when building the Sage library.

Issue created by migration from https://trac.sagemath.org/ticket/21441





---

archive/issue_comments_293677.json:
```json
{
    "body": "Wow, I see the issue.  When you use pip with the `--ignore-installed` option it also does not uninstall existing versions of the package (at the very least if it's an old .egg).  I would say that's undocumented behavior.",
    "created_at": "2016-09-07T09:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293677",
    "user": "https://github.com/embray"
}
```

Wow, I see the issue.  When you use pip with the `--ignore-installed` option it also does not uninstall existing versions of the package (at the very least if it's an old .egg).  I would say that's undocumented behavior.



---

archive/issue_comments_293678.json:
```json
{
    "body": "I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.  That will also make `./sage -f` work properly since it will force reinstall of the package even if the same version was already installed.",
    "created_at": "2016-09-07T09:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293678",
    "user": "https://github.com/embray"
}
```

I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.  That will also make `./sage -f` work properly since it will force reinstall of the package even if the same version was already installed.



---

archive/issue_comments_293679.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.\n\nThat is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.\n\nOther than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.",
    "created_at": "2016-09-07T12:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293679",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 embray]:
> I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.

That is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.

Other than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.



---

archive/issue_comments_293680.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Replying to [comment:6 embray]:\n> > I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.\n> \n> That is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.\n\nFair point.  A broader idea I had is that as many of the `spkg-install`s (but not all!) have sections for uninstalling previous installations, that step should maybe be broken out to a separate `spkg-uninstall` script.  Another step in making the packages a little more uniform in how they are managed.  But my hope was to find a simple way to address this specific issue *now*.\n\nI'm sort of of the mind that `pip uninstall .` *should* work.  If there's a local `setup.py` it should use that to figure out the package's name, and then uninstall that.  \n\n> Other than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.\n\nI don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.  It seems that `--ignore-installed` is just very literal in its intent.  It really means \"pay no attention whatsoever to what I already have installed\".",
    "created_at": "2016-09-07T13:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293680",
    "user": "https://github.com/embray"
}
```

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 embray]:
> > I think the easiest thing to do for now would be to make `PIP_INSTALL` point to a little wrapper function that also forcibly calls `pip uninstall`.
> 
> That is not entirely trivial because you need to figure out which package to uninstall. You cannot do `pip uninstall .`, you need something like `pip uninstall $PKGNAME`.

Fair point.  A broader idea I had is that as many of the `spkg-install`s (but not all!) have sections for uninstalling previous installations, that step should maybe be broken out to a separate `spkg-uninstall` script.  Another step in making the packages a little more uniform in how they are managed.  But my hope was to find a simple way to address this specific issue *now*.

I'm sort of of the mind that `pip uninstall .` *should* work.  If there's a local `setup.py` it should use that to figure out the package's name, and then uninstall that.  

> Other than that, I like the idea. We could probably drop the `--ignore-installed --no-deps` options too.

I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.  It seems that `--ignore-installed` is just very literal in its intent.  It really means "pay no attention whatsoever to what I already have installed".



---

archive/issue_comments_293681.json:
```json
{
    "body": "I think what pip really needs here is an option to *explicitly* ensure that conflicting packages are uninstalled, even if I said `--ignore-installed`.",
    "created_at": "2016-09-07T13:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293681",
    "user": "https://github.com/embray"
}
```

I think what pip really needs here is an option to *explicitly* ensure that conflicting packages are uninstalled, even if I said `--ignore-installed`.



---

archive/issue_comments_293682.json:
```json
{
    "body": "Here's an initial stab at a fix.  Adds a new `sage-pip-install` script to wrap `pip`, since otherwise this got too unwieldy.  It just ensures that any previous installations of the package are thoroughly uninstalled before the actual `pip install` call.\n\nIn the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name (if it prints anything else it should be to stderr).  This is easy enough to work around, but I wonder what other packages make this mistake, and I'm testing for that now...\n----\nNew commits:",
    "created_at": "2016-09-07T14:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293682",
    "user": "https://github.com/embray"
}
```

Here's an initial stab at a fix.  Adds a new `sage-pip-install` script to wrap `pip`, since otherwise this got too unwieldy.  It just ensures that any previous installations of the package are thoroughly uninstalled before the actual `pip install` call.

In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name (if it prints anything else it should be to stderr).  This is easy enough to work around, but I wonder what other packages make this mistake, and I'm testing for that now...
----
New commits:



---

archive/issue_comments_293683.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-07T14:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-07T14:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293685.json:
```json
{
    "body": "`#!/bin/bash` should be `#!/usr/bin/env bash`",
    "created_at": "2016-09-08T06:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293685",
    "user": "https://github.com/jdemeyer"
}
```

`#!/bin/bash` should be `#!/usr/bin/env bash`



---

archive/issue_comments_293686.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.\n\nThe whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.",
    "created_at": "2016-09-08T06:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293686",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 embray]:
> I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.

The whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.



---

archive/issue_comments_293687.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name\n\nIs Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.",
    "created_at": "2016-09-08T07:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293687",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 embray]:
> In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name

Is Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.



---

archive/issue_comments_293688.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> `#!/bin/bash` should be `#!/usr/bin/env bash`\n\nSure, will do.",
    "created_at": "2016-09-09T08:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293688",
    "user": "https://github.com/embray"
}
```

Replying to [comment:13 jdemeyer]:
> `#!/bin/bash` should be `#!/usr/bin/env bash`

Sure, will do.



---

archive/issue_comments_293689.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Replying to [comment:8 embray]:\n> > I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.\n> \n> The whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.\n\nThat makes sense.  I think for the purposes of this ticket we shouldn't mess with it though--it's already working as is (minus this issue).  I'd rather get the uninstallation fixed, and then worry about further tweaking the install options.\n\nI'm also going to write up something about this experience for the pip mailing list.  As `pip` is now the de-facto installer for Python packages it ought to be easier for system integrators to control it a bit (though I still maintain that as system integrators dependency management is our job, not pip's).",
    "created_at": "2016-09-09T08:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293689",
    "user": "https://github.com/embray"
}
```

Replying to [comment:14 jdemeyer]:
> Replying to [comment:8 embray]:
> > I don't know what you mean here.  If `--ignore-installed` is dropped then it's a moot point.  pip will uninstall the previous version of the package without that flag.
> 
> The whole point of adding `--ignored-installed` in #20218 was to fix cases of existing but broken installations. Those would now be uninstalled anyway, so you no longer need the `--ignore-installed` flag. And once you do that, you can drop `--no-deps` to enable dependency checking.

That makes sense.  I think for the purposes of this ticket we shouldn't mess with it though--it's already working as is (minus this issue).  I'd rather get the uninstallation fixed, and then worry about further tweaking the install options.

I'm also going to write up something about this experience for the pip mailing list.  As `pip` is now the de-facto installer for Python packages it ought to be easier for system integrators to control it a bit (though I still maintain that as system integrators dependency management is our job, not pip's).



---

archive/issue_comments_293690.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Replying to [comment:10 embray]:\n> > In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name\n> \n> Is Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.\n\nThere are a few others I've found:\n\n* pari_jupyter\n* widgetsnbextension\n* giacpy\n* matplotlib\n\nI've already opened an issue for matplotlib, though I don't have a patch.  I think the check is good to leave in even if these are fixed because you never know when another package is going to be added, or updated in such a way that it breaks this.",
    "created_at": "2016-09-09T08:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293690",
    "user": "https://github.com/embray"
}
```

Replying to [comment:15 jdemeyer]:
> Replying to [comment:10 embray]:
> > In the process I found out that Cython's `setup.py` is badly behaved--`./setup.py --name` should really *only* print the package's name
> 
> Is Cython the only misbehaving package? If so, I would rather add https://github.com/cython/cython/pull/1455 in order to simplify `sage-pip-install`.

There are a few others I've found:

* pari_jupyter
* widgetsnbextension
* giacpy
* matplotlib

I've already opened an issue for matplotlib, though I don't have a patch.  I think the check is good to leave in even if these are fixed because you never know when another package is going to be added, or updated in such a way that it breaks this.



---

archive/issue_comments_293691.json:
```json
{
    "body": "I see. For `pari_jupyter`, I need Cython 0.25 to fix that: https://github.com/jdemeyer/pari_jupyter/pull/1",
    "created_at": "2016-09-09T08:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293691",
    "user": "https://github.com/jdemeyer"
}
```

I see. For `pari_jupyter`, I need Cython 0.25 to fix that: https://github.com/jdemeyer/pari_jupyter/pull/1



---

archive/issue_comments_293692.json:
```json
{
    "body": "Erik, I agree with everything you said. Remember to fix [comment:13] and set this to needs review when you feel like it is ready.",
    "created_at": "2016-09-09T08:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293692",
    "user": "https://github.com/jdemeyer"
}
```

Erik, I agree with everything you said. Remember to fix [comment:13] and set this to needs review when you feel like it is ready.



---

archive/issue_comments_293693.json:
```json
{
    "body": "Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.",
    "created_at": "2016-09-09T09:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293693",
    "user": "https://github.com/jdemeyer"
}
```

Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.



---

archive/issue_comments_293694.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.\n\nDoesn't that mean basically any package that uses pip?  I avoided doing that in #20218 since there was no real change in the packages themselves.  How they are installed is changed, but it shouldn't have otherwise impacted their functionality.\n\nI'm not opposed to doing it anyways, but I'm not sure it's really needed either.",
    "created_at": "2016-09-09T12:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293694",
    "user": "https://github.com/embray"
}
```

Replying to [comment:21 jdemeyer]:
> Important: we should also bump the version number of all involved packages to force reinstalling them. Alternatively, we could also just bump the Python version. That will also force a re-installation of all Python packages in Sage.

Doesn't that mean basically any package that uses pip?  I avoided doing that in #20218 since there was no real change in the packages themselves.  How they are installed is changed, but it shouldn't have otherwise impacted their functionality.

I'm not opposed to doing it anyways, but I'm not sure it's really needed either.



---

archive/issue_comments_293695.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-09T13:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293696.json:
```json
{
    "body": "Replying to [comment:22 embray]:\n> Doesn't that mean basically any package that uses pip?\n\nYes indeed.\n\n> I avoided doing that in #20218 since there was no real change in the packages themselves.  \n\nThe *intent* was to have no real change. But this whole ticket is about an accidental change.\n\n> How they are installed is changed, but it shouldn't have otherwise impacted their functionality.\n\nGiven that the packages were installed badly, the change *does* impact the functionality.\n\nAnother example of breakage is the patchbot report of #20767: it reports a failure because the Cython update #21126 didn't work. If you don't force a rebuild, it will keep using the wrong version.",
    "created_at": "2016-09-09T13:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293696",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:22 embray]:
> Doesn't that mean basically any package that uses pip?

Yes indeed.

> I avoided doing that in #20218 since there was no real change in the packages themselves.  

The *intent* was to have no real change. But this whole ticket is about an accidental change.

> How they are installed is changed, but it shouldn't have otherwise impacted their functionality.

Given that the packages were installed badly, the change *does* impact the functionality.

Another example of breakage is the patchbot report of #20767: it reports a failure because the Cython update #21126 didn't work. If you don't force a rebuild, it will keep using the wrong version.



---

archive/issue_comments_293697.json:
```json
{
    "body": "But that was only an issue specifically because Cython was updated.  The version number of Cython was bumped, at it was reinstalled.  It just didn't uninstall the old version.  Neither the old version nor the new version were \"installed badly\" on their own--only insofar as two copies were installed.\n\nIf a package wasn't otherwise updated there's no reason to reinstall it.",
    "created_at": "2016-09-09T14:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293697",
    "user": "https://github.com/embray"
}
```

But that was only an issue specifically because Cython was updated.  The version number of Cython was bumped, at it was reinstalled.  It just didn't uninstall the old version.  Neither the old version nor the new version were "installed badly" on their own--only insofar as two copies were installed.

If a package wasn't otherwise updated there's no reason to reinstall it.



---

archive/issue_comments_293698.json:
```json
{
    "body": "Replying to [comment:25 embray]:\n> But that was only an issue specifically because Cython was updated.\n\n...in the latest beta. If you assume that people upgrade at every beta release, then you might be right. But people might have skipped some beta releases (upgrading from an older version to the current version) and then more packages might be affected. I suggest we don't guess and just upgrade all `pip`-installed packages.\n\n> Neither the old version nor the new version were \"installed badly\" on their own--only insofar as two copies were installed.\n\nRight, it wasn't \"installed badly\" in the strict sense. But still, the packages are installed badly in the sense that if you try to `import` them, you get the wrong version.",
    "created_at": "2016-09-09T19:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293698",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 embray]:
> But that was only an issue specifically because Cython was updated.

...in the latest beta. If you assume that people upgrade at every beta release, then you might be right. But people might have skipped some beta releases (upgrading from an older version to the current version) and then more packages might be affected. I suggest we don't guess and just upgrade all `pip`-installed packages.

> Neither the old version nor the new version were "installed badly" on their own--only insofar as two copies were installed.

Right, it wasn't "installed badly" in the strict sense. But still, the packages are installed badly in the sense that if you try to `import` them, you get the wrong version.



---

archive/issue_comments_293699.json:
```json
{
    "body": "Anyway, this is not something I want to fight about. My main concern is that this bug gets fixed :-)",
    "created_at": "2016-09-11T07:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293699",
    "user": "https://github.com/jdemeyer"
}
```

Anyway, this is not something I want to fight about. My main concern is that this bug gets fixed :-)



---

archive/issue_comments_293700.json:
```json
{
    "body": "I think the `pushd`/`popd` logic is not needed since this script will be run in a separate process. A simple `cd` should work.",
    "created_at": "2016-09-13T14:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293700",
    "user": "https://github.com/jdemeyer"
}
```

I think the `pushd`/`popd` logic is not needed since this script will be run in a separate process. A simple `cd` should work.



---

archive/issue_comments_293701.json:
```json
{
    "body": "Erik, do you plan to work on this or should I take over?",
    "created_at": "2016-09-18T12:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293701",
    "user": "https://github.com/jdemeyer"
}
```

Erik, do you plan to work on this or should I take over?



---

archive/issue_comments_293702.json:
```json
{
    "body": "Replying to [comment:18 embray]:\n> There are a few others I've found:\n> \n> * widgetsnbextension\n\nFor widgetsnbextension, see https://github.com/ipython/ipywidgets/pull/781",
    "created_at": "2016-09-20T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293702",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:18 embray]:
> There are a few others I've found:
> 
> * widgetsnbextension

For widgetsnbextension, see https://github.com/ipython/ipywidgets/pull/781



---

archive/issue_comments_293703.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-20T10:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293703",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_293704.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-09-20T10:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293704",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_293705.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-20T13:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293705",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293706.json:
```json
{
    "body": "I think the mass replacement of `PIP_INSTALL` with `sage-pip-install` was excessive.  I deliberately did not do that in the first place, because\n\na) I wanted to avoid another mass update of `spkg-installs` when that was already done to put `PIP_INSTALL` everywhere, and\n\nb) Leaving `PIP_INSTALL` as a variable means such mass updates can be avoided in the future.  For example, future improvements in pip itself might render the `sage-pip-install` script superfluous, at which point it might be nice to remove it.\n\nI also have ideas for more work to generalize common installation steps so that maybe many of these spkg-installs will just be pointers to a common install script for Python packages, so that will reduce duplication as well, at which point `PIP_INSTALL` might not be as useful.  But for now I think it's easier to leave it so that this can be changed in one place.",
    "created_at": "2016-09-22T16:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293706",
    "user": "https://github.com/embray"
}
```

I think the mass replacement of `PIP_INSTALL` with `sage-pip-install` was excessive.  I deliberately did not do that in the first place, because

a) I wanted to avoid another mass update of `spkg-installs` when that was already done to put `PIP_INSTALL` everywhere, and

b) Leaving `PIP_INSTALL` as a variable means such mass updates can be avoided in the future.  For example, future improvements in pip itself might render the `sage-pip-install` script superfluous, at which point it might be nice to remove it.

I also have ideas for more work to generalize common installation steps so that maybe many of these spkg-installs will just be pointers to a common install script for Python packages, so that will reduce duplication as well, at which point `PIP_INSTALL` might not be as useful.  But for now I think it's easier to leave it so that this can be changed in one place.



---

archive/issue_comments_293707.json:
```json
{
    "body": "(Also, sorry, I was on vacation last week.  No disagreement with anything else here.)",
    "created_at": "2016-09-22T16:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293707",
    "user": "https://github.com/embray"
}
```

(Also, sorry, I was on vacation last week.  No disagreement with anything else here.)



---

archive/issue_comments_293708.json:
```json
{
    "body": "To be honest, I never liked the `PIP_INSTALL` the environment variable in the first place. And if that variable would just be the name of a script, why bother with the environment variable? And mass replacements are really not a big deal, that's trivially done with some `sed` script or other tool.\n\nHowever, for the sake of peace, I don't mind to change this back if that's the only issue you have.",
    "created_at": "2016-09-22T21:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293708",
    "user": "https://github.com/jdemeyer"
}
```

To be honest, I never liked the `PIP_INSTALL` the environment variable in the first place. And if that variable would just be the name of a script, why bother with the environment variable? And mass replacements are really not a big deal, that's trivially done with some `sed` script or other tool.

However, for the sake of peace, I don't mind to change this back if that's the only issue you have.



---

archive/issue_comments_293709.json:
```json
{
    "body": "`@`embray: please clearly state what you require to set this to positive_review.",
    "created_at": "2016-09-23T09:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293709",
    "user": "https://github.com/jdemeyer"
}
```

`@`embray: please clearly state what you require to set this to positive_review.



---

archive/issue_comments_293710.json:
```json
{
    "body": "Just removing the change to `PIP_INSTALL`.\n\nI don't like adding yet another \"sage-\" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.",
    "created_at": "2016-09-23T11:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293710",
    "user": "https://github.com/embray"
}
```

Just removing the change to `PIP_INSTALL`.

I don't like adding yet another "sage-" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.



---

archive/issue_comments_293711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-09-23T12:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_293712.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> I don't like adding yet another \"sage-\" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.\n\nI would argue that adding a new environment variable in `sage-env` is uglier than a clean self-contained script. But here is what you asked for...",
    "created_at": "2016-09-23T12:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293712",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:40 embray]:
> I don't like adding yet another "sage-" script and would prefer to remove it sooner rather than later.  But for now it's the easiest solution.

I would argue that adding a new environment variable in `sage-env` is uglier than a clean self-contained script. But here is what you asked for...



---

archive/issue_comments_293713.json:
```json
{
    "body": "I wouldn't have removed the `.` either.  `sage-pip-install` takes that as an argument.  The idea was to keep the interface otherwise the same, and minimize the changes needed to work around this issue, which I think represents deficiencies in pip more than anything else.",
    "created_at": "2016-09-23T12:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293713",
    "user": "https://github.com/embray"
}
```

I wouldn't have removed the `.` either.  `sage-pip-install` takes that as an argument.  The idea was to keep the interface otherwise the same, and minimize the changes needed to work around this issue, which I think represents deficiencies in pip more than anything else.



---

archive/issue_comments_293714.json:
```json
{
    "body": "Replying to [comment:43 embray]:\n> I wouldn't have removed the `.` either.\n\nI know. However, Sage *only* uses `.` as directory, so I didn't see the point of supporting a directory argument (it's extra complexity without a use case). We could also keep the `.` and just ignore it in `sage-pip-install`, but that looked like a worse solution.",
    "created_at": "2016-09-23T12:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293714",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:43 embray]:
> I wouldn't have removed the `.` either.

I know. However, Sage *only* uses `.` as directory, so I didn't see the point of supporting a directory argument (it's extra complexity without a use case). We could also keep the `.` and just ignore it in `sage-pip-install`, but that looked like a worse solution.



---

archive/issue_comments_293715.json:
```json
{
    "body": "(I do agree having it as an environment variable sucks--in the future we'll want to redo how `spkg-install` works so that it instead sources what it needs instead of relying as much on environment variables).",
    "created_at": "2016-09-23T12:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293715",
    "user": "https://github.com/embray"
}
```

(I do agree having it as an environment variable sucks--in the future we'll want to redo how `spkg-install` works so that it instead sources what it needs instead of relying as much on environment variables).



---

archive/issue_comments_293716.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-29T14:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293716",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293717.json:
```json
{
    "body": "See above.",
    "created_at": "2016-09-29T14:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293717",
    "user": "https://github.com/embray"
}
```

See above.



---

archive/issue_comments_293718.json:
```json
{
    "body": "Replying to [comment:46 embray]:\n> See above.\n\nCan you give a little more detail?",
    "created_at": "2016-09-29T14:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293718",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:46 embray]:
> See above.

Can you give a little more detail?



---

archive/issue_comments_293719.json:
```json
{
    "body": "In other words: what would you like me to do concretely?",
    "created_at": "2016-09-29T14:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293719",
    "user": "https://github.com/jdemeyer"
}
```

In other words: what would you like me to do concretely?



---

archive/issue_comments_293720.json:
```json
{
    "body": "Remove any changes to `spkg-install`s.",
    "created_at": "2016-09-29T15:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293720",
    "user": "https://github.com/embray"
}
```

Remove any changes to `spkg-install`s.



---

archive/issue_comments_293721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-09-30T08:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_293722.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-30T08:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293722",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293723.json:
```json
{
    "body": "Not fully tested yet, but this reverts all changes to `spkg-install`, except for the `pip` package.",
    "created_at": "2016-09-30T08:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293723",
    "user": "https://github.com/jdemeyer"
}
```

Not fully tested yet, but this reverts all changes to `spkg-install`, except for the `pip` package.



---

archive/issue_comments_293724.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-30T10:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293724",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_293725.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2016-09-30T10:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293725",
    "user": "https://github.com/embray"
}
```

Looks good to me.



---

archive/issue_comments_293726.json:
```json
{
    "body": "Reviewer name...",
    "created_at": "2016-10-02T17:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293726",
    "user": "https://github.com/vbraun"
}
```

Reviewer name...



---

archive/issue_comments_293727.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-02T21:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293727",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_293728.json:
```json
{
    "body": "The patch bumps the version numbers of dozens of packages without making changes to them. This seems unnecessary.",
    "created_at": "2016-10-03T02:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293728",
    "user": "https://github.com/mkoeppe"
}
```

The patch bumps the version numbers of dozens of packages without making changes to them. This seems unnecessary.



---

archive/issue_comments_293729.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-03T06:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293729",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_293730.json:
```json
{
    "body": "Replying to [comment:55 mkoeppe]:\n> The patch bumps the version numbers of dozens of packages without making changes to them.\n\nThis patch *does* make implicit changes to all those `spkg-install` scripts because it changes `$PIP_INSTALL`. See [comment:21] and following.\n\nIn any case, if this is merged with  #21552, then all Python packages need to be rebuilt anyway so it wouldn't matter.",
    "created_at": "2016-10-03T06:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293730",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:55 mkoeppe]:
> The patch bumps the version numbers of dozens of packages without making changes to them.

This patch *does* make implicit changes to all those `spkg-install` scripts because it changes `$PIP_INSTALL`. See [comment:21] and following.

In any case, if this is merged with  #21552, then all Python packages need to be rebuilt anyway so it wouldn't matter.



---

archive/issue_comments_293731.json:
```json
{
    "body": "I don't personally think it's terribly important to bump all these package versions since it doesn't actually change all of them--for example packages that did not use setuptools (and thus are not installed as .egg directories) really aren't changed *at all*.  For those that are changed, this changes some small details about how they are installed, but nothing about how they run.\n\nThat said, strictly speaking, Jeroen is right that this does change runtime behavior since it will change what `sys.path` looks like.  Also nice to bump the version numbers to force all the .egg installs to be removed.",
    "created_at": "2016-10-03T09:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293731",
    "user": "https://github.com/embray"
}
```

I don't personally think it's terribly important to bump all these package versions since it doesn't actually change all of them--for example packages that did not use setuptools (and thus are not installed as .egg directories) really aren't changed *at all*.  For those that are changed, this changes some small details about how they are installed, but nothing about how they run.

That said, strictly speaking, Jeroen is right that this does change runtime behavior since it will change what `sys.path` looks like.  Also nice to bump the version numbers to force all the .egg installs to be removed.



---

archive/issue_events_020076.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2016-10-03T17:41:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21204#event-20076"
}
```



---

archive/issue_comments_293732.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-03T17:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293732",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_293733.json:
```json
{
    "body": "OK, thanks for the explanation.",
    "created_at": "2016-10-03T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21204#issuecomment-293733",
    "user": "https://github.com/mkoeppe"
}
```

OK, thanks for the explanation.
