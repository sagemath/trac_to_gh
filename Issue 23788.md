# Issue 23788: Update simple autotools packages to use sdh_configure and related helpers

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-10-12 15:16:54

These are packages that use standard autoconf builds (configure && make && make install) that could be easily updated to use the corresponding helper functions, as explained in #24024.

This ticket updates a large number of packages, but the change to all of them is nearly identical.


---

Comment by embray created at 2017-10-12 15:17:16

I'm going to check to see if there are any other open tickets this conflicts with before setting it ready for review.


---

Comment by embray created at 2017-10-12 15:19:14

This is also based on a couple other pending tickets.


---

Comment by jdemeyer created at 2017-10-12 19:21:23

Note: we need to check the portability of `cp -L` on OS X which does not have GNU tools.


---

Comment by jhpalmieri created at 2017-10-12 19:53:23

The man page for `cp` on OS X says:

```
-L    If the -R option is specified, all symbolic links are followed.
```



---

Comment by jdemeyer created at 2017-10-12 20:55:52

Looks good in principle, but I'm sure that there are details to be checked and fixed.


---

Comment by embray created at 2017-10-13 08:31:18

Replying to [comment:3 jdemeyer]:
> Note: we need to check the portability of `cp -L` on OS X which does not have GNU tools.

I did check that. Also that comes from #23781.  This ticket depends on 3 others so it would be best for those to be merged before reviewing this one.  This ticket _only_ changes the `spkg-` scripts of some packages.  Note, you can always manually do a diff as well.


---

Comment by embray created at 2017-10-13 08:33:21

Replying to [comment:5 jdemeyer]:
> Looks good in principle, but I'm sure that there are details to be checked and fixed.

Are you?  I'll note that these changes are all extracted from #22509 which I'm working on breaking up into multiple smaller steps, but the branch in #22509 has already gone through quite a lot of testing.

The only thing I'm sure of is it's worth checking what open tickets this conflicts with, of which I'm sure there are some.


---

Comment by git created at 2017-10-26 13:41:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-10-26 13:42:31

Changing status from new to needs_review.


---

Comment by embray created at 2017-10-26 13:43:52

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-26 13:43:52

Oops, rebase is messed up...


---

Comment by git created at 2017-10-26 13:45:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-10-26 13:48:51

Okay, there we go.

This ticket unfortunately touches a large number of files, but I don't see a much better way to do it other than to create separate tickets for each package, which quickly becomes tedious.  The subset of packages updated by this ticket was specifically selected because they required no additional changes other than mechanical replacement of `./configure` with `sdh_configure` and so on (and in the case of brial, one use of `sdh_pip_install` as well).

Some other packages will be addressed in followup tickets.


---

Comment by embray created at 2017-10-26 13:48:51

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-26 13:51:10

One question remains whether we need to update the patch level on these packages.  I think it's a bit excessive, because the point of focusing on this subset of packages is that the replacement by the helper functions results in almost the exact same build scripts as before.  But I'm not outright opposed.


---

Comment by embray created at 2017-10-26 13:51:10

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-26 13:59:58

Didn't mean to change the status.


---

Comment by embray created at 2017-10-26 13:59:58

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2017-10-26 21:42:25

That will clash with #24092 (which you happily reviewed). I am sorry, can you make it yet another dependency of this ticket?


---

Comment by fbissey created at 2017-10-26 21:42:25

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-27 12:22:53

Replying to [comment:15 fbissey]:
> That will clash with #24092 (which you happily reviewed). I am sorry, can you make it yet another dependency of this ticket?

Sure, of course.  Thanks for pointing it out.  I'm trying to track down any other currently active tickets this might clash with.


---

Comment by git created at 2017-10-27 12:38:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-27 12:38:26

Fully incorporated fix from #24092.


---

Comment by embray created at 2017-10-27 12:48:54

Okay--hard to be _exactly_ sure, but I don't think there are any other imminent tickets this conflicts with, so the sooner it can be applied the better, if indeed it's acceptable.


---

Comment by embray created at 2017-10-27 12:48:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-10-27 13:19:52

I would rather prefer to see all those packages receiving a version bump, to avoid trouble.

Also, some random quick comments:

1. `libfplll`: conflicts with #24042: just postpone `libfplll` to a new ticket.

2. `libpng`: I don't want to think about `$DESTDIR` for now, please revert that.

3. `mpfr`: one `./configure` command is intentionally not checked I believe.

4. `ppl`: just use `./configure` instead of `sdh_configure` if you don't want the functionality of `sdh_configure`.

5. `zlib`: use `ZLIB_CONFIGURE` instead of `CONFIGUREFLAGS` to be consistent with other packages.

If you disagree with any of the above, I would much rather prefer to postpone the given package to a new ticket and only deal on this ticket with the packages where we agree. Otherwise we will never make progress.


---

Comment by embray created at 2017-10-27 14:01:51

Replying to [comment:21 jdemeyer]:
> I would rather prefer to see all those packages receiving a version bump, to avoid trouble.

Okay--that will probably introduce more potential conflicts though; e.g. with #23700.  I could postpone some of those, or help get those tickets done more quickly if possible...

> Also, some random quick comments:
> 
> 1. `libfplll`: conflicts with #24042: just postpone `libfplll` to a new ticket.

I don't see any reason to postpone it to a new ticket.  In particular, since #24042 is already closed I can just merge it into this.
 
> 2. `libpng`: I don't want to think about `$DESTDIR` for now, please revert that.

Oops--yes, my intention was to leave out anything to do with DESTDIR.  I missed that one.

> 3. `mpfr`: one `./configure` command is intentionally not checked I believe.

Right--I think originally I had that correct, but when I was checking this patch over I initially thought it was something I missed and updated it.  Now you've reminded me that it was intentionally allowed to fail.

> 4. `ppl`: just use `./configure` instead of `sdh_configure` if you don't want the functionality of `sdh_configure`.

The functionality of `sdh_configure` isn't just the error checking.  But I'll see if there's a different approach I can take to that case that doesn't require a sub-shell.  Maybe I'll leave ppl and mpfr out of this ticket for now.

> 5. `zlib`: use `ZLIB_CONFIGURE` instead of `CONFIGUREFLAGS` to be consistent with other packages.

+1

> If you disagree with any of the above, I would much rather prefer to postpone the given package to a new ticket and only deal on this ticket with the packages where we agree. Otherwise we will never make progress.

Agreed--with the exception of `libfplll` where I'm not sure why you propose a separate ticket.


---

Comment by git created at 2017-10-27 14:22:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-27 14:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-27 14:25:34

Also merged in #24042.


---

Comment by embray created at 2017-10-27 14:26:56

Jeroen, how does this sound to you?  I think I addressed all your comments--I excluded ppl and mpfr from this ticket for now, until I decide what to do there, and I have also removed updates to gc and curl in order to avoid conflicts, for now, with other tickets that update them.


---

Comment by git created at 2017-10-31 15:13:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-31 15:15:18

The problem here was a missing change to the definition of `sdh_configure` that I originally included in #22509.  This is part of the problem with taking a large commit that works fine and trying to chop it down piecemeal...


---

Comment by fbissey created at 2017-11-08 22:57:36

Replying to [comment:27 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[d094602](https://git.sagemath.org/sage.git/commit/?id=d09460226e0494a8c2f14ca40132dbd4ded77f54)||`Force the libdir option to $SAGE_LOCAL/lib for all packages that call sdh_configure`||

I am wondering if this could be split and included quickly. That way, separately from a big push for all packages I and other can already start migrating when upgrading packages. 

For example I am thinking on working on #22836 - it will conflict with this ticket. But instead of just upgrading I think I could use the opportunity to migrate. It would be more useful if the above commit was already available.


---

Comment by embray created at 2017-11-09 10:22:59

Let me rebase it and figure out what the issue is with building flint, which is still broken for some reason.  But I agree this should be high priority to merge.


---

Comment by embray created at 2017-11-09 10:22:59

Changing priority from major to critical.


---

Comment by git created at 2017-11-10 12:58:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-11-10 13:01:44

It turns out that flint is not actually a real autoconf'd package, and has a hand-written custom `configure` script which doesn't support `--libdir`.

I might do something about that, but in the meantime it should be dropped from this ticket.


---

Comment by jdemeyer created at 2017-11-12 08:38:28

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-11-12 08:38:28

Squashed most commits together and reverted zlib.
----
New commits:


---

Comment by embray created at 2017-11-13 11:46:07

Changing status from positive_review to needs_info.


---

Comment by embray created at 2017-11-13 11:46:07

Why "reverted zlib"?  I don't see any problems there.


---

Comment by embray created at 2017-11-13 11:50:34

Please don't unilaterally replace my branch with yours without discussion if it's making non-trivial changes.
----
New commits:


---

Comment by jdemeyer created at 2017-11-13 11:53:36

First of all, I think it is a bad idea to change a ticket back to positive_review just because of that question. As I explained in [comment:21], we have the most chances of actually making progress if we try to merge what we can and postpone more difficult packages.

Giving positive_review to a part of a ticket which makes sense by itself is something that I have done before and I honestly don't see the problem.

My goal is to actually merge this ticket and I don't understand why you are going against that.


---

Comment by jdemeyer created at 2017-11-13 11:59:31

Replying to [comment:35 embray]:
> Why "reverted zlib"?

There looks to be an issue with quoting (`"` quotes nested inside `"` quotes). I thought I commented on this already, but I see now that I haven't. Anyway, I'm done with reviewing this ticket.


---

Comment by embray created at 2017-11-13 12:05:14

> Giving positive_review to a part of a ticket which makes sense by itself is something that I have done before and I honestly don't see the problem.

Because you made changes and then set it to "positive review" without consulting.  If anything you should have then set it to "needs review" so that I could review _your_ changes.  Otherwise something that I didn't intend might end up getting merged.  It's just presumptuous.

I don't know what issue with zlib you're talking about.  I can't reproduce it.  Maybe if there really is an issue it would be simpler for me to fix it than to just revert the change entirely.


---

Comment by git created at 2017-11-13 12:14:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-13 12:16:01

Replying to [comment:39 embray]:
> Because you made changes and then set it to "positive review" without consulting.

I wouldn't call it making changes. Essentially, you propose A, B, C and D and I agree with A, B and C but not with D. So instead of having a discussion about D, I simply say: let's merge A, B and C right now and postpone D. I don't see any problem here.


---

Comment by embray created at 2017-11-13 12:16:07

Changing status from needs_info to positive_review.


---

Comment by embray created at 2017-11-13 12:16:07

Ah, I see--you're talking about the double quotes inside the assignment of `ZLIB_CONFIGURE`.  You could've just said so.  Although it didn't seem to cause any harm it was obviously a mistake; a simple bug.  I've removed the `--includedir` flag entirely from that line since it was superfluous anyways.
----
New commits:


---

Comment by embray created at 2017-11-13 12:16:57

Replying to [comment:41 jdemeyer]:
> Replying to [comment:39 embray]:
> > Because you made changes and then set it to "positive review" without consulting.
> 
> I wouldn't call it making changes. Essentially, you propose A, B, C and D and I agree with A, B and C but not with D. So instead of having a discussion about D, I simply say: let's merge A, B and C right now and postpone D. I don't see any problem here.

There'd be less problem if some reasonable explanation were given.


---

Comment by embray created at 2017-11-13 12:18:04

It's also sneaky since the change was rolled into a squashed commit.  In this case it could be very easy for me to miss, since I already have other branches where I've done further work on this.


---

Comment by chapoton created at 2017-11-15 12:21:25

reviewer name, please


---

Comment by vbraun created at 2017-12-02 23:36:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-12-02 23:36:37

merge conflict


---

Comment by jdemeyer created at 2017-12-04 10:38:08

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2017-12-04 10:38:08

New commits:


---

Comment by vbraun created at 2017-12-11 01:04:11

Resolution: fixed


---

Comment by jdemeyer created at 2017-12-11 10:09:47

Great!


---

Comment by dimpase created at 2018-01-06 12:46:14

I am confused - where are all these `sdh_make`, `sdh_confugure` etc scripts located ?


---

Comment by dimpase created at 2018-01-06 14:45:00

facepalm - sdh==sage-dist-helpers, see #23160
