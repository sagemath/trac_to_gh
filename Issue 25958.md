# Issue 25958: Tate algebras

Issue created by migration from Trac.

Original creator: caruso

Original creation time: 2018-09-05 11:22:51

CC:  tristanvaccon @thibautverron caruso roed

We propose to implement Tate algebras over complete discrete valuation rings/fields.


---

Comment by git created at 2018-09-06 14:43:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-06 15:21:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-06 15:51:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @ThibautVerron created at 2018-09-06 16:06:07

New commits:


---

Comment by git created at 2018-09-07 09:25:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-07 09:29:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-07 18:23:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-08 09:44:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 00:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-10 07:39:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-11 16:08:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-12 11:46:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-12 13:32:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-13 12:56:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-13 19:30:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-14 15:10:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-19 15:15:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-20 09:09:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-20 12:06:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-20 21:23:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-20 22:20:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-21 06:11:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-22 22:15:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-25 12:07:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-25 13:35:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-09-26 09:22:57

I cc roed because, David, you might know the answer at the following question.

In this ticket, we have implemented two parents, the first one for the Tate algebra itself and the second one for the monoid of terms of the Tate Algebra. Here is a basic example:


```
sage: A.<x,y> = TateAlgebra(Zp(2)); A
Tate Algebra in x (val >= 0), y (val >= 0) over 2-adic Field with capped relative precision 20
sage: T = A.monoid_of_terms(); T
Monoid of terms in x (val >= 0), y (val >= 0) over 2-adic Field with capped relative precision 20
```


We now want to add a method for recovering `A` (the Tate algebra) from `T` (the monoid of terms). However a method `algebra` already exists: it is inherited from `sage.categories.sets_cat.Sets` and provides a very general construction of an algebra over an arbitrary set.
We believe that this general construction is not very relevant in our setting and that `T.algebra()` should instead output `A`. So our question is: is it allowed/appropriate to override the method `algebra` (keeping in mind that it comes from the category machinery)? 

In any case, we will create a method `tate_algebra` but we think that having `algebra` at the same time (with a different behavior) could be confusing.


---

Comment by tscrim created at 2018-09-26 09:35:18

Yes, you are allowed (maybe even encouraged) to override `algebra`, and in this case, you should because you have a specialized implementation of the algebra.

Also, I want to just point out a common idiom that we've used is to define the monoid of monomials, then use `CombinatorialFreeModule` and the category of `AlgebrasWithBasis` to construct the corresponding algebra by implementing `product_on_basis`. Although this has been known to have some issues with overhead due to the number of indirections (which can be mitigated by directly implementing the multiplication in the element class), and this might not work for what you need.


---

Comment by git created at 2018-09-26 13:37:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-26 14:17:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-27 08:38:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-30 00:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-30 15:08:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-09-30 15:09:47

Changing status from new to needs_review.


---

Comment by git created at 2018-09-30 15:13:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-30 15:36:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-01 06:08:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-15 21:50:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-16 08:10:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-16 13:02:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-16 14:30:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-17 05:10:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-17 08:09:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-17 11:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-17 11:46:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-19 08:35:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-10-19 08:44:06

I wanted to point out a couple of points:

- for the methods `log` and `exp`, I essentially copy the code in `sage.rings.padics.padic_element_generic`; so I wonder if it would be a good idea to factorize this code. One solution would be to split the current class `pAdicElementGeneric` into two parts (e.g `pAdicElementGeneric` and `pAdicNumberGeneric`), the second one inheriting from the first one, and let Tate series derive from the most general one.

- in the method `lift_to_precision`, I defined a nested function `lift_without_error` but I think it would be better to add a keyword argument `no_error` (or something like that) to `lift_to_precision` (for p-adic number); what's your opinion?


---

Comment by git created at 2018-10-19 11:58:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-20 09:21:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-01 22:09:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-01 22:33:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-11-02 17:34:51

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-11-02 17:34:51

Looks good!


---

Comment by vbraun created at 2018-11-07 11:28:13

Resolution: fixed


---

Comment by chapoton created at 2018-11-12 20:07:37

Tate algebras elements are now among the 10 files having the most failures with python3. See #26212.

EDIT:
And this is also bad:

```
sage -t --long src/sage/rings/tate_algebra_ideal.pyx  # 29 doctests failed
```


One example of failure: bad use of range:

```
File "sage/rings/tate_algebra_ideal.pyx", line 83, in sage.rings.tate_algebra_ideal._groebner_basis_buchberger (build/cythonized/sage/rings/tate_algebra_ideal.c:3488)
        indices = range(l)
    TypeError: Expected list, got range
```


Other failure: change dict while iterating over this dict:

```
      File "sage/rings/tate_algebra_element.pyx", line 1151, in sage.rings.tate_algebra_element.TateAlgebraElement._normalize (build/cythonized/sage/rings/tate_algebra_element.c:12421)
        for (e,c) in self._poly.__repn.items():
    RuntimeError: dictionary changed size during iteration
```



---

Comment by chapoton created at 2018-11-13 12:49:07

python3 problems are fixed in #26692, please review


---

Comment by roed created at 2018-11-13 19:15:36

Sorry about that!  I didn't see any py3 failures on the patchbot, so I thought it was okay.  I've got a py3 build, so I'll try to check big tickets there from now on.


---

Comment by jdemeyer created at 2018-12-01 11:41:09

This should be fixed:

```
[288/306] Cythonizing sage/rings/tate_algebra_element.pyx
warning: sage/rings/tate_algebra_element.pyx:301:10: Compatible but non-identical C method '_mul_' not redeclared in definition part of extension type 'TateAlgebraTerm'.  This may cause incorrect vtables to be generated.
warning: sage/structure/element.pxd:188:15: Previous declaration is here
```



---

Comment by jdemeyer created at 2018-12-01 11:42:47

Essentially, you're missing a declaration for `cpdef _mul_` in `tate_algebra_element.pxd`


---

Comment by jdemeyer created at 2018-12-01 11:47:55

There are also some thing I consider bad style, for example

```
    `@`coerce_binop
    def __floordiv__(self, other):
```

Why not use `_floordiv_` from the coercion model?

There is also the inefficient

```
from sage.structure.richcmp import op_EQ, op_NE, op_LT, op_GT, op_LE, op_GE
```

which should be

```
from cpython.object cimport Py_LT, Py_LE, Py_EQ, Py_NE, Py_GT, Py_GE
```



---

Comment by jdemeyer created at 2018-12-01 11:49:21

And isn't `_pushout_family()` really just `coercion_model.common_parent()`?


---

Comment by jdemeyer created at 2018-12-01 11:51:42

This is reinventing `sage.structure.richcmp.rich_to_bool`:

```
        if op == op_LT:
            return c < 0
        if op == op_LE:
            return c <= 0
        if op == op_GT:
            return c > 0
        if op == op_GE:
            return c >= 0
```



---

Comment by caruso created at 2018-12-03 20:10:03

Thanks Jeroen for your useful comments!

I addressed all of them except this one:
> And isn't `_pushout_family()` really just `coercion_model.common_parent()`?
because I'm not sure that `_pushout_family()` and `coercion_model.common_parent()` do the same job. At least if I replace the code of `_pushout_family()` by:

```
    elements = [initial] + list(elements)
    return coercion_model.common_parent(*elements)
```

I get many doctest failures.


---

Comment by caruso created at 2018-12-03 20:16:11

cf ticket #26807
