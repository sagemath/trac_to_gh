# Issue 31794: patchbots fail to build mpmath

Issue created by migration from https://trac.sagemath.org/ticket/32031

Original creator: tmonteil

Original creation time: 2021-06-22 08:45:14

CC:  dimpase mkoeppe @rocky fbissey isuruf @kliem

See https://patchbot.sagemath.org/ticket/0/

Possibly related to `pip` and `setuptools_scm`.


---

Comment by mkoeppe created at 2021-06-22 13:16:58


```
[mpmath-1.2.1]     ERROR: Could not find a version that satisfies the requirement setuptools_scm>=1.7.0 (from versions: none)
[mpmath-1.2.1]     ERROR: No matching distribution found for setuptools_scm>=1.7.0
[mpmath-1.2.1]     Traceback (most recent call last):
[mpmath-1.2.1]       File "/home/chapoton/sage/local/lib/python3.9/site-packages/setuptools/installer.py", line 75, in fetch_build_egg
[mpmath-1.2.1]         subprocess.check_call(cmd)
[mpmath-1.2.1]       File "/usr/lib/python3.9/subprocess.py", line 373, in check_call
[mpmath-1.2.1]         raise CalledProcessError(retcode, cmd)
[mpmath-1.2.1]     subprocess.CalledProcessError: Command '['/home/chapoton/sage/local/bin/python3', '-m', 'pip', '--disable-pip-version-check', 'wheel', '--no-deps', '-w', '/tmp/tmpqau7q1i8', '--quiet', 'setuptools_scm>=1.7.0']' returned non-zero exit status 1.
```


Despite the dependencies declared in `build/pkgs/mpmath/dependencies`, it seems `setuptools_scm` has not been installed


---

Comment by mkoeppe created at 2021-06-22 13:22:25

Changing component from PLEASE CHANGE to build.


---

Comment by mkoeppe created at 2021-06-22 13:22:25

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-06-22 13:24:38

Something similar happened before in #31915 - are our order-only dependencies broken?


---

Comment by mkoeppe created at 2021-06-22 13:42:25

What's the version of `make` on the machines where this fails?


---

Comment by @kliem created at 2021-06-22 13:44:10


```
kliem@cofio:~/localhome/sage$ make --version
GNU Make 4.2.1
Built for x86_64-pc-linux-gnu
Copyright (C) 1988-2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```



---

Comment by mkoeppe created at 2021-06-22 13:46:53

It would be helpful to use `make --debug=all` to see what's happening with the dependencies.


---

Comment by @kliem created at 2021-06-22 13:47:55

Ok. So what part do I need to rebuilt then?


---

Comment by mkoeppe created at 2021-06-22 13:50:52

I'd say do `make setuptools_scm-clean mpmath-clean` and then run `make --debug=all mpmath`


---

Comment by mkoeppe created at 2021-06-22 13:52:12

My guess is that #29013 (merged in 9.4.beta0) somehow managed to break order-only dependencies


---

Comment by @kliem created at 2021-06-22 13:55:20

Well it fixed it. Thanks. But now I'm confused and I don't know what happened.


---

Comment by @kliem created at 2021-06-22 14:15:55

Should I fix the patchbot like this?


---

Comment by mkoeppe created at 2021-06-22 14:16:10

Can you post the debug output please?


---

Attachment

mpmath with debug


---

Comment by mkoeppe created at 2021-06-22 15:05:07

Everything looks fine in this log...


---

Comment by @kliem created at 2021-06-22 15:52:30


```
[setuptools_scm-6.0.1] Ignoring indexes: https://pypi.org/simple
```

Could this make the difference?


---

Comment by mkoeppe created at 2021-06-22 16:03:08

"Ignoring indexes" is normal - we do not use PyPI for installing normal packages. (See `build/bin/sage-dist-helpers` (`sdh_pip_install`)


---

Comment by @rocky created at 2021-06-22 16:27:42

Replying to [comment:6 mkoeppe]:
> It would be helpful to use `make --debug=all` to see what's happening with the dependencies.

In my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better.


---

Comment by dimpase created at 2021-06-22 16:49:05

I gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.
Because if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,
as follows:

```
[mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src
[mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm
[mpmath-1.2.1]     Running command python setup.py egg_info
[mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/
```



---

Comment by @kliem created at 2021-06-22 18:08:15

That seems to be exacly the problem. Do you want to provide a branch?


---

Comment by mkoeppe created at 2021-06-22 18:30:12

Replying to [comment:16 gh-rocky]:
> Replying to [comment:6 mkoeppe]:
> > It would be helpful to use `make --debug=all` to see what's happening with the dependencies.
> 
> In my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better. 
Thanks! I'll try it out next time I feel this need


---

Comment by mkoeppe created at 2021-06-22 18:34:11

Replying to [comment:17 dimpase]:
> I gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.
> Because if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,
> as follows:
> {{{
> [mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src
> [mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm
> [mpmath-1.2.1]     Running command python setup.py egg_info
> [mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/
> }}}

After rebuilding `setuptools`, is `setuptools_scm` still present or did it somehow get lost?


---

Comment by @kliem created at 2021-06-22 18:36:35


```
ModuleNotFoundError: No module named 'setuptools_scm'
```

So somehow got lost somehow.

But `sage --standard` claims it's installed somehow.


---

Comment by mkoeppe created at 2021-06-22 18:37:49

It's bad old code at the top of `build/pkgs/setuptools/spkg-install.in`


---

Comment by mkoeppe created at 2021-06-22 18:38:16

... which just nukes everything in site-packages that starts with "setuptools". Ouch.


---

Comment by mkoeppe created at 2021-06-22 18:44:06

Try with this change please
----
New commits:


---

Comment by mkoeppe created at 2021-06-22 18:44:06

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-06-22 19:02:30

OK, this works, thanks.


---

Comment by dimpase created at 2021-06-22 19:02:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-22 19:42:32

Thanks!


---

Comment by strogdon created at 2021-06-22 20:32:55

Changing status from positive_review to needs_work.


---

Comment by strogdon created at 2021-06-22 20:32:55

This doesn't work here. After applying the patch and

```
./bootstrap
./configure
make
```

See attached mpmath and py logs.


---

Attachment


---

Comment by strogdon created at 2021-06-22 20:51:26

Changing status from needs_work to positive_review.


---

Comment by strogdon created at 2021-06-22 20:51:26

OK, doing

```
./sage -f setuptools_scm
```

fixed things.


---

Comment by vbraun created at 2021-06-29 17:39:52

Resolution: fixed
