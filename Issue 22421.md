# Issue 22421: Polyhedron methods using the polymake pexpect interface

Issue created by migration from https://trac.sagemath.org/ticket/22658

Original creator: mkoeppe

Original creation time: 2017-03-20 23:37:44

CC:  simonking jipilab vdelecroix tscrim yzh dimpase

Keywords: days84

Following up on the Polymake pexpect interface (#22452), we should make it easy to make a polymake object corresponding to a given `Polyhedron`.


---

Comment by mkoeppe created at 2017-03-21 00:15:19

I immediately ran into a problem:

```
sage: polymake.new_object("Polytope", FACETS=[[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-a71d30984154> in <module>()
      7  [Integer(0), Integer(0), Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0)],
      8  [Integer(0), Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0)],
----> 9  [Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0)]])

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in new_object(self, name, *args, **kwds)
   1201         except KeyError:
   1202             f = self.__new[name] = self._function_class()(self, "new %s"%name)
-> 1203         return f(*args, **kwds)
   1204 
   1205 polymake = Polymake()

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, *args, **kwds)
    627 
    628     def __call__(self, *args, **kwds):
--> 629         return self._parent.function_call(self._name, list(args), kwds)
    630 
    631     def _sage_doc_(self):

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in function_call(self, function, args, kwds)
    269 
    270         """
--> 271         args, kwds = self._convert_args_kwds(args, kwds)
    272         self._check_valid_function_name(function)
    273         s = self._function_call_string(function,

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/interface.pyc in _convert_args_kwds(self, args, kwds)
    512         for key, value in iteritems(kwds):
    513             if not isinstance(value, InterfaceElement) or value.parent() is not self:
--> 514                 kwds[key] = self(value)
    515 
    516         return args, kwds

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, x, name)
    270                 return cls(self, str(x), name=name)
    271             except TypeError:
--> 272                 raise TypeError(msg)
    273 
    274     def _coerce_from_special_method(self, x):

TypeError: Polymake terminated unexpectedly while reading in a large line:
reference to an undeclared variable @SAGE21 at /Users/mkoeppe/.sage/temp/campus-005-030.ucdavis.edu/69025/interface/tmp69091 line 1.
```


When I enter the same a second time, I get this interesting "recompilation failure"...


```
sage: polymake.new_object("Polytope", FACETS=[[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.py:1019: RuntimeWarning: Recompiling application common in extension /Users/mkoeppe/.polymake/wrappers.0, please be patient...
  warnings.warn(w, RuntimeWarning)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-a71d30984154> in <module>()
      7  [Integer(0), Integer(0), Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0)],
      8  [Integer(0), Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0)],
----> 9  [Integer(0), Integer(0), Integer(1), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0), Integer(0)]])

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in new_object(self, name, *args, **kwds)
   1201         except KeyError:
   1202             f = self.__new[name] = self._function_class()(self, "new %s"%name)
-> 1203         return f(*args, **kwds)
   1204 
   1205 polymake = Polymake()

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, *args, **kwds)
    627 
    628     def __call__(self, *args, **kwds):
--> 629         return self._parent.function_call(self._name, list(args), kwds)
    630 
    631     def _sage_doc_(self):

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in function_call(self, function, args, kwds)
    274                                        [s.name() for s in args],
    275                                        ['%s=>%s'%(key,value.name()) for key, value in kwds.items()])
--> 276         return self(s)
    277 
    278     def _function_call_string(self, function, args, kwds):

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, x, name)
    257 
    258         if isinstance(x, six.string_types):
--> 259             return cls(self, x, name=name)
    260         try:
    261             return self._coerce_from_special_method(x)

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/expect.pyc in __init__(self, parent, value, is_name, name)
   1386             except (RuntimeError, ValueError) as x:
   1387                 self._session_number = -1
-> 1388                 raise_(TypeError, x, sys.exc_info()[2])
   1389             except BaseException:
   1390                 self._session_number = -1

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/expect.pyc in __init__(self, parent, value, is_name, name)
   1381         else:
   1382             try:
-> 1383                 self._name = parent._create(value, name=name)
   1384             # Convert ValueError and RuntimeError to TypeError for
   1385             # coercion to work properly.

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in _create(self, value, name)
    603         """
    604         name = self._next_var_name() if name is None else name
--> 605         self.set(name, value)
    606         # If value is a list, then @name is now equal to that list.
    607         # Otherwise, value is obtained by $name[0]. So, we modify

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in set(self, var, value)
    668             value = value.strip().rstrip(';').strip()
    669         cmd = '@%s%s(%s);'%(var,self._assign_symbol(), value)
--> 670         self.eval(cmd)
    671 
    672     def get(self, cmd):

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1298                 elif split_lines:
   1299                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1300                                         for L in code.split('\n') if L != ''])
   1301                 else:
   1302                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/interfaces/polymake.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed, **kwds)
   1019             warnings.warn(w, RuntimeWarning)
   1020         for e in p_errors:
-> 1021             raise PolymakeError(e)
   1022         return out
   1023 

TypeError: Shared module compilation failed; see the error log below

/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc: In instantiation of 'static sv* polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::call(sv**, char*) [with T0 = pm::Matrix<pm::Rational>; T1 = int]':
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/perl/wrappers.h:253:21:   required from 'static void pm::perl::WrapperBase<Wrapper>::register_it(const char (&)[namelen], const char (&)[filelen], int, _app_list) [with long unsigned int namelen = 6ul; long unsigned int filelen = 72ul; _app_list = int; Wrapper = polymake::common::{anonymous}::Wrapper4perl_new_X<pm::Matrix<pm::Rational>, int>]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:10:182:   required from 'polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::Wrapper4perl_new_X(const char (&)[fl], int, first_arg_type) [with long unsigned int fl = 72ul; first_arg_type = int; T0 = pm::Matrix<pm::Rational>; T1 = int]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:15:90:   required from here
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: error: no matching function for call to 'pm::Matrix<pm::Rational>::Matrix(pm::perl::access<int, int>::return_type)'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:166:4: note: candidate: template<class Container> pm::Matrix<E>::Matrix(void*, int, int, const Container&, typename pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::enabled, typename pm::enable_if<void**, (pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::depth == 2)>::type)
    Matrix(void *place, int r, int c, const Container& src,
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:166:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   cannot convert 'arg0.pm::perl::Value::get<int>()' (type 'pm::perl::access<int, int>::return_type {aka int}') to type 'void*'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:161:4: note: candidate: template<class Iterator> pm::Matrix<E>::Matrix(void*, int, int, Iterator, typename pm::construct_cascaded_iterator<Iterator, E, pm::dense>::enabled)
    Matrix(void *place, int r, int c, Iterator src,
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:161:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   cannot convert 'arg0.pm::perl::Value::get<int>()' (type 'pm::perl::access<int, int>::return_type {aka int}') to type 'void*'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:158:4: note: candidate: pm::Matrix<E>::Matrix(void*, int, int) [with E = pm::Rational]
    Matrix(void *place, int r, int c) : base(place,r,c) {}
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:158:4: note:   candidate expects 3 arguments, 1 provided
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:151:13: note: candidate: template<class Container> pm::Matrix<E>::Matrix(const Container&, typename pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::enabled, typename pm::enable_if<void**, (pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::depth == 2)>::type)
    explicit Matrix(const Container& src,
             ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:151:13: note:   template argument deduction/substitution failed:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h: In substitution of 'template<class Container> pm::Matrix<E>::Matrix(const Container&, typename pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::enabled, typename pm::enable_if<void**, (pm::construct_cascaded_iterator<typename Container::const_iterator, E, pm::dense>::depth == 2)>::type) [with Container = int]':
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67:   required from 'static sv* polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::call(sv**, char*) [with T0 = pm::Matrix<pm::Rational>; T1 = int]'
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/perl/wrappers.h:253:21:   required from 'static void pm::perl::WrapperBase<Wrapper>::register_it(const char (&)[namelen], const char (&)[filelen], int, _app_list) [with long unsigned int namelen = 6ul; long unsigned int filelen = 72ul; _app_list = int; Wrapper = polymake::common::{anonymous}::Wrapper4perl_new_X<pm::Matrix<pm::Rational>, int>]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:10:182:   required from 'polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::Wrapper4perl_new_X(const char (&)[fl], int, first_arg_type) [with long unsigned int fl = 72ul; first_arg_type = int; T0 = pm::Matrix<pm::Rational>; T1 = int]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:15:90:   required from here
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:153:127: error: 'int' is not a class, struct, or union type
                    typename enable_if<void**, construct_cascaded_iterator<typename Container::const_iterator, E, dense>::depth==2>::type=0)
                                                                                                                               ^
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc: In instantiation of 'static sv* polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::call(sv**, char*) [with T0 = pm::Matrix<pm::Rational>; T1 = int]':
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/perl/wrappers.h:253:21:   required from 'static void pm::perl::WrapperBase<Wrapper>::register_it(const char (&)[namelen], const char (&)[filelen], int, _app_list) [with long unsigned int namelen = 6ul; long unsigned int filelen = 72ul; _app_list = int; Wrapper = polymake::common::{anonymous}::Wrapper4perl_new_X<pm::Matrix<pm::Rational>, int>]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:10:182:   required from 'polymake::common::{anonymous}::Wrapper4perl_new_X<T0, T1>::Wrapper4perl_new_X(const char (&)[fl], int, first_arg_type) [with long unsigned int fl = 72ul; first_arg_type = int; T0 = pm::Matrix<pm::Rational>; T1 = int]'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:15:90:   required from here
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:146:13: note: candidate: template<class Matrix2, class E2> pm::Matrix<E>::Matrix(const pm::GenericMatrix<Matrix2, E2>&, typename pm::enable_if<void**, pm::explicitly_convertible_to<E2, E>::value>::type)
    explicit Matrix(const GenericMatrix<Matrix2, E2>& m,
             ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:146:13: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   mismatched types 'const pm::GenericMatrix<Matrix, E>' and 'pm::perl::access<int, int>::return_type {aka int}'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:141:13: note: candidate: template<class Matrix2, class E2> pm::Matrix<E>::Matrix(const pm::GenericMatrix<Matrix2, E2>&, typename pm::enable_if<void**, pm::convertible_to<E2, E>::value>::type)
    explicit Matrix(const GenericMatrix<Matrix2, E2>& m,
             ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:141:13: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   mismatched types 'const pm::GenericMatrix<Matrix, E>' and 'pm::perl::access<int, int>::return_type {aka int}'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:136:4: note: candidate: template<class Matrix2> pm::Matrix<E>::Matrix(const pm::GenericMatrix<Matrix2, E>&)
    Matrix(const GenericMatrix<Matrix2, E>& m)
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:136:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   mismatched types 'const pm::GenericMatrix<Matrix2, pm::Rational>' and 'pm::perl::access<int, int>::return_type {aka int}'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:132:4: note: candidate: pm::Matrix<E>::Matrix(const pm::GenericMatrix<pm::Matrix<E> >&) [with E = pm::Rational; typename pm::Matrix<E>::element_type = pm::Rational]
    Matrix(const GenericMatrix<Matrix>& m) : base(m.top()) {}
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:132:4: note:   no known conversion for argument 1 from 'pm::perl::access<int, int>::return_type {aka int}' to 'const pm::GenericMatrix<pm::Matrix<pm::Rational>, pm::Rational>&'
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:123:4: note: candidate: template<class Iterator> pm::Matrix<E>::Matrix(int, int, Iterator, typename pm::construct_cascaded_iterator<Iterator, E, pm::dense>::enabled)
    Matrix(int r, int c, Iterator src,
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:123:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   candidate expects 4 arguments, 1 provided
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:115:13: note: candidate: template<class E2, long unsigned int r, long unsigned int c> pm::Matrix<E>::Matrix(const E2 (&)[r][c], typename pm::enable_if<void**, pm::explicitly_convertible_to<E2, E>::value>::type)
    explicit Matrix(const E2 (&a)[r][c],
             ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:115:13: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   mismatched types 'const E2 [r][c]' and 'pm::perl::access<int, int>::return_type {aka int}'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:110:13: note: candidate: template<class E2, long unsigned int r, long unsigned int c> pm::Matrix<E>::Matrix(const E2 (&)[r][c], typename pm::enable_if<void**, pm::convertible_to<E2, E>::value>::type)
    explicit Matrix(const E2 (&a)[r][c],
             ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:110:13: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   mismatched types 'const E2 [r][c]' and 'pm::perl::access<int, int>::return_type {aka int}'
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:105:4: note: candidate: template<class E2> pm::Matrix<E>::Matrix(int, int, const E2&, typename pm::enable_if<void**, pm::explicitly_convertible_to<E2, E>::value>::type)
    Matrix(int r, int c, const E2& init,
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:105:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   candidate expects 4 arguments, 1 provided
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:100:4: note: candidate: template<class E2> pm::Matrix<E>::Matrix(int, int, const E2&, typename pm::enable_if<void**, pm::convertible_to<E2, E>::value>::type)
    Matrix(int r, int c, const E2& init,
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:100:4: note:   template argument deduction/substitution failed:
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:12:67: note:   candidate expects 4 arguments, 1 provided
In file included from /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/Matrix.h:20:0,
                 from /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.cc:5:
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:97:4: note: candidate: pm::Matrix<E>::Matrix(int, int) [with E = pm::Rational]
    Matrix(int r, int c) : base(r,c) {}
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:97:4: note:   candidate expects 2 arguments, 1 provided
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:94:4: note: candidate: pm::Matrix<E>::Matrix() [with E = pm::Rational]
    Matrix() {}
    ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:94:4: note:   candidate expects 0 arguments, 1 provided
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:77:7: note: candidate: pm::Matrix<pm::Rational>::Matrix(const pm::Matrix<pm::Rational>&)
 class Matrix :
       ^
/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/include/polymake/next/Matrix.h:77:7: note:   no known conversion for argument 1 from 'pm::perl::access<int, int>::return_type {aka int}' to 'const pm::Matrix<pm::Rational>&'
make: *** [/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//poly69091Taaaa0001.o] Error 1
```



---

Comment by SimonKing created at 2017-03-23 11:23:00

The problem arises when converting the list of lists of integers:

```
sage: polymake([[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
Traceback (most recent call last):
...
TypeError: Polymake terminated unexpectedly while reading in a large line:
reference to an undeclared variable @SAGE9 at /home/king/.sage/temp/king-ThinkPad-T430/4038/interface/tmp4212 line 1.
```



---

Comment by SimonKing created at 2017-03-23 11:27:07

The interesting thing is that in the file there is no reference to a variable. Instead, a variable (with a different name) is defined in the file.


---

Comment by SimonKing created at 2017-03-23 11:30:41

Is that a bug in polymake, perhaps? The content of the file is

```
@SAGE47=([[12, -2, -3, -5, -8, -13, -21, -34, -55], [0, 1, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 1], [0, 0, 0, 0, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 0, 0, 0, 1, 0, 0, 0], [0, 0, 0, 0, 1, 0, 0, 0, 0], [0, 0, 0, 1, 0, 0, 0, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0]]);
```

When I feed this directly into polymake, all is fine. But when I read it as a script, I get

```
polytope > script "/home/king/.sage/temp/king-ThinkPad-T430/4038/interface/tmp4212";

polymake:  ERROR: reference to an undeclared variable @SAGE47 at /home/king/.sage/temp/king-ThinkPad-T430/4038/interface/tmp4212 line 1.
```


Question to polymake experts: Is polymake interpreting a script differently from a user interaction?


---

Comment by SimonKing created at 2017-03-23 11:50:01

I posted the question in the polymake forum


---

Comment by SimonKing created at 2017-03-23 12:34:24

Apparently it is safer to use `declare `@`SAGE47=...;`. I wonder why so far it has worked without "declare", but I was told that when reading a script, variables need to be declared explicitly, either by `my` or by `declare`, depending on whether they are only declared in the script or shall still be available later.

That said, after changing the `set()` method, I get a different error:

```
polymake.new_object("Polytope", FACETS=[[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
Traceback (most recent call last):
...
TypeError: multiple declaration of a variable at input line 1.
```

Also, the following is not what I was hoping for:

```
sage: polymake([[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
0
```



---

Comment by SimonKing created at 2017-03-23 12:41:51

Probably the reason for the new error is that on the command line, a variable can be declared only once. But certainly Perl/polymake allows to explicitly un-declare a variable. So, as soon I have found out how to un-declare, I can fix that.


---

Comment by SimonKing created at 2017-03-23 15:46:01

It REALLY SUCKS that trac keeps logging me out automatically after short time!

What I wanted to say: At [polymake forum](https://forum.polymake.org/viewtopic.php?p=1963#p1963) I was told that scripts somehow are cached - which basically means that the use of scripts in order to send commands to polymake is leaking memory.

So, perhaps better disallow using files. When I do it, the definition of the polytope initially seems to work:

```
sage: P = polymake.new_object("Polytope", FACETS=[[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
sage: P
Polytope<Rational>[SAGE185]
sage: P.N_FACETS
9
```

but alas, something goes foobar:

```
sage: P.VERTICES
Traceback (most recent call last):
...
AttributeError:
```

whereas in a polymake session I get

```
polytope > $P = new Polytope(FACETS=>[[12, -2, -3, -5, -8, -13, -21, -34, -55], [0, 1, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 1], [0, 0, 0, 0, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 0, 0, 0, 1, 0, 0, 0], [0, 0, 0, 0, 1, 0, 0, 0, 0], [0, 0, 0, 1, 0, 0, 0, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0]]);

polytope > print $P->VERTICES;
polymake: used package ppl
  The Parma Polyhedra Library (PPL): A C++ library for convex polyhedra
  and other numerical abstractions.
  http://www.cs.unipr.it/ppl/

1 6 0 0 0 0 0 0 0
1 0 4 0 0 0 0 0 0
1 0 0 0 0 0 0 0 0
1 0 0 12/5 0 0 0 0 0
1 0 0 0 0 0 0 0 12/55
1 0 0 0 0 0 0 6/17 0
1 0 0 0 0 0 4/7 0 0
1 0 0 0 0 12/13 0 0 0
1 0 0 0 3/2 0 0 0 0
```



---

Comment by SimonKing created at 2017-03-23 15:52:06

The interface seems to be out of sync in the example above:

```
sage: P = polymake.new_object("Polytope", FACETS=[[12, -2, -3, -5, -8, -13, -21, -34, -55],
....:  [0, 1, 0, 0, 0, 0, 0, 0, 0],
....:  [0, 0, 0, 0, 0, 0, 0, 0, 1],
....:  [0, 0, 0, 0, 0, 0, 0, 1, 0],
....:  [0, 0, 0, 0, 0, 0, 1, 0, 0],
....:  [0, 0, 0, 0, 0, 1, 0, 0, 0],
....:  [0, 0, 0, 0, 1, 0, 0, 0, 0],
....:  [0, 0, 0, 1, 0, 0, 0, 0, 0],
....:  [0, 0, 1, 0, 0, 0, 0, 0, 0]])
sage: P._name
'$SAGE91[0]'
sage: polymake.eval("print $SAGE91[0]->VERTICES;")
''
sage: polymake.eval("print $SAGE91[0]->VERTICES;")
'1 6 0 0 0 0 0 0 0\n1 0 4 0 0 0 0 0 0\n1 0 0 0 0 0 0 0 0\n1 0 0 12/5 0 0 0 0 0\n1 0 0 0 0 0 0 0 12/55\n1 0 0 0 0 0 0 6/17 0\n1 0 0 0 0 0 4/7 0 0\n1 0 0 0 0 12/13 0 0 0\n1 0 0 0 3/2 0 0 0 0\n'
sage: P.VERTICES

1 6 0 0 0 0 0 0 0
1 0 4 0 0 0 0 0 0
1 0 0 0 0 0 0 0 0
1 0 0 12/5 0 0 0 0 0
1 0 0 0 0 0 0 0 12/55
1 0 0 0 0 0 0 6/17 0
1 0 0 0 0 0 4/7 0 0
1 0 0 0 0 12/13 0 0 0
1 0 0 0 3/2 0 0 0 0
```

Or perhaps there is a different reason:

```
sage: polymake.eval("print $SAGE91[0]->F_VECTOR;")
'9 36 84 126 126 84 36 9'
sage: P.F_VECTOR
Traceback (most recent call last):
...
AttributeError: 
```


So, sometimes the attribute error is stable, sometimes it vanishes.


---

Comment by jipilab created at 2017-03-23 15:55:09

Replying to [comment:9 SimonKing]:
> It REALLY SUCKS that trac keeps logging me out automatically after short time!

Maybe because your IP address changes automatically?


---

Comment by SimonKing created at 2017-03-23 16:37:09

Replying to [comment:11 jipilab]:
> Replying to [comment:9 SimonKing]:
> > It REALLY SUCKS that trac keeps logging me out automatically after short time!
> 
> Maybe because your IP address changes automatically?

You mean my IP address could change while being connected to eduroam, or also while being connected to ethernet?


---

Comment by mkoeppe created at 2017-03-23 16:48:40

By the way, would it make it easier for you to stay synced if there was no terminal echo? 
Then consider adding `stty -echo; ` just before the "env".  We did this in #20173 to work around a problem in the Mathematica pexpect interface.
----
Last 10 new commits:


---

Comment by SimonKing created at 2017-03-23 16:48:54

Replying to [comment:10 SimonKing]:
> The interface seems to be out of sync in the example above:

But it does work if I simply disallow the use of files and do not change the declaration of variables. So, I provided a quick fix plus doctest.


---

Comment by jipilab created at 2017-03-23 16:51:24

> You mean my IP address could change while being connected to eduroam, or also while being connected to ethernet?
Yes, actually, the same just happened to me now to come and write this comment and I'm using eduroam (without a lan connection at the same time) ...and this never happened to me in Olot for example. 

It is explains anything at all...


---

Comment by SimonKing created at 2017-03-23 16:52:36

Replying to [comment:17 jipilab]:
> > You mean my IP address could change while being connected to eduroam, or also while being connected to ethernet?
> Yes, actually, the same just happened to me now to come and write this comment and I'm using eduroam (without a lan connection at the same time) ...and this never happened to me in Olot for example. 
> 
> It is explains anything at all...

It also sucks that some changes that I just did have automatically been deleted by the simple fact that you posted something.


---

Comment by SimonKing created at 2017-03-23 16:53:36

Replying to [comment:14 mkoeppe]:
> By the way, would it make it easier for you to stay synced if there was no terminal echo? 
> Then consider adding `stty -echo; ` just before the "env".  We did this in #20173 to work around a problem in the Mathematica pexpect interface.

I will try. At least it would slightly reduce traffic in the interface.


---

Comment by jipilab created at 2017-03-23 16:54:03

Replying to [comment:19 SimonKing]:
> Replying to [comment:17 jipilab]:
> > > You mean my IP address could change while being connected to eduroam, or also while being connected to ethernet?
> > Yes, actually, the same just happened to me now to come and write this comment and I'm using eduroam (without a lan connection at the same time) ...and this never happened to me in Olot for example. 
> > 
> > It is explains anything at all...
> 
> It also sucks that some changes that I just did have automatically been deleted by the simple fact that you posted something.

Yes, I'm sorry for that... Trac does suck for that as well(!)


---

Comment by mkoeppe created at 2017-03-23 16:54:21

One needs to be careful to click "revert" when there's a red conflict marker.


---

Comment by SimonKing created at 2017-03-23 17:03:31

Replying to [comment:17 jipilab]:
> > You mean my IP address could change while being connected to eduroam, or also while being connected to ethernet?
> Yes, actually, the same just happened to me now to come and write this comment and I'm using eduroam (without a lan connection at the same time) ...and this never happened to me in Olot for example. 

IIRC, it happened in Olot to me all the time.

I tried to change things so that there is no terminal echo, but then I immediately get an error as soon as I do anything with polymake (and yes, I did set `terminal_echo=False` in the initialisation of the pexpect interface).


---

Comment by mkoeppe created at 2017-03-23 17:09:22

The way that some interfaces are written seems to assume that there is echo, and important lines are discarded as echo.
I don't remember the details


---

Comment by mkoeppe created at 2017-03-23 20:22:35

Thanks for the patch, this is progress.


---

Comment by mkoeppe created at 2017-03-23 20:45:47

So here's a `Polyhedron._polymake_` method. 

I guess the next step would be to provide a `_sage_` method for `PolymakeElement` which can convert Perl arrays(?) to Sage lists (ideally, based on calls to `__len__` and `__getitem__`, not parsing!). 

The inherited method already knows how to convert numbers:

```
sage: P = polytopes.cube()
sage: PP = P._polymake_()
sage: PP.N_VERTICES
8
sage: _._sage_()
8
sage: type(_)
<type 'sage.rings.integer.Integer'>
```

Simon, is this something that you're planning to work on?
----
New commits:


---

Comment by SimonKing created at 2017-03-23 22:32:26

Replying to [comment:27 mkoeppe]:
> Simon, is this something that you're planning to work on?

Currently Sage has a relatively low priority, as I have to set up a written exam on differential equations, to grade two 40 student's written exams, to edit a book chapter and to prepare three lectures courses that will start in 10 days.


---

Comment by SimonKing created at 2017-03-23 22:37:06

It may be reasonable/faster/more stable to not rely on automatic conversion of lists of lists of integers to Polymake, but to do the conversion explicitly, in the `_polymake_` method.


---

Comment by git created at 2017-03-24 03:11:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-24 14:16:44

I think the `_polymake_` method doesn't work how it is supposed to.

Have a look at `sage.structure.sage_object`: There, all conversion methods `_foobar_` are defined, and are customised with a `_foobar_init_`.

So, I guess one should implement `_polymake_` for `SageObject`, and also a default version of `_polymake_init_` (which defaults to the string representation and thus works out of the box for numbers and strings), similar to the other conversion methods. And then, you can override `_polymake_init_` (but not `_polymake_`!) for `Polyhedron_base`, returning a string rather than a polymake element.


---

Comment by SimonKing created at 2017-03-24 14:22:50

A question about workflow: My commits so far didn't concern polyhedron methods --- they are just fixes to the polymake interface (namely: "communicate with polymake without files"). I have further ideas (namely: "do communicate with polymake with files, but this time declare the variables properly"), and you as well ("avoid terminal echo"). Should we really do these fixes here, or open another ticket, which would be another dependency?


---

Comment by SimonKing created at 2017-03-24 14:33:18

PS: The following should work, but doesn't, with the current approach.

```
sage: P = polytopes.cube()
sage: polymake(P)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-d5e7b6594a93> in <module>()
----> 1 polymake(P)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, x, name)
    259             return cls(self, x, name=name)
    260         try:
--> 261             return self._coerce_from_special_method(x)
    262         except TypeError:
    263             raise

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in _coerce_from_special_method(self, x)
    285             s = '_gp_'
    286         try:
--> 287             return (x.__getattribute__(s))(self)
    288         except AttributeError:
    289             return self(x._interface_init_())

TypeError: __call__() takes exactly 0 positional arguments (1 given)
```

So, better implement `_polymake_` analogously to `_singular_`, `_gap_`, ... for `SageObject`.

EDIT: `_coerce_from_special_method_` results in a call to `_name_of_the_interface_()`.


---

Comment by SimonKing created at 2017-03-24 14:36:05

PPS: Is it really the case that we only want to define a polyhedron using FACETS and AFFINE_HULL? Why not via VERTICES?


---

Comment by mkoeppe created at 2017-03-24 15:30:00

Replying to [comment:34 SimonKing]:
> PPS: Is it really the case that we only want to define a polyhedron using FACETS and AFFINE_HULL? Why not via VERTICES?

We probably want to pass both the H- and V-description to polymake because both are computed already.
However, for unbounded, nonpointed polyhedra, I think it's more complicated to get it right, because what a Sage `Polyhedron` calls "vertices" are not vertices. So plenty of tests are needed to get it right.


---

Comment by mkoeppe created at 2017-03-24 15:31:44

Replying to [comment:32 SimonKing]:
> A question about workflow: My commits so far didn't concern polyhedron methods --- they are just fixes to the polymake interface (namely: "communicate with polymake without files"). I have further ideas (namely: "do communicate with polymake with files, but this time declare the variables properly"), and you as well ("avoid terminal echo"). Should we really do these fixes here, or open another ticket, which would be another dependency?

A separate ticket would be fine. In fact, since there is very little code on Polyhedron methods as of now, it's perhaps easiest to just rename this ticket and make a fresh ticket for the Polyhedron methods.


---

Comment by mkoeppe created at 2017-03-24 15:32:55

Replying to [comment:31 SimonKing]:
> I think the `_polymake_` method doesn't work how it is supposed to.
> 
> Have a look at `sage.structure.sage_object`: There, all conversion methods `_foobar_` are defined, and are customised with a `_foobar_init_`.
> 
> So, I guess one should implement `_polymake_` for `SageObject`, and also a default version of `_polymake_init_` (which defaults to the string representation and thus works out of the box for numbers and strings), similar to the other conversion methods. And then, you can override `_polymake_init_` (but not `_polymake_`!) for `Polyhedron_base`, returning a string rather than a polymake element.

Thanks a lot! I'll look into it.

It seems to me that I do want a `Polyhedron` method that does what my `_polymake_` method did. What should I call it?


---

Comment by jipilab created at 2017-03-24 15:56:18

> We probably want to pass both the H- and V-description to polymake because both are computed already.
> However, for unbounded, nonpointed polyhedra, I think it's more complicated to get it right, because what a Sage `Polyhedron` calls "vertices" are not vertices. So plenty of tests are needed to get it right.

I am not 100% sure, but I guess this only happens when the polyhedron has a lineality space (if it is not pointed but does not contain a line, then I guess vertices are still the correct vertices), for which sometimes the choice is not directly predictable (one should open the hood and checkout how it is done...)

I just put examples here for later test cases.

Examples:


```
sage: Q = Polyhedron(lines = [[-1, 1]], vertices = [[1, 1]])
sage: Q.vertices()
(A vertex at (2, 0),)

sage: R = Polyhedron(rays = [[0, 1, 0], [1, 0, 0]], vertices = [[0, 1, 0], [1, 0
....: , 0]], lines = [[0, 0, 1]])
sage: R.vertices()
(A vertex at (0, 1, 0), A vertex at (1, 0, 0))
```



---

Comment by SimonKing created at 2017-03-24 16:35:03

Replying to [comment:35 mkoeppe]:
> Replying to [comment:34 SimonKing]:
> > PPS: Is it really the case that we only want to define a polyhedron using FACETS and AFFINE_HULL? Why not via VERTICES?
> 
> We probably want to pass both the H- and V-description to polymake because both are computed already.
> However, for unbounded, nonpointed polyhedra, I think it's more complicated to get it right, because what a Sage `Polyhedron` calls "vertices" are not vertices. So plenty of tests are needed to get it right.

But certainly there are cases where a Sage polyhedron does know its vertices, and thus they could be provided to the polymake constructor. I am not saying that this should *always* be done.


---

Comment by SimonKing created at 2017-03-24 16:37:10

Replying to [comment:37 mkoeppe]:
> It seems to me that I do want a `Polyhedron` method that does what my `_polymake_` method did. What should I call it?

I don't understand that. Why do you want `P.Polyhedron()`, if `polymake(P)` works? Moreover, it isn't clear from the name that `P.Polyhedron()` returns anything that is related with polymake.


---

Comment by mkoeppe created at 2017-03-24 17:45:25

What I meant is a method of the `Polyhedron` classes.


---

Comment by mkoeppe created at 2017-03-24 17:48:02

Replying to [comment:38 jipilab]:
> > We probably want to pass both the H- and V-description to polymake because both are computed already.
> > However, for unbounded, nonpointed polyhedra, I think it's more complicated to get it right, because what a Sage `Polyhedron` calls "vertices" are not vertices. So plenty of tests are needed to get it right.
> 
> I am not 100% sure, but I guess this only happens when the polyhedron has a lineality space 

Yes, exactly. We may be used to different terminologies, but in my book, pointed = trivial lineality space = minimal faces are vertices.


---

Comment by SimonKing created at 2017-03-24 17:49:38

Replying to [comment:41 mkoeppe]:
> What I meant is a method of the `Polyhedron` classes.

I still don't see why there should be such method, if `polymake(P)` works. The implementation via `_polymake_init_` would be for `Polyhedron_base`, I suppose.


---

Comment by mkoeppe created at 2017-03-24 17:51:01

Replying to [comment:43 SimonKing]:
> I still don't see why there should be such method, if `polymake(P)` works. The implementation via `_polymake_init_` would be for `Polyhedron_base`, I suppose.

OK, I'll try to get `polymake(P)` working. Thanks for the discussion!


---

Comment by jipilab created at 2017-03-24 18:01:41

> Yes, exactly. We may be used to different terminologies, but in my book, pointed = trivial lineality space = minimal faces are vertices.

Okay! Yes, sounds good! I guess we are now on the same page ... of the same book.


---

Comment by mkoeppe created at 2017-03-26 03:12:52

Another observation about the interface:

```
sage: polymake.show_preferences()
1
```

This should instead print something (like it does in polymake:)

```
polytope > show_preferences;
"default" (#)
"tikz.lattice" (#)
"*.convex_hull ppl, cdd, lrs, beneath_beyond" (#)
"projection.integer_points"

Preferences marked with (#) are in effect by default, as specified in the rule files
```



---

Comment by git created at 2017-03-26 06:19:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-26 06:30:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-03-26 06:32:14

Replying to [comment:31 SimonKing]:
> So, I guess one should implement `_polymake_` for `SageObject`, and also a default version of `_polymake_init_` (which defaults to the string representation and thus works out of the box for numbers and strings), similar to the other conversion methods. And then, you can override `_polymake_init_` (but not `_polymake_`!) for `Polyhedron_base`, returning a string rather than a polymake element.

I have now reworked this along these lines. The default `_polymake_init` (in `SageObject`) works for some basic things such as integers and rationals. 

I provide a specialized `_polymake_init_` for some rings (the parents). For example, `polymake(QQ)` gives the polymake type name`"Rational"`.

Note, in `Polyhedron.base._polymake_init_`, I am still using `polymake.new_object` rather than putting together a complicated string. This seems to work fine, and seems more natural.

`polymake(P)` now works when `P` is  a `Polyhedron` over the rationals, over `RDF`, or over a quadratic extension of the rationals.


---

Comment by mkoeppe created at 2017-03-26 06:33:58

Replying to [comment:45 jipilab]:
> 
> > Yes, exactly. We may be used to different terminologies, but in my book, pointed = trivial lineality space = minimal faces are vertices.
> 
> Okay! Yes, sounds good! I guess we are now on the same page ... of the same book.

Turns out that polymake does a similar thing as Sage does, so it's less tricky than I thought it would be. I'm now passing both the H- and the V-rep to polymake. I've added tests for the various cases.


---

Comment by mkoeppe created at 2017-03-26 06:45:54

Changing status from new to needs_review.


---

Comment by git created at 2017-03-26 18:23:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-26 20:28:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-03-28 02:12:37

Replying to [comment:32 SimonKing]:
>  I have further ideas (namely: "do communicate with polymake with files, but this time declare the variables properly")

Yes, this is needed; I just got bitten by the 4096-characters-per-line limitation...


---

Comment by git created at 2017-03-28 05:27:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-03-28 05:28:39

It seems I found a simple solution for communicating with files.


---

Comment by tscrim created at 2017-03-28 05:32:34

Do you want it to be 100 characters (IIRC that is what the 100 specifies), or do you want to go higher so files are written less frequently, like 1024 or 2048?


---

Comment by mkoeppe created at 2017-03-28 06:06:07

1024 works for me, larger values don't. I'll make a change and add tests.


---

Comment by git created at 2017-03-28 06:07:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-03-28 08:48:50

Replying to [comment:60 mkoeppe]:
> It seems I found a simple solution for communicating with files. 

Sigh. Why didn't the polymake developers point me to that solution when I asked in the polymake forum? I explicitly asked for a way to read commands from a file and mentioned that the only solution I found was `script`, but I made it clear that I do certainly not _insist_ on using `script`. Their answer was to not point out alternatives, but to explain oddities that come with `script`, such as different conventions on declaring variables, and caching.

Do I see correctly that `eval read_file` will not cache what it read? That would be another advantage over `script` and would have been yet another reason for the polymake forum to mention that solution.

In singular.py, there is

```
eval_using_file_cutoff=100 if os.uname()[0]=="SunOS" else 1000
```

and in gap it is unconditionally 100. So, perhaps 1024 won't work on some systems?


---

Comment by mkoeppe created at 2017-03-28 16:56:26

Replying to [comment:64 SimonKing]:
> Do I see correctly that `eval read_file` will not cache what it read? 

No caching. It's just Perl. `eval` executes a given string of code.

> In singular.py, there is
> {{{
> eval_using_file_cutoff=100 if os.uname()[0]=="SunOS" else 1000
> }}}
> and in gap it is unconditionally 100. So, perhaps 1024 won't work on some systems?

I'm not very surprised to see code like this for Solaris based on past experience with its pty driver, but I don't think anyone has built Sage on Solaris in a long time, so we can't know. I would be hesitant to add special-casing code like this based on guessing.


---

Comment by git created at 2017-03-28 19:00:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-29 02:45:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-29 03:36:56

I wouldn't even worry about Solaris. If someone does want this, then they should be able to provide a fix.


---

Comment by tscrim created at 2017-03-29 15:27:20

Also, in the interfaces, there are other similar large values, e.g.:

```
src/sage/interfaces/gap3.py:             eval_using_file_cutoff=100,
src/sage/interfaces/scilab.py:                        eval_using_file_cutoff=100)
src/sage/interfaces/r.py:                  eval_using_file_cutoff=1024)
src/sage/interfaces/octave.py:                        eval_using_file_cutoff=100)
src/sage/interfaces/gap3.py:             eval_using_file_cutoff=100,
src/sage/interfaces/scilab.py:                        eval_using_file_cutoff=100)
src/sage/interfaces/r.py:                  eval_using_file_cutoff=1024)
src/sage/interfaces/octave.py:                        eval_using_file_cutoff=100)
src/sage/interfaces/kash.py:                        eval_using_file_cutoff=100,
src/sage/interfaces/mathematica.py:                        eval_using_file_cutoff=50)
src/sage/interfaces/lie.py:                        eval_using_file_cutoff=1024)
src/sage/interfaces/macaulay2.py:                        eval_using_file_cutoff=500)
src/sage/interfaces/gp.py:                        eval_using_file_cutoff=1024)
src/sage/interfaces/maxima.py:        eval_using_file_cutoff = 256
```



---

Comment by mkoeppe created at 2017-03-30 01:58:01

Yes, no point worrying about these numbers. I guess some are based on historical testing, others based on cut and paste. 

In any case, the current value in the polymake interface works both on Mac OS X and Linux; and there are tests for it.


---

Comment by tscrim created at 2017-03-30 04:58:06

So what else needs to be done for reviewing this ticket? Is anyone currently actively finishing the review for this ticket?


---

Comment by git created at 2017-03-30 05:33:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-03-30 05:39:53

Travis, I'm not aware of anyone else reviewing this ticket.
If you'd like to take a closer look at how I use `_polymake_` and `_polymake_init_` in this ticket, that could be helpful. I've in part followed Simon's advice regarding these methods and in part copied what other methods of the same classes did, but it's first time I've written interface coercion methods.


---

Comment by tscrim created at 2017-03-30 15:40:24

LGTM as far as I can tell. However, there are 2 minor issues from the patchbot:

- you didn't mark some tests as `# optional` in `src/sage/geometry/polyhedron/base.py`,
- you have trivial doctest failures in `src/doc/en/thematic_tutorials/coercion_and_categories.rst`.


---

Comment by git created at 2017-03-30 17:27:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-30 17:35:16

I think this one is unnecessary:

```
sage: P = polytopes.dodecahedron(exact=False); P # optional - polymake
```

Once that is reverted, then you can set a positive review on my behalf.


---

Comment by git created at 2017-03-30 17:39:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-03-30 17:39:48

Thank you!


---

Comment by mkoeppe created at 2017-03-30 17:39:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-01 11:00:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-04-01 11:00:52


```
sage -t --long src/sage/interfaces/polymake.py
**********************************************************************
File "src/sage/interfaces/polymake.py", line 397, in sage.interfaces.polymake.Polymake._read_in_file_command
Failed example:
    L = polymake([42] * 400)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._read_in_file_command[1]>", line 1, in <module>
        L = polymake([Integer(42)] * Integer(400))
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 273, in __call__
        raise TypeError(msg)
    TypeError: unable to start polymake
**********************************************************************
File "src/sage/interfaces/polymake.py", line 398, in sage.interfaces.polymake.Polymake._read_in_file_command
Failed example:
    len(L)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._read_in_file_command[2]>", line 1, in <module>
        len(L)
    NameError: name 'L' is not defined
**********************************************************************
File "src/sage/interfaces/polymake.py", line 403, in sage.interfaces.polymake.Polymake._read_in_file_command
Failed example:
    L = polymake([42] * 84)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._read_in_file_command[3]>", line 1, in <module>
        L = polymake([Integer(42)] * Integer(84))
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 273, in __call__
        raise TypeError(msg)
    TypeError: unable to start polymake
**********************************************************************
File "src/sage/interfaces/polymake.py", line 404, in sage.interfaces.polymake.Polymake._read_in_file_command
Failed example:
    len(L)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.polymake.Polymake._read_in_file_command[4]>", line 1, in <module>
        len(L)
    NameError: name 'L' is not defined
**********************************************************************
1 item had failures:
   4 of   6 in sage.interfaces.polymake.Polymake._read_in_file_command
    [25 tests, 4 failures, 0.24 s]
```



---

Comment by tscrim created at 2017-04-01 13:32:38

Looks like they just need `# optional - polymake`.


---

Comment by git created at 2017-04-01 14:28:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-04-01 14:28:29

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-04-01 14:38:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-03 20:59:24

Resolution: fixed
