# Issue 33179: Colormaps and contours for complex_plot

archive/issues_033179.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/33416\n\n",
    "created_at": "2022-02-25T14:57:12Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Colormaps and contours for complex_plot",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33179",
    "user": "https://github.com/davidlowryduda"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/33416





---

archive/issue_comments_472032.json:
```json
{
    "body": "Changing keywords from \"\" to \"complex plotting\".",
    "created_at": "2022-02-25T15:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472032",
    "user": "https://github.com/davidlowryduda"
}
```

Changing keywords from "" to "complex plotting".



---

archive/issue_comments_472033.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graphics.",
    "created_at": "2022-02-25T15:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472033",
    "user": "https://github.com/davidlowryduda"
}
```

Changing component from PLEASE CHANGE to graphics.



---

archive/issue_comments_472034.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-02-25T15:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472034",
    "user": "https://github.com/davidlowryduda"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_472035.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-02-25T15:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472035",
    "user": "https://github.com/davidlowryduda"
}
```

New commits:



---

archive/issue_comments_472036.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-25T15:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472036",
    "user": "https://github.com/davidlowryduda"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_472037.json:
```json
{
    "body": "Thank you for the contribution. Some comments:\n\n- I am not sure I like `'default'` not being the default in Sage. Perhaps `'matplotlib'`? If we can't agree on a better name, this will be okay, but I might want to put some effort towards this.\n- Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).\n- `Returns` -> `Return`\n- Revert this change\n  {{{#!diff\n-    OUTPUT:\n+    OUTPUT::\n  }}}\n- In `cyclic_mag_to_lightness()`, use ``\\log(2)`` (latex) instead of ```log(2)``` (code formatted). Also add an `r` before the first `\"\"\"`.\n- Similar changes as well:\n  {{{#!diff\n-    - ``r`` - a non-negative real number\n-    - ``arg`` - a real number\n+    - ``r`` -- a non-negative real number\n+    - ``arg`` -- a real number\n  }}}\n- Add a one-line description to `direct_complex_to_rgb()` and `cmap_complex_to_rgb()`.\n- And similar changes\n  {{{#!diff\n-    - ``contoured`` -- boolean (default: False) - causes magnitude to be\n-      indicated through contour-like adjustments to lightness.\n+    - ``contoured`` -- boolean (default: ``False``); causes magnitude to be\n+      indicated through contour-like adjustments to lightness\n \n-    - ``tiled`` -- boolean (default: False) - causes magnitude and argument to\n-      be indicated through contour-like adjustments to lightness.\n+    - ``tiled`` -- boolean (default: ``False``); causes magnitude and argument to\n+      be indicated through contour-like adjustments to lightness\n  }}}\n- In `cmap_complex_to_rgb()`, if you do `r\"\"\"`, then you can change the `\\\\` to `\\`. Similar changes elsewhere too.\n- And similar\n  {{{#!diff\n-for i from 0 <= i < imax:\n+for i in range(imax):\n  }}}",
    "created_at": "2022-02-27T09:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472037",
    "user": "https://github.com/tscrim"
}
```

Thank you for the contribution. Some comments:

- I am not sure I like `'default'` not being the default in Sage. Perhaps `'matplotlib'`? If we can't agree on a better name, this will be okay, but I might want to put some effort towards this.
- Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).
- `Returns` -> `Return`
- Revert this change
  {{{#!diff
-    OUTPUT:
+    OUTPUT::
  }}}
- In `cyclic_mag_to_lightness()`, use ``\log(2)`` (latex) instead of ```log(2)``` (code formatted). Also add an `r` before the first `"""`.
- Similar changes as well:
  {{{#!diff
-    - ``r`` - a non-negative real number
-    - ``arg`` - a real number
+    - ``r`` -- a non-negative real number
+    - ``arg`` -- a real number
  }}}
- Add a one-line description to `direct_complex_to_rgb()` and `cmap_complex_to_rgb()`.
- And similar changes
  {{{#!diff
-    - ``contoured`` -- boolean (default: False) - causes magnitude to be
-      indicated through contour-like adjustments to lightness.
+    - ``contoured`` -- boolean (default: ``False``); causes magnitude to be
+      indicated through contour-like adjustments to lightness
 
-    - ``tiled`` -- boolean (default: False) - causes magnitude and argument to
-      be indicated through contour-like adjustments to lightness.
+    - ``tiled`` -- boolean (default: ``False``); causes magnitude and argument to
+      be indicated through contour-like adjustments to lightness
  }}}
- In `cmap_complex_to_rgb()`, if you do `r"""`, then you can change the `\\` to `\`. Similar changes elsewhere too.
- And similar
  {{{#!diff
-for i from 0 <= i < imax:
+for i in range(imax):
  }}}



---

archive/issue_comments_472038.json:
```json
{
    "body": "Thank you for this addition. This will be nice to have in Sage. I have been playing around with this and have some remarks as well.\n\n- The first thing I noticed is the aliasing effects. These are a bit unfortunate, but the way Sage interacts with Matplotlib makes it rather difficult to avoid them. At the time Sage creates the plot, the eventual size of the figure is not known, so upsampling of the image can not in general be avoided. I assume one might get fewer aliasing effects if it were possible to remap the colors of the upsampled image (so that the contours could be applied to the final image), but currently this seems very difficult to accomplish with Matplotlib. Therefore, I think the way you implemented it is the best we can do for now, even if it means that one needs a large number of plot points to obtain a smooth image.\n\n- Renaming the function `complex_to_rgb` to `direct_complex_to_rgb` is not necessary. It is probably not used by anyone outside of Sage, but it is better to avoid breaking backward compatibility if we can. Also, functions that are meant for internal use should start with an underscore.\n\n- Where possible we should use Numpy, unless there is a good reason not to. For example, the function `clamp` can be replaced by [numpy.clip](https://numpy.org/doc/stable/reference/generated/numpy.clip.html).\n\n- I have tried to speed up the slow step in `cmap_complex_to_rgb` using Numpy. The following computation should be equivalent and faster, but please check this for correctness.\n\n```diff\ndiff --git a/src/sage/plot/complex_plot.pyx b/src/sage/plot/complex_plot.pyx\nindex a3551584ce..d116887b83 100644\n--- a/src/sage/plot/complex_plot.pyx\n+++ b/src/sage/plot/complex_plot.pyx\n@@ -387,14 +387,13 @@ def cmap_complex_to_rgb(z_values, cmap=None, contoured=False, tiled=False):\n     normalized_colors = cmap((args + PI) / (2 * PI))\n     normalized_colors = normalized_colors[:,:,:3]  # discard alpha channel\n     lightdeltas = als[:,:,1]\n-    lightdeltas = lightdeltas # normalize lightness adjustment\n-    arg_d_s = np.dstack((normalized_colors, lightdeltas))\n\n     if tiled or contoured:\n+        arg_d_s = np.dstack((normalized_colors, lightdeltas))\n         # add contours: convert to hls, adjust lightness, convert back\n         rgbs = manual_contoured_cmap_complex_to_rgb(arg_d_s)\n     else:\n-        rgbs = manual_smooth_cmap_complex_to_rgb(arg_d_s)\n+        rgbs = manual_smooth_cmap_complex_to_rgb(normalized_colors, lightdeltas)\n\n     # Apply mask, making nan_indices white\n     rgbs[nan_indices] = 1\n@@ -451,7 +450,7 @@ cdef inline double clamp(double x):\n     return x\n\n\n-def manual_smooth_cmap_complex_to_rgb(rgb_d_s):\n+def manual_smooth_cmap_complex_to_rgb(rgb, delta):\n     \"\"\"\n     Returns an rgb array from given array of `(r, g, b, delta)`.\n\n@@ -508,30 +507,10 @@ def manual_smooth_cmap_complex_to_rgb(rgb_d_s):\n         array([[[0.75  , 0.8125, 0.875 ]]])\n     \"\"\"\n     import numpy as np\n-\n-    cdef unsigned int i, j, imax, jmax\n-    cdef double r, g, b, delta, h, l, s\n-\n-    imax = len(rgb_d_s)\n-    jmax = len(rgb_d_s[0])\n-\n-    cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgb = np.empty(dtype=float, shape=(imax, jmax, 3))\n-\n-    sig_on()\n-    for i from 0 <= i < imax:\n-        row = rgb_d_s[i]\n-        for j from 0 <= j < jmax:\n-            r, g, b, delta = row[j]\n-            delta = 0.5 + delta/2.0\n-            if delta < 0.5:\n-                rgb[i][j][0] = clamp(2 * delta * r)\n-                rgb[i][j][1] = clamp(2 * delta * g)\n-                rgb[i][j][2] = clamp(2 * delta * b)\n-            else:\n-                rgb[i][j][0] = clamp(2*(delta - 1.0)*(1 - r) + 1)\n-                rgb[i][j][1] = clamp(2*(delta - 1.0)*(1 - g) + 1)\n-                rgb[i][j][2] = clamp(2*(delta - 1.0)*(1 - b) + 1)\n-    sig_off()\n+    delta = delta[:,:,np.newaxis]\n+    delta_pos = delta > 0.0\n+    rgb = (1.0 - np.abs(delta))*(rgb - delta_pos) + delta_pos\n+    rgb = np.clip(rgb, 0.0, 1.0)\n     return rgb\n```\n\n\n    -\u2022 `rgb[i,j,k]` is faster than `rgb[i][j][k]` as the latter creates temporary arrays.\n\n    -\u2022 stacking the arrays was not necessary and cost time, so I kept `rgb` and `delta` separate.\n\n Now, this is not much slower than the old implementation anymore:\n\n```\nsage: from sage.plot.complex_plot import *\n....: arr = list(map(list, matrix.random(CDF, 800)))\n....: %timeit res = direct_complex_to_rgb(arr)\n....: %timeit res = cmap_complex_to_rgb(arr)\n60.5 ms \u00b1 1.34 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n144 ms \u00b1 829 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\n previously:\n\n```\n....: %timeit res = cmap_complex_to_rgb(arr)\n1.13 s \u00b1 9.25 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\n\n At this point, I think it makes sense to completely remove the old implementation and replace it by using the colormap `hsv` together with a sign change of the input data.\n\n- For now I have focused on the colormap functionality. I have not looked at the contouring implementation yet, but noticed a problem with this example:\n\n```\ncomplex_plot(x, (-2,2), (-2,2), cmap='twilight', contoured=True)\n```\n\n\n  The `twilight` colormap should be cyclic continuous, so the plot does not look right.\n\n- For the documentation, I would also suggest to replace one of the examples that specified a colormap to use `twilight` instead because it is cyclic.",
    "created_at": "2022-02-27T15:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472038",
    "user": "https://github.com/mwageringel"
}
```

Thank you for this addition. This will be nice to have in Sage. I have been playing around with this and have some remarks as well.

- The first thing I noticed is the aliasing effects. These are a bit unfortunate, but the way Sage interacts with Matplotlib makes it rather difficult to avoid them. At the time Sage creates the plot, the eventual size of the figure is not known, so upsampling of the image can not in general be avoided. I assume one might get fewer aliasing effects if it were possible to remap the colors of the upsampled image (so that the contours could be applied to the final image), but currently this seems very difficult to accomplish with Matplotlib. Therefore, I think the way you implemented it is the best we can do for now, even if it means that one needs a large number of plot points to obtain a smooth image.

- Renaming the function `complex_to_rgb` to `direct_complex_to_rgb` is not necessary. It is probably not used by anyone outside of Sage, but it is better to avoid breaking backward compatibility if we can. Also, functions that are meant for internal use should start with an underscore.

- Where possible we should use Numpy, unless there is a good reason not to. For example, the function `clamp` can be replaced by [numpy.clip](https://numpy.org/doc/stable/reference/generated/numpy.clip.html).

- I have tried to speed up the slow step in `cmap_complex_to_rgb` using Numpy. The following computation should be equivalent and faster, but please check this for correctness.

```diff
diff --git a/src/sage/plot/complex_plot.pyx b/src/sage/plot/complex_plot.pyx
index a3551584ce..d116887b83 100644
--- a/src/sage/plot/complex_plot.pyx
+++ b/src/sage/plot/complex_plot.pyx
@@ -387,14 +387,13 @@ def cmap_complex_to_rgb(z_values, cmap=None, contoured=False, tiled=False):
     normalized_colors = cmap((args + PI) / (2 * PI))
     normalized_colors = normalized_colors[:,:,:3]  # discard alpha channel
     lightdeltas = als[:,:,1]
-    lightdeltas = lightdeltas # normalize lightness adjustment
-    arg_d_s = np.dstack((normalized_colors, lightdeltas))

     if tiled or contoured:
+        arg_d_s = np.dstack((normalized_colors, lightdeltas))
         # add contours: convert to hls, adjust lightness, convert back
         rgbs = manual_contoured_cmap_complex_to_rgb(arg_d_s)
     else:
-        rgbs = manual_smooth_cmap_complex_to_rgb(arg_d_s)
+        rgbs = manual_smooth_cmap_complex_to_rgb(normalized_colors, lightdeltas)

     # Apply mask, making nan_indices white
     rgbs[nan_indices] = 1
@@ -451,7 +450,7 @@ cdef inline double clamp(double x):
     return x


-def manual_smooth_cmap_complex_to_rgb(rgb_d_s):
+def manual_smooth_cmap_complex_to_rgb(rgb, delta):
     """
     Returns an rgb array from given array of `(r, g, b, delta)`.

@@ -508,30 +507,10 @@ def manual_smooth_cmap_complex_to_rgb(rgb_d_s):
         array([[[0.75  , 0.8125, 0.875 ]]])
     """
     import numpy as np
-
-    cdef unsigned int i, j, imax, jmax
-    cdef double r, g, b, delta, h, l, s
-
-    imax = len(rgb_d_s)
-    jmax = len(rgb_d_s[0])
-
-    cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgb = np.empty(dtype=float, shape=(imax, jmax, 3))
-
-    sig_on()
-    for i from 0 <= i < imax:
-        row = rgb_d_s[i]
-        for j from 0 <= j < jmax:
-            r, g, b, delta = row[j]
-            delta = 0.5 + delta/2.0
-            if delta < 0.5:
-                rgb[i][j][0] = clamp(2 * delta * r)
-                rgb[i][j][1] = clamp(2 * delta * g)
-                rgb[i][j][2] = clamp(2 * delta * b)
-            else:
-                rgb[i][j][0] = clamp(2*(delta - 1.0)*(1 - r) + 1)
-                rgb[i][j][1] = clamp(2*(delta - 1.0)*(1 - g) + 1)
-                rgb[i][j][2] = clamp(2*(delta - 1.0)*(1 - b) + 1)
-    sig_off()
+    delta = delta[:,:,np.newaxis]
+    delta_pos = delta > 0.0
+    rgb = (1.0 - np.abs(delta))*(rgb - delta_pos) + delta_pos
+    rgb = np.clip(rgb, 0.0, 1.0)
     return rgb
```


    -• `rgb[i,j,k]` is faster than `rgb[i][j][k]` as the latter creates temporary arrays.

    -• stacking the arrays was not necessary and cost time, so I kept `rgb` and `delta` separate.

 Now, this is not much slower than the old implementation anymore:

```
sage: from sage.plot.complex_plot import *
....: arr = list(map(list, matrix.random(CDF, 800)))
....: %timeit res = direct_complex_to_rgb(arr)
....: %timeit res = cmap_complex_to_rgb(arr)
60.5 ms ± 1.34 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
144 ms ± 829 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

 previously:

```
....: %timeit res = cmap_complex_to_rgb(arr)
1.13 s ± 9.25 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


 At this point, I think it makes sense to completely remove the old implementation and replace it by using the colormap `hsv` together with a sign change of the input data.

- For now I have focused on the colormap functionality. I have not looked at the contouring implementation yet, but noticed a problem with this example:

```
complex_plot(x, (-2,2), (-2,2), cmap='twilight', contoured=True)
```


  The `twilight` colormap should be cyclic continuous, so the plot does not look right.

- For the documentation, I would also suggest to replace one of the examples that specified a colormap to use `twilight` instead because it is cyclic.



---

archive/issue_comments_472039.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-28T21:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472039",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472040.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n\nThank you for your suggestions and the documentation fixes. I've incorporated these changes.\n \n> - Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).\n\nIt's not possible (as far as I can tell) to give the user the ability to choose the parameter for scaling. For example, I chose contours at `2^n` for logarithmic scaling. Fortunately, logarithmic scaling is pretty forgiving since logarithms grow so slowly. For linear scaling, the difference between scaling at `1` and `10`, say, is *really* dramatic. I didn't put in a default linear scaling option for this reason.\n\nThe reason it's nontrivial to include is that these are used heavily in the compiled portion of the cython. I think this is the same reason why there is no runtime option to change the exponent for ``mag_to_lightness`` in the current ``complex_plot``.\n\nOf course, I could be wrong.\n\n> - And similar\n>   {{{#!diff\n> -for i from 0 <= i < imax:\n> +for i in range(imax):\n>   }}}\n\nOh, thank you! I hadn't realized that cython changed to convert range-based loops into C-loops. (It seems this happened in 2018, and I'm behind the times). This is much nicer!\n\nI'm currently examining the comments from `@`gh-mwageringel, but haven't acted on those comments yet.\n----\nNew commits:",
    "created_at": "2022-02-28T21:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472040",
    "user": "https://github.com/davidlowryduda"
}
```

Replying to [comment:4 tscrim]:

Thank you for your suggestions and the documentation fixes. I've incorporated these changes.
 
> - Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).

It's not possible (as far as I can tell) to give the user the ability to choose the parameter for scaling. For example, I chose contours at `2^n` for logarithmic scaling. Fortunately, logarithmic scaling is pretty forgiving since logarithms grow so slowly. For linear scaling, the difference between scaling at `1` and `10`, say, is *really* dramatic. I didn't put in a default linear scaling option for this reason.

The reason it's nontrivial to include is that these are used heavily in the compiled portion of the cython. I think this is the same reason why there is no runtime option to change the exponent for ``mag_to_lightness`` in the current ``complex_plot``.

Of course, I could be wrong.

> - And similar
>   {{{#!diff
> -for i from 0 <= i < imax:
> +for i in range(imax):
>   }}}

Oh, thank you! I hadn't realized that cython changed to convert range-based loops into C-loops. (It seems this happened in 2018, and I'm behind the times). This is much nicer!

I'm currently examining the comments from `@`gh-mwageringel, but haven't acted on those comments yet.
----
New commits:



---

archive/issue_comments_472041.json:
```json
{
    "body": "Replying to [comment:7 DavidLowry]:\n> Replying to [comment:4 tscrim]:\n> \n> Thank you for your suggestions and the documentation fixes. I've incorporated these changes.\n>  \n> > - Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).\n> \n> It's not possible (as far as I can tell) to give the user the ability to choose the parameter for scaling. For example, I chose contours at `2^n` for logarithmic scaling. Fortunately, logarithmic scaling is pretty forgiving since logarithms grow so slowly. For linear scaling, the difference between scaling at `1` and `10`, say, is *really* dramatic. I didn't put in a default linear scaling option for this reason.\n\nSomeone might utilize that difference. With having an extra parameter that the user can control, this becomes a useful tool that I believe should be easy to implement.\n\n> The reason it's nontrivial to include is that these are used heavily in the compiled portion of the cython. I think this is the same reason why there is no runtime option to change the exponent for ``mag_to_lightness`` in the current ``complex_plot``.\n\nThis doesn't make sense to me. You can just make your hardcoded values into input parameters, or have the lightness be a function (with the default being the hardcoded function).",
    "created_at": "2022-03-01T00:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472041",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:7 DavidLowry]:
> Replying to [comment:4 tscrim]:
> 
> Thank you for your suggestions and the documentation fixes. I've incorporated these changes.
>  
> > - Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like `f(x) = z^2`).
> 
> It's not possible (as far as I can tell) to give the user the ability to choose the parameter for scaling. For example, I chose contours at `2^n` for logarithmic scaling. Fortunately, logarithmic scaling is pretty forgiving since logarithms grow so slowly. For linear scaling, the difference between scaling at `1` and `10`, say, is *really* dramatic. I didn't put in a default linear scaling option for this reason.

Someone might utilize that difference. With having an extra parameter that the user can control, this becomes a useful tool that I believe should be easy to implement.

> The reason it's nontrivial to include is that these are used heavily in the compiled portion of the cython. I think this is the same reason why there is no runtime option to change the exponent for ``mag_to_lightness`` in the current ``complex_plot``.

This doesn't make sense to me. You can just make your hardcoded values into input parameters, or have the lightness be a function (with the default being the hardcoded function).



---

archive/issue_comments_472042.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n\n> This doesn't make sense to me. You can just make your hardcoded values into input parameters, or have the lightness be a function (with the default being the hardcoded function).\n\nI don't know what I was thinking. Of course you're right. This is easy to implement. I'll do that too.",
    "created_at": "2022-03-01T06:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472042",
    "user": "https://github.com/davidlowryduda"
}
```

Replying to [comment:8 tscrim]:

> This doesn't make sense to me. You can just make your hardcoded values into input parameters, or have the lightness be a function (with the default being the hardcoded function).

I don't know what I was thinking. Of course you're right. This is easy to implement. I'll do that too.



---

archive/issue_comments_472043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T21:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472044.json:
```json
{
    "body": "Example of aliasing artifacts for linear contours",
    "created_at": "2022-03-02T22:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472044",
    "user": "https://github.com/davidlowryduda"
}
```

Example of aliasing artifacts for linear contours



---

archive/issue_comments_472045.json:
```json
{
    "body": "Attachment [result.png](tarball://root/attachments/some-uuid/ticket33416/result.png) by @davidlowryduda created at 2022-03-02 22:14:36\n\nI have now included several of the suggestions from `@`gh-mwageringel. In particular, I have changed many of the implementations to now be in numpy, including writing numpy forms of HLS->RGB and RGB->HLS translations. I'm not particularly great at numpy, but nonetheless this is markedly faster than my previous version.\n\n> At this point, I think it makes sense to completely remove the old implementation and replace it by using the colormap hsv together with a sign change of the input data.\n\nI almost did this completely. I changed the default `complex_plot` to use my new color implementation. There is a __very small__ difference that can be seen by comparing the outputs of\n\n\n```\nsage: complex_plot(x^3, (-2, 2), (-2, 2))\nsage: complex_plot(x^3, (-2, 2), (-2, 2), cmap=None) # old default\n```\n\n\nThis seems close enough to me that I'd be happy to remove the old implementation entirely.\n\n> Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like f(x) = z^2). \n\nThese commits also include this implementation. It is now possible to choose between linear vs log scaling, to choose the intervals between contours, the number of phases in the tiling method, and the rate of change of magnitude when there are no contours. I note that linear scaling can often lead quickly to Moire patterns once the rate of change of the function gets to be large. For a concrete example, I've included the two outputs of the plots from\n\n\n```\nsage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, contoured=True, contour_type='linear', contour_base=10, plot_points=800)\nsage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, contoured=True, contour_type='linear', contour_base=10, plot_points=800)\n```\n\n\n<img src=\"result.png\" width=600 px>\n\nI'll add one such example and a warning to the documentation.\n\nIt is also now possible to adjust the exponent controlling how quickly the magnitude tends to white or black. This can be seen for example in\n\n```\nsage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, plot_points=300)\nsage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, plot_points=300, dark_rate=1.0)\n```\n",
    "created_at": "2022-03-02T22:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472045",
    "user": "https://github.com/davidlowryduda"
}
```

Attachment [result.png](tarball://root/attachments/some-uuid/ticket33416/result.png) by @davidlowryduda created at 2022-03-02 22:14:36

I have now included several of the suggestions from `@`gh-mwageringel. In particular, I have changed many of the implementations to now be in numpy, including writing numpy forms of HLS->RGB and RGB->HLS translations. I'm not particularly great at numpy, but nonetheless this is markedly faster than my previous version.

> At this point, I think it makes sense to completely remove the old implementation and replace it by using the colormap hsv together with a sign change of the input data.

I almost did this completely. I changed the default `complex_plot` to use my new color implementation. There is a __very small__ difference that can be seen by comparing the outputs of


```
sage: complex_plot(x^3, (-2, 2), (-2, 2))
sage: complex_plot(x^3, (-2, 2), (-2, 2), cmap=None) # old default
```


This seems close enough to me that I'd be happy to remove the old implementation entirely.

> Is there an easy way to extend the contours to have different user input? I am thinking two parameters: one for choosing linear versus log scaling, and then another for the intervals. I am thinking about if someone is looking at where a function changes more slowly (a more trivial example, but something like f(x) = z^2). 

These commits also include this implementation. It is now possible to choose between linear vs log scaling, to choose the intervals between contours, the number of phases in the tiling method, and the rate of change of magnitude when there are no contours. I note that linear scaling can often lead quickly to Moire patterns once the rate of change of the function gets to be large. For a concrete example, I've included the two outputs of the plots from


```
sage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, contoured=True, contour_type='linear', contour_base=10, plot_points=800)
sage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, contoured=True, contour_type='linear', contour_base=10, plot_points=800)
```


<img src="result.png" width=600 px>

I'll add one such example and a warning to the documentation.

It is also now possible to adjust the exponent controlling how quickly the magnitude tends to white or black. This can be seen for example in

```
sage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, plot_points=300)
sage: complex_plot(x^3, (-5, 5), (-5, 5), cmap=None, plot_points=300, dark_rate=1.0)
```




---

archive/issue_comments_472046.json:
```json
{
    "body": "Attachment [twilight.png](tarball://root/attachments/some-uuid/ticket33416/twilight.png) by @davidlowryduda created at 2022-03-02 22:16:55\n\ntwilight example",
    "created_at": "2022-03-02T22:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472046",
    "user": "https://github.com/davidlowryduda"
}
```

Attachment [twilight.png](tarball://root/attachments/some-uuid/ticket33416/twilight.png) by @davidlowryduda created at 2022-03-02 22:16:55

twilight example



---

archive/issue_comments_472047.json:
```json
{
    "body": "Replying to [comment:5 gh-mwageringel]:\n\n> - For now I have focused on the colormap functionality. I have not looked at the contouring implementation yet, but noticed a problem with this example:\n> {{{\n> complex_plot(x, (-2,2), (-2,2), cmap='twilight', contoured=True)\n> }}}\n> \n>   The `twilight` colormap should be cyclic continuous, so the plot does not look right.\n\nThe output looks about as I expect. For concreteness, I've included a version (with 300 plot points) here: \n\n![](twilight.png)\n\nThere are two interactions governing the colors. First, there are contours affecting magnitudes. Then there is the colormap. The phase is mapped to the color, so we should expect on any circle centered at the origin to go through a cyclic continuous colormap (but each circle might be adjusted in lightness by the contouring). In a commit that will immediately after I write this, it's also possible to choose contour visibility (by adjusting `dark_rate`). With `twilight`, I find that setting `dark_rate = 0.2` works better. Setting `dark_rate = 0.0` now gives a pure phase plot.\n\n> - For the documentation, I would also suggest to replace one of the examples that specified a colormap to use `twilight` instead because it is cyclic.\n\nI think this is a good idea! I think I'm going to add many examples.",
    "created_at": "2022-03-02T22:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472047",
    "user": "https://github.com/davidlowryduda"
}
```

Replying to [comment:5 gh-mwageringel]:

> - For now I have focused on the colormap functionality. I have not looked at the contouring implementation yet, but noticed a problem with this example:
> {{{
> complex_plot(x, (-2,2), (-2,2), cmap='twilight', contoured=True)
> }}}
> 
>   The `twilight` colormap should be cyclic continuous, so the plot does not look right.

The output looks about as I expect. For concreteness, I've included a version (with 300 plot points) here: 

![](twilight.png)

There are two interactions governing the colors. First, there are contours affecting magnitudes. Then there is the colormap. The phase is mapped to the color, so we should expect on any circle centered at the origin to go through a cyclic continuous colormap (but each circle might be adjusted in lightness by the contouring). In a commit that will immediately after I write this, it's also possible to choose contour visibility (by adjusting `dark_rate`). With `twilight`, I find that setting `dark_rate = 0.2` works better. Setting `dark_rate = 0.0` now gives a pure phase plot.

> - For the documentation, I would also suggest to replace one of the examples that specified a colormap to use `twilight` instead because it is cyclic.

I think this is a good idea! I think I'm going to add many examples.



---

archive/issue_comments_472048.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T22:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472049.json:
```json
{
    "body": "Great, thank you. Looks very pretty. I just have a few trivial doc comments:\n\nAnd similar:\n\n```diff\n     .. SEEALSO::\n \n-        :func:`sage.plot.complex_plot.mag_to_lightness`\n-        :func:`sage.plot.complex_plot.mag_and_arg_to_lightness`\n-        :func:`sage.plot.complex_plot.cyclic_linear_mag_to_lightness`\n+        - :func:`sage.plot.complex_plot.mag_to_lightness`\n+        - :func:`sage.plot.complex_plot.mag_and_arg_to_lightness`\n+        - :func:`sage.plot.complex_plot.cyclic_linear_mag_to_lightness`\n```\n\n\nFor `INPUT:` blocks, please format as:\n\n```\n- ``arg1`` -- positive integer; a description\n- ``arg2`` -- boolean (default: ``False``); some description\n```\n\n\nInstead of using ```... \\times 3```, use ``n \\times 3``.",
    "created_at": "2022-03-03T01:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472049",
    "user": "https://github.com/tscrim"
}
```

Great, thank you. Looks very pretty. I just have a few trivial doc comments:

And similar:

```diff
     .. SEEALSO::
 
-        :func:`sage.plot.complex_plot.mag_to_lightness`
-        :func:`sage.plot.complex_plot.mag_and_arg_to_lightness`
-        :func:`sage.plot.complex_plot.cyclic_linear_mag_to_lightness`
+        - :func:`sage.plot.complex_plot.mag_to_lightness`
+        - :func:`sage.plot.complex_plot.mag_and_arg_to_lightness`
+        - :func:`sage.plot.complex_plot.cyclic_linear_mag_to_lightness`
```


For `INPUT:` blocks, please format as:

```
- ``arg1`` -- positive integer; a description
- ``arg2`` -- boolean (default: ``False``); some description
```


Instead of using ```... \times 3```, use ``n \times 3``.



---

archive/issue_comments_472050.json:
```json
{
    "body": "Replying to [comment:11 DavidLowry]:\n> I almost did this completely. I changed the default `complex_plot` to use my new color implementation. There is a __very small__ difference that can be seen by comparing the outputs of\n> \n> {{{\n> sage: complex_plot(x^3, (-2, 2), (-2, 2))\n> sage: complex_plot(x^3, (-2, 2), (-2, 2), cmap=None) # old default\n> }}}\n> \n> This seems close enough to me that I'd be happy to remove the old implementation entirely.\n\nThe difference is very small, but I cannot fully explain where the difference comes from. On closer inspection, I also noticed that the matplotlib `hsv` color map is discretized (which I did not expect), so one can see a difference when the phase varies very little. For example:\n\n```\ngraphics_array([complex_plot(x^(1/10)*e^(2*pi*I/10), (-2, 2), (-2, 2)), complex_plot(x^(1/10)*e^(2*pi*I/10), (-2, 2), (-2, 2), cmap=None)])\n```\n\nA way around this would be creating our own hsv color map with more than 256 sampling points, but maybe that goes too far for this ticket. For now, should we just keep the old implementation?\n\nReplying to [comment:12 DavidLowry]:\n> The output looks about as I expect. For concreteness, I've included a version (with 300 plot points) here:\n\nYes, I now obtain the same result. When I reported the problem, there was a discontinuity in the color spectrum at about 10 degrees, but it seems to be fixed now.\n\nI still need to take a closer look at the implementation.",
    "created_at": "2022-03-03T18:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472050",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:11 DavidLowry]:
> I almost did this completely. I changed the default `complex_plot` to use my new color implementation. There is a __very small__ difference that can be seen by comparing the outputs of
> 
> {{{
> sage: complex_plot(x^3, (-2, 2), (-2, 2))
> sage: complex_plot(x^3, (-2, 2), (-2, 2), cmap=None) # old default
> }}}
> 
> This seems close enough to me that I'd be happy to remove the old implementation entirely.

The difference is very small, but I cannot fully explain where the difference comes from. On closer inspection, I also noticed that the matplotlib `hsv` color map is discretized (which I did not expect), so one can see a difference when the phase varies very little. For example:

```
graphics_array([complex_plot(x^(1/10)*e^(2*pi*I/10), (-2, 2), (-2, 2)), complex_plot(x^(1/10)*e^(2*pi*I/10), (-2, 2), (-2, 2), cmap=None)])
```

A way around this would be creating our own hsv color map with more than 256 sampling points, but maybe that goes too far for this ticket. For now, should we just keep the old implementation?

Replying to [comment:12 DavidLowry]:
> The output looks about as I expect. For concreteness, I've included a version (with 300 plot points) here:

Yes, I now obtain the same result. When I reported the problem, there was a discontinuity in the color spectrum at about 10 degrees, but it seems to be fixed now.

I still need to take a closer look at the implementation.



---

archive/issue_comments_472051.json:
```json
{
    "body": "I wouldn\u2019t worry too much about minor aliasing differences when there is slight variation (some monitors might not be able to resolve these differences either). That being said, I am not opposed to keeping the current implementation since it does provide slightly better performance and it is already there and working.",
    "created_at": "2022-03-04T00:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472051",
    "user": "https://github.com/tscrim"
}
```

I wouldn’t worry too much about minor aliasing differences when there is slight variation (some monitors might not be able to resolve these differences either). That being said, I am not opposed to keeping the current implementation since it does provide slightly better performance and it is already there and working.



---

archive/issue_comments_472052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-07T15:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472053.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-09T00:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472053",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472054.json:
```json
{
    "body": "Thanks. I am happy with this. Markus, if you want something else changed, feel free to revert the positive review.",
    "created_at": "2022-03-09T00:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472054",
    "user": "https://github.com/tscrim"
}
```

Thanks. I am happy with this. Markus, if you want something else changed, feel free to revert the positive review.



---

archive/issue_comments_472055.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2022-03-09T20:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472055",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_472056.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-03-09T20:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_472057.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-09T20:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472057",
    "user": "https://github.com/davidlowryduda"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472058.json:
```json
{
    "body": "I just realized that I'd mistyped one of the `sphinx_plot` examples in the documentation and had `nphases=20` instead of `nphases=5`. I just corrected this typo. As this consists only of changing two characters, I amended these two characters in the previous commit and force-pushed... maybe this was excessive.\n\nThank you both for your reviews! I tried to use numpy along gh-mwageringel's suggestions, but I wouldn't be too surprised if it were possible to improve my implementation of contours. But there is nothing remaining that I plan on changing or adding.",
    "created_at": "2022-03-09T20:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472058",
    "user": "https://github.com/davidlowryduda"
}
```

I just realized that I'd mistyped one of the `sphinx_plot` examples in the documentation and had `nphases=20` instead of `nphases=5`. I just corrected this typo. As this consists only of changing two characters, I amended these two characters in the previous commit and force-pushed... maybe this was excessive.

Thank you both for your reviews! I tried to use numpy along gh-mwageringel's suggestions, but I wouldn't be too surprised if it were possible to improve my implementation of contours. But there is nothing remaining that I plan on changing or adding.



---

archive/issue_comments_472059.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-09T21:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472059",
    "user": "https://github.com/mwageringel"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_472060.json:
```json
{
    "body": "Sorry for being slow with the review. There are just a few minor things left.\n\nThe `sig_on`/`sig_off` in `complex_to_cmap_rgb` should only contain C/Cython code. Though, they contain calls to Python functions which should be avoided. See the warning about it [here](https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off). You can move the `sig_off` to the end of the `for` loop.\n\nThis color map conversion seems redundant, as this is already done in a different place in the same way (almost, except for the 128 vs 126 difference which seems unintentional):\n\n```\n        if isinstance(cmap, str):\n            if cmap == 'matplotlib':\n                domain = np.linspace(0, 1, 256)\n                shifted_domain = np.roll(domain, 128)\n                default_cmap = mpl.colors.LinearSegmentedColormap.from_list(\n                    \"sage_default\", mpl.cm.get_cmap('hsv')(shifted_domain)\n                )\n                cmap = default_cmap\n            else:\n                cmap = mpl.cm.get_cmap(cmap)\n```\n\n\nThis allocation occurs in two places. I think it is not needed:\n\n```\n    cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgbs = np.empty(dtype=float, shape=(imax, jmax, 3))\n```\n\n\nTypos:\n\n```diff\n-    We see that changing ``dark_rate`` affects how visible contours. In this\n+    We see that changing ``dark_rate`` affects how visible contours are. In this\n     example, we set ``contour_base=5`` and note that the points `0` and `1 + i`\n     are far away from contours, but `2.9 + 4i` is near (and just below) a\n-    contour. Raising ``dark_rate`` should have strong affects on the last\n+    contour. Raising ``dark_rate`` should have strong effects on the last\n```\n\n\nOther than that, everything looks good to me.",
    "created_at": "2022-03-09T21:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472060",
    "user": "https://github.com/mwageringel"
}
```

Sorry for being slow with the review. There are just a few minor things left.

The `sig_on`/`sig_off` in `complex_to_cmap_rgb` should only contain C/Cython code. Though, they contain calls to Python functions which should be avoided. See the warning about it [here](https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off). You can move the `sig_off` to the end of the `for` loop.

This color map conversion seems redundant, as this is already done in a different place in the same way (almost, except for the 128 vs 126 difference which seems unintentional):

```
        if isinstance(cmap, str):
            if cmap == 'matplotlib':
                domain = np.linspace(0, 1, 256)
                shifted_domain = np.roll(domain, 128)
                default_cmap = mpl.colors.LinearSegmentedColormap.from_list(
                    "sage_default", mpl.cm.get_cmap('hsv')(shifted_domain)
                )
                cmap = default_cmap
            else:
                cmap = mpl.cm.get_cmap(cmap)
```


This allocation occurs in two places. I think it is not needed:

```
    cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgbs = np.empty(dtype=float, shape=(imax, jmax, 3))
```


Typos:

```diff
-    We see that changing ``dark_rate`` affects how visible contours. In this
+    We see that changing ``dark_rate`` affects how visible contours are. In this
     example, we set ``contour_base=5`` and note that the points `0` and `1 + i`
     are far away from contours, but `2.9 + 4i` is near (and just below) a
-    contour. Raising ``dark_rate`` should have strong affects on the last
+    contour. Raising ``dark_rate`` should have strong effects on the last
```


Other than that, everything looks good to me.



---

archive/issue_comments_472061.json:
```json
{
    "body": "You can also use `sig_check()` for (e.g., `for`) loops.",
    "created_at": "2022-03-09T23:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472061",
    "user": "https://github.com/tscrim"
}
```

You can also use `sig_check()` for (e.g., `for`) loops.



---

archive/issue_comments_472062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-10T01:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472062",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472063.json:
```json
{
    "body": "Replying to [comment:21 gh-mwageringel]:\n\n> The `sig_on`/`sig_off` in `complex_to_cmap_rgb` should only contain C/Cython code. Though, they contain calls to Python functions which should be avoided. See the warning about it [here](https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off). You can move the `sig_off` to the end of the `for` loop.\n\nI didn't know that! That's good to know. Thanks again.",
    "created_at": "2022-03-10T01:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472063",
    "user": "https://github.com/davidlowryduda"
}
```

Replying to [comment:21 gh-mwageringel]:

> The `sig_on`/`sig_off` in `complex_to_cmap_rgb` should only contain C/Cython code. Though, they contain calls to Python functions which should be avoided. See the warning about it [here](https://cysignals.readthedocs.io/en/latest/interrupt.html#using-sig-on-and-sig-off). You can move the `sig_off` to the end of the `for` loop.

I didn't know that! That's good to know. Thanks again.



---

archive/issue_comments_472064.json:
```json
{
    "body": "> {{{\n>     cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgbs = np.empty(dtype=float, shape=(imax, jmax, 3))\n> }}}\n\nOne last nitpick: There is one more spot where this empty array `rgbs` is allocated, but replaced by a reference to another array later on.",
    "created_at": "2022-03-10T18:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472064",
    "user": "https://github.com/mwageringel"
}
```

> {{{
>     cdef cnumpy.ndarray[cnumpy.float_t, ndim=3, mode='c'] rgbs = np.empty(dtype=float, shape=(imax, jmax, 3))
> }}}

One last nitpick: There is one more spot where this empty array `rgbs` is allocated, but replaced by a reference to another array later on.



---

archive/issue_comments_472065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-10T21:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472065",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472066.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-03-11T17:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472066",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_472067.json:
```json
{
    "body": "Thank you for all the changes. I have fixed one more typo in the documentation and have also run the tests locally.\n----\nNew commits:",
    "created_at": "2022-03-11T17:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472067",
    "user": "https://github.com/mwageringel"
}
```

Thank you for all the changes. I have fixed one more typo in the documentation and have also run the tests locally.
----
New commits:



---

archive/issue_comments_472068.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-03-13T13:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472068",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_472069.json:
```json
{
    "body": "\n```\nFile \"src/sage/plot/complex_plot.pyx\", line 256, in sage.plot.complex_plot.?\nFailed example:\n    complex_to_rgb([[0, 1 + 1j, -3 - 4j]], tiled=True, contour_base=5, nphases=15)\nExpected:\n    array([[[1.        , 0.        , 0.        ],\n            [0.87741543, 0.65806157, 0.        ],\n            [0.        , 0.11124213, 0.97156143]]])\nGot:\n    array([[[1.        , 0.        , 0.        ],\n            [0.87741543, 0.65806157, 0.        ],\n            [0.        , 0.08261755, 0.72156143]]])\n```\n",
    "created_at": "2022-03-13T13:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472069",
    "user": "https://github.com/vbraun"
}
```


```
File "src/sage/plot/complex_plot.pyx", line 256, in sage.plot.complex_plot.?
Failed example:
    complex_to_rgb([[0, 1 + 1j, -3 - 4j]], tiled=True, contour_base=5, nphases=15)
Expected:
    array([[[1.        , 0.        , 0.        ],
            [0.87741543, 0.65806157, 0.        ],
            [0.        , 0.11124213, 0.97156143]]])
Got:
    array([[[1.        , 0.        , 0.        ],
            [0.87741543, 0.65806157, 0.        ],
            [0.        , 0.08261755, 0.72156143]]])
```




---

archive/issue_comments_472070.json:
```json
{
    "body": "Thank you, Volker.\n\n`@`DavidLowry: To explain the problem a bit further, the problem with this test is that it is not numerically stable. I cannot replicate the problem directly, but adding a small perturbation to one of the values demonstrates it:\n\n```\nsage: from sage.plot.complex_plot import complex_to_rgb\nsage: complex_to_rgb([[0, 1 + 1j, -3 - 4j + 1e-9]], tiled=True, contour_base=5, nphases=15)\n[[[1.         0.         0.        ]\n  [0.87741543 0.65806157 0.        ]\n  [0.         0.08261755 0.72156143]]]\n```\n\nProbably, Volker observed the issue on a 32-bit machine, which can lead to numerical differences like this.\n\nIs this a problem with the test or with the implementation, i.e. should the implementation of `complex_to_rgb` yield numerically stable results? I guess the tiling can never be completely stable, but seeing this problem with only three values is a bit unexpected. If it is just the test, maybe you could replace it by a different one.",
    "created_at": "2022-03-14T19:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472070",
    "user": "https://github.com/mwageringel"
}
```

Thank you, Volker.

`@`DavidLowry: To explain the problem a bit further, the problem with this test is that it is not numerically stable. I cannot replicate the problem directly, but adding a small perturbation to one of the values demonstrates it:

```
sage: from sage.plot.complex_plot import complex_to_rgb
sage: complex_to_rgb([[0, 1 + 1j, -3 - 4j + 1e-9]], tiled=True, contour_base=5, nphases=15)
[[[1.         0.         0.        ]
  [0.87741543 0.65806157 0.        ]
  [0.         0.08261755 0.72156143]]]
```

Probably, Volker observed the issue on a 32-bit machine, which can lead to numerical differences like this.

Is this a problem with the test or with the implementation, i.e. should the implementation of `complex_to_rgb` yield numerically stable results? I guess the tiling can never be completely stable, but seeing this problem with only three values is a bit unexpected. If it is just the test, maybe you could replace it by a different one.



---

archive/issue_comments_472071.json:
```json
{
    "body": "Oh, thank you Markus. I couldn't replicate this and didn't understand. But you're right!\n\nLooking at this test case now, I see that this is a poor choice of parameter. I think I chose them to be \"random small numbers\", but the law of small numbers bites here.\n\nThe reason this test acting like this is because a rgb value is being associated to a point lying *exactly* on a contour boundary. Here, contours are associated on powers of `contour_base=5`, and the point has absolute value exactly 5. The actual evaluation of contour boundaries occurs after taking logs, and thus it's reasonable to expect a certain amount of instability.\n\nAway from the contours, these tests should be fine and pretty stable. I'll replace this test with a different one. I'll also make sure that I didn't make this same error elsewhere.",
    "created_at": "2022-03-14T20:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472071",
    "user": "https://github.com/davidlowryduda"
}
```

Oh, thank you Markus. I couldn't replicate this and didn't understand. But you're right!

Looking at this test case now, I see that this is a poor choice of parameter. I think I chose them to be "random small numbers", but the law of small numbers bites here.

The reason this test acting like this is because a rgb value is being associated to a point lying *exactly* on a contour boundary. Here, contours are associated on powers of `contour_base=5`, and the point has absolute value exactly 5. The actual evaluation of contour boundaries occurs after taking logs, and thus it's reasonable to expect a certain amount of instability.

Away from the contours, these tests should be fine and pretty stable. I'll replace this test with a different one. I'll also make sure that I didn't make this same error elsewhere.



---

archive/issue_comments_472072.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-14T20:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472072",
    "user": "https://github.com/davidlowryduda"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_472073.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-03-14T20:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472073",
    "user": "https://github.com/davidlowryduda"
}
```

New commits:



---

archive/issue_comments_472074.json:
```json
{
    "body": "I actually wonder how much we have to worry about numerical noise. Perhaps we can modify these doctests to not have explicit values? Maybe just the first two or three sigfigs with `...`?",
    "created_at": "2022-03-14T23:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472074",
    "user": "https://github.com/tscrim"
}
```

I actually wonder how much we have to worry about numerical noise. Perhaps we can modify these doctests to not have explicit values? Maybe just the first two or three sigfigs with `...`?



---

archive/issue_comments_472075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-15T21:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472076.json:
```json
{
    "body": "`@`tscrim That makes sense to me. I've incorporated a pretty general absolute tolerance into the tests.",
    "created_at": "2022-03-15T21:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472076",
    "user": "https://github.com/davidlowryduda"
}
```

`@`tscrim That makes sense to me. I've incorporated a pretty general absolute tolerance into the tests.



---

archive/issue_comments_472077.json:
```json
{
    "body": "Thanks. I changed some numbers to verify that the tolerance works. Two last little changes: The doctests on lines 1104 and 1114 should be marked as `# long time` since they take >3s on my (new fast) desktop. Once that is done, you can (re)set a positive review on my behalf.",
    "created_at": "2022-03-16T00:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472077",
    "user": "https://github.com/tscrim"
}
```

Thanks. I changed some numbers to verify that the tolerance works. Two last little changes: The doctests on lines 1104 and 1114 should be marked as `# long time` since they take >3s on my (new fast) desktop. Once that is done, you can (re)set a positive review on my behalf.



---

archive/issue_comments_472078.json:
```json
{
    "body": "Minor suggestion:\n\n```diff\n .. [LD2021] David Lowry-Duda.\n             *Visualizing modular forms*.\n-            Arithmetic Geometry, Number Theory, and Computation, Simons\n-            Symposia, Springer, 2021.\n+            Arithmetic Geometry, Number Theory, and Computation.\n+            Simons Symposia, Springer, 2021.\n             :arxiv:`2002.05234`\n```\n",
    "created_at": "2022-03-16T08:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472078",
    "user": "https://github.com/slel"
}
```

Minor suggestion:

```diff
 .. [LD2021] David Lowry-Duda.
             *Visualizing modular forms*.
-            Arithmetic Geometry, Number Theory, and Computation, Simons
-            Symposia, Springer, 2021.
+            Arithmetic Geometry, Number Theory, and Computation.
+            Simons Symposia, Springer, 2021.
             :arxiv:`2002.05234`
```




---

archive/issue_comments_472079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-16T15:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472080.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-16T15:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472080",
    "user": "https://github.com/davidlowryduda"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472081.json:
```json
{
    "body": "Thanks `@`tscrim and `@`slelievre. I've made these changes. And at `@`tscrim's suggestion, I'm also marking this positively reviewed.",
    "created_at": "2022-03-16T15:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472081",
    "user": "https://github.com/davidlowryduda"
}
```

Thanks `@`tscrim and `@`slelievre. I've made these changes. And at `@`tscrim's suggestion, I'm also marking this positively reviewed.



---

archive/issue_comments_472082.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-21T23:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33179#issuecomment-472082",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
