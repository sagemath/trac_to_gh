# Issue 33118: Generate coverage results and upload to codecov

archive/issues_033118.json:
```json
{
    "body": "CC:  @mkoeppe\n\nUse coverage.py to generate coverage results for the sage source code based on the test execution. In contrast to sage's na\u00efve coverage tool, this not only looks for the existence of doctests for a method but actually measures which lines are actually executed by the tests.\n\nThese coverage results are then uploaded to codecov, where one can inspect the results. See https://codecov.io/gh/sagemath/sagetrac-mirror/tree/ec045eb0168b937e35375e803979975df4aa6564/src/sage for the current coverage. Codecov also displays the coverage of changed files, so that one can easily check if changes are indeed covered by tests. An example would be https://codecov.io/gh/sagemath/sagetrac-mirror/commit/ec045eb0168b937e35375e803979975df4aa6564 but there are of course no changes in python files in this ticket, so it shows nothing interesting. For a more interesting example from a different project see eg https://app.codecov.io/gh/JabRef/jabref/commit/2494509f2d75426bd7369b358880e7ffed2a47b4. The idea would be to add the link to such a report as a new badge in the trac ticket (after this ticket here is merged). \n\nRun: https://github.com/sagemath/sagetrac-mirror/actions/workflows/build.yml?query=branch%3Apublic/build/codecov\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33355\n\n",
    "closed_at": "2022-03-08T08:12:09Z",
    "created_at": "2022-02-15T20:44:14Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Generate coverage results and upload to codecov",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33118",
    "user": "https://github.com/tobiasdiez"
}
```
CC:  @mkoeppe

Use coverage.py to generate coverage results for the sage source code based on the test execution. In contrast to sage's na√Øve coverage tool, this not only looks for the existence of doctests for a method but actually measures which lines are actually executed by the tests.

These coverage results are then uploaded to codecov, where one can inspect the results. See https://codecov.io/gh/sagemath/sagetrac-mirror/tree/ec045eb0168b937e35375e803979975df4aa6564/src/sage for the current coverage. Codecov also displays the coverage of changed files, so that one can easily check if changes are indeed covered by tests. An example would be https://codecov.io/gh/sagemath/sagetrac-mirror/commit/ec045eb0168b937e35375e803979975df4aa6564 but there are of course no changes in python files in this ticket, so it shows nothing interesting. For a more interesting example from a different project see eg https://app.codecov.io/gh/JabRef/jabref/commit/2494509f2d75426bd7369b358880e7ffed2a47b4. The idea would be to add the link to such a report as a new badge in the trac ticket (after this ticket here is merged). 

Run: https://github.com/sagemath/sagetrac-mirror/actions/workflows/build.yml?query=branch%3Apublic/build/codecov


Issue created by migration from https://trac.sagemath.org/ticket/33355





---

archive/issue_comments_471375.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-15T23:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471375",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471376.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2022-02-16T12:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471376",
    "user": "https://github.com/tobiasdiez"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_471377.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-02-16T12:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471377",
    "user": "https://github.com/tobiasdiez"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_471378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T12:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471379.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T13:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T16:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471381.json:
```json
{
    "body": "Use `sage -sh -c \"....\"` to run a shell command `....` in the Sage environment.",
    "created_at": "2022-02-17T16:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471381",
    "user": "https://github.com/mkoeppe"
}
```

Use `sage -sh -c "...."` to run a shell command `....` in the Sage environment.



---

archive/issue_comments_471382.json:
```json
{
    "body": "Or use `sage -python -m coverage ...`",
    "created_at": "2022-02-17T16:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471382",
    "user": "https://github.com/mkoeppe"
}
```

Or use `sage -python -m coverage ...`



---

archive/issue_comments_471383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T17:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471383",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T19:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471384",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471385.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-18T12:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471385",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471386.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-18T21:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471386",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471387.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-19T10:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471387",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471388.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-19T10:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471388",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471389.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-19T11:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471389",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471390.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> Or use `sage -python -m coverage ...`\n\n\nThanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)\n\nI just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?",
    "created_at": "2022-02-19T18:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471390",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:7 mkoeppe]:
> Or use `sage -python -m coverage ...`


Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)

I just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?



---

archive/issue_comments_471391.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-19T19:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471391",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471392.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> Replying to [comment:7 mkoeppe]:\n> > Or use `sage -python -m coverage ...`\n\n> \n> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)\n\n\nThis is a goal that has not been achieved yet. What `sage-env` does is still needed for some things in the Sage library. See for example #31296.",
    "created_at": "2022-02-19T20:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471392",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:7 mkoeppe]:
> > Or use `sage -python -m coverage ...`

> 
> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)


This is a goal that has not been achieved yet. What `sage-env` does is still needed for some things in the Sage library. See for example #31296.



---

archive/issue_comments_471393.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> Replying to [comment:7 mkoeppe]:\n> > Or use `sage -python -m coverage ...`\n\n> \n> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)\n> \n> I just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?\n\n\nI added `git` to `-recommended`, see #33296, #33277, but we're not building the image yet. We could replace `-standard` but `-recommended`. Probably best after #33062.\n\nYou don't need `sudo`, you are running as `root`.",
    "created_at": "2022-02-19T20:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471393",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:7 mkoeppe]:
> > Or use `sage -python -m coverage ...`

> 
> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)
> 
> I just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?


I added `git` to `-recommended`, see #33296, #33277, but we're not building the image yet. We could replace `-standard` but `-recommended`. Probably best after #33062.

You don't need `sudo`, you are running as `root`.



---

archive/issue_comments_471394.json:
```json
{
    "body": "Replying to [comment:18 mkoeppe]:\n> You don't need `sudo`, you are running as `root`.\n\n\nIt's more for convenience and coherence - normally github actions don't run as sudo.",
    "created_at": "2022-03-02T12:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471394",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:18 mkoeppe]:
> You don't need `sudo`, you are running as `root`.


It's more for convenience and coherence - normally github actions don't run as sudo.



---

archive/issue_comments_471395.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-02T12:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471395",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471396.json:
```json
{
    "body": "I am getting\n\"There was a problem getting the source code from your provider. Unable to show line by line coverage. \"\n\nhttps://app.codecov.io/gh/sagemath/sagetrac-mirror/blob/ec045eb0168b937e35375e803979975df4aa6564/src/sage/categories/chain_complexes.py",
    "created_at": "2022-03-02T17:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471396",
    "user": "https://github.com/mkoeppe"
}
```

I am getting
"There was a problem getting the source code from your provider. Unable to show line by line coverage. "

https://app.codecov.io/gh/sagemath/sagetrac-mirror/blob/ec045eb0168b937e35375e803979975df4aa6564/src/sage/categories/chain_complexes.py



---

archive/issue_comments_471397.json:
```json
{
    "body": "The link is working for me. Maybe a temporary issues on their side?",
    "created_at": "2022-03-02T17:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471397",
    "user": "https://github.com/tobiasdiez"
}
```

The link is working for me. Maybe a temporary issues on their side?



---

archive/issue_comments_471398.json:
```json
{
    "body": "Working now for me too",
    "created_at": "2022-03-02T19:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471398",
    "user": "https://github.com/mkoeppe"
}
```

Working now for me too



---

archive/issue_comments_471399.json:
```json
{
    "body": "Looking great, thanks for this work!",
    "created_at": "2022-03-02T19:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471399",
    "user": "https://github.com/mkoeppe"
}
```

Looking great, thanks for this work!



---

archive/issue_comments_471400.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-02T19:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471400",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471401.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2022-03-02T20:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471401",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the review!



---

archive/issue_comments_471402.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-08T08:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471402",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088002.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-08T08:12:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33118#event-88002"
}
```



---

archive/issue_comments_471403.json:
```json
{
    "body": "currently not working in the \"Build and Test\" badge, shouting :\n\n```\nRun ./venv/bin/python3 -m coverage combine src/.coverage/\n  ./venv/bin/python3 -m coverage combine src/.coverage/\n  ./venv/bin/python3 -m coverage xml\n  find . -name *coverage*\n  shell: sh -e {0}\nCouldn't combine from non-existent path 'src/.coverage/'\nError: Process completed with exit code 1.\n```",
    "created_at": "2022-03-31T19:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471403",
    "user": "https://github.com/fchapoton"
}
```

currently not working in the "Build and Test" badge, shouting :

```
Run ./venv/bin/python3 -m coverage combine src/.coverage/
  ./venv/bin/python3 -m coverage combine src/.coverage/
  ./venv/bin/python3 -m coverage xml
  find . -name *coverage*
  shell: sh -e {0}
Couldn't combine from non-existent path 'src/.coverage/'
Error: Process completed with exit code 1.
```



---

archive/issue_comments_471404.json:
```json
{
    "body": "Which ticket shows this behavior? It is still working correctly in the latest beta: https://github.com/sagemath/sagetrac-mirror/runs/5710760370?check_suite_focus=true",
    "created_at": "2022-03-31T19:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471404",
    "user": "https://github.com/tobiasdiez"
}
```

Which ticket shows this behavior? It is still working correctly in the latest beta: https://github.com/sagemath/sagetrac-mirror/runs/5710760370?check_suite_focus=true



---

archive/issue_comments_471405.json:
```json
{
    "body": "see #33629 for example",
    "created_at": "2022-04-02T10:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471405",
    "user": "https://github.com/fchapoton"
}
```

see #33629 for example



---

archive/issue_comments_471406.json:
```json
{
    "body": "Okay, was actually an issue with pyright. Fixed in #33631.",
    "created_at": "2022-04-02T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471406",
    "user": "https://github.com/tobiasdiez"
}
```

Okay, was actually an issue with pyright. Fixed in #33631.



---

archive/issue_comments_471407.json:
```json
{
    "body": "Can we get the badge now?",
    "created_at": "2022-04-05T04:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471407",
    "user": "https://github.com/mkoeppe"
}
```

Can we get the badge now?



---

archive/issue_comments_471408.json:
```json
{
    "body": "the badge \"Build & Test\" is still broken by problems about coverage\n\nfor example, see\n\nhttps://github.com/sagemath/sagetrac-mirror/runs/6117339523?check_suite_focus=true\n\nshouting\n\n```\nRun ./venv/bin/python3 -m coverage combine src/.coverage/\n6\n/__w/sagetrac-mirror/sagetrac-mirror/venv/bin/python3: No module named coverage\n7\nError: Process completed with exit code 1.\n```",
    "created_at": "2022-04-22T06:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471408",
    "user": "https://github.com/fchapoton"
}
```

the badge "Build & Test" is still broken by problems about coverage

for example, see

https://github.com/sagemath/sagetrac-mirror/runs/6117339523?check_suite_focus=true

shouting

```
Run ./venv/bin/python3 -m coverage combine src/.coverage/
6
/__w/sagetrac-mirror/sagetrac-mirror/venv/bin/python3: No module named coverage
7
Error: Process completed with exit code 1.
```



---

archive/issue_comments_471409.json:
```json
{
    "body": "I've opened #33747 for this",
    "created_at": "2022-04-22T22:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33118#issuecomment-471409",
    "user": "https://github.com/mkoeppe"
}
```

I've opened #33747 for this
