# Issue 33118: Generate coverage results and upload to codecov

Issue created by migration from https://trac.sagemath.org/ticket/33355

Original creator: @tobiasdiez

Original creation time: 2022-02-15 20:44:14

CC:  mkoeppe




---

Comment by git created at 2022-02-15 23:06:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-16 12:41:24

Changing component from PLEASE CHANGE to build.


---

Comment by @tobiasdiez created at 2022-02-16 12:41:24

Changing type from PLEASE CHANGE to enhancement.


---

Comment by git created at 2022-02-17 12:38:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-17 13:26:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-17 16:09:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-17 16:46:22

Use `sage -sh -c "...."` to run a shell command `....` in the Sage environment.


---

Comment by mkoeppe created at 2022-02-17 16:48:11

Or use `sage -python -m coverage ...`


---

Comment by git created at 2022-02-17 17:08:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-17 19:31:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-18 12:55:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-18 21:59:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 10:05:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 10:05:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 11:36:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-19 18:58:13

Replying to [comment:7 mkoeppe]:
> Or use `sage -python -m coverage ...`

Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)

I just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?


---

Comment by git created at 2022-02-19 19:26:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-19 20:02:12

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:7 mkoeppe]:
> > Or use `sage -python -m coverage ...`
> 
> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)

This is a goal that has not been achieved yet. What `sage-env` does is still needed for some things in the Sage library. See for example #31296.


---

Comment by mkoeppe created at 2022-02-19 20:10:50

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:7 mkoeppe]:
> > Or use `sage -python -m coverage ...`
> 
> Thanks that worked well! (Why is this command actually necessary? I thought its the job of `sage-conf` to handle all environment variables)
> 
> I just noticed that elementary things like git and sudo are missing in the standard docker image. Would it make sense to add these tools?

I added `git` to `-recommended`, see #33296, #33277, but we're not building the image yet. We could replace `-standard` but `-recommended`. Probably best after #33062.

You don't need `sudo`, you are running as `root`.


---

Comment by @tobiasdiez created at 2022-03-02 12:47:54

Replying to [comment:18 mkoeppe]:
> You don't need `sudo`, you are running as `root`.

It's more for convenience and coherence - normally github actions don't run as sudo.


---

Comment by @tobiasdiez created at 2022-03-02 12:59:05

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-02 17:14:56

I am getting
"There was a problem getting the source code from your provider. Unable to show line by line coverage. "

https://app.codecov.io/gh/sagemath/sagetrac-mirror/blob/ec045eb0168b937e35375e803979975df4aa6564/src/sage/categories/chain_complexes.py


---

Comment by @tobiasdiez created at 2022-03-02 17:57:48

The link is working for me. Maybe a temporary issues on their side?


---

Comment by mkoeppe created at 2022-03-02 19:44:29

Working now for me too


---

Comment by mkoeppe created at 2022-03-02 19:47:52

Looking great, thanks for this work!


---

Comment by mkoeppe created at 2022-03-02 19:47:52

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-02 20:15:05

Thanks for the review!


---

Comment by vbraun created at 2022-03-08 08:12:09

Resolution: fixed


---

Comment by chapoton created at 2022-03-31 19:00:22

currently not working in the "Build and Test" badge, shouting :

```
Run ./venv/bin/python3 -m coverage combine src/.coverage/
  ./venv/bin/python3 -m coverage combine src/.coverage/
  ./venv/bin/python3 -m coverage xml
  find . -name *coverage*
  shell: sh -e {0}
Couldn't combine from non-existent path 'src/.coverage/'
Error: Process completed with exit code 1.
```



---

Comment by @tobiasdiez created at 2022-03-31 19:10:02

Which ticket shows this behavior? It is still working correctly in the latest beta: https://github.com/sagemath/sagetrac-mirror/runs/5710760370?check_suite_focus=true


---

Comment by chapoton created at 2022-04-02 10:09:03

see #33629 for example


---

Comment by @tobiasdiez created at 2022-04-02 11:38:52

Okay, was actually an issue with pyright. Fixed in #33631.


---

Comment by mkoeppe created at 2022-04-05 04:40:55

Can we get the badge now?


---

Comment by chapoton created at 2022-04-22 06:43:12

the badge "Build & Test" is still broken by problems about coverage

for example, see

https://github.com/sagemath/sagetrac-mirror/runs/6117339523?check_suite_focus=true

shouting

```
Run ./venv/bin/python3 -m coverage combine src/.coverage/
6
/__w/sagetrac-mirror/sagetrac-mirror/venv/bin/python3: No module named coverage
7
Error: Process completed with exit code 1.
```



---

Comment by mkoeppe created at 2022-04-22 22:01:29

I've opened #33747 for this
