# Issue 33185: Bug in equivalence_decomposition of inductive valuation

archive/issues_033185.json:
```json
{
    "body": "CC:  saraedum swewers\n\nKeywords: valuation, maclane\n\nThe following application of sage.rings.valuation.inductive_valuation.py's method `equivalence_decomposition` produces an assertion error, see [https://github.com/MCLF/mclf/issues/109](https://github.com/MCLF/mclf/issues/109).\n\n```\nsage: R.<x> = QQ[]\nsage: v_7 = QQ.valuation(7)\nsage: v0 = GaussValuation(R, v_7)\nsage: v1 = v0.augmentation(x, 3/2)\nsage: v2 = v1.augmentation(x^2-686, 7/2)\nsage: f = x^4 - 8001504*x^2 - 592815428352\nsage: v2.equivalence_decomposition(f)\n```\n\n\nThe error comes from the assertion \n\n```\nassert self.is_equivalent(ret.prod(), f)\n```\n\nwhere the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.\n\nThe problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in lift_to_key. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. \n\nIn this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.\n\nI have a fix for it and will implement it in a branch asap.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33422\n\n",
    "created_at": "2022-02-27T20:22:24Z",
    "labels": [
        "commutative algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Bug in equivalence_decomposition of inductive valuation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33185",
    "user": "@oossen"
}
```
CC:  saraedum swewers

Keywords: valuation, maclane

The following application of sage.rings.valuation.inductive_valuation.py's method `equivalence_decomposition` produces an assertion error, see [https://github.com/MCLF/mclf/issues/109](https://github.com/MCLF/mclf/issues/109).

```
sage: R.<x> = QQ[]
sage: v_7 = QQ.valuation(7)
sage: v0 = GaussValuation(R, v_7)
sage: v1 = v0.augmentation(x, 3/2)
sage: v2 = v1.augmentation(x^2-686, 7/2)
sage: f = x^4 - 8001504*x^2 - 592815428352
sage: v2.equivalence_decomposition(f)
```


The error comes from the assertion 

```
assert self.is_equivalent(ret.prod(), f)
```

where the input *f* does not agree with the product of the factorization computed. Its unit part is wrong, *2* instead of *1*.

The problem is as follows. The polynomial *f* gets reduced to *x<sup>2</sup>+1*, whose lift *x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139* is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in lift_to_key. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 

In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of *2*.

I have a fix for it and will implement it in a branch asap.

Issue created by migration from https://trac.sagemath.org/ticket/33422





---

archive/issue_comments_472696.json:
```json
{
    "body": "Explanation of the change:\n\nThe method described in `lift_to_key` lifts an irreducible factor of the reduction and then essentially multiplies it with the polynomial called \\phi_k<sup>{\\tau\\sharp}</sup> by MacLane. `equivalence_decomposition` just wants to keep track of this change in unit by multiplying with an element of appropriate valuation, but that's not the right choice in general. Instead we can just multiply with the right power of the reciprocal \\phi_k<sup>{\\tau\\flat}</sup> (which has its own method in Sage, `_Q_reciprocal`).\n----\nNew commits:",
    "created_at": "2022-03-06T11:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33185#issuecomment-472696",
    "user": "@oossen"
}
```

Explanation of the change:

The method described in `lift_to_key` lifts an irreducible factor of the reduction and then essentially multiplies it with the polynomial called \phi_k<sup>{\tau\sharp}</sup> by MacLane. `equivalence_decomposition` just wants to keep track of this change in unit by multiplying with an element of appropriate valuation, but that's not the right choice in general. Instead we can just multiply with the right power of the reciprocal \phi_k<sup>{\tau\flat}</sup> (which has its own method in Sage, `_Q_reciprocal`).
----
New commits:



---

archive/issue_comments_472697.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-06T11:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33185#issuecomment-472697",
    "user": "@oossen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_472698.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-13T20:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33185#issuecomment-472698",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472699.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-02T10:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33185#issuecomment-472699",
    "user": "vbraun"
}
```

Resolution: fixed
