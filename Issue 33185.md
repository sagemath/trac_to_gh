# Issue 33185: Bug in equivalence_decomposition of inductive valuation

Issue created by migration from https://trac.sagemath.org/ticket/33422

Original creator: @oossen

Original creation time: 2022-02-27 20:22:24

CC:  saraedum swewers

Keywords: valuation, maclane

The following application of sage.rings.valuation.inductive_valuation.py's method `equivalence_decomposition` produces an assertion error, see [https://github.com/MCLF/mclf/issues/109](https://github.com/MCLF/mclf/issues/109).

```
sage: R.<x> = QQ[]
sage: v_7 = QQ.valuation(7)
sage: v0 = GaussValuation(R, v_7)
sage: v1 = v0.augmentation(x, 3/2)
sage: v2 = v1.augmentation(x^2-686, 7/2)
sage: f = x^4 - 8001504*x^2 - 592815428352
sage: v2.equivalence_decomposition(f)
```


The error comes from the assertion 

```
assert self.is_equivalent(ret.prod(), f)
```

where the input _f_ does not agree with the product of the factorization computed. Its unit part is wrong, _2_ instead of _1_.

The problem is as follows. The polynomial _f_ gets reduced to _x<sup>2</sup>+1_, whose lift _x<sup>4</sup> - 343/2*x<sup>2</sup> + 1294139_ is the only key in the factorization. To take care of its unit part, we add `equivalence_unit(-7, reciprocal=True)` to the unit. But this isn't actually the unit implicit in lift_to_key. There, we use the augmented valuation v_2's method `_Q()`. What this comes down to is adding `equivalence_unit(-7/2, reciprocal=True)^2` to the unit. 

In this example, this does not work: `equivalence_unit(-7, reciprocal=True)` and `equivalence_unit(-7/2, reciprocal=True)^2` are not equivalent, they differ by a factor of _2_.

I have a fix for it and will implement it in a branch asap.


---

Comment by @oossen created at 2022-03-06 11:32:30

Explanation of the change:

The method described in `lift_to_key` lifts an irreducible factor of the reduction and then essentially multiplies it with the polynomial called \phi_k<sup>{\tau\sharp}</sup> by MacLane. `equivalence_decomposition` just wants to keep track of this change in unit by multiplying with an element of appropriate valuation, but that's not the right choice in general. Instead we can just multiply with the right power of the reciprocal \phi_k<sup>{\tau\flat}</sup> (which has its own method in Sage, `_Q_reciprocal`).
----
New commits:


---

Comment by @oossen created at 2022-03-06 11:35:38

Changing status from new to needs_review.


---

Comment by saraedum created at 2022-03-13 20:18:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-04-02 10:52:27

Resolution: fixed
