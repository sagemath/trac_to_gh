# Issue 11187: ECL does not fully recover from relocation

Issue created by migration from https://trac.sagemath.org/ticket/11359

Original creator: nbruin

Original creation time: 2011-05-20 15:35:32

Assignee: GeorgSWeber

Keywords: ecl relocation

It has been reported that after the Sage tree is relocated, e.g.

```
mv /usr/local/sage-4.6.2 /usr/local/sage-new-location
```

it is not possible to reinstall a maxima spkg anymore. This indicates that there are components of ecl that are sensitive to location and are not properly adjusted (I think the script `sage-location` is responsible for that).

See also #11348 and [this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/4da7b0076f74d912/4a1f17eecbbdf064).


---

Comment by nbruin created at 2011-05-20 19:44:52

One problem (perhaps the only one?) is that ECL uses the C compiler for compiling lisp (much like cython) and gives it include paths and library paths that it found out upon configuration. `local/bin/sage-location` is obviously not updating those. Example in a relocated "sage -ecl":

```
(defun f (x y) (+ x y))
(compile 'f) ;; fails
(setf c::*ecl-include-directory* (concatenate 'string (SI:GETENV "SAGE_ROOT") "/local/include/"))
(setf c::*ecl-library-directory* (concatenate 'string (SI:GETENV "SAGE_ROOT") "/local/lib/"))
(compile 'f) ;; now it works
```

There is a slight problem that the paths also end up in other variables (perhaps because of the way that sage calls configure when configuring ECL?):

```
> c::*cc-flags*

" -I/usr/local/sage/4.6.2-copy/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux"
> c::*ld-flags*

" -L/usr/local/sage/4.6.2-copy/local/lib  -lecl  -lgmp -lgc -ldl  -lm "
```

Since it is a bit unsanitary to have references to old locations lying around (one might link to wrong versions of libraries if the old location still exists!), we should probably strip those variables as well.

Possible solutions:
 - Patch ECL so that the above code is used to initialize these variables
 - Wrap our invocation of ECL so that we always update the values of these variables
 - equip `local/bin/sage-location` with the logic to update the relevant parts of ECL. That probably means recompiling (part of) ECL, because these values will be stored as a string in a ".fas"-file somewhere, which essentially a ".so".


---

Comment by nbruin created at 2011-05-20 21:41:26

Confirmed! This seems to be indeed the only problem. I did the following in `local/bin`

```
$ mv ecl ecl.bin
$ cat <<<EOF >ecl
#!/bin/sh
exec ecl.bin \
  -eval '(setf c::*ecl-include-directory* (concatenate '"'"'string (SI:GETENV "SAGE_ROOT") "/local/include/"))'\
  -eval '(setf c::*ecl-library-directory* (concatenate '"'"'string (SI:GETENV "SAGE_ROOT") "/local/lib/"))' \
  "$@"
EOF
$ chmod a+x ecl
```

after which rebuilding maxima succeeds in a relocated position.

Note that this piece of code does not scrub c::*cc-flags* or c::*ld-flags* yet.

The definitions for the default values of these variables seem to live in
spkg/build/ecl-*/src/src/cmp/cmpdefs.lsp
so that is probably what we need to patch.


---

Comment by nbruin created at 2011-05-21 01:36:26

The dirty `c::*cc-flags*` and `c::*ld-flags` are our own fault. In the ECL spkg-install we have the lines:

```
CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
```

but we are adding paths there, not flags! It needs the include path to find the boehm-gc headers, but our library search paths should already be set up. Can we instead just do

```
C_INCLUDE_PATH="$SAGE_LOCAL/include"
export C_INCLUDE_PATH
```

If the library really needs to be mentioned here, perhaps also a

```
LIBRARY_PATH="$SAGE_LOCAL/lib"
export LIBRARY_PATH
```

but I think we can leave that one out. With this I get an ECL where we obtain

```
> (require 'cmp)
> c::*cc-flags*

" -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux"
> c::*ld-flags*

"  -lecl  -lgmp -lgc -ldl  -lm "
```

so no paths in the flags variables anymore! That just leaves figuring out where best to change the values of the *ecl-...-directory* variables.


---

Comment by nbruin created at 2011-05-21 22:03:26

The following two fixes resolve the issues

## Cleaning paths from *..-flags* variables

In `<ECL-PACKAGE>/spkg-install` replace the lines

```
CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
```

by

```
C_INCLUDE_PATH="$SAGE_LOCAL/include"
export C_INCLUDE_PATH
```

(web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)

## Making initialization of *ecl-...-directory* variables runtime

Patch `<ECL-PACKAGE>/src/src/cmp/cmpdefs.lsp` such that the lines

```
(defvar *ecl-include-directory* @includedir\@)
(defvar *ecl-library-directory* @libdir\@)
```

are replaced by

```
;;; The following code sets the default values of the include and library directories used for
;;; invocation of the C-compiler during compilation to values relative to ECL's idea
;;; of the current "system" directory. The logical pathname "SYS:" normally points to
;;; ".../local/lib/ecl", where "..." would normally be "/usr" (if ECL is installed in
;;; "/usr/local"). So, we strip off the last 2 components of "SYS:" and append "include" or
;;; "lib". This results in the values
;;;   ".../local/lib/"  and  ".../local/include/"  in the above example.
;;; Since this substitution happens at runtime, these values get adjusted appropriately if
;;; the ".../local" tree gets relocated.
(defvar *ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("include")))))
(defvar *ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("lib")))))
```



---

Comment by nbruin created at 2011-05-21 22:16:48

## Avoiding patching ECL
The role of `defvar` is 2-fold: It declares a variable to have dynamic scoping rather than lexical scoping and it sets the value _only_ if the variable wasn't bound already. So, as long as we execute the two defvar statements

```
(defvar c::*ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("include")))))
(defvar c::*ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("lib")))))
```

before the compiler package is loaded, our values will persist. So, if one finds another file of lisp instructions that are guaranteed to be executed upon ECL startup (`~/.eclrc` doesn't work because maxima is built by calling `ecl -norc`) we're still good. I was not able to find such a file.


---

Comment by fbissey created at 2011-05-21 22:22:39

So do we have to do two things here? Reworking spkg-install and the relocation script or just one of them is enough? And then at what stage?

I am ready to cut a new ecl spkg for 4.7.1 if needed. I could take the opportunity to update maxima to 5.24.0 at the same time.


---

Comment by nbruin created at 2011-05-21 22:56:49

Replying to [comment:6 fbissey]:
> So do we have to do two things here? Reworking spkg-install

Yes, that *and* patch ECL.

> and the relocation script

No changes to relocation script required. The patch to ECL means that the default values for the `*ecl-...-library*` variables are derived from a quantity that is already aware of ECL's runtime location.

So both changes are necessary and both are to the ecl spkg and both take effect at ECL build-time (well, the patch of course also changes ECL's runtime behaviour. Since a large part of building ECL consists of ECL compiling itself, the two overlap)

(the comment about avoiding patching ECL is just recording possible avenues someone might pursue if they feel really reluctant to patch ECL)


---

Comment by fbissey created at 2011-05-21 23:06:38

I am for the less intrusive option but I am also pragmatic if it is far more practical to patch ecl itself.
Your option for not patching ecl would involve calling ecl before compiling any lisp code right? Which means before building maxima and sage/libs/ecl.pyx in sage if I understand correctly. The second one especially bother me so patching may be the best avenue.


---

Comment by nbruin created at 2011-05-21 23:30:41

Actually, for sage/libs/ecl.pyx it's not so much of a problem, since our initialization of ecllib involves sending some instructions there anyway, so we could just add the `defvar`s there. It would add a minuscule overhead for something that is unlikely to have any effect anyway: Who's going to use embedded ECL to compile something? That is one reason to prefer the patch to the compiler package already.

For fixing the behaviour of the ECL executable I haven't actually found a solution other than wrapping it with a shell script, which really does add considerable overhead.

Patching is definitely the cleaner solution, but will likely be with us in perpetuity, with all the extra maintenance of rebasing the patch with any ECL upgrade.


---

Comment by fbissey created at 2011-05-22 00:36:57

OK. I am putting cutting a patched ecl according to your instruction on my TODO list for the week starting tomorrow. Like I said I'll probably cut a new maxima as well only
one non trivial doctest is being broken by 5.24.0 so it is easy work.


---

Comment by nbruin created at 2011-05-22 22:03:18

## Avoiding patching ECL in a future release

The development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:

```
(in-package "SI")
(defun customized-boot ()
   (defparameter *ecl-include-directory* ...)
   (si::top-level t))
```

and then add the following options to ECL's configure:

```
--with-extra-files="/path/to/sage.lsp"
--with-init-form='(si::customized-boot)'
```

This option is not available in 11.1.1 yet.


---

Comment by fbissey created at 2011-05-22 22:37:40

Replying to [comment:11 nbruin]:
> == Avoiding patching ECL in a future release ==
> 
> The development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:
> {{{
> (in-package "SI")
> (defun customized-boot ()
>    (defparameter *ecl-include-directory* ...)
>    (si::top-level t))
> }}}
> and then add the following options to ECL's configure:
> {{{
> --with-extra-files="/path/to/sage.lsp"
> --with-init-form='(si::customized-boot)'
> }}}
> This option is not available in 11.1.1 yet.

Should we delay making a new spkg until it is released or do you think
we should still do it now with a note to check ecl at the next rev-bump?


---

Comment by nbruin created at 2011-05-23 01:24:49

Replying to [comment:12 fbissey]:
> Should we delay making a new spkg until it is released or do you think
> we should still do it now with a note to check ecl at the next rev-bump?
That depends on how urgently people think this needs fixing. Given that in practice, it only affects people wanting to build maxima on a moved Sage install and that they have a reasonable workaround of rebuilding ecl first (which builds quickly), I'd say this can wait. But if you're going to make a new ECL package anyway, I'd say patch the flaw, or at least the CCFLAGS thing.


---

Comment by fbissey created at 2011-05-23 04:12:23

I am not in a particular hurry as I have other things I'd like to do. So unless there is pressure to do so. I'll wait for the next ecl.


---

Comment by jdemeyer created at 2013-05-30 13:00:42

Changing priority from minor to blocker.


---

Comment by jdemeyer created at 2013-05-30 13:00:42

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-05-30 13:00:42

Changing component from build to packages: standard.


---

Attachment

Whats with the CFLAGS discussion on the ticket? Not necessary any more? The new spkg doesn't address that, it just implements a workaround for broken include paths.


---

Comment by jdemeyer created at 2013-05-30 13:28:06

Replying to [comment:16 vbraun]:
> The new spkg doesn't address that, it just implements a workaround for broken include paths.
True, but I guess this workaround is sufficient if it makes maxima build.


---

Comment by nbruin created at 2013-05-30 13:55:28

I think the c-flags are still a problem. Try this

```
sage -ecl
> (defun f (x y) (+ x y))
> (compile 'f) ;; make sure the compiler package is loaded and initialized
>  c::*cc-flags*
" -I/usr/local/sage/5.9b4/local/include -I/usr/local/sage/5.9b4/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC -Dlinux"
> c::*ld-flags*
" -L/usr/local/sage/5.9b4/local/lib -Wl,--rpath,/usr/local/sage/5.9b4/local/lib -L/usr/local/sage/5.9b4/local/lib -lecl  -lgmp -lgc -ldl  -lm "
```

I didn't check, but I assume these paths are still hardcoded and hence not adjusted by relocation. We're putting the "-I" and I think also the "-L" directives into those paths upon ecl config-and-build time. They are just not the right spot to put those. We'd be better off letting the environment be so that these things are found automatically, e.g. via setting the appropriate link paths (already done) and include search paths (for instance via `C_INCLUDE_PATH`).

Failing that, we need to patch ECL so that these paths get set relative to `$SAGE_ROOT`, evaluated at ecl invokation time rather than during ecl package build.

As explained above, we can now also avoid patching sage and instead configure sage to include our own customized ecl boot routine to set up the environment with the appropriate path information during ecl invokation.


---

Comment by leif created at 2013-05-30 16:42:36

Replying to [comment:4 nbruin]:
> == Cleaning paths from *..-flags* variables ==
> 
> In `<ECL-PACKAGE>/spkg-install` replace the lines
> {{{
> CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
> LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
> }}}
> by
> {{{
> C_INCLUDE_PATH="$SAGE_LOCAL/include"
> export C_INCLUDE_PATH
> }}}
> (web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)

For the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are *never* read by the compiler / preprocessor;  their names are just _conventions_ used in *Makefiles* (and `make`'s default rules).


---

Comment by nbruin created at 2013-05-30 17:51:55

Replying to [comment:19 leif]:
> For the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are *never* read by the compiler / preprocessor;  their names are just _conventions_ used in *Makefiles* (and `make`'s default rules).

Ah, OK. For ECL it does have a meaning: the value gets inherited as hard-wired default value for `c::*cc-flags*`. There also is `c::*ecl-include-directory*`, so including `-I` directives in `CPPFLAGS` leads to superfluous includes passed to `ecl` compiler invocations. That would be one reason to try to get rid of it.

The other issue is that ecl by design hard-wires the default value of `c::*ecl-include-directory*`, which is the real obstacle to relocating ecl. We can change that by patching ecl (but since the current behaviour is likely not considered a bug for ecl, we'd be doing that indefinitely) or we can work around it by configuring ecl to include a different setting (as outlined above, with the `--with-extra-files` and `--with-init-form` directives). [Note that this change is only required if sage builds a "private ecl" (as it does normally). If sage were to rely on an ecl supplied via other means, we wouldn't be responsible for relocating it.]


---

Comment by jdemeyer created at 2013-05-30 18:29:28

Nils or Leif: can you give an example of an _actual compilation_ which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).


---

Comment by nbruin created at 2013-05-30 23:02:33

Replying to [comment:21 jdemeyer]:
> Nils or Leif: can you give an example of an _actual compilation_ which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).
It's pretty clear how you can make it fail:
- build sage and ecl in location `<ORIGINAL>`
- move sage to another location
- put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location
now trying to compile a file with ecl will use an invalid header. It's the usual risk of keeping references to uncontrolled locations in lookup tables. You may be exposed to arbitrary crap.

(I admit I haven't actually tried. It may be that with the symlink proposed on #14662 in place, the lookup happens at the right place prior to the place searched due to the `-I` directive. But that would really just be a fluke).

I'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.


---

Comment by leif created at 2013-05-31 00:42:45

FWIW, `C*PATH` and `LIBRARY_PATH` are searched *last*, after any dirs specified on the command line.

Especially for libs, searching "random" folders is pretty delicate.  (Think e.g. of bdists; we of course still have almost the same problem with `R[UN]PATH`s, although there's `chrpath`, but that wouldn't be applicable in this case.)

And it's perhaps not too uncommon to _copy_ a Sage installation for upgrading, i.e., keeping the files at the original location.


---

Comment by jdemeyer created at 2013-05-31 06:58:29

Replying to [comment:22 nbruin]:
> I'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.
Mainly because the new maxima spkg at #14556 exposes it. But also because there is a known fix (althought perhaps not perfect).


---

Comment by jdemeyer created at 2013-05-31 09:11:33

Replying to [comment:22 nbruin]:
> It's pretty clear how you can make it fail:
> - build sage and ecl in location `<ORIGINAL>`
> - move sage to another location
> - put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location
> now trying to compile a file with ecl will use an invalid header.

Fair enough, if you *intentionally want to break it* by providing a bogus `<ORIGINAL>/local/include/ecl/config.h`, you can.  But my spkg fixes the problem for people who don't intentionally break their setup.

Note: an old `ecl/config.h` (as in the case for a copied install) is fine.


---

Comment by vbraun created at 2013-06-05 11:03:14

Changing priority from blocker to major.


---

Comment by vbraun created at 2013-06-05 11:03:14

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2013-06-05 11:03:14

Changing keywords from "ecl relocation" to "ecl hardcoded paths".


---

Comment by vbraun created at 2013-06-05 11:03:14

I will review the workaround as part of #14662. 

Leaving this ticket open until you figure out how to set paths correctly ;-)


---

Comment by jdemeyer created at 2016-04-11 10:04:17

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2016-04-11 10:04:17

Obsolete by the new binary packaging I guess.


---

Comment by vbraun created at 2016-06-12 12:02:30

Resolution: fixed
