# Issue 11187: ECL does not fully recover from relocation

archive/issues_011187.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nKeywords: ecl relocation\n\nIt has been reported that after the Sage tree is relocated, e.g.\n\n```\nmv /usr/local/sage-4.6.2 /usr/local/sage-new-location\n```\n\nit is not possible to reinstall a maxima spkg anymore. This indicates that there are components of ecl that are sensitive to location and are not properly adjusted (I think the script `sage-location` is responsible for that).\n\nSee also #11348 and [this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/4da7b0076f74d912/4a1f17eecbbdf064).\n\nIssue created by migration from https://trac.sagemath.org/ticket/11359\n\n",
    "created_at": "2011-05-20T15:35:32Z",
    "labels": [
        "build",
        "minor",
        "bug"
    ],
    "title": "ECL does not fully recover from relocation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11187",
    "user": "nbruin"
}
```
Assignee: GeorgSWeber

Keywords: ecl relocation

It has been reported that after the Sage tree is relocated, e.g.

```
mv /usr/local/sage-4.6.2 /usr/local/sage-new-location
```

it is not possible to reinstall a maxima spkg anymore. This indicates that there are components of ecl that are sensitive to location and are not properly adjusted (I think the script `sage-location` is responsible for that).

See also #11348 and [this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/4da7b0076f74d912/4a1f17eecbbdf064).

Issue created by migration from https://trac.sagemath.org/ticket/11359





---

archive/issue_comments_122981.json:
```json
{
    "body": "One problem (perhaps the only one?) is that ECL uses the C compiler for compiling lisp (much like cython) and gives it include paths and library paths that it found out upon configuration. `local/bin/sage-location` is obviously not updating those. Example in a relocated \"sage -ecl\":\n\n```\n(defun f (x y) (+ x y))\n(compile 'f) ;; fails\n(setf c::*ecl-include-directory* (concatenate 'string (SI:GETENV \"SAGE_ROOT\") \"/local/include/\"))\n(setf c::*ecl-library-directory* (concatenate 'string (SI:GETENV \"SAGE_ROOT\") \"/local/lib/\"))\n(compile 'f) ;; now it works\n```\n\nThere is a slight problem that the paths also end up in other variables (perhaps because of the way that sage calls configure when configuring ECL?):\n\n```\n> c::*cc-flags*\n\n\" -I/usr/local/sage/4.6.2-copy/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux\"\n> c::*ld-flags*\n\n\" -L/usr/local/sage/4.6.2-copy/local/lib  -lecl  -lgmp -lgc -ldl  -lm \"\n```\n\nSince it is a bit unsanitary to have references to old locations lying around (one might link to wrong versions of libraries if the old location still exists!), we should probably strip those variables as well.\n\nPossible solutions:\n- Patch ECL so that the above code is used to initialize these variables\n- Wrap our invocation of ECL so that we always update the values of these variables\n- equip `local/bin/sage-location` with the logic to update the relevant parts of ECL. That probably means recompiling (part of) ECL, because these values will be stored as a string in a \".fas\"-file somewhere, which essentially a \".so\".",
    "created_at": "2011-05-20T19:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122981",
    "user": "nbruin"
}
```

One problem (perhaps the only one?) is that ECL uses the C compiler for compiling lisp (much like cython) and gives it include paths and library paths that it found out upon configuration. `local/bin/sage-location` is obviously not updating those. Example in a relocated "sage -ecl":

```
(defun f (x y) (+ x y))
(compile 'f) ;; fails
(setf c::*ecl-include-directory* (concatenate 'string (SI:GETENV "SAGE_ROOT") "/local/include/"))
(setf c::*ecl-library-directory* (concatenate 'string (SI:GETENV "SAGE_ROOT") "/local/lib/"))
(compile 'f) ;; now it works
```

There is a slight problem that the paths also end up in other variables (perhaps because of the way that sage calls configure when configuring ECL?):

```
> c::*cc-flags*

" -I/usr/local/sage/4.6.2-copy/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux"
> c::*ld-flags*

" -L/usr/local/sage/4.6.2-copy/local/lib  -lecl  -lgmp -lgc -ldl  -lm "
```

Since it is a bit unsanitary to have references to old locations lying around (one might link to wrong versions of libraries if the old location still exists!), we should probably strip those variables as well.

Possible solutions:
- Patch ECL so that the above code is used to initialize these variables
- Wrap our invocation of ECL so that we always update the values of these variables
- equip `local/bin/sage-location` with the logic to update the relevant parts of ECL. That probably means recompiling (part of) ECL, because these values will be stored as a string in a ".fas"-file somewhere, which essentially a ".so".



---

archive/issue_comments_122982.json:
```json
{
    "body": "Confirmed! This seems to be indeed the only problem. I did the following in `local/bin`\n\n```\n$ mv ecl ecl.bin\n$ cat <<<EOF >ecl\n#!/bin/sh\nexec ecl.bin \\\n  -eval '(setf c::*ecl-include-directory* (concatenate '\"'\"'string (SI:GETENV \"SAGE_ROOT\") \"/local/include/\"))'\\\n  -eval '(setf c::*ecl-library-directory* (concatenate '\"'\"'string (SI:GETENV \"SAGE_ROOT\") \"/local/lib/\"))' \\\n  \"$@\"\nEOF\n$ chmod a+x ecl\n```\n\nafter which rebuilding maxima succeeds in a relocated position.\n\nNote that this piece of code does not scrub c::*cc-flags* or c::*ld-flags* yet.\n\nThe definitions for the default values of these variables seem to live in\nspkg/build/ecl-*/src/src/cmp/cmpdefs.lsp\nso that is probably what we need to patch.",
    "created_at": "2011-05-20T21:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122982",
    "user": "nbruin"
}
```

Confirmed! This seems to be indeed the only problem. I did the following in `local/bin`

```
$ mv ecl ecl.bin
$ cat <<<EOF >ecl
#!/bin/sh
exec ecl.bin \
  -eval '(setf c::*ecl-include-directory* (concatenate '"'"'string (SI:GETENV "SAGE_ROOT") "/local/include/"))'\
  -eval '(setf c::*ecl-library-directory* (concatenate '"'"'string (SI:GETENV "SAGE_ROOT") "/local/lib/"))' \
  "$@"
EOF
$ chmod a+x ecl
```

after which rebuilding maxima succeeds in a relocated position.

Note that this piece of code does not scrub c::*cc-flags* or c::*ld-flags* yet.

The definitions for the default values of these variables seem to live in
spkg/build/ecl-*/src/src/cmp/cmpdefs.lsp
so that is probably what we need to patch.



---

archive/issue_comments_122983.json:
```json
{
    "body": "The dirty `c::*cc-flags*` and `c::*ld-flags` are our own fault. In the ECL spkg-install we have the lines:\n\n```\nCPPFLAGS=\"$CPPFLAGS -I$SAGE_LOCAL/include\"\nLDFLAGS=\"$LDFLAGS -L$SAGE_LOCAL/lib\"\n```\n\nbut we are adding paths there, not flags! It needs the include path to find the boehm-gc headers, but our library search paths should already be set up. Can we instead just do\n\n```\nC_INCLUDE_PATH=\"$SAGE_LOCAL/include\"\nexport C_INCLUDE_PATH\n```\n\nIf the library really needs to be mentioned here, perhaps also a\n\n```\nLIBRARY_PATH=\"$SAGE_LOCAL/lib\"\nexport LIBRARY_PATH\n```\n\nbut I think we can leave that one out. With this I get an ECL where we obtain\n\n```\n> (require 'cmp)\n> c::*cc-flags*\n\n\" -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux\"\n> c::*ld-flags*\n\n\"  -lecl  -lgmp -lgc -ldl  -lm \"\n```\n\nso no paths in the flags variables anymore! That just leaves figuring out where best to change the values of the *ecl-...-directory* variables.",
    "created_at": "2011-05-21T01:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122983",
    "user": "nbruin"
}
```

The dirty `c::*cc-flags*` and `c::*ld-flags` are our own fault. In the ECL spkg-install we have the lines:

```
CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
```

but we are adding paths there, not flags! It needs the include path to find the boehm-gc headers, but our library search paths should already be set up. Can we instead just do

```
C_INCLUDE_PATH="$SAGE_LOCAL/include"
export C_INCLUDE_PATH
```

If the library really needs to be mentioned here, perhaps also a

```
LIBRARY_PATH="$SAGE_LOCAL/lib"
export LIBRARY_PATH
```

but I think we can leave that one out. With this I get an ECL where we obtain

```
> (require 'cmp)
> c::*cc-flags*

" -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC  -Dlinux"
> c::*ld-flags*

"  -lecl  -lgmp -lgc -ldl  -lm "
```

so no paths in the flags variables anymore! That just leaves figuring out where best to change the values of the *ecl-...-directory* variables.



---

archive/issue_comments_122984.json:
```json
{
    "body": "The following two fixes resolve the issues\n\n## Cleaning paths from *..-flags* variables\n\nIn `<ECL-PACKAGE>/spkg-install` replace the lines\n\n```\nCPPFLAGS=\"$CPPFLAGS -I$SAGE_LOCAL/include\"\nLDFLAGS=\"$LDFLAGS -L$SAGE_LOCAL/lib\"\n```\n\nby\n\n```\nC_INCLUDE_PATH=\"$SAGE_LOCAL/include\"\nexport C_INCLUDE_PATH\n```\n\n(web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)\n\n## Making initialization of *ecl-...-directory* variables runtime\n\nPatch `<ECL-PACKAGE>/src/src/cmp/cmpdefs.lsp` such that the lines\n\n```\n(defvar *ecl-include-directory* @includedir\\@)\n(defvar *ecl-library-directory* @libdir\\@)\n```\n\nare replaced by\n\n```\n;;; The following code sets the default values of the include and library directories used for\n;;; invocation of the C-compiler during compilation to values relative to ECL's idea\n;;; of the current \"system\" directory. The logical pathname \"SYS:\" normally points to\n;;; \".../local/lib/ecl\", where \"...\" would normally be \"/usr\" (if ECL is installed in\n;;; \"/usr/local\"). So, we strip off the last 2 components of \"SYS:\" and append \"include\" or\n;;; \"lib\". This results in the values\n;;;   \".../local/lib/\"  and  \".../local/include/\"  in the above example.\n;;; Since this substitution happens at runtime, these values get adjusted appropriately if\n;;; the \".../local\" tree gets relocated.\n(defvar *ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname \"SYS:\")) 2) '(\"include\")))))\n(defvar *ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname \"SYS:\")) 2) '(\"lib\")))))\n```\n",
    "created_at": "2011-05-21T22:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122984",
    "user": "nbruin"
}
```

The following two fixes resolve the issues

## Cleaning paths from *..-flags* variables

In `<ECL-PACKAGE>/spkg-install` replace the lines

```
CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
```

by

```
C_INCLUDE_PATH="$SAGE_LOCAL/include"
export C_INCLUDE_PATH
```

(web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)

## Making initialization of *ecl-...-directory* variables runtime

Patch `<ECL-PACKAGE>/src/src/cmp/cmpdefs.lsp` such that the lines

```
(defvar *ecl-include-directory* @includedir\@)
(defvar *ecl-library-directory* @libdir\@)
```

are replaced by

```
;;; The following code sets the default values of the include and library directories used for
;;; invocation of the C-compiler during compilation to values relative to ECL's idea
;;; of the current "system" directory. The logical pathname "SYS:" normally points to
;;; ".../local/lib/ecl", where "..." would normally be "/usr" (if ECL is installed in
;;; "/usr/local"). So, we strip off the last 2 components of "SYS:" and append "include" or
;;; "lib". This results in the values
;;;   ".../local/lib/"  and  ".../local/include/"  in the above example.
;;; Since this substitution happens at runtime, these values get adjusted appropriately if
;;; the ".../local" tree gets relocated.
(defvar *ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("include")))))
(defvar *ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("lib")))))
```




---

archive/issue_comments_122985.json:
```json
{
    "body": "## Avoiding patching ECL\nThe role of `defvar` is 2-fold: It declares a variable to have dynamic scoping rather than lexical scoping and it sets the value *only* if the variable wasn't bound already. So, as long as we execute the two defvar statements\n\n```\n(defvar c::*ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname \"SYS:\")) 2) '(\"include\")))))\n(defvar c::*ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname \"SYS:\")) 2) '(\"lib\")))))\n```\n\nbefore the compiler package is loaded, our values will persist. So, if one finds another file of lisp instructions that are guaranteed to be executed upon ECL startup (`~/.eclrc` doesn't work because maxima is built by calling `ecl -norc`) we're still good. I was not able to find such a file.",
    "created_at": "2011-05-21T22:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122985",
    "user": "nbruin"
}
```

## Avoiding patching ECL
The role of `defvar` is 2-fold: It declares a variable to have dynamic scoping rather than lexical scoping and it sets the value *only* if the variable wasn't bound already. So, as long as we execute the two defvar statements

```
(defvar c::*ecl-include-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("include")))))
(defvar c::*ecl-library-directory* (namestring (make-pathname :directory (append (butlast (pathname-directory (translate-logical-pathname "SYS:")) 2) '("lib")))))
```

before the compiler package is loaded, our values will persist. So, if one finds another file of lisp instructions that are guaranteed to be executed upon ECL startup (`~/.eclrc` doesn't work because maxima is built by calling `ecl -norc`) we're still good. I was not able to find such a file.



---

archive/issue_comments_122986.json:
```json
{
    "body": "So do we have to do two things here? Reworking spkg-install and the relocation script or just one of them is enough? And then at what stage?\n\nI am ready to cut a new ecl spkg for 4.7.1 if needed. I could take the opportunity to update maxima to 5.24.0 at the same time.",
    "created_at": "2011-05-21T22:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122986",
    "user": "fbissey"
}
```

So do we have to do two things here? Reworking spkg-install and the relocation script or just one of them is enough? And then at what stage?

I am ready to cut a new ecl spkg for 4.7.1 if needed. I could take the opportunity to update maxima to 5.24.0 at the same time.



---

archive/issue_comments_122987.json:
```json
{
    "body": "Replying to [comment:6 fbissey]:\n> So do we have to do two things here? Reworking spkg-install\n\nYes, that **and** patch ECL.\n\n> and the relocation script\n\nNo changes to relocation script required. The patch to ECL means that the default values for the `*ecl-...-library*` variables are derived from a quantity that is already aware of ECL's runtime location.\n\nSo both changes are necessary and both are to the ecl spkg and both take effect at ECL build-time (well, the patch of course also changes ECL's runtime behaviour. Since a large part of building ECL consists of ECL compiling itself, the two overlap)\n\n(the comment about avoiding patching ECL is just recording possible avenues someone might pursue if they feel really reluctant to patch ECL)",
    "created_at": "2011-05-21T22:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122987",
    "user": "nbruin"
}
```

Replying to [comment:6 fbissey]:
> So do we have to do two things here? Reworking spkg-install

Yes, that **and** patch ECL.

> and the relocation script

No changes to relocation script required. The patch to ECL means that the default values for the `*ecl-...-library*` variables are derived from a quantity that is already aware of ECL's runtime location.

So both changes are necessary and both are to the ecl spkg and both take effect at ECL build-time (well, the patch of course also changes ECL's runtime behaviour. Since a large part of building ECL consists of ECL compiling itself, the two overlap)

(the comment about avoiding patching ECL is just recording possible avenues someone might pursue if they feel really reluctant to patch ECL)



---

archive/issue_comments_122988.json:
```json
{
    "body": "I am for the less intrusive option but I am also pragmatic if it is far more practical to patch ecl itself.\nYour option for not patching ecl would involve calling ecl before compiling any lisp code right? Which means before building maxima and sage/libs/ecl.pyx in sage if I understand correctly. The second one especially bother me so patching may be the best avenue.",
    "created_at": "2011-05-21T23:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122988",
    "user": "fbissey"
}
```

I am for the less intrusive option but I am also pragmatic if it is far more practical to patch ecl itself.
Your option for not patching ecl would involve calling ecl before compiling any lisp code right? Which means before building maxima and sage/libs/ecl.pyx in sage if I understand correctly. The second one especially bother me so patching may be the best avenue.



---

archive/issue_comments_122989.json:
```json
{
    "body": "Actually, for sage/libs/ecl.pyx it's not so much of a problem, since our initialization of ecllib involves sending some instructions there anyway, so we could just add the `defvar`s there. It would add a minuscule overhead for something that is unlikely to have any effect anyway: Who's going to use embedded ECL to compile something? That is one reason to prefer the patch to the compiler package already.\n\nFor fixing the behaviour of the ECL executable I haven't actually found a solution other than wrapping it with a shell script, which really does add considerable overhead.\n\nPatching is definitely the cleaner solution, but will likely be with us in perpetuity, with all the extra maintenance of rebasing the patch with any ECL upgrade.",
    "created_at": "2011-05-21T23:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122989",
    "user": "nbruin"
}
```

Actually, for sage/libs/ecl.pyx it's not so much of a problem, since our initialization of ecllib involves sending some instructions there anyway, so we could just add the `defvar`s there. It would add a minuscule overhead for something that is unlikely to have any effect anyway: Who's going to use embedded ECL to compile something? That is one reason to prefer the patch to the compiler package already.

For fixing the behaviour of the ECL executable I haven't actually found a solution other than wrapping it with a shell script, which really does add considerable overhead.

Patching is definitely the cleaner solution, but will likely be with us in perpetuity, with all the extra maintenance of rebasing the patch with any ECL upgrade.



---

archive/issue_comments_122990.json:
```json
{
    "body": "OK. I am putting cutting a patched ecl according to your instruction on my TODO list for the week starting tomorrow. Like I said I'll probably cut a new maxima as well only\none non trivial doctest is being broken by 5.24.0 so it is easy work.",
    "created_at": "2011-05-22T00:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122990",
    "user": "fbissey"
}
```

OK. I am putting cutting a patched ecl according to your instruction on my TODO list for the week starting tomorrow. Like I said I'll probably cut a new maxima as well only
one non trivial doctest is being broken by 5.24.0 so it is easy work.



---

archive/issue_comments_122991.json:
```json
{
    "body": "## Avoiding patching ECL in a future release\n\nThe development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:\n\n```\n(in-package \"SI\")\n(defun customized-boot ()\n   (defparameter *ecl-include-directory* ...)\n   (si::top-level t))\n```\n\nand then add the following options to ECL's configure:\n\n```\n--with-extra-files=\"/path/to/sage.lsp\"\n--with-init-form='(si::customized-boot)'\n```\n\nThis option is not available in 11.1.1 yet.",
    "created_at": "2011-05-22T22:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122991",
    "user": "nbruin"
}
```

## Avoiding patching ECL in a future release

The development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:

```
(in-package "SI")
(defun customized-boot ()
   (defparameter *ecl-include-directory* ...)
   (si::top-level t))
```

and then add the following options to ECL's configure:

```
--with-extra-files="/path/to/sage.lsp"
--with-init-form='(si::customized-boot)'
```

This option is not available in 11.1.1 yet.



---

archive/issue_comments_122992.json:
```json
{
    "body": "Replying to [comment:11 nbruin]:\n> == Avoiding patching ECL in a future release ==\n> \n> The development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:\n> {{{\n> (in-package \"SI\")\n> (defun customized-boot ()\n>    (defparameter *ecl-include-directory* ...)\n>    (si::top-level t))\n> }}}\n> and then add the following options to ECL's configure:\n> {{{\n> --with-extra-files=\"/path/to/sage.lsp\"\n> --with-init-form='(si::customized-boot)'\n> }}}\n> This option is not available in 11.1.1 yet.\n\nShould we delay making a new spkg until it is released or do you think\nwe should still do it now with a note to check ecl at the next rev-bump?",
    "created_at": "2011-05-22T22:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122992",
    "user": "fbissey"
}
```

Replying to [comment:11 nbruin]:
> == Avoiding patching ECL in a future release ==
> 
> The development version of ECL has two configuration options that will allow avoiding patching ECL in the future. We'll be able to make a file `/path/to/sage.lsp`:
> {{{
> (in-package "SI")
> (defun customized-boot ()
>    (defparameter *ecl-include-directory* ...)
>    (si::top-level t))
> }}}
> and then add the following options to ECL's configure:
> {{{
> --with-extra-files="/path/to/sage.lsp"
> --with-init-form='(si::customized-boot)'
> }}}
> This option is not available in 11.1.1 yet.

Should we delay making a new spkg until it is released or do you think
we should still do it now with a note to check ecl at the next rev-bump?



---

archive/issue_comments_122993.json:
```json
{
    "body": "Replying to [comment:12 fbissey]:\n> Should we delay making a new spkg until it is released or do you think\n> we should still do it now with a note to check ecl at the next rev-bump?\nThat depends on how urgently people think this needs fixing. Given that in practice, it only affects people wanting to build maxima on a moved Sage install and that they have a reasonable workaround of rebuilding ecl first (which builds quickly), I'd say this can wait. But if you're going to make a new ECL package anyway, I'd say patch the flaw, or at least the CCFLAGS thing.",
    "created_at": "2011-05-23T01:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122993",
    "user": "nbruin"
}
```

Replying to [comment:12 fbissey]:
> Should we delay making a new spkg until it is released or do you think
> we should still do it now with a note to check ecl at the next rev-bump?
That depends on how urgently people think this needs fixing. Given that in practice, it only affects people wanting to build maxima on a moved Sage install and that they have a reasonable workaround of rebuilding ecl first (which builds quickly), I'd say this can wait. But if you're going to make a new ECL package anyway, I'd say patch the flaw, or at least the CCFLAGS thing.



---

archive/issue_comments_122994.json:
```json
{
    "body": "I am not in a particular hurry as I have other things I'd like to do. So unless there is pressure to do so. I'll wait for the next ecl.",
    "created_at": "2011-05-23T04:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122994",
    "user": "fbissey"
}
```

I am not in a particular hurry as I have other things I'd like to do. So unless there is pressure to do so. I'll wait for the next ecl.



---

archive/issue_comments_122995.json:
```json
{
    "body": "Changing priority from minor to blocker.",
    "created_at": "2013-05-30T13:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122995",
    "user": "jdemeyer"
}
```

Changing priority from minor to blocker.



---

archive/issue_comments_122996.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-30T13:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122996",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_122997.json:
```json
{
    "body": "Changing component from build to packages: standard.",
    "created_at": "2013-05-30T13:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122997",
    "user": "jdemeyer"
}
```

Changing component from build to packages: standard.



---

archive/issue_comments_122998.json:
```json
{
    "body": "Attachment [ecl-12.12.1.p4.diff](tarball://root/attachments/some-uuid/ticket11359/ecl-12.12.1.p4.diff) by vbraun created at 2013-05-30 13:24:16\n\nWhats with the CFLAGS discussion on the ticket? Not necessary any more? The new spkg doesn't address that, it just implements a workaround for broken include paths.",
    "created_at": "2013-05-30T13:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122998",
    "user": "vbraun"
}
```

Attachment [ecl-12.12.1.p4.diff](tarball://root/attachments/some-uuid/ticket11359/ecl-12.12.1.p4.diff) by vbraun created at 2013-05-30 13:24:16

Whats with the CFLAGS discussion on the ticket? Not necessary any more? The new spkg doesn't address that, it just implements a workaround for broken include paths.



---

archive/issue_comments_122999.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> The new spkg doesn't address that, it just implements a workaround for broken include paths.\nTrue, but I guess this workaround is sufficient if it makes maxima build.",
    "created_at": "2013-05-30T13:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-122999",
    "user": "jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> The new spkg doesn't address that, it just implements a workaround for broken include paths.
True, but I guess this workaround is sufficient if it makes maxima build.



---

archive/issue_comments_123000.json:
```json
{
    "body": "I think the c-flags are still a problem. Try this\n\n```\nsage -ecl\n> (defun f (x y) (+ x y))\n> (compile 'f) ;; make sure the compiler package is loaded and initialized\n>  c::*cc-flags*\n\" -I/usr/local/sage/5.9b4/local/include -I/usr/local/sage/5.9b4/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC -Dlinux\"\n> c::*ld-flags*\n\" -L/usr/local/sage/5.9b4/local/lib -Wl,--rpath,/usr/local/sage/5.9b4/local/lib -L/usr/local/sage/5.9b4/local/lib -lecl  -lgmp -lgc -ldl  -lm \"\n```\n\nI didn't check, but I assume these paths are still hardcoded and hence not adjusted by relocation. We're putting the \"-I\" and I think also the \"-L\" directives into those paths upon ecl config-and-build time. They are just not the right spot to put those. We'd be better off letting the environment be so that these things are found automatically, e.g. via setting the appropriate link paths (already done) and include search paths (for instance via `C_INCLUDE_PATH`).\n\nFailing that, we need to patch ECL so that these paths get set relative to `$SAGE_ROOT`, evaluated at ecl invokation time rather than during ecl package build.\n\nAs explained above, we can now also avoid patching sage and instead configure sage to include our own customized ecl boot routine to set up the environment with the appropriate path information during ecl invokation.",
    "created_at": "2013-05-30T13:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123000",
    "user": "nbruin"
}
```

I think the c-flags are still a problem. Try this

```
sage -ecl
> (defun f (x y) (+ x y))
> (compile 'f) ;; make sure the compiler package is loaded and initialized
>  c::*cc-flags*
" -I/usr/local/sage/5.9b4/local/include -I/usr/local/sage/5.9b4/local/include -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -g -O2  -fPIC -Dlinux"
> c::*ld-flags*
" -L/usr/local/sage/5.9b4/local/lib -Wl,--rpath,/usr/local/sage/5.9b4/local/lib -L/usr/local/sage/5.9b4/local/lib -lecl  -lgmp -lgc -ldl  -lm "
```

I didn't check, but I assume these paths are still hardcoded and hence not adjusted by relocation. We're putting the "-I" and I think also the "-L" directives into those paths upon ecl config-and-build time. They are just not the right spot to put those. We'd be better off letting the environment be so that these things are found automatically, e.g. via setting the appropriate link paths (already done) and include search paths (for instance via `C_INCLUDE_PATH`).

Failing that, we need to patch ECL so that these paths get set relative to `$SAGE_ROOT`, evaluated at ecl invokation time rather than during ecl package build.

As explained above, we can now also avoid patching sage and instead configure sage to include our own customized ecl boot routine to set up the environment with the appropriate path information during ecl invokation.



---

archive/issue_comments_123001.json:
```json
{
    "body": "Replying to [comment:4 nbruin]:\n> == Cleaning paths from *..-flags* variables ==\n> \n> In `<ECL-PACKAGE>/spkg-install` replace the lines\n> {{{\n> CPPFLAGS=\"$CPPFLAGS -I$SAGE_LOCAL/include\"\n> LDFLAGS=\"$LDFLAGS -L$SAGE_LOCAL/lib\"\n> }}}\n> by\n> {{{\n> C_INCLUDE_PATH=\"$SAGE_LOCAL/include\"\n> export C_INCLUDE_PATH\n> }}}\n> (web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)\n\nFor the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are **never** read by the compiler / preprocessor;  their names are just *conventions* used in **Makefiles** (and `make`'s default rules).",
    "created_at": "2013-05-30T16:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123001",
    "user": "leif"
}
```

Replying to [comment:4 nbruin]:
> == Cleaning paths from *..-flags* variables ==
> 
> In `<ECL-PACKAGE>/spkg-install` replace the lines
> {{{
> CPPFLAGS="$CPPFLAGS -I$SAGE_LOCAL/include"
> LDFLAGS="$LDFLAGS -L$SAGE_LOCAL/lib"
> }}}
> by
> {{{
> C_INCLUDE_PATH="$SAGE_LOCAL/include"
> export C_INCLUDE_PATH
> }}}
> (web documentation indicates that Sun Studio and IBM compilers also support this variable, so although it's not POSIX (neither is CPPFLAGS), it doesn't seem to be GNU exclusive.)

For the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are **never** read by the compiler / preprocessor;  their names are just *conventions* used in **Makefiles** (and `make`'s default rules).



---

archive/issue_comments_123002.json:
```json
{
    "body": "Replying to [comment:19 leif]:\n> For the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are **never** read by the compiler / preprocessor;  their names are just *conventions* used in **Makefiles** (and `make`'s default rules).\n\nAh, OK. For ECL it does have a meaning: the value gets inherited as hard-wired default value for `c::*cc-flags*`. There also is `c::*ecl-include-directory*`, so including `-I` directives in `CPPFLAGS` leads to superfluous includes passed to `ecl` compiler invocations. That would be one reason to try to get rid of it.\n\nThe other issue is that ecl by design hard-wires the default value of `c::*ecl-include-directory*`, which is the real obstacle to relocating ecl. We can change that by patching ecl (but since the current behaviour is likely not considered a bug for ecl, we'd be doing that indefinitely) or we can work around it by configuring ecl to include a different setting (as outlined above, with the `--with-extra-files` and `--with-init-form` directives). [Note that this change is only required if sage builds a \"private ecl\" (as it does normally). If sage were to rely on an ecl supplied via other means, we wouldn't be responsible for relocating it.]",
    "created_at": "2013-05-30T17:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123002",
    "user": "nbruin"
}
```

Replying to [comment:19 leif]:
> For the record:  In contrast to `C_INCLUDE_PATH` etc., `CPPFLAGS` (and `CFLAGS` etc.) are **never** read by the compiler / preprocessor;  their names are just *conventions* used in **Makefiles** (and `make`'s default rules).

Ah, OK. For ECL it does have a meaning: the value gets inherited as hard-wired default value for `c::*cc-flags*`. There also is `c::*ecl-include-directory*`, so including `-I` directives in `CPPFLAGS` leads to superfluous includes passed to `ecl` compiler invocations. That would be one reason to try to get rid of it.

The other issue is that ecl by design hard-wires the default value of `c::*ecl-include-directory*`, which is the real obstacle to relocating ecl. We can change that by patching ecl (but since the current behaviour is likely not considered a bug for ecl, we'd be doing that indefinitely) or we can work around it by configuring ecl to include a different setting (as outlined above, with the `--with-extra-files` and `--with-init-form` directives). [Note that this change is only required if sage builds a "private ecl" (as it does normally). If sage were to rely on an ecl supplied via other means, we wouldn't be responsible for relocating it.]



---

archive/issue_comments_123003.json:
```json
{
    "body": "Nils or Leif: can you give an example of an *actual compilation* which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).",
    "created_at": "2013-05-30T18:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123003",
    "user": "jdemeyer"
}
```

Nils or Leif: can you give an example of an *actual compilation* which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).



---

archive/issue_comments_123004.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Nils or Leif: can you give an example of an *actual compilation* which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).\nIt's pretty clear how you can make it fail:\n- build sage and ecl in location `<ORIGINAL>`\n- move sage to another location\n- put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location\nnow trying to compile a file with ecl will use an invalid header. It's the usual risk of keeping references to uncontrolled locations in lookup tables. You may be exposed to arbitrary crap.\n\n(I admit I haven't actually tried. It may be that with the symlink proposed on #14662 in place, the lookup happens at the right place prior to the place searched due to the `-I` directive. But that would really just be a fluke).\n\nI'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.",
    "created_at": "2013-05-30T23:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123004",
    "user": "nbruin"
}
```

Replying to [comment:21 jdemeyer]:
> Nils or Leif: can you give an example of an *actual compilation* which fails because of this? The wrong paths might not matter that much if the proper include and library files are found anyway through other means (e.g. environment variables such as `CPATH` and `LIBRARY_PATH` set in `sage-env`).
It's pretty clear how you can make it fail:
- build sage and ecl in location `<ORIGINAL>`
- move sage to another location
- put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location
now trying to compile a file with ecl will use an invalid header. It's the usual risk of keeping references to uncontrolled locations in lookup tables. You may be exposed to arbitrary crap.

(I admit I haven't actually tried. It may be that with the symlink proposed on #14662 in place, the lookup happens at the right place prior to the place searched due to the `-I` directive. But that would really just be a fluke).

I'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.



---

archive/issue_comments_123005.json:
```json
{
    "body": "FWIW, `C*PATH` and `LIBRARY_PATH` are searched **last**, after any dirs specified on the command line.\n\nEspecially for libs, searching \"random\" folders is pretty delicate.  (Think e.g. of bdists; we of course still have almost the same problem with `R[UN]PATH`s, although there's `chrpath`, but that wouldn't be applicable in this case.)\n\nAnd it's perhaps not too uncommon to *copy* a Sage installation for upgrading, i.e., keeping the files at the original location.",
    "created_at": "2013-05-31T00:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123005",
    "user": "leif"
}
```

FWIW, `C*PATH` and `LIBRARY_PATH` are searched **last**, after any dirs specified on the command line.

Especially for libs, searching "random" folders is pretty delicate.  (Think e.g. of bdists; we of course still have almost the same problem with `R[UN]PATH`s, although there's `chrpath`, but that wouldn't be applicable in this case.)

And it's perhaps not too uncommon to *copy* a Sage installation for upgrading, i.e., keeping the files at the original location.



---

archive/issue_comments_123006.json:
```json
{
    "body": "Replying to [comment:22 nbruin]:\n> I'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.\nMainly because the new maxima spkg at #14556 exposes it. But also because there is a known fix (althought perhaps not perfect).",
    "created_at": "2013-05-31T06:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123006",
    "user": "jdemeyer"
}
```

Replying to [comment:22 nbruin]:
> I'm a little surprised this suddenly gets marked as blocker when the issue was known for 2 years.
Mainly because the new maxima spkg at #14556 exposes it. But also because there is a known fix (althought perhaps not perfect).



---

archive/issue_comments_123007.json:
```json
{
    "body": "Replying to [comment:22 nbruin]:\n> It's pretty clear how you can make it fail:\n> - build sage and ecl in location `<ORIGINAL>`\n> - move sage to another location\n> - put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location\n> now trying to compile a file with ecl will use an invalid header.\n\nFair enough, if you **intentionally want to break it** by providing a bogus `<ORIGINAL>/local/include/ecl/config.h`, you can.  But my spkg fixes the problem for people who don't intentionally break their setup.\n\nNote: an old `ecl/config.h` (as in the case for a copied install) is fine.",
    "created_at": "2013-05-31T09:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123007",
    "user": "jdemeyer"
}
```

Replying to [comment:22 nbruin]:
> It's pretty clear how you can make it fail:
> - build sage and ecl in location `<ORIGINAL>`
> - move sage to another location
> - put a bogus file `<ORIGINAL>/local/include/ecl/config.h` (or whatever headers are required) in the old location
> now trying to compile a file with ecl will use an invalid header.

Fair enough, if you **intentionally want to break it** by providing a bogus `<ORIGINAL>/local/include/ecl/config.h`, you can.  But my spkg fixes the problem for people who don't intentionally break their setup.

Note: an old `ecl/config.h` (as in the case for a copied install) is fine.



---

archive/issue_comments_123008.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2013-06-05T11:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123008",
    "user": "vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_123009.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-06-05T11:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123009",
    "user": "vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_123010.json:
```json
{
    "body": "Changing keywords from \"ecl relocation\" to \"ecl hardcoded paths\".",
    "created_at": "2013-06-05T11:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123010",
    "user": "vbraun"
}
```

Changing keywords from "ecl relocation" to "ecl hardcoded paths".



---

archive/issue_comments_123011.json:
```json
{
    "body": "I will review the workaround as part of #14662. \n\nLeaving this ticket open until you figure out how to set paths correctly ;-)",
    "created_at": "2013-06-05T11:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123011",
    "user": "vbraun"
}
```

I will review the workaround as part of #14662. 

Leaving this ticket open until you figure out how to set paths correctly ;-)



---

archive/issue_comments_123012.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-04-11T10:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123012",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_123013.json:
```json
{
    "body": "Obsolete by the new binary packaging I guess.",
    "created_at": "2016-04-11T10:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123013",
    "user": "jdemeyer"
}
```

Obsolete by the new binary packaging I guess.



---

archive/issue_comments_123014.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-12T12:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11187#issuecomment-123014",
    "user": "vbraun"
}
```

Resolution: fixed
