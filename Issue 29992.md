# Issue 29992: ExtPowerFreeModule and TensorFreeModule cannot create a basis

Issue created by migration from https://trac.sagemath.org/ticket/30229

Original creator: mkoeppe

Original creation time: 2020-07-27 01:07:12

CC:  egourgoulhon tscrim @mjungmath slelievre @honglizhaobob


```
            sage: from sage.tensor.modules.ext_pow_free_module import ExtPowerFreeModule
            sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
            sage: e = M.basis('e')
            sage: A = ExtPowerFreeModule(M, 2) ; A
            sage: A.basis('w')
            TypeError: __init__() missing 1 required positional argument: 'degree'

        sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
        sage: e = M.basis('e')
        sage: from sage.tensor.modules.tensor_free_module import TensorFreeModule
        sage: T = TensorFreeModule(M, (1,2)) ; T
        sage: T.basis('q')
        TypeError: __init__() missing 1 required positional argument: 'tensor_type'
```



---

Comment by egourgoulhon created at 2020-07-27 13:26:29

The current design of `ExtPowerFreeModule`, `ExtPowerDualFreeModule` and `TensorFreeModule` is such that they cannot have their own bases, although they are mathematically free modules and they inherit from `FiniteRankFreeModule`. This is because all the basis management is performed at the level of the _base_ module. Indeed, any choice of basis in the base module gives birth uniquely to a basis in each of the tensor modules and exterior power modules.
For instance:

```
sage: M = FiniteRankFreeModule(ZZ, 2, name='M')
sage: e = M.basis('e')
sage: t = M.tensor((1, 1), name='t'); t
Type-(1,1) tensor t on the Rank-2 free module M over the Integer Ring
```

The components are set and displayed with respect to the basis `e = (e_0, e_1)` of the _base_ module `M` and its dual basis `(e^0, e^1)`:

```
sage: t[e, :] = [[1, 0], [-2, 0]]
sage: t.display(e)  # equivalent to t.display()
t = e_0*e^0 - 2 e_1*e^0
sage: t.components(e)
2-indices components w.r.t. Basis (e_0,e_1) on the Rank-2 free module M 
 over the Integer Ring
```

The same feature holds for `ExtPowerDualFreeModule` elements:

```
sage: a = M.alternating_form(2, name='a')
sage: a.parent()
2nd exterior power of the dual of the Rank-2 free module M over the Integer Ring
sage: a[e, 0, 1] = 3
sage: a.display(e)  # equivalent to a.display()
a = 3 e^0/\e^1
sage: a.components(e)
Fully antisymmetric 2-indices components w.r.t. Basis (e_0,e_1) on the Rank-2 
 free module M over the Integer Ring
```

If we introduce proper bases for the derived modules `ExtPowerFreeModule`, `ExtPowerDualFreeModule` and `TensorFreeModule`, then `t.display()` would become ambiguous: shall we want a display w.r.t. to the default basis of `M` or to the default basis of `t.parent()`? Moreover, the storage of components is currently performed with respect to bases of the base module. Introducing bases in the tensor modules shall of course not lead to duplicate storage.

If we keep this design (which I would favor at this stage), then, for the sake of clarity, 

```
sage: A = M.exterior_power(2)
sage: A.basis('w')
```

shall return a `NotImplementedError` and not a `TypeError`, with a message like _only bases on the base module are implemented_.


---

Comment by mkoeppe created at 2020-07-27 15:59:52

Thanks a lot for the explanation. 

Yes, a `NotImplementedError` with a clear message would be an improvement.

It could also be considered whether these three classes should really be subclasses of `FiniteRankFreeModule`, or perhaps rather a new common baseclass.


---

Comment by egourgoulhon created at 2020-07-27 17:39:30

Replying to [comment:4 mkoeppe]:
> 
> It could also be considered whether these three classes should really be subclasses of `FiniteRankFreeModule`, or perhaps rather a new common baseclass.

Yes, indeed!


---

Comment by mkoeppe created at 2020-07-27 17:42:39

Replying to [comment:2 egourgoulhon]:
> all the basis management is performed at the level of the _base_ module. Indeed, any choice of basis in the base module gives birth uniquely to a basis in each of the tensor modules and exterior power modules.

Given this, I am also wondering whether perhaps there should be a subclass of `Basis_abstract` that would make these bases explicit.


---

Comment by mkoeppe created at 2020-07-31 03:02:57

Preliminary branch 
----
New commits:


---

Comment by git created at 2020-08-01 18:11:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-08-01 18:38:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-01 18:39:24

Here's an early draft, comments welcome


---

Comment by egourgoulhon created at 2020-08-01 20:08:22

Replying to [comment:13 mkoeppe]:
> Here's an early draft, comments welcome
Thanks. It seems that the file `tensor_free_submodule_basis.py` is missing in the ticket branch.


---

Comment by git created at 2020-08-01 20:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-01 20:13:05

Sorry, here you go.


---

Comment by git created at 2020-08-03 04:21:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-08-03 04:28:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-03 04:39:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2020-08-03 08:23:11

Replying to [comment:16 mkoeppe]:
> Sorry, here you go.
Thanks. Looks nice!


---

Comment by git created at 2020-08-03 20:23:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-04 00:36:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-04 01:18:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-04 02:07:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-04 05:51:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-05 02:58:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-05 18:08:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-22 20:08:31

That's a really nice addition! Especially the in this ticket introduced `ambient_module` is useful in view of #31276. What's the status of this ticket?


---

Comment by mkoeppe created at 2021-01-22 20:36:04

A comment in the file says:

```
+# Todo: Make it a Family
+#       dual basis
+#       add test for dual
+# lift/reduce/retract
```

I think I wanted to go through #30307 to simplify the code.

Unfortunately I won't have a chance to work on any of this before spring this year


---

Comment by mkoeppe created at 2021-01-22 20:41:02

Please feel free to take any parts of the branch that are useful already


---

Comment by @mjungmath created at 2021-01-23 00:11:09

What shall be the purpose of `reduce` and `retract`?


---

Comment by mkoeppe created at 2021-01-23 01:19:01

Replying to [comment:34 gh-mjungmath]:
> What shall be the purpose of `reduce` and `retract`?

They are part of the protocol for subobjects and quotients (https://doc.sagemath.org/html/en/reference/modules/sage/modules/with_basis/subquotient.html?highlight=subquotient#module-sage.modules.with_basis.subquotient)


---

Comment by @mjungmath created at 2021-01-23 10:56:06

Are these common mathematical terms? I cannot find anything on Wikipedia etc. The documentation is very sparse so that I can only (educatedly) guess what that should mean.


---

Comment by mkoeppe created at 2021-01-25 20:38:25

`sage.modules` has implementations from which it should become clearer


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2022-08-23 22:55:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-08-23 23:16:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-23 23:41:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 00:02:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 00:27:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 01:03:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 01:55:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 06:25:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-24 17:33:29

Replying to [comment:6 egourgoulhon]:
> Replying to [comment:4 mkoeppe]:
> > 
> > It could also be considered whether these three classes should really be subclasses of `FiniteRankFreeModule`, or perhaps rather a new common baseclass.
> 
> Yes, indeed!

I've opened #34424 for this


---

Comment by git created at 2022-08-26 21:59:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-26 22:23:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-26 23:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-26 23:47:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-26 23:58:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 00:07:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 03:30:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 06:06:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 15:31:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 16:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 16:33:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 17:24:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-27 17:36:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-27 21:38:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 01:25:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 02:01:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 02:21:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-28 02:39:27

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-08-28 15:59:18

Thanks for the implementation. This looks nice!
A few comments:
- Some entrie(s) should be added to `src/doc/en/reference/tensor_free_modules/index.rst`, so that the documentation of the new classes `TensorFreeSubmodule_comp` and `TensorFreeSubmoduleBasis_comp` is generated
- There are some coverage issues (cf. the patchbot report); for instance the method `TensorFreeSubmodule_comp._basis_comp` has no docstring. 
- The output of `TensorFreeSubmodule_comp._repr_` is quite odd:

```
sage: T40Sym45M = TensorFreeSubmodule_comp(M, (6, 0), sym=((4, 5))); T40Sym45M
Free module of type-(6,0) tensors with 6-indices components w.r.t. (0, 1, 2),
 with symmetry on the index positions (4, 5)
 on the Rank-3 free module M over the Integer Ring
```

 - `with 6-indices components` could be suppressed for it is redundant with `type-(6,0)`
 - `w.r.t. (0, 1, 2)` is meaningless in this context 
 
 The output could be shorten to 
 {{{
 Free module of type-(6,0) tensors with symmetry on the index 
  positions (4, 5) on the Rank-3 free module M over the Integer Ring
 }}}
 without any loss of information. 

- The patchbot reports 2 pyflake issues.


---

Comment by git created at 2022-08-28 16:18:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 16:41:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 16:58:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 17:00:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 17:03:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 17:10:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 17:20:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 17:36:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 18:14:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 18:15:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 18:17:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-28 18:22:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-28 18:23:01

Thanks a lot for your comments. All fixed now


---

Comment by git created at 2022-08-28 22:46:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-08-29 15:52:56

Thanks for the changes. 

I was wondering about the names and descriptions of the new classes `TensorFreeSubmodule_comp` and `TensorFreeSubmoduleBasis_comp`, which stress the connection with `Components` objects. Now, what really matters here are the tensor symmetries, which do not depend upon a basis, while a `Components` object is attached to a given basis.
In particular the description _"Class for free submodules of tensor products of free modules that are defined by the symmetries of a Components object."_ would better be rephrased by something like _"Class for free submodules of tensor products of free modules that are defined by some monoterm symmetries"_. Similarly _"Free module bases indexed by component indices"_ conveys more the  output of the method `keys()` than the actual nature of these bases. 
Wouldn't something like  `TensorFreeSubmodule_sym` or `TensorFreeSubmoduleBasis_sym` be better names? 

Other remarks:

- We have:
  {{{
  sage: M = FiniteRankFreeModule(ZZ, 2)
  sage: M.tensor_module(2, 0, sym=(0,1)) is M.symmetric_power(2)
  False
  }}}
  Shouldn't the answer be `True`?
- In the doctests of `TensorFreeSubmodule_comp` and `TensorFreeModule.basis`, one could get
  rid of
  {{{
  from sage.tensor.modules.tensor_free_submodule import TensorFreeSubmodule_comp
  }}}
  and construct the submodules via `M.tensor_module` with the new arguments `sym` and `antisym`. 

- In the docstring of `TensorFreeModule.basis`, it could be instructive to illustrate the use with a basis that is not the default basis of the base module, e.g. something like
  {{{
sage: M = FiniteRankFreeModule(ZZ, 2)
sage: e = M.basis('e')
sage: f = M.basis('f', from_family=(-e[1], e[0]))
sage: for b in f: b.display()
f_0 = -e_1
f_1 = e_0
sage: S = M.tensor_module(2, 0, sym=(0,1))
sage: fS = S.basis('f')
sage: for b in fS: b.display()
e_1⊗e_1
-e_0⊗e_1 - e_1⊗e_0
e_0⊗e_0
sage: for b in fS: b.display(f)
f_0⊗f_0
f_0⊗f_1 + f_1⊗f_0
f_1⊗f_1
  }}}
- a typo in the docstring of `TensorFreeModule.basis`:   
  {{{
  #!diff
  - - ``symbol``, ``indices`` -- passed to he base module's method
  + - ``symbol``, ``indices`` -- passed to the base module's method
  }}}


---

Comment by mkoeppe created at 2022-08-29 16:05:51

Replying to [comment:94 egourgoulhon]:
> - We have:
>   {{{
>   sage: M = FiniteRankFreeModule(ZZ, 2)
>   sage: M.tensor_module(2, 0, sym=(0,1)) is M.symmetric_power(2)
>   False
>   }}}
>   Shouldn't the answer be `True`?

Yes, this is one of the TODOs that you can see in the branch.

```
+        if sym or antisym:
+            # TODO: Canonicalize sym, antisym, make hashable
+            key = (k, l, sym, antisym)
+        else:
+            key = (k, l)
```


I'm not sure whether we should fix it in this ticket; I think it's better done in a refactoring ticket that takes care of how symmetries are constructed and represented.


---

Comment by mkoeppe created at 2022-08-29 16:09:37

(I have some preliminary work in this direction on the branch of #32029)


---

Comment by mkoeppe created at 2022-08-29 16:11:14

Replying to [comment:94 egourgoulhon]:
> I was wondering about the names and descriptions of the new classes `TensorFreeSubmodule_comp` and `TensorFreeSubmoduleBasis_comp`, which stress the connection with `Components` objects. Now, what really matters here are the tensor symmetries, which do not depend upon a basis, while a `Components` object is attached to a given basis.
> In particular the description _"Class for free submodules of tensor products of free modules that are defined by the symmetries of a Components object."_ would better be rephrased by something like _"Class for free submodules of tensor products of free modules that are defined by some monoterm symmetries"_. Similarly _"Free module bases indexed by component indices"_ conveys more the  output of the method `keys()` than the actual nature of these bases. 
> Wouldn't something like  `TensorFreeSubmodule_sym` or `TensorFreeSubmoduleBasis_sym` be better names? 

I agree, I'll make these changes.


---

Comment by git created at 2022-08-29 16:13:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 16:21:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 16:28:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 16:38:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 16:40:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 16:56:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-29 16:57:25

Replying to [comment:95 mkoeppe]:
> I'm not sure whether we should fix it in this ticket; I think it's better done in a refactoring ticket that takes care of how symmetries are constructed and represented.

Some less ambitious refactoring will also do the job. Working on it


---

Comment by git created at 2022-08-29 18:51:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 19:05:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-29 19:09:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-29 19:09:26

Done now


---

Comment by git created at 2022-08-30 03:42:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 17:07:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 22:00:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by egourgoulhon created at 2022-09-02 09:29:24

Thanks for the changes. LGTM, after #34451#comment:21 is fixed. 

A minor typo in the doctests of `FiniteRankFreeModule_abstract.is_submodule`:

```diff
-            sage: N = FiniteRankFreeModule(ZZ, 4, name='M')
+            sage: N = FiniteRankFreeModule(ZZ, 4, name='N')
```


What about adding an AUTHOR field in the main docstring of the new files `tensor_free_submodule.py` and `tensor_free_submodule_basis.py`? Similarly, what about updating the AUTHORS field of other files, especially `finite_rank_free_module.py` regarding `FiniteRankFreeModule_abstract`?


---

Comment by git created at 2022-09-02 16:31:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-02 17:35:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-02 17:37:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-02 17:48:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-02 18:06:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-09-04 17:05:33

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-09-04 17:05:33

Looks good! Thanks.


---

Comment by mkoeppe created at 2022-09-04 18:08:55

Thank you!


---

Comment by git created at 2022-09-04 18:45:53

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-09-04 18:45:53

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2022-09-04 18:46:41

I've merged #34474 to resolve a merge conflict
----
New commits:


---

Comment by egourgoulhon created at 2022-09-04 19:19:01

Replying to [comment:123 Matthias Köppe]:
> I've merged #34474 to resolve a merge conflict

OK.

At the moment, we have:

```
sage: M = FiniteRankFreeModule(ZZ, 2, name='M')
sage: e = M.basis('e')
sage: S = M.tensor_module(2, 0, sym=(0,1))
sage: s = M.tensor((2, 0), sym=(0,1))
sage: s[0,1] = 2
sage: s.display()
2 e_0⊗e_1 + 2 e_1⊗e_0
sage: s.parent() is S
False
sage: s.parent()
Free module of type-(2,0) tensors on the Rank-2 free module M over the Integer Ring
```

but I guess `s.parent()` being `S` should be for a follow-up ticket...


---

Comment by egourgoulhon created at 2022-09-04 19:19:01

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-09-04 19:21:01

Yes, #34482 goes roughly into this direction.


---

Comment by egourgoulhon created at 2022-09-04 19:28:41

Replying to [comment:125 Matthias Köppe]:
> Yes, #34482 goes roughly into this direction.
OK very good.


---

Comment by vbraun created at 2022-09-22 22:35:02

Resolution: fixed
