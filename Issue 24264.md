# Issue 24264: Hash of Integer broken on Python 3

Issue created by migration from https://trac.sagemath.org/ticket/24501

Original creator: embray

Original creation time: 2018-01-09 15:07:27

Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.

In Python 3 something changed subtly about the hash algorithm such that this no longer holds:


```
sage: hash(int(2^61))
1
sage: hash(2^61)
2305843009213693952
```


I haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.


---

Comment by embray created at 2018-01-09 15:10:13

Relevant: https://bugs.python.org/issue8188


---

Comment by embray created at 2018-01-09 15:19:43

I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.


---

Comment by jdemeyer created at 2018-01-09 15:40:01

I'll have a look


---

Comment by jdemeyer created at 2018-01-09 17:11:10

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-01-09 17:11:10

New commits:


---

Comment by embray created at 2018-01-09 17:31:50

Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more "generic" I suppose.

I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.


---

Comment by jdemeyer created at 2018-01-09 18:53:56

Replying to [comment:6 embray]:
> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.

Constant folding is so trivial that it is safe to assume that the compiler knows what to do.


---

Comment by embray created at 2018-01-09 19:04:10

It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.


---

Comment by git created at 2018-01-09 19:10:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-01-10 09:39:16

Thanks for the quick work on this--looks good to me!


---

Comment by embray created at 2018-01-10 09:39:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-15 22:29:26

Resolution: fixed
