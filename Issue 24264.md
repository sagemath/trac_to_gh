# Issue 24264: Hash of Integer broken on Python 3

archive/issues_024264.json:
```json
{
    "body": "Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.\n\nIn Python 3 something changed subtly about the hash algorithm such that this no longer holds:\n\n\n```\nsage: hash(int(2^61))\n1\nsage: hash(2^61)\n2305843009213693952\n```\n\n\nI haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24501\n\n",
    "created_at": "2018-01-09T15:07:27Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "Hash of Integer broken on Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24264",
    "user": "embray"
}
```
Currently `Integer.__hash__` is implemented with `mpz_pythonhash`, which is designed to return the same hash value for built-in `int` and `long`s.

In Python 3 something changed subtly about the hash algorithm such that this no longer holds:


```
sage: hash(int(2^61))
1
sage: hash(2^61)
2305843009213693952
```


I haven't looked into what the difference is yet.  But I suspect this is the source of a number of errors I've seen.

Issue created by migration from https://trac.sagemath.org/ticket/24501





---

archive/issue_comments_339747.json:
```json
{
    "body": "Relevant: https://bugs.python.org/issue8188",
    "created_at": "2018-01-09T15:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339747",
    "user": "embray"
}
```

Relevant: https://bugs.python.org/issue8188



---

archive/issue_comments_339748.json:
```json
{
    "body": "I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.",
    "created_at": "2018-01-09T15:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339748",
    "user": "embray"
}
```

I see--essentially instead of reduction modulo `ULONG_MAX` it's modulo a prime `_PyHASH_MODULUS`.



---

archive/issue_comments_339749.json:
```json
{
    "body": "I'll have a look",
    "created_at": "2018-01-09T15:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339749",
    "user": "jdemeyer"
}
```

I'll have a look



---

archive/issue_comments_339750.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339750",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339751.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-01-09T17:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339751",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_339752.json:
```json
{
    "body": "Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more \"generic\" I suppose.\n\nI wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.",
    "created_at": "2018-01-09T17:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339752",
    "user": "embray"
}
```

Ah, you beat me to it.  I was doing roughly the same thing but with separate Python 2 and 3 branches, so your version is more "generic" I suppose.

I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.



---

archive/issue_comments_339753.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.\n\nConstant folding is so trivial that it is safe to assume that the compiler knows what to do.",
    "created_at": "2018-01-09T18:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339753",
    "user": "jdemeyer"
}
```

Replying to [comment:6 embray]:
> I wonder if we an find some way to get away with not having to calculate `modulus` and `limb_bits` every time since they are constant, but it's just some bit shifts and maybe the compiler can optimize that out anyways.

Constant folding is so trivial that it is safe to assume that the compiler knows what to do.



---

archive/issue_comments_339754.json:
```json
{
    "body": "It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.",
    "created_at": "2018-01-09T19:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339754",
    "user": "embray"
}
```

It seems like you're defining `limb_bits` twice--once using the trick in `cdef extern` and then again in the function body.



---

archive/issue_comments_339755.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-09T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339755",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339756.json:
```json
{
    "body": "Thanks for the quick work on this--looks good to me!",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339756",
    "user": "embray"
}
```

Thanks for the quick work on this--looks good to me!



---

archive/issue_comments_339757.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-10T09:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339757",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339758.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-15T22:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24264#issuecomment-339758",
    "user": "vbraun"
}
```

Resolution: fixed
