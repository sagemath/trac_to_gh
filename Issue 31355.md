# Issue 31355: Upgrade/patch singular more to remove bad -rpath linker options

Issue created by migration from https://trac.sagemath.org/ticket/31592

Original creator: mkoeppe

Original creation time: 2021-04-01 16:43:37

CC:  justin fbissey dimpase slelievre jhpalmieri @zlscherr vdelecroix arojas

The issue reported in https://groups.google.com/g/sage-release/c/fXpbYwaqt9o/m/929SlEXcCAAJ is likely caused by the upgrade to singular (#25993).
Upstream singular introduced some rather unfortunate linker flags in 4.1.3 or earlier.


---

Comment by mkoeppe created at 2021-04-01 23:38:56

A first PR as preparation: https://github.com/Singular/Singular/pull/1072


---

Comment by fbissey created at 2021-04-02 00:43:47

While `/usr and /usr/local` made it back in `DEFAULT_CHECKING_PATH` in `flint-check.m4`, if you use that variable that means they have not been found there previously by the bit that check standard paths - that I have added [https://github.com/Singular/Singular/pull/981](https://github.com/Singular/Singular/pull/981). So, I haven't asked for that re-addition to be removed. If you get to the bit checking `DEFAULT_CHECKING_PATH` they won't be found there anyway.

It would have been nice for `gmp-check.m4` to follow that model. That would also prevent `/usr/lib` and `/usr/local/lib` to ever end up in a `rpath` unless you explicitly pass it as a path to be checked.


---

Comment by mkoeppe created at 2021-04-02 00:55:11

Yes, I plan to make more improvements in this direction later. The first PR is designed to make no difference in behavior


---

Comment by fbissey created at 2021-04-02 00:57:42

The replacement of all those gmp detections by a single one is certainly overdue. Code duplication is such a maintenance mess. It is an improvement on that front already.


---

Comment by mkoeppe created at 2021-04-02 18:27:42

Replying to [comment:2 mkoeppe]:
> A first PR as preparation: https://github.com/Singular/Singular/pull/1072
It has been merged upstream.


---

Comment by mkoeppe created at 2021-04-02 23:51:33

Next PR: https://github.com/Singular/Singular/pull/1074 (Replace `-Wl,-rpath -Wl,...` by `-Wl,-rpath,...`)


---

Comment by mkoeppe created at 2021-04-03 00:15:11

And another one: https://github.com/Singular/Singular/pull/1075 (Define `DEFAULT_CHECKING_PATH` once only)


---

Comment by mkoeppe created at 2021-04-03 01:11:53

And another one: https://github.com/Singular/Singular/pull/1076 (m4/*.m4: In the search loops, test for the presence of headers using the compiler)


---

Comment by mkoeppe created at 2021-04-04 16:05:12

These three are all merged by upstream, so here's the next one:

https://github.com/Singular/Singular/pull/1078 (m4/flint-check.m4: Refactor)


---

Comment by mkoeppe created at 2021-04-05 19:49:11

Merged, so here is the last one:

https://github.com/Singular/Singular/pull/1080


---

Comment by fbissey created at 2021-04-05 20:24:17

I am not sure why you leave '/usr/local'? I would have thought anything in there would be found when testing `DEFAULTS`.


---

Comment by mkoeppe created at 2021-04-05 20:26:41

Not true on macOS when using CC=`CC=gcc -isysroot ...`.


---

Comment by fbissey created at 2021-04-05 20:30:06

OK, fair enough.


---

Comment by mkoeppe created at 2021-04-06 20:51:15

All of the above PRs have been merged by upstream.

I have made another PR, https://github.com/Singular/Singular/pull/1081, just with minor fixes to the Singular docbuild so the process of making a release is simpler: `autoreconf -fi && ./configure --disable-pyobject-module --enable-doc-build && make && make dist`

New release for sage at https://github.com/mkoeppe/Singular/releases/tag/singular-4.2.0p1%2B2021-04-06%2Bsage
----
New commits:


---

Comment by mkoeppe created at 2021-04-06 20:51:15

Changing status from new to needs_review.


---

Comment by fbissey created at 2021-04-06 20:54:59

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2021-04-06 20:54:59

Thanks for taking the time to go through that mess that likely represented years of accumulated hacks. I am satisfied that it should work out of the box. It needs to go to the bots.


---

Comment by git created at 2021-04-06 21:25:53

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-04-06 21:25:53

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by fbissey created at 2021-04-06 21:38:39

That's a new option to me. I now see what objects it builds. I am unfamiliar with the documentation building, is that a component to help build it?


---

Comment by mkoeppe created at 2021-04-06 23:06:44

Yes, to my understanding it is needed by the docbuild to extract test cases from the library code.


---

Comment by fbissey created at 2021-04-06 23:15:30

I am not against it but that may have been more appropriate for future tickets. On the other hand that would mean more bumping of singular, not like we need any more of that.

I am happy to put it back to positive review, that commit doesn't add any requirements which was my first knee jerk reaction to it.


---

Comment by fbissey created at 2021-04-06 23:15:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-06 23:18:14

I added it here so that the upstream CI integration tests with Sage run properly: https://github.com/Singular/Singular/actions/runs/723960919


---

Comment by git created at 2021-04-08 23:14:20

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-04-08 23:14:20

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-04-08 23:14:47

now on top of 9.3.rc2


---

Comment by mkoeppe created at 2021-04-08 23:14:47

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-10 16:47:29

Just saw this error on `cygwin-standard`, a cygwin-specific makefile bug related to libparse.

```
g++ -std=gnu++11 -O2 -g -march=native -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -fno-threadsafe-statics -fno-enforce-eh-specs -fconserve-space -funroll-loops -fno-delete-null-pointer-checks -fno-rtti  -L/opt/sage-ee023d7e18dfacf53b08fd0cf862661c48fe39c5/lib -Wl,-rpath,/opt/sage-ee023d7e18dfacf53b08fd0cf862661c48fe39c5/lib  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -fconserve-space -funroll-loops -fno-delete-null-pointer-checks  -Wl,-Bdynamic  libparse.cc   -o libparse
libparse.cc:31:10: fatal error: factory/globaldefs.h: No such file or directory
   31 | #include "factory/globaldefs.h"
      |          ^~~~~~~~~~~~~~~~~~~~~~
compilation terminated.
```

https://github.com/mkoeppe/sage/runs/2309214320
(this run is on top of other tickets, in particular #28890, but let's play safe and remove 1c00520)


---

Comment by mkoeppe created at 2021-04-10 16:47:29

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-04-10 16:50:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-10 16:50:45

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-04-10 16:58:05

Setting it back to positive review - back to the version reviewed in comment 19.


---

Comment by mkoeppe created at 2021-04-10 16:58:05

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-10 18:51:27

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-04-10 19:44:46

Follow-up in #31642, where 1c00520 is coming back


---

Comment by vbraun created at 2021-04-12 21:48:46

Resolution: fixed
