# Issue 26114: build/pkgs/*/checksums.ini: Add upstream-tarball-url field

Issue created by migration from https://trac.sagemath.org/ticket/26351

Original creator: mkoeppe

Original creation time: 2018-09-26 23:54:02

CC:  embray dimpase vbraun jhpalmieri tscrim

This is to make testing tickets that include spkg upgrades easier.


---

Comment by embray created at 2018-09-27 08:05:26

That's a good idea.  It should still be synced to our mirrors primarily, but having a canonical "original" URL (even if it's just an attachment to a trac ticket) would provide the primary source for a tarball independent of the mirrors.


---

Comment by embray created at 2018-09-27 11:10:11

I'll take a stab at this.  What I'm thinking is `sage-download-file` could try all mirrors first, but failing that try the `upstream-tarball-url` as a last resort.  This way, if that field is filled in, the download should still work even if the tarball is not on the mirrors yet (this will be great for people manually testing new SPKGs too, since it means they won't have to manually download the tarball into `upstream/`).

The `upstream-tarball-url` should also be optional, so that we don't have to go adding it for every package.  But it should be encouraged to add it when adding new SPGKs or updating existing ones.  Additionally, `sage --package fix-checksum` could test the URL to make sure it's still valid, and `sage-download-file` could grow a `--no-mirrors` option to skip the mirrors entirely if there is an `upstream-tarball-url` (useful if nothing else for testing).


---

Comment by mkoeppe created at 2018-09-27 17:29:21

Sounds good, thank you!


---

Comment by mkoeppe created at 2019-04-29 21:42:13

Any news on this?


---

Comment by mkoeppe created at 2020-02-11 02:59:18

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-02-11 02:59:18

New commits:


---

Comment by mkoeppe created at 2020-03-03 02:28:28

Anyone interested in this ticket?


---

Comment by tscrim created at 2020-03-03 04:11:20

Everything looks fine to me from what I understand, but I don't feel qualified enough to set this to a positive review.


---

Comment by jhpalmieri created at 2020-03-03 05:04:45

What are the lines `maxDiff = None` for? And how are we supposed to test that this works?

Edit: I mean, I see the commit message "build/test: Set maxDiff=None to improve debugging of sage_bootstrap", but can you expand on this?


---

Comment by dimpase created at 2020-03-03 11:34:48

Replying to [comment:13 jhpalmieri]:
> What are the lines `maxDiff = None` for?

https://docs.python.org/3/library/unittest.html#unittest.TestCase.maxDiff


---

Comment by mkoeppe created at 2020-03-06 02:29:21

Replying to [comment:13 jhpalmieri]:
> What are the lines `maxDiff = None` for? And how are we supposed to test that this works?
> 
> Edit: I mean, I see the commit message "build/test: Set maxDiff=None to improve debugging of sage_bootstrap", but can you expand on this?

Without this change, failed test assertions did not show enough useful information.
Now, of course, nothing fails, so these lines have no effect on the operation of sage_bootstrap.

If you want to test that this ticket works, may I suggest picking a package that needs upgrading anyway, and use the new upstream_url mechanism to do the upgrade.


---

Comment by embray created at 2020-03-06 12:50:48

I have a package to upgrade, so I'll try doing it with this feature.


---

Comment by embray created at 2020-03-06 12:55:15

Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.


---

Comment by embray created at 2020-03-06 13:35:43

Can you please also apply the following patch:


```
diff --git a/build/sage_bootstrap/cmdline.py b/build/sage_bootstrap/cmdline.py
index abb617dd65..3fa9de4104 100644
--- a/build/sage_bootstrap/cmdline.py
+++ b/build/sage_bootstrap/cmdline.py
@@ -219,14 +219,14 @@ def make_parser():
     parser_fix_checksum.add_argument(
         'package_name', nargs='?', default=None, type=str,
         help='Package name. Default: fix all packages.')
-    
+
     parser_create = subparsers.add_parser(
         'create', epilog=epilog_create,
         formatter_class=argparse.RawDescriptionHelpFormatter,
         help='Create or overwrite package.')
     parser_create.add_argument(
-        'package_name', nargs='?', default=None, type=str,
-        help='Package name. Default: fix all packages.')
+        'package_name', default=None, type=str,
+        help='Package name.')
     parser_create.add_argument(
         '--version', type=str, default=None, help='Package version')
     parser_create.add_argument(
```


running `sage -package create` doesn't work without a package name argument, so it shouldn't be optional (it looks like it was just incorrectly copied from the fix-checksum command).


---

Comment by embray created at 2020-03-06 13:39:52

Replying to [comment:17 embray]:
> Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.

Nevermind, I misunderstood that these are the tests for the bootstrap scripts.


---

Comment by embray created at 2020-03-06 14:50:02

If you want to fix the issue above as part of this ticket please do; it wasn't clear to me whether or not this bug predates this ticket (it probably does).  Whether you decide to or not you can set this to positive_review afterwards.


---

Comment by mkoeppe created at 2020-03-06 15:21:14

Thanks for reviewing.
Separate ticket please for the patch.


---

Comment by mkoeppe created at 2020-03-06 15:21:14

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-06 16:30:02

Replying to [comment:21 mkoeppe]:
> Separate ticket please for the patch.
That's #29286


---

Comment by vbraun created at 2020-03-08 22:15:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-03-08 22:15:36

Merge conflict


---

Comment by vbraun created at 2020-03-08 22:16:15

Changing status from needs_work to needs_info.


---

Comment by vbraun created at 2020-03-08 22:16:15

Actually: `There is no merge to abort (MERGE_HEAD missing).`


---

Comment by vbraun created at 2020-03-08 22:26:29

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2020-03-10 23:27:48

Resolution: fixed


---

Comment by dimpase created at 2020-04-03 00:54:13

I am trying to test #29444, and upstream_url does not seem to work
(either by running make, or with ./sage -i)
What am I doing wrong?


---

Comment by jhpalmieri created at 2020-04-03 01:20:00

I think you're supposed to do `make SAGE_SPKG="sage-spkg -o" ...`


---

Comment by dimpase created at 2020-04-03 02:30:16

Thanks. Is there any reason for this extra verbosity? After all, the checksums are supposed to identify the tarball well enough, so as long as they are not tampered with, downloading from `upstream_url` is safe.


---

Comment by mkoeppe created at 2020-04-03 10:09:43

#29392 proposes a nicer user interface to this feature. 
I didn't make it the default because it's a potentially controversial feature.
