# Issue 11959: $SAGE_LOCAL/lib and lib64

Issue created by migration from https://trac.sagemath.org/ticket/12131

Original creator: vbraun

Original creation time: 2011-12-09 11:04:46

Assignee: GeorgSWeber

CC:  simonking malb

Some distributions set up autotools to install libraries into `%{prefix}/lib64`, which breaks Sage's assumption that libraries are installed in `$SAGE_LOCAL/lib`. In particular, OpenSuse64 according to this thread https://groups.google.com/d/topic/sage-devel/LS-u8E77NJQ/discussion

It seems like we have two options:
  * Always call `./configure --libdir='${prefix}/lib'` to explicitly specify the library directory, or
  * Set up a symlink `$SAGE_LOCAL/lib64` -> `$SAGE_LOCAL/lib`.

The symlink is the lazy thing to do but will probably break again with the next architectural change. Fixing the configure call seems the right thing to do but will need some work to patch up all spkgs.


---

Comment by vbraun created at 2011-12-09 12:09:12

Thomas Hupfer wrote:

In my handwritten notes I find besides readline that libgmp.so.3,
libmftr.so, and libcddgmp.a were in lib64, but this list is probably
incomplete. These errors showed up in building ecl, mpfi, gfan and maxima.


---

Comment by vbraun created at 2011-12-09 18:24:16

For the record, Thomas Hupfer further wrote:

grep "local/lib64/"  install.log  | grep "^/usr/bin/install" | cut -d
4 -f 2 | cut -d / -f 2 | cut -d . -f 1 | sort | uniq

gives:

ecl-11
libcord
libfplll
libfreetype
libgc
libgcrypt
libgd
libgivaro
libgmp
libgmpxx
libgnutls
libgnutls-extra
libgnutls-openssl
libgpg-error
libiml
liblinbox
liblinboxsage
libmpfi
libmpir
libmpirxx
libopencdk
libsqlite3
python2


---

Comment by SimonKing created at 2011-12-09 21:44:28

Volker has posted an [updated readline spkg](http://www.stp.dias.ie/~vbraun/Sage/spkg/readline-6.2.p2.spkg). It use

```
./configure --libdir="$SAGE_LOCAL/lib"
```


Similarly, I changed the python-2.6.4 spkg (not posted yet).

I wonder: Is the `--libdir=..." option is also valid on Solaris?

Meanwhile, my `openSUSE` laptop is in the middle of building Atlas. Hence, it looks good, so far!


---

Comment by vbraun created at 2011-12-09 22:30:21

I tested the new readline on mark/skynet (Solaris SPARC) and it works.


---

Comment by SimonKing created at 2011-12-09 22:50:40

Replying to [comment:4 vbraun]:
> I tested the new readline on mark/skynet (Solaris SPARC) and it works.

Great! Meanwhile I have a new python-2.6.4.p12.spkg and an mpir-1.2.2.p8.spkg. The next problem is that ecl can't find libgc, so that's the next thing I have to modify.


---

Comment by SimonKing created at 2011-12-09 23:02:00

Hooray! Fixing mpir and boehm_gc was enough to make ecl build!! I am looking forward to the next error...


---

Comment by SimonKing created at 2011-12-09 23:42:43

The next problem is givaro, which hits linbox.


---

Comment by SimonKing created at 2011-12-09 23:50:03

... followed by mpfr and mpfi


---

Comment by SimonKing created at 2011-12-10 09:12:42

I made some progress by modifying the following spkgs:

 * readline (I used Volker's version)
 * python
 * mpir
 * boehm_gc
 * givaro
 * mpfr
 * mpfi
 * r

Now it hangs in the Sage library code, more precisely: In M4RI. Therefore I am Cc'ing Martin. I will try to modify the M4RI spkg (and then probably M4RIE, too).

My install.log is [here](http://sage.math.washington.edu/home/SimonKing/SAGE/install_logs/4.8.alpha3/install.log.4), probably with some leftovers of previous build attempts.


---

Comment by SimonKing created at 2011-12-10 09:14:24

I forgot to Cc Martin, even though I had announced it in my previous comment...


---

Comment by SimonKing created at 2011-12-10 11:22:23

Changing priority from major to blocker.


---

Comment by SimonKing created at 2011-12-10 11:22:23

According to [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/2d2faef04efb3494/f55374ff728ebc27), we could make this a blocker for sage-5.0.

The sage installation on my `openSUSE` laptop is now almost completed, but just as I write this line, there is yet another library that can't be found.

Here is the suggested work plan:

*__New package versions__*

Use the following updated spkgs (the first is contributed by Volker, and I'll provide the others probably later today:

 * python-2.6.4.p12.spkg
 * mpir-1.2.2.p8.spkg
 * boehm_gc-7.2.alpha6.p1.spkg
 * givaro-3.2.13rc2.p3.spkg
 * mpfr-2.4.2.p0.spkg
 * mpfi-1.3.4-cvs20071125.p9.spkg
 * r-2.10.1.p5.spkg
 * libm4ri-2011004.p0.spkg
 * libm4rie-2011004.p0.spkg
 * cddlib-094f.p9.spkg
 * maxima-5.23.2.p3.spkg
 * ecl-11.1.2.cvs20111120.p1.spkg
 * libpng-1.2.35.p4.spkg
 * iml-1.0.1.p14.spkg
 * pynac-0.2.3.p0.spkg
 * linbox-1.1.6.p6.spkg
 * glpk-4.44.p0.spkg

Perhaps there will be more than that, but so far it seems to work: Sage is already creating the docs!

*__Testing__*

In addition to the new spkgs, I have `LD_LIBRARY_PATH` defined. It would be interesting to know whether it would also work without defining it.


---

Comment by malb created at 2011-12-10 11:27:33

M4RI(E) uses fairly standard autoconf (me thinks) so `./configure --libdir='${prefix}/lib'` should work. Fingers crossed!


---

Comment by jdemeyer created at 2011-12-10 11:33:58

Some of the spkg versions are based on old versions and should be updated:
 * python: #12096
 * mpir: #11964 (sage-4.8.alpha0)
 * boehm_gc: #12126
 * r: #12057

(all these got positive_review).


---

Comment by SimonKing created at 2011-12-10 11:38:59

OK, Jeroen's remark means more work. I need to get python, mpir, boehm_gc and r in the most recent versions.

Question: Martin seems to suggest to use `--libdir="${prefix}/lib"` rather than `--libdir="$SAGE_LOCAL/lib"` in `M4RI(E)`. Is this a rule that applies to other packages as well?


---

Comment by SimonKing created at 2011-12-10 11:40:20

Replying to [comment:14 SimonKing]:
> OK, Jeroen's remark means more work. I need to get python, mpir, boehm_gc and r in the most recent versions.

Not mpir, since I started with alpha3 (which does contain the new mpir).


---

Comment by jdemeyer created at 2011-12-10 11:42:15

In the post above you mention `mpir-1.2.2.p8.spkg`

mpir should also be coordinated with #12139.  I am planning to work on it this weekend.


---

Comment by SimonKing created at 2011-12-10 11:47:14

Replying to [comment:16 jdemeyer]:
> In the post above you mention `mpir-1.2.2.p8.spkg`
> 
> mpir should also be coordinated with #12139.  I am planning to work on it this weekend.

Question to the release manager:

Why is mpir-1.2.2.p8 from #11964 not in alpha3, even though it is supposed to be merged in alpha0?


---

Comment by malb created at 2011-12-10 11:51:06

Replying to [comment:14 SimonKing]:
> Question: Martin seems to suggest to use `--libdir="${prefix}/lib"` rather than `--libdir="$SAGE_LOCAL/lib"` in `M4RI(E)`. Is this a rule that applies to other packages as well?

Nevermind me, I just tried to say: whatever you do for standard packages, it should work for M4RI(E). I don't know which one is better of the two options you mentioned above.


---

Comment by SimonKing created at 2011-12-10 11:54:25

Yesssss!!

Sage starts on my laptop, and `maxima(1)` does work!

I will now get the updated packages from the other tickets and modify them. Because of coordination with #12139, I will not post a new mpir here, but leave it to Jeroen to insert `--libdir` into mpir.


---

Comment by jdemeyer created at 2011-12-10 12:07:59

Replying to [comment:17 SimonKing]:
> Why is mpir-1.2.2.p8 from #11964 not in alpha3, even though it is supposed to be merged in alpha0?
I don't understand your question.  #11964 has mpir-2.1.3.p7.spkg which is merged in sage-4.8.alpha0 and still is in sage-4.8.alpha3.


---

Comment by SimonKing created at 2011-12-10 12:17:48

Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 SimonKing]:
> > Why is mpir-1.2.2.p8 from #11964 not in alpha3, even though it is supposed to be merged in alpha0?
> I don't understand your question.  #11964 has mpir-2.1.3.p7.spkg which is merged in sage-4.8.alpha0 and still is in sage-4.8.alpha3.

Then I misunderstood your remark above. Yes, your are right, there is mpir-2.1.3.p7.spkg.


---

Comment by vbraun created at 2011-12-10 13:06:28

Replying to [comment:14 SimonKing]: 
> Question: Martin seems to suggest to use `--libdir="${prefix}/lib"` rather than `--libdir="$SAGE_LOCAL/lib"` in `M4RI(E)`. Is this a rule that applies to other packages as well?

I think (haven't tried it though) that `--libdir='${prefix}/lib'` or perhaps `%{prefix}` would work. Note the single tick quotation mark which prevents the shell from expanding `$prefix` (which we don't set). I believe this would be expanded somewhere in autotools. I prefer the `--libdir="$SAGE_LOCAL/lib"`, though. This is completely explicit, so if some distribution thinks that it would be a good idea to fsck with `prefix` inside autotools then we should be safe(er).

Also, I updated the readline spkg; Now the change is documented in SPKG.txt


---

Comment by jdemeyer created at 2011-12-10 13:19:22

I have a new mpir spkg at #12139 which does *not* fix the `--libdir` issue, but gives you something to work with.  The package needs review, by the way :-)


---

Comment by SimonKing created at 2011-12-10 15:22:29

I wonder one thing: There is `.../local/lib/` and `.../local/lib64/`. Certainly there are two different lib directories for a reason. So, is it really safe to put everything into `.../local/lib/`?


---

Comment by vbraun created at 2011-12-10 15:51:50

The only reason to have a different `/lib64/` is if you have a multilib (32+64 bit) system. Since Sage is compiled only for one particular architecture it doesn't matter what you call the library dir.


---

Comment by jdemeyer created at 2011-12-10 20:26:23

Would it not be simpler to just add the symbolic link?  Fixing a dozen packages somehow looks like a lot of effort when adding one symbolic link would also fix things...

Unless of course someone is volunteering to change all the spkgs _and_ somebody else is volunteering to review them.  If we are unlucky, adding `--libdir` could also add new issues...


---

Comment by vbraun created at 2011-12-10 20:33:20

Adding the symlink will only work until the next wonky distribution changes the default libdir. For example I wouldn't be surprised if somebody uses `/usr/lib32/`.

If Simon fixes it then I'll review it. Its a one-line change, how hard can it be.


---

Comment by SimonKing created at 2011-12-11 16:14:48

In total, one needs to modify at least 29 packages. I am in the middle of building sage-4.8.alpha3 with the modified packages, and so far `local/lib64/` is empty.


---

Comment by SimonKing created at 2011-12-11 22:55:16

With the new package versions that I have posted on my sage.math account (see ticket description), `local/lib64/` remains empty, and more importantly all long tests pass.

I noticed that #12139 is now fixed. Therefore I will provide a new mpir version based on that. So, not "needs review" yet...


---

Comment by SimonKing created at 2011-12-11 23:08:41

Changing status from new to needs_review.


---

Comment by SimonKing created at 2011-12-11 23:08:41

The mpir package is now updated as well, based on #12139. I am re-building Sage now, but I will only be able to run the tests again tomorrow.

Needs review, I'd say! I give Volker's readline package a positive review, since it is part of the Sage version that works for me on `openSUSE 12.1`, at least when I also have

```
> echo $LD_LIBRARY_PATH
/usr/local/lib64:/usr/local/lib
```



---

Comment by SimonKing created at 2011-12-11 23:12:13

Sorry, I had too many `http://` in the ticket description...


---

Comment by jdemeyer created at 2011-12-12 09:23:13

libm4ri: `SPKG.txt` needs to be updated.

cddlib, gd, iml: you should fix permissions by doing

```
chmod ugo+rX -R .
```


givaro: the version number in `SPKG.txt` doesn't match the version number of the spkg, but this has been the case for many versions...


---

Comment by jdemeyer created at 2011-12-12 09:27:13

givaro: since there has never been an upstream version 3.2.13rc2, the correct version number is 3.2.13.rc1.

You could also consider upgrading the source to upstream 3.2.13 proper:
[http://ljk.imag.fr/CASYS/LOGICIELS/givaro/Downloads/](http://ljk.imag.fr/CASYS/LOGICIELS/givaro/Downloads/)


---

Comment by jdemeyer created at 2011-12-12 10:00:31

givaro: `spkg-check` should be executable.


---

Comment by SimonKing created at 2011-12-12 10:08:15

I will see what I can do. Since my laptop is at home, I can't work on it right now. Also, I think it would be better to update the givaro package on a different ticket.

I did not change executability of spkg-check in givaro and did not change the permissions if cddlib, gd and iml. But if you like, I can take care of that.


---

Comment by jdemeyer created at 2011-12-12 10:22:44

Replying to [comment:36 SimonKing]:
> Also, I think it would be better to update the givaro package on a different ticket.
Sure, but al least correct the spkg version name to *3.2.13rc1*

> I did not change executability of spkg-check in givaro and did not change the permissions if cddlib, gd and iml. But if you like, I can take care of that.
Yes please, these should be trivial fixes.


---

Comment by jdemeyer created at 2011-12-12 10:25:56

opencdk, mpfi: also fix permissions as above

ppl: spkg-install should be executable


---

Comment by SimonKing created at 2011-12-12 10:38:00

How could ppl possibly work if spkg-install is not executable??


---

Comment by SimonKing created at 2011-12-12 10:39:04

PS: How do I make it executable? By `chmod ugo+rx spkg-install`?


---

Comment by vbraun created at 2011-12-12 10:44:18

Replying to [comment:39 SimonKing]:
> How could ppl possibly work if spkg-install is not executable??

It works because the `sage-spkg` script makes spkg-install executable before running it.


---

Comment by vbraun created at 2011-12-12 11:16:54

Replying to [comment:31 SimonKing]: 
> Needs review, I'd say! I give Volker's readline package a positive review, since it is part of the Sage version that works for me on `openSUSE 12.1`, at least when I also have

```
> echo $LD_LIBRARY_PATH
/usr/local/lib64:/usr/local/lib
```


Is that the default OpenSuse setting? Thats would be quite insane. You are not installing Sage into /usr/local, are you?


---

Comment by SimonKing created at 2011-12-12 11:24:38

Replying to [comment:42 vbraun]:
> Is that the default OpenSuse setting? 

No, of course not. Some sage-devel gurus suggested to set `LD_LIBRARY_PATH` when I had problems building Sage on an older verson of `SuSE`, when I started using Sage a few years ago. It worked, and thus I did the same again when I met trouble. But this time it has not been enough.

> You are not installing Sage into /usr/local, are you?

No. It is in my /home folder.


---

Comment by SimonKing created at 2011-12-12 11:25:36

Let me ask again: How do I make it executable? By `chmod ugo+rx spkg-install`?


---

Comment by vbraun created at 2011-12-12 12:13:20

Replying to [comment:44 SimonKing]:
> Let me ask again: How do I make it executable? By `chmod ugo+rx spkg-install`? 

Yes, that works. Or maybe `chmod 755 spkg-install`, depending on how much you like octal...

The opencdk spkg has not-checked-in changes.


---

Comment by vbraun created at 2011-12-12 13:10:34

There is a typo in iml:

```
./configure --prefix="$SAGE_LOCAL" --libdir="SAGE_LOCAL/lib"
```

misses a dollar sign before `SAGE_LOCAL`


---

Comment by SimonKing created at 2011-12-12 18:12:16

I have updated the packages as follows:

 * iml: Typo in SPKG.txt ($ missing) and permissions fixed
 * libm4ri: Typo in SPKG.txt concerning version number fixed
 * cddlib: fixed permissions
 * gd: fixed permissions, 
 * givaro: I changed the version number into 3.2.13.rc1 and made spkg-check executable. I did not upgrade to the "full" release, though.
 * opencdk: fixed permissions and not-checked-in changes. 
 * mpfi: fixed permissions
 * ppl: made spkg-install executable

The spkgs are in their old location (except of course the renumbered givaro package).


---

Comment by vbraun created at 2011-12-14 22:49:37

I've double checked everything and it looks good to me! Positive review for everything except the readline spkg which Simon reviewed.


---

Comment by vbraun created at 2011-12-14 22:49:37

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2011-12-15 09:03:11

Since we have a timely positive review: Can this be merged into sage-4.8.alpha_something?


---

Comment by jdemeyer created at 2011-12-15 09:07:46

Resolution: fixed


---

Comment by jdemeyer created at 2012-01-31 21:15:14

Why didn't we simply add "$SAGE_LOCAL/lib64" to `LD_LIBRARY_PATH` in `sage-env`?  The currently solution (setting --libdir) doesn't work on packages installing _both_ a 32-bit and a 64-bit library (such as gcc by default on x86_64, see #12369).


---

Comment by vbraun created at 2012-01-31 21:58:47

Apart from giving you a 50% chance of having the wrong library first in the library path, its ugly and will break once somebody uses a more descriptive library path :-)


---

Comment by jdemeyer created at 2012-01-31 22:53:07

Replying to [comment:52 vbraun]:
> Apart from giving you a 50% chance of having the wrong library first in the library path
We already have a 99% chance or so of having the first two components wrong:

```
/usr/local/src/sage-5.0.beta1/local/lib/R/lib:/usr/local/src/sage-5.0.beta1/local/lib/openmpi:/usr/local/src/sage-5.0.beta1/local/lib/
```


Besides, nobody said that `lib64` had to come first.

> and will break once somebody uses a more descriptive library path :-)
True, but the `lib32`/`lib64` multilib is very standard.

In any case, it is absolutely needed for gcc: #12405.
