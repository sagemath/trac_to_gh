# Issue 17434: Implement gcd for fraction fields

Issue created by migration from https://trac.sagemath.org/ticket/17671

Original creator: vdelecroix

Original creation time: 2015-01-25 19:31:54

As reported on [sage-support](https://groups.google.com/forum/#!topic/sage-support/AYDqdxy5fTw), gcd and xgcd disagree on fraction fields

```
sage: gcd(6/1,2/1)
2
sage: xgcd(6/1,2/1)
(1, 1/6, 0)
```


We implement a `xgcd` for the `QuotientFields` category in order to fix that (there was a `gcd` here without a `xgcd`).


---

Comment by vdelecroix created at 2015-01-25 20:21:22

I am annoyed with the current implementation... it is written in the generic `gcd` of `categories.fields` that

```
For fields of characteristic zero (i.e., containing the
integers as a sub-ring), evaluation in the integer ring is
attempted. This is for backwards compatibility.::
    sage: gcd(6.0,8); gcd(6.0,8).parent()
    2
    Integer Ring
```

This is completely crazy! And moreover different from what is in gcd!!


---

Comment by vdelecroix created at 2015-01-25 23:43:15

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-01-25 23:43:15

New commits:


---

Comment by bruno created at 2015-01-26 13:40:31

In `src/sage/categories/quotient_fields.py`, lines 262-270:

```python
            except (AttributeError, NotImplementedError, TypeError, ValueError):
                zero = self.parent.zero()
                one  = self.parent.one()
                if self == zero:
                    return (other, zero, one)
                elif other == zero:
                    return (self, one, zero)
                else:
                    return (zero, zero, zero)
```


I would have returned `one` as soon as one of `self` and `other` is nonzero, and `zero` only when none is nonzero. The current code is not consistent (if I am not mistaken) with the implementation of `gcd` (lines 125-128).


---

Comment by vdelecroix created at 2015-01-26 13:45:58

Replying to [comment:6 bruno]:
> In `src/sage/categories/quotient_fields.py`, lines 262-270:
> ...
> I would have returned `one` as soon as one of `self` and `other` is nonzero, and `zero` only when none is nonzero.

You are totally right! Thanks!

Vincent


---

Comment by git created at 2015-01-26 15:11:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-01-26 15:21:33

* In `src/sage/rings/arith.py`, lines 1901-1910, the introducing sentence should to my mind be: `Here is an example of a xgcd for two polynomials over the integers, where the linear combination is not the gcd but the gcd multiplied by the resultant::`. 

```python

    Here is an example of a xgcd for two polynomials over the integers, where the linear
    combination is not the gcd but the resultant::

        sage: R.<x> = ZZ[]
        sage: gcd(2*x*(x-1), x^2)
        x
        sage: xgcd(2*x*(x-1), x^2)
        (2*x, -1, 2)
        sage: (2*(x-1)).resultant(x)
        2
```



* I do not understand exactly what you want to do with your function `_test_gcd_vs_xgcd()`: As discussed, it is not clear that the results should always be the same. 

* To answer your questions: 
  1. As I've said on sage-devel, I am clearly in favor of `gcd(RR(6), RR(3)).parent()` to return `Real Field with 53 bits of precision` rather than `Integer Ring`. 
  2. I would keep the name `xgcd` though, with a clear documentation.
----
New commits:


---

Comment by vdelecroix created at 2015-01-26 15:33:38

Replying to [comment:9 bruno]:
> * In `src/sage/rings/arith.py`, lines 1901-1910, the introducing sentence should to my mind be:

right

> * I do not understand exactly what you want to do with your function `_test_gcd_vs_xgcd()`: As discussed, it is not clear that the results should always be the same. 

The test is *only* for principal ideal domains. Up to now I encountered two cases where the convention are a bit special:
- quotient fields: the gcd/xgcd is compatible with the ring (managed by the category)
- polynomial over fields: the gcd/xgcd always return monic polynomials (managed by the methods in `rings.polynomial.polynomial_element_generic`)
If there is an example of a PID where gcd and xgcd *must* be different I would be happy to remove my test.

Vincent


---

Comment by git created at 2015-01-26 15:35:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-01-26 15:51:13

Replying to [comment:10 vdelecroix]:
> > * I do not understand exactly what you want to do with your function `_test_gcd_vs_xgcd()`: As discussed, it is not clear that the results should always be the same. 
> 
> The test is *only* for principal ideal domains. 

Oh, right! Then I agree with your test.

Everything you've committed so far looks good to me (and passes the tests). There are two things left:
1. The parent of `gcd(3.0,6.0)`: This ticket seems the right one to change this.
2. The name of `xgcd` for polynomials over UFD: There does not seem to be a consensus yet, so I would be in favor of letting this question to a later ticket so that this ticket can get a positive review soon.


---

Comment by vdelecroix created at 2015-01-26 15:56:21

Nope. There seems to be a regression with respect to timings (at least I do not understand what is happening). If I run the doctest on the file `coercion_and_categories.rst` in `$SAGE_ROOT/src/doc/en/thematic_tutorials/` then I end up with an incredibly long `TestSuite(P).run()`. If I instead replace it with `TestSuite(P).run(skip='_test_gcd_vs_xgcd')` everything looks fine.

Moreover, in `sage.rings.function_field.function_field.py`, line 62, the test

```
TestSuite(M).run(skip = '_test_gcd_vs_xgcd')  # long time (52s on sage.math, 2012)
```

is much longer for me. And if I remove the `skip` then it is even longer!

This is a critical issue.


---

Comment by vdelecroix created at 2015-01-27 01:45:29

I finally find out the problem in the tests:

- in `function_field.py` the timings are similar to what is here in sage-6.5.beta6. This is bad but at least not because of me
- in `coercions_and_categories.rst` the problem comes from xgcd over `ZZ['x']` (see #17675)

I will add a small commit to fix some doctests.


---

Comment by git created at 2015-01-27 01:50:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-28 12:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-28 12:43:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-01-28 12:48:33

Salut Bruno,

Sorry I had a typo in the two last commit messages so I had to do a forced push.

Now everything looks all right. Note that before setting this one to positive review, we need to wait for the trivial #17673 to be in positive review (!hint!). Thanks to Ralf #17675 is already in positive review.

In the last commits:
- I changed the behavior for real numbers as you and I wanted (nobody answered on the [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/37TjI2fZfLM)).
- I made one change to `_test_gcd_vs_xgcd` in order to check whether the parent of gcd is really what we expect and not an element of another ring.

Vincent


---

Comment by bruno created at 2015-01-28 13:15:54

Salut Vincent,

I looked at #17673, but I am unable to review it since it goes beyond my knowledge in Sage... Or at least it will take some time for me to understand it and then review.

Concerning the real number, I would have thought of an implementation acting as follows:

```python
sage: gcd(2.0,6.0)
2.00000000000000
```

I do not know if this makes sense.


---

Comment by vdelecroix created at 2015-01-28 14:32:29

Replying to [comment:21 bruno]:
> Salut Vincent,
> 
> I looked at #17673, but I am unable to review it since it goes beyond my knowledge in Sage... Or at least it will take some time for me to understand it and then review.
> 
> Concerning the real number, I would have thought of an implementation acting as follows:
> {{{#!python
> sage: gcd(2.0,6.0)
> 2.00000000000000
> }}}
Why? Would you like it to be nice only over ZZ and not over QQ? And this is where it becomes impossible. Within Sage any floating point can be converted to QQ...

```
sage: QQ(1.1231938951)
155072989/138064309
```

So the only way I would agree with your proposition is to have also

```
sage: gcd(RR(5/2), RR(3/2)) == RR(gcd(5/2, 3/2))
```

which is currently False as well.

Anyway mixing algebraic functions (like gcd) with floating point number is often a bad idea. So at least the proposed implementation tells you that something is wrong.

Vincent


---

Comment by bruno created at 2015-01-28 15:50:01

Replying to [comment:22 vdelecroix]:
> Why? Would you like it to be nice only over ZZ and not over QQ? And this is where it becomes impossible.

First of all, your current solution is mathematically perfectly correct and I am quite fine with it. This said, let me expose the reasons of my suggestion. 

With my suggestion, "integral floating point numbers" are treated differently than other floating point numbers. Reasons:
1. The `gcd` function coincide with the mathematical GCD function for integers only;
2. Every floating point number can be seen as a rational, while not every floating point number can be seen as an integer.

Also, `RR` and `QQ` are treated differently. Reasons: 
1. For inputs in `QQ`, we know that they are rational numbers, so we deviate from the mathematical definition to give a more meaningful answer and the definition we use "lives" in `QQ`;
2. For inputs in `RR` that are "integral", we make an assumption (the floating point numbers we have at hand represent integers) and then use the standard mathematical definition; 
3. For inputs in `RR` that are not "integral", not returning `1.0000000` requires to make an assumption AND to deviate from the mathematical definition: that is, we would need to "move" from `RR` to `QQ` and then to use a non-standard definition.

Finally, if a user asks for the GCD of two "integral floating point numbers", I have no difficulty to understand what s/he means (since the GCD of the integers they represent is a well-defined mathematical function). It is much more difficult to me to interpret the will of a user that asks for the GCD of two "rational floating point numbers", and this (also) justifies to treat differently the two situations.


> Anyway mixing algebraic functions (like gcd) with floating point number is often a bad idea. So at least the proposed implementation tells you that something is wrong.

I agree with that.


---

Comment by vdelecroix created at 2015-01-28 16:05:35

All right. Let us do it your way.

(actually mine would be to not define floating point as a field ;-)


---

Comment by git created at 2015-01-28 16:21:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2015-01-28 16:22:37

I removed #17673 from the dependencies... I had to do a forced push to remove the commit coming from that branch.

Vincent


---

Comment by bruno created at 2015-01-28 17:20:26

It seems that I get the same problem you had in #17673, thus the tests in `src/sage/rings/polynomial/polynomial_quotient_ring.py` don't pass. From line 281, there is a test that looks like the following (I removed irrelevant parts):

```python
sage: P.<x> = QQ[]
sage: Q = P.quotient(x^2+2)
sage: Q in Fields()
True
sage: Q.an_element().gcd._module_
'sage.categories.fields'
```

but the test doesn't pass, and I get `AttributeError: 'sage.structure.element.NamedBinopMethod' object has no attribute '__module__'` instead of `'sage.categories.fields'`.


---

Comment by vdelecroix created at 2015-01-28 17:35:43

Yep. I forgot to change that. And the modification of gcd/lcm for floating point also causes some trouble for the symbolic ring. A commit is comming.

Vincent


---

Comment by git created at 2015-01-28 17:36:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-01-29 12:55:13

Changing status from needs_review to positive_review.


---

Comment by bruno created at 2015-01-29 12:55:13

All tests pass! LGTM.


---

Comment by vdelecroix created at 2015-01-29 14:54:58

Cool! Thanks for the review.


---

Comment by vbraun created at 2015-01-29 22:41:52

Resolution: fixed
