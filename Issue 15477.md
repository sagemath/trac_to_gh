# Issue 15477: generalize BinaryRecurrenceSequence

Issue created by migration from https://trac.sagemath.org/ticket/15714

Original creator: rws

Original creation time: 2014-01-23 10:56:52

Assignee: rws

CC:  burcin mmezzarobba vivianepons

Keywords: recurrence ogf

The name for the next more general mathematical object is _linear homogenous recurrence with constant coefficients_, and there are mappings to and from polynomial fractions (the latter generate the former). I am not sure about the best object name, however. Working title: Linrec.

Definition of linrec: degree n, coefficients c_0...c_(n-1), start values a_0...a_(n-1), satisfying 0 = c_0a_0 + ... + c_(n-1)a_(n-1).


---

Comment by rws created at 2014-01-24 11:37:16

Please comment on the interface/documentation
----
New commits:


---

Comment by git created at 2014-01-26 18:27:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-27 18:09:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-28 17:38:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-30 07:31:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-01-30 07:41:12

Changing keywords from "recurrence ogf" to "recurrence, sequence, ogf".


---

Comment by rws created at 2014-01-30 07:41:12

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2014-02-04 15:01:57

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2014-02-04 15:01:57

Some more comments:
* Your code is apparently limited to sequences with integer or rational coefficients. IMHO it would be best to handle C-finite sequences over arbitrary rings (or perhaps integral domains?). If you don't want to do that, the scope of the code should be clearly documented and there should be a few checks in suitable places<sup>[1]</sup>.
* How about making CFiniteSequences Elements of a proper Parent? Sure, it is not absolutely essential at this point, but that's something we will certainly want in the long run—C-finite sequences [over a given ring] form a ring!—, and designing a suitable interface from the start would save the trouble of deprecating the current one later on!
* If you do implement a "ring of C-Finite sequences over ...", I'd suggest moving it outside of combinat (perhaps to a new package `sage.rings.sequences`?).

[1] Currently, the following examples all behave differently:

```
sage: R.<x> = RR[]; fibo = CFiniteSequence(x/(1-x-x^2)); fibo[10]
55
sage: R.<x> = GF(3)[]; fibo = CFiniteSequence(x/(1-x-x^2)); fibo[10]
...
ValueError: Cannot convert to CFiniteSequence.
sage: R.<x> = CC[]; fibo = CFiniteSequence(x/(1-x-x^2)); fibo[10]
...
TypeError: Unable to coerce 0.000000000000000 (<type 'sage.rings.complex_number.ComplexNumber'>) to Rational
```

Their behaviour is not entirely unreasonable, but it only makes sense if you know that `CFiniteSequence` is going to try converting the input to a rational fraction over `QQ`.


---

Comment by git created at 2014-03-14 10:03:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-03-14 10:18:06

Changing status from needs_work to needs_review.


---

Comment by rws created at 2014-03-14 10:18:06

I refrained from creating a specific parent, as the ring is isomorphic to Laurent polynomial fractions. I specifically allowed `ZZ` and `QQ`. So C-finite sequences return their parent as `Fraction Field of Univariate Polynomial Ring in x over Rational Field`.

Two guessing algorithms are implemented, Berlekamp-Massey and LLL (faster,default).

An improvement in clarity could be to replace the internal implementation via vanilla polyniomals by Laurent polyniomals (#11726).

I think the math is pretty standard, though I know of no paper about the isomorphism. If I knew algebra better I would write a paper.


---

Comment by rws created at 2014-05-12 06:26:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-05-31 07:35:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-31 07:36:33

Changing status from needs_work to needs_review.


---

Comment by rws created at 2014-06-10 10:31:50

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-06-10 10:31:50

The recent move to abandon pexpect demands that the pari script in this patch should be replaced by code using libpari.


---

Comment by rws created at 2014-07-28 16:03:40

That demand should not hold up the ticket.


---

Comment by rws created at 2014-07-28 16:03:40

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2014-11-18 21:39:31

I have had a look and corrected a few little things. Now pep8 compliant.
----
New commits:


---

Comment by git created at 2014-11-18 21:41:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-11-19 09:01:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-12-11 07:57:22

Frédéric, you seem to have had a good look at the code, why not do a review?


---

Comment by git created at 2015-01-10 17:34:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2015-02-05 14:58:00

Replying to [comment:15 rws]:
> I refrained from creating a specific parent, as the ring is isomorphic to Laurent polynomial fractions. I specifically allowed `ZZ` and `QQ`. So C-finite sequences return their parent as `Fraction Field of Univariate Polynomial Ring in x over Rational Field`.

I haven't looked at the new code, but I really doubt that this is a good idea: do you really want, say, the sum of a CFiniteSequence and an integer to return a rational function?!


---

Comment by rws created at 2015-02-05 15:22:15

Replying to [comment:30 mmezzarobba]:
> I haven't looked at the new code, but I really doubt that this is a good idea: do you really want, say, the sum of a CFiniteSequence and an integer to return a rational function?!
Nowhere is a function returned. The type remains a polynomial fraction.


---

Comment by mmezzarobba created at 2015-02-05 15:29:45

Replying to [comment:31 rws]:
> Nowhere is a function returned. The type remains a polynomial fraction.

Yes, that's what I mean by rational function.


---

Comment by rws created at 2015-02-05 15:49:17

Please compare:

```
sage: fr = (x/(1+x)).fraction(QQ)
sage: 1+fr
(2*x + 1)/(x + 1)
sage: type(_)
<class 'sage.rings.fraction_field_element.FractionFieldElement_1poly_field'>
sage: fr+1
(2*x + 1)/(x + 1)
sage: type(_)
<class 'sage.rings.fraction_field_element.FractionFieldElement_1poly_field'>
```

versus

```
sage: R.<x> = PolynomialRing(QQ, 'x')
sage: s = CFiniteSequence(x/(1+x))
/home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/cfinite_sequence.py:212: DeprecationWarning: This method is deprecated.
See http://trac.sagemath.org/16201 for details.
  R.set_default_prec(alen)
sage: s
C-finite sequence, generated by x/(x + 1)
sage: 1+s
(2*x + 1)/(x + 1)
sage: s+1
C-finite sequence, generated by (2*x + 1)/(x + 1)
sage: CFiniteSequence(1)+s
C-finite sequence, generated by (2*x + 1)/(x + 1)
```

What do yu think is wrong there? (Will fix the deprecation warning)


---

Comment by mmezzarobba created at 2015-02-05 16:13:37

Replying to [comment:33 rws]:
> {{{
> sage: R.<x> = PolynomialRing(QQ, 'x')
> sage: s = CFiniteSequence(x/(1+x))
> /home/ralf/sage/local/lib/python2.7/site-packages/sage/rings/cfinite_sequence.py:212: DeprecationWarning: This method is deprecated.
> See http://trac.sagemath.org/16201 for details.
>   R.set_default_prec(alen)
> sage: s
> C-finite sequence, generated by x/(x + 1)
> sage: 1+s
> (2*x + 1)/(x + 1)
> sage: s+1
> C-finite sequence, generated by (2*x + 1)/(x + 1)
> sage: CFiniteSequence(1)+s
> C-finite sequence, generated by (2*x + 1)/(x + 1)
> }}}
> What do yu think is wrong there? (Will fix the deprecation warning)

I don't think that's how sage objects are supposed to behave! I'd expect the result of `1+s` not do depend on the order. Moreover, I'd expect that things like `1.0+s` or `s+s'` where `s'` is another type of sequence can be made to work in the long run even if they don't all work yet.


---

Comment by git created at 2015-02-05 16:16:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-02-05 16:25:23

Replying to [comment:34 mmezzarobba]:
> I don't think that's how sage objects are supposed to behave! I'd expect the result of `1+s` not do depend on the order.
Tell you what: I'm working incrementally. I won't add the feature unless you review what is already there.


---

Comment by mmezzarobba created at 2015-02-05 16:48:35

Replying to [comment:36 rws]:
> Replying to [comment:34 mmezzarobba]:
> > I don't think that's how sage objects are supposed to behave! I'd expect the result of `1+s` not do depend on the order.
> Tell you what: I'm working incrementally. I won't add the feature unless you review what is already there.

I'm not interested in just reviewing what is already there because I don't feel able to judge whether it's a step towards a proper solution or in the wrong direction. I would be interested in implementing the parent myself (and review your commits along the way) if I have time--but that's a big if, unfortunately.


---

Comment by rws created at 2015-02-05 16:52:26

Replying to [comment:37 mmezzarobba]:
>I would be interested in implementing the parent myself...
You have my support for that.


---

Comment by git created at 2015-03-22 15:24:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by VivianePons created at 2015-06-01 22:23:54

Hi,

I just came across this code and I'm willing to review/fix whatever is left cause I would really like to see that into Sage! 

I do agree with the comments on the parent. I find it really weird that the parent is the fraction field. Look at this:



```
sage: R.<x> = QQ[]
sage: fibo = CFiniteSequence(x/(1-x-x^2))
sage: f = x/(1-x-x^2)
sage: f == fibo
True
sage: fibo == f
Traceback (most recent call last):
...
AttributeError: 'FractionFieldElement_1poly_field' object has no attribute 'ogf'
```


Actually, do we really need the CFiniteSequence to extend FractionFieldElement? What method do we use from FractionFieldElement? It seems to me that even if a sequence is represented by a fraction, they are two complete different objects.


---

Comment by rws created at 2015-06-02 07:22:25

You're welcome. This was my early attempt at parenting Sage objects, so there is no particular reason for any oddities. Meanwhile I found that the `guess` algorithm `"sage"` is less general than `"pari"` so you might want to change the default, too. I'll gladly review any additions you make.


---

Comment by git created at 2015-06-05 22:11:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by VivianePons created at 2015-06-05 22:19:48

I have changed the architecture so that C-Finite Sequences are no longer sub classes of fraction field elements. Instead, they just store the ogf and belong to their own ring with a proper parent and everything.

I think the new implementation is much cleaner and it's addressing the issues that had been raised before: the behavior and coercions are much more consistent.

Also, it actually makes things easy for the user as you can write directly



```
sage: CFiniteSequence(1+x)
Finite sequence [1, 1], offset = 0
```


even if `x` is a symbolic variable, it gets transformed into a proper fraction field element and the result still has the right parent and everything.

Someone can start reviewing my changes, rws I guess and also mmezzarobba (or whoever wants to look at it). 

I still haven't recompiled the doc but I will do shortly.


---

Comment by git created at 2015-06-05 23:21:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-06 07:09:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-06-06 07:16:55

Nice work! I think this is fine. So someone just needs to look over this last commit, where I fixed the default guessing method. Also, since you while adapting the original code also reviewed it, you should insert your name in the Reviewers field.

Having this finally in mainstream Sage would motivate me to complete the already existing code for automated closed form output.


---

Comment by chapoton created at 2015-06-06 07:17:21

Luca should be Lucas, I think.

I have also noted some alignement problems at the beginning of
`class CFiniteSequence(FieldElement)`


---

Comment by git created at 2015-06-06 07:30:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-06-06 16:23:41

please use `....:` for doctest continuation (see patchbot report)


---

Comment by git created at 2015-06-07 06:12:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-09 16:16:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by VivianePons created at 2015-06-09 16:20:20

I've recompiled the doc and tests and everything seems fine now. The problems reported by Chapoton have been fixed. From my point of view, this is all good. Maybe someone else could give green flag? Anyway, if nobody complains in the near future, I'll move this to positive review.


---

Comment by rws created at 2015-06-09 16:30:34

As you are positive, and your own last commit is fine, and a recent patchbot run passed, I'll set positive myself. Please add yourself to the reviewers, too. Marc?


---

Comment by rws created at 2015-06-09 16:30:34

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2015-06-09 16:56:52

Replying to [comment:53 rws]:
> As you are positive, and your own last commit is fine, and a recent patchbot run passed, I'll set positive myself. Please add yourself to the reviewers, too. Marc?

Sorry, I don't have time to have a look now. But if you both are happy with the current code, I guess all is fine!


---

Comment by vbraun created at 2015-06-11 13:51:00

Resolution: fixed
