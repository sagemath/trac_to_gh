# Issue 13724: Problematic file filter in skip() from sage-ptest

Issue created by migration from https://trac.sagemath.org/ticket/13928

Original creator: ncohen

Original creation time: 2013-01-08 15:05:31

Assignee: mvngu

CC:  jdemeyer hivert nthiery

My computer has no processor, and that's because `sage -tp 4` refuses to test any file whose path contains the string `"/."`. That's a problem, for on my machine `SAGE_ROOT=/home/ncohen/.Sage` and all files get filtered. This patch removes this test, hoping that it was totally useless in the first place, which sounds.... unlikely `O_o`

Apply the patch to SAGE_ROOT/local/bin/

Nathann

See the report on sage-devel : https://groups.google.com/forum/?hl=fr&fromgroups=#!topic/sage-devel/Ae8wLR0EgHA


---

Comment by ncohen created at 2013-01-08 15:07:21

Changing status from new to needs_review.


---

Comment by leif created at 2013-01-08 17:17:44

That's not a bug (skipping files in directories starting with `.`), but a feature.

The real bug is the exception raised (if no files to test remain).  But we should probably report _why_ (or _that_) such files get skipped, or (because there can potentially be many) at least document this somewhere (if it isn't already; a comment in `sage-ptest` would probably have sufficed in your case... ;-) )


---

Comment by leif created at 2013-01-08 17:19:37

P.S.:  You'll also have noticed the many `XXX`s (due to me) in that file... :-)


---

Comment by jhpalmieri created at 2013-01-08 17:56:45

Maybe the test shouldn't filter the absolute path, but the path relative to `SAGE_ROOT`. I don't see why we should skip directories starting with `.` if they are not in the Sage library (if I want to test some random collection of files in one of my own directories, why can't the directory start with a `.`?). So 

```python
G = os.path.realpath(G)
if G.startswith(SAGE_ROOT):
    if os.path.sep + '.' in G[len(SAGE_ROOT):].lstrip(os.path.sep + '.'):
        return True

    # perhaps also put this here:
    if G.find(os.path.join('doc', 'output')) != -1:
        return True
```



---

Comment by leif created at 2013-01-08 18:05:29

Hmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.

Feel free to implement an option to disable this feature... ;-P


---

Comment by ncohen created at 2013-01-08 18:45:47

> Hmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.
> 
> Feel free to implement an option to disable this feature... ;-P

Here is a patch using John's code.... Leif do you really find adequate that `make ptestlong` does not work when I install Sage ? `O_o`
As John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !

Nathann


---

Comment by jhpalmieri created at 2013-01-08 19:04:26

Nathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.

Leif: why shouldn't I be able to (p)test files in `~/.sage`, for example? I think when we try to test a subdirectory of `SAGE_ROOT`, we can skip files based on names of directories (relative to `SAGE_ROOT`), but shouldn't the user be able to test anything outside of the Sage installation?


---

Comment by ncohen created at 2013-01-08 19:05:50

> Nathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.

(Gloops. Fixed)


---

Comment by leif created at 2013-01-08 19:07:42

Replying to [comment:6 ncohen]:
> As John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !

Well, rename the folder to something not starting with a dot, then run `sage -tp ...` or `make ptest[long]` or whatever... ;-)

The exception raised if no files to test remain should get fixed though, giving a reasonable message instead.  [We could also issue a warning (once!) if `SAGE_ROOT` or some specified directory's path contains a hidden directory.]

The filtering really needs an overhaul, but probably on another ticket...  (For example, the whole tree below a hidden directory should get pruned [once], instead of testing each file's path -- at least by default.  See the `XXX`s for similar issues...)


---

Comment by ncohen created at 2013-01-08 19:12:00

Come on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ? What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !

Nathann


---

Comment by jhpalmieri created at 2013-01-08 19:19:17

With or without Nathann's patch, we should fix the actual bug:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -429,6 +429,7 @@ for gr in range(0,numglobaliteration):
     interrupt = False
 
     numthreads = min(numthreads, len(files))  # don't use more threads than files
+    numthreads = max(numthreads, 1) # use at least one thread
         
     if len(files) == 1:
         file_str = "1 file"
```

although as Leif says we could also give a warning if no files will be tested, and also a warning about the hidden directory issue. For example:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -358,6 +358,15 @@ for gr in range(0,numglobaliteration):
 
     infiles.sort()
 
+    for F in infiles:
+        F = abspath(F)
+        if os.path.sep + '.' in F.lstrip(os.path.sep + '.'):
+            print """Warning:
+
+   %s
+
+will be not be tested because it is in a hidden directory.""" % F
+
     files = list()
 
     t0 = time.time()
```



---

Comment by leif created at 2013-01-08 19:22:13

Replying to [comment:10 ncohen]:
> Come on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ?

Why do you install Sage into a hidden directory, or [`<flame>` _why would anybody want to do so_ `</flame>`] ? 

> What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !

At least the one who implemented it knows, and others would perhaps be surprised if we didn't.

I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.


---

Comment by ncohen created at 2013-01-08 19:27:37

> Why do you install Sage into a hidden directory, or [`<flame>` _why would anybody want to do so_ `</flame>`] ? 

I use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do "ls" in my home directory. Happened to me thousands of times.

> > What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !
> 
> At least the one who implemented it knows, and others would perhaps be surprised if we didn't.
> 
> I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.

Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

Nathann


---

Comment by nbruin created at 2013-01-08 19:37:12

Perhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a "." should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?

Compare the behaviour of `ls -R <path name>`, for instance. It won't list/recurse into any dotted files _within_ `<path name>`, but it will happily work if any of the components of `<path name>` have a dot in them.

I don't know where/how `make ptest` gets a list of to-be-tested files, but I'd think that you want to filter out dotted files there (i.e., when you're discovering new leafs/nodes), rather than when you've assembled a full path name already. That basically means: let `populatefilelist` do the hard work, not `skip` (in fact, shouldn't everything of skip be absorbed in there?)

(But really ... why _would_ you want to install software in a dotted directory? Do you want to hide it from your sysadmin?)

Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not _have_ a canonical `realpath` anyway, showing that relying on it is a logical flaw.


---

Comment by leif created at 2013-01-08 19:44:38

Replying to [comment:13 ncohen]:
> > Why do you install Sage into a hidden directory, or [`<flame>` _why would anybody want to do so_ `</flame>`] ? 
> 
> I use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do "ls" in my home directory. Happened to me thousands of times.

Create some [visible] subdirectory that contains all the stuff that you don't want to see?

(On [other people's] Windows for example, the first thing I usually do is to create a `Deskbottom` folder, to move the useless things to... :-) )




> > I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.
> 
> Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.


---

Comment by leif created at 2013-01-08 19:54:44

Replying to [comment:14 nbruin]:
> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not _have_ a canonical `realpath` anyway, showing that relying on it is a logical flaw.

Thanks.  I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so, unfortunately.  This is a real mess with filesystems that get mounted on different directories (for example depending on the machine or the operating system you currently booted), and by the way -- at least in my case -- always blows up the log files [and screen output] because the "real path" is three to ten times longer than the specified one, i.e., the one with symlinks.


---

Comment by jhpalmieri created at 2013-01-08 19:56:56

Replying to [comment:14 nbruin]:
> Perhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a "." should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?

Sounds good to me.

> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not _have_ a canonical `realpath` anyway, showing that relying on it is a logical flaw.

I agree about using the path as presented by the user. Note though that `realpath` is used several other places in the file, for example line 308:

```
if os.path.realpath(appendstr).startswith(BUILD_DIR):
```

where `BUILD_DIR` was also defined using `realpath`. So if it's problematic, other parts of the file need to be fixed (as does the [Python documentation](http://docs.python.org/2/library/os.path.html?highlight=realpath#os.path.realpath), unless they're using the word "canonical" in a, ahem, noncanonical way). Or they don't need to be fixed, and they might produce false positives: some files will get tested which perhaps shouldn't. But it's better to test too many than to skip some, I think: false positives are better than false negatives.

Replying to [comment:15 leif]:
> Replying to [comment:13 ncohen]:

> > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?
> 
> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.

I think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.


---

Comment by ncohen created at 2013-01-08 19:58:40

> Create some [visible] subdirectory that contains all the stuff that you don't want to see?

`O_o`

It's my home folder. Not Sage's. It's there because I invited it, but it's not about to make rules there `:-P`

> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.

Oh. I mean that we could ask Sage to ignore the `/.` that belong to SAGE_ROOT, and not the other ones. Let us assume that my SAGE_ROOT variable contains a `/.` (it does). Then SAGE_ROOT/subfolder/ will *not* be ignored, but SAGE_ROOT/.subfolder/ would !

This way, no problem with .hg folders located in SAGE_ROOT. But I can type `make ptestlong`.

Nathann


---

Comment by nbruin created at 2013-01-08 21:22:43

Ah, got it. `populatefilelist` uses `os.walk` to recurse into the directory tree and that has no problem following into hidden files. Hence the solution to prune these afterwards. That's the wrong approach of course: You shouldn't follow/include these things in the first place. So `os.walk` is the wrong tool. Nathan, you got your job cut out for you: rewrite `populatefilelist` to include files into the list a little more prudently, so that `skip` doesn't have to do so much pruning.

Actually, `os.walk` _is_ the proper tool, but you have to run it with `topdown=True` (which is the default anyway). See [os.walk documentation](http://docs.python.org/2/library/os.html#os.walk). Then you can edit `dirnames` in-place, to affect further recursions. So, if you write something like this in `populatefilelist`:

```
for path,dirnames,lfiles in os.walk(walkdir):
    dirnames[:]=(n for n in dirnames if len(n) == 0 or n[0] != '.')
    lfiles[:]=(n for n in lfiles if len(n) == 0 or n[0] != '.')
    <do your processing here>
```

there shouldn't be a need for `skip` to explicitly filter out dotted filenames anymore.


---

Comment by leif created at 2013-01-08 21:50:53

Replying to [comment:17 jhpalmieri]:
> Replying to [comment:15 leif]:
> > Replying to [comment:13 ncohen]:
> 
> > > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?
> > 
> > I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.
> 
> I think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.

Well, I'd say it's even _more likely_ that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files _outside_ `SAGE_ROOT`.  Feeding `sage -t ...` with complex ``find ... -prune ...`` expressions is certainly pretty inconvenient.

We could of course introduce yet another Sage environment variable containing the directory names to skip... ;-)
[and only skip them if they're really _below_ the directories specified, as Nils suggested.]


---

Comment by jhpalmieri created at 2013-01-08 22:15:00

Replying to [comment:20 leif]:
> Well, I'd say it's even _more likely_ that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files _outside_ `SAGE_ROOT`.  Feeding `sage -t ...` with complex ``find ... -prune ...`` expressions is certainly pretty inconvenient.

I'm happy with Nils' suggestion to not skip any directories passed explicitly as arguments, but to skip any subdirectories of those which are hidden.


---

Comment by nbruin created at 2013-01-08 22:19:27

Rationalized dotted-name pruning procedure


---

Attachment

Attached rationalized pruning patch. This walks the dirtree more efficiently, because it won't even descend into dotted names. It's also agnostic of the pathname on which it starts, so if dots are present there, things should still work.

This should allow Nathan to continue his crazy naming schemes and improve and (unnecessarily) speed up the whole procedure. There's a lot more that can be rationalized about `sage-ptest`, but I think this is at least a step in the right direction.


---

Comment by jhpalmieri created at 2013-01-08 22:32:13

This looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -429,6 +429,11 @@ for gr in range(0,numglobaliteration):
     interrupt = False
 
     numthreads = min(numthreads, len(files))  # don't use more threads than files
+    if len(files) == 0:
+        print """
+Warning: no files to test!
+"""
+        sys.exit(0)
         
     if len(files) == 1:
         file_str = "1 file"
```



---

Comment by leif created at 2013-01-08 23:03:30

Replying to [comment:23 jhpalmieri]:
> This looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:
> {{{
> #!diff
> diff --git a/sage-ptest b/sage-ptest
> --- a/sage-ptest
> +++ b/sage-ptest
> `@``@` -429,6 +429,11 `@``@` for gr in range(0,numglobaliteration):
>      interrupt = False
>  
>      numthreads = min(numthreads, len(files))  # don't use more threads than files
> +    if len(files) == 0:
> +        print """
> +Warning: no files to test!
> +"""
> +        sys.exit(0)
>          
>      if len(files) == 1:
>          file_str = "1 file"
> }}}

I prefer the latter.  Although it should still inform the user how long it took to doctest 0 files, similar to what `sage -b` does ("Time to execute 0 commands ...").

No, seriously, a warning would IMHO only make sense if we print it for every _specified_ directory that didn't contain files to test.  (If no files remain at all, it's obvious that no file got tested, and from a script one would presumably just test the exit status, which [in what you propose] is 0 anyway.)


---

Comment by leif created at 2013-01-08 23:05:06

P.S.:  From a mathematical perspective, one should still print "All tests passed!" of course.


---

Comment by jdemeyer created at 2013-01-09 07:11:55

Replying to [comment:16 leif]:
> I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so
That is absolutely untrue. You're probably refering to #5852, but that was about _fixing_ the way _how_ `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.


---

Comment by leif created at 2013-01-09 16:16:43

Replying to [comment:26 jdemeyer]:
> Replying to [comment:16 leif]:
> > I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so
> That is absolutely untrue. You're probably refering to #5852, but that was about _fixing_ the way _how_ `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.

Well, we used `realpath()` and the like in a few places (mostly to check whether two filenames actually refer to the same file), but never fully "expanded" `SAGE_ROOT` "from the beginning", i.e., in the main `sage` script.  I recall you implemented the latter, so it's IMHO fair to say (or assume) you were in favour of doing so...

Since then, nearly no Sage component ever sees what the user specified (or is willing to use), hence presents the user only and always the fully dereferenced form, which is certainly annoying to a couple of people (and also causes some technical trouble, as mentioned earlier).


---

Comment by jdemeyer created at 2013-01-09 16:20:37

Replying to [comment:27 leif]:
> never fully "expanded" `SAGE_ROOT` "from the beginning", i.e., in the main `sage` script.  I recall you implemented the latter
This is not true, go and read the patch at #5852 and notice that

```
SAGE_ROOT=`realpath    "$0" 2> /dev/null` || \
```

was already there.


---

Comment by ncohen created at 2013-01-10 15:12:57

Here it is ! Do you like it this way ? `:-)`

Nathann


---

Attachment

Hello ! Could someone give this short patch a review ? I almost forgot its very existence `^^;`

Nathann


---

Comment by jhpalmieri created at 2013-02-26 15:43:01

Hi Nathann,

It looks like this will be superseded by the work at #12415: at least, the patches there completely remove the file sage-ptest. So I think we should close this and you should take the discussion there. Note that there has been a lot of activity on that ticket lately – it has not stagnated – and putting in a patch here would just cause them to rebase. Also, they may still be ignoring paths containing "/.", so you should intervene if you want that changed.


---

Comment by jhpalmieri created at 2013-02-26 16:48:25

Okay, I was wrong. It looks like #12415 will ignore files in directories starting with "." within the Sage library, but they will have no problem testing files if the entire Sage directory is contained in "/home/user/.Sage/...". So I propose we don't work further on this ticket and just wait for #12415 (or help with it, if that's possible).


---

Comment by ncohen created at 2013-02-26 17:01:47

Thank you for telling me ! `:-)`

Nathann

(This ticket is to be closed, as #12415 will do the job)


---

Comment by ncohen created at 2013-02-26 17:01:47

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-07 08:10:20

Resolution: duplicate
