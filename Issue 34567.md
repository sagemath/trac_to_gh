# Issue 34567: Deprecate sage.interfaces is_...Element functions

Issue created by migration from https://trac.sagemath.org/ticket/34804

Original creator: mkoeppe

Original creation time: 2022-11-28 18:56:02

CC:  dimpase klee

Introducing a module `sage.interfaces.abc` with abstract base classes for `isinstance` testing (see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies)


---

Comment by dimpase created at 2022-11-29 20:46:53


```diff
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
@@ -211,6 +211,9 @@ import platform
 import string
 import warnings
 
+import sage.rings.abc
+
+
 WORKSPACE = gap_workspace_file()
 
 first_try = True
@@ -1524,7 +1527,7 @@ def gap_reset_workspace(max_workspace_size=None, verbose=False):
 
 
 @instancedoc
-class GapElement(GapElement_generic):
+class GapElement(GapElement_generic, sage.rings.abc.GapElement):
     def __getitem__(self, n):
         """
         EXAMPLES::
```


this is weird - do you mean `sage.interfaces...` there, not `sage.rings...` ?
----
New commits:


---

Comment by mkoeppe created at 2022-11-29 20:48:19

Yes, sorry, it should be `sage.interfaces...` of course


---

Comment by dimpase created at 2022-11-29 21:26:43

I took (corrected) pieces of this branch to #34770. So this ought to be based on the branch there.


---

Comment by git created at 2022-12-04 21:59:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-12-04 22:10:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 22:45:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-04 22:48:04

Changing status from new to needs_review.


---

Comment by git created at 2022-12-04 23:40:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-12-05 09:47:01

New commits:


---

Comment by dimpase created at 2022-12-05 10:44:46

we have still only a fraction done:


```
Axiom            ?
Expect           ?
FriCAS           ?
Gap              done
Gp               done
Interface        ?
Kash             ?
LiE              ?
Lisp             ?
Macaulay2        done
Magma            ?
Maxima           ?
MaximaLib        ?
R                ?
Singular         done
```



---

Comment by dimpase created at 2022-12-05 12:24:42

How about an implementation with a decorator:

```python
r"""
Abstract base classes for interface elements
"""
def _add_doc():
    def wrapped(c):
        c.__doc__ = "\n Abstract base class for :class:`~sage.interfaces.gap." + c.__name__
        c.__doc__ += """
    
  This class is defined for the purpose of ``isinstance`` tests.  It should not be
  instantiated.

  EXAMPLES:

  By design, there is a unique direct subclass::

  """
        c.__doc__ += "    sage: len(sage.interfaces.abc."+c.__name__+".__subclasses__()) <= 1\n      True"
        return c
    return wrapped


@_add_doc()
class GapElement: pass


@_add_doc()
class GpElement: pass

...
```


Needless to say, docstrings etc work as they should this way. Decorator overhead - very small, if at all, IMHO.


---

Comment by mkoeppe created at 2022-12-05 17:33:50

Doctests are discovered by parsing files; they cannot be supplied by decorators.


---

Comment by git created at 2022-12-05 17:51:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-05 17:57:52

The remaining is_... functions are not used anywhere


---

Comment by git created at 2022-12-05 18:01:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-05 18:04:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-05 18:20:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-05 18:59:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-05 22:51:52

Green checks, ready for review


---

Comment by dimpase created at 2022-12-06 09:41:59

Replying to [comment:17 Matthias KÃ¶ppe]:
> Doctests are discovered by parsing files; they cannot be supplied by decorators.

Yes, they can. In fact, very easy to amend and doctest the docstring of a function:

```
$ cat d.py 
def docstr(f):
    """
    amends the docstring
    """
    f.__doc__ += """
    >>> tst(1)
    42
    """
    return f

@docstr
def tst(x):
    '''adds 1 to x
    >>> tst(0)
    1
    >>> tst(42)
    42 
    '''
    return x+1

if __name__ == '__main__':
    import doctest
    doctest.testmod()
$
$ python3 d.py 
**********************************************************************
File "/tmp/d.py", line 16, in __main__.tst
Failed example:
    tst(42)
Expected:
    42 
Got:
    43
**********************************************************************
File "/tmp/d.py", line 19, in __main__.tst
Failed example:
    tst(1)
Expected:
    42
Got:
    2
**********************************************************************
1 items had failures:
   2 of   3 in __main__.tst
```


See, the original `tst()` had 2 doctests, one was added by ``@`docstr` - and 3 were tested.
So it's perfectly doable for functions.

As a sanity check:

```
$ ipython3 
Python 3.9.2 (default, Feb 28 2021, 17:03:44) 
Type 'copyright', 'credits' or 'license' for more information
IPython 7.20.0 -- An enhanced Interactive Python. Type '?' for help.

In [1]: from d import  *

In [2]: tst?
Docstring:
adds 1 to x
>>> tst(0)
1
>>> tst(42)
42 

>>> tst(1)
42
File:      /tmp/d.py
Type:      function
```


------

As we see, doctests are run on `__doc__` attributes of functions, not by scraping the text of the file.


---

Comment by dimpase created at 2022-12-06 10:12:19

And it works, in vanilla Python 3.9, with classes too:

```python
def docstr(f):
    """
    amends the docstring
    """
    f.__doc__ += """
    >>> len(tst.__subclasses__()) > 0
    True
    """
    return f

@docstr
class tst:
    '''testing
    >>> len(tst.__subclasses__()) <= 1
    True
    '''
    pass

if __name__ == '__main__':
    import doctest
    doctest.testmod()
```

and so we see 2 doctests being run, one from the class body, one added by the decorator.

```
$ python3 c.py 
**********************************************************************
File "/tmp/c.py", line 17, in __main__.tst
Failed example:
    len(tst.__subclasses__()) > 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
   1 of   2 in __main__.tst
***Test Failed*** 1 failures.
```

(You can easily modify this so that the class has empty `__doc__`, then one can create it in the decorator, so it's all sane here in vanilla Python).


I can only conclude that Sage's doctest system is borked at this point,and somehow
does a non-vanilla thing. 
Indeed,  `sage -t c.py` does not see the doctests added by the decorator.


---

Comment by dimpase created at 2022-12-06 11:20:23

I've opened #34828 to fix the doctest issue in comment:28


---

Comment by mkoeppe created at 2022-12-06 18:48:41

Let's not wait for that to be fixed


---

Comment by dimpase created at 2022-12-06 21:20:04

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-12-06 21:20:04

lgtm


---

Comment by mkoeppe created at 2022-12-06 21:22:11

Thank you!
