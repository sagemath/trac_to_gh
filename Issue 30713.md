# Issue 30713: sage-download-file: Proper initialization of SSL certificates

archive/issues_030713.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @etn40ff tmonteil\n\n(from #29418)\n\nSee ticket description of #29418.\n\nWhen done, we can switch sage-bootstrap-python back to preferring `python3` on macOS.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30950\n\n",
    "created_at": "2020-11-23T02:01:24Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage-download-file: Proper initialization of SSL certificates",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30713",
    "user": "@mkoeppe"
}
```
CC:  @jhpalmieri @dimpase @etn40ff tmonteil

(from #29418)

See ticket description of #29418.

When done, we can switch sage-bootstrap-python back to preferring `python3` on macOS.

Issue created by migration from https://trac.sagemath.org/ticket/30950





---

archive/issue_comments_439111.json:
```json
{
    "body": "Is this necessary? I'm not sure how to test, but here's what I did: with #29719 (new flint), I used\n\n```\n$ ./configure --with-python=/usr/bin/python3 --enable-download-from-upstream-url --with-system-flint=no\n$ make flint\n```\n\n`flint` was downloaded properly. Since that worked, I tried a pip package:\n\n```\n$ ./sage -i biopython\n```\n\nThat also worked. What should I be testing?\n\nEdit: hold on, trying again after editing `build/bin/sage-system-python`.",
    "created_at": "2020-11-23T04:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439111",
    "user": "@jhpalmieri"
}
```

Is this necessary? I'm not sure how to test, but here's what I did: with #29719 (new flint), I used

```
$ ./configure --with-python=/usr/bin/python3 --enable-download-from-upstream-url --with-system-flint=no
$ make flint
```

`flint` was downloaded properly. Since that worked, I tried a pip package:

```
$ ./sage -i biopython
```

That also worked. What should I be testing?

Edit: hold on, trying again after editing `build/bin/sage-system-python`.



---

archive/issue_comments_439112.json:
```json
{
    "body": "This is affecting upstream URLs that are https.\nYou can test by replacing `upstream/mirror_list` by something that always fails to force download from the upstream URL.",
    "created_at": "2020-11-23T05:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439112",
    "user": "@mkoeppe"
}
```

This is affecting upstream URLs that are https.
You can test by replacing `upstream/mirror_list` by something that always fails to force download from the upstream URL.



---

archive/issue_comments_439113.json:
```json
{
    "body": "I put a print statement in `sage-system-python` to say what Python it's using (2nd line below). I removed the `attrs` tarball and modified `mirror_list` to only include https sites. I see this at the top of the `attrs` log file:\n\n```\n[attrs-19.3.0] Found local metadata for attrs-19.3.0\n[attrs-19.3.0] PYTHON=/usr/bin/python3\n[attrs-19.3.0] Attempting to download package attrs-19.3.0.tar.gz from mirrors\n[attrs-19.3.0] https://mirror.csclub.uwaterloo.ca/sage/spkg/upstream/attrs/attrs-19.3.0.tar.gz\n[attrs-19.3.0] [......................................................................]\n[attrs-19.3.0] attrs-19.3.0\n```\n",
    "created_at": "2020-11-23T05:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439113",
    "user": "@jhpalmieri"
}
```

I put a print statement in `sage-system-python` to say what Python it's using (2nd line below). I removed the `attrs` tarball and modified `mirror_list` to only include https sites. I see this at the top of the `attrs` log file:

```
[attrs-19.3.0] Found local metadata for attrs-19.3.0
[attrs-19.3.0] PYTHON=/usr/bin/python3
[attrs-19.3.0] Attempting to download package attrs-19.3.0.tar.gz from mirrors
[attrs-19.3.0] https://mirror.csclub.uwaterloo.ca/sage/spkg/upstream/attrs/attrs-19.3.0.tar.gz
[attrs-19.3.0] [......................................................................]
[attrs-19.3.0] attrs-19.3.0
```




---

archive/issue_comments_439114.json:
```json
{
    "body": "I then modified `sage_bootstrap/download/mirror_list.py`:\n\n```diff\ndiff --git a/build/sage_bootstrap/download/mirror_list.py b/build/sage_bootstrap/download/mirror_list.py\nindex 12868bf608..3a4b9d22fc 100644\n--- a/build/sage_bootstrap/download/mirror_list.py\n+++ b/build/sage_bootstrap/download/mirror_list.py\n@@ -200,8 +200,6 @@ class MirrorList(object):\n             pass\n         for mirror in self.mirrors:\n             yield mirror\n-        # If all else fails: Try the packages we host ourselves\n-        yield 'http://sagepad.org/'\n \n     @property\n     def fastest(self):\n```\n\nand changed `mirror_list` to include just a nonsense site. Then\n\n```\nFound local metadata for attrs-19.3.0\nPYTHON=/usr/bin/python3\nAttempting to download package attrs-19.3.0.tar.gz from mirrors\nhttp://uw.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz\n[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\nERROR [transfer|run:135]: [Errno socket error] [Errno socket error] [Errno 404] Not Found: '//www.washington.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz'\nAttempting to download from https://pypi.io/packages/source/a/attrs/attrs-19.3.0.tar.gz\n[......................................................................]\nattrs-19.3.0\n====================================================\n```\n",
    "created_at": "2020-11-23T05:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439114",
    "user": "@jhpalmieri"
}
```

I then modified `sage_bootstrap/download/mirror_list.py`:

```diff
diff --git a/build/sage_bootstrap/download/mirror_list.py b/build/sage_bootstrap/download/mirror_list.py
index 12868bf608..3a4b9d22fc 100644
--- a/build/sage_bootstrap/download/mirror_list.py
+++ b/build/sage_bootstrap/download/mirror_list.py
@@ -200,8 +200,6 @@ class MirrorList(object):
             pass
         for mirror in self.mirrors:
             yield mirror
-        # If all else fails: Try the packages we host ourselves
-        yield 'http://sagepad.org/'
 
     @property
     def fastest(self):
```

and changed `mirror_list` to include just a nonsense site. Then

```
Found local metadata for attrs-19.3.0
PYTHON=/usr/bin/python3
Attempting to download package attrs-19.3.0.tar.gz from mirrors
http://uw.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno socket error] [Errno socket error] [Errno 404] Not Found: '//www.washington.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz'
Attempting to download from https://pypi.io/packages/source/a/attrs/attrs-19.3.0.tar.gz
[......................................................................]
attrs-19.3.0
====================================================
```




---

archive/issue_comments_439115.json:
```json
{
    "body": "This looks promising... I'm surprised that this seems to be working now. I don't think we changed anything. You don't have `SAGE_DOWNLOAD_FILE_OPTIONS` set in your global environment by any chance?",
    "created_at": "2020-11-23T06:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439115",
    "user": "@mkoeppe"
}
```

This looks promising... I'm surprised that this seems to be working now. I don't think we changed anything. You don't have `SAGE_DOWNLOAD_FILE_OPTIONS` set in your global environment by any chance?



---

archive/issue_comments_439116.json:
```json
{
    "body": "I may be too optimistic, and it may depend, for example, on the version of OS X. Does the version of Python 3 depend on the version of Xcode, or the OS version, or something else? Anyway, this testing was done on Big Sur, although the same version of Python (3.8.2) is present on 10.15.7. The previous problems were reported with Python 3.7, I think.\n\nI don't set any environment variables with names starting \"SAGE\".",
    "created_at": "2020-11-23T17:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439116",
    "user": "@jhpalmieri"
}
```

I may be too optimistic, and it may depend, for example, on the version of OS X. Does the version of Python 3 depend on the version of Xcode, or the OS version, or something else? Anyway, this testing was done on Big Sur, although the same version of Python (3.8.2) is present on 10.15.7. The previous problems were reported with Python 3.7, I think.

I don't set any environment variables with names starting "SAGE".



---

archive/issue_comments_439117.json:
```json
{
    "body": "what is the Python3 involved here?",
    "created_at": "2020-11-23T20:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439117",
    "user": "@dimpase"
}
```

what is the Python3 involved here?



---

archive/issue_comments_439118.json:
```json
{
    "body": "You can have Python3 installed in Homebrew, Python3 installed from python.org, and system-provided Python3.",
    "created_at": "2020-11-23T20:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439118",
    "user": "@dimpase"
}
```

You can have Python3 installed in Homebrew, Python3 installed from python.org, and system-provided Python3.



---

archive/issue_comments_439119.json:
```json
{
    "body": "In my testing, it's the system-provided Python 3, `/usr/bin/python3`.",
    "created_at": "2020-11-23T20:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439119",
    "user": "@jhpalmieri"
}
```

In my testing, it's the system-provided Python 3, `/usr/bin/python3`.



---

archive/issue_comments_439120.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439120",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_439121.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-29T23:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439121",
    "user": "tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_439122.json:
```json
{
    "body": "Could you please tell if the proposed branch fixes your issue on MacOS ?\n----\nNew commits:",
    "created_at": "2021-09-29T23:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439122",
    "user": "tmonteil"
}
```

Could you please tell if the proposed branch fixes your issue on MacOS ?
----
New commits:



---

archive/issue_comments_439123.json:
```json
{
    "body": "Hm... I am having difficulty reproducing the original problem on my current system... this might confirm comment:1, comment:6",
    "created_at": "2021-09-30T00:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439123",
    "user": "@mkoeppe"
}
```

Hm... I am having difficulty reproducing the original problem on my current system... this might confirm comment:1, comment:6



---

archive/issue_comments_439124.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30713#issuecomment-439124",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
