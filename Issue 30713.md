# Issue 30713: sage-download-file: Proper initialization of SSL certificates

Issue created by migration from https://trac.sagemath.org/ticket/30950

Original creator: mkoeppe

Original creation time: 2020-11-23 02:01:24

CC:  jhpalmieri dimpase etn40ff tmonteil

(from #29418)

See ticket description of #29418.

When done, we can switch sage-bootstrap-python back to preferring `python3` on macOS.


---

Comment by jhpalmieri created at 2020-11-23 04:57:15

Is this necessary? I'm not sure how to test, but here's what I did: with #29719 (new flint), I used

```
$ ./configure --with-python=/usr/bin/python3 --enable-download-from-upstream-url --with-system-flint=no
$ make flint
```

`flint` was downloaded properly. Since that worked, I tried a pip package:

```
$ ./sage -i biopython
```

That also worked. What should I be testing?

Edit: hold on, trying again after editing `build/bin/sage-system-python`.


---

Comment by mkoeppe created at 2020-11-23 05:10:52

This is affecting upstream URLs that are https.
You can test by replacing `upstream/mirror_list` by something that always fails to force download from the upstream URL.


---

Comment by jhpalmieri created at 2020-11-23 05:25:30

I put a print statement in `sage-system-python` to say what Python it's using (2nd line below). I removed the `attrs` tarball and modified `mirror_list` to only include https sites. I see this at the top of the `attrs` log file:

```
[attrs-19.3.0] Found local metadata for attrs-19.3.0
[attrs-19.3.0] PYTHON=/usr/bin/python3
[attrs-19.3.0] Attempting to download package attrs-19.3.0.tar.gz from mirrors
[attrs-19.3.0] https://mirror.csclub.uwaterloo.ca/sage/spkg/upstream/attrs/attrs-19.3.0.tar.gz
[attrs-19.3.0] [......................................................................]
[attrs-19.3.0] attrs-19.3.0
```



---

Comment by jhpalmieri created at 2020-11-23 05:31:22

I then modified `sage_bootstrap/download/mirror_list.py`:

```diff
diff --git a/build/sage_bootstrap/download/mirror_list.py b/build/sage_bootstrap/download/mirror_list.py
index 12868bf608..3a4b9d22fc 100644
--- a/build/sage_bootstrap/download/mirror_list.py
+++ b/build/sage_bootstrap/download/mirror_list.py
@@ -200,8 +200,6 @@ class MirrorList(object):
             pass
         for mirror in self.mirrors:
             yield mirror
-        # If all else fails: Try the packages we host ourselves
-        yield 'http://sagepad.org/'
 
     @property
     def fastest(self):
```

and changed `mirror_list` to include just a nonsense site. Then

```
Found local metadata for attrs-19.3.0
PYTHON=/usr/bin/python3
Attempting to download package attrs-19.3.0.tar.gz from mirrors
http://uw.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno socket error] [Errno socket error] [Errno 404] Not Found: '//www.washington.edu/spkg/upstream/attrs/attrs-19.3.0.tar.gz'
Attempting to download from https://pypi.io/packages/source/a/attrs/attrs-19.3.0.tar.gz
[......................................................................]
attrs-19.3.0
====================================================
```



---

Comment by mkoeppe created at 2020-11-23 06:56:00

This looks promising... I'm surprised that this seems to be working now. I don't think we changed anything. You don't have `SAGE_DOWNLOAD_FILE_OPTIONS` set in your global environment by any chance?


---

Comment by jhpalmieri created at 2020-11-23 17:31:27

I may be too optimistic, and it may depend, for example, on the version of OS X. Does the version of Python 3 depend on the version of Xcode, or the OS version, or something else? Anyway, this testing was done on Big Sur, although the same version of Python (3.8.2) is present on 10.15.7. The previous problems were reported with Python 3.7, I think.

I don't set any environment variables with names starting "SAGE".


---

Comment by dimpase created at 2020-11-23 20:19:51

what is the Python3 involved here?


---

Comment by dimpase created at 2020-11-23 20:21:04

You can have Python3 installed in Homebrew, Python3 installed from python.org, and system-provided Python3.


---

Comment by jhpalmieri created at 2020-11-23 20:22:16

In my testing, it's the system-provided Python 3, `/usr/bin/python3`.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by tmonteil created at 2021-09-29 23:51:33

Changing status from new to needs_review.


---

Comment by tmonteil created at 2021-09-29 23:51:33

Could you please tell if the proposed branch fixes your issue on MacOS ?
----
New commits:


---

Comment by mkoeppe created at 2021-09-30 00:34:39

Hm... I am having difficulty reproducing the original problem on my current system... this might confirm comment:1, comment:6


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
