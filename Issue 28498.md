# Issue 28498: Lattice Polytopes: Obtain facets directly from facet_normals

archive/issues_028498.json:
```json
{
    "body": "CC:  @jplab @laisrast\n\nKeywords: lattice polytopes, facets\n\nWe improve the method `facets` of lattice polytopes to be obtained directly from the facet normals.\n\nBefore, this method implicitly computed the face lattice and then obtained the codimension 1 faces of the face lattice.\n\nTimings before:\n\n```\nsage: o = lattice_polytope.cross_polytope(5)\nsage: %time _ = o.facets()\nCPU times: user 24.8 ms, sys: 4.13 ms, total: 28.9 ms\nWall time: 26.8 ms\nsage: o = lattice_polytope.cross_polytope(7)\nsage: %time _ = o.facets()\nCPU times: user 302 ms, sys: 4.04 ms, total: 306 ms\nWall time: 288 ms\nsage: o = lattice_polytope.cross_polytope(10)\nsage: %time _ = o.facets()\nCPU times: user 16.2 s, sys: 70.6 ms, total: 16.3 s\nWall time: 16.3 s\n```\n\n\nTimings with this ticket:\n\n```\nsage: o = lattice_polytope.cross_polytope(5)\nsage: %time _ = o.facets()\nCPU times: user 2.29 ms, sys: 0 ns, total: 2.29 ms\nWall time: 1.97 ms\nsage: o = lattice_polytope.cross_polytope(7)\nsage: %time _ = o.facets()\nCPU times: user 5.76 ms, sys: 0 ns, total: 5.76 ms\nWall time: 5.22 ms\nsage: o = lattice_polytope.cross_polytope(10)\nsage: %time _ = o.facets()\nCPU times: user 45.1 ms, sys: 4.7 ms, total: 49.8 ms\nWall time: 46.2 ms\n```\n\n\nRemark: This makes `CombinatorialPolyhedron` useful for lattice polytopes, as it is obtained from the method `facets`. Currently the entire face lattice is implicitly computed to obtain the combinatorial polyhedron.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28735\n\n",
    "created_at": "2019-11-14T13:05:24Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Lattice Polytopes: Obtain facets directly from facet_normals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28498",
    "user": "https://github.com/kliem"
}
```
CC:  @jplab @laisrast

Keywords: lattice polytopes, facets

We improve the method `facets` of lattice polytopes to be obtained directly from the facet normals.

Before, this method implicitly computed the face lattice and then obtained the codimension 1 faces of the face lattice.

Timings before:

```
sage: o = lattice_polytope.cross_polytope(5)
sage: %time _ = o.facets()
CPU times: user 24.8 ms, sys: 4.13 ms, total: 28.9 ms
Wall time: 26.8 ms
sage: o = lattice_polytope.cross_polytope(7)
sage: %time _ = o.facets()
CPU times: user 302 ms, sys: 4.04 ms, total: 306 ms
Wall time: 288 ms
sage: o = lattice_polytope.cross_polytope(10)
sage: %time _ = o.facets()
CPU times: user 16.2 s, sys: 70.6 ms, total: 16.3 s
Wall time: 16.3 s
```


Timings with this ticket:

```
sage: o = lattice_polytope.cross_polytope(5)
sage: %time _ = o.facets()
CPU times: user 2.29 ms, sys: 0 ns, total: 2.29 ms
Wall time: 1.97 ms
sage: o = lattice_polytope.cross_polytope(7)
sage: %time _ = o.facets()
CPU times: user 5.76 ms, sys: 0 ns, total: 5.76 ms
Wall time: 5.22 ms
sage: o = lattice_polytope.cross_polytope(10)
sage: %time _ = o.facets()
CPU times: user 45.1 ms, sys: 4.7 ms, total: 49.8 ms
Wall time: 46.2 ms
```


Remark: This makes `CombinatorialPolyhedron` useful for lattice polytopes, as it is obtained from the method `facets`. Currently the entire face lattice is implicitly computed to obtain the combinatorial polyhedron.

Issue created by migration from https://trac.sagemath.org/ticket/28735





---

archive/issue_comments_402011.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-11-14T13:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402011",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_402012.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-14T13:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402012",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-14T17:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402013",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_402014.json:
```json
{
    "body": "While it certainly makes sense, some things should be addressed:\n1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.\n2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.\n3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?\n\nAs a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.",
    "created_at": "2019-11-14T17:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402014",
    "user": "https://github.com/novoselt"
}
```

While it certainly makes sense, some things should be addressed:
1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.
2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.
3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?

As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.



---

archive/issue_comments_402015.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-14T20:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402016.json:
```json
{
    "body": "Thanks for the comments.\n\nReplying to [comment:2 novoselt]:\n> While it certainly makes sense, some things should be addressed:\n> 1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.\nSure.\n> 2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.\nIt seems to still work:\n\n```\nsage: o = lattice_polytope.cross_polytope(5)\nsage: f = o.facets()[0]\nsage: f.facet_of()\n(5-d reflexive polytope in 5-d lattice M,)\nsage: L = o.face_lattice()\nsage: D = L.hasse_diagram()\nsage: D.neighbors(f)\n[3-d face of 5-d reflexive polytope in 5-d lattice M,\n 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M,\n 3-d face of 5-d reflexive polytope in 5-d lattice M]\nsage: f.facet_of()\n(5-d reflexive polytope in 5-d lattice M,)\nsage: \n```\n\nNevertheless, I adopted `face_lattice` to return exactly the facets in codimension 1.\n\nI also changed my could to only be applied, when `self is self.ambient()`.\n> 3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?\nMy facets should be in exactly the same order, as they used to be, as I just took the code from `face_lattice`. They are also in the same order as the normals. So anything else would be very strange. Wouldn't it?\n> \n> As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.\n\nEventually, it makes sense to cache the hasse diagram instead of the `FiniteLatticePoset`. See [https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ](https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ).\n----\nNew commits:",
    "created_at": "2019-11-14T20:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402016",
    "user": "https://github.com/kliem"
}
```

Thanks for the comments.

Replying to [comment:2 novoselt]:
> While it certainly makes sense, some things should be addressed:
> 1. Caching of facets - while the existing code computes more than necessary, it does it once and on the second invocation nothing is computed at all, plus all the properties of the facets (like lattice point count) are cached as well.
Sure.
> 2. Face lattice methods - is it still possible with this change to ask for neighbours of a facet or its own facets and get the same results as before? I have doubts about it as it relied on facets being elements of a poset.
It seems to still work:

```
sage: o = lattice_polytope.cross_polytope(5)
sage: f = o.facets()[0]
sage: f.facet_of()
(5-d reflexive polytope in 5-d lattice M,)
sage: L = o.face_lattice()
sage: D = L.hasse_diagram()
sage: D.neighbors(f)
[3-d face of 5-d reflexive polytope in 5-d lattice M,
 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M,
 3-d face of 5-d reflexive polytope in 5-d lattice M]
sage: f.facet_of()
(5-d reflexive polytope in 5-d lattice M,)
sage: 
```

Nevertheless, I adopted `face_lattice` to return exactly the facets in codimension 1.

I also changed my could to only be applied, when `self is self.ambient()`.
> 3. Sorting in low-dimensional cases - there is care the in the existing code to have consistent order of vertices and 0-dimensional faces, as well as facet normals and facets. And sometimes these coinside. Will the new code preserve the order?
My facets should be in exactly the same order, as they used to be, as I just took the code from `face_lattice`. They are also in the same order as the normals. So anything else would be very strange. Wouldn't it?
> 
> As a possible easy solution - facets may take some argument like ``from_lattice=True`` which will trigger full lattice computation when ``True`` (default) and when ``False`` it will check if lattice is already computed (in which case there is no harm in using it) and if not - use the suggested code.

Eventually, it makes sense to cache the hasse diagram instead of the `FiniteLatticePoset`. See [https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ](https://groups.google.com/d/msg/sage-devel/UuSDdN9QC3M/i2Uzp2SzEAAJ).
----
New commits:



---

archive/issue_comments_402017.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-14T20:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402017",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402018.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-15T05:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402019.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-15T06:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402019",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_402020.json:
```json
{
    "body": "Actually, I think I'm going to change the design a bit.\n\n- Make `LPFace` a method of the lattice polytope (cached), which\n  - if `self.ambient() is self` works as it is\n  - otherwise transform the indices to ambient indices (using cached dictionaries) and then call `LPFace` of ambient\n\nThis way one can obtain facets directly from any lattice polytope. This will also allow to obtain faces directly from an interator instead of from the face lattice.",
    "created_at": "2019-11-15T06:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402020",
    "user": "https://github.com/kliem"
}
```

Actually, I think I'm going to change the design a bit.

- Make `LPFace` a method of the lattice polytope (cached), which
  - if `self.ambient() is self` works as it is
  - otherwise transform the indices to ambient indices (using cached dictionaries) and then call `LPFace` of ambient

This way one can obtain facets directly from any lattice polytope. This will also allow to obtain faces directly from an interator instead of from the face lattice.



---

archive/issue_comments_402021.json:
```json
{
    "body": "By face lattice methods I actually meant methods of facets which are related to the lattice:\n\n```\nsage: sage: o = lattice_polytope.cross_polytope(5)\n....: sage: f = o.facets()[0]\n....: sage: f.facet_of()\n....: \n(5-d reflexive polytope in 5-d lattice M,)\nsage: f.adjacent()\n(4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M,\n 4-d face of 5-d reflexive polytope in 5-d lattice M)\n```\n\nWill this adjacent method work with your design? What would be nice (and perhaps your last comment was about it as well) is to have an ability to construct standalone faces, but whenever they are requested again for whatever reason (e.g. because the full face lattice is computed) - exactly the same objects are returned.",
    "created_at": "2019-11-15T16:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402021",
    "user": "https://github.com/novoselt"
}
```

By face lattice methods I actually meant methods of facets which are related to the lattice:

```
sage: sage: o = lattice_polytope.cross_polytope(5)
....: sage: f = o.facets()[0]
....: sage: f.facet_of()
....: 
(5-d reflexive polytope in 5-d lattice M,)
sage: f.adjacent()
(4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M,
 4-d face of 5-d reflexive polytope in 5-d lattice M)
```

Will this adjacent method work with your design? What would be nice (and perhaps your last comment was about it as well) is to have an ability to construct standalone faces, but whenever they are requested again for whatever reason (e.g. because the full face lattice is computed) - exactly the same objects are returned.



---

archive/issue_comments_402022.json:
```json
{
    "body": "Also a general remark on these improvements and optimizations - they are very welcome, especially since I have no time anymore to work on them myself! But please keep in mind the use case these classes were introduced - working with a lot of quite small polytopes (reflexive, their faces and subpolytopes) where faces and numbers of lattice points are requested repeatedly. So whatever optimizations are added to initial constructions should not affect caching of stuff for later reuse. Thank you!",
    "created_at": "2019-11-15T16:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402022",
    "user": "https://github.com/novoselt"
}
```

Also a general remark on these improvements and optimizations - they are very welcome, especially since I have no time anymore to work on them myself! But please keep in mind the use case these classes were introduced - working with a lot of quite small polytopes (reflexive, their faces and subpolytopes) where faces and numbers of lattice points are requested repeatedly. So whatever optimizations are added to initial constructions should not affect caching of stuff for later reuse. Thank you!



---

archive/issue_comments_402023.json:
```json
{
    "body": "Ok, I keep that in mind.\n\nA few sentences about my motivation:\n\nI mainly just wanted to compute the face lattice by `CombinatorialPolyhedron`. However, it doesn't make any sense to initialize it from the facets, which are in turn taken from the face lattice.\n\nOne intermediate step, is to create the incidence matrix (#28743). This is implicitly done for the face lattice anyway. (Actually one can obtain the combinatorial polyhedron instead from the incidence matrix.)\n\nMaybe I just replace face lattice (in the `self is self.ambient()` case) and leave everything else the way it is.\n\nTo avoid memory leak, it makes also sense to cache the hasse diagram/digraph instead of `FiniteLatticePoset` (I was told that this is cached anyway). As it looks, many methods can then just call the hasse diagram directly.",
    "created_at": "2019-11-15T20:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402023",
    "user": "https://github.com/kliem"
}
```

Ok, I keep that in mind.

A few sentences about my motivation:

I mainly just wanted to compute the face lattice by `CombinatorialPolyhedron`. However, it doesn't make any sense to initialize it from the facets, which are in turn taken from the face lattice.

One intermediate step, is to create the incidence matrix (#28743). This is implicitly done for the face lattice anyway. (Actually one can obtain the combinatorial polyhedron instead from the incidence matrix.)

Maybe I just replace face lattice (in the `self is self.ambient()` case) and leave everything else the way it is.

To avoid memory leak, it makes also sense to cache the hasse diagram/digraph instead of `FiniteLatticePoset` (I was told that this is cached anyway). As it looks, many methods can then just call the hasse diagram directly.



---

archive/issue_comments_402024.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402024",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_events_072484.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28498#event-72484"
}
```



---

archive/issue_events_072485.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-01-06T20:20:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28498#event-72485"
}
```



---

archive/issue_events_072486.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-01-06T20:20:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28498#event-72486"
}
```



---

archive/issue_comments_402025.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-06T20:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402025",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402026.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-07T18:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402026",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_402027.json:
```json
{
    "body": "While this ticket is not closed, I updated the description to help people understand what was going on and why we this ticket is a \"won't fix\".",
    "created_at": "2020-02-11T10:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402027",
    "user": "https://github.com/kliem"
}
```

While this ticket is not closed, I updated the description to help people understand what was going on and why we this ticket is a "won't fix".



---

archive/issue_comments_402028.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2020-04-22T07:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28498#issuecomment-402028",
    "user": "https://github.com/fchapoton"
}
```

Resolution: wontfix



---

archive/issue_events_072487.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-04-22T07:38:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28498",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28498#event-72487"
}
```
