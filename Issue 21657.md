# Issue 21657: Do not compare dictionaries which might contain caches

Issue created by migration from Trac.

Original creator: saraedum

Original creation time: 2016-11-18 04:29:57

The following is a common pattern in implementations of `__cmp__` or `__eq__`:

```
sage: search_src("cmp\(self.__dict__,")
doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)
doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)
doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)
doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)
sage: search_src("__dict__ == ")
categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
combinat/dlx.py:142:        return self.__dict__ == other.__dict__
combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__
geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__
misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__
modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__
modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
```


This fails as soon as `self` has a ``@`cached_method`:

* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.
* A pickle contains a `PickledMethod` which is not considered the same as the `CachedMethodCaller(NoArgs)` in the original object.


---

Comment by tscrim created at 2016-11-18 06:15:53

See #19820 for the module morphism.


---

Comment by saraedum created at 2016-11-18 21:58:29

Thanks for pointing that one out.
