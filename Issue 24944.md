# Issue 24944: has_custom_conversion check in UnitalAlgebras.ParentMethods is broken

archive/issues_024944.json:
```json
{
    "body": "CC:  @nthiery\n\nThis code\n\n```\n            try:\n                has_custom_conversion = self.category().parent_class.from_base_ring.__func__ is not self.from_base_ring.__func__\n            except AttributeError:\n                # Sometimes from_base_ring is a lazy attribute\n                has_custom_conversion = True\n```\n\nis trying to determine whether `from_base_ring` comes from the category or not. However, in the case of a lazy attribute it wrongly sets `has_custom_conversion = True`.\n\nRegardless of this bug, the code to do check can be improved. The reason why the `__func__` access is needed in the first place is because we are trying to compare an *unbound* method with a *bound* method. If we have unbound methods on both sides of this check, it can be simplified and fixed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25181\n\n",
    "created_at": "2018-04-16T12:55:35Z",
    "labels": [
        "categories",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "has_custom_conversion check in UnitalAlgebras.ParentMethods is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24944",
    "user": "@jdemeyer"
}
```
CC:  @nthiery

This code

```
            try:
                has_custom_conversion = self.category().parent_class.from_base_ring.__func__ is not self.from_base_ring.__func__
            except AttributeError:
                # Sometimes from_base_ring is a lazy attribute
                has_custom_conversion = True
```

is trying to determine whether `from_base_ring` comes from the category or not. However, in the case of a lazy attribute it wrongly sets `has_custom_conversion = True`.

Regardless of this bug, the code to do check can be improved. The reason why the `__func__` access is needed in the first place is because we are trying to compare an *unbound* method with a *bound* method. If we have unbound methods on both sides of this check, it can be simplified and fixed.

Issue created by migration from https://trac.sagemath.org/ticket/25181





---

archive/issue_comments_351083.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-04-16T13:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351083",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_351084.json:
```json
{
    "body": "`@`nthiery: it would be great to have some advice on how to proceed...",
    "created_at": "2018-04-16T15:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351084",
    "user": "@jdemeyer"
}
```

`@`nthiery: it would be great to have some advice on how to proceed...



---

archive/issue_comments_351085.json:
```json
{
    "body": "So use `six.get_unbound_function` on both sides.  The function name is a bit of a mouthful, but it's very accurate and unambiguous as to what it does...\n\nAnother way to spell it is `the_func = getattr(the_method, '__func__', the_method)` but it's a little less obvious what the intent is of that.",
    "created_at": "2018-04-18T10:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351085",
    "user": "@embray"
}
```

So use `six.get_unbound_function` on both sides.  The function name is a bit of a mouthful, but it's very accurate and unambiguous as to what it does...

Another way to spell it is `the_func = getattr(the_method, '__func__', the_method)` but it's a little less obvious what the intent is of that.



---

archive/issue_comments_351086.json:
```json
{
    "body": "I meant advice on what to do with the lazy attribute situation. The comments do not agree with the code. So either we fix the comments to say what the code really does or we change the code to do what the comments say. Unfortunately, the latter breaks stuff (see ticket description).",
    "created_at": "2018-04-18T10:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351086",
    "user": "@jdemeyer"
}
```

I meant advice on what to do with the lazy attribute situation. The comments do not agree with the code. So either we fix the comments to say what the code really does or we change the code to do what the comments say. Unfortunately, the latter breaks stuff (see ticket description).



---

archive/issue_comments_351087.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> So use `six.get_unbound_function` on both sides.\n\nNot both sides, because one side is a *bound* method and the other is an *unbound* method.",
    "created_at": "2018-04-18T12:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351087",
    "user": "@jdemeyer"
}
```

Replying to [comment:5 embray]:
> So use `six.get_unbound_function` on both sides.

Not both sides, because one side is a *bound* method and the other is an *unbound* method.



---

archive/issue_comments_351088.json:
```json
{
    "body": "Nicolas: I would love to hear your opinion on this ticket.",
    "created_at": "2018-04-28T12:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351088",
    "user": "@jdemeyer"
}
```

Nicolas: I would love to hear your opinion on this ticket.



---

archive/issue_comments_351089.json:
```json
{
    "body": "Given that this seems difficult to fix properly, I'll probably go for cleaning it up without making any functional changes and properly documenting what happens.",
    "created_at": "2018-05-17T10:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351089",
    "user": "@jdemeyer"
}
```

Given that this seems difficult to fix properly, I'll probably go for cleaning it up without making any functional changes and properly documenting what happens.



---

archive/issue_comments_351090.json:
```json
{
    "body": "This is already \"fixed\" in #24955 but only superficially.",
    "created_at": "2018-05-17T16:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351090",
    "user": "@embray"
}
```

This is already "fixed" in #24955 but only superficially.



---

archive/issue_comments_351091.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-14T13:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351091",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_351092.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-14T13:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351092",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351093.json:
```json
{
    "body": "Travis told me in person that he is willing to set this to positive review later this month, after discussing it with Nicolas.",
    "created_at": "2018-07-05T08:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351093",
    "user": "@jdemeyer"
}
```

Travis told me in person that he is willing to set this to positive review later this month, after discussing it with Nicolas.



---

archive/issue_comments_351094.json:
```json
{
    "body": "Changing keywords from \"\" to \"sagedays@icerm\".",
    "created_at": "2018-07-26T23:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351094",
    "user": "@jdemeyer"
}
```

Changing keywords from "" to "sagedays@icerm".



---

archive/issue_comments_351095.json:
```json
{
    "body": "Changing keywords from \"sagedays@icerm\" to \"sagedays@icerm python3\".",
    "created_at": "2018-07-27T09:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351095",
    "user": "@embray"
}
```

Changing keywords from "sagedays@icerm" to "sagedays@icerm python3".



---

archive/issue_comments_351096.json:
```json
{
    "body": "Adding python3 keyword since this helps fix a number of bugs there as well.",
    "created_at": "2018-07-27T09:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351096",
    "user": "@embray"
}
```

Adding python3 keyword since this helps fix a number of bugs there as well.



---

archive/issue_comments_351097.json:
```json
{
    "body": "Hi Jeroen!\n\nI have just been through the new version. It is now much much clearer what the current logic does; thanks a lot! The logic is still crappy and way too complicated. but it's indeed very reasonable to split the work in two stages (in this ticket: fixing the Python 3 issue + clarifying the current logic; in a later ticket:fix/improve the logic).\n\nPositive review on my side.\n\nJust one question: while rewriting the code, did you do some additional manual tests to check how things worked? Or were the current doctests sufficient? In the former case, in case you still have your manual tests under hand, could you add them to the doctests?\n\nThanks again,",
    "created_at": "2018-07-27T13:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351097",
    "user": "@nthiery"
}
```

Hi Jeroen!

I have just been through the new version. It is now much much clearer what the current logic does; thanks a lot! The logic is still crappy and way too complicated. but it's indeed very reasonable to split the work in two stages (in this ticket: fixing the Python 3 issue + clarifying the current logic; in a later ticket:fix/improve the logic).

Positive review on my side.

Just one question: while rewriting the code, did you do some additional manual tests to check how things worked? Or were the current doctests sufficient? In the former case, in case you still have your manual tests under hand, could you add them to the doctests?

Thanks again,



---

archive/issue_comments_351098.json:
```json
{
    "body": "Travis is next to me and agrees with the above comment. I let you set the positive review on our behalf after the question above.",
    "created_at": "2018-07-27T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351098",
    "user": "@nthiery"
}
```

Travis is next to me and agrees with the above comment. I let you set the positive review on our behalf after the question above.



---

archive/issue_comments_351099.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-27T13:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351099",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_351100.json:
```json
{
    "body": "Replying to [comment:19 nthiery]:\n> Just one question: while rewriting the code, did you do some additional manual tests to check how things worked?\n\nI don't think so.\n\n> Or were the current doctests sufficient?\n\nI recall from my work in Cernay on this ticket that the code was quite brittle: any small change in functionality would induce doctest failures somewhere. Maybe there are not many explicit tests, but the code is used in many places and therefore well tested implicitly.",
    "created_at": "2018-07-27T13:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351100",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 nthiery]:
> Just one question: while rewriting the code, did you do some additional manual tests to check how things worked?

I don't think so.

> Or were the current doctests sufficient?

I recall from my work in Cernay on this ticket that the code was quite brittle: any small change in functionality would induce doctest failures somewhere. Maybe there are not many explicit tests, but the code is used in many places and therefore well tested implicitly.



---

archive/issue_comments_351101.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-05T08:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24944#issuecomment-351101",
    "user": "@vbraun"
}
```

Resolution: fixed
