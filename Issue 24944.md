# Issue 24944: has_custom_conversion check in UnitalAlgebras.ParentMethods is broken

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-04-16 12:55:35

CC:  nthiery

This code

```
            try:
                has_custom_conversion = self.category().parent_class.from_base_ring.__func__ is not self.from_base_ring.__func__
            except AttributeError:
                # Sometimes from_base_ring is a lazy attribute
                has_custom_conversion = True
```

is trying to determine whether `from_base_ring` comes from the category or not. However, in the case of a lazy attribute it wrongly sets `has_custom_conversion = True`.

Regardless of this bug, the code to do check can be improved. The reason why the `__func__` access is needed in the first place is because we are trying to compare an _unbound_ method with a _bound_ method. If we have unbound methods on both sides of this check, it can be simplified and fixed.


---

Comment by jdemeyer created at 2018-04-16 13:01:28

New commits:


---

Comment by jdemeyer created at 2018-04-16 15:36:14

`@`nthiery: it would be great to have some advice on how to proceed...


---

Comment by embray created at 2018-04-18 10:06:15

So use `six.get_unbound_function` on both sides.  The function name is a bit of a mouthful, but it's very accurate and unambiguous as to what it does...

Another way to spell it is `the_func = getattr(the_method, '__func__', the_method)` but it's a little less obvious what the intent is of that.


---

Comment by jdemeyer created at 2018-04-18 10:44:30

I meant advice on what to do with the lazy attribute situation. The comments do not agree with the code. So either we fix the comments to say what the code really does or we change the code to do what the comments say. Unfortunately, the latter breaks stuff (see ticket description).


---

Comment by jdemeyer created at 2018-04-18 12:02:33

Replying to [comment:5 embray]:
> So use `six.get_unbound_function` on both sides.

Not both sides, because one side is a _bound_ method and the other is an _unbound_ method.


---

Comment by jdemeyer created at 2018-04-28 12:12:46

Nicolas: I would love to hear your opinion on this ticket.


---

Comment by jdemeyer created at 2018-05-17 10:10:31

Given that this seems difficult to fix properly, I'll probably go for cleaning it up without making any functional changes and properly documenting what happens.


---

Comment by embray created at 2018-05-17 16:12:26

This is already "fixed" in #24955 but only superficially.


---

Comment by git created at 2018-06-14 13:51:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-14 13:52:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-07-05 08:19:03

Travis told me in person that he is willing to set this to positive review later this month, after discussing it with Nicolas.


---

Comment by jdemeyer created at 2018-07-26 23:00:13

Changing keywords from "" to "sagedays@icerm".


---

Comment by embray created at 2018-07-27 09:46:13

Changing keywords from "sagedays@icerm" to "sagedays@icerm python3".


---

Comment by embray created at 2018-07-27 09:46:13

Adding python3 keyword since this helps fix a number of bugs there as well.


---

Comment by nthiery created at 2018-07-27 13:26:15

Hi Jeroen!

I have just been through the new version. It is now much much clearer what the current logic does; thanks a lot! The logic is still crappy and way too complicated. but it's indeed very reasonable to split the work in two stages (in this ticket: fixing the Python 3 issue + clarifying the current logic; in a later ticket:fix/improve the logic).

Positive review on my side.

Just one question: while rewriting the code, did you do some additional manual tests to check how things worked? Or were the current doctests sufficient? In the former case, in case you still have your manual tests under hand, could you add them to the doctests?

Thanks again,


---

Comment by nthiery created at 2018-07-27 13:27:31

Travis is next to me and agrees with the above comment. I let you set the positive review on our behalf after the question above.


---

Comment by jdemeyer created at 2018-07-27 13:39:42

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-07-27 13:39:42

Replying to [comment:19 nthiery]:
> Just one question: while rewriting the code, did you do some additional manual tests to check how things worked?

I don't think so.

> Or were the current doctests sufficient?

I recall from my work in Cernay on this ticket that the code was quite brittle: any small change in functionality would induce doctest failures somewhere. Maybe there are not many explicit tests, but the code is used in many places and therefore well tested implicitly.


---

Comment by vbraun created at 2018-08-05 08:42:47

Resolution: fixed
