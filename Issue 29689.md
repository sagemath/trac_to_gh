# Issue 29689: shifting issue in padic function: preprocess_list

archive/issues_029689.json:
```json
{
    "body": "Keywords: shift, preprocess_list\n\nUsing version 9.1 of sage, the function preprocess_list(), written in the file: /sage/src/sage/rings/padics/padic_ZZ_pX_element.pyx, crashes for lists of padics containing at least one element with **negative valuation and finite precision**.\n\nExample (see full output in attached file):\n\n```\nsage: from sage.rings.padics.padic_ZZ_pX_element import _test_preprocess_list\nsage: from sage.libs.ntl.all import ZZ as ntl_ZZ, ZZ_p as ntl_ZZ_p\nsage: T.<a> = Qp(5).extension(x^2-5)\nsage: _test_preprocess_list(T,[5^-1 + O(5)])\n------------------------------------------------------------------------\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x828b)[0x7f9b12f0928b]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x8348)[0x7f9b12f09348]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xb2f5)[0x7f9b12f0c2f5]\n/lib/x86_64-linux-gnu/libc.so.6(+0x3ef20)[0x7f9b215a0f20]\n/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7f9b215a0e97]\n/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7f9b215a2801]\n/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL13TerminalErrorEPKc+0x2b)[0x7f9b0792106b]\n/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL3invERNS_4ZZ_pERKS0_+0x75)[0x7f9b0783f505]\n/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL3divERNS_4ZZ_pERKS0_S3_+0x74)[0x7f9b0783f664]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/libs/ntl/ntl_ZZ_p.cpython-37m-x86_64-linux-gnu.so(+0xfd1f)[0x7f9a65732d1f]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x105972)[0x7f9b21a58972]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x95f5)[0x7f9a5a50a5f5]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x13c52)[0x7f9a5a514c52]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x172d6)[0x7f9a5a5182d6]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x258)[0x7f9b219ee358]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f9b219ee425]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f9b219c5d9e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f9b21adbbde]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f9b21adbc0b]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x185e4d)[0x7f9b21ad8e4d]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x23d)[0x7f9b219ee33d]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f9b219ee425]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f9b219c5d9e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f9b219c3a4e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f9b219c3a4e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x68c8f)[0x7f9b219bbc8f]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f9b21adbbde]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f9b21adbc0b]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_FileExFlags+0xaa)[0x7f9b21b10f3a]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_SimpleFileExFlags+0xfd)[0x7f9b21b110ad]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x1e25e0)[0x7f9b21b355e0]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_Py_UnixMain+0x49)[0x7f9b21b35859]\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f9b21583b97]\n/home/noa/workspace/padic_project/sage/local/bin/python3(_start+0x2a)[0x55f2e13c378a]\n------------------------------------------------------------------------\n```\n\n\nThe bug causes the following code to crash too (but only after fixing bug #29925):\n\n```\nsage: T.<a> = Qp(5).extension(x^2-5)\nsage: W.<w> = Qp(5).extension(x^2-5)\nsage: W(T(1/5))\n```\n\nOn the current version of sage, however (in which #29925 is yet unfixed), the above code does not crash, but returns a wrong result.\n\nThe bug is fixed by changing direction of shifting at some point in the function: substituting << by >>.\n\nNote: The bug repeated itself twice in this function. I did not add a doctest for the second case (where min_val > 0), because I think that under this condition, the fixed line is perhaps not reachabale at all: In case min_val > 0, the list does not contain any finite-precision elements (such elements are considered in the context of this function to have non-positive valuation). Therefore any padic element of such a list, is necessarily rational (or integer). So our line of code, which only applies to non-rational/integer padics, is allegedly not reachabale in this case.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29926\n\n",
    "created_at": "2020-06-21T14:42:06Z",
    "labels": [
        "padics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "shifting issue in padic function: preprocess_list",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29689",
    "user": "@n-vi"
}
```
Keywords: shift, preprocess_list

Using version 9.1 of sage, the function preprocess_list(), written in the file: /sage/src/sage/rings/padics/padic_ZZ_pX_element.pyx, crashes for lists of padics containing at least one element with **negative valuation and finite precision**.

Example (see full output in attached file):

```
sage: from sage.rings.padics.padic_ZZ_pX_element import _test_preprocess_list
sage: from sage.libs.ntl.all import ZZ as ntl_ZZ, ZZ_p as ntl_ZZ_p
sage: T.<a> = Qp(5).extension(x^2-5)
sage: _test_preprocess_list(T,[5^-1 + O(5)])
------------------------------------------------------------------------
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x828b)[0x7f9b12f0928b]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x8348)[0x7f9b12f09348]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xb2f5)[0x7f9b12f0c2f5]
/lib/x86_64-linux-gnu/libc.so.6(+0x3ef20)[0x7f9b215a0f20]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7f9b215a0e97]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7f9b215a2801]
/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL13TerminalErrorEPKc+0x2b)[0x7f9b0792106b]
/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL3invERNS_4ZZ_pERKS0_+0x75)[0x7f9b0783f505]
/home/noa/workspace/padic_project/sage/local/lib/libntl.so.43(_ZN3NTL3divERNS_4ZZ_pERKS0_S3_+0x74)[0x7f9b0783f664]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/libs/ntl/ntl_ZZ_p.cpython-37m-x86_64-linux-gnu.so(+0xfd1f)[0x7f9a65732d1f]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x105972)[0x7f9b21a58972]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x95f5)[0x7f9a5a50a5f5]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x13c52)[0x7f9a5a514c52]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x172d6)[0x7f9a5a5182d6]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x258)[0x7f9b219ee358]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f9b219ee425]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f9b219c5d9e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f9b21adbbde]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f9b21adbc0b]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x185e4d)[0x7f9b21ad8e4d]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x23d)[0x7f9b219ee33d]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f9b219ee425]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f9b219c5d9e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f9b219c3a4e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f9b219c3a4e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f9b219edeef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x68c8f)[0x7f9b219bbc8f]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f9b219c3fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f9b21adbaf1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f9b21adbbde]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f9b21adbc0b]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_FileExFlags+0xaa)[0x7f9b21b10f3a]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_SimpleFileExFlags+0xfd)[0x7f9b21b110ad]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x1e25e0)[0x7f9b21b355e0]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_Py_UnixMain+0x49)[0x7f9b21b35859]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f9b21583b97]
/home/noa/workspace/padic_project/sage/local/bin/python3(_start+0x2a)[0x55f2e13c378a]
------------------------------------------------------------------------
```


The bug causes the following code to crash too (but only after fixing bug #29925):

```
sage: T.<a> = Qp(5).extension(x^2-5)
sage: W.<w> = Qp(5).extension(x^2-5)
sage: W(T(1/5))
```

On the current version of sage, however (in which #29925 is yet unfixed), the above code does not crash, but returns a wrong result.

The bug is fixed by changing direction of shifting at some point in the function: substituting << by >>.

Note: The bug repeated itself twice in this function. I did not add a doctest for the second case (where min_val > 0), because I think that under this condition, the fixed line is perhaps not reachabale at all: In case min_val > 0, the list does not contain any finite-precision elements (such elements are considered in the context of this function to have non-positive valuation). Therefore any padic element of such a list, is necessarily rational (or integer). So our line of code, which only applies to non-rational/integer padics, is allegedly not reachabale in this case.

Issue created by migration from https://trac.sagemath.org/ticket/29926





---

archive/issue_comments_421544.json:
```json
{
    "body": "Attachment [preprocess_list_crash_log](tarball://root/attachments/some-uuid/ticket29926/preprocess_list_crash_log) by @n-vi created at 2020-06-21 14:42:38",
    "created_at": "2020-06-21T14:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421544",
    "user": "@n-vi"
}
```

Attachment [preprocess_list_crash_log](tarball://root/attachments/some-uuid/ticket29926/preprocess_list_crash_log) by @n-vi created at 2020-06-21 14:42:38



---

archive/issue_comments_421545.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-21T16:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421545",
    "user": "@n-vi"
}
```

New commits:



---

archive/issue_comments_421546.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-21T16:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421546",
    "user": "@n-vi"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421547.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-22T00:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421547",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421548.json:
```json
{
    "body": "LGTM.",
    "created_at": "2020-06-22T00:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421548",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_421549.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n> LGTM.\n\nThanks!",
    "created_at": "2020-06-22T01:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421549",
    "user": "@n-vi"
}
```

Replying to [comment:4 tscrim]:
> LGTM.

Thanks!



---

archive/issue_comments_421550.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-08T19:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29689#issuecomment-421550",
    "user": "vbraun"
}
```

Resolution: fixed
