# Issue 10285: sage-native-execute does not unset path etc.

archive/issues_010285.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @mwhansen @nbruin tbd\n\nKeywords: sage-native-execute, jmol\n\nThe script unsets the LD_LIBRARY_PATH but not the PATH, and then \nexecutes the argument. So it essentially breaks execution of all \nprograms that are shipped with sage since they can't find their \nlibraries any more, unless you are lucky and the system libraries have the same version. \n\n3d plots on the Sage command line call \"sage-native-execute jmol\", \nwhich is why 3d plotting in Fedora is broken since forever, see #9232.\n\nThe goal of this ticket is to\n1. fix `sage-native-execute` to revert more of the pre-Sage environment, in particular the PATH.\n2. fix the sage library to not call `sage-native-execute` for Sage components like jmol.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10286\n\n",
    "created_at": "2010-11-17T22:00:41Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage-native-execute does not unset path etc.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10285",
    "user": "@vbraun"
}
```
Assignee: @jasongrout

CC:  @mwhansen @nbruin tbd

Keywords: sage-native-execute, jmol

The script unsets the LD_LIBRARY_PATH but not the PATH, and then 
executes the argument. So it essentially breaks execution of all 
programs that are shipped with sage since they can't find their 
libraries any more, unless you are lucky and the system libraries have the same version. 

3d plots on the Sage command line call "sage-native-execute jmol", 
which is why 3d plotting in Fedora is broken since forever, see #9232.

The goal of this ticket is to
1. fix `sage-native-execute` to revert more of the pre-Sage environment, in particular the PATH.
2. fix the sage library to not call `sage-native-execute` for Sage components like jmol.

Issue created by migration from https://trac.sagemath.org/ticket/10286





---

archive/issue_comments_105038.json:
```json
{
    "body": "apply to SAGE_LOCAL/bin",
    "created_at": "2010-11-17T22:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105038",
    "user": "@vbraun"
}
```

apply to SAGE_LOCAL/bin



---

archive/issue_comments_105039.json:
```json
{
    "body": "Attachment [trac_10286_call_jmol_correctly.patch](tarball://root/attachments/some-uuid/ticket10286/trac_10286_call_jmol_correctly.patch) by @vbraun created at 2010-11-17 22:15:11\n\nApply to sage library",
    "created_at": "2010-11-17T22:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105039",
    "user": "@vbraun"
}
```

Attachment [trac_10286_call_jmol_correctly.patch](tarball://root/attachments/some-uuid/ticket10286/trac_10286_call_jmol_correctly.patch) by @vbraun created at 2010-11-17 22:15:11

Apply to sage library



---

archive/issue_comments_105040.json:
```json
{
    "body": "The two patches fix #9232 for me.",
    "created_at": "2010-11-17T22:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105040",
    "user": "@vbraun"
}
```

The two patches fix #9232 for me.



---

archive/issue_comments_105041.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-13T11:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105041",
    "user": "@nexttime"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105042.json:
```json
{
    "body": "The patch to the Sage library looks ok, the patches to the scripts less optimal.\n\nBesides that I get eye cancer from `[ \"x$VAR\" = \"xVALUE\" ]`, a few comments:\n\nThe usage of curly braces around environment variables is inconsistent; I would simply drop them here.\n\nIf we really use additional variables just to record if others were already set (which is mostly superfluous), I would either use `true` or, analogously to others, `\"yes\"`.\n\nI would also move the definition of `UNAME` up in `sage-env`, such that we call `uname` only once (i.e., use `\"$UNAME\"` in the tests).\n\nThere are lots of useless `export` statements:\n* It's weird to export variables that have been `unset`.\n* We don't have to re-export `PATH` etc. since they never get unset.\n* Setting variables to other, probably empty or undefined variables  (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`) is pretty ok, so the tests in `sage-native-execute` are all superfluous (see above).\n\nPerhaps we should also \"save\" Sage's modified paths to be able to revert the settings in scripts / programs called with the original settings, e.g. by `sage-native-execute`. ;-)\n\n\n`sage-native-execute` should do `exec \"$`@`\"`.\n\ns/can not/cannot/.\n\nI don't know where `sage-native-execute` gets used, but from Python etc. I would use a Python function that sets up the desired environment for the command to be executed, not call yet another script which in turn runs the program we want to execute. (The C library e.g. contains a family of POSIX functions that wrap the system call `execve()` to do such.) \n\nWith the above changes, `sage-native-execute` reduces to:\n\n```sh\n#!/bin/sh\n\nunset PYTHONHOME PYTHONPATH\nPATH=$SAGE_ORIG_PATH\nLD_LIBRARY_PATH=$SAGE_ORIG_LD_LIBRARY_PATH\nDYLD_LIBRARY_PATH=$SAGE_ORIG_DYLD_LIBRARY_PATH # doesn't pollute environment on non-Darwin systems\n\nexec \"$@\"\n```\n\nor maybe (if we don't want to rely on `sage-env` having been sourced)\n\n```sh\n...\ntest -n \"$SAGE_ORIG_PATH\" && PATH=$SAGE_ORIG_PATH\n# etc., which is equivalent to\nPATH=${SAGE_ORIG_PATH:-$PATH}\n...\n```\n\n(Or, if desired, we could instead just add the usual \"sanity check\" `if [ -z \"$SAGE_LOCAL\" ]; then ... exit 1; fi`, which also ensures that the original paths had been saved.)\n\nIn `sage-env`, we could also use\n\n```sh\n: ${SAGE_ORIG_PATH:=$PATH}  # assign if not already set\n# etc., and drop the *_SET variables\n```\n\n(which may set `SAGE_ORIG_LD_LIBRARY_PATH` to Sage's modified, not the original one in case it was empty and `sage-env` got sourced more than once. But we should IMHO prevent the latter at the top of `sage-env` by simply returning zero if e.g. `SAGE_ENV_SOURCED` is non-empty, otherwise defining it to e.g. `\"yes\"`. This prevents other odd behavior as well.)\n\nI wonder if we shouldn't also save `PYTHONPATH` and `PYTHONHOME` in `sage-env` (and restore them in `sage-native-execute` as well).\n\n\nThe lines of the commit messages shouldn't exceed 80 columns.\n\n\nJust my 2 cents.",
    "created_at": "2010-12-13T14:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105042",
    "user": "@nexttime"
}
```

The patch to the Sage library looks ok, the patches to the scripts less optimal.

Besides that I get eye cancer from `[ "x$VAR" = "xVALUE" ]`, a few comments:

The usage of curly braces around environment variables is inconsistent; I would simply drop them here.

If we really use additional variables just to record if others were already set (which is mostly superfluous), I would either use `true` or, analogously to others, `"yes"`.

I would also move the definition of `UNAME` up in `sage-env`, such that we call `uname` only once (i.e., use `"$UNAME"` in the tests).

There are lots of useless `export` statements:
* It's weird to export variables that have been `unset`.
* We don't have to re-export `PATH` etc. since they never get unset.
* Setting variables to other, probably empty or undefined variables  (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`) is pretty ok, so the tests in `sage-native-execute` are all superfluous (see above).

Perhaps we should also "save" Sage's modified paths to be able to revert the settings in scripts / programs called with the original settings, e.g. by `sage-native-execute`. ;-)


`sage-native-execute` should do `exec "$`@`"`.

s/can not/cannot/.

I don't know where `sage-native-execute` gets used, but from Python etc. I would use a Python function that sets up the desired environment for the command to be executed, not call yet another script which in turn runs the program we want to execute. (The C library e.g. contains a family of POSIX functions that wrap the system call `execve()` to do such.) 

With the above changes, `sage-native-execute` reduces to:

```sh
#!/bin/sh

unset PYTHONHOME PYTHONPATH
PATH=$SAGE_ORIG_PATH
LD_LIBRARY_PATH=$SAGE_ORIG_LD_LIBRARY_PATH
DYLD_LIBRARY_PATH=$SAGE_ORIG_DYLD_LIBRARY_PATH # doesn't pollute environment on non-Darwin systems

exec "$@"
```

or maybe (if we don't want to rely on `sage-env` having been sourced)

```sh
...
test -n "$SAGE_ORIG_PATH" && PATH=$SAGE_ORIG_PATH
# etc., which is equivalent to
PATH=${SAGE_ORIG_PATH:-$PATH}
...
```

(Or, if desired, we could instead just add the usual "sanity check" `if [ -z "$SAGE_LOCAL" ]; then ... exit 1; fi`, which also ensures that the original paths had been saved.)

In `sage-env`, we could also use

```sh
: ${SAGE_ORIG_PATH:=$PATH}  # assign if not already set
# etc., and drop the *_SET variables
```

(which may set `SAGE_ORIG_LD_LIBRARY_PATH` to Sage's modified, not the original one in case it was empty and `sage-env` got sourced more than once. But we should IMHO prevent the latter at the top of `sage-env` by simply returning zero if e.g. `SAGE_ENV_SOURCED` is non-empty, otherwise defining it to e.g. `"yes"`. This prevents other odd behavior as well.)

I wonder if we shouldn't also save `PYTHONPATH` and `PYTHONHOME` in `sage-env` (and restore them in `sage-native-execute` as well).


The lines of the commit messages shouldn't exceed 80 columns.


Just my 2 cents.



---

archive/issue_comments_105043.json:
```json
{
    "body": "Changing keywords from \"sage-native-execute, jmol\" to \"sage-native-execute jmol LD_LIBRARY_PATH original save restore sage-env\".",
    "created_at": "2010-12-13T14:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105043",
    "user": "@nexttime"
}
```

Changing keywords from "sage-native-execute, jmol" to "sage-native-execute jmol LD_LIBRARY_PATH original save restore sage-env".



---

archive/issue_comments_105044.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> [...]\n> If we really use additional variables just to record if others were already set (which is mostly superfluous), I would either use `true` or, analogously to others, `\"yes\"`.\n> [...] \n\n> In `sage-env`, we could also use\n\n```sh\n: ${SAGE_ORIG_PATH:=$PATH}  # assign if not already set\n# etc., and drop the *_SET variables\n```\n\n> (which may set `SAGE_ORIG_LD_LIBRARY_PATH` to Sage's modified, not the original one in case it was empty and `sage-env` got sourced more than once. But we should IMHO prevent the latter at the top of `sage-env` by simply returning zero if e.g. `SAGE_ENV_SOURCED` is non-empty, otherwise defining it to e.g. `\"yes\"`. This prevents other odd behavior as well.)\n\nI've opened #10469 to address that (sourcing `sage-env` / saving the original paths only once).",
    "created_at": "2010-12-13T18:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105044",
    "user": "@nexttime"
}
```

Replying to [comment:3 leif]:
> [...]
> If we really use additional variables just to record if others were already set (which is mostly superfluous), I would either use `true` or, analogously to others, `"yes"`.
> [...] 

> In `sage-env`, we could also use

```sh
: ${SAGE_ORIG_PATH:=$PATH}  # assign if not already set
# etc., and drop the *_SET variables
```

> (which may set `SAGE_ORIG_LD_LIBRARY_PATH` to Sage's modified, not the original one in case it was empty and `sage-env` got sourced more than once. But we should IMHO prevent the latter at the top of `sage-env` by simply returning zero if e.g. `SAGE_ENV_SOURCED` is non-empty, otherwise defining it to e.g. `"yes"`. This prevents other odd behavior as well.)

I've opened #10469 to address that (sourcing `sage-env` / saving the original paths only once).



---

archive/issue_comments_105045.json:
```json
{
    "body": "The patch [attachment:trac_10286_call_jmol_correctly.patch] will be used on #9232 instead.",
    "created_at": "2011-03-25T18:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105045",
    "user": "@kcrisman"
}
```

The patch [attachment:trac_10286_call_jmol_correctly.patch] will be used on #9232 instead.



---

archive/issue_comments_105046.json:
```json
{
    "body": "Is this still relevant?  Why is `sage-native-execute` needed anyway?",
    "created_at": "2012-08-29T18:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105046",
    "user": "@jdemeyer"
}
```

Is this still relevant?  Why is `sage-native-execute` needed anyway?



---

archive/issue_comments_105047.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Is this still relevant?  Why is `sage-native-execute` needed anyway?\nI think it still is. For instance if you start up magma (in the notebook for instance), it's run via `sage-native-execute`. If you do anything in the magma startup script that depends on having paths/environment properly set, it won't work. For a while, it meant I couldn't use magma through the notebook (see #9386). I worked around it by restoring the environment in the magma startup script itself.",
    "created_at": "2012-08-29T18:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105047",
    "user": "@nbruin"
}
```

Replying to [comment:6 jdemeyer]:
> Is this still relevant?  Why is `sage-native-execute` needed anyway?
I think it still is. For instance if you start up magma (in the notebook for instance), it's run via `sage-native-execute`. If you do anything in the magma startup script that depends on having paths/environment properly set, it won't work. For a while, it meant I couldn't use magma through the notebook (see #9386). I worked around it by restoring the environment in the magma startup script itself.



---

archive/issue_comments_105048.json:
```json
{
    "body": "See for instance #8560, before which Nils' comment wasn't true, I think.",
    "created_at": "2012-08-29T18:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105048",
    "user": "@kcrisman"
}
```

See for instance #8560, before which Nils' comment wasn't true, I think.



---

archive/issue_comments_105049.json:
```json
{
    "body": "Fine, so it seems that `sage-native-execute` does serve a purpose, good to know.\n\nOn my system, I just replaced `sage-native-execute` with a no-op and all doctests passed.",
    "created_at": "2012-08-29T18:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105049",
    "user": "@jdemeyer"
}
```

Fine, so it seems that `sage-native-execute` does serve a purpose, good to know.

On my system, I just replaced `sage-native-execute` with a no-op and all doctests passed.



---

archive/issue_comments_105050.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-09-21T14:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105050",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105051.json:
```json
{
    "body": "In any case, this needs to be rebased.",
    "created_at": "2012-09-21T14:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105051",
    "user": "@jdemeyer"
}
```

In any case, this needs to be rebased.



---

archive/issue_comments_105052.json:
```json
{
    "body": "Since the jmol issue was solved elsewhere, isn't this ticket a duplicate of #9386 ?",
    "created_at": "2015-02-08T17:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105052",
    "user": "tmonteil"
}
```

Since the jmol issue was solved elsewhere, isn't this ticket a duplicate of #9386 ?



---

archive/issue_comments_105053.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-05-07T17:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105053",
    "user": "@nbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_105054.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2015-05-19T06:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10285#issuecomment-105054",
    "user": "@vbraun"
}
```

Resolution: duplicate
