# Issue 27211: compute normal vectors of surface faces of polyhedron

Issue created by migration from https://trac.sagemath.org/ticket/27448

Original creator: dkrenn

Original creation time: 2019-03-09 10:40:47

CC:  jipilab @laisrast @kliem




---

Comment by dkrenn created at 2019-03-10 18:22:34

Changing status from new to needs_review.


---

Comment by dkrenn created at 2019-03-10 18:22:34

New commits:


---

Comment by git created at 2019-03-12 11:21:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-03-12 12:41:26


```
    Invalid Python 3 syntax found:
    invalid syntax (face.py, line 587)
```



---

Comment by git created at 2019-03-12 12:48:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2019-03-12 12:49:38

Replying to [comment:4 chapoton]:
> {{{
>     Invalid Python 3 syntax found:
>     invalid syntax (face.py, line 587)
> }}}

Indeed, missed this one. Thanks, is now corrected.


---

Comment by chapoton created at 2019-03-12 18:53:23

please add one example with vertices in AA


---

Comment by vdelecroix created at 2019-03-15 19:49:36

Why is it cached!?


---

Comment by vdelecroix created at 2019-03-15 19:51:16

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2019-03-15 19:51:16

What is that intended for?

```
        if T.base_ring() in (AA, QQbar):
            def exactify(c):
                c.exactify()
                try:
                    return QQ(c)
                except (ValueError, TypeError):
                    return c
            T = T.apply_map(lambda c: exactify(c))
```

If it is of any use, it should be carefully explained in the code.


---

Comment by vdelecroix created at 2019-03-15 19:53:09

Isn't it a big waste to compute the matrix `T` each time you ask for a normal vector. Wouldn't it make more sense to compute it once and for all?


---

Comment by vdelecroix created at 2019-03-15 19:55:01

Documentation must include examples with unbounded faces. Especially the degenerate case where the polyhedron is a vector space.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-03-27 18:48:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2019-03-27 18:50:24

Replying to [comment:7 chapoton]:
> please add one example with vertices in AA

Done in ||[8f23aa9](https://git.sagemath.org/sage.git/commit/?id=8f23aa949086e9cb358a2d50b67ad85f2efb7fdd)||`Trac #27448: doctest for polyhedron with vertices in AA`||


---

Comment by dkrenn created at 2019-03-27 18:51:27

Replying to [comment:8 vdelecroix]:
> Why is it cached!?

Because for my computation (related to #27447) it reduced the computation time by a factor 7 or 8.


---

Comment by dkrenn created at 2019-03-27 18:51:58

Replying to [comment:9 vdelecroix]:
> What is that intended for?
> {{{
>         if T.base_ring() in (AA, QQbar):
>             def exactify(c):
>                 c.exactify()
>                 try:
>                     return QQ(c)
>                 except (ValueError, TypeError):
>                     return c
>             T = T.apply_map(lambda c: exactify(c))
> }}}
> If it is of any use, it should be carefully explained in the code.

Code commented in ||[919bebf](https://git.sagemath.org/sage.git/commit/?id=919bebf3299bf40081f23f72b5fb6a59752f8fee)||`Trac #27448: explain purpose of exactify-code`||


---

Comment by dkrenn created at 2019-03-27 18:52:56

Replying to [comment:10 vdelecroix]:
> Isn't it a big waste to compute the matrix `T` each time you ask for a normal vector. Wouldn't it make more sense to compute it once and for all?

Indeed. Done in ||[4b7a774](https://git.sagemath.org/sage.git/commit/?id=4b7a774740cae38749940b8c1d862d7fd52bca9d)||`Trac #27448: cache matrix`||
but also see the other commits (some more changes were done).


---

Comment by dkrenn created at 2019-03-27 18:53:36

Replying to [comment:11 vdelecroix]:
> Documentation must include examples with unbounded faces. Especially the degenerate case where the polyhedron is a vector space.

Done in ||[769ba63](https://git.sagemath.org/sage.git/commit/?id=769ba63169b8b618910f68fe3257ba12ad22773d)||`Trac #27448 doctest for unbounded polyhedron`||


---

Comment by dkrenn created at 2019-03-27 18:53:49

Changing status from needs_info to needs_review.


---

Comment by dkrenn created at 2019-03-27 18:54:12

All comments are incorporated, so please review again.


---

Comment by vdelecroix created at 2019-04-14 17:03:53

I don't understand something. According to the comment `When the polyhedron is rational, ... We correct this below.` the following should not fail

```
c.exactify()
try:
    return QQ(c)
```



---

Comment by vdelecroix created at 2019-04-14 17:05:54

There is no example of polyhedra defined over a number field such as `QuadraticField(2)` or `NumberField(x^3 - 2, 'a', embedding=AA(2)^(1/3))`.


---

Comment by vdelecroix created at 2019-04-14 17:07:28

If the matrix `T` is supposed to belong to the ground field, isn't there a more direct way to compute it wihtout going through `A` that might involve a lot of different square roots?


---

Comment by vdelecroix created at 2019-04-18 20:31:32

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by jipilab created at 2019-10-26 12:03:18

Please have a look at the related #17215.

Also, it seems that in the doctests, the older version of the `repr` for faces is used... This should be updated.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by jipilab created at 2020-02-04 16:45:18

With #17215, one can do:

```
sage: s = polytopes.simplex(2)
sage: for facet in s.facets():
....:     print("{} has normal vector {}".format(facet,facet.normal_cone().rays()[0].vector()))
....:     
A 1-dimensional face of a Polyhedron in ZZ^3 defined as the convex hull of 2 vertices has normal vector (1, 1, 0)
A 1-dimensional face of a Polyhedron in ZZ^3 defined as the convex hull of 2 vertices has normal vector (0, -1, 0)
A 1-dimensional face of a Polyhedron in ZZ^3 defined as the convex hull of 2 vertices has normal vector (-1, 0, 0)
```



```
sage: P = Polyhedron(vertices=[(0,0), (1,0), (sqrt(AA(2)),2), (1,1)],base_ring=AA)
sage: for facet in P.facets():
....:     print("{} has normal vector {}".format(facet,facet.normal_cone().rays()[0].vector()))
....:     
A 1-dimensional face of a Polyhedron in AA^2 defined as the convex hull of 2 vertices has normal vector (0, -1/2)
A 1-dimensional face of a Polyhedron in AA^2 defined as the convex hull of 2 vertices has normal vector (-1, 0.7071067811865475?)
A 1-dimensional face of a Polyhedron in AA^2 defined as the convex hull of 2 vertices has normal vector (1, -0.2071067811865476?)
```



```
sage: P = Polyhedron(ieqs=[(0, 1, 1, 1, 1)])
sage: for facet in P.facets():
....:     print("{} has normal vector {}".format(facet,facet.normal_cone().rays()[0].vector()))
....:     
A 3-dimensional face of a Polyhedron in QQ^4 defined as the convex hull of 1 vertex and 3 lines has normal vector (-1, -1, -1, -1)
sage: for facet in P.facets():
....:     print("{} has normal vector {}".format(facet,facet.normal_cone('inner').rays()[0].vector()))
....:     
A 3-dimensional face of a Polyhedron in QQ^4 defined as the convex hull of 1 vertex and 3 lines has normal vector (1, 1, 1, 1)
```



```
sage: P = Polyhedron(ieqs=[(0, 0, 1), (0, 1, 0), (1, 0, -1)])
sage: for facet in P.facets():
....:     print("{} has normal vector {}".format(facet,facet.normal_cone().rays()[0].vector()))
....:     
A 1-dimensional face of a Polyhedron in QQ^2 defined as the convex hull of 1 vertex and 1 ray has normal vector (0, -1)
A 1-dimensional face of a Polyhedron in QQ^2 defined as the convex hull of 2 vertices has normal vector (-1, 0)
A 1-dimensional face of a Polyhedron in QQ^2 defined as the convex hull of 1 vertex and 1 ray has normal vector (0, 1)
```


I don't know if this fulfills what is intended in this ticket? Does it? If it does, I believe that it would be appropriate to minimize the duplication of code. In particular, it seems that the present function is intended for facets only (smaller dimensional faces also have normal vectors, but not anymore just in 1 direction...) so the name `normal_vector` is a choice which may be nasty for the user.

As for speed, well, it is true that we create a polyhedron in `normal_cone`, though, the code in #17215 is essentially all obtained through already computed data. I guess this should be benchmarked.


---

Comment by dkrenn created at 2020-02-10 08:36:26

Replying to [comment:28 jipilab]:
> With #17215, one can do: [...]> I don't know if this fulfills what is intended in this ticket? Does it? If it does, I believe that it would be appropriate to minimize the duplication of code.

This might be the case. Can we make the doctests here on this ticket work with the code of #17215 (or giving at least somehow a similar output)?

> In particular, it seems that the present function is intended for facets only

Yes, true.

> (smaller dimensional faces also have normal vectors, but not anymore just in 1 direction...) so the name `normal_vector` is a choice which may be nasty for the user.

It seems that the new code is more general indeed.


---

Comment by jipilab created at 2020-02-10 11:06:29

Replying to [comment:30 dkrenn]:
> Replying to [comment:28 jipilab]:
> > With #17215, one can do: [...]> I don't know if this fulfills what is intended in this ticket? Does it? If it does, I believe that it would be appropriate to minimize the duplication of code.
> 
> This might be the case. Can we make the doctests here on this ticket work with the code of #17215 (or giving at least somehow a similar output)?

Yes, that's definitely possible I would say.

> 
> > In particular, it seems that the present function is intended for facets only
> 
> Yes, true.
> 
> > (smaller dimensional faces also have normal vectors, but not anymore just in 1 direction...) so the name `normal_vector` is a choice which may be nasty for the user.
> 
> It seems that the new code is more general indeed.

Then, I believe it make sense to have a method for facets that return the appropriate normal vector.


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-08-27 04:59:42

Has this been implemented in #17215?


---

Comment by jipilab created at 2021-01-22 12:40:58

Replying to [comment:33 mkoeppe]:
> Has this been implemented in #17215?

I think that the resolution was that it might be nice to have a direct function giving the vector and not a "cone" object...


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
