# Issue 17055: Make transparency work in jmol

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2014-11-05 13:02:46

CC:  novoselt gutow vbraun strogdon ppurka

See [comment:150:ticket:16004 here], where it is pointed out that we need to upgrade the `platformspeed` variable in the js in order for things to work properly for transparency in jsmol.


---

Comment by kcrisman created at 2014-11-05 13:46:08

[The Jmol wiki](http://wiki.jmol.org/index.php/JSmol_pros_and_cons) says
> HTML5 is significantly slower than Java. For large systems it is strongly advised to use the set platformSpeed setting (or allow the user to set that). Smaller molecules (<10,000 atoms) are handled quite well. Large molecules (>20,000 atoms; see table at right) may be slow to load and process.
Also note it says IE is "unworkably slow" with the jsmol option, though I don't know how authoritative this is.

At the very least, maybe we need a little documentation for this somewhere, in addition to setting this.  I don't think we want to get in the business of checking whether a plot has transparency and then sending a message to Jmol...


---

Comment by kcrisman created at 2014-11-05 13:49:05

See https://github.com/sagemath/sagenb/issues/254 for upstream.


---

Comment by kcrisman created at 2014-11-05 16:34:58

Hold up, is it only while _spinning_/moving that this is not supported?  I can confirm this.  Maybe in that case this could be downgraded.  What do you guys think?

Update: In fact, this also happens whenever right-clicking on the menu.  In addition, the "animation" menu is whited-out.  Finally, it even seems to happen with the java, not just jsmol version.  Is that possible?


---

Comment by kcrisman created at 2014-11-05 16:43:29

And we couldn't do it dynamically easily in any case because there is some horrendous minification that goes on with notebook_dynamic.js which is where the relevant file is included.


---

Comment by kcrisman created at 2014-11-05 17:52:08

The animation menu still is whited-out with speed 7, though now the transparency indeed works.  Plots with many points are indeed perhaps _even_ slower, and are truly much faster with the java.  That said, I don't know that they are enough slower for me to notice that much, because they are just very slow without java.  (This only applies to the really big plot points, of course, not defaults.)

Maybe this needs some really obvious documentation to "use java for big plots" in the plot3d documentation, maybe even in the "Help" link that one clicks for the notebook.  I don't want to go back to Sage 3d graphics being unusable on many browsers.  And this was truly a one-character change.


---

Comment by novoselt created at 2014-11-05 19:48:12

Personally I find it extremely annoying that transparency changes when I click on a plot, since it is not just hiding some parts, it is greatly changing/flashing the whole thing.

On a more objective note - the point of transparency is to be able to see things which are hidden otherwise to get a better sense of the plot. And the point of spinning the plot around is the same. With this new setting you can only benefit from one or the other but not both.

Regarding speed issues - can we get some examples of Sage plots which we should "test"? Just getting things slow with many points is a bit pointless - for what plots it is really necessary to increase the number of points?


---

Comment by kcrisman created at 2014-11-05 20:26:16

> On a more objective note - the point of transparency is to be able to see things which are hidden otherwise to get a better sense of the plot. And the point of spinning the plot around is the same. With this new setting you can only benefit from one or the other but not both.
Yes.  Well, changing the platform speed will be the way to go, then.  Can you take care of the sagenb package for this iteration?
> Regarding speed issues - can we get some examples of Sage plots which we should "test"? Just getting things slow with many points is a bit pointless - for what plots it is really necessary to increase the number of points?
No no, I always use something like

```
var('y')
plot3d(sin(x^2+y^2),(x,0,10),(y,0,10))
```

where an increased number of points makes a _very_ noticeable difference.


---

Comment by novoselt created at 2014-11-05 20:55:13

Playing some more, platformspeed 6 is the first one which shows the plot at all during rotation, 7 includes transparency, and 8 includes antialiasing as well. Which is greatly affecting shape and size of "thick curves" and "fat points". In fact, with 8 I can see no differences while rotating and while not rotating and I think this should be the default (it certainly was the default before). I don't know what is changing between 8 and 10.

With 200 points your sin plot works OK for me and while on 6 it may be faster, it is not at all the difference between OK and unusable. This is on a fast desktop (4GHz cores) and I'll try to test on a slower machine as well, however I am for default of 8 regardless of outcomes.

As for packaging the next version - I am hesitant to commit since I tend to lag behind...


---

Comment by strogdon created at 2014-11-06 00:32:52

Just noticed this. Should the individuals listed opposite Authors: really be opposite Cc:


---

Comment by kcrisman created at 2014-11-06 01:11:41

> Just noticed this. Should the individuals listed opposite Authors: really be opposite Cc:
Wow, I _really_ must have been in a hurry when I opened this one!  Sorry.


---

Comment by kcrisman created at 2014-11-06 01:46:54

> Playing some more, platformspeed 6 is the first one which shows the plot at all during rotation, 7 includes transparency, and 8 includes antialiasing as well. Which is greatly affecting shape and size of "thick curves" and "fat points". In fact, with 8 I can see no differences while rotating and while not rotating and I think this should be the default (it certainly was the default before). I don't know what is changing between 8 and 10.
I'm not sure it's changing anything.
> With 200 points your sin plot works OK for me and while on 6 it may be faster, it is not at all the difference between OK and unusable. This is on a fast desktop (4GHz cores) and I'll try to test on a slower machine as well, however I am for default of 8 regardless of outcomes.

It's definitely very, very slow for me on my 2.3 GHz i7.  Probably also depends on the browser.  (By the way, for some reason I can use Java in Chrome; maybe it's just Chromium where it doesn't work.)  I really wouldn't go above the 7 in case it really does do something.   Among other reasons, because the doc for this at http://chemapps.stolaf.edu/jmol/jsmol/test2.htm suggests that for tablets or other mobile devices one will have problems with higher values.


---

Comment by gutow created at 2014-11-06 02:28:09

I'm pretty sure I picked 6 because that was the only thing that worked OK on tablets.  Unfortunately, I do not have a test server set up with 6.4.rc1 on which to retest this.  Here's a way we can all do device checking and report back.  I have some web pages set up that have complex enough things that we should be able to tell.
1. go to [hybrid orbitals](http://www.uwosh.edu/faculty_staff/gutow/Orbitals/N/sp3%20hybrid.shtml)
1. select a different orbital in each popup
1. set two of them to transparent
1. set another to mesh
1. use the right-click menu to bring up the console
1. test "set platformspeed = X", where X = 6  through 8.
1. report back with device details.

(may not work on all touch devices as I have had trouble getting the equivalent of a right-click)

My first report:
i3 portable that tops out at 1.8 GHZ (usually runs at 800 MHz) 8 or higher is fine on. Tested in Firefox and Chromium on Ubuntu 14.04.


---

Comment by gutow created at 2014-11-06 02:41:00

Better test page [Standard JSmol test page](http://chemapps.stolaf.edu/jmol/jsmol/test2.htm)

1. select pmesh `"data/sage.pmesh"` from about 2/3 of the way down the second column of links.
1. try the different platforms speeds by clicking on the numbers below the image


---

Comment by gutow created at 2014-11-06 03:37:48

Original Ipad: 7 is acceptable, 8 is not.


---

Comment by novoselt created at 2014-11-06 04:41:27

Thanks for the test, Jonathan!

On my over **TEN YEARS OLD** laptop with Athlon 64 1.8GHz (and GeForce MX440 Go videocard) it works just fine with 8. On the other hand, three.js on this machine is completely unusable since WebGL is not supported and canvas is incredibly slow (many seconds to render a frame).

While supporting old mobile devices is noble, I think that complicated 3D plots with a lot of points are more likely to be viewed on computers with adequate resources.

Note also that the current situation (for a year) is that rotatable 3D plots are not working at all on all devices. With 8 we will get a great renderer for desktops/laptops and perhaps more recent tablets as well. And while with 7 situation is satisfactory as well, I still would prefer not to compromise - spinning manually or automatically is the most natural way to look at 3D plots and the higher quality we can achieve the better.


---

Comment by gutow created at 2014-11-06 05:58:21

What about handheld devices like phones, many are less capable then my original Ipad? Anybody got an iphone 4, droid mini, of galaxy III?


---

Comment by vbraun created at 2014-11-06 11:29:10

Let's make plots work first on real computers, please. Some of use use Sage for their work. I doubt that anybody is writing a paper or teaching classes on their iPhone 4. 

It would be easy enough to add a javascript to pick out mobile devices depending on media query and degrade display, e.g. 

```
var fast = window.matchMedia( "(min-width: 500px)" );
```

with a suitable try/catch for browser that don't support it.


---

Comment by vbraun created at 2014-11-06 11:39:42

Also, jsmol knows how long it takes to render each frame, right? It should just dynamically adjust the rendering quality to achieve >=30fps


---

Comment by vbraun created at 2014-11-06 11:40:37

IMHO this is not a blocker, more of an annoyance.


---

Comment by kcrisman created at 2014-11-06 13:30:53

> IMHO this is not a blocker, more of an annoyance.

Once I realized that it was only for rotation, I was thinking of downgrading to critical, but Andrey's point was actually fairly compelling.

Andrey and Jonathan, we can either fix this _fast_ or dither about choices and not get it in.  I think 7 is a good compromise but I don't think we are going to have the energy to put in some extra javascript, or at least I won't.

----

> I doubt that anybody is writing a paper or teaching classes on their iPhone 4. 
Volker, you wrote the Android app - how does it deal with 3d images?  (I don't have iOS or Android so I can't test this, and the current Google Play page doesn't have an example pictured.)  If the apps using cell server aren't doing 3d graphics anyway, then I wouldn't worry about it, it's relatively less frequent that people are doing intense graphics on such platforms, I imagine, since sagenb isn't optimized for mobile devices (at all).

Incidentally, the recent reviews at [the Android app site](https://play.google.com/store/apps/details?id=org.sagemath.droid&hl=en) are fairly negative - that's sad, because from everything I heard it was actually pretty awesome.  I don't think sagecell has been having problems - or has it?

> Also, jsmol knows how long it takes to render each frame, right? It should just dynamically adjust the rendering quality to achieve >=30fps

Jonathan can report that upstream...


---

Comment by vbraun created at 2014-11-06 13:42:25

Java applets are not supported on Android.


---

Comment by kcrisman created at 2014-11-06 13:55:13

> Java applets are not supported on Android.
Thanks, I didn't think about it that way.  And on iOS I guess you need various workarounds.  

So in other words, before the only option for 3d plotting in Sage on most tablets was canvas3d or Tachyon, neither of which are particularly good for that type of thing (spinning etc.).  Now, presumably we _will_ be able to support them, even if pretty darn slow.

So come to consensus on 7 or 8, given those constraints, and then we can always try to add something later to detect browsers - if really necessary.


---

Comment by gutow created at 2014-11-06 14:17:49

Changing status from new to needs_review.


---

Comment by gutow created at 2014-11-06 14:17:49

The commit I just pushed sets the default speed to 8.  Test please.
----
Last 10 new commits:


---

Comment by gutow created at 2014-11-06 14:20:13

Failed automerge suggests I missed some more recent commits (not sure how).  The last one is the one-liner we need.  It cannot conflict with anything else.


---

Comment by kcrisman created at 2014-11-06 14:24:36

You can't do it from here anyway, it has to be upstream, and then you can link to https://github.com/sagemath/sagenb/issues/254 from there.  I'm sorry, it continues to be very annoying that the sagenb is "upstream", I know...

Anyway, I can just make the commit myself there as well without having to do any pushing, if you like.


---

Comment by kcrisman created at 2014-11-06 14:58:08

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-11-06 14:58:08

Okay, confirmed and done at [this commit](https://github.com/sagemath/sagenb/commit/f5eef910f7791ed80a0538193dc2ba00c84d0c09).

Now we just need a new sagenb release, probably waiting on https://github.com/sagemath/sagenb/issues/256 to be fixed.


---

Comment by novoselt created at 2014-11-06 17:21:25

Regarding Android app: there were issues caused/exposed by my server setup changes that Volker has fixed at https://github.com/sagemath/sagecell/commit/8e5c8722e03bcd0bcd7a9fa67cf9c925ad99f7bf

SageCell uses Java Jmol by default (meaning it is not working almost anywhere) and has some three.js support separate from SMC. Not sure what will happen when I merge all these changes, but probably JS Jmol will not just work magically ;-)


---

Comment by kcrisman created at 2014-11-06 17:23:57

> Regarding Android app: there were issues caused/exposed by my server setup changes that Volker has fixed at https://github.com/sagemath/sagecell/commit/8e5c8722e03bcd0bcd7a9fa67cf9c925ad99f7bf

Nice - probably good to change it soon, given all the angry reviews showing up on the app website.

> SageCell uses Java Jmol by default (meaning it is not working almost anywhere) and has some three.js support separate from SMC. Not sure what will happen when I merge all these changes, but probably JS Jmol will not just work magically ;-)

I think it should, right?  I forgot about the three.js stuff.


---

Comment by novoselt created at 2014-11-06 17:36:06

Change what soon? sagecell.sagemath.org has been running the fixed version shortly after Volker's fix and Android app was updated a couple days after it. My understanding is that it is working now.

And given that !SageNB and SageCell have different resulting HTML and SageCell patches graphics code in Sage, I do not expect new Jmol work there right away. But we'll see!


---

Comment by kcrisman created at 2014-11-06 17:38:11

> Change what soon? sagecell.sagemath.org has been running the fixed version shortly after Volker's fix and Android app was updated a couple days after it. My understanding is that it is working now.

Oh, I didn't realize that - I guess I saw a review from October there, but it looks like you must have fixed it shortly thereafter.

> And given that !SageNB and SageCell have different resulting HTML and SageCell patches graphics code in Sage, I do not expect new Jmol work there right away. But we'll see!

Hmm, that may be.  Let me know (not on this ticket, email) and I can test if you have a demo server at some point).


---

Comment by kcrisman created at 2014-11-07 03:00:35

Changing component from graphics to notebook.


---

Comment by vbraun created at 2014-11-09 12:22:02

Whats the plan for making a new sagenb release?


---

Comment by kcrisman created at 2014-11-10 13:11:30

Plan is to do it today; I was waiting for the review of https://github.com/sagemath/sagenb/pull/259 though ppurka seemed to think there was something else "wrong" (but not badly) with `dist.sh`...


---

Comment by ppurka created at 2014-11-10 13:28:25

I already fixed dist.sh in sagenb master.


---

Comment by kcrisman created at 2014-11-10 13:35:58

> I already fixed dist.sh in sagenb master.
Oh!  I didn't see that, sagenb doesn't give me auto-notifications except on my own stuff - I assume that is configurable, though.


---

Comment by kcrisman created at 2014-11-10 17:19:04

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-11-10 17:19:04

New commits:


---

Comment by novoselt created at 2014-11-10 19:21:24

On the branch of the ticket:

```
$ sage -i http://sage.math.washington.edu/home/kcrisman/sagenb-0.11.1.tar
...
Finished extraction
/home/novoselt/sage/src/bin/sage-spkg: line 598: cd: sagenb-0.11.1.tar: No such file or directory
Error: after extracting, the directory sagenb-0.11.1.tar does not exist
```


Am I doing something wrong?


---

Comment by vbraun created at 2014-11-10 19:23:05

You need to download the file yourself and put it into the upstream/ folder


---

Comment by novoselt created at 2014-11-10 19:50:36

It works! (As expected ;-))


---

Comment by novoselt created at 2014-11-10 19:50:36

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-11-10 21:07:24

> You need to download the file yourself and put it into the upstream/ folder
But I think that syntax used to work, correct?
> It works! (As expected ;-))
Let's hope there are finally no more issues!


---

Comment by vbraun created at 2014-11-11 17:00:05

Resolution: fixed
