# Issue 29050: SPKG type: Make "regular/script/pip" orthogonal to "standard/optional/experimental"

Issue created by migration from https://trac.sagemath.org/ticket/29287

Original creator: mkoeppe

Original creation time: 2020-03-06 16:46:19

CC:  embray dimpase jhpalmieri tmonteil vbraun

This would enable having "optional" "script" packages. (Needed for #27952 - libnauty)

`type` would only be used for "standard/optional/experimental".

- regular packages have a `checksum.ini`
- pip packages have `requirements.txt` instead
- script packages have neither of the two


---

Comment by mkoeppe created at 2020-03-07 00:14:12

New commits:


---

Comment by git created at 2020-03-07 02:57:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-07 03:05:18

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-03-07 05:42:47

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2020-03-07 05:42:47

This needs documentation.


---

Comment by mkoeppe created at 2020-03-08 00:15:37

Indeed, as noted already in #21033.


---

Comment by jhpalmieri created at 2020-03-08 20:27:17

Just putting the list in the description somewhere in the docs would help. What is a "script" package, anyway?


---

Comment by mkoeppe created at 2020-03-08 20:29:10

Yes, I'll work on it


---

Comment by git created at 2020-03-14 21:55:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-14 21:56:10

Rebased on 9.1.beta7, merged #29096 to avoid conflicts in documentation


---

Comment by git created at 2020-03-14 23:01:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-14 23:27:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-15 00:11:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-15 01:33:59

Added documentation describing normal, pip, and script packages.


---

Comment by git created at 2020-03-15 01:47:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-15 01:58:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-15 02:03:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-15 02:19:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-15 03:12:20

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-03-15 22:17:49

Why do you had all these `.in`? Such a change should be agreed on sage-devel.


---

Comment by vdelecroix created at 2020-03-15 22:18:29

Unless I misunderstood something, in the section `Install scripts of script packages`, ```spkg-install``` should be ```spkg-install.in``` (twice).


---

Comment by mkoeppe created at 2020-03-15 22:20:00

Changing to .in happened on #29096.

No, script packages don't to templating.


---

Comment by dimpase created at 2020-03-16 08:35:23

Replying to [comment:22 vdelecroix]:
> Why do you had all these `.in`? Such a change should be agreed on sage-devel.

we had an argument about it, and that change should have been done when the actual conversion of most of sage-install scripts into templates happened, a couple of years back. So this change merely corrects an old fault of the naming scheme.


---

Comment by git created at 2020-03-19 00:09:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-19 00:10:45

Rebased on 9.1.beta8 -- so the diff is easier to read now. Needs review


---

Comment by jhpalmieri created at 2020-03-19 16:30:24

I get a doctest failure:

```
sage -t --long --warn-long 65.3 src/sage/env.py
**********************************************************************
File "src/sage/env.py", line 14, in sage.env
Failed example:
    res = subprocess.call([sys.executable, "-c", cmd], env=env)  # long time
Expected:
    None
Got:
    /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/29090/29287/sage-9.1.beta8
**********************************************************************
1 item had failures:
   1 of   5 in sage.env
    [45 tests, 1 failure, 1.41 s]
----------------------------------------------------------------------
sage -t --long --warn-long 65.3 src/sage/env.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 1.4 seconds
```



---

Comment by jhpalmieri created at 2020-03-19 17:00:16

I don't know m4 syntax. Is the indentation remaining after you delete `if test "$SPKG_NAME" != "$SPKG_VERSION"; then` meaningful?


---

Comment by mkoeppe created at 2020-03-19 17:04:49

No, it is not meaningful, I was just keeping the diff small.


---

Comment by jhpalmieri created at 2020-03-19 17:10:29

What do you think about this proposed change:

```diff
diff --git a/src/doc/en/developer/packaging.rst b/src/doc/en/developer/packaging.rst
index 6934f4ebbf..34f5651bc1 100644
--- a/src/doc/en/developer/packaging.rst
+++ b/src/doc/en/developer/packaging.rst
@@ -87,8 +87,9 @@ the following source types:
    - is obtained directly from https://pypi.org/;
 
    - the version to be installed is determined using the required file
-     ``requirements.txt`` (see
-     https://pip.pypa.io/en/stable/reference/pip_install/#requirements-file-format);
+     ``requirements.txt`` -- in its simplest form, this file just
+     contains the name of the package (more details at
+     https://pip.pypa.io/en/stable/user_guide/#requirements-files);
 
    - Sage installs the package using the ``pip`` package manager;
 
```

Note: different link, in addition to the changed text.


---

Comment by mkoeppe created at 2020-03-19 17:11:31

Excellent, please push it to the ticket


---

Comment by jhpalmieri created at 2020-03-19 17:19:14

Not necessarily for this ticket, but should `pyopenssl` be a pip package?
----
New commits:


---

Comment by mkoeppe created at 2020-03-19 17:25:51

Good idea. I'll make this change.


---

Comment by mkoeppe created at 2020-03-19 17:48:46

Replying to [comment:28 jhpalmieri]:
> I get a doctest failure:
> {{{
> sage -t --long --warn-long 65.3 src/sage/env.py
> **********************************************************************
> File "src/sage/env.py", line 14, in sage.env
> Failed example:
>     res = subprocess.call([sys.executable, "-c", cmd], env=env)  # long time
> Expected:
>     None
> Got:
>     /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/29090/29287/sage-9.1.beta8
> }}}

Ha, this doctest is funny. I'll fix it.
----
New commits:


---

Comment by git created at 2020-03-19 18:28:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-19 20:19:58

Can you explain the doctest failure? For some reason, there was no output before, but now there is output?


---

Comment by mkoeppe created at 2020-03-19 20:25:35

The doctest was actually "broken" by #29038 in the situation when the `sage_conf` package that it added is installed.
See ticket description of #29038 -- in particular, it provides `SAGE_ROOT` in the situation that Python imports `sage.all` outside of a sage-env.
That doctest was testing that `SAGE_ROOT` is not provided in that situation -- when it should simply have tested that the `sage.all` module works.

The present ticket makes sure that `sage_conf` is always installed (fixes #29365, for example), and so you now saw the doctest failure.


---

Comment by jhpalmieri created at 2020-03-19 22:46:10

Why do we need to give a longer path in the `spkg-install` file for `texlive`?


---

Comment by mkoeppe created at 2020-03-19 22:51:22

Replying to [comment:42 jhpalmieri]:
> Why do we need to give a longer path in the `spkg-install` file for `texlive`?
This is an incidental bugfix for something that was broken by some earlier ticket. Seems nobody has tried `sage -i texlive` in a while.


---

Comment by jhpalmieri created at 2020-03-19 22:53:36

A few small changes. If you're happy with these, positive review from me.
----
New commits:


---

Comment by mkoeppe created at 2020-03-19 22:54:55

Great, thanks very much.


---

Comment by mkoeppe created at 2020-03-19 22:54:55

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-21 01:23:05

Changing priority from major to critical.


---

Comment by vbraun created at 2020-03-25 22:48:51

Resolution: fixed
