# Issue 21947: map_reduce failing on IntegerVectorsModPermutationGroup

archive/issues_021947.json:
```json
{
    "body": "CC:  @hivert nborie @seblabbe @slel\n\n`IntegerVectorsModPermutationGroup` elements are generated recursively\nalong a search tree. Alas, the `map_reduce` feature of\n`RecursivelyEnumeratedSets/SearchForest` is broken:\n\n\n```\n    sage: G = CyclicPermutationGroup(5)\n    sage: V = IntegerVectorsModPermutationGroup(G)\n    sage: V.map_reduce(lambda x: 1, operator.add, 0)\n    ...\n    AttributeError: 'IntegerVectorsModPermutationGroup_All_with_category' object has no attribute '_roots'\n```\n\n\nThat seems to be because the SearchForest structure in V is not fully\ninitialized (or alternatively SearchForest and RESetMapReduce don't\nquite agree on the API to recover the roots: f.roots() or f._roots).\n\nLet's fix that for now:\n\n```\n    sage: V._roots = V.roots()\n```\n\n\nStill does not work:\n\n```\n    sage: V.map_reduce(lambda x: 1, operator.add, 0)\n    Process RESetMapReduceWorker-4:\n    Traceback (most recent call last):\n    ...\n    assert max(self) <= self.parent()._max_part, 'Entries of %s must be inferiors to %s'%(self, self.parent()._max_part)\n...\n```\n\n\nPlausibly that's because the postprocessing is not initialized\nproperly; so internal nodes in the trees get converted into end\nresults when the should not.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22184\n\n",
    "created_at": "2017-01-13T10:21:53Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "map_reduce failing on IntegerVectorsModPermutationGroup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21947",
    "user": "https://github.com/nthiery"
}
```
CC:  @hivert nborie @seblabbe @slel

`IntegerVectorsModPermutationGroup` elements are generated recursively
along a search tree. Alas, the `map_reduce` feature of
`RecursivelyEnumeratedSets/SearchForest` is broken:


```
    sage: G = CyclicPermutationGroup(5)
    sage: V = IntegerVectorsModPermutationGroup(G)
    sage: V.map_reduce(lambda x: 1, operator.add, 0)
    ...
    AttributeError: 'IntegerVectorsModPermutationGroup_All_with_category' object has no attribute '_roots'
```


That seems to be because the SearchForest structure in V is not fully
initialized (or alternatively SearchForest and RESetMapReduce don't
quite agree on the API to recover the roots: f.roots() or f._roots).

Let's fix that for now:

```
    sage: V._roots = V.roots()
```


Still does not work:

```
    sage: V.map_reduce(lambda x: 1, operator.add, 0)
    Process RESetMapReduceWorker-4:
    Traceback (most recent call last):
    ...
    assert max(self) <= self.parent()._max_part, 'Entries of %s must be inferiors to %s'%(self, self.parent()._max_part)
...
```


Plausibly that's because the postprocessing is not initialized
properly; so internal nodes in the trees get converted into end
results when the should not.

Issue created by migration from https://trac.sagemath.org/ticket/22184


