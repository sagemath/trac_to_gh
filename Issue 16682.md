# Issue 16682: mistake in sage/src/bin/sage-bdist, OSX app is always built 32-bit

archive/issues_016682.json:
```json
{
    "body": "CC:  @gvol\n\nKeywords: OSX, sage-bdist\n\nThe file sage/src/bin/sage-bdist contains a mistake:\n       'ARCHES' should be 'ARCHS'.\nThe effect of the mistake is that the OS X application is always built as 32-bit ('i386').  This can be seen in the OS X 10.9 app version currently being distributed officially by running the unix command\n    $ file /Applications/Sage-6.3.app/Contents/MacOS/Sage\nwhich returns\n/Applications/sage-6.3.app/Contents/MacOS/Sage: Mach-O executable i386\n\nThis mistake is probably not terribly significant for running sage code, since all the files in sage/local/{bin,lib}/ are 64-bit.\n\n(2) There is a second, more obscure mistake in sage-bdist.  sage-bdist uses `uname -m` to determine the target architecture.  Some older 64-bit Macintoshes can only boot into a 32-bit system.  These machines run 64-bit Sage perfectly well.  \nThey can make and build 64-bit Sage perfectly well.  The problem is that \n`uname -m` returns 'i386' on these machines, so sage-bdist uses 'i386' as the target architecture.\n\nAttached is modified version of sage-bdist which corrects both mistakes.  See below for a description of my modifications.\n\nI am NOT going to submit this via 'git trac'.  As a neophyte, I don't want the responsibility of modifying the build script.\n\nchanges in the attached version of sage-bdist:\n\n(1) 'ARCHES' -> 'ARCHS'\n\n(2) I added an environment variable SAGE_APP_TARGET_ARCH to override `uname -m`.  If one is building Sage on an older 64-bit OSX machine that boots into a 32-bit system, one would do\n    $ export SAGE_APP_TARGET_ARCH=x86_64\n    $ ./sage-bdist\n\n(3) I also added some code to append '-app' to the name \nof the .dmg file produced by sage-bdist.  At present, this has to be done by hand.\n\n(4) I also added an environment variable (SAGE_APP_GZ=no) to prevent \nthe final compression stage, to save time during debugging \nsage-bdist.  One would do\n    $ export SAGE_APP_GZ=no\n    $ export SAGE_APP_DMG=no\n    $ ./sage-bdist\nin order to skip the final compression.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16919\n\n",
    "created_at": "2014-09-02T10:35:10Z",
    "labels": [
        "build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "mistake in sage/src/bin/sage-bdist, OSX app is always built 32-bit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16682",
    "user": "dfriedan"
}
```
CC:  @gvol

Keywords: OSX, sage-bdist

The file sage/src/bin/sage-bdist contains a mistake:
       'ARCHES' should be 'ARCHS'.
The effect of the mistake is that the OS X application is always built as 32-bit ('i386').  This can be seen in the OS X 10.9 app version currently being distributed officially by running the unix command
    $ file /Applications/Sage-6.3.app/Contents/MacOS/Sage
which returns
/Applications/sage-6.3.app/Contents/MacOS/Sage: Mach-O executable i386

This mistake is probably not terribly significant for running sage code, since all the files in sage/local/{bin,lib}/ are 64-bit.

(2) There is a second, more obscure mistake in sage-bdist.  sage-bdist uses `uname -m` to determine the target architecture.  Some older 64-bit Macintoshes can only boot into a 32-bit system.  These machines run 64-bit Sage perfectly well.  
They can make and build 64-bit Sage perfectly well.  The problem is that 
`uname -m` returns 'i386' on these machines, so sage-bdist uses 'i386' as the target architecture.

Attached is modified version of sage-bdist which corrects both mistakes.  See below for a description of my modifications.

I am NOT going to submit this via 'git trac'.  As a neophyte, I don't want the responsibility of modifying the build script.

changes in the attached version of sage-bdist:

(1) 'ARCHES' -> 'ARCHS'

(2) I added an environment variable SAGE_APP_TARGET_ARCH to override `uname -m`.  If one is building Sage on an older 64-bit OSX machine that boots into a 32-bit system, one would do
    $ export SAGE_APP_TARGET_ARCH=x86_64
    $ ./sage-bdist

(3) I also added some code to append '-app' to the name 
of the .dmg file produced by sage-bdist.  At present, this has to be done by hand.

(4) I also added an environment variable (SAGE_APP_GZ=no) to prevent 
the final compression stage, to save time during debugging 
sage-bdist.  One would do
    $ export SAGE_APP_GZ=no
    $ export SAGE_APP_DMG=no
    $ ./sage-bdist
in order to skip the final compression.

Issue created by migration from https://trac.sagemath.org/ticket/16919





---

archive/issue_comments_220256.json:
```json
{
    "body": "Attachment [sage-bdist-TARGET_ARCH-app](tarball://root/attachments/some-uuid/ticket16919/sage-bdist-TARGET_ARCH-app) by dfriedan created at 2014-09-02 10:35:52\n\ncandidate replacement for sage/src/bin/sage-bdist",
    "created_at": "2014-09-02T10:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220256",
    "user": "dfriedan"
}
```

Attachment [sage-bdist-TARGET_ARCH-app](tarball://root/attachments/some-uuid/ticket16919/sage-bdist-TARGET_ARCH-app) by dfriedan created at 2014-09-02 10:35:52

candidate replacement for sage/src/bin/sage-bdist



---

archive/issue_comments_220257.json:
```json
{
    "body": "Well-done! \n\nOne still has to convert your attachment into a git branch and put it on trac. :-) This does not add any responsibility, as it will still be reviewed etc, before making it into Sage proper.",
    "created_at": "2014-09-02T12:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220257",
    "user": "@dimpase"
}
```

Well-done! 

One still has to convert your attachment into a git branch and put it on trac. :-) This does not add any responsibility, as it will still be reviewed etc, before making it into Sage proper.



---

archive/issue_comments_220258.json:
```json
{
    "body": "looks good to me.. somebody wants to try it on their mac?\n----\nNew commits:",
    "created_at": "2014-09-02T13:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220258",
    "user": "@vbraun"
}
```

looks good to me.. somebody wants to try it on their mac?
----
New commits:



---

archive/issue_comments_220259.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-02T13:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220259",
    "user": "@vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_220260.json:
```json
{
    "body": "> looks good to me.. somebody wants to try it on their mac?\n\nSeems likely to me as well, though I'd prefer to have Ivan also check out the part that Xcode will see first.  I definitely won't have time to actually try a bdist with this in the next week.\n\nAlso, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of \n\n```\nelif [ \"$SAGE_APP_GZ\" != \"no\" ]; then\n```\n\nsince the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.",
    "created_at": "2014-09-02T14:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220260",
    "user": "@kcrisman"
}
```

> looks good to me.. somebody wants to try it on their mac?

Seems likely to me as well, though I'd prefer to have Ivan also check out the part that Xcode will see first.  I definitely won't have time to actually try a bdist with this in the next week.

Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 

```
elif [ "$SAGE_APP_GZ" != "no" ]; then
```

since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.



---

archive/issue_comments_220261.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> looks good to me.. somebody wants to try it on their mac?\nI can try this tonight, assuming my laptop still boots in OSX...",
    "created_at": "2014-09-02T15:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220261",
    "user": "@dimpase"
}
```

Replying to [comment:4 vbraun]:
> looks good to me.. somebody wants to try it on their mac?
I can try this tonight, assuming my laptop still boots in OSX...



---

archive/issue_comments_220262.json:
```json
{
    "body": "I tried it OMM (10.9) and everything seems to be in order.",
    "created_at": "2014-09-04T02:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220262",
    "user": "@gvol"
}
```

I tried it OMM (10.9) and everything seems to be in order.



---

archive/issue_comments_220263.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-04T02:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220263",
    "user": "@gvol"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_220264.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-09-04T12:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220264",
    "user": "@kcrisman"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_220265.json:
```json
{
    "body": "> Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of \n> {{{\n> elif [ \"$SAGE_APP_GZ\" != \"no\" ]; then\n> }}}\n> since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.\n\nI haven't heard a response to this, though.",
    "created_at": "2014-09-04T12:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220265",
    "user": "@kcrisman"
}
```

> Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 
> {{{
> elif [ "$SAGE_APP_GZ" != "no" ]; then
> }}}
> since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.

I haven't heard a response to this, though.



---

archive/issue_comments_220266.json:
```json
{
    "body": "Replying to [comment:9 kcrisman]:\n> > Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of \n> > {{{\n> > elif [ \"$SAGE_APP_GZ\" != \"no\" ]; then\n> > }}}\n> > since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.\n> \n> I haven't heard a response to this, though.\nSorry, I didn't see the full description, because I just was thinking about the original discussion.   Both of these now are clear to me but still I think they need to be documented.",
    "created_at": "2014-09-04T12:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220266",
    "user": "@kcrisman"
}
```

Replying to [comment:9 kcrisman]:
> > Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 
> > {{{
> > elif [ "$SAGE_APP_GZ" != "no" ]; then
> > }}}
> > since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.
> 
> I haven't heard a response to this, though.
Sorry, I didn't see the full description, because I just was thinking about the original discussion.   Both of these now are clear to me but still I think they need to be documented.



---

archive/issue_comments_220267.json:
```json
{
    "body": "I can't test whether changing `SAGE_APP_TARGET_ARCH` will change anything but things built okay on 10.7 and of course the other changes are very salutary.  I will remark that I then got a segmentation fault while trying to start it, but I did bdist from a bdisted binary so that is probably the problem.",
    "created_at": "2014-09-04T18:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220267",
    "user": "@kcrisman"
}
```

I can't test whether changing `SAGE_APP_TARGET_ARCH` will change anything but things built okay on 10.7 and of course the other changes are very salutary.  I will remark that I then got a segmentation fault while trying to start it, but I did bdist from a bdisted binary so that is probably the problem.



---

archive/issue_comments_220268.json:
```json
{
    "body": "I have taken the opportunity to correct two typos, and use $UNAME consistently.\n----\nNew commits:",
    "created_at": "2014-10-22T10:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220268",
    "user": "@fchapoton"
}
```

I have taken the opportunity to correct two typos, and use $UNAME consistently.
----
New commits:



---

archive/issue_comments_220269.json:
```json
{
    "body": "Thanks.  I still say \"needs work\" due to missing documentation of these new environment variables - I think it's the installation guide where these ordinarily appear?",
    "created_at": "2014-10-22T12:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220269",
    "user": "@kcrisman"
}
```

Thanks.  I still say "needs work" due to missing documentation of these new environment variables - I think it's the installation guide where these ordinarily appear?



---

archive/issue_comments_220270.json:
```json
{
    "body": "I'll add these docs now. If not me then who, if not now then when...",
    "created_at": "2014-10-22T13:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220270",
    "user": "@dimpase"
}
```

I'll add these docs now. If not me then who, if not now then when...



---

archive/issue_comments_220271.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-22T14:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220271",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_220272.json:
```json
{
    "body": "done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.",
    "created_at": "2014-10-22T14:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220272",
    "user": "@dimpase"
}
```

done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.



---

archive/issue_comments_220273.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-10-22T14:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220273",
    "user": "@dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_220274.json:
```json
{
    "body": "typo \"terminal version fo Sage\"",
    "created_at": "2014-10-22T14:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220274",
    "user": "@fchapoton"
}
```

typo "terminal version fo Sage"



---

archive/issue_comments_220275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-22T14:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220275",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_220276.json:
```json
{
    "body": "> done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.\nQuite.   They are also in the script itself help messages, but that is not the greatest - thanks very much!\n\nIf you look at the built doc the outcome one might expect happens from\n\n```\n`i386` and `x86_64`\n```\n\ninstead of\n\n```\n``i386`` and ``x86_64``\n```\n\nso adding those characters would be good.",
    "created_at": "2014-10-22T14:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220276",
    "user": "@kcrisman"
}
```

> done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.
Quite.   They are also in the script itself help messages, but that is not the greatest - thanks very much!

If you look at the built doc the outcome one might expect happens from

```
`i386` and `x86_64`
```

instead of

```
``i386`` and ``x86_64``
```

so adding those characters would be good.



---

archive/issue_comments_220277.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-22T14:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220277",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_220278.json:
```json
{
    "body": "Thx.\n\nSounds like everyone has used the new bdist script successfully, Mac and Linux?  Anything left?",
    "created_at": "2014-10-22T15:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220278",
    "user": "@kcrisman"
}
```

Thx.

Sounds like everyone has used the new bdist script successfully, Mac and Linux?  Anything left?



---

archive/issue_comments_220279.json:
```json
{
    "body": "not any more now :)",
    "created_at": "2014-10-22T15:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220279",
    "user": "@dimpase"
}
```

not any more now :)



---

archive/issue_comments_220280.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-22T15:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220280",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_220281.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-23T11:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220281",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_220282.json:
```json
{
    "body": "Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??",
    "created_at": "2014-11-14T21:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220282",
    "user": "@vbraun"
}
```

Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??



---

archive/issue_comments_220283.json:
```json
{
    "body": "Followup: #17346",
    "created_at": "2014-11-14T22:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220283",
    "user": "@vbraun"
}
```

Followup: #17346



---

archive/issue_comments_220284.json:
```json
{
    "body": "> Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??\nI dunno - I just bdisted three times in the past few days with no problem.",
    "created_at": "2014-11-15T02:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220284",
    "user": "@kcrisman"
}
```

> Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??
I dunno - I just bdisted three times in the past few days with no problem.



---

archive/issue_comments_220285.json:
```json
{
    "body": "Please no discussion on closed tickets, any further information should go to #17346",
    "created_at": "2014-11-15T11:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16682#issuecomment-220285",
    "user": "@vbraun"
}
```

Please no discussion on closed tickets, any further information should go to #17346
