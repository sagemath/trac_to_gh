# Issue 16682: mistake in sage/src/bin/sage-bdist, OSX app is always built 32-bit

Issue created by migration from Trac.

Original creator: dfriedan

Original creation time: 2014-09-02 10:35:10

CC:  iandrus

Keywords: OSX, sage-bdist

The file sage/src/bin/sage-bdist contains a mistake:
       'ARCHES' should be 'ARCHS'.
The effect of the mistake is that the OS X application is always built as 32-bit ('i386').  This can be seen in the OS X 10.9 app version currently being distributed officially by running the unix command
    $ file /Applications/Sage-6.3.app/Contents/MacOS/Sage
which returns
/Applications/sage-6.3.app/Contents/MacOS/Sage: Mach-O executable i386

This mistake is probably not terribly significant for running sage code, since all the files in sage/local/{bin,lib}/ are 64-bit.

(2) There is a second, more obscure mistake in sage-bdist.  sage-bdist uses `uname -m` to determine the target architecture.  Some older 64-bit Macintoshes can only boot into a 32-bit system.  These machines run 64-bit Sage perfectly well.  
They can make and build 64-bit Sage perfectly well.  The problem is that 
`uname -m` returns 'i386' on these machines, so sage-bdist uses 'i386' as the target architecture.

Attached is modified version of sage-bdist which corrects both mistakes.  See below for a description of my modifications.

I am NOT going to submit this via 'git trac'.  As a neophyte, I don't want the responsibility of modifying the build script.

changes in the attached version of sage-bdist:

(1) 'ARCHES' -> 'ARCHS'

(2) I added an environment variable SAGE_APP_TARGET_ARCH to override `uname -m`.  If one is building Sage on an older 64-bit OSX machine that boots into a 32-bit system, one would do
    $ export SAGE_APP_TARGET_ARCH=x86_64
    $ ./sage-bdist

(3) I also added some code to append '-app' to the name 
of the .dmg file produced by sage-bdist.  At present, this has to be done by hand.

(4) I also added an environment variable (SAGE_APP_GZ=no) to prevent 
the final compression stage, to save time during debugging 
sage-bdist.  One would do
    $ export SAGE_APP_GZ=no
    $ export SAGE_APP_DMG=no
    $ ./sage-bdist
in order to skip the final compression.


---

Attachment

candidate replacement for sage/src/bin/sage-bdist


---

Comment by dimpase created at 2014-09-02 12:50:40

Well-done! 

One still has to convert your attachment into a git branch and put it on trac. :-) This does not add any responsibility, as it will still be reviewed etc, before making it into Sage proper.


---

Comment by vbraun created at 2014-09-02 13:50:42

looks good to me.. somebody wants to try it on their mac?
----
New commits:


---

Comment by vbraun created at 2014-09-02 13:51:00

Changing status from new to needs_review.


---

Comment by kcrisman created at 2014-09-02 14:45:46

> looks good to me.. somebody wants to try it on their mac?

Seems likely to me as well, though I'd prefer to have Ivan also check out the part that Xcode will see first.  I definitely won't have time to actually try a bdist with this in the next week.

Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 

```
elif [ "$SAGE_APP_GZ" != "no" ]; then
```

since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.


---

Comment by dimpase created at 2014-09-02 15:08:03

Replying to [comment:4 vbraun]:
> looks good to me.. somebody wants to try it on their mac?
I can try this tonight, assuming my laptop still boots in OSX...


---

Comment by iandrus created at 2014-09-04 02:45:05

I tried it OMM (10.9) and everything seems to be in order.


---

Comment by iandrus created at 2014-09-04 02:45:05

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-09-04 12:15:02

Changing status from positive_review to needs_work.


---

Comment by kcrisman created at 2014-09-04 12:15:02

> Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 
> {{{
> elif [ "$SAGE_APP_GZ" != "no" ]; then
> }}}
> since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.

I haven't heard a response to this, though.


---

Comment by kcrisman created at 2014-09-04 12:36:57

Replying to [comment:9 kcrisman]:
> > Also, there are now TWO new undocumented variables.  I think that it makes sense to have an example of the appropriate new one introduced here in the installation guide or wherever such variables are documented.  Secondly, I fail to see the point of 
> > {{{
> > elif [ "$SAGE_APP_GZ" != "no" ]; then
> > }}}
> > since the message is pretty clear that the only two options are dmg and not-dmg.  Returning to `else` would remove the need to document that one, at any rate.
> 
> I haven't heard a response to this, though.
Sorry, I didn't see the full description, because I just was thinking about the original discussion.   Both of these now are clear to me but still I think they need to be documented.


---

Comment by kcrisman created at 2014-09-04 18:42:48

I can't test whether changing `SAGE_APP_TARGET_ARCH` will change anything but things built okay on 10.7 and of course the other changes are very salutary.  I will remark that I then got a segmentation fault while trying to start it, but I did bdist from a bdisted binary so that is probably the problem.


---

Comment by chapoton created at 2014-10-22 10:03:07

I have taken the opportunity to correct two typos, and use $UNAME consistently.
----
New commits:


---

Comment by kcrisman created at 2014-10-22 12:11:05

Thanks.  I still say "needs work" due to missing documentation of these new environment variables - I think it's the installation guide where these ordinarily appear?


---

Comment by dimpase created at 2014-10-22 13:20:12

I'll add these docs now. If not me then who, if not now then when...


---

Comment by git created at 2014-10-22 14:28:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2014-10-22 14:31:59

done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.


---

Comment by dimpase created at 2014-10-22 14:31:59

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2014-10-22 14:40:10

typo "terminal version fo Sage"


---

Comment by git created at 2014-10-22 14:42:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-10-22 14:53:05

> done. apparently `SAGE_APP_BUNDLE` existed before, but wasn't documented either.
Quite.   They are also in the script itself help messages, but that is not the greatest - thanks very much!

If you look at the built doc the outcome one might expect happens from

```
`i386` and `x86_64`
```

instead of

```
``i386`` and ``x86_64``
```

so adding those characters would be good.


---

Comment by git created at 2014-10-22 14:58:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-10-22 15:02:46

Thx.

Sounds like everyone has used the new bdist script successfully, Mac and Linux?  Anything left?


---

Comment by dimpase created at 2014-10-22 15:07:15

not any more now :)


---

Comment by dimpase created at 2014-10-22 15:07:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-23 11:15:56

Resolution: fixed


---

Comment by vbraun created at 2014-11-14 21:43:36

Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??


---

Comment by vbraun created at 2014-11-14 22:16:16

Followup: #17346


---

Comment by kcrisman created at 2014-11-15 02:47:49

> Why did you remove execute permissions from the sage-bdist script? How did anybody manage to run a script that is not executable??
I dunno - I just bdisted three times in the past few days with no problem.


---

Comment by vbraun created at 2014-11-15 11:12:56

Please no discussion on closed tickets, any further information should go to #17346
