# Issue 32536: Another test failure with KlyachkoBundle_class.random_deformation

Issue created by migration from https://trac.sagemath.org/ticket/32773

Original creator: @kliem

Original creation time: 2021-10-26 09:43:16

CC:  vbraun mjo @collares

Part of #32544:

Bug or incorrect test?


```
sage -t --long --random-seed=23747002002644886606785003174022326205 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
```



---

Comment by dcoudert created at 2021-12-04 11:27:26

Another one:

```
sage -t --long --warn-long 289.1 --random-seed=213487260798313884417459570000434714591 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 29, in sage.schemes.toric.sheaf.klyachko
Failed example:
    V.cohomology(dim=True, weight=(0,0,0,0))    # long time
Expected:
    (0, 0, 3, 0, 0)
Got:
    (0, 0, 0, 0, 0)
```



---

Comment by @mwageringel created at 2022-01-29 21:54:21

The source of the problem seems to be the implementation of `FilteredVectorSpace_class.random_deformation` [(source)](https://github.com/sagemath/sage/blob/97d550d15c2bce750f404034d71b517ab34b5d77/src/sage/modules/filtered_vector_space.py#L1271-L1275). This is the relevant code:

```python
        filtration = dict()
        for deg, filt in self._filt[1:]:
            generators = [v + epsilon * random_vector(R, self.rank())
                          for v in filt.echelonized_basis()]
            filtration[deg] = generators
```


Occasionally, this random deformation results in `generators` that are linearly dependent, so that the new filtered component is of lower dimension than the original. It seems to me that this is not intended, as this will only happen in rare cases. Should we add a check here to avoid this?


---

Comment by @mwageringel created at 2022-01-30 13:35:29

Here is an attempt at a partial fix which I think respects the original intent, while preserving the subspace inclusions and dimensions of the filtered vector spaces.

This fixes the issue in the description, but the test from comment:1 still sometimes fails:

```
sage -t --long --warn-long 69.2 --random-seed=298280877953805287150486292027026647714 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 29, in sage.schemes.toric.sheaf.klyachko
Failed example:
    V.cohomology(dim=True, weight=(0,0,0,0))    # long time
Expected:
    (0, 0, 3, 0, 0)
Got:
    (0, 0, 5, 0, 0)
```

----
New commits:


---

Comment by @mwageringel created at 2022-01-30 13:35:29

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2022-02-14 21:18:50

If the current fix seems acceptable, I would suggest to open a new ticket for the remaining failure. We can mark it as known bug here to make the tests pass again.


---

Comment by mjo created at 2022-02-16 13:03:25

It looks like all of this machinery was added specifically for Klyachko bundles, so it really comes down to the intent. And I think the `FilteredVectorSpace` constructor guarantees the subspace inclusions? If so, it's only the dimensions of the components that can cause  an issue; I don't see a problem with that a priori for general filtered vector spaces, but the docs for the Klyachko bundle method say,

> Return a generic torus-equivariant deformation of the bundle... A new Klyachko bundle with randomly perturbed moduli. In particular, the same Chern classes.

and I have to admit that I don't know what very many of those words mean. If it's only the Klyachko class that needs the dimensions of the components to remain invariant, it might be better to change


```
while not filt.is_exhaustive():
    filt = self._filt.random_deformation(epsilon)
```


to preserve those dimensions as well.


---

Comment by @mwageringel created at 2022-02-17 08:59:47

Yes, I think your assessments are correct. I am not completely sure about the original intent either.

`@`vbraun: Could you help us on this, please? You seem to be the original author. In particular, what is needed for the random deformations of Klyachko bundles to have those properties? And should random deformations of filtered vector spaces preserve the dimensions of their components?


---

Comment by dimpase created at 2022-04-04 11:06:51

it seems to me that "random" here silently   means "generic", as well.


---

Comment by strogdon created at 2022-08-12 05:53:22

This also happens with a different `random-seed`.

```
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
1 item had failures:
   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
    [151 tests, 1 failure, 7.14 s]
----------------------------------------------------------------------
sage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633
```



---

Comment by strogdon created at 2022-08-12 06:00:43

Replying to [comment:13 strogdon]:
> This also happens with a different `random-seed`.
> {{{
> sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py
> **********************************************************************
> File "/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
> Failed example:
>     Vtilde.cohomology(dim=True, weight=(0,))
> Expected:
>     (1, 0)
> Got:
>     (0, 0)
> **********************************************************************
> 1 item had failures:
>    1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
>     [151 tests, 1 failure, 7.14 s]
> ----------------------------------------------------------------------
> sage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633
> }}}
This was on Sage-on-Gentoo. With vanilla sage the failure is

```
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
1 item had failures:
   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
    [151 tests, 1 failure, 7.30 s]
----------------------------------------------------------------------
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py  # 1 doctest failed
```

