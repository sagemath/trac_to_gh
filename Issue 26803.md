# Issue 26803: Make env.py use system values instead of using seeds

archive/issues_026803.json:
```json
{
    "body": "CC:  infinity0 thansen\n\nFran\u00e7ois Bissey made sage-on-gentoo's env.py use:\n\n```\n_add_variable_or_fallback('SAGE_LOCAL',      sysconfig.get_config_var(\"prefix\u201d))\n```\n\ninstead of using a seed.\n\nProbably SAGE_ROOT should also use the same trick.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27040\n\n",
    "created_at": "2019-01-10T21:11:36Z",
    "labels": [
        "scripts",
        "trivial"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Make env.py use system values instead of using seeds",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26803",
    "user": "Snark"
}
```
CC:  infinity0 thansen

François Bissey made sage-on-gentoo's env.py use:

```
_add_variable_or_fallback('SAGE_LOCAL',      sysconfig.get_config_var("prefix”))
```

instead of using a seed.

Probably SAGE_ROOT should also use the same trick.

Issue created by migration from https://trac.sagemath.org/ticket/27040





---

archive/issue_comments_377009.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-01-10T21:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377009",
    "user": "Snark"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_377010.json:
```json
{
    "body": "SAGE_ROOT is harder. It doesn't correspond to any configuration features of anything. At best it is `SAGE_LOCAL/..`. Any corners in which that wouldn't be true?",
    "created_at": "2019-01-10T21:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377010",
    "user": "fbissey"
}
```

SAGE_ROOT is harder. It doesn't correspond to any configuration features of anything. At best it is `SAGE_LOCAL/..`. Any corners in which that wouldn't be true?



---

archive/issue_comments_377011.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> SAGE_ROOT is harder. It doesn't correspond to any configuration features of anything. At best it is `SAGE_LOCAL/..`. Any corners in which that wouldn't be true?\n\nOne place where the `SAGE_LOCAL/..` pattern does not hold is the Debian package, where `SAGE_LOCAL=/usr` but `SAGE_ROOT=/usr/share/sagemath`.  Moreover, on Debian `SAGE_SCRIPTS_DIR` is `$SAGE_ROOT/bin` rather than the more typical `$SAGE_LOCAL/bin`.",
    "created_at": "2019-01-10T22:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377011",
    "user": "dunfield"
}
```

Replying to [comment:2 fbissey]:
> SAGE_ROOT is harder. It doesn't correspond to any configuration features of anything. At best it is `SAGE_LOCAL/..`. Any corners in which that wouldn't be true?

One place where the `SAGE_LOCAL/..` pattern does not hold is the Debian package, where `SAGE_LOCAL=/usr` but `SAGE_ROOT=/usr/share/sagemath`.  Moreover, on Debian `SAGE_SCRIPTS_DIR` is `$SAGE_ROOT/bin` rather than the more typical `$SAGE_LOCAL/bin`.



---

archive/issue_comments_377012.json:
```json
{
    "body": "I see. debian choose to do something like that. In sage-on-gentoo SAGE_ROOT points to a location where there used to be something but is now empty. Does debian use SAGE_ROOT anywhere else? Otherwise they could just define SAGE_SCRIPTS_DIR directly.",
    "created_at": "2019-01-10T22:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377012",
    "user": "fbissey"
}
```

I see. debian choose to do something like that. In sage-on-gentoo SAGE_ROOT points to a location where there used to be something but is now empty. Does debian use SAGE_ROOT anywhere else? Otherwise they could just define SAGE_SCRIPTS_DIR directly.



---

archive/issue_comments_377013.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> Does debian use SAGE_ROOT anywhere else? Otherwise they could just define SAGE_SCRIPTS_DIR directly.\n\nTo clarify, Debian doesn't change anything in `env.py` related to `SAGE_SCRIPTS_DIR`; the only fallback there is `$SAGE_LOCAL/bin` which does not contain the relevant scripts.  Instead, in `/usr/share/sagemath/bin/sage-env` they manually set `SAGE_ROOT=/usr/share/sagemath/` and `SAGE_SCRIPTS_DIR=/usr/share/sagemath/bin`. \n\nOn Debian, I tried setting `SAGE_ROOT` to a garbage value in `sage-env`, and Sage still started and worked fine near as I can tell.",
    "created_at": "2019-01-10T23:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377013",
    "user": "dunfield"
}
```

Replying to [comment:5 fbissey]:
> Does debian use SAGE_ROOT anywhere else? Otherwise they could just define SAGE_SCRIPTS_DIR directly.

To clarify, Debian doesn't change anything in `env.py` related to `SAGE_SCRIPTS_DIR`; the only fallback there is `$SAGE_LOCAL/bin` which does not contain the relevant scripts.  Instead, in `/usr/share/sagemath/bin/sage-env` they manually set `SAGE_ROOT=/usr/share/sagemath/` and `SAGE_SCRIPTS_DIR=/usr/share/sagemath/bin`. 

On Debian, I tried setting `SAGE_ROOT` to a garbage value in `sage-env`, and Sage still started and worked fine near as I can tell.



---

archive/issue_comments_377014.json:
```json
{
    "body": "I can see it now. In vanilla sage `SAGE_SCRIPTS_DIR` is only set in sage-env and used to source `sage-env-config`. But I certainly know that debian has plan for that folder.\n\nSo as far as we can see, it would be fine to set `SAGE_ROOT` in `env.py`. But it could probably be left as is without impacting anything and doing `from sage import all` in python should work without setting it.\n\nLooking at it there is one thing I have set `SAGE_ROOT` for! `sage/misc/copying.py` tries to access `SAGE_ROOT/COPYING.txt`. So its current value in sage-on-gentoo is just so that bit works :) I need to change that to be more conformant to Gentoo policies.\n\nThere is a somewhat harmless appearance of `SAGE_ROOT` in `sage/misc/citation.pyx`. There is a more disturbing one in `sage/misc/persist.pyx` where I would have used `DOT_SAGE` to be honest. The rest is mostly doctesting, packaging, doctests themselves and documentation strings.",
    "created_at": "2019-01-11T01:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377014",
    "user": "fbissey"
}
```

I can see it now. In vanilla sage `SAGE_SCRIPTS_DIR` is only set in sage-env and used to source `sage-env-config`. But I certainly know that debian has plan for that folder.

So as far as we can see, it would be fine to set `SAGE_ROOT` in `env.py`. But it could probably be left as is without impacting anything and doing `from sage import all` in python should work without setting it.

Looking at it there is one thing I have set `SAGE_ROOT` for! `sage/misc/copying.py` tries to access `SAGE_ROOT/COPYING.txt`. So its current value in sage-on-gentoo is just so that bit works :) I need to change that to be more conformant to Gentoo policies.

There is a somewhat harmless appearance of `SAGE_ROOT` in `sage/misc/citation.pyx`. There is a more disturbing one in `sage/misc/persist.pyx` where I would have used `DOT_SAGE` to be honest. The rest is mostly doctesting, packaging, doctests themselves and documentation strings.



---

archive/issue_comments_377015.json:
```json
{
    "body": "Changing component from scripts to porting.",
    "created_at": "2019-01-11T08:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377015",
    "user": "jdemeyer"
}
```

Changing component from scripts to porting.



---

archive/issue_comments_377016.json:
```json
{
    "body": "Changing priority from trivial to major.",
    "created_at": "2019-01-11T08:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377016",
    "user": "jdemeyer"
}
```

Changing priority from trivial to major.



---

archive/issue_comments_377017.json:
```json
{
    "body": "Scope extension. That's brave! I notice you mention `SAGE_SRC` and `SAGE_LIB`, is it because you spotted I have\n\n```\n_add_variable_or_fallback('SAGE_SRC',        opj('$SAGE_LIB'))\n```\n\nin sage-on-gentoo? I override it with the appropriate value during build of course. But it should work in most places.",
    "created_at": "2019-01-11T09:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377017",
    "user": "fbissey"
}
```

Scope extension. That's brave! I notice you mention `SAGE_SRC` and `SAGE_LIB`, is it because you spotted I have

```
_add_variable_or_fallback('SAGE_SRC',        opj('$SAGE_LIB'))
```

in sage-on-gentoo? I override it with the appropriate value during build of course. But it should work in most places.



---

archive/issue_comments_377018.json:
```json
{
    "body": "Replying to [comment:12 fbissey]:\n> is it because you spotted I have\n> {{{\n> _add_variable_or_fallback('SAGE_SRC',        opj('$SAGE_LIB'))\n> }}}\n> in sage-on-gentoo?\n\nActually no. It's something I figured out independently.",
    "created_at": "2019-01-11T09:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377018",
    "user": "jdemeyer"
}
```

Replying to [comment:12 fbissey]:
> is it because you spotted I have
> {{{
> _add_variable_or_fallback('SAGE_SRC',        opj('$SAGE_LIB'))
> }}}
> in sage-on-gentoo?

Actually no. It's something I figured out independently.



---

archive/issue_comments_377019.json:
```json
{
    "body": "Will using `sage.__file__` change the way we use `SAGE_LIB` or do you plan to restore the value starting from it?",
    "created_at": "2019-01-11T09:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377019",
    "user": "fbissey"
}
```

Will using `sage.__file__` change the way we use `SAGE_LIB` or do you plan to restore the value starting from it?



---

archive/issue_comments_377020.json:
```json
{
    "body": "Replying to [comment:15 fbissey]:\n> Will using `sage.__file__` change the way we use `SAGE_LIB`\n\nNo.\n\n`SAGE_LIB` is supposed to be the installed location of Sage. I guess that by definition, Sage is run from its installed location. So if you know `sage.__file__`, you know the installed location of Sage.",
    "created_at": "2019-01-11T10:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377020",
    "user": "jdemeyer"
}
```

Replying to [comment:15 fbissey]:
> Will using `sage.__file__` change the way we use `SAGE_LIB`

No.

`SAGE_LIB` is supposed to be the installed location of Sage. I guess that by definition, Sage is run from its installed location. So if you know `sage.__file__`, you know the installed location of Sage.



---

archive/issue_comments_377021.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:15 fbissey]:\n> > Will using `sage.__file__` change the way we use `SAGE_LIB`\n> \n> No.\n> \n> `SAGE_LIB` is supposed to be the installed location of Sage. I guess that by definition, Sage is run from its installed location. So if you know `sage.__file__`, you know the installed location of Sage.\n\nI get your argument and won't contest. but it has been used as the site-package location in the code so I am expecting changes, particularly where you exchange `SAGE_SRC` for `SAGE_LIB`.",
    "created_at": "2019-01-11T10:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377021",
    "user": "fbissey"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:15 fbissey]:
> > Will using `sage.__file__` change the way we use `SAGE_LIB`
> 
> No.
> 
> `SAGE_LIB` is supposed to be the installed location of Sage. I guess that by definition, Sage is run from its installed location. So if you know `sage.__file__`, you know the installed location of Sage.

I get your argument and won't contest. but it has been used as the site-package location in the code so I am expecting changes, particularly where you exchange `SAGE_SRC` for `SAGE_LIB`.



---

archive/issue_comments_377022.json:
```json
{
    "body": "Replying to [comment:19 fbissey]:\n> it has been used as the site-package location in the code so I am expecting changes\n\nIf Sage is installed in `site-packages` (which is almost certainly the case), then the old value and new value for `SAGE_LIB` will be the same. In this case, there won't be any breakage.\n\nIf Sage is **not** installed in `site-packages`, then any existing code using `SAGE_LIB` to find the installed location of Sage is already broken.\n\nDo you know any code which is using `SAGE_LIB` to find the path of something else besides `sage`?",
    "created_at": "2019-01-11T10:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377022",
    "user": "jdemeyer"
}
```

Replying to [comment:19 fbissey]:
> it has been used as the site-package location in the code so I am expecting changes

If Sage is installed in `site-packages` (which is almost certainly the case), then the old value and new value for `SAGE_LIB` will be the same. In this case, there won't be any breakage.

If Sage is **not** installed in `site-packages`, then any existing code using `SAGE_LIB` to find the installed location of Sage is already broken.

Do you know any code which is using `SAGE_LIB` to find the path of something else besides `sage`?



---

archive/issue_comments_377023.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-11T10:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377023",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_377024.json:
```json
{
    "body": "Let's take some code from `sage/doctest/control.py`\n\n```\nF = x.__file__.replace(SAGE_LIB, SAGE_SRC)\n```\n\nIt basically works because in both case you have to add `sage` to find what you want.\n\nAll the current code using `SAGE_LIB` is based on it mirroring `SAGE_SRC` by the look of it.\n\nNevertheless a change may be good. I'll certainly have a good look at what you proposing!\n----\nNew commits:",
    "created_at": "2019-01-11T10:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377024",
    "user": "fbissey"
}
```

Let's take some code from `sage/doctest/control.py`

```
F = x.__file__.replace(SAGE_LIB, SAGE_SRC)
```

It basically works because in both case you have to add `sage` to find what you want.

All the current code using `SAGE_LIB` is based on it mirroring `SAGE_SRC` by the look of it.

Nevertheless a change may be good. I'll certainly have a good look at what you proposing!
----
New commits:



---

archive/issue_comments_377025.json:
```json
{
    "body": "In `env.py` in the definition of `sage_include_directories` \n\n```\n    if use_sources :\n        include_directories.extend([SAGE_SRC,\n                                    opj(SAGE_SRC, 'sage', 'ext')])\n    else:\n        include_directories.extend([SAGE_LIB,\n                                    opj(SAGE_LIB, 'sage', 'ext')])\n```\n\nsince `SAGE_LIB` should now include `sage`, this should be changed unless there is something I don't get.",
    "created_at": "2019-01-11T10:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377025",
    "user": "fbissey"
}
```

In `env.py` in the definition of `sage_include_directories` 

```
    if use_sources :
        include_directories.extend([SAGE_SRC,
                                    opj(SAGE_SRC, 'sage', 'ext')])
    else:
        include_directories.extend([SAGE_LIB,
                                    opj(SAGE_LIB, 'sage', 'ext')])
```

since `SAGE_LIB` should now include `sage`, this should be changed unless there is something I don't get.



---

archive/issue_comments_377026.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T11:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377026",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377027.json:
```json
{
    "body": "I'm guessing that those top-level include directories like `SAGE_SRC` and `SAGE_LIB` are not actually needed. But the patchbot needs to confirm...",
    "created_at": "2019-01-11T11:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377027",
    "user": "jdemeyer"
}
```

I'm guessing that those top-level include directories like `SAGE_SRC` and `SAGE_LIB` are not actually needed. But the patchbot needs to confirm...



---

archive/issue_comments_377028.json:
```json
{
    "body": "That `SAGE_SRC` in the include directories was introduced by #14544. I'll recheck that bug. But hopefully Cython has become more clever now.",
    "created_at": "2019-01-11T11:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377028",
    "user": "jdemeyer"
}
```

That `SAGE_SRC` in the include directories was introduced by #14544. I'll recheck that bug. But hopefully Cython has become more clever now.



---

archive/issue_comments_377029.json:
```json
{
    "body": "\n```diff\n+\n+def j(*args):\n+    \"\"\"\n+    Join paths like ``os.path.join`` except that the result is ``None``\n+    if any of the components is ``None``.\n+    \"\"\"\n+    if any(a is None for a in args):\n+        return None\n+    import os\n+    return os.path.join(*args)\n+\n+\n```\n\n\nWhat's with the superfluous `import os` in here?  I also don't like that this function is called just `j`.  I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.",
    "created_at": "2019-01-11T11:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377029",
    "user": "embray"
}
```


```diff
+
+def j(*args):
+    """
+    Join paths like ``os.path.join`` except that the result is ``None``
+    if any of the components is ``None``.
+    """
+    if any(a is None for a in args):
+        return None
+    import os
+    return os.path.join(*args)
+
+
```


What's with the superfluous `import os` in here?  I also don't like that this function is called just `j`.  I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.



---

archive/issue_comments_377030.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.\n\nAt least it's not as bad as gettext's convention of using `_` :-)",
    "created_at": "2019-01-11T12:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377030",
    "user": "jdemeyer"
}
```

Replying to [comment:29 embray]:
> I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.

At least it's not as bad as gettext's convention of using `_` :-)



---

archive/issue_comments_377031.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T12:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377031",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377032.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:29 embray]:\n> > I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.\n> \n> At least it's not as bad as gettext's convention of using `_` :-)\n\nHeh, I think there's a decent excuse for that, but it's still definitely questionable.\n\nThanks anyways.  Just glancing over the rest of the diff this looks like a vast improvement.  I probably won't have a chance to test it out next week, but I want to try it on Cygwin.",
    "created_at": "2019-01-11T14:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377032",
    "user": "embray"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:29 embray]:
> > I know it's convenient to have a short name here, but I'd prefer something a little clearer, like `join`.
> 
> At least it's not as bad as gettext's convention of using `_` :-)

Heh, I think there's a decent excuse for that, but it's still definitely questionable.

Thanks anyways.  Just glancing over the rest of the diff this looks like a vast improvement.  I probably won't have a chance to test it out next week, but I want to try it on Cygwin.



---

archive/issue_comments_377033.json:
```json
{
    "body": "Various doctest failures on the patchbot but only in deprecated functionality.",
    "created_at": "2019-01-11T15:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377033",
    "user": "jdemeyer"
}
```

Various doctest failures on the patchbot but only in deprecated functionality.



---

archive/issue_comments_377034.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T15:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377034",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-13T21:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377035",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_377036.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-14T16:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377036",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_377037.json:
```json
{
    "body": "This is definitely a vast improvement over the old version of this module.  If any further changes are needed for any reason we can add them in follow-up tickets (though if maintainers of any particular downstream packages want to chime in with their own comments feel free to set back to needs_work/needs_info).\n\nChanging milestone to 8.7 as I don't think this is urgent: Most packagers already have their own patches to this module, and drastically changing it now is going to break those patches, only making this harder for getting an 8.6 release out.",
    "created_at": "2019-01-14T16:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377037",
    "user": "embray"
}
```

This is definitely a vast improvement over the old version of this module.  If any further changes are needed for any reason we can add them in follow-up tickets (though if maintainers of any particular downstream packages want to chime in with their own comments feel free to set back to needs_work/needs_info).

Changing milestone to 8.7 as I don't think this is urgent: Most packagers already have their own patches to this module, and drastically changing it now is going to break those patches, only making this harder for getting an 8.6 release out.



---

archive/issue_comments_377038.json:
```json
{
    "body": "Note that the dependency #27041 still needs review.",
    "created_at": "2019-01-15T12:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377038",
    "user": "jdemeyer"
}
```

Note that the dependency #27041 still needs review.



---

archive/issue_comments_377039.json:
```json
{
    "body": "On nix, the test\n\n\n```\nVerify that Sage can be started without any ``SAGE_`` environment\nvariables::\n\n    sage: env = {k:v for (k,v) in os.environ.items() if not k.startswith(\"SAGE_\")}\n    sage: import subprocess\n    sage: cmd = \"from sage.all import SAGE_ROOT; print(SAGE_ROOT)\"\n    sage: res = subprocess.call([\"python\", \"-c\", cmd], env=env)  # long time\n    None\n```\n\n\nbreaks because maxima can't be found:\n\n\n```\nFailed example:\n    res = subprocess.call([\"python\", \"-c\", cmd], env=env)  # long time\nExpected:\n    None\nGot:\n    Traceback (most recent call last):\n      File \"<string>\", line 1, in <module>\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/all.py\", line 83, in <module>\n        from sage.misc.all       import *         # takes a while\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/misc/all.py\", line 84, in <module>\n        from .functional import (additive_order,\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/misc/functional.py\", line 27, in <module>\n        from sage.rings.complex_double import CDF\n      File \"sage/rings/complex_double.pyx\", line 101, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:23780)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 114, in ComplexField\n        C = ComplexField_class(prec)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 208, in __init__\n        self._populate_coercion_lists_(coerce_list=[RRtoCC(self._real_field(), self)])\n      File \"sage/rings/complex_number.pyx\", line 2580, in sage.rings.complex_number.RRtoCC.__init__ (build/cythonized/sage/rings/complex_number.c:20548)\n      File \"sage/categories/map.pyx\", line 125, in sage.categories.map.Map.__init__ (build/cythonized/sage/categories/map.c:3621)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/homset.py\", line 395, in Hom\n        H = Hom(X, Y, category, check=False)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/homset.py\", line 422, in Hom\n        H = X._Hom_(Y, category)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/rings.py\", line 361, in _Hom_\n        from sage.rings.homset import RingHomset\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/homset.py\", line 19, in <module>\n        from . import quotient_ring\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/quotient_ring.py\", line 116, in <module>\n        import sage.rings.polynomial.multi_polynomial_ideal\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 239, in <module>\n        from sage.interfaces.all import (singular as singular_default,\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/all.py\", line 24, in <module>\n        from .maxima import maxima, Maxima\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/maxima.py\", line 1238, in <module>\n        script_subdirectory=None)\n      File \"/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/maxima.py\", line 529, in __init__\n        raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')\n    RuntimeError: You must get the file local/bin/sage-maxima.lisp\n```\n\n\nIs it the intention for that test to work in every environment? If its not, I think it is a step back.",
    "created_at": "2019-01-27T09:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377039",
    "user": "@timokau"
}
```

On nix, the test


```
Verify that Sage can be started without any ``SAGE_`` environment
variables::

    sage: env = {k:v for (k,v) in os.environ.items() if not k.startswith("SAGE_")}
    sage: import subprocess
    sage: cmd = "from sage.all import SAGE_ROOT; print(SAGE_ROOT)"
    sage: res = subprocess.call(["python", "-c", cmd], env=env)  # long time
    None
```


breaks because maxima can't be found:


```
Failed example:
    res = subprocess.call(["python", "-c", cmd], env=env)  # long time
Expected:
    None
Got:
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/all.py", line 83, in <module>
        from sage.misc.all       import *         # takes a while
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/misc/all.py", line 84, in <module>
        from .functional import (additive_order,
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/misc/functional.py", line 27, in <module>
        from sage.rings.complex_double import CDF
      File "sage/rings/complex_double.pyx", line 101, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:23780)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/complex_field.py", line 114, in ComplexField
        C = ComplexField_class(prec)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/complex_field.py", line 208, in __init__
        self._populate_coercion_lists_(coerce_list=[RRtoCC(self._real_field(), self)])
      File "sage/rings/complex_number.pyx", line 2580, in sage.rings.complex_number.RRtoCC.__init__ (build/cythonized/sage/rings/complex_number.c:20548)
      File "sage/categories/map.pyx", line 125, in sage.categories.map.Map.__init__ (build/cythonized/sage/categories/map.c:3621)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/homset.py", line 395, in Hom
        H = Hom(X, Y, category, check=False)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/homset.py", line 422, in Hom
        H = X._Hom_(Y, category)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/categories/rings.py", line 361, in _Hom_
        from sage.rings.homset import RingHomset
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/homset.py", line 19, in <module>
        from . import quotient_ring
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/quotient_ring.py", line 116, in <module>
        import sage.rings.polynomial.multi_polynomial_ideal
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 239, in <module>
        from sage.interfaces.all import (singular as singular_default,
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/all.py", line 24, in <module>
        from .maxima import maxima, Maxima
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 1238, in <module>
        script_subdirectory=None)
      File "/nix/store/yhjx1nw8fiivfhpi1pg45v5fkawbpzv9-python-2.7.15-env/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 529, in __init__
        raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')
    RuntimeError: You must get the file local/bin/sage-maxima.lisp
```


Is it the intention for that test to work in every environment? If its not, I think it is a step back.



---

archive/issue_comments_377040.json:
```json
{
    "body": "It is very strange. Nothing in this ticket changes `sage/interface/maxima.py` or the variable it gets from `env.py`. The error message could use a bit of work from the point of view of distro though. \n\n```\n       STARTUP = os.path.join(SAGE_LOCAL,'bin','sage-maxima.lisp')\n\n       if not os.path.exists(STARTUP):\n            raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')\n```\n\nif the message in runtime error was quoting `STARTUP` instead of a fixed path we may have more of a clue as to what's happening to you.",
    "created_at": "2019-01-27T09:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377040",
    "user": "fbissey"
}
```

It is very strange. Nothing in this ticket changes `sage/interface/maxima.py` or the variable it gets from `env.py`. The error message could use a bit of work from the point of view of distro though. 

```
       STARTUP = os.path.join(SAGE_LOCAL,'bin','sage-maxima.lisp')

       if not os.path.exists(STARTUP):
            raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')
```

if the message in runtime error was quoting `STARTUP` instead of a fixed path we may have more of a clue as to what's happening to you.



---

archive/issue_comments_377041.json:
```json
{
    "body": "I suspect it is because the `SAGE_LOCAL` I set was replaced by\n\n\n```\nvar('SAGE_LOCAL', os.path.abspath(sys.prefix))\n```\n\n\nWhich isn't accurate for me. I don't mind that the fallbacks won't work on every system (if they would, there would be no point in making it configurable in the first place). But I'm not sure if we should include a test for those fallbacks.\n\nI've planned to just migrate my custom `sage-env.sh` to `sage-env.py` and import that from `env.py` for a while now, so that would solve the problem for me. Still not entirely convinced the test is a good idea.",
    "created_at": "2019-01-27T10:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377041",
    "user": "@timokau"
}
```

I suspect it is because the `SAGE_LOCAL` I set was replaced by


```
var('SAGE_LOCAL', os.path.abspath(sys.prefix))
```


Which isn't accurate for me. I don't mind that the fallbacks won't work on every system (if they would, there would be no point in making it configurable in the first place). But I'm not sure if we should include a test for those fallbacks.

I've planned to just migrate my custom `sage-env.sh` to `sage-env.py` and import that from `env.py` for a while now, so that would solve the problem for me. Still not entirely convinced the test is a good idea.



---

archive/issue_comments_377042.json:
```json
{
    "body": "I think the test is a good idea because it should work in all \"normal\" installation scenarios. Nix is the special one here, so it's not surprising to me that stuff breaks on Nix.",
    "created_at": "2019-01-27T10:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377042",
    "user": "jdemeyer"
}
```

I think the test is a good idea because it should work in all "normal" installation scenarios. Nix is the special one here, so it's not surprising to me that stuff breaks on Nix.



---

archive/issue_comments_377043.json:
```json
{
    "body": "I disagree. In my opinion if tests depend on a certain environment, that is a bug.\n\nBut I won't fight anyone on this.",
    "created_at": "2019-01-27T10:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377043",
    "user": "@timokau"
}
```

I disagree. In my opinion if tests depend on a certain environment, that is a bug.

But I won't fight anyone on this.



---

archive/issue_comments_377044.json:
```json
{
    "body": "That value for `SAGE_LOCAL` follows my own suggestion with suppose that sage and its software is all installed under the same \"prefix\". Of course in nix case that's a little bit different. In a way, it's a more general case.\n\nYou would have to rethink quite a bit of the wiring of sage to eliminate the need for `SAGE_LOCAL` - I wouldn't be against, but that's too much work in one sitting.",
    "created_at": "2019-01-27T10:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377044",
    "user": "fbissey"
}
```

That value for `SAGE_LOCAL` follows my own suggestion with suppose that sage and its software is all installed under the same "prefix". Of course in nix case that's a little bit different. In a way, it's a more general case.

You would have to rethink quite a bit of the wiring of sage to eliminate the need for `SAGE_LOCAL` - I wouldn't be against, but that's too much work in one sitting.



---

archive/issue_comments_377045.json:
```json
{
    "body": "Replying to [comment:44 fbissey]:\n> That value for `SAGE_LOCAL` follows my own suggestion with suppose that sage and its software is all installed under the same \"prefix\". Of course in nix case that's a little bit different. In a way, it's a more general case.\n> \n> You would have to rethink quite a bit of the wiring of sage to eliminate the need for `SAGE_LOCAL` - I wouldn't be against, but that's too much work in one sitting.\n\nI'm not saying this change is bad. If it works for more cases than it did before, that is great. I just think that the tests should work in the more \"general\" case (a python library can be anywhere in `sys.path`, doesn't have to be in `prefix`) and thus we shouldn't test for this.",
    "created_at": "2019-01-27T10:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377045",
    "user": "@timokau"
}
```

Replying to [comment:44 fbissey]:
> That value for `SAGE_LOCAL` follows my own suggestion with suppose that sage and its software is all installed under the same "prefix". Of course in nix case that's a little bit different. In a way, it's a more general case.
> 
> You would have to rethink quite a bit of the wiring of sage to eliminate the need for `SAGE_LOCAL` - I wouldn't be against, but that's too much work in one sitting.

I'm not saying this change is bad. If it works for more cases than it did before, that is great. I just think that the tests should work in the more "general" case (a python library can be anywhere in `sys.path`, doesn't have to be in `prefix`) and thus we shouldn't test for this.



---

archive/issue_comments_377046.json:
```json
{
    "body": "Sure. `SAGE_LOCAL` is really mostly an installation \"prefix\" and it make sense in the most usual case which is why the current value is useful for most people. There are arguments for eliminating it like SAGE_ROOT was mostly disposed of before.\n\nIn the case of `STARTUP` and `sage-maxima.lisp`, my own view is that it ends up in `SAGE_LOCAL/bin` by accident. It is a freaking configuration file not an executable and it belongs to `SAGE_ETC` but it was easier to put it in `src/bin` where it will be installed neatly with the rest. Same with `sage-env*`. One day we'll have to fix that properly in vanilla sage.",
    "created_at": "2019-01-27T10:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377046",
    "user": "fbissey"
}
```

Sure. `SAGE_LOCAL` is really mostly an installation "prefix" and it make sense in the most usual case which is why the current value is useful for most people. There are arguments for eliminating it like SAGE_ROOT was mostly disposed of before.

In the case of `STARTUP` and `sage-maxima.lisp`, my own view is that it ends up in `SAGE_LOCAL/bin` by accident. It is a freaking configuration file not an executable and it belongs to `SAGE_ETC` but it was easier to put it in `src/bin` where it will be installed neatly with the rest. Same with `sage-env*`. One day we'll have to fix that properly in vanilla sage.



---

archive/issue_comments_377047.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-28T19:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377047",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_377048.json:
```json
{
    "body": "I think `sage-maxima.lisp` should not be where it currently lives.  If it's needed by the sage Python package to work then it should just be installed inside the package (e.g. as `package_data` in `setup.py`).  ~~Please open a ticket.~~ I opened #27171.",
    "created_at": "2019-01-29T18:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377048",
    "user": "embray"
}
```

I think `sage-maxima.lisp` should not be where it currently lives.  If it's needed by the sage Python package to work then it should just be installed inside the package (e.g. as `package_data` in `setup.py`).  ~~Please open a ticket.~~ I opened #27171.



---

archive/issue_comments_377049.json:
```json
{
    "body": "Serious breakage: #27389",
    "created_at": "2019-03-04T10:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26803#issuecomment-377049",
    "user": "jdemeyer"
}
```

Serious breakage: #27389
