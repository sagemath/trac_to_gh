# Issue 8115: bad patching practice in cddlib-094f.p2.spkg

Issue created by migration from Trac.

Original creator: mvngu

Original creation time: 2010-01-29 09:51:05

Assignee: tbd

CC:  vbraun mhampton

Keywords: cddlib, polyhedra

A problem with cddlib-094f.p2.spkg is that it patches upstream source using a patch file, rather than copying a patched file over to the appropriate place under the src/ directory. Consequently, there is no clean separation between upstream source and patches that we apply to cddlib-094f. Looking at spkg-install of cddlib-094f.p2.spkg, you get these two lines for applying Sage-specific patches:

```
cp patches/allfaces.c src/src/

patch -p0 < patches/cdd_both_reps-make.patch
```

The first line is the preferred way to patch an upstream source because it copies the patched file patches/allfaces.c over to src/src/.


---

Comment by mvngu created at 2010-01-29 09:57:26

Updated spkg is up at

http://sage.math.washington.edu/home/mvngu/spkg/standard/cddlib/cddlib-094f.p3.spkg

Changes include:

 * clean separation between upstream source and Sage-specific patches
 * add function patch() to spkg-install for managing patches
 * use && for conditional "and" instead of "-a" in spkg-install


---

Comment by mvngu created at 2010-01-29 09:57:26

Changing status from new to needs_review.


---

Comment by mhampton created at 2010-01-29 14:22:23

The allfaces.c file is mentioned in the cddlib manual as an example file.  Its been in the sage spkg for a long time, I think.  Probably it was originally included to show sage developers how to use the library.  So it seems to make sense to get rid of it after #8115 is sorted out, since cdd_both_reps provides an example that is actually used.  

My apologies for missing this issue in review - makefiles and libraries are not my strong suit.

-Marshall


---

Comment by vbraun created at 2010-01-29 16:30:56

New version now has unmodified src (except for deleting unnecessary subdirectories). 

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg

To simplify review I'll attach spkg-install in verbatim. 

Changes: 
 * libtool-ized, see http://trac.sagemath.org/sage_trac/ticket/3304
   After implementing the changes, I found that tabbott proposed a
   similar patch to the automake files earlier:
   http://sagetrac.org/sage_trac/ticket/3304
 * renamed configure.in -> configure.ac (preferred usage)
 * renamed patches/cdd_both_reps-makefiles.patch -> patches/automake.patch 
 * added check for required mpir (aka GMP) to spkg-install
 * added spkg-check
 * corrected src/patch usage
 * removed CFLAGS settings in spkg-install, not required.
 * Workaround for spkg-env setting RM="rm"
   http://trac.sagemath.org/sage_trac/ticket/7818#comment:28


---

Attachment

spkg-install from cddlib-094f.p4.spkg


---

Comment by mvngu created at 2010-01-31 01:35:40

There are outstanding changes in 

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg

which must be first checked in:

```
[mvngu`@`mod cddlib-094f.p4]$ pwd
/home/mvngu/cddlib-094f.p4
[mvngu`@`mod cddlib-094f.p4]$ hg st
M SPKG.txt
M spkg-install
A patches/autogenerated/INSTALL
A patches/autogenerated/Makefile.in
A patches/autogenerated/aclocal.m4
A patches/autogenerated/config.guess
A patches/autogenerated/config.sub
A patches/autogenerated/configure
A patches/autogenerated/configure.ac
A patches/autogenerated/depcomp
A patches/autogenerated/install-sh
A patches/autogenerated/ltmain.sh
A patches/autogenerated/m4/libtool.m4
A patches/autogenerated/m4/ltoptions.m4
A patches/autogenerated/m4/ltsugar.m4
A patches/autogenerated/m4/ltversion.m4
A patches/autogenerated/m4/lt~obsolete.m4
A patches/autogenerated/missing
A patches/autogenerated/mkinstalldirs
A patches/automake.patch
A patches/configure.ac
A patches/lib-src-Makefile.am
A patches/lib-src-gmp-Makefile.am
A patches/src-Makefile.am
A patches/src-gmp-Makefile.am
A spkg-check
R patches/cdd_both_reps-make.patch
```



---

Comment by mvngu created at 2010-01-31 01:37:25

I'm moving this to "needs work" until all changes have been checked in.


---

Comment by mvngu created at 2010-01-31 01:37:25

Changing status from needs_review to needs_work.


---

Comment by mvngu created at 2010-01-31 02:03:07

Here's an updated spkg 

http://boxen.math.washington.edu/home/mvngu/patch/cddlib-094f.p4.spkg

which commits all outstanding changes in vbraun's name. In this updated spkg, I inserted the following line in spkg-install:

```
[mvngu`@`mod cddlib-094f.p4]$ hg diff
diff -r 499a1b5d0357 spkg-install
--- a/spkg-install
+++ b/spkg-install
`@``@` -47,6 +47,9 `@``@`
 # See http://trac.sagemath.org/sage_trac/ticket/7818#comment:28
 unset RM
 
+# apply patches on top of pristine upstream release under src/
+patch
+
 cd src
 
 ./configure --prefix=$SAGE_LOCAL
```

This runs the function `patch()` in `spkg-install` so that the patching is done before configuring the upstream source under `src/`.


---

Comment by mvngu created at 2010-01-31 02:03:07

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2010-01-31 12:54:41

I didn't know that I had commit rights to the mercurial repository! Also, I thought that the patch function would be called automatically, but clearly it is not and spkg-install has to call it manually. I did not catch that error because I did not delete $SAGE_LOCAL/*/cdd* before force-reinstalling.

Testing the spkg properly, I now noticed that the main src/Makefile.m4 was not included in patches/, and other Makefile.am's were not copied to the right place.  Here is a fixed spkg:

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg

Also, changes now checked into hg repo.


---

Comment by mvngu created at 2010-01-31 22:48:28

Changing status from needs_review to positive_review.


---

Comment by mvngu created at 2010-01-31 22:48:28

Replying to [comment:8 vbraun]:
> I didn't know that I had commit rights to the mercurial repository! 

To some extent, any Sage developer has commit rights. The idea is that one puts one's username in any Mercurial patch. For spkg updates, all changes need to be checked in before submitting them for review. In this way, people know who did what and when. As for patches against the Sage library, a release manager would commit a patch using the username of the developer who wrote that patch. This process can be made easier if the developer puts their username on their patch. By username, this is understood as being a developer's real name, not the username for logging into the Trac server.




> Here is a fixed spkg:
> 
> http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg
> 
> Also, changes now checked into hg repo.

The updated spkg looks good. I longer see any binaries being moved to the script repository at `SAGE_ROOT/local/bin`. All doctests pass.


---

Comment by mvngu created at 2010-01-31 22:50:35

Merged [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg) in the standard spkg repository.


---

Comment by mvngu created at 2010-01-31 22:50:35

Resolution: fixed


---

Comment by mvngu created at 2010-02-01 05:02:27

This looks bad. I'm now getting a build error when forcing a re-installation of [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg):

```
[mvngu`@`mod sage-4.3.2.alpha0]$ ./sage -f http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg
<compile-messages>
cddcore.c:2072: error: expected ‘)’ before ‘lc’
cddcore.c:2084: error: expected ‘)’ before ‘prod’
make[1]: *** [cddcore.lo] Error 1
make[1]: Leaving directory `/scratch/mvngu/release/sage-4.3.2.alpha0/spkg/build/cddlib-094f.p4/src/lib-src-gmp'
make: *** [all-recursive] Error 1
Error building cddlib

real    0m17.132s
user    0m8.960s
sys     0m4.350s
sage: An error occurred while installing cddlib-094f.p4
```

I'm reopening this ticket and backing [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg) out of Sage 4.3.2.alpha1.


---

Comment by mvngu created at 2010-02-01 05:02:27

Resolution changed from fixed to 


---

Comment by mvngu created at 2010-02-01 05:02:27

Changing status from closed to new.


---

Comment by mvngu created at 2010-02-01 05:03:41

Changing status from new to needs_work.


---

Comment by vbraun created at 2010-02-01 13:15:46

Which architecture is that error on? Full messages log?

I dug around a bit and the autogenerated files were copied with `cp` instead of `cp -p`, which then tricks `make` into re-running some autotools. This might have been the problem, even though it shouldn't. Updated spkg is here:

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg


---

Attachment

install log for cddlib-094f.p4.spkg


---

Comment by mvngu created at 2010-02-01 19:13:04

Replying to [comment:13 vbraun]:
> Which architecture is that error on? Full messages log?
Here is some relevant information about the machine on which I tried to force a re-installation of the previous version of cddlib-094f.p4.spkg:

 * OS version: Ubuntu 8.04.3 LTS
 * Machine name: mod.math.washington.edu
 * Architecture: Intel(R) Xeon(R) CPU X7460 `@` 2.66GHz
 * 32/64 bit: 64-bit
 * RAM: 124 GB
 * Compiler: GCC 4.2.4

Even with the updated spkg you posted, forcing a re-installation also results in a build failure on the above machine. I have attached an install log.


---

Comment by vbraun created at 2010-02-01 21:14:59

The problem is that gmp/mpir headers are not found. On my machine, these are already installed in /usr/include, but not on mod.math.washington.edu. I was under the wrong impression that the sage build process would put $SAGE_LOCAL/include and $SAGE_LOCAL/lib at the beginning of CPPFLAGS and LDFLAGS, respectively. Apparently they need to be set manually in the spkg_install.

Here is an updated spkg that sets these *FLAGS correctly. To test it, I uninstalled gmp on my machine and could still build the cddlib spgk successfully.

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg


---

Comment by jsp created at 2010-02-02 15:20:13

Replying to [comment:15 vbraun]:

> 
> Here is an updated spkg that sets these *FLAGS correctly. To test it, I uninstalled gmp on my machine and could still build the cddlib spgk successfully.
> 
> http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg

This one fails with:



```
config.status: creating lib-src/Makefile
config.status: creating src/Makefile
config.status: creating lib-src-gmp/Makefile
config.status: creating src-gmp/Makefile
config.status: creating Makefile
config.status: executing depfiles commands
config.status: executing libtool commands
make: Fatal error in reader: Makefile, line 706: Unexpected end of line seen
Error building cddlib

real    0m3.070s
user    0m0.743s
sys     0m0.886s
sage: An error occurred while installing cddlib-094f.p4

```


On Open Solaris x64

Jaap


---

Comment by jsp created at 2010-02-02 16:02:34

Replying to [comment:16 jsp]:

> 
> On Open Solaris x64
> 




Sorry for the noise. This was due to a configuration error: no libtool in /usr/bin

On my Open Solaris in VirtualBox no such a problem. There are others!

Jaap


---

Attachment

Add cdd_both_reps/cdd_both_reps_gmp binaries to .hgignore.


---

Comment by mvngu created at 2010-02-03 19:48:21

I don't know how long it would take to positively review this ticket. So I have moved [cddlib-local-bin-hgignore.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/8115/cddlib-local-bin-hgignore.patch) over to #8179.


---

Comment by mvngu created at 2010-02-17 01:13:24

A reason why this ticket has been stalling is that we have been trying to do too many things at once. The original intention was to get `cddlib-094f.p2.spkg` into such a shape that there is a clear separation between Sage specific patches and upstream source. And also to use `cp` during the patching process. The updated package 

http://sage.math.washington.edu/home/mvngu/spkg/standard/cddlib/cddlib-094f.p3.spkg

does just the above two tasks. Once this spkg is in, we can open another ticket to tidy up cddlib. So only `cddlib-094f.p3.spkg` needs reviewing.


---

Comment by mvngu created at 2010-02-17 01:13:24

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2010-02-17 01:32:11

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2010-02-17 01:32:11

The .p3 will break polyhedra.py, please don't apply that. You need those two parts:


```
    # Required by sage.geometry.polyhedra
    cp patches/cdd_both_reps.c src/src/
    cp patches/cdd_both_reps.c src/src-gmp/
```


To actually compile these extra .c sources, you need the updated Makefile.am's and rerun autoconf/automake and keep track of the autogenerated files.

Can you be a bit clearer on what you want to separate out? Do you want a spkg with all updates and fixes except the libtools stuff? I can split that out but I don't quite see the point. We'd have to test one new set of autotools-files and then, with the shared library update, trash those autogenerated files and try yet another set of autogenerated files.


---

Comment by mvngu created at 2010-02-17 01:46:48

Now I'm looking at [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg). I'm getting this:

```
[mvngu`@`sage cddlib-094f.p4]$ hg st
! patches/autogenerated/configure.ac
```



---

Comment by vbraun created at 2010-02-17 12:18:46

Sorry I forgot to commit that change; Fixed now.

Since configure.ac is one of the autotools source files, it belongs into patches/ and not into patches/autogenerated.


---

Comment by vbraun created at 2010-02-17 12:18:46

Changing status from needs_work to needs_review.


---

Comment by mvngu created at 2010-02-17 14:51:29

Replying to [comment:24 vbraun]:
> Sorry I forgot to commit that change; Fixed now.

Where is the updated spkg. I assume that this is the updated spkg:

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg

But that one still gives:


```
[mvngu`@`sage cddlib-094f.p4]$ hg st
! patches/autogenerated/configure.ac
```



---

Comment by vbraun created at 2010-02-17 15:38:11

Oops. Copied updated spgk to

http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg


---

Comment by mvngu created at 2010-02-17 20:57:03

Changing status from needs_review to positive_review.


---

Comment by mvngu created at 2010-02-17 20:57:03

The package [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg) now builds on sage.math, bsd.math, rosemary.math, and machines on Skynet.


---

Comment by mvngu created at 2010-02-17 20:58:34

Merged [cddlib-094f.p4.spkg](http://www.stp.dias.ie/~vbraun/cddlib-094f.p4.spkg) in the standard spkg repository.


---

Comment by mvngu created at 2010-02-17 20:58:34

Resolution: fixed


---

Comment by dimpase created at 2010-04-20 13:04:41

Guys, it would be good to know how to do changes in this  framework of patches you created.
The current problem with this spkg is that gmp must be in $SAGE_LOCAL, and not in /usr/local
This stops the thing building on Solaris, see [http://groups.google.com/group/sage-release/msg/35b0c600a5ef250f](http://groups.google.com/group/sage-release/msg/35b0c600a5ef250f) and other messages in this thread.
And gmpdir=/usr/local is hardwired in Makefile.am...

Thanks,
Dima


---

Comment by vbraun created at 2010-04-20 17:31:47

Dima, this ticket has already been closed. I created a new ticket with your problem at #8730, and will post updated spkg there.
