# Issue 21387: Better debug mode for singular 4

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2016-10-03 10:03:45

CC:  embray

This is a follow up to #17254 which upgraded to singular 4:
*debug (with xalloc) build on OS X (om_Info gets undefined (U) in Singular, note that it is ok on linux (B), maybe depends on ocmpiler, linker vesions)
*failing test in debug mode


---

Comment by vbraun created at 2016-10-21 07:03:05


```
24524sage -t --long src/sage/algebras/free_algebra.py  # 4 doctests failed
24525sage -t --long src/sage/algebras/letterplace/free_algebra_element_letterplace.pyx  # 6 doctests failed
24526sage -t --long src/sage/algebras/letterplace/free_algebra_letterplace.pyx  # 2 doctests failed
24527sage -t --long src/sage/algebras/letterplace/letterplace_ideal.pyx  # 10 doctests failed
24528sage -t --long src/sage/rings/quotient_ring.py  # 18 doctests failed
24529sage -t --long src/sage/rings/quotient_ring_element.py  # 1 doctest failed
24530sage -t --long src/sage/schemes/curves/constructor.py  # 1 doctest failed
```



---

Comment by jdemeyer created at 2016-10-21 09:40:43

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2016-10-21 09:40:43

Changing type from enhancement to defect.


---

Comment by jpflori created at 2016-10-28 12:25:13

All of these errors look like:

```
    // ***dPolyReportError: NULL coef 
     occurred at
     occurred for poly: o*x*y*x_1*y_1*x_2
    // ***dPolyReportError: NULL coef 
     occurred at
     occurred for poly: o*y*x_1*y_1*x_2
    // ***dError: S_2_R[2]=1 != T[1].i_r=0
    -y*z*x - y*z*y - y*z*z
```

except for the last one:

```

File "src/sage/schemes/curves/constructor.py", line 108, in sage.schemes.curves.constructor.Curve
Failed example:
    C.genus()
Expected:
    13
Got:
    // ** no minpoly allowed if there are local objects belonging to the basering: 
    number((a2+a+1))
    // ** killing a local object due to minpoly change: p
    // ** no minpoly allowed if there are local objects belonging to the basering: 
    number((a2-a+1))
    // ** killing a local object due to minpoly change: p
    13
```

> 24528sage -t --long src/sage/rings/quotient_ring.py  # 18 doctests failed
> 24529sage -t --long src/sage/rings/quotient_ring_element.py  # 1 doctest failed
> 24530sage -t --long src/sage/schemes/curves/constructor.py  # 1 doctest failed
> }}}


---

Comment by jpflori created at 2016-10-28 14:33:08

Thread about first issue here:
* https://groups.google.com/forum/#!topic/libsingular-devel/TPZNlvZXei0


---

Comment by jpflori created at 2016-10-31 13:19:08

And the second one here:
* https://groups.google.com/forum/#!topic/libsingular-devel/tYuWlGOZdWo


---

Comment by vbraun created at 2016-11-02 19:19:07

With #21631 there are now also many

```
 // ***dError: assume violation at numbers.cc:426 condition: n->cfCoeffName!=ndCoeffName
```

warnings, though no crashes.


---

Comment by jpflori created at 2016-11-03 11:21:42

Can you tell in which file it is?


---

Comment by jpflori created at 2016-11-03 12:19:32

Ok, got it.


---

Comment by jpflori created at 2016-12-21 13:50:12

See ##21865 for new errors occurring only in debug mode in:
* sage/rings/cfinite_sequence.py
* sage/matrix/matrix_modn_dense_template.pxi


---

Comment by jakobkroeker created at 2017-01-31 21:24:01

the last issue ( "no minpoly allowed..") can be fixed with

https://github.com/Singular/Sources/pull/814
(avoids intermediate object between ring declaration and minpoly definition in 'normal.lib')

Did you get answers from Hans for the other issues?
Or, could you track them down?


Replying to [comment:4 jpflori]:
> All of these errors look like:
> {{{
>     // ***dPolyReportError: NULL coef 
>      occurred at
>      occurred for poly: o*x*y*x_1*y_1*x_2
>     // ***dPolyReportError: NULL coef 
>      occurred at
>      occurred for poly: o*y*x_1*y_1*x_2
>     // ***dError: S_2_R[2]=1 != T[1].i_r=0
>     -y*z*x - y*z*y - y*z*z
> }}}
> except for the last one:
> {{{
> 
> File "src/sage/schemes/curves/constructor.py", line 108, in sage.schemes.curves.constructor.Curve
> Failed example:
>     C.genus()
> Expected:
>     13
> Got:
>     // ** no minpoly allowed if there are local objects belonging to the basering: 
>     number((a2+a+1))
>     // ** killing a local object due to minpoly change: p
>     // ** no minpoly allowed if there are local objects belonging to the basering: 
>     number((a2-a+1))
>     // ** killing a local object due to minpoly change: p
>     13
> }}}
> > 24528sage -t --long src/sage/rings/quotient_ring.py  # 18 doctests failed
> > 24529sage -t --long src/sage/rings/quotient_ring_element.py  # 1 doctest failed
> > 24530sage -t --long src/sage/schemes/curves/constructor.py  # 1 doctest failed
> > }}}


---

Comment by jakobkroeker created at 2017-01-31 21:47:52

Replying to [comment:7 vbraun]:
> With #21631 there are now also many
> {{{
>  // ***dError: assume violation at numbers.cc:426 condition: n->cfCoeffName!=ndCoeffName
> }}}
> warnings, though no crashes.

so changes in #21631 introduced a new issue?
Could someone track it down?


---

Comment by jpflori created at 2017-02-01 13:06:55

Replying to [comment:12 jakobkroeker]:
> Replying to [comment:7 vbraun]:
> > With #21631 there are now also many
> > {{{
> >  // ***dError: assume violation at numbers.cc:426 condition: n->cfCoeffName!=ndCoeffName
> > }}}
> > warnings, though no crashes.
> 
> so changes in #21631 introduced a new issue?
> Could someone track it down?
This has been fixed in Singular git version.


---

Comment by jpflori created at 2017-02-01 13:10:40

Replying to [comment:11 jakobkroeker]:
> the last issue ( "no minpoly allowed..") can be fixed with
> 
> https://github.com/Singular/Sources/pull/814
> (avoids intermediate object between ring declaration and minpoly definition in 'normal.lib')
> 
Good! It's even in Singular's git version now.

> Did you get answers from Hans for the other issues?
> Or, could you track them down?
> 
> 
> Replying to [comment:4 jpflori]:
> > All of these errors look like:
> > {{{
> >      occurred at
> >      occurred for poly: o*y*x_1*y_1*x_2
> >     // ***dError: S_2_R[2]=1 != T[1].i_r=0
> >     -y*z*x - y*z*y - y*z*z
> > }}}
Those like this were still present last time I checked and those about stuff not being where it belongs through kTest_L and kTest_TS as mentioned here:
* https://groups.google.com/d/msg/libsingular-devel/TPZNlvZXei0/CptSq0fdAgAJ
No feedback from Hans and I had no time to look at it.


---

Comment by jakobkroeker created at 2017-02-01 17:11:00

I just reminded Hans kindly to look at that issue since it is
a blocker ticket for sage.

https://groups.google.com/forum/#!msg/libsingular-devel/TPZNlvZXei0/CptSq0fdAgAJ

Let's see if something happens.



Replying to [comment:14 jpflori]:
> Replying to [comment:11 jakobkroeker]:
> > the last issue ( "no minpoly allowed..") can be fixed with
> > 
> > https://github.com/Singular/Sources/pull/814
> > (avoids intermediate object between ring declaration and minpoly definition in 'normal.lib')
> > 
> Good! It's even in Singular's git version now.
> 
> > Did you get answers from Hans for the other issues?
> > Or, could you track them down?
> > 
> > 
> > Replying to [comment:4 jpflori]:
> > > All of these errors look like:
> > > {{{
> > >      occurred at
> > >      occurred for poly: o*y*x_1*y_1*x_2
> > >     // ***dError: S_2_R[2]=1 != T[1].i_r=0
> > >     -y*z*x - y*z*y - y*z*z
> > > }}}
> Those like this were still present last time I checked and those about stuff not being where it belongs through kTest_L and kTest_TS as mentioned here:
> * https://groups.google.com/d/msg/libsingular-devel/TPZNlvZXei0/CptSq0fdAgAJ
> No feedback from Hans and I had no time to look at it.


---

Comment by jpflori created at 2017-02-21 10:46:24

With the latest tarball for 4-1-0p2, debug mode should be clean:
* http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-0/


---

Comment by jakobkroeker created at 2017-03-08 00:58:24

Replying to [comment:16 jpflori]:
> With the latest tarball for 4-1-0p2, debug mode should be clean:
> * http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-0/

related singular commit is 
https://github.com/Singular/Sources/commit/54c80cb81ed58f166a023fc060f541e24ebd5892


---

Comment by jakobkroeker created at 2017-03-08 01:10:35

Replying to [comment:14 jpflori]:
> Replying to [comment:11 jakobkroeker]:
> > the last issue ( "no minpoly allowed..") can be fixed with
> > 
> > https://github.com/Singular/Sources/pull/814
> > (avoids intermediate object between ring declaration and minpoly definition in 'normal.lib')
> > 
> Good! It's even in Singular's git version now.

There are much more issues in Singular LIBs where the minpoly is not immediately defined (and lead to debug output) which are probably not hit by current sage tests, but in the long term they have all to be fixed:
https://github.com/jakobkroeker/test_singular/issues/243


---

Comment by embray created at 2017-03-23 12:55:44

Changing priority from blocker to major.


---

Comment by embray created at 2017-03-23 12:55:44

I think I'm seeing this too.  I almost always compile with `SAGE_DEBUG=yes` on Cygwin since I have to debug things so often, and I'm seeing lots of failures like this since the switch to Singular 4.  Going to recompile Singular in non-debug mode to confirm that it goes away.

(Also obviously this isn't a _blocker_ or it'd be fixed by now :)


---

Comment by embray created at 2017-03-23 14:43:35

Confirmed that rebuilding Singular and its dependents with `SAGE_DEBUG=no` fixed these failures for me.


---

Comment by jpflori created at 2017-04-03 11:41:22

`@`eric: does #22425 fixed the errors you saw?
I think we can close this one now #22425 is merged.


---

Comment by embray created at 2017-04-03 12:02:47

I don't think I've tried yet.  I'll test it and see.  Are you saying it should be fixed even with `SAGE_DEBUG=yes`?


---

Comment by jpflori created at 2017-04-03 12:04:37

All error messages specific to singular built in debug mode should not appear anymore.


---

Comment by jpflori created at 2017-04-25 11:20:30

Changing status from new to needs_review.


---

Comment by jpflori created at 2017-04-25 11:20:30

Should be ok since the latest singular upgrade.


---

Comment by vbraun created at 2017-04-25 17:36:43

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2017-04-25 17:36:43

I'm still getting this one

```
sage -t --long src/sage/interfaces/singular.py
**********************************************************************
File "src/sage/interfaces/singular.py", line 1523, in sage.interfaces.singular.SingularElement.sage_global_ring
Failed example:
    singular.eval('ring r5 = (complex,15,j),(a,b,c),dp')
Expected:
    ''
Got:
    '\n// ***dError: assume violation at numbers.cc:434 condition: n->cfCoeffName!=ndCoeffName'
**********************************************************************
1 item had failures:
   1 of  22 in sage.interfaces.singular.SingularElement.sage_global_ring
    [390 tests, 1 failure, 10.81 s]
```



---

Comment by jpflori created at 2017-04-25 17:39:17

Maybe #22868.
Did not check debug mode there.


---

Comment by jpflori created at 2017-04-26 08:49:45

Unfortunately the failing test it is still here with 4.1.0p3.


---

Comment by jpflori created at 2017-04-27 10:17:56

Should be fixed in git version:
* https://github.com/Singular/Sources/commit/6af76a7a09a49e7e08065cdf078b2461e16af2eb

`@`volker: do you see any other failures?


---

Comment by vbraun created at 2017-04-29 23:27:45

These look a bit like they might be from Singular, haven't investigated further:

```
sage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 1761, in sage.rings.polynomial.multi_polynomial_ideal.?.interreduced_basis
Failed example:
    Ideal(P(0)).interreduced_basis()
Expected:
    [0]
Got:
    wrong mod p number 140727535500960 at modulop.cc,158
    [0]
**********************************************************************
1 item had failures:
   1 of  13 in sage.rings.polynomial.multi_polynomial_ideal.?.interreduced_basis
    [722 tests, 1 failure, 75.81 s]
sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_sequence.py", line 1022, in sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic.reduced
Failed example:
    Sequence([P(0)]).reduced()
Expected:
    [0]
Got:
    wrong mod p number 140727535505680 at modulop.cc,158
    [0]
**********************************************************************
1 item had failures:
   1 of  17 in sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic.reduced
    [235 tests, 1 failure, 14.47 s]
```



---

Comment by jpflori created at 2017-05-02 09:44:22

Error messages definitely from Singular, though it might be from bad input on Sage's side.
