# Issue 25023: Upgrade to NumPy 1.14.3

archive/issues_025023.json:
```json
{
    "body": "CC:  fbissey infinity0 jdemeyer slelievre epalezzato\n\nKeywords: upgrade, numpy\n\nNumPy 1.14.3 was released.\n\n- [NumPy releases](https://github.com/numpy/numpy/releases)\n\nOur last upgrade was to NumPy 1.13.3 in #24063.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25260\n\n",
    "created_at": "2018-04-29T10:51:30Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Upgrade to NumPy 1.14.3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25023",
    "user": "slelievre"
}
```
CC:  fbissey infinity0 jdemeyer slelievre epalezzato

Keywords: upgrade, numpy

NumPy 1.14.3 was released.

- [NumPy releases](https://github.com/numpy/numpy/releases)

Our last upgrade was to NumPy 1.13.3 in #24063.

Issue created by migration from https://trac.sagemath.org/ticket/25260





---

archive/issue_comments_352056.json:
```json
{
    "body": "For NumPy 1.13.3 we have the tarball in .zip, should we also use the .zip this time or the .tar.gz?",
    "created_at": "2018-04-29T23:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352056",
    "user": "slelievre"
}
```

For NumPy 1.13.3 we have the tarball in .zip, should we also use the .zip this time or the .tar.gz?



---

archive/issue_comments_352057.json:
```json
{
    "body": "We now support zip files I believe, so this is fine.",
    "created_at": "2018-04-29T23:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352057",
    "user": "fbissey"
}
```

We now support zip files I believe, so this is fine.



---

archive/issue_comments_352058.json:
```json
{
    "body": "If we support both kinds of archive, we should probably use the smallest one.",
    "created_at": "2018-04-30T05:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352058",
    "user": "jdemeyer"
}
```

If we support both kinds of archive, we should probably use the smallest one.



---

archive/issue_comments_352059.json:
```json
{
    "body": "I don't know how or if I can add changes here, but I have fixed the doctests for the numpy+scipy upgrade [here](https://github.com/timokau/nixpkgs/blob/276be14b387f7f8f98eba05ecddeccb5ec8b8ef7/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch).\n\nIts mostly formatting. Interesting bits:\n\n- [here](https://github.com/timokau/nixpkgs/blob/276be14b387f7f8f98eba05ecddeccb5ec8b8ef7/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch#L119) I avoid a numpy deprecation warning (empty array should not be used as false) by always making sure points is a regular array and then comparing its `len`.\n- the `iprint` kwarg in `fmin_cobyla` is [deprecated](https://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.optimize.fmin_cobyla.html) and repaced by `disp`\n\nEdit: I was a bit too fast and didn't test it properly. I'll post an updated version once thats tested.",
    "created_at": "2018-05-07T20:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352059",
    "user": "@timokau"
}
```

I don't know how or if I can add changes here, but I have fixed the doctests for the numpy+scipy upgrade [here](https://github.com/timokau/nixpkgs/blob/276be14b387f7f8f98eba05ecddeccb5ec8b8ef7/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch).

Its mostly formatting. Interesting bits:

- [here](https://github.com/timokau/nixpkgs/blob/276be14b387f7f8f98eba05ecddeccb5ec8b8ef7/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch#L119) I avoid a numpy deprecation warning (empty array should not be used as false) by always making sure points is a regular array and then comparing its `len`.
- the `iprint` kwarg in `fmin_cobyla` is [deprecated](https://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.optimize.fmin_cobyla.html) and repaced by `disp`

Edit: I was a bit too fast and didn't test it properly. I'll post an updated version once thats tested.



---

archive/issue_comments_352060.json:
```json
{
    "body": "I have [updated the patch](https://github.com/timokau/nixpkgs/blob/eeee5439e8e43bc9a6c31441440de675e16767e8/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch).\nThe doctests should pass now.",
    "created_at": "2018-05-08T19:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352060",
    "user": "@timokau"
}
```

I have [updated the patch](https://github.com/timokau/nixpkgs/blob/eeee5439e8e43bc9a6c31441440de675e16767e8/pkgs/applications/science/math/sage/patches/numpy-1.14.3.patch).
The doctests should pass now.



---

archive/issue_comments_352061.json:
```json
{
    "body": "Changing target from Numpy 1.14.3 to 1.14.4.",
    "created_at": "2018-06-10T10:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352061",
    "user": "slelievre"
}
```

Changing target from Numpy 1.14.3 to 1.14.4.



---

archive/issue_comments_352062.json:
```json
{
    "body": "I updated the package and applied my doctest fixes. `make ptestlong` passes.\n----\nNew commits:",
    "created_at": "2018-07-08T20:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352062",
    "user": "@timokau"
}
```

I updated the package and applied my doctest fixes. `make ptestlong` passes.
----
New commits:



---

archive/issue_comments_352063.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-08T20:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352063",
    "user": "@timokau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352064.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-25T15:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352064",
    "user": "slelievre"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_352065.json:
```json
{
    "body": "Numpy 1.15.0 just came out.",
    "created_at": "2018-07-25T15:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352065",
    "user": "slelievre"
}
```

Numpy 1.15.0 just came out.



---

archive/issue_comments_352066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-05T23:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352066",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352067.json:
```json
{
    "body": "I've done most of the upgrade, but two failures in `src/sage/plot/histogram.py` remain. I think both are rooted in the following issue:\n\n\n```\n> import numpy\n> numpy.histogram([], range=(1.0,1.0))\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-05b803a2f80b> in <module>()\n----> 1 numpy.histogram([], range=(RealNumber('1.0'),RealNumber('1.0')))\n\n/home/timo/repos/sage/local/lib/python2.7/site-packages/numpy/lib/histograms.pyc in histogram(a, bins, range, normed, weights, density)\n    674     a, weights = _ravel_and_check_weights(a, weights)\n    675 \n--> 676     bin_edges, uniform_bins = _get_bin_edges(a, bins, range, weights)\n    677 \n    678     # Histogram is an integer or a float array depending on the weights.\n\n/home/timo/repos/sage/local/lib/python2.7/site-packages/numpy/lib/histograms.pyc in _get_bin_edges(a, bins, range, weights)\n    342         # shapes. To avoid this causing problems, we pick a type now and stick\n    343         # with it throughout.\n--> 344         bin_type = np.result_type(first_edge, last_edge, a)\n    345         if np.issubdtype(bin_type, np.integer):\n    346             bin_type = np.result_type(bin_type, float)\n\nTypeError: data type not understood\n```\n\n\nThis does not happen outside of sage. It probably has something to do with sages custom number types.",
    "created_at": "2018-08-05T23:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352067",
    "user": "@timokau"
}
```

I've done most of the upgrade, but two failures in `src/sage/plot/histogram.py` remain. I think both are rooted in the following issue:


```
> import numpy
> numpy.histogram([], range=(1.0,1.0))

TypeError                                 Traceback (most recent call last)
<ipython-input-2-05b803a2f80b> in <module>()
----> 1 numpy.histogram([], range=(RealNumber('1.0'),RealNumber('1.0')))

/home/timo/repos/sage/local/lib/python2.7/site-packages/numpy/lib/histograms.pyc in histogram(a, bins, range, normed, weights, density)
    674     a, weights = _ravel_and_check_weights(a, weights)
    675 
--> 676     bin_edges, uniform_bins = _get_bin_edges(a, bins, range, weights)
    677 
    678     # Histogram is an integer or a float array depending on the weights.

/home/timo/repos/sage/local/lib/python2.7/site-packages/numpy/lib/histograms.pyc in _get_bin_edges(a, bins, range, weights)
    342         # shapes. To avoid this causing problems, we pick a type now and stick
    343         # with it throughout.
--> 344         bin_type = np.result_type(first_edge, last_edge, a)
    345         if np.issubdtype(bin_type, np.integer):
    346             bin_type = np.result_type(bin_type, float)

TypeError: data type not understood
```


This does not happen outside of sage. It probably has something to do with sages custom number types.



---

archive/issue_comments_352068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-24T00:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352068",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352069.json:
```json
{
    "body": "I haven't run full doctests but this fixes the issues in `histogram.py`.",
    "created_at": "2018-08-24T00:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352069",
    "user": "saraedum"
}
```

I haven't run full doctests but this fixes the issues in `histogram.py`.



---

archive/issue_comments_352070.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-24T00:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352070",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352071.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-24T08:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352071",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_352072.json:
```json
{
    "body": "Avoid `map`, it's bad for Python 3 compatibility. Replace `map(float, options['range'])` -> `[float(x) for x in options['range']]` (which is also more readable to non-mathematicians)",
    "created_at": "2018-08-24T08:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352072",
    "user": "jdemeyer"
}
```

Avoid `map`, it's bad for Python 3 compatibility. Replace `map(float, options['range'])` -> `[float(x) for x in options['range']]` (which is also more readable to non-mathematicians)



---

archive/issue_comments_352073.json:
```json
{
    "body": "Mixing `abs tol` and `...` is messy, it should be sufficient to use only `abs tol` here:\n\n```\n            sage: p = P[0]; p.ydata  # abs tol 1e-8\n            [0.0, 0.0, -0.211524990023434..., -0.211524990023434..., 0.244978663126864..., 0.244978663126864..., -0.149106180027477..., -0.149106180027477...]\n```\n",
    "created_at": "2018-08-24T08:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352073",
    "user": "jdemeyer"
}
```

Mixing `abs tol` and `...` is messy, it should be sufficient to use only `abs tol` here:

```
            sage: p = P[0]; p.ydata  # abs tol 1e-8
            [0.0, 0.0, -0.211524990023434..., -0.211524990023434..., 0.244978663126864..., 0.244978663126864..., -0.149106180027477..., -0.149106180027477...]
```




---

archive/issue_comments_352074.json:
```json
{
    "body": "Needs rebase to 8.4.beta2.\n\nAlso don't forget your name as Author.",
    "created_at": "2018-08-26T07:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352074",
    "user": "jdemeyer"
}
```

Needs rebase to 8.4.beta2.

Also don't forget your name as Author.



---

archive/issue_comments_352075.json:
```json
{
    "body": "In the meantime 1.15.1 was also released.",
    "created_at": "2018-08-28T14:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352075",
    "user": "@bryangingechen"
}
```

In the meantime 1.15.1 was also released.



---

archive/issue_comments_352076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-01T08:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352076",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352077.json:
```json
{
    "body": "I fixed the merge conflict (in sage/plot/histogram.py due to the upgrade to matplotlib in #25702) and I bumped the version to 1.15.1. \n\nThere's one remaining failing doctest in histogram.py: #25702 added a test for the function `get_minmax_data` with the deprecated `normed` option. As of 1.15.0, numpy spits out a DeprecationWarning and I don't know the standard way to deal with this.",
    "created_at": "2018-09-01T08:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352077",
    "user": "@bryangingechen"
}
```

I fixed the merge conflict (in sage/plot/histogram.py due to the upgrade to matplotlib in #25702) and I bumped the version to 1.15.1. 

There's one remaining failing doctest in histogram.py: #25702 added a test for the function `get_minmax_data` with the deprecated `normed` option. As of 1.15.0, numpy spits out a DeprecationWarning and I don't know the standard way to deal with this.



---

archive/issue_comments_352078.json:
```json
{
    "body": "Thanks! Can't you just switch it to use the `density` option?",
    "created_at": "2018-09-01T11:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352078",
    "user": "@timokau"
}
```

Thanks! Can't you just switch it to use the `density` option?



---

archive/issue_comments_352079.json:
```json
{
    "body": "Replying to [comment:23 gh-timokau]:\n> Thanks! Can't you just switch it to use the `density` option?\nThe point of the test seems to be to check the `normed` option; note that the first example in the docstring is essentially identical except it uses `density`.\n\nI thought about just deleting the test, but I figured I'd ask first.",
    "created_at": "2018-09-01T13:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352079",
    "user": "@bryangingechen"
}
```

Replying to [comment:23 gh-timokau]:
> Thanks! Can't you just switch it to use the `density` option?
The point of the test seems to be to check the `normed` option; note that the first example in the docstring is essentially identical except it uses `density`.

I thought about just deleting the test, but I figured I'd ask first.



---

archive/issue_comments_352080.json:
```json
{
    "body": "`@`epalezzato since you authored #25702, why did you add that test testing the `normed` argument?",
    "created_at": "2018-09-02T21:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352080",
    "user": "@timokau"
}
```

`@`epalezzato since you authored #25702, why did you add that test testing the `normed` argument?



---

archive/issue_comments_352081.json:
```json
{
    "body": "The new way is to use the `density` option, but Sage wants to give its users some time\nto adapt, so keeps `normed` working but with a deprecation warning.\n\nThe test should check that the deprecation warning works. Please adapt it to do that.\n\nFor examples of deprecation warnings in doctests, see:\n\nhttps://github.com/sagemath/sage/search?q=deprecationwarning\n\nAfter a year, the deprecated stuff can be removed.",
    "created_at": "2018-09-02T22:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352081",
    "user": "slelievre"
}
```

The new way is to use the `density` option, but Sage wants to give its users some time
to adapt, so keeps `normed` working but with a deprecation warning.

The test should check that the deprecation warning works. Please adapt it to do that.

For examples of deprecation warnings in doctests, see:

https://github.com/sagemath/sage/search?q=deprecationwarning

After a year, the deprecated stuff can be removed.



---

archive/issue_comments_352082.json:
```json
{
    "body": "I ran into an annoying interaction between `rel tol` and `...` in the doctesting framework while trying to fix up the test. Reported as #26183.\n\nFor now I will try to work around it by making the test a little cruder.",
    "created_at": "2018-09-03T02:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352082",
    "user": "@bryangingechen"
}
```

I ran into an annoying interaction between `rel tol` and `...` in the doctesting framework while trying to fix up the test. Reported as #26183.

For now I will try to work around it by making the test a little cruder.



---

archive/issue_comments_352083.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-03T02:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352083",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352084.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-03T02:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352084",
    "user": "@bryangingechen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352085.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-03T02:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352085",
    "user": "@bryangingechen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_352086.json:
```json
{
    "body": "Oops, I haven't addressed comments 16 and 17 yet.",
    "created_at": "2018-09-03T02:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352086",
    "user": "@bryangingechen"
}
```

Oops, I haven't addressed comments 16 and 17 yet.



---

archive/issue_comments_352087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-03T02:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352087",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352088.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-03T02:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352088",
    "user": "@bryangingechen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352089.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-03T10:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352089",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_352090.json:
```json
{
    "body": "`if options.get('range', None)` : do you mean `if 'range' in options`?",
    "created_at": "2018-09-03T10:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352090",
    "user": "jdemeyer"
}
```

`if options.get('range', None)` : do you mean `if 'range' in options`?



---

archive/issue_comments_352091.json:
```json
{
    "body": "I'm not convinced about\n\n```\n        if 'normed' in options:\n            from sage.misc.superseded import deprecation\n            deprecation(25260, \"the 'normed' option is deprecated. Use 'density' instead.\")\n```\n\nbecause it's essentially copying a deprecation warning that numpy already gives.",
    "created_at": "2018-09-03T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352091",
    "user": "jdemeyer"
}
```

I'm not convinced about

```
        if 'normed' in options:
            from sage.misc.superseded import deprecation
            deprecation(25260, "the 'normed' option is deprecated. Use 'density' instead.")
```

because it's essentially copying a deprecation warning that numpy already gives.



---

archive/issue_comments_352092.json:
```json
{
    "body": "And I'm also not convinced about\n\n```\n    points = list(points) # make sure points is a python list\n```\n\n\nWhy was that added?",
    "created_at": "2018-09-03T10:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352092",
    "user": "jdemeyer"
}
```

And I'm also not convinced about

```
    points = list(points) # make sure points is a python list
```


Why was that added?



---

archive/issue_comments_352093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-03T14:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352093",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352094.json:
```json
{
    "body": "Thanks for the quick feedback!\n\nReplying to [comment:33 jdemeyer]:\n>if `options.get('range', None)` : do you mean `if 'range' in options`? \n\n`if 'range' in options:` does not work, since that also triggers upon passing `range=None` (which is the default).\n\nReplying to [comment:34 jdemeyer]:\n> I'm not convinced about\n> {{{\n>         if 'normed' in options:\n>             from sage.misc.superseded import deprecation\n>             deprecation(25260, \"the 'normed' option is deprecated. Use 'density' instead.\")\n> }}}\n> because it's essentially copying a deprecation warning that numpy already gives.\nWhat do you suggest? numpy / matplot (which do indeed also throw deprecation warnings) aren't called until either `_render_on_subplot` or `get_minmax_data` are run. I wanted to give the user a notice when they construct the initial `Histogram` object.\n\nReplying to [comment:34 jdemeyer]:\n>And I'm also not convinced about\n>{{{\n>    points = list(points) # make sure points is a python list\n>}}}\n>Why was that added?\n\n`points = list(points)` is necessary to properly treat the case when `points` is a generator or other non-list iterable. Note the test `line(enumerate(range(2)), marker = 'o', legend_label='a')` at line 498 which was apparently added for unrelated reasons in #13690.\n\nI made a change to a string which stated that `normed` was a deprecated alias for `density`. Strictly speaking, `normed` has different (incorrect) behavior from `density` [when constructing a histogram with non-uniform bars](https://github.com/numpy/numpy/blob/5adb81051086a45fe3b59ba506b567340ec9bd5e/numpy/lib/histograms.py#L818).\n----\nNew commits:\n----\nNew commits:",
    "created_at": "2018-09-03T14:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352094",
    "user": "@bryangingechen"
}
```

Thanks for the quick feedback!

Replying to [comment:33 jdemeyer]:
>if `options.get('range', None)` : do you mean `if 'range' in options`? 

`if 'range' in options:` does not work, since that also triggers upon passing `range=None` (which is the default).

Replying to [comment:34 jdemeyer]:
> I'm not convinced about
> {{{
>         if 'normed' in options:
>             from sage.misc.superseded import deprecation
>             deprecation(25260, "the 'normed' option is deprecated. Use 'density' instead.")
> }}}
> because it's essentially copying a deprecation warning that numpy already gives.
What do you suggest? numpy / matplot (which do indeed also throw deprecation warnings) aren't called until either `_render_on_subplot` or `get_minmax_data` are run. I wanted to give the user a notice when they construct the initial `Histogram` object.

Replying to [comment:34 jdemeyer]:
>And I'm also not convinced about
>{{{
>    points = list(points) # make sure points is a python list
>}}}
>Why was that added?

`points = list(points)` is necessary to properly treat the case when `points` is a generator or other non-list iterable. Note the test `line(enumerate(range(2)), marker = 'o', legend_label='a')` at line 498 which was apparently added for unrelated reasons in #13690.

I made a change to a string which stated that `normed` was a deprecated alias for `density`. Strictly speaking, `normed` has different (incorrect) behavior from `density` [when constructing a histogram with non-uniform bars](https://github.com/numpy/numpy/blob/5adb81051086a45fe3b59ba506b567340ec9bd5e/numpy/lib/histograms.py#L818).
----
New commits:
----
New commits:



---

archive/issue_comments_352095.json:
```json
{
    "body": "Replying to [comment:37 gh-bryangingechen]:\n> Replying to [comment:34 jdemeyer]:\n> > I'm not convinced about\n> > {{{\n> >         if 'normed' in options:\n> >             from sage.misc.superseded import deprecation\n> >             deprecation(25260, \"the 'normed' option is deprecated. Use 'density' instead.\")\n> > }}}\n> > because it's essentially copying a deprecation warning that numpy already gives.\n> What do you suggest? numpy / matplot (which do indeed also throw deprecation warnings) aren't called until either `_render_on_subplot` or `get_minmax_data` are run. I wanted to give the user a notice when they construct the initial `Histogram` object.\n\nI'm also in favor of throwing our own deprecation warning. That we're using numpy under the hood is an implementation detail. This way we have more control.",
    "created_at": "2018-09-06T14:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352095",
    "user": "@timokau"
}
```

Replying to [comment:37 gh-bryangingechen]:
> Replying to [comment:34 jdemeyer]:
> > I'm not convinced about
> > {{{
> >         if 'normed' in options:
> >             from sage.misc.superseded import deprecation
> >             deprecation(25260, "the 'normed' option is deprecated. Use 'density' instead.")
> > }}}
> > because it's essentially copying a deprecation warning that numpy already gives.
> What do you suggest? numpy / matplot (which do indeed also throw deprecation warnings) aren't called until either `_render_on_subplot` or `get_minmax_data` are run. I wanted to give the user a notice when they construct the initial `Histogram` object.

I'm also in favor of throwing our own deprecation warning. That we're using numpy under the hood is an implementation detail. This way we have more control.



---

archive/issue_comments_352096.json:
```json
{
    "body": "This is positive_review from me, pending Jeroen's judgement on the deprecation warning. Jeroen, would you mind commenting on that?",
    "created_at": "2018-09-07T15:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352096",
    "user": "@timokau"
}
```

This is positive_review from me, pending Jeroen's judgement on the deprecation warning. Jeroen, would you mind commenting on that?



---

archive/issue_comments_352097.json:
```json
{
    "body": "I don't have a strong opinion on the deprecation warning, I was mostly just commenting.\n\nHowever, `points = list(points)` is still wrong! The docs for `line2d` state\n\n```\n    -  ``points`` - either a single point (as a tuple), a list of\n       points, a single complex number, or a list of complex numbers.\n```\n\nIt's not at all clear to me that calling `list()` on a single point or a single complex number is the right thing to do.",
    "created_at": "2018-09-08T09:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352097",
    "user": "jdemeyer"
}
```

I don't have a strong opinion on the deprecation warning, I was mostly just commenting.

However, `points = list(points)` is still wrong! The docs for `line2d` state

```
    -  ``points`` - either a single point (as a tuple), a list of
       points, a single complex number, or a list of complex numbers.
```

It's not at all clear to me that calling `list()` on a single point or a single complex number is the right thing to do.



---

archive/issue_comments_352098.json:
```json
{
    "body": "If it helps \"to properly treat the case when points is a generator or other non-list iterable\" (quote gh-bryangingechen) and doesn't make a difference in the case of a single point, why not?",
    "created_at": "2018-09-08T09:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352098",
    "user": "@timokau"
}
```

If it helps "to properly treat the case when points is a generator or other non-list iterable" (quote gh-bryangingechen) and doesn't make a difference in the case of a single point, why not?



---

archive/issue_comments_352099.json:
```json
{
    "body": "Replying to [comment:41 gh-timokau]:\n> doesn't make a difference in the case of a single point\n\nAre you sure about this part?",
    "created_at": "2018-09-08T13:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352099",
    "user": "jdemeyer"
}
```

Replying to [comment:41 gh-timokau]:
> doesn't make a difference in the case of a single point

Are you sure about this part?



---

archive/issue_comments_352100.json:
```json
{
    "body": "I have to admit I'm not. gh-bryangingechen, do you know more?",
    "created_at": "2018-09-08T13:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352100",
    "user": "@timokau"
}
```

I have to admit I'm not. gh-bryangingechen, do you know more?



---

archive/issue_comments_352101.json:
```json
{
    "body": "Hi, thanks for pushing back on this. The code from this ticket indeed works fine with a single point (entered as a tuple, list, or a list containing a single tuple or single list, etc.). \n\nHowever, in the course of testing this, I realized that I did not completely understand the addition of `points = list(points)` in `line2d()` and my answer above to Jeroen was incorrect. Note that this line was actually added by gh-timokau [here](https://git.sagemath.org/sage.git/diff/src/sage/plot/line.py?id=3322ff1a1446cc5d0b8b34b6f7203250df0bdd5c), so I should probably have deferred to him to explain it. \n\nAnyways, here's what I think now. The real reason this line was added was to properly treat `line(numpy.array([]))` (which is one of the doctests). The previous version of `line2d` used the more pythonic-looking `if not points:` to detect \"no points\". As of numpy 1.15, the truth value of `numpy.array([])` is still `False`, but it returns a DeprecationWarning that this behavior will be removed.\n\nSo to get around this, gh-timokau replaced `if not points:` with the `points = list(points)` and `if len(points) == 0`.\n\nTwo observations:\n\n- The test `if points in CC or points in CDF:` now always fails.\n\n- `xydata_from_point_list()` [already has this](https://github.com/sagemath/sage/blob/e8633b09919542a65e7e990c8369fee30c7edefd/src/sage/plot/plot.py#L777):\n\n```\nif not isinstance(points, (list, tuple)):\n    points = list(points)\n```\n\n\nFor the first point, I think we should just remove this test altogether, since it looks like it was originally there to catch some edge cases for `if not points:` (e.g. `points=CC(0)`). One somewhat related thing that I noticed was that symbolic complex input is not handled well: `line([1+I,I])` doesn't work but `line([CC(1+I),CC(I)])` does. Maybe this should be dealt with in another ticket for `xydata_from_point_list` though.\n\nThe second point gives me pause. Is there a cleaner way to detect both an empty list and an empty numpy array in `line2d`? I'd appreciate suggestions, as I don't see anything nice at the moment. It does seem like [dealing with empty numpy arrays](https://stackoverflow.com/a/9381545/) is a common pain point. \n\nThe current code does work so we could also just go with what we have.",
    "created_at": "2018-09-09T00:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352101",
    "user": "@bryangingechen"
}
```

Hi, thanks for pushing back on this. The code from this ticket indeed works fine with a single point (entered as a tuple, list, or a list containing a single tuple or single list, etc.). 

However, in the course of testing this, I realized that I did not completely understand the addition of `points = list(points)` in `line2d()` and my answer above to Jeroen was incorrect. Note that this line was actually added by gh-timokau [here](https://git.sagemath.org/sage.git/diff/src/sage/plot/line.py?id=3322ff1a1446cc5d0b8b34b6f7203250df0bdd5c), so I should probably have deferred to him to explain it. 

Anyways, here's what I think now. The real reason this line was added was to properly treat `line(numpy.array([]))` (which is one of the doctests). The previous version of `line2d` used the more pythonic-looking `if not points:` to detect "no points". As of numpy 1.15, the truth value of `numpy.array([])` is still `False`, but it returns a DeprecationWarning that this behavior will be removed.

So to get around this, gh-timokau replaced `if not points:` with the `points = list(points)` and `if len(points) == 0`.

Two observations:

- The test `if points in CC or points in CDF:` now always fails.

- `xydata_from_point_list()` [already has this](https://github.com/sagemath/sage/blob/e8633b09919542a65e7e990c8369fee30c7edefd/src/sage/plot/plot.py#L777):

```
if not isinstance(points, (list, tuple)):
    points = list(points)
```


For the first point, I think we should just remove this test altogether, since it looks like it was originally there to catch some edge cases for `if not points:` (e.g. `points=CC(0)`). One somewhat related thing that I noticed was that symbolic complex input is not handled well: `line([1+I,I])` doesn't work but `line([CC(1+I),CC(I)])` does. Maybe this should be dealt with in another ticket for `xydata_from_point_list` though.

The second point gives me pause. Is there a cleaner way to detect both an empty list and an empty numpy array in `line2d`? I'd appreciate suggestions, as I don't see anything nice at the moment. It does seem like [dealing with empty numpy arrays](https://stackoverflow.com/a/9381545/) is a common pain point. 

The current code does work so we could also just go with what we have.



---

archive/issue_comments_352102.json:
```json
{
    "body": "Oh I forgot I added that, thanks for investigating :)\n\nI think `if not <something that is not a bool>` is an antipattern anyways, even if it still worked. If we don't want to change `points` to a list permanently, maybe we could just do `if len(list(points)) == 0` instead.",
    "created_at": "2018-09-09T20:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352102",
    "user": "@timokau"
}
```

Oh I forgot I added that, thanks for investigating :)

I think `if not <something that is not a bool>` is an antipattern anyways, even if it still worked. If we don't want to change `points` to a list permanently, maybe we could just do `if len(list(points)) == 0` instead.



---

archive/issue_comments_352103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-10T20:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352104.json:
```json
{
    "body": "Unfortunately, `if len(list(points)) == 0` breaks the `line(enumerate(range(2)), marker = 'o', legend_label='a')` test, since after spitting out all the values once, future calls to `list(points)` just return `[]`.\n\nThe commit I've just pushed simply removes the dead code and leaves `points = list(points)` and `if len(points) == 0:` alone. Since this does work and no better alternatives are coming to mind, I propose we just go with this.",
    "created_at": "2018-09-10T21:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352104",
    "user": "@bryangingechen"
}
```

Unfortunately, `if len(list(points)) == 0` breaks the `line(enumerate(range(2)), marker = 'o', legend_label='a')` test, since after spitting out all the values once, future calls to `list(points)` just return `[]`.

The commit I've just pushed simply removes the dead code and leaves `points = list(points)` and `if len(points) == 0:` alone. Since this does work and no better alternatives are coming to mind, I propose we just go with this.



---

archive/issue_comments_352105.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-10T21:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352105",
    "user": "@bryangingechen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352106.json:
```json
{
    "body": "Ah right. I now remember that I had the same problem.\n\n> Since this does work and no better alternatives are coming to mind, I propose we just go with this. \n\n+1 from me. Jeroen?",
    "created_at": "2018-09-10T21:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352106",
    "user": "@timokau"
}
```

Ah right. I now remember that I had the same problem.

> Since this does work and no better alternatives are coming to mind, I propose we just go with this. 

+1 from me. Jeroen?



---

archive/issue_comments_352107.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-23T17:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352107",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352108.json:
```json
{
    "body": "I've changed the target to 1.15.2, as that's just been released. Does anyone understand the numpy patches we have? They seem not to apply to this version and the build currently fails: \n\n\n```\n[numpy-1.15.2] Found local metadata for numpy-1.15.2\n[numpy-1.15.2] Using cached file /Applications/SageMath/upstream/numpy-1.15.2.tar.gz\n[numpy-1.15.2] numpy-1.15.2\n[numpy-1.15.2] ====================================================\n[numpy-1.15.2] Setting up build directory for numpy-1.15.2\n[numpy-1.15.2] Finished extraction\n[numpy-1.15.2] Applying patches from ../patches...\n[numpy-1.15.2] Applying ../patches/fix-numpy-1.13.3-for-python3.7.patch\n[numpy-1.15.2] patching file setup.py\n[numpy-1.15.2] Hunk #1 succeeded at 381 (offset 11 lines).\n[numpy-1.15.2] The next patch would create the file tools/cythonize.py,\n[numpy-1.15.2] which already exists!  Assume -R? [n]\n[numpy-1.15.2] Apply anyway? [n]\n[numpy-1.15.2] Skipping patch.\n[numpy-1.15.2] 1 out of 1 hunk ignored\n[numpy-1.15.2] Error applying '../patches/fix-numpy-1.13.3-for-python3.7.patch'\n[numpy-1.15.2] ************************************************************************\n[numpy-1.15.2] Error applying patches\n[numpy-1.15.2] ************************************************************************\n[numpy-1.15.2] Please email sage-devel (http://groups.google.com/group/sage-devel)\n[numpy-1.15.2] explaining the problem and including the log file\n[numpy-1.15.2]   /Applications/SageMath/logs/pkgs/numpy-1.15.2.log\n[numpy-1.15.2] Describe your computer, operating system, etc.\n[numpy-1.15.2] ************************************************************************\nmake[3]: *** [/Applications/SageMath/local/var/lib/sage/installed/numpy-1.15.2] Error 1\nmake[2]: *** [all-build] Error 2\n```\n\n\nI have no experience with patching so if someone wants fix this themselves rather than explain to me how to do it they're also welcome to do so.",
    "created_at": "2018-09-23T17:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352108",
    "user": "@bryangingechen"
}
```

I've changed the target to 1.15.2, as that's just been released. Does anyone understand the numpy patches we have? They seem not to apply to this version and the build currently fails: 


```
[numpy-1.15.2] Found local metadata for numpy-1.15.2
[numpy-1.15.2] Using cached file /Applications/SageMath/upstream/numpy-1.15.2.tar.gz
[numpy-1.15.2] numpy-1.15.2
[numpy-1.15.2] ====================================================
[numpy-1.15.2] Setting up build directory for numpy-1.15.2
[numpy-1.15.2] Finished extraction
[numpy-1.15.2] Applying patches from ../patches...
[numpy-1.15.2] Applying ../patches/fix-numpy-1.13.3-for-python3.7.patch
[numpy-1.15.2] patching file setup.py
[numpy-1.15.2] Hunk #1 succeeded at 381 (offset 11 lines).
[numpy-1.15.2] The next patch would create the file tools/cythonize.py,
[numpy-1.15.2] which already exists!  Assume -R? [n]
[numpy-1.15.2] Apply anyway? [n]
[numpy-1.15.2] Skipping patch.
[numpy-1.15.2] 1 out of 1 hunk ignored
[numpy-1.15.2] Error applying '../patches/fix-numpy-1.13.3-for-python3.7.patch'
[numpy-1.15.2] ************************************************************************
[numpy-1.15.2] Error applying patches
[numpy-1.15.2] ************************************************************************
[numpy-1.15.2] Please email sage-devel (http://groups.google.com/group/sage-devel)
[numpy-1.15.2] explaining the problem and including the log file
[numpy-1.15.2]   /Applications/SageMath/logs/pkgs/numpy-1.15.2.log
[numpy-1.15.2] Describe your computer, operating system, etc.
[numpy-1.15.2] ************************************************************************
make[3]: *** [/Applications/SageMath/local/var/lib/sage/installed/numpy-1.15.2] Error 1
make[2]: *** [all-build] Error 2
```


I have no experience with patching so if someone wants fix this themselves rather than explain to me how to do it they're also welcome to do so.



---

archive/issue_comments_352109.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-09-23T17:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352109",
    "user": "@bryangingechen"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_352110.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-23T21:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352110",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352111.json:
```json
{
    "body": "Replying to [comment:51 gh-bryangingechen]:\n> I have no experience with patching so if someone wants fix this themselves rather than explain to me how to do it they're also welcome to do so.\n\nA you can see in the first line of `$SAGE_ROOT/build/pkgs/numpy/patches/fix-numpy-1.13.3-for-python3.7.patch`, there is a link to https://github.com/numpy/numpy/issues/10500 which is now fixed (the patch or a similar one was applied upstream), so it sufice to remove that patch. I just did that and recompiled numpy and scipy, but did not run all doctests.",
    "created_at": "2018-09-23T21:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352111",
    "user": "tmonteil"
}
```

Replying to [comment:51 gh-bryangingechen]:
> I have no experience with patching so if someone wants fix this themselves rather than explain to me how to do it they're also welcome to do so.

A you can see in the first line of `$SAGE_ROOT/build/pkgs/numpy/patches/fix-numpy-1.13.3-for-python3.7.patch`, there is a link to https://github.com/numpy/numpy/issues/10500 which is now fixed (the patch or a similar one was applied upstream), so it sufice to remove that patch. I just did that and recompiled numpy and scipy, but did not run all doctests.



---

archive/issue_comments_352112.json:
```json
{
    "body": "By the way, both scipy and numpy offer self-tests using pytest), so we should add some `spkg-check` for them (not in that ticket).",
    "created_at": "2018-09-23T22:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352112",
    "user": "tmonteil"
}
```

By the way, both scipy and numpy offer self-tests using pytest), so we should add some `spkg-check` for them (not in that ticket).



---

archive/issue_comments_352113.json:
```json
{
    "body": "Thanks! For what it's worth, after your patch, all the tests seem to pass for me.",
    "created_at": "2018-09-24T00:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352113",
    "user": "@bryangingechen"
}
```

Thanks! For what it's worth, after your patch, all the tests seem to pass for me.



---

archive/issue_comments_352114.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-09-24T00:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352114",
    "user": "@bryangingechen"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_352115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-25T01:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352115",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352116.json:
```json
{
    "body": "They also pass for me. So I am setting this to a positive review.",
    "created_at": "2018-09-25T01:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352116",
    "user": "tscrim"
}
```

They also pass for me. So I am setting this to a positive review.



---

archive/issue_comments_352117.json:
```json
{
    "body": "This fails on kucalc (48-core linux 64-bit):\n\n```\n**********************************************************************\nFile \"src/sage/misc/inline_fortran.py\", line 134, in sage.misc.inline_fortran._import_module_from_path._import_module_from_path_impl\nFailed example:\n    fortran(code, globals())\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 659, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1070, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.inline_fortran._import_module_from_path._import_module_from_path_impl[1]>\", line 1, in <module>\n        fortran(code, globals())\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3759)\n        return self.get_object()(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/inline_fortran.py\", line 96, in __call__\n        return self.eval(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/inline_fortran.py\", line 200, in eval\n        log_string)\n    RuntimeError: failed to compile Fortran code:\n    Traceback (most recent call last):\n      File \"<string>\", line 1, in <module>\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/f2py/f2py2e.py\", line 648, in main\n        run_compile()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/f2py/f2py2e.py\", line 633, in run_compile\n        setup(ext_modules=[ext])\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/core.py\", line 169, in setup\n        return old_setup(**new_attr)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/core.py\", line 151, in setup\n        dist.run_commands()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py\", line 953, in run_commands\n        self.run_command(cmd)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py\", line 972, in run_command\n        cmd_obj.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build.py\", line 47, in run\n        old_build.run(self)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/command/build.py\", line 127, in run\n        self.run_command(cmd_name)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/cmd.py\", line 326, in run_command\n        self.distribution.run_command(command)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py\", line 972, in run_command\n        cmd_obj.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build_ext.py\", line 262, in run\n        self.build_extensions()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/command/build_ext.py\", line 449, in build_extensions\n        self.build_extension(ext)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build_ext.py\", line 380, in build_extension\n        **kws)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/ccompiler.py\", line 337, in CCompiler_compile\n        pool = multiprocessing.pool.ThreadPool(jobs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/multiprocessing/pool.py\", line 732, in __init__\n        Pool.__init__(self, processes, initializer, initargs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/multiprocessing/pool.py\", line 187, in __init__\n        self._result_handler.start()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/threading.py\", line 736, in start\n        _start_new_thread(self.__bootstrap, ())\n    thread.error: can't start new thread\n```\n\nSomething is wrong on high-cpu count machines, I think. Works on others.",
    "created_at": "2018-09-26T22:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352117",
    "user": "vbraun"
}
```

This fails on kucalc (48-core linux 64-bit):

```
**********************************************************************
File "src/sage/misc/inline_fortran.py", line 134, in sage.misc.inline_fortran._import_module_from_path._import_module_from_path_impl
Failed example:
    fortran(code, globals())
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.inline_fortran._import_module_from_path._import_module_from_path_impl[1]>", line 1, in <module>
        fortran(code, globals())
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3759)
        return self.get_object()(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/inline_fortran.py", line 96, in __call__
        return self.eval(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/inline_fortran.py", line 200, in eval
        log_string)
    RuntimeError: failed to compile Fortran code:
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/f2py/f2py2e.py", line 648, in main
        run_compile()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/f2py/f2py2e.py", line 633, in run_compile
        setup(ext_modules=[ext])
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/core.py", line 169, in setup
        return old_setup(**new_attr)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/core.py", line 151, in setup
        dist.run_commands()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py", line 953, in run_commands
        self.run_command(cmd)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py", line 972, in run_command
        cmd_obj.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build.py", line 47, in run
        old_build.run(self)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/command/build.py", line 127, in run
        self.run_command(cmd_name)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/cmd.py", line 326, in run_command
        self.distribution.run_command(command)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/dist.py", line 972, in run_command
        cmd_obj.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build_ext.py", line 262, in run
        self.build_extensions()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/distutils/command/build_ext.py", line 449, in build_extensions
        self.build_extension(ext)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/command/build_ext.py", line 380, in build_extension
        **kws)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/distutils/ccompiler.py", line 337, in CCompiler_compile
        pool = multiprocessing.pool.ThreadPool(jobs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/multiprocessing/pool.py", line 732, in __init__
        Pool.__init__(self, processes, initializer, initargs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/multiprocessing/pool.py", line 187, in __init__
        self._result_handler.start()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/threading.py", line 736, in start
        _start_new_thread(self.__bootstrap, ())
    thread.error: can't start new thread
```

Something is wrong on high-cpu count machines, I think. Works on others.



---

archive/issue_comments_352118.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-09-26T22:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352118",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_352119.json:
```json
{
    "body": "Any ideas how we could debug this? k8s has 48 cores so we could try to debug this there.\n\nI'll probably start by building there and running just the tests in `inline_fortran.py`. Maybe that's already enough to trigger the error.",
    "created_at": "2018-10-04T18:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352119",
    "user": "saraedum"
}
```

Any ideas how we could debug this? k8s has 48 cores so we could try to debug this there.

I'll probably start by building there and running just the tests in `inline_fortran.py`. Maybe that's already enough to trigger the error.



---

archive/issue_comments_352120.json:
```json
{
    "body": "For Python packages, the sources on PyPI should always be considered the official sources (unless the project specifically points to GitHub for their sources, which is not the case here).",
    "created_at": "2018-10-05T05:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352120",
    "user": "jdemeyer"
}
```

For Python packages, the sources on PyPI should always be considered the official sources (unless the project specifically points to GitHub for their sources, which is not the case here).



---

archive/issue_comments_352121.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-05T05:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352121",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352122.json:
```json
{
    "body": "I'm getting a timeout instead on that test:\n\n```\nDoctesting 1 file using 8 threads.\nsage -t --long src/sage/misc/inline_fortran.py\n    Timed out\n**********************************************************************\nTests run before process (pid=16924) timed out:\nsage: from sage.misc.inline_fortran import _import_module_from_path ## line 27 ##\nsage: modname = '___test__import_module_from_path' ## line 28 ##\nsage: tmpdir = tmp_dir() ## line 29 ##\nsage: filename = os.path.join(tmpdir, modname + '.py') ## line 30 ##\nsage: with open(filename, 'w') as fobj:\n    _ = fobj.write('foo = \"bar\"') ## line 31 ##\nsage: mod = _import_module_from_path(modname) ## line 33 ##\nsage: mod = _import_module_from_path('DoEsNoTeXiSt', path=[tmpdir]) ## line 37 ##\nsage: mod = _import_module_from_path(modname, path=[tmpdir]) ## line 41 ##\nsage: mod.foo ## line 42 ##   \n'bar'\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 44 ##\n0\nsage: code = '''\nC FILE: FIB1.F\n      SUBROUTINE FIB(A,N)\nC\nC     CALCULATE FIRST N FIBONACCI NUMBERS\nC\n      INTEGER N\n      REAL*8 A(N)\n      DO I=1,N\n         IF (I.EQ.1) THEN\n            A(I) = 0.0D0\n         ELSEIF (I.EQ.2) THEN \n            A(I) = 1.0D0\n         ELSE\n            A(I) = A(I-1) + A(I-2)\n         ENDIF\n      ENDDO\n      END\nC END FILE FIB1.F\n''' ## line 114 ##\nsage: fortran(code, globals()) ## line 134 ##\n------------------------------------------------------------------------\n/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0x851c)[0x3fff7ea0851c]\n/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8638)[0x3fff7ea08638]\n/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0xd370)[0x3fff7ea0d370]\n[0x3fff7ffa04d8]\n/lib/powerpc64le-linux-gnu/libc.so.6(__read+0x58)[0x3fff7fc0e02c]\n[0x3fffd1c122b0]\n/lib/powerpc64le-linux-gnu/libc.so.6(_IO_file_read+0x64)[0x3fff7fb88674]\n/lib/powerpc64le-linux-gnu/libc.so.6(+0x8839c)[0x3fff7fb8839c]\n/lib/powerpc64le-linux-gnu/libc.so.6(_IO_sgetn+0x28)[0x3fff7fb8bac8]\n/lib/powerpc64le-linux-gnu/libc.so.6(fread+0xb4)[0x3fff7fb78a84]\n/home/jdemeyer/sage-git/local/lib/libpython2.7.so.1.0(Py_UniversalNewlineFread+0x1e8)[0x3fff7fdc2668]\n[...]\n----------------------------------------------------------------------\nsage -t --long src/sage/misc/inline_fortran.py  # Timed out\n----------------------------------------------------------------------\nTotal time for all tests: 1800.1 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n",
    "created_at": "2018-10-05T07:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352122",
    "user": "jdemeyer"
}
```

I'm getting a timeout instead on that test:

```
Doctesting 1 file using 8 threads.
sage -t --long src/sage/misc/inline_fortran.py
    Timed out
**********************************************************************
Tests run before process (pid=16924) timed out:
sage: from sage.misc.inline_fortran import _import_module_from_path ## line 27 ##
sage: modname = '___test__import_module_from_path' ## line 28 ##
sage: tmpdir = tmp_dir() ## line 29 ##
sage: filename = os.path.join(tmpdir, modname + '.py') ## line 30 ##
sage: with open(filename, 'w') as fobj:
    _ = fobj.write('foo = "bar"') ## line 31 ##
sage: mod = _import_module_from_path(modname) ## line 33 ##
sage: mod = _import_module_from_path('DoEsNoTeXiSt', path=[tmpdir]) ## line 37 ##
sage: mod = _import_module_from_path(modname, path=[tmpdir]) ## line 41 ##
sage: mod.foo ## line 42 ##   
'bar'
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 44 ##
0
sage: code = '''
C FILE: FIB1.F
      SUBROUTINE FIB(A,N)
C
C     CALCULATE FIRST N FIBONACCI NUMBERS
C
      INTEGER N
      REAL*8 A(N)
      DO I=1,N
         IF (I.EQ.1) THEN
            A(I) = 0.0D0
         ELSEIF (I.EQ.2) THEN 
            A(I) = 1.0D0
         ELSE
            A(I) = A(I-1) + A(I-2)
         ENDIF
      ENDDO
      END
C END FILE FIB1.F
''' ## line 114 ##
sage: fortran(code, globals()) ## line 134 ##
------------------------------------------------------------------------
/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0x851c)[0x3fff7ea0851c]
/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8638)[0x3fff7ea08638]
/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/cysignals/signals.so(+0xd370)[0x3fff7ea0d370]
[0x3fff7ffa04d8]
/lib/powerpc64le-linux-gnu/libc.so.6(__read+0x58)[0x3fff7fc0e02c]
[0x3fffd1c122b0]
/lib/powerpc64le-linux-gnu/libc.so.6(_IO_file_read+0x64)[0x3fff7fb88674]
/lib/powerpc64le-linux-gnu/libc.so.6(+0x8839c)[0x3fff7fb8839c]
/lib/powerpc64le-linux-gnu/libc.so.6(_IO_sgetn+0x28)[0x3fff7fb8bac8]
/lib/powerpc64le-linux-gnu/libc.so.6(fread+0xb4)[0x3fff7fb78a84]
/home/jdemeyer/sage-git/local/lib/libpython2.7.so.1.0(Py_UniversalNewlineFread+0x1e8)[0x3fff7fdc2668]
[...]
----------------------------------------------------------------------
sage -t --long src/sage/misc/inline_fortran.py  # Timed out
----------------------------------------------------------------------
Total time for all tests: 1800.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```




---

archive/issue_comments_352123.json:
```json
{
    "body": "Running this under `strace` shows indeed that `f2py` is creating a huge number of threads which at some points leads to out-of-memory problems. For some reason, this is causing a hang for me instead of an exception.",
    "created_at": "2018-10-05T08:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352123",
    "user": "jdemeyer"
}
```

Running this under `strace` shows indeed that `f2py` is creating a huge number of threads which at some points leads to out-of-memory problems. For some reason, this is causing a hang for me instead of an exception.



---

archive/issue_comments_352124.json:
```json
{
    "body": "I reported the thread issue upstream: https://github.com/numpy/numpy/issues/12087",
    "created_at": "2018-10-05T09:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352124",
    "user": "jdemeyer"
}
```

I reported the thread issue upstream: https://github.com/numpy/numpy/issues/12087



---

archive/issue_comments_352125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-05T09:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352125",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352126.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-05T09:47:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352126",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352127.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-05T10:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352127",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352128.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-10-05T10:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352128",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352129.json:
```json
{
    "body": "Just for the record I would prefer to monkey-patch instead (or maybe additionally). It seems to be a clear bug in this case and downstream distributions should probably patch, but I still think sage should do what it can to prevent errors even on an unpatched system.\n\nI know your views on this but still wanted to make that point.",
    "created_at": "2018-10-05T15:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352129",
    "user": "@timokau"
}
```

Just for the record I would prefer to monkey-patch instead (or maybe additionally). It seems to be a clear bug in this case and downstream distributions should probably patch, but I still think sage should do what it can to prevent errors even on an unpatched system.

I know your views on this but still wanted to make that point.



---

archive/issue_comments_352130.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-06T17:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352130",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352131.json:
```json
{
    "body": "gh-timokau, I would usually agree that we should monkey-patch. However, in this case, there seems to be nothing Sage specific going on so I do not see a strong reason to monkey-patch. In particular, this does not completely break Sage but just breaks things in some rare cases. As this is a numpy bug, distributions should backport it in their numpy if they care.\n\nProbably more importantly, this would be somewhat hard to monkey-patch. Numpy is not imported in a central spot in Sage as the import takes a while, so it is only loaded on demand. Therefore, there is not a single spot where the monkey-patching could happen.",
    "created_at": "2018-10-06T17:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352131",
    "user": "saraedum"
}
```

gh-timokau, I would usually agree that we should monkey-patch. However, in this case, there seems to be nothing Sage specific going on so I do not see a strong reason to monkey-patch. In particular, this does not completely break Sage but just breaks things in some rare cases. As this is a numpy bug, distributions should backport it in their numpy if they care.

Probably more importantly, this would be somewhat hard to monkey-patch. Numpy is not imported in a central spot in Sage as the import takes a while, so it is only loaded on demand. Therefore, there is not a single spot where the monkey-patching could happen.



---

archive/issue_comments_352132.json:
```json
{
    "body": "Yes, I agree that the argument is a bit weak in this case. If it was easy I would still prefer it, but since its not its not that bad.",
    "created_at": "2018-10-06T17:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352132",
    "user": "@timokau"
}
```

Yes, I agree that the argument is a bit weak in this case. If it was easy I would still prefer it, but since its not its not that bad.



---

archive/issue_comments_352133.json:
```json
{
    "body": "The patch was accepted upstream.",
    "created_at": "2018-10-09T09:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352133",
    "user": "jdemeyer"
}
```

The patch was accepted upstream.



---

archive/issue_comments_352134.json:
```json
{
    "body": "Should we then upgrade to NumPy 1.14.6 now, or wait for NumPy 1.15.3 to be released?",
    "created_at": "2018-10-09T12:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352134",
    "user": "slelievre"
}
```

Should we then upgrade to NumPy 1.14.6 now, or wait for NumPy 1.15.3 to be released?



---

archive/issue_comments_352135.json:
```json
{
    "body": "From a packaging perspective its preferable to upgrade to the latest version now. The latest version just requires a patch for some edge case. Without the upgrade sage is completely incompatible with newer numpy versions (which distros probably have by now).\n\nThank you for your efforts in fixing this upstream Jeroen!",
    "created_at": "2018-10-09T15:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352135",
    "user": "@timokau"
}
```

From a packaging perspective its preferable to upgrade to the latest version now. The latest version just requires a patch for some edge case. Without the upgrade sage is completely incompatible with newer numpy versions (which distros probably have by now).

Thank you for your efforts in fixing this upstream Jeroen!



---

archive/issue_comments_352136.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-20T11:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352136",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_352137.json:
```json
{
    "body": "This should be re-targeted for 8.5.",
    "created_at": "2018-10-28T14:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352137",
    "user": "embray"
}
```

This should be re-targeted for 8.5.



---

archive/issue_comments_352138.json:
```json
{
    "body": "Next NumPy upgrade at #26643.",
    "created_at": "2018-11-05T14:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352138",
    "user": "slelievre"
}
```

Next NumPy upgrade at #26643.



---

archive/issue_comments_352139.json:
```json
{
    "body": "I get two doctest failures on OSX with [SageMath](SageMath) version 8.5.beta2, which I believe are related to this ticket, please let me know what other information is helpful (or if I should ignore this).\n\n\n```\nFile \"src/sage/schemes/elliptic_curves/height.py\", line 1629, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.wp_on_grid\nFailed example:\n    H.wp_on_grid(v,4)\nExpected:\n    array([[25.43920182,  5.28760943,  5.28760943, 25.43920182],\n           [ 6.05099485,  1.83757786,  1.83757786,  6.05099485],\n           [ 6.05099485,  1.83757786,  1.83757786,  6.05099485],\n           [25.43920182,  5.28760943,  5.28760943, 25.43920182]])\nGot:\n    array([[ 25.43920182,   5.28760943,   5.28760943,  25.43920182],\n           [  6.05099485,   1.83757786,   1.83757786,   6.05099485],\n           [  6.05099485,   1.83757786,   1.83757786,   6.05099485],\n           [ 25.43920182,   5.28760943,   5.28760943,  25.43920182]])\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/height.py\", line 1637, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.wp_on_grid\nFailed example:\n    H.wp_on_grid(v,4,True)\nExpected:\n    array([[25.43920182,  5.28760943],\n           [ 6.05099485,  1.83757786],\n           [ 6.05099485,  1.83757786],\n           [25.43920182,  5.28760943]])\nGot:\n    array([[ 25.43920182,   5.28760943],\n           [  6.05099485,   1.83757786],\n           [  6.05099485,   1.83757786],\n           [ 25.43920182,   5.28760943]])\n**********************************************************************\n```\n",
    "created_at": "2018-11-11T22:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352139",
    "user": "alexjbest"
}
```

I get two doctest failures on OSX with [SageMath](SageMath) version 8.5.beta2, which I believe are related to this ticket, please let me know what other information is helpful (or if I should ignore this).


```
File "src/sage/schemes/elliptic_curves/height.py", line 1629, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.wp_on_grid
Failed example:
    H.wp_on_grid(v,4)
Expected:
    array([[25.43920182,  5.28760943,  5.28760943, 25.43920182],
           [ 6.05099485,  1.83757786,  1.83757786,  6.05099485],
           [ 6.05099485,  1.83757786,  1.83757786,  6.05099485],
           [25.43920182,  5.28760943,  5.28760943, 25.43920182]])
Got:
    array([[ 25.43920182,   5.28760943,   5.28760943,  25.43920182],
           [  6.05099485,   1.83757786,   1.83757786,   6.05099485],
           [  6.05099485,   1.83757786,   1.83757786,   6.05099485],
           [ 25.43920182,   5.28760943,   5.28760943,  25.43920182]])
**********************************************************************
File "src/sage/schemes/elliptic_curves/height.py", line 1637, in sage.schemes.elliptic_curves.height.EllipticCurveCanonicalHeight.wp_on_grid
Failed example:
    H.wp_on_grid(v,4,True)
Expected:
    array([[25.43920182,  5.28760943],
           [ 6.05099485,  1.83757786],
           [ 6.05099485,  1.83757786],
           [25.43920182,  5.28760943]])
Got:
    array([[ 25.43920182,   5.28760943],
           [  6.05099485,   1.83757786],
           [  6.05099485,   1.83757786],
           [ 25.43920182,   5.28760943]])
**********************************************************************
```




---

archive/issue_comments_352140.json:
```json
{
    "body": "I don't think it is the first time we have a formatting issue of that kind but I am not sure how to deal with it. The first thing that comes to mind is: are you using OS X' clang or sage's gcc?",
    "created_at": "2018-11-11T22:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352140",
    "user": "fbissey"
}
```

I don't think it is the first time we have a formatting issue of that kind but I am not sure how to deal with it. The first thing that comes to mind is: are you using OS X' clang or sage's gcc?



---

archive/issue_comments_352141.json:
```json
{
    "body": "I'm not 100% sure I'm looking in the right place but looks like homebrew gcc, version 8.2.0. As far as I know I haven't tried to change to clang for my sage install.\n\nI have this line in config.log `Configured with: ../configure --build=x86_64-apple-darwin17.7.0 --prefix=/usr/local/Cellar/gcc/8.2.0 --libdir=/usr/local/Cellar/gcc/8.2.0/lib/gcc/8 --enable-languages=c,c++,objc,obj-c++,fortran --program-suffix=-8 --with-gmp=/usr/local/opt/gmp --with-mpfr=/usr/local/opt/mpfr --with-mpc=/usr/local/opt/libmpc --with-isl=/usr/local/opt/isl --with-system-zlib --enable-checking=release --with-pkgversion='Homebrew GCC 8.2.0' --with-bugurl=https://github.com/Homebrew/homebrew-core/issues --disable-nls`",
    "created_at": "2018-11-11T22:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352141",
    "user": "alexjbest"
}
```

I'm not 100% sure I'm looking in the right place but looks like homebrew gcc, version 8.2.0. As far as I know I haven't tried to change to clang for my sage install.

I have this line in config.log `Configured with: ../configure --build=x86_64-apple-darwin17.7.0 --prefix=/usr/local/Cellar/gcc/8.2.0 --libdir=/usr/local/Cellar/gcc/8.2.0/lib/gcc/8 --enable-languages=c,c++,objc,obj-c++,fortran --program-suffix=-8 --with-gmp=/usr/local/opt/gmp --with-mpfr=/usr/local/opt/mpfr --with-mpc=/usr/local/opt/libmpc --with-isl=/usr/local/opt/isl --with-system-zlib --enable-checking=release --with-pkgversion='Homebrew GCC 8.2.0' --with-bugurl=https://github.com/Homebrew/homebrew-core/issues --disable-nls`



---

archive/issue_comments_352142.json:
```json
{
    "body": "Hum... Not sure. You should open a new ticket in any case. While numpy could be your culprit if numpy arrays are used it could be something else entirely.",
    "created_at": "2018-11-11T22:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25023#issuecomment-352142",
    "user": "fbissey"
}
```

Hum... Not sure. You should open a new ticket in any case. While numpy could be your culprit if numpy arrays are used it could be something else entirely.
