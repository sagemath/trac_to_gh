# Issue 12034: make it so sage_scripts gets installed as early as possible, so that it is possible to type "sage -i" and "sage -sh" on the command line early on when debugging and porting sage

Issue created by migration from https://trac.sagemath.org/ticket/12206

Original creator: was

Original creation time: 2011-12-20 19:51:27

Assignee: GeorgSWeber

I've discovered that even after building dozen(s) of packages, I still can't do

```
$ ./sage -sh
```

or even

```
$ ./sage -i <packagename>
```

in Sage anymore.  This is annoying.  The reason is because the sage_scripts spkg is not getting installed. 

Looking at the spkg-install for this package shows that it has a strange dependency setup:  (1) if sage is being upgraded, *then* this package depends on Mercurial being installed, but (2) if this is a fresh install, then this package does not depend on Mercurial being installed.    In case (1), Mercurial is of course installed, so the dependency is always satisfied.  

I just looked at spkg/deps and the deps line for this spkg is:

```
$(INST)/$(SAGE_SCRIPTS): $(BASE)
        +$(PIPE) "$(SAGE_SPKG) $(SAGE_SCRIPTS) 2>&1" "tee -a $(SAGE_LOGS)/$(SAGE_SCRIPTS).log"
```


So the change I'm suggesting in this patch is minimal and shouldn't cause any trouble.


---

Attachment

apply to the repo in SAGE_ROOT


---

Comment by was created at 2011-12-20 19:56:26

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-12-20 20:18:30

My impression of makefiles is that the list of prerequisities is an unordered list, so moving the entry for SAGE_SCRIPTS won't necessarily have any effect.  If you really want to force SAGE_SCRIPTS to build early, make it a prerequisite for, say the `patch` spkg, which has to be built before almost everything else.  The problem with this approach, though, is that if you upgrade the scripts package in an upgrade of Sage, it will force a rebuild of everything else, thereby taking way too long.


---

Comment by was created at 2011-12-20 20:39:05

Replying to [comment:2 jhpalmieri]:
> My impression of makefiles is that the list of prerequisities
> is an unordered list, so moving the entry for SAGE_SCRIPTS won't
>  necessarily have any effect. 

Then you won't think it could hurt either.   I just used exactly this change to the deps file in order to get sage_scripts installed while doing some work on porting Sage to Android, and it worked fine.  I.e., by moving the sage_scripts prereq to the top, it got built first.  But it's not guaranteed to work (as discussed at http://stackoverflow.com/questions/1647480/in-what-order-prerequisites-will-be-made-by-the-gnu-make). 

Given that getting sage_scripts to build early is merely a convenience and nothing else, I still am for this.  It can't break anything.  If it doesn't work in some weird case, we're no worse off and in that case the developer will find this trac ticket (say) and hack the deps file manually.  I just want to decrease the chances that such hacking is needed. 

> If you really want to force SAGE_SCRIPTS to build early, make it a 
> prerequisite for, say the `patch` spkg, which has to be built before almost
>  everything else.  The problem with this approach, though, is that if you 
> upgrade the scripts package in an upgrade of Sage,
>  it will force a rebuild of everything else, thereby taking way too long.

That's not good, since every single upgrade of sage upgrades the scripts repo, right?


---

Comment by jhpalmieri created at 2011-12-20 20:47:00

Yes, I agree with you that your patch can't hurt and it might help.  Having the scripts package be a prerequisite for `patch` would be a bad idea.


---

Comment by jhpalmieri created at 2011-12-20 20:47:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-12-20 23:11:39

This problem would also be solved by making `sage-sage` part of the Sage root repository.  I never understood why we needed a separate `$SAGE_ROOT/sage` and `$SAGE_LOCAL/bin/sage-sage` anyway.

But I do agree the patch here doesn't hurt.


---

Comment by jdemeyer created at 2011-12-20 23:14:46

I unfortunately would like to point out that #11073 will actually make sage_scripts depend on sage_root, which depends on mercurial, which depends on python.


---

Comment by jdemeyer created at 2011-12-20 23:18:19

Any objections to moving $SAGE_LOCAL/bin/sage-sage to $SAGE_ROOT/spkg/bin/sage (or some other file in the root repo)?


---

Comment by was created at 2011-12-21 04:42:21

jdmeyer:

  1. Having just sage-sage doesn't help at all, because sage-sage just calls other scripts that we *don't* have.  E.g., if I do "sage -i foo.spkg", then sage-pkg or something like that gets called.  So your suggestion about about moving sage-sage wouldn't help at all with this problem. 

  2. Regarding #11073 -- let's just NOT make sage_scripts depend on sage_root. Why should it?

Anyway, I very strongly object to sage_scripts getting installed late in the process or having any dependencies.    So long as this is a first-time build, sage-scripts has absolutely no dependencies at all -- it's just some static files that get copied over.  The hg dependency is only needed on upgrade, at which point we definitely already have hg installed. 

If you have done a lot of porting work on Sage (as I have over the years), you'll realize pretty quickly the critical importance of having "sage -sh" and "sage -i" (and friends) all work as early as possible.


---

Comment by jhpalmieri created at 2011-12-21 06:10:33

Replying to [comment:8 was]:
> jdmeyer:
> 
>   1. Having just sage-sage doesn't help at all, because sage-sage just calls other scripts that we *don't* have.  E.g., if I do "sage -i foo.spkg", then sage-pkg or something like that gets called.  

Both sage-spkg and sage-env are already in SAGE_ROOT/spkg/base, and will be moved (in #11073) to the root repo, so they are present right from the start.  I think Jeroen's point is to make sure that the really crucial scripts — these two and sage-sage — are in the root repo, since we need these two, and as you note, we might also want sage-sage, at the start of the build process.

Can you think of other scripts that are useful to have in the middle of the build process?

Anyway, moving sage-sage to the root repo might accomplish what you're trying to do here, but more reliably, without just hoping that changing the order in the prerequisites will have the desired effect.  (We can also reorder the prereqs as in this patch – this ticket should be merged – but Jeroen's idea also seems good.)

>  2. Regarding #11073 -- let's just NOT make sage_scripts depend on sage_root. Why should it? 

I wonder if we can make sage_scripts depend on sage_root only when upgrading, not in a build from scratch.


---

Comment by was created at 2011-12-21 14:09:17

Replying to [comment:9 jhpalmieri]:
> Replying to [comment:8 was]:
> > jdmeyer:
> > 
> >   1. Having just sage-sage doesn't help at all, because sage-sage just calls other scripts that we *don't* have.  E.g., if I do "sage -i foo.spkg", then sage-pkg or something like that gets called.  
> 
> Both sage-spkg and sage-env are already in SAGE_ROOT/spkg/base, and will
>  be moved (in #11073) to the root repo, so they are present right from the start.  

I see.  I had completely missed the point.  If both "sage -i" and "sage -sh" work from the start, I'll be very happy.  I can't really think of anything else that one needs that early.   Thanks for clarifying this!


---

Comment by jdemeyer created at 2011-12-23 11:49:05


```
make[1]: Entering directory `/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha6/spkg'
standard/deps:30: *** missing separator.  Stop.
make[1]: Leaving directory `/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha6/spkg'
```



---

Comment by jdemeyer created at 2011-12-23 11:49:05

Changing status from positive_review to needs_work.


---

Comment by was created at 2011-12-31 14:51:12

got rid of comment


---

Comment by was created at 2011-12-31 14:51:26

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jhpalmieri created at 2012-01-02 06:16:08

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-03 08:49:26

Resolution: fixed
