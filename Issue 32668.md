# Issue 32668: Adapt CBF and RBF doctests to numerical noise

archive/issues_032668.json:
```json
{
    "body": "CC:  @dimpase @mezzarobba @slel @antonio-rojas\n\nKeywords: arb, CBF, RBF\n\nAcross computers, `CBF` and `RBF` can give\nslightly different numerical results.\n\nEarly 2014 MacBook Air, macOS 10.14.6,\nmany Homebrew packages, Sage 9.5.beta7:\ntesting with random seed 0 gives failures in\n\n- `src/sage/rings/complex_arb.pyx` -- 3 doctests failed\n- `src/sage/rings/real_arb.pyx` -- 12 doctests failed\n\nFollowing two tickets merged in Sage 9.5.beta7,\n\n- #32869: fix improper names of several special functions for CBF\n- #32851: Provide real ball erfi, Ei, Si, Ci, Shi, Chi, li, Li, beta, gamma_inc, gamma_inc_lower via arb\n\nhere we adapt a few doctests to numerical noise.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32905\n\n",
    "created_at": "2021-11-19T15:38:43Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Adapt CBF and RBF doctests to numerical noise",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32668",
    "user": "https://github.com/slel"
}
```
CC:  @dimpase @mezzarobba @slel @antonio-rojas

Keywords: arb, CBF, RBF

Across computers, `CBF` and `RBF` can give
slightly different numerical results.

Early 2014 MacBook Air, macOS 10.14.6,
many Homebrew packages, Sage 9.5.beta7:
testing with random seed 0 gives failures in

- `src/sage/rings/complex_arb.pyx` -- 3 doctests failed
- `src/sage/rings/real_arb.pyx` -- 12 doctests failed

Following two tickets merged in Sage 9.5.beta7,

- #32869: fix improper names of several special functions for CBF
- #32851: Provide real ball erfi, Ei, Si, Ci, Shi, Chi, li, Li, beta, gamma_inc, gamma_inc_lower via arb

here we adapt a few doctests to numerical noise.

Issue created by migration from https://trac.sagemath.org/ticket/32905





---

archive/issue_comments_465540.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-19T15:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465540",
    "user": "https://github.com/slel"
}
```

New commits:



---

archive/issue_comments_465541.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-19T15:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465541",
    "user": "https://github.com/slel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_465542.json:
```json
{
    "body": "[Oops. Initially only considered two out of four files. Edited.]\n\nWith Sage 9.5.beta7:\n\n```\n$ ./sage -t --long --random-seed=0 \\\n  src/sage/functions/gamma.py \\\n  src/sage/rings/complex_arb.pyx \\\n  src/sage/rings/real_arb.pyx \\\n  src/sage/symbolic/function.pyx\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-11-19-17-19-26-ea3c3ab9.\nGit branch: develop\nUsing --optional=build,dochtml,homebrew,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg\nDoctesting 4 files.\nsage -t --long --random-seed=0 src/sage/functions/gamma.py\n**********************************************************************\nFile \"src/sage/functions/gamma.py\", line 1052, in sage.functions.gamma.Function_beta._method_arguments\nFailed example:\n    RBF(beta(sin(3),sqrt(RBF(2).add_error(1e-8)/3)))\nExpected:\n    [7.407662 +/- 6.17e-7]\nGot:\n    [7.4076616 +/- 5.44e-8]\n**********************************************************************\n1 item had failures:\n   1 of   2 in sage.functions.gamma.Function_beta._method_arguments\n    [214 tests, 1 failure, 4.05 s]\nsage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx\n**********************************************************************\nFile \"src/sage/rings/complex_arb.pyx\", line 4192, in sage.rings.complex_arb.ComplexBall.Ei\nFailed example:\n    CBF(Ei(I))\nExpected:\n    [0.337403922900968 +/- 3.76e-16] + [2.51687939716208 +/- 2.01e-15]*I\nGot:\n    [0.337403922900968 +/- 4.31e-16] + [2.51687939716208 +/- 2.01e-15]*I\n**********************************************************************\nFile \"src/sage/rings/complex_arb.pyx\", line 4242, in sage.rings.complex_arb.ComplexBall.Ci\nFailed example:\n    CBF(Ci(I))\nExpected:\n    [0.837866940980208 +/- 4.72e-16] + [1.570796326794897 +/- 5.54e-16]*I\nGot:\n    [0.837866940980208 +/- 4.78e-16] + [1.570796326794897 +/- 5.54e-16]*I\n**********************************************************************\nFile \"src/sage/rings/complex_arb.pyx\", line 4294, in sage.rings.complex_arb.ComplexBall.Chi\nFailed example:\n    CBF(Chi(I))\nExpected:\n    [0.337403922900968 +/- 3.25e-16] + [1.570796326794897 +/- 5.54e-16]*I\nGot:\n    [0.337403922900968 +/- 3.80e-16] + [1.570796326794897 +/- 5.54e-16]*I\n**********************************************************************\n3 items had failures:\n   1 of   4 in sage.rings.complex_arb.ComplexBall.Chi\n   1 of   4 in sage.rings.complex_arb.ComplexBall.Ci\n   1 of   4 in sage.rings.complex_arb.ComplexBall.Ei\n    [655 tests, 3 failures, 5.94 s]\nsage -t --long --random-seed=0 src/sage/rings/real_arb.pyx\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3492, in sage.rings.real_arb.RealBall.Ei\nFailed example:\n    RBF(1).Ei()\nExpected:\n    [1.89511781635594 +/- 4.94e-15]\nGot:\n    [1.89511781635594 +/- 5.11e-15]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3497, in sage.rings.real_arb.RealBall.Ei\nFailed example:\n    RBF(Ei(1))\nExpected:\n    [1.89511781635594 +/- 4.94e-15]\nGot:\n    [1.89511781635594 +/- 5.11e-15]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3534, in sage.rings.real_arb.RealBall.Ci\nFailed example:\n    RBF(1).Ci()\nExpected:\n    [0.337403922900968 +/- 3.25e-16]\nGot:\n    [0.337403922900968 +/- 3.80e-16]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3539, in sage.rings.real_arb.RealBall.Ci\nFailed example:\n    RBF(Ci(1))\nExpected:\n    [0.337403922900968 +/- 3.25e-16]\nGot:\n    [0.337403922900968 +/- 3.80e-16]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3578, in sage.rings.real_arb.RealBall.Chi\nFailed example:\n    RBF(1).Chi()\nExpected:\n    [0.837866940980208 +/- 4.72e-16]\nGot:\n    [0.837866940980208 +/- 4.78e-16]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3583, in sage.rings.real_arb.RealBall.Chi\nFailed example:\n    RBF(Chi(1))\nExpected:\n    [0.837866940980208 +/- 4.72e-16]\nGot:\n    [0.837866940980208 +/- 4.78e-16]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3600, in sage.rings.real_arb.RealBall.li\nFailed example:\n    RBF(3).li()\nExpected:\n    [2.16358859466719 +/- 4.72e-15]\nGot:\n    [2.16358859466719 +/- 5.11e-15]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3624, in sage.rings.real_arb.RealBall.Li\nFailed example:\n    RBF(3).Li()\nExpected:\n    [1.11842481454970 +/- 7.61e-15]\nGot:\n    [1.11842481454970 +/- 8.00e-15]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3651, in sage.rings.real_arb.RealBall.beta\nFailed example:\n    RBF(sin(3)).beta(RBF(2/3).sqrt())\nExpected:\n    [7.407661629415 +/- 1.07e-13]\nGot:\n    [7.4076616294151 +/- 5.60e-14]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3653, in sage.rings.real_arb.RealBall.beta\nFailed example:\n    RealBallField(100)(7/2).beta(1)\nExpected:\n    [0.28571428571428571428571428571 +/- 5.23e-30]\nGot:\n    [0.28571428571428571428571428571 +/- 4.93e-30]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3688, in sage.rings.real_arb.RealBall.gamma\nFailed example:\n    RBF(gamma(3/2, RBF(2).sqrt()))\nExpected:\n    [0.37118875695353 +/- 3.00e-15]\nGot:\n    [0.37118875695353 +/- 3.01e-15]\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 3690, in sage.rings.real_arb.RealBall.gamma\nFailed example:\n    RBF(3/2).gamma_inc(RBF(2).sqrt())\nExpected:\n    [0.37118875695353 +/- 3.00e-15]\nGot:\n    [0.37118875695353 +/- 3.01e-15]\n**********************************************************************\n7 items had failures:\n   2 of   3 in sage.rings.real_arb.RealBall.Chi\n   2 of   3 in sage.rings.real_arb.RealBall.Ci\n   2 of   3 in sage.rings.real_arb.RealBall.Ei\n   1 of   2 in sage.rings.real_arb.RealBall.Li\n   2 of   4 in sage.rings.real_arb.RealBall.beta\n   2 of   5 in sage.rings.real_arb.RealBall.gamma\n   1 of   4 in sage.rings.real_arb.RealBall.li\n    [568 tests, 12 failures, 0.61 s]\nsage -t --long --random-seed=0 src/sage/symbolic/function.pyx\n**********************************************************************\nFile \"src/sage/symbolic/function.pyx\", line 629, in sage.symbolic.function.Function._is_numerical\nFailed example:\n    gamma(b, 1)\nExpected:\n    [0.50728223 +/- 4.67e-9]\nGot:\n    [0.507282234 +/- 3.81e-10]\n**********************************************************************\n1 item had failures:\n   1 of  12 in sage.symbolic.function.Function._is_numerical\n    [245 tests, 1 failure, 2.70 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/functions/gamma.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx  # 3 doctests failed\nsage -t --long --random-seed=0 src/sage/rings/real_arb.pyx  # 12 doctests failed\nsage -t --long --random-seed=0 src/sage/symbolic/function.pyx  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 14.0 seconds\n    cpu time: 12.2 seconds\n    cumulative wall time: 13.3 seconds\nPytest is not installed, skip checking tests that rely on it.\n```\n\nWith the proposed branch (commit 859b7ba):\n\n```\n$ ./sage -t --long --random-seed=0 \\\n  src/sage/functions/gamma.py \\\n  src/sage/rings/complex_arb.pyx \\\n  src/sage/rings/real_arb.pyx \\\n  src/sage/symbolic/function.pyx\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-11-19-17-21-44-77772dac.\nGit branch: t-32905\nUsing --optional=build,dochtml,homebrew,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg\nDoctesting 4 files.\nsage -t --long --random-seed=0 src/sage/functions/gamma.py\n    [214 tests, 4.63 s]\nsage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx\n    [655 tests, 6.78 s]\nsage -t --long --random-seed=0 src/sage/rings/real_arb.pyx\n    [568 tests, 0.58 s]\nsage -t --long --random-seed=0 src/sage/symbolic/function.pyx\n    [245 tests, 2.09 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 14.8 seconds\n    cpu time: 12.1 seconds\n    cumulative wall time: 14.1 seconds\nPytest is not installed, skip checking tests that rely on it.\n```",
    "created_at": "2021-11-19T15:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465542",
    "user": "https://github.com/slel"
}
```

[Oops. Initially only considered two out of four files. Edited.]

With Sage 9.5.beta7:

```
$ ./sage -t --long --random-seed=0 \
  src/sage/functions/gamma.py \
  src/sage/rings/complex_arb.pyx \
  src/sage/rings/real_arb.pyx \
  src/sage/symbolic/function.pyx
too many failed tests, not using stored timings
Running doctests with ID 2021-11-19-17-19-26-ea3c3ab9.
Git branch: develop
Using --optional=build,dochtml,homebrew,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg
Doctesting 4 files.
sage -t --long --random-seed=0 src/sage/functions/gamma.py
**********************************************************************
File "src/sage/functions/gamma.py", line 1052, in sage.functions.gamma.Function_beta._method_arguments
Failed example:
    RBF(beta(sin(3),sqrt(RBF(2).add_error(1e-8)/3)))
Expected:
    [7.407662 +/- 6.17e-7]
Got:
    [7.4076616 +/- 5.44e-8]
**********************************************************************
1 item had failures:
   1 of   2 in sage.functions.gamma.Function_beta._method_arguments
    [214 tests, 1 failure, 4.05 s]
sage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4192, in sage.rings.complex_arb.ComplexBall.Ei
Failed example:
    CBF(Ei(I))
Expected:
    [0.337403922900968 +/- 3.76e-16] + [2.51687939716208 +/- 2.01e-15]*I
Got:
    [0.337403922900968 +/- 4.31e-16] + [2.51687939716208 +/- 2.01e-15]*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4242, in sage.rings.complex_arb.ComplexBall.Ci
Failed example:
    CBF(Ci(I))
Expected:
    [0.837866940980208 +/- 4.72e-16] + [1.570796326794897 +/- 5.54e-16]*I
Got:
    [0.837866940980208 +/- 4.78e-16] + [1.570796326794897 +/- 5.54e-16]*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4294, in sage.rings.complex_arb.ComplexBall.Chi
Failed example:
    CBF(Chi(I))
Expected:
    [0.337403922900968 +/- 3.25e-16] + [1.570796326794897 +/- 5.54e-16]*I
Got:
    [0.337403922900968 +/- 3.80e-16] + [1.570796326794897 +/- 5.54e-16]*I
**********************************************************************
3 items had failures:
   1 of   4 in sage.rings.complex_arb.ComplexBall.Chi
   1 of   4 in sage.rings.complex_arb.ComplexBall.Ci
   1 of   4 in sage.rings.complex_arb.ComplexBall.Ei
    [655 tests, 3 failures, 5.94 s]
sage -t --long --random-seed=0 src/sage/rings/real_arb.pyx
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3492, in sage.rings.real_arb.RealBall.Ei
Failed example:
    RBF(1).Ei()
Expected:
    [1.89511781635594 +/- 4.94e-15]
Got:
    [1.89511781635594 +/- 5.11e-15]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3497, in sage.rings.real_arb.RealBall.Ei
Failed example:
    RBF(Ei(1))
Expected:
    [1.89511781635594 +/- 4.94e-15]
Got:
    [1.89511781635594 +/- 5.11e-15]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3534, in sage.rings.real_arb.RealBall.Ci
Failed example:
    RBF(1).Ci()
Expected:
    [0.337403922900968 +/- 3.25e-16]
Got:
    [0.337403922900968 +/- 3.80e-16]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3539, in sage.rings.real_arb.RealBall.Ci
Failed example:
    RBF(Ci(1))
Expected:
    [0.337403922900968 +/- 3.25e-16]
Got:
    [0.337403922900968 +/- 3.80e-16]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3578, in sage.rings.real_arb.RealBall.Chi
Failed example:
    RBF(1).Chi()
Expected:
    [0.837866940980208 +/- 4.72e-16]
Got:
    [0.837866940980208 +/- 4.78e-16]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3583, in sage.rings.real_arb.RealBall.Chi
Failed example:
    RBF(Chi(1))
Expected:
    [0.837866940980208 +/- 4.72e-16]
Got:
    [0.837866940980208 +/- 4.78e-16]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3600, in sage.rings.real_arb.RealBall.li
Failed example:
    RBF(3).li()
Expected:
    [2.16358859466719 +/- 4.72e-15]
Got:
    [2.16358859466719 +/- 5.11e-15]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3624, in sage.rings.real_arb.RealBall.Li
Failed example:
    RBF(3).Li()
Expected:
    [1.11842481454970 +/- 7.61e-15]
Got:
    [1.11842481454970 +/- 8.00e-15]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3651, in sage.rings.real_arb.RealBall.beta
Failed example:
    RBF(sin(3)).beta(RBF(2/3).sqrt())
Expected:
    [7.407661629415 +/- 1.07e-13]
Got:
    [7.4076616294151 +/- 5.60e-14]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3653, in sage.rings.real_arb.RealBall.beta
Failed example:
    RealBallField(100)(7/2).beta(1)
Expected:
    [0.28571428571428571428571428571 +/- 5.23e-30]
Got:
    [0.28571428571428571428571428571 +/- 4.93e-30]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3688, in sage.rings.real_arb.RealBall.gamma
Failed example:
    RBF(gamma(3/2, RBF(2).sqrt()))
Expected:
    [0.37118875695353 +/- 3.00e-15]
Got:
    [0.37118875695353 +/- 3.01e-15]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 3690, in sage.rings.real_arb.RealBall.gamma
Failed example:
    RBF(3/2).gamma_inc(RBF(2).sqrt())
Expected:
    [0.37118875695353 +/- 3.00e-15]
Got:
    [0.37118875695353 +/- 3.01e-15]
**********************************************************************
7 items had failures:
   2 of   3 in sage.rings.real_arb.RealBall.Chi
   2 of   3 in sage.rings.real_arb.RealBall.Ci
   2 of   3 in sage.rings.real_arb.RealBall.Ei
   1 of   2 in sage.rings.real_arb.RealBall.Li
   2 of   4 in sage.rings.real_arb.RealBall.beta
   2 of   5 in sage.rings.real_arb.RealBall.gamma
   1 of   4 in sage.rings.real_arb.RealBall.li
    [568 tests, 12 failures, 0.61 s]
sage -t --long --random-seed=0 src/sage/symbolic/function.pyx
**********************************************************************
File "src/sage/symbolic/function.pyx", line 629, in sage.symbolic.function.Function._is_numerical
Failed example:
    gamma(b, 1)
Expected:
    [0.50728223 +/- 4.67e-9]
Got:
    [0.507282234 +/- 3.81e-10]
**********************************************************************
1 item had failures:
   1 of  12 in sage.symbolic.function.Function._is_numerical
    [245 tests, 1 failure, 2.70 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/functions/gamma.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx  # 3 doctests failed
sage -t --long --random-seed=0 src/sage/rings/real_arb.pyx  # 12 doctests failed
sage -t --long --random-seed=0 src/sage/symbolic/function.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 14.0 seconds
    cpu time: 12.2 seconds
    cumulative wall time: 13.3 seconds
Pytest is not installed, skip checking tests that rely on it.
```

With the proposed branch (commit 859b7ba):

```
$ ./sage -t --long --random-seed=0 \
  src/sage/functions/gamma.py \
  src/sage/rings/complex_arb.pyx \
  src/sage/rings/real_arb.pyx \
  src/sage/symbolic/function.pyx
too many failed tests, not using stored timings
Running doctests with ID 2021-11-19-17-21-44-77772dac.
Git branch: t-32905
Using --optional=build,dochtml,homebrew,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg
Doctesting 4 files.
sage -t --long --random-seed=0 src/sage/functions/gamma.py
    [214 tests, 4.63 s]
sage -t --long --random-seed=0 src/sage/rings/complex_arb.pyx
    [655 tests, 6.78 s]
sage -t --long --random-seed=0 src/sage/rings/real_arb.pyx
    [568 tests, 0.58 s]
sage -t --long --random-seed=0 src/sage/symbolic/function.pyx
    [245 tests, 2.09 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 14.8 seconds
    cpu time: 12.1 seconds
    cumulative wall time: 14.1 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

archive/issue_comments_465543.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-19T16:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465543",
    "user": "https://github.com/slel"
}
```

New commits:



---

archive/issue_comments_465544.json:
```json
{
    "body": "(Not a review, just some comments.)\n\nThe results should only depend on the installed version of arb, not on other system details. The policy until now (at Jeroen's insistence long ago, if I remember correctly) has been to doctest the exact output corresponding to the version packaged by sage-the-distribution. With increasing use of system packages, it may be time to change that, but that should be a conscious decision. \n\nI don't see the point of things like `[3.141592653589793 +/- ...e-16]`: if all we are interested in is that the value (and its approximate accuracy), we may as well write `[3.14159265358979...]`; if, on the other hand, we want (for documentation purposes, say) the shape of the output to be apparent, then something like `[3.141592653589793 +/- 3.39e-16] # abs tol 1e-15` seems better.",
    "created_at": "2021-11-19T16:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465544",
    "user": "https://github.com/mezzarobba"
}
```

(Not a review, just some comments.)

The results should only depend on the installed version of arb, not on other system details. The policy until now (at Jeroen's insistence long ago, if I remember correctly) has been to doctest the exact output corresponding to the version packaged by sage-the-distribution. With increasing use of system packages, it may be time to change that, but that should be a conscious decision. 

I don't see the point of things like `[3.141592653589793 +/- ...e-16]`: if all we are interested in is that the value (and its approximate accuracy), we may as well write `[3.14159265358979...]`; if, on the other hand, we want (for documentation purposes, say) the shape of the output to be apparent, then something like `[3.141592653589793 +/- 3.39e-16] # abs tol 1e-15` seems better.



---

archive/issue_comments_465545.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-19T22:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465545",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_465546.json:
```json
{
    "body": "Thanks for clarifying that results only vary\nwith arb versions, not other system details.\nI edited the ticket description accordingly.\n\nThe policy you mention does not seem to have\nbeen consistently enforced, as many doctests\nnear those I changed have `...` ellipses in\nthe output.\n\nThat said, your suggestions make a lot of sense.\n\nI prefer using `abs tol` to an ellipsis as\nit better shows the shape of the output and\nbetter controls the doctest output (the ellipsis\nwould match a wrong imaginary part).",
    "created_at": "2021-11-19T22:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465546",
    "user": "https://github.com/slel"
}
```

Thanks for clarifying that results only vary
with arb versions, not other system details.
I edited the ticket description accordingly.

The policy you mention does not seem to have
been consistently enforced, as many doctests
near those I changed have `...` ellipses in
the output.

That said, your suggestions make a lot of sense.

I prefer using `abs tol` to an ellipsis as
it better shows the shape of the output and
better controls the doctest output (the ellipsis
would match a wrong imaginary part).



---

archive/issue_comments_465547.json:
```json
{
    "body": "For the same package versions, answers might be a bit different on different hardware, in particular if machine floating point is involved in any way.\n\nBut yes, #`abs tol ` is the way  to go. Does it work with complex data?",
    "created_at": "2021-11-19T22:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465547",
    "user": "https://github.com/dimpase"
}
```

For the same package versions, answers might be a bit different on different hardware, in particular if machine floating point is involved in any way.

But yes, #`abs tol ` is the way  to go. Does it work with complex data?



---

archive/issue_comments_465548.json:
```json
{
    "body": "My understanding is `abs tol` or `rel tol`\napply to each floating-point number in the output.\n\nSo for instance in the following output:\n\n```\nsage: CBF(pi + I*e)  # abs tol 3e-16\n[3.141592653589793 +/- 3.39e-16] + [2.718281828459045 +/- 5.41e-16]*I\n```\nthe doctest would test that we have something of the form\n\n```\n[AAA +/- BBB] + [CCC +/- DDD]*I\n```\nwhere each of `AAA`, `BBB`, `CCC`, `DDD` is\na floating-point number, and that they match,\neach within the given tolerance, the values\n3.141592653589793, 3.39e-16,\n2.718281828459045, 5.41e-16.",
    "created_at": "2021-11-19T22:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465548",
    "user": "https://github.com/slel"
}
```

My understanding is `abs tol` or `rel tol`
apply to each floating-point number in the output.

So for instance in the following output:

```
sage: CBF(pi + I*e)  # abs tol 3e-16
[3.141592653589793 +/- 3.39e-16] + [2.718281828459045 +/- 5.41e-16]*I
```
the doctest would test that we have something of the form

```
[AAA +/- BBB] + [CCC +/- DDD]*I
```
where each of `AAA`, `BBB`, `CCC`, `DDD` is
a floating-point number, and that they match,
each within the given tolerance, the values
3.141592653589793, 3.39e-16,
2.718281828459045, 5.41e-16.



---

archive/issue_comments_465549.json:
```json
{
    "body": "Did doctests from #32869 and #32851 use\nthe exact output obtained using Arb 2.19?\n\nIn comment:2 above, the tests were run using\nHomebrew's \"arb 2.21.1\".\n\nTo adapt CBF and RBF doctests with `abs tol`,\nI could compare the outputs given by\n\n- Sage with Homebrew's Arb 2.21.1\n\n```\n$ brew list --versions arb\narb 2.21.1\n```\n\n- Sage with the arb spkg, currently at:\n\n```\n$ cat build/pkgs/arb/package-version.txt\n2.19.0.p0\n```\n\nBut beyond that I don't know the range of\nallowed arb versions or how to figure it out.\n\nChecking the outputs of each CBF and RBF doctest\nacross our tox configurations (which might reflect\nthe range of allowed arb versions to some extent)\nseems a bit daunting.\n\nOne way might be to use the exact output\nfrom Sage-with-arb-spkg, add some tolerance,\nrun some github-actions to check that worked,\nand iterate if not. I wonder how those\ngithub-actions could be made to start from\nan already built Sage 9.5.beta7 and to test\nonly the few files we care about here.\n\nRelated: ticket #32211 will upgrade\nFLINT and Arb.",
    "created_at": "2021-11-19T23:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465549",
    "user": "https://github.com/slel"
}
```

Did doctests from #32869 and #32851 use
the exact output obtained using Arb 2.19?

In comment:2 above, the tests were run using
Homebrew's "arb 2.21.1".

To adapt CBF and RBF doctests with `abs tol`,
I could compare the outputs given by

- Sage with Homebrew's Arb 2.21.1

```
$ brew list --versions arb
arb 2.21.1
```

- Sage with the arb spkg, currently at:

```
$ cat build/pkgs/arb/package-version.txt
2.19.0.p0
```

But beyond that I don't know the range of
allowed arb versions or how to figure it out.

Checking the outputs of each CBF and RBF doctest
across our tox configurations (which might reflect
the range of allowed arb versions to some extent)
seems a bit daunting.

One way might be to use the exact output
from Sage-with-arb-spkg, add some tolerance,
run some github-actions to check that worked,
and iterate if not. I wonder how those
github-actions could be made to start from
an already built Sage 9.5.beta7 and to test
only the few files we care about here.

Related: ticket #32211 will upgrade
FLINT and Arb.



---

archive/issue_comments_465550.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> For the same package versions, answers might be a bit different on different hardware, in particular if machine floating point is involved in any way.\n\n\nIn principle yes, but I am not aware of any example of this situation with arb. (This is frequent with libm operations, less so with basic IEEE-754 correctly rounded operations, and I suspect small variations in the computation steps for which arb uses hardware FP typically don't affect the final result at all.)",
    "created_at": "2021-11-20T07:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465550",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:6 dimpase]:
> For the same package versions, answers might be a bit different on different hardware, in particular if machine floating point is involved in any way.


In principle yes, but I am not aware of any example of this situation with arb. (This is frequent with libm operations, less so with basic IEEE-754 correctly rounded operations, and I suspect small variations in the computation steps for which arb uses hardware FP typically don't affect the final result at all.)



---

archive/issue_comments_465551.json:
```json
{
    "body": "Replying to [comment:8 slelievre]:\n> Did doctests from #32869 and #32851 use\n> the exact output obtained using Arb 2.19?\n\n\nYes.\n\n> But beyond that I don't know the range of\n> allowed arb versions or how to figure it out.\n\n\n`spkg-configure` checks for arb \u22652.16; I don't know if that's really enough or if we now use more recent additions somewhere.\n\nI don't think the precise versions matter much for most doctests: typically all that happens with new versions is that some error bounds change a little bit but remain of the same order of magnitude.",
    "created_at": "2021-11-20T07:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465551",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:8 slelievre]:
> Did doctests from #32869 and #32851 use
> the exact output obtained using Arb 2.19?


Yes.

> But beyond that I don't know the range of
> allowed arb versions or how to figure it out.


`spkg-configure` checks for arb ≥2.16; I don't know if that's really enough or if we now use more recent additions somewhere.

I don't think the precise versions matter much for most doctests: typically all that happens with new versions is that some error bounds change a little bit but remain of the same order of magnitude.



---

archive/issue_comments_465552.json:
```json
{
    "body": "On the same machine as in comment:2,\nanother copy of Sage built with the arb spkg:\n\n```\n$ source .homebrew-build-env\n$ ./bootstrap -q\n$ ./configure --with-system-arb=no -q\n$ make -s V=0 ptestlong\n```\npasses all tests in the four affected files\nfor unmodified Sage 9.5.beta7.\n\nI'll prepare a new branch with tolerance indications.",
    "created_at": "2021-11-20T09:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465552",
    "user": "https://github.com/slel"
}
```

On the same machine as in comment:2,
another copy of Sage built with the arb spkg:

```
$ source .homebrew-build-env
$ ./bootstrap -q
$ ./configure --with-system-arb=no -q
$ make -s V=0 ptestlong
```
passes all tests in the four affected files
for unmodified Sage 9.5.beta7.

I'll prepare a new branch with tolerance indications.



---

archive/issue_comments_465553.json:
```json
{
    "body": "Here is enough to let all CBF and RBF doctests pass,\nwhether using arb 2.21.0 or arb 2.19.0.\n\nReplacing `...` by `abs tol` in all CBF and RBF\ndoctests can be a different ticket.\n\nGetting the minimal fix from this branch\ninto Sage 9.5 is more urgent in my eyes.\n\n---\nNew commits:",
    "created_at": "2021-11-20T12:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465553",
    "user": "https://github.com/slel"
}
```

Here is enough to let all CBF and RBF doctests pass,
whether using arb 2.21.0 or arb 2.19.0.

Replacing `...` by `abs tol` in all CBF and RBF
doctests can be a different ticket.

Getting the minimal fix from this branch
into Sage 9.5 is more urgent in my eyes.

---
New commits:



---

archive/issue_comments_465554.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-20T12:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465554",
    "user": "https://github.com/slel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_465555.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-20T12:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465555",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_465556.json:
```json
{
    "body": "I had left out the changes to `real_arb.pyx`,\nI force-pushed to include them. Ready for review now.",
    "created_at": "2021-11-20T12:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465556",
    "user": "https://github.com/slel"
}
```

I had left out the changes to `real_arb.pyx`,
I force-pushed to include them. Ready for review now.



---

archive/issue_comments_465557.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-22T15:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465557",
    "user": "https://github.com/tornaria"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465558.json:
```json
{
    "body": "Looks good to me. I took the patch for the sagemath package for void linux (wip) which uses arb 2.21.1, and all of those tests that were failing now pass.\n\nSee https://github.com/void-linux/void-packages/pull/34030",
    "created_at": "2021-11-22T15:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465558",
    "user": "https://github.com/tornaria"
}
```

Looks good to me. I took the patch for the sagemath package for void linux (wip) which uses arb 2.21.1, and all of those tests that were failing now pass.

See https://github.com/void-linux/void-packages/pull/34030



---

archive/issue_comments_465559.json:
```json
{
    "body": "Raising priority to put it in the 9.5 radar, as this is affecting many distro packages.",
    "created_at": "2021-12-12T09:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465559",
    "user": "https://github.com/antonio-rojas"
}
```

Raising priority to put it in the 9.5 radar, as this is affecting many distro packages.



---

archive/issue_comments_465560.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-12-12T09:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465560",
    "user": "https://github.com/antonio-rojas"
}
```

Changing priority from major to critical.



---

archive/issue_comments_465561.json:
```json
{
    "body": "See e.g.\n\n- [sage-on-gentoo issue 664: doctest failures on Prefix for 9.5.beta8](https://github.com/cschwan/sage-on-gentoo/issues/664)",
    "created_at": "2021-12-17T06:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465561",
    "user": "https://github.com/slel"
}
```

See e.g.

- [sage-on-gentoo issue 664: doctest failures on Prefix for 9.5.beta8](https://github.com/cschwan/sage-on-gentoo/issues/664)



---

archive/issue_events_086975.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-19T11:48:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32668#event-86975"
}
```



---

archive/issue_comments_465562.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-19T11:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32668#issuecomment-465562",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
