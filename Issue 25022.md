# Issue 25022: py3: buffet of minor fixes involving dict iterators

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-04-29 09:54:09

This fixes several doctests, and a few APIs that involved returning dict iterators from `dict.keys()`, `dict.values()`, or `dict.items()`.  All existing code assumes that these methods return `lists` containing copies of data from the dict, whereas on Python 3 they return live views into the dict, which makes for some rather different behavior (and in some cases different doctest output).

This probably isn't exhaustive, but is the majority of such bugs I could find in a recent run of the test suite on Python 3.


---

Comment by embray created at 2018-04-29 09:54:40

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-04-29 11:08:20

At least using Python2 it is faster to do `list(D.items())`

```
sage: import six
sage: D = {i:i for i in range(10)}
sage: %timeit list(six.iteritems(D))
The slowest run took 88.95 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.5 µs per loop
sage: %timeit list(D.items())
1000000 loops, best of 3: 1.11 µs per loop
sage: D = {i:i for i in range(100)}
sage: %timeit list(six.iteritems(D))
100000 loops, best of 3: 7.27 µs per loop
sage: %timeit list(D.items())
100000 loops, best of 3: 6.65 µs per loop
```

Granted, it is not necessarily memory efficient, but I think speed in `functor.pyx` is more important. Same comment can be applied for the other similar changes, including `values()`.

Why do you still use `keys()` in `generic_graph.py`?

In `matrix_generic_sparse.pyx`, I don't think you need the `list`:

```
for key in list(entries):
```

Similar for `reset.pyx`, `conway_polynomials.py`, and `polydict.pyx`. Likewise, I don't understand the need for the change in `decorators.py`.


---

Comment by embray created at 2018-04-29 19:01:34

I don't really care about such minor differences unless it can be shown to have an impact on the specific code in question (e.g. that code itself is in a large loop.


---

Comment by embray created at 2018-04-29 19:05:44

Replying to [comment:2 tscrim]:
> Why do you still use `keys()` in `generic_graph.py`?

No specific reason--I guess i wasn't sure if the return value there was actually a dict or not, but it's harmless either way.  In this case I think having the `.keys()` is almost better from a documentation perspective.

> In `matrix_generic_sparse.pyx`, I don't think you need the `list`:
> {{{
> for key in list(entries):
> }}}
> Similar for `reset.pyx`, `conway_polynomials.py`, and `polydict.pyx`. Likewise, I don't understand the need for the change in `decorators.py`.

You do--in all those cases the dict being looped over is modified in the loops so you must make a list first.


---

Comment by embray created at 2018-04-29 19:13:34

Replying to [comment:2 tscrim]:
> Granted, it is not necessarily memory efficient, but I think speed in `functor.pyx` is more important. Same comment can be applied for the other similar changes, including `values()`.

The change in `functor.pyx` is to its `__reduce__` method.  Is there really a reason that's critical?  Some difference like this pales in comparison to the overall process of creating a pickle from an object.


---

Comment by chapoton created at 2018-05-11 12:11:33

rebased on 8.3.b0
----
New commits:


---

Comment by chapoton created at 2018-05-11 17:30:34

This introduces bad uses of six inside some pyx files:

* src/sage/categories/functor.pyx

* src/sage/combinat/designs/designs_pyx.pyx


---

Comment by tscrim created at 2018-05-12 08:57:31

Thanks for the explanations in comment:4 (I had missed the modified dictionaries). However, we should remove the use of `six` in `pyx` files as mentioned in comment:7.


---

Comment by git created at 2018-05-13 06:36:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-13 06:37:09

I have taken care of the removal of six from pyx files


---

Comment by tscrim created at 2018-05-13 06:52:14

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-05-13 06:52:14

LGTM. Thanks.


---

Comment by embray created at 2018-05-14 15:40:06

Ok but I'm going to clean up / squash the commit history.


---

Comment by git created at 2018-05-14 15:42:46

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2018-05-14 15:42:46

Changing status from positive_review to needs_review.


---

Comment by chapoton created at 2018-05-16 08:58:05

does not merge, needs rebase


---

Comment by jdemeyer created at 2018-05-16 09:27:50

Merge conflict


---

Comment by jdemeyer created at 2018-05-16 09:27:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-16 09:34:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-16 09:35:10

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-05-16 09:35:10

merged


---

Comment by jdemeyer created at 2018-05-16 10:02:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-17 18:51:28

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-05-17 18:51:28

Merge conflict


---

Comment by git created at 2018-05-19 07:07:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-19 07:08:38

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2018-05-19 07:08:38

merged. Setting back to positive


---

Comment by vbraun created at 2018-05-20 22:55:19

Resolution: fixed
