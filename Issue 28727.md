# Issue 28727: Problem with integration/differentiation of symbolic functions.

archive/issues_028727.json:
```json
{
    "body": "Minimal case of a problem reported on [ask.sagemath.org](https://ask.sagemath.org/question/49384/simple-integration-problem/).\n\n\n```\nsage: reset()\nsage: var(\"x,t\")\n(x, t)\nsage: f=function(\"f\") ## Note : no formal arguments\nsage: diff(f(x,t),x)\ndiff(f(x, t), x)\nsage: diff(f(x,t),x).integrate(x)\nf(x, t)\n```\n\n\nAs expected. But :\n\n\n```\nsage: diff(f(x,t),x).integrate(t)\nf(x, t)\n```\n\n\nNo, no, no. And no.\n\nSlightly better:\n\n\n```\nsage: reset()\nsage: var(\"x,t\")\n(x, t)\nsage: f=function(\"f\")(x,t)  ## Note : specified formal arguments.\nsage: diff(f(x,t),x)\ndiff(f(t, x), x)\nsage: diff(f(x,t),x).integrate(x)\nf(t, x)\nsage: diff(f(x,t),x).integrate(t)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/all_cmdline.py in <module>()\n----> 1 diff(f(x,t),x).integrate(t)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:64575)()\n  12389                     R = ring.SR\n  12390             return R(integral(f, v, a, b, **kwds))\n> 12391         return integral(self, *args, **kwds)\n  12392 \n  12393     integrate = integral\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)\n    927         return integrator(expression, v, a, b)\n    928     if a is None:\n--> 929         return indefinite_integral(expression, v, hold=hold)\n    930     else:\n    931         return definite_integral(expression, v, a, b, hold=hold)\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12262)()\n   1136             res = self._evalf_try_(*args)\n   1137             if res is None:\n-> 1138                 res = super(BuiltinFunction, self).__call__(\n   1139                         *args, coerce=coerce, hold=hold)\n   1140 \n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7039)()\n    600                     (<Expression>args[0])._gobj, hold)\n    601         elif self._nargs == 2:\n--> 602             res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,\n    603                     (<Expression>args[1])._gobj, hold)\n    604         elif self._nargs == 3:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x)\n    100         for integrator in self.integrators:\n    101             try:\n--> 102                 A = integrator(f, x)\n    103             except (NotImplementedError, TypeError, AttributeError):\n    104                 pass\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/external.py in sympy_integrator(expression, v, a, b)\n     66     else:\n     67         result = sympy.integrate(ex, (v, a._sympy_(), b._sympy_()))\n---> 68     return result._sage_()\n     69 \n     70 def mma_free_integrator(expression, v, a=None, b=None):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/sympy.py in _sympysage_integral(self)\n    307     \"\"\"\n    308     from sage.misc.functional import integral\n--> 309     f, limits = self.function._sage_(), list(self.limits)\n    310     for limit in limits:\n    311         if len(limit) == 1:\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/sympy.py in _sympysage_derivative(self)\n    333     f = self.args[0]._sage_()\n    334     args = [[a._sage_() for a in arg] if isinstance(arg,tuple) else arg._sage_() for arg in self.args[2:]]\n--> 335     return derivative(f, *args)\n    336 \n    337 def _sympysage_order(self):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/calculus/functional.py in derivative(f, *args, **kwds)\n    129     \"\"\"\n    130     try:\n--> 131         return f.derivative(*args, **kwds)\n    132     except AttributeError:\n    133         pass\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:25806)()\n   4186             ValueError: No differentiation variable specified.\n   4187         \"\"\"\n-> 4188         return multi_derivative(self, args)\n   4189 \n   4190     diff = differentiate = derivative\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3014)()\n    217     if not args:\n    218         # fast version where no arguments supplied\n--> 219         return F._derivative()\n    220 \n    221     for arg in derivative_parse(args):\n\n/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:26148)()\n   4248                 return self.gradient()\n   4249             else:\n-> 4250                 raise ValueError(\"No differentiation variable specified.\")\n   4251         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \\\n   4252                 or deg < 1:\n\nValueError: No differentiation variable specified.\n```\n\n\nNo again. But at least, this is an explicit error, not a silently accepted wrong result.\n\nThe problem seems to point to handling formal arguments of undefined functions. I do not (yet) understand this code...\n\nIMHO, at least the first case is critical (possibly blocker), because it silently returns a wrong result.\n\nNote that the handling of //defined// functions //seems// to be correct. For example:\n\n\n```\nsage: sin(t*x).diff(x)\nt*cos(t*x)\nsage: sin(t*x).diff(x).integrate(x)\nsin(t*x)\nsage: sin(t*x).diff(x).integrate(t)\n(t*x*sin(t*x) + cos(t*x))/x^2\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28964\n\n",
    "created_at": "2020-01-07T07:19:10Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Problem with integration/differentiation of symbolic functions.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28727",
    "user": "charpent"
}
```
Minimal case of a problem reported on [ask.sagemath.org](https://ask.sagemath.org/question/49384/simple-integration-problem/).


```
sage: reset()
sage: var("x,t")
(x, t)
sage: f=function("f") ## Note : no formal arguments
sage: diff(f(x,t),x)
diff(f(x, t), x)
sage: diff(f(x,t),x).integrate(x)
f(x, t)
```


As expected. But :


```
sage: diff(f(x,t),x).integrate(t)
f(x, t)
```


No, no, no. And no.

Slightly better:


```
sage: reset()
sage: var("x,t")
(x, t)
sage: f=function("f")(x,t)  ## Note : specified formal arguments.
sage: diff(f(x,t),x)
diff(f(t, x), x)
sage: diff(f(x,t),x).integrate(x)
f(t, x)
sage: diff(f(x,t),x).integrate(t)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/all_cmdline.py in <module>()
----> 1 diff(f(x,t),x).integrate(t)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:64575)()
  12389                     R = ring.SR
  12390             return R(integral(f, v, a, b, **kwds))
> 12391         return integral(self, *args, **kwds)
  12392 
  12393     integrate = integral

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)
    927         return integrator(expression, v, a, b)
    928     if a is None:
--> 929         return indefinite_integral(expression, v, hold=hold)
    930     else:
    931         return definite_integral(expression, v, a, b, hold=hold)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12262)()
   1136             res = self._evalf_try_(*args)
   1137             if res is None:
-> 1138                 res = super(BuiltinFunction, self).__call__(
   1139                         *args, coerce=coerce, hold=hold)
   1140 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7039)()
    600                     (<Expression>args[0])._gobj, hold)
    601         elif self._nargs == 2:
--> 602             res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
    603                     (<Expression>args[1])._gobj, hold)
    604         elif self._nargs == 3:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x)
    100         for integrator in self.integrators:
    101             try:
--> 102                 A = integrator(f, x)
    103             except (NotImplementedError, TypeError, AttributeError):
    104                 pass

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/integration/external.py in sympy_integrator(expression, v, a, b)
     66     else:
     67         result = sympy.integrate(ex, (v, a._sympy_(), b._sympy_()))
---> 68     return result._sage_()
     69 
     70 def mma_free_integrator(expression, v, a=None, b=None):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/sympy.py in _sympysage_integral(self)
    307     """
    308     from sage.misc.functional import integral
--> 309     f, limits = self.function._sage_(), list(self.limits)
    310     for limit in limits:
    311         if len(limit) == 1:

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/interfaces/sympy.py in _sympysage_derivative(self)
    333     f = self.args[0]._sage_()
    334     args = [[a._sage_() for a in arg] if isinstance(arg,tuple) else arg._sage_() for arg in self.args[2:]]
--> 335     return derivative(f, *args)
    336 
    337 def _sympysage_order(self):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/calculus/functional.py in derivative(f, *args, **kwds)
    129     """
    130     try:
--> 131         return f.derivative(*args, **kwds)
    132     except AttributeError:
    133         pass

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:25806)()
   4186             ValueError: No differentiation variable specified.
   4187         """
-> 4188         return multi_derivative(self, args)
   4189 
   4190     diff = differentiate = derivative

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3014)()
    217     if not args:
    218         # fast version where no arguments supplied
--> 219         return F._derivative()
    220 
    221     for arg in derivative_parse(args):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:26148)()
   4248                 return self.gradient()
   4249             else:
-> 4250                 raise ValueError("No differentiation variable specified.")
   4251         if not isinstance(deg, (int, long, sage.rings.integer.Integer)) \
   4252                 or deg < 1:

ValueError: No differentiation variable specified.
```


No again. But at least, this is an explicit error, not a silently accepted wrong result.

The problem seems to point to handling formal arguments of undefined functions. I do not (yet) understand this code...

IMHO, at least the first case is critical (possibly blocker), because it silently returns a wrong result.

Note that the handling of //defined// functions //seems// to be correct. For example:


```
sage: sin(t*x).diff(x)
t*cos(t*x)
sage: sin(t*x).diff(x).integrate(x)
sin(t*x)
sage: sin(t*x).diff(x).integrate(t)
(t*x*sin(t*x) + cos(t*x))/x^2
```


Issue created by migration from https://trac.sagemath.org/ticket/28964





---

archive/issue_comments_405710.json:
```json
{
    "body": "Weird. Round-tripping to maxima seems to do the right thing, so that's not where the problem seems to lie:\n\n```\nsage: diff(f(x,t),x)._maxima_().integrate(t)._sage_()\nintegrate(diff(f(x, t), x), t)\n```\n\nIf you make the variable combinations a little more complicated:\n\n```\nsage: diff(f(x,x,t),x).integrate(t)\nValueError: No differentiation variable specified.\nsage: diff(f(x,x,t),t).integrate(x)\nValueError: \nSince there is more than one variable in the expression, the\nvariable(s) of differentiation must be supplied to differentiate f(x,\nx, t)\n```\n\nThese are Pynac errors. So I suspect that there is a differentiation that doesn't have its variable specified, and that with only two variables around (one for the integration!) it ends up choosing that variable. So my guess is either Pynac itself or the way we interface with it.\n\nThe same problem seems to arise the other way around as well:\n\n```\nsage: integrate(f(x,t),x).diff(t)\nf(x, t)\n```\n\n\nwe can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.",
    "created_at": "2020-01-07T09:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405710",
    "user": "nbruin"
}
```

Weird. Round-tripping to maxima seems to do the right thing, so that's not where the problem seems to lie:

```
sage: diff(f(x,t),x)._maxima_().integrate(t)._sage_()
integrate(diff(f(x, t), x), t)
```

If you make the variable combinations a little more complicated:

```
sage: diff(f(x,x,t),x).integrate(t)
ValueError: No differentiation variable specified.
sage: diff(f(x,x,t),t).integrate(x)
ValueError: 
Since there is more than one variable in the expression, the
variable(s) of differentiation must be supplied to differentiate f(x,
x, t)
```

These are Pynac errors. So I suspect that there is a differentiation that doesn't have its variable specified, and that with only two variables around (one for the integration!) it ends up choosing that variable. So my guess is either Pynac itself or the way we interface with it.

The same problem seems to arise the other way around as well:

```
sage: integrate(f(x,t),x).diff(t)
f(x, t)
```


we can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.



---

archive/issue_comments_405711.json:
```json
{
    "body": "Replying to [comment:1 nbruin]:\n\n[ Snip... ]\n\n> we can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.\n\nAccording to a comment posted around Jan 7, 2020 07:00 by dsejas in the original ask.sagemath question, the problem might have been introduced between 8.8 and 8.9.\n\nIt should be possible to `git bisect` this range to pinpoint the commit. I don't have the necessary resources on hand...",
    "created_at": "2020-01-07T10:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405711",
    "user": "charpent"
}
```

Replying to [comment:1 nbruin]:

[ Snip... ]

> we can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.

According to a comment posted around Jan 7, 2020 07:00 by dsejas in the original ask.sagemath question, the problem might have been introduced between 8.8 and 8.9.

It should be possible to `git bisect` this range to pinpoint the commit. I don't have the necessary resources on hand...



---

archive/issue_comments_405712.json:
```json
{
    "body": "Replying to [comment:2 charpent]:\n> \n> > we can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.\n> \n> According to a comment posted around Jan 7, 2020 07:00 by dsejas in the original ask.sagemath question, the problem might have been introduced between 8.8 and 8.9.\n> \n\nThe culprit might be #27958.",
    "created_at": "2020-01-07T10:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405712",
    "user": "egourgoulhon"
}
```

Replying to [comment:2 charpent]:
> 
> > we can make that cause an error by fiddling with some more variables and then we see that the error traces back in something being called from `_sympysage_integral()`, so I think this error was introduced relatively recently, when sympy was added as an integrator by default.
> 
> According to a comment posted around Jan 7, 2020 07:00 by dsejas in the original ask.sagemath question, the problem might have been introduced between 8.8 and 8.9.
> 

The culprit might be #27958.



---

archive/issue_comments_405713.json:
```json
{
    "body": "Changing keywords from \"\" to \"integrate, integral\".",
    "created_at": "2020-01-07T10:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405713",
    "user": "egourgoulhon"
}
```

Changing keywords from "" to "integrate, integral".



---

archive/issue_comments_405714.json:
```json
{
    "body": "I am the original poster in ask.sagemath.org for this issue.  Hope I am not out of line to add a test case because I hope the eventual fix will solve my original problem:\n\n\n```\nvar('x t')\nf = function('f')(x, t)\ng = function('g')(x, t)\nintegrate(g * diff(f, x), x)\n...\nValueError: No differentiation variable specified.\n```\n\n\nUsed to work in Sage 8.8.  Not working in 8.9 or 9.0. \n\nThanks a lot.",
    "created_at": "2020-01-07T16:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405714",
    "user": "@bryanso"
}
```

I am the original poster in ask.sagemath.org for this issue.  Hope I am not out of line to add a test case because I hope the eventual fix will solve my original problem:


```
var('x t')
f = function('f')(x, t)
g = function('g')(x, t)
integrate(g * diff(f, x), x)
...
ValueError: No differentiation variable specified.
```


Used to work in Sage 8.8.  Not working in 8.9 or 9.0. 

Thanks a lot.



---

archive/issue_comments_405715.json:
```json
{
    "body": "Translation of derivatives to sympy is definitely wonky:\n\n```\nsage: f=function('f')\nsage: F=f(x,y,t).diff(t)\nsage: F\ndiff(f(x, y, t), t)\nsage: F._sympy_()\nDerivative(f(x, y, t), y)\nsage: F=f(x,x,t).diff(t)\nsage: F._sympy_()\nValueError: \nSince there is more than one variable in the expression, the\nvariable(s) of differentiation must be supplied to differentiate f(x,\nx, t)\n```\n\n\nThere are typos in `sage/interfaces/sympy.py`:\n\n```\ndef _sympysage_derivative(self):\n    \"\"\"\n    EXAMPLES::\n\n        sage: from sympy import Derivative\n        sage: f = function('f')\n        sage: sympy_diff = Derivative(f(x)._sympy_(), x._sympy_())\n        sage: assert diff(f(x),x)._sympy_() == sympy_diff\n        sage: assert diff(f(x),x) == sympy_diff._sage_()\n    \"\"\"\n    from sage.calculus.functional import derivative\n    f = self.args[0]._sage_()\n    args = [[a._sage_() for a in arg] if isinstance(arg,tuple) else arg._sage_() for arg in self.args[2:]]\n    return derivative(f, *args)\n```\n\nI'm pretty sure the second-last line should be iterating over `self.args[1:]`, but changing that doesn't actually seem to fix the problem.",
    "created_at": "2020-01-07T17:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405715",
    "user": "nbruin"
}
```

Translation of derivatives to sympy is definitely wonky:

```
sage: f=function('f')
sage: F=f(x,y,t).diff(t)
sage: F
diff(f(x, y, t), t)
sage: F._sympy_()
Derivative(f(x, y, t), y)
sage: F=f(x,x,t).diff(t)
sage: F._sympy_()
ValueError: 
Since there is more than one variable in the expression, the
variable(s) of differentiation must be supplied to differentiate f(x,
x, t)
```


There are typos in `sage/interfaces/sympy.py`:

```
def _sympysage_derivative(self):
    """
    EXAMPLES::

        sage: from sympy import Derivative
        sage: f = function('f')
        sage: sympy_diff = Derivative(f(x)._sympy_(), x._sympy_())
        sage: assert diff(f(x),x)._sympy_() == sympy_diff
        sage: assert diff(f(x),x) == sympy_diff._sage_()
    """
    from sage.calculus.functional import derivative
    f = self.args[0]._sage_()
    args = [[a._sage_() for a in arg] if isinstance(arg,tuple) else arg._sage_() for arg in self.args[2:]]
    return derivative(f, *args)
```

I'm pretty sure the second-last line should be iterating over `self.args[1:]`, but changing that doesn't actually seem to fix the problem.



---

archive/issue_comments_405716.json:
```json
{
    "body": "Replying to [comment:6 nbruin]:\n> Translation of derivatives to sympy is definitely wonky:\n> {{{\n> sage: f=function('f')\n> sage: F=f(x,y,t).diff(t)\n> sage: F\n> diff(f(x, y, t), t)\n> sage: F._sympy_()\n> Derivative(f(x, y, t), y)\n> sage: F=f(x,x,t).diff(t)\n> sage: F._sympy_()\n> ValueError: \n> Since there is more than one variable in the expression, the\n> variable(s) of differentiation must be supplied to differentiate f(x,\n> x, t)\n> }}}\n\nThe following fixes this particular problem:\n\n```diff\n--- a/src/sage/symbolic/expression_conversions.py\n+++ b/src/sage/symbolic/expression_conversions.py\n@@ -860,7 +860,7 @@ class SympyConverter(Converter):\n         # retrieve order\n         order = operator._parameter_set\n         # arguments\n-        _args = ex.arguments()\n+        _args = ex.operands()\n\n         sympy_arg = []\n         for i, a in enumerate(_args):\n```\n\n`arguments` contains the operands, but in a different order \u2013 alphabetically I assume.",
    "created_at": "2020-01-07T19:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405716",
    "user": "@mwageringel"
}
```

Replying to [comment:6 nbruin]:
> Translation of derivatives to sympy is definitely wonky:
> {{{
> sage: f=function('f')
> sage: F=f(x,y,t).diff(t)
> sage: F
> diff(f(x, y, t), t)
> sage: F._sympy_()
> Derivative(f(x, y, t), y)
> sage: F=f(x,x,t).diff(t)
> sage: F._sympy_()
> ValueError: 
> Since there is more than one variable in the expression, the
> variable(s) of differentiation must be supplied to differentiate f(x,
> x, t)
> }}}

The following fixes this particular problem:

```diff
--- a/src/sage/symbolic/expression_conversions.py
+++ b/src/sage/symbolic/expression_conversions.py
@@ -860,7 +860,7 @@ class SympyConverter(Converter):
         # retrieve order
         order = operator._parameter_set
         # arguments
-        _args = ex.arguments()
+        _args = ex.operands()

         sympy_arg = []
         for i, a in enumerate(_args):
```

`arguments` contains the operands, but in a different order – alphabetically I assume.



---

archive/issue_comments_405717.json:
```json
{
    "body": "The patches in comment:6 and comment:7 almost fix the problem, but there were a few more issues in the conversion of derivatives between sympy and Sage. These are now fixed by this branch.\n\nMost notably, sympy's arguments are encoded as `sympy.core.containers.Tuple` which was missed in a typecheck `isinstance(arg, tuple)`, and Sage's derivative does not accept tuples as arguments, so they need to be flattened.\n\nMoreover, the conversion from Sage to sympy was very broken and has been rewritten completely, especially to account for the case of variables with multiple occurences as in comment:1.\n\nAs far as I can see, all the test cases mentioned on this ticket work correctly now.\n----\nNew commits:",
    "created_at": "2020-02-17T13:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405717",
    "user": "@mwageringel"
}
```

The patches in comment:6 and comment:7 almost fix the problem, but there were a few more issues in the conversion of derivatives between sympy and Sage. These are now fixed by this branch.

Most notably, sympy's arguments are encoded as `sympy.core.containers.Tuple` which was missed in a typecheck `isinstance(arg, tuple)`, and Sage's derivative does not accept tuples as arguments, so they need to be flattened.

Moreover, the conversion from Sage to sympy was very broken and has been rewritten completely, especially to account for the case of variables with multiple occurences as in comment:1.

As far as I can see, all the test cases mentioned on this ticket work correctly now.
----
New commits:



---

archive/issue_comments_405718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-17T13:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405718",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405719.json:
```json
{
    "body": "Changing keywords from \"integrate, integral\" to \"integrate, integral, sympy\".",
    "created_at": "2020-02-17T13:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405719",
    "user": "@mwageringel"
}
```

Changing keywords from "integrate, integral" to "integrate, integral, sympy".



---

archive/issue_comments_405720.json:
```json
{
    "body": "Handling the Rational this way leads to problem\n\n```\nsage: cos(x).diff(x, 3/2)\n-sin(x)\n```\n\nIf this is really needed (I don't quite understand why yet), then you should check that there is no denominator.",
    "created_at": "2020-02-17T20:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405720",
    "user": "vdelecroix"
}
```

Handling the Rational this way leads to problem

```
sage: cos(x).diff(x, 3/2)
-sin(x)
```

If this is really needed (I don't quite understand why yet), then you should check that there is no denominator.



---

archive/issue_comments_405721.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-17T20:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405721",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_405722.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-17T21:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405722",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405723.json:
```json
{
    "body": "You are right. That was not a good solution. It turns out the problem is that elements of type `sympy.core.numbers.Integer` (a subtype of `sympy.core.numbers.Rational`) are converted to Sage's `Rational`. For example, this causes problems here:\n\n\n```\nsage: import sympy\nsage: sympy.sympify('Derivative(f(x, t), x, x)')\nDerivative(f(x, t), (x, 2))\nsage: _._sage_()            # the 2 is converted to Rational here\n...\n```\n\n\nI have just fixed this by implementing the missing conversion routine for integers. Thanks for pointing me in the right direction. I will squash the commits if you prefer.",
    "created_at": "2020-02-17T21:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405723",
    "user": "@mwageringel"
}
```

You are right. That was not a good solution. It turns out the problem is that elements of type `sympy.core.numbers.Integer` (a subtype of `sympy.core.numbers.Rational`) are converted to Sage's `Rational`. For example, this causes problems here:


```
sage: import sympy
sage: sympy.sympify('Derivative(f(x, t), x, x)')
Derivative(f(x, t), (x, 2))
sage: _._sage_()            # the 2 is converted to Rational here
...
```


I have just fixed this by implementing the missing conversion routine for integers. Thanks for pointing me in the right direction. I will squash the commits if you prefer.



---

archive/issue_comments_405724.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-17T21:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405724",
    "user": "@mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_405725.json:
```json
{
    "body": "Good enough as it is.",
    "created_at": "2020-02-18T08:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405725",
    "user": "vdelecroix"
}
```

Good enough as it is.



---

archive/issue_comments_405726.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-18T08:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405726",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405727.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-21T22:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28727#issuecomment-405727",
    "user": "vbraun"
}
```

Resolution: fixed
