# Issue 32614: Provide real ball erfi, Ei, Si, Ci, Shi, Chi, li, Li, beta, gamma_inc, gamma_inc_lower via arb

archive/issues_032614.json:
```json
{
    "body": "CC:  @williamstein @slel\n\nKeywords: arb, RBF, RealBallField, special functions\n\nPart of #24641.\n\nFollowing a [report by Harald Helfgott on sage-devel](https://groups.google.com/g/sage-devel/c/rOputadfR54):\n\n- Currently `RBF(gamma(3/2, 1))` errors out, as\n  `arb_hypgeom_gamma_upper` is not known to the arb interface\n- Same for other special functions `erfi`, `Ei`,...\n\nHere, by wrapping the corresponding functions from arb,\nwe add real ball special functions:\n\n- `erfi` -- imaginary error function\n- `Ei` -- exponential integral\n- `Si` -- sine integral\n- `Ci` -- cosine integral\n- `Shi` -- hyperbolic sine integral\n- `Chi` -- hyperbolic cosine integral\n- `li` -- logarithmic integral\n- `Li` -- offset logarithmic integral\n- `beta` -- complete Beta function\n- `gamma_inc` -- upper incomplete Gamma function\n- `gamma_inc_lower` -- lower incomplete Gamma function\n\nand we clarify that `zeta` with an extra argument\ngives the Hurwitz zeta function.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32851\n\n",
    "closed_at": "2021-11-15T23:16:20Z",
    "created_at": "2021-11-10T09:53:21Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Provide real ball erfi, Ei, Si, Ci, Shi, Chi, li, Li, beta, gamma_inc, gamma_inc_lower via arb",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32614",
    "user": "https://github.com/dimpase"
}
```
CC:  @williamstein @slel

Keywords: arb, RBF, RealBallField, special functions

Part of #24641.

Following a [report by Harald Helfgott on sage-devel](https://groups.google.com/g/sage-devel/c/rOputadfR54):

- Currently `RBF(gamma(3/2, 1))` errors out, as
  `arb_hypgeom_gamma_upper` is not known to the arb interface
- Same for other special functions `erfi`, `Ei`,...

Here, by wrapping the corresponding functions from arb,
we add real ball special functions:

- `erfi` -- imaginary error function
- `Ei` -- exponential integral
- `Si` -- sine integral
- `Ci` -- cosine integral
- `Shi` -- hyperbolic sine integral
- `Chi` -- hyperbolic cosine integral
- `li` -- logarithmic integral
- `Li` -- offset logarithmic integral
- `beta` -- complete Beta function
- `gamma_inc` -- upper incomplete Gamma function
- `gamma_inc_lower` -- lower incomplete Gamma function

and we clarify that `zeta` with an extra argument
gives the Hurwitz zeta function.


Issue created by migration from https://trac.sagemath.org/ticket/32851





---

archive/issue_comments_464579.json:
```json
{
    "body": "Many other special functions implemented in arb are still to be wrapped even at the level of `CBF`, including all of `acb_dirichlet`. And then we should add appropriate wrappers for real balls and, when necessary (because of multiple arguments etc.), for symbolic expressions.",
    "created_at": "2021-11-10T10:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464579",
    "user": "https://github.com/mezzarobba"
}
```

Many other special functions implemented in arb are still to be wrapped even at the level of `CBF`, including all of `acb_dirichlet`. And then we should add appropriate wrappers for real balls and, when necessary (because of multiple arguments etc.), for symbolic expressions.



---

archive/issue_comments_464580.json:
```json
{
    "body": "By the way, for `erfi` to work, so that \n\n```\nsage: RBF(erfi(1/sqrt(2)))\n```\ndoes not crash, one needs\n\n```diff\n--- a/src/sage/rings/real_arb.pyx\n+++ b/src/sage/rings/real_arb.pyx\n@@ -3468,6 +3468,21 @@ cdef class RealBall(RingElement):\n         if _do_sig(prec(self)): sig_off()\n         return res\n \n+    def erfi(self):\n+        \"\"\"\n+        Imaginary error function.\n+\n+        EXAMPLES::\n+\n+            sage: RBF(1/2).erfi()\n+            [0.614952094696511 +/- 2.22e-16]\n+        \"\"\"\n+        cdef RealBall res = self._new()\n+        if _do_sig(prec(self)): sig_on()\n+        arb_hypgeom_erfi(res.value, self.value, prec(self))\n+        if _do_sig(prec(self)): sig_off()\n+        return res\n+\n     def gamma(self):\n         \"\"\"\n         Return the image of this ball by the Euler Gamma function.\n```\n\nWithout this, one ends up with infinite recursion.",
    "created_at": "2021-11-10T14:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464580",
    "user": "https://github.com/dimpase"
}
```

By the way, for `erfi` to work, so that 

```
sage: RBF(erfi(1/sqrt(2)))
```
does not crash, one needs

```diff
--- a/src/sage/rings/real_arb.pyx
+++ b/src/sage/rings/real_arb.pyx
@@ -3468,6 +3468,21 @@ cdef class RealBall(RingElement):
         if _do_sig(prec(self)): sig_off()
         return res
 
+    def erfi(self):
+        """
+        Imaginary error function.
+
+        EXAMPLES::
+
+            sage: RBF(1/2).erfi()
+            [0.614952094696511 +/- 2.22e-16]
+        """
+        cdef RealBall res = self._new()
+        if _do_sig(prec(self)): sig_on()
+        arb_hypgeom_erfi(res.value, self.value, prec(self))
+        if _do_sig(prec(self)): sig_off()
+        return res
+
     def gamma(self):
         """
         Return the image of this ball by the Euler Gamma function.
```

Without this, one ends up with infinite recursion.



---

archive/issue_comments_464581.json:
```json
{
    "body": "What do you mean by \u201cwrapped, but still not known to the ARB interface\u201d in the new description?",
    "created_at": "2021-11-10T17:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464581",
    "user": "https://github.com/mezzarobba"
}
```

What do you mean by “wrapped, but still not known to the ARB interface” in the new description?



---

archive/issue_comments_464582.json:
```json
{
    "body": "Replying to [comment:5 mmezzarobba]:\n> What do you mean by \u201cwrapped, but still not known to the ARB interface\u201d in the new description?\n\nthat one needs the patch in comment:3 to be able to do `RBF(erfi())`.",
    "created_at": "2021-11-10T17:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464582",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:5 mmezzarobba]:
> What do you mean by “wrapped, but still not known to the ARB interface” in the new description?

that one needs the patch in comment:3 to be able to do `RBF(erfi())`.



---

archive/issue_comments_464583.json:
```json
{
    "body": "Replying to [comment:5 mmezzarobba]:\n> What do you mean by \u201cwrapped, but still not known to the ARB interface\u201d in the new description?\n\n\nI don't quite get what you did with `gamma()` in `real_arb.pyx`.\nThere is `def gamma(self)`, which is `RBF(self).gamma()`, and `def gamma(self, x)`, which is \n`RBF.gamma(x)` - and the latter leads to things like `RBF(gamma(3/2,1))` erroring out.\nIt also squats the incomplete gamma function place.",
    "created_at": "2021-11-10T18:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464583",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:5 mmezzarobba]:
> What do you mean by “wrapped, but still not known to the ARB interface” in the new description?


I don't quite get what you did with `gamma()` in `real_arb.pyx`.
There is `def gamma(self)`, which is `RBF(self).gamma()`, and `def gamma(self, x)`, which is 
`RBF.gamma(x)` - and the latter leads to things like `RBF(gamma(3/2,1))` erroring out.
It also squats the incomplete gamma function place.



---

archive/issue_comments_464584.json:
```json
{
    "body": "Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.",
    "created_at": "2021-11-10T19:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464584",
    "user": "https://github.com/dimpase"
}
```

Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.



---

archive/issue_comments_464585.json:
```json
{
    "body": "That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.",
    "created_at": "2021-11-10T19:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464585",
    "user": "https://github.com/dimpase"
}
```

That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.



---

archive/issue_comments_464586.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-10T19:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464586",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464587.json:
```json
{
    "body": "Sorry for confision. I guess the branch almost does the job:\n\n```\nsage: RBF(gamma(3/2,RBF(sqrt(2))))\n[0.37118875695353 +/- 3.29e-15]\n```\nworks, but\n\n```\nsage: RBF(gamma(3/2,sqrt(2)))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-93db2d9138f4> in <module>\n----> 1 RBF(gamma(Integer(3)/Integer(2),sqrt(Integer(2))))\n...\nhome/scratch2/dimpase/sage/sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/sage/rings/real_arb.pyx in sage.rings.real_arb.RealBall.gamma (build/cythonized/sage/rings/real_arb.c:25156)()\n   3506             if _do_sig(prec(self)): sig_off()\n   3507         else:\n-> 3508             a_ball = res._parent.coerce(a)\n   3509             if _do_sig(prec(self)): sig_on()\n   3510             arb_hypgeom_gamma_upper(res.value, self.value, a_ball.value, 0, prec(self))\n...\nTypeError: no canonical coercion from Symbolic Ring to Real ball field with 53 bits of precision\n```\n\nHow can this be fixed?\n\n---\nNew commits:",
    "created_at": "2021-11-10T19:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464587",
    "user": "https://github.com/dimpase"
}
```

Sorry for confision. I guess the branch almost does the job:

```
sage: RBF(gamma(3/2,RBF(sqrt(2))))
[0.37118875695353 +/- 3.29e-15]
```
works, but

```
sage: RBF(gamma(3/2,sqrt(2)))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-93db2d9138f4> in <module>
----> 1 RBF(gamma(Integer(3)/Integer(2),sqrt(Integer(2))))
...
home/scratch2/dimpase/sage/sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/sage/rings/real_arb.pyx in sage.rings.real_arb.RealBall.gamma (build/cythonized/sage/rings/real_arb.c:25156)()
   3506             if _do_sig(prec(self)): sig_off()
   3507         else:
-> 3508             a_ball = res._parent.coerce(a)
   3509             if _do_sig(prec(self)): sig_on()
   3510             arb_hypgeom_gamma_upper(res.value, self.value, a_ball.value, 0, prec(self))
...
TypeError: no canonical coercion from Symbolic Ring to Real ball field with 53 bits of precision
```

How can this be fixed?

---
New commits:



---

archive/issue_comments_464588.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-10T21:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_464589.json:
```json
{
    "body": "OK, this seems to be a complete branch. Please review.",
    "created_at": "2021-11-10T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464589",
    "user": "https://github.com/dimpase"
}
```

OK, this seems to be a complete branch. Please review.



---

archive/issue_comments_464590.json:
```json
{
    "body": "Changing keywords from \"\" to \"arb, RBF, RealBallField\".",
    "created_at": "2021-11-11T10:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464590",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "arb, RBF, RealBallField".



---

archive/issue_comments_464591.json:
```json
{
    "body": "Good, let me add easy things listed on #24641 here. This ticket needs review in particular at the place I convert the 2nd argument of the incomplete Gamma function to RBF, just by calling `RBF()`.\nPerhaps there is a better way to do this in cython.",
    "created_at": "2021-11-11T11:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464591",
    "user": "https://github.com/dimpase"
}
```

Good, let me add easy things listed on #24641 here. This ticket needs review in particular at the place I convert the 2nd argument of the incomplete Gamma function to RBF, just by calling `RBF()`.
Perhaps there is a better way to do this in cython.



---

archive/issue_comments_464592.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-11T11:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464592",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464593.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-11T12:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464594.json:
```json
{
    "body": "the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.\n\nI am not sure what exactly this implies w.r.t. to the precision of the answer.\n\nI'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.\nincomplete gamma.",
    "created_at": "2021-11-11T13:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464594",
    "user": "https://github.com/dimpase"
}
```

the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.

I am not sure what exactly this implies w.r.t. to the precision of the answer.

I'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.
incomplete gamma.



---

archive/issue_comments_464595.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-11T16:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464595",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464596.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-11T17:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464597.json:
```json
{
    "body": "Replying to [comment:22 dimpase]:\n> the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.\n> \n> I am not sure what exactly this implies w.r.t. to the precision of the answer.\n> \n> I'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.\n> incomplete gamma.\n\n\nThe precision passed to arb is basically a working precision that does not guarantee anything on the precision of the result (except that it tends to infinity when both the precision of the arguments and the working precision do). When there are arguments of different precisions, it usually does not make sense to ask for more than the minimum of their precisions, but arb will typically do the right thing even if you do and there will be little performance penalty.",
    "created_at": "2021-11-11T18:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464597",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:22 dimpase]:
> the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.
> 
> I am not sure what exactly this implies w.r.t. to the precision of the answer.
> 
> I'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.
> incomplete gamma.


The precision passed to arb is basically a working precision that does not guarantee anything on the precision of the result (except that it tends to infinity when both the precision of the arguments and the working precision do). When there are arguments of different precisions, it usually does not make sense to ask for more than the minimum of their precisions, but arb will typically do the right thing even if you do and there will be little performance penalty.



---

archive/issue_comments_464598.json:
```json
{
    "body": "Replying to [comment:12 dimpase]:\n> That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.\n\n\nYes. The point of `RBF.gamma(foo)` is that one can compute gamma much more efficiently when the argument is a small rational, but of course one then needs to pass the rational exactly. To my eyes, having this type of things as a method of `RBF` is not really different from things like `RR.pi()` or even `Foo.gen()`.",
    "created_at": "2021-11-11T18:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464598",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:12 dimpase]:
> That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.


Yes. The point of `RBF.gamma(foo)` is that one can compute gamma much more efficiently when the argument is a small rational, but of course one then needs to pass the rational exactly. To my eyes, having this type of things as a method of `RBF` is not really different from things like `RR.pi()` or even `Foo.gen()`.



---

archive/issue_comments_464599.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.\n\n\nProbably all there is to it is that these functions were added before the incomplete gamma function was available in arb (for real balls at least).",
    "created_at": "2021-11-11T18:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464599",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:11 dimpase]:
> Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.


Probably all there is to it is that these functions were added before the incomplete gamma function was available in arb (for real balls at least).



---

archive/issue_comments_464600.json:
```json
{
    "body": "There is an article missing in\n\n```\n+        Otherwise, it computes Hurwitz zeta function.\n```\nand I would suggest adding\n\n```\ngamma_inc = gamma\n```\nin `RealBall` since both names are used in Sage.",
    "created_at": "2021-11-11T18:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464600",
    "user": "https://github.com/mezzarobba"
}
```

There is an article missing in

```
+        Otherwise, it computes Hurwitz zeta function.
```
and I would suggest adding

```
gamma_inc = gamma
```
in `RealBall` since both names are used in Sage.



---

archive/issue_comments_464601.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-11T20:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464601",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464602.json:
```json
{
    "body": "`gamma_inc` added to the place where it's really making sense, i.e. where `gamma` may mean `gamma_inc`.",
    "created_at": "2021-11-11T20:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464602",
    "user": "https://github.com/dimpase"
}
```

`gamma_inc` added to the place where it's really making sense, i.e. where `gamma` may mean `gamma_inc`.



---

archive/issue_comments_464603.json:
```json
{
    "body": "For functions with an additional parameter, you convert the parameter into `RBF`. Existing wrappers for arb special functions use coercions, not conversions. Coercion looks like a better choice to me, though this is debatable. In any case what we do with different functions should be consistent.\n\nSwitching from conversions to coercions breaks examples like `RBF(sin(3)).beta(sqrt(2/3))`, but `RBF(beta(sin(3),sqrt(2/3)))` (once implemented) will work, because the converter from symbolic expressions to real balls will traverse the expression and convert `sqrt(2/3)` recursively before it calls `beta`.\n\nAlso, all(?) occurrences of `RBF` in these conversions/coercions should be `self._parent`.\n\nI've implemented these changes, please feel free to revert to your branch if you disagree.",
    "created_at": "2021-11-12T09:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464603",
    "user": "https://github.com/mezzarobba"
}
```

For functions with an additional parameter, you convert the parameter into `RBF`. Existing wrappers for arb special functions use coercions, not conversions. Coercion looks like a better choice to me, though this is debatable. In any case what we do with different functions should be consistent.

Switching from conversions to coercions breaks examples like `RBF(sin(3)).beta(sqrt(2/3))`, but `RBF(beta(sin(3),sqrt(2/3)))` (once implemented) will work, because the converter from symbolic expressions to real balls will traverse the expression and convert `sqrt(2/3)` recursively before it calls `beta`.

Also, all(?) occurrences of `RBF` in these conversions/coercions should be `self._parent`.

I've implemented these changes, please feel free to revert to your branch if you disagree.



---

archive/issue_comments_464604.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-12T09:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464604",
    "user": "https://github.com/mezzarobba"
}
```

New commits:



---

archive/issue_comments_464605.json:
```json
{
    "body": "how about trying coercion, and if it fails switching to conversion, i.e. calling RBF() ?",
    "created_at": "2021-11-12T09:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464605",
    "user": "https://github.com/dimpase"
}
```

how about trying coercion, and if it fails switching to conversion, i.e. calling RBF() ?



---

archive/issue_comments_464606.json:
```json
{
    "body": "the commit message for `beta` says:\n\n```\nwrapped arb's complete beta function\n\nthere are issues with Sage's beta being also\nimplemented via pynac, so RBF(beta(a,b)) does not\nwork, one needs RBF(a).beta(b) instead.\n```\n\nunless I miss something, your  change breaks `beta` on symbolic args.",
    "created_at": "2021-11-12T09:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464606",
    "user": "https://github.com/dimpase"
}
```

the commit message for `beta` says:

```
wrapped arb's complete beta function

there are issues with Sage's beta being also
implemented via pynac, so RBF(beta(a,b)) does not
work, one needs RBF(a).beta(b) instead.
```

unless I miss something, your  change breaks `beta` on symbolic args.



---

archive/issue_comments_464607.json:
```json
{
    "body": "Replying to [comment:34 dimpase]:\n> unless I miss something, your  change breaks `beta` on symbolic args.\n\n\nRegarding `a.beta(b)`, yes it does, and that's intentional.\n\nAs for `RBF(beta(a,b))`, the main reason it does not work is that `Function_beta` does not define the magic method `_method_arguments()` needed to specify how to map the arguments of the symbolic functions to those of the method.\n\nNevertheless, it seems that you are right and implementing `_method_arguments()` is not enough, because, contrary to what I said above, `Expression._arb_()` does not convert the arguments before calling the method. And indeed it shouldn't, since for some functions, the additional argument is not a ball.\n\nI don't like the idea of `ball.special_function(param)` triggering a conversion, but I don't know how to solve the issue...",
    "created_at": "2021-11-12T10:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464607",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:34 dimpase]:
> unless I miss something, your  change breaks `beta` on symbolic args.


Regarding `a.beta(b)`, yes it does, and that's intentional.

As for `RBF(beta(a,b))`, the main reason it does not work is that `Function_beta` does not define the magic method `_method_arguments()` needed to specify how to map the arguments of the symbolic functions to those of the method.

Nevertheless, it seems that you are right and implementing `_method_arguments()` is not enough, because, contrary to what I said above, `Expression._arb_()` does not convert the arguments before calling the method. And indeed it shouldn't, since for some functions, the additional argument is not a ball.

I don't like the idea of `ball.special_function(param)` triggering a conversion, but I don't know how to solve the issue...



---

archive/issue_comments_464608.json:
```json
{
    "body": "I don't know how the generic conversion is implemented, but for efficiency reasons it ought to try something cheap, i.e. coersion, first, so if this is true then the extra try/except I proposed in the previous comment is not even needed.",
    "created_at": "2021-11-12T13:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464608",
    "user": "https://github.com/dimpase"
}
```

I don't know how the generic conversion is implemented, but for efficiency reasons it ought to try something cheap, i.e. coersion, first, so if this is true then the extra try/except I proposed in the previous comment is not even needed.



---

archive/issue_comments_464609.json:
```json
{
    "body": "To be clear, I am not concerned about performance issues. I don't like the idea of special functions converting their argument because conversions are unsafe and should be as explicit as possible (that's the whole point of the conversion/coercion distinction).",
    "created_at": "2021-11-13T09:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464609",
    "user": "https://github.com/mezzarobba"
}
```

To be clear, I am not concerned about performance issues. I don't like the idea of special functions converting their argument because conversions are unsafe and should be as explicit as possible (that's the whole point of the conversion/coercion distinction).



---

archive/issue_comments_464610.json:
```json
{
    "body": "OK, fine. I thought I was just making it consistent with, say, `RR`, but it's in fact not so.\nAdd yourself as author/reviewer then :-)",
    "created_at": "2021-11-13T10:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464610",
    "user": "https://github.com/dimpase"
}
```

OK, fine. I thought I was just making it consistent with, say, `RR`, but it's in fact not so.
Add yourself as author/reviewer then :-)



---

archive/issue_comments_464611.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-13T10:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464611",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464612.json:
```json
{
    "body": "Ok, thank you!",
    "created_at": "2021-11-13T10:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464612",
    "user": "https://github.com/mezzarobba"
}
```

Ok, thank you!



---

archive/issue_comments_464613.json:
```json
{
    "body": "Changing keywords from \"arb, RBF, RealBallField\" to \"arb, RBF, RealBallField, special functions\".",
    "created_at": "2021-11-13T14:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464613",
    "user": "https://github.com/slel"
}
```

Changing keywords from "arb, RBF, RealBallField" to "arb, RBF, RealBallField, special functions".



---

archive/issue_comments_464614.json:
```json
{
    "body": "The docstring for beta mentions Gamma,\nis that a copy-pasto?",
    "created_at": "2021-11-13T14:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464614",
    "user": "https://github.com/slel"
}
```

The docstring for beta mentions Gamma,
is that a copy-pasto?



---

archive/issue_comments_464615.json:
```json
{
    "body": "In `src/sage/rings/complex_arb.pyx` we have\n\n- uncapitalized `ei`, `si`, `ci`, `shi`, `chi`\n- `li(self, bint offset=False)`\n  rather than `li` and `Li`\n\nI would use the same here for consistency.\nWhat do you think?",
    "created_at": "2021-11-13T14:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464615",
    "user": "https://github.com/slel"
}
```

In `src/sage/rings/complex_arb.pyx` we have

- uncapitalized `ei`, `si`, `ci`, `shi`, `chi`
- `li(self, bint offset=False)`
  rather than `li` and `Li`

I would use the same here for consistency.
What do you think?



---

archive/issue_comments_464616.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-11-13T14:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464616",
    "user": "https://github.com/slel"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_464617.json:
```json
{
    "body": "Thanks Samuel, I indeed went too fast with the review!",
    "created_at": "2021-11-13T16:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464617",
    "user": "https://github.com/mezzarobba"
}
```

Thanks Samuel, I indeed went too fast with the review!



---

archive/issue_comments_464618.json:
```json
{
    "body": "huh? Li and li are different Sage symbolic functions. Both need to be dealt with by RBF",
    "created_at": "2021-11-13T20:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464618",
    "user": "https://github.com/dimpase"
}
```

huh? Li and li are different Sage symbolic functions. Both need to be dealt with by RBF



---

archive/issue_comments_464619.json:
```json
{
    "body": "the inconsistency is in CBF, and ought to be addressed on another ticket, not here.\nSage does not have ei, it has Ei, using ei in place of Ei is just creating confusion.",
    "created_at": "2021-11-13T21:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464619",
    "user": "https://github.com/dimpase"
}
```

the inconsistency is in CBF, and ought to be addressed on another ticket, not here.
Sage does not have ei, it has Ei, using ei in place of Ei is just creating confusion.



---

archive/issue_comments_464620.json:
```json
{
    "body": "It's `CBF` that can't properly handle symbolic arguments, e.g. `CBF(Ei(I))` leads to an infinite recursion, just as `RBF(Ei(1))` did before the fixes introduced in this ticket. And `CBF(Ei(I))` doesn't work because there `CBF` does not know anything about Sage function `Ei`, it only knows about how to compute `Ei(t)` for t converted to CBF, by calling an improperly named `CBF(t).ei()`.\n\nA fix is trivial:\n\n```diff\n--- a/src/sage/rings/complex_arb.pyx\n+++ b/src/sage/rings/complex_arb.pyx\n@@ -4192,6 +4192,8 @@ cdef class ComplexBall(RingElement):\n         if _do_sig(prec(self)): sig_off()\n         return result\n \n+    Ei = ei\n+\n     def si(self):\n         \"\"\"\n         Return the sine integral with argument ``self``.\n```\n\nNow we can do\n\n```\nsage: CBF(Ei(I))\n[0.337403922900968 +/- 4.31e-16] + [2.51687939716208 +/- 2.01e-15]*I\n```\n\nI'm setting this back to positive review, and invite everyone to deal with the `CBF` issue in #32869.",
    "created_at": "2021-11-13T23:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464620",
    "user": "https://github.com/dimpase"
}
```

It's `CBF` that can't properly handle symbolic arguments, e.g. `CBF(Ei(I))` leads to an infinite recursion, just as `RBF(Ei(1))` did before the fixes introduced in this ticket. And `CBF(Ei(I))` doesn't work because there `CBF` does not know anything about Sage function `Ei`, it only knows about how to compute `Ei(t)` for t converted to CBF, by calling an improperly named `CBF(t).ei()`.

A fix is trivial:

```diff
--- a/src/sage/rings/complex_arb.pyx
+++ b/src/sage/rings/complex_arb.pyx
@@ -4192,6 +4192,8 @@ cdef class ComplexBall(RingElement):
         if _do_sig(prec(self)): sig_off()
         return result
 
+    Ei = ei
+
     def si(self):
         """
         Return the sine integral with argument ``self``.
```

Now we can do

```
sage: CBF(Ei(I))
[0.337403922900968 +/- 4.31e-16] + [2.51687939716208 +/- 2.01e-15]*I
```

I'm setting this back to positive review, and invite everyone to deal with the `CBF` issue in #32869.



---

archive/issue_comments_464621.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-11-13T23:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464621",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_464622.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-11-14T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_464623.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2021-11-14T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464623",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_464624.json:
```json
{
    "body": "But Samuel is right that the docstring of beta was incorrect. I fixed this, made a couple of other minor improvements, and rebased the branch on top of the last beta.\n\nI agree that some of the methods of `CBF` have badly chosen names/interfaces in view of what is available in `sage.functions`. Part of the reason, I guess, is that these methods were added (in #19082) before the mechanism for calling them when converting symbolic expressions.\n\nFrom my point of view (and I thinks this may explain some of the misunderstandings on this ticket), the main goal of the methods of the form `ComplexBall.special_function()` is to provide a clean interface to the special functions available in Arb. `CBF(constant_expression)` sort of works now, but it is a fragile hack, and I do not recommend relying on it.\n\nAs a side note, it is not necessary for `CBF(f(x))` to work that `f` and the method it defers to have the same: the symbolic function can also provide the mapping. But I agree that it makes more sense in the present situation to rename the methods of `ComplexBall`.",
    "created_at": "2021-11-14T09:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464624",
    "user": "https://github.com/mezzarobba"
}
```

But Samuel is right that the docstring of beta was incorrect. I fixed this, made a couple of other minor improvements, and rebased the branch on top of the last beta.

I agree that some of the methods of `CBF` have badly chosen names/interfaces in view of what is available in `sage.functions`. Part of the reason, I guess, is that these methods were added (in #19082) before the mechanism for calling them when converting symbolic expressions.

From my point of view (and I thinks this may explain some of the misunderstandings on this ticket), the main goal of the methods of the form `ComplexBall.special_function()` is to provide a clean interface to the special functions available in Arb. `CBF(constant_expression)` sort of works now, but it is a fragile hack, and I do not recommend relying on it.

As a side note, it is not necessary for `CBF(f(x))` to work that `f` and the method it defers to have the same: the symbolic function can also provide the mapping. But I agree that it makes more sense in the present situation to rename the methods of `ComplexBall`.



---

archive/issue_comments_464625.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-14T11:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464626.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-14T12:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464626",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464627.json:
```json
{
    "body": "OK, thanks!",
    "created_at": "2021-11-14T12:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464627",
    "user": "https://github.com/dimpase"
}
```

OK, thanks!



---

archive/issue_comments_464628.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-11-15T23:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32614#issuecomment-464628",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086875.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-11-15T23:16:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32614",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32614#event-86875"
}
```
