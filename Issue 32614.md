# Issue 32614: wrap more arb functions

Issue created by migration from https://trac.sagemath.org/ticket/32851

Original creator: dimpase

Original creation time: 2021-11-10 09:53:21

CC:  was slelievre

currently e.g. `RBF(gamma(3/2,1))` is erroring out, as 
`arb_hypgeom_gamma_upper` is not wrapped.


---

Comment by mmezzarobba created at 2021-11-10 10:42:54

Many other special functions implemented in arb are still to be wrapped even at the level of `CBF`, including all of `acb_dirichlet`. And then we should add appropriate wrappers for real balls and, when necessary (because of multiple arguments etc.), for symbolic expressions.


---

Comment by dimpase created at 2021-11-10 14:49:01

By the way, for `erfi` to work, so that 

```
sage: RBF(erfi(1/sqrt(2)))
```

does not crash, one needs

```diff
--- a/src/sage/rings/real_arb.pyx
+++ b/src/sage/rings/real_arb.pyx
@@ -3468,6 +3468,21 @@ cdef class RealBall(RingElement):
         if _do_sig(prec(self)): sig_off()
         return res
 
+    def erfi(self):
+        """
+        Imaginary error function.
+
+        EXAMPLES::
+
+            sage: RBF(1/2).erfi()
+            [0.614952094696511 +/- 2.22e-16]
+        """
+        cdef RealBall res = self._new()
+        if _do_sig(prec(self)): sig_on()
+        arb_hypgeom_erfi(res.value, self.value, prec(self))
+        if _do_sig(prec(self)): sig_off()
+        return res
+
     def gamma(self):
         """
         Return the image of this ball by the Euler Gamma function.
```


Without this, one ends up with infinite recursion.


---

Comment by mmezzarobba created at 2021-11-10 17:14:02

What do you mean by “wrapped, but still not known to the ARB interface” in the new description?


---

Comment by dimpase created at 2021-11-10 17:22:16

Replying to [comment:5 mmezzarobba]:
> What do you mean by “wrapped, but still not known to the ARB interface” in the new description?
that one needs the patch in comment:3 to be able to do `RBF(erfi())`.


---

Comment by dimpase created at 2021-11-10 18:20:22

Replying to [comment:5 mmezzarobba]:
> What do you mean by “wrapped, but still not known to the ARB interface” in the new description?

I don't quite get what you did with `gamma()` in `real_arb.pyx`.
There is `def gamma(self)`, which is `RBF(self).gamma()`, and `def gamma(self, x)`, which is 
`RBF.gamma(x)` - and the latter leads to things like `RBF(gamma(3/2,1))` erroring out.
It also squats the incomplete gamma function place.


---

Comment by dimpase created at 2021-11-10 19:05:30

Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.


---

Comment by dimpase created at 2021-11-10 19:09:47

That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.


---

Comment by dimpase created at 2021-11-10 19:41:20

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-11-10 19:41:20

Sorry for confision. I guess the branch almost does the job:

```
sage: RBF(gamma(3/2,RBF(sqrt(2))))
[0.37118875695353 +/- 3.29e-15]
```

works, but

```
sage: RBF(gamma(3/2,sqrt(2)))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-93db2d9138f4> in <module>
----> 1 RBF(gamma(Integer(3)/Integer(2),sqrt(Integer(2))))
...
home/scratch2/dimpase/sage/sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/sage/rings/real_arb.pyx in sage.rings.real_arb.RealBall.gamma (build/cythonized/sage/rings/real_arb.c:25156)()
   3506             if _do_sig(prec(self)): sig_off()
   3507         else:
-> 3508             a_ball = res._parent.coerce(a)
   3509             if _do_sig(prec(self)): sig_on()
   3510             arb_hypgeom_gamma_upper(res.value, self.value, a_ball.value, 0, prec(self))
...
TypeError: no canonical coercion from Symbolic Ring to Real ball field with 53 bits of precision
```


How can this be fixed?
----
New commits:


---

Comment by git created at 2021-11-10 21:19:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-11-10 21:20:14

OK, this seems to be a complete branch. Please review.


---

Comment by slelievre created at 2021-11-11 10:30:12

Changing keywords from "" to "arb, RBF, RealBallField".


---

Comment by dimpase created at 2021-11-11 11:14:14

Good, let me add easy things listed on #24641 here. This ticket needs review in particular at the place I convert the 2nd argument of the incomplete Gamma function to RBF, just by calling `RBF()`.
Perhaps there is a better way to do this in cython.


---

Comment by git created at 2021-11-11 11:38:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 12:27:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-11 13:05:24

the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.

I am not sure what exactly this implies w.r.t. to the precision of the answer.

I'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.
incomplete gamma.


---

Comment by git created at 2021-11-11 16:27:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 17:48:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2021-11-11 18:22:30

Replying to [comment:22 dimpase]:
> the precision  (the last argument) in the calls to arb is always taken to be the precision of the 1st argument.
> 
> I am not sure what exactly this implies w.r.t. to the precision of the answer.
> 
> I'm also not sure whether this is always correct in the cases with more than 1 argument, e.g.
> incomplete gamma.

The precision passed to arb is basically a working precision that does not guarantee anything on the precision of the result (except that it tends to infinity when both the precision of the arguments and the working precision do). When there are arguments of different precisions, it usually does not make sense to ask for more than the minimum of their precisions, but arb will typically do the right thing even if you do and there will be little performance penalty.


---

Comment by mmezzarobba created at 2021-11-11 18:34:51

Replying to [comment:12 dimpase]:
> That `RBF.gamma(foo)` is actually quite misleading, as it gives you an impression that it magically computes `gamma(foo)` and converts the result into `RBF`, while in fact it uses a special arb implementation for `gamma(foo)` with `foo` being integer or rational, nothing magical at all.

Yes. The point of `RBF.gamma(foo)` is that one can compute gamma much more efficiently when the argument is a small rational, but of course one then needs to pass the rational exactly. To my eyes, having this type of things as a method of `RBF` is not really different from things like `RR.pi()` or even `Foo.gen()`.


---

Comment by mmezzarobba created at 2021-11-11 18:38:24

Replying to [comment:11 dimpase]:
> Can we put the code from `gamma(self, x)` into `gamma(self)` and do the dispatch on the type of the argument there? This will free the slot of `gamma(self, x)` - but perhaps break some grand design which I don't get.

Probably all there is to it is that these functions were added before the incomplete gamma function was available in arb (for real balls at least).


---

Comment by mmezzarobba created at 2021-11-11 18:40:49

There is an article missing in

```
+        Otherwise, it computes Hurwitz zeta function.
```

and I would suggest adding

```
gamma_inc = gamma
```

in `RealBall` since both names are used in Sage.


---

Comment by git created at 2021-11-11 20:17:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-11 20:19:27

`gamma_inc` added to the place where it's really making sense, i.e. where `gamma` may mean `gamma_inc`.


---

Comment by mmezzarobba created at 2021-11-12 09:08:32

For functions with an additional parameter, you convert the parameter into `RBF`. Existing wrappers for arb special functions use coercions, not conversions. Coercion looks like a better choice to me, though this is debatable. In any case what we do with different functions should be consistent.

Switching from conversions to coercions breaks examples like `RBF(sin(3)).beta(sqrt(2/3))`, but `RBF(beta(sin(3),sqrt(2/3)))` (once implemented) will work, because the converter from symbolic expressions to real balls will traverse the expression and convert `sqrt(2/3)` recursively before it calls `beta`.

Also, all(?) occurrences of `RBF` in these conversions/coercions should be `self._parent`.

I've implemented these changes, please feel free to revert to your branch if you disagree.


---

Comment by mmezzarobba created at 2021-11-12 09:09:21

New commits:


---

Comment by dimpase created at 2021-11-12 09:34:55

how about trying coercion, and if it fails switching to conversion, i.e. calling RBF() ?


---

Comment by dimpase created at 2021-11-12 09:38:34

the commit message for `beta` says:

```
wrapped arb's complete beta function

there are issues with Sage's beta being also
implemented via pynac, so RBF(beta(a,b)) does not
work, one needs RBF(a).beta(b) instead.
```


unless I miss something, your  change breaks `beta` on symbolic args.


---

Comment by mmezzarobba created at 2021-11-12 10:27:56

Replying to [comment:34 dimpase]:
> unless I miss something, your  change breaks `beta` on symbolic args.

Regarding `a.beta(b)`, yes it does, and that's intentional.

As for `RBF(beta(a,b))`, the main reason it does not work is that `Function_beta` does not define the magic method `_method_arguments()` needed to specify how to map the arguments of the symbolic functions to those of the method.

Nevertheless, it seems that you are right and implementing `_method_arguments()` is not enough, because, contrary to what I said above, `Expression._arb_()` does not convert the arguments before calling the method. And indeed it shouldn't, since for some functions, the additional argument is not a ball.

I don't like the idea of `ball.special_function(param)` triggering a conversion, but I don't know how to solve the issue...


---

Comment by dimpase created at 2021-11-12 13:40:21

I don't know how the generic conversion is implemented, but for efficiency reasons it ought to try something cheap, i.e. coersion, first, so if this is true then the extra try/except I proposed in the previous comment is not even needed.


---

Comment by mmezzarobba created at 2021-11-13 09:05:59

To be clear, I am not concerned about performance issues. I don't like the idea of special functions converting their argument because conversions are unsafe and should be as explicit as possible (that's the whole point of the conversion/coercion distinction).


---

Comment by dimpase created at 2021-11-13 10:17:30

OK, fine. I thought I was just making it consistent with, say, `RR`, but it's in fact not so.
Add yourself as author/reviewer then :-)


---

Comment by dimpase created at 2021-11-13 10:17:30

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2021-11-13 10:32:22

Ok, thank you!


---

Comment by slelievre created at 2021-11-13 14:21:27

Changing keywords from "arb, RBF, RealBallField" to "arb, RBF, RealBallField, special functions".


---

Comment by slelievre created at 2021-11-13 14:21:27

The docstring for beta mentions Gamma,
is that a copy-pasto?


---

Comment by slelievre created at 2021-11-13 14:36:03

In `src/sage/rings/complex_arb.pyx` we have

- uncapitalized `ei`, `si`, `ci`, `shi`, `chi`
- `li(self, bint offset=False)`
  rather than `li` and `Li`

I would use the same here for consistency.
What do you think?


---

Comment by slelievre created at 2021-11-13 14:36:03

Changing status from positive_review to needs_work.


---

Comment by mmezzarobba created at 2021-11-13 16:28:34

Thanks Samuel, I indeed went too fast with the review!


---

Comment by dimpase created at 2021-11-13 20:58:46

huh? Li and li are different Sage symbolic functions. Both need to be dealt with by RBF


---

Comment by dimpase created at 2021-11-13 21:03:47

the inconsistency is in CBF, and ought to be addressed on another ticket, not here.
Sage does not have ei, it has Ei, using ei in place of Ei is just creating confusion.


---

Comment by dimpase created at 2021-11-13 23:43:17

It's `CBF` that can't properly handle symbolic arguments, e.g. `CBF(Ei(I))` leads to an infinite recursion, just as `RBF(Ei(1))` did before the fixes introduced in this ticket. And `CBF(Ei(I))` doesn't work because there `CBF` does not know anything about Sage function `Ei`, it only knows about how to compute `Ei(t)` for t converted to CBF, by calling an improperly named `CBF(t).ei()`.

A fix is trivial:

```diff
--- a/src/sage/rings/complex_arb.pyx
+++ b/src/sage/rings/complex_arb.pyx
@@ -4192,6 +4192,8 @@ cdef class ComplexBall(RingElement):
         if _do_sig(prec(self)): sig_off()
         return result
 
+    Ei = ei
+
     def si(self):
         """
         Return the sine integral with argument ``self``.
```


Now we can do

```
sage: CBF(Ei(I))
[0.337403922900968 +/- 4.31e-16] + [2.51687939716208 +/- 2.01e-15]*I
```


I'm setting this back to positive review, and invite everyone to deal with the `CBF` issue in #32869.


---

Comment by dimpase created at 2021-11-13 23:43:17

Changing status from needs_work to positive_review.


---

Comment by git created at 2021-11-14 09:43:11

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-11-14 09:43:11

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2021-11-14 09:52:53

But Samuel is right that the docstring of beta was incorrect. I fixed this, made a couple of other minor improvements, and rebased the branch on top of the last beta.

I agree that some of the methods of `CBF` have badly chosen names/interfaces in view of what is available in `sage.functions`. Part of the reason, I guess, is that these methods were added (in #19082) before the mechanism for calling them when converting symbolic expressions.

From my point of view (and I thinks this may explain some of the misunderstandings on this ticket), the main goal of the methods of the form `ComplexBall.special_function()` is to provide a clean interface to the special functions available in Arb. `CBF(constant_expression)` sort of works now, but it is a fragile hack, and I do not recommend relying on it.

As a side note, it is not necessary for `CBF(f(x))` to work that `f` and the method it defers to have the same: the symbolic function can also provide the mapping. But I agree that it makes more sense in the present situation to rename the methods of `ComplexBall`.


---

Comment by git created at 2021-11-14 11:18:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-14 12:54:56

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-11-14 12:54:56

OK, thanks!


---

Comment by vbraun created at 2021-11-15 23:16:20

Resolution: fixed
