# Issue 12686: Bug in sympow

archive/issues_012686.json:
```json
{
    "body": "Assignee: rlm\n\nCC:  mjo\n\nKeywords: sympow\n\nIn util.c there is a function free_data, which frees TACKS[0].  TACKS[0] is meant to be allocated in disk.c, but there are circumstances when TACKS[0] is not allocated.\n\nThe following patch seems to fix it.  Notice that it makes use of the fact that free(NULL) should do nothing in the C programming language.\n\n\n```\n--- sympow-1.018.1.p11/src/disk.c-orig  2012-04-19 02:33:51.000000000 +0000\n+++ sympow-1.018.1.p11/src/disk.c       2012-04-19 02:34:22.000000000 +0000\n@@ -39,7 +39,7 @@\n  else if (((sp&3)==0) && CM_CASE) {if (2*ep==sp) S[3]='l'; else S[3]='h';}\n  else {if (2*ep==sp) S[3]='L'; else S[3]='H';}\n  if (HECKE && dv) {TACKS[which]=malloc(dv*sizeof(QD)); TACKON[which]=dv;}\n- else if (dv<=sp/2) TACKON[which]=0;\n+ else if (dv<=sp/2) {TACKS[which]=NULL; TACKON[which]=0;}\n  else {TACKS[which]=malloc((dv-sp/2)*sizeof(QD)); TACKON[which]=dv-sp/2;}\n  S[4]=0; F=fopen(\"datafiles/param_data\",\"r\"); strcpy(U,S);\n  if (ANAL_RANK) {if (dv>0) U[0]='A'; else U[0]='m';}\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12858\n\n",
    "created_at": "2012-04-19T12:13:48Z",
    "labels": [
        "memleak",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Bug in sympow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12686",
    "user": "stephen"
}
```
Assignee: rlm

CC:  mjo

Keywords: sympow

In util.c there is a function free_data, which frees TACKS[0].  TACKS[0] is meant to be allocated in disk.c, but there are circumstances when TACKS[0] is not allocated.

The following patch seems to fix it.  Notice that it makes use of the fact that free(NULL) should do nothing in the C programming language.


```
--- sympow-1.018.1.p11/src/disk.c-orig  2012-04-19 02:33:51.000000000 +0000
+++ sympow-1.018.1.p11/src/disk.c       2012-04-19 02:34:22.000000000 +0000
@@ -39,7 +39,7 @@
  else if (((sp&3)==0) && CM_CASE) {if (2*ep==sp) S[3]='l'; else S[3]='h';}
  else {if (2*ep==sp) S[3]='L'; else S[3]='H';}
  if (HECKE && dv) {TACKS[which]=malloc(dv*sizeof(QD)); TACKON[which]=dv;}
- else if (dv<=sp/2) TACKON[which]=0;
+ else if (dv<=sp/2) {TACKS[which]=NULL; TACKON[which]=0;}
  else {TACKS[which]=malloc((dv-sp/2)*sizeof(QD)); TACKON[which]=dv-sp/2;}
  S[4]=0; F=fopen("datafiles/param_data","r"); strcpy(U,S);
  if (ANAL_RANK) {if (dv>0) U[0]='A'; else U[0]='m';}
```


Issue created by migration from https://trac.sagemath.org/ticket/12858





---

archive/issue_comments_151566.json:
```json
{
    "body": "Needs an spkg.  I'm sorry that I do not know enough about allocations to review this.   \n\nIs there any way to doctest this, just out of curiosity?",
    "created_at": "2012-06-20T20:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151566",
    "user": "kcrisman"
}
```

Needs an spkg.  I'm sorry that I do not know enough about allocations to review this.   

Is there any way to doctest this, just out of curiosity?



---

archive/issue_comments_151567.json:
```json
{
    "body": "Changing component from memleak to porting: BSD.",
    "created_at": "2013-04-02T01:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151567",
    "user": "kcrisman"
}
```

Changing component from memleak to porting: BSD.



---

archive/issue_comments_151568.json:
```json
{
    "body": "Changing assignee from rlm to pjeremy.",
    "created_at": "2013-04-02T01:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151568",
    "user": "kcrisman"
}
```

Changing assignee from rlm to pjeremy.



---

archive/issue_comments_151569.json:
```json
{
    "body": "I don't think this error only effects BSD.  Rather I think it is an error that only happens very rarely, and I got unlucky.\n\nAlso, I seem to have missed the message posted 10 months ago.  What do you mean by \"doctest\"?",
    "created_at": "2013-04-02T01:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151569",
    "user": "stephen"
}
```

I don't think this error only effects BSD.  Rather I think it is an error that only happens very rarely, and I got unlucky.

Also, I seem to have missed the message posted 10 months ago.  What do you mean by "doctest"?



---

archive/issue_comments_151570.json:
```json
{
    "body": "Sorry about that.\n\n\"doctest\" means that whenever we have a regression that we fix, we add a test to the suite of tests to check that it stays fixed.  Is there a command that failed or leaked, or did Sage simply fail to compile this spkg?",
    "created_at": "2013-04-02T02:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151570",
    "user": "kcrisman"
}
```

Sorry about that.

"doctest" means that whenever we have a regression that we fix, we add a test to the suite of tests to check that it stays fixed.  Is there a command that failed or leaked, or did Sage simply fail to compile this spkg?



---

archive/issue_comments_151571.json:
```json
{
    "body": "Changing component from porting: BSD to memleak.",
    "created_at": "2013-04-02T02:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151571",
    "user": "kcrisman"
}
```

Changing component from porting: BSD to memleak.



---

archive/issue_comments_151572.json:
```json
{
    "body": "Changing assignee from pjeremy to rlm.",
    "created_at": "2013-04-02T02:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151572",
    "user": "kcrisman"
}
```

Changing assignee from pjeremy to rlm.



---

archive/issue_comments_151573.json:
```json
{
    "body": "OK, I did find this error with a doctest.  I don't remember which doctest it was, but it was quite a few of them.\n\nBut I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.\n\nBut also, anyone who understands how malloc and free work should see instantly that the existing code has errors.\n\nSee `man 3 free` on any unix computer, e.g. on ubuntu:\n\n\n```\n       The free() function frees the memory space pointed  to  by  ptr,  which\n       must  have  been  returned  by a previous call to malloc(), calloc() or\n       realloc().  Otherwise, or if free(ptr) has already been called  before,\n       undefined behavior occurs.  If ptr is NULL, no operation is performed.\n```\n",
    "created_at": "2013-04-02T02:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151573",
    "user": "stephen"
}
```

OK, I did find this error with a doctest.  I don't remember which doctest it was, but it was quite a few of them.

But I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.

But also, anyone who understands how malloc and free work should see instantly that the existing code has errors.

See `man 3 free` on any unix computer, e.g. on ubuntu:


```
       The free() function frees the memory space pointed  to  by  ptr,  which
       must  have  been  returned  by a previous call to malloc(), calloc() or
       realloc().  Otherwise, or if free(ptr) has already been called  before,
       undefined behavior occurs.  If ptr is NULL, no operation is performed.
```




---

archive/issue_comments_151574.json:
```json
{
    "body": "> OK, I did find this error with a doctest.  I don't remember which doctest it was, but it was quite a few of them.\n> \n> But I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.\nIf you wouldn't mind terribly just undoing this patch and seeing which one it was, then we could add a nearly trivial patch adding a comment to that doctest saying `also tests that :trac:`12858` is fixed` or something like that.\n> But also, anyone who understands how malloc and free work should see instantly that the existing code has errors.\nSince I don't really know C, I don't :)  But presumably many other Sage developers do...",
    "created_at": "2013-04-02T12:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151574",
    "user": "kcrisman"
}
```

> OK, I did find this error with a doctest.  I don't remember which doctest it was, but it was quite a few of them.
> 
> But I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.
If you wouldn't mind terribly just undoing this patch and seeing which one it was, then we could add a nearly trivial patch adding a comment to that doctest saying `also tests that :trac:`12858` is fixed` or something like that.
> But also, anyone who understands how malloc and free work should see instantly that the existing code has errors.
Since I don't really know C, I don't :)  But presumably many other Sage developers do...



---

archive/issue_comments_151575.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> Since I don't really know C, I don't :)  But presumably many other Sage developers do...\n\nThe problem here is that sympow is not even legal C. We had that conversation a while ago with David Kirkby that sympow was probably by far the worst piece of code in sage and it couldn't even be entered in \"the obfuscated C contest\" since some bits are not even legal C.\n\nThe patch looks a bit weird but that's not any weirder than the surrounding code. And I actually understand the intent and by the look of it, it is the only case where TACKS[which] is not allocated. The other solution would be perform some check before deallocation.\n\nBut further, TACKS is an array of pointers, shouldn't the pointer be NULL if not allocated or is it just at the discretion of the compiler, or possibly a compilation option?",
    "created_at": "2013-04-03T08:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151575",
    "user": "fbissey"
}
```

Replying to [comment:6 kcrisman]:
> Since I don't really know C, I don't :)  But presumably many other Sage developers do...

The problem here is that sympow is not even legal C. We had that conversation a while ago with David Kirkby that sympow was probably by far the worst piece of code in sage and it couldn't even be entered in "the obfuscated C contest" since some bits are not even legal C.

The patch looks a bit weird but that's not any weirder than the surrounding code. And I actually understand the intent and by the look of it, it is the only case where TACKS[which] is not allocated. The other solution would be perform some check before deallocation.

But further, TACKS is an array of pointers, shouldn't the pointer be NULL if not allocated or is it just at the discretion of the compiler, or possibly a compilation option?



---

archive/issue_comments_151576.json:
```json
{
    "body": "My understanding is that arrays in C are not automatically initialized.",
    "created_at": "2013-04-03T13:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151576",
    "user": "stephen"
}
```

My understanding is that arrays in C are not automatically initialized.



---

archive/issue_comments_151577.json:
```json
{
    "body": "Replying to [comment:8 stephen]:\n> My understanding is that arrays in C are not automatically initialized.\n\nYou are quite right. Wishful thinking of my part, although there must a gcc flag to do it.",
    "created_at": "2013-04-04T09:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151577",
    "user": "fbissey"
}
```

Replying to [comment:8 stephen]:
> My understanding is that arrays in C are not automatically initialized.

You are quite right. Wishful thinking of my part, although there must a gcc flag to do it.



---

archive/issue_comments_151578.json:
```json
{
    "body": "> > But I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.\n> If you wouldn't mind terribly just undoing this patch and seeing which one it was, then we could add a nearly trivial patch adding a comment to that doctest saying `also tests that :trac:`12858` is fixed` or something like that.\nPing - *if* you happen to have time to check that out, I realize it could be annoying to do.",
    "created_at": "2013-04-25T16:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151578",
    "user": "kcrisman"
}
```

> > But I think it depends on the computer you are using, OS, probably amount of RAM, other processes, etc.  In my case it failed an existing doctest on one computer, and passed on other computers.
> If you wouldn't mind terribly just undoing this patch and seeing which one it was, then we could add a nearly trivial patch adding a comment to that doctest saying `also tests that :trac:`12858` is fixed` or something like that.
Ping - *if* you happen to have time to check that out, I realize it could be annoying to do.



---

archive/issue_comments_151579.json:
```json
{
    "body": "Adding keyword even though it may be a bug on all platforms, since it seems to have only been reported on FreeBSD.",
    "created_at": "2013-04-25T16:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151579",
    "user": "kcrisman"
}
```

Adding keyword even though it may be a bug on all platforms, since it seems to have only been reported on FreeBSD.



---

archive/issue_comments_151580.json:
```json
{
    "body": "Changing keywords from \"sympow\" to \"sympow FreeBSD\".",
    "created_at": "2013-04-25T16:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151580",
    "user": "kcrisman"
}
```

Changing keywords from "sympow" to "sympow FreeBSD".



---

archive/issue_comments_151581.json:
```json
{
    "body": "this appears still to be the case, see https://gitlab.com/rezozer/forks/sympow/-/blob/master/disk.c#L60\n(this [GitLab](GitLab) repo, I gather, is Debian's pseudo-upstream)",
    "created_at": "2020-11-02T16:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151581",
    "user": "dimpase"
}
```

this appears still to be the case, see https://gitlab.com/rezozer/forks/sympow/-/blob/master/disk.c#L60
(this [GitLab](GitLab) repo, I gather, is Debian's pseudo-upstream)



---

archive/issue_comments_151582.json:
```json
{
    "body": "I think this was fixed by removing the `free()` instead:\n\nhttps://gitlab.com/rezozer/forks/sympow/-/commit/f414d52ee601c54fab556ad2ecf79762ec7d5eef",
    "created_at": "2020-11-02T23:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151582",
    "user": "mjo"
}
```

I think this was fixed by removing the `free()` instead:

https://gitlab.com/rezozer/forks/sympow/-/commit/f414d52ee601c54fab556ad2ecf79762ec7d5eef



---

archive/issue_comments_151583.json:
```json
{
    "body": "this \"fix\" replaces a wrong attempt to free memory held (a bit wrongly, as some pointers that by right should be NULL are not always, as found on this ticket) in an array of pointers by no freeing at all.\n\nThis is of course fine if there are only created once during a run of the code, and this appears to be the case.",
    "created_at": "2020-11-03T09:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151583",
    "user": "dimpase"
}
```

this "fix" replaces a wrong attempt to free memory held (a bit wrongly, as some pointers that by right should be NULL are not always, as found on this ticket) in an array of pointers by no freeing at all.

This is of course fine if there are only created once during a run of the code, and this appears to be the case.



---

archive/issue_comments_151584.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-03T09:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151584",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_151585.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-03T09:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151585",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_151586.json:
```json
{
    "body": "I've opened https://gitlab.com/rezozer/forks/sympow/-/issues/6 just so that the upstream is aware of this.",
    "created_at": "2020-11-03T09:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151586",
    "user": "dimpase"
}
```

I've opened https://gitlab.com/rezozer/forks/sympow/-/issues/6 just so that the upstream is aware of this.



---

archive/issue_comments_151587.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-06-24T20:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12686#issuecomment-151587",
    "user": "mkoeppe"
}
```

Resolution: invalid
