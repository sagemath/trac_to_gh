# Issue 19271: Implementing RijndaelGF

Issue created by migration from https://trac.sagemath.org/ticket/19508

Original creator: tgagne

Original creation time: 2015-11-01 03:26:56

CC:  rbeezer malb

Keywords: cryptography, aes, rijndaelgf

This implements the Rijndael-GF polynomial representation of the AES cipher as described in Appendix A of Joan Daemen and Vincent Rijmen's "The Design of Rijndael".
This consists of a new `RijndaelGF` class which can be used to construct systems of polynomials which under evaluation behave identically to arbitrary sections of the AES cipher.

This was created in a research project with Professor Rob Beezer at the University of Puget Sound.
A comprehensive paper describing the motivation for this project and various details of its implementation can be found at: http://soundideas.pugetsound.edu/cgi/viewcontent.cgi?article=1390&context=summer_research


---

Comment by tgagne created at 2015-11-01 03:31:28

New commits:


---

Comment by tgagne created at 2015-11-01 21:22:33

Changing status from new to needs_review.


---

Comment by malb created at 2015-11-03 18:14:13

1. BES and Rijndael-GF

> This approach to implementing Rijndael-GF bears some similarity to the multivariate quadratic (MQ) systems utilized in :mod:`SR <sage.crypto.mq.sr>`, in that the MQ systems also seek to describe the AES cipher as a system of algebraic equations. Despite this initial similarity though, Rijndael-GF and :mod:`SR <sage.crypto.mq.sr>` are quite different, as this implementation operates over `(\GF{2<sup>8})</sup>{n_t}` and seeks to provide a fully generalized algebraic representation of both the whole AES cipher as well as its individual components, while :mod:`SR <sage.crypto.mq.sr>` operates on `(\GF{2})^{4 n_t}` and `(\GF{2})^{8 n_t}` and is instead a family of parameterizable variants of the AES suitable as a framework for comparing different cryptanalytic techniques that can be brought to bear on the AES.

This isn’t quite right. `mq.SR()` has two modes. `gf2=True` and `gf2=False`. The latter implements BES which also operates over `\GF{2^8}`.

2. At some point we should revisit where everything lives. The `mq` module was initially intended to hold all kinds of “algebraic cryptanalysis” code, but that never really got that far, partly because that sort of cryptanalysis didn’t produce any tangible results against block ciphers, really. In any case, Rijndael-GF seems similar to BES in being aimed at such strategies so either they should both live under `mq` or perhaps neither?

3. This is some extensive documentation, well done!

4. Functions like `hex_to_GF` which don’t use `self` at all, should be declared ``@`staticobject`. Actually, I’m not sure that function should live in Rijndael-GF at all, as it’s more general. Maybe a `string_to_field` or `field_io` module should be added?


---

Comment by malb created at 2015-11-03 18:14:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-11-04 00:52:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-04 00:52:44

Thanks so much for reviewing this, Martin!

A couple responses to some of your comments:

1. Looking more into how SR operates and its `gf2` mode, I realize that `mq.SR()` and `RijndaelGF` can indeed operate over the same state. I've removed that error from the documentation.

2. While Rijndael-GF's primary function isn't necessarily algebraic cryptanalysis, it's definitely similar enough to BES that your comment about the purpose of the `mq` module has convinced me that Rijndael-GF fits better into `mq`. I've now moved it there in the most recent commit.

4. `hex_to_GF` and `bin_to_GF` do actually use `self` by calling `self._F` to return an element of the field. On the other hand, `GF_to_bin` and `GF_to_hex` don't necessarily rely on `self` but they do use it for printing error messages; does it make sense to remove the reference to `self` in the error messages so that ``@`staticmethod` can be used? Also, I agree that those functions might not have the best home in Rijndael-GF and that a separate module might be better. Did you have in mind a more general `string_to_field` module or were you thinking of a module more specific to cryptography, since `hex_to_GF` for example only works when the field is `F(2^(4n))`?
----
New commits:
----
New commits:


---

Comment by tgagne created at 2015-11-04 00:52:44

Changing status from needs_work to needs_review.


---

Comment by malb created at 2015-11-04 18:07:21

Replying to [comment:6 tgagne]:
> Thanks so much for reviewing this, Martin!
> 
> A couple responses to some of your comments:
> 
> 1. Looking more into how SR operates and its `gf2` mode, I realize that `mq.SR()` and `RijndaelGF` can indeed operate over the same state. I've removed that error from the documentation.
> 
> 2. While Rijndael-GF's primary function isn't necessarily algebraic cryptanalysis, it's definitely similar enough to BES that your comment about the purpose of the `mq` module has convinced me that Rijndael-GF fits better into `mq`. I've now moved it there in the most recent commit.

Okay, cool, thanks.

> 4. `hex_to_GF` and `bin_to_GF` do actually use `self` by calling `self._F` to return an element of the field.

Ouch, sorry for missing this obvious dependency.

> On the other hand, `GF_to_bin` and `GF_to_hex` don't necessarily rely on `self` but they do use it for printing error messages; does it make sense to remove the reference to `self` in the error messages so that ``@`staticmethod` can be used?

No, it's good to have the symmetry with the other functions.

> Also, I agree that those functions might not have the best home in Rijndael-GF and that a separate module might be better. Did you have in mind a more general `string_to_field` module or were you thinking of a module more specific to cryptography, since `hex_to_GF` for example only works when the field is `F(2^(4n))`?

Ideally, we'd have the following:

- Finite fields GF(2<sup>{tn}</sup>) accept strings of the form "0xff" to produce elements.
- Matrix and vector spacess over these finite fields also accept strings, but split up the strings adedequately.
- Similarly for strings of the form "{0,1}^*" except that they'd work over any $GF(2<sup>n</sup>)$.

For the inverse direction, ideally we'd have methods on finite fields, vectors and matrices to do the conversion.

However, while this would nice this might be righly considered beyond the scope of this ticket (?)


---

Comment by tgagne created at 2015-11-04 20:43:30

Replying to [comment:7 malb]:

> Ideally, we'd have the following:
> 
> - Finite fields GF(2<sup>{tn}</sup>) accept strings of the form "0xff" to produce elements.
> - Matrix and vector spacess over these finite fields also accept strings, but split up the strings adedequately.
> - Similarly for strings of the form "{0,1}^*" except that they'd work over any $GF(2<sup>n</sup>)$.
> 
> For the inverse direction, ideally we'd have methods on finite fields, vectors and matrices to do the conversion.
> 
> However, while this would nice this might be righly considered beyond the scope of this ticket (?)

I think this is a fantastic idea and is definitely worth serious consideration.

I do think that this is far beyond the scope of this ticket however, and that until such functionality is implemented Rijndael-GF's conversion methods should for the most part remain as-is.


---

Comment by malb created at 2015-11-05 08:41:52

Replying to [comment:8 tgagne]:
> I think this is a fantastic idea and is definitely worth serious consideration.
> 
> I do think that this is far beyond the scope of this ticket however, and that until such functionality is implemented Rijndael-GF's conversion methods should for the most part remain as-is.

Fair enough. How about this for a plan: could you open a new ticket outlining a plan to clean up conversion GF ←→ hex/bit strings so this doesn't get lost and then we aslso rename the conversion functions to start with an "_" so that they are not considered part of an official API?

Once that is done, I think this is a positive review.


---

Comment by git created at 2015-11-05 20:27:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-05 20:29:56

Replying to [comment:9 malb]:

> Fair enough. How about this for a plan: could you open a new ticket outlining a plan to clean up conversion GF ←→ hex/bit strings so this doesn't get lost and then we aslso rename the conversion functions to start with an "_" so that they are not considered part of an official API?
> 
> Once that is done, I think this is a positive review.

Alright, I've added a ticket for GF hex/bin conversion at [#19531](http://trac.sagemath.org/ticket/19531#ticket) and I just pushed the renamed conversion methods for Rijndael-GF.


---

Comment by malb created at 2015-11-06 10:28:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-06 19:04:20

Docs don't build, as is obvious from the patchbot output:

```
[cryptogra] reading sources... [100%] sage/crypto/util
[cryptogra] loading cross citations...
[cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/miniaes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.miniaes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
[cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/sdes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.sdes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
Error building the documentation.
Traceback (most recent call last):
  File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 1636, in <module>
    getattr(get_builder(name), type)()
  File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python/multiprocessing/pool.py", line 558, in get
    raise self._value
OSError: [cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/miniaes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.miniaes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
```



---

Comment by vbraun created at 2015-11-06 19:04:20

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-11-06 20:43:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-06 20:50:51

Replying to [comment:13 vbraun]:
> Docs don't build, as is obvious from the patchbot output:
> {{{
> [cryptogra] reading sources... [100%] sage/crypto/util
> [cryptogra] loading cross citations...
> [cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/miniaes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.miniaes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
> [cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/sdes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.sdes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
> Error building the documentation.
> Traceback (most recent call last):
>   File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 1636, in <module>
>     getattr(get_builder(name), type)()
>   File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 302, in _wrapper
>     getattr(get_builder(document), 'inventory')(*args, **kwds)
>   File "/mnt/highperf/buildbot/slave/sage_git/build/src/doc/common/builder.py", line 513, in _wrapper
>     x.get(99999)
>   File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python/multiprocessing/pool.py", line 558, in get
>     raise self._value
> OSError: [cryptogra] /mnt/highperf/buildbot/slave/sage_git/build/src/doc/en/reference/cryptography/sage/crypto/block_cipher/miniaes.rst:11: WARNING: autodoc can't import/find module 'sage.crypto.block_cipher.miniaes', it reported error: "No module named rijndael_gf", please check your spelling and sys.path
> }}}

Thanks for catching this, Volker!
I've updated `block_cipher/all.py` so that it doesn't point towards the missing `rijndael_gf.py` and I added the new location to `mq/__init__.py`. 

This fixed the problem with building documentation for me, but I did have to do a `make doc` for it to work since the documentation was partially built for me. Hopefully you won't run into that issue.


---

Comment by jdemeyer created at 2015-11-07 11:22:03

Replying to [comment:15 tgagne]:
> This fixed the problem with building documentation for me, but I did have to do a `make doc` for it to work since the documentation was partially built for me.
I have no idea what you mean: it's obvious that you need to run `make doc` (or simply `make`) to build the documentation, it doesn't magically build by itself.

If you want the ticket to be reviewed, set it to needs_review.

One more detail: could you use the standard copyright template from [http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files](http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files)


---

Comment by malb created at 2015-11-07 12:16:01

Replying to [comment:13 vbraun]:
> Docs don't build, as is obvious from the patchbot output:

Argh, sorry for obviously not checking this earlier. I promise to up my reviewing game.


---

Comment by rbeezer created at 2015-11-07 17:57:57

They built fine earlier.  I believe this was a result of moving some files around, and I've not had time to stay on top of the iterations in this review.

Ideally, Thomas would have done a full suite of checks after each change.

Replying to [comment:17 malb]:
> Replying to [comment:13 vbraun]:
> > Docs don't build, as is obvious from the patchbot output:
> 
> Argh, sorry for obviously not checking this earlier. I promise to up my reviewing game.


---

Comment by rbeezer created at 2015-11-07 18:05:18

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 tgagne]:
> > This fixed the problem with building documentation for me, but I did have to do a `make doc` for it to work since the documentation was partially built for me.
> I have no idea what you mean: it's obvious that you need to run `make doc` (or simply `make`) to build the documentation, it doesn't magically build by itself.

No, of course the documentation does not build by itself, and Thomas knows that.  But `sage -docbuild reference html` (or similar) is what I tend to use first.  So I think Thomas is trying to help the reviewer by saying the change was big enough that the `make doc` command is the **necessary** command and other alternatives will not be successful.

Thanks for everyone's careful help with Thomas' summer undergraduate research project.  It will be a big accomplishment for him to add this to his collection of Sage contributions.


---

Comment by git created at 2015-11-08 04:18:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-08 04:53:33

Changing status from needs_work to needs_review.


---

Comment by tgagne created at 2015-11-08 04:53:33

Replying to [comment:19 rbeezer]:
> Replying to [comment:16 jdemeyer]:
> > Replying to [comment:15 tgagne]:
> > > This fixed the problem with building documentation for me, but I did have to do a `make doc` for it to work since the documentation was partially built for me.
> > I have no idea what you mean: it's obvious that you need to run `make doc` (or simply `make`) to build the documentation, it doesn't magically build by itself.
> 
> No, of course the documentation does not build by itself, and Thomas knows that.  But `sage -docbuild reference html` (or similar) is what I tend to use first.  So I think Thomas is trying to help the reviewer by saying the change was big enough that the `make doc` command is the **necessary** command and other alternatives will not be successful.

Couldn't have said this better myself. 

After moving the class to a different directory I mistakenly didn't rigorously check that the documentation built in a clean environment and so the documentation still appeared to work for me with `sage -docbuild reference/cryptography html`. After making the fix the files from the failed docbuilds were still causing minor errors with normal docbuilding which was why I recommended a forceful rebuild of everything with `make doc`.

I've done more testing on getting the documentation to build in a clean environment and I'm confident that the fix I pushed earlier makes it build properly.

Also:
Replying to [comment:16 jdemeyer]:
> One more detail: could you use the standard copyright template from ​http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files

Thanks for pointing this out! It's easy to let little things like this slip by.


---

Comment by jdemeyer created at 2015-11-09 04:18:13

Replying to [comment:21 tgagne]:
> > One more detail: could you use the standard copyright template from ​http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files
> 
> Thanks for pointing this out! It's easy to let little things like this slip by.

Did you forget to push this commit or something? I don't see any change in this part:

```
###########################################################################
# Copyright (c) 2015 Thomas Gagne <thomasgagne100@gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# http://www.gnu.org/licenses/
###########################################################################
```

The standard copyright template looks like

```
#*****************************************************************************
#       Copyright (C) 2013 YOUR NAME <your email>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  http://www.gnu.org/licenses/
#*****************************************************************************
```



---

Comment by git created at 2015-11-09 04:58:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-09 05:06:36

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 tgagne]:
> > > One more detail: could you use the standard copyright template from ​http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files
> > 
> > Thanks for pointing this out! It's easy to let little things like this slip by.
> 
> Did you forget to push this commit or something? I don't see any change in this part:

Whoops! Sorry about not getting that updated properly.


---

Comment by malb created at 2015-11-13 06:58:50

Okay, looks like patchbot is happy except for one item http://patchbot.sagemath.org/ticket/19508/ which seems to be related to a new module being added. 

But this is fine, I'd say, see https://groups.google.com/forum/#!topic/sage-devel/d7FVLt8Cyb8


---

Comment by git created at 2015-11-17 00:56:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tgagne created at 2015-11-17 01:00:17

Replying to [comment:25 malb]:
> Okay, looks like patchbot is happy except for one item http://patchbot.sagemath.org/ticket/19508/ which seems to be related to a new module being added. 
> 
> But this is fine, I'd say, see https://groups.google.com/forum/#!topic/sage-devel/d7FVLt8Cyb8

I changed the `__init__.py` file in `mq` to use `lazy_import` for Rijndael-GF like the link you posted suggests and since there's no change in the module's behavior I don't see any reason not to do it.
Hopefully this should resolve the patchbot issue.


---

Comment by malb created at 2015-11-17 10:17:17

Changing status from needs_review to positive_review.


---

Comment by malb created at 2015-11-17 10:17:17

Okay, patchbot seems happy. Restoring positive review.


---

Comment by vbraun created at 2015-11-19 03:48:17

Resolution: fixed
