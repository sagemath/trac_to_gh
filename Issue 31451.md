# Issue 31451: Pullbacks of manifold subsets under continuous maps

Issue created by migration from https://trac.sagemath.org/ticket/31688

Original creator: mkoeppe

Original creation time: 2021-04-19 00:13:11

CC:  egourgoulhon tscrim @mjungmath

Similar to #31653, given a continuous map `\Phi: N -> M` and a manifold subset `S` of `M`, we define the pullback (preimage) of `S` as the subset of `N` of points `p` with `\Phi(p)` in `S`.


---

Comment by git created at 2021-05-31 02:25:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-31 05:07:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-31 05:31:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-01 20:57:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-02 01:57:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-02 19:00:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-03 19:34:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-04 23:09:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-05 00:56:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-06-05 18:48:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-05 19:02:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-05 20:05:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-05 20:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-05 21:33:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-05 21:37:31

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-05 21:37:31

This is not quite ready yet, but comments are very welcome


---

Comment by git created at 2021-06-06 03:43:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-06-06 10:03:22

For a possible follow-up, it might be a good idea to bear in mind that the preimage of a regular value of a differentiable map between manifolds of dimension `n` and `m` respectively is a differentiable manifold of dimension `n-m` again.


---

Comment by git created at 2021-06-06 21:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-13 19:52:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-15 03:35:58

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by egourgoulhon created at 2021-06-16 12:49:32

As revealed by the patchbot, there are some doctest failures, as well as some coverage and pyflakes issues.


---

Comment by git created at 2021-06-16 16:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-16 16:39:17

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-16 16:39:17

Thanks for taking a look! Yes, I'll have to add more documentation and examples.


---

Comment by git created at 2021-06-16 17:19:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 00:59:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 01:28:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-17 01:29:21

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-17 05:43:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 13:07:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-17 20:04:49

Thanks for the last changes. 
Some comments regarding the documentation:

- there is no entry for the class `ManifoldSubsetPullback` in the reference manual
- in the files `continuous_map.py` and `subsets/pullback.py`, each instance of `:class:`ManifoldSubset`` should be replaced by `:class:`~sage.manifolds.subset.ManifoldSubset``
- the docstring of `ScalarField.pullback` should have an INPUT and OUTPUT sections similar to those of `ContinuousMap.preimage`. By the way, to be consistent with `ContinuousMap.preimage`, shouldn't `ScalarField.pullback` be renamed to `ScalarField.preimage`, with `pullback` defined as an alias to `preimage`?
- the INPUT and OUTPUT sections of `DiffMap.pullback` should be updated to take into account the new arguments.


---

Comment by git created at 2021-06-18 18:47:45

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-06-18 19:31:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-20 05:47:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-21 17:15:03

In the docstring of  `ManifoldSubsetPullback`: 
- in the INPUT section, there seems to be no entry for `ConvexSet_base` in the documentation

- in the following part of the EXAMPLES block:

```
sage: r_squared = M.scalar_field(x^2+y^2)
sage: r_squared.set_immutable()
sage: cl_I = RealSet((1, 4)); cl_I
(1, 4)
sage: cl_O = ManifoldSubsetPullback(r_squared, None, I); cl_O
```

  I guess `I` in the last line (which, at this stage, is the imaginary number _i_) should be replaced by `cl_I` and the subsequent `True` and `False` should become `False` and `True` respectively. But then, `cl_I` and `cl_O` are identical to `I` and `O` in the example that follows...


---

Comment by git created at 2021-06-21 18:05:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-21 18:05:37

Thanks for spotting this - I have fixed this and a similar example


---

Comment by mkoeppe created at 2021-06-21 18:06:12

Replying to [comment:50 egourgoulhon]:
> In the docstring of  `ManifoldSubsetPullback`: 
> - in the INPUT section, there seems to be no entry for `ConvexSet_base` in the documentation

You may need to run `./sage -docbuild reference/discrete_geometry html`


---

Comment by egourgoulhon created at 2021-06-21 20:02:31

Replying to [comment:53 mkoeppe]:
> Replying to [comment:50 egourgoulhon]:
> > In the docstring of  `ManifoldSubsetPullback`: 
> > - in the INPUT section, there seems to be no entry for `ConvexSet_base` in the documentation
> 
> You may need to run `./sage -docbuild reference/discrete_geometry html`
Yes indeed!


---

Comment by egourgoulhon created at 2021-06-21 20:50:04

Replying to [comment:52 mkoeppe]:
> Thanks for spotting this - I have fixed this and a similar example
Thanks. 

At the moment, we have 

```
sage: M = Manifold(2, 'M')                                                                          
sage: X.<x,y> = M.chart()                                                                           
sage: M.identity_map().preimage(M)                                                                  
Subset Id_M_inv_M of the 2-dimensional differentiable manifold M
sage: M.identity_map().preimage(M) is M                                                             
False
sage: M.zero_scalar_field().preimage(RealSet.point(0))                                              
Subset zero_inv_{0} of the 2-dimensional differentiable manifold M
sage: M.zero_scalar_field().preimage(RealSet.point(0)) is M                                         
False
```

Do you think it would be easy to have both answers to be `True`? If no, this should not hamper the current ticket, but be differed to another ticket.


---

Comment by git created at 2021-06-21 21:10:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-21 21:11:00

Sure, that's easy to do and certainly a good idea. Here it is for `ContinuousMap.preimage` already, I'll look into the case of the scalar fields


---

Comment by git created at 2021-06-21 21:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-21 21:24:07

More general things such as detecting that the preimage of [0,oo) under squaring is the full domain will have to wait until a follow-up ticket


---

Comment by egourgoulhon created at 2021-06-22 04:27:46

Replying to [comment:57 mkoeppe]:
> Sure, that's easy to do and certainly a good idea. Here it is for `ContinuousMap.preimage` already, 

Thanks. Maybe one can add

```
if self._is_isomorphism and codomain_subset == self._codomain:
    return self._domain
```



---

Comment by egourgoulhon created at 2021-06-22 04:37:09

The patchbot reports a doctest error in `src/sage/geometry/polyhedron/base.py` as well as pyflakes errors in `src/sage/manifolds/subsets/pullback.py`.


---

Comment by mkoeppe created at 2021-06-22 04:49:47

Replying to [comment:60 egourgoulhon]:
> Maybe one can add
> {{{
> if self._is_isomorphism and codomain_subset == self._codomain:
>     return self._domain
> }}}

I think I can do more generally

```
  if self._codomain.is_subset(codomain_subset):
      return self._domain
```



---

Comment by mkoeppe created at 2021-06-22 04:59:44

Replying to [comment:61 egourgoulhon]:
> The patchbot reports a doctest error in `src/sage/geometry/polyhedron/base.py` 

I've seen this one before locally, I don't think it's coming from this ticket, but I have opened #32030 for it


---

Comment by git created at 2021-06-22 05:22:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-22 08:46:15

Replying to [comment:62 mkoeppe]:
> Replying to [comment:60 egourgoulhon]:
> > Maybe one can add
> > {{{
> > if self._is_isomorphism and codomain_subset == self._codomain:
> >     return self._domain
> > }}}
> 
> I think I can do more generally
> {{{
>   if self._codomain.is_subset(codomain_subset):
>       return self._domain
> }}}
> 
Yes, indeed! Being an isomorphism is not necessary in that case.


---

Comment by git created at 2021-06-22 16:17:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-06-24 10:20:41

A minor point: to generate correctly the documentation, the following change shall be made in the docstring of `ManifoldSubsetPullback`:

```diff
-    - ``map`` - an instance of :class:`ContinuousMap`,
+    - ``map`` - an instance of :class:`~sage.manifolds.continuous_map.ContinuousMap`,
       :class:`ScalarField`, or :class:`Chart`
```

For `:class:`ScalarField`` and `:class:`Chart``, this is not necessary because these classes are imported in `pullback.py`.


---

Comment by egourgoulhon created at 2021-06-24 13:51:02

This example in the doctstring of `ManifoldSubsetPullback.is_closed` is dubious:

```

        The pullback of finite sets is closed::

            sage: F = Family([vector(QQ, [1, 2], immutable=True), vector(QQ, [2, 3], immutable=True)])
            sage: McF = ManifoldSubsetPullback(c_cart, F, name='McF'); McF
            Subset McF of the 2-dimensional topological manifold R^2
            sage: McF.is_closed()
            False

```



---

Comment by git created at 2021-06-24 16:33:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-24 16:33:35

Replying to [comment:68 egourgoulhon]:
> This example in the doctstring of `ManifoldSubsetPullback.is_closed` is dubious:

Indeed. Looks like I had forgotten to actually implement this case. Done now


---

Comment by egourgoulhon created at 2021-06-26 09:52:11

Thanks for the update. As soon as the patchbot visits the ticket and is green, the ticket can be set to positive review.


---

Comment by egourgoulhon created at 2021-06-28 19:51:32

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-06-28 19:51:32

OK, since the changes since the last time the patchbot visited the ticket are quite minor, let us move on without waiting for another visit. 

Thank you for the new features introduced here!


---

Comment by mkoeppe created at 2021-06-28 20:02:19

Thanks for the review!


---

Comment by egourgoulhon created at 2021-06-30 11:49:15

Replying to [comment:72 egourgoulhon]:
> OK, since the changes since the last time the patchbot visited the ticket are quite minor, let us move on without waiting for another visit. 

It seems that we don't have any patchbot at the moment:
https://patchbot.sagemath.org/ticket/0/


---

Comment by git created at 2021-07-01 22:59:53

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-07-01 22:59:53

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-07-01 23:00:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-07 21:47:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-07-07 21:47:41


```
sage -t --long --warn-long 41.5 --random-seed=0 src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 2975, in sage.geometry.polyhedron.base.Polyhedron_base.incidence_matrix
Failed example:
    M == P.incidence_matrix()
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   1 of  31 in sage.geometry.polyhedron.base.Polyhedron_base.incidence_matrix
    [1737 tests, 1 failure, 35.30 s]
----------------------------------------------------------------------
sage -t --long --warn-long 41.5 --random-seed=0 src/sage/geometry/polyhedron/base.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by git created at 2021-07-07 23:09:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-07 23:10:13

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-07 23:10:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-18 22:53:36

Resolution: fixed
