# Issue 25279: Huge delay introduced in SBox nonlinearity

Issue created by migration from Trac.

Original creator: asante

Original creation time: 2018-06-06 08:16:40

Keywords: sbox, linear approximation matrix, regression

There is a regression in the computation of the nonlinearity of an SBox introduced from 8.1 to 8.2+

Quoted from https://ask.sagemath.org/question/42492/huge-delay-in-sagecryptosboxsbox-method-nonlinearity-introduced-in-v82/

```sage
sage: for j in range(10):
....:     S = [x for x in range(256)];shuffle(S)
....:     S = sage.crypto.sbox.SBox(S)
....:     %time S.nonlinearity()
```


Results from Sage 8.1


```
CPU times: user 237 ms, sys: 1.87 ms, total: 239 ms
Wall time: 236 ms
94
CPU times: user 208 ms, sys: 12.5 ms, total: 220 ms
Wall time: 220 ms
94
CPU times: user 287 ms, sys: 1.41 ms, total: 288 ms
Wall time: 288 ms
92
....
```


Results from Sage 8.2


```
CPU times: user 5.12 s, sys: 30.6 ms, total: 5.15 s
Wall time: 5.16 s
92
CPU times: user 5.04 s, sys: 14.3 ms, total: 5.05 s
Wall time: 5.05 s
96
CPU times: user 5.08 s, sys: 13 ms, total: 5.09 s
Wall time: 5.09 s
94
CPU times: user 5.03 s, sys: 8.56 ms, total: 5.04 s
Wall time: 5.04 s
92
.....
```



I expect the cause being the modification of the `linear_approximation_matrix` Method, i.e. the following diff

```diff
-        B = BooleanFunction(self.m)
-        L = []
-        for j in range(ncols):
-            for i in range(nrows):
-                B[i] = ZZ(self(i)&j).popcount()
-            L.append(B.walsh_hadamard_transform())
+        L = [self.component_function(i).walsh_hadamard_transform() for i in range(ncols)]
```




---

Comment by asante created at 2018-06-06 08:16:48

Set assignee to asante.


---

Comment by asante created at 2018-06-07 14:45:07

The cause is as expected the use of the `component_function` method of the sbox. Reverting to the previous implementation restores the old speed.
----
New commits:


---

Comment by asante created at 2018-06-07 14:45:07

Changing status from new to needs_review.


---

Comment by ylchapuy created at 2018-06-25 20:53:49

You should probably also fix `component_function` for speed (by using the popcount trick).
It might be in another ticket though.


---

Comment by git created at 2018-06-28 09:23:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-06-28 10:28:44

Changing keywords from "sbox, linear approximation matrix, regression" to "sbox, linear approximation matrix, regression, days94".


---

Comment by git created at 2018-06-29 10:09:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ruhm created at 2018-06-29 10:58:53

Hi Friedrich,

I have tested the patch and it fixes the problem and pass the doctests. However, I suggest the fix for this ticket should actually be done on the `component_function`. The value `b` in the `component_function` is kept as an integer. The Boolean function for the component function can be computed as

`ret[x] = ZZ(b & self(x)).popcount() & 1`


---

Comment by ruhm created at 2018-06-29 10:59:22

Changing status from needs_review to needs_work.


---

Comment by ruhm created at 2018-06-29 13:17:29

Additional notes : when converting `b` in `component_function` from a list/tuple of bits to integer, you may use `self.from_bits()` inside the SBox module since it takes care of the "endianness". By default [SageMath](SageMath) use little-endian ordering (i.e., the leftmost bit in a list/tuple/vector is the least-significant bit).


---

Comment by git created at 2018-06-29 13:43:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-06-29 14:32:23

Fixed the slow implementation of `component_function`, now the `walsh_hadamard_transform` can stay as it was without speed penalty. There is still some small decrease in speed, I guess because of the know-corrected input checks?


---

Comment by asante created at 2018-06-29 14:32:23

Changing status from needs_work to needs_review.


---

Comment by asante created at 2018-07-02 13:06:39

patchbot tests are failing


---

Comment by asante created at 2018-07-02 13:06:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-07-02 13:40:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-02 13:42:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-07-02 13:42:36

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-07-03 12:54:15

FYI - All tests pass (the one failure from the patchbot is independent and transient).


---

Comment by soehms created at 2018-07-04 09:45:56

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2018-07-04 09:45:56

LGTM


---

Comment by vbraun created at 2018-07-08 13:05:22

Resolution: fixed
