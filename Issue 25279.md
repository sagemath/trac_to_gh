# Issue 25279: Huge delay introduced in SBox nonlinearity

archive/issues_025279.json:
```json
{
    "body": "Keywords: sbox, linear approximation matrix, regression\n\nThere is a regression in the computation of the nonlinearity of an SBox introduced from 8.1 to 8.2+\n\nQuoted from https://ask.sagemath.org/question/42492/huge-delay-in-sagecryptosboxsbox-method-nonlinearity-introduced-in-v82/\n\n```sage\nsage: for j in range(10):\n....:     S = [x for x in range(256)];shuffle(S)\n....:     S = sage.crypto.sbox.SBox(S)\n....:     %time S.nonlinearity()\n```\n\n\nResults from Sage 8.1\n\n\n```\nCPU times: user 237 ms, sys: 1.87 ms, total: 239 ms\nWall time: 236 ms\n94\nCPU times: user 208 ms, sys: 12.5 ms, total: 220 ms\nWall time: 220 ms\n94\nCPU times: user 287 ms, sys: 1.41 ms, total: 288 ms\nWall time: 288 ms\n92\n....\n```\n\n\nResults from Sage 8.2\n\n\n```\nCPU times: user 5.12 s, sys: 30.6 ms, total: 5.15 s\nWall time: 5.16 s\n92\nCPU times: user 5.04 s, sys: 14.3 ms, total: 5.05 s\nWall time: 5.05 s\n96\nCPU times: user 5.08 s, sys: 13 ms, total: 5.09 s\nWall time: 5.09 s\n94\nCPU times: user 5.03 s, sys: 8.56 ms, total: 5.04 s\nWall time: 5.04 s\n92\n.....\n```\n\n\n\nI expect the cause being the modification of the `linear_approximation_matrix` Method, i.e. the following diff\n\n```diff\n-        B = BooleanFunction(self.m)\n-        L = []\n-        for j in range(ncols):\n-            for i in range(nrows):\n-                B[i] = ZZ(self(i)&j).popcount()\n-            L.append(B.walsh_hadamard_transform())\n+        L = [self.component_function(i).walsh_hadamard_transform() for i in range(ncols)]\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25516\n\n",
    "created_at": "2018-06-06T08:16:40Z",
    "labels": [
        "cryptography",
        "major",
        "bug"
    ],
    "title": "Huge delay introduced in SBox nonlinearity",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25279",
    "user": "asante"
}
```
Keywords: sbox, linear approximation matrix, regression

There is a regression in the computation of the nonlinearity of an SBox introduced from 8.1 to 8.2+

Quoted from https://ask.sagemath.org/question/42492/huge-delay-in-sagecryptosboxsbox-method-nonlinearity-introduced-in-v82/

```sage
sage: for j in range(10):
....:     S = [x for x in range(256)];shuffle(S)
....:     S = sage.crypto.sbox.SBox(S)
....:     %time S.nonlinearity()
```


Results from Sage 8.1


```
CPU times: user 237 ms, sys: 1.87 ms, total: 239 ms
Wall time: 236 ms
94
CPU times: user 208 ms, sys: 12.5 ms, total: 220 ms
Wall time: 220 ms
94
CPU times: user 287 ms, sys: 1.41 ms, total: 288 ms
Wall time: 288 ms
92
....
```


Results from Sage 8.2


```
CPU times: user 5.12 s, sys: 30.6 ms, total: 5.15 s
Wall time: 5.16 s
92
CPU times: user 5.04 s, sys: 14.3 ms, total: 5.05 s
Wall time: 5.05 s
96
CPU times: user 5.08 s, sys: 13 ms, total: 5.09 s
Wall time: 5.09 s
94
CPU times: user 5.03 s, sys: 8.56 ms, total: 5.04 s
Wall time: 5.04 s
92
.....
```



I expect the cause being the modification of the `linear_approximation_matrix` Method, i.e. the following diff

```diff
-        B = BooleanFunction(self.m)
-        L = []
-        for j in range(ncols):
-            for i in range(nrows):
-                B[i] = ZZ(self(i)&j).popcount()
-            L.append(B.walsh_hadamard_transform())
+        L = [self.component_function(i).walsh_hadamard_transform() for i in range(ncols)]
```



Issue created by migration from https://trac.sagemath.org/ticket/25516





---

archive/issue_comments_356374.json:
```json
{
    "body": "Set assignee to asante.",
    "created_at": "2018-06-06T08:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356374",
    "user": "asante"
}
```

Set assignee to asante.



---

archive/issue_comments_356375.json:
```json
{
    "body": "The cause is as expected the use of the `component_function` method of the sbox. Reverting to the previous implementation restores the old speed.\n----\nNew commits:",
    "created_at": "2018-06-07T14:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356375",
    "user": "asante"
}
```

The cause is as expected the use of the `component_function` method of the sbox. Reverting to the previous implementation restores the old speed.
----
New commits:



---

archive/issue_comments_356376.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-07T14:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356376",
    "user": "asante"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_356377.json:
```json
{
    "body": "You should probably also fix `component_function` for speed (by using the popcount trick).\nIt might be in another ticket though.",
    "created_at": "2018-06-25T20:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356377",
    "user": "ylchapuy"
}
```

You should probably also fix `component_function` for speed (by using the popcount trick).
It might be in another ticket though.



---

archive/issue_comments_356378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-28T09:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356378",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356379.json:
```json
{
    "body": "Changing keywords from \"sbox, linear approximation matrix, regression\" to \"sbox, linear approximation matrix, regression, days94\".",
    "created_at": "2018-06-28T10:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356379",
    "user": "asante"
}
```

Changing keywords from "sbox, linear approximation matrix, regression" to "sbox, linear approximation matrix, regression, days94".



---

archive/issue_comments_356380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-29T10:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356380",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356381.json:
```json
{
    "body": "Hi Friedrich,\n\nI have tested the patch and it fixes the problem and pass the doctests. However, I suggest the fix for this ticket should actually be done on the `component_function`. The value `b` in the `component_function` is kept as an integer. The Boolean function for the component function can be computed as\n\n`ret[x] = ZZ(b & self(x)).popcount() & 1`",
    "created_at": "2018-06-29T10:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356381",
    "user": "ruhm"
}
```

Hi Friedrich,

I have tested the patch and it fixes the problem and pass the doctests. However, I suggest the fix for this ticket should actually be done on the `component_function`. The value `b` in the `component_function` is kept as an integer. The Boolean function for the component function can be computed as

`ret[x] = ZZ(b & self(x)).popcount() & 1`



---

archive/issue_comments_356382.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-29T10:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356382",
    "user": "ruhm"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_356383.json:
```json
{
    "body": "Additional notes : when converting `b` in `component_function` from a list/tuple of bits to integer, you may use `self.from_bits()` inside the SBox module since it takes care of the \"endianness\". By default [SageMath](SageMath) use little-endian ordering (i.e., the leftmost bit in a list/tuple/vector is the least-significant bit).",
    "created_at": "2018-06-29T13:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356383",
    "user": "ruhm"
}
```

Additional notes : when converting `b` in `component_function` from a list/tuple of bits to integer, you may use `self.from_bits()` inside the SBox module since it takes care of the "endianness". By default [SageMath](SageMath) use little-endian ordering (i.e., the leftmost bit in a list/tuple/vector is the least-significant bit).



---

archive/issue_comments_356384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-29T13:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356384",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356385.json:
```json
{
    "body": "Fixed the slow implementation of `component_function`, now the `walsh_hadamard_transform` can stay as it was without speed penalty. There is still some small decrease in speed, I guess because of the know-corrected input checks?",
    "created_at": "2018-06-29T14:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356385",
    "user": "asante"
}
```

Fixed the slow implementation of `component_function`, now the `walsh_hadamard_transform` can stay as it was without speed penalty. There is still some small decrease in speed, I guess because of the know-corrected input checks?



---

archive/issue_comments_356386.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-29T14:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356386",
    "user": "asante"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_356387.json:
```json
{
    "body": "patchbot tests are failing",
    "created_at": "2018-07-02T13:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356387",
    "user": "asante"
}
```

patchbot tests are failing



---

archive/issue_comments_356388.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-02T13:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356388",
    "user": "asante"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_356389.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-02T13:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356389",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356390.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-02T13:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356390",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356391.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-02T13:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356391",
    "user": "asante"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_356392.json:
```json
{
    "body": "FYI - All tests pass (the one failure from the patchbot is independent and transient).",
    "created_at": "2018-07-03T12:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356392",
    "user": "tscrim"
}
```

FYI - All tests pass (the one failure from the patchbot is independent and transient).



---

archive/issue_comments_356393.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-04T09:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356393",
    "user": "soehms"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_356394.json:
```json
{
    "body": "LGTM",
    "created_at": "2018-07-04T09:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356394",
    "user": "soehms"
}
```

LGTM



---

archive/issue_comments_356395.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-08T13:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25279#issuecomment-356395",
    "user": "vbraun"
}
```

Resolution: fixed
