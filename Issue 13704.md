# Issue 13704: Exit Sage gracefully upon SIGHUP

Issue created by migration from https://trac.sagemath.org/ticket/13908

Original creator: jdemeyer

Original creation time: 2013-01-04 13:25:06

Assignee: jdemeyer

Change the signal handling code to allow a graceful forced exit of Sage. "graceful" meaning that code is interrupted and the normal exit handlers are run. This graceful exit is not guaranteed to work, code which is not interruptible would not be exited.

This might be used by the doctesting framework to handle timeouts.

One could argue that we should also handle `SIGTERM` this way, but since the exit is not guaranteed, I prefer not to do this.


---

Comment by jdemeyer created at 2013-01-11 14:09:34

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-01-12 22:15:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-01-14 16:02:24

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-20 17:46:24

Sounds good to me.


---

Comment by vbraun created at 2013-01-20 17:46:24

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-21 16:19:19

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-21 16:19:19

See sage-devel.


---

Comment by jdemeyer created at 2013-01-28 10:54:40

Since the main motivation is to have _some_ way of gracefully terminating Sage, I'm handling only `SIGHUP` now, not `SIGTERM`.


---

Attachment


---

Attachment


---

Comment by jdemeyer created at 2013-01-28 11:25:04

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-28 14:53:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-28 14:53:37

Hmm I didn't see any discussion on sage-devel about SIGTERM but getting started with just catching SIGHUP is fine, too.


---

Comment by jdemeyer created at 2013-01-28 15:01:34

For the SIGTERM problem, see [https://groups.google.com/forum/?fromgroups#!search/sage-devel$2013908/sage-devel/5BfDSSdN5qw/AcWANg5v2KwJ](https://groups.google.com/forum/?fromgroups#!search/sage-devel$2013908/sage-devel/5BfDSSdN5qw/AcWANg5v2KwJ)


---

Comment by jdemeyer created at 2013-01-30 07:34:48

Resolution: fixed


---

Comment by stumpc5 created at 2013-02-23 10:05:03

I was running a moinmoin wiki with sage. With this patch applied, that doesn't work anymore because of the new interruption handling in `sage.ext._init_csage`:

When running the wiki using

```
$ sage wikiserver.py
```

and importing `sage.all.*` therein, I get the following error:


```
    from sage.all import *
  File "/home/stumpc5/progs/sage-5.7/devel/sage-main/build/sage/all.py", line 59, in <module>
    _init_csage()
  File "c_lib.pyx", line 41, in sage.ext.c_lib._init_csage (sage/ext/c_lib.c:569)
    
ValueError: signal only works in main thread
```


The issue seems to be solved when I comment out the signal in `_init_csage`.

Question: Is there a (reasonable and finite) way to fix this issue properly? Can something serious go wrong if I comment these lines out?

Thanks, Christian


---

Comment by jdemeyer created at 2013-02-23 10:15:05

Replying to [comment:16 stumpc5]:
> Can something serious go wrong if I comment these lines out?
Not very serious. Interrupt handling might be a bit messed up, in particular some interrupts (CTRL-C) might be seen twice: once by the default Python handler (`raise KeyboardInterrupt`) and once by the special Sage handler (written in C).

The line

```
signal.signal(signal.SIGINT, sage_python_check_interrupt)
```

is mainly used to ensure that only the Sage signal handler is used.

But this will certainly have no consequences beyond interrupt handling.
