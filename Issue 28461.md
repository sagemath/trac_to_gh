# Issue 28461: py3: HTML documentation for GlobalOptions does not show up correctly

Issue created by migration from https://trac.sagemath.org/ticket/28698

Original creator: @mwageringel

Original creation time: 2019-11-06 19:35:11

CC:  klee

With Python 3, the HTML documentation for `GlobalOptions` does not show the docstring, but something else. For example in the case of `QQbar.options`, this is what gets displayed:

```
options = Current options for AlgebraicField - display_format: decimal
```

This is what is called "String form" in the introspection `QQbar.options?`.

With Python 2, the HTML documentation shows the "Docstring" as desired:

```
options(*get_value, **set_value)
OPTIONS:

* "display_format" -- (default: "decimal")

  * "decimal" -- Always display a decimal approximation

  * "radical" -- Display using radicals (if possible)

See "GlobalOptions" for more features of these options.
```


This is not unique to `QQbar`, but can also be seen with `Tableaux.options`, for instance.


---

Comment by jhpalmieri created at 2019-11-06 19:46:14

Can you provide more details? From the Sage command line or from the Jupyter notebook, if I type `QQbar.options?`, I see the same thing in Python 2 or Python 3.


---

Comment by @mwageringel created at 2019-11-06 19:55:40

It is displayed correctly on the command line. The problem is with the HTML files that get generated as part of the documentation. Currently, the problem can be seen here online: [Python 2](http://doc.sagemath.org/html/en/reference/number_fields/sage/rings/qqbar.html#sage.rings.qqbar.AlgebraicField_common.options)/[Python 3](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/number_fields/sage/rings/qqbar.html#sage.rings.qqbar.AlgebraicField_common.options).


---

Comment by egourgoulhon created at 2019-11-06 21:00:37

I confirm the bug in Sage 9.0.beta4 (Python 3 version). It holds for `Manifold.options` as well.


---

Comment by @mwageringel created at 2019-11-09 11:05:22

The following (non-sensical) change in `sage_autodoc.AttributeDocumenter.can_document_member` appears to fix this problem.


```diff
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -1477,17 +1477,17 @@ class AttributeDocumenter(DocstringStripSignatureMixin, ClassLevelDocumenter):

         isattribute = isdatadesc or (not isinstance(parent, ModuleDocumenter) and isattr)

         # Trac #26522: This condition is here just to pass objects of classes
         # that inherit ClasscallMetaclass as attributes rather than method
         # descriptors.
         isattribute = isattribute or isinstance(type(member), ClasscallMetaclass)

-        if PY2:
+        if PY2 or True:
             return isattribute

         # That last condition addresses an obscure case of C-defined
         # methods using a deprecated type in Python 3, that is not otherwise
         # exported anywhere by Python
         return isattribute or (not isinstance(parent, ModuleDocumenter) and
                               not inspect.isroutine(member) and
                               not isinstance(member, type))
```


The problem is that `sage_autodoc` determines that `QQbar.options` should be documented as an attribute rather than a function, in Python 3, because the expression in the last return statement is true.

Note that `class options(GlobalOptions)` does not create a subclass, but an instance of `GlobalOptions` by some magic, so it acually is an attribute, which nevertheless should not be documented as such.

Also note that `sage_autodoc` is a modified copy of [Sphinx' autodoc](https://github.com/sphinx-doc/sphinx/blob/v1.8.5/sphinx/ext/autodoc/__init__.py#L1383-L1396). The problematic expression has not been added by Sage, but is part of the upstream version. The PY2-check was added in #26949 when `sage_autodoc` was updated to be more in line with the upstream version (which is Python-3-only I assume).

Any ideas how to solve this? It would be good if we could avoid adding a special case for `GlobalOptions` and also avoid deviating from upstream too much.


---

Comment by jhpalmieri created at 2019-11-09 23:04:31

`@`klee: any suggestions?


---

Comment by git created at 2019-11-14 04:57:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-11-14 05:07:35

Replying to [comment:4 gh-mwageringel]:
> Any ideas how to solve this? It would be good if we could avoid adding a special case for `GlobalOptions` and also avoid deviating from upstream too much.

The problem is that `GlobalOptions` attribute get documented by `AttributeDocumenter` unlike by `FunctionDocumenter` in python 2. This  is because of the extra check for "obscure case" in python 3.

I don't clearly understand what the "obscure case" is. Anyway, the extra check is apparently doing more harm than good to sage documentation. In the patch, I turned off that check, as you originally suggested. I expect the generated documentation is more close to the version in python 2. 

We need to examine the generated documentation to see if there is any regression from the version in python 2.


---

Comment by klee created at 2019-11-14 06:05:31

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-11-16 14:51:28

Changing status from needs_review to needs_info.


---

Comment by @mwageringel created at 2019-11-16 14:51:28

I ran a diff on the generated html files before and after the patch using Python 3. The change mainly affects all the `options` classes that are now documented as function rather than attribute.

Besides `options`, there are two or three cases where the documentation also switched from attribute to function, for example

[FiniteStateMachine.default_format_letter](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/finite_state_machine.html#sage.combinat.finite_state_machine.FiniteStateMachine.default_format_letter)

which is just an alias to an imported function

```
    default_format_letter = latex
```

so `default_format_letter` now shows the documentation from `latex`, which seems correct.

However, this patch also affects a number of attributes that completely disappear from the documentation after the patch, for example:

[AbstractGrowthGroupFunctor.rank](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/asymptotic/sage/rings/asymptotic/growth_group.html#sage.rings.asymptotic.growth_group.AbstractGrowthGroupFunctor.rank),
[GenericGrowthGroup.CartesianProduct](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/asymptotic/sage/rings/asymptotic/growth_group.html#sage.rings.asymptotic.growth_group.GenericGrowthGroup.CartesianProduct),
[GenericSymbolicSubringFunctor.coercion_reversed](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/calculus/sage/symbolic/subring.html#sage.symbolic.subring.GenericSymbolicSubringFunctor.coercion_reversed),
[CartesianProductFunctor.symbol](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/categories/sage/categories/cartesian_product.html#sage.categories.cartesian_product.CartesianProductFunctor.symbol),
[A000027.link](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/sloane_functions.html#sage.combinat.sloane_functions.A000027.link),
[CNFEncoder.permutations](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/sat/sage/sat/converters/polybori.html#sage.sat.converters.polybori.CNFEncoder.permutations)

Are these supposed to appear in the documentation or not? Most of them do not have documentation strings attached to them, but some do (possibly unintentionally), for example:

[FSMState.initial_probability](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/finite_state_machine.html#sage.combinat.finite_state_machine.FSMState.initial_probability)


---

Comment by klee created at 2019-11-18 01:44:24

Replying to [comment:10 gh-mwageringel]:
> I ran a diff on the generated html files before and after the patch using Python 3. 

Thanks.

> The change mainly affects all the `options` classes that are now documented as function rather than attribute.

Good.

> Besides `options`, there are two or three cases where the documentation also switched from attribute to function, for example
> 
> [FiniteStateMachine.default_format_letter](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/finite_state_machine.html#sage.combinat.finite_state_machine.FiniteStateMachine.default_format_letter)
> 
> which is just an alias to an imported function
> {{{
>     default_format_letter = latex
> }}}
> so `default_format_letter` now shows the documentation from `latex`, which seems correct.

Seems ok.

> However, this patch also affects a number of attributes that completely disappear from the documentation after the patch, for example:
> 
> [AbstractGrowthGroupFunctor.rank](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/asymptotic/sage/rings/asymptotic/growth_group.html#sage.rings.asymptotic.growth_group.AbstractGrowthGroupFunctor.rank),
> [GenericGrowthGroup.CartesianProduct](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/asymptotic/sage/rings/asymptotic/growth_group.html#sage.rings.asymptotic.growth_group.GenericGrowthGroup.CartesianProduct),
> [GenericSymbolicSubringFunctor.coercion_reversed](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/calculus/sage/symbolic/subring.html#sage.symbolic.subring.GenericSymbolicSubringFunctor.coercion_reversed),
> [CartesianProductFunctor.symbol](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/categories/sage/categories/cartesian_product.html#sage.categories.cartesian_product.CartesianProductFunctor.symbol),
> [A000027.link](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/sloane_functions.html#sage.combinat.sloane_functions.A000027.link),
> [CNFEncoder.permutations](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/sat/sage/sat/converters/polybori.html#sage.sat.converters.polybori.CNFEncoder.permutations)
> 
> Are these supposed to appear in the documentation or not? 

They did not appear in python 2 documentation, but started to appear in python 3 documentation by #26949, perhaps because of the extra check in `AttributeDocumenter`. So I think they should not appear in the documentation. I regard this as an improvement.

>Most of them do not have documentation strings attached to them, but some do (possibly unintentionally), for example:
>> 
>> [FSMState.initial_probability](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/combinat/sage/combinat/finite_state_machine.html#sage.combinat.finite_state_machine.FSMState.initial_probability)

This example is interesting. 

The attribute `initial_probability` did have docstring, but as of sage 9.0.beta4, the docstring is removed, or rather moved into the class (`FSMState`) docstring. This is why `initial_probability` (and `is_initial`) disappeared from the python 3 documentation. 

Then why the docstring was moved to class docstring? Perhaps because the attribute docstrings do not get doctested. I think this is a defect of sage doctesting -- the original docstring was nice!

To summarize, I see no regression from your report.


---

Comment by klee created at 2019-11-18 01:46:08

Changing status from needs_info to needs_review.


---

Comment by @mwageringel created at 2019-11-18 21:08:00

Ok, thank you for the explanations. Considering that the documentation in Python 3 now seems to agree with the usual Python 2 documentation, this is good to go then.


---

Comment by @mwageringel created at 2019-11-18 21:08:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-11-24 16:58:49

Resolution: fixed
