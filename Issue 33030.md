# Issue 33030: Improve speed of sum_of_* for CombinatorialFreeModule

archive/issues_033030.json:
```json
{
    "body": "CC:  @fchapoton @orlitzky\n\nWe avoid using transient elements as much as possible (and using Cythonization) to speed up these methods.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33267\n\n",
    "created_at": "2022-02-01T02:29:06Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Improve speed of sum_of_* for CombinatorialFreeModule",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33030",
    "user": "@tscrim"
}
```
CC:  @fchapoton @orlitzky

We avoid using transient elements as much as possible (and using Cythonization) to speed up these methods.

Issue created by migration from https://trac.sagemath.org/ticket/33267





---

archive/issue_comments_470980.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-01T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470980",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470981.json:
```json
{
    "body": "\n```\nsage: F = CombinatorialFreeModule(QQ, ['a', 'b', 'c'])\nsage: %timeit F._sum_of_monomials(['a','b','b'])\n2.12 \u00b5s \u00b1 16 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit F.sum_of_terms([('a',2), ('c',3)])\n1.38 \u00b5s \u00b1 26.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nversus before\n\n```\nsage: %timeit F._sum_of_monomials(['a','b','b'])\n8.11 \u00b5s \u00b1 21.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit F.sum_of_terms([('a',2), ('c',3)])\n5.1 \u00b5s \u00b1 20.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nSo we get ~4x speedup on these small examples. Likely this will improve the speed across a number of methods as these two methods are used somewhat frequently.\n----\nNew commits:",
    "created_at": "2022-02-01T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470981",
    "user": "@tscrim"
}
```


```
sage: F = CombinatorialFreeModule(QQ, ['a', 'b', 'c'])
sage: %timeit F._sum_of_monomials(['a','b','b'])
2.12 µs ± 16 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit F.sum_of_terms([('a',2), ('c',3)])
1.38 µs ± 26.9 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

versus before

```
sage: %timeit F._sum_of_monomials(['a','b','b'])
8.11 µs ± 21.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit F.sum_of_terms([('a',2), ('c',3)])
5.1 µs ± 20.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

So we get ~4x speedup on these small examples. Likely this will improve the speed across a number of methods as these two methods are used somewhat frequently.
----
New commits:



---

archive/issue_comments_470982.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to performance.",
    "created_at": "2022-02-01T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470982",
    "user": "@tscrim"
}
```

Changing component from PLEASE CHANGE to performance.



---

archive/issue_comments_470983.json:
```json
{
    "body": "This bit,\n\n\n```python\n    for index, coeff in index_coeff_pairs:\n        if index in result:\n            result[index] += coeff\n        else:\n            result[index] = coeff\n    return remove_zeros(result)\n```\n\n\nmakes several passes through `result` looking for `index`. Given that we're going to remove the zeros at the end anyway, would it be any faster to initialize the `result` with zeros, so that we can add unconditionally? Or to try `result[index] += coeff` and only do `result[index] = coeff` if a `KeyError` is thrown?",
    "created_at": "2022-02-01T13:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470983",
    "user": "@orlitzky"
}
```

This bit,


```python
    for index, coeff in index_coeff_pairs:
        if index in result:
            result[index] += coeff
        else:
            result[index] = coeff
    return remove_zeros(result)
```


makes several passes through `result` looking for `index`. Given that we're going to remove the zeros at the end anyway, would it be any faster to initialize the `result` with zeros, so that we can add unconditionally? Or to try `result[index] += coeff` and only do `result[index] = coeff` if a `KeyError` is thrown?



---

archive/issue_comments_470984.json:
```json
{
    "body": "Initializing zeros would only be better in cases that are highly dense, which is fairly rare IMO. Suppose we are working in the exterior algebra of rank `n`, which has dimension 2<sup>n</sup>. If we simply want to work with 20 terms for a computation (not an unlikely scenario in rank 10). Then we have to fill all 1024 possible entries of this dict, which we then afterwards have to check for 0 (iterating over everything, which is not so good for a `dict`) and filter most of those out.\n\nNow I did think about catching the `KeyError`, but I am assuming the most likely scenario is most of the terms are unique and `index` is not in the `dict. In small scale testing:\n\n```\nsage: def t1():\n....:     d = {}\n....:     try:\n....:         d[5] += 1\n....:     except KeyError:\n....:         d[5] = 1\n....:         \nsage: def t2():\n....:     d = {}\n....:     if 5 in d:\n....:         d[5] += 1\n....:     else:\n....:         d[5] = 1\n....:         \nsage: %timeit t1()\n729 ns \u00b1 0.982 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit t2()\n478 ns \u00b1 20.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nIf I instead replace `5` with `ind = (1,2,3)`, I get\n\n```\nsage: %timeit t1()\n929 ns \u00b1 7.51 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit t2()\n656 ns \u00b1 1.84 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nThis is why I settled on this.\n\nSomething I have thought a bit about is having a sparse and dense version of `CFM` (and bring its implementation much closer `FreeModule`). However, that would likely be a major project. Perhaps I should propose that as a GSoC project... So the dense case would become useful for those that want it (or \"small\" dimensional algebras). That's for later though.",
    "created_at": "2022-02-02T00:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470984",
    "user": "@tscrim"
}
```

Initializing zeros would only be better in cases that are highly dense, which is fairly rare IMO. Suppose we are working in the exterior algebra of rank `n`, which has dimension 2<sup>n</sup>. If we simply want to work with 20 terms for a computation (not an unlikely scenario in rank 10). Then we have to fill all 1024 possible entries of this dict, which we then afterwards have to check for 0 (iterating over everything, which is not so good for a `dict`) and filter most of those out.

Now I did think about catching the `KeyError`, but I am assuming the most likely scenario is most of the terms are unique and `index` is not in the `dict. In small scale testing:

```
sage: def t1():
....:     d = {}
....:     try:
....:         d[5] += 1
....:     except KeyError:
....:         d[5] = 1
....:         
sage: def t2():
....:     d = {}
....:     if 5 in d:
....:         d[5] += 1
....:     else:
....:         d[5] = 1
....:         
sage: %timeit t1()
729 ns ± 0.982 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit t2()
478 ns ± 20.7 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

If I instead replace `5` with `ind = (1,2,3)`, I get

```
sage: %timeit t1()
929 ns ± 7.51 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit t2()
656 ns ± 1.84 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

This is why I settled on this.

Something I have thought a bit about is having a sparse and dense version of `CFM` (and bring its implementation much closer `FreeModule`). However, that would likely be a major project. Perhaps I should propose that as a GSoC project... So the dense case would become useful for those that want it (or "small" dimensional algebras). That's for later though.



---

archive/issue_comments_470985.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-02T00:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470985",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470986.json:
```json
{
    "body": "I did one additional optimization I noticed while reviewing #33257.",
    "created_at": "2022-02-02T00:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470986",
    "user": "@tscrim"
}
```

I did one additional optimization I noticed while reviewing #33257.



---

archive/issue_comments_470987.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-02T14:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470987",
    "user": "@orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470988.json:
```json
{
    "body": "Ok, it does what it says. I've been testing it on my own CFM code with no problems.\n\nOne more nitpick: in `sum_of_terms`, you mention that the argument can be any iterable, but\n\n\n```python\ncpdef dict sum_of_monomials(monomials, scalar):\n    r\"\"\"\n    Return the pointwise addition of ``monomials``.\n\n    INPUT:\n\n    - ``monomials`` -- a list of indices representing the monomials\n```\n\n\nonly mentions a list. I think an iterable would work there too? Not a big deal.\n\nI also spent some time trying to figure out how to remove the double-loop from `remove_zeros()`. The best I could come up with is to use a dict comprehension like `{ index: D[index] for index in D if D[index] }`, but that creates a new dict so it's not guaranteed to be any faster.",
    "created_at": "2022-02-02T14:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470988",
    "user": "@orlitzky"
}
```

Ok, it does what it says. I've been testing it on my own CFM code with no problems.

One more nitpick: in `sum_of_terms`, you mention that the argument can be any iterable, but


```python
cpdef dict sum_of_monomials(monomials, scalar):
    r"""
    Return the pointwise addition of ``monomials``.

    INPUT:

    - ``monomials`` -- a list of indices representing the monomials
```


only mentions a list. I think an iterable would work there too? Not a big deal.

I also spent some time trying to figure out how to remove the double-loop from `remove_zeros()`. The best I could come up with is to use a dict comprehension like `{ index: D[index] for index in D if D[index] }`, but that creates a new dict so it's not guaranteed to be any faster.



---

archive/issue_comments_470989.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-02-02T23:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470989",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_470990.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-02-02T23:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470990",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_470991.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> Ok, it does what it says. I've been testing it on my own CFM code with no problems.\n\nThank you for the review.\n\n> One more nitpick: in `sum_of_terms`, you mention that the argument can be any iterable, but\n> \n> {{{#!python\n> cpdef dict sum_of_monomials(monomials, scalar):\n>     r\"\"\"\n>     Return the pointwise addition of ``monomials``.\n> \n>     INPUT:\n> \n>     - ``monomials`` -- a list of indices representing the monomials\n> }}}\n> \n> only mentions a list. I think an iterable would work there too? Not a big deal.\n\nI fixed it. Since it is a trivial change, I am allowing myself to set this back to a positive review. Feel free to revert if you disagree.\n\n> I also spent some time trying to figure out how to remove the double-loop from `remove_zeros()`. The best I could come up with is to use a dict comprehension like `{ index: D[index] for index in D if D[index] }`, but that creates a new dict so it's not guaranteed to be any faster.\n\nThat would be bad when there are very few zeros, but say the `dict` is really big. I feel that is a more common scenario than having a lot of zeros, and a list is cheaper to create I believe. There will always be a scenario that behaves badly for whichever implementation unfortunately. So IMO we just have to chose the one which seems least likely to occur.",
    "created_at": "2022-02-03T00:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470991",
    "user": "@tscrim"
}
```

Replying to [comment:6 mjo]:
> Ok, it does what it says. I've been testing it on my own CFM code with no problems.

Thank you for the review.

> One more nitpick: in `sum_of_terms`, you mention that the argument can be any iterable, but
> 
> {{{#!python
> cpdef dict sum_of_monomials(monomials, scalar):
>     r"""
>     Return the pointwise addition of ``monomials``.
> 
>     INPUT:
> 
>     - ``monomials`` -- a list of indices representing the monomials
> }}}
> 
> only mentions a list. I think an iterable would work there too? Not a big deal.

I fixed it. Since it is a trivial change, I am allowing myself to set this back to a positive review. Feel free to revert if you disagree.

> I also spent some time trying to figure out how to remove the double-loop from `remove_zeros()`. The best I could come up with is to use a dict comprehension like `{ index: D[index] for index in D if D[index] }`, but that creates a new dict so it's not guaranteed to be any faster.

That would be bad when there are very few zeros, but say the `dict` is really big. I feel that is a more common scenario than having a lot of zeros, and a list is cheaper to create I believe. There will always be a scenario that behaves badly for whichever implementation unfortunately. So IMO we just have to chose the one which seems least likely to occur.



---

archive/issue_comments_470992.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-03T00:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470992",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470993.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-20T13:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33030#issuecomment-470993",
    "user": "@vbraun"
}
```

Resolution: fixed
