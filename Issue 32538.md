# Issue 32538: Mostly fix slow down by #30022

Issue created by migration from https://trac.sagemath.org/ticket/32775

Original creator: @kliem

Original creation time: 2021-10-26 13:02:45

CC:  tscrim

We avoid multiple imports caused by #30022:

Before (and with #30022):


```
sage: a = 1/1000
sage: %timeit a.__pari__()
810 ns ± 2.33 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit QQ(p)
1.52 µs ± 1.37 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: a = 12314
sage: %timeit a.__pari__()
723 ns ± 0.804 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit ZZ(p)
715 ns ± 1.32 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.divisors(method='pari')
1.23 µs ± 1.51 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.is_prime_power()
647 ns ± 0.164 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.is_prime()
604 ns ± 0.486 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.factor()
3.6 µs ± 13.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


Reverting #30022:


```
sage: a = 1/1000
sage: %timeit a.__pari__()
221 ns ± 0.289 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit QQ(p)
810 ns ± 0.852 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: a = 12314
sage: %timeit a.__pari__()
176 ns ± 0.217 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = a.__pari__()
sage: %timeit ZZ(p)
150 ns ± 0.104 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.divisors(method='pari')
643 ns ± 1.38 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.is_prime_power()
53.9 ns ± 0.336 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.is_prime()
58 ns ± 0.174 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.factor()
2.99 µs ± 4.62 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


With this ticket:


```
sage: a = 1/1000
sage: %timeit a.__pari__()
274 ns ± 0.344 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit QQ(p)
867 ns ± 0.999 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: a = 12314
sage: %timeit a.__pari__()
200 ns ± 0.0656 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = a.__pari__()
sage: %timeit ZZ(p)
716 ns ± 0.912 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.divisors(method='pari')
673 ns ± 0.928 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.is_prime_power()
88.4 ns ± 0.075 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.is_prime()
68.9 ns ± 0.0878 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.factor()
3.19 µs ± 10.2 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by @kliem created at 2021-10-26 13:03:14

New commits:


---

Comment by @kliem created at 2021-10-26 13:03:14

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-26 17:52:36

The test failures are not from this ticket:

```
sage -t --long --random-seed=29194783039255016302038928490654063942 src/sage/rings/integer.pyx  # 1 doctest failed
sage -t --long --random-seed=29194783039255016302038928490654063942 src/sage/modular/modform/numerical.py  # 3 doctests failed
```



---

Comment by mkoeppe created at 2021-10-26 17:53:00

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-26 17:53:00

Thanks for working on this! LGTM.


---

Comment by @kliem created at 2021-10-26 19:17:49

Thank you.


---

Comment by slelievre created at 2021-10-27 12:46:57

Not sure about `set_integer_from_pari_gen` vs `set_integer_from_gen`.


---

Comment by git created at 2021-10-27 13:41:30

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-10-27 13:41:30

Changing status from positive_review to needs_review.


---

Comment by slelievre created at 2021-10-27 18:07:09

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-10-27 18:07:09

That seems better. Another option would have been to use

```diff
from sage.libs.pari.convert_sage import (
    set_integer_from_gen as set_integer_from_pari_gen)
```

if that name mattered.


---

Comment by @kliem created at 2021-10-27 18:22:54

It was just a typo and made this whole construction pointless there. This is the reason, I modified the benchmarks as well.


---

Comment by vbraun created at 2021-10-31 22:20:34

Resolution: fixed
