# Issue 25443: Upgrade to Python 3.7.0

archive/issues_025443.json:
```json
{
    "body": "CC:  @fchapoton @embray @kiwifb @mkoeppe @slel\n\n**Tarball**: https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz\n\nIssue created by migration from https://trac.sagemath.org/ticket/25680\n\n",
    "created_at": "2018-06-28T03:59:38Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Upgrade to Python 3.7.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25443",
    "user": "@jdemeyer"
}
```
CC:  @fchapoton @embray @kiwifb @mkoeppe @slel

**Tarball**: https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz

Issue created by migration from https://trac.sagemath.org/ticket/25680





---

archive/issue_comments_358834.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-28T07:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358834",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_358835.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-28T07:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358835",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_358836.json:
```json
{
    "body": "I don't think we should be in any hurry on this.  All the last ~year's work of Python 3 porting has been targeting Python 3.6, and I think I'd rather stick with that before risking throwing everything out of whack again.\n\nBetween Python 3.6 and 3.7 I suspect the differences, if any, will be minor.  But I'd rather try to stabilize on 3.6 first (to which we're quite close), then deal with those differences, rather than change Python versions again.  Also I don't know that Python 3.7 has been ported to Cygwin yet (although it does contain a number of useful fixes for Cygwin, I do know).\n\nThat said, if you know any specific changes in Python 3.7 (other than the aforementioned Cygwin fixes) that would actively make our porting effort easier I'd consider it...",
    "created_at": "2018-06-28T15:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358836",
    "user": "@embray"
}
```

I don't think we should be in any hurry on this.  All the last ~year's work of Python 3 porting has been targeting Python 3.6, and I think I'd rather stick with that before risking throwing everything out of whack again.

Between Python 3.6 and 3.7 I suspect the differences, if any, will be minor.  But I'd rather try to stabilize on 3.6 first (to which we're quite close), then deal with those differences, rather than change Python versions again.  Also I don't know that Python 3.7 has been ported to Cygwin yet (although it does contain a number of useful fixes for Cygwin, I do know).

That said, if you know any specific changes in Python 3.7 (other than the aforementioned Cygwin fixes) that would actively make our porting effort easier I'd consider it...



---

archive/issue_comments_358837.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-28T15:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358837",
    "user": "@embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_358838.json:
```json
{
    "body": "Jeroen has said elsewhere that islice will accept Sage integers instead of just ints.\n\nI am again becoming tired and frustated by the slow pace of progress towards py3. And by the large amount of difficult work that remains..",
    "created_at": "2018-06-28T15:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358838",
    "user": "@fchapoton"
}
```

Jeroen has said elsewhere that islice will accept Sage integers instead of just ints.

I am again becoming tired and frustated by the slow pace of progress towards py3. And by the large amount of difficult work that remains..



---

archive/issue_comments_358839.json:
```json
{
    "body": "Ah, I remember making an issue about that, but I don't think I followed what the resolution was.",
    "created_at": "2018-06-28T15:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358839",
    "user": "@embray"
}
```

Ah, I remember making an issue about that, but I don't think I followed what the resolution was.



---

archive/issue_comments_358840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-28T15:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358840",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358841.json:
```json
{
    "body": "Well there's this https://github.com/python/cpython/pull/1918  But unless there are other fixes I'm not seeing it's annoying that this was *only* fixed for `islice`, where I believe there is other code affected by the same issue (e.g. range).  Also we've already worked aroudn the majority of those cases (sigh...)",
    "created_at": "2018-06-28T15:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358841",
    "user": "@embray"
}
```

Well there's this https://github.com/python/cpython/pull/1918  But unless there are other fixes I'm not seeing it's annoying that this was *only* fixed for `islice`, where I believe there is other code affected by the same issue (e.g. range).  Also we've already worked aroudn the majority of those cases (sigh...)



---

archive/issue_comments_358842.json:
```json
{
    "body": "Replying to [comment:5 chapoton]:\n> I am again becoming tired and frustated by the slow pace of progress towards py3. And by the large amount of difficult work that remains..\n\nUnfortunately I'm not convinced that upgrading Python yet again is going to make that go any faster.  In any case I don't actually have that much \"difficult\" work remaining.  Just dozens of little issues.  My Python 3 branch has < 600 modules failing, and most of it appears to minor issues (at one point I had it down to ~400 and I don't know why it ballooned up again, but one or two small changes in just the right places can do that with Sage...)\n\nAlso I'll add if you're not using a patched pynac you're going to have lots, lots more \"serious\" looking issues.  We still need to get a pynac upgrade in (I've been manually installing pynac with my Python 3 fixes every time I re-build sage).",
    "created_at": "2018-06-28T15:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358842",
    "user": "@embray"
}
```

Replying to [comment:5 chapoton]:
> I am again becoming tired and frustated by the slow pace of progress towards py3. And by the large amount of difficult work that remains..

Unfortunately I'm not convinced that upgrading Python yet again is going to make that go any faster.  In any case I don't actually have that much "difficult" work remaining.  Just dozens of little issues.  My Python 3 branch has < 600 modules failing, and most of it appears to minor issues (at one point I had it down to ~400 and I don't know why it ballooned up again, but one or two small changes in just the right places can do that with Sage...)

Also I'll add if you're not using a patched pynac you're going to have lots, lots more "serious" looking issues.  We still need to get a pynac upgrade in (I've been manually installing pynac with my Python 3 fixes every time I re-build sage).



---

archive/issue_comments_358843.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> That said, if you know any specific changes in Python 3.7 (other than the aforementioned Cygwin fixes) that would actively make our porting effort easier I'd consider it...\n\n#25391 is a pretty serious issue which is fixed by a Python upgrade (probably also by upgrading to 3.6.6 but I haven't tested that).",
    "created_at": "2018-06-28T15:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358843",
    "user": "@jdemeyer"
}
```

Replying to [comment:3 embray]:
> That said, if you know any specific changes in Python 3.7 (other than the aforementioned Cygwin fixes) that would actively make our porting effort easier I'd consider it...

#25391 is a pretty serious issue which is fixed by a Python upgrade (probably also by upgrading to 3.6.6 but I haven't tested that).



---

archive/issue_comments_358844.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> I don't think we should be in any hurry on this.  All the last ~year's work of Python 3 porting has been targeting Python 3.6, and I think I'd rather stick with that before risking throwing everything out of whack again.\n\nFirst of all, I *do not* think that this 3.6 -> 3.7 will throw everything out of whack.\n\nHowever, regardless of that, we'll have to upgrade sooner or later. I don't see the point of having a perfectly working Sage on an outdated Python version. And for the many issues that we still have to fix, it would be better to make sure that they work on Python 3.7 from the start.",
    "created_at": "2018-06-28T15:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358844",
    "user": "@jdemeyer"
}
```

Replying to [comment:3 embray]:
> I don't think we should be in any hurry on this.  All the last ~year's work of Python 3 porting has been targeting Python 3.6, and I think I'd rather stick with that before risking throwing everything out of whack again.

First of all, I *do not* think that this 3.6 -> 3.7 will throw everything out of whack.

However, regardless of that, we'll have to upgrade sooner or later. I don't see the point of having a perfectly working Sage on an outdated Python version. And for the many issues that we still have to fix, it would be better to make sure that they work on Python 3.7 from the start.



---

archive/issue_comments_358845.json:
```json
{
    "body": "I still think we have very hard remaining problems, among which\n\n* sorting issues in graphs\n* hashing and comparisons, especially for groups\n* coercion framework have broken parts",
    "created_at": "2018-06-28T15:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358845",
    "user": "@fchapoton"
}
```

I still think we have very hard remaining problems, among which

* sorting issues in graphs
* hashing and comparisons, especially for groups
* coercion framework have broken parts



---

archive/issue_comments_358846.json:
```json
{
    "body": "Attachment [python3-3.7.0.log](tarball://root/attachments/some-uuid/ticket25680/python3-3.7.0.log) by @vinklein created at 2018-06-29 08:28:00",
    "created_at": "2018-06-29T08:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358846",
    "user": "@vinklein"
}
```

Attachment [python3-3.7.0.log](tarball://root/attachments/some-uuid/ticket25680/python3-3.7.0.log) by @vinklein created at 2018-06-29 08:28:00



---

archive/issue_comments_358847.json:
```json
{
    "body": "I get the following error\n\n```\n$ ./configure --with-python=3\n...\n$ make build\n...\n[python3-3.7.0] Testing importing of various modules...\n[python3-3.7.0] Traceback (most recent call last):\n[python3-3.7.0]   File \"<string>\", line 1, in <module>\n[python3-3.7.0]   File \"/home/vklein/odk/sage/local/var/tmp/sage/build/python3-3.7.0/src/Lib/ctypes/__init__.py\", line 7, in <module>\n[python3-3.7.0]     from _ctypes import Union, Structure, Array\n[python3-3.7.0] ModuleNotFoundError: No module named '_ctypes'\n[python3-3.7.0] ctypes module failed to import\n[python3-3.7.0] math module imported OK\n[python3-3.7.0] hashlib module imported OK\n[python3-3.7.0] crypt module imported OK\n[python3-3.7.0] readline module imported OK\n[python3-3.7.0] socket module imported OK\n[python3-3.7.0] Error: One or more modules failed to import.\n...\n```\n\n\nfull python3.7 install log in attachement",
    "created_at": "2018-06-29T08:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358847",
    "user": "@vinklein"
}
```

I get the following error

```
$ ./configure --with-python=3
...
$ make build
...
[python3-3.7.0] Testing importing of various modules...
[python3-3.7.0] Traceback (most recent call last):
[python3-3.7.0]   File "<string>", line 1, in <module>
[python3-3.7.0]   File "/home/vklein/odk/sage/local/var/tmp/sage/build/python3-3.7.0/src/Lib/ctypes/__init__.py", line 7, in <module>
[python3-3.7.0]     from _ctypes import Union, Structure, Array
[python3-3.7.0] ModuleNotFoundError: No module named '_ctypes'
[python3-3.7.0] ctypes module failed to import
[python3-3.7.0] math module imported OK
[python3-3.7.0] hashlib module imported OK
[python3-3.7.0] crypt module imported OK
[python3-3.7.0] readline module imported OK
[python3-3.7.0] socket module imported OK
[python3-3.7.0] Error: One or more modules failed to import.
...
```


full python3.7 install log in attachement



---

archive/issue_comments_358848.json:
```json
{
    "body": "Failure to build `_ctypes` usually means a problem with `ffi` (sometimes called libffi) may be there is minimum version requirement?",
    "created_at": "2018-06-29T08:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358848",
    "user": "@kiwifb"
}
```

Failure to build `_ctypes` usually means a problem with `ffi` (sometimes called libffi) may be there is minimum version requirement?



---

archive/issue_comments_358849.json:
```json
{
    "body": "Indeed i don't get the error after installing `libffi-dev`. Thanks !\n\nNote : sage `make build` works fine in python 3.6 without that.",
    "created_at": "2018-06-29T08:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358849",
    "user": "@vinklein"
}
```

Indeed i don't get the error after installing `libffi-dev`. Thanks !

Note : sage `make build` works fine in python 3.6 without that.



---

archive/issue_comments_358850.json:
```json
{
    "body": "next error during the build is :\n\n```\nInstalling collected packages: ipykernel\n  Running setup.py install for ipykernel: started\n    Running command /home/vklein/odk/sage/local/bin/python3 -u -c \"import setuptools, tokenize;__file__='/tmp/pip-qoxsao1r-build/setup.py';f=getattr(tokenize\n, 'open', open)(__file__);code=f.read().replace('\\r\\n', '\\n');f.close();exec(compile(code, __file__, 'exec'))\" --no-user-cfg install --record /tmp/pip-vc23lh\npc-record/install-record.txt --single-version-externally-managed --compile\n    Traceback (most recent call last):\n      File \"<string>\", line 1, in <module>\n      File \"/tmp/pip-qoxsao1r-build/setup.py\", line 91, in <module>\n        from ipykernel.kernelspec import write_kernel_spec, make_ipkernel_cmd, KERNEL_NAME\n...\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/pexpect/spawnbase.py\", line 224\n        def expect(self, pattern, timeout=-1, searchwindowsize=-1, async=False):\n                                                                       ^\n    SyntaxError: invalid syntax\n    Running setup.py install for ipykernel: finished with status 'error'\nCleaning up...\n\n```\n\n\nIssue reference : https://github.com/pypa/pipenv/issues/956",
    "created_at": "2018-06-29T09:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358850",
    "user": "@vinklein"
}
```

next error during the build is :

```
Installing collected packages: ipykernel
  Running setup.py install for ipykernel: started
    Running command /home/vklein/odk/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-qoxsao1r-build/setup.py';f=getattr(tokenize
, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-vc23lh
pc-record/install-record.txt --single-version-externally-managed --compile
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/tmp/pip-qoxsao1r-build/setup.py", line 91, in <module>
        from ipykernel.kernelspec import write_kernel_spec, make_ipkernel_cmd, KERNEL_NAME
...
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/pexpect/spawnbase.py", line 224
        def expect(self, pattern, timeout=-1, searchwindowsize=-1, async=False):
                                                                       ^
    SyntaxError: invalid syntax
    Running setup.py install for ipykernel: finished with status 'error'
Cleaning up...

```


Issue reference : https://github.com/pypa/pipenv/issues/956



---

archive/issue_comments_358851.json:
```json
{
    "body": "To be honest we haven't updated pexpect in vanilla sage for a while. It may be a good idea to do that - in a separate ticket.",
    "created_at": "2018-06-29T10:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358851",
    "user": "@kiwifb"
}
```

To be honest we haven't updated pexpect in vanilla sage for a while. It may be a good idea to do that - in a separate ticket.



---

archive/issue_comments_358852.json:
```json
{
    "body": "Do we need to update pexpect or to patch pipenv ?",
    "created_at": "2018-06-29T10:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358852",
    "user": "@vinklein"
}
```

Do we need to update pexpect or to patch pipenv ?



---

archive/issue_comments_358853.json:
```json
{
    "body": "No, `pexpect`.",
    "created_at": "2018-06-29T10:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358853",
    "user": "@jdemeyer"
}
```

No, `pexpect`.



---

archive/issue_comments_358854.json:
```json
{
    "body": "I am at `pexpect-4.2.1` in sage-on-gentoo (without any patches) and sage is at 4.1.0 + some patches.",
    "created_at": "2018-06-29T10:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358854",
    "user": "@kiwifb"
}
```

I am at `pexpect-4.2.1` in sage-on-gentoo (without any patches) and sage is at 4.1.0 + some patches.



---

archive/issue_comments_358855.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> I am at `pexpect-4.2.1` in sage-on-gentoo (without any patches) and sage is at 4.1.0 + some patches.\n\nThe patches in Sage are for performance. Without those patches, `pexpect` is really a lot slower.",
    "created_at": "2018-06-29T10:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358855",
    "user": "@jdemeyer"
}
```

Replying to [comment:21 fbissey]:
> I am at `pexpect-4.2.1` in sage-on-gentoo (without any patches) and sage is at 4.1.0 + some patches.

The patches in Sage are for performance. Without those patches, `pexpect` is really a lot slower.



---

archive/issue_comments_358856.json:
```json
{
    "body": "Let's do that #25700.",
    "created_at": "2018-06-29T12:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358856",
    "user": "@vinklein"
}
```

Let's do that #25700.



---

archive/issue_comments_358857.json:
```json
{
    "body": "Replying to [comment:12 chapoton]:\n> I still think we have very hard remaining problems, among which\n> \n> * sorting issues in graphs\n> * hashing and comparisons, especially for groups\n> * coercion framework have broken parts\n\nMost of which Python 3.7 won't help with.  The one area where it might is sorting of dicts, since dict insertion order is now preserved (hooray!)\n\nWell, I'm not completely opposed to upgrading, just skeptical, and don't want to rush into it.  When I get a chance I'll compare how my python3 branch fares with and without it.",
    "created_at": "2018-06-29T14:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358857",
    "user": "@embray"
}
```

Replying to [comment:12 chapoton]:
> I still think we have very hard remaining problems, among which
> 
> * sorting issues in graphs
> * hashing and comparisons, especially for groups
> * coercion framework have broken parts

Most of which Python 3.7 won't help with.  The one area where it might is sorting of dicts, since dict insertion order is now preserved (hooray!)

Well, I'm not completely opposed to upgrading, just skeptical, and don't want to rush into it.  When I get a chance I'll compare how my python3 branch fares with and without it.



---

archive/issue_comments_358858.json:
```json
{
    "body": "Replying to [comment:24 embray]:\n\n> Well, I'm not completely opposed to upgrading, just skeptical, and don't want to rush into it.  When I get a chance I'll compare how my python3 branch fares with and without it.\n\nOne of my goal reviewing this ticket is to produce a kind of diff between the doctests failures in 3.6 and 3.7. It can be helpful to decide what to do.",
    "created_at": "2018-06-29T14:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358858",
    "user": "@vinklein"
}
```

Replying to [comment:24 embray]:

> Well, I'm not completely opposed to upgrading, just skeptical, and don't want to rush into it.  When I get a chance I'll compare how my python3 branch fares with and without it.

One of my goal reviewing this ticket is to produce a kind of diff between the doctests failures in 3.6 and 3.7. It can be helpful to decide what to do.



---

archive/issue_comments_358859.json:
```json
{
    "body": "And now it's numpy's turn :\n\n\n```\n$ ./configure --with-python=3\n...\n$ make build\n...\n/home/vklein/odk/sage/local/lib/python3.7/distutils/dist.py:274: UserWarning: Un\nknown distribution option: 'define_macros'\n  warnings.warn(msg)\nnumpy/random/mtrand/mtrand.c: In function '__Pyx__ExceptionSave':\nnumpy/random/mtrand/mtrand.c:45208:19: error: 'PyThreadState {aka struct _ts}' h\nas no member named 'exc_type'\n     *type = tstate->exc_type;\n                   ^\nnumpy/random/mtrand/mtrand.c:45209:20: error: 'PyThreadState {aka struct _ts}' h\nas no member named 'exc_value'\n     *value = tstate->exc_value;\n...\n```\n\n\n\nnumpy's issue [#10500](https://github.com/numpy/numpy/issues/10500). I am not sure what is the right call here i will try with `numpy 1.14.5`",
    "created_at": "2018-07-02T09:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358859",
    "user": "@vinklein"
}
```

And now it's numpy's turn :


```
$ ./configure --with-python=3
...
$ make build
...
/home/vklein/odk/sage/local/lib/python3.7/distutils/dist.py:274: UserWarning: Un
known distribution option: 'define_macros'
  warnings.warn(msg)
numpy/random/mtrand/mtrand.c: In function '__Pyx__ExceptionSave':
numpy/random/mtrand/mtrand.c:45208:19: error: 'PyThreadState {aka struct _ts}' h
as no member named 'exc_type'
     *type = tstate->exc_type;
                   ^
numpy/random/mtrand/mtrand.c:45209:20: error: 'PyThreadState {aka struct _ts}' h
as no member named 'exc_value'
     *value = tstate->exc_value;
...
```



numpy's issue [#10500](https://github.com/numpy/numpy/issues/10500). I am not sure what is the right call here i will try with `numpy 1.14.5`



---

archive/issue_comments_358860.json:
```json
{
    "body": "When updating to `numpy 1.14.5` with this following patch :\n\n```\ndiff --git a/numpy/distutils/system_info.py b/numpy/distutils/system_info.py\nindex 93a8e6f..6e31d30 100644\n--- a/numpy/distutils/system_info.py\n+++ b/numpy/distutils/system_info.py\n@@ -1740,7 +1740,7 @@ class blas_info(system_info):\n             lib = self.has_cblas(info)\n             if lib is not None:\n                 info['language'] = 'c'\n-                info['libraries'] = [lib]\n+                info['libraries'] = lib\n                 info['define_macros'] = [('HAVE_CBLAS', None)]\n         self.set_info(**info)\n \n@@ -1772,16 +1772,16 @@ class blas_info(system_info):\n                 # check for cblas lib, and if not present check for blas lib.\n                 try:\n                     c.link_executable(obj, os.path.join(tmpdir, \"a.out\"),\n-                                      libraries=[\"cblas\"],\n+                                      libraries=[\"libraries\"],\n                                       library_dirs=info['library_dirs'],\n                                       extra_postargs=info.get('extra_link_args', []))\n-                    res = \"cblas\"\n+                    res = info[\"libraries\"]\n                 except distutils.ccompiler.LinkError:\n                     c.link_executable(obj, os.path.join(tmpdir, \"a.out\"),\n                                       libraries=[\"blas\"],\n                                       library_dirs=info['library_dirs'],\n                                       extra_postargs=info.get('extra_link_args', []))\n-                    res = \"blas\"\n+                    res = [\"blas\"]\n             except distutils.ccompiler.CompileError:\n                 res = None\n         finally:\n```\n\n\nI get the following error :\n\n```\nFound local metadata for numpy-1.14.5.p0\nUsing cached file /home/vklein/odk/sage/upstream/numpy-1.14.5.zip\nnumpy-1.14.5.p0\n====================================================\nSetting up build directory for numpy-1.14.5.p0\nFinished extraction\nApplying patches from ../patches...\nApplying ../patches/numpy-1.14.5-no-hardcode-blas.patch\npatching file numpy/distutils/system_info.py\n****************************************************\nHost system:\nLinux tuono 4.13.0-45-generic #50~16.04.1-Ubuntu SMP Wed May 30 11:18:27 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/5/lto-wrapper\nTarget: x86_64-linux-gnu\nConfigured with: ../src/configure -v --with-pkgversion='Ubuntu 5.4.0-6ubuntu1~16.04.10' --with-bugurl=file:///usr/s\nhare/doc/gcc-5/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suff\nix=-5 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=po\nsix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcx\nx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --en\nable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/\nusr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-5-amd64 -\n-with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share\n/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --wit\nh-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-g\nnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu\nThread model: posix\ngcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.10) \n****************************************************\n\nNote: if you need reliable uninstall behavior, then install\nwith pip instead of using `setup.py install`:\n\n  - `pip install .`       (from a git repo or downloaded source\n                           release)\n  - `pip install numpy`   (last NumPy release on PyPi)\n\n\nblas_opt_info:\nblas_mkl_info:\nDisabled blas_mkl_info: (MKLROOT is None)\nDisabled blas_mkl_info: (MKLROOT is None)\ncustomize UnixCCompiler\n  libraries mkl_rt not found in []\n  NOT AVAILABLE\n\nblis_info:\ncustomize UnixCCompiler\n  libraries blis not found in ['/home/vklein/odk/sage/local/lib', '/usr/local/lib', '/usr/lib', '/usr/lib/x86_64-li\nnux-gnu']\n  NOT AVAILABLE\n\nopenblas_info:\ncustomize UnixCCompiler\nDisabled openblas_info: (OPENBLAS is None)\ncustomize UnixCCompiler\n  libraries openblas not found in []\n  NOT AVAILABLE\n\natlas_3_10_blas_threads_info:\nDisabled atlas_3_10_blas_threads_info: (PTATLAS is None)\ncustomize UnixCCompiler\n  libraries tatlas not found in []\n  NOT AVAILABLE\n\natlas_3_10_blas_info:\nDisabled atlas_3_10_blas_info: (ATLAS is None)\ncustomize UnixCCompiler\n  libraries satlas not found in []\n  NOT AVAILABLE\n\natlas_blas_threads_info:\nDisabled atlas_blas_threads_info: (PTATLAS is None)\ncustomize UnixCCompiler\n  libraries ptf77blas,ptcblas,atlas not found in []\n  NOT AVAILABLE\n\natlas_blas_info:\nDisabled atlas_blas_info: (ATLAS is None)\ncustomize UnixCCompiler\n  libraries f77blas,cblas,atlas not found in []\n  NOT AVAILABLE\n\nblas_info:\ncustomize UnixCCompiler\ncustomize UnixCCompiler\nC compiler: gcc -DNDEBUG -g -fwrapv -O3 -Wall -D__CEPHES_COMPLEX_H -fPIC\n\ncreating /tmp/tmpyq7p80or/tmp\ncreating /tmp/tmpyq7p80or/tmp/tmpyq7p80or\ncompile options: '-I/home/vklein/odk/sage/local/include -c'\ngcc: /tmp/tmpyq7p80or/source.c\ngcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/lib -llibraries -o /tmp/tmpyq7p80or/a.o\nut\n/usr/bin/ld: cannot find -llibraries\ncollect2: error: ld returned 1 exit status\n/usr/bin/ld: cannot find -llibraries\ncollect2: error: ld returned 1 exit status\ngcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/lib -lblas -o /tmp/tmpyq7p80or/a.out\nRunning from numpy source directory.\n/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/system_info.py:624: UserWarning:\n \n    Atlas (http://math-atlas.sourceforge.net/) libraries not found.\n    Directories to search for the libraries can be specified in the\n    numpy/distutils/site.cfg file (section [atlas]) or by setting\n    the ATLAS environment variable.\n  self.calc_info()\n/usr/bin/ld: cannot find -lblas\ncollect2: error: ld returned 1 exit status\n/usr/bin/ld: cannot find -lblas\ncollect2: error: ld returned 1 exit status\nTraceback (most recent call last):\n  File \"/home/vklein/odk/sage/local/lib/python3.7/distutils/unixccompiler.py\", line 197, in link\n    self.spawn(linker + ld_args)\n  File \"/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/ccompiler.py\", line 89, \nin <lambda>\n    m = lambda self, *args, **kw: func(self, *args, **kw)\n  File \"/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/ccompiler.py\", line 152,\n in CCompiler_spawn\n    raise DistutilsExecError('Command \"%s\" failed with exit status %d%s' % (cmd, s, msg))\ndistutils.errors.DistutilsExecError: Command \"gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage\n/local/lib -llibraries -o /tmp/tmpyq7p80or/a.out\" failed with exit status 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/system_info.py\", line 17\n77, in has_cblas\n    extra_postargs=info.get('extra_link_args', []))\n  File \"/home/vklein/odk/sage/local/lib/python3.7/distutils/ccompiler.py\", line 734, in link_executable\n    debug, extra_preargs, extra_postargs, None, target_lang)\n  File \"/home/vklein/odk/sage/local/lib/python3.7/distutils/unixccompiler.py\", line 199, in link\n    raise LinkError(msg)\ndistutils.errors.LinkError: Command \"gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/li\nb -llibraries -o /tmp/tmpyq7p80or/a.out\" failed with exit status 1\n```\n\n\nAdvices or help are welcome.\nI get the same errors with a sage with python2.7.",
    "created_at": "2018-07-02T14:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358860",
    "user": "@vinklein"
}
```

When updating to `numpy 1.14.5` with this following patch :

```
diff --git a/numpy/distutils/system_info.py b/numpy/distutils/system_info.py
index 93a8e6f..6e31d30 100644
--- a/numpy/distutils/system_info.py
+++ b/numpy/distutils/system_info.py
@@ -1740,7 +1740,7 @@ class blas_info(system_info):
             lib = self.has_cblas(info)
             if lib is not None:
                 info['language'] = 'c'
-                info['libraries'] = [lib]
+                info['libraries'] = lib
                 info['define_macros'] = [('HAVE_CBLAS', None)]
         self.set_info(**info)
 
@@ -1772,16 +1772,16 @@ class blas_info(system_info):
                 # check for cblas lib, and if not present check for blas lib.
                 try:
                     c.link_executable(obj, os.path.join(tmpdir, "a.out"),
-                                      libraries=["cblas"],
+                                      libraries=["libraries"],
                                       library_dirs=info['library_dirs'],
                                       extra_postargs=info.get('extra_link_args', []))
-                    res = "cblas"
+                    res = info["libraries"]
                 except distutils.ccompiler.LinkError:
                     c.link_executable(obj, os.path.join(tmpdir, "a.out"),
                                       libraries=["blas"],
                                       library_dirs=info['library_dirs'],
                                       extra_postargs=info.get('extra_link_args', []))
-                    res = "blas"
+                    res = ["blas"]
             except distutils.ccompiler.CompileError:
                 res = None
         finally:
```


I get the following error :

```
Found local metadata for numpy-1.14.5.p0
Using cached file /home/vklein/odk/sage/upstream/numpy-1.14.5.zip
numpy-1.14.5.p0
====================================================
Setting up build directory for numpy-1.14.5.p0
Finished extraction
Applying patches from ../patches...
Applying ../patches/numpy-1.14.5-no-hardcode-blas.patch
patching file numpy/distutils/system_info.py
****************************************************
Host system:
Linux tuono 4.13.0-45-generic #50~16.04.1-Ubuntu SMP Wed May 30 11:18:27 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/5/lto-wrapper
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 5.4.0-6ubuntu1~16.04.10' --with-bugurl=file:///usr/s
hare/doc/gcc-5/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suff
ix=-5 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=po
six --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcx
x-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --en
able-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/
usr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-5-amd64 -
-with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share
/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --wit
h-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-g
nu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.10) 
****************************************************

Note: if you need reliable uninstall behavior, then install
with pip instead of using `setup.py install`:

  - `pip install .`       (from a git repo or downloaded source
                           release)
  - `pip install numpy`   (last NumPy release on PyPi)


blas_opt_info:
blas_mkl_info:
Disabled blas_mkl_info: (MKLROOT is None)
Disabled blas_mkl_info: (MKLROOT is None)
customize UnixCCompiler
  libraries mkl_rt not found in []
  NOT AVAILABLE

blis_info:
customize UnixCCompiler
  libraries blis not found in ['/home/vklein/odk/sage/local/lib', '/usr/local/lib', '/usr/lib', '/usr/lib/x86_64-li
nux-gnu']
  NOT AVAILABLE

openblas_info:
customize UnixCCompiler
Disabled openblas_info: (OPENBLAS is None)
customize UnixCCompiler
  libraries openblas not found in []
  NOT AVAILABLE

atlas_3_10_blas_threads_info:
Disabled atlas_3_10_blas_threads_info: (PTATLAS is None)
customize UnixCCompiler
  libraries tatlas not found in []
  NOT AVAILABLE

atlas_3_10_blas_info:
Disabled atlas_3_10_blas_info: (ATLAS is None)
customize UnixCCompiler
  libraries satlas not found in []
  NOT AVAILABLE

atlas_blas_threads_info:
Disabled atlas_blas_threads_info: (PTATLAS is None)
customize UnixCCompiler
  libraries ptf77blas,ptcblas,atlas not found in []
  NOT AVAILABLE

atlas_blas_info:
Disabled atlas_blas_info: (ATLAS is None)
customize UnixCCompiler
  libraries f77blas,cblas,atlas not found in []
  NOT AVAILABLE

blas_info:
customize UnixCCompiler
customize UnixCCompiler
C compiler: gcc -DNDEBUG -g -fwrapv -O3 -Wall -D__CEPHES_COMPLEX_H -fPIC

creating /tmp/tmpyq7p80or/tmp
creating /tmp/tmpyq7p80or/tmp/tmpyq7p80or
compile options: '-I/home/vklein/odk/sage/local/include -c'
gcc: /tmp/tmpyq7p80or/source.c
gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/lib -llibraries -o /tmp/tmpyq7p80or/a.o
ut
/usr/bin/ld: cannot find -llibraries
collect2: error: ld returned 1 exit status
/usr/bin/ld: cannot find -llibraries
collect2: error: ld returned 1 exit status
gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/lib -lblas -o /tmp/tmpyq7p80or/a.out
Running from numpy source directory.
/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/system_info.py:624: UserWarning:
 
    Atlas (http://math-atlas.sourceforge.net/) libraries not found.
    Directories to search for the libraries can be specified in the
    numpy/distutils/site.cfg file (section [atlas]) or by setting
    the ATLAS environment variable.
  self.calc_info()
/usr/bin/ld: cannot find -lblas
collect2: error: ld returned 1 exit status
/usr/bin/ld: cannot find -lblas
collect2: error: ld returned 1 exit status
Traceback (most recent call last):
  File "/home/vklein/odk/sage/local/lib/python3.7/distutils/unixccompiler.py", line 197, in link
    self.spawn(linker + ld_args)
  File "/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/ccompiler.py", line 89, 
in <lambda>
    m = lambda self, *args, **kw: func(self, *args, **kw)
  File "/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/ccompiler.py", line 152,
 in CCompiler_spawn
    raise DistutilsExecError('Command "%s" failed with exit status %d%s' % (cmd, s, msg))
distutils.errors.DistutilsExecError: Command "gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage
/local/lib -llibraries -o /tmp/tmpyq7p80or/a.out" failed with exit status 1

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/vklein/odk/sage/local/var/tmp/sage/build/numpy-1.14.5.p0/src/numpy/distutils/system_info.py", line 17
77, in has_cblas
    extra_postargs=info.get('extra_link_args', []))
  File "/home/vklein/odk/sage/local/lib/python3.7/distutils/ccompiler.py", line 734, in link_executable
    debug, extra_preargs, extra_postargs, None, target_lang)
  File "/home/vklein/odk/sage/local/lib/python3.7/distutils/unixccompiler.py", line 199, in link
    raise LinkError(msg)
distutils.errors.LinkError: Command "gcc /tmp/tmpyq7p80or/tmp/tmpyq7p80or/source.o -L/home/vklein/odk/sage/local/li
b -llibraries -o /tmp/tmpyq7p80or/a.out" failed with exit status 1
```


Advices or help are welcome.
I get the same errors with a sage with python2.7.



---

archive/issue_comments_358861.json:
```json
{
    "body": "Replying to [comment:26 vklein]:\n> numpy's issue [#10500](https://github.com/numpy/numpy/issues/10500).\n\nThe solution seems to be recythonizing. Maybe we should just do that when building numpy.",
    "created_at": "2018-07-02T14:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358861",
    "user": "@jdemeyer"
}
```

Replying to [comment:26 vklein]:
> numpy's issue [#10500](https://github.com/numpy/numpy/issues/10500).

The solution seems to be recythonizing. Maybe we should just do that when building numpy.



---

archive/issue_comments_358862.json:
```json
{
    "body": "Ok i will try.",
    "created_at": "2018-07-02T15:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358862",
    "user": "@vinklein"
}
```

Ok i will try.



---

archive/issue_comments_358863.json:
```json
{
    "body": "Replying to [comment:29 vklein]:\n> Ok i will try.\n\nIf you look in the `setup.py` file of `numpy`, you'll see\n\n```\n    from setuptools import setup\n    if run_build:\n        from numpy.distutils.core import setup\n        cwd = os.path.abspath(os.path.dirname(__file__))\n        if not os.path.exists(os.path.join(cwd, 'PKG-INFO')):\n            # Generate Cython sources, unless building from source release\n            generate_cython()\n```\n\n\nSo I guess that removing the `PKG-INFO` file in `spkg-install` will force recythonization.",
    "created_at": "2018-07-02T15:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358863",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 vklein]:
> Ok i will try.

If you look in the `setup.py` file of `numpy`, you'll see

```
    from setuptools import setup
    if run_build:
        from numpy.distutils.core import setup
        cwd = os.path.abspath(os.path.dirname(__file__))
        if not os.path.exists(os.path.join(cwd, 'PKG-INFO')):
            # Generate Cython sources, unless building from source release
            generate_cython()
```


So I guess that removing the `PKG-INFO` file in `spkg-install` will force recythonization.



---

archive/issue_comments_358864.json:
```json
{
    "body": "Your trick almost work. The problem is that the numpy file [tools/cythonize.py](https://github.com/numpy/numpy/blob/master/tools/cythonize.py) is not in numpy's source releases.",
    "created_at": "2018-07-02T16:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358864",
    "user": "@vinklein"
}
```

Your trick almost work. The problem is that the numpy file [tools/cythonize.py](https://github.com/numpy/numpy/blob/master/tools/cythonize.py) is not in numpy's source releases.



---

archive/issue_comments_358865.json:
```json
{
    "body": "I confirm that numpy's install work if we remove `PKG-INFO` and add `cythonize.py` file.",
    "created_at": "2018-07-02T17:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358865",
    "user": "@vinklein"
}
```

I confirm that numpy's install work if we remove `PKG-INFO` and add `cythonize.py` file.



---

archive/issue_comments_358866.json:
```json
{
    "body": "Adding a patch to fix `numpy`'s \u200bissue [#10500](https://github.com/numpy/numpy/issues/10500).\n----\nNew commits:",
    "created_at": "2018-07-03T08:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358866",
    "user": "@vinklein"
}
```

Adding a patch to fix `numpy`'s ​issue [#10500](https://github.com/numpy/numpy/issues/10500).
----
New commits:



---

archive/issue_comments_358867.json:
```json
{
    "body": "Can we please deal with numpy in a separate ticket.",
    "created_at": "2018-07-03T08:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358867",
    "user": "@jdemeyer"
}
```

Can we please deal with numpy in a separate ticket.



---

archive/issue_comments_358868.json:
```json
{
    "body": "I don't know. The patch doesn't make sense without python 3.7.",
    "created_at": "2018-07-03T08:18:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358868",
    "user": "@vinklein"
}
```

I don't know. The patch doesn't make sense without python 3.7.



---

archive/issue_comments_358869.json:
```json
{
    "body": "Replying to [comment:36 vklein]:\n> I don't know. The patch doesn't make sense without python 3.7.\n\nIt's needed for Python 3.7, but the fix is unrelated to it.",
    "created_at": "2018-07-03T08:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358869",
    "user": "@jdemeyer"
}
```

Replying to [comment:36 vklein]:
> I don't know. The patch doesn't make sense without python 3.7.

It's needed for Python 3.7, but the fix is unrelated to it.



---

archive/issue_comments_358870.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2018-07-03T08:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358870",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_358871.json:
```json
{
    "body": "If you're patching the sources anyway, I would prefer to patch `setup.py` instead of removing `PKG-INFO`.",
    "created_at": "2018-07-03T08:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358871",
    "user": "@jdemeyer"
}
```

If you're patching the sources anyway, I would prefer to patch `setup.py` instead of removing `PKG-INFO`.



---

archive/issue_comments_358872.json:
```json
{
    "body": "Sure ! It will be cleaner to patch `setup.py`.",
    "created_at": "2018-07-03T08:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358872",
    "user": "@vinklein"
}
```

Sure ! It will be cleaner to patch `setup.py`.



---

archive/issue_comments_358873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-03T08:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358873",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358874.json:
```json
{
    "body": "scipy errors seems pretty similar to numpy's:\n\n\n```\nscipy/cluster/_vq.c: In function '__Pyx__ExceptionSave':\n    scipy/cluster/_vq.c:9728:19: error: 'PyThreadState {aka struct _ts}' has no member named 'exc_type'\n         *type = tstate->exc_type;\n                       ^\n    scipy/cluster/_vq.c:9729:20: error: 'PyThreadState {aka struct _ts}' has no member named 'exc_value'\n         *value = tstate->exc_value;\n```\n\n\nWith likely the same cause.\nIn `setup.py` file of `scipy` :\n        \n\n```\n        if not os.path.exists(os.path.join(cwd, 'PKG-INFO')):\n            # Generate Cython sources, unless building from source release\n            generate_cython()\n```\n",
    "created_at": "2018-07-03T14:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358874",
    "user": "@vinklein"
}
```

scipy errors seems pretty similar to numpy's:


```
scipy/cluster/_vq.c: In function '__Pyx__ExceptionSave':
    scipy/cluster/_vq.c:9728:19: error: 'PyThreadState {aka struct _ts}' has no member named 'exc_type'
         *type = tstate->exc_type;
                       ^
    scipy/cluster/_vq.c:9729:20: error: 'PyThreadState {aka struct _ts}' has no member named 'exc_value'
         *value = tstate->exc_value;
```


With likely the same cause.
In `setup.py` file of `scipy` :
        

```
        if not os.path.exists(os.path.join(cwd, 'PKG-INFO')):
            # Generate Cython sources, unless building from source release
            generate_cython()
```




---

archive/issue_comments_358875.json:
```json
{
    "body": "Building sage with this ticket and it's dependencies works fine.\n\nI have made two run of `sage -t -a --long`, one with a sage python3.6 and one with this ticket. Comparing the logs of the two runs (and weakly idenfying a failure by the tuple (<sage file with the failure>, <line of the failure>) with a little script, i get the following results:\n\n\n```\nnb doctests failures with python3.6: 42990\nnb doctests failures with python3.7: 43643\nnew python3.7 failures : 1366\npython3.6 failures not appearing with python 3.7 : 713\n```\n\n\nTwo exemple failures among 1366 :\n\n```\nFile \"src/sage/combinat/finite_state_machine.py\", line 10190, in sage.combinat.finite_state_machine.FiniteStateMachine.asymptotic_moments\nFailed example:\n    moments = T.asymptotic_moments()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 573, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 983, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.finite_state_machine.FiniteStateMachine.asymptotic_moments[2]>\", line 1, in <module>\n        moments = T.asymptotic_moments()\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/combinat/finite_state_machine.py\", line 10540, in asymptotic_moments\n        if not final_component.digraph().is_aperiodic():\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py\", line 3330, in is_aperiodic\n        import networkx\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/__init__.py\", line 114, in <module>\n        import networkx.generators\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/generators/__init__.py\", line 13, in <module>\n        from networkx.generators.geometric import *\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/generators/geometric.py\", line 27, in <module>\n        from scipy.spatial import cKDTree as KDTree\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/scipy/spatial/__init__.py\", line 95, in <module>\n        from .qhull import *\n      File \"qhull.pyx\", line 2224, in init scipy.spatial.qhull\n    AttributeError: 'cython_function_or_method' object has no attribute '__func__'\n\nsage -t --long src/sage/combinat/dyck_word.py\n**********************************************************************\nFile \"src/sage/combinat/dyck_word.py\", line 873, in sage.combinat.dyck_word.DyckWord.plot\nFailed example:\n    w.plot()\nExpected:\n    Graphics object consisting of 1 graphics primitive\nGot:\n    doctest:warning\n      File \"/home/vklein/odk/sage/src/bin/sage-runtests\", line 127, in <module>\n        err = DC.run()\n      File \"/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/control.py\", line 1172, in run\n        self.run_doctests()\n      ...\n      File \"/home/vklein/odk/sage/local/lib/python3.7/collections/__init__.py\", line 52, in __getattr__\n        DeprecationWarning, stacklevel=2)\n            File \"/home/vklein/odk/sage/local/lib/python3.7/warnings.py\", line 99, in _showwarnmsg\n        msg.file, msg.line)\n    :\n    DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working\n    Graphics object consisting of 1 graphics primitive\n```\n\n\nNote : To see the script and logs used https://github.com/vinklein/Trac25680",
    "created_at": "2018-07-05T09:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358875",
    "user": "@vinklein"
}
```

Building sage with this ticket and it's dependencies works fine.

I have made two run of `sage -t -a --long`, one with a sage python3.6 and one with this ticket. Comparing the logs of the two runs (and weakly idenfying a failure by the tuple (<sage file with the failure>, <line of the failure>) with a little script, i get the following results:


```
nb doctests failures with python3.6: 42990
nb doctests failures with python3.7: 43643
new python3.7 failures : 1366
python3.6 failures not appearing with python 3.7 : 713
```


Two exemple failures among 1366 :

```
File "src/sage/combinat/finite_state_machine.py", line 10190, in sage.combinat.finite_state_machine.FiniteStateMachine.asymptotic_moments
Failed example:
    moments = T.asymptotic_moments()
Exception raised:
    Traceback (most recent call last):
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.finite_state_machine.FiniteStateMachine.asymptotic_moments[2]>", line 1, in <module>
        moments = T.asymptotic_moments()
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/combinat/finite_state_machine.py", line 10540, in asymptotic_moments
        if not final_component.digraph().is_aperiodic():
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/graphs/digraph.py", line 3330, in is_aperiodic
        import networkx
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/__init__.py", line 114, in <module>
        import networkx.generators
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/generators/__init__.py", line 13, in <module>
        from networkx.generators.geometric import *
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/networkx/generators/geometric.py", line 27, in <module>
        from scipy.spatial import cKDTree as KDTree
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/scipy/spatial/__init__.py", line 95, in <module>
        from .qhull import *
      File "qhull.pyx", line 2224, in init scipy.spatial.qhull
    AttributeError: 'cython_function_or_method' object has no attribute '__func__'

sage -t --long src/sage/combinat/dyck_word.py
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 873, in sage.combinat.dyck_word.DyckWord.plot
Failed example:
    w.plot()
Expected:
    Graphics object consisting of 1 graphics primitive
Got:
    doctest:warning
      File "/home/vklein/odk/sage/src/bin/sage-runtests", line 127, in <module>
        err = DC.run()
      File "/home/vklein/odk/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1172, in run
        self.run_doctests()
      ...
      File "/home/vklein/odk/sage/local/lib/python3.7/collections/__init__.py", line 52, in __getattr__
        DeprecationWarning, stacklevel=2)
            File "/home/vklein/odk/sage/local/lib/python3.7/warnings.py", line 99, in _showwarnmsg
        msg.file, msg.line)
    :
    DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working
    Graphics object consisting of 1 graphics primitive
```


Note : To see the script and logs used https://github.com/vinklein/Trac25680



---

archive/issue_comments_358876.json:
```json
{
    "body": "Python 3.7 seems to require libffi as new dependency, so I guess we should add that as Sage package.\n----\nNew commits:",
    "created_at": "2018-07-22T20:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358876",
    "user": "@jdemeyer"
}
```

Python 3.7 seems to require libffi as new dependency, so I guess we should add that as Sage package.
----
New commits:



---

archive/issue_comments_358877.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-22T21:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358877",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-22T21:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358878",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358879.json:
```json
{
    "body": "Replying to [comment:15 fbissey]:\n> Failure to build `_ctypes` usually means a problem with `ffi` (sometimes called libffi) may be there is minimum version requirement?\n\nIt seems that older Python versions vendored libffi but this was changed in Python 3.7. See https://docs.python.org/3/whatsnew/3.7.html#build-changes",
    "created_at": "2018-07-22T22:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358879",
    "user": "@jdemeyer"
}
```

Replying to [comment:15 fbissey]:
> Failure to build `_ctypes` usually means a problem with `ffi` (sometimes called libffi) may be there is minimum version requirement?

It seems that older Python versions vendored libffi but this was changed in Python 3.7. See https://docs.python.org/3/whatsnew/3.7.html#build-changes



---

archive/issue_comments_358880.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-22T22:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358880",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358881.json:
```json
{
    "body": "The build works fine with the new dependencies.",
    "created_at": "2018-07-23T09:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358881",
    "user": "@vinklein"
}
```

The build works fine with the new dependencies.



---

archive/issue_comments_358882.json:
```json
{
    "body": "Ok, since this will be delayed until 8.4 (at least) I rescind my earlier concerns that this will hinder the Python 3 port.  After a thorough reading of the release notes I don't think there's anything that will hurt, and there are some things that will almost certainly help (such a `dict` insertion order preservation).\n\nI just need to see how Python 3.7 does on Cygwin (originally I was aiming to have CPython fully supported on Cygwin by 3.7, but I just didn't have the time, though we did get some important big fixes in).",
    "created_at": "2018-07-23T16:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358882",
    "user": "@embray"
}
```

Ok, since this will be delayed until 8.4 (at least) I rescind my earlier concerns that this will hinder the Python 3 port.  After a thorough reading of the release notes I don't think there's anything that will hurt, and there are some things that will almost certainly help (such a `dict` insertion order preservation).

I just need to see how Python 3.7 does on Cygwin (originally I was aiming to have CPython fully supported on Cygwin by 3.7, but I just didn't have the time, though we did get some important big fixes in).



---

archive/issue_comments_358883.json:
```json
{
    "body": "branch does not apply",
    "created_at": "2018-08-10T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358883",
    "user": "@fchapoton"
}
```

branch does not apply



---

archive/issue_comments_358884.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-10T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358884",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_358885.json:
```json
{
    "body": "`@`embray Have you some news on Python3.7 on Cygwin ?",
    "created_at": "2018-09-26T08:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358885",
    "user": "@vinklein"
}
```

`@`embray Have you some news on Python3.7 on Cygwin ?



---

archive/issue_comments_358886.json:
```json
{
    "body": "My only news is I have multiple upstream PRs necessary for 3.7 to at least build, at a bare minimum, on Cygwin, and they have been stalled for quite a bit.  I was just thinking yesterday of poking python-dev soon for someone to look at them.\n\nI actually now maintain an official CPython buildbot for Cygwin, but it's all but useless until those fixes are accepted: https://buildbot.python.org/all/#/builders/164",
    "created_at": "2018-09-26T09:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358886",
    "user": "@embray"
}
```

My only news is I have multiple upstream PRs necessary for 3.7 to at least build, at a bare minimum, on Cygwin, and they have been stalled for quite a bit.  I was just thinking yesterday of poking python-dev soon for someone to look at them.

I actually now maintain an official CPython buildbot for Cygwin, but it's all but useless until those fixes are accepted: https://buildbot.python.org/all/#/builders/164



---

archive/issue_comments_358887.json:
```json
{
    "body": "The more I think about it, the more I'm also hesitant to make 3.7 the Python for Sage until 3.7 is in more distros.  But I'm not sure.  It would be easier to depend on an arbitrary Python 3 (or at least 3.4+) if we were also dropping Python 2 support completely.  I don't think we've set a schedule for doing that, but I doubt that will happen in Sage until *after* the Python 2 EoL.",
    "created_at": "2018-09-26T09:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358887",
    "user": "@embray"
}
```

The more I think about it, the more I'm also hesitant to make 3.7 the Python for Sage until 3.7 is in more distros.  But I'm not sure.  It would be easier to depend on an arbitrary Python 3 (or at least 3.4+) if we were also dropping Python 2 support completely.  I don't think we've set a schedule for doing that, but I doubt that will happen in Sage until *after* the Python 2 EoL.



---

archive/issue_comments_358888.json:
```json
{
    "body": "Ok i see (https://github.com/python/cpython/pulls/embray). \n\nSo does that mean you think we should fix problems like `itertools.islice` in sage rather than waiting for 3.7 ?",
    "created_at": "2018-09-26T09:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358888",
    "user": "@vinklein"
}
```

Ok i see (https://github.com/python/cpython/pulls/embray). 

So does that mean you think we should fix problems like `itertools.islice` in sage rather than waiting for 3.7 ?



---

archive/issue_comments_358889.json:
```json
{
    "body": "Replying to [comment:59 vklein]:\n> Ok i see (https://github.com/python/cpython/pulls/embray). \n\nWow, I have several PRs pending...  FWIW the only two that are major blockers for Python on Cygwin are:\n\nhttps://github.com/python/cpython/pull/4348\nhttps://github.com/python/cpython/pull/8712\n\nOf course, that alone doesn't necessarily need to block Sage's Python 3 spkg--as it is I believe we already include some custom patches for Cygwin, and I'm okay with that for now.  I just brought it up since you asked about the status on Cygwin.  Also, beyond those patches, there may be other issues.  I actually haven't spent much time on it since I was hoping to get some movement on those bare minimum issues before I do much more... *sigh*\n \n> So does that mean you think we should fix problems like `itertools.islice` in sage rather than waiting for 3.7 ?\n\nYes, and for two reasons:\n\n1) We've already fixed those problems in several cases; probably even the majority of them (I have a few more in my Python 3 branch I haven't even made tickets for yet).\n\n2) We will likely have to work around that anyway for downstream distros, unless we want to make 3.7 a hard requirement for Sage.  But that might be tough, at least in the near term...",
    "created_at": "2018-09-26T10:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358889",
    "user": "@embray"
}
```

Replying to [comment:59 vklein]:
> Ok i see (https://github.com/python/cpython/pulls/embray). 

Wow, I have several PRs pending...  FWIW the only two that are major blockers for Python on Cygwin are:

https://github.com/python/cpython/pull/4348
https://github.com/python/cpython/pull/8712

Of course, that alone doesn't necessarily need to block Sage's Python 3 spkg--as it is I believe we already include some custom patches for Cygwin, and I'm okay with that for now.  I just brought it up since you asked about the status on Cygwin.  Also, beyond those patches, there may be other issues.  I actually haven't spent much time on it since I was hoping to get some movement on those bare minimum issues before I do much more... *sigh*
 
> So does that mean you think we should fix problems like `itertools.islice` in sage rather than waiting for 3.7 ?

Yes, and for two reasons:

1) We've already fixed those problems in several cases; probably even the majority of them (I have a few more in my Python 3 branch I haven't even made tickets for yet).

2) We will likely have to work around that anyway for downstream distros, unless we want to make 3.7 a hard requirement for Sage.  But that might be tough, at least in the near term...



---

archive/issue_comments_358890.json:
```json
{
    "body": "Changing keywords from \"\" to \"upgrade, Python3\".",
    "created_at": "2018-10-23T12:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358890",
    "user": "@slel"
}
```

Changing keywords from "" to "upgrade, Python3".



---

archive/issue_comments_358891.json:
```json
{
    "body": "Python 3.7.1 was released.",
    "created_at": "2018-10-23T12:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358891",
    "user": "@slel"
}
```

Python 3.7.1 was released.



---

archive/issue_comments_358892.json:
```json
{
    "body": "Python 3.7.2rc1 was released: [Python insider blog post: Python 3.7.2rc1](https://blog.python.org/2018/12/python-372rc1-and-368rc1-now-available.html).",
    "created_at": "2018-12-15T17:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358892",
    "user": "@slel"
}
```

Python 3.7.2rc1 was released: [Python insider blog post: Python 3.7.2rc1](https://blog.python.org/2018/12/python-372rc1-and-368rc1-now-available.html).



---

archive/issue_comments_358893.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-11T20:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358893",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358894.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-11T20:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358894",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358895.json:
```json
{
    "body": "When running sage in py3 a difference with python3.6 is that we get a bunch of doctests errors of type `DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working`. They mainly comes form `matplotlib` package but also from packages `jinja2`, `networkx` and `werkzeug`.",
    "created_at": "2019-02-12T11:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358895",
    "user": "@vinklein"
}
```

When running sage in py3 a difference with python3.6 is that we get a bunch of doctests errors of type `DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working`. They mainly comes form `matplotlib` package but also from packages `jinja2`, `networkx` and `werkzeug`.



---

archive/issue_comments_358896.json:
```json
{
    "body": "Replying to [comment:66 vklein]:\n> When running sage in py3 a difference with python3.6 is that we get a bunch of doctests errors of type `DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working`. They mainly comes form `matplotlib` package but also from packages `jinja2`, `networkx` and `werkzeug`.\n\nWe could just hide that warning.",
    "created_at": "2019-02-12T16:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358896",
    "user": "@jdemeyer"
}
```

Replying to [comment:66 vklein]:
> When running sage in py3 a difference with python3.6 is that we get a bunch of doctests errors of type `DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working`. They mainly comes form `matplotlib` package but also from packages `jinja2`, `networkx` and `werkzeug`.

We could just hide that warning.



---

archive/issue_comments_358897.json:
```json
{
    "body": "|                |                       |                  |\n|----------------|-----------------------|------------------|\n| Python version | Files having failures | failing doctests |\n| 3.6.6 | 166 | 717 |\n| 3.7.2 | 387 | 1104 |\nNumbers of `DeprecationWarning: Using or importing the ABCs from 'collections'...` : 230.\n\nnew python3.7 failures : 407\\\\\n\npython3.6 failures not appearing with python 3.7 : 18\n\nLink for the doctest logs [here](https://www.labri.fr/perso/vklein/python3.7.2.log.zip)",
    "created_at": "2019-02-12T16:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358897",
    "user": "@vinklein"
}
```

|                |                       |                  |
|----------------|-----------------------|------------------|
| Python version | Files having failures | failing doctests |
| 3.6.6 | 166 | 717 |
| 3.7.2 | 387 | 1104 |
Numbers of `DeprecationWarning: Using or importing the ABCs from 'collections'...` : 230.

new python3.7 failures : 407\\

python3.6 failures not appearing with python 3.7 : 18

Link for the doctest logs [here](https://www.labri.fr/perso/vklein/python3.7.2.log.zip)



---

archive/issue_comments_358898.json:
```json
{
    "body": "By the way, I don't think that increasing the number of doctest failures should prevent this ticket from being merged. We'll need to support Python 3.7 sooner or later, so we might as well do it sooner.",
    "created_at": "2019-02-12T16:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358898",
    "user": "@jdemeyer"
}
```

By the way, I don't think that increasing the number of doctest failures should prevent this ticket from being merged. We'll need to support Python 3.7 sooner or later, so we might as well do it sooner.



---

archive/issue_comments_358899.json:
```json
{
    "body": "Yes i agree with that. I am ok to give positive review for this ticket as you can now run sage with this python version. \n\n`@`embray can you confirm that it's ok for Cygwin now ? ((https://github.com/python/cpython/pull/4348 \u200bhttps://github.com/python/cpython/pull/8712 have been merged)",
    "created_at": "2019-02-12T17:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358899",
    "user": "@vinklein"
}
```

Yes i agree with that. I am ok to give positive review for this ticket as you can now run sage with this python version. 

`@`embray can you confirm that it's ok for Cygwin now ? ((https://github.com/python/cpython/pull/4348 ​https://github.com/python/cpython/pull/8712 have been merged)



---

archive/issue_comments_358900.json:
```json
{
    "body": "oh, great, 400 new doctests to fix.. really great.. I was afraid to start lacking things to do...\n\nDoes this pass the python3 test target ?\n\nIf not, it will fail on the buildbot that checks exactly that.. and maybe the release manager will say **niet**.",
    "created_at": "2019-02-12T17:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358900",
    "user": "@fchapoton"
}
```

oh, great, 400 new doctests to fix.. really great.. I was afraid to start lacking things to do...

Does this pass the python3 test target ?

If not, it will fail on the buildbot that checks exactly that.. and maybe the release manager will say **niet**.



---

archive/issue_comments_358901.json:
```json
{
    "body": "Like I said, we would need to fix those failures at some point anyway. I don't think that we want to stay on Python 3.6 forever.",
    "created_at": "2019-02-12T17:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358901",
    "user": "@jdemeyer"
}
```

Like I said, we would need to fix those failures at some point anyway. I don't think that we want to stay on Python 3.6 forever.



---

archive/issue_comments_358902.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-12T21:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358902",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358903.json:
```json
{
    "body": "Most remaining failures are of the form\n\n```\nsage -t --long src/sage/rings/number_field/galois_group.py\n**********************************************************************\nFile \"src/sage/rings/number_field/galois_group.py\", line 20, in sage.rings.number_field.galois_group\nFailed example:\n    G == loads(dumps(G))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.number_field.galois_group[3]>\", line 1, in <module>\n        G == loads(dumps(G))\n      File \"sage/misc/persist.pyx\", line 968, in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7256)\n        return unpickler.load()\n      File \"/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py\", line 573, in extend\n        self._require_mutable()\n      File \"/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py\", line 740, in _require_mutable\n        if self._is_immutable:\n      File \"/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py\", line 879, in __getattr__\n        raise AttributeError(\"'Sequence_generic' object has no attribute '%s'\"%name)\n    AttributeError: 'Sequence_generic' object has no attribute '_is_immutable'\n**********************************************************************\n```\n",
    "created_at": "2019-02-12T22:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358903",
    "user": "@jdemeyer"
}
```

Most remaining failures are of the form

```
sage -t --long src/sage/rings/number_field/galois_group.py
**********************************************************************
File "src/sage/rings/number_field/galois_group.py", line 20, in sage.rings.number_field.galois_group
Failed example:
    G == loads(dumps(G))
Exception raised:
    Traceback (most recent call last):
      File "/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.number_field.galois_group[3]>", line 1, in <module>
        G == loads(dumps(G))
      File "sage/misc/persist.pyx", line 968, in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7256)
        return unpickler.load()
      File "/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py", line 573, in extend
        self._require_mutable()
      File "/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py", line 740, in _require_mutable
        if self._is_immutable:
      File "/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py", line 879, in __getattr__
        raise AttributeError("'Sequence_generic' object has no attribute '%s'"%name)
    AttributeError: 'Sequence_generic' object has no attribute '_is_immutable'
**********************************************************************
```




---

archive/issue_comments_358904.json:
```json
{
    "body": "The filter works ! So it will be more something like 177 new doctests failures rather than 407.",
    "created_at": "2019-02-12T22:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358904",
    "user": "@vinklein"
}
```

The filter works ! So it will be more something like 177 new doctests failures rather than 407.



---

archive/issue_comments_358905.json:
```json
{
    "body": "Also\n\n```\nDeprecationWarning: time.clock has been deprecated in Python 3.3 and will be removed from Python 3.8: use time.perf_counter or time.process_time instead\n```\n",
    "created_at": "2019-02-12T22:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358905",
    "user": "@jdemeyer"
}
```

Also

```
DeprecationWarning: time.clock has been deprecated in Python 3.3 and will be removed from Python 3.8: use time.perf_counter or time.process_time instead
```




---

archive/issue_comments_358906.json:
```json
{
    "body": "Replying to [comment:71 chapoton]:\n> oh, great, 400 new doctests to fix.. really great.. I was afraid to start lacking things to do...\n\nIt's not as bad as it sounds. Those 400 doctests are mostly just instances of either of two failures. So fixing those two should bring that number down to a very small number.",
    "created_at": "2019-02-12T22:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358906",
    "user": "@jdemeyer"
}
```

Replying to [comment:71 chapoton]:
> oh, great, 400 new doctests to fix.. really great.. I was afraid to start lacking things to do...

It's not as bad as it sounds. Those 400 doctests are mostly just instances of either of two failures. So fixing those two should bring that number down to a very small number.



---

archive/issue_comments_358907.json:
```json
{
    "body": "does not build on my patchbot (and others)",
    "created_at": "2019-02-14T10:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358907",
    "user": "@fchapoton"
}
```

does not build on my patchbot (and others)



---

archive/issue_comments_358908.json:
```json
{
    "body": "Replying to [comment:79 chapoton]:\n> does not build\n\nDetails please...",
    "created_at": "2019-02-14T10:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358908",
    "user": "@jdemeyer"
}
```

Replying to [comment:79 chapoton]:
> does not build

Details please...



---

archive/issue_comments_358909.json:
```json
{
    "body": "The only thing I can see from the patch bot is that the python 3.7 tarball is not mirrored so the bots fail to fetch it.",
    "created_at": "2019-02-14T10:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358909",
    "user": "@kiwifb"
}
```

The only thing I can see from the patch bot is that the python 3.7 tarball is not mirrored so the bots fail to fetch it.



---

archive/issue_comments_358910.json:
```json
{
    "body": "yes, sorry for the noise..\n\nIs there good hope to fix here the \n\n```\nAttributeError: 'Sequence_generic' object has no attribute '_is_immutable\n```\n\nerrors ? I remember that the Galois group code is a bit antique and somewhat ugly..",
    "created_at": "2019-02-14T10:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358910",
    "user": "@fchapoton"
}
```

yes, sorry for the noise..

Is there good hope to fix here the 

```
AttributeError: 'Sequence_generic' object has no attribute '_is_immutable
```

errors ? I remember that the Galois group code is a bit antique and somewhat ugly..



---

archive/issue_comments_358911.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-21T09:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358911",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358912.json:
```json
{
    "body": "I'm looking into this:\n\n```\nsage: L = Sequence(range(10))\nsage: L\n[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\nsage: loads(dumps(L))\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-3-21e74d398e6e> in <module>()\n----> 1 loads(dumps(L))\n\n/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7256)()\n    966 \n    967     unpickler = SageUnpickler(io.BytesIO(s))\n--> 968     return unpickler.load()\n    969 \n    970 \n\n/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in extend(self, iterable)\n    571             [1, 2, 3, 0, 1, 2, 3]\n    572         \"\"\"\n--> 573         self._require_mutable()\n    574         v = [self.__universe(x) for x in iterable]\n    575         list.extend(self, v)\n\n/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in _require_mutable(self)\n    738             ValueError: object is immutable; please change a copy instead.\n    739         \"\"\"\n--> 740         if self._is_immutable:\n    741             raise ValueError(\"object is immutable; please change a copy instead.\")\n    742 \n\n/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in __getattr__(self, name)\n    877             return self.__hash\n    878         else:\n--> 879             raise AttributeError(\"'Sequence_generic' object has no attribute '%s'\"%name)\n    880 seq = Sequence\n    881 \n\nAttributeError: 'Sequence_generic' object has no attribute '_is_immutable'\n```\n\nThis is causing the vast majority of all new doctest failures.",
    "created_at": "2019-02-21T10:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358912",
    "user": "@jdemeyer"
}
```

I'm looking into this:

```
sage: L = Sequence(range(10))
sage: L
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
sage: loads(dumps(L))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-3-21e74d398e6e> in <module>()
----> 1 loads(dumps(L))

/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/misc/persist.pyx in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7256)()
    966 
    967     unpickler = SageUnpickler(io.BytesIO(s))
--> 968     return unpickler.load()
    969 
    970 

/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in extend(self, iterable)
    571             [1, 2, 3, 0, 1, 2, 3]
    572         """
--> 573         self._require_mutable()
    574         v = [self.__universe(x) for x in iterable]
    575         list.extend(self, v)

/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in _require_mutable(self)
    738             ValueError: object is immutable; please change a copy instead.
    739         """
--> 740         if self._is_immutable:
    741             raise ValueError("object is immutable; please change a copy instead.")
    742 

/home/dimpase/sage-python3/local/lib/python3.7/site-packages/sage/structure/sequence.py in __getattr__(self, name)
    877             return self.__hash
    878         else:
--> 879             raise AttributeError("'Sequence_generic' object has no attribute '%s'"%name)
    880 seq = Sequence
    881 

AttributeError: 'Sequence_generic' object has no attribute '_is_immutable'
```

This is causing the vast majority of all new doctest failures.



---

archive/issue_comments_358913.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-21T11:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358913",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358914.json:
```json
{
    "body": "There is just one failure with `ptest-python3`: a timeout in `src/sage/parallel/map_reduce.py`",
    "created_at": "2019-02-21T14:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358914",
    "user": "@jdemeyer"
}
```

There is just one failure with `ptest-python3`: a timeout in `src/sage/parallel/map_reduce.py`



---

archive/issue_comments_358915.json:
```json
{
    "body": "Is this timeout somehow related with `python3.7` ? If not with #27334 i am ok to set this ticket in positive review.",
    "created_at": "2019-02-22T15:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358915",
    "user": "@vinklein"
}
```

Is this timeout somehow related with `python3.7` ? If not with #27334 i am ok to set this ticket in positive review.



---

archive/issue_comments_358916.json:
```json
{
    "body": "I'm not entirely sure what is causing that timeout... but I also don't think that it should prevent merging this ticket.",
    "created_at": "2019-02-22T16:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358916",
    "user": "@jdemeyer"
}
```

I'm not entirely sure what is causing that timeout... but I also don't think that it should prevent merging this ticket.



---

archive/issue_comments_358917.json:
```json
{
    "body": "Ok then.",
    "created_at": "2019-02-22T16:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358917",
    "user": "@vinklein"
}
```

Ok then.



---

archive/issue_comments_358918.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-22T16:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358918",
    "user": "@vinklein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358919.json:
```json
{
    "body": "Does this pass the refreshed python3 test target of 8.7.b5 (that checks more modules)?\n\nIf not, it will fail on the buildbot that checks exactly that.. and maybe the release manager will say **niet**.",
    "created_at": "2019-02-24T19:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358919",
    "user": "@fchapoton"
}
```

Does this pass the refreshed python3 test target of 8.7.b5 (that checks more modules)?

If not, it will fail on the buildbot that checks exactly that.. and maybe the release manager will say **niet**.



---

archive/issue_comments_358920.json:
```json
{
    "body": "I would argue that we can always change the list of passing doctests in this ticket. Otherwise, we are aiming for a moving target and this ticket won't ever be fixed.",
    "created_at": "2019-02-25T08:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358920",
    "user": "@jdemeyer"
}
```

I would argue that we can always change the list of passing doctests in this ticket. Otherwise, we are aiming for a moving target and this ticket won't ever be fixed.



---

archive/issue_comments_358921.json:
```json
{
    "body": "yes, sure. I would very much like this ticket to be fixed, and I do not want to do anything against it. But still maybe somebody should check if the passing doctests needs to be changed ?",
    "created_at": "2019-02-25T09:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358921",
    "user": "@fchapoton"
}
```

yes, sure. I would very much like this ticket to be fixed, and I do not want to do anything against it. But still maybe somebody should check if the passing doctests needs to be changed ?



---

archive/issue_comments_358922.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-25T18:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358922",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_358923.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-02-25T23:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358923",
    "user": "@vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_358924.json:
```json
{
    "body": "Ironically, this fails on py3:\n\n```\nsage -t --long src/sage_setup/docbuild/__init__.py\n**********************************************************************\nFile \"src/sage_setup/docbuild/__init__.py\", line 98, in sage_setup.docbuild.builder_helper\nFailed example:\n    build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\nExpected:\n    Traceback (most recent call last):\n    ...\n    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation',))\nGot:\n    <BLANKLINE>\n    multiprocessing.pool.RemoteTraceback: \n    \"\"\"\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 129, in f\n        runsphinx()\n      File \"<doctest sage_setup.docbuild.builder_helper[3]>\", line 2, in raiseBaseException\n        raise BaseException(\"abort pool operation\")\n    BaseException: abort pool operation\n    <BLANKLINE>\n    During handling of the above exception, another exception occurred:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\n        result = (True, func(*args, **kwds))\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py\", line 44, in mapstar\n        return list(map(*args))\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 73, in build_ref_doc\n        getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 742, in _wrapper\n        getattr(DocBuilder, build_type)(self, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 138, in f\n        raise Exception(\"Non-exception during docbuild: %s\"%(e,), e)\n    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))\n    \"\"\"\n    <BLANKLINE>\n    The above exception was the direct cause of the following exception:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.docbuild.builder_helper[7]>\", line 1, in <module>\n        build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 282, in build_many\n        ret = x.get(99999)\n      File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py\", line 657, in get\n        raise self._value\n    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage_setup.docbuild.builder_helper\n    [36 tests, 1 failure, 0.65 s]\n```\n",
    "created_at": "2019-02-25T23:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358924",
    "user": "@vbraun"
}
```

Ironically, this fails on py3:

```
sage -t --long src/sage_setup/docbuild/__init__.py
**********************************************************************
File "src/sage_setup/docbuild/__init__.py", line 98, in sage_setup.docbuild.builder_helper
Failed example:
    build_many(build_ref_doc, [("docname", "en", "html", {})])
Expected:
    Traceback (most recent call last):
    ...
    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation',))
Got:
    <BLANKLINE>
    multiprocessing.pool.RemoteTraceback: 
    """
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 129, in f
        runsphinx()
      File "<doctest sage_setup.docbuild.builder_helper[3]>", line 2, in raiseBaseException
        raise BaseException("abort pool operation")
    BaseException: abort pool operation
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py", line 121, in worker
        result = (True, func(*args, **kwds))
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py", line 44, in mapstar
        return list(map(*args))
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 73, in build_ref_doc
        getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 742, in _wrapper
        getattr(DocBuilder, build_type)(self, *args, **kwds)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 138, in f
        raise Exception("Non-exception during docbuild: %s"%(e,), e)
    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))
    """
    <BLANKLINE>
    The above exception was the direct cause of the following exception:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.docbuild.builder_helper[7]>", line 1, in <module>
        build_many(build_ref_doc, [("docname", "en", "html", {})])
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 282, in build_many
        ret = x.get(99999)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py", line 657, in get
        raise self._value
    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))
**********************************************************************
1 item had failures:
   1 of  10 in sage_setup.docbuild.builder_helper
    [36 tests, 1 failure, 0.65 s]
```




---

archive/issue_comments_358925.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2019-02-25T23:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358925",
    "user": "@vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_358926.json:
```json
{
    "body": "Here's what I got for the test suite on OS X:\n\n```\n\nRan 93 tests in 225.537s\n\nFAILED (errors=3, skipped=1)\n8 tests failed again:\n    test_normalization test_robotparser test_site test_ssl\n    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet\n\n## Tests result: FAILURE then FAILURE\n\n389 tests OK.\n\n8 tests failed:\n    test_normalization test_robotparser test_site test_ssl\n    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet\n\n16 tests skipped:\n    test_dbm_gnu test_devpoll test_epoll test_gdb test_msilib\n    test_multiprocessing_fork test_ossaudiodev test_spwd\n    test_startfile test_tix test_tk test_ttk_guionly test_winconsoleio\n    test_winreg test_winsound test_zipfile64\n\n8 re-run tests:\n    test_normalization test_robotparser test_site test_ssl\n    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet\n\n3 tests run no tests:\n    test_dtrace test_future4 test_largefile\n\nTotal duration: 48 min 44 sec\nTests result: FAILURE then FAILURE\nmake[2]: *** [test] Error 2\nAn error occurred while testing Python\n```\n",
    "created_at": "2019-02-26T00:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358926",
    "user": "@jhpalmieri"
}
```

Here's what I got for the test suite on OS X:

```

Ran 93 tests in 225.537s

FAILED (errors=3, skipped=1)
8 tests failed again:
    test_normalization test_robotparser test_site test_ssl
    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet

## Tests result: FAILURE then FAILURE

389 tests OK.

8 tests failed:
    test_normalization test_robotparser test_site test_ssl
    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet

16 tests skipped:
    test_dbm_gnu test_devpoll test_epoll test_gdb test_msilib
    test_multiprocessing_fork test_ossaudiodev test_spwd
    test_startfile test_tix test_tk test_ttk_guionly test_winconsoleio
    test_winreg test_winsound test_zipfile64

8 re-run tests:
    test_normalization test_robotparser test_site test_ssl
    test_sysconfig test_urllib test_urllib2 test_urllib2_localnet

3 tests run no tests:
    test_dtrace test_future4 test_largefile

Total duration: 48 min 44 sec
Tests result: FAILURE then FAILURE
make[2]: *** [test] Error 2
An error occurred while testing Python
```




---

archive/issue_comments_358927.json:
```json
{
    "body": "Please also don't set this back to positive review until I've had a chance to try it.  I didn't even know this had been closed.  I don't know why you added me to the reviewers when I haven't even commented on this ticket in 5 months (note: I'm not opposed to it but I haven't even looked at it since it started having activity again).",
    "created_at": "2019-02-26T11:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358927",
    "user": "@embray"
}
```

Please also don't set this back to positive review until I've had a chance to try it.  I didn't even know this had been closed.  I don't know why you added me to the reviewers when I haven't even commented on this ticket in 5 months (note: I'm not opposed to it but I haven't even looked at it since it started having activity again).



---

archive/issue_comments_358928.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-02-26T11:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358928",
    "user": "@embray"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_358929.json:
```json
{
    "body": "(For some reason the workflow was in an odd state where I couldn't set it directly back to needs review)",
    "created_at": "2019-02-26T11:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358929",
    "user": "@embray"
}
```

(For some reason the workflow was in an odd state where I couldn't set it directly back to needs review)



---

archive/issue_comments_358930.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-02-26T11:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358930",
    "user": "@embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_358931.json:
```json
{
    "body": "There are two critical fixes needed for Python 3.7 to even *build* on Cygwin:\n\n* [One of them](https://github.com/python/cpython/pull/10734) has been backported to the 3.7 branch, and I confirmed is in 3.7.2.\n\n* [The other](https://github.com/python/cpython/pull/4348) has not been backported to 3.7, which is annoying.  I'm not sure why not; I'll have to look into what I have to do to request a backport.  In the meantime this patch needs to be included, at the very least.",
    "created_at": "2019-02-26T11:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358931",
    "user": "@embray"
}
```

There are two critical fixes needed for Python 3.7 to even *build* on Cygwin:

* [One of them](https://github.com/python/cpython/pull/10734) has been backported to the 3.7 branch, and I confirmed is in 3.7.2.

* [The other](https://github.com/python/cpython/pull/4348) has not been backported to 3.7, which is annoying.  I'm not sure why not; I'll have to look into what I have to do to request a backport.  In the meantime this patch needs to be included, at the very least.



---

archive/issue_comments_358932.json:
```json
{
    "body": "Replying to [comment:100 embray]:\n> Please also don't set this back to positive review until I've had a chance to try it.  I didn't even know this had been closed.  I don't know why you added me to the reviewers when I haven't even commented on this ticket in 5 months (note: I'm not opposed to it but I haven't even looked at it since it started having activity again).\n\nSorry but i thought you already had validated `3.7.2` for OSX. I was wrong.",
    "created_at": "2019-02-26T12:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358932",
    "user": "@vinklein"
}
```

Replying to [comment:100 embray]:
> Please also don't set this back to positive review until I've had a chance to try it.  I didn't even know this had been closed.  I don't know why you added me to the reviewers when I haven't even commented on this ticket in 5 months (note: I'm not opposed to it but I haven't even looked at it since it started having activity again).

Sorry but i thought you already had validated `3.7.2` for OSX. I was wrong.



---

archive/issue_comments_358933.json:
```json
{
    "body": "For comparison, here is what happens when I run the tests with Python 3.6.6:\n\n```\nRan 93 tests in 225.364s\n\nFAILED (errors=3, skipped=1)\n10 tests failed again:\n    test_asyncio test_normalization test_pyexpat test_robotparser\n    test_site test_ssl test_sysconfig test_urllib test_urllib2\n    test_urllib2_localnet\n\n## Tests result: FAILURE then FAILURE\n\n382 tests OK.\n\n10 tests failed:\n    test_asyncio test_normalization test_pyexpat test_robotparser\n    test_site test_ssl test_sysconfig test_urllib test_urllib2\n    test_urllib2_localnet\n\n15 tests skipped:\n    test_dbm_gnu test_devpoll test_epoll test_gdb test_msilib\n    test_ossaudiodev test_spwd test_startfile test_tix test_tk\n    test_ttk_guionly test_winconsoleio test_winreg test_winsound\n    test_zipfile64\n\n10 re-run tests:\n    test_asyncio test_normalization test_pyexpat test_robotparser\n    test_site test_ssl test_sysconfig test_urllib test_urllib2\n    test_urllib2_localnet\n\nTotal duration: 49 min 37 sec\nTests result: FAILURE then FAILURE\nmake[2]: *** [test] Error 2\nAn error occurred while testing Python\n```\n",
    "created_at": "2019-02-26T18:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358933",
    "user": "@jhpalmieri"
}
```

For comparison, here is what happens when I run the tests with Python 3.6.6:

```
Ran 93 tests in 225.364s

FAILED (errors=3, skipped=1)
10 tests failed again:
    test_asyncio test_normalization test_pyexpat test_robotparser
    test_site test_ssl test_sysconfig test_urllib test_urllib2
    test_urllib2_localnet

## Tests result: FAILURE then FAILURE

382 tests OK.

10 tests failed:
    test_asyncio test_normalization test_pyexpat test_robotparser
    test_site test_ssl test_sysconfig test_urllib test_urllib2
    test_urllib2_localnet

15 tests skipped:
    test_dbm_gnu test_devpoll test_epoll test_gdb test_msilib
    test_ossaudiodev test_spwd test_startfile test_tix test_tk
    test_ttk_guionly test_winconsoleio test_winreg test_winsound
    test_zipfile64

10 re-run tests:
    test_asyncio test_normalization test_pyexpat test_robotparser
    test_site test_ssl test_sysconfig test_urllib test_urllib2
    test_urllib2_localnet

Total duration: 49 min 37 sec
Tests result: FAILURE then FAILURE
make[2]: *** [test] Error 2
An error occurred while testing Python
```




---

archive/issue_comments_358934.json:
```json
{
    "body": "The second Cygwin fix seems to have been merged, no ?\n\nhttps://github.com/python/cpython/pull/12063",
    "created_at": "2019-03-05T10:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358934",
    "user": "@fchapoton"
}
```

The second Cygwin fix seems to have been merged, no ?

https://github.com/python/cpython/pull/12063



---

archive/issue_comments_358935.json:
```json
{
    "body": "Replying to [comment:105 chapoton]:\n> The second Cygwin fix seems to have been merged, no ?\n> \n> https://github.com/python/cpython/pull/12063\n\nYes, 6 days ago, after I made noise about it.",
    "created_at": "2019-03-05T15:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358935",
    "user": "@embray"
}
```

Replying to [comment:105 chapoton]:
> The second Cygwin fix seems to have been merged, no ?
> 
> https://github.com/python/cpython/pull/12063

Yes, 6 days ago, after I made noise about it.



---

archive/issue_comments_358936.json:
```json
{
    "body": "Should we wait for a release of python 3.7 ?",
    "created_at": "2019-03-05T15:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358936",
    "user": "@fchapoton"
}
```

Should we wait for a release of python 3.7 ?



---

archive/issue_comments_358937.json:
```json
{
    "body": "Not necessarily, we can still include the patch now.",
    "created_at": "2019-03-05T15:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358937",
    "user": "@embray"
}
```

Not necessarily, we can still include the patch now.



---

archive/issue_comments_358938.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-11T10:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358938",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358939.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-11T10:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358939",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358940.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-11T10:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358940",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358941.json:
```json
{
    "body": "I'm getting a lot of failures due to\n\n```\nsage: gap_reset_workspace()\n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-1-01843f720c90> in <module>()\n----> 1 gap_reset_workspace()\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in gap_reset_workspace(max_workspace_size, verbose)\n   1577     # Create new workspace with filename WORKSPACE\n   1578     g = Gap(use_workspace_cache=False, max_workspace_size=None)\n-> 1579     g.eval('SetUserPreference(\"HistoryMaxLines\", 30)')\n   1580     from sage.tests.gap_packages import all_installed_packages\n   1581     for pkg in all_installed_packages():\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in eval(self, x, newlines, strip, split_lines, **kwds)\n    581             if not input_line.endswith(';'):\n    582                 input_line += ';'\n--> 583         result = Expect.eval(self, input_line, **kwds)\n    584         if not newlines:\n    585             result = result.replace(\"\\\\\\n\",\"\")\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)                                                                                                                                                                    \n   1349                 elif split_lines:\n   1350                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1351                                         for L in code.split('\\n') if L != ''])\n   1352                 else:\n   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in <listcomp>(.0)\n   1349                 elif split_lines:\n   1350                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1351                                         for L in code.split('\\n') if L != ''])\n   1352                 else:\n   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)\n    741         try:\n    742             if self._expect is None:\n--> 743                 self._start()\n    744             E = self._expect\n    745             #import pdb; pdb.set_trace()\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _start(self)\n   1272 \n   1273         # set random seed\n-> 1274         self.set_seed(self._seed)\n   1275 \n   1276     def _function_class(self):\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in set_seed(self, seed)\n   1177         if seed is None:\n   1178             seed = self.rand_seed()\n-> 1179         self.eval(\"Reset(GlobalMersenneTwister,%d)\" % seed)\n   1180         self.eval(\"Reset(GlobalRandomSource,%d)\" % seed)\n   1181         self._seed = seed\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in eval(self, x, newlines, strip, split_lines, **kwds)\n    581             if not input_line.endswith(';'):\n    582                 input_line += ';'\n--> 583         result = Expect.eval(self, input_line, **kwds)\n    584         if not newlines:\n    585             result = result.replace(\"\\\\\\n\",\"\")\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1349                 elif split_lines:\n   1350                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1351                                         for L in code.split('\\n') if L != ''])\n   1352                 else:\n   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in <listcomp>(.0)\n   1349                 elif split_lines:\n   1350                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1351                                         for L in code.split('\\n') if L != ''])\n   1352                 else:\n   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)\n    753             # garbage should be filtered out by this point); here we decode\n    754             # them (on Python 3), currently just using the default encoding\n--> 755             normal, error = bytes_to_str(normal), bytes_to_str(error)\n    756 \n    757             if len(error):\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1515)()\n     29 \n     30 \n---> 31 cpdef inline str bytes_to_str(b, encoding=None, errors=None):\n     32     r\"\"\"\n     33     Convert ``bytes`` to ``str``.\n\n/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1399)()\n     58         return <str>b\n     59     else:\n---> 60         return _cstr_to_str(<bytes>b, encoding, errors)\n     61 \n     62 \n\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0x80 in position 15: invalid start byte\n```\n",
    "created_at": "2019-03-11T14:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358941",
    "user": "@jdemeyer"
}
```

I'm getting a lot of failures due to

```
sage: gap_reset_workspace()
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-1-01843f720c90> in <module>()
----> 1 gap_reset_workspace()

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in gap_reset_workspace(max_workspace_size, verbose)
   1577     # Create new workspace with filename WORKSPACE
   1578     g = Gap(use_workspace_cache=False, max_workspace_size=None)
-> 1579     g.eval('SetUserPreference("HistoryMaxLines", 30)')
   1580     from sage.tests.gap_packages import all_installed_packages
   1581     for pkg in all_installed_packages():

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in eval(self, x, newlines, strip, split_lines, **kwds)
    581             if not input_line.endswith(';'):
    582                 input_line += ';'
--> 583         result = Expect.eval(self, input_line, **kwds)
    584         if not newlines:
    585             result = result.replace("\\\n","")

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)                                                                                                                                                                    
   1349                 elif split_lines:
   1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1351                                         for L in code.split('\n') if L != ''])
   1352                 else:
   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1349                 elif split_lines:
   1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1351                                         for L in code.split('\n') if L != ''])
   1352                 else:
   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    741         try:
    742             if self._expect is None:
--> 743                 self._start()
    744             E = self._expect
    745             #import pdb; pdb.set_trace()

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _start(self)
   1272 
   1273         # set random seed
-> 1274         self.set_seed(self._seed)
   1275 
   1276     def _function_class(self):

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in set_seed(self, seed)
   1177         if seed is None:
   1178             seed = self.rand_seed()
-> 1179         self.eval("Reset(GlobalMersenneTwister,%d)" % seed)
   1180         self.eval("Reset(GlobalRandomSource,%d)" % seed)
   1181         self._seed = seed

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in eval(self, x, newlines, strip, split_lines, **kwds)
    581             if not input_line.endswith(';'):
    582                 input_line += ';'
--> 583         result = Expect.eval(self, input_line, **kwds)
    584         if not newlines:
    585             result = result.replace("\\\n","")

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1349                 elif split_lines:
   1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1351                                         for L in code.split('\n') if L != ''])
   1352                 else:
   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1349                 elif split_lines:
   1350                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1351                                         for L in code.split('\n') if L != ''])
   1352                 else:
   1353                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/interfaces/gap.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    753             # garbage should be filtered out by this point); here we decode
    754             # them (on Python 3), currently just using the default encoding
--> 755             normal, error = bytes_to_str(normal), bytes_to_str(error)
    756 
    757             if len(error):

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1515)()
     29 
     30 
---> 31 cpdef inline str bytes_to_str(b, encoding=None, errors=None):
     32     r"""
     33     Convert ``bytes`` to ``str``.

/home/jdemeyer/sage-python3/local/lib/python3.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1399)()
     58         return <str>b
     59     else:
---> 60         return _cstr_to_str(<bytes>b, encoding, errors)
     61 
     62 

UnicodeDecodeError: 'utf-8' codec can't decode byte 0x80 in position 15: invalid start byte
```




---

archive/issue_comments_358942.json:
```json
{
    "body": "But why is GAP producing a byte `0x80` in its output?",
    "created_at": "2019-03-11T14:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358942",
    "user": "@jdemeyer"
}
```

But why is GAP producing a byte `0x80` in its output?



---

archive/issue_comments_358943.json:
```json
{
    "body": "what is the locale used ?",
    "created_at": "2019-03-11T15:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358943",
    "user": "@fchapoton"
}
```

what is the locale used ?



---

archive/issue_comments_358944.json:
```json
{
    "body": "Replying to [comment:115 chapoton]:\n> what is the locale used ?\n\nI have no idea, how do I figure that out?",
    "created_at": "2019-03-11T15:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358944",
    "user": "@jdemeyer"
}
```

Replying to [comment:115 chapoton]:
> what is the locale used ?

I have no idea, how do I figure that out?



---

archive/issue_comments_358945.json:
```json
{
    "body": "In any case, Python 3 was working quite well on this system before. So it's a regression since a few betas ago.",
    "created_at": "2019-03-11T15:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358945",
    "user": "@jdemeyer"
}
```

In any case, Python 3 was working quite well on this system before. So it's a regression since a few betas ago.



---

archive/issue_comments_358946.json:
```json
{
    "body": "Maybe using\n\n```\necho $LANG\necho $LC_ALL\n```\n",
    "created_at": "2019-03-11T16:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358946",
    "user": "@fchapoton"
}
```

Maybe using

```
echo $LANG
echo $LC_ALL
```




---

archive/issue_comments_358947.json:
```json
{
    "body": "Does the current branch include the patches required for Cygwin ?",
    "created_at": "2019-03-13T09:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358947",
    "user": "@fchapoton"
}
```

Does the current branch include the patches required for Cygwin ?



---

archive/issue_comments_358948.json:
```json
{
    "body": "Replying to [comment:119 chapoton]:\n> Does the current branch include the patches required for Cygwin ?\n\nYes, I added the patches that `@`embray mentioned.\n\nI have not looked further into the GAP issue. Maybe somebody else should try it.",
    "created_at": "2019-03-13T09:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358948",
    "user": "@jdemeyer"
}
```

Replying to [comment:119 chapoton]:
> Does the current branch include the patches required for Cygwin ?

Yes, I added the patches that `@`embray mentioned.

I have not looked further into the GAP issue. Maybe somebody else should try it.



---

archive/issue_comments_358949.json:
```json
{
    "body": "I don't see the GAP problem when I do a Python 3 build with this branch on OS X:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.7.beta7, Release Date: 2019-03-10               \u2502\n\u2502 Using Python 3.7.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: gap_reset_workspace()\nsage: \n```\n\nand\n\n```\n$ ./sage -t src/sage/interfaces/gap.py \ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-03-13-13-25-14-a8d0606b.\nGit branch: t/25680/upgrade_to_python_3_7_0\nUsing --optional=dochtml,mpir,python2,sage\nDoctesting 1 file.\nsage -t src/sage/interfaces/gap.py\n    [222 tests, 6.84 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 8.3 seconds\n    cpu time: 1.9 seconds\n    cumulative wall time: 6.8 seconds\n$ ./sage -t src/sage/interfaces/gap_workspace.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-03-13-13-25-35-b861aafd.\nGit branch: t/25680/upgrade_to_python_3_7_0\nUsing --optional=dochtml,mpir,python2,sage\nDoctesting 1 file.\nsage -t src/sage/interfaces/gap_workspace.py\n    [8 tests, 0.01 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.0 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n",
    "created_at": "2019-03-13T20:27:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358949",
    "user": "@jhpalmieri"
}
```

I don't see the GAP problem when I do a Python 3 build with this branch on OS X:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.7.beta7, Release Date: 2019-03-10               │
│ Using Python 3.7.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: gap_reset_workspace()
sage: 
```

and

```
$ ./sage -t src/sage/interfaces/gap.py 
too many failed tests, not using stored timings
Running doctests with ID 2019-03-13-13-25-14-a8d0606b.
Git branch: t/25680/upgrade_to_python_3_7_0
Using --optional=dochtml,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/interfaces/gap.py
    [222 tests, 6.84 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 8.3 seconds
    cpu time: 1.9 seconds
    cumulative wall time: 6.8 seconds
$ ./sage -t src/sage/interfaces/gap_workspace.py
too many failed tests, not using stored timings
Running doctests with ID 2019-03-13-13-25-35-b861aafd.
Git branch: t/25680/upgrade_to_python_3_7_0
Using --optional=dochtml,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/interfaces/gap_workspace.py
    [8 tests, 0.01 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```




---

archive/issue_comments_358950.json:
```json
{
    "body": "I have two questions here:\n\n* do we have the approval of Erik (about Windows) ?\n* does the branch pass all the tests in the current python3 target ?\n\nEDIT: I have no problem with gap either.",
    "created_at": "2019-03-21T08:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358950",
    "user": "@fchapoton"
}
```

I have two questions here:

* do we have the approval of Erik (about Windows) ?
* does the branch pass all the tests in the current python3 target ?

EDIT: I have no problem with gap either.



---

archive/issue_comments_358951.json:
```json
{
    "body": "I reduced the problem to the shell command\n\n```\necho 'Reset(GlobalMersenneTwister,500837550);' | ./sage --gap -r -b -p -T -E local/share/sage/ext/gap/sage.g\n```\n\nThis is outputting binary garbage which Python 3 cannot convert to a string.\n\nI don't think it's caused by this ticket, but it does prevent me from working on Python 3.",
    "created_at": "2019-03-21T10:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358951",
    "user": "@jdemeyer"
}
```

I reduced the problem to the shell command

```
echo 'Reset(GlobalMersenneTwister,500837550);' | ./sage --gap -r -b -p -T -E local/share/sage/ext/gap/sage.g
```

This is outputting binary garbage which Python 3 cannot convert to a string.

I don't think it's caused by this ticket, but it does prevent me from working on Python 3.



---

archive/issue_comments_358952.json:
```json
{
    "body": "Even in an interactive GAP session, I'm getting the same binary garbage:\n\n```\n *********   GAP 4.10.0 of 01-Nov-2018\n *  GAP  *   https://www.gap-system.org\n *********   Architecture: x86_64-pc-linux-gnu-default64\n Configuration:  gmp 6.0.0, readline\n Loading the library and packages ...\n Packages:   Alnuth 3.1.0, AtlasRep 1.5.1, AutPGrp 1.10, CRISP 1.4.4, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, GAPDoc 1.6.2, IRREDSOL 1.4, LAGUNA 3.9.0, \n             Polycyclic 2.14, PrimGrp 3.3.2, SmallGrp 1.3, Sophus 1.24, TomLib 1.2.7, TransGrp 2.0.4\n Try '??help' for help. See also '?copyright', '?cite' and '?authors'\ngap> Reset(GlobalMersenneTwister,0);\n\ufffd>[>\ufffd1P[\ufffd\\\"\ufffd2\ufffd\u02a6\\005\ufffdt>\ufffd\ufffd\ufffdT\ufffd\ufffd\\020@\ufffd8\ufffd\ufffdl\ufffd\ufffd\ufffd\\023\ufffd%\ufffd\ufffd\\023hK\ufffdq\\033\ufffd'\ufffd\\026fB\\025\ufffd\ufffdP\ufffd\ufffd\\n~otM\ufffd\ufffd^\ufffd\ufffd\ufffd\ufffd\ufffd\u00c9)\\<[\\000\\b\\<G\\rs\ufffd\ufffd\ufffd\\n\ufffd\ufffd\ufffdQ[LN\ufffd\\030\\<\ufffd\\013\ufffdL~8\\\nx*\\t\ufffdx\ufffdp\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdl\\b\ufffd\\022P`\ufffd\ufffd\ufffd^\ufffd\ufffd\\021p\ufffd=j\ufffd\ufffdI8j\ufffd\ufffdrV\\023\ufffd~N\ufffd^l\ufffd9\ufffd'\ufffd\u1fb9\ufffd@^LI[\\\nI\\027\ufffd\ufffdj\\023\ufffd\ufffd\ufffd#\\03122q\\034\ufffd\ufffd\ufffdUv\ufffd\ufffdn\ufffdp\ufffd\ufffd\\\\014\ufffdH\\b\u05ef2\ufffd9W\ufffd.\ufffdNi\\034\ufffd\ufffd\ufffd4J\ufffdTb_\ufffd\\\ufffd2\\013\ufffdI\\000JM\ufffdn6ODt`_\\007!\\023:\ufffd*\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd_*\ufffdqj4\ufffdk\u02aa\ufffd-F<pr\ufffd\ufffdH\ufffd\ufffdxR\\005\ufffduS\ufffd\\026\\n\\\n\ufffd\\027\ufffd\ufffd\ufffd'\\005FT\ufffd\ufffda&]\\024\ufffd\\026\ufffd\ufffd\ufffdd\ufffd\ufffd\ufffd#\\rK\ufffd\ufffd)k\ufffd\\\\\ufffd\ufffdL\ufffd\ufffdI\ufffd\ufffd\\033o\ufffdF\ufffd\ufffdBY D\\>\ufffd\\006tF\ufffd\ufffd\ufffd^\\032-\\n\ufffd\ufffdz\ufffd\ufffd\ufffdf\\020>\ufffd\ufffdp\ufffd\\004K<\ufffd\n                                                                                                               \ufffdlCJ\ufffdo\\0278|\\027P3\ufffdQ%D\ufffdQ\ufffd\ufffdV\\bU\n\ufffdhR-\ufffd\ufffd\ufffd]\ufffd~N\ufffd\ufffd\ufffd\\c\ufffda\ufffd\\025[O\\036\ufffd\\037MJt\ufffd\ufffd5\ufffdi\ufffd\\014\\bu=)=f\ufffd\ufffd\\034\\c\ufffd\ufffd\\>\ufffd\ufffd\ufffd\ufffd*\ufffd\ufffd\\006\ufffd\ufffd{o\\\n\\016jws\ufffd1\ufffd&we5\ufffd[\ufffdBF\u01f4zl\ufffd'\ufffd_Q\ufffd\\021[x\ufffdR[\ufffd\\021\\t\ufffd\ufffd\ufffd\ufffd7F\u02f50[N\\t\ufffd\ufffd\ufffdU\ufffd/\ufffd\ufffdUP\\005\\t\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\\024\ufffd\ufffd\ufffdI\u05e0L(\ufffd\ufffd7\ufffd\ufffd9\ufffd\ufffdl`\ufffd\ufffdL\ufffd\\027\ufffdP\u00e8\ufffd8\ufffdTdO,r\ufffd\ufffd`RY\\\\W\\026s\ufffdh]\\c\ufffdj|\ufffdd\ufffd\ufffd\ufffd\\016\ufffd8\ufffd@\\\n\ufffd\\027\ufffd\\006\ufffd2.\ufffd\\005\ufffd\\n6\ufffd\ufffd\ufffd7`\\005[-)\\037\ufffdN4\ufffd=\ufffdW\ufffd\ufffdN\ufffd+\ufffd\\025\ufffd2a\ufffd\ufffd\\037T\u0374\ufffd\\0164:*k\ufffd\ufffdz\ufffd\\c,v\u0539\ufffd\ufffd&,\\025\\<&>Pk\n\ufffd4\ufffd\ufffd\\005\ufffd\ufffd\ufffd\ufffdI_\ufffd\ufffdQ\ufffdZ\ufffd\ufffd\ufffd\ufffdf(2\ufffd\\Iw\ufffd\ufffd\\023H\ufffdp\ufffd\\033\\c\\\\\\016\ufffd\ufffd\ufffd\ufffd\ufffdPTd\ufffdC\\020\ufffd\ufffd\uff80\ufffd8b\\025.\ufffd\ufffd\ufffd\ufffd\\034qc\ufffd\ufffd\\037?\ufffd\ufffd\ufffd)\ufffd6'Kd\ufffd\\033$\ufffd\ufffdMz\ufffd\ufffd\ufffd!t;Njn\ufffdwh\u02145\ufffd#D_\ufffd\ufffd \ufffd!<\u063e\u03db\\031O\ufffd\ufffd\ufffd\\\n\ufffd\ufffd2\ufffd,h8=\\blJ$\ufffd\ufffd\ufffd\ufffd\u036b\ufffd\ufffd)\ufffd\ufffd\ufffd\\031-<4\ufffd\ufffdz\ufffd\ufffd\ufffddj\\<\ufffd\\t<;\ufffdg\ufffd&u\ufffd<GS\\027\ufffd2E\ufffd|[\ufffd0{\\t\ufffdK\ufffd\\022}\n                                                                             \\030\ufffd\ufffd\\026cW\ufffde\ufffd\\020\ufffd\ufffd\ufffdB\ufffd\ufffdC\ufffd?]k&\ufffd\ufffd`\ufffd\\026\ufffd!\\017\\>\\ru5\ufffdj) \ufffd\u072e\ufffdY\\005\ufffd\ufffd\ufffd \\004\\\n\ufffd\ufffd\ufffdC\ufffd7        \ufffd\\>n\ufffdo\u04a4\\\\\\000\ufffd\\>,\ufffd\\026dJ\ufffdn)S#!l\ufffd/\ufffd8?\ufffd7Q\\004Jt\ufffd\u026d7\ufffd\\>*B`jmT\ufffdg\ufffd\ufffd\\036S|]\\006\\033\ufffd\\>|\\007\\004\ufffd\\037\\033                  \ufffdEV\ufffd&\ufffd\ufffd\\bS\ufffdP\ufffdR\\\n/\u07fe\ufffd\ufffd\u0262\ufffd\ufffda\\031{i\ufffd\\r\\020N\\030\ufffd\ufffd\\032)\ufffd&\ufffd\ufffd\\\"{\ufffd\u05be\ufffd.\ufffd\ufffd\ufffd~,\ufffd\ufffd\\034\ufffd\ufffd\ufffd\ufffdI6\\030\\034f\ufffd\\032\ufffd\ufffd\ufffd\ufffd(4\ufffd^`m&w\ufffd\ufffd\\000\ufffdD\\016,\\b\ufffd[7/ \ufffd\\025`\\030s@ZW;\ufffd\\024\ufffd\ufffd\ufffd\u00e6M\u04af4\ufffdHc\ufffd\\033\ufffd\\\"\ufffd\ufffd\\006\\<O-\ufffdFP\ud75b-\ufffdA\ufffd\ufffdKW2>p\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdq\\b\ufffd\\022\ufffdJ*\\031P\ufffd\ufffd^\ufffd\ufffd\ufffdyJ\ufffd\ufffd\ufffd\ufffd\ufffd\\016H\ufffdC9\ufffd,|\ufffdj\ufffd?\ufffd[U\ufffd\ufffd\\c\\                            \ufffd*\ufffdj\ufffd\ufffd\ufffdW[\\023|`\ufffd\ufffd.\ufffd\ufffd\ufffdh\ufffd9e{sy\ufffd\\rw\ufffd\ufffd\\b4\ufffd[z\\023\ufffd\ufffd\ufffdm\\022\ufffd\\027\u022f[\u0429O\u017e\\\n\\036\ufffd\u07be> J\\b\ufffdG\ufffd4;\ufffd\\r\ufffd\ufffdW\\022i\ufffd\ufffd\ufffdzs\ufffd\ufffd\ufffdzW=\\004\ufffd\ufffd\ufffdyT\ufffd\\007\ufffd\ufffd\ufffd\ufffd\ufffdLr30\ufffd\ufffd\\005\ufffdv\ufffd%D\ufffd\\025\ufffd\\032\\037\\c\\b\n                      1\ufffdFt\ufffd1\ufffd-\ufffd\\033[Z\\035\ufffd\ufffdt\ufffd\ufffd\ufffd\\030YY\ufffd-V\ufffdo\ufffdg\ufffd\ufffd\ufffdq\\007Lb\ufffd'J.R\ufffd4jC\ufffdC\ufffd\ufffd\ufffdU%\\>v\u01b8%C]\ufffd<\ufffd\ufffd[iK#8.\ufffdj>O1T\ufffd\ufffd\\cl\ufffd\ufffd[\ufffd\ufffd\ufffd\ufffd\ufffdB?_\\0277\ufffd\\004\\0275\ufffd\\000d\ufffd\ufffd\ufffdX\\\n\\014\\013\ufffd\\032ijv\ufffd.u\ufffd\ufffd\\016+\ufffd\ufffd\\017\ufffd:_\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdes\u037a\\023\ufffdH\\<z\ufffd\\n\\023E\ufffd\ufffd\ufffd\\r\ufffd\ufffd\ufffd\ufffd\\024k\ufffd\\n\ufffdW\ufffdT(\ufffd\ufffd\ufffd\ufffdk8\\032rJ|=8\\\"\ufffd|\ufffd\\004gU\ufffd\u05ed\ufffd\ufffd\ufffd\ufffdL=;\ufffdow\ufffd\u04be`:,\\>\ufffdmdQ-\u052a\ufffdBqy}\ufffd-\ufffd\ufffdbA{p\\<\\\n\\000\\0001234\" ]\n```\n",
    "created_at": "2019-03-21T10:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358952",
    "user": "@jdemeyer"
}
```

Even in an interactive GAP session, I'm getting the same binary garbage:

```
 *********   GAP 4.10.0 of 01-Nov-2018
 *  GAP  *   https://www.gap-system.org
 *********   Architecture: x86_64-pc-linux-gnu-default64
 Configuration:  gmp 6.0.0, readline
 Loading the library and packages ...
 Packages:   Alnuth 3.1.0, AtlasRep 1.5.1, AutPGrp 1.10, CRISP 1.4.4, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, GAPDoc 1.6.2, IRREDSOL 1.4, LAGUNA 3.9.0, 
             Polycyclic 2.14, PrimGrp 3.3.2, SmallGrp 1.3, Sophus 1.24, TomLib 1.2.7, TransGrp 2.0.4
 Try '??help' for help. See also '?copyright', '?cite' and '?authors'
gap> Reset(GlobalMersenneTwister,0);
�>[>�1P[�\"�2�ʦ\005�t>���T��\020@�8��l���\023�%��\023hK�q\033�'�\026fB\025��P��\n~otM��^�����É)\<[\000\b\<G\rs���\n���Q[LN�\030\<�\013�L~8\
x*\t�x�p������l\b�\022P`���^��\021p�=j��I8j��rV\023�~N�^l�9�'�Ᾱ�@^LI[\
I\027��j\023���#\03122q\034���Uv��n�p��\\014�H\bׯ2�9W�.�Ni\034���4J�Tb_�\�2\013�I\000JM�n6ODt`_\007!\023:�*�������_*�qj4�kʪ�-F<pr��H��xR\005�uS�\026\n\
�\027���'\005FT��a&]\024�\026���d���#\rK��)k�\\��L��I��\033o�F��BY D\>�\006tF���^\032-\n��z���f\020>��p�\004K<�
                                                                                                               �lCJ�o\0278|\027P3�Q%D�Q��V\bU
�hR-���]�~N���\c�a�\025[O\036�\037MJt��5�i�\014\bu=)=f��\034\c��\>����*��\006��{o\
\016jws�1�&we5�[�BFǴzl�'�_Q�\021[x�R[�\021\t����7F˵0[N\t���U�/��UP\005\t������\024���IנL(��7��9��l`��L�\027�Pè�8�TdO,r��`RY\\W\026s�h]\c�j|�d���\016�8�@\
�\027�\006�2.�\005�\n6���7`\005[-)\037�N4�=�W��N�+�\025�2a��\037Tʹ�\0164:*k��z�\c,vԹ��&,\025\<&>Pk
�4��\005����I_��Q�Z����f(2�\Iw��\023H�p�\033\c\\\016�����PTd�C\020��ﾀ�8b\025.����\034qc��\037?���)�6'Kd�\033$��Mz���!t;Njn�whȔ5�#D_�� �!<ؾϛ\031O���\
��2�,h8=\blJ$����ͫ��)���\031-<4��z���dj\<�\t<;�g�&u�<GS\027�2E�|[�0{\t�K�\022}
                                                                             \030��\026cW�e�\020���B��C�?]k&��`�\026�!\017\>\ru5�j) �ܮ�Y\005��� \004\
���C�7        �\>n�oҤ\\\000�\>,�\026dJ�n)S#!l�/�8?�7Q\004Jt�ɭ7�\>*B`jmT�g��\036S|]\006\033�\>|\007\004�\037\033                  �EV�&��\bS�P�R\
/߾��ɢ��a\031{i�\r\020N\030��\032)�&��\"{�־�.���~,��\034����I6\030\034f�\032����(4�^`m&w��\000�D\016,\b�[7/ �\025`\030s@ZW;�\024���æMү4�Hc�\033�\"��\006\<O-�FP흛-�A��KW2>p��������q\b�\022�J*\031P��^���yJ�����\016H�C9�,|�j�?�[U��\c\                            �*�j���W[\023|`��.���h�9e{sy�\rw��\b4�[z\023���m\022�\027ȯ[ЩOž\
\036�޾> J\b�G�4;�\r��W\022i���zs���zW=\004���yT�\007�����Lr30��\005�v�%D�\025�\032\037\c\b
                      1�Ft�1�-�\033[Z\035��t���\030YY�-V�o�g���q\007Lb�'J.R�4jC�C���U%\>vƸ%C]�<��[iK#8.�j>O1T��\cl��[�����B?_\0277�\004\0275�\000d���X\
\014\013�\032ijv�.u��\016+��\017�:_������esͺ\023�H\<z�\n\023E���\r����\024k�\n�W�T(����k8\032rJ|=8\"�|�\004gU�׭����L=;�ow�Ҿ`:,\>�mdQ-Ԫ�Bqy}�-��bA{p\<\
\000\0001234" ]
```




---

archive/issue_comments_358953.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-21T11:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358953",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358954.json:
```json
{
    "body": "Replying to [comment:122 chapoton]:\n> I have two questions here:\n> \n> * do we have the approval of Erik (about Windows) ?\n> * does the branch pass all the tests in the current python3 target ?\n> \n> EDIT: I have no problem with gap either.\n\nFor myself, I've been waiting until some of the other issues with this branch are worked out--i.e. that it's otherwise good-to-go on Linux.\n\nBut if you think that's nearly the case I should start now, since building on Windows takes some time.",
    "created_at": "2019-03-21T12:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358954",
    "user": "@embray"
}
```

Replying to [comment:122 chapoton]:
> I have two questions here:
> 
> * do we have the approval of Erik (about Windows) ?
> * does the branch pass all the tests in the current python3 target ?
> 
> EDIT: I have no problem with gap either.

For myself, I've been waiting until some of the other issues with this branch are worked out--i.e. that it's otherwise good-to-go on Linux.

But if you think that's nearly the case I should start now, since building on Windows takes some time.



---

archive/issue_comments_358955.json:
```json
{
    "body": "I have got 3 doctests failure on the python3 test-suite:\n\n```\nsage -t --long src/sage/interacts/debugger.py  # 1 doctest failed\nsage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed\nsage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished\n```\n\n\n**EDIT**: in particular, the \"abort pool operation\" is not fixed as claimed.",
    "created_at": "2019-03-21T13:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358955",
    "user": "@fchapoton"
}
```

I have got 3 doctests failure on the python3 test-suite:

```
sage -t --long src/sage/interacts/debugger.py  # 1 doctest failed
sage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed
sage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished
```


**EDIT**: in particular, the "abort pool operation" is not fixed as claimed.



---

archive/issue_comments_358956.json:
```json
{
    "body": "Replying to [comment:128 chapoton]:\n> I have got 3 doctests failure on the python3 test-suite:\n> {{{\n> sage -t --long src/sage/interacts/debugger.py  # 1 doctest failed\n> sage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed\n> sage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished\n> }}}\n\nThe first one I don't know about.\n\nThe second one I think Jeroen just fixed: https://git.sagemath.org/sage.git/commit/?id=10442de1f848010ec373ea5afa9332885ffaf59c\n\nThe third one is a little concerning: That module tends to have some random failures in it and I have made a few fixes to it in the past.  Nevertheless apparently it still has bugs. Though I'm surprised it's timing out (albeit after testing finished, meaning it's probably hanging during interpreter shutdown...",
    "created_at": "2019-03-21T13:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358956",
    "user": "@embray"
}
```

Replying to [comment:128 chapoton]:
> I have got 3 doctests failure on the python3 test-suite:
> {{{
> sage -t --long src/sage/interacts/debugger.py  # 1 doctest failed
> sage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed
> sage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished
> }}}

The first one I don't know about.

The second one I think Jeroen just fixed: https://git.sagemath.org/sage.git/commit/?id=10442de1f848010ec373ea5afa9332885ffaf59c

The third one is a little concerning: That module tends to have some random failures in it and I have made a few fixes to it in the past.  Nevertheless apparently it still has bugs. Though I'm surprised it's timing out (albeit after testing finished, meaning it's probably hanging during interpreter shutdown...



---

archive/issue_comments_358957.json:
```json
{
    "body": "on the very latest branch, I still get\n\n```\nsage -t --long src/sage_setup/docbuild/__init__.py\n**********************************************************************\nFile \"src/sage_setup/docbuild/__init__.py\", line 105, in sage_setup.docbuild.builder_helper\nFailed example:\n    try:\n        build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n    except Exception as E:\n        \"Non-exception during docbuild: abort pool operation\" in E\nException raised:\n    multiprocessing.pool.RemoteTraceback: \n    \"\"\"\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 134, in f\n        runsphinx()\n      File \"<doctest sage_setup.docbuild.builder_helper[3]>\", line 2, in raiseBaseException\n        raise BaseException(\"abort pool operation\")\n    BaseException: abort pool operation\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\n        result = (True, func(*args, **kwds))\n      File \"/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py\", line 44, in mapstar\n        return list(map(*args))\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 80, in build_ref_doc\n        getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 761, in _wrapper\n        getattr(DocBuilder, build_type)(self, *args, **kwds)\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 143, in f\n        raise Exception(\"Non-exception during docbuild: %s\"%(e,), e)\n    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))\n    \"\"\"\n\n    The above exception was the direct cause of the following exception:\n\n    Traceback (most recent call last):\n      File \"<doctest sage_setup.docbuild.builder_helper[7]>\", line 2, in <module>\n        build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 289, in build_many\n        ret = x.get(99999)\n      File \"/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py\", line 657, in get\n        raise self._value\n    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))\n\n    During handling of the above exception, another exception occurred:\n\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.docbuild.builder_helper[7]>\", line 4, in <module>\n        \"Non-exception during docbuild: abort pool operation\" in E\n    TypeError: argument of type 'Exception' is not iterable\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage_setup.docbuild.builder_helper\n    [35 tests, 1 failure, 0.49 s]\n----------------------------------------------------------------------\nsage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nand\n\n```\nsage -t --long src/sage/interacts/debugger.py\n**********************************************************************\nFile \"src/sage/interacts/debugger.py\", line 102, in sage.interacts.debugger.Debug.curframe\nFailed example:\n    d.curframe()\nExpected:\n    <frame object at 0x...>\nGot:\n    <repr(<sage.interfaces.sage0.SageElement at 0x7f0c32222fc0>) failed: TypeError: replace() argument 2 must be str, not SageFunction>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.interacts.debugger.Debug.curframe\n    [23 tests, 1 failure, 1.36 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/interacts/debugger.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\n\nEDIT: The failing doctest in debugger works fine when run interactively.",
    "created_at": "2019-03-21T13:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358957",
    "user": "@fchapoton"
}
```

on the very latest branch, I still get

```
sage -t --long src/sage_setup/docbuild/__init__.py
**********************************************************************
File "src/sage_setup/docbuild/__init__.py", line 105, in sage_setup.docbuild.builder_helper
Failed example:
    try:
        build_many(build_ref_doc, [("docname", "en", "html", {})])
    except Exception as E:
        "Non-exception during docbuild: abort pool operation" in E
Exception raised:
    multiprocessing.pool.RemoteTraceback: 
    """
    Traceback (most recent call last):
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 134, in f
        runsphinx()
      File "<doctest sage_setup.docbuild.builder_helper[3]>", line 2, in raiseBaseException
        raise BaseException("abort pool operation")
    BaseException: abort pool operation

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py", line 121, in worker
        result = (True, func(*args, **kwds))
      File "/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py", line 44, in mapstar
        return list(map(*args))
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 80, in build_ref_doc
        getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 761, in _wrapper
        getattr(DocBuilder, build_type)(self, *args, **kwds)
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 143, in f
        raise Exception("Non-exception during docbuild: %s"%(e,), e)
    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))
    """

    The above exception was the direct cause of the following exception:

    Traceback (most recent call last):
      File "<doctest sage_setup.docbuild.builder_helper[7]>", line 2, in <module>
        build_many(build_ref_doc, [("docname", "en", "html", {})])
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 289, in build_many
        ret = x.get(99999)
      File "/home/chapoton/sage3/local/lib/python3.7/multiprocessing/pool.py", line 657, in get
        raise self._value
    Exception: ('Non-exception during docbuild: abort pool operation', BaseException('abort pool operation'))

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage3/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.docbuild.builder_helper[7]>", line 4, in <module>
        "Non-exception during docbuild: abort pool operation" in E
    TypeError: argument of type 'Exception' is not iterable
**********************************************************************
1 item had failures:
   1 of   9 in sage_setup.docbuild.builder_helper
    [35 tests, 1 failure, 0.49 s]
----------------------------------------------------------------------
sage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed
----------------------------------------------------------------------
```

and

```
sage -t --long src/sage/interacts/debugger.py
**********************************************************************
File "src/sage/interacts/debugger.py", line 102, in sage.interacts.debugger.Debug.curframe
Failed example:
    d.curframe()
Expected:
    <frame object at 0x...>
Got:
    <repr(<sage.interfaces.sage0.SageElement at 0x7f0c32222fc0>) failed: TypeError: replace() argument 2 must be str, not SageFunction>
**********************************************************************
1 item had failures:
   1 of   4 in sage.interacts.debugger.Debug.curframe
    [23 tests, 1 failure, 1.36 s]
----------------------------------------------------------------------
sage -t --long src/sage/interacts/debugger.py  # 1 doctest failed
----------------------------------------------------------------------
```


EDIT: The failing doctest in debugger works fine when run interactively.



---

archive/issue_comments_358958.json:
```json
{
    "body": "Here is fix for the docbuild doctest, please add to your branch if you agree:\n\n```\n-- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -105,7 +105,7 @@ def builder_helper(type):\n         sage: try:\n         ....:     build_many(build_ref_doc, [(\"docname\", \"en\", \"html\", {})])\n         ....: except Exception as E:\n-        ....:     \"Non-exception during docbuild: abort pool operation\" in E\n+        ....:     \"Non-exception during docbuild: abort pool operation\" in str(E)\n         True\n     \"\"\"\n     def f(self, *args, **kwds):\n```\n",
    "created_at": "2019-03-21T14:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358958",
    "user": "@fchapoton"
}
```

Here is fix for the docbuild doctest, please add to your branch if you agree:

```
-- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -105,7 +105,7 @@ def builder_helper(type):
         sage: try:
         ....:     build_many(build_ref_doc, [("docname", "en", "html", {})])
         ....: except Exception as E:
-        ....:     "Non-exception during docbuild: abort pool operation" in E
+        ....:     "Non-exception during docbuild: abort pool operation" in str(E)
         True
     """
     def f(self, *args, **kwds):
```




---

archive/issue_comments_358959.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-21T14:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358959",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358960.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-21T14:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358960",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358961.json:
```json
{
    "body": "I'm now down to one failure: the timeout in `map_reduce.py`",
    "created_at": "2019-03-21T14:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358961",
    "user": "@jdemeyer"
}
```

I'm now down to one failure: the timeout in `map_reduce.py`



---

archive/issue_comments_358962.json:
```json
{
    "body": "The debugger failure is still there for me.",
    "created_at": "2019-03-21T14:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358962",
    "user": "@fchapoton"
}
```

The debugger failure is still there for me.



---

archive/issue_comments_358963.json:
```json
{
    "body": "Replying to [comment:135 chapoton]:\n> The debugger failure is still there for me.\n\nCan you post the complete output of `./sage -t --long src/sage/interacts/debugger.py`?\n\nI get\n\n```\ntoo few successful tests, not using stored timings\nRunning doctests with ID 2019-03-21-15-27-35-0a07308a.\nGit branch: HEAD\nUsing --optional=dochtml,memlimit,mpir,python2,sage\nDoctesting 1 file.\nsage -t --long src/sage/interacts/debugger.py\n    [23 tests, 2.38 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 2.4 seconds\n    cpu time: 0.1 seconds\n    cumulative wall time: 2.4 seconds\n```\n",
    "created_at": "2019-03-21T14:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358963",
    "user": "@jdemeyer"
}
```

Replying to [comment:135 chapoton]:
> The debugger failure is still there for me.

Can you post the complete output of `./sage -t --long src/sage/interacts/debugger.py`?

I get

```
too few successful tests, not using stored timings
Running doctests with ID 2019-03-21-15-27-35-0a07308a.
Git branch: HEAD
Using --optional=dochtml,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t --long src/sage/interacts/debugger.py
    [23 tests, 2.38 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2.4 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 2.4 seconds
```




---

archive/issue_comments_358964.json:
```json
{
    "body": "I posted it already, but here it is again:\n\n```\n./sage -t --long src/sage/interacts/debugger.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-03-21-15-31-58-e3b050c6.\nGit branch: python3.7\nUsing --optional=dochtml,fricas,gfortran,memlimit,mpir,normaliz,python2,sage\nDoctesting 1 file.\nsage -t --long src/sage/interacts/debugger.py\n**********************************************************************\nFile \"src/sage/interacts/debugger.py\", line 102, in sage.interacts.debugger.Debug.curframe\nFailed example:\n    d.curframe()\nExpected:\n    <frame ...>\nGot:\n    <repr(<sage.interfaces.sage0.SageElement at 0x7f773c42f870>) failed: TypeError: replace() argument 2 must be str, not SageFunction>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.interacts.debugger.Debug.curframe\n    [23 tests, 1 failure, 1.38 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/interacts/debugger.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 1.4 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 1.4 seconds\n```\n",
    "created_at": "2019-03-21T14:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358964",
    "user": "@fchapoton"
}
```

I posted it already, but here it is again:

```
./sage -t --long src/sage/interacts/debugger.py
too many failed tests, not using stored timings
Running doctests with ID 2019-03-21-15-31-58-e3b050c6.
Git branch: python3.7
Using --optional=dochtml,fricas,gfortran,memlimit,mpir,normaliz,python2,sage
Doctesting 1 file.
sage -t --long src/sage/interacts/debugger.py
**********************************************************************
File "src/sage/interacts/debugger.py", line 102, in sage.interacts.debugger.Debug.curframe
Failed example:
    d.curframe()
Expected:
    <frame ...>
Got:
    <repr(<sage.interfaces.sage0.SageElement at 0x7f773c42f870>) failed: TypeError: replace() argument 2 must be str, not SageFunction>
**********************************************************************
1 item had failures:
   1 of   4 in sage.interacts.debugger.Debug.curframe
    [23 tests, 1 failure, 1.38 s]
----------------------------------------------------------------------
sage -t --long src/sage/interacts/debugger.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 1.4 seconds
```




---

archive/issue_comments_358965.json:
```json
{
    "body": "I have no idea why that's failing for you...",
    "created_at": "2019-03-21T14:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358965",
    "user": "@jdemeyer"
}
```

I have no idea why that's failing for you...



---

archive/issue_comments_358966.json:
```json
{
    "body": "Let me try on another machine (will take time)",
    "created_at": "2019-03-21T14:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358966",
    "user": "@fchapoton"
}
```

Let me try on another machine (will take time)



---

archive/issue_comments_358967.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-21T14:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358967",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358968.json:
```json
{
    "body": "This last commit is probably controversial, but it's the best I can do. I have no idea what's going on in `map_reduce.py`.",
    "created_at": "2019-03-21T14:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358968",
    "user": "@jdemeyer"
}
```

This last commit is probably controversial, but it's the best I can do. I have no idea what's going on in `map_reduce.py`.



---

archive/issue_comments_358969.json:
```json
{
    "body": "As far as I'm concerned, this is now actually ready for review.",
    "created_at": "2019-03-21T15:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358969",
    "user": "@jdemeyer"
}
```

As far as I'm concerned, this is now actually ready for review.



---

archive/issue_comments_358970.json:
```json
{
    "body": "Could we instead tag #py2 the doctest that triggers the time-out ?",
    "created_at": "2019-03-21T15:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358970",
    "user": "@fchapoton"
}
```

Could we instead tag #py2 the doctest that triggers the time-out ?



---

archive/issue_comments_358971.json:
```json
{
    "body": "Replying to [comment:143 chapoton]:\n> Could we instead tag #py2 the doctest that triggers the time-out ?\n\nI'd rather not do that. For me, `# py2` means doctests that are clearly meant to pass only on Python 2; where the fact that it only works on Python 2 is not considered a bug.",
    "created_at": "2019-03-21T15:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358971",
    "user": "@jdemeyer"
}
```

Replying to [comment:143 chapoton]:
> Could we instead tag #py2 the doctest that triggers the time-out ?

I'd rather not do that. For me, `# py2` means doctests that are clearly meant to pass only on Python 2; where the fact that it only works on Python 2 is not considered a bug.



---

archive/issue_comments_358972.json:
```json
{
    "body": "Then we should fix that bug, and not hide it under the carpet.",
    "created_at": "2019-03-21T15:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358972",
    "user": "@fchapoton"
}
```

Then we should fix that bug, and not hide it under the carpet.



---

archive/issue_comments_358973.json:
```json
{
    "body": "`# py2` is hiding it under the carpet. Removing it from `python3-known-passing.txt` is just deferring it to another time.",
    "created_at": "2019-03-21T15:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358973",
    "user": "@jdemeyer"
}
```

`# py2` is hiding it under the carpet. Removing it from `python3-known-passing.txt` is just deferring it to another time.



---

archive/issue_comments_358974.json:
```json
{
    "body": "I get the exact same failure in `src/sage/interacts/debugger.py` in another machine. So maybe this should not be neglected.",
    "created_at": "2019-03-21T16:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358974",
    "user": "@fchapoton"
}
```

I get the exact same failure in `src/sage/interacts/debugger.py` in another machine. So maybe this should not be neglected.



---

archive/issue_comments_358975.json:
```json
{
    "body": "I believe you, but I cannot reproduce the failure in `src/sage/interacts/debugger.py`",
    "created_at": "2019-03-21T16:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358975",
    "user": "@jdemeyer"
}
```

I believe you, but I cannot reproduce the failure in `src/sage/interacts/debugger.py`



---

archive/issue_comments_358976.json:
```json
{
    "body": "The appropriate tests pass for me on OS X. (I don't see a failure in `interacts/debugger.py`, either.)",
    "created_at": "2019-03-21T19:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358976",
    "user": "@jhpalmieri"
}
```

The appropriate tests pass for me on OS X. (I don't see a failure in `interacts/debugger.py`, either.)



---

archive/issue_comments_358977.json:
```json
{
    "body": "So maybe it's time for Erik to launch the Windows build..",
    "created_at": "2019-03-21T19:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358977",
    "user": "@fchapoton"
}
```

So maybe it's time for Erik to launch the Windows build..



---

archive/issue_comments_358978.json:
```json
{
    "body": "Hopefully I'll have time tomorrow but not sure. Kinda crazy day. Monday otherwise.",
    "created_at": "2019-03-21T19:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358978",
    "user": "@embray"
}
```

Hopefully I'll have time tomorrow but not sure. Kinda crazy day. Monday otherwise.



---

archive/issue_comments_358979.json:
```json
{
    "body": "Well, it compiled fine at least (which was to be expected since the necessary patches are applied) but I haven't had a chance to run any tests yet.",
    "created_at": "2019-03-22T12:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358979",
    "user": "@embray"
}
```

Well, it compiled fine at least (which was to be expected since the necessary patches are applied) but I haven't had a chance to run any tests yet.



---

archive/issue_comments_358980.json:
```json
{
    "body": "If you agree to deprecate the whole module `src/sage/interacts/debugger.py` in #27531, then we could easily mark the failing test as `# py2` and not bother with it anymore.",
    "created_at": "2019-03-22T21:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358980",
    "user": "@jdemeyer"
}
```

If you agree to deprecate the whole module `src/sage/interacts/debugger.py` in #27531, then we could easily mark the failing test as `# py2` and not bother with it anymore.



---

archive/issue_comments_358981.json:
```json
{
    "body": "Replying to [comment:143 chapoton]:\n> Could we instead tag #py2 the doctest that triggers the time-out ?\n\nYour suggestion of checking which specific doctest triggers the time-out is a good one. I'll try that now.",
    "created_at": "2019-03-22T21:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358981",
    "user": "@jdemeyer"
}
```

Replying to [comment:143 chapoton]:
> Could we instead tag #py2 the doctest that triggers the time-out ?

Your suggestion of checking which specific doctest triggers the time-out is a good one. I'll try that now.



---

archive/issue_comments_358982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-22T22:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358982",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358983.json:
```json
{
    "body": "New attempt, hopefully more acceptable. Still needs to be tested.",
    "created_at": "2019-03-22T22:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358983",
    "user": "@jdemeyer"
}
```

New attempt, hopefully more acceptable. Still needs to be tested.



---

archive/issue_comments_358984.json:
```json
{
    "body": "This passes `make ptest-python3` for me.",
    "created_at": "2019-03-23T10:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358984",
    "user": "@jdemeyer"
}
```

This passes `make ptest-python3` for me.



---

archive/issue_comments_358985.json:
```json
{
    "body": "Replying to [comment:157 jdemeyer]:\n> This passes `make ptest-python3` for me.\n\nSame here.",
    "created_at": "2019-03-23T11:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358985",
    "user": "@fchapoton"
}
```

Replying to [comment:157 jdemeyer]:
> This passes `make ptest-python3` for me.

Same here.



---

archive/issue_comments_358986.json:
```json
{
    "body": "I used the updated version of `src/ext/doctest/python3-known-passing.txt` from #27519, and I also added \"--long\" to the appropriate line of `Makefile` (why don't we have this option already?). Tests passed.",
    "created_at": "2019-03-23T18:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358986",
    "user": "@jhpalmieri"
}
```

I used the updated version of `src/ext/doctest/python3-known-passing.txt` from #27519, and I also added "--long" to the appropriate line of `Makefile` (why don't we have this option already?). Tests passed.



---

archive/issue_comments_358987.json:
```json
{
    "body": "So, is anybody willing to give positive review here?",
    "created_at": "2019-03-23T19:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358987",
    "user": "@jdemeyer"
}
```

So, is anybody willing to give positive review here?



---

archive/issue_comments_358988.json:
```json
{
    "body": "Should we wait for Erik's green light ?",
    "created_at": "2019-03-23T19:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358988",
    "user": "@fchapoton"
}
```

Should we wait for Erik's green light ?



---

archive/issue_comments_358989.json:
```json
{
    "body": "Came home after a weekend afk to find that although python3 succeeded in building, the build stopped at cysignals with a strange problem. I think there might have been something else odd going on with my build though so I'll start it again and then run the tests.",
    "created_at": "2019-03-25T09:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358989",
    "user": "@embray"
}
```

Came home after a weekend afk to find that although python3 succeeded in building, the build stopped at cysignals with a strange problem. I think there might have been something else odd going on with my build though so I'll start it again and then run the tests.



---

archive/issue_comments_358990.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358990",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_358991.json:
```json
{
    "body": "Seeing lots of\n\n\n```\n[dochtml] [misc     ] loading pickled environment... failed: 'str' object has no attribute '__dict__'\n```\n\n\nwhen building the docs.  Probably not directly related to this ticket, but worth making note of.",
    "created_at": "2019-03-25T20:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358991",
    "user": "@embray"
}
```

Seeing lots of


```
[dochtml] [misc     ] loading pickled environment... failed: 'str' object has no attribute '__dict__'
```


when building the docs.  Probably not directly related to this ticket, but worth making note of.



---

archive/issue_comments_358992.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-26T09:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358992",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_358993.json:
```json
{
    "body": "Python 3.7.3 was just released, so we might as well upgrade to that.",
    "created_at": "2019-03-26T09:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358993",
    "user": "@jdemeyer"
}
```

Python 3.7.3 was just released, so we might as well upgrade to that.



---

archive/issue_comments_358994.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-26T09:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358994",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_358995.json:
```json
{
    "body": "Cool, I'll try it.",
    "created_at": "2019-03-26T09:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358995",
    "user": "@embray"
}
```

Cool, I'll try it.



---

archive/issue_comments_358996.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-26T09:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358996",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358997.json:
```json
{
    "body": "3.7.3 allowed me to remove one more Cygwin patch (the one related to the `.exe` suffix)",
    "created_at": "2019-03-26T09:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358997",
    "user": "@jdemeyer"
}
```

3.7.3 allowed me to remove one more Cygwin patch (the one related to the `.exe` suffix)



---

archive/issue_comments_358998.json:
```json
{
    "body": "Is there any reason its version is \"3.7.3.p0\" and not just \"3.7.3\"? Just because we do still apply *some* patches?  Not that I think it matters much, just curious.",
    "created_at": "2019-03-26T10:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358998",
    "user": "@embray"
}
```

Is there any reason its version is "3.7.3.p0" and not just "3.7.3"? Just because we do still apply *some* patches?  Not that I think it matters much, just curious.



---

archive/issue_comments_358999.json:
```json
{
    "body": "I thought the rule was to use `.pX` when there are patches. But it's certainly not enforced strictly.",
    "created_at": "2019-03-26T10:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-358999",
    "user": "@jdemeyer"
}
```

I thought the rule was to use `.pX` when there are patches. But it's certainly not enforced strictly.



---

archive/issue_comments_359000.json:
```json
{
    "body": "I think that makes sense--after all it is no longer \"purely\" the 3.7.3 release at that point.",
    "created_at": "2019-03-26T10:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359000",
    "user": "@embray"
}
```

I think that makes sense--after all it is no longer "purely" the 3.7.3 release at that point.



---

archive/issue_comments_359001.json:
```json
{
    "body": "I'm getting docbuild failures due to\n\n```\nWARNING: cannot copy static file OSError(40, 'Too many levels of symbolic links')\n```\n",
    "created_at": "2019-03-26T12:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359001",
    "user": "@jdemeyer"
}
```

I'm getting docbuild failures due to

```
WARNING: cannot copy static file OSError(40, 'Too many levels of symbolic links')
```




---

archive/issue_comments_359002.json:
```json
{
    "body": "I don't see this warning. You don't have that stupid mathjax recursive link, do you? Oh, `make ptest-python3` passes for me.",
    "created_at": "2019-03-26T19:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359002",
    "user": "@jhpalmieri"
}
```

I don't see this warning. You don't have that stupid mathjax recursive link, do you? Oh, `make ptest-python3` passes for me.



---

archive/issue_comments_359003.json:
```json
{
    "body": "I don't know what was wrong with the docs. I did `make doc-clean` and then it worked.",
    "created_at": "2019-03-27T06:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359003",
    "user": "@jdemeyer"
}
```

I don't know what was wrong with the docs. I did `make doc-clean` and then it worked.



---

archive/issue_comments_359004.json:
```json
{
    "body": "I am having a bad problem when running the tests where every test outputs something like:\n\n\n```\nException ignored in: <function _TemporaryFileCloser.__del__ at 0x6ffff4d92f0>\nTraceback (most recent call last):\n  File \"/home/embray/src/sagemath/sage-python3/local/lib/python3.7/tempfile.py\", line 448, in __del__\n    self.close()\n  File \"/home/embray/src/sagemath/sage-python3/local/lib/python3.7/tempfile.py\", line 444, in close\n    unlink(self.name)\nFileNotFoundError: [Errno 2] No such file or directory: '/tmp/tmpw4zt6tfq'\n```\n\n\neven if the test succeeds.  I think this may be a bug (big shock) in the `tempfile` module itself.  I believe it might even be one that I already have a patch for (I seem to recall fixing some issues in `tempfile` back when I was trying to get all of the Python test suite to pass on Cygwin) but I will need to look into that before saying anything more.",
    "created_at": "2019-03-27T11:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359004",
    "user": "@embray"
}
```

I am having a bad problem when running the tests where every test outputs something like:


```
Exception ignored in: <function _TemporaryFileCloser.__del__ at 0x6ffff4d92f0>
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.7/tempfile.py", line 448, in __del__
    self.close()
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.7/tempfile.py", line 444, in close
    unlink(self.name)
FileNotFoundError: [Errno 2] No such file or directory: '/tmp/tmpw4zt6tfq'
```


even if the test succeeds.  I think this may be a bug (big shock) in the `tempfile` module itself.  I believe it might even be one that I already have a patch for (I seem to recall fixing some issues in `tempfile` back when I was trying to get all of the Python test suite to pass on Cygwin) but I will need to look into that before saying anything more.



---

archive/issue_comments_359005.json:
```json
{
    "body": "(Obviously the bug itself is relatively harmless: It's just running a `__del__` method that unlinks a file but doesn't ignore errors that occur if the file was already deleted.  It's more a nuisance than anything).",
    "created_at": "2019-03-27T11:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359005",
    "user": "@embray"
}
```

(Obviously the bug itself is relatively harmless: It's just running a `__del__` method that unlinks a file but doesn't ignore errors that occur if the file was already deleted.  It's more a nuisance than anything).



---

archive/issue_comments_359006.json:
```json
{
    "body": "I see; this is a recurrence of the problem I originally described here: #25107#comment:14\n\nIt's resurfaced, because the `tempfile` module has been refactored, now in such a way that merely setting the `_TemporaryFileWrapper.deleted` attribute no longer has *any* effect whatsoever (it should really probably be a property which delegates to the new `_TemporaryFileCloser` object.\n\nI think this may be a broader issue with `NamedTemporaryFile` that is not unique just to Cygwin: If you create a `NamedTemporaryFile(delete=True)` in a parent process, then add it as an attribute on a `Process` subclass, when the worker process exits the file is deleted. But then when the temporary file is closed on the parent side it tries to re-delete the already deleted file.  I think more generally it would be best if ENOENT errors were just ignored in this case.",
    "created_at": "2019-03-27T14:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359006",
    "user": "@embray"
}
```

I see; this is a recurrence of the problem I originally described here: #25107#comment:14

It's resurfaced, because the `tempfile` module has been refactored, now in such a way that merely setting the `_TemporaryFileWrapper.deleted` attribute no longer has *any* effect whatsoever (it should really probably be a property which delegates to the new `_TemporaryFileCloser` object.

I think this may be a broader issue with `NamedTemporaryFile` that is not unique just to Cygwin: If you create a `NamedTemporaryFile(delete=True)` in a parent process, then add it as an attribute on a `Process` subclass, when the worker process exits the file is deleted. But then when the temporary file is closed on the parent side it tries to re-delete the already deleted file.  I think more generally it would be best if ENOENT errors were just ignored in this case.



---

archive/issue_comments_359007.json:
```json
{
    "body": "If you would consider including [this commit](https://git.sagemath.org/sage.git/commit/?id=b124a898c7315412a071a8ccc7028604192f3af8), or something like it, that would resolve the problem I'm having with unhandled exceptions in `_TemporaryFileCloser.__del__ `.\n\nWith this fix, I can see more clearly that there are two test failures remaining on Cygwin:\n\n\n```\nsage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed\nsage -t --long src/sage/manifolds/differentiable/vectorfield.py  # Killed due to segmentation fault\n```\n\n\nThe first one is merely a manifestation of #27514.  Still need to rethink exactly how that test is implemented.\n\nThe second is more disconcerting, being a segfault (but at least repeatable).  I will look into it next.",
    "created_at": "2019-03-27T16:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359007",
    "user": "@embray"
}
```

If you would consider including [this commit](https://git.sagemath.org/sage.git/commit/?id=b124a898c7315412a071a8ccc7028604192f3af8), or something like it, that would resolve the problem I'm having with unhandled exceptions in `_TemporaryFileCloser.__del__ `.

With this fix, I can see more clearly that there are two test failures remaining on Cygwin:


```
sage -t --long src/sage_setup/docbuild/__init__.py  # 1 doctest failed
sage -t --long src/sage/manifolds/differentiable/vectorfield.py  # Killed due to segmentation fault
```


The first one is merely a manifestation of #27514.  Still need to rethink exactly how that test is implemented.

The second is more disconcerting, being a segfault (but at least repeatable).  I will look into it next.



---

archive/issue_comments_359008.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-27T16:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359008",
    "user": "@embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_359009.json:
```json
{
    "body": "I think the segfault might be related to openblas issues that I've already fixed, but may not be incorporated in my current build (since I started building this Python 3 branch some time ago, possibly before all the relevant openblas fixes were incorporated).",
    "created_at": "2019-03-27T17:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359009",
    "user": "@embray"
}
```

I think the segfault might be related to openblas issues that I've already fixed, but may not be incorporated in my current build (since I started building this Python 3 branch some time ago, possibly before all the relevant openblas fixes were incorporated).



---

archive/issue_comments_359010.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-03-30T16:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359010",
    "user": "@fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_359011.json:
```json
{
    "body": "I am setting this to positive **now**, so that we can start again making progress on #27519. We can always fix details in later tickets.",
    "created_at": "2019-03-30T16:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359011",
    "user": "@fchapoton"
}
```

I am setting this to positive **now**, so that we can start again making progress on #27519. We can always fix details in later tickets.



---

archive/issue_comments_359012.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-31T22:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359012",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_359013.json:
```json
{
    "body": "Replying to [comment:183 chapoton]:\n> I am setting this to positive **now**, so that we can start again making progress on #27519. We can always fix details in later tickets.\n\nWhy would you do that?  I explicitly pointed out that something was broken and proposed a fix, but that fix wasn't applied yet.  Doing this \"**now**\" has no direct impact on making progress on #27519.  You're just rushing things for no reason and leaving them broken.",
    "created_at": "2019-04-01T09:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359013",
    "user": "@embray"
}
```

Replying to [comment:183 chapoton]:
> I am setting this to positive **now**, so that we can start again making progress on #27519. We can always fix details in later tickets.

Why would you do that?  I explicitly pointed out that something was broken and proposed a fix, but that fix wasn't applied yet.  Doing this "**now**" has no direct impact on making progress on #27519.  You're just rushing things for no reason and leaving them broken.



---

archive/issue_comments_359014.json:
```json
{
    "body": "Replying to [comment:181 embray]:\n> I think the segfault might be related to openblas issues that I've already fixed, but may not be incorporated in my current build (since I started building this Python 3 branch some time ago, possibly before all the relevant openblas fixes were incorporated).\n\nI meant to follow up here.  The segfault was nothing to do with Python 3 (fortunately) and is fixed by #27565 .  Not exactly sure why I wasn't seeing that bug before--it's possible I was building OpenBLAS out of its recent `develop` branch which already had that fixed.",
    "created_at": "2019-04-01T10:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359014",
    "user": "@embray"
}
```

Replying to [comment:181 embray]:
> I think the segfault might be related to openblas issues that I've already fixed, but may not be incorporated in my current build (since I started building this Python 3 branch some time ago, possibly before all the relevant openblas fixes were incorporated).

I meant to follow up here.  The segfault was nothing to do with Python 3 (fortunately) and is fixed by #27565 .  Not exactly sure why I wasn't seeing that bug before--it's possible I was building OpenBLAS out of its recent `develop` branch which already had that fixed.



---

archive/issue_comments_359015.json:
```json
{
    "body": "Do we have a follow up on that ticket anywhere? In sage-on-gentoo I have a segfault when building the documentation with python 3.7.3 (but not 2.7 or 3.6). Am I alone with that issue?\n\n```\npython3.7: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/cythonized/sage/matrix/matrix1.c:14275: __pyx_pf_4sage_6matrix_7matrix1_6Matrix_60matrix_from_columns: Assertion `PyList_Check(__pyx_v_columns)' failed.\n```\n",
    "created_at": "2019-04-16T23:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359015",
    "user": "@kiwifb"
}
```

Do we have a follow up on that ticket anywhere? In sage-on-gentoo I have a segfault when building the documentation with python 3.7.3 (but not 2.7 or 3.6). Am I alone with that issue?

```
python3.7: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_7/build/cythonized/sage/matrix/matrix1.c:14275: __pyx_pf_4sage_6matrix_7matrix1_6Matrix_60matrix_from_columns: Assertion `PyList_Check(__pyx_v_columns)' failed.
```




---

archive/issue_comments_359016.json:
```json
{
    "body": "Interesting. You're building with assertions enabled.",
    "created_at": "2019-04-17T07:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359016",
    "user": "@jdemeyer"
}
```

Interesting. You're building with assertions enabled.



---

archive/issue_comments_359017.json:
```json
{
    "body": "Can you attach or send me that `matrix1.c` file? In my version of that file, I don't find such an assertion.",
    "created_at": "2019-04-17T07:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359017",
    "user": "@jdemeyer"
}
```

Can you attach or send me that `matrix1.c` file? In my version of that file, I don't find such an assertion.



---

archive/issue_comments_359018.json:
```json
{
    "body": "Attachment [matrix1.c.bz2](tarball://root/attachments/some-uuid/ticket25680/matrix1.c.bz2) by @kiwifb created at 2019-04-17 08:23:49\n\nAttached as requested (compressed).",
    "created_at": "2019-04-17T08:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359018",
    "user": "@kiwifb"
}
```

Attachment [matrix1.c.bz2](tarball://root/attachments/some-uuid/ticket25680/matrix1.c.bz2) by @kiwifb created at 2019-04-17 08:23:49

Attached as requested (compressed).



---

archive/issue_comments_359019.json:
```json
{
    "body": "Thanks, that clears things up. Follow-up ticket at #27688.",
    "created_at": "2019-04-17T08:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25443#issuecomment-359019",
    "user": "@jdemeyer"
}
```

Thanks, that clears things up. Follow-up ticket at #27688.
