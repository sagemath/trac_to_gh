# Issue 32035: Finitely generated graded algebras with finite degree

Issue created by migration from https://trac.sagemath.org/ticket/32272

Original creator: @mjungmath

Original creation time: 2021-07-24 15:28:25

CC:  tscrim mkoeppe tkarn jhpalmieri

We implement finitely generated graded algebras with finite degree. That is, each generator has a degree, and multiplications exceeding a fixed degree yield zero.

This implementation is for example useful in the case of certain cohomology rings (or subrings of such) over a field of finite dimensional manifolds. See #29581.


---

Comment by git created at 2021-07-25 19:38:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-25 19:40:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-25 21:23:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-26 18:29:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-07-26 18:41:34

(for the following see also https://groups.google.com/g/sage-devel/c/z5Y7BMwEUVk)

I have troubles constructing a quotient. Here is what happens without a `ngens` method:


```
sage: from sage.algebras.commutative_graded_algebra_finite import FiniteGCAlgebra
sage: A.<x,y,z> = FiniteGCAlgebra(QQ, degrees=(1,2,3), max_degree=6)
sage: I = A.ideal(y^2)
sage: A.quotient(I)
Traceback (most recent call last)
...
RuntimeError: Graded commutative algebra with generators ('x', 'y', 'z') in degrees (1, 2, 3) with maximal finite degree 6 still using old coercion framework
```


Adding a `ngens` method on the other hand causes the quotients not to function properly:


```
sage: from sage.algebras.commutative_graded_algebra_finite import FiniteGCAlgebra
sage: A.<x,y,z> = FiniteGCAlgebra(QQ, degrees=(1,2,3), max_degree=6)
sage: I = A.ideal(y^2)
sage: Q = A.quotient(I)
sage: Q.gen(1)^2
ybar^2
```


The result, however, should be zero.

What am I doing wrong?


---

Comment by @mjungmath created at 2021-07-27 13:53:33

See https://ask.sagemath.org/question/56243/quotients-of-exterior-algebras/.


---

Comment by git created at 2021-07-28 13:49:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-28 15:13:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-28 17:03:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-07-28 17:03:52

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-07-28 17:03:52

Ready for review. If you have more ideas for doctests, please let me know.


---

Comment by git created at 2021-07-28 19:28:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-30 05:32:09

It would be better to have the keys be a filter applied to `WeightedIntegerVectors`, so it returns a parent rather than the explicit list. That way you do not need to create this list upon creation of the parent nor store it in memory. You can use `ConditionSet` from #32089 with a small extension to handle the case when its ambient set is a (finite?) enumerated set, or as a more stopgap that is already has what you need: `FilteredCombinatorialClass`. (Note that `ConditionSet` should be used as the replacement of this, which is de facto deprecated.)

This line is unnecessary:

```
Element = CombinatorialFreeModule.Element
```



---

Comment by @mjungmath created at 2021-07-30 17:15:07

With your proposal, it is a very small step to a general implementation, i.e. including the non-bounded case.

But then we would have two different implementations of the same algebra. How do we wanna deal with it? In particular, what should the globally available `GradedCommutativeAlgebra` constructor return?


---

Comment by git created at 2021-08-01 18:08:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-08-01 18:09:31

Ready for review again.


---

Comment by @mjungmath created at 2021-08-01 20:07:16

The function `GradedCommutativeAlgebra` returns this implementation if `max_degree` is passed (including infinity) and the other implementation otherwise. 

Moreover, I am a bit uncertain about the names of the file and the class. Better ideas are most welcome.


---

Comment by @mjungmath created at 2021-08-01 20:09:04

Coercions from infinite to finite maximal degrees, and coercions between both different implementations will be done in a follow-up.


---

Comment by git created at 2021-08-02 08:22:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-08-02 08:26:45

This should fix the patchbot complaints.


---

Comment by git created at 2021-08-02 22:58:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-08-03 09:35:15

Patchbot is morally green now. :)


---

Comment by jhpalmieri created at 2021-08-05 20:53:59

In the file `commutative_graded_algebra.py`, the first line of the docstring for `GCAlgebraWithMaxDegree` says "Graded commutative algebras." Shouldn't it say "Graded commutative algebras with a maximum degree"? Should this class inherit from `GCAlgebra`? (`GCAlgebra` would be my answer to your last question in comment:17.)

I notice that you mentioned ideals in a previous comment; was that issue ever resolved? If so, it would be good to add some examples. If not, if there are no ideals or relations possible with these, the documentation should say that. "The only relation in such an algebra is that any product above `max_degree` is zero."


---

Comment by @mjungmath created at 2021-08-05 21:50:20

Replying to [comment:28 jhpalmieri]:
> In the file `commutative_graded_algebra.py`, the first line of the docstring for `GCAlgebraWithMaxDegree` says "Graded commutative algebras." Shouldn't it say "Graded commutative algebras with a maximum degree"?

Yes, I think so. Though this implementation supports general graded commutative algebras. 

> Should this class inherit from `GCAlgebra`?

I don't think so. This implementation is basically different from what is done in `commutative_dga`. This implementation now offers two benefits: it supports `SR` as base field and a maximal degree. 

> (`GCAlgebra` would be my answer to your last question in comment:17.)

`GCAlgebra` would be the same name as in `commutative_dga`. So you think this is a good idea? 

> I notice that you mentioned ideals in a previous comment; was that issue ever resolved? If so, it would be good to add some examples. If not, if there are no ideals or relations possible with these, the documentation should say that.

No, the algebra apparently needs its own implementation of an ideal. A first lead into this direction yields #32249. 

> "The only relation in such an algebra is that any product above `max_degree` is zero."

What are you referring to?


---

Comment by jhpalmieri created at 2021-08-06 02:00:50

Replying to [comment:29 gh-mjungmath]:
> Replying to [comment:28 jhpalmieri]:
> > In the file `commutative_graded_algebra.py`, the first line of the docstring for `GCAlgebraWithMaxDegree` says "Graded commutative algebras." Shouldn't it say "Graded commutative algebras with a maximum degree"?
> 
> Yes, I think so. Though this implementation supports general graded commutative algebras. 
> 
> > Should this class inherit from `GCAlgebra`?
> 
> I don't think so. This implementation is basically different from what is done in `commutative_dga`. This implementation now offers two benefits: it supports `SR` as base field and a maximal degree. 

I'm confused: are you creating a new class that duplicates and then enhances an existing class? Why not rewrite the old class instead? In other words, why have two implementations of graded commutative algebras?

> > I notice that you mentioned ideals in a previous comment; was that issue ever resolved? If so, it would be good to add some examples. If not, if there are no ideals or relations possible with these, the documentation should say that.
> 
> No, the algebra apparently needs its own implementation of an ideal. A first lead into this direction yields #32249. 
> 
> > "The only relation in such an algebra is that any product above `max_degree` is zero."
> 
> What are you referring to? 

I was suggesting documentation in case it is not possible to impose relations on your class of algebras.


---

Comment by @mjungmath created at 2021-08-06 07:44:49

Replying to [comment:30 jhpalmieri]:
> I'm confused: are you creating a new class that duplicates and then enhances an existing class? Why not rewrite the old class instead? In other words, why have two implementations of graded commutative algebras?

First of all, this was not planned. I only wanted to implement gc algebras with _finite_ degree. But it turned out that together with #32315, it was a small step to infinite degrees. 

Imho, rewriting would be way too much work for a questionable benefit. Both classes have different advantages and disadvantages. 

If I'm not mistaken, different implementations of the same mathematical objects are not uncommon in Sage...

I'm open to suggestions though, because I agree that this is not optimal. 

> I was suggesting documentation in case it is not possible to impose relations on your class of algebras.

Well, here it gets strange. You can define ideals by default, ie relations. But then the generic implementation of the quotient just gives nonsense.

This is not the only class having this problem. In other classes, this is also undocumented. See #32291 and https://ask.sagemath.org/question/56243/quotients-of-exterior-algebras/.


---

Comment by @mjungmath created at 2021-08-06 07:56:56

In summary, the main differences to the other implementation are:

- not possible to define (working) relations and quotients
- no differentials
- no multigrading
- support for `SR` and other arbitrary fields
- maximal degree (relation)


---

Comment by @mjungmath created at 2021-08-06 11:32:53

Alternatively, we should add `SR` support, which currently produces the following error:


```
sage: A.<x,y,z> = GradedCommutativeAlgebra(SR, degrees=(1,2,3))
Traceback (most recent call last):
...
TypeError: Cannot call Singular function 'nc_algebra' with ring parameter of type '<class 'sage.rings.polynomial.multi_polynomial_ring.MPolynomialRing_polydict_with_category'>'
```


and getting finite degrees using ideals. But honestly, I don't see how to use ideals in an efficient fashion this way; especially since Groebner bases are not supported so far. But even with Groebner bases, the list of generators of that ideal is not easy to create (without redundancies) and can get very long.


---

Comment by @mjungmath created at 2021-08-10 11:28:15

How do we want to proceed now?

If this ticket is on hold, I would like to proceed in #29581 with a tentative version of this code restricted only to characteristic cohomology classes.


---

Comment by jhpalmieri created at 2021-08-10 18:45:45

Changing the milestone gives us some more time to think about it. I personally would prefer a more narrow use of this, and then we can try to find a unified approach for graded commutative algebras that combines the features of both.


---

Comment by @mjungmath created at 2021-08-11 10:08:48

Thank you for the feedback. Then let's restrict this class to finite degrees only and think about the rest later.

I'll make the changes accordingly.

Otherwise, do you have further suggestions?


---

Comment by git created at 2021-08-11 11:28:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-08-11 11:28:41

Here we go. Ready for review again.

Though we have some time now, I'd appreciate a positive review soon, so that I can proceed working on #29581. The latter ticket is necessary for a project I'm currently running.


---

Comment by tscrim created at 2021-08-11 12:58:53

At some point, this (and perhaps its unbounded degree variant) should have a more optimized version of the multiplication done in Cython rather than relying on plural or `product_on_basis` framework (there are a lot of extra intermediate function calls being done).

I suspect the exterior algebra implementation will remain faster (which could be meld together with a purely odd degree version) because of the data structure for encoding the elements. Nevertheless, it would be interesting to compare with a "natural" encoding of the monomials by the degree of the generators. Perhaps the ideal way to do this would be to encode a basis element by a pair of the degrees of the evens with a subset of the odd indices (ordered as a tuple; cf. the exterior algebra implementation).

However, all of that is for another ticket.


---

Comment by @mjungmath created at 2021-08-11 13:40:30

Replying to [comment:43 tscrim]:
> At some point, this (and perhaps its unbounded degree variant) should have a more optimized version of the multiplication done in Cython rather than relying on plural or `product_on_basis` framework (there are a lot of extra intermediate function calls being done).

Indeed!

> I suspect the exterior algebra implementation will remain faster (which could be meld together with a purely odd degree version) because of the data structure for encoding the elements. Nevertheless, it would be interesting to compare with a "natural" encoding of the monomials by the degree of the generators. Perhaps the ideal way to do this would be to encode a basis element by a pair of the degrees of the evens with a subset of the odd indices (ordered as a tuple; cf. the exterior algebra implementation).

Separating the generators into odd and even degree, and performing the computations on those sounds like the most optimal solution to me. Besides, together with Cythonizing, this could give an extremely efficient implementation. I can imagine that all those ideals and relations currently used in `commutative_dga` slow down computations a bit.

> However, all of that is for another ticket.

Exactly.


---

Comment by @mjungmath created at 2021-08-11 14:45:06

Patchbot seems okay.


---

Comment by tscrim created at 2021-08-13 21:50:35

Since this functionality is distinct from the general cga code, I think for now we can go ahead with this ticket.

One trivial pyflakes thing before a positive review:

```
src/sage/algebras/finite_gca.py:28:1 'sage.rings.infinity.infinity' imported but unused
```

Once fixed, you can set a positive review unless somebody else objects.


---

Comment by git created at 2021-08-14 09:31:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-14 12:19:37

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-08-14 12:19:37

Thank you.


---

Comment by @mjungmath created at 2021-08-14 12:26:24

Thank you for the review.


---

Comment by slelievre created at 2021-08-15 09:16:52

Nitpicking suggestion, feel free to ignore.

Please remove trailing blank lines
at the end of docstrings.

While reST blocks usually need a final blank line,
it is not the case at the end of a docstring.

See the template at:

- https://doc.sagemath.org/html/en/developer/coding_basics.html#template

where the final TESTS block is followed
directly by `"""` with no extra blank line.


---

Comment by @mjungmath created at 2021-08-15 09:27:21

Replying to [comment:50 slelievre]:
> Nitpicking suggestion, feel free to ignore.
> 
> Please remove trailing blank lines
> at the end of docstrings.
> 
> While reST blocks usually need a final blank line,
> it is not the case at the end of a docstring.
> 
> See the template at:
> 
> - https://doc.sagemath.org/html/en/developer/coding_basics.html#template
> 
> where the final TESTS block is followed
> directly by `"""` with no extra blank line.

Thank you! That is good to know. I will keep an eye on this in the future!


---

Comment by vbraun created at 2021-09-02 22:43:33

PDF docs don't build


---

Comment by vbraun created at 2021-09-02 22:43:33

Changing status from positive_review to needs_work.


---

Comment by @mjungmath created at 2021-09-04 19:51:55

Weird. What's the issue here?


---

Comment by tscrim created at 2021-09-04 20:38:24

Perhaps its the `$` in the `\text` with an autoreplace done to a backtick ```? Are you able to build the PDF docs?


---

Comment by git created at 2021-09-04 21:58:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-09-04 21:59:10

That should be it.


---

Comment by @mjungmath created at 2021-09-04 22:00:02

Changing status from needs_work to needs_review.


---

Comment by @mjungmath created at 2021-09-05 10:26:47

Patchbot is green except for unrelated pyflakes errors in `src/sage/docs/conf.py`. Those imports should be removed at some point, no?


---

Comment by tscrim created at 2021-09-06 06:15:21

Perhaps, but that should be its own ticket.


---

Comment by tscrim created at 2021-09-06 06:15:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-13 22:22:25

Resolution: fixed
