# Issue 23997: py3: restore_atexit context manager

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-11-17 14:07:43

CC:  chapoton jdemeyer

Adds a context manager that can save and restore the state of the `atexit` module.

This functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.

This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.

We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.


---

Comment by embray created at 2017-11-17 14:07:55

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-11-17 17:04:47

Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.


---

Comment by jdemeyer created at 2017-11-17 17:11:09

By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.


---

Comment by embray created at 2017-11-20 09:24:46

Replying to [comment:3 jdemeyer]:
> Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.

If you say so--I felt like it would be good to add a module to `sage.misc` specifically for context managers _in general_.  I'm not sure how I feel about `sage.cpython` for this.


---

Comment by embray created at 2017-11-20 09:29:23

Replying to [comment:4 jdemeyer]:
> By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.

Writing a function to return a list would be easy.  The problem is that mutating that list would either have no effect, or would have to be propagated back to the internal array of callbacks.  So I think that would be a no-go.  Instead you'd probably want to have a function that returns a tuple since it's immutable, and also provide a function for setting the sequence of callbacks directly.

I'd say normally this goes against how the module is intended to be used, but if nothing else, as this case demonstrates, it may be useful for testing purposes to be able to do this through underscored methods as was the case in Python 2.  I'll bring it up...


---

Comment by embray created at 2017-11-20 09:58:07

Added an upstream report as well, but even if my idea, or something like it is accepted it will likely be at least until Python 3.7 that we could rely on it, so for now my code, or something like it, will serve as a workaround.


---

Comment by jdemeyer created at 2017-11-20 13:52:11

Replying to [comment:7 embray]:
> for now my code, or something like it, will serve as a workaround.

Sure.


---

Comment by jdemeyer created at 2017-11-20 13:57:03

Replying to [comment:5 embray]:
> I felt like it would be good to add a module to `sage.misc` specifically for context managers _in general_.

It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).


---

Comment by jdemeyer created at 2017-11-20 14:02:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-20 14:02:05

I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.


---

Comment by jdemeyer created at 2017-11-20 14:03:14

Alternatively, you could implement everything in one Cython file which is always compiled but which uses different internal logic depending on the Python version.


---

Comment by jdemeyer created at 2017-11-20 14:09:50

I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.


---

Comment by embray created at 2017-11-20 14:55:43

Replying to [comment:9 jdemeyer]:
> Replying to [comment:5 embray]:
> > I felt like it would be good to add a module to `sage.misc` specifically for context managers _in general_.
> 
> It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).

I don't really think about it that way, but it's not worth arguing over.


---

Comment by embray created at 2017-11-20 14:56:48

Replying to [comment:10 jdemeyer]:
> I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.

Ah, I didn't know about `OptionalExtension`.  The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that (or something equivalent that might come up even if I moved it).


---

Comment by embray created at 2017-11-20 14:59:01

Replying to [comment:12 jdemeyer]:
> I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.

Yeah, that might be fine too.  I would prefix those with an underscore but otherwise that makes sense.


---

Comment by jdemeyer created at 2017-11-21 16:05:39

Replying to [comment:14 embray]:
> The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that

Cython is clever enough to deal with that. Extensions which are explicitly listed take precedence over extensions specified by a glob pattern. See for example

```python
    # Compile this with -Os because it works around a bug with
    # GCC-4.7.3 + Cython 0.19 on Itanium, see Trac #14452. Moreover, it
    # actually results in faster code than -O3.
    Extension('sage.structure.element',
              sources = ['sage/structure/element.pyx'],
              extra_compile_args=["-Os"]),

    Extension('*', ['sage/structure/*.pyx']),
```



---

Comment by embray created at 2017-11-21 16:56:56

Okay, I'll rework it that way then.  I will keep the `_py3` naming scheme though.


---

Comment by git created at 2017-12-01 17:04:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-12-01 17:05:16

Moved to `sage.cpython.atexit` and did some of the suggested refactoring.  At the end it ended up not being particularly useful (especially now that we have #24246) to split the Python 3 implementation off to a separate module, so I ended up recombining everything into a single Cython module.


---

Comment by embray created at 2017-12-01 17:05:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-12-01 17:09:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-12-01 17:09:56

Given a positive review I'll also squash the commits into something more coherent.


---

Comment by jdemeyer created at 2017-12-01 19:45:23

Overall, this looks good. There are various details to be fixed though:

1. The title still says "A home for miscellaneous context managers."

2. You import `six` but don't use it.

3. The doc of `restore_atexit` is misformatted. The correct format is

```
    EXAMPLES:

    For this example...

    ...of the ``atexit`` state::

        sage: import atexit
```


4. I would move the comment "# These are helper functions..." outside of the `IF` block. There is also a typo: implements -> implementations.

5. I find it mildly ugly that the signature of the helper functions is different in the Python 2 and Python 3 versions (`cdef inline list` vs. `def`) Since performance doesn't really matter here, I would make all functions simply Python (`def`) functions. Then they can be imported as usual.

6. I think the doctest would be more clear by adding some `print` statements showing the list of registered handlers in appropriate places. Something like

```
sage: print("Initial exitfuncs: {}".format(_get_exithandlers()))
```


7. Add a comment above `ctypedef struct atexit_callback:` that you are copying the internal structures of the `atexit` module, see `Modules/atexitmodule.c` in the Python sources.

8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead _append_ to the existing list?

9. Add a test with an empty `restore_atexit():` context:

```
with restore_atexit():
    pass
```

showing that the list of registered functions is the same before and after. That would have caught 8.


---

Comment by jdemeyer created at 2017-12-01 19:45:23

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-12-04 10:44:32

I don't agree with all of these, but I'll fix the obvious ones.


---

Comment by embray created at 2017-12-04 10:48:23

Replying to [comment:22 jdemeyer]:
> 8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead _append_ to the existing list?

That's a good point--it should clear the existing list first.


---

Comment by git created at 2017-12-04 11:26:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-12-04 11:26:32

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-12-04 13:05:43

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-12-04 13:05:43

Two more things before a positive review:

1. `def _set_exithandlers(list exithandlers)`: remove `list` typing. We might as well allow arbitrary iterables.

2. Add this new module to the documentation in `src/doc/en/reference/cpython/index.rst`


---

Comment by embray created at 2017-12-04 13:16:43

I'll add it to the docs but I'd rather otherwise leave the typing as is.  This is an internal function and there's no reason it will ever be passed anything but a list.


---

Comment by chapoton created at 2018-01-04 15:27:58

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-01-04 15:27:58

done and done
----
New commits:


---

Comment by embray created at 2018-01-04 16:04:38

Oh, I forgot about this. Thanks.


---

Comment by git created at 2018-01-05 09:04:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-05 09:05:37

Rebased, squashed and fixed docbuild issue. Back to patchbot testing.


---

Comment by jdemeyer created at 2018-01-08 14:24:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-14 10:14:38

Resolution: fixed
