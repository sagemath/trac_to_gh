# Issue 23997: py3: restore_atexit context manager

archive/issues_023997.json:
```json
{
    "body": "CC:  chapoton jdemeyer\n\nAdds a context manager that can save and restore the state of the `atexit` module.\n\nThis functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.\n\nThis is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.\n\nWe might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24234\n\n",
    "created_at": "2017-11-17T14:07:43Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: restore_atexit context manager",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23997",
    "user": "embray"
}
```
CC:  chapoton jdemeyer

Adds a context manager that can save and restore the state of the `atexit` module.

This functionality is currently only needed by the test runner (see `DocTestTask`) but is non-trivial on Python 3 since the list of registered atexit handler functions is no longer exposed to Python.

This is perhaps the first example we have in sage of a Python 3-only extension module.  Thsi establishes a convention that module names ending with '_py3' should only be built on Python 3.  Typically these should also begin with an underscore to emphasize that they are an implementation detail.  They can then be conditionally imported from a 'public' module of the same name without the `_*_py3`.

We might consider using a similar convention for modules that are Python 2-only, but currently none such examples exist.

Issue created by migration from https://trac.sagemath.org/ticket/24234





---

archive/issue_comments_336332.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-17T14:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336332",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336333.json:
```json
{
    "body": "Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.",
    "created_at": "2017-11-17T17:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336333",
    "user": "jdemeyer"
}
```

Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.



---

archive/issue_comments_336334.json:
```json
{
    "body": "By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.",
    "created_at": "2017-11-17T17:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336334",
    "user": "jdemeyer"
}
```

By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.



---

archive/issue_comments_336335.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.\n\nIf you say so--I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.  I'm not sure how I feel about `sage.cpython` for this.",
    "created_at": "2017-11-20T09:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336335",
    "user": "embray"
}
```

Replying to [comment:3 jdemeyer]:
> Haven't read the code yet, but this is really something which should be put in the directory `src/sage/cpython`.

If you say so--I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.  I'm not sure how I feel about `sage.cpython` for this.



---

archive/issue_comments_336336.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.\n\nWriting a function to return a list would be easy.  The problem is that mutating that list would either have no effect, or would have to be propagated back to the internal array of callbacks.  So I think that would be a no-go.  Instead you'd probably want to have a function that returns a tuple since it's immutable, and also provide a function for setting the sequence of callbacks directly.\n\nI'd say normally this goes against how the module is intended to be used, but if nothing else, as this case demonstrates, it may be useful for testing purposes to be able to do this through underscored methods as was the case in Python 2.  I'll bring it up...",
    "created_at": "2017-11-20T09:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336336",
    "user": "embray"
}
```

Replying to [comment:4 jdemeyer]:
> By the way, do you think that Python upstream would accept a patch to expose some more of `atexit` internals? It would be easy to write a function to return the list of atexit functions (say, as a list of triples `(func, args, kwds)`) for example.

Writing a function to return a list would be easy.  The problem is that mutating that list would either have no effect, or would have to be propagated back to the internal array of callbacks.  So I think that would be a no-go.  Instead you'd probably want to have a function that returns a tuple since it's immutable, and also provide a function for setting the sequence of callbacks directly.

I'd say normally this goes against how the module is intended to be used, but if nothing else, as this case demonstrates, it may be useful for testing purposes to be able to do this through underscored methods as was the case in Python 2.  I'll bring it up...



---

archive/issue_comments_336337.json:
```json
{
    "body": "Added an upstream report as well, but even if my idea, or something like it is accepted it will likely be at least until Python 3.7 that we could rely on it, so for now my code, or something like it, will serve as a workaround.",
    "created_at": "2017-11-20T09:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336337",
    "user": "embray"
}
```

Added an upstream report as well, but even if my idea, or something like it is accepted it will likely be at least until Python 3.7 that we could rely on it, so for now my code, or something like it, will serve as a workaround.



---

archive/issue_comments_336338.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> for now my code, or something like it, will serve as a workaround.\n\nSure.",
    "created_at": "2017-11-20T13:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336338",
    "user": "jdemeyer"
}
```

Replying to [comment:7 embray]:
> for now my code, or something like it, will serve as a workaround.

Sure.



---

archive/issue_comments_336339.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.\n\nIt makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).",
    "created_at": "2017-11-20T13:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336339",
    "user": "jdemeyer"
}
```

Replying to [comment:5 embray]:
> I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.

It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).



---

archive/issue_comments_336340.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-20T14:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336340",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336341.json:
```json
{
    "body": "I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.",
    "created_at": "2017-11-20T14:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336341",
    "user": "jdemeyer"
}
```

I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.



---

archive/issue_comments_336342.json:
```json
{
    "body": "Alternatively, you could implement everything in one Cython file which is always compiled but which uses different internal logic depending on the Python version.",
    "created_at": "2017-11-20T14:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336342",
    "user": "jdemeyer"
}
```

Alternatively, you could implement everything in one Cython file which is always compiled but which uses different internal logic depending on the Python version.



---

archive/issue_comments_336343.json:
```json
{
    "body": "I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.",
    "created_at": "2017-11-20T14:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336343",
    "user": "jdemeyer"
}
```

I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.



---

archive/issue_comments_336344.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:5 embray]:\n> > I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.\n> \n> It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).\n\nI don't really think about it that way, but it's not worth arguing over.",
    "created_at": "2017-11-20T14:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336344",
    "user": "embray"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:5 embray]:
> > I felt like it would be good to add a module to `sage.misc` specifically for context managers *in general*.
> 
> It makes a lot more sense to group functionality according to topic (the `cpython` directory for dealing with Python internals) rather than implementation type (context managers).

I don't really think about it that way, but it's not worth arguing over.



---

archive/issue_comments_336345.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.\n\nAh, I didn't know about `OptionalExtension`.  The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that (or something equivalent that might come up even if I moved it).",
    "created_at": "2017-11-20T14:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336345",
    "user": "embray"
}
```

Replying to [comment:10 jdemeyer]:
> I don't think you need to add additional functionality to `setup.py`. Compiling extensions only on Python 3 an be done by using an `OptionalExtension(..., condition=six.PY3)` in `module_list.py`. This also gives the advantage that modules are at least cythonized on Python 2, so certain kinds of breakage will be detected even on Python 2.

Ah, I didn't know about `OptionalExtension`.  The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that (or something equivalent that might come up even if I moved it).



---

archive/issue_comments_336346.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.\n\nYeah, that might be fine too.  I would prefix those with an underscore but otherwise that makes sense.",
    "created_at": "2017-11-20T14:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336346",
    "user": "embray"
}
```

Replying to [comment:12 jdemeyer]:
> I don't see why you need to implement two complete context managers (one for Python 2 and one for Python 3). Instead, you could just implement two functions (say `atexit_get_handlers()` and `atexit_set_handlers()`) for both Python versions and then implement one context manager using those functions.

Yeah, that might be fine too.  I would prefix those with an underscore but otherwise that makes sense.



---

archive/issue_comments_336347.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that\n\nCython is clever enough to deal with that. Extensions which are explicitly listed take precedence over extensions specified by a glob pattern. See for example\n\n```python\n    # Compile this with -Os because it works around a bug with\n    # GCC-4.7.3 + Cython 0.19 on Itanium, see Trac #14452. Moreover, it\n    # actually results in faster code than -O3.\n    Extension('sage.structure.element',\n              sources = ['sage/structure/element.pyx'],\n              extra_compile_args=[\"-Os\"]),\n\n    Extension('*', ['sage/structure/*.pyx']),\n```\n",
    "created_at": "2017-11-21T16:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336347",
    "user": "jdemeyer"
}
```

Replying to [comment:14 embray]:
> The thing is that since this was originally in `sage.misc`, you have in there `Extension('sage/misc/*.pyx')` so I'm not sure how `OptionalExtension` would play with that

Cython is clever enough to deal with that. Extensions which are explicitly listed take precedence over extensions specified by a glob pattern. See for example

```python
    # Compile this with -Os because it works around a bug with
    # GCC-4.7.3 + Cython 0.19 on Itanium, see Trac #14452. Moreover, it
    # actually results in faster code than -O3.
    Extension('sage.structure.element',
              sources = ['sage/structure/element.pyx'],
              extra_compile_args=["-Os"]),

    Extension('*', ['sage/structure/*.pyx']),
```




---

archive/issue_comments_336348.json:
```json
{
    "body": "Okay, I'll rework it that way then.  I will keep the `_py3` naming scheme though.",
    "created_at": "2017-11-21T16:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336348",
    "user": "embray"
}
```

Okay, I'll rework it that way then.  I will keep the `_py3` naming scheme though.



---

archive/issue_comments_336349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-01T17:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336349",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336350.json:
```json
{
    "body": "Moved to `sage.cpython.atexit` and did some of the suggested refactoring.  At the end it ended up not being particularly useful (especially now that we have #24246) to split the Python 3 implementation off to a separate module, so I ended up recombining everything into a single Cython module.",
    "created_at": "2017-12-01T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336350",
    "user": "embray"
}
```

Moved to `sage.cpython.atexit` and did some of the suggested refactoring.  At the end it ended up not being particularly useful (especially now that we have #24246) to split the Python 3 implementation off to a separate module, so I ended up recombining everything into a single Cython module.



---

archive/issue_comments_336351.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-01T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336351",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336352.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-01T17:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336352",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336353.json:
```json
{
    "body": "Given a positive review I'll also squash the commits into something more coherent.",
    "created_at": "2017-12-01T17:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336353",
    "user": "embray"
}
```

Given a positive review I'll also squash the commits into something more coherent.



---

archive/issue_comments_336354.json:
```json
{
    "body": "Overall, this looks good. There are various details to be fixed though:\n\n1. The title still says \"A home for miscellaneous context managers.\"\n\n2. You import `six` but don't use it.\n\n3. The doc of `restore_atexit` is misformatted. The correct format is\n\n```\n    EXAMPLES:\n\n    For this example...\n\n    ...of the ``atexit`` state::\n\n        sage: import atexit\n```\n\n\n4. I would move the comment \"# These are helper functions...\" outside of the `IF` block. There is also a typo: implements -> implementations.\n\n5. I find it mildly ugly that the signature of the helper functions is different in the Python 2 and Python 3 versions (`cdef inline list` vs. `def`) Since performance doesn't really matter here, I would make all functions simply Python (`def`) functions. Then they can be imported as usual.\n\n6. I think the doctest would be more clear by adding some `print` statements showing the list of registered handlers in appropriate places. Something like\n\n```\nsage: print(\"Initial exitfuncs: {}\".format(_get_exithandlers()))\n```\n\n\n7. Add a comment above `ctypedef struct atexit_callback:` that you are copying the internal structures of the `atexit` module, see `Modules/atexitmodule.c` in the Python sources.\n\n8. The Python 3 version of `_set_exithandlers` says \"Replace the list of exit handlers...\" but doesn't it instead *append* to the existing list?\n\n9. Add a test with an empty `restore_atexit():` context:\n\n```\nwith restore_atexit():\n    pass\n```\n\nshowing that the list of registered functions is the same before and after. That would have caught 8.",
    "created_at": "2017-12-01T19:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336354",
    "user": "jdemeyer"
}
```

Overall, this looks good. There are various details to be fixed though:

1. The title still says "A home for miscellaneous context managers."

2. You import `six` but don't use it.

3. The doc of `restore_atexit` is misformatted. The correct format is

```
    EXAMPLES:

    For this example...

    ...of the ``atexit`` state::

        sage: import atexit
```


4. I would move the comment "# These are helper functions..." outside of the `IF` block. There is also a typo: implements -> implementations.

5. I find it mildly ugly that the signature of the helper functions is different in the Python 2 and Python 3 versions (`cdef inline list` vs. `def`) Since performance doesn't really matter here, I would make all functions simply Python (`def`) functions. Then they can be imported as usual.

6. I think the doctest would be more clear by adding some `print` statements showing the list of registered handlers in appropriate places. Something like

```
sage: print("Initial exitfuncs: {}".format(_get_exithandlers()))
```


7. Add a comment above `ctypedef struct atexit_callback:` that you are copying the internal structures of the `atexit` module, see `Modules/atexitmodule.c` in the Python sources.

8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead *append* to the existing list?

9. Add a test with an empty `restore_atexit():` context:

```
with restore_atexit():
    pass
```

showing that the list of registered functions is the same before and after. That would have caught 8.



---

archive/issue_comments_336355.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-01T19:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336355",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336356.json:
```json
{
    "body": "I don't agree with all of these, but I'll fix the obvious ones.",
    "created_at": "2017-12-04T10:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336356",
    "user": "embray"
}
```

I don't agree with all of these, but I'll fix the obvious ones.



---

archive/issue_comments_336357.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> 8. The Python 3 version of `_set_exithandlers` says \"Replace the list of exit handlers...\" but doesn't it instead *append* to the existing list?\n\nThat's a good point--it should clear the existing list first.",
    "created_at": "2017-12-04T10:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336357",
    "user": "embray"
}
```

Replying to [comment:22 jdemeyer]:
> 8. The Python 3 version of `_set_exithandlers` says "Replace the list of exit handlers..." but doesn't it instead *append* to the existing list?

That's a good point--it should clear the existing list first.



---

archive/issue_comments_336358.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-04T11:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336358",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336359.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-04T11:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336359",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336360.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-04T13:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336360",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336361.json:
```json
{
    "body": "Two more things before a positive review:\n\n1. `def _set_exithandlers(list exithandlers)`: remove `list` typing. We might as well allow arbitrary iterables.\n\n2. Add this new module to the documentation in `src/doc/en/reference/cpython/index.rst`",
    "created_at": "2017-12-04T13:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336361",
    "user": "jdemeyer"
}
```

Two more things before a positive review:

1. `def _set_exithandlers(list exithandlers)`: remove `list` typing. We might as well allow arbitrary iterables.

2. Add this new module to the documentation in `src/doc/en/reference/cpython/index.rst`



---

archive/issue_comments_336362.json:
```json
{
    "body": "I'll add it to the docs but I'd rather otherwise leave the typing as is.  This is an internal function and there's no reason it will ever be passed anything but a list.",
    "created_at": "2017-12-04T13:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336362",
    "user": "embray"
}
```

I'll add it to the docs but I'd rather otherwise leave the typing as is.  This is an internal function and there's no reason it will ever be passed anything but a list.



---

archive/issue_comments_336363.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-04T15:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336363",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336364.json:
```json
{
    "body": "done and done\n----\nNew commits:",
    "created_at": "2018-01-04T15:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336364",
    "user": "chapoton"
}
```

done and done
----
New commits:



---

archive/issue_comments_336365.json:
```json
{
    "body": "Oh, I forgot about this. Thanks.",
    "created_at": "2018-01-04T16:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336365",
    "user": "embray"
}
```

Oh, I forgot about this. Thanks.



---

archive/issue_comments_336366.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-05T09:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336366",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336367.json:
```json
{
    "body": "Rebased, squashed and fixed docbuild issue. Back to patchbot testing.",
    "created_at": "2018-01-05T09:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336367",
    "user": "jdemeyer"
}
```

Rebased, squashed and fixed docbuild issue. Back to patchbot testing.



---

archive/issue_comments_336368.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-08T14:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336368",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336369.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-14T10:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23997#issuecomment-336369",
    "user": "vbraun"
}
```

Resolution: fixed
