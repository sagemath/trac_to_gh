# Issue 32633: sage.rings: Modularization changes

Issue created by migration from https://trac.sagemath.org/ticket/32870

Original creator: mkoeppe

Original creation time: 2021-11-14 08:23:09

CC:  @kliem

split out from #32432.




---

Comment by mkoeppe created at 2021-11-14 08:23:59

New commits:


---

Comment by mkoeppe created at 2021-11-14 08:23:59

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-16 20:24:28


```
    from .functional import (additive_order,
  File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
    from sage.rings.complex_double import CDF
  File "sage/rings/complex_double.pyx", line 110, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:24921)
  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr (build/cythonized/sage/rings/complex_mpfr.c:35629)
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr (build/cythonized/sage/rings/real_mpfr.c:47129)
  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils (build/cythonized/sage/libs/mpmath/utils.c:9319)
ImportError: cannot import name ComplexField
```



---

Comment by mkoeppe created at 2021-11-16 20:24:28

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-16 23:54:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-16 23:55:27

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-16 23:55:27

Backed out the last change to `src/sage/rings/rational.pyx`


---

Comment by git created at 2021-11-18 18:05:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-29 22:02:05

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-29 22:02:05


```
sage -t --long --random-seed=194261639548588837697181034125749346937 src/sage/rings/commutative_algebra.py
**********************************************************************
File "src/sage/rings/commutative_algebra.py", line 28, in sage.rings.commutative_algebra.is_CommutativeAlgebra
Failed example:
    sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.commutative_algebra.is_CommutativeAlgebra[0]>", line 1, in <module>
        sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
    AttributeError: module 'sage.rings' has no attribute 'commutative_algebra'
```



---

Comment by git created at 2021-11-29 22:13:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-29 22:13:25

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-11-30 08:40:36

Before:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
833 ns ± 1.01 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```


After:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
1.37 µs ± 0.777 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```


I will see, if I can improve this.


---

Comment by @kliem created at 2021-11-30 08:47:24

Before:


```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.2 µs ± 38.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.24 µs ± 8.11 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.04 µs ± 7.01 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


After:


```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
9.71 µs ± 36.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
3.2 µs ± 26.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.75 µs ± 6.89 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by @kliem created at 2021-11-30 09:16:10

I'm pretty much back to the old timings:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
853 ns ± 1.18 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.1 µs ± 71.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.11 µs ± 2.83 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.02 µs ± 13.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

----
New commits:


---

Comment by mkoeppe created at 2021-11-30 21:11:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-30 21:11:31

Thanks a lot, this is looking great.


---

Comment by mkoeppe created at 2021-11-30 23:45:50

Actually, in this change there's a typo:

```
--- a/src/sage/rings/quotient_ring_element.py
+++ b/src/sage/rings/quotient_ring_element.py
@@ -18,7 +18,12 @@ AUTHORS:
 
 from sage.structure.element import RingElement
 from sage.structure.richcmp import richcmp, rich_to_bool
-from sage.interfaces.singular import singular as singular_default
+
+
+try:
+    from sage.interfaces.singular import singular as singular_default
+except ImportError:
+    is_singularElement = lambda x : False
```


... `singular_default` should be set here


---

Comment by mkoeppe created at 2021-11-30 23:45:50

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-11-30 23:49:26

New commits:


---

Comment by mkoeppe created at 2021-11-30 23:49:26

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-12-01 06:08:46

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-12-01 06:08:46

Thanks for fixing this.


---

Comment by vbraun created at 2021-12-19 11:47:25

Resolution: fixed
