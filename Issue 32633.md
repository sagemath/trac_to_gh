# Issue 32633: sage.rings: Modularization changes

archive/issues_032633.json:
```json
{
    "body": "CC:  @kliem\n\nsplit out from #32432.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32870\n\n",
    "created_at": "2021-11-14T08:23:09Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "sage.rings: Modularization changes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32633",
    "user": "@mkoeppe"
}
```
CC:  @kliem

split out from #32432.



Issue created by migration from https://trac.sagemath.org/ticket/32870





---

archive/issue_comments_465455.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-14T08:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465455",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_465456.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-14T08:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465456",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_465457.json:
```json
{
    "body": "\n```\n    from .functional import (additive_order,\n  File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/misc/functional.py\", line 26, in <module>\n    from sage.rings.complex_double import CDF\n  File \"sage/rings/complex_double.pyx\", line 110, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:24921)\n  File \"sage/rings/complex_mpfr.pyx\", line 1, in init sage.rings.complex_mpfr (build/cythonized/sage/rings/complex_mpfr.c:35629)\n  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr (build/cythonized/sage/rings/real_mpfr.c:47129)\n  File \"sage/libs/mpmath/utils.pyx\", line 17, in init sage.libs.mpmath.utils (build/cythonized/sage/libs/mpmath/utils.c:9319)\nImportError: cannot import name ComplexField\n```\n",
    "created_at": "2021-11-16T20:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465457",
    "user": "@mkoeppe"
}
```


```
    from .functional import (additive_order,
  File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
    from sage.rings.complex_double import CDF
  File "sage/rings/complex_double.pyx", line 110, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:24921)
  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr (build/cythonized/sage/rings/complex_mpfr.c:35629)
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr (build/cythonized/sage/rings/real_mpfr.c:47129)
  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils (build/cythonized/sage/libs/mpmath/utils.c:9319)
ImportError: cannot import name ComplexField
```




---

archive/issue_comments_465458.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-16T20:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465458",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_465459.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-16T23:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465459",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_465460.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-16T23:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465460",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_465461.json:
```json
{
    "body": "Backed out the last change to `src/sage/rings/rational.pyx`",
    "created_at": "2021-11-16T23:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465461",
    "user": "@mkoeppe"
}
```

Backed out the last change to `src/sage/rings/rational.pyx`



---

archive/issue_comments_465462.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-18T18:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465462",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_465463.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-29T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465463",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_465464.json:
```json
{
    "body": "\n```\nsage -t --long --random-seed=194261639548588837697181034125749346937 src/sage/rings/commutative_algebra.py\n**********************************************************************\nFile \"src/sage/rings/commutative_algebra.py\", line 28, in sage.rings.commutative_algebra.is_CommutativeAlgebra\nFailed example:\n    sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))\nException raised:\n    Traceback (most recent call last):\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.commutative_algebra.is_CommutativeAlgebra[0]>\", line 1, in <module>\n        sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))\n    AttributeError: module 'sage.rings' has no attribute 'commutative_algebra'\n```\n",
    "created_at": "2021-11-29T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465464",
    "user": "@mkoeppe"
}
```


```
sage -t --long --random-seed=194261639548588837697181034125749346937 src/sage/rings/commutative_algebra.py
**********************************************************************
File "src/sage/rings/commutative_algebra.py", line 28, in sage.rings.commutative_algebra.is_CommutativeAlgebra
Failed example:
    sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.commutative_algebra.is_CommutativeAlgebra[0]>", line 1, in <module>
        sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
    AttributeError: module 'sage.rings' has no attribute 'commutative_algebra'
```




---

archive/issue_comments_465465.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-29T22:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465465",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_465466.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-29T22:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465466",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_465467.json:
```json
{
    "body": "Before:\n\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n833 ns \u00b1 1.01 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\n\nAfter:\n\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n1.37 \u00b5s \u00b1 0.777 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\n\nI will see, if I can improve this.",
    "created_at": "2021-11-30T08:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465467",
    "user": "@kliem"
}
```

Before:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
833 ns ± 1.01 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```


After:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
1.37 µs ± 0.777 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```


I will see, if I can improve this.



---

archive/issue_comments_465468.json:
```json
{
    "body": "Before:\n\n\n```\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n8.2 \u00b5s \u00b1 38.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n2.24 \u00b5s \u00b1 8.11 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.04 \u00b5s \u00b1 7.01 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nAfter:\n\n\n```\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n9.71 \u00b5s \u00b1 36.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n3.2 \u00b5s \u00b1 26.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.75 \u00b5s \u00b1 6.89 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n",
    "created_at": "2021-11-30T08:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465468",
    "user": "@kliem"
}
```

Before:


```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.2 µs ± 38.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.24 µs ± 8.11 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.04 µs ± 7.01 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


After:


```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
9.71 µs ± 36.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
3.2 µs ± 26.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.75 µs ± 6.89 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```




---

archive/issue_comments_465469.json:
```json
{
    "body": "I'm pretty much back to the old timings:\n\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n853 ns \u00b1 1.18 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n8.1 \u00b5s \u00b1 71.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n2.11 \u00b5s \u00b1 2.83 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.02 \u00b5s \u00b1 13.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n----\nNew commits:",
    "created_at": "2021-11-30T09:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465469",
    "user": "@kliem"
}
```

I'm pretty much back to the old timings:


```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
853 ns ± 1.18 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.1 µs ± 71.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.11 µs ± 2.83 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.02 µs ± 13.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

----
New commits:



---

archive/issue_comments_465470.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-30T21:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465470",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465471.json:
```json
{
    "body": "Thanks a lot, this is looking great.",
    "created_at": "2021-11-30T21:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465471",
    "user": "@mkoeppe"
}
```

Thanks a lot, this is looking great.



---

archive/issue_comments_465472.json:
```json
{
    "body": "Actually, in this change there's a typo:\n\n```\n--- a/src/sage/rings/quotient_ring_element.py\n+++ b/src/sage/rings/quotient_ring_element.py\n@@ -18,7 +18,12 @@ AUTHORS:\n \n from sage.structure.element import RingElement\n from sage.structure.richcmp import richcmp, rich_to_bool\n-from sage.interfaces.singular import singular as singular_default\n+\n+\n+try:\n+    from sage.interfaces.singular import singular as singular_default\n+except ImportError:\n+    is_singularElement = lambda x : False\n```\n\n\n... `singular_default` should be set here",
    "created_at": "2021-11-30T23:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465472",
    "user": "@mkoeppe"
}
```

Actually, in this change there's a typo:

```
--- a/src/sage/rings/quotient_ring_element.py
+++ b/src/sage/rings/quotient_ring_element.py
@@ -18,7 +18,12 @@ AUTHORS:
 
 from sage.structure.element import RingElement
 from sage.structure.richcmp import richcmp, rich_to_bool
-from sage.interfaces.singular import singular as singular_default
+
+
+try:
+    from sage.interfaces.singular import singular as singular_default
+except ImportError:
+    is_singularElement = lambda x : False
```


... `singular_default` should be set here



---

archive/issue_comments_465473.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-11-30T23:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465473",
    "user": "@mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_465474.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-30T23:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465474",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_465475.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-30T23:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465475",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_465476.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-01T06:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465476",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465477.json:
```json
{
    "body": "Thanks for fixing this.",
    "created_at": "2021-12-01T06:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465477",
    "user": "@kliem"
}
```

Thanks for fixing this.



---

archive/issue_comments_465478.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-19T11:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32633#issuecomment-465478",
    "user": "@vbraun"
}
```

Resolution: fixed
