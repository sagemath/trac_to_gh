# Issue 32172: Differences in Riemann surfaces results based on OS

archive/issues_032172.json:
```json
{
    "body": "CC:  @nbruin @slel\n\nAs noted in comment 44 on trac ticket #31996, the output to `S.riemann_matrix()` where `S` is a `RiemannSurface` object is different depending if the calculation is run on Ubuntu or Mac OSX, differening by a value on the order of the machine precision of the complex field being used for the calculation. The reason for this should be discovered, and appropriate doctests added to check this. This doctest will likely take the form of testing the output against a known Riemann matrix, e.g. for the curve given by `y<sup>2-x</sup>3+1=0`, which has Riemann matrix (-1+I*sqrt(3))/2.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32409\n\n",
    "created_at": "2021-08-22T10:55:38Z",
    "labels": [
        "algebraic geometry",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Differences in Riemann surfaces results based on OS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32172",
    "user": "@DisneyHogg"
}
```
CC:  @nbruin @slel

As noted in comment 44 on trac ticket #31996, the output to `S.riemann_matrix()` where `S` is a `RiemannSurface` object is different depending if the calculation is run on Ubuntu or Mac OSX, differening by a value on the order of the machine precision of the complex field being used for the calculation. The reason for this should be discovered, and appropriate doctests added to check this. This doctest will likely take the form of testing the output against a known Riemann matrix, e.g. for the curve given by `y<sup>2-x</sup>3+1=0`, which has Riemann matrix (-1+I*sqrt(3))/2.

Issue created by migration from https://trac.sagemath.org/ticket/32409





---

archive/issue_comments_459514.json:
```json
{
    "body": "An update on this, a bit of testing shows that the differences occur because the values of `S._vertices` are slightly different between operating systems, which occurs at the step of the use of the scipy package Voronoi (as the outputs of `voronoi_ghost(self.branch_locus, CC=self._CC)` is the same for both). I have checked that both systems are indeed using the same version of scipy, and so I believe this is how scipy is handling the multiprecision floats.",
    "created_at": "2021-08-28T19:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32172#issuecomment-459514",
    "user": "@DisneyHogg"
}
```

An update on this, a bit of testing shows that the differences occur because the values of `S._vertices` are slightly different between operating systems, which occurs at the step of the use of the scipy package Voronoi (as the outputs of `voronoi_ghost(self.branch_locus, CC=self._CC)` is the same for both). I have checked that both systems are indeed using the same version of scipy, and so I believe this is how scipy is handling the multiprecision floats.



---

archive/issue_comments_459515.json:
```json
{
    "body": "OK, I think that traces it to OS-dependent behaviour of the [Qhull](http://www.qhull.org/) library. I don't expect handling of multiprecision floats has much to do with it. It's not unusual for libraries to have such subtle differences.\n\nWhen I chose the Voronoi engine, the one wrapped in scipy was the easiest to access. I think standard precision is enough: if you can't properly separate the branch locus with 53 bits, I don't think there's any chance in getting the integrals to any reasonable precision (or the homotopy continuations).\n\nIt would be quite doable to use a different engine: there are a few places where the usage should be adjusted, but it's fairly limited. At this point I'm not convinced it's necessary: do we really need results to be reproducible to the last bit across different platforms?",
    "created_at": "2021-08-29T21:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32172#issuecomment-459515",
    "user": "@nbruin"
}
```

OK, I think that traces it to OS-dependent behaviour of the [Qhull](http://www.qhull.org/) library. I don't expect handling of multiprecision floats has much to do with it. It's not unusual for libraries to have such subtle differences.

When I chose the Voronoi engine, the one wrapped in scipy was the easiest to access. I think standard precision is enough: if you can't properly separate the branch locus with 53 bits, I don't think there's any chance in getting the integrals to any reasonable precision (or the homotopy continuations).

It would be quite doable to use a different engine: there are a few places where the usage should be adjusted, but it's fairly limited. At this point I'm not convinced it's necessary: do we really need results to be reproducible to the last bit across different platforms?



---

archive/issue_comments_459516.json:
```json
{
    "body": "Replying to [comment:2 nbruin]:\n> It would be quite doable to use a different engine: there are a few places where the usage should be adjusted, but it's fairly limited. At this point I'm not convinced it's necessary: do we really need results to be reproducible to the last bit across different platforms?\n\nI agree that it doesn't seem worthwhile to stop using Qhull, but I will probably add a comment to the documentation to make sure that a record is kept. Any advice on the best way to do so to avoid conflict with tickets #31996 and #32297?",
    "created_at": "2021-08-30T13:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32172#issuecomment-459516",
    "user": "@DisneyHogg"
}
```

Replying to [comment:2 nbruin]:
> It would be quite doable to use a different engine: there are a few places where the usage should be adjusted, but it's fairly limited. At this point I'm not convinced it's necessary: do we really need results to be reproducible to the last bit across different platforms?

I agree that it doesn't seem worthwhile to stop using Qhull, but I will probably add a comment to the documentation to make sure that a record is kept. Any advice on the best way to do so to avoid conflict with tickets #31996 and #32297?
