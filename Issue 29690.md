# Issue 29690: shifting issue in padic _set_from_list functions

archive/issues_029690.json:
```json
{
    "body": "CC:  caruso roed\n\nKeywords: precision, set_from_list, shifting\n\nUsing version 9.1 of sage, the function _set_from_list_both(), which is written in the file: /sage/src/sage/rings/padics/padic_ZZ_pX_element.pyx, crashes or returns wrong results for some inputs.\n\nExample for wrong results:\n\n```\nsage: T.<a> = Qp(5).extension(x^2-5)\nsage: W.<w> = Qp(5).extension(x^2-5)\nsage: W(a^-41)\nO(w^-1)\n```\n\nExample for a crash (see full output in attached file):\n\n```\nsage: T.<a> = Qp(5).extension(x^2-5)\nsage: T([5^-2], absprec=-1)\n------------------------------------------------------------------------\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x828b)[0x7f250e49428b]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x8348)[0x7f250e494348]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xb323)[0x7f250e497323]\n/lib/x86_64-linux-gnu/libc.so.6(+0x3ef20)[0x7f251cc46f20]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_CR_element.cpython-37m-x86_64-linux-gnu.so(+0x34d62)[0x7f2455837d62]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x1f27d)[0x7f2455c9027d]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_CR_element.cpython-37m-x86_64-linux-gnu.so(+0x2fee9)[0x7f2455832ee9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x105972)[0x7f251d0fe972]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyObject_Call+0x68)[0x7f251d096538]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x4fc5)[0x7f251d067d65]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallDict+0x14a)[0x7f251d093cda]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyObject_Call_Prepend+0xcc)[0x7f251d094ecc]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-x86_64-linux-gnu.so(+0x7c7c)[0x7f25074c2c7c]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-x86_64-linux-gnu.so(+0x13bec)[0x7f25074cebec]\n/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/parent.cpython-37m-x86_64-linux-gnu.so(+0x1dfa9)[0x7f250d533fa9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyObject_FastCallKeywords+0xc3)[0x7f251d094503]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x5132)[0x7f251d067ed2]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f251d181bde]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f251d181c0b]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x185e4d)[0x7f251d17ee4d]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x23d)[0x7f251d09433d]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f251d094425]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f251d06bd9e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f251d069a4e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f251d069a4e]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x68c8f)[0x7f251d061c8f]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f251d181bde]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f251d181c0b]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_FileExFlags+0xaa)[0x7f251d1b6f3a]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_SimpleFileExFlags+0xfd)[0x7f251d1b70ad]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x1e25e0)[0x7f251d1db5e0]\n/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_Py_UnixMain+0x49)[0x7f251d1db859]\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f251cc29b97]\n/home/noa/workspace/padic_project/sage/local/bin/python3(_start+0x2a)[0x558e97ef478a]\n------------------------------------------------------------------------\n```\n\n\nThe bug occurs because the element is set to the desirable absolute precision **before** it is shifted by p<sup>min_val</sup>. \n\nTo fix this, I subtracted (min_val * ramification-index) from the absolute precision to which the element is set, so that **after** shifting it will hopefully reach the desirable precision.\n\nHowever, this does not completely solve the problem, because in case p is not a power of the uniformizer, it's not necessary that shifting increases the absolute precision in exactly (min_val * ramification-index). So perhaps it would be best to set the absolute precision to the desirable value, only **after** the shifting (I didn't figure out how to do this correctly).\n\nHowever, if it isn't necessary to have the exact desirable precision, the above solution could be enough.\n\nNote: The issue of shifting after setting the precision, is also relevant for _set_from_list_abs(), which I changed similarly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29927\n\n",
    "created_at": "2020-06-21T21:05:33Z",
    "labels": [
        "padics",
        "major",
        "bug"
    ],
    "title": "shifting issue in padic _set_from_list functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29690",
    "user": "@n-vi"
}
```
CC:  caruso roed

Keywords: precision, set_from_list, shifting

Using version 9.1 of sage, the function _set_from_list_both(), which is written in the file: /sage/src/sage/rings/padics/padic_ZZ_pX_element.pyx, crashes or returns wrong results for some inputs.

Example for wrong results:

```
sage: T.<a> = Qp(5).extension(x^2-5)
sage: W.<w> = Qp(5).extension(x^2-5)
sage: W(a^-41)
O(w^-1)
```

Example for a crash (see full output in attached file):

```
sage: T.<a> = Qp(5).extension(x^2-5)
sage: T([5^-2], absprec=-1)
------------------------------------------------------------------------
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x828b)[0x7f250e49428b]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x8348)[0x7f250e494348]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xb323)[0x7f250e497323]
/lib/x86_64-linux-gnu/libc.so.6(+0x3ef20)[0x7f251cc46f20]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_CR_element.cpython-37m-x86_64-linux-gnu.so(+0x34d62)[0x7f2455837d62]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_element.cpython-37m-x86_64-linux-gnu.so(+0x1f27d)[0x7f2455c9027d]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/padic_ZZ_pX_CR_element.cpython-37m-x86_64-linux-gnu.so(+0x2fee9)[0x7f2455832ee9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x105972)[0x7f251d0fe972]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyObject_Call+0x68)[0x7f251d096538]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x4fc5)[0x7f251d067d65]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallDict+0x14a)[0x7f251d093cda]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyObject_Call_Prepend+0xcc)[0x7f251d094ecc]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-x86_64-linux-gnu.so(+0x7c7c)[0x7f25074c2c7c]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/coerce_maps.cpython-37m-x86_64-linux-gnu.so(+0x13bec)[0x7f25074cebec]
/home/noa/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/parent.cpython-37m-x86_64-linux-gnu.so(+0x1dfa9)[0x7f250d533fa9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyObject_FastCallKeywords+0xc3)[0x7f251d094503]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x5132)[0x7f251d067ed2]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f251d181bde]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f251d181c0b]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x185e4d)[0x7f251d17ee4d]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallKeywords+0x23d)[0x7f251d09433d]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyCFunction_FastCallKeywords+0x25)[0x7f251d094425]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x8ffe)[0x7f251d06bd9e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f251d069a4e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x6cae)[0x7f251d069a4e]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x8f)[0x7f251d093eef]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x68c8f)[0x7f251d061c8f]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x7219)[0x7f251d069fb9]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0xa81)[0x7f251d181af1]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCodeEx+0x3e)[0x7f251d181bde]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyEval_EvalCode+0x1b)[0x7f251d181c0b]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_FileExFlags+0xaa)[0x7f251d1b6f3a]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(PyRun_SimpleFileExFlags+0xfd)[0x7f251d1b70ad]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(+0x1e25e0)[0x7f251d1db5e0]
/home/noa/workspace/padic_project/sage/local/lib/libpython3.7m.so.1.0(_Py_UnixMain+0x49)[0x7f251d1db859]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f251cc29b97]
/home/noa/workspace/padic_project/sage/local/bin/python3(_start+0x2a)[0x558e97ef478a]
------------------------------------------------------------------------
```


The bug occurs because the element is set to the desirable absolute precision **before** it is shifted by p<sup>min_val</sup>. 

To fix this, I subtracted (min_val * ramification-index) from the absolute precision to which the element is set, so that **after** shifting it will hopefully reach the desirable precision.

However, this does not completely solve the problem, because in case p is not a power of the uniformizer, it's not necessary that shifting increases the absolute precision in exactly (min_val * ramification-index). So perhaps it would be best to set the absolute precision to the desirable value, only **after** the shifting (I didn't figure out how to do this correctly).

However, if it isn't necessary to have the exact desirable precision, the above solution could be enough.

Note: The issue of shifting after setting the precision, is also relevant for _set_from_list_abs(), which I changed similarly.

Issue created by migration from https://trac.sagemath.org/ticket/29927





---

archive/issue_comments_421551.json:
```json
{
    "body": "Attachment [set_from_list_both_crash_log](tarball://root/attachments/some-uuid/ticket29927/set_from_list_both_crash_log) by @n-vi created at 2020-06-21 21:05:49",
    "created_at": "2020-06-21T21:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421551",
    "user": "@n-vi"
}
```

Attachment [set_from_list_both_crash_log](tarball://root/attachments/some-uuid/ticket29927/set_from_list_both_crash_log) by @n-vi created at 2020-06-21 21:05:49



---

archive/issue_comments_421552.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-22T00:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421552",
    "user": "@n-vi"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421553.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-22T00:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421553",
    "user": "@n-vi"
}
```

New commits:



---

archive/issue_comments_421554.json:
```json
{
    "body": "this looks simple enough, but needs people that know the padics code",
    "created_at": "2020-09-08T10:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421554",
    "user": "chapoton"
}
```

this looks simple enough, but needs people that know the padics code



---

archive/issue_comments_421555.json:
```json
{
    "body": "gh-n-vi: I don't know a better way of contacting you. So, we're meeting every Thursday 3pm US/Eastern = 9pm CEST on Zulip (and then maybe in Zoom.) Feel free to join us if you want to discuss p-adics :)\nhttps://zulip.sagemath.org/#narrow/stream/15-padics",
    "created_at": "2020-09-08T15:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421555",
    "user": "saraedum"
}
```

gh-n-vi: I don't know a better way of contacting you. So, we're meeting every Thursday 3pm US/Eastern = 9pm CEST on Zulip (and then maybe in Zoom.) Feel free to join us if you want to discuss p-adics :)
https://zulip.sagemath.org/#narrow/stream/15-padics



---

archive/issue_comments_421556.json:
```json
{
    "body": "Replying to [comment:4 saraedum]:\n> gh-n-vi: I don't know a better way of contacting you. So, we're meeting every Thursday 3pm US/Eastern = 9pm CEST on Zulip (and then maybe in Zoom.) Feel free to join us if you want to discuss p-adics :)\n> https://zulip.sagemath.org/#narrow/stream/15-padics\nThanks saraedum, I would be glad to join the discussion!",
    "created_at": "2020-09-08T19:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421556",
    "user": "@n-vi"
}
```

Replying to [comment:4 saraedum]:
> gh-n-vi: I don't know a better way of contacting you. So, we're meeting every Thursday 3pm US/Eastern = 9pm CEST on Zulip (and then maybe in Zoom.) Feel free to join us if you want to discuss p-adics :)
> https://zulip.sagemath.org/#narrow/stream/15-padics
Thanks saraedum, I would be glad to join the discussion!



---

archive/issue_comments_421557.json:
```json
{
    "body": "Would you mind adding the first example to the doctests as well? (I read that it did not work originally, but it should now, right?)",
    "created_at": "2020-09-17T23:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421557",
    "user": "saraedum"
}
```

Would you mind adding the first example to the doctests as well? (I read that it did not work originally, but it should now, right?)



---

archive/issue_comments_421558.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-17T23:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421558",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_421559.json:
```json
{
    "body": "> However, this does not completely solve the problem, because in case p is not a power of the uniformizer, shifting doesn't necessarily increase the absolute precision by exactly (min_val * ramification-index).\n\nTrue. It's been a while since I looked at this. But isn't it at most off by one?\n\nIs this correct when `min_val` is positive?\n\n\n```\nself._set_from_ZZ_pX_abs(&(<ntl_ZZ_pX>ntl_ZZ_pX(L, ctx)).x, ctx, absprec - (min_val * self.parent().e()))\n```\n\n\nWhen `min_val` is large, wouldn't x be 0 modulo the precision then?\n\nIt seems to me that you have to do the shift (probably depending on the sign of `min_val`) and then reduce the precision to `absprec` explicitly again for this to be really correct. Is that what you tried originally? Feel free to ask on Zulip if you are not sure how to do this.",
    "created_at": "2020-09-17T23:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421559",
    "user": "saraedum"
}
```

> However, this does not completely solve the problem, because in case p is not a power of the uniformizer, shifting doesn't necessarily increase the absolute precision by exactly (min_val * ramification-index).

True. It's been a while since I looked at this. But isn't it at most off by one?

Is this correct when `min_val` is positive?


```
self._set_from_ZZ_pX_abs(&(<ntl_ZZ_pX>ntl_ZZ_pX(L, ctx)).x, ctx, absprec - (min_val * self.parent().e()))
```


When `min_val` is large, wouldn't x be 0 modulo the precision then?

It seems to me that you have to do the shift (probably depending on the sign of `min_val`) and then reduce the precision to `absprec` explicitly again for this to be really correct. Is that what you tried originally? Feel free to ask on Zulip if you are not sure how to do this.



---

archive/issue_comments_421560.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-21T17:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421560",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421561.json:
```json
{
    "body": "Hi Julian, thank you for the review! \n\n* I have added the first example as you suggested.\n* Regarding the question of the increase in the absolute-precision when shifting by p<sup>min_val</sup> : \n  Rethinking about the subject, it seems to me that perhaps the absolute-precision is actually increased by exactly (min_val * ramification-index). \n  Here is a proof (if anything in the process is wrong, I will appreciate any corrections!):\nDenote the original number by x, the uniformizer by u, the ramification index by e, and min_val by n.\n1. The valuation of p always equals e. Therefore the valuation of p<sup>n</sup> is e*n. \n   Denote: p<sup>n</sup> = a0*(u<sup>e*n</sup>) + a1*(u<sup>e*n+1</sup>) + a2*(u<sup>e*n+2</sup>) +...\n2. x*p<sup>n</sup> = (x*a0*(u<sup>e*n</sup>)) + (x*a1*(u<sup>e*n+1</sup>)) + (x*a2*(u<sup>e*n+2</sup>)) +... \n3. The absolute-precision of x*p<sup>n</sup> equals the absolute-precision of the element which has the lowest absolute-precision among those in the sum.\n4. For each i>=0, (x*ai*(u<sup>e*n+i</sup>)).absolute_precision() = x.absolute_precision() + e*n+i.\n5. 3. and 4. imply that: (x*p<sup>n</sup>).absolute_precision() = (x*a0*(u<sup>e*n</sup>)).absolute_precision() = x.absolute_precision() + e*n.\nTherefore, the absolute-precision has indeed been increased by exactly e*n.\n* Correctness in case min_val is positive:\n  Denote the valuation of x by v, and: x = a0*(u<sup>v</sup>) + a1*(u<sup>v+1</sup>) + ... \n  If the i-th element in this sum is truncated when setting the precision of x to  (absprec - (min_val * e)), it means that i >= (absprec - (min_val * e)). \n  Now, I claim that this element would also be truncated if we set the precision after the shifting. Let's assume for simplicity that p is a power of the uniformizer: p=u<sup>e</sup>, which implies that: p<sup>min_val</sup>=u<sup>min_val*e</sup>. \n  We need to shift x by p<sup>min_val</sup> and then truncate its precision to absprec. \n  So the i-th element is shifted by min_val*e entries, and now equals: ai*(u<sup>v+i+min_val*e</sup>). \n  Now we set the result (x*p<sup>min_val</sup>) to precision absprec. We assumed that i >= (absprec - (min_val * e)). Therefore i+min_val*e >= absprec, which implies that this element (ai*(u<sup>v+i+min_val*e</sup>)) is truncated. \n  Therefore I think that if min_val is large enough so that x is 0 modolu (absprec - (min_val * e)), it is O.K because x would be truncated either way. Am I right in this deduction?\n\n* The problem I had with changing the precision after the shifting, is that I don't know how to increase precision of elements (the only method I found to be relevant is lift_to_precision, but it does not guarantee that the new entries that are added to the element are zero-entries). So if I wanted to do this, I would have to make sure that the precision needs to be decreased rather than increased.",
    "created_at": "2020-09-21T18:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421561",
    "user": "@n-vi"
}
```

Hi Julian, thank you for the review! 

* I have added the first example as you suggested.
* Regarding the question of the increase in the absolute-precision when shifting by p<sup>min_val</sup> : 
  Rethinking about the subject, it seems to me that perhaps the absolute-precision is actually increased by exactly (min_val * ramification-index). 
  Here is a proof (if anything in the process is wrong, I will appreciate any corrections!):
Denote the original number by x, the uniformizer by u, the ramification index by e, and min_val by n.
1. The valuation of p always equals e. Therefore the valuation of p<sup>n</sup> is e*n. 
   Denote: p<sup>n</sup> = a0*(u<sup>e*n</sup>) + a1*(u<sup>e*n+1</sup>) + a2*(u<sup>e*n+2</sup>) +...
2. x*p<sup>n</sup> = (x*a0*(u<sup>e*n</sup>)) + (x*a1*(u<sup>e*n+1</sup>)) + (x*a2*(u<sup>e*n+2</sup>)) +... 
3. The absolute-precision of x*p<sup>n</sup> equals the absolute-precision of the element which has the lowest absolute-precision among those in the sum.
4. For each i>=0, (x*ai*(u<sup>e*n+i</sup>)).absolute_precision() = x.absolute_precision() + e*n+i.
5. 3. and 4. imply that: (x*p<sup>n</sup>).absolute_precision() = (x*a0*(u<sup>e*n</sup>)).absolute_precision() = x.absolute_precision() + e*n.
Therefore, the absolute-precision has indeed been increased by exactly e*n.
* Correctness in case min_val is positive:
  Denote the valuation of x by v, and: x = a0*(u<sup>v</sup>) + a1*(u<sup>v+1</sup>) + ... 
  If the i-th element in this sum is truncated when setting the precision of x to  (absprec - (min_val * e)), it means that i >= (absprec - (min_val * e)). 
  Now, I claim that this element would also be truncated if we set the precision after the shifting. Let's assume for simplicity that p is a power of the uniformizer: p=u<sup>e</sup>, which implies that: p<sup>min_val</sup>=u<sup>min_val*e</sup>. 
  We need to shift x by p<sup>min_val</sup> and then truncate its precision to absprec. 
  So the i-th element is shifted by min_val*e entries, and now equals: ai*(u<sup>v+i+min_val*e</sup>). 
  Now we set the result (x*p<sup>min_val</sup>) to precision absprec. We assumed that i >= (absprec - (min_val * e)). Therefore i+min_val*e >= absprec, which implies that this element (ai*(u<sup>v+i+min_val*e</sup>)) is truncated. 
  Therefore I think that if min_val is large enough so that x is 0 modolu (absprec - (min_val * e)), it is O.K because x would be truncated either way. Am I right in this deduction?

* The problem I had with changing the precision after the shifting, is that I don't know how to increase precision of elements (the only method I found to be relevant is lift_to_precision, but it does not guarantee that the new entries that are added to the element are zero-entries). So if I wanted to do this, I would have to make sure that the precision needs to be decreased rather than increased.



---

archive/issue_comments_421562.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-21T18:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421562",
    "user": "@n-vi"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421563.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421563",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_421564.json:
```json
{
    "body": ">  Therefore I think that if min_val is large enough so that x is 0 modolu (absprec - (min_val * e)), it is O.K because x would be truncated either way. Am I right in this deduction?\n\nIt was my understanding that this code also used for capped-relative p-adics? In that case I don't think that this is correct.",
    "created_at": "2021-05-03T22:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421564",
    "user": "saraedum"
}
```

>  Therefore I think that if min_val is large enough so that x is 0 modolu (absprec - (min_val * e)), it is O.K because x would be truncated either way. Am I right in this deduction?

It was my understanding that this code also used for capped-relative p-adics? In that case I don't think that this is correct.



---

archive/issue_comments_421565.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-03T22:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421565",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421566.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-05-03T22:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421566",
    "user": "saraedum"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_421567.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421567",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_421568.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-01T10:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421568",
    "user": "@n-vi"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421569.json:
```json
{
    "body": "Replying to [comment:13 saraedum]:\n> \n> It was my understanding that this code also used for capped-relative p-adics? In that case I don't think that this is correct.\nHi Julian!\nSorry about the very-long-delay in answering your comment. \\\\\nCan you please explain, or give an example, why there should be a problem with the capped-relative case? I tried to think about it but didn't manage to figure out myself.\\\\\nThank you!",
    "created_at": "2022-02-01T10:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421569",
    "user": "@n-vi"
}
```

Replying to [comment:13 saraedum]:
> 
> It was my understanding that this code also used for capped-relative p-adics? In that case I don't think that this is correct.
Hi Julian!
Sorry about the very-long-delay in answering your comment. \\
Can you please explain, or give an example, why there should be a problem with the capped-relative case? I tried to think about it but didn't manage to figure out myself.\\
Thank you!



---

archive/issue_comments_421570.json:
```json
{
    "body": "I made some minor modifications to the documentation. If these look good to you, feel free to set this to positive review.\n\nSorry, for getting you wrong the first time and delaying this forever in doing so. The `relprec` in the docstring confused me when it should have been `absprec`.\n----\nNew commits:",
    "created_at": "2022-02-23T06:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421570",
    "user": "saraedum"
}
```

I made some minor modifications to the documentation. If these look good to you, feel free to set this to positive review.

Sorry, for getting you wrong the first time and delaying this forever in doing so. The `relprec` in the docstring confused me when it should have been `absprec`.
----
New commits:



---

archive/issue_comments_421571.json:
```json
{
    "body": "This is great, thank you Julian! The documentation was indeed misleading here...",
    "created_at": "2022-02-23T06:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421571",
    "user": "@n-vi"
}
```

This is great, thank you Julian! The documentation was indeed misleading here...



---

archive/issue_comments_421572.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-23T06:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421572",
    "user": "@n-vi"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421573.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-27T22:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29690#issuecomment-421573",
    "user": "vbraun"
}
```

Resolution: fixed
