# Issue 16197: Package d3.js

Issue created by migration from https://trac.sagemath.org/ticket/16434

Original creator: tmonteil

Original creation time: 2014-06-03 19:09:00

Assignee: tmonteil

CC:  ncohen bonfroy

Keywords: d3.js

#14953 uses online `3d.js` script. The aim of this ticket is to provide it as a package for offline use.


---

Comment by tmonteil created at 2014-06-04 09:38:17

Changing status from new to needs_review.


---

Comment by tmonteil created at 2014-06-04 09:38:17

Changing component from packages: standard to packages: optional.


---

Comment by tmonteil created at 2014-06-04 09:38:17

The tarball (which was produced with sage-src) can be downloaded from https://lipn.univ-paris13.fr/~monteil/hebergement/sage/d3js-3.4.8.tar.gz
----
New commits:


---

Comment by ncohen created at 2014-06-04 12:29:42

Yo !

Looks like you should not "move" an archive to upstream/. It looked a bit weird to be, and it seems that other sage-src script only fill the "src" directory with the right stuff. Like for ecl/ or ntl/ ...

Nathann


---

Comment by tmonteil created at 2014-06-04 13:02:36

Well, i need to have the tarball in upstream/ to compute the new checksums.ini automatically. To my understanding [the spkg-src script](http://www.sagemath.org/doc/developer/packaging.html#section-spkg-src) is used by the maintainer to ease rebuilding future versions, this is why i put the whole build process here (i also hesitated to create a ticket, push changes and ask for review on the fly ;). If you want, i can move it back to the work/ directory after building checksums.ini, but this does only affect the maintainer's upstream/ directory.


---

Comment by ncohen created at 2014-06-04 13:08:15

Yo !

> Well, i need to have the tarball in upstream/ to compute the new checksums.ini automatically.

None of the other spkg do that.

> To my understanding [the spkg-src script](http://www.sagemath.org/doc/developer/packaging.html#section-spkg-src) is used by the maintainer to ease rebuilding future versions, this is why i put the whole build process here (i also hesitated to create a ticket, push changes and ask for review on the fly ;). If you want, i can move it back to the work/ directory after building checksums.ini, but this does only affect the maintainer's upstream/ directory.

First I think that it is meant to be the "src" directory, not the "work/" directory. Isn't sage -pkg meant to deal with that ? Either way I guess that the solution here should be global. If every package tries to solve this in a different way we are going nowhere `O_o`

Nathann


---

Comment by ncohen created at 2014-06-04 14:36:39

Changing status from needs_review to needs_info.


---

Comment by tmonteil created at 2014-06-04 15:26:27

Replying to [comment:5 ncohen]:
> Yo !

Hi Nathann and thanks for caring,

it is fun that i asked myself all those questions yesterday night, and i
could not find an answer within the existing spkgs or the doc (another was
whether i should call the spkg d3, d3js or d3_js).

    find -name spkg-src -exec echo '{}' \; -exec cat '{}' \; | less

There seem to be no rule concerning the spkg-src script. The patterns you
may discover between some of the spkg-src scripts only come from the fact
that pieces are copied from one to another. For example, some script
hardcode the version (e.g. ecl, so it needs to be modified by hand before
being run), some write 'Run this after extracting the upstream sources in
src/' (e.g. iml), some use curl (e.g ntl), other wget (e.g. cddlib), some
create the final tarball (e.g. gap), some only fill a src/ directory (e.g.
ntl), some apply patches while it is supposed to happen during spkg
installation (e.g. lrcalc), some are written in python (e.g. maxima).


> First I think that it is meant to be the "src" directory, not the
> "work/" directory. 

Actually, the semantics of what represents 'src' is not even constant
among existing scripts, which is more confusing than each having a
different name. Some download the tarball within the src/ directory and
work in there (e.g. singular), some extract the source in src/, some
extract outside and move interesting stuff in src/ (e.g. gap_packages),
some work directly within the upstream/ directory (e.g. autotools, which
by the way lets the tarball in the maintainer's upstream/ directory).

Here, it is clear that work/ is where the script works (stuff that come
here will not necessarily end in the produced tarball), it should even be
called tmp_work/. I do not like to fetch things directely within the spkg
directory, because then i have to remove them one by one (it is easier to
remove a single subdirectory). I could create a src/ directory within the
work/ directory, this would make sense, but since the tarball contains
only two files ('d3.min.js' and 'LICENSE') i didn't think it was worth
putting them in a separate directory before creating the tarball, but it
is possible if you think it may help.

> > Well, i need to have the tarball in upstream/ to compute the new
> > checksums.ini automatically.
> 
> None of the other spkg do that.

Actually, autotools spkg-src already puts its tarball in the upstream/
directory.

If some other maintainers like to do some complementary work by hand, it
is fine, if they want me to do this as well by having only part of the
maintenance script made public within spkg-src, then i can write my own
proprietary meta-spkg-src script so that other maintainers of this package
will also have to write their own, or work by hand.

I think this is in the spirit of the documentation that says : "This not
only serves as documentation but also makes it easier to apply the same
modifications to future versions". So, let us be the first to add this
feature, so that future spkgs could benefit from this example and will
have less hand work at each new release.

> Either way I guess that the solution here should be global. If every
> package tries to solve this in a different way we are going nowhere
> `O_o`

I totally agree, but this is already the case. Adding confusion by using a
name which already has different purposes only adds confusion.

Instead, we could have a specification somewhere since existing spkg-src
are far from being consistent.

> Isn't sage -pkg meant to deal with that ?

The sage-pkg script seems to be used for old-style spkg as it still uses
mercurial.


---

Comment by ncohen created at 2014-06-04 17:43:05

Yoooooooo !

> Hi Nathann and thanks for caring,

My pleasure. I am so sick of watching all my patches in needs_review and all the code I have yet to submit stuck because of endless nitpicking that I am actually glad to participate to some honest work... `>_<`

> it is fun that i asked myself all those questions yesterday night, and i
> could not find an answer within the existing spkgs or the doc (another was
> whether i should call the spkg d3, d3js or d3_js).
> 
>     find -name spkg-src -exec echo '{}' \; -exec cat '{}' \; | less

Hey by the way... Once a student of mine showed me a different way to do stuff like that, which is actually MUCH more powerful :


```
find . -iname "spkg-src" | while read line; do echo $line; cat $line; done
```


> There seem to be no rule concerning the spkg-src script. The patterns you
> may discover between some of the spkg-src scripts only come from the fact
> that pieces are copied from one to another.

Okayokay.

> remove a single subdirectory). I could create a src/ directory within the
> work/ directory, this would make sense, but since the tarball contains
> only two files ('d3.min.js' and 'LICENSE') i didn't think it was worth
> putting them in a separate directory before creating the tarball, but it
> is possible if you think it may help.

Well, I see no reason, you did the work right...

> Actually, autotools spkg-src already puts its tarball in the upstream/
> directory.

I see. Could you use SAGE_ROOT/upstream instead of ../../../../ btw ? I did this kind of things a long time ago and several generations of release managers cursed me for it `:-P`

Nathann


---

Comment by ncohen created at 2014-06-04 17:55:44

Just tried it, works for me. It woudl be cool if you can replace this ../../../ by a SAGE_ROOT, and then it can go.

Nathann


---

Comment by tmonteil created at 2014-06-04 19:24:24

Hmm, it does not work for me, did you set `SAGE_ROOT` somewhere ? Or did you run the script within `sage -sh` ?


---

Comment by jhpalmieri created at 2014-06-04 19:49:36

Try `$SAGE_ROOT`.


---

Comment by git created at 2014-06-04 20:06:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2014-06-04 20:10:40

Changing status from needs_info to needs_review.


---

Comment by tmonteil created at 2014-06-04 20:10:40

Done. The script forges `SAGE_ROOT` as `"$(pwd)/../../../"` in case the variable is not set as a backup. I also add `set -e` at the beginning in order not to mess everything up if something get wrong (e.g. if the archive can not be fetched by lack of network).


---

Comment by ncohen created at 2014-06-05 07:00:25

Funny, I did not know this option `:-)`

Nathann


---

Comment by ncohen created at 2014-06-05 07:02:23

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-06-05 07:02:23

Thanks for this patch !

Nathann


---

Comment by ncohen created at 2014-06-05 07:09:06

Arggggggg.... Sorry I just noticed something... Could you build your package in a different way ? Right now when you run "tar xvzf tar xzvf d3js-3.4.8.tar.gz" the files are extracted into the current directory, and that's a bit messy `:-/`

Nathann


---

Comment by git created at 2014-06-05 10:03:30

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-06-05 10:03:30

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by tmonteil created at 2014-06-05 10:07:08

You are right, for two files i was thinking that is was not an issue since the build dir get destroyed anyway, but i didn-t think a human could be interested in unpacking the tarball. I updated the source tarball accordingly.


---

Comment by ncohen created at 2014-06-05 10:42:34

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-06-05 10:42:34

Thanks ! It still works, sooo.... `:-)`

Nathann


---

Comment by vbraun created at 2014-06-06 11:00:40

Resolution: fixed


---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "d3.js" to "d3.js, sdl".
