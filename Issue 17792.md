# Issue 17792: speed up integral point enumeration

Issue created by migration from https://trac.sagemath.org/ticket/18029

Original creator: vdelecroix

Original creation time: 2015-03-21 13:23:39

CC:  novoselt tscrim winfried

Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17652) and more.


---

Comment by tscrim created at 2016-07-08 06:38:15

I was able to get ~15% speedup:

```
sage: sage: ieqs = [(-1, -1, -1, -1, -1, -1, -1, -1, -1),
....:         (0, -1, 0, 0, 0, 0, 0, 0, 0),
....:         (0, -1, 0, 2, -1, 0, 0, 0, 0),
....:         (0, 0, -1, -1, 2, -1, 0, 0, 0),
....:         (0, 2, 0, -1, 0, 0, 0, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, -1, 2),
....:         (1, 0, 2, 0, -1, 0, 0, 0, 0),
....:         (0, 0, 0, 0, -1, 2, -1, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, 0, -1),
....:         (0, 0, 0, 0, 0, -1, 2, -1, 0),
....:         (0, 0, 0, 0, 0, 0, -1, 2, -1)]
sage: P = Polyhedron(ieqs=ieqs)
sage: %time len(P.integral_points())
CPU times: user 12.4 s, sys: 5 Âµs, total: 12.4 s
Wall time: 12.4 s
4
```

In the current version, this takes ~14s. There is also some improvement for the simplex approach:

```
sage: from sage.geometry.integral_points import simplex_points
sage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)] 
sage: simplex = Polyhedron(v); simplexA 4-dimensional polyhedron in ZZ^4 defined as the convex hull of 5 vertices
sage: %timeit len(simplex_points(simplex.vertices()))
100 loops, best of 3: 15.1 ms per loop
```

vs

```
10 loops, best of 3: 24.1 ms per loop
```


I used all the tricks that I know to squeeze speed out with doing any rewrites. However, it would be better to implement/use a priority queue (or linked list) data structure instead of a straight list for the inequalities since we are often moving one to the front as part of the algorithm.
Yet I think this is a good gain and should be included in the present state (unless someone feels like doing something more invasive, which I would then review).
----
New commits:


---

Comment by tscrim created at 2016-07-08 06:39:45

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-07-17 13:57:43

normaliz input


---

Attachment

This looks fine, but let me point out that the performance of this code is very far from the state of the art.
The first example in dimension 8 is solved by normaliz in 0.1s (I have attached an input file for normaliz). So a simple interface to normaliz (#20885) would bring huge speedups.


---

Comment by mkoeppe created at 2016-07-17 14:49:59

That said, of course it's nice to have a basic, generic implementation in Sage if one does not want to install normaliz; but it turns out that the implementation is actually not very generic (#21037).


---

Comment by git created at 2016-07-17 23:05:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-07-17 23:11:56

FYI - this merged cleanly with #21037.


---

Comment by mkoeppe created at 2016-07-17 23:32:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2016-07-17 23:32:54

Looks good.

So... how about that normaliz interface?


---

Comment by git created at 2016-07-17 23:39:47

Changing status from positive_review to needs_review.


---

Comment by git created at 2016-07-17 23:39:47

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by tscrim created at 2016-07-17 23:42:18

Replying to [comment:10 mkoeppe]:
> Looks good.

Sorry, I found one other place where I got another `.4s` in the above example.

> So... how about that normaliz interface?

That's quite a difference, and it would be great to have it available (and be extremely useful to me to have integral points that fast). I don't know how much I could help it writing the interface; I know somewhat how to write the cython bindings, but not what to use/expose from noraliz. I will definitely be happy to review it.


---

Comment by tscrim created at 2016-07-18 14:50:43

Just in case you didn't see it, could you check my last push?


---

Comment by mkoeppe created at 2016-07-18 15:01:52

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-07-18 15:07:29

Thank you.


---

Comment by vbraun created at 2016-07-19 06:44:53

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-07-19 07:03:12

You need to use an `except` value when you have a `c(p)def` function with a return type: replace `cpdef bint ...(...)` by `cpdef bint ...(...) except -1`.

And since you seem to like Cython micro-optimizations a lot in this ticket, you missed an obvious one: setting the `boundscheck` and `wraparound` [directives](http://docs.cython.org/src/reference/compilation.html#compiler-directives) to `False` to speed up list indexing.


---

Comment by jdemeyer created at 2016-07-19 07:09:21

I should also add that declaring the type of a variable or return value may or may not speed up the code. You gain if Cython can use special optimizations for that type. But you lose if Cython needs to add pointless checks that the thing you are assigning to the variable has the correct type.

Deciding whether to declare the type of a variable should be done on a case-on-case basis, it's not a general rule that you should declare as much types as possible.


---

Comment by git created at 2016-08-03 15:22:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-03 15:26:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2016-08-03 15:31:05

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-08-03 15:31:05

I've added the Cython directives (I didn't know about them, thank you), and I've added a few more type declarations. I believe I have made it so once the type is known, it is kept that way so Cython should never have to recheck the type of things.


---

Comment by tscrim created at 2016-08-03 15:31:47

I've also added the `except -1` to the necessary `c(p)def` methods.


---

Comment by mkoeppe created at 2016-08-03 19:11:46

It builds and works OK.
Jeroen, could you take another look?


---

Comment by tscrim created at 2016-08-09 23:19:29

Jeroen, if you have a minute, could you check my most recent changes? Thanks.


---

Comment by tscrim created at 2016-10-28 04:37:04

Ping?


---

Comment by mkoeppe created at 2016-11-26 06:27:06

#20885 now has an implementation of `integer_points` using normaliz.


---

Comment by mkoeppe created at 2016-11-27 02:02:44

This ticket would need rebasing also.


---

Comment by git created at 2016-11-27 11:37:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-11-27 11:39:07

Rebased. It would be nice to finalize this and get this in until #20885 gets merged and becomes the default.


---

Comment by mkoeppe created at 2016-11-27 20:42:56

By the way, I noticed the following bug in Sage (without this branch -- haven't tested yet with this branch!):

```
sage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()
...
/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)
   4357                 box_points<threshold:
   4358             from sage.geometry.integral_points import rectangular_box_points
-> 4359             return rectangular_box_points(box_min, box_max, self)
   4360 
   4361         # for more complicate polytopes, triangulate & use smith normal form

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()
    552     v = vector(ZZ, d)
    553     if not return_saturated:
--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):
    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow
    556             for i in range(0,d):

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()
    601     while True:
    602         sig_check()
--> 603         inequalities.prepare_inner_loop(p)
    604         i_min = box_min[0]
    605         i_max = box_max[0]

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()
   1256         """
   1257         for ineq in self.ineqs_int:
-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)
   1259         for ineq in self.ineqs_generic:
   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()
    938         cdef int j
    939         if self.dim>1:
--> 940             self.cache = self.cache_next + self.coeff_next*p[1]
    941         else:
    942             self.cache = self.cache_next

OverflowError: value too large to convert to int
```


(I can make this a separate ticket if that's better.)

----
New commits:


---

Comment by mkoeppe created at 2016-11-27 21:28:24

(same error also with this branch).


---

Comment by tscrim created at 2016-11-29 13:43:24

I think that should be a separate ticket. (It likely might just be changing some `int` to `long`...)


---

Comment by mkoeppe created at 2016-11-29 19:08:26

That's now #21993.


---

Comment by mkoeppe created at 2016-12-08 19:18:15

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2016-12-08 19:18:15

Looks good to me.
I'm setting this to positive review -- but Jeroen may have more comments.


---

Comment by vbraun created at 2016-12-10 12:38:20

Resolution: fixed
