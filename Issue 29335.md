# Issue 29335: Fix perl_term_readline_gnu build error on conda-forge-macos-maximal

Issue created by migration from https://trac.sagemath.org/ticket/29572

Original creator: mkoeppe

Original creation time: 2020-04-24 23:43:10

CC:  isuruf saraedum dimpase

https://github.com/mkoeppe/sage/runs/612692498


---

Comment by isuruf created at 2020-04-25 00:32:03

I'm not sure why it's picking up the readline package from macOS.


---

Comment by isuruf created at 2020-04-25 00:39:43

I know why. perl_term_readline_gnu is not using `CFLAGS` env variable


---

Comment by isuruf created at 2020-04-25 00:49:20

spkg-install.in should pass the path of readline to `Makefile.PL` using `--incpath=`


---

Comment by isuruf created at 2020-04-25 00:52:03

`incdir`, sorry.


---

Comment by isuruf created at 2020-04-25 00:56:10

Should have been `includedir` and `libdir`


---

Comment by mkoeppe created at 2020-04-25 01:18:25

I see. Related: #29000


---

Comment by dimpase created at 2020-04-25 02:35:43

OK, I'm going to fix #29000, creating env vars `SAGE_READLINE_INCDIR` and
`SAGE_READLINE_LIBDIR` - it would help if you tell me what needs to change here, like

```diff
- perl Makefile.PL --prefix="$SAGE_LOCAL" INSTALL_BASE="$SAGE_LOCAL"
+ perl Makefile.PL --prefix="$SAGE_LOCAL" INSTALL_BASE="$SAGE_LOCAL" \ 
+ --includedir=$SAGE_READLINE_INCDIR --libdir=$SAGE_READLINE_LIBDIR 
```

Does this look right?


---

Comment by isuruf created at 2020-04-25 02:38:14

You don't need the prefix there.


```
perl Makefile.PL --includedir=$SAGE_READLINE_INCDIR --libdir=$SAGE_READLINE_LIBDIR INSTALL_BASE="$SAGE_LOCAL" 
```



---

Comment by isuruf created at 2020-04-27 05:00:27

Can you try something like,


```
--- Makefile.PL 2020-04-27 04:21:25.239877458 +0000
+++ Makefile.PL.old     2020-04-27 04:19:41.682872176 +0000
@@ -138,14 +138,14 @@
      VERSION_FROM => 'Gnu.pm',
      MIN_PERL_VERSION => '5.8.1',
      LIBS        => [ "$RLLIB $libs" ],
-     LDDLFLAGS   => "$RLLIB $Config{lddlflags} $ENV{LDFLAGS}",                                                                                                       
+     LDDLFLAGS   => "$RLLIB $Config{lddlflags}",                                                                                                                     
      dynamic_lib  => { OTHERLDFLAGS => $lddflags },                                                                                                                  
      DEFINE      => $defs,                                                                                                                                           
      ($Config{osname} eq 'os2' ?                                                                                                                                     
       (
        IMPORTS   => { xfree => 'emxlibcm.401' }, # Yuck!
       ) : () ),
-     INC         => "$RLINC $ENV{CFLAGS}",
+     INC         => $RLINC,
      dist        => { COMPRESS => 'gzip -9f', SUFFIX => 'gz' },
      clean       => { FILES => "rlver.c rlver$Config{_exe} rlmalloc.c rlmalloc$Config{_exe}" },
 );
```



---

Comment by isuruf created at 2020-04-29 20:55:17

`@`mkoeppe, can you try the patch above?


---

Comment by mkoeppe created at 2020-04-30 00:11:59

Thanks, will try


---

Comment by mkoeppe created at 2020-04-30 01:09:57

Just quickly checked that 1.36 does not contain an immediate fix for the problem (#29623)


---

Comment by isuruf created at 2020-04-30 01:22:28

That patch should be reversed. Sorry about that.


---

Comment by mkoeppe created at 2020-04-30 01:44:41

Sure.


---

Comment by mkoeppe created at 2020-04-30 01:45:33

But I don't think this is the right fix. I'd think it's dangerous to mix the Perl-provided flags with the general CFLAGS, LDFLAGS


---

Comment by mkoeppe created at 2020-04-30 01:46:32

So I think it's better to go through #29000


---

Comment by isuruf created at 2020-04-30 01:50:35

I disagree. CFLAGS and LDFLAGS from the environment should be respected by any build system. I don't think its dangerous to mix these flags. Almost all spkgs pass through CFLAGS and LDFLAGS.


---

Comment by mkoeppe created at 2020-04-30 02:10:36

OK, I'll try it


---

Comment by isuruf created at 2020-04-30 02:25:14

Thanks for that link. Maybe the following will work.


```
export PERL_MM_OPT="INC=\"${CFLAGS}\" LDDLFLAGS=\"${LDFLAGS}\""
```



---

Comment by mkoeppe created at 2020-04-30 03:27:55

Your patch from comment 10 seems to work on macOS. I try with the other approach too,
and then a test on more platforms will be necessary


---

Comment by mkoeppe created at 2020-04-30 03:32:46

New commits:


---

Comment by mkoeppe created at 2020-04-30 03:49:57

Tests running at https://github.com/mkoeppe/sage/actions/runs/91785670


---

Comment by mkoeppe created at 2020-04-30 03:52:58

Replying to [comment:21 isuruf]:
> Thanks for that link. Maybe the following will work.
> 
> {{{
> export PERL_MM_OPT="INC=\"${CFLAGS}\" LDDLFLAGS=\"${LDFLAGS}\""
> }}}
Does not work as is, causes linker errors, probably too much of Perl's stuff is overwrittten:

```
x86_64-apple-darwin13.4.0-clang  -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-conda-forge-macos-maximal/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-conda-forge-macos-maximal/local/lib -Wl,-pie -Wl,-headerpad_max_install_names -Wl,-dead_strip_dylibs -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-conda-forge-macos-maximal/conda/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-conda-forge-macos-maximal/conda/lib Gnu.o  -o blib/arch/auto/Term/ReadLine/Gnu/Gnu.bundle  \
      \
  
Undefined symbols for architecture x86_64:
  "_PL_thr_key", referenced from:
      _boot_Term__ReadLine__Gnu in Gnu.o
      _XS_Term__ReadLine__Gnu__XS_rl_readline in Gnu.o
      _XS_Term__ReadLine__Gnu__XS_rl_add_defun in Gnu.o
      _XS_Term__ReadLine__Gnu__XS_rl_make_bare_keymap in Gnu.o
      _XS_Term__ReadLine__Gnu__XS__rl_copy_keymap in Gnu.o
      _XS_Term__ReadLine__Gnu__XS_rl_make_keymap in Gnu.o
      _XS_Term__ReadLine__Gnu__XS__rl_discard_keymap in Gnu.o
      ...
  "_PerlIO_debug", referenced from:
      _XS_Term__ReadLine__Gnu__Var__rl_store_iostream in Gnu.o
  "_PerlIO_findFILE", referenced from:
      _XS_Term__ReadLine__Gnu__XS_rl_getc in Gnu.o
      _XS_Term__ReadLine__Gnu__Var__rl_store_iostream in Gnu.o
  "_Perl_av_fetch", referenced from:
      _XS_Term__ReadLine__Gnu__XS_rl_display_match_list in Gnu.o
  "_Perl_av_len", referenced from:
      _XS_Term__ReadLine__Gnu__XS_rl_display_match_list in Gnu.o
  "_Perl_av_push", referenced from:
      _completion_display_matches_hook_wrapper in Gnu.o
  "_Perl_call_sv", referenced from:
```



---

Comment by isuruf created at 2020-04-30 13:58:48

Thanks. I guess we'll have to go with patching. Is this ready for review?


---

Comment by mkoeppe created at 2020-04-30 15:43:47

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-30 15:43:47

I haven't yet had a chance to look at the test results


---

Comment by mkoeppe created at 2020-05-01 01:31:29

More tests at https://github.com/mkoeppe/sage/actions/runs/92681498


---

Comment by mkoeppe created at 2020-05-01 03:38:31

On `docker-conda-forge-standard` (https://github.com/mkoeppe/sage/runs/635176678):

```
Checking whether SageMath should install SPKG readline...
checking Installing ncurses? ... No.
checking for readline >= 6.0... yes
configure: will use system package and not install SPKG readline

****************************************************
Package 'perl_term_readline_gnu' is currently not installed
No legacy uninstaller found for 'perl_term_readline_gnu'; nothing to do
/opt/conda/bin/..//bin/x86_64-conda_cos6-linux-gnu-gcc -I/sage/local/include -D_REENTRANT -D_GNU_SOURCE --sysroot=/opt/conda/bin/..//x86_64-conda_cos6-linux-gnu/sysroot -fwrapv -fno-strict-aliasing -pipe -fstack-protector-strong -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -D_FORTIFY_SOURCE=2 -DHAVE_STRING_H -O rlver.c -o rlver -L/sage/local/lib  -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib -fstack-protector-strong -lreadline -lncurses
rlver.c:3:10: fatal error: readline/readline.h: No such file or directory
 #include <readline/readline.h>
          ^~~~~~~~~~~~~~~~~~~~~
compilation terminated.
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Could not compile rlver.c.

system(): Inappropriate ioctl for device

If you have installed the GNU Readline Library (libreadline.{a,so} and
readline/readline.h, etc.) on directories for which your perl is not
configured to search (refer the value of `ccflags' and `libpath' in
the output of `perl -V'), specify the paths as follows;
```

(`docker pull docker.pkg.github.com/mkoeppe/sage/sage-docker-conda-forge-standard-with-targets:9.1.rc0-66608-g98b8231a35-failed`)


Same on `docker-conda-forge-minimal` (https://github.com/mkoeppe/sage/runs/635176663?check_suite_focus=true) and `local-conda-forge-ubuntu-minimal (https://github.com/mkoeppe/sage/runs/635175780?check_suite_focus=true), all of which also have a system readline.


---

Comment by isuruf created at 2020-05-01 04:40:27

New commits:


---

Comment by mkoeppe created at 2020-05-01 04:46:41

Testing again at https://github.com/mkoeppe/sage/actions/runs/92798013


---

Comment by mkoeppe created at 2020-05-01 05:58:40

Patch does not apply...
Could you just send me a pull request at https://github.com/mkoeppe/Term-Readline-Gnu.git, then I can regenerate the patch


---

Comment by isuruf created at 2020-05-01 06:16:08

https://github.com/mkoeppe/Term-Readline-Gnu/pull/1


---

Comment by mkoeppe created at 2020-05-01 06:29:26

New run at https://github.com/mkoeppe/sage/actions/runs/92850133
----
New commits:


---

Comment by isuruf created at 2020-05-01 06:42:20

One more change, https://github.com/mkoeppe/Term-Readline-Gnu/pull/3


---

Comment by isuruf created at 2020-05-01 17:47:12

Looks like the patch failed to apply.


---

Comment by mkoeppe created at 2020-05-01 17:52:27

Yes, looks like I messed up the merge into my testing branch


---

Comment by git created at 2020-05-01 21:56:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-01 21:58:07

Another run: https://github.com/mkoeppe/sage/actions/runs/93430178


---

Comment by mkoeppe created at 2020-05-02 00:44:26

Build error on `conda-forge-macos-standard`:

```
LD_RUN_PATH="/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib" x86_64-apple-darwin13.4.0-clang  -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -Wl,-pie -Wl,-headerpad_max_install_names -Wl,-dead_strip_dylibs -Wl,-rpath,/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib -mmacosx-version-min=10.9 -bundle -undefined dynamic_lookup --sysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk -fstack-protector-strong -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -Wl,-rpath,/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -Wl,-pie -Wl,-headerpad_max_install_names -Wl,-dead_strip_dylibs -Wl,-rpath,/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib Gnu.o  -o blib/arch/auto/Term/ReadLine/Gnu/Gnu.bundle  \
   -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -Wl,-R/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib -Wl,-pie -Wl,-headerpad_max_install_names -Wl,-dead_strip_dylibs -Wl,-R/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib -L/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/conda/lib -lreadline -lncurses   \
  
clang-9: warning: argument unused during compilation: '--sysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk' [-Wunused-command-line-argument]
ld: unknown option: -R/Users/runner/runners/2.169.1/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib
clang-9: error: linker command failed with exit code 1 (use -v to see invocation)
make[2]: *** [Makefile:494: blib/arch/auto/Term/ReadLine/Gnu/Gnu.bundle] Error 1
```



---

Comment by mkoeppe created at 2020-05-02 00:47:41

(The failure for `fedora` are unrelated, some system package did not install properly.)


---

Comment by mkoeppe created at 2020-05-02 00:49:33

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-05-02 18:13:26

I think this is an instance of "it's dangerous to mix the Perl-provided flags with the general CFLAGS, LDFLAGS"


---

Comment by isuruf created at 2020-05-02 18:56:20

Nope, this is an instance of "Perl is trying to be smart and ends up being stupid". By changing LDFLAGS like `-Wl,-rpath` to `-Wl,-R` or `-R` depending on whether the linker is invoked directly or not, it's breaking OSX as the linker doesn't know '-R'


---

Comment by mkoeppe created at 2020-05-02 23:20:17

OK, how to fix?


---

Comment by isuruf created at 2020-05-02 23:26:55

We need to fool Perl by changing `-Wl,-rpath,/path/to/lib` to `-Xlinker -rpath -Xlinker /path/to/lib` if the compiler is clang on osx. Otherwise we'll have to patch Perl itself, but that'll take some time.


---

Comment by mkoeppe created at 2020-05-02 23:30:20

Patching Perl is not an option here, I want this to work with Perl from all possible sources (including /usr/bin/perl, homebrew, perlbrew)


---

Comment by isuruf created at 2020-05-02 23:46:12

New commits:


---

Comment by isuruf created at 2020-05-02 23:46:12

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-05-02 23:47:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-05-04 05:33:40

Testing at https://github.com/mkoeppe/sage/actions/runs/94951929


---

Comment by isuruf created at 2020-05-04 15:34:55

Looks like it worked.


---

Comment by mkoeppe created at 2020-05-04 15:39:34

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-05-04 15:56:35

You're not a reviewer also?


---

Comment by isuruf created at 2020-05-04 16:08:23

Sure. I just removed an extraneous comma in the last change.


---

Comment by mkoeppe created at 2020-05-04 16:49:55

Thanks!


---

Comment by mkoeppe created at 2020-05-07 02:26:14

Changing priority from major to critical.


---

Comment by vbraun created at 2020-05-26 21:49:57

Resolution: fixed
