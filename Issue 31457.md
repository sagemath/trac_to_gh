# Issue 31457: Upgrade pynac

Issue created by migration from https://trac.sagemath.org/ticket/31694

Original creator: mkoeppe

Original creation time: 2021-04-19 17:40:26

CC:  dimpase @davewittemorris fbissey arojas

... after merging the various patches added in #31679, #31645 etc. 
 upstream.


---

Comment by @DaveWitteMorris created at 2021-04-19 20:09:44

There are still several pynac bug tickets that may not be hard to fix, so I think I will be posting quite a few more pynac patches in the next few months, so let's wait on this. But it would be good to make an upgrade before the 9.4 release.


---

Comment by mkoeppe created at 2021-04-19 20:13:20

Aren't you preparing your patches using git? I'd recommend to create pull requests to the pynac repo to make it more transparent.


---

Comment by mkoeppe created at 2021-05-18 18:05:50

Changing priority from major to blocker.


---

Comment by dimpase created at 2021-06-25 09:03:56

I am going to cut a new release of pynac with all da patchez


---

Comment by dimpase created at 2021-06-25 11:18:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-06-25 11:18:01

New commits:


---

Comment by fbissey created at 2021-06-25 11:23:23

Thank you Dima! :)


---

Comment by arojas created at 2021-06-25 11:26:59

yah, thanks a lot!


---

Comment by dimpase created at 2021-06-25 11:40:26

Dave, I've merged all your pynac patches into master, e.g.

https://github.com/pynac/pynac/commit/9d442a81aee9355c5526fff53246aa6912a18398

while the log is clear they are yours, I'm still the author. If you like you can do a PR on github to change the author of these commits.


---

Comment by mkoeppe created at 2021-06-25 17:09:05

GH Actions run please


---

Comment by dimpase created at 2021-06-25 23:33:15

Replying to [comment:12 mkoeppe]:
> GH Actions run please
running at https://github.com/sagemath/sagetrac-mirror/actions/runs/972993967


---

Comment by @DaveWitteMorris created at 2021-06-26 02:40:52

Replying to [comment:11 dimpase]:
> Dave, I've merged all your pynac patches into master, e.g.
> 
> https://github.com/pynac/pynac/commit/9d442a81aee9355c5526fff53246aa6912a18398
> 
> while the log is clear they are yours, I'm still the author. If you like you can do a PR on github to change the author of these commits.

Thanks, Dima, that's great! I am not concerned about the "author", so nothing needs to be done, as far as I'm concerned.

Copying these patches to the pynac repository has been on my to-do list for a long time, but I never got around to it, so thanks for doing this!  In the future, I'll try to save you (and the distro managers) some trouble by making the appropriate PRs.


---

Comment by dimpase created at 2021-06-26 08:10:20

Replying to [comment:14 gh-DaveWitteMorris]:

> Copying these patches to the pynac repository has been on my to-do list for a long time, but I never got around to it, so thanks for doing this!  In the future, I'll try to save you (and the distro managers) some trouble by making the appropriate PRs.

I guess you actually might have a git repo with these patches applied (at least this is how I typically do package patching), so it could have been a breeze to convert these into PRs. Anyway, it's done now.


---

Comment by slelievre created at 2021-06-26 12:45:30

One can set the author name and email as different from the committer's:

```bash
$ git commit --author="Author Name <email@example.com>"
```

This can be used to amend the last commit done:

```bash
$ git commit --amend --author="Author Name <email@example.com>" --no-edit
```


Reference:

- Answers to [Stack Overflow question 3042437](https://stackoverflow.com/q/3042437) (see more tips there)


---

Comment by @sheerluck created at 2021-06-26 21:03:15

Replying to [comment:13 dimpase]:
> Replying to [comment:12 mkoeppe]:
> > GH Actions run please
> running at https://github.com/sagemath/sagetrac-mirror/actions/runs/972993967
gentoo failed bc system eclib wanted #31443

```
checking whether we can link and run a program using eclib...
eclib version 20210503, using NTL bigints and NTL real and complex multiprecision floating point
yes; use eclib from the system
```



---

Comment by dimpase created at 2021-06-27 10:25:23

Replying to [comment:13 dimpase]:
> Replying to [comment:12 mkoeppe]:
> > GH Actions run please
> running at https://github.com/sagemath/sagetrac-mirror/actions/runs/972993967

looks like that everything (modulo the usual GH actions suspects, e.g. broken conda on some platforms) is working.
Review?


---

Comment by mkoeppe created at 2021-06-27 18:46:25

Broken on `ubuntu-trusty`


---

Comment by mkoeppe created at 2021-06-27 18:46:25

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-27 18:52:28

Also could you please have the GH Actions on pynac re-enabled? 
see https://github.com/pynac/pynac/actions/runs/971200691


---

Comment by dimpase created at 2021-06-27 22:26:56

Replying to [comment:19 mkoeppe]:
> Broken on `ubuntu-trusty`
I cannot imagine that 

```
[pynac-0.7.28]   checking for flint/fmpq_poly.h... no
[pynac-0.7.28]   configure: error: This package needs flint headers
```

is a regression. The only difference between 0.7.28 and 0.2.27 that all patches for the latter are upstreamed, and two more PRs are merged, none of them have anything to do with flint.


---

Comment by mkoeppe created at 2021-06-27 22:32:24

`ubuntu-trusty` is OK on 9.4.beta3 (as you can see in https://github.com/sagemath/sage/actions/runs/958667352) and broken with this branch as your GH Actions run showed. Same with `linuxmint-17`.


---

Comment by dimpase created at 2021-06-27 22:37:41

I'm sure it's just crappy CI for museum age OSs - what could have caused flint headers to suddenly become unavailable?


---

Comment by mkoeppe created at 2021-06-27 22:38:45

No, my CI does not have such problems.


---

Comment by mkoeppe created at 2021-06-27 22:39:36

As you know, you can test it locally using `tox -e docker-ubuntu-trusty-standard`.


---

Comment by fbissey created at 2021-06-27 22:40:13

Instead of arguing about the CI, could we have the `config.log` of pynac.


---

Comment by mkoeppe created at 2021-06-27 22:43:48

The logs are in the log artifacts of Dima's GH Actions run:
https://github.com/sagemath/sagetrac-mirror/suites/3090181081/artifacts/70720481


---

Comment by mkoeppe created at 2021-06-27 22:45:42

OK actually the config.log is not there. So a local rerun is needed to produce them


---

Comment by dimpase created at 2021-06-27 23:00:12

Replying to [comment:25 mkoeppe]:
> As you know, you can test it locally using `tox -e docker-ubuntu-trusty-standard`.

My office machine doesn't have docker. OK, I can do an lxc install of ubuntu trusty, maybe...


---

Comment by mkoeppe created at 2021-06-27 23:02:03

That's #29283


---

Comment by dimpase created at 2021-06-27 23:41:04

linuxmint-17 reached EOL over 2 years ago, I don't know why we still keep it.
https://forums.linuxmint.com/viewtopic.php?t=289281

ubuntu trusty is also beyond the end of unpaid support, EOL to happen in 10 months.

Let's drop them for 9.4.


---

Comment by mkoeppe created at 2021-06-27 23:56:34

We can't have this discussion on every untested package upgrade ticket.


---

Comment by mkoeppe created at 2021-06-28 00:41:45

Here's the pynac config.log:

```
configure:17504: checking for gmp.h
configure:17504: gcc -std=gnu11 -c -O2 -g   conftest.c >&5
configure:17504: $? = 0
configure:17504: result: yes
configure:17514: checking for library containing __gmpz_get_str
configure:17544: gcc -std=gnu11 -o conftest -O2 -g   -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib  conftest.c  >&5
/tmp/ccY7y07W.o: In function `main':
/sage/local/var/tmp/sage/build/pynac-0.7.28/src/conftest.c:34: undefined reference to `__gmpz_get_str'
collect2: error: ld returned 1 exit status
configure:17544: $? = 1
configure: failed program was:
configure:17544: gcc -std=gnu11 -o conftest -O2 -g   -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib  conftest.c -lgmp   >&5
configure:17544: $? = 0
configure:17564: result: -lgmp
configure:17578: checking for flint/fmpq_poly.h
configure:17578: gcc -std=gnu11 -c -O2 -g   conftest.c >&5
In file included from /sage/local/include/flint/nmod_vec.h:29:0,
                 from /sage/local/include/flint/fmpz.h:31,
                 from /sage/local/include/flint/fmpq_poly.h:24,
                 from conftest.c:54:
/sage/local/include/flint/ulong_extras.h:119:1: error: unknown type name '_Thread_local'
 extern FLINT_TLS_PREFIX ulong * _flint_primes[FLINT_BITS];
 ^
/sage/local/include/flint/ulong_extras.h:119:31: error: expected '=', ',', ';', 'asm' or '__attribute__' before '*' token
 extern FLINT_TLS_PREFIX ulong * _flint_primes[FLINT_BITS];
                               ^
/sage/local/include/flint/ulong_extras.h:120:25: error: expected '=', ',', ';', 'asm' or '__attribute__' before 'double'
 extern FLINT_TLS_PREFIX double * _flint_prime_inverses[FLINT_BITS];
                         ^
/sage/local/include/flint/ulong_extras.h:121:25: error: expected '=', ',', ';', 'asm' or '__attribute__' before 'int'
 extern FLINT_TLS_PREFIX int _flint_primes_used;
                         ^
configure:17578: $? = 1
configure: failed program was:
configure:17578: result: no
configure:17584: error: This package needs flint headers
```



---

Comment by fbissey created at 2021-06-28 00:54:58

So, we have `flint` headers but they are broken. I'd say because glibc is too old at first glance. Glad you could dig those because they are really useful in pinpointing issues.


---

Comment by mkoeppe created at 2021-06-28 00:59:11

On this install, flint was installed from the SPKG.


---

Comment by mkoeppe created at 2021-06-28 01:02:36

And looking at the flint build log: it is using plain `gcc`, without `-std=gnu11`.


---

Comment by fbissey created at 2021-06-28 01:03:17

Replying to [comment:35 mkoeppe]:
> On this install, flint was installed from the SPKG.
I could tell from the headers tested. Either something is changed at install or those particular headers are not involved in building flint. Otherwise building flint would be a problem. It is worth trying without the gnu11 bit. Good spotting.


---

Comment by fbissey created at 2021-06-28 01:10:05

I think the gnu11 is a setting bleeding from setting the C++ compiler to c++11. It probably shouldn't be there at all.


---

Comment by fbissey created at 2021-06-28 01:24:11

Replying to [comment:38 fbissey]:
> I think the gnu11 is a setting bleeding from setting the C++ compiler to c++11. It probably shouldn't be there at all.
Nope C++11 is supposed to be tested after. I have no idea where this one comes from. I also don't see it when I configure pynac locally (have to double check that) so I am not sure where it is introduced.


---

Comment by mkoeppe created at 2021-06-28 01:32:14

Right. There is no C code whatsoever in pynac. Everything is C++. Just the AC_LANG([C++])
is coming much too late!


---

Comment by mkoeppe created at 2021-06-28 01:35:21

Tests with a change run now at https://github.com/mkoeppe/pynac/actions/runs/977436209


---

Comment by mkoeppe created at 2021-06-28 02:03:24

https://github.com/pynac/pynac/pull/377


---

Comment by fbissey created at 2021-06-28 02:41:20

Do I take it that it helped :)


---

Comment by mkoeppe created at 2021-06-28 02:46:31

Yes, this seems to do the trick.

Dima, can you please create a new release with this PR?


---

Comment by dimpase created at 2021-06-28 07:15:08

Replying to [comment:20 mkoeppe]:
> Also could you please have the GH Actions on pynac re-enabled? 
> see https://github.com/pynac/pynac/actions/runs/971200691

no idea what "reenabled" means. They are enabled, I guess it's what we have in .github/ matters.


---

Comment by mkoeppe created at 2021-06-28 07:24:55

Like the error message says: "Actions jobs for this repository have been disabled by [GitHub](GitHub) staff. If you are the repository owner, you can contact support via https://github.com/contact for more information."
I had to do this for one of my repositories too in the past.


---

Comment by @DaveWitteMorris created at 2021-06-28 07:51:54

Replying to [comment:15 dimpase]:
> Replying to [comment:14 gh-DaveWitteMorris]:
> 
> > Copying these patches to the pynac repository has been on my to-do list for a long time, but I never got around to it, so thanks for doing this!  In the future, I'll try to save you (and the distro managers) some trouble by making the appropriate PRs.
> 
> I guess you actually might have a git repo with these patches applied (at least this is how I typically do package patching), so it could have been a breeze to convert these into PRs. Anyway, it's done now.

Yes, this should have been easy, but I know almost nothing about git, so my attempts failed when I tried a few weeks ago. (I didn't realize that I needed a fork, instead of a clone.) I think I succeeded in making a PR to the pynac repository this evening, and, now that I know how, I will try to make PRs of all of my pynac patches.


---

Comment by dimpase created at 2021-06-28 08:23:29

Replying to [comment:46 mkoeppe]:
> Like the error message says: "Actions jobs for this repository have been disabled by [GitHub](GitHub) staff. 

I cannot see any error messages there.
Maybe I am looking at the wrong places?

> If you are the repository owner, you can contact support via https://github.com/contact for more information."
> I had to do this for one of my repositories too in the past.


---

Comment by dimpase created at 2021-06-28 08:29:41

Replying to [comment:48 dimpase]:
> Replying to [comment:46 mkoeppe]:
> > Like the error message says: "Actions jobs for this repository have been disabled by [GitHub](GitHub) staff. 
> 
> I cannot see any error messages there.
> Maybe I am looking at the wrong places?
> 
> > If you are the repository owner, you can contact support via https://github.com/contact for more information."
> > I had to do this for one of my repositories too in the past. 

OK, it's in "Annotations". Duh. OK, requested re-enabling
https://support.github.com/ticket/personal/0/1212297


---

Comment by git created at 2021-06-28 09:21:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-28 10:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-28 10:54:33

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-06-28 11:23:30

tests are running on https://github.com/sagemath/sagetrac-mirror/actions/runs/978774922
(which is this branch with an extra pynac test from #31585)


---

Comment by dimpase created at 2021-06-28 12:35:14

Replying to [comment:32 mkoeppe]:
> We can't have this discussion on every untested package upgrade ticket.
I've opened #32074


---

Comment by mkoeppe created at 2021-06-28 14:39:04

Broken on `debian-jessie` - https://github.com/pynac/pynac/pull/378#issuecomment-869741626

and on `ubuntu-trusty` - https://github.com/sagemath/sagetrac-mirror/runs/2931188061?check_suite_focus=true


---

Comment by mkoeppe created at 2021-06-28 14:39:04

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-28 14:44:34

Dima, could you please make a release without PR 378, so that we can get this blocker ticket done? Just focused on what this ticket says - add support for gcc 11, consolidate existing patches; no breaking/removing of other platform support.


---

Comment by mkoeppe created at 2021-06-28 19:39:07

I volunteer to make the next pynac releases.


---

Comment by dimpase created at 2021-06-28 22:01:20

Replying to [comment:57 mkoeppe]:
> I volunteer to make the next pynac releases.

let's just drop gcc 4.x. It would minimise the disruption, and it's overdue anyway.


---

Comment by @DaveWitteMorris created at 2021-06-28 22:04:47

As I said on #32074, I am +1 on this proposal to drop support for gcc 4.x. That should solve the immediate problem.


---

Comment by dimpase created at 2021-06-28 22:19:48

Or even better/quicker, just add `AC_CHECK_FUNC(__builtin_smull_overflow,...)` to spkg-configure for gcc spkg.


---

Comment by mkoeppe created at 2021-06-28 22:24:32

It's important to keep tickets focused. In particular for a blocker ticket like this one, which creates an urgency to get it in.

The urgent need to add support for gcc 11 is entirely unconnected to a decision to drop support for the gcc 4 versions used in some of our supported distributions.

It is poor practice to connect these two issues arbitrarily.


---

Comment by dimpase created at 2021-06-28 22:59:32

our resources are limited;

*  making a new pynac release without `__builtin_smull_overflow` takes time, 
* re-doing the branch with `__builtin_smull_overflow` takes time 
* (and God help you finding a workaround not using `__builtin_smull_overflow`, potentially another time waste to keep a museum compiler in...)


---

Comment by mkoeppe created at 2021-06-28 23:09:28

It's important to keep tickets focused -- that includes avoiding to give unsolicited advice to other developers regarding time management.


---

Comment by mkoeppe created at 2021-06-30 03:13:01

New commits:


---

Comment by mkoeppe created at 2021-06-30 03:13:01

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-06-30 13:53:06

tests run on https://github.com/sagemath/sagetrac-mirror/actions/runs/986545913


---

Comment by dimpase created at 2021-07-01 13:10:46

lgtm


---

Comment by dimpase created at 2021-07-01 13:10:46

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-01 16:14:22

Thanks!


---

Comment by vbraun created at 2021-07-06 21:29:45

Resolution: fixed


---

Comment by dimpase created at 2021-07-18 10:01:39

I don't see this branch in the current develop branch, what's up?
