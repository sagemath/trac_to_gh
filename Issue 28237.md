# Issue 28237: Spherical Bessel functions have wrong phase for negative argument

Issue created by migration from https://trac.sagemath.org/ticket/28474

Original creator: paulmasson

Original creation time: 2019-09-12 00:17:24




---

Comment by git created at 2019-09-12 00:48:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2019-09-12 00:53:04

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2019-09-12 17:05:54

Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?

Edit: on the other hand, the DLMF also states that j_n(-z) = (-1)<sup>n</sup>·j_n(z) with no restriction on z...


---

Comment by paulmasson created at 2019-09-12 19:33:40

Replying to [comment:4 mmezzarobba]:
> Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?
The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.


---

Comment by tscrim created at 2019-09-13 00:18:46

Quick code comment: You have the wrong colons on each part and it should be:

```
    TESTS:

    Check that :trac:`28474` is fixed::
```



---

Comment by git created at 2019-09-13 00:36:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2019-09-13 00:37:22

Replying to [comment:6 tscrim]:
> Quick code comment: You have the wrong colons on each part and it should be:
> {{{
>     TESTS:
> 
>     Check that :trac:`28474` is fixed::
> }}}
Fixed


---

Comment by mmezzarobba created at 2019-09-13 11:31:06

Replying to [comment:5 paulmasson]:
> The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.

Then there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:

```
sage: n = 3
sage: z = -4
sage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)
[0.229243857955030 +/- 5.17e-16]
```

Your patch changes that result to its opposite.


---

Comment by paulmasson created at 2019-09-16 21:08:50

Replying to [comment:9 mmezzarobba]:
> Replying to [comment:5 paulmasson]:
> > The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.
> 
> Then there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:
> {{{
> sage: n = 3
> sage: z = -4
> sage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)
> [0.229243857955030 +/- 5.17e-16]
> }}}
> Your patch changes that result to its opposite.
If you repeat the evaluation with `z=4` you'll get exactly the same result, which contradicts the identity you mentioned [above](https://trac.sagemath.org/ticket/28474?#comment:4). You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.

In my own JavaScript [library](https://github.com/paulmasson/math) I had assumed that the straightforward calculation would give the standard branch but it doesn't. I only noticed the issue here while fixing the same [issue](https://github.com/paulmasson/math/issues/5) in my library.


---

Comment by mmezzarobba created at 2019-09-17 15:37:51

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2019-09-17 15:37:51

Replying to [comment:10 paulmasson]:
>  You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.

Ok. I suppose this does mean that the identity given by the DLMF (and already by Abramowitz & Stegun) is not valid for negative z...


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-03 17:57:40

Resolution: fixed
