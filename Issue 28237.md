# Issue 28237: Spherical Bessel functions have wrong phase for negative argument

archive/issues_028237.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/28474\n\n",
    "created_at": "2019-09-12T00:17:24Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Spherical Bessel functions have wrong phase for negative argument",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28237",
    "user": "https://github.com/paulmasson"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/28474





---

archive/issue_comments_398373.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-12T00:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398373",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_398374.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-12T00:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398374",
    "user": "https://github.com/paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_398375.json:
```json
{
    "body": "Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?\n\nEdit: on the other hand, the DLMF also states that j_n(-z) = (-1)<sup>n</sup>\u00b7j_n(z) with no restriction on\u00a0z...",
    "created_at": "2019-09-12T17:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398375",
    "user": "https://github.com/mezzarobba"
}
```

Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?

Edit: on the other hand, the DLMF also states that j_n(-z) = (-1)<sup>n</sup>·j_n(z) with no restriction on z...



---

archive/issue_comments_398376.json:
```json
{
    "body": "Replying to [comment:4 mmezzarobba]:\n> Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?\nThe mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.",
    "created_at": "2019-09-12T19:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398376",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:4 mmezzarobba]:
> Mathematica seems to agree with you, but https://dlmf.nist.gov/10.47#E3 gives (assuming I'm reading it correctly) the previously implemented definition. I am not really familiar with spherical Bessel functions; are you sure that the change is consistent with general usage and with the rest of Sage?
The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.



---

archive/issue_comments_398377.json:
```json
{
    "body": "Quick code comment: You have the wrong colons on each part and it should be:\n\n```\n    TESTS:\n\n    Check that :trac:`28474` is fixed::\n```\n",
    "created_at": "2019-09-13T00:18:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398377",
    "user": "https://github.com/tscrim"
}
```

Quick code comment: You have the wrong colons on each part and it should be:

```
    TESTS:

    Check that :trac:`28474` is fixed::
```




---

archive/issue_comments_398378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T00:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_398379.json:
```json
{
    "body": "Replying to [comment:6 tscrim]:\n> Quick code comment: You have the wrong colons on each part and it should be:\n> {{{\n>     TESTS:\n> \n>     Check that :trac:`28474` is fixed::\n> }}}\nFixed",
    "created_at": "2019-09-13T00:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398379",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:6 tscrim]:
> Quick code comment: You have the wrong colons on each part and it should be:
> {{{
>     TESTS:
> 
>     Check that :trac:`28474` is fixed::
> }}}
Fixed



---

archive/issue_comments_398380.json:
```json
{
    "body": "Replying to [comment:5 paulmasson]:\n> The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.\n\nThen there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:\n\n```\nsage: n = 3\nsage: z = -4\nsage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)\n[0.229243857955030 +/- 5.17e-16]\n```\n\nYour patch changes that result to its opposite.",
    "created_at": "2019-09-13T11:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398380",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:5 paulmasson]:
> The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.

Then there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:

```
sage: n = 3
sage: z = -4
sage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)
[0.229243857955030 +/- 5.17e-16]
```

Your patch changes that result to its opposite.



---

archive/issue_comments_398381.json:
```json
{
    "body": "Replying to [comment:9 mmezzarobba]:\n> Replying to [comment:5 paulmasson]:\n> > The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.\n> \n> Then there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:\n> {{{\n> sage: n = 3\n> sage: z = -4\n> sage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)\n> [0.229243857955030 +/- 5.17e-16]\n> }}}\n> Your patch changes that result to its opposite.\nIf you repeat the evaluation with `z=4` you'll get exactly the same result, which contradicts the identity you mentioned [above](https://trac.sagemath.org/ticket/28474?#comment:4). You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.\n\nIn my own JavaScript [library](https://github.com/paulmasson/math) I had assumed that the straightforward calculation would give the standard branch but it doesn't. I only noticed the issue here while fixing the same [issue](https://github.com/paulmasson/math/issues/5) in my library.",
    "created_at": "2019-09-16T21:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398381",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:9 mmezzarobba]:
> Replying to [comment:5 paulmasson]:
> > The mathematical definition has not been altered. The issue is the numerical evaluation of the square root to give the proper sign for negative arguments. The proposed fix takes care of that without needing to consider any special cases.
> 
> Then there is something I don't understand. With the DLMF definition I linked to (and assuming the standard branch of the square root), one has:
> {{{
> sage: n = 3
> sage: z = -4
> sage: CBF(1/2*pi/z).sqrt()*CBF(z).bessel_J(n+1/2)
> [0.229243857955030 +/- 5.17e-16]
> }}}
> Your patch changes that result to its opposite.
If you repeat the evaluation with `z=4` you'll get exactly the same result, which contradicts the identity you mentioned [above](https://trac.sagemath.org/ticket/28474?#comment:4). You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.

In my own JavaScript [library](https://github.com/paulmasson/math) I had assumed that the straightforward calculation would give the standard branch but it doesn't. I only noticed the issue here while fixing the same [issue](https://github.com/paulmasson/math/issues/5) in my library.



---

archive/issue_comments_398382.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-17T15:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398382",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_398383.json:
```json
{
    "body": "Replying to [comment:10 paulmasson]:\n>  You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.\n\nOk. I suppose this does mean that the identity given by the DLMF (and already by Abramowitz\u00a0& Stegun) is not valid for negative\u00a0z...",
    "created_at": "2019-09-17T15:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398383",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:10 paulmasson]:
>  You can verify the identity by looking at these functions [expressed](https://en.wikipedia.org/wiki/Bessel_function#Spherical_Bessel_functions:_jn,_yn) in terms of circular functions: they need to be odd in the argument for odd `n`.

Ok. I suppose this does mean that the identity given by the DLMF (and already by Abramowitz & Stegun) is not valid for negative z...



---

archive/issue_comments_398384.json:
```json
{
    "body": "moving milestone to 9.0 (after release of 8.9)",
    "created_at": "2019-09-30T08:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398384",
    "user": "https://github.com/fchapoton"
}
```

moving milestone to 9.0 (after release of 8.9)



---

archive/issue_events_026154.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-03T17:57:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28237#event-26154"
}
```



---

archive/issue_comments_398385.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-03T17:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28237",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28237#issuecomment-398385",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
