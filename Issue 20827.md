# Issue 20827: Enable NTL's '-march=native' more cautiously

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2016-07-20 16:16:15

CC:  dunfield fbissey

Keywords: assembler shlx mulx

Take more care in passing `NATIVE=on` to NTL's `configure`.

Upstream only checks whether _the compiler accepts the option_, nothing beyond that.

This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with `-march=native`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficent to build Sage).

While we could (and hopefully will) add more sophisticated checks regarding the assembler's capabilities (or use an alternate one, e.g. clang's/LLVM's on Darwin, cf. #20779), we need a quick (and safe) fix for Sage 7.3.


---

Comment by leif created at 2016-07-20 16:20:17

Set assignee to leif.


---

Comment by leif created at 2016-07-20 23:55:35

Changing status from new to needs_review.


---

Comment by leif created at 2016-07-20 23:55:35

Here it is.

Feel free to vote for the second commit; the third is less restrictive.
----
New commits:


---

Comment by fbissey created at 2016-07-21 00:25:35

Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).

Being refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.


---

Comment by leif created at 2016-07-21 00:47:46

Replying to [comment:4 fbissey]:
> Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).
> 
> Being refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.

Yep, it became more lengthy than I first thought.  (Empathy with Apple fan boys is no good. ;-) )

W.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.

On the other hand, I actually intended to add proper feature checks (for each "non-standard" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually _executing_ instructions), because what CPUID reports isn't always correct (and hence GCC could be "wrong" as well), be it a crippled _and_ flawed Intel chip, or a VM bug.


---

Comment by dunfield created at 2016-07-21 02:54:58

I tried out version (3) of this patch on OS X version 10.9 (which has the old `as`) and now NTL compiles fine.  So it looks good at my end.  

One very minor quibble with the OS X-specific comment in the spkg-install file:


```
TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.
```


It is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...


---

Comment by fbissey created at 2016-07-21 03:08:44

That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.


---

Comment by leif created at 2016-07-21 03:17:51

Replying to [comment:6 dunfield]:
> One very minor quibble with the OS X-specific comment in the spkg-install file:
> 
> {{{
> TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.
> }}}
> 
> It is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...

Better this way?

```diff
diff --git a/build/pkgs/ntl/spkg-install b/build/pkgs/ntl/spkg-install
index 0a35355..cb5ad4e 100755
--- a/build/pkgs/ntl/spkg-install
+++ b/build/pkgs/ntl/spkg-install
`@``@` -109,8 +109,7 `@``@` ntl_configure()
                 assembler_ok=true # perhaps until we upgrade Sage's GCC... ;-)
                 ;;
               1.38) # This is Apple's ancient version of GNU as.
-                # TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which
-                #       should work.
+                # If we passed '-q', it would suddenly become LLVM's 'as'.
                 ;;
             esac
         elif [ -n "$LLVMAS_VERSION" ]; then
```


(The [corresponding commit message](https://git.sagemath.org/sage.git/commit?id=7e1ceb270804b7525db553d35be29ccecc03206a) is more explicit.)


---

Comment by dunfield created at 2016-07-21 03:18:28

Replying to [comment:7 fbissey]:
> That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.

I think (3) is still OK in this regard since it never changes the assembler, but just determines which will be used (and consequently whether we can expect it to work with the `-march=native` flag).


---

Comment by dunfield created at 2016-07-21 03:19:04

Replying to [comment:8 leif]:
> Better this way?

Yes, that looks good to me.


---

Comment by git created at 2016-07-21 03:32:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-21 03:35:23

Replying to [comment:10 dunfield]:
> Replying to [comment:8 leif]:
> > Better this way?
> 
> Yes, that looks good to me.

Committed.


---

Comment by jdemeyer created at 2016-07-21 16:02:10

That's a lot of complicated logic which looks quite fragile. Why not simply:

1. Try to build normally.

2. If that failed, retry without `-march=native`.


---

Comment by leif created at 2016-07-21 19:16:50

Replying to [comment:13 jdemeyer]:
> That's a lot of complicated logic which looks quite fragile.

It's about 30 lines of code, 10 of them `echo`s.  And I fail to see where it's "fragile", as we don't do dangerous things here, just try to not lose performance without reason.

\\

> Why not simply:
> 
> 1. Try to build normally.
> 
> 2. If that failed, retry without `-march=native`.

That's nearly dumber than simply disabling `NATIVE`; if NTL took a few seconds (maybe minutes) to build, I'd perhaps agree.  And we cannot be sure it will fail _early_.

Imagine we'd do so for every package, probably trying more than one option.

As I said, in the long run, proper tests belong to NTL's `configure`, and the general problem on MacOS X will be solved on #20779.  I'd also appreciate if we had an (optional) binutils package for older Linux distros, otherwise we should perhaps stop building our own GCC (on those at least).


---

Comment by leif created at 2016-07-21 19:28:04

P.S.:  If we solve the toolchain problems (partially caused by Apple, but also by _us_), we should IMHO by default build everything with `-march=native`, unless `SAGE_FAT_BINARY=yes`.


---

Comment by jdemeyer created at 2016-07-22 07:39:21

Replying to [comment:14 leif]:
> And I fail to see where it's "fragile"

The part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22. But even if you fix that, you still have to "parse" the output of `as --version` correctly.


---

Comment by jdemeyer created at 2016-07-22 07:40:38

Can you remove this pointless code:

```
              1.38) # This is Apple's ancient version of GNU as.
                # If we passed '-q', it would suddenly become LLVM's 'as'.
                ;;
```



---

Comment by git created at 2016-07-22 09:21:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-22 09:59:14

Replying to [comment:16 jdemeyer]:
> Replying to [comment:14 leif]:
> > And I fail to see where it's "fragile"
> 
> The part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22.

Show me a system where GAS 2.3 is used (and Sage at least partially builds)...

(Fixed that though.)

\\

> But even if you fix that, you still have to "parse" the output of `as --version` correctly.

If it contains `LLVM`, it's LLVM's `as`, certainly not GAS at least, and completely sufficient _here_.

If you instead meant to refer to `as -v`,

```sh
        GAS_VERSION=$( ${AS:-as} -v </dev/null -o /dev/null 2>&1 \
            | sed  -n '/GNU assembler/s/^.* \([12]\.[^ ][^ ]*\).*$/\1/p' )
```

works for all versions I encountered in this context (namely, Sage).  This is `spkg-install`, not `configure.ac`.  (Note that GAS doesn't support anything like `-dumpversion`, and distro packagers mess up what vanilla GAS gives.)

\\

And, again repeating myself, I'm not going to mess with Darwin and Xcode versions here, that belongs elsewhere.  (You may have noticed that I do not even check whether we're on Darwin if GAS is 1.38 or LLVM's assembler is present, because that's far beyond what we need here.  This ticket works around a fall-out of other bugs in Sage:  Not properly checking / requiring Xcode versions, and installing a GCC which may not fit, hence break, the other parts of the toolchain -- that's why I'm voting for offering an adequate binutils Sage package.)


---

Comment by leif created at 2016-07-22 10:17:14

P.S.:  I'll probably write some script which converts `-march=native` in `*FLAGS` to `-march=native -mno-foo -mno-bar ...` as appropriate, but including (and regularly updating!) such somewhere in Sage is something for future tickets.  (We could do that, i.e., build `SAGE_NATIVE_*FLAGS`, in Sage's top-level `configure`, and again after having installed Sage's GCC and probably binutils.  But in general, `-march=native` _is supposed to work *without* additional hacks_ on platforms where GCC supports that option.)


---

Comment by leif created at 2016-07-23 14:28:12

Replying to [comment:5 leif]:
> Replying to [comment:4 fbissey]:
> > Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version?
> W.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.
> 
> On the other hand, I actually intended to add proper feature checks (for each "non-standard" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually _executing_ instructions), because what CPUID reports isn't always correct (and hence GCC could be "wrong" as well), be it a crippled _and_ flawed Intel chip, or a VM bug.

Looking deeper into NTL's configure process (I haven't done for a while), there's certainly room for improvements, i.e., changes we could submit upstream in the long run.

While there are tests for AVX, AVX2 and `__builtin_clzl()` actually running test code (implicitly testing the toolchain), the test program (which gets compiled _and_ linked, but currently not run) for `CXXAUTOFLAGS` (which include `-march=native` if `NATIVE=on`) is the following:

```C
int main() { return 0; }
```

I think it's _unlikely_ that GCC will generate code containing _any_ ISA extension instructions for this, so the assembler won't complain there (and the program -- as is -- is likely to run without errors on _any_ machine with the same [generic] architecture, not only on those with the specific one GCC _thinks_ is the native).


---

Comment by vbraun created at 2016-07-25 20:22:46

Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.


---

Comment by vbraun created at 2016-07-25 20:22:46

Changing status from needs_review to positive_review.


---

Comment by leif created at 2016-07-25 23:20:21

Replying to [comment:22 vbraun]:
> Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.

Yep.  Unfortunately NTL doesn't have the usual `configure && make` structure; `configure` calls a Perl script which generates (and continually rewrites) a makefile (and indirectly config files) which is then again called (`make -f ...`) from the script to perform some tests.

The "final" makefile then first builds kind of another configure chain and runs that before building the library; there, some tests simply happen "too late" (as building the tools may already fail).

(This is similar to a shell script which first tests features of the shell it is run with, but, when run with the wrong shell, already bails out with a syntax error when performing the tests supposed to avoid exactly that.)

So it's not easy to submit anything useful / acceptable upstream (without completely rewriting the above, or being too specific and probably kind of redundant in just fixing our problem which is rather uncommon).


---

Comment by vbraun created at 2016-07-27 20:24:50

Resolution: fixed
