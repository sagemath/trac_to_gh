# Issue 10287: Experimental package 'CHomP' fails to install on OpenSolaris x86

Issue created by migration from Trac.

Original creator: drkirkby

Original creation time: 2010-11-18 09:15:57

Assignee: drkirkby

CC:  jhpalmieri mhampton fbissey

Trying to install this experiemental package on a Sun Ultra 27 (3.33 GHz Intel Xeon) running OpenSolaris 06/2009, it fails as it can't reconise the system. 

I've not tried it, but I would also expect it to fail on a Solaris 10 machine with an x86 processor such as 'fulvia' on Skynet. 

I've not tried a 64-bit build (i.e. with `SAGE64=yes`). 


```
g++ -O2 -ansi -pedantic -Wall -I../include  -o ../obj/capd-homengin/engines.o -c \
        ../src/capd-homengin/engines.cpp
In file included from ../include/capd/auxil/clock.h:18:0,
                 from ../include/capd/auxil/Stopwatch.h:19,
                 from ../include/capd/homologicalAlgebra/homAlgFunctors.hpp:27,
                 from ../include/capd/homologicalAlgebra/cubSetFunctors.hpp:22,
                 from ../include/capd/multiEngHom/MultiEngHomT.h:30,
                 from ../src/capd-homengin/engines.cpp:35:
../include/capd/capd/operatingSystemSetting.h:73:2: error: #error Your system cannot be determined automatically by the KRAK package.Please edit the configuration file appropriately.
In file included from ../include/capd/auxil/Stopwatch.h:19:0,
                 from ../include/capd/homologicalAlgebra/homAlgFunctors.hpp:27,
                 from ../include/capd/homologicalAlgebra/cubSetFunctors.hpp:22,
                 from ../include/capd/multiEngHom/MultiEngHomT.h:30,
                 from ../src/capd-homengin/engines.cpp:35:
../include/capd/auxil/clock.h: In function 'long double getWorldSeconds()':
../include/capd/auxil/clock.h:54:32: error: aggregate 'getWorldSeconds()::_timeb timebuffer' has incomplete type and cannot be defined
In file included from ../include/capd/auxil/Stopwatch.h:19:0,
                 from ../include/capd/homologicalAlgebra/homAlgFunctors.hpp:27,
                 from ../include/capd/homologicalAlgebra/cubSetFunctors.hpp:22,
                 from ../include/capd/multiEngHom/MultiEngHomT.h:30,
                 from ../src/capd-homengin/engines.cpp:35:
../include/capd/auxil/clock.h:55:31: error: '_ftime' was not declared in this scope
../include/capd/auxil/clock.h:57:5: warning: control reaches end of non-void function
make[2]: *** [../obj/capd-homengin/engines.o] Error 1
make[2]: Leaving directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p1/src/make'
:
```



---

Comment by jhpalmieri created at 2010-11-19 01:20:23

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2010-11-19 01:20:23

I have a new spkg available at [http://sage.math.washington.edu/home/palmieri/SPKG/chomp-20100213.p2.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/chomp-20100213.p2.spkg).  It builds on hawk, and since the only changes are SunOS-specific, it should still wherever it built before, but I haven't tested it yet.  I'll try to test on various skynet machines soon.  I'm also attaching a patch showing the changes; this is for reference only, don't apply it anywhere.


---

Comment by drkirkby created at 2010-11-19 04:18:13

Changing status from needs_review to needs_work.


---

Comment by drkirkby created at 2010-11-19 04:18:13

Johh, 

your patch clearly works for a 32-bit build on OpenSolaris, though I'm not sure its the best solution to the problem. I think it would be better to make the automatic operating-system detection work, which means the problem can be reported upstream, and get fixed. 

That's easily done by checking if `sun` is defined, rather than checking if `__sparc__` is defined. 


```
--- ./src/include/capd/capd/operatingSystemSetting.h    Wed Jul  2 12:50:10 2008
+++ ./patches/operatingSystemSetting.h  Fri Nov 19 02:24:23 2010
`@``@` -59,8 +59,8 `@``@`
 #    error The Interval library does not work on the Linux/Sparc combination.
 #  endif
 
-// Is the target processor a Sparc one? If so, assume the system is Sun OS.
-#elif defined (__sparc__)
+// If 'sun' is defined, which it is by both Sun Studio and gcc, then assume Solaris. 
+#elif defined (sun)
 #  define SUN_OS
 #endif
```


This can then remove the Solaris operating system specific patch in spkg-install. 

Another problem is that there's no code to handle 64-bit on any Solaris platform, or probably on OS X too, as the variable SAGE64 is never used. I tried fixing that by exporting CXXFLAGS, with the following code:


```
if [ "x$CXXFLAG64" = x ] ; then
   CXXFLAG64=-m64
fi

if [ "x$SAGE64" = xyes ] ; then
   CXX="$CXXFLAGS CXXFLAG64"
   export CXXFLAGS
fi
```


Unfortunately, the compiler g++ is hard-coded in most of the Makefiles and CXXFLAGS is ignored. Although I've not checked it, I think editing src/make/config/sun from its previous version: 


```
CXX = g++
COMPILE = $(CXX) -O2 -ansi -pedantic -Wall
LINK    = $(CXX) -s
LINKGUI = $(CXX) -s
```


with


```
COMPILE = $(CXX) $(CXXFLAGS) -O2 -ansi -pedantic -Wall
LINK    = $(CXX) $(CXXFLAGS) -s
LINKGUI = $(CXX) $(CXXFLAGS) -s
```


Then it should use the -m64 option when building all objects if `SAGE64=yes`

Reading the web site, it would appear on Macs one needs to use:


```
case `uname` in 
    "Darwin")
        target='mac';;
```


I can't find any reference to 'mac' in any makefile, or anywhere else for that matter. (I used the -R option to GNU grep). It seems to me setting 'target=mac' is doing absolutely nothing. 

I've late here and I need some sleep, but there were a few things I found that were wrong. 
Dave


---

Comment by jhpalmieri created at 2010-11-19 06:08:39

Replying to [comment:3 drkirkby]:

> Reading the web site, it would appear on Macs one needs to use:
> 

```
case `uname` in 
    "Darwin")
        target='mac';;
```


Right, this is what is (and has been) in spkg-install.
 
> I can't find any reference to 'mac' in any makefile, or anywhere else for that matter. (I used the -R option to GNU grep). It seems to me setting 'target=mac' is doing absolutely nothing. 

I think it uses the file src/make/config/mac for configuration.  Maybe the string "mac" isn't in any file, but there is a file called "mac", which your grep may not have found.

I'll look at your other comments later.


---

Comment by fbissey created at 2010-11-19 08:28:34

In the gentoo ebuild cooked initially by Christopher, we pass CXX, COMPILE, LINK and LINKGUI to make. So we have a make invocation that looks like this:

```
make -j1 CXX=${cxxcompiler) COMPILE="${cxxcompiler) ${CXXFLAGS}" \
         LINK="$(cxxcompiler) ${LDFLAGS}" LINKGUI="$(cxxcompiler) ${LDFLAGS}"
```

Of course you need to add the target on specific platform. Finally I am not sure
we need LINKGUI since it is for producing a wxwidget apps and it has its own target
according to the compilation instructions. That is you need target=wxunx on unix like systems.


---

Comment by drkirkby created at 2010-11-19 15:10:43

Hi all
The fact there is a mac file no doubt means I was wrong, and so that is needed.

I was not aware that the arguments to make would solve the problem. In which case it's even easier to fix than I thought. Thank you Francois. 


```
if [ "x$CXXFLAG64" = x ] ; then
   CXXFLAG64=-m64
fi

if [ "x$SAGE64" = xyes ] ; then
   CXX="$CXXFLAGS CXXFLAG64"
fi
```


then $MAKE CXX=$CXX CXXFLAGS=$CXXFLAGS etc should solve it. 

Do we know for sure the package can't be built in parallel, so one must set j=1, or was that just a safe choice? 

One other point i forgot to make. The 'prereq' script checks that the version of make is GNU, so arguably this does not need repeating. But I guess this being optional, the hardware/software might have changed, so recheking is not a bad idea. 


However, despite what spkg-install says, the version number of gnu make is not checked. 

I think im going to be stuck to using someone elses Windows machine for the rest of the afternoon, so wil have no Unix access. 

Dave


---

Comment by drkirkby created at 2010-11-19 15:13:54

Oops, that bit of code needs to be:


```
if [ "x$SAGE64" = xyes ] ; then
   CXXFLAGS="$CXXFLAGS CXXFLAG64"
fi
```



which will addend -m64 (or another flag if needed) to CXXFLAGS on 64-bit builds.


---

Comment by jhpalmieri created at 2010-11-19 17:07:51

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2010-11-19 17:07:51

Replying to [comment:6 drkirkby]:

> then $MAKE CXX=$CXX CXXFLAGS=$CXXFLAGS etc should solve it. 

I can't get this to work on my Mac; instead I'm using

```
$MAKE target=$target COMPILE="${CXX} ${CXXFLAGS}"
```


> Do we know for sure the package can't be built in parallel, so one must set j=1, or was that just a safe choice? 

It actually says not to use "make -j..." on one of the web pages.  I've added a citation to spkg-install and to SPKG.txt.

> One other point i forgot to make. The 'prereq' script checks that the version of make is GNU, so arguably this does not need repeating. But I guess this being optional, the hardware/software might have changed, so recheking is not a bad idea. 

Okay.

> However, despite what spkg-install says, the version number of gnu make is not checked. 

You're right.  Version 3.77 of make was released in 1998, so I'm inclined to remove the check altogether.

I've updating the spkg and the patch.  This is still pretty experimental, but I'll mark it as "needs review" anyway.


---

Comment by jhpalmieri created at 2010-11-19 22:22:07

I've posted an updated spkg and accompanying patch.  This may not be done as efficiently as possible, but it builds for me on OS X 10.6, OpenSolaris on x86 (hawk), and sage.math, all of which with SAGE64 unset and then again SAGE64 set.  I have yet to test it on the skynet machines.


---

Comment by jhpalmieri created at 2010-11-20 00:54:29

By the way, if you want to install and test it, if the spkg seems to install okay, you can execute the following commands in Sage.  The first homology computation should be a lot faster than the second; I'm showing timings on my 2-year-old iMac:

```
sage: S3 = simplicial_complexes.Sphere(3)
sage: X = S3.product(S3)
sage: time X.homology()
CPU times: user 0.03 s, sys: 0.02 s, total: 0.05 s
Wall time: 0.48 s
{0: 0, 1: 0, 2: 0, 3: Z x Z, 4: 0, 5: 0, 6: Z}
sage: time X.homology(algorithm='no_chomp')
CPU times: user 15.71 s, sys: 0.17 s, total: 15.87 s
Wall time: 16.31 s
{0: 0, 1: 0, 2: 0, 3: Z x Z, 4: 0, 5: 0, 6: Z}
```



---

Comment by jhpalmieri created at 2010-11-20 19:36:41

The new patch for the scripts repo adds the CHomP binaries "homsimpl", "homchain", and "homcubes" to SAGE_ROOT/local/bin/.hgignore.


---

Comment by jhpalmieri created at 2010-11-20 19:37:00

scripts repo


---

Attachment

Is there a new .spkg to test? The one in the link given in the description lack anything to handle the SAGE64=yes case.


---

Comment by drkirkby created at 2010-11-21 00:38:10

I'd also be tempted to change SPKG.txt a bit from 

_"doesn't seem to expect Solaris on anything except a sparc"_

We now now more precisely the problem - the original code assumed Solaris only if the processor was SPARC, where now it assumes Solaris is 'sun' is defined. But I don't mind making that as a review patch. But an spkg to test would be nice. 


Dave


---

Comment by drkirkby created at 2010-11-21 00:39:59

Sorry about the grammar in my last comment. There are too many spelling/grammatical errors to even start to address them individually!


---

Comment by jhpalmieri created at 2010-11-21 00:59:42

I updated the spkg when I posted the new patch, so it does deal with 64-bit issues.  (In general, if I update the patch here, I should also have updated the spkg.)  I can also make the change to SPKG.txt.


---

Comment by jhpalmieri created at 2010-11-21 01:10:19

for reference only; do not apply


---

Attachment

Okay, I've changed SPKG.txt a little, as Dave suggested.


---

Comment by drkirkby created at 2010-11-21 01:52:46

Changing status from needs_review to positive_review.


---

Comment by drkirkby created at 2010-11-21 01:52:46

Sorry John. 

This is odd. When I try to install with 'sage -i', the variable SAGE64 was ignored, which concluded me to believe you had not updated the .spkg. 


```
drkirkby`@`hawk:~/sage-4.6.1.alpha2$ export SAGE64=yes
drkirkby`@`hawk:~/sage-4.6.1.alpha2$ ./sage -i http://sage.math.washington.edu/home/palmieri/SPKG/chomp-20100213.p2.spkg
Building Sage on Solaris in 64-bit mode
Creating SAGE_LOCAL/lib/sage-64.txt since it does not exist
Detected SAGE64 flag
Building Sage on Solaris in 64-bit mode
Installing http://sage.math.washington.edu/home/palmieri/SPKG/chomp-20100213.p2.spkg
Calling sage-spkg on http://sage.math.washington.edu/home/palmieri/SPKG/chomp-20100213.p2.spkg
Warning: Attempted to overwrite SAGE_ROOT environment variable
Building Sage on Solaris in 64-bit mode
Creating SAGE_LOCAL/lib/sage-64.txt since it does not exist
Detected SAGE64 flag
Building Sage on Solaris in 64-bit mode
chomp-20100213.p2
Machine:
SunOS hawk 5.11 snv_134 i86pc i386 i86pc
Deleting directories from past builds of previous/current versions of chomp-20100213.p2
Extracting package /export/home/drkirkby/sage-4.6.1.alpha2/spkg/optional/chomp-20100213.p2.spkg ...
-rw-r--r--   1 drkirkby staff     804047 Nov 19 01:23 /export/home/drkirkby/sage-4.6.1.alpha2/spkg/optional/chomp-20100213.p2.spkg
Finished extraction
****************************************************
Host system
uname -a:
SunOS hawk 5.11 snv_134 i86pc i386 i86pc
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
COLLECT_GCC=/usr/local/gcc-4.5.0/bin/gcc
COLLECT_LTO_WRAPPER=/usr/local/gcc-4.5.0/libexec/gcc/i386-pc-solaris2.10/4.5.0/lto-wrapper
Target: i386-pc-solaris2.10
Configured with: ../gcc-4.5.0/configure --prefix=/usr/local/gcc-4.5.0 --build=i386-pc-solaris2.10 --enable-languages=c,c++,fortran --with-gmp=/usr/local/gcc-4.5.0 --with-mpfr=/usr/local/gcc-4.5.0 --disable-nls --enable-checking=release --enable-werror=no --enable-multilib -with-system-zlib --enable-bootstrap --with-gnu-as --with-as=/usr/local/binutils-2.20/bin/as --without-gnu-ld --with-ld=/usr/ccs/bin/ld
Thread model: posix
gcc version 4.5.0 (GCC) 
****************************************************
make -C make target=sun
make[1]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
make -f makemain target=sun module=bitmaps
make[2]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
g++ -O2 -ansi -pedantic -Wall -I../include  -o ../obj/bitmaps/bitmaps.o -c \
	../src/bitmaps/bitmaps.cpp
ar cru ../lib/libchompbitmaps.a ../obj/bitmaps/bitmaps.o
ranlib ../lib/libchompbitmaps.a
make[2]: Leaving directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
make -f makemain target=sun module=capd-auxil
make[2]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
g++ -O2 -ansi -pedantic -Wall -I../include  -o ../obj/capd-auxil/memSize.o -c \
	../src/capd-auxil/memSize.cpp
```


*i.e. there are not -m64's anywhere*

Now having copied the spkg to /tmp



```
drkirkby`@`hawk:~/sage-4.6.1.alpha2$ ./sage -f /tmp/chomp-20100213.p2.spkg
Building Sage on Solaris in 64-bit mode
Creating SAGE_LOCAL/lib/sage-64.txt since it does not exist
Detected SAGE64 flag
Building Sage on Solaris in 64-bit mode
Force installing /tmp/chomp-20100213.p2.spkg
Calling sage-spkg on /tmp/chomp-20100213.p2.spkg
Warning: Attempted to overwrite SAGE_ROOT environment variable
Building Sage on Solaris in 64-bit mode
Creating SAGE_LOCAL/lib/sage-64.txt since it does not exist
Detected SAGE64 flag
Building Sage on Solaris in 64-bit mode
chomp-20100213.p2
Machine:
SunOS hawk 5.11 snv_134 i86pc i386 i86pc
Deleting directories from past builds of previous/current versions of chomp-20100213.p2
Extracting package /tmp/chomp-20100213.p2.spkg ...
-rw-r--r--   1 drkirkby staff     803975 Nov 21 01:08 /tmp/chomp-20100213.p2.spkg
Finished extraction
****************************************************
Host system
uname -a:
SunOS hawk 5.11 snv_134 i86pc i386 i86pc
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
COLLECT_GCC=/usr/local/gcc-4.5.0/bin/gcc
COLLECT_LTO_WRAPPER=/usr/local/gcc-4.5.0/libexec/gcc/i386-pc-solaris2.10/4.5.0/lto-wrapper
Target: i386-pc-solaris2.10
Configured with: ../gcc-4.5.0/configure --prefix=/usr/local/gcc-4.5.0 --build=i386-pc-solaris2.10 --enable-languages=c,c++,fortran --with-gmp=/usr/local/gcc-4.5.0 --with-mpfr=/usr/local/gcc-4.5.0 --disable-nls --enable-checking=release --enable-werror=no --enable-multilib -with-system-zlib --enable-bootstrap --with-gnu-as --with-as=/usr/local/binutils-2.20/bin/as --without-gnu-ld --with-ld=/usr/ccs/bin/ld
Thread model: posix
gcc version 4.5.0 (GCC) 
****************************************************
make -C make target=sun
make[1]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
make -f makemain target=sun module=bitmaps
make[2]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
g++  -m64 -O2 -pedantic -Wall -I../include  -o ../obj/bitmaps/bitmaps.o -c \
	../src/bitmaps/bitmaps.cpp
ar cru ../lib/libchompbitmaps.a ../obj/bitmaps/bitmaps.o
ranlib ../lib/libchompbitmaps.a
make[2]: Leaving directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
make -f makemain target=sun module=capd-auxil
make[2]: Entering directory `/export/home/drkirkby/sage-4.6.1.alpha2/spkg/build/chomp-20100213.p2/src/make'
g++  -m64 -O2 -pedantic -Wall -I../include  -o ../obj/capd-auxil/memSize.o -c \
	../src/capd-auxil/memSize.cpp
g++  -m64 -O2 -pedantic -Wall -I../include  -o ../obj/capd-auxil/ofstreamcout.o -c \
	../src/capd-auxil/ofstreamcout.cpp

```


Very odd. But positive review. 

Thank you for fixing this.


---

Comment by jhpalmieri created at 2010-11-21 02:37:24

Replying to [comment:17 drkirkby]:
> Sorry John. 
> 
> This is odd. When I try to install with 'sage -i', the variable SAGE64 was ignored, which concluded me to believe you had not updated the .spkg. 

I _think_ that when you run "sage -i", if you give it a URL, it sees if it has saved a copy somewhere local, and if so, it uses that instead of downloading it again.  If you give it a path, it uses the file.  If I'm right, that would explain it.


---

Comment by drkirkby created at 2010-11-21 08:50:07

Replying to [comment:18 jhpalmieri]:
> Replying to [comment:17 drkirkby]:
> > Sorry John. 
> > 
> > This is odd. When I try to install with 'sage -i', the variable SAGE64 was ignored, which concluded me to believe you had not updated the .spkg. 
> 
> I _think_ that when you run "sage -i", if you give it a URL, it sees if it has saved a copy somewhere local, and if so, it uses that instead of downloading it again.  If you give it a path, it uses the file.  If I'm right, that would explain it.

Thanks John, you are right. 

Although this experiemental package is not going to be merged into Sage, someone needs to take care that the version on the Sage web site is updated. I don't know if that's something the release manager can do, or if someone else has to do it. 

Dave


---

Comment by drkirkby created at 2010-11-21 08:53:27

Although experimental packages don't need a review, I filled in the author and reviewer fields, since this has undergone a review. 

Dave


---

Comment by jdemeyer created at 2010-12-02 16:08:17

.hgignore patch will be merged


---

Comment by jdemeyer created at 2010-12-02 16:08:17

Resolution: fixed
