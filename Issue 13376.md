# Issue 13376: Parellel map reduce on SearchForest

Issue created by migration from https://trac.sagemath.org/ticket/13580

Original creator: hivert

Original creation time: 2012-10-07 17:07:38

Assignee: hivert

CC:  sage-combinat ncohen â€‹jdemeyer slabbe

Keywords: map-reduce

Implement a map reduce algorithm in parallel on large sets described by a `SearchForest`.


---

Comment by slabbe created at 2013-02-09 18:12:42

Salut Florent et Nathann,

I am starting to think/work on #6637... I have some questions. Mainly, I would like to know what is this ticket, because the above one liner in the description does not say much...

 - Will SearchForest survive or not? 
 - Does it replace SearchForest?
 - Does it improve SearchForest? 
 - Does it use SearchForest?
 - Or is it used by SearchForest?

Also, Florent wrote on [sage-devel](https://groups.google.com/d/msg/sage-devel/5XHvEx89RlQ/Tb_QBWepC5YJ) in October 2012 that 


```
   I'm also in the process of finalizing a patch which do parallel and even
   distributed map-reduce on recursively enumerated sets (currently badly named
   SearchForest, I'll change the name in my patch, ticket #13580, patch on
   Sage-Combinat queue [1]).
```


 - I do not see in the cited patch that the name of SearchForest is changed.
 - What would be a better name for SearchForest ?
 - What patch is the more recent? the "old" one or the "experimental" one?


```
    trac_13580-map_reduce-fh.patch #+experimental
    map_reduce_improved_loop-fh.patch #+experimental
    map_reduce_condition-fh.patch #+experimental
    trac_13580-map_reduce-old-fh.patch 
```



---

Comment by hivert created at 2014-04-09 02:56:21

New commits:


---

Comment by hivert created at 2014-04-09 02:56:21

Changing keywords from "map-reduce" to "map-reduce, days57".


---

Comment by git created at 2015-03-09 15:47:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-20 22:49:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-20 23:06:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-05-21 07:51:43

I saw the following typo in map reduce file while looking at the previous commit: "As an example, ee compute"


---

Comment by git created at 2015-05-21 15:42:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-23 11:06:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-26 11:09:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-01 08:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-14 13:02:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-14 13:57:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-14 14:07:27

Changing status from new to needs_review.


---

Comment by slabbe created at 2015-12-14 16:49:12

The branch currently have conflicts with development version of Sage (because the link is red in the description of the ticket above). The branch seems to be based on 6.2.beta6 which is old and may explain the presence of a conflict.


---

Comment by slabbe created at 2015-12-14 16:49:12

Changing status from needs_review to needs_work.


---

Comment by hivert created at 2015-12-14 19:38:34

Replying to [comment:21 slabbe]:
> The branch currently have conflicts with development version of Sage (because the link is red in the description of the ticket above). The branch seems to be based on 6.2.beta6 which is old and may explain the presence of a conflict.

Yes ! there is a trivial conflict. Thank you for pointing it. I'm fixing it, testing and re-uploading.


---

Comment by git created at 2015-12-14 20:29:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-14 20:53:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-14 20:56:30

Replying to [comment:22 hivert]:
> Replying to [comment:21 slabbe]:
> > The branch currently have conflicts with development version of Sage (because the link is red in the description of the ticket above). The branch seems to be based on 6.2.beta6 which is old and may explain the presence of a conflict.
> 
> Yes ! there is a trivial conflict. Thank you for pointing it. I'm fixing it, testing and re-uploading.

Done ! I was actually based on 6.9.


---

Comment by hivert created at 2015-12-14 20:56:30

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-12-14 21:32:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-14 22:18:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-15 07:19:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-15 07:20:34

Replying to [comment:29 git]:
> ||[5c7720d](http://git.sagemath.org/sage.git/commit/?id=5c7720dae1034f1b2e04bb9abb3ea90797de55ee)||`Fixed doctest continuations and raise statements`||

Patchbot was complaining about old style multiline doctests and exception raises. Fixed and reuped. Should be Ok now.


---

Comment by git created at 2015-12-15 16:03:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-12-15 20:14:04

I just looked at the code in the browser. Looks good. I will do real code review later this week hopefully. Quickly, I saw two typos:

First line of `/src/sage/parallel/map_reduce.py` : `Paralell`

Later in the same file I think: `parameters tu the`


---

Comment by git created at 2015-12-15 21:10:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-15 21:14:26

Replying to [comment:32 slabbe]:
> I just looked at the code in the browser. Looks good. I will do real code review later this week hopefully. Quickly, I saw two typos:

Fixed ! I'm afraid you'll find more ! By the way, removed distributed from the title since I don't do distributed computation anymore. I had a prototype which allowed to launch those computation on a cluster of machines, but it induces a huge performance loss do I dropped It. maybe we will work on this with Jeroen...


---

Comment by slabbe created at 2015-12-16 11:34:47

Dear Florent, I know that you like multiline doctests, but for two reasons I prefer to avoid them as much as possible in doctests:

 1. It is not fun for the user who wants to adapt an example after a copy paste in the console. The up arrow brings the multiline all at once and it is not fun to change the value 10 to a value 25 let say.
 2. Using variables to store the input before calling the method gives lot of information easily to the user: what are the argument names, in what order should they be used.

I know I am asking you to change your style by asking you this, but don't you agree with me or can you provide some counter-arguments to mine? I give an example below:


```diff
diff --git a/src/sage/combinat/backtrack.py b/src/sage/combinat/backtrack.py
index 9dee057..ac1243a 100644
--- a/src/sage/combinat/backtrack.py
+++ b/src/sage/combinat/backtrack.py
@@ -695,17 +695,19 @@ class SearchForest(Parent):
                    reduce_function = None,
                    reduce_init = None):
         r"""
-        Apply en Map Reduce algorithm on ``self``
+        Apply a Map Reduce algorithm on ``self``
 
         EXAMPLES::
 
-            sage: F = RecursivelyEnumeratedSet( [([i],i, i) for i in range(1,10)],
-            ....:     lambda (list, sum, last):
-            ....:         [(list + [i], sum + i, i) for i in range(1,last)],
-            ....:     structure='forest', enumeration='depth')
+            sage: seeds = [([i],i, i) for i in range(1,10)]
+            sage: succ = lambda (list, sum, last): 
+            ....:               [(list + [i], sum + i, i) for i in range(1,last)]
+            sage: F = RecursivelyEnumeratedSet(seeds, succ, 
+            ....:                       structure='forest', enumeration='depth')
             sage: y = var('y')
-            sage: F.map_reduce(
-            ....:     lambda (li, sum, _): y**sum, lambda x,y: x + y,  0 )
+            sage: map_function = lambda (li, sum, _): y**sum
+            sage: reduce_function = lambda x,y: x + y
+            sage: F.map_reduce(map_function, reduce_function, 0)
             y^45 + y^44 + y^43 + 2*y^42 + 2*y^41 + 3*y^40 + 4*y^39 + 5*y^38 + 6*y^37 + 8*y^36 + 9*y^35 
 
         .. SEEALSO:: :mod:`sage.parallel.map_reduce`
```


I noticed another typo on the same line as the one `parameters tu the` : `On` -> `One`


---

Comment by hivert created at 2015-12-16 23:27:20

Replying to [comment:35 slabbe]:
> Dear Florent, I know that you like multiline doctests, but for two reasons I prefer to avoid them as much as possible in doctests:
> 
>  1. It is not fun for the user who wants to adapt an example after a copy paste in the console. The up arrow brings the multiline all at once and it is not fun to change the value 10 to a value 25 let say.

I'm tempted to answer that I don't have this problem with emacs ;-). Of course, for the people using a two letters editor...

>  2. Using variables to store the input before calling the method gives lot of information easily to the user: what are the argument names, in what order should they be used.

I'm much more convinced by this argument. I'm watching an exam tomorrow evening. I'll change my code accordingly.


---

Comment by hivert created at 2015-12-17 13:51:09

Replying to [comment:36 hivert]:
> I'm much more convinced by this argument. I'm watching an exam tomorrow evening. I'll change my code accordingly.

Actually, I'm not that much convinced. It's not clear for me that

```
      sage: map_function = lambda x: 1
      sage: reduce_function = lambda x,y: x+y
      sage: reduce_init = 0
      sage: S.map_reduce(map_function, reduce_function, reduce_init)
      131071
```

is much better than

```
      sage: S.map_reduce(
      ....:   map_function = lambda x: 1,
      ....:   reduce_function = lambda x,y: x+y,
      ....:   reduce_init = 0 )
```

In this second version which is the style I adopted in `map_reduce.py`, we don't repeat the name twice, which is better in my opinion.

A third possibility is

```
      sage: S.map_reduce(lambda x: 1, lambda x,y: x+y, 0)
```

It is the one used through the whole `backtrack.py` files. Unless for very short example, I don't find it very readable. But since it's not adding new code but changing old one, which needs even more cleanup and doc improvement, I'd rather keep it for another ticket. More precisly, I'd rather do that during #16351.

What do you think ?


---

Comment by hivert created at 2015-12-17 13:53:26

I'm not sure to understand the patchbot complaint ? Is it because the `map_reduce` is not imported as Sage's startup ?


---

Comment by hivert created at 2015-12-17 14:02:02

I just uploaded a doc improvement: the `map_reduce` function was missing the description of the input.


---

Comment by git created at 2015-12-17 14:02:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-17 18:13:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-12-18 14:23:10

Replying to [comment:37 hivert]:
> What do you think ?

I think that some doctest are more important than other, especially the first doctests that people might be expected to see when using the map reduce code. For example the `map_reduce` method in the recursively enumerated set file is one possible entry point where clarity of doctests matters more. Therefore, I like the way you change the doctest. Definitively, the top of the module is an important entry point. For other sub methods of the class map reduce, I care less...


---

Comment by slabbe created at 2015-12-18 14:23:50

Replying to [comment:38 hivert]:
> I'm not sure to understand the patchbot complaint ? Is it because the `map_reduce` is not imported as Sage's startup ?  

I don't see why neither...


---

Comment by slabbe created at 2015-12-18 16:17:51

`Event`, `Condition`, `time` and `os` are imported in map_reduce file but are not used.


---

Comment by slabbe created at 2015-12-18 16:20:34

Is there a reason why you use `res=[""]` and `res[0]` in `print_communication_statistics` instead of `res=""` and `res`?


---

Comment by hivert created at 2015-12-18 17:32:55

Replying to [comment:45 slabbe]:
> Is there a reason why you use `res=[""]` and `res[0]` in `print_communication_statistics` instead of `res=""` and `res`?

Yes ! This is the classical trick to have a local variable shared with the local function (see e.g: http://stackoverflow.com/questions/2609518/python-nested-function-scopes).


---

Comment by hivert created at 2015-12-18 17:49:04

Replying to [comment:44 slabbe]:
> `Event`, `Condition`, `time` and `os` are imported in map_reduce file but are not used.

Fixed in my last push.


---

Comment by git created at 2015-12-18 17:49:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-18 17:52:51

Replying to [comment:43 slabbe]: 
> I don't see why neither...

According to Vincent on Sage devel it is probably a bug of the patchbot (see https://groups.google.com/forum/#!topic/sage-devel/xlpLwktA5Hk).


---

Comment by slabbe created at 2015-12-21 10:56:59

Replying to [comment:46 hivert]:
> Replying to [comment:45 slabbe]:
> > Is there a reason why you use `res=[""]` and `res[0]` in `print_communication_statistics` instead of `res=""` and `res`?
> 
> Yes ! This is the classical trick to have a local variable shared with the local function (see e.g: http://stackoverflow.com/questions/2609518/python-nested-function-scopes).

Could you add this information inside the code of that method?


---

Comment by slabbe created at 2015-12-21 13:44:49

`map_reduce` method of `SearchForest` should document what happen when this method is called with no arguments, i.e. returns the cardinality. More precisely, it should say that the value `None` for arguments `map_function` and `reduce_function` is replaced by what?


---

Comment by slabbe created at 2015-12-21 13:54:26

`On can use the three following parameters:` -> `One can use the three following parameters:`


---

Comment by slabbe created at 2015-12-21 14:09:19

I get the following doctests error on top on sage-6.10 on my machine:


```
Git branch: 13580
Using --optional=gcc,mpir,python2,sage
Doctesting 1 file.
sage -t --warn-long 85.4 map_reduce.py
**********************************************************************
File "map_reduce.py", line 960, in sage.parallel.map_reduce.RESetMapReduce._signal_task_start
Failed example:
    S._active_tasks
Expected:
    <Semaphore(value=2)>
Got:
    <Semaphore(value=unknown)>
**********************************************************************
File "map_reduce.py", line 964, in sage.parallel.map_reduce.RESetMapReduce._signal_task_start
Failed example:
    S._active_tasks
Expected:
    <Semaphore(value=3)>
Got:
    <Semaphore(value=unknown)>
**********************************************************************
File "map_reduce.py", line 985, in sage.parallel.map_reduce.RESetMapReduce._signal_task_done
Failed example:
    S._active_tasks
Expected:
    <Semaphore(value=2)>
Got:
    <Semaphore(value=unknown)>
**********************************************************************
File "map_reduce.py", line 989, in sage.parallel.map_reduce.RESetMapReduce._signal_task_done
Failed example:
    S._active_tasks
Expected:
    <Semaphore(value=1)>
Got:
    <Semaphore(value=unknown)>
**********************************************************************
2 items had failures:
   2 of   9 in sage.parallel.map_reduce.RESetMapReduce._signal_task_done
   2 of   7 in sage.parallel.map_reduce.RESetMapReduce._signal_task_start
    [249 tests, 4 failures, 43.04 s]
----------------------------------------------------------------------
sage -t --warn-long 85.4 map_reduce.py  # 4 doctests failed
----------------------------------------------------------------------
```


It seems ok on patchbot reporting seemingly unrelated errors :


```
----------------------------------------------------------------------
sage -t --long src/sage/interfaces/expect.py  # Timed out
sage -t --long src/sage/interfaces/gap.py  # 10 doctests failed
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2015-12-21 14:24:23

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2015-12-21 14:24:23

I divided the review in a stack of tasks but since I am unable to parallelize my working time, I did the review serially with many interruptions during the previous days:)

I finished to look at what I wanted to look at. The documentation compiles good and helps to understand what is happening. I was able to test the parallel computation on at least one extensive example. To me it will be a positive review after my previous four comments are answered.


---

Comment by hivert created at 2015-12-21 14:49:03

Replying to [comment:53 slabbe]:
> I get the following doctests error on top on sage-6.10 on my machine:
> 
> {{{
> Expected:
>     <Semaphore(value=1)>
> Got:
>     <Semaphore(value=unknown)>
> }}}

Is this happening on MacOS ? I know that Semaphore are implemented differently on this system. See in particular [the note](https://docs.python.org/2/library/multiprocessing.html#synchronization-primitives) after class `multiprocessing.BoundedSemaphore`, where it says:

    on Unix platforms like Mac OS X where sem_getvalue() is not implemented.

If so and if the rests behave correctly, I'm tempted to replace the doctests with

```
    <Semaphore(value=...)>
```


What do you think ?


---

Comment by hivert created at 2015-12-21 14:58:26

Replying to [comment:51 slabbe]:
> `map_reduce` method of `SearchForest` should document what happen when this method is called with no arguments, i.e. returns the cardinality. More precisely, it should say that the value `None` for arguments `map_function` and `reduce_function` is replaced by what?

I didn't document this one because I'm was not sure It was a sensible default. If you think it is then let's go for it.

By the way thanks for your careful review !!!

Florent


---

Comment by git created at 2015-12-21 15:17:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2015-12-21 15:18:35

I uploaded a patch which should address all your concerns:
- tests on MacOSX
- typos
- default values documentation


---

Comment by slabbe created at 2015-12-21 19:25:20

Introduced typo in the previous commit: `the function costant to 1.` -> `constant`


---

Comment by slabbe created at 2015-12-21 19:29:59

Replying to [comment:55 hivert]:
> Replying to [comment:53 slabbe]:
> > I get the following doctests error on top on sage-6.10 on my machine:
> > 
> > {{{
> > Expected:
> >     <Semaphore(value=1)>
> > Got:
> >     <Semaphore(value=unknown)>
> > }}}
> 
> Is this happening on MacOS ? 

Yes

> If so and if the rests behave correctly, I'm tempted to replace the doctests with
> {{{
>     <Semaphore(value=...)>
> }}}
> 
> What do you think ? 

I agree. All tests passed now...


---

Comment by slabbe created at 2015-12-21 19:33:59

Replying to [comment:56 hivert]:
> I didn't document this one because I'm was not sure It was a sensible default. If you think it is then let's go for it.

I think it is a good default. Also, sometimes, you may want to set only some of the arguments and this information allows it. Finally, it's good to see that cardinality is a special case of this method.


---

Comment by slabbe created at 2015-12-22 12:53:19

Just to be clear: I am waiting for the `costant` -> `constant` fix to change the status to positive review.


---

Comment by nthiery created at 2015-12-24 08:18:23

Typo fixed, hence changing the status to positive review on Sebastien's behalf.
----
New commits:


---

Comment by nthiery created at 2015-12-24 08:18:23

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-12-24 17:13:25

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-12-24 17:13:25

Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/636/steps/shell_4/logs/stdio


---

Comment by elixyre created at 2015-12-26 14:25:08

Hello and merry christmas every one,

I have some question on this ticket.

Firstly, I don't understand the documentation from the line 571:


```
    Decription of the map/reduce operation:

    - ``map_function=f`` -- (default to ``None``)
    - ``reduce_function=red`` -- (default to ``None``)
    - ``reduce_init=init`` -- (default to ``None``)
```


What means `f`, `red` and `init`? My opinion is that `f`, `red`and `init` are irrelevant but an example should be interesting at this point: 

(copy-paste of one in the module documentation)

```
 sage: from sage.parallel.map_reduce import RESetMapReduce
 sage: S = RESetMapReduce(
 ....:   roots = [[]],
 ....:   children = lambda l: [l+[0], l+[1]] if len(l) <= 15 else [],
 ....:   map_function = lambda x : 1,
 ....:   reduce_function = lambda x,y: x+y,
 ....:   reduce_init = 0 )
 sage: S.run()
 131071
```


Ok, there is the `seealso` which says go to see the documentation of the module for examples, but one example there is interesting, no?

Then it seems there is some useless import (like line 1345 `from multiprocessing import current_process`) (I try to compile sage soon and I can remove all useless import if you want).

Finally, I'm not sure to understand the use of `AbortError`. It is used to abort the computation and to say to the workers and the thiefs every think is done?

Jean-Baptiste


---

Comment by slabbe created at 2015-12-28 09:48:47

Replying to [comment:66 vbraun]:
> Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/636/steps/shell_4/logs/stdio

I can not reproduce this problem on my Mac OS X Yosemite 10.10.2:


```
$ sage -tp --long src/sage/parallel/map_reduce.py 
Running doctests with ID 2015-12-28-10-44-31-65e477d9.
Git branch: 13580
Using --optional=gcc,mpir,python2,sage
Doctesting 1 file using 2 threads.
sage -t --long --warn-long 85.0 src/sage/parallel/map_reduce.py
    [252 tests, 40.89 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by elixyre created at 2016-01-06 10:56:19

Hello,

I can reproduce test failures on El Capitan (os x):

 - [log_map_reduce](http://kerios.fr/downloads/sage/2016/log_map_reduce)
 - [log_map_reduce2](http://kerios.fr/downloads/sage/2016/log_map_reduce2)
 - [log_map_reduce3](http://kerios.fr/downloads/sage/2016/log_map_reduce3)

I run 3 tests and I obtained 3 distincts failures. My problem is that if I try to execute those lines which fails in sage terminal (several times) then it does not fail!

Is it possible that the test environment is not robust specially on mac os?


---

Comment by elixyre created at 2016-01-11 09:17:16

I read the code and I don't know how to understand this:


```
res = post_process(node)
if res is not None:
    self._res = reduc(self._res, mapp(res))
```


in the worker code of `walk_branch_locally` method.

I think this is useless, no? Or if not then the documentation of `post_process` function should be improve to specify that if `post_process` returns `None` then there is a specific behavior.


---

Comment by elixyre created at 2016-01-11 09:33:26

Replying to [comment:70 elixyre]:
> {{{
> res = post_process(node)
> if res is not None:
>     self._res = reduc(self._res, mapp(res))
> }}}
> I think this is useless, no? Or if not then the documentation of `post_process` function should be improve to specify that if `post_process` returns `None` then there is a specific behavior.

Ok, this behavior is specify in the documentation of `RESetMapReduce` but this is not specified in paragraph (line 135) associated of this module.


---

Comment by elixyre created at 2016-01-11 09:35:44

Furthermore the lines:

```
for child in newnodes: 
    self._todo.append(child)
```

of `walk_branch_locally` should be replaced by

```
self._todo_.extend(newnodes)
```


(I just notice that I read and if you are agree with my remark then I can replace that)


---

Comment by elixyre created at 2016-01-11 10:08:16

Go back to `None` activities, if I assume some users want to use _nodes_ which could be `None` then my first idea is to use the `post_process` function to avoid problem but... if the _thief_ doesn't receive then he send `None` and he says there is no job to do.

I propose two solutions:
 - first one, to specify that `None` is not a node never! (this is assumed but this must be explicited in the documentation),
 - second one (the object way), to define an object `NoTask`.

Opinion?


---

Comment by hivert created at 2016-01-12 08:44:42

Replying to [comment:73 elixyre]:
> Go back to `None` activities, if I assume some users want to use _nodes_ which could be `None` then my first idea is to use the `post_process` function to avoid problem but... if the _thief_ doesn't receive then he send `None` and he says there is no job to do.
> 
> I propose two solutions:
>  - first one, to specify that `None` is not a node never! (this is assumed but this must be explicited in the documentation),

I'm clearly in Favor of this solution. We assume that `None` doesn't blong to the set described by the underlying RESet. Note that this is something which concerns more the underlying RESet than the map-reduce computation.


---

Comment by hivert created at 2016-01-12 09:56:33

New commits:


---

Comment by git created at 2016-01-12 10:02:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2016-01-15 15:53:49

Replying to [comment:66 vbraun]:
> Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/636/steps/shell_4/logs/stdio

We finally got the problem with Jean-Baptiste. It occurs that semaphore are broken on MacOSX (or at least are not fully POSIX compliant). In particular, on standard unixes, when two processes are trying to acquire a semaphore whose value is more than two, they always both succeeded. On MacOS, one of them may fail. As a consequence, I'm writing a different code form MacOS relying on a Lock and a shared integer. It may be slower on system where semaphore are implemented in a lockless way.

Is there a standard Sage/Python way to check if we are on MacOS ?


---

Comment by elixyre created at 2016-01-17 20:00:07

New commits:


---

Comment by elixyre created at 2016-01-17 20:04:03

I pushed the modifications done with Florent about mac os problem.

It seems there still exists the problem of synchronization with the `Pipe` (of the worker) but... it is never appear... so may be I am wrong.

Is it possible that two distinct process write in the same time on the `_write_task` of a worker?


---

Comment by hivert created at 2016-02-02 10:43:15

I just uploaded a version which hopefully should be working on all OSes including MacOS. Please tests on various oses and report any failure here. I don't put needs review yet because it needs a few refactoring and the coverage it not yet 100%. 
----
New commits:


---

Comment by git created at 2016-02-03 09:11:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-16 16:01:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-06 17:24:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-07 09:20:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-07 09:30:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2016-04-07 09:35:58

Changing keywords from "map-reduce, days57" to "map-reduce, days57, days77".


---

Comment by hivert created at 2016-04-07 09:35:58

Changing status from needs_work to needs_review.


---

Comment by hivert created at 2016-04-07 09:35:58

I just uploaded a patch with basically two implementation of `ActiveTaskCounter`: one using semaphore and which doesn't work on MACOS and one using semaphore for all POSIX compliant OSes. It should be ready for review.


---

Comment by git created at 2016-04-07 13:02:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-07 17:03:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2016-04-07 17:27:07

I get the following errors on OSX :


```
Running doctests with ID 2016-04-07-19-23-55-8fd43b63.
Git branch: 13580
Using --optional=dot2tex,mpir,python2,sage
Doctesting 1 file using 2 threads.
sage -t --long --warn-long 84.5 src/sage/parallel/map_reduce.py
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 727, in sage.parallel.map_reduce.ActiveTaskCounterPosix.__repr__
Failed example:
    ATC(4)
Expected:
    ActiveTaskCounter(value=4)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x190d32e90>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 743, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start
Failed example:
    c = ATC(4); c
Expected:
    ActiveTaskCounter(value=4)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x190d32e50>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 745, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start
Failed example:
    c.task_start()
Exception raised:
    Traceback (most recent call last):
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start[2]>", line 1, in <module>
        c.task_start()
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py", line 764, in task_start
        return self._active_tasks.get_value()
      File "/Users/slabbe/Applications/sage-git/local/lib/python/multiprocessing/synchronize.py", line 114, in get_value
        return self._semlock._get_value()
    NotImplementedError
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 747, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start
Failed example:
    c
Expected:
    ActiveTaskCounter(value=5)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x190d32e50>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 755, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start
Failed example:
    c
Expected:
    ActiveTaskCounter(value=0)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x190d32f90>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 778, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_done
Failed example:
    c = ATC(4); c
Expected:
    ActiveTaskCounter(value=4)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x1026a5c10>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 780, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_done
Failed example:
    c.task_done()
Exception raised:
    Traceback (most recent call last):
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.parallel.map_reduce.ActiveTaskCounterPosix.task_done[2]>", line 1, in <module>
        c.task_done()
      File "/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py", line 796, in task_done
        return self._active_tasks.get_value()
      File "/Users/slabbe/Applications/sage-git/local/lib/python/multiprocessing/synchronize.py", line 114, in get_value
        return self._semlock._get_value()
    NotImplementedError
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 782, in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_done
Failed example:
    c
Expected:
    ActiveTaskCounter(value=3)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x1026a5c10>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 805, in sage.parallel.map_reduce.ActiveTaskCounterPosix.abort
Failed example:
    c = ATC(4); c
Expected:
    ActiveTaskCounter(value=4)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x1026a5910>) failed: NotImplementedError>
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 808, in sage.parallel.map_reduce.ActiveTaskCounterPosix.abort
Failed example:
    c
Expected:
    ActiveTaskCounter(value=0)
Got:
    <repr(<sage.parallel.map_reduce.ActiveTaskCounterPosix at 0x1026a5910>) failed: NotImplementedError>
**********************************************************************
4 items had failures:
   1 of   3 in sage.parallel.map_reduce.ActiveTaskCounterPosix.__repr__
   2 of   5 in sage.parallel.map_reduce.ActiveTaskCounterPosix.abort
   3 of   7 in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_done
   4 of   8 in sage.parallel.map_reduce.ActiveTaskCounterPosix.task_start
    [296 tests, 10 failures, 33.64 s]
----------------------------------------------------------------------
sage -t --long --warn-long 84.5 src/sage/parallel/map_reduce.py  # 10 doctests failed
----------------------------------------------------------------------
Total time for all tests: 33.9 seconds
    cpu time: 5.8 seconds
    cumulative wall time: 33.6 seconds
```



---

Comment by slabbe created at 2016-04-07 17:27:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-04-07 17:57:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2016-04-07 18:00:19

It works now! : 


```
Using --optional=dot2tex,mpir,python2,sage
Doctesting 1 file using 2 threads.
sage -t --warn-long 84.3 src/sage/parallel/map_reduce.py
    [296 tests, 32.56 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2016-04-07 18:29:18

some typos:

`compute the the cardinality`

`its job. Non only mapping` -> `Not only`

`method so that to compute the number of element you only need to call::` -> wrap the line

`precedingly by we only ` -> `previously`? , `but` 

I would suggest to replace this:


```
        OUTPUT: Calling :meth:`task_done` decrement the counter and returns
        its value after the decrementation.
```


by


```
        OUTPUT: 

        Calling :meth:`task_done` decrement the counter and returns
        its value after the decrementation.
```


to follow sage standards (more than once).

Also, I would replace this:


```
INPUT: ``o`` -- a node
```


by


```
INPUT: 

- ``o`` -- a node
```


to follow sage standards (more than once).

`the computation are done i` -> s missing


---

Comment by git created at 2016-04-07 21:11:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-07 23:02:46

I am wondering what else is currently needed for this ticket before a positive review?

Also, what are the current plans to cythonize `SearchForest` and the parallel reduce map?


---

Comment by slabbe created at 2016-04-08 00:43:54

What I had in mind for the next step to do was to move the `SearchForest` code from backtrack file into the `recursivelyenumerated_set.pyx` file *and* into the hierarchy of `RecEnumSet` classes so that it benefits for example of methods like the newly added `to_digraph`.


---

Comment by slabbe created at 2016-04-08 00:43:54

Changing status from needs_work to positive_review.


---

Comment by hivert created at 2016-04-08 01:05:41

Replying to [comment:96 tscrim]:
> I am wondering what else is currently needed for this ticket before a positive review?

Sebastien is currently rereading it. I think he is very close to put a positive review.

> Also, what are the current plans to cythonize `SearchForest` and the parallel reduce map?

Concerning Cythonization of map-reduce, my current opinion is that, the code
is designed for case where the computation of the children is costly. In this
case the cost of the current code should be negligible. There are a lot of
function calls, I'm using Python synchronization primitive, but most
importantly, communication is are by pickling/unpickling which is very
slow. So the idea is to reduce at most at possible the communication, but
without drastically changing the technology, I don't think you get a large
improvement without great effort. You'll need to rewrite all the communication
primitive and to inline the function call to the client code.

On the other hand, If you are allowed to write the code directly in C/C++
(which is the case for small basic objects), then the Cilk extension of C is
wonderful. It's a small extension which is supported by GCC since version 5,
ICC and in recent CLANG (https://cilkplus.github.io/). I've several code where
I've been able to have very large speedup. See
e.g. https://hal.archives-ouvertes.fr/hal-00823339/file/article.pdf if you are
curious.

Now if you have a specific use case, I'll be happy to experiment.


---

Comment by hivert created at 2016-04-08 01:07:04

Replying to [comment:97 slabbe]:
> What I had in mind for the next step to do was to move the `SearchForest` code from backtrack file into the `recursivelyenumerated_set.pyx` file *and* into the hierarchy of `RecEnumSet` classes so that it benefits for example of methods like the newly added `to_digraph`.

That was also the next goal in my mind.


---

Comment by slabbe created at 2016-04-08 08:28:49

See #16351


---

Comment by tscrim created at 2016-04-08 09:28:57

Replying to [comment:98 hivert]:
> Replying to [comment:96 tscrim]:
> > Also, what are the current plans to cythonize `SearchForest` and the parallel reduce map?
> 
> Concerning Cythonization of map-reduce, my current opinion is that, the code
> is designed for case where the computation of the children is costly. In this
> case the cost of the current code should be negligible. There are a lot of
> function calls, I'm using Python synchronization primitive, but most
> importantly, communication is are by pickling/unpickling which is very
> slow. So the idea is to reduce at most at possible the communication, but
> without drastically changing the technology, I don't think you get a large
> improvement without great effort. You'll need to rewrite all the communication
> primitive and to inline the function call to the client code.
> 
> On the other hand, If you are allowed to write the code directly in C/C++
> (which is the case for small basic objects), then the Cilk extension of C is
> wonderful. It's a small extension which is supported by GCC since version 5,
> ICC and in recent CLANG (https://cilkplus.github.io/). I've several code where
> I've been able to have very large speedup. See
> e.g. https://hal.archives-ouvertes.fr/hal-00823339/file/article.pdf if you are
> curious.
> 
> Now if you have a specific use case, I'll be happy to experiment.

Christian, Vivien, and I are working on trying to speed up the iteration of finite Coxeter groups by using (subgroups of) permutation groups and the iterator method of generic Coxeter groups, which uses a `SearchForest` (see #11187 and the `CoxeterGroups` category). Our goal is to try and match or beat GAP3 iteration time (which we are about ~30x slower).

We are in the process pushing our successor computation code to Cython and some of our other methods, but we would appreciate any insights you have.

Yet the code on this ticket will definitely help with that. Thank you for finishing it.


---

Comment by hivert created at 2016-04-08 09:51:35

Replying to [comment:101 tscrim]:
> Christian, Vivien, and I are working on trying to speed up the iteration of
> finite Coxeter groups by using (subgroups of) permutation groups and the
> iterator method of generic Coxeter groups, which uses a `SearchForest` (see
> #11187 and the `CoxeterGroups` category). Our goal is to try and match or
> beat GAP3 iteration time (which we are about ~30x slower).

I'll be both very happy and interested to have usecase for this code.

> We are in the process pushing our successor computation code to Cython and
> some of our other methods, but we would appreciate any insights you have.

Do you have a typical example relying on `SearchForest` of code on top of
#11187 that I can profile ? Note that I included in the documentation of
map_reduce.py a guide on how to profile the parallel code. I'd like to measure
the proportion of time that is spend on Coxeter code one one hand and on the
parallel infrastructure on the other.


Now, concerning coxeter group, I'm quite sure that rewriting part of the code
in C/C++ and using advanced parallel stuff (AVX instruction set + SIMD) you
can get speedup a large as several hundreds and even thousand ! As a witness
on https://github.com/hivert/IVMPG I wrote a code whose goal is to enumerate
integer vector modulo permutation group. Compared to the code we have in Sage
which has been Cythonized and optimized by Simon King I manage to get speedup
a large as x2000 ! I need help on the build system to be able to distribute
it. I'm pretty sure the code there is very similar to what you need in Coxeter
groups.

By the way, should we transfer this discussion on #11187 ?


---

Comment by tscrim created at 2016-04-08 10:07:32

Replying to [comment:102 hivert]:
> By the way, should we transfer this discussion on #11187 ?

Done.


---

Comment by vbraun created at 2016-04-08 22:40:20

Resolution: fixed


---

Comment by tmonteil created at 2016-04-15 15:39:00

This ticket breaks the doctests on my patchbot, i do not know whether it is because it is run from a VM or from a 32-bit system, see http://patchbot.sagemath.org/log/0/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-15%2012:13:01?short


---

Comment by tmonteil created at 2016-04-15 15:44:37

Note also that the VM emulates a "Pentium III (Katmai)"


---

Comment by hivert created at 2016-04-15 20:01:58

Replying to [comment:105 tmonteil]:
> This ticket breaks the doctests on my patchbot, i do not know whether it is because it is run from a VM or from a 32-bit system, see http://patchbot.sagemath.org/log/0/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-15%2012:13:01?short

From the error message, it is neither because of 32 bits nor because of the VM but because your (virtual) machine has only one core. The goal of the patch is to distribute computation on several cores. The doctest assumes that your machine has at least 2 cores. I should fix that. Though I'm not sure what to do on those kind of machine. Pretend that they are two core and let the computation run on those two cores ?


---

Comment by hivert created at 2016-04-15 20:16:07

Replying to [comment:107 hivert]:
> From the error message, it is neither because of 32 bits nor because of the VM but because your (virtual) machine has only one core. The goal of the patch is to distribute computation on several cores. The doctest assumes that your machine has at least 2 cores. I should fix that. Though I'm not sure what to do on those kind of machine. Pretend that they are two core and let the computation run on those two cores ?

I just checked that I get the very same errors on my machine pretending that it has only one core.


---

Comment by tmonteil created at 2016-04-15 20:41:23

OK thanks for isolating the culplrit, i made #20449 as a follwup.
