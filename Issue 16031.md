# Issue 16031: Better normalization for function field elements

archive/issues_016031.json:
```json
{
    "body": "CC:  @tscrim @cheuberg @etn40ff jakobkroeker @bhutz @slel\n\nIf K is a field then K(u), the function field, has a reduce() method which cancels the gcd but does not put into a canonical form by (for example) dividing through by the leading coefficient of the denominator to make the denominator monic.  This means that equal elements may have different hashes, and hence that putting function field elements into a set does not work as a mathematician would expect.  For example:\n\n```\nsage: Ku.<u> = FractionField(PolynomialRing(QQ,'u'))\nsage: a = 27*u^2+81*u+243\nsage: b = 27*u-81\nsage: c = u^2 + 3*u + 9\nsage: d = u-3\nsage: s = a/b\nsage: t = c/d\nsage: s==t\nTrue\nsage: len(Set([s,t]))\n2\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16268\n\n",
    "created_at": "2014-04-29T15:00:38Z",
    "labels": [
        "algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Better normalization for function field elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16031",
    "user": "@JohnCremona"
}
```
CC:  @tscrim @cheuberg @etn40ff jakobkroeker @bhutz @slel

If K is a field then K(u), the function field, has a reduce() method which cancels the gcd but does not put into a canonical form by (for example) dividing through by the leading coefficient of the denominator to make the denominator monic.  This means that equal elements may have different hashes, and hence that putting function field elements into a set does not work as a mathematician would expect.  For example:

```
sage: Ku.<u> = FractionField(PolynomialRing(QQ,'u'))
sage: a = 27*u^2+81*u+243
sage: b = 27*u-81
sage: c = u^2 + 3*u + 9
sage: d = u-3
sage: s = a/b
sage: t = c/d
sage: s==t
True
sage: len(Set([s,t]))
2
```


Issue created by migration from https://trac.sagemath.org/ticket/16268





---

archive/issue_comments_208367.json:
```json
{
    "body": "The normalization would already be much better if `PolynomialRing(QQ, 'u')` had a 'better' gcd, like the one implemented for QQ in #10771, which would yield `gcd(27*u^2+81*u+243, 27*u-81)==27`. However the gcd from flint in src/sage/rings/polynomial/polynomial_rational_flint.pyx is monic. \n\nKu could also figure out that it is also `FractionField(PolynomialRing(ZZ, 'u'))`, which has a better reduce.",
    "created_at": "2014-04-29T16:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208367",
    "user": "emassop"
}
```

The normalization would already be much better if `PolynomialRing(QQ, 'u')` had a 'better' gcd, like the one implemented for QQ in #10771, which would yield `gcd(27*u^2+81*u+243, 27*u-81)==27`. However the gcd from flint in src/sage/rings/polynomial/polynomial_rational_flint.pyx is monic. 

Ku could also figure out that it is also `FractionField(PolynomialRing(ZZ, 'u'))`, which has a better reduce.



---

archive/issue_comments_208368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-04-30T08:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208369.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-04-30T08:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208369",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208370.json:
```json
{
    "body": "Thanks, Robert, I will review this.  I had already started by patching the reduce function but had not yet discoivered where the automatic calling of reduction was actually happening.  Your solution -- keeping reduce() and normalise() separate -- looks better.",
    "created_at": "2014-04-30T08:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208370",
    "user": "@JohnCremona"
}
```

Thanks, Robert, I will review this.  I had already started by patching the reduce function but had not yet discoivered where the automatic calling of reduction was actually happening.  Your solution -- keeping reduce() and normalise() separate -- looks better.



---

archive/issue_comments_208371.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-30T08:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208371",
    "user": "@robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_208372.json:
```json
{
    "body": "As of yet the documentation at normalize is incorrect. It reads \"Returns a normalized representation of self\". However it does not return anything.\n\nAlso, shouldn't normalize in `FractionFieldElement` throw a not-implemented-exception or so? Or at least have a warning in its documentation that it might not actually normalize? For instance in `FractionField(PolynomialRing(QQ, 'x,y'))`, calling reduce is still insufficient to do the normalization.",
    "created_at": "2014-04-30T12:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208372",
    "user": "emassop"
}
```

As of yet the documentation at normalize is incorrect. It reads "Returns a normalized representation of self". However it does not return anything.

Also, shouldn't normalize in `FractionFieldElement` throw a not-implemented-exception or so? Or at least have a warning in its documentation that it might not actually normalize? For instance in `FractionField(PolynomialRing(QQ, 'x,y'))`, calling reduce is still insufficient to do the normalization.



---

archive/issue_comments_208373.json:
```json
{
    "body": "What is happening here?  There are/were two commits by Robert Bradshaw but suddenly the branch name has changed to an emassop name.  I assume that this means the emassop is doing something, so I will hold back.\n----\nNew commits:",
    "created_at": "2014-05-02T14:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208373",
    "user": "@JohnCremona"
}
```

What is happening here?  There are/were two commits by Robert Bradshaw but suddenly the branch name has changed to an emassop name.  I assume that this means the emassop is doing something, so I will hold back.
----
New commits:



---

archive/issue_comments_208374.json:
```json
{
    "body": "I changed the documentation to not say \"return\". Then did `git trac push`, but apparently something went wrong, since it only changed the branch name without picking up on the new commithash (and hence the summary of my commit). I was hoping trac-user \"git\" would pick it up with some delay, but apparently not.\n\nI'm not going to change more, as I'm unfamiliar with the conventions about what normalize in `FractionFieldElement` should do when its not actually guaranteeing that numerator and denominator are the same for a == b after calling normalize on both.",
    "created_at": "2014-05-02T15:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208374",
    "user": "emassop"
}
```

I changed the documentation to not say "return". Then did `git trac push`, but apparently something went wrong, since it only changed the branch name without picking up on the new commithash (and hence the summary of my commit). I was hoping trac-user "git" would pick it up with some delay, but apparently not.

I'm not going to change more, as I'm unfamiliar with the conventions about what normalize in `FractionFieldElement` should do when its not actually guaranteeing that numerator and denominator are the same for a == b after calling normalize on both.



---

archive/issue_comments_208375.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-04T18:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208375",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208376.json:
```json
{
    "body": "I couldn't help myself and hacked a bit on this.\n* Removed normalize from generic `FractionFieldElement`, as I don't think it can live up to the behaviour in its documentation. For instance (2x)/(2x+1) and (-2x)/(-2x-1) in Q(ZZ[x]) did not have the same normalisation. I doubt this can be fixed for general rings.\n* Removed call to reduce for non-exact rings, as reduces' documentation says \"Automatically called for exact rings, but because it may be numerically unstable for inexact rings it must be called manually in that case.\"\n* Raise `NotImplementedError` in generic `FractionFieldElement.__hash__` except when the denominator is 1. In this exceptional case the hash necessarily agrees with the hash of the corresponding element of the integral domain and therefore can be computed without any trouble.\n\nI (re)implemented hashing for elements of Q(R[X]) with R an integral domain, by passing from Q(R[X]) to Q(Q(R)[X]), reducing to the case of this bug. I haven't pushed this, as I don't like the architecture in my patch and that should probably be a separate bug anyway. There should probably be separate bug reports for many kinds of rings.",
    "created_at": "2014-05-04T19:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208376",
    "user": "emassop"
}
```

I couldn't help myself and hacked a bit on this.
* Removed normalize from generic `FractionFieldElement`, as I don't think it can live up to the behaviour in its documentation. For instance (2x)/(2x+1) and (-2x)/(-2x-1) in Q(ZZ[x]) did not have the same normalisation. I doubt this can be fixed for general rings.
* Removed call to reduce for non-exact rings, as reduces' documentation says "Automatically called for exact rings, but because it may be numerically unstable for inexact rings it must be called manually in that case."
* Raise `NotImplementedError` in generic `FractionFieldElement.__hash__` except when the denominator is 1. In this exceptional case the hash necessarily agrees with the hash of the corresponding element of the integral domain and therefore can be computed without any trouble.

I (re)implemented hashing for elements of Q(R[X]) with R an integral domain, by passing from Q(R[X]) to Q(Q(R)[X]), reducing to the case of this bug. I haven't pushed this, as I don't like the architecture in my patch and that should probably be a separate bug anyway. There should probably be separate bug reports for many kinds of rings.



---

archive/issue_comments_208377.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-10T09:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208377",
    "user": "@rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_208378.json:
```json
{
    "body": "patchbot:\n\n```\nsage -t --long src/sage/tests/book_schilling_zabrocki_kschur_primer.py  # 28 doctests failed\nsage -t --long src/sage/combinat/sf/macdonald.py  # 8 doctests failed\nsage -t --long src/sage/algebras/iwahori_hecke_algebra.py  # 1 doctest failed\nsage -t --long src/sage/combinat/sf/sfa.py  # 8 doctests failed\nsage -t --long src/sage/combinat/k_tableau.py  # 2 doctests failed\nsage -t --long src/sage/schemes/projective/projective_morphism.py  # 1 doctest failed\nsage -t --long src/sage/matrix/matrix2.pyx  # 6 doctests failed\nsage -t --long src/sage/combinat/sf/k_dual.py  # 52 doctests failed\nsage -t --long src/sage/rings/function_field/function_field.py  # 32 doctests failed\nsage -t --long src/sage/combinat/sf/llt.py  # 49 doctests failed\nsage -t --long src/sage/schemes/elliptic_curves/ell_point.py  # 8 doctests failed\nsage -t --long src/sage/combinat/sf/new_kschur.py  # 10 doctests failed\nsage -t --long src/sage/combinat/sf/jack.py  # 72 doctests failed\nsage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py  # Killed due to terminate\nsage -t --long src/sage/combinat/sf/sf.py  # 15 doctests failed\nsage -t --long src/sage/combinat/sf/hall_littlewood.py  # 39 doctests failed\nsage -t --long src/sage/modules/free_module_element.pyx  # 4 doctests failed\nsage -t --long src/sage/modules/free_module.py  # 2 doctests failed\nsage -t --long src/sage/combinat/cluster_algebra_quiver/cluster_seed.py  # 32 doctests failed\nsage -t --long src/sage/schemes/toric/ideal.py  # 1 doctest failed\nsage -t --long src/sage/categories/pushout.py  # 2 doctests failed\nsage -t --long src/sage/categories/quotient_fields.py  # 3 doctests failed\nsage -t --long src/sage/matrix/strassen.pyx  # 2 doctests failed\nsage -t --long src/sage/calculus/wester.py  # 1 doctest failed\nsage -t --long src/sage/algebras/quatalg/quaternion_algebra_element.pyx  # 6 doctests failed\nsage -t --long src/sage/schemes/plane_conics/con_field.py  # 5 doctests failed\nsage -t --long src/sage/combinat/free_module.py  # 2 doctests failed\nsage -t --long src/sage/combinat/species/recursive_species.py  # 1 doctest failed\nsage -t --long src/sage/rings/function_field/function_field_ideal.py  # 18 doctests failed\nsage -t --long src/sage/combinat/sf/dual.py  # 4 doctests failed\nsage -t --long src/sage/rings/function_field/function_field_order.py  # 6 doctests failed\nsage -t --long src/sage/combinat/species/product_species.py  # 1 doctest failed\nsage -t --long src/sage/combinat/species/species.py  # 2 doctests failed\nsage -t --long src/sage/modules/matrix_morphism.py  # 1 doctest failed\nsage -t --long src/sage/rings/function_field/function_field_element.pyx  # 10 doctests failed\nsage -t --long src/sage/modules/free_quadratic_module.py  # 1 doctest failed\nsage -t --long src/sage/rings/polynomial/polynomial_element_generic.py  # 1 doctest failed\nsage -t --long src/sage/rings/fraction_field_element.pyx  # 3 doctests failed\nsage -t --long src/sage/matrix/tests.py  # 2 doctests failed\nsage -t --long src/sage/categories/function_fields.py  # 1 doctest failed\nsage -t --long src/sage/combinat/species/sum_species.py  # 1 doctest failed\nsage -t --long src/sage/rings/function_field/constructor.py  # 2 doctests failed\n```\n",
    "created_at": "2014-05-10T09:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208378",
    "user": "@rwst"
}
```

patchbot:

```
sage -t --long src/sage/tests/book_schilling_zabrocki_kschur_primer.py  # 28 doctests failed
sage -t --long src/sage/combinat/sf/macdonald.py  # 8 doctests failed
sage -t --long src/sage/algebras/iwahori_hecke_algebra.py  # 1 doctest failed
sage -t --long src/sage/combinat/sf/sfa.py  # 8 doctests failed
sage -t --long src/sage/combinat/k_tableau.py  # 2 doctests failed
sage -t --long src/sage/schemes/projective/projective_morphism.py  # 1 doctest failed
sage -t --long src/sage/matrix/matrix2.pyx  # 6 doctests failed
sage -t --long src/sage/combinat/sf/k_dual.py  # 52 doctests failed
sage -t --long src/sage/rings/function_field/function_field.py  # 32 doctests failed
sage -t --long src/sage/combinat/sf/llt.py  # 49 doctests failed
sage -t --long src/sage/schemes/elliptic_curves/ell_point.py  # 8 doctests failed
sage -t --long src/sage/combinat/sf/new_kschur.py  # 10 doctests failed
sage -t --long src/sage/combinat/sf/jack.py  # 72 doctests failed
sage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py  # Killed due to terminate
sage -t --long src/sage/combinat/sf/sf.py  # 15 doctests failed
sage -t --long src/sage/combinat/sf/hall_littlewood.py  # 39 doctests failed
sage -t --long src/sage/modules/free_module_element.pyx  # 4 doctests failed
sage -t --long src/sage/modules/free_module.py  # 2 doctests failed
sage -t --long src/sage/combinat/cluster_algebra_quiver/cluster_seed.py  # 32 doctests failed
sage -t --long src/sage/schemes/toric/ideal.py  # 1 doctest failed
sage -t --long src/sage/categories/pushout.py  # 2 doctests failed
sage -t --long src/sage/categories/quotient_fields.py  # 3 doctests failed
sage -t --long src/sage/matrix/strassen.pyx  # 2 doctests failed
sage -t --long src/sage/calculus/wester.py  # 1 doctest failed
sage -t --long src/sage/algebras/quatalg/quaternion_algebra_element.pyx  # 6 doctests failed
sage -t --long src/sage/schemes/plane_conics/con_field.py  # 5 doctests failed
sage -t --long src/sage/combinat/free_module.py  # 2 doctests failed
sage -t --long src/sage/combinat/species/recursive_species.py  # 1 doctest failed
sage -t --long src/sage/rings/function_field/function_field_ideal.py  # 18 doctests failed
sage -t --long src/sage/combinat/sf/dual.py  # 4 doctests failed
sage -t --long src/sage/rings/function_field/function_field_order.py  # 6 doctests failed
sage -t --long src/sage/combinat/species/product_species.py  # 1 doctest failed
sage -t --long src/sage/combinat/species/species.py  # 2 doctests failed
sage -t --long src/sage/modules/matrix_morphism.py  # 1 doctest failed
sage -t --long src/sage/rings/function_field/function_field_element.pyx  # 10 doctests failed
sage -t --long src/sage/modules/free_quadratic_module.py  # 1 doctest failed
sage -t --long src/sage/rings/polynomial/polynomial_element_generic.py  # 1 doctest failed
sage -t --long src/sage/rings/fraction_field_element.pyx  # 3 doctests failed
sage -t --long src/sage/matrix/tests.py  # 2 doctests failed
sage -t --long src/sage/categories/function_fields.py  # 1 doctest failed
sage -t --long src/sage/combinat/species/sum_species.py  # 1 doctest failed
sage -t --long src/sage/rings/function_field/constructor.py  # 2 doctests failed
```




---

archive/issue_comments_208379.json:
```json
{
    "body": "#15297 is related",
    "created_at": "2014-06-09T19:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208379",
    "user": "emassop"
}
```

#15297 is related



---

archive/issue_comments_208380.json:
```json
{
    "body": "#16993 is related.",
    "created_at": "2014-09-16T14:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208380",
    "user": "emassop"
}
```

#16993 is related.



---

archive/issue_comments_208381.json:
```json
{
    "body": "Also, I sadly don't currently have time to work on this. In fact, I don't think I'll have time until spring.",
    "created_at": "2014-09-16T14:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208381",
    "user": "emassop"
}
```

Also, I sadly don't currently have time to work on this. In fact, I don't think I'll have time until spring.



---

archive/issue_comments_208382.json:
```json
{
    "body": "ping",
    "created_at": "2017-03-04T00:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208382",
    "user": "jakobkroeker"
}
```

ping



---

archive/issue_comments_208383.json:
```json
{
    "body": "Replying to [comment:5 cremona]:\n> Thanks, Robert, I will review this.  I had already started by patching the reduce function but had not yet discoivered where the automatic calling of reduction was actually happening.  Your solution -- keeping reduce() and normalise() separate -- looks better.\n\nIMO having `reduce()` normalize the leading coefficient is actually a better choice, because it helps limiting coefficient blow-up in computations with rational functions.\n\nHere is another attempt that does that. See the commit messages for more information. (Addendum: this fixes #16993. Fixing #15297 in full generality requires more work, but could be done as a follow-up.)\n----\nNew commits:",
    "created_at": "2018-04-23T17:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208383",
    "user": "@mezzarobba"
}
```

Replying to [comment:5 cremona]:
> Thanks, Robert, I will review this.  I had already started by patching the reduce function but had not yet discoivered where the automatic calling of reduction was actually happening.  Your solution -- keeping reduce() and normalise() separate -- looks better.

IMO having `reduce()` normalize the leading coefficient is actually a better choice, because it helps limiting coefficient blow-up in computations with rational functions.

Here is another attempt that does that. See the commit messages for more information. (Addendum: this fixes #16993. Fixing #15297 in full generality requires more work, but could be done as a follow-up.)
----
New commits:



---

archive/issue_comments_208384.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-23T17:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208384",
    "user": "@mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_208385.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-24T07:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208385",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208386.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-24T12:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208386",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208387.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-24T15:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208387",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208388.json:
```json
{
    "body": "Replying to [comment:26 git]:\n> ||[77dc9e1](https://git.sagemath.org/sage.git/commit/?id=77dc9e1eda2e55bc4dcbe8556cf138f75086289d)||`FractionFieldElement: merge reduce() and normalize()`||\n\nReplaced a nbsp by a plain ascii space; all tests passed before.",
    "created_at": "2018-04-24T15:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208388",
    "user": "@mezzarobba"
}
```

Replying to [comment:26 git]:
> ||[77dc9e1](https://git.sagemath.org/sage.git/commit/?id=77dc9e1eda2e55bc4dcbe8556cf138f75086289d)||`FractionFieldElement: merge reduce() and normalize()`||

Replaced a nbsp by a plain ascii space; all tests passed before.



---

archive/issue_comments_208389.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-25T06:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208389",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208390.json:
```json
{
    "body": "Replying to [comment:28 git]:\n> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n> ||[daec622](https://git.sagemath.org/sage.git/commit/?id=daec622b57a0b75e4241e7d406880cfab73272c1)||`#16268 boring doctest updates`||\n> ||[3cf5014](https://git.sagemath.org/sage.git/commit/?id=3cf5014d43785fd384204981ead86702a3ea1662)||`#16268 other doctest updates`||\n\nUpdated an optional test.",
    "created_at": "2018-04-25T06:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208390",
    "user": "@mezzarobba"
}
```

Replying to [comment:28 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[daec622](https://git.sagemath.org/sage.git/commit/?id=daec622b57a0b75e4241e7d406880cfab73272c1)||`#16268 boring doctest updates`||
> ||[3cf5014](https://git.sagemath.org/sage.git/commit/?id=3cf5014d43785fd384204981ead86702a3ea1662)||`#16268 other doctest updates`||

Updated an optional test.



---

archive/issue_comments_208391.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-11T18:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208391",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208392.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-11T18:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208392",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208393.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-12T06:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208393",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_208394.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-12T06:43:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208394",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208395.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-12T08:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208395",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208396.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-12T08:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208396",
    "user": "@mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_208397.json:
```json
{
    "body": "The only nontrivial doctest update in the last commit should be the one in `endPN_automorphism_group.three_stable_points()`; I think it is correct, but it would be nice if someone who actually understands what it is about could double-check.",
    "created_at": "2018-05-12T08:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208397",
    "user": "@mezzarobba"
}
```

The only nontrivial doctest update in the last commit should be the one in `endPN_automorphism_group.three_stable_points()`; I think it is correct, but it would be nice if someone who actually understands what it is about could double-check.



---

archive/issue_comments_208398.json:
```json
{
    "body": "Yes, the doc test change in three_stable_points is fine.",
    "created_at": "2018-05-12T18:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208398",
    "user": "@bhutz"
}
```

Yes, the doc test change in three_stable_points is fine.



---

archive/issue_comments_208399.json:
```json
{
    "body": "In [c16d55a247b21d6c46d00f603ca21d7d6d64db19](https://git.sagemath.org/sage.git/commit/?id=c16d55a247b21d6c46d00f603ca21d7d6d64db19), \"EXAMPLES::\" became \"EXAMPLES:\". IIRC double colons are needed to use the examples in a doctest, or at least for formatting of the documentation (per https://devguide.python.org/documenting/#source-code). Please put the double colons back.\n\nIn [7c8a45abecdf5224c9f0a324447ba69db22057b5](https://git.sagemath.org/sage.git/commit/?id=7c8a45abecdf5224c9f0a324447ba69db22057b5) hashes are computed for inexact rings without reduction. This means that python-equal fraction field elements can have distinct hashes, violating the preconditions of hashing in python. I would prefer to err on the side of caution and raise an exception rather than introducing a pathway for bugs that will be hard to find. If you decide to go the other way, please consider removing [198c0596630bb4ecc200e62c55715441e6f38d5c](https://git.sagemath.org/sage.git/commit/?id=198c0596630bb4ecc200e62c55715441e6f38d5c) from the history as its intended effect is completely undone.",
    "created_at": "2018-05-12T19:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208399",
    "user": "emassop"
}
```

In [c16d55a247b21d6c46d00f603ca21d7d6d64db19](https://git.sagemath.org/sage.git/commit/?id=c16d55a247b21d6c46d00f603ca21d7d6d64db19), "EXAMPLES::" became "EXAMPLES:". IIRC double colons are needed to use the examples in a doctest, or at least for formatting of the documentation (per https://devguide.python.org/documenting/#source-code). Please put the double colons back.

In [7c8a45abecdf5224c9f0a324447ba69db22057b5](https://git.sagemath.org/sage.git/commit/?id=7c8a45abecdf5224c9f0a324447ba69db22057b5) hashes are computed for inexact rings without reduction. This means that python-equal fraction field elements can have distinct hashes, violating the preconditions of hashing in python. I would prefer to err on the side of caution and raise an exception rather than introducing a pathway for bugs that will be hard to find. If you decide to go the other way, please consider removing [198c0596630bb4ecc200e62c55715441e6f38d5c](https://git.sagemath.org/sage.git/commit/?id=198c0596630bb4ecc200e62c55715441e6f38d5c) from the history as its intended effect is completely undone.



---

archive/issue_comments_208400.json:
```json
{
    "body": "Thanks for your comments!\n\nReplying to [comment:38 emassop]:\n> In [c16d55a247b21d6c46d00f603ca21d7d6d64db19](https://git.sagemath.org/sage.git/commit/?id=c16d55a247b21d6c46d00f603ca21d7d6d64db19), \"EXAMPLES::\" became \"EXAMPLES:\". IIRC double colons are needed to use the examples in a doctest, or at least for formatting of the documentation (per https://devguide.python.org/documenting/#source-code). Please put the double colons back.\n\nThey are still there, after the introductory sentence instead of the \"EXAMPLES:\" heading.\n\n> In [7c8a45abecdf5224c9f0a324447ba69db22057b5](https://git.sagemath.org/sage.git/commit/?id=7c8a45abecdf5224c9f0a324447ba69db22057b5) hashes are computed for inexact rings without reduction. This means that python-equal fraction field elements can have distinct hashes, violating the preconditions of hashing in python. I would prefer to err on the side of caution and raise an exception rather than introducing a pathway for bugs that will be hard to find. If you decide to go the other way, please consider removing [198c0596630bb4ecc200e62c55715441e6f38d5c](https://git.sagemath.org/sage.git/commit/?id=198c0596630bb4ecc200e62c55715441e6f38d5c) from the history as its intended effect is completely undone.\n\nI don't like that either. But over an inexact ring, the precondition of hashing would be violated anyway, because of the round-off errors during the computation of the reduction and the equality test. So what I'm suggesting in order to move forward is to keep the broken hash in this case, to be closer to bug-for-bug compatibility with the historic implementation...\n\nThis issue with equality appears almost everywhere in Sage, and unfortunately, I think we have to live with it. The only real fix IMO would be to drop the use of `==` for mathematical equality, define it to mean \u201csyntactic\u201d equality of the data structures (after normalization when relevant) instead, and introduce a separate method for mathematical equality. But that's not going to happen without a Sage fork at least, I guess...",
    "created_at": "2018-05-14T10:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208400",
    "user": "@mezzarobba"
}
```

Thanks for your comments!

Replying to [comment:38 emassop]:
> In [c16d55a247b21d6c46d00f603ca21d7d6d64db19](https://git.sagemath.org/sage.git/commit/?id=c16d55a247b21d6c46d00f603ca21d7d6d64db19), "EXAMPLES::" became "EXAMPLES:". IIRC double colons are needed to use the examples in a doctest, or at least for formatting of the documentation (per https://devguide.python.org/documenting/#source-code). Please put the double colons back.

They are still there, after the introductory sentence instead of the "EXAMPLES:" heading.

> In [7c8a45abecdf5224c9f0a324447ba69db22057b5](https://git.sagemath.org/sage.git/commit/?id=7c8a45abecdf5224c9f0a324447ba69db22057b5) hashes are computed for inexact rings without reduction. This means that python-equal fraction field elements can have distinct hashes, violating the preconditions of hashing in python. I would prefer to err on the side of caution and raise an exception rather than introducing a pathway for bugs that will be hard to find. If you decide to go the other way, please consider removing [198c0596630bb4ecc200e62c55715441e6f38d5c](https://git.sagemath.org/sage.git/commit/?id=198c0596630bb4ecc200e62c55715441e6f38d5c) from the history as its intended effect is completely undone.

I don't like that either. But over an inexact ring, the precondition of hashing would be violated anyway, because of the round-off errors during the computation of the reduction and the equality test. So what I'm suggesting in order to move forward is to keep the broken hash in this case, to be closer to bug-for-bug compatibility with the historic implementation...

This issue with equality appears almost everywhere in Sage, and unfortunately, I think we have to live with it. The only real fix IMO would be to drop the use of `==` for mathematical equality, define it to mean “syntactic” equality of the data structures (after normalization when relevant) instead, and introduce a separate method for mathematical equality. But that's not going to happen without a Sage fork at least, I guess...



---

archive/issue_comments_208401.json:
```json
{
    "body": "Regarding EXAMPLES: Ah, I didn't notice that. Sorry.\n\n\nRegarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.\n\nI am aware that in general sage does not guarantee \"`x == y` implies `hash(x) == hash(y)`\", but if I recall correctly, it did strive to uphold this implication when `x` and `y` have the same parent.\n\n\nA point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation. Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.",
    "created_at": "2018-05-15T10:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208401",
    "user": "emassop"
}
```

Regarding EXAMPLES: Ah, I didn't notice that. Sorry.


Regarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.

I am aware that in general sage does not guarantee "`x == y` implies `hash(x) == hash(y)`", but if I recall correctly, it did strive to uphold this implication when `x` and `y` have the same parent.


A point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation. Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.



---

archive/issue_comments_208402.json:
```json
{
    "body": "Replying to [comment:41 emassop]:\n> Regarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.\n\nI'll try that and look again at the test failures to see what makes sense.\n\n> I am aware that in general sage does not guarantee \"`x == y` implies `hash(x) == hash(y)`\", but if I recall correctly, it did strive to uphold this implication when `x` and `y` have the same parent.\n\nYes. But even that is not always possible, unfortunately.\n\n> A point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation.\n\nDepending whether we are working with univariate rational function over a field or not, actually, isn't it?\n\n> Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.\n\nI'm not sure. This is also related to the issue of provinding a normal form for more general fraction field elements (starting with rational functions over non-fields, I guess), and hence I agree that this would best be kept for another ticket.",
    "created_at": "2018-05-15T18:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208402",
    "user": "@mezzarobba"
}
```

Replying to [comment:41 emassop]:
> Regarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.

I'll try that and look again at the test failures to see what makes sense.

> I am aware that in general sage does not guarantee "`x == y` implies `hash(x) == hash(y)`", but if I recall correctly, it did strive to uphold this implication when `x` and `y` have the same parent.

Yes. But even that is not always possible, unfortunately.

> A point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation.

Depending whether we are working with univariate rational function over a field or not, actually, isn't it?

> Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.

I'm not sure. This is also related to the issue of provinding a normal form for more general fraction field elements (starting with rational functions over non-fields, I guess), and hence I agree that this would best be kept for another ticket.



---

archive/issue_comments_208403.json:
```json
{
    "body": "Replying to [comment:42 mmezzarobba]:\n> > Regarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.\n> I'll try that and look again at the test failures to see what makes sense.\n\nThanks, I'll wait for the result.\n\n> > A point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation.\n> \n> Depending whether we are working with univariate rational function over a field or not, actually, isn't it?\n>\n> > Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.\n> \n> I'm not sure. This is also related to the issue of providing a normal form for more general fraction field elements (starting with rational functions over non-fields, I guess), and hence I agree that this would best be kept for another ticket.\n\nWith the current implementation \"is this a univariate rational function over a field\" is the criterion, yes. The point is that the criterion changes when the implementation changes, and no one will know except by looking at the code for their specific kind of base ring.\n\n(For instance the present normalization easily generalizes to the multivariate case by looking at the leading coefficient for some [monomial order](https://en.wikipedia.org/wiki/Monomial_order).)\n\nI was hoping for a convincing argument on why making `reduce` more powerful is better than keeping `normalize` around, as my initial preference would be towards `normalize` because I generally prefer explicit over implicit.",
    "created_at": "2018-05-15T21:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208403",
    "user": "emassop"
}
```

Replying to [comment:42 mmezzarobba]:
> > Regarding hashing: How about emitting a warning? (sage.misc.superseded.warning?) Then computations keep working bug-for-bug, but the user is at least made aware that something may be going wrong. I can't recall if there was a policy for or against this.
> I'll try that and look again at the test failures to see what makes sense.

Thanks, I'll wait for the result.

> > A point on API: Although I can believe that always making the denominator monic is a good thing, merging `normalize` into `reduce` means that there no longer is a method that guarantees a normal form. Instead `reduce` now maybe normalizes the numerator and denominator or maybe not, depending on the implementation.
> 
> Depending whether we are working with univariate rational function over a field or not, actually, isn't it?
>
> > Would it perhaps make sense to have a bool `_normalized` (instead of or in addition to `_reduced`) that gets set when `reduce` has succeeded at normalization? This doesn't have to be done as part of this bug though.
> 
> I'm not sure. This is also related to the issue of providing a normal form for more general fraction field elements (starting with rational functions over non-fields, I guess), and hence I agree that this would best be kept for another ticket.

With the current implementation "is this a univariate rational function over a field" is the criterion, yes. The point is that the criterion changes when the implementation changes, and no one will know except by looking at the code for their specific kind of base ring.

(For instance the present normalization easily generalizes to the multivariate case by looking at the leading coefficient for some [monomial order](https://en.wikipedia.org/wiki/Monomial_order).)

I was hoping for a convincing argument on why making `reduce` more powerful is better than keeping `normalize` around, as my initial preference would be towards `normalize` because I generally prefer explicit over implicit.



---

archive/issue_comments_208404.json:
```json
{
    "body": "Replying to [comment:43 emassop]:\n> > I'll try that and look again at the test failures to see what makes sense.\n> \n> Thanks, I'll wait for the result.\n\nOk, the only failures I'm seeing are in `src/sage/modular/modform_hecketriangle/` and apparently come from the fact that `FormsRingElement` inherits from `UniqueRepresentation` but is sometimes called on fractions with floating-point coefficients. I guess it would be possible to port it to `UniqueFactory` and somehow preprocess the arguments to avoid the warning.\n\nHowever, I wonder if it wouldn't be better to keep `__hash__()` as it is now, and have `==` over inexact rings return `True` only when the fractions are equal *without reduction*. Then, hashing would be consistent with equality, the (arguably valid) use case of indexing a table by inexact fractions would work without warning, and hashing wouldn't break the promise that fractions over inexact ring are not automatically reduced. For `==`, this would consistent with the semantics of equality in \u201cdifficult\u201d cases like interval arithmetic and symbolic expressions, where `a == b` may return `False` in cases where `a` and `b` are actually equal but that could not be verified. (Not for `!=`, though, but I don't see what we could do about that.)\n\nWhat do you think?\n\n> With the current implementation \"is this a univariate rational function over a field\" is the criterion, yes. The point is that the criterion changes when the implementation changes, and no one will know except by looking at the code for their specific kind of base ring.\n> \n> (For instance the present normalization easily generalizes to the multivariate case by looking at the leading coefficient for some [monomial order](https://en.wikipedia.org/wiki/Monomial_order).)\n> \n> I was hoping for a convincing argument on why making `reduce` more powerful is better than keeping `normalize` around, as my initial preference would be towards `normalize` because I generally prefer explicit over implicit.\n\nEssentially, I agree with you. I'm just saying that I'd rather keep that question for later, and address it once we have a way of normalizing in more general situations, probably along the lines of what you suggested at #16993.",
    "created_at": "2018-05-17T14:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208404",
    "user": "@mezzarobba"
}
```

Replying to [comment:43 emassop]:
> > I'll try that and look again at the test failures to see what makes sense.
> 
> Thanks, I'll wait for the result.

Ok, the only failures I'm seeing are in `src/sage/modular/modform_hecketriangle/` and apparently come from the fact that `FormsRingElement` inherits from `UniqueRepresentation` but is sometimes called on fractions with floating-point coefficients. I guess it would be possible to port it to `UniqueFactory` and somehow preprocess the arguments to avoid the warning.

However, I wonder if it wouldn't be better to keep `__hash__()` as it is now, and have `==` over inexact rings return `True` only when the fractions are equal *without reduction*. Then, hashing would be consistent with equality, the (arguably valid) use case of indexing a table by inexact fractions would work without warning, and hashing wouldn't break the promise that fractions over inexact ring are not automatically reduced. For `==`, this would consistent with the semantics of equality in “difficult” cases like interval arithmetic and symbolic expressions, where `a == b` may return `False` in cases where `a` and `b` are actually equal but that could not be verified. (Not for `!=`, though, but I don't see what we could do about that.)

What do you think?

> With the current implementation "is this a univariate rational function over a field" is the criterion, yes. The point is that the criterion changes when the implementation changes, and no one will know except by looking at the code for their specific kind of base ring.
> 
> (For instance the present normalization easily generalizes to the multivariate case by looking at the leading coefficient for some [monomial order](https://en.wikipedia.org/wiki/Monomial_order).)
> 
> I was hoping for a convincing argument on why making `reduce` more powerful is better than keeping `normalize` around, as my initial preference would be towards `normalize` because I generally prefer explicit over implicit.

Essentially, I agree with you. I'm just saying that I'd rather keep that question for later, and address it once we have a way of normalizing in more general situations, probably along the lines of what you suggested at #16993.



---

archive/issue_comments_208405.json:
```json
{
    "body": "FWIW, all tests pass with\n\n```diff\n\n}}}diff --git a/src/sage/modular/modform_hecketriangle/graded_ring_element.py b/src/sage/modular/modform_hecketriangle/graded_ring_element.py\nindex be3b1e614b..5b41348c07 100644\n--- a/src/sage/modular/modform_hecketriangle/graded_ring_element.py\n+++ b/src/sage/modular/modform_hecketriangle/graded_ring_element.py\n@@ -156,7 +156,7 @@ class FormsRingElement(six.with_metaclass(\n             sage: MeromorphicModularFormsRing()(-1/x) == MeromorphicModularFormsRing()(1/(-x))\n             True\n             sage: MeromorphicModularFormsRing(base_ring=CC)(-1/x) == MeromorphicModularFormsRing()(1/(-x))\n-            True\n+            False\n         \"\"\"\n         if op not in [op_EQ, op_NE]:\n             return NotImplemented\ndiff --git a/src/sage/rings/fraction_field_element.pyx b/src/sage/rings/fraction_field_element.pyx\nindex 3013a7b3af..3b221ddf4b 100644\n--- a/src/sage/rings/fraction_field_element.pyx\n+++ b/src/sage/rings/fraction_field_element.pyx\n@@ -894,14 +894,16 @@ cdef class FractionFieldElement(FieldElement):\n             True\n         \"\"\"\n         cdef FractionFieldElement other = other_\n-        if ((op == Py_EQ or op == Py_NE)\n-                and self.__denominator == other.__denominator):\n-            return richcmp(self.__numerator, other.__numerator, op)\n-        else:\n-            return richcmp(\n-                    self.__numerator * other.__denominator,\n-                    self.__denominator * other.__numerator,\n-                    op)\n+        if (op == Py_EQ or op == Py_NE):\n+            if self.__denominator == other.__denominator:\n+                return richcmp(self.__numerator, other.__numerator, op)\n+            elif not self._parent.is_exact():\n+                # over inexact rings, compare unreduced representations\n+                return op == Py_NE\n+        return richcmp(\n+                self.__numerator * other.__denominator,\n+                self.__denominator * other.__numerator,\n+                op)\n \n     def valuation(self, v=None):\n         \"\"\"\n@@ -1150,7 +1152,8 @@ cdef class FractionFieldElement_1poly_field(FractionFieldElement):\n         if op == Py_EQ or op == Py_NE:\n             if self.__denominator == other.__denominator:\n                 return richcmp(self.__numerator, other.__numerator, op)\n-            elif self._is_reduced and other._is_reduced:\n+            elif (self._is_reduced and other._is_reduced\n+                    or not self._parent.is_exact()):\n                 return op == Py_NE\n         return richcmp(\n                 self.__numerator * other.__denominator,",
    "created_at": "2018-05-18T06:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208405",
    "user": "@mezzarobba"
}
```

FWIW, all tests pass with

```diff

}}}diff --git a/src/sage/modular/modform_hecketriangle/graded_ring_element.py b/src/sage/modular/modform_hecketriangle/graded_ring_element.py
index be3b1e614b..5b41348c07 100644
--- a/src/sage/modular/modform_hecketriangle/graded_ring_element.py
+++ b/src/sage/modular/modform_hecketriangle/graded_ring_element.py
@@ -156,7 +156,7 @@ class FormsRingElement(six.with_metaclass(
             sage: MeromorphicModularFormsRing()(-1/x) == MeromorphicModularFormsRing()(1/(-x))
             True
             sage: MeromorphicModularFormsRing(base_ring=CC)(-1/x) == MeromorphicModularFormsRing()(1/(-x))
-            True
+            False
         """
         if op not in [op_EQ, op_NE]:
             return NotImplemented
diff --git a/src/sage/rings/fraction_field_element.pyx b/src/sage/rings/fraction_field_element.pyx
index 3013a7b3af..3b221ddf4b 100644
--- a/src/sage/rings/fraction_field_element.pyx
+++ b/src/sage/rings/fraction_field_element.pyx
@@ -894,14 +894,16 @@ cdef class FractionFieldElement(FieldElement):
             True
         """
         cdef FractionFieldElement other = other_
-        if ((op == Py_EQ or op == Py_NE)
-                and self.__denominator == other.__denominator):
-            return richcmp(self.__numerator, other.__numerator, op)
-        else:
-            return richcmp(
-                    self.__numerator * other.__denominator,
-                    self.__denominator * other.__numerator,
-                    op)
+        if (op == Py_EQ or op == Py_NE):
+            if self.__denominator == other.__denominator:
+                return richcmp(self.__numerator, other.__numerator, op)
+            elif not self._parent.is_exact():
+                # over inexact rings, compare unreduced representations
+                return op == Py_NE
+        return richcmp(
+                self.__numerator * other.__denominator,
+                self.__denominator * other.__numerator,
+                op)
 
     def valuation(self, v=None):
         """
@@ -1150,7 +1152,8 @@ cdef class FractionFieldElement_1poly_field(FractionFieldElement):
         if op == Py_EQ or op == Py_NE:
             if self.__denominator == other.__denominator:
                 return richcmp(self.__numerator, other.__numerator, op)
-            elif self._is_reduced and other._is_reduced:
+            elif (self._is_reduced and other._is_reduced
+                    or not self._parent.is_exact()):
                 return op == Py_NE
         return richcmp(
                 self.__numerator * other.__denominator,



---

archive/issue_comments_208406.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-19T09:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208406",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208407.json:
```json
{
    "body": "Rebased on the last beta due to a minor conflict.",
    "created_at": "2018-05-19T09:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208407",
    "user": "@mezzarobba"
}
```

Rebased on the last beta due to a minor conflict.



---

archive/issue_comments_208408.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-29T08:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208408",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_208409.json:
```json
{
    "body": "Replying to [comment:48 git]:\n> Branch pushed to git repo; I updated commit sha1. This was a forced push.\n\nRebased and fixed minor test failure.",
    "created_at": "2018-05-29T09:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208409",
    "user": "@mezzarobba"
}
```

Replying to [comment:48 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push.

Rebased and fixed minor test failure.



---

archive/issue_comments_208410.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-06-10T12:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208410",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_208411.json:
```json
{
    "body": "Rebased on 8.3.beta5 to add a minor doctest update.",
    "created_at": "2018-06-10T12:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208411",
    "user": "@mezzarobba"
}
```

Rebased on 8.3.beta5 to add a minor doctest update.



---

archive/issue_comments_208412.json:
```json
{
    "body": "This seems wrong:\n\n```diff\n-            ((1 + O(2)))/((1 + O(2^5))*x)\n+            ((1 + O(2)))/((1 + O(2))*x)\n```\n\n\nBut let's discuss this at #25318.",
    "created_at": "2018-06-11T06:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208412",
    "user": "@saraedum"
}
```

This seems wrong:

```diff
-            ((1 + O(2)))/((1 + O(2^5))*x)
+            ((1 + O(2)))/((1 + O(2))*x)
```


But let's discuss this at #25318.



---

archive/issue_comments_208413.json:
```json
{
    "body": "Replying to [comment:52 saraedum]:\n> This seems wrong:\n> {{{#!diff\n> -            ((1 + O(2)))/((1 + O(2^5))*x)\n> +            ((1 + O(2)))/((1 + O(2))*x)\n> }}}\n> \n> But let's discuss this at #25318.\n\nWhy? Isn't it the same result, just written in a different way?",
    "created_at": "2018-06-11T08:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208413",
    "user": "@mezzarobba"
}
```

Replying to [comment:52 saraedum]:
> This seems wrong:
> {{{#!diff
> -            ((1 + O(2)))/((1 + O(2^5))*x)
> +            ((1 + O(2)))/((1 + O(2))*x)
> }}}
> 
> But let's discuss this at #25318.

Why? Isn't it the same result, just written in a different way?



---

archive/issue_comments_208414.json:
```json
{
    "body": "Oops, sorry. I guess you're right.\n\nReplying to [comment:53 mmezzarobba]:\n> Replying to [comment:52 saraedum]:\n> > This seems wrong:\n> > {{{#!diff\n> > -            ((1 + O(2)))/((1 + O(2^5))*x)\n> > +            ((1 + O(2)))/((1 + O(2))*x)\n> > }}}\n> > \n> > But let's discuss this at #25318.\n> \n> Why? Isn't it the same result, just written in a different way?",
    "created_at": "2018-06-11T15:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208414",
    "user": "@saraedum"
}
```

Oops, sorry. I guess you're right.

Replying to [comment:53 mmezzarobba]:
> Replying to [comment:52 saraedum]:
> > This seems wrong:
> > {{{#!diff
> > -            ((1 + O(2)))/((1 + O(2^5))*x)
> > +            ((1 + O(2)))/((1 + O(2))*x)
> > }}}
> > 
> > But let's discuss this at #25318.
> 
> Why? Isn't it the same result, just written in a different way?



---

archive/issue_comments_208415.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-06-24T11:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208415",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_208416.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-07-02T08:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208416",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_208417.json:
```json
{
    "body": "If you are confident that the output in the doctests is still correct (I did not check all of them) then feel free to set this to positive review.",
    "created_at": "2018-07-03T15:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208417",
    "user": "@saraedum"
}
```

If you are confident that the output in the doctests is still correct (I did not check all of them) then feel free to set this to positive review.



---

archive/issue_comments_208418.json:
```json
{
    "body": "Thank you!",
    "created_at": "2018-07-03T16:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208418",
    "user": "@mezzarobba"
}
```

Thank you!



---

archive/issue_comments_208419.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-03T16:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208419",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_208420.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-09T21:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208420",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_208421.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2018-08-09T21:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208421",
    "user": "@vbraun"
}
```

Merge conflict



---

archive/issue_comments_208422.json:
```json
{
    "body": "Replying to [comment:60 vbraun]:\n> Merge conflict\n\nShould be fixed. Back to needs_review mainly for the patchbot; there shouldn't be any nontrivial changes to review.",
    "created_at": "2018-08-14T13:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208422",
    "user": "@mezzarobba"
}
```

Replying to [comment:60 vbraun]:
> Merge conflict

Should be fixed. Back to needs_review mainly for the patchbot; there shouldn't be any nontrivial changes to review.



---

archive/issue_comments_208423.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-14T13:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208423",
    "user": "@mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_208424.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-08-14T14:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208424",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_208425.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-15T08:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208425",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_208426.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-25T11:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208426",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_208427.json:
```json
{
    "body": "#16993 should probably be closed as a dup of this ticket.\n\nAlso, should there be a follow-up ticket for the desirable further improvements mentioned in the ticket description?",
    "created_at": "2018-09-14T04:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208427",
    "user": "@mkoeppe"
}
```

#16993 should probably be closed as a dup of this ticket.

Also, should there be a follow-up ticket for the desirable further improvements mentioned in the ticket description?



---

archive/issue_comments_208428.json:
```json
{
    "body": "Replying to [comment:65 mkoeppe]:\n> #16993 should probably be closed as a dup of this ticket.\n\nYes, thanks, I had forgotten to do that.\n\n> Also, should there be a follow-up ticket for the desirable further improvements mentioned in the ticket description?\n\nPlease go ahead if you want to open additional tickets and/or work on these improvements. (I have little time to work on them myself at the moment, unfortunately, but feel free to ping me if some follow-up ticket needs review.)",
    "created_at": "2018-09-22T14:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208428",
    "user": "@mezzarobba"
}
```

Replying to [comment:65 mkoeppe]:
> #16993 should probably be closed as a dup of this ticket.

Yes, thanks, I had forgotten to do that.

> Also, should there be a follow-up ticket for the desirable further improvements mentioned in the ticket description?

Please go ahead if you want to open additional tickets and/or work on these improvements. (I have little time to work on them myself at the moment, unfortunately, but feel free to ping me if some follow-up ticket needs review.)



---

archive/issue_comments_208429.json:
```json
{
    "body": "Follow-up ticket at #26339",
    "created_at": "2018-09-22T19:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16031#issuecomment-208429",
    "user": "@mkoeppe"
}
```

Follow-up ticket at #26339
