# Issue 29178: tox.ini: Add environment local-conda

Issue created by migration from https://trac.sagemath.org/ticket/29415

Original creator: mkoeppe

Original creation time: 2020-03-27 15:24:09

CC:  dimpase jhpalmieri isuruf saraedum @kliem

This environment would create and use an isolated conda installation within the tox environment directory,
similar to `local-homebrew`.


---

Comment by mkoeppe created at 2020-03-28 21:37:14

Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-28 21:37:14

Changing status from new to needs_review.


---

Comment by git created at 2020-03-29 02:45:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-29 03:00:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-29 03:00:53

Rebased on 9.1.beta9+#29087


---

Comment by mkoeppe created at 2020-03-30 18:23:55

Needs testing, in particular on Linux


---

Comment by dimpase created at 2020-03-31 04:43:46

I end up with a C++ error in Singular

```
libtool: compile:  /home/dimpase/sage/.tox/local-conda-forge-standard/conda/bin/x86_64-conda_cos6-linux-gnu-c++ -DHAVE_CONFIG_H -I. -I.
./../.. -I. -I../../.. -I../../.. -I../../../libpolys -I../../../libpolys -I/home/dimpase/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/singular-4.1.1p2.p0/src -I/home/dimpase/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/singular-4.1.1p2.p0/src/factory/include -I/home/dimpase/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/singular-4.1.1p2.p0/src -I/home/dimpase/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/singular-4.1.1p2.p0/src -pthread -DDYNAMIC_VERSION -DGMPRATIONAL -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /home/dimpase/sage/.tox/local-conda-forge-standard/conda/include -O2 -g -fvisibility-inlines-hidden -std=c++17 -fmessage-length=0 -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /home/dimpase/sage/.tox/local-conda-forge-standard/conda/include -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -fno-threadsafe-statics -fno-enforce-eh-specs -fconserve-space -funroll-loops -fno-delete-null-pointer-checks -fno-rtti -fexceptions -frtti -c groebnerCone.cc  -fPIC -DPIC -o .libs/gfanlib_la-groebnerCone.o
groebnerCone.cc:428:58: error: no 'bool groebnerCone::pointsOutwards(gfan::ZVector) const' member function declared in class 'groebnerCone'
 bool groebnerCone::pointsOutwards(const gfan::ZVector w) const
                                                          ^~~~~
groebnerCone.cc: In member function 'groebnerCones groebnerCone::tropicalNeighbours() const':
groebnerCone.cc:449:13: error: 'pointsOutwards' was not declared in this scope
         if (pointsOutwards(ray[j]))
             ^~~~~~~~~~~~~~
make[9]: *** [Makefile:726: gfanlib_la-groebnerCone.lo] Error 1
```


this is on Debian, and might be due to using gfan from the system.


---

Comment by isuruf created at 2020-03-31 04:56:12

This is fixed in singular 4.1.2. https://github.com/Singular/Sources/commit/80a9ffc773542e3329935e5377f6906628be16e6

A workaround is to do `export CPPFLAGS="$CPPFLAGS -UNDEBUG"` in Singular build script.


---

Comment by dimpase created at 2020-03-31 07:37:56

should we upgrade Sage's singular?


---

Comment by mkoeppe created at 2020-03-31 11:34:55

Replying to [comment:11 dimpase]:
> should we upgrade Sage's singular?
That's #25993.


---

Comment by mkoeppe created at 2020-03-31 11:53:08

I also see a failure (testing with #29417):

- `local-conda-forge-macos-standard`: 

```
  [dochtml]       from sage.symbolic.all   import *
  [dochtml]     File "/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/all.py", line 3, in <module>
  [dochtml]       from sage.libs.pynac.pynac import I
  [dochtml]     File "sage/symbolic/expression.pxd", line 4, in init sage.libs.pynac.pynac (build/cythonized/sage/libs/pynac/pynac.cpp:30411)
   [dochtml]     File "sage/symbolic/expression.pyx", line 160, in init sage.symbolic.expression (build/cythonized/sage/symbolic/expression.cpp:75349)
  [dochtml]   ImportError: dlopen(/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so, 2): Symbol not found: __ZN5GiNaC9containerINSt3__16vectorEEC2ERKNS2_INS_2exENS1_9allocatorIS4_EEEEb
  [dochtml]     Referenced from: /Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so
  [dochtml]     Expected in: flat namespace
  [dochtml]    in /Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so
```

(this is with #29404 -- should take another look)


---

Comment by mkoeppe created at 2020-03-31 12:58:29

In any case, the present ticket is about adding the testing framework for local-conda, which appears to work. Needs review.


---

Comment by isuruf created at 2020-03-31 16:33:53

Shameless plug. Use miniforge instead of miniconda?


---

Comment by mkoeppe created at 2020-03-31 17:11:40

Replying to [comment:16 isuruf]:
> Shameless plug. Use miniforge instead of miniconda?
Just tried it and it behaves a bit different from miniconda:

```
local-macos-conda-forge-standard-python2 run-test-pre: commands[6] | bash -c '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-macos-conda-forge-standard-python2/conda/bin/conda update -n base --yes conda'
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-macos-conda-forge-standard-python2/conda/bin/conda", line 12, in <module>
    from conda.cli import main
ModuleNotFoundError: No module named 'conda'
```

Do I need to activate the environment before using that?


---

Comment by mkoeppe created at 2020-03-31 17:19:33

Replying to [comment:10 isuruf]:
> This is fixed in singular 4.1.2. https://github.com/Singular/Sources/commit/80a9ffc773542e3329935e5377f6906628be16e6
> 
> A workaround is to do `export CPPFLAGS="$CPPFLAGS -UNDEBUG"` in Singular build script.

Because the singular upgrade (#25993) will not be ready for 9.1, I have opened #29438 for this


---

Comment by isuruf created at 2020-03-31 17:22:20

Replying to [comment:17 mkoeppe]:
> Do I need to activate the environment before using that?

Yes, but even miniconda needs activation.


---

Comment by git created at 2020-03-31 17:37:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by @kliem created at 2020-04-01 09:21:12

I guess it works in the way that it doesn't work.


```
* package:         openblas-0.3.6.p0
  last build time: Apr 1 10:54
  log file:        /srv/public/kliem/sage/logs/pkgs/openblas-0.3.6.p0.log
  build directory: /srv/public/kliem/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/openblas-0.3.6.p0                                                               

* package:         singular-4.1.1p2.p0
  last build time: Apr 1 11:00
  log file:        /srv/public/kliem/sage/logs/pkgs/singular-4.1.1p2.p0.log
  build directory: /srv/public/kliem/sage/.tox/local-conda-forge-standard/local/var/tmp/sage/build/singular-4.1.1p2.p0                                                             

```


I attached the logs.


---

Comment by dimpase created at 2020-04-01 09:32:52

Singular might need the fix proposed by Isuru above


---

Comment by @kliem created at 2020-04-01 12:57:10

I'm not sure that I understand.

At least this here did not fix the problem.

```
+++ b/build/pkgs/singular/spkg-install.in
@@ -19,6 +19,7 @@ else
 fi
 
 export CFLAGS CXXFLAGS
+export CPPFLAGS="$CPPFLAGS -UNDEBUG"
 
 
 remove_old_version()
```


Now openblas, tachyon, m4ri, givaro, ecm, python3, giac, singular fail to install.


---

Comment by mkoeppe created at 2020-04-01 13:12:47

Singular fixes - please on  #29438, not here


---

Comment by mkoeppe created at 2020-04-01 13:13:39

This ticket is about adding the testing environment for conda, not fixing everything that may be broken in the conda build


---

Comment by isuruf created at 2020-04-03 16:33:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-03 16:44:04

Thank you.


---

Comment by vbraun created at 2020-04-09 22:44:44

Resolution: fixed


---

Comment by mkoeppe created at 2020-04-25 03:16:55

Replying to [comment:13 mkoeppe]:
> I also see a failure (testing with #29417):
> 
> - `local-conda-forge-macos-standard`: 
> {{{
>   [dochtml]       from sage.symbolic.all   import *
>   [dochtml]     File "/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/all.py", line 3, in <module>
>   [dochtml]       from sage.libs.pynac.pynac import I
>   [dochtml]     File "sage/symbolic/expression.pxd", line 4, in init sage.libs.pynac.pynac (build/cythonized/sage/libs/pynac/pynac.cpp:30411)
>    [dochtml]     File "sage/symbolic/expression.pyx", line 160, in init sage.symbolic.expression (build/cythonized/sage/symbolic/expression.cpp:75349)
>   [dochtml]   ImportError: dlopen(/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so, 2): Symbol not found: __ZN5GiNaC9containerINSt3__16vectorEEC2ERKNS2_INS_2exENS1_9allocatorIS4_EEEEb
>   [dochtml]     Referenced from: /Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so
>   [dochtml]     Expected in: flat namespace
>   [dochtml]    in /Users/runner/runners/2.165.2/work/sage/sage/.tox/local-conda-forge-macos-standard/local/lib/python3.7/site-packages/sage/symbolic/ring.cpython-37m-darwin.so
> }}}
> (this is with #29404 -- should take another look)

This is now #29574
