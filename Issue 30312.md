# Issue 30312: Remove all the bitset access from cython files in combinatorial polyhedron

Issue created by migration from https://trac.sagemath.org/ticket/30549

Original creator: @kliem

Original creation time: 2020-09-10 14:58:52

CC:  jipilab @laisrast tscrim

Keywords: combinatorial polyhedron, bitsets

This ticket removes all the top level bitset access. The algorithm is cleanly separated from the data structure now.

There is a new file `bitsets.cpp` (already introduced in #30528). This file should eventually be merged with `data_structures/bitsets.pxd` (and now one can see that such a thing is possible).

There is a file `face.cpp` that grabs what seems to be useful to define a face.

There is `face_list.cpp`. Here a list of faces is defined as a structure and some common methods that make sense for lists of faces are defined (such as intersect a face with a list of other faces and `get_next_level`).

There are two new structures: `face_list_struct` and `face_struct`. `face_list_struct` is more or less public. `face_struct` is pretty much private. Only the provided functions should be used with it.

The signatures of functions/methods became a lot easier. Cython files do not have to worry about alignment or `face_length` etc. Memory allocation is still done by `MemoryAllocator`. The low level file iteratively requests all the memory to define a face.

With this ticket, one can easily adapt the data structure for combinatorial faces to almost anything one likes. Hopefully without changing the cython files.


---

Comment by @kliem created at 2020-09-10 19:31:04

It's a patch bomb, I know. If anyone knows a reasonable way around it, I'll do it.

Currently, this is working again and I'm happy. And it's so much easier to do some something from then on.

Most of the changes in the cython files are trivial (took me a while to figure out everything though).

The current branch is a bit of regression with non-simple-non-simplicial polyhedra. It can take much longer. One thing is the unnecessary union of coatoms. Also the branch prediction seems to be bad, because one could know much earlier that the coatom check is useless. I'll think about a solution that works well.

We waste a bit of memory by also allocating enough space for the coatoms in each case, but I wouldn't worry about it for now. In a worst case scenario this needs twice as much memory and much less in many scenarios that have less equal number of vertices/facets. Memory was never an issue for me, it was always time.


---

Comment by git created at 2020-09-11 14:21:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-09-11 14:53:02

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-09-11 14:53:02

I'm happy with the ticket as it is.

Using templates for the two algorithmic variants, the branch prediction has improved significantly. For extreme cases (see below), things got a bit slower. I don't know why.

In a future ticket one can spare allocating the memory for the coatoms in case we are not using the simple/simplicial algorithm. It doesn't seem to make a difference in runtime.

This is an example of slight slowdown:

```
sage: P = polytopes.permutahedron(6)                                                                                                                                  
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                
sage: R = P.join(Q)                                                                                                                                                   
sage: C = CombinatorialPolyhedron(R)                                                                                                                                  
sage: %time _ = C.f_vector()                                                                                                                                              
CPU times: user 1min 12s, sys: 28.8 ms, total: 1min 12s
Wall time: 1min 12s
```

This is 10 seconds faster on #30040.

I could also play around with constants etc.

This could also all be because the compiler ignores my `inline` instructions in places.

Anyway, I can live with the slight slowdown for now, because the structure is so much better for further improvements.

Any suggestions on how to improve things are welcome.


---

Comment by @kliem created at 2020-09-11 15:26:01

https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html

If this is better, I could move almost everything back to cython again.

The only thing that really needs to be in C/C++ are those 4 functions that I want to optimize with intrinsics later on (there are going to be a few more, but they are all tiny).
To my knowledge you cannot do something like

```
#if __AVX__
def foo(): return 1
#elif __SSE4_1__
def foo(): return 2
#else
def foo(): return 3
#endif
```

in cython.

However I don't know how the performance is, when you include critical `C/C++` function via `cdef extern from` that will be called a huge number of times.


---

Comment by @kliem created at 2020-09-11 18:22:28

Changing status from needs_review to needs_info.


---

Comment by @kliem created at 2020-09-11 18:22:28

Also I'm happy with it now, the current status would force to move quite a lot of `bitsets` to C++. If I want to do it (which I'm not sure of yet) I would need to ask other people about it.

So for now this is a design proposal.


---

Comment by @kliem created at 2020-09-16 09:24:12

I like it much better now.

Timings with this ticket (branch `u/gh-kliem/use_face_structure`):

(Note that I didn't apply new tricks to the algorithm. Only the data structure has changed.)


```
sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 648 ms, sys: 15 µs, total: 648 ms
Wall time: 648 ms

sage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1.97 s, sys: 0 ns, total: 1.97 s
Wall time: 1.97 s

sage: P = polytopes.permutahedron(7)                                                                                                                                                
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 242 ms, sys: 0 ns, total: 242 ms
Wall time: 241 ms

sage: P = polytopes.hypercube(12)                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 430 ms, sys: 0 ns, total: 430 ms
Wall time: 429 ms

sage: P = polytopes.permutahedron(6)                                                                                                                                                
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              
sage: R = P.join(Q)                                                                                                                                                                 
sage: C = CombinatorialPolyhedron(R)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1min 11s, sys: 31.8 ms, total: 1min 11s
Wall time: 1min 11s
```


Timings on #30040:


```
sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 680 ms, sys: 0 ns, total: 680 ms
Wall time: 679 ms

sage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 2.2 s, sys: 45 µs, total: 2.2 s
Wall time: 2.2 s

sage: P = polytopes.permutahedron(7)                                                                                                                                                
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 240 ms, sys: 0 ns, total: 240 ms
Wall time: 239 ms

sage: P = polytopes.hypercube(12)                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 414 ms, sys: 0 ns, total: 414 ms
Wall time: 413 ms

sage: P = polytopes.permutahedron(6)                                                                                                                                                
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              
sage: R = P.join(Q)                                                                                                                                                                 
sage: C = CombinatorialPolyhedron(R)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1min 4s, sys: 51.6 ms, total: 1min 4s
Wall time: 1min 4s
```


So I would say that there is no performance-wise reason to reject the changes.

The branch indicates a bit, how this could be split into seperate tickets that are doable to review.
----
Last 10 new commits:


---

Comment by @kliem created at 2020-09-16 10:01:37

I posted on sage devel on whether the proposed design is acceptable:
https://groups.google.com/g/sage-devel/c/jD9BY5Ozlko


---

Comment by tscrim created at 2020-09-17 00:07:28

I am essentially happy with this ticket, but I want to wait and see what happens with the design discussion before going forward.


---

Comment by git created at 2020-09-18 16:24:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @kliem created at 2020-09-18 16:25:43

Changing status from needs_info to needs_review.


---

Comment by git created at 2020-10-26 07:32:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-11 09:48:55

Red branch.

I'll fix it, once all the dependencies are in.


---

Comment by @kliem created at 2020-11-11 09:48:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-27 08:37:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-27 08:42:06

Ok, this is back on needs review. Almost all dependencies are gone now.


---

Comment by @kliem created at 2020-11-27 08:42:06

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-12-07 23:16:52

`# The universe.` <-- Great comment.

LGTM. Hopefully this won't have any issues with other systems that some of the other tickets had.


---

Comment by tscrim created at 2020-12-07 23:16:52

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-08 07:06:11

Thank you.

Yes, I think it is way more stable, as it just exposes bitsets, which has been working for a while now.

I just didn't think, the intermediate solutions to the end.


---

Comment by vbraun created at 2020-12-13 20:30:42

Resolution: fixed
