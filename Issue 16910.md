# Issue 16910: Overriding checks to generate poset and lattice faster

Issue created by migration from https://trac.sagemath.org/ticket/17147

Original creator: jmantysalo

Original creation time: 2014-10-14 10:06:04

CC:  tscrim

Now for example `Posets.ChainPoset(500)` takes about 10 second. It does something like 1) make a list, 2) make a poset from list, checking that list really is acyclic as when read as digraph edges and 3) make a lattice from poset, checking that poset really is lattice. Phase 3 is done by really generating meet- and join-matrix.

Poset and lattice creating functions need an option that says "do not check, trust blindly".


---

Comment by jmantysalo created at 2016-09-26 11:19:04

Travis, I guess we should close this one. But to be sure:

First, if I just say `n = 500; L1 = LatticePoset((range(n), [[x,x+1] for x in range(n-1)]))` it takes about two seconds. But if I say


```
n = 500
D = DiGraph([range(n), [[x,x+1] for x in range(n-1)]], format='vertices_and_edges')
from sage.combinat.posets.lattices import FiniteLatticePoset
L2 = FiniteLatticePoset(D, range(n), FiniteLatticePosets(), True)
```


it takes only 10 or 20 millisecods. Can you confirm that this works, and so there is a way to override check "is this poset really a poset (i.e. acyclic transitive reduction of graph)"?

Second, another possibility is that the code could directly compute le-matrix, MÃ¶bius function matrix etc, and those would be very easy for a chain, diamond and so one. But that is a place for another ticket.

Third, it is unnecessary to re-compute meet- or join-matrix. But that is a duplicate of #20434 or #18776.


---

Comment by jmantysalo created at 2016-09-26 11:19:04

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-09-26 13:59:48

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2016-09-26 13:59:48

I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.


---

Comment by jmantysalo created at 2016-09-26 14:11:52

Replying to [comment:3 tscrim]:
> I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.

Do you mean only mandatory checks, i.e. `is_poset` and having a join matrix and a bottom element (or meet matrix and top), or more precomputation?


---

Comment by jmantysalo created at 2016-09-26 14:11:52

Changing status from needs_work to needs_info.


---

Comment by tscrim created at 2016-09-26 14:43:34

I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks


---

Comment by jmantysalo created at 2016-09-26 15:10:27

Replying to [comment:5 tscrim]:
> I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks

In specific functions at `lattice_examples.py` that creates, say, `DivisorLattice`?


---

Comment by tscrim created at 2016-09-26 15:14:20

Yes, that's correct.


---

Comment by jmantysalo created at 2016-09-26 15:32:57

Like this?

Does everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?
----
New commits:


---

Comment by tscrim created at 2016-09-26 16:34:18

Replying to [comment:9 jmantysalo]:
> Like this?

Yes.

> Does everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?

AFAIK, yes, but I don't have time immediately to test it. Unique representation is handled by the `FinitePoset` class and our input is basically the result from going through `Poset`. IIRC, the default for fixed linear extensions is to not have one. The others look like they are naturally the same from going through `Poset` as well.


---

Comment by jmantysalo created at 2016-09-26 16:57:49

OK. Then how to create `DivisorLattice` or whatever poset whose elements are not integers `0..n-1`?


---

Comment by jmantysalo created at 2016-09-27 04:39:19

Ah, the "hasse diagram" -parameter is not Hasse diagram in a sense that `hasse_diagram.py` defines... I.e. it is just a DiGraph with some properties as an unlabeled graph. So something like this could work:


```
from sage.combinat.posets.lattices import FiniteLatticePoset
from sage.categories.finite_lattice_posets import FiniteLatticePosets
n = 10^12
Div_n = divisors(n)
D = DiGraph([Div_n, lambda a, b: b%a==0 and is_prime(b//a)])
L = FiniteLatticePoset(D, elements=Div_n, category=FiniteLatticePosets())
```


This is faster than current implementation, but could be made even faster with some thinking. Having a natural linear extension would even make some small examples better; currently `Posets.DivisorLattice(12).join_irreducibles()` will give `[2, 4, 3]`.


---

Comment by jmantysalo created at 2016-10-07 12:36:26

Is there something against using distinguished linear extension in general? Slower, eats more memory, something?

I think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.


---

Comment by tscrim created at 2016-10-07 14:07:47

Replying to [comment:13 jmantysalo]:
> Is there something against using distinguished linear extension in general? Slower, eats more memory, something?

Not that I am aware.

> I think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.

It is natural in a way, but I don't have any opinion on this.


---

Comment by jmantysalo created at 2016-10-08 08:15:47

I did #21666 as a first part for this.


---

Comment by jmantysalo created at 2016-10-10 07:00:34

Changing status from needs_info to needs_work.


---

Comment by git created at 2016-11-14 20:23:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jmantysalo created at 2016-11-14 20:29:09

Done for most basic structures. I guess this one can be closed; more complicated structures take more time to create as a digraph, so proportional time change is not that much.


---

Comment by jmantysalo created at 2016-11-14 20:29:09

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-11-14 21:39:11

I agree that we can do things incrementally as there is a need. However, I don't agree with this change:

```diff
-        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}
-        return p
```

as this is used to make the printing of the poset is "nice".


---

Comment by jmantysalo created at 2016-11-15 05:21:06

Replying to [comment:19 tscrim]:
> I don't agree with this change:
> {{{#!diff
> -        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}
> -        return p
> }}}
> as this is used to make the printing of the poset is "nice".

Posets are plotted wih `layout='acyclic'`, so that will be overrided in any case.


---

Comment by jmantysalo created at 2016-11-21 07:37:31

Just pinging. As you can see from


```
g = DiGraph({0: [1]})
g._pos={0: [0,0], 1: [1,1]}
g.show(layout='acyclic')
```


the `...pos=...` line does nothing.


---

Comment by tscrim created at 2016-11-22 22:39:50

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-11-22 22:39:50

Looking at the code more, the original didn't actually set the `_pos` because it was doing it to a copy of the Hasse diagram. So it is okay I guess...it does have some effect on the `HasseDiagram` when done correctly, but like I said, it wasn't actually doing it correctly anyways.


---

Comment by jmantysalo created at 2016-11-23 04:49:36

OK, thanks. I'll continue on sage-devel about `_pos`.


---

Comment by vbraun created at 2016-11-27 16:46:02

Resolution: fixed
