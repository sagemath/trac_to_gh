# Issue 16910: Overriding checks to generate poset and lattice faster

archive/issues_016910.json:
```json
{
    "body": "CC:  tscrim\n\nNow for example `Posets.ChainPoset(500)` takes about 10 second. It does something like 1) make a list, 2) make a poset from list, checking that list really is acyclic as when read as digraph edges and 3) make a lattice from poset, checking that poset really is lattice. Phase 3 is done by really generating meet- and join-matrix.\n\nPoset and lattice creating functions need an option that says \"do not check, trust blindly\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/17147\n\n",
    "created_at": "2014-10-14T10:06:04Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Overriding checks to generate poset and lattice faster",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16910",
    "user": "jmantysalo"
}
```
CC:  tscrim

Now for example `Posets.ChainPoset(500)` takes about 10 second. It does something like 1) make a list, 2) make a poset from list, checking that list really is acyclic as when read as digraph edges and 3) make a lattice from poset, checking that poset really is lattice. Phase 3 is done by really generating meet- and join-matrix.

Poset and lattice creating functions need an option that says "do not check, trust blindly".

Issue created by migration from https://trac.sagemath.org/ticket/17147





---

archive/issue_comments_223970.json:
```json
{
    "body": "Travis, I guess we should close this one. But to be sure:\n\nFirst, if I just say `n = 500; L1 = LatticePoset((range(n), [[x,x+1] for x in range(n-1)]))` it takes about two seconds. But if I say\n\n\n```\nn = 500\nD = DiGraph([range(n), [[x,x+1] for x in range(n-1)]], format='vertices_and_edges')\nfrom sage.combinat.posets.lattices import FiniteLatticePoset\nL2 = FiniteLatticePoset(D, range(n), FiniteLatticePosets(), True)\n```\n\n\nit takes only 10 or 20 millisecods. Can you confirm that this works, and so there is a way to override check \"is this poset really a poset (i.e. acyclic transitive reduction of graph)\"?\n\nSecond, another possibility is that the code could directly compute le-matrix, M\u00f6bius function matrix etc, and those would be very easy for a chain, diamond and so one. But that is a place for another ticket.\n\nThird, it is unnecessary to re-compute meet- or join-matrix. But that is a duplicate of #20434 or #18776.",
    "created_at": "2016-09-26T11:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223970",
    "user": "jmantysalo"
}
```

Travis, I guess we should close this one. But to be sure:

First, if I just say `n = 500; L1 = LatticePoset((range(n), [[x,x+1] for x in range(n-1)]))` it takes about two seconds. But if I say


```
n = 500
D = DiGraph([range(n), [[x,x+1] for x in range(n-1)]], format='vertices_and_edges')
from sage.combinat.posets.lattices import FiniteLatticePoset
L2 = FiniteLatticePoset(D, range(n), FiniteLatticePosets(), True)
```


it takes only 10 or 20 millisecods. Can you confirm that this works, and so there is a way to override check "is this poset really a poset (i.e. acyclic transitive reduction of graph)"?

Second, another possibility is that the code could directly compute le-matrix, MÃ¶bius function matrix etc, and those would be very easy for a chain, diamond and so one. But that is a place for another ticket.

Third, it is unnecessary to re-compute meet- or join-matrix. But that is a duplicate of #20434 or #18776.



---

archive/issue_comments_223971.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-26T11:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223971",
    "user": "jmantysalo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_223972.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-26T13:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223972",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_223973.json:
```json
{
    "body": "I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.",
    "created_at": "2016-09-26T13:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223973",
    "user": "tscrim"
}
```

I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.



---

archive/issue_comments_223974.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.\n\nDo you mean only mandatory checks, i.e. `is_poset` and having a join matrix and a bottom element (or meet matrix and top), or more precomputation?",
    "created_at": "2016-09-26T14:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223974",
    "user": "jmantysalo"
}
```

Replying to [comment:3 tscrim]:
> I am opting for changing the relevant constructors to avoid the checks, which is a separate from #20434 and #18776.

Do you mean only mandatory checks, i.e. `is_poset` and having a join matrix and a bottom element (or meet matrix and top), or more precomputation?



---

archive/issue_comments_223975.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2016-09-26T14:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223975",
    "user": "jmantysalo"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_223976.json:
```json
{
    "body": "I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks",
    "created_at": "2016-09-26T14:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223976",
    "user": "tscrim"
}
```

I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks



---

archive/issue_comments_223977.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks\n\nIn specific functions at `lattice_examples.py` that creates, say, `DivisorLattice`?",
    "created_at": "2016-09-26T15:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223977",
    "user": "jmantysalo"
}
```

Replying to [comment:5 tscrim]:
> I mean replace `LatticePoset` with `FiniteLatticePoset` as in comment:2 to avoid the input validation checks

In specific functions at `lattice_examples.py` that creates, say, `DivisorLattice`?



---

archive/issue_comments_223978.json:
```json
{
    "body": "Yes, that's correct.",
    "created_at": "2016-09-26T15:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223978",
    "user": "tscrim"
}
```

Yes, that's correct.



---

archive/issue_comments_223979.json:
```json
{
    "body": "Like this?\n\nDoes everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?\n----\nNew commits:",
    "created_at": "2016-09-26T15:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223979",
    "user": "jmantysalo"
}
```

Like this?

Does everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?
----
New commits:



---

archive/issue_comments_223980.json:
```json
{
    "body": "Replying to [comment:9 jmantysalo]:\n> Like this?\n\nYes.\n\n> Does everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?\n\nAFAIK, yes, but I don't have time immediately to test it. Unique representation is handled by the `FinitePoset` class and our input is basically the result from going through `Poset`. IIRC, the default for fixed linear extensions is to not have one. The others look like they are naturally the same from going through `Poset` as well.",
    "created_at": "2016-09-26T16:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223980",
    "user": "tscrim"
}
```

Replying to [comment:9 jmantysalo]:
> Like this?

Yes.

> Does everything work? I.e. meets, joins, listing elements, linear extension is OK and so on? How about unique representation?

AFAIK, yes, but I don't have time immediately to test it. Unique representation is handled by the `FinitePoset` class and our input is basically the result from going through `Poset`. IIRC, the default for fixed linear extensions is to not have one. The others look like they are naturally the same from going through `Poset` as well.



---

archive/issue_comments_223981.json:
```json
{
    "body": "OK. Then how to create `DivisorLattice` or whatever poset whose elements are not integers `0..n-1`?",
    "created_at": "2016-09-26T16:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223981",
    "user": "jmantysalo"
}
```

OK. Then how to create `DivisorLattice` or whatever poset whose elements are not integers `0..n-1`?



---

archive/issue_comments_223982.json:
```json
{
    "body": "Ah, the \"hasse diagram\" -parameter is not Hasse diagram in a sense that `hasse_diagram.py` defines... I.e. it is just a DiGraph with some properties as an unlabeled graph. So something like this could work:\n\n\n```\nfrom sage.combinat.posets.lattices import FiniteLatticePoset\nfrom sage.categories.finite_lattice_posets import FiniteLatticePosets\nn = 10^12\nDiv_n = divisors(n)\nD = DiGraph([Div_n, lambda a, b: b%a==0 and is_prime(b//a)])\nL = FiniteLatticePoset(D, elements=Div_n, category=FiniteLatticePosets())\n```\n\n\nThis is faster than current implementation, but could be made even faster with some thinking. Having a natural linear extension would even make some small examples better; currently `Posets.DivisorLattice(12).join_irreducibles()` will give `[2, 4, 3]`.",
    "created_at": "2016-09-27T04:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223982",
    "user": "jmantysalo"
}
```

Ah, the "hasse diagram" -parameter is not Hasse diagram in a sense that `hasse_diagram.py` defines... I.e. it is just a DiGraph with some properties as an unlabeled graph. So something like this could work:


```
from sage.combinat.posets.lattices import FiniteLatticePoset
from sage.categories.finite_lattice_posets import FiniteLatticePosets
n = 10^12
Div_n = divisors(n)
D = DiGraph([Div_n, lambda a, b: b%a==0 and is_prime(b//a)])
L = FiniteLatticePoset(D, elements=Div_n, category=FiniteLatticePosets())
```


This is faster than current implementation, but could be made even faster with some thinking. Having a natural linear extension would even make some small examples better; currently `Posets.DivisorLattice(12).join_irreducibles()` will give `[2, 4, 3]`.



---

archive/issue_comments_223983.json:
```json
{
    "body": "Is there something against using distinguished linear extension in general? Slower, eats more memory, something?\n\nI think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.",
    "created_at": "2016-10-07T12:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223983",
    "user": "jmantysalo"
}
```

Is there something against using distinguished linear extension in general? Slower, eats more memory, something?

I think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.



---

archive/issue_comments_223984.json:
```json
{
    "body": "Replying to [comment:13 jmantysalo]:\n> Is there something against using distinguished linear extension in general? Slower, eats more memory, something?\n\nNot that I am aware.\n\n> I think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.\n\nIt is natural in a way, but I don't have any opinion on this.",
    "created_at": "2016-10-07T14:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223984",
    "user": "tscrim"
}
```

Replying to [comment:13 jmantysalo]:
> Is there something against using distinguished linear extension in general? Slower, eats more memory, something?

Not that I am aware.

> I think that `DivisorLattice()` is a good example for some functions like `join_irreducibles()`. But it is more natural if linear extension is ascending. That is, `Posets.DivisorLattice(12).join_irreducibles()` could return `[2, 3, 4]` and not `[2, 4, 3]` like it now does.

It is natural in a way, but I don't have any opinion on this.



---

archive/issue_comments_223985.json:
```json
{
    "body": "I did #21666 as a first part for this.",
    "created_at": "2016-10-08T08:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223985",
    "user": "jmantysalo"
}
```

I did #21666 as a first part for this.



---

archive/issue_comments_223986.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2016-10-10T07:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223986",
    "user": "jmantysalo"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_223987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-11-14T20:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223987",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_223988.json:
```json
{
    "body": "Done for most basic structures. I guess this one can be closed; more complicated structures take more time to create as a digraph, so proportional time change is not that much.",
    "created_at": "2016-11-14T20:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223988",
    "user": "jmantysalo"
}
```

Done for most basic structures. I guess this one can be closed; more complicated structures take more time to create as a digraph, so proportional time change is not that much.



---

archive/issue_comments_223989.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-14T20:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223989",
    "user": "jmantysalo"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_223990.json:
```json
{
    "body": "I agree that we can do things incrementally as there is a need. However, I don't agree with this change:\n\n```diff\n-        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}\n-        return p\n```\n\nas this is used to make the printing of the poset is \"nice\".",
    "created_at": "2016-11-14T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223990",
    "user": "tscrim"
}
```

I agree that we can do things incrementally as there is a need. However, I don't agree with this change:

```diff
-        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}
-        return p
```

as this is used to make the printing of the poset is "nice".



---

archive/issue_comments_223991.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> I don't agree with this change:\n> {{{#!diff\n> -        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}\n> -        return p\n> }}}\n> as this is used to make the printing of the poset is \"nice\".\n\nPosets are plotted wih `layout='acyclic'`, so that will be overrided in any case.",
    "created_at": "2016-11-15T05:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223991",
    "user": "jmantysalo"
}
```

Replying to [comment:19 tscrim]:
> I don't agree with this change:
> {{{#!diff
> -        p.hasse_diagram()._pos = {0:[2,0],1:[0,2],2:[3,1],3:[3,3],4:[2,4]}
> -        return p
> }}}
> as this is used to make the printing of the poset is "nice".

Posets are plotted wih `layout='acyclic'`, so that will be overrided in any case.



---

archive/issue_comments_223992.json:
```json
{
    "body": "Just pinging. As you can see from\n\n\n```\ng = DiGraph({0: [1]})\ng._pos={0: [0,0], 1: [1,1]}\ng.show(layout='acyclic')\n```\n\n\nthe `...pos=...` line does nothing.",
    "created_at": "2016-11-21T07:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223992",
    "user": "jmantysalo"
}
```

Just pinging. As you can see from


```
g = DiGraph({0: [1]})
g._pos={0: [0,0], 1: [1,1]}
g.show(layout='acyclic')
```


the `...pos=...` line does nothing.



---

archive/issue_comments_223993.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-22T22:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223993",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_223994.json:
```json
{
    "body": "Looking at the code more, the original didn't actually set the `_pos` because it was doing it to a copy of the Hasse diagram. So it is okay I guess...it does have some effect on the `HasseDiagram` when done correctly, but like I said, it wasn't actually doing it correctly anyways.",
    "created_at": "2016-11-22T22:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223994",
    "user": "tscrim"
}
```

Looking at the code more, the original didn't actually set the `_pos` because it was doing it to a copy of the Hasse diagram. So it is okay I guess...it does have some effect on the `HasseDiagram` when done correctly, but like I said, it wasn't actually doing it correctly anyways.



---

archive/issue_comments_223995.json:
```json
{
    "body": "OK, thanks. I'll continue on sage-devel about `_pos`.",
    "created_at": "2016-11-23T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223995",
    "user": "jmantysalo"
}
```

OK, thanks. I'll continue on sage-devel about `_pos`.



---

archive/issue_comments_223996.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-27T16:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16910",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16910#issuecomment-223996",
    "user": "vbraun"
}
```

Resolution: fixed
