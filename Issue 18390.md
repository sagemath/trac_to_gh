# Issue 18390: Fix the weight lattice realization of a tensor product of crystals

Issue created by migration from https://trac.sagemath.org/ticket/18627

Original creator: tscrim

Original creation time: 2015-06-07 00:42:12

Assignee: sage-combinat

CC:  sage-combinat bsalisbury1 aschilling

Keywords: crystals, tensor product

Right now, the weight lattice realization (WLR) of a tensor product assumes all crystals have the same WLR (the generic one implemented by the category). We should make sure the result of `weight_lattice_realization` for tensor products gives a common WLR.


---

Comment by tscrim created at 2015-06-07 01:09:04

I overwrote some of the `weight_lattice_realizations` methods, in particular, the one for `TensorProductOfCrystals`. I also fixed some assumptions about the existence of the ambient space.
----
New commits:


---

Comment by tscrim created at 2015-06-07 01:09:04

Changing status from new to needs_review.


---

Comment by bsalisbury1 created at 2015-06-07 16:00:38

Hi Travis,

I think the problem is still occurring is certain instances:


```
sage: R = RootSystem(['A',4,1])
sage: P = RootSystem(['A',4,1]).weight_lattice(extended=True)
sage: C = crystals.elementary.Component(R)
sage: La = P.fundamental_weights()
sage: TLa = crystals.elementary.T(R,La[0])
sage: Y = crystals.infinity.GeneralizedYoungWalls(4)
sage: T = crystals.TensorProduct(C,TLa,Y)
sage: mg = T(C[0],TLa[0],Y([]))
sage: mg.weight()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-26-8b7ee5a6cd87> in <module>()
----> 1 mg.weight()

/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/combinat/crystals/tensor_product.pyc in weight(self)
   1027             (-2, 1, 0, 1)
   1028         """
-> 1029         return sum(self[i].weight() for i in range(len(self)))
   1030 
   1031     def epsilon(self, i):

/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __add__(self, right)
    414             from sage.structure.element import get_coercion_model
    415             import operator
--> 416             return get_coercion_model().bin_op(self, right, operator.add)
    417 
    418         def __radd__(self, left):

/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9172)()
    900 
    901 
--> 902     cpdef bin_op(self, x, y, op):
    903         """
    904         Execute the operation op on x and y. It first looks for an action

/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9059)()
   1044         # We should really include the underlying error.
   1045         # This causes so much headache.
-> 1046         raise TypeError, arith_error_message(x,y,op)
   1047 
   1048     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for '+': 'Weight lattice of the Root system of type ['A', 4, 1]' and 'Ambient space of the Root system of type ['A', 4, 1]'
```


```
sage: C.weight_lattice_realization()
Weight lattice of the Root system of type ['A', 4, 1]
sage: TLa.weight_lattice_realization()
Ambient space of the Root system of type ['A', 4, 1]
sage: Y.weight_lattice_realization()
Weight lattice of the Root system of type ['A', 4, 1]
```


Is this particular error related to #18453 rather than this patch?


---

Comment by git created at 2015-06-07 16:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-07 16:13:39

Correct, this error will be fixed on #18453 because there is no coercion from the non-extended weight lattice to the ambient space (nor should there be because of the null root being zero in the former).

I moved the function to the actual concrete class (the one `WithGenerators` will be going away in #15463 as it is a subcrystal) to fix failing doctests.


---

Comment by bsalisbury1 created at 2015-06-07 17:14:09

Changing status from needs_review to positive_review.


---

Comment by bsalisbury1 created at 2015-06-07 17:14:09

Thanks, Travis!


```
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2066.5 seconds
    cpu time: 11856.2 seconds
    cumulative wall time: 16199.7 seconds
```



---

Comment by tscrim created at 2015-06-07 17:41:11

Thank you for the review.


---

Comment by vbraun created at 2015-06-08 20:28:41

Resolution: fixed
