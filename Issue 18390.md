# Issue 18390: Fix the weight lattice realization of a tensor product of crystals

archive/issues_018390.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  sage-combinat bsalisbury1 aschilling\n\nKeywords: crystals, tensor product\n\nRight now, the weight lattice realization (WLR) of a tensor product assumes all crystals have the same WLR (the generic one implemented by the category). We should make sure the result of `weight_lattice_realization` for tensor products gives a common WLR.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18627\n\n",
    "created_at": "2015-06-07T00:42:12Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "title": "Fix the weight lattice realization of a tensor product of crystals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18390",
    "user": "tscrim"
}
```
Assignee: sage-combinat

CC:  sage-combinat bsalisbury1 aschilling

Keywords: crystals, tensor product

Right now, the weight lattice realization (WLR) of a tensor product assumes all crystals have the same WLR (the generic one implemented by the category). We should make sure the result of `weight_lattice_realization` for tensor products gives a common WLR.

Issue created by migration from https://trac.sagemath.org/ticket/18627





---

archive/issue_comments_249764.json:
```json
{
    "body": "I overwrote some of the `weight_lattice_realizations` methods, in particular, the one for `TensorProductOfCrystals`. I also fixed some assumptions about the existence of the ambient space.\n----\nNew commits:",
    "created_at": "2015-06-07T01:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249764",
    "user": "tscrim"
}
```

I overwrote some of the `weight_lattice_realizations` methods, in particular, the one for `TensorProductOfCrystals`. I also fixed some assumptions about the existence of the ambient space.
----
New commits:



---

archive/issue_comments_249765.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-07T01:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249765",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_249766.json:
```json
{
    "body": "Hi Travis,\n\nI think the problem is still occurring is certain instances:\n\n\n```\nsage: R = RootSystem(['A',4,1])\nsage: P = RootSystem(['A',4,1]).weight_lattice(extended=True)\nsage: C = crystals.elementary.Component(R)\nsage: La = P.fundamental_weights()\nsage: TLa = crystals.elementary.T(R,La[0])\nsage: Y = crystals.infinity.GeneralizedYoungWalls(4)\nsage: T = crystals.TensorProduct(C,TLa,Y)\nsage: mg = T(C[0],TLa[0],Y([]))\nsage: mg.weight()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-26-8b7ee5a6cd87> in <module>()\n----> 1 mg.weight()\n\n/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/combinat/crystals/tensor_product.pyc in weight(self)\n   1027             (-2, 1, 0, 1)\n   1028         \"\"\"\n-> 1029         return sum(self[i].weight() for i in range(len(self)))\n   1030 \n   1031     def epsilon(self, i):\n\n/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __add__(self, right)\n    414             from sage.structure.element import get_coercion_model\n    415             import operator\n--> 416             return get_coercion_model().bin_op(self, right, operator.add)\n    417 \n    418         def __radd__(self, left):\n\n/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9172)()\n    900 \n    901 \n--> 902     cpdef bin_op(self, x, y, op):\n    903         \"\"\"\n    904         Execute the operation op on x and y. It first looks for an action\n\n/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9059)()\n   1044         # We should really include the underlying error.\n   1045         # This causes so much headache.\n-> 1046         raise TypeError, arith_error_message(x,y,op)\n   1047 \n   1048     cpdef canonical_coercion(self, x, y):\n\nTypeError: unsupported operand parent(s) for '+': 'Weight lattice of the Root system of type ['A', 4, 1]' and 'Ambient space of the Root system of type ['A', 4, 1]'\n```\n\n\n```\nsage: C.weight_lattice_realization()\nWeight lattice of the Root system of type ['A', 4, 1]\nsage: TLa.weight_lattice_realization()\nAmbient space of the Root system of type ['A', 4, 1]\nsage: Y.weight_lattice_realization()\nWeight lattice of the Root system of type ['A', 4, 1]\n```\n\n\nIs this particular error related to #18453 rather than this patch?",
    "created_at": "2015-06-07T16:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249766",
    "user": "bsalisbury1"
}
```

Hi Travis,

I think the problem is still occurring is certain instances:


```
sage: R = RootSystem(['A',4,1])
sage: P = RootSystem(['A',4,1]).weight_lattice(extended=True)
sage: C = crystals.elementary.Component(R)
sage: La = P.fundamental_weights()
sage: TLa = crystals.elementary.T(R,La[0])
sage: Y = crystals.infinity.GeneralizedYoungWalls(4)
sage: T = crystals.TensorProduct(C,TLa,Y)
sage: mg = T(C[0],TLa[0],Y([]))
sage: mg.weight()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-26-8b7ee5a6cd87> in <module>()
----> 1 mg.weight()

/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/combinat/crystals/tensor_product.pyc in weight(self)
   1027             (-2, 1, 0, 1)
   1028         """
-> 1029         return sum(self[i].weight() for i in range(len(self)))
   1030 
   1031     def epsilon(self, i):

/Users/Ben/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __add__(self, right)
    414             from sage.structure.element import get_coercion_model
    415             import operator
--> 416             return get_coercion_model().bin_op(self, right, operator.add)
    417 
    418         def __radd__(self, left):

/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9172)()
    900 
    901 
--> 902     cpdef bin_op(self, x, y, op):
    903         """
    904         Execute the operation op on x and y. It first looks for an action

/Users/Ben/sage-git/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9059)()
   1044         # We should really include the underlying error.
   1045         # This causes so much headache.
-> 1046         raise TypeError, arith_error_message(x,y,op)
   1047 
   1048     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for '+': 'Weight lattice of the Root system of type ['A', 4, 1]' and 'Ambient space of the Root system of type ['A', 4, 1]'
```


```
sage: C.weight_lattice_realization()
Weight lattice of the Root system of type ['A', 4, 1]
sage: TLa.weight_lattice_realization()
Ambient space of the Root system of type ['A', 4, 1]
sage: Y.weight_lattice_realization()
Weight lattice of the Root system of type ['A', 4, 1]
```


Is this particular error related to #18453 rather than this patch?



---

archive/issue_comments_249767.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-07T16:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249767",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_249768.json:
```json
{
    "body": "Correct, this error will be fixed on #18453 because there is no coercion from the non-extended weight lattice to the ambient space (nor should there be because of the null root being zero in the former).\n\nI moved the function to the actual concrete class (the one `WithGenerators` will be going away in #15463 as it is a subcrystal) to fix failing doctests.",
    "created_at": "2015-06-07T16:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249768",
    "user": "tscrim"
}
```

Correct, this error will be fixed on #18453 because there is no coercion from the non-extended weight lattice to the ambient space (nor should there be because of the null root being zero in the former).

I moved the function to the actual concrete class (the one `WithGenerators` will be going away in #15463 as it is a subcrystal) to fix failing doctests.



---

archive/issue_comments_249769.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-07T17:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249769",
    "user": "bsalisbury1"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_249770.json:
```json
{
    "body": "Thanks, Travis!\n\n\n```\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 2066.5 seconds\n    cpu time: 11856.2 seconds\n    cumulative wall time: 16199.7 seconds\n```\n",
    "created_at": "2015-06-07T17:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249770",
    "user": "bsalisbury1"
}
```

Thanks, Travis!


```
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2066.5 seconds
    cpu time: 11856.2 seconds
    cumulative wall time: 16199.7 seconds
```




---

archive/issue_comments_249771.json:
```json
{
    "body": "Thank you for the review.",
    "created_at": "2015-06-07T17:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249771",
    "user": "tscrim"
}
```

Thank you for the review.



---

archive/issue_comments_249772.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-08T20:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18390#issuecomment-249772",
    "user": "vbraun"
}
```

Resolution: fixed
