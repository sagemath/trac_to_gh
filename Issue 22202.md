# Issue 22202: Fix use of scipy rtol parameter

Issue created by migration from Trac.

Original creator: infinity0

Original creation time: 2017-02-25 15:18:27




---

Comment by infinity0 created at 2017-02-25 15:20:27

New commits:


---

Comment by infinity0 created at 2017-02-25 15:20:27

Changing status from new to needs_review.


---

Comment by infinity0 created at 2017-02-25 15:20:27

Changing component from PLEASE CHANGE to interfaces.


---

Comment by infinity0 created at 2017-02-25 15:26:51

Changing type from PLEASE CHANGE to defect.


---

Comment by jdemeyer created at 2017-02-25 19:18:52

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-02-25 19:18:52

This seems a bit over-engineered to me. What exactly is the problem?


---

Comment by jdemeyer created at 2017-02-25 20:01:45

I mean: why not just change the default value of `rtol` directly?


---

Comment by infinity0 created at 2017-02-25 22:42:25

Oh, that is because `sage.numerical.optimize` is not imported until we actually run that function. But the default value of a function has to be available when the function is defined, i.e. before it is run.

An alternative is to define `default_rtol` in some other module and have both `sage/numerical/optimize.py` and `src/sage/symbolic/expression.pyx` import this module at the top, unconditionally. Do you have a suggestion on which module this could be?


---

Comment by jdemeyer created at 2017-02-26 10:08:46

Replying to [comment:6 infinity0]:
> An alternative is to define `default_rtol`

Why is that needed?

Why not just change the default value and nothing else?


---

Comment by infinity0 created at 2017-02-26 12:47:27

To change the default value in both locations as you're suggesting, I would have to write `4*finfo(float).eps` in two modules.

The definition comes from the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq) of scipy yet is a calculation on a numpy architecture-dependent property. (The docs say `8.88..e-16`, giving away the architecture of the build machine.) I was unsure if this might change in the future, so I only wanted to define it once, and avoid coupling two Sage modules to what looks like a numpy implementation detail but is actually one of scipy's.

It's unfortunate that scipy don't expose the value themselves. Actually, I will send a patch to them for that, when I next get some time. I just noticed again that it's available as `from scipy.optimize.zeros import _rtol`, i.e. a "private" variable, but this could be properly exposed.

In the meantime, shall I do it your way and duplicate the definitions?


---

Comment by jdemeyer created at 2017-02-26 19:00:07

Are you sure that this value is architecture-dependent? I think it's just the constant `2.0 ** -50`.


---

Comment by infinity0 created at 2017-03-11 16:51:52

I'm not confident how architecture-dependent this is; numpy themselves perform quite a long complex calculation in `numpy.core.getlimits` and `numpy.core.machar`, and also Sage currently thinks it's a different value. (The code says 4.5e-16).

I think it would be safer to use the symbolic value as indicated in the scipy documentation, than try to guess that it might be architecture-dependent. (It's true that Sage only works on x86 and x64 right now, but there's no need to add more obstacles to portability.)


---

Comment by jdemeyer created at 2017-03-11 19:51:34

Replying to [comment:10 infinity0]:
> also Sage currently thinks it's a different value. (The code says 4.5e-16).

Sage doesn't "think" it's a different value, Sage just hardcodes a different number.

So why does this default value for `rtol` even need to be equal to whatever `scipy` uses?


---

Comment by infinity0 created at 2017-03-11 20:52:30

It needs to be greater than the documented minimum, otherwise we get errors.

From the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq):

rtol [..] cannot be smaller than its default value of `4*np.finfo(float).eps`.


---

Comment by jdemeyer created at 2017-03-11 21:19:43

Replying to [comment:10 infinity0]:
> I'm not confident how architecture-dependent this is

According to [Wikipedia](https://en.wikipedia.org/wiki/Double-precision_floating-point_format#C_and_C.2B.2B), a C `double` (which is how Python implements `float`) is required by C99 to be an [IEEE-754](https://en.wikipedia.org/wiki/IEEE_floating_point) double precision number. So that would make it not architecture dependent.


---

Comment by jdemeyer created at 2017-03-11 21:20:23

In other words: even though it might theoretically be architecture-dependent, in practice it's not.


---

Comment by jdemeyer created at 2017-03-11 21:22:39

Replying to [comment:10 infinity0]:
> It's true that Sage only works on x86 and x64 right now

For the record: we do consider that a bug: #22280. In the past, Sage has worked on SPARC, Itanium, various kinds of PowerPCs, ARM (some of these with a few issues).


---

Comment by infinity0 created at 2017-03-11 22:33:55

OK, I see


```
typedef struct {
    PyObject_HEAD
    double ob_fval;
} PyFloatObject;
```


in python's `Include/floatobject.h` so I guess this is fine. So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.


---

Comment by jdemeyer created at 2017-03-12 08:22:23

Replying to [comment:16 infinity0]:
> So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.


Sounds good.


---

Comment by git created at 2017-03-12 15:41:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by infinity0 created at 2017-03-12 15:42:35

Changing status from needs_info to needs_review.


---

Comment by infinity0 created at 2017-03-12 15:52:20

Oh, I dug a bit deeper and found that scipy changed the meaning of this flag between 0.17.1 and 0.18.1. Sage's current usage is also OK for the older version but not the newer version:

https://github.com/scipy/scipy/commit/cbd91b93c752eb2e947c2b657fe0471a12759b83#diff-9167bb8d33bd7d9eb5e07e0ebe18e05e

I'm unsure if this patch will cause any extra doctest failures for Sage upstream and scipy 0.17.1, but I guess we'll see that when a build is run.

(On Debian, we are also patching some doctests to expect slightly different float results, but I can't remember which of these are caused by scipy. The differences are minute, of course.)


---

Comment by infinity0 created at 2017-03-12 15:59:16

I guess it may be best to put off this change until you guys upgrade to scipy >= 0.18.1. At least, the extra doc comment I added in that commit is wrong for scipy 0.17.1.


---

Comment by jdemeyer created at 2017-03-18 10:06:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-27 20:42:23

Resolution: fixed
