# Issue 22202: Fix use of scipy rtol parameter

archive/issues_022202.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/22439\n\n",
    "created_at": "2017-02-25T15:18:27Z",
    "labels": [],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Fix use of scipy rtol parameter",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22202",
    "user": "https://github.com/infinity0"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/22439





---

archive/issue_comments_308053.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-02-25T15:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308053",
    "user": "https://github.com/infinity0"
}
```

New commits:



---

archive/issue_comments_308054.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-02-25T15:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308054",
    "user": "https://github.com/infinity0"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_308055.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to interfaces.",
    "created_at": "2017-02-25T15:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308055",
    "user": "https://github.com/infinity0"
}
```

Changing component from PLEASE CHANGE to interfaces.



---

archive/issue_comments_308056.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-02-25T15:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308056",
    "user": "https://github.com/infinity0"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_308057.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-02-25T19:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308057",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_308058.json:
```json
{
    "body": "This seems a bit over-engineered to me. What exactly is the problem?",
    "created_at": "2017-02-25T19:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308058",
    "user": "https://github.com/jdemeyer"
}
```

This seems a bit over-engineered to me. What exactly is the problem?



---

archive/issue_comments_308059.json:
```json
{
    "body": "I mean: why not just change the default value of `rtol` directly?",
    "created_at": "2017-02-25T20:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308059",
    "user": "https://github.com/jdemeyer"
}
```

I mean: why not just change the default value of `rtol` directly?



---

archive/issue_comments_308060.json:
```json
{
    "body": "Oh, that is because `sage.numerical.optimize` is not imported until we actually run that function. But the default value of a function has to be available when the function is defined, i.e. before it is run.\n\nAn alternative is to define `default_rtol` in some other module and have both `sage/numerical/optimize.py` and `src/sage/symbolic/expression.pyx` import this module at the top, unconditionally. Do you have a suggestion on which module this could be?",
    "created_at": "2017-02-25T22:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308060",
    "user": "https://github.com/infinity0"
}
```

Oh, that is because `sage.numerical.optimize` is not imported until we actually run that function. But the default value of a function has to be available when the function is defined, i.e. before it is run.

An alternative is to define `default_rtol` in some other module and have both `sage/numerical/optimize.py` and `src/sage/symbolic/expression.pyx` import this module at the top, unconditionally. Do you have a suggestion on which module this could be?



---

archive/issue_comments_308061.json:
```json
{
    "body": "Replying to [comment:6 infinity0]:\n> An alternative is to define `default_rtol`\n\nWhy is that needed?\n\nWhy not just change the default value and nothing else?",
    "created_at": "2017-02-26T10:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308061",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 infinity0]:
> An alternative is to define `default_rtol`

Why is that needed?

Why not just change the default value and nothing else?



---

archive/issue_comments_308062.json:
```json
{
    "body": "To change the default value in both locations as you're suggesting, I would have to write `4*finfo(float).eps` in two modules.\n\nThe definition comes from the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq) of scipy yet is a calculation on a numpy architecture-dependent property. (The docs say `8.88..e-16`, giving away the architecture of the build machine.) I was unsure if this might change in the future, so I only wanted to define it once, and avoid coupling two Sage modules to what looks like a numpy implementation detail but is actually one of scipy's.\n\nIt's unfortunate that scipy don't expose the value themselves. Actually, I will send a patch to them for that, when I next get some time. I just noticed again that it's available as `from scipy.optimize.zeros import _rtol`, i.e. a \"private\" variable, but this could be properly exposed.\n\nIn the meantime, shall I do it your way and duplicate the definitions?",
    "created_at": "2017-02-26T12:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308062",
    "user": "https://github.com/infinity0"
}
```

To change the default value in both locations as you're suggesting, I would have to write `4*finfo(float).eps` in two modules.

The definition comes from the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq) of scipy yet is a calculation on a numpy architecture-dependent property. (The docs say `8.88..e-16`, giving away the architecture of the build machine.) I was unsure if this might change in the future, so I only wanted to define it once, and avoid coupling two Sage modules to what looks like a numpy implementation detail but is actually one of scipy's.

It's unfortunate that scipy don't expose the value themselves. Actually, I will send a patch to them for that, when I next get some time. I just noticed again that it's available as `from scipy.optimize.zeros import _rtol`, i.e. a "private" variable, but this could be properly exposed.

In the meantime, shall I do it your way and duplicate the definitions?



---

archive/issue_comments_308063.json:
```json
{
    "body": "Are you sure that this value is architecture-dependent? I think it's just the constant `2.0 ** -50`.",
    "created_at": "2017-02-26T19:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308063",
    "user": "https://github.com/jdemeyer"
}
```

Are you sure that this value is architecture-dependent? I think it's just the constant `2.0 ** -50`.



---

archive/issue_comments_308064.json:
```json
{
    "body": "I'm not confident how architecture-dependent this is; numpy themselves perform quite a long complex calculation in `numpy.core.getlimits` and `numpy.core.machar`, and also Sage currently thinks it's a different value. (The code says 4.5e-16).\n\nI think it would be safer to use the symbolic value as indicated in the scipy documentation, than try to guess that it might be architecture-dependent. (It's true that Sage only works on x86 and x64 right now, but there's no need to add more obstacles to portability.)",
    "created_at": "2017-03-11T16:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308064",
    "user": "https://github.com/infinity0"
}
```

I'm not confident how architecture-dependent this is; numpy themselves perform quite a long complex calculation in `numpy.core.getlimits` and `numpy.core.machar`, and also Sage currently thinks it's a different value. (The code says 4.5e-16).

I think it would be safer to use the symbolic value as indicated in the scipy documentation, than try to guess that it might be architecture-dependent. (It's true that Sage only works on x86 and x64 right now, but there's no need to add more obstacles to portability.)



---

archive/issue_comments_308065.json:
```json
{
    "body": "Replying to [comment:10 infinity0]:\n> also Sage currently thinks it's a different value. (The code says 4.5e-16).\n\nSage doesn't \"think\" it's a different value, Sage just hardcodes a different number.\n\nSo why does this default value for `rtol` even need to be equal to whatever `scipy` uses?",
    "created_at": "2017-03-11T19:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308065",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 infinity0]:
> also Sage currently thinks it's a different value. (The code says 4.5e-16).

Sage doesn't "think" it's a different value, Sage just hardcodes a different number.

So why does this default value for `rtol` even need to be equal to whatever `scipy` uses?



---

archive/issue_comments_308066.json:
```json
{
    "body": "It needs to be greater than the documented minimum, otherwise we get errors.\n\nFrom the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq):\n\nrtol [..] cannot be smaller than its default value of `4*np.finfo(float).eps`.",
    "created_at": "2017-03-11T20:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308066",
    "user": "https://github.com/infinity0"
}
```

It needs to be greater than the documented minimum, otherwise we get errors.

From the [documentation](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.brentq.html#scipy.optimize.brentq):

rtol [..] cannot be smaller than its default value of `4*np.finfo(float).eps`.



---

archive/issue_comments_308067.json:
```json
{
    "body": "Replying to [comment:10 infinity0]:\n> I'm not confident how architecture-dependent this is\n\nAccording to [Wikipedia](https://en.wikipedia.org/wiki/Double-precision_floating-point_format#C_and_C.2B.2B), a C `double` (which is how Python implements `float`) is required by C99 to be an [IEEE-754](https://en.wikipedia.org/wiki/IEEE_floating_point) double precision number. So that would make it not architecture dependent.",
    "created_at": "2017-03-11T21:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308067",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 infinity0]:
> I'm not confident how architecture-dependent this is

According to [Wikipedia](https://en.wikipedia.org/wiki/Double-precision_floating-point_format#C_and_C.2B.2B), a C `double` (which is how Python implements `float`) is required by C99 to be an [IEEE-754](https://en.wikipedia.org/wiki/IEEE_floating_point) double precision number. So that would make it not architecture dependent.



---

archive/issue_comments_308068.json:
```json
{
    "body": "In other words: even though it might theoretically be architecture-dependent, in practice it's not.",
    "created_at": "2017-03-11T21:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308068",
    "user": "https://github.com/jdemeyer"
}
```

In other words: even though it might theoretically be architecture-dependent, in practice it's not.



---

archive/issue_comments_308069.json:
```json
{
    "body": "Replying to [comment:10 infinity0]:\n> It's true that Sage only works on x86 and x64 right now\n\nFor the record: we do consider that a bug: #22280. In the past, Sage has worked on SPARC, Itanium, various kinds of PowerPCs, ARM (some of these with a few issues).",
    "created_at": "2017-03-11T21:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308069",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 infinity0]:
> It's true that Sage only works on x86 and x64 right now

For the record: we do consider that a bug: #22280. In the past, Sage has worked on SPARC, Itanium, various kinds of PowerPCs, ARM (some of these with a few issues).



---

archive/issue_comments_308070.json:
```json
{
    "body": "OK, I see\n\n\n```\ntypedef struct {\n    PyObject_HEAD\n    double ob_fval;\n} PyFloatObject;\n```\n\n\nin python's `Include/floatobject.h` so I guess this is fine. So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.",
    "created_at": "2017-03-11T22:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308070",
    "user": "https://github.com/infinity0"
}
```

OK, I see


```
typedef struct {
    PyObject_HEAD
    double ob_fval;
} PyFloatObject;
```


in python's `Include/floatobject.h` so I guess this is fine. So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.



---

archive/issue_comments_308071.json:
```json
{
    "body": "Replying to [comment:16 infinity0]:\n> So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.\n\n\nSounds good.",
    "created_at": "2017-03-12T08:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308071",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 infinity0]:
> So you want me to rewrite the patch to hard-code `2.0 ** -50` instead? I'll add some comments too.


Sounds good.



---

archive/issue_comments_308072.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-12T15:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_308073.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-03-12T15:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308073",
    "user": "https://github.com/infinity0"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_308074.json:
```json
{
    "body": "Oh, I dug a bit deeper and found that scipy changed the meaning of this flag between 0.17.1 and 0.18.1. Sage's current usage is also OK for the older version but not the newer version:\n\nhttps://github.com/scipy/scipy/commit/cbd91b93c752eb2e947c2b657fe0471a12759b83#diff-9167bb8d33bd7d9eb5e07e0ebe18e05e\n\nI'm unsure if this patch will cause any extra doctest failures for Sage upstream and scipy 0.17.1, but I guess we'll see that when a build is run.\n\n(On Debian, we are also patching some doctests to expect slightly different float results, but I can't remember which of these are caused by scipy. The differences are minute, of course.)",
    "created_at": "2017-03-12T15:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308074",
    "user": "https://github.com/infinity0"
}
```

Oh, I dug a bit deeper and found that scipy changed the meaning of this flag between 0.17.1 and 0.18.1. Sage's current usage is also OK for the older version but not the newer version:

https://github.com/scipy/scipy/commit/cbd91b93c752eb2e947c2b657fe0471a12759b83#diff-9167bb8d33bd7d9eb5e07e0ebe18e05e

I'm unsure if this patch will cause any extra doctest failures for Sage upstream and scipy 0.17.1, but I guess we'll see that when a build is run.

(On Debian, we are also patching some doctests to expect slightly different float results, but I can't remember which of these are caused by scipy. The differences are minute, of course.)



---

archive/issue_comments_308075.json:
```json
{
    "body": "I guess it may be best to put off this change until you guys upgrade to scipy >= 0.18.1. At least, the extra doc comment I added in that commit is wrong for scipy 0.17.1.",
    "created_at": "2017-03-12T15:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308075",
    "user": "https://github.com/infinity0"
}
```

I guess it may be best to put off this change until you guys upgrade to scipy >= 0.18.1. At least, the extra doc comment I added in that commit is wrong for scipy 0.17.1.



---

archive/issue_comments_308076.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-18T10:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308076",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_308077.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22202#issuecomment-308077",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058702.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-27T20:42:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22202",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22202#event-58702"
}
```
