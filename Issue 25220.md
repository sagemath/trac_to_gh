# Issue 25220: Enter the component of a metric while declaring the metric on a Parallelizable Manifold

archive/issues_025220.json:
```json
{
    "body": "CC:  @egourgoulhon\n\nKeywords: Parallelizable Manifold, Pseudo-Riemannian Metric, Degenerate Metric\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25457\n\n",
    "created_at": "2018-05-28T19:16:14Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Enter the component of a metric while declaring the metric on a Parallelizable Manifold",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25220",
    "user": "Dicolevrai"
}
```
CC:  @egourgoulhon

Keywords: Parallelizable Manifold, Pseudo-Riemannian Metric, Degenerate Metric



Issue created by migration from https://trac.sagemath.org/ticket/25457





---

archive/issue_comments_355227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-28T21:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355227",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355228.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-30T14:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355228",
    "user": "Dicolevrai"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_355229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-31T11:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355229",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-31T15:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355230",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355231.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-31T17:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355231",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355232.json:
```json
{
    "body": "Thanks for this contribution!\n\nAs you can see on the [patchbot report](https://patchbot.sagemath.org/ticket/25457/) \n(which you can get by clicking on the yellow question mark at the top right and then on the \"shortlog\" items), there are many doctest failures, mostly due to the change in handling the metric signature. Could you fix this please? Before submitting the change, you can make sure that all doctests are passed by running\n\n```\nsage -tp --long src/sage/manifolds/\n```\n\nIn case you need more information about the patchbot, see [here](https://wiki.sagemath.org/buildbot).",
    "created_at": "2018-06-03T21:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355232",
    "user": "@egourgoulhon"
}
```

Thanks for this contribution!

As you can see on the [patchbot report](https://patchbot.sagemath.org/ticket/25457/) 
(which you can get by clicking on the yellow question mark at the top right and then on the "shortlog" items), there are many doctest failures, mostly due to the change in handling the metric signature. Could you fix this please? Before submitting the change, you can make sure that all doctests are passed by running

```
sage -tp --long src/sage/manifolds/
```

In case you need more information about the patchbot, see [here](https://wiki.sagemath.org/buildbot).



---

archive/issue_comments_355233.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-03T21:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355233",
    "user": "@egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_355234.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-06T04:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355234",
    "user": "Dicolevrai"
}
```

New commits:



---

archive/issue_comments_355235.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-06T04:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355235",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355236.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-06T05:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355236",
    "user": "Dicolevrai"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_355237.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-12T12:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355237",
    "user": "@egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_355238.json:
```json
{
    "body": "A doctest fails:\n\n```\nsage -t --long --warn-long 49.9 src/sage/manifolds/differentiable/metric.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/metric.py\", line 1006, in sage.manifolds.differentiable.metric.PseudoRiemannianMetric.riemann\nFailed example:\n    g.riemann()[:]\nExpected:\n    [[[[0, 0], [0, 0]], [[0, sin(th)^2], [-sin(th)^2, 0]]],\n    [[[0, (cos(th)^2 - 1)/sin(th)^2], [1, 0]], [[0, 0], [0, 0]]]]\nGot:\n    [[[[0, 0], [0, 0]], [[0, sin(th)^2], [-sin(th)^2, 0]]],\n     [[[0, -1], [1, 0]], [[0, 0], [0, 0]]]]\n**********************************************************************\n1 item had failures:\n   1 of  15 in sage.manifolds.differentiable.metric.PseudoRiemannianMetric.riemann\n    [534 tests, 1 failure, 86.67 s]\n```\n\nBesides, the following doctest in line 168-170 of `src/sage/manifolds/differentiable/pseudo_riemannian.py`:\n\n```    \nsage: g = M.metric()\nsage: g\nRiemannian metric g on the 4-dimensional Lorentzian manifold M\n```\n\nis not correct: the output should be `Lorentzian metric` (as it was prior to this ticket), since `M` has been declared in line 158 as being a Lorentzian manifold. \n\nSimilarly, in lines 566-567 of the same file, the output of the doctest \n\n```\nsage: h = M.metric('h', signature=1); h\nRiemannian metric h on the 3-dimensional Riemannian manifold M\n```\n\nis not correct, since a signature of 1 on a 3-dimensional manifold implies a Lorentzian metric. \n\nIn the helper function `_diag` defined in line 1908 of `src/sage/manifolds/differentiable/metric.py`, it is quite unconventional to name the first argument `self` since `_diag` is not a class method. \n\nYou should not end docstring lines by a backslash character, as done in lines 1976-1982 of `metric.py`. \n\nThe documentation fails to build: the command\n\n```\n./sage -docbuild reference/manifolds html\n```\n\nreturns errors like\n\n```\ndocstring of sage.manifolds.differentiable.metric.PseudoRiemannianMetricParal.index:7: \nWARNING: Bullet list ends without a blank line; unexpected unindent.\n```\n",
    "created_at": "2018-06-12T12:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355238",
    "user": "@egourgoulhon"
}
```

A doctest fails:

```
sage -t --long --warn-long 49.9 src/sage/manifolds/differentiable/metric.py
**********************************************************************
File "src/sage/manifolds/differentiable/metric.py", line 1006, in sage.manifolds.differentiable.metric.PseudoRiemannianMetric.riemann
Failed example:
    g.riemann()[:]
Expected:
    [[[[0, 0], [0, 0]], [[0, sin(th)^2], [-sin(th)^2, 0]]],
    [[[0, (cos(th)^2 - 1)/sin(th)^2], [1, 0]], [[0, 0], [0, 0]]]]
Got:
    [[[[0, 0], [0, 0]], [[0, sin(th)^2], [-sin(th)^2, 0]]],
     [[[0, -1], [1, 0]], [[0, 0], [0, 0]]]]
**********************************************************************
1 item had failures:
   1 of  15 in sage.manifolds.differentiable.metric.PseudoRiemannianMetric.riemann
    [534 tests, 1 failure, 86.67 s]
```

Besides, the following doctest in line 168-170 of `src/sage/manifolds/differentiable/pseudo_riemannian.py`:

```    
sage: g = M.metric()
sage: g
Riemannian metric g on the 4-dimensional Lorentzian manifold M
```

is not correct: the output should be `Lorentzian metric` (as it was prior to this ticket), since `M` has been declared in line 158 as being a Lorentzian manifold. 

Similarly, in lines 566-567 of the same file, the output of the doctest 

```
sage: h = M.metric('h', signature=1); h
Riemannian metric h on the 3-dimensional Riemannian manifold M
```

is not correct, since a signature of 1 on a 3-dimensional manifold implies a Lorentzian metric. 

In the helper function `_diag` defined in line 1908 of `src/sage/manifolds/differentiable/metric.py`, it is quite unconventional to name the first argument `self` since `_diag` is not a class method. 

You should not end docstring lines by a backslash character, as done in lines 1976-1982 of `metric.py`. 

The documentation fails to build: the command

```
./sage -docbuild reference/manifolds html
```

returns errors like

```
docstring of sage.manifolds.differentiable.metric.PseudoRiemannianMetricParal.index:7: 
WARNING: Bullet list ends without a blank line; unexpected unindent.
```




---

archive/issue_comments_355239.json:
```json
{
    "body": "Another point: you should fill the *Description* field of this ticket, to tell what it is about.",
    "created_at": "2018-06-12T13:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355239",
    "user": "@egourgoulhon"
}
```

Another point: you should fill the *Description* field of this ticket, to tell what it is about.



---

archive/issue_comments_355240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-15T17:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355240",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355241.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-15T17:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355241",
    "user": "Dicolevrai"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_355242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-18T19:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355242",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355243.json:
```json
{
    "body": "I've pushed to the ticket branch a commit with small tweaks, which\n- correct errors in the documentation building\n- correct the doctest failure mentioned in comment:12 (trigonometric simplification)\n- apply some coding style along the recommended [PEP 8 conventions](https://www.python.org/dev/peps/pep-0008/), in particular: *\"The preferred way of wrapping long lines is by using Python's implied line continuation inside parentheses, brackets and braces. Long lines can be broken over multiple lines by wrapping expressions in parentheses. These should be used in preference to using a backslash for line continuation.\"*\n\nTo see all my changes, click on [cae28a7](https://git.sagemath.org/sage.git/commit/?id=cae28a718d0cd7c9fe7b867855b84caaa6c83919) in comment:16.\n\nThere are still some points that must be discussed or fixed: \n\n- At the moment, if no metric components are provided at some metric declaration (i.e. if `comp` is `None`), this defaults to initializing the metric components to  `diag(1,1,...,1)`. It would be preferable to left the components uninitialized instead, especially if the default chart is not of Cartesian type. I think we can make both behaviors (the previous one, with no components preinitialized, and the new one, with components set via the argument `comp=...`) coexist nicely\n- Since the argument `comp` is implemented only in `PseudoRiemannianMetricParal.__init__`, there is a difference of behavior between parallelizable manifolds and non-parallelizable ones; the argument `comp` has been added to `VectorFieldModule.metric` but is totally unused there. \n- Even on parallelizable manifolds, what if more than one chart is required to cover the manifold, like for instance **S**<sup>1</sup> or **S**<sup>3</sup> ?\n- The issue with the naming of the first argument of `_diag` mentioned in comment:12 is not addressed\n- The argument `comp` should be documented everywhere it has been added (e.g. in `VectorFieldFreeModule.metric`)",
    "created_at": "2018-06-18T19:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355243",
    "user": "@egourgoulhon"
}
```

I've pushed to the ticket branch a commit with small tweaks, which
- correct errors in the documentation building
- correct the doctest failure mentioned in comment:12 (trigonometric simplification)
- apply some coding style along the recommended [PEP 8 conventions](https://www.python.org/dev/peps/pep-0008/), in particular: *"The preferred way of wrapping long lines is by using Python's implied line continuation inside parentheses, brackets and braces. Long lines can be broken over multiple lines by wrapping expressions in parentheses. These should be used in preference to using a backslash for line continuation."*

To see all my changes, click on [cae28a7](https://git.sagemath.org/sage.git/commit/?id=cae28a718d0cd7c9fe7b867855b84caaa6c83919) in comment:16.

There are still some points that must be discussed or fixed: 

- At the moment, if no metric components are provided at some metric declaration (i.e. if `comp` is `None`), this defaults to initializing the metric components to  `diag(1,1,...,1)`. It would be preferable to left the components uninitialized instead, especially if the default chart is not of Cartesian type. I think we can make both behaviors (the previous one, with no components preinitialized, and the new one, with components set via the argument `comp=...`) coexist nicely
- Since the argument `comp` is implemented only in `PseudoRiemannianMetricParal.__init__`, there is a difference of behavior between parallelizable manifolds and non-parallelizable ones; the argument `comp` has been added to `VectorFieldModule.metric` but is totally unused there. 
- Even on parallelizable manifolds, what if more than one chart is required to cover the manifold, like for instance **S**<sup>1</sup> or **S**<sup>3</sup> ?
- The issue with the naming of the first argument of `_diag` mentioned in comment:12 is not addressed
- The argument `comp` should be documented everywhere it has been added (e.g. in `VectorFieldFreeModule.metric`)



---

archive/issue_comments_355244.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-18T19:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355244",
    "user": "@egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_355245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-27T17:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355245",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355246.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-27T17:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355246",
    "user": "Dicolevrai"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_355247.json:
```json
{
    "body": "Changing keywords from \"Parallelizable Manifold, Pseudo-Riemannian Metric, Degenerate Metric\" to \"Manifold, Pseudo-Riemannian Metric, Degenerate Metric\".",
    "created_at": "2018-06-27T17:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355247",
    "user": "Dicolevrai"
}
```

Changing keywords from "Parallelizable Manifold, Pseudo-Riemannian Metric, Degenerate Metric" to "Manifold, Pseudo-Riemannian Metric, Degenerate Metric".



---

archive/issue_comments_355248.json:
```json
{
    "body": "There are various issues:\n- The doctest time of `metric.py` is too long: on my computer, running\n\n```\nsage -t --long src/sage/manifolds/differentiable/metric.py\n```\n\nyields a total CPU time of 144.2 s, while with Sage 8.3.rc0 (i.e. outside the ticket branch) it is only of 62.3 s. Such an increase of doctest time is not acceptable, especially for a new functionality, which in principle, does not require much computing.\nOne can see the culprits by running\n\n```\nsage -t --long --warn-long 5 src/sage/manifolds/differentiable/metric.py\n```\n\nwhich reports the doctests running for more than 5 s. They are the doctests involving a metric on the sphere, with the components given in 6 charts. Why do you choose such a lengthy example? It is also very long, and thus not pleasant to read, in the html documentation.\n\n- In line 726 of `levi_civita_connection.py`, you have changed the output of the doctest by replacing `Lorentzian metric` by `Riemannian metric` (so that the doctest is passed), but this not correct since the metric has been declared as Lorentzian a few lines above. Actually this reveals that the handling of metric signatures must be entirely rethinked after the introduction of your function for computing the signature (previously, there was only the concept of \"user declared signature\"). This is out of the scope of this ticket and I will open a new ticket for this.\n\n- The method `sign()` should return a tuple, and not a list, since the signature is intended to be immutable.\n\n- The documentation does not build, due to a spurious `u99` inserted in line 3216 of `src/sage/manifolds/differentiable/manifold.py`. On general grounds, please check that the documentation builds correctly, via\n\n```\nsage -docbuild reference/manifolds html\n```\n\nand that the html output is OK, before submitting a ticket for review.",
    "created_at": "2018-07-25T15:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355248",
    "user": "@egourgoulhon"
}
```

There are various issues:
- The doctest time of `metric.py` is too long: on my computer, running

```
sage -t --long src/sage/manifolds/differentiable/metric.py
```

yields a total CPU time of 144.2 s, while with Sage 8.3.rc0 (i.e. outside the ticket branch) it is only of 62.3 s. Such an increase of doctest time is not acceptable, especially for a new functionality, which in principle, does not require much computing.
One can see the culprits by running

```
sage -t --long --warn-long 5 src/sage/manifolds/differentiable/metric.py
```

which reports the doctests running for more than 5 s. They are the doctests involving a metric on the sphere, with the components given in 6 charts. Why do you choose such a lengthy example? It is also very long, and thus not pleasant to read, in the html documentation.

- In line 726 of `levi_civita_connection.py`, you have changed the output of the doctest by replacing `Lorentzian metric` by `Riemannian metric` (so that the doctest is passed), but this not correct since the metric has been declared as Lorentzian a few lines above. Actually this reveals that the handling of metric signatures must be entirely rethinked after the introduction of your function for computing the signature (previously, there was only the concept of "user declared signature"). This is out of the scope of this ticket and I will open a new ticket for this.

- The method `sign()` should return a tuple, and not a list, since the signature is intended to be immutable.

- The documentation does not build, due to a spurious `u99` inserted in line 3216 of `src/sage/manifolds/differentiable/manifold.py`. On general grounds, please check that the documentation builds correctly, via

```
sage -docbuild reference/manifolds html
```

and that the html output is OK, before submitting a ticket for review.



---

archive/issue_comments_355249.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-25T15:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25220#issuecomment-355249",
    "user": "@egourgoulhon"
}
```

Changing status from needs_review to needs_work.
