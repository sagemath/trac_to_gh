# Issue 33636: Refactor system package scripts

Issue created by migration from https://trac.sagemath.org/ticket/33873

Original creator: mkoeppe

Original creation time: 2022-05-20 02:31:22

CC:  dimpase




---

Comment by mkoeppe created at 2022-05-24 15:51:07

New commits:


---

Comment by mkoeppe created at 2022-05-24 16:08:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-07-06 23:03:27

how can one test that?


---

Comment by mkoeppe created at 2022-07-06 23:07:00

For example, on a Linux machine using `tox -e local-sudo-standard -- config.status`


---

Comment by mkoeppe created at 2022-07-06 23:10:48

#33819 also makes (limited) use of it


---

Comment by dimpase created at 2022-07-06 23:14:13

Replying to [comment:7 mkoeppe]:
> For example, on a Linux machine using `tox -e local-sudo-standard -- config.status`

how about something without `sudo`?


---

Comment by dimpase created at 2022-07-06 23:18:18

I tried `local-standard` instead, it worked.


---

Comment by dimpase created at 2022-07-06 23:18:18

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-07-06 23:18:57

Thanks!


---

Comment by mkoeppe created at 2022-07-06 23:22:11

Replying to [comment:10 dimpase]:
> I tried `local-standard` instead, it worked.

I think this does not actually invoke the package scripts at all, but you can do `tox -e local-root-standard` and wait for the error from not being root


---

Comment by dimpase created at 2022-07-07 12:13:06

why is `sudo/root` needed at all for these tests? Is it meant to allow a system-wide installation of (parts of) Sage?


---

Comment by dimpase created at 2022-07-07 12:15:28

Replying to [comment:12 mkoeppe]:
> Replying to [comment:10 dimpase]:
> > I tried `local-standard` instead, it worked.
> 
> I think this does not actually invoke the package scripts at all, but you can do `tox -e local-root-standard` and wait for the error from not being root

the error is coming very soon:

```
$ tox -e local-root-standard -- config.status
local-root-standard create: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/local-root-standard
local-root-standard run-test-pre: PYTHONHASHSEED='263570377'
local-root-standard run-test: commands[0] | bash -c 'if [ ! -d /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/local-root-standard/Library/Caches ]; then mkdir -p /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/Caches && mkdir -p /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/local-root-standard/Library && ln -sf /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/Caches /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/.tox/local-root-standard/Library/; fi'
local-root-standard run-test: commands[1] | bash -c 'case "" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command auto  update) ;; esac'
local-root-standard run-test: commands[2] | bash -c 'case "" in 1|y*|Y*);; *) export PATH="build/bin:$PATH" && eval $(sage-print-system-package-command auto  --yes --no-install-recommends --spkg install $(sage-package list --has-file=spkg-configure.m4 :standard:) _bootstrap    ) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ;; esac'
Error: This command has to be run with superuser privileges (under the root user on most systems).
ERROR: InvocationError for command /usr/local/bin/bash -c 'case "" in 1|y*|Y*);; *) export PATH="build/bin:$PATH" && eval $(sage-print-system-package-command auto  --yes --no-install-recommends --spkg install $(sage-package list --has-file=spkg-configure.m4 :standard:) _bootstrap    ) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ;; esac' (exited with code 1)
...
Error: This command has to be run with superuser privileges (under the root user on most systems).
```



---

Comment by mkoeppe created at 2022-07-07 16:51:37

Replying to [comment:13 dimpase]:
> why is `sudo/root` needed at all for these tests? Is it meant to allow a system-wide installation of (parts of) Sage?

These tox environments are primarily for use on containers to install system packages. It's not intended to be user-facing.

One use is in .github/workflows/ci-wsl.yml


---

Comment by vbraun created at 2022-07-09 22:33:30

Resolution: fixed
