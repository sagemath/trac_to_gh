# Issue 16643: even faster prime_powers

archive/issues_016643.json:
```json
{
    "body": "CC:  ncohen jdemeyer\n\nThe cythonization of `prime_powers` is much faster (around x4 in the timings). We also introduce the keyword `py_ints` as in `prime_range` in order to be able to use Python int instead of Sage integers.\n\nNote: I do not like the convention that the name are different `prime_powers` vs `prime_range`... why not using `primes` or `prime_power_range`?\n\nIssue created by migration from https://trac.sagemath.org/ticket/16880\n\n",
    "created_at": "2014-08-26T11:09:37Z",
    "labels": [
        "number theory",
        "major",
        "enhancement"
    ],
    "title": "even faster prime_powers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16643",
    "user": "vdelecroix"
}
```
CC:  ncohen jdemeyer

The cythonization of `prime_powers` is much faster (around x4 in the timings). We also introduce the keyword `py_ints` as in `prime_range` in order to be able to use Python int instead of Sage integers.

Note: I do not like the convention that the name are different `prime_powers` vs `prime_range`... why not using `primes` or `prime_power_range`?

Issue created by migration from https://trac.sagemath.org/ticket/16880





---

archive/issue_comments_219528.json:
```json
{
    "body": "+1 for \"primes\"",
    "created_at": "2014-08-26T11:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219528",
    "user": "ncohen"
}
```

+1 for "primes"



---

archive/issue_comments_219529.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-26T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219529",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_219530.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-08-26T12:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219530",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_219531.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-28T20:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219531",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219532.json:
```json
{
    "body": "Rebased on 6.4.beta2, no dependency anymore...\n\nVincent",
    "created_at": "2014-08-28T20:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219532",
    "user": "vdelecroix"
}
```

Rebased on 6.4.beta2, no dependency anymore...

Vincent



---

archive/issue_comments_219533.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-30T16:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219533",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219534.json:
```json
{
    "body": "And with timings\n\nusing `prime_powers` (EDIT: only for commit at a3195f7 and not at e3be1ce)\n\n```\nsage: timeit(\"prime_powers(1000)\", number=4000)\n4000 loops, best of 3: 86.7 \u00b5s per loop\nsage: timeit(\"prime_powers(5000)\", number=2000)\n2000 loops, best of 3: 314 \u00b5s per loop\n```\n\n\nusing `prime_power_range` instead\n\n```\nsage: timeit(\"prime_power_range(1000)\", number=4000)\n4000 loops, best of 3: 17.6 \u00b5s per loop\nsage:  timeit(\"prime_power_range(5000)\", number=2000)\n2000 loops, best of 3: 72.3 \u00b5s per loop\n```\n\n\nusing `prime_power_range` with `py_ints=True`\n\n```\nsage: timeit(\"prime_power_range(1000,py_ints=True)\", number=4000)\n4000 loops, best of 3: 14.6 \u00b5s per loop\nsage:  timeit(\"prime_power_range(5000,py_ints=True)\", number=2000)\n2000 loops, best of 3: 33.9 \u00b5s per loop\n```\n",
    "created_at": "2014-08-30T16:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219534",
    "user": "vdelecroix"
}
```

And with timings

using `prime_powers` (EDIT: only for commit at a3195f7 and not at e3be1ce)

```
sage: timeit("prime_powers(1000)", number=4000)
4000 loops, best of 3: 86.7 µs per loop
sage: timeit("prime_powers(5000)", number=2000)
2000 loops, best of 3: 314 µs per loop
```


using `prime_power_range` instead

```
sage: timeit("prime_power_range(1000)", number=4000)
4000 loops, best of 3: 17.6 µs per loop
sage:  timeit("prime_power_range(5000)", number=2000)
2000 loops, best of 3: 72.3 µs per loop
```


using `prime_power_range` with `py_ints=True`

```
sage: timeit("prime_power_range(1000,py_ints=True)", number=4000)
4000 loops, best of 3: 14.6 µs per loop
sage:  timeit("prime_power_range(5000,py_ints=True)", number=2000)
2000 loops, best of 3: 33.9 µs per loop
```




---

archive/issue_comments_219535.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-31T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219535",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219536.json:
```json
{
    "body": "It looks more natural to me to follow what `primes` and `prime_range` do... this is what I did in e3be1ce.\n\nVincent",
    "created_at": "2014-08-31T09:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219536",
    "user": "vdelecroix"
}
```

It looks more natural to me to follow what `primes` and `prime_range` do... this is what I did in e3be1ce.

Vincent



---

archive/issue_comments_219537.json:
```json
{
    "body": "Needs rebase.",
    "created_at": "2015-03-09T09:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219537",
    "user": "jdemeyer"
}
```

Needs rebase.



---

archive/issue_comments_219538.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-09T09:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219538",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_219539.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-03-21T17:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219539",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_219540.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-21T17:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219540",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_219541.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-21T18:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219541",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-25T10:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219542",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219543.json:
```json
{
    "body": "I split the other parts to different tickets: #18298 and #18299.",
    "created_at": "2015-04-25T11:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219543",
    "user": "vdelecroix"
}
```

I split the other parts to different tickets: #18298 and #18299.



---

archive/issue_comments_219544.json:
```json
{
    "body": "1. I don't know if `lesser or equal than` is proper English. How about `less than or equal to`?\n\n2. `PARI` instead of `Pari`.\n\n3. In `next_prime_power` and `previous_prime_power`, a small optimization is possible: you can replace\n\n```\nmpz_set(n.value, self.value)\nmpz_add_ui(n.value, n.value, 1)\n```\n\nby\n\n```\nmpz_add_ui(n.value, self.value, 1)\n```\n\n\nand in `next_prime_power`, replace\n\n```\nif mpz_cmp_ui(n.value, 2) < 0:\n    mpz_set_ui(n.value, 2)\n    return n\n```\n\nby\n\n```\nif mpz_cmp_ui(self.value, 2) < 0:\n    return smallInteger(2)\n```\n\n\n4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing\n\n```\nwhile mpz_cmp(m.value, n.value) == 1:\n```\n\nI would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.",
    "created_at": "2015-04-28T09:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219544",
    "user": "jdemeyer"
}
```

1. I don't know if `lesser or equal than` is proper English. How about `less than or equal to`?

2. `PARI` instead of `Pari`.

3. In `next_prime_power` and `previous_prime_power`, a small optimization is possible: you can replace

```
mpz_set(n.value, self.value)
mpz_add_ui(n.value, n.value, 1)
```

by

```
mpz_add_ui(n.value, self.value, 1)
```


and in `next_prime_power`, replace

```
if mpz_cmp_ui(n.value, 2) < 0:
    mpz_set_ui(n.value, 2)
    return n
```

by

```
if mpz_cmp_ui(self.value, 2) < 0:
    return smallInteger(2)
```


4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing

```
while mpz_cmp(m.value, n.value) == 1:
```

I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.



---

archive/issue_comments_219545.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-28T09:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219545",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_219546.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T10:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219546",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219547.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n \n> 4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing\n> {{{\n> while mpz_cmp(m.value, n.value) == 1:\n> }}}\n> I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.\n\nI used `mpz_tstbit` instead. Should be the fastest.\n\nPotential micro optimization that would need to use `mpn_*` functions\n- the call to `mpz_sizeinbase` can be replaced by `mpn_count_leading_zeros` and some arithmetic\n- we can avoid a useless bit shift in `mpz_tstbit` by only considering the `&` with the most significant limb. Moreover, the allocation of the limbs will not change inside the loop. So we can already use the good pointer to the concerned limb.\n\nI think this is too much for a naive algorithm...",
    "created_at": "2015-04-28T10:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219547",
    "user": "vdelecroix"
}
```

Replying to [comment:20 jdemeyer]:
 
> 4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing
> {{{
> while mpz_cmp(m.value, n.value) == 1:
> }}}
> I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.

I used `mpz_tstbit` instead. Should be the fastest.

Potential micro optimization that would need to use `mpn_*` functions
- the call to `mpz_sizeinbase` can be replaced by `mpn_count_leading_zeros` and some arithmetic
- we can avoid a useless bit shift in `mpz_tstbit` by only considering the `&` with the most significant limb. Moreover, the allocation of the limbs will not change inside the loop. So we can already use the good pointer to the concerned limb.

I think this is too much for a naive algorithm...



---

archive/issue_comments_219548.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-28T10:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219548",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_219549.json:
```json
{
    "body": "`skept` -> `skipped`\n\nThis should be moved *after* the comparison with 2 (and `self` should be compared with 2):\n\n```\ncdef Integer n = PY_NEW(Integer)\n```\n\n\nAnother simplification that I missed: you can skip the block\n\n```\n    if mpz_even_p(n.value):\n    if n.is_prime_power(proof=proof):\n    return n\n    mpz_add_ui(n.value, n.value, 1)\n```\n\nif you instead just add 2 if `self` was odd:\n\n```\nmpz_add_ui(n.value, self.value, 1 if mpz_even_p(self.value) else 2)\n```\n\n\nThen the `bit_index` should be based on the value of `self`, such that the check works correctly if `self` was `2^n - 1`.",
    "created_at": "2015-04-28T11:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219549",
    "user": "jdemeyer"
}
```

`skept` -> `skipped`

This should be moved *after* the comparison with 2 (and `self` should be compared with 2):

```
cdef Integer n = PY_NEW(Integer)
```


Another simplification that I missed: you can skip the block

```
    if mpz_even_p(n.value):
    if n.is_prime_power(proof=proof):
    return n
    mpz_add_ui(n.value, n.value, 1)
```

if you instead just add 2 if `self` was odd:

```
mpz_add_ui(n.value, self.value, 1 if mpz_even_p(self.value) else 2)
```


Then the `bit_index` should be based on the value of `self`, such that the check works correctly if `self` was `2^n - 1`.



---

archive/issue_comments_219550.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-28T11:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219550",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_219551.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T11:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219551",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219552.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-28T11:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219552",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_219553.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-28T15:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219553",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_219554.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-29T03:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219554",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_219555.json:
```json
{
    "body": "Some copy/paste accidents (could probably be corrected on the follow-ups):\n\n\n```\n+    def previous_prime(self, proof=None):\n+        r\"\"\"\n+        Returns the previous prime before self.\n+\n+        This method calls the PARI ``precprime`` function.\n+\n+        INPUT:\n+\n+        - ``proof`` - if ``True`` ensure that the returned value is the next\n+          prime power and if set to ``False`` uses probabilistic methods\n+          (i.e. the result is not guaranteed). By default it uses global\n+          configuration variables to determine which alternative to use (see\n+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).\n```\n\n\n```\n+    def previous_prime_power(self, proof=None):\n+        r\"\"\"\n+        Return the previous prime power before self.\n+\n+        INPUT:\n+\n+        - ``proof`` - if ``True`` ensure that the returned value is the next\n+          prime power and if set to ``False`` uses probabilistic methods\n+          (i.e. the result is not guaranteed). By default it uses global\n+          configuration variables to determine which alternative to use (see\n+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).\n```\n",
    "created_at": "2015-05-06T07:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219555",
    "user": "leif"
}
```

Some copy/paste accidents (could probably be corrected on the follow-ups):


```
+    def previous_prime(self, proof=None):
+        r"""
+        Returns the previous prime before self.
+
+        This method calls the PARI ``precprime`` function.
+
+        INPUT:
+
+        - ``proof`` - if ``True`` ensure that the returned value is the next
+          prime power and if set to ``False`` uses probabilistic methods
+          (i.e. the result is not guaranteed). By default it uses global
+          configuration variables to determine which alternative to use (see
+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).
```


```
+    def previous_prime_power(self, proof=None):
+        r"""
+        Return the previous prime power before self.
+
+        INPUT:
+
+        - ``proof`` - if ``True`` ensure that the returned value is the next
+          prime power and if set to ``False`` uses probabilistic methods
+          (i.e. the result is not guaranteed). By default it uses global
+          configuration variables to determine which alternative to use (see
+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).
```




---

archive/issue_comments_219556.json:
```json
{
    "body": "Replying to [comment:29 leif]:\n> Some copy/paste accidents (could probably be corrected on the follow-ups):\n\nHa right.",
    "created_at": "2015-05-06T07:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16643#issuecomment-219556",
    "user": "vdelecroix"
}
```

Replying to [comment:29 leif]:
> Some copy/paste accidents (could probably be corrected on the follow-ups):

Ha right.
