# Issue 24440: prefer numbers.Integral rather than six.integer_types

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2018-02-07 08:42:08

CC:  vklein

In many functions, integer type checking is done via `isinstance(x, integer_types)` where `integer_types` is sometimes `int` or obtained from the `six` library. This approach is ignoring custom integer types implemented in external libraries such as gmpy2. One solution would be to use `numbers.Integral` instead.

The example of the `factor` function in `sage.arith.misc`

```
sage: import gmpy2
sage: factor(gmpy2.mpz(4))
Traceback (most recent call last):
...
TypeError: unable to factor n
```



---

Comment by jdemeyer created at 2018-02-07 09:54:15

I think that we should avoid both `six.integer_types` and `numbers.Integral`. Use duck typing as much as possible.


---

Comment by vdelecroix created at 2018-02-07 09:55:14

Replying to [comment:1 jdemeyer]:
> I think that we should avoid both `six.integer_types` and `numbers.Integral`. Use duck typing as much as possible.

How would you do for `factor`?


---

Comment by jdemeyer created at 2018-02-07 10:12:38

See #24679 for `factor()`.


---

Comment by jdemeyer created at 2018-02-07 10:13:11

If you like my approach there, you can copy it for other functions.


---

Comment by vdelecroix created at 2018-02-08 07:54:50

New commits:


---

Comment by vklein created at 2018-05-01 20:58:32

Set assignee to vklein.


---

Comment by vklein created at 2018-05-14 15:53:47

New commits:


---

Comment by git created at 2018-05-17 14:18:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-17 14:23:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-17 14:29:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-05-17 14:35:23

Changing status from new to needs_review.


---

Comment by vklein created at 2018-05-18 07:56:29

Changing keywords from "" to "thursdaysbdx".


---

Comment by vdelecroix created at 2018-05-29 05:58:58

merge failure on beta3


---

Comment by vdelecroix created at 2018-05-29 05:58:58

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-05-29 06:07:10

There are trailing whitespaces that needs to be removed.

In doctests, a comment line must be followed by a linebreak. The following

```
TESTS with numpy and gmpy2 numbers::
    sage: from numpy import int8
```

shoud be changed to

```
Tests with numpy and gmpy2 numbers::

    sage: from numpy import int8
```


There is no need to write `TESTS` in upper case unless it corresponds to the section in the docstring.

You should get rid of `integer_types` in the whole file. This kind of conversion

```
    if isinstance(n, integer_types):
        n = ZZ(n)
```

is better and faster with

```
    n = py_scalar_to_element()
```

(Moreover the former is not working for gmpy2 elements)


---

Comment by vklein created at 2018-05-29 08:25:22

Replying to [comment:28 vdelecroix]:
> (Moreover the former is not working for gmpy2 elements)
The remaining functions works for other reasons. 
\\
For example `is_square` call gmpy2 native `is_square` function. 
But it's true that this solution may be incompatible with another future number type.


---

Comment by git created at 2018-05-29 15:04:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-05-29 15:05:53

Rebase on 8.3.beta3 and fix Trailing whitespace doctests issues.


---

Comment by git created at 2018-05-30 09:24:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-30 12:51:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-05-30 12:59:42

Usage of `six.integer_types` removed.


---

Comment by vklein created at 2018-05-30 12:59:42

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-05-30 14:06:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-06-01 08:31:17

I don't think that

```
     if not n:
         raise ValueError("n must be nonzero")
```

should remain at the begining of `divisors`. Something like `divisors([])` should raise a `TypeError` and not a `ValueError`.

The rest looks good.


---

Comment by git created at 2018-06-01 13:11:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-06-01 13:17:01

As i don't know a good way to check the valids/invalid types for `divisors` as a pre-condition, i just let `factor` function throw `TypeError` when needed.

I prefer to keep the message `TypeError: unable to factor []` rather than catch and reraise the Error (as the Error stack is quite simple to understand).


---

Comment by vdelecroix created at 2018-06-01 13:32:04

It is good this way.

If the patchbot has nothing bad to say about documentation and doctests I am ok with the ticket.


---

Comment by vdelecroix created at 2018-06-03 08:37:28

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-06-03 08:37:28

Needs rebase on beta3 and doctests need to be marked as optional

```
sage -t --long src/sage/arith/misc.py
**********************************************************************
File "src/sage/arith/misc.py", line 1020, in sage.arith.misc.primes
Failed example:
    from gmpy2 import mpz
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 572, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 982, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.arith.misc.primes[11]>", line 1, in <module>
        from gmpy2 import mpz
    ImportError: No module named gmpy2
**********************************************************************
```



---

Comment by git created at 2018-06-04 08:03:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-04 08:05:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-05 13:19:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-05 13:28:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-05 15:15:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by vdelecroix created at 2018-08-23 03:30:49

The sentence is confusing

```
    Tests with gmpy2 and numpy numbers::

        sage: from numpy import int8
        sage: dedekind_sum(int8(5), int8(7), algorithm='default')
        -1/14
        sage: from gmpy2 import mpz                             # optional - gmpy2
        sage: dedekind_sum(mpz(5), mpz(7), algorithm='default') # optional - gmpy2
        -1/14
```

You say `gmpy2 and numpy` but you test numpy first...


---

Comment by vklein created at 2018-08-23 07:34:11

I think i will find a way to fix that.


---

Comment by git created at 2018-08-23 08:43:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-23 14:45:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-08-24 07:07:53

- Add a test for multivariate polynomials
- Fix docstring to match test order (`gmpy2 and numpy` into `numpy and gmpy2`)


---

Comment by vklein created at 2018-08-24 07:07:53

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-08-24 11:55:44

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-08-24 11:55:44

Sadly, the patchbot does not merge the dependencies before testing...

Everything is ok (at least on my computer).


---

Comment by vbraun created at 2018-09-01 09:10:27

Resolution: fixed
