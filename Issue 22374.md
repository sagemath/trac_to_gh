# Issue 22374: Replace _sage_doc_ by a __doc__ descriptor

Issue created by migration from https://trac.sagemath.org/ticket/22611

Original creator: jdemeyer

Original creation time: 2017-03-15 20:20:27

CC:  hivert nthiery

The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.

This is easy for Python classes, but it might be problematic for `cdef class`es.


---

Comment by jdemeyer created at 2017-03-17 09:06:13

Changing keywords from "" to "days85".


---

Comment by jdemeyer created at 2017-03-17 21:46:32

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-17 21:46:32

New commits:


---

Comment by git created at 2017-03-17 23:08:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-03-18 06:35:14

There was an issue building the docs due to `src/sage/parallel/decorate.py`. I did not understand the problem but I fixed it anyway with

```diff
diff --git a/src/sage/parallel/decorate.py b/src/sage/parallel/decorate.py
index ebc06e2..3305724 100644
--- a/src/sage/parallel/decorate.py
+++ b/src/sage/parallel/decorate.py
@@ -284,8 +287,7 @@ for a in args[0]))
             sage: sage_getdoc(p(f))
             'Test docstring\n'
         """
-        from sage.misc.sageinspect import sage_getdoc
-        return sage_getdoc(self.func)
+        return self.func.__doc__
 
 
 def parallel(p_iter='fork', ncpus=None, **kwds):
```



---

Comment by vdelecroix created at 2017-03-18 09:46:45

In ticket description: `and I was various Cython bugs along the way`!?


---

Comment by git created at 2017-03-21 09:52:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-03-22 13:27:38

This is just a stupid comment, but I'm curious about the naming--why ``@`InstanceDoc` and not ``@`instance_doc`?  For whatever reason it's more common to name decorators with underscores instead of camel case (so much so that people will even go against the camel case convention for classes in cases where a decorator is implemented as a class).

Then again, maybe the existing naming nicely calls attention to the fact that this is intended as a class decorator.


---

Comment by embray created at 2017-03-22 13:36:27

What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?

I think at the very least there should be a clear error message that `_instancedoc_` must be defined (including on base classes that may not have a sensible `_instancedoc_`, in which case it might be good if the descriptor also handled `NotImplemented` errors).


---

Comment by embray created at 2017-03-22 13:48:54

LGTM otherwise. Clever way to abuse the Python internals a bit, though I can't see anything inherently wrong with it, since tp_doc is suppose to be able to be NULL.


---

Comment by jdemeyer created at 2017-03-22 15:11:20

Replying to [comment:12 embray]:
> LGTM otherwise. Clever way to abuse the Python internals a bit

Like I say on the ticket description, this is the only way to make it work for all classes. Any pure Python implementation wouldn't work for extension types.


---

Comment by jdemeyer created at 2017-03-22 15:12:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-22 15:12:52

Replying to [comment:11 embray]:
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?

Yes, `AttributeError` works the same way in Cython.


---

Comment by jdemeyer created at 2017-03-22 15:15:01

Replying to [comment:11 embray]:
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?
> 
> I think at the very least there should be a clear error message that `_instancedoc_` must be defined

You mean an error which is not just `AttributeError: 'foo' object has no attribute '_instancedoc_'`?


---

Comment by embray created at 2017-03-22 16:04:45

Right.  For example, in classes with the `ABCMeta` metaclass, if there are any unimplemented `abstractproperty` or `abstractmethod`, trying to instantiate the class results in:


```
TypeError: Can't instantiate abstract class A with abstract methods foo
```


This is a slightly different case of course, since it's an error that would occur at class definition time.  I was just using this as an example of a clearer error message.


---

Comment by git created at 2017-03-22 16:12:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-03-22 16:14:19

I replaced `InstanceDoc` with `instancedoc` (I didn't use `instance_doc` just because the method name `_instancedoc_` doesn't have an underscore either. And anyway, Python uses `staticmethod` and not `static_method`.)


---

Comment by embray created at 2017-03-22 16:21:56

I still don't think the `AttributeError` is very useful, especially considering that you're getting an exception from a builtin module and can't see in the traceback what's actually causing it.  Of course, if one is implementing a class using ``@`instancedoc` this should be expected, but it still might seem mysterious, I think, compared to a slightly customized message (it could still be an `AttributeError`, though `TypeError` is used more commonly for cases where an expected interface is not found--e.g. `len()` on an object with no `__len__`.).


---

Comment by git created at 2017-03-23 10:17:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-03-23 10:21:30

Here you go...


---

Comment by jdemeyer created at 2017-03-23 10:21:30

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-03-23 11:05:51

Great, I think that's a lot nicer!  Thanks for this--honestly this is so useful I think some form of this should be implemented in Python.  I might suggest that, actually, since I see the question of per-instance docstrings come up from time to time, with no good solution.  If some kind of `__instancedoc__` special method were built into Python it would obviate the need for the special descriptor or the decorator.


---

Comment by embray created at 2017-03-23 11:05:51

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-03-23 20:36:26

Thanks!


---

Comment by vbraun created at 2017-03-29 16:51:16

Resolution: fixed
