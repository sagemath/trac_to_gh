# Issue 24946: Bug in the associahedron object

Issue created by migration from https://trac.sagemath.org/ticket/25183

Original creator: jipilab

Original creation time: 2018-04-16 15:23:17

CC:  chapoton stumpc5 tscrim moritz jipilab @laisrast

Keywords: associahedron

The following lines currently occur:


```
sage: A = polytopes.associahedron(['A',3])
sage: face = A.faces(2)[3]
sage: face
<6,8,9,10>
sage: face.as_polyhedron()
/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:590: RichReprWarning: Exception in _rich_repr_ while displaying object: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'
  RichReprWarning,
<repr(<sage.combinat.root_system.associahedron.Associahedra_with_category.element_class at 0x7f48d0d7ad70>) failed: AttributeError: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'>
```



---

Comment by @kliem created at 2019-05-10 10:56:36

I think I took care of it in #27798.


---

Comment by @kliem created at 2019-05-16 13:12:33

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-05-16 13:12:33

This branch should fix the bug.

Feel free to change it, alter it, abonden it, etc.

Maybe there is a better way to obtain the correct parent, i.e. improve the following lines:


```
156             for typ1 in ancestors_of_associahedron:
157                 if typ1 in mro:
158                     return typ1(parent, Vrep, Hrep, **kwds)
```

----
New commits:


---

Comment by @kliem created at 2019-08-27 20:14:10

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-08-27 20:14:10

Once #27798 is done, I'm going to rebase it and solve the merge conflict. At the moment it seems pointless to me.


---

Comment by git created at 2019-08-29 14:35:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2019-08-29 14:39:09

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-08-29 14:39:31

I think I got things fixed now. Suggestions for better solutions are welcome.


---

Comment by jipilab created at 2019-11-12 23:55:08

That looks good to me. Might be good to have some feedback from Travis or Frédéric on the cartan side of things, if they are done properly.

I would put this to positive review since the error appears to be fixed.


---

Comment by tscrim created at 2019-11-14 10:41:54

I don't have any comments on the Cartan side as you are not really doing anything with them. However, I do have one comment about this code block:

```python
            for typ1 in ancestors_of_associahedron:
                if typ1 in mro:
                    return typ1(parent, Vrep, Hrep, **kwds)
```

My understanding is there is no subclass relations among the classes in `ancestors_of_associahedron`. So I think it is faster to make that a `set` object and test

```python
            for typ1 in mro:
                if typ1 in ancestors_of_associahedron:
                    return typ1(parent, Vrep, Hrep, **kwds)
```

as `set` containment check is much faster and these classes are likely to be higher in the MRO. It also has a side effect of making all of these classes run in the same time. For example, imagine if you are looking for a `Polyhedron_polymake`, that means it has to check the through the entire MRO 4 times (and a bit more to actually find it). So this could become really expensive if you create lots of (temporary) associahedra.


---

Comment by @kliem created at 2019-11-14 12:47:52

New commits:


---

Comment by @kliem created at 2019-11-14 12:49:40

Changed to order of iteration, such that it only runs once through mro now.


---

Comment by tscrim created at 2019-11-14 12:59:16

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-11-14 12:59:16

Thanks. LGTM.


---

Comment by vbraun created at 2019-11-16 20:15:54

Resolution: fixed
