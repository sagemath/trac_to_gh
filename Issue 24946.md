# Issue 24946: Bug in the associahedron object

archive/issues_024946.json:
```json
{
    "body": "CC:  @fchapoton stumpc5 @tscrim @mo271 @jplab @laisrast\n\nKeywords: associahedron\n\nThe following lines currently occur:\n\n\n```\nsage: A = polytopes.associahedron(['A',3])\nsage: face = A.faces(2)[3]\nsage: face\n<6,8,9,10>\nsage: face.as_polyhedron()\n/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:590: RichReprWarning: Exception in _rich_repr_ while displaying object: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'\n  RichReprWarning,\n<repr(<sage.combinat.root_system.associahedron.Associahedra_with_category.element_class at 0x7f48d0d7ad70>) failed: AttributeError: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'>\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25183\n\n",
    "created_at": "2018-04-16T15:23:17Z",
    "labels": [
        "geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Bug in the associahedron object",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24946",
    "user": "@jplab"
}
```
CC:  @fchapoton stumpc5 @tscrim @mo271 @jplab @laisrast

Keywords: associahedron

The following lines currently occur:


```
sage: A = polytopes.associahedron(['A',3])
sage: face = A.faces(2)[3]
sage: face
<6,8,9,10>
sage: face.as_polyhedron()
/home/jplabbe/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:590: RichReprWarning: Exception in _rich_repr_ while displaying object: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'
  RichReprWarning,
<repr(<sage.combinat.root_system.associahedron.Associahedra_with_category.element_class at 0x7f48d0d7ad70>) failed: AttributeError: 'Associahedra_with_category.element_class' object has no attribute '_cartan_type'>
```


Issue created by migration from https://trac.sagemath.org/ticket/25183





---

archive/issue_comments_351110.json:
```json
{
    "body": "I think I took care of it in #27798.",
    "created_at": "2019-05-10T10:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351110",
    "user": "@kliem"
}
```

I think I took care of it in #27798.



---

archive/issue_comments_351111.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-16T13:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351111",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351112.json:
```json
{
    "body": "This branch should fix the bug.\n\nFeel free to change it, alter it, abonden it, etc.\n\nMaybe there is a better way to obtain the correct parent, i.e. improve the following lines:\n\n\n```\n156             for typ1 in ancestors_of_associahedron:\n157                 if typ1 in mro:\n158                     return typ1(parent, Vrep, Hrep, **kwds)\n```\n\n----\nNew commits:",
    "created_at": "2019-05-16T13:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351112",
    "user": "@kliem"
}
```

This branch should fix the bug.

Feel free to change it, alter it, abonden it, etc.

Maybe there is a better way to obtain the correct parent, i.e. improve the following lines:


```
156             for typ1 in ancestors_of_associahedron:
157                 if typ1 in mro:
158                     return typ1(parent, Vrep, Hrep, **kwds)
```

----
New commits:



---

archive/issue_comments_351113.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-27T20:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351113",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_351114.json:
```json
{
    "body": "Once #27798 is done, I'm going to rebase it and solve the merge conflict. At the moment it seems pointless to me.",
    "created_at": "2019-08-27T20:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351114",
    "user": "@kliem"
}
```

Once #27798 is done, I'm going to rebase it and solve the merge conflict. At the moment it seems pointless to me.



---

archive/issue_comments_351115.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-29T14:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351115",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_351116.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-29T14:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351116",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351117.json:
```json
{
    "body": "I think I got things fixed now. Suggestions for better solutions are welcome.",
    "created_at": "2019-08-29T14:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351117",
    "user": "@kliem"
}
```

I think I got things fixed now. Suggestions for better solutions are welcome.



---

archive/issue_comments_351118.json:
```json
{
    "body": "That looks good to me. Might be good to have some feedback from Travis or Fr\u00e9d\u00e9ric on the cartan side of things, if they are done properly.\n\nI would put this to positive review since the error appears to be fixed.",
    "created_at": "2019-11-12T23:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351118",
    "user": "@jplab"
}
```

That looks good to me. Might be good to have some feedback from Travis or Frédéric on the cartan side of things, if they are done properly.

I would put this to positive review since the error appears to be fixed.



---

archive/issue_comments_351119.json:
```json
{
    "body": "I don't have any comments on the Cartan side as you are not really doing anything with them. However, I do have one comment about this code block:\n\n```python\n            for typ1 in ancestors_of_associahedron:\n                if typ1 in mro:\n                    return typ1(parent, Vrep, Hrep, **kwds)\n```\n\nMy understanding is there is no subclass relations among the classes in `ancestors_of_associahedron`. So I think it is faster to make that a `set` object and test\n\n```python\n            for typ1 in mro:\n                if typ1 in ancestors_of_associahedron:\n                    return typ1(parent, Vrep, Hrep, **kwds)\n```\n\nas `set` containment check is much faster and these classes are likely to be higher in the MRO. It also has a side effect of making all of these classes run in the same time. For example, imagine if you are looking for a `Polyhedron_polymake`, that means it has to check the through the entire MRO 4 times (and a bit more to actually find it). So this could become really expensive if you create lots of (temporary) associahedra.",
    "created_at": "2019-11-14T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351119",
    "user": "@tscrim"
}
```

I don't have any comments on the Cartan side as you are not really doing anything with them. However, I do have one comment about this code block:

```python
            for typ1 in ancestors_of_associahedron:
                if typ1 in mro:
                    return typ1(parent, Vrep, Hrep, **kwds)
```

My understanding is there is no subclass relations among the classes in `ancestors_of_associahedron`. So I think it is faster to make that a `set` object and test

```python
            for typ1 in mro:
                if typ1 in ancestors_of_associahedron:
                    return typ1(parent, Vrep, Hrep, **kwds)
```

as `set` containment check is much faster and these classes are likely to be higher in the MRO. It also has a side effect of making all of these classes run in the same time. For example, imagine if you are looking for a `Polyhedron_polymake`, that means it has to check the through the entire MRO 4 times (and a bit more to actually find it). So this could become really expensive if you create lots of (temporary) associahedra.



---

archive/issue_comments_351120.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-11-14T12:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351120",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_351121.json:
```json
{
    "body": "Changed to order of iteration, such that it only runs once through mro now.",
    "created_at": "2019-11-14T12:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351121",
    "user": "@kliem"
}
```

Changed to order of iteration, such that it only runs once through mro now.



---

archive/issue_comments_351122.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-14T12:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351122",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_351123.json:
```json
{
    "body": "Thanks. LGTM.",
    "created_at": "2019-11-14T12:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351123",
    "user": "@tscrim"
}
```

Thanks. LGTM.



---

archive/issue_comments_351124.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-16T20:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24946#issuecomment-351124",
    "user": "@vbraun"
}
```

Resolution: fixed
