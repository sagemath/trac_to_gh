# Issue 12842: lcm for SR rationals

archive/issues_012842.json:
```json
{
    "body": "Assignee: @aghitza\n\nKeywords: sd40.5\n\nAt the moment, we can do \n\n\n```\nsage: gcd(2/3, 4/5)\n2/15\nsage: lcm(2/3, 4/5)\n4\nsage: gcd(2/3, 4/5) * lcm(2/3, 4/5) == 2/3*4/5\nTrue\n```\n\n\nbut\n\n\n```\nsage: gcd(SR(2/3), SR(4/5))\n2/15\nsage: lcm(SR(2/3), SR(4/5))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/Users/mcneil/sagedev/sage-5.1.beta0/devel/sage-hack/sage/plot/<ipython console> in <module>()\n\n/Users/mcneil/sagedev/sage-5.1.beta0/local/lib/python2.7/site-packages/sage/rings/arith.pyc in lcm(a, b)\n   1646                 return ZZ(a).lcm(ZZ(b))\n   1647             except TypeError:\n-> 1648                 raise TypeError, \"unable to find lcm of %s and %s\"%(a,b)\n   1649         return LCM(b)\n   1650 \n\nTypeError: unable to find lcm of 2/3 and 4/5\n\n```\n\n\nWe can improve the symmetry just by trying QQ instead of ZZ, as discussed in the comments to #10771.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13014\n\n",
    "created_at": "2012-05-25T18:35:36Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.2",
    "title": "lcm for SR rationals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12842",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```
Assignee: @aghitza

Keywords: sd40.5

At the moment, we can do 


```
sage: gcd(2/3, 4/5)
2/15
sage: lcm(2/3, 4/5)
4
sage: gcd(2/3, 4/5) * lcm(2/3, 4/5) == 2/3*4/5
True
```


but


```
sage: gcd(SR(2/3), SR(4/5))
2/15
sage: lcm(SR(2/3), SR(4/5))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/Users/mcneil/sagedev/sage-5.1.beta0/devel/sage-hack/sage/plot/<ipython console> in <module>()

/Users/mcneil/sagedev/sage-5.1.beta0/local/lib/python2.7/site-packages/sage/rings/arith.pyc in lcm(a, b)
   1646                 return ZZ(a).lcm(ZZ(b))
   1647             except TypeError:
-> 1648                 raise TypeError, "unable to find lcm of %s and %s"%(a,b)
   1649         return LCM(b)
   1650 

TypeError: unable to find lcm of 2/3 and 4/5

```


We can improve the symmetry just by trying QQ instead of ZZ, as discussed in the comments to #10771.

Issue created by migration from https://trac.sagemath.org/ticket/13014





---

archive/issue_comments_154106.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2012-05-25T18:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154106",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing priority from major to minor.



---

archive/issue_comments_154107.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-25T18:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154107",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_154108.json:
```json
{
    "body": "Positive review, but line 35 of your patch has a weird \"ZZ\" at the beginning of the line. I'm actually a bit surprised it's not a syntax error.\n\nTake that out of your patch and change this to positive review. :)",
    "created_at": "2012-05-26T03:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154108",
    "user": "https://github.com/dandrake"
}
```

Positive review, but line 35 of your patch has a weird "ZZ" at the beginning of the line. I'm actually a bit surprised it's not a syntax error.

Take that out of your patch and change this to positive review. :)



---

archive/issue_comments_154109.json:
```json
{
    "body": "Not sure how that happened.  :)  Not a SyntaxError because ZZ is perfectly valid as a name and the hashes just indicate a comment.  Many's the time I've caused a bug because I've forgotten that simply naming something doesn't execute it..",
    "created_at": "2012-05-26T04:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154109",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Not sure how that happened.  :)  Not a SyntaxError because ZZ is perfectly valid as a name and the hashes just indicate a comment.  Many's the time I've caused a bug because I've forgotten that simply naming something doesn't execute it..



---

archive/issue_comments_154110.json:
```json
{
    "body": "Looks good.",
    "created_at": "2012-05-26T17:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154110",
    "user": "https://github.com/dandrake"
}
```

Looks good.



---

archive/issue_comments_154111.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-26T17:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154111",
    "user": "https://github.com/dandrake"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_154112.json:
```json
{
    "body": "Oops. This causes a couple minor doctest failures in `symbolic/expression.pyx`:\n\n```\nsage -t --long -force_lib \"devel/sage/sage/symbolic/expression.pyx\"\n#0: simplify_sum(expr='sum(q^k,k,0,inf))\n#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))\n**********************************************************************\nFile \"/home/drake/s/sage-5.1.beta0/devel/sage/sage/symbolic/expression.pyx\", line 2611:\n    sage: (Mod(2,7)*x^2 + Mod(2,7))^7\nExpected:\n    128*(x^2 + 1)^7\nGot:\n    (2*x^2 + 2)^7\n**********************************************************************\nFile \"/home/drake/s/sage-5.1.beta0/devel/sage/sage/symbolic/expression.pyx\", line 2618:\n    sage: gcd(t,t).parent()\nExpected:\n    Integer Ring\nGot:\n    Rational Field\n**********************************************************************\n```\n\nI'll look into these.",
    "created_at": "2012-05-28T02:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154112",
    "user": "https://github.com/dandrake"
}
```

Oops. This causes a couple minor doctest failures in `symbolic/expression.pyx`:

```
sage -t --long -force_lib "devel/sage/sage/symbolic/expression.pyx"
#0: simplify_sum(expr='sum(q^k,k,0,inf))
#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))
**********************************************************************
File "/home/drake/s/sage-5.1.beta0/devel/sage/sage/symbolic/expression.pyx", line 2611:
    sage: (Mod(2,7)*x^2 + Mod(2,7))^7
Expected:
    128*(x^2 + 1)^7
Got:
    (2*x^2 + 2)^7
**********************************************************************
File "/home/drake/s/sage-5.1.beta0/devel/sage/sage/symbolic/expression.pyx", line 2618:
    sage: gcd(t,t).parent()
Expected:
    Integer Ring
Got:
    Rational Field
**********************************************************************
```

I'll look into these.



---

archive/issue_comments_154113.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-05-28T02:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154113",
    "user": "https://github.com/dandrake"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_154114.json:
```json
{
    "body": "Okay, here's what's going on.  I'd be fine with simply changing the second doctest but the first one is actually a change in behaviour and so we should salvage it.  Before this patch, we had\n\n\n\n```\n\nsage: gcd(2 % 7, 2 % 7)\n2\nsage: parent(_)\nInteger Ring\n\n```\n\n\ni.e. we move out of Zmod(7) even though we don't need to.  See, e.g., the following sage-support thread (https://groups.google.com/forum/#!topic/sage-support/_LvmAECVeDg/discussion) for related issues.  \n\nI think the simplest thing to do to get QQ working without changing the original doctests would be to try ZZ first and if that succeeds don't try QQ.  (At the moment we leap right to QQ.)  After we fix the gcds in Zmod(n), the first doctest will need to change.  I'll submit a new patch.",
    "created_at": "2012-05-28T03:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154114",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Okay, here's what's going on.  I'd be fine with simply changing the second doctest but the first one is actually a change in behaviour and so we should salvage it.  Before this patch, we had



```

sage: gcd(2 % 7, 2 % 7)
2
sage: parent(_)
Integer Ring

```


i.e. we move out of Zmod(7) even though we don't need to.  See, e.g., the following sage-support thread (https://groups.google.com/forum/#!topic/sage-support/_LvmAECVeDg/discussion) for related issues.  

I think the simplest thing to do to get QQ working without changing the original doctests would be to try ZZ first and if that succeeds don't try QQ.  (At the moment we leap right to QQ.)  After we fix the gcds in Zmod(n), the first doctest will need to change.  I'll submit a new patch.



---

archive/issue_comments_154115.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-28T04:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154115",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154116.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-28T04:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154116",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154117.json:
```json
{
    "body": "REFEREE REPORT:\n\nSorry, but I have a few issues...\n\n* Doing this is a sort of gotcha mistake in Python:\n\n```\nraise TypeError(\"unable to find gcd of %s and %s\"%(a,b))\n```\n\nThe problem is that the error message may take a very, very long time to generate.  The error should just be `TypeError(\"unable to compute gcd\")`.  Similar remarks for lcm.\n\n* Give me an example in the docstring that illustrates every exception in your code actually getting raised.  If you can't, then maybe the code isn't needed.\n\n* The bool in all your tests is not needed since nothing is symbolic in the comparison. E.g., \n\n```\nsage: bool(gcd(2/5, 3/7) == gcd(SR(2/5), SR(3/7))) \n```\n\nshould be\n\n```\nsage: gcd(2/5, 3/7) == gcd(SR(2/5), SR(3/7))\n```\n",
    "created_at": "2012-05-28T04:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154117",
    "user": "https://github.com/williamstein"
}
```

REFEREE REPORT:

Sorry, but I have a few issues...

* Doing this is a sort of gotcha mistake in Python:

```
raise TypeError("unable to find gcd of %s and %s"%(a,b))
```

The problem is that the error message may take a very, very long time to generate.  The error should just be `TypeError("unable to compute gcd")`.  Similar remarks for lcm.

* Give me an example in the docstring that illustrates every exception in your code actually getting raised.  If you can't, then maybe the code isn't needed.

* The bool in all your tests is not needed since nothing is symbolic in the comparison. E.g., 

```
sage: bool(gcd(2/5, 3/7) == gcd(SR(2/5), SR(3/7))) 
```

should be

```
sage: gcd(2/5, 3/7) == gcd(SR(2/5), SR(3/7))
```




---

archive/issue_comments_154118.json:
```json
{
    "body": "(1) Sure, I can change those.  Those were pre-existing.\n\n(2) Will do-- you might be right it can't actually be tripped, because \n\n    a,b = cm.canonical_coercion(a,b)\n\nmight already fail.  I thought I had a case where it did; will see if I can find it.\n\n(3) I don't agree with your last comment.  Even before this patch, we have parent(gcd(SR(3), SR(6)) == SR, and so the bool is necessary.  Do you think the current behaviour should change and gcd(SR(3), SR(6)) should return something not in SR?",
    "created_at": "2012-05-28T04:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154118",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

(1) Sure, I can change those.  Those were pre-existing.

(2) Will do-- you might be right it can't actually be tripped, because 

    a,b = cm.canonical_coercion(a,b)

might already fail.  I thought I had a case where it did; will see if I can find it.

(3) I don't agree with your last comment.  Even before this patch, we have parent(gcd(SR(3), SR(6)) == SR, and so the bool is necessary.  Do you think the current behaviour should change and gcd(SR(3), SR(6)) should return something not in SR?



---

archive/issue_comments_154119.json:
```json
{
    "body": "Replying to [comment:10 dsm]:\n> (3) I don't agree with your last comment.  Even before this patch, we have parent(gcd(SR(3), SR(6)) == SR, and so the bool is necessary.  Do you think the current behaviour should change and gcd(SR(3), SR(6)) should return something not in SR?\n\nSorry, I was actually testing your code with lcm, and there the parent is **not** SR:\n\n```\nsage: parent(lcm(SR(2/5), SR(3/7)))\nRational Field\n```\n\nI thought your gcd would be the same.  It's bad that it isn't.     I think the answer should be in SR as you say, though.  So replace 3 by the error regarding the parent for lcm.",
    "created_at": "2012-05-28T04:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154119",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:10 dsm]:
> (3) I don't agree with your last comment.  Even before this patch, we have parent(gcd(SR(3), SR(6)) == SR, and so the bool is necessary.  Do you think the current behaviour should change and gcd(SR(3), SR(6)) should return something not in SR?

Sorry, I was actually testing your code with lcm, and there the parent is **not** SR:

```
sage: parent(lcm(SR(2/5), SR(3/7)))
Rational Field
```

I thought your gcd would be the same.  It's bad that it isn't.     I think the answer should be in SR as you say, though.  So replace 3 by the error regarding the parent for lcm.



---

archive/issue_comments_154120.json:
```json
{
    "body": "Ah.  That's due to the quirk that we have a .gcd defined in expression.pyx and not an .lcm, and so slightly different paths are taken.  Should be able to fix that without too much work.",
    "created_at": "2012-05-28T04:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154120",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Ah.  That's due to the quirk that we have a .gcd defined in expression.pyx and not an .lcm, and so slightly different paths are taken.  Should be able to fix that without too much work.



---

archive/issue_comments_154121.json:
```json
{
    "body": "*whew*  Well, that was fun. \n\nExpressions now have an .lcm method (defined as self * b / self.gcd(b)), with associated tests to make sure that the corner cases I could think of work, mostly involving zeroes.  The error messages are now less informative (but less likely to crash if they accidentally receive some object with a really long str), which necessitated changes elsewhere where the old error message was being doctested.  That the error messages are actually produced is tested locally as well.\n\nlcm and gcd of symbolic objects now stay in SR.\n\nWe still need to fix gcd taking objects out of Zmod(n) but that can wait for another ticket.",
    "created_at": "2012-05-28T08:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154121",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

*whew*  Well, that was fun. 

Expressions now have an .lcm method (defined as self * b / self.gcd(b)), with associated tests to make sure that the corner cases I could think of work, mostly involving zeroes.  The error messages are now less informative (but less likely to crash if they accidentally receive some object with a really long str), which necessitated changes elsewhere where the old error message was being doctested.  That the error messages are actually produced is tested locally as well.

lcm and gcd of symbolic objects now stay in SR.

We still need to fix gcd taking objects out of Zmod(n) but that can wait for another ticket.



---

archive/issue_comments_154122.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-28T08:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154122",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154123.json:
```json
{
    "body": "looks great to me!",
    "created_at": "2012-05-28T08:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154123",
    "user": "https://github.com/williamstein"
}
```

looks great to me!



---

archive/issue_comments_154124.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-28T08:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154124",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_154125.json:
```json
{
    "body": "Morning delta, typo in the tests:\n\n\n```\n\n< +    Verify that objects without gcd methods but which can't be \n---\n> +    Verify that objects without lcm methods but which can't be \n\n```\n\n\nChanged v4 in place.",
    "created_at": "2012-05-28T15:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154125",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Morning delta, typo in the tests:


```

< +    Verify that objects without gcd methods but which can't be 
---
> +    Verify that objects without lcm methods but which can't be 

```


Changed v4 in place.



---

archive/issue_comments_154126.json:
```json
{
    "body": "Attachment [trac_13014_try_QQ_lcm_v4.patch](tarball://root/attachments/some-uuid/ticket13014/trac_13014_try_QQ_lcm_v4.patch) by dsm created at 2012-05-28 15:16:44\n\ntry QQ *after* trying ZZ, now with more lcm",
    "created_at": "2012-05-28T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154126",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Attachment [trac_13014_try_QQ_lcm_v4.patch](tarball://root/attachments/some-uuid/ticket13014/trac_13014_try_QQ_lcm_v4.patch) by dsm created at 2012-05-28 15:16:44

try QQ *after* trying ZZ, now with more lcm



---

archive/issue_comments_154127.json:
```json
{
    "body": "Changing component from basic arithmetic to symbolics.",
    "created_at": "2012-06-11T19:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154127",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from basic arithmetic to symbolics.



---

archive/issue_comments_154128.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2012-06-18T13:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154128",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_events_012802.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-07-02T15:23:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12842#event-12802"
}
```



---

archive/issue_comments_154129.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-02T15:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154129",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_154130.json:
```json
{
    "body": "This caused a massive slowdown for the command\n\n```\nsage: time p = polar_plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color=\"red\", plot_points=1000)\n```\n\nfrom 9 to 23 seconds. See [https://groups.google.com/forum/?fromgroups#!topic/sage-devel/EzFPIG6EFMI](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/EzFPIG6EFMI)",
    "created_at": "2013-01-07T12:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154130",
    "user": "https://github.com/jdemeyer"
}
```

This caused a massive slowdown for the command

```
sage: time p = polar_plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color="red", plot_points=1000)
```

from 9 to 23 seconds. See [https://groups.google.com/forum/?fromgroups#!topic/sage-devel/EzFPIG6EFMI](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/EzFPIG6EFMI)



---

archive/issue_comments_154131.json:
```json
{
    "body": "Urf, that's no good at all.  I'll have a look tonight if no one else gets to it.  Since this wasn't supported before, then maybe (1) some code was implicitly expecting a `TypeError` and now isn't getting one, or (2) something still gets a `TypeError` but the expense of trying to convert it to QQ as well as ZZ is too high. :-/",
    "created_at": "2013-01-07T12:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154131",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Urf, that's no good at all.  I'll have a look tonight if no one else gets to it.  Since this wasn't supported before, then maybe (1) some code was implicitly expecting a `TypeError` and now isn't getting one, or (2) something still gets a `TypeError` but the expense of trying to convert it to QQ as well as ZZ is too high. :-/



---

archive/issue_comments_154132.json:
```json
{
    "body": "It's clear that this either needs to fixed or that this patch will need to be reverted.",
    "created_at": "2013-01-07T19:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154132",
    "user": "https://github.com/jdemeyer"
}
```

It's clear that this either needs to fixed or that this patch will need to be reverted.



---

archive/issue_comments_154133.json:
```json
{
    "body": "I think it should probably come out entirely.  What seems to be going on is that gcd is getting called during evaluation on a lot of floats, e.g.\n\n\n```\n\nsage: f = lambda t: 1/(t+pi)\nsage: f(1.5r)               \nGCDing 1 <type 'int'> 1 0 <type 'int'> 0\nreturning on ZZ 1\nGCDing 1.5 <type 'float'> 1.5 1.0 <type 'float'> 1.0\nreturning on QQ 1/2\nGCDing 3.0 <type 'float'> 3.0 2.0 <type 'float'> 2.0\nreturning on ZZ 1\n```\n\n\nPreviously, only integers would be tried, and they would typically (though not always!)  fail.  Floats, however, can be coerced to QQ.. and so they are.  Sage is implicitly relying on the fact that gcd will fail, and fail quickly, for floats.  I can recover the original runtimes by adding more explicit typechecks but that isn't very robust.\n\nFar and away the simplest thing is to revert it, more's the pity.  On the bright side I probably exercise this code more than anyone else and even I don't use it very much.",
    "created_at": "2013-01-07T20:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154133",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

I think it should probably come out entirely.  What seems to be going on is that gcd is getting called during evaluation on a lot of floats, e.g.


```

sage: f = lambda t: 1/(t+pi)
sage: f(1.5r)               
GCDing 1 <type 'int'> 1 0 <type 'int'> 0
returning on ZZ 1
GCDing 1.5 <type 'float'> 1.5 1.0 <type 'float'> 1.0
returning on QQ 1/2
GCDing 3.0 <type 'float'> 3.0 2.0 <type 'float'> 2.0
returning on ZZ 1
```


Previously, only integers would be tried, and they would typically (though not always!)  fail.  Floats, however, can be coerced to QQ.. and so they are.  Sage is implicitly relying on the fact that gcd will fail, and fail quickly, for floats.  I can recover the original runtimes by adding more explicit typechecks but that isn't very robust.

Far and away the simplest thing is to revert it, more's the pity.  On the bright side I probably exercise this code more than anyone else and even I don't use it very much.



---

archive/issue_comments_154134.json:
```json
{
    "body": "OK, see #13926.",
    "created_at": "2013-01-08T08:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12842#issuecomment-154134",
    "user": "https://github.com/jdemeyer"
}
```

OK, see #13926.
