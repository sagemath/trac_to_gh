# Issue 33352: Gitpod: track remote trac branch

Issue created by migration from https://trac.sagemath.org/ticket/33589

Original creator: @tobiasdiez

Original creation time: 2022-03-29 13:59:54

CC:  mkoeppe

Currently, gitpod tracks the branch on github as the remote. Thus, one might accidentally changes to github instead of trac. With this ticket, the remote is changed to trac. 


---

Comment by @tobiasdiez created at 2022-03-29 13:59:59

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-29 19:00:20

I think `git remote set-url --push origin git`@`trac.sagemath.org:sage.git` would also be good to add


---

Comment by @tobiasdiez created at 2022-03-29 19:18:39

Not sure if that's really a good idea. The git manual contains

>Note that the push URL and the fetch URL, even though they can be set differently, must still refer to the same place. What you pushed to the push URL should be what you would see if you immediately fetched from the fetch URL. If you are trying to fetch from one place (e.g. your upstream) and push to another (e.g. your publishing repository), use two separate remotes.


Your idea was to prevent accidental commits to github, right? Would it be possible to restrict write access for the trac mirror repo to only allow the sync-hook to have write access?


---

Comment by mkoeppe created at 2022-03-29 19:21:35

It's already documented as standard procedure in `src/doc/en/developer/manual_git.rst`


---

Comment by @tobiasdiez created at 2022-03-29 19:24:21

Where exactly? I can only find `git remote set-url --push trac git`@`trac.sagemath.org:sage.git` at https://doc.sagemath.org/html/en/developer/manual_git.html


---

Comment by mkoeppe created at 2022-03-31 15:24:08

Yes, that's the one.


---

Comment by @tobiasdiez created at 2022-03-31 15:25:56

This is already included in the gitpod config:

```
      git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)
      git remote set-url --push trac git@trac.sagemath.org:sage.git
      git fetch trac
      git branch -u trac/$(git branch --show-current)
```



---

Comment by mkoeppe created at 2022-03-31 15:32:54

No, the first line is setting the wrong URL for fetching.


---

Comment by @tobiasdiez created at 2022-03-31 15:37:00

I took this from the docs: https://doc.sagemath.org/html/en/developer/manual_git.html#the-trac-server

```
git remote add trac git@trac.sagemath.org:sage.git -t master
```

What is then the correct url?


---

Comment by mkoeppe created at 2022-03-31 15:50:28

Further up in the same section.


---

Comment by @tobiasdiez created at 2022-03-31 15:56:14


```
git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master
```

Does not work well. If you then push something to trac, VS still notifies you that there are changes between your local and remote branch. The reason is that VS invokes `git fetch` directly after pushing, but then the sync hook has not yet been executed so it still fetches the old branch on github.


---

Comment by mkoeppe created at 2022-03-31 15:59:11

OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.


---

Comment by mkoeppe created at 2022-03-31 16:00:18

We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.


---

Comment by @tobiasdiez created at 2022-03-31 16:01:28

Replying to [comment:12 mkoeppe]:
> OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.

The point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.


---

Comment by @tobiasdiez created at 2022-03-31 16:02:04

Replying to [comment:13 mkoeppe]:
> We should probably also note this in the documentation (https://doc.sagemath.org/html/en/developer/manual_git.html) that the first configuration is not recommended for users who use VS Code.

What's the reason for this config in the first place? It is also against the git recommendations that I've cited above.


---

Comment by mkoeppe created at 2022-03-31 16:04:32

Replying to [comment:15 gh-tobiasdiez]:
> What's the reason for this config in the first place? It is also against the git recommendations that I've cited above.

That's what read-only mirrors are for - they scale better than 1 read/write server.

I don't think that recommendation that you found in the doc is intended to rule out mirrors.


---

Comment by mkoeppe created at 2022-03-31 16:08:53

Replying to [comment:14 gh-tobiasdiez]:
> Replying to [comment:12 mkoeppe]:
> > OK. Then I'd suggest that we make switching to the ssh remote (`git`@`trac.sagemath.org:sage.git`) part of the instructions for adding the SSH key.
> 
> The point of this ticket was that this happens automatically for each ticket/gitpod session without manual intervention.

I think we shouldn't force users to do the SSH key thing if all they want to do is fetch from trac.


---

Comment by mkoeppe created at 2022-03-31 16:21:16

Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?
By the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too


---

Comment by git created at 2022-03-31 16:33:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-31 16:33:29

Replying to [comment:18 mkoeppe]:
> Maybe it should be made conditional on `PRIVATE_SSH_KEY` being set already?
> By the way, the current script in `.gitpod.yml` creates an empty id_rsa file if `PRIVATE_SSH_KEY` is not provided; creating that should probably be avoided too

Good suggestion, thanks. I've implemented that now.


---

Comment by mkoeppe created at 2022-03-31 16:34:30

That should be "-n "${PRIVATE_SSH_KEY}"`


---

Comment by @tobiasdiez created at 2022-03-31 16:36:03

Yes...


---

Comment by mkoeppe created at 2022-03-31 16:36:45

And everyone needs the `trac` remote. 
When `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.


---

Comment by git created at 2022-03-31 16:40:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-31 16:41:36

Replying to [comment:23 mkoeppe]:
> And everyone needs the `trac` remote. 
> When `PRIVATE_SSH_KEY` is set, just switch the fetch URL to the good one.

But this is `origin` already, so where is the point of adding trac as the same alias?


---

Comment by mkoeppe created at 2022-03-31 16:43:18

`trac` is the name used in the developer's guide; and it is also the hardcoded name of the remote that is used in git-trac-command.


---

Comment by git created at 2022-03-31 16:44:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-31 16:47:07


```
+      else
+        # Fallback to sagemath mirror
+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop
+      fi
+
```

but only for fetch, not for push!


---

Comment by git created at 2022-03-31 16:57:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-31 17:24:18

This line should probably be run in both cases

```
+        git remote set-url --push origin pushing-only-via-trac
```



---

Comment by mkoeppe created at 2022-03-31 17:24:54

Also comment:12, comment:13


---

Comment by git created at 2022-03-31 17:50:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-31 17:51:00

Replying to [comment:30 mkoeppe]:
> This line should probably be run in both cases
> {{{
> +        git remote set-url --push origin pushing-only-via-trac
> }}}

Done.


---

Comment by @tobiasdiez created at 2022-03-31 17:51:27

Replying to [comment:31 mkoeppe]:
> Also comment:12, comment:13

I think comment:12 is obsolete now (or I misunderstand it), and comment:13 is not in the scope of this ticket.


---

Comment by mkoeppe created at 2022-03-31 17:53:14

comment:12 - when the user sets up the key the first time (https://620901c077fb7caa9f914f33--sagemath-tobias.netlify.app/developer/workspace.html#section-gitpod), the user needs to change the remote - this needs to be added to the instructions


---

Comment by mkoeppe created at 2022-03-31 17:54:30


```
+        git remote remove trac # might still exists from a previous run/prebuild
```

does this not give an error if the remote is not there?


---

Comment by @tobiasdiez created at 2022-03-31 18:00:25

Replying to [comment:36 mkoeppe]:
> {{{
> +        git remote remove trac # might still exists from a previous run/prebuild
> }}}
> does this not give an error if the remote is not there?

Yes, it prints an error (during the prebuild) but the script keeps executing.


---

Comment by mkoeppe created at 2022-03-31 18:06:31

You can silence it by appending `2> /dev/null`


---

Comment by git created at 2022-03-31 18:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-31 18:22:36

I've added comment:13 to #33088


---

Comment by mkoeppe created at 2022-03-31 18:24:18


```
+ 4. Close this Gitpod workspace.
```

OK, that's a good solution too


---

Comment by mkoeppe created at 2022-03-31 20:27:07

I think all of these steps:

```
+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
```

and

```
+        git remote set-url --push trac git@trac.sagemath.org:sage.git
+        git fetch trac
+        git branch -u trac/$(git branch --show-current)
```

should be unconditional


---

Comment by @tobiasdiez created at 2022-03-31 21:35:17

Replying to [comment:42 mkoeppe]:
> I think all of these steps:
> {{{
> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
> }}}

During the prebuild there is never a ssh key set, so the trac remote is always either unset or set to the github mirror.

> and
> {{{
> +        git remote set-url --push trac git`@`trac.sagemath.org:sage.git
> +        git fetch trac
> +        git branch -u trac/$(git branch --show-current)
> }}}
> should be unconditional

Fetching trac doesn't work without ssh keys (at least for me).


---

Comment by mkoeppe created at 2022-03-31 22:41:01

Replying to [comment:43 gh-tobiasdiez]:
> Fetching trac doesn't work without ssh keys (at least for me).

It doesn't if the remote is ssh, which is why we have changed that.


---

Comment by @tobiasdiez created at 2022-03-31 23:30:42

I don't get what you want.

```
+        git remote set-url --push trac git@trac.sagemath.org:sage.git
```

is in conflict with

```
+        git remote set-url --push trac pushing-needs-ssh-key
```

Since the ssh setup is more involved for gitpod, its better in my opinion to explicitly tell the user that something is off so he might look this up in the docs.

Ps: can we please migrate to github/gitlab; their server are beefy enough to don't need a special mirror setup ;-)


---

Comment by mkoeppe created at 2022-03-31 23:46:48

I mean like this (untested).

```
diff --git a/.gitpod.yml b/.gitpod.yml
index 7c6800ab8f..8244bafae9 100644
--- a/.gitpod.yml
+++ b/.gitpod.yml
@@ -36,7 +36,9 @@ image:
 tasks:
   - name: Setup
     before: |
+      git remote set-url --push origin pushing-only-via-trac
       # Setup trac as remote
+      git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
       ## In order to push to trac, generate a new key with `ssh-keygen -f tempkey` and save the private key to gitpod `gp env PRIVATE_SSH_KEY="$(<tempkey)"` (or by following https://www.gitpod.io/docs/environment-variables#using-the-account-settings)
       ## then follow https://doc.sagemath.org/html/en/developer/trac.html#linking-your-public-key-to-your-trac-account to register the public key with trac.
       ## Afterwards, create a new gitpod workspace.
@@ -50,18 +52,15 @@ tasks:
         ssh-keyscan -H trac.sagemath.org >> ~/.ssh/known_hosts
 
         # Setup trac repo
-        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
         git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)
         git remote set-url --push trac git@trac.sagemath.org:sage.git
-        git fetch trac
-        git branch -u trac/$(git branch --show-current)
-        git remote set-url --push origin pushing-only-via-trac
       else
         # Fallback to sagemath mirror
-        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop
+        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop -t $(git branch --show-current)
         git remote set-url --push trac pushing-needs-ssh-key
-        git remote set-url --push origin pushing-only-via-trac
       fi
+      git fetch trac
+      git branch -u trac/$(git branch --show-current)
       
       ## No need for pyenv
       pyenv shell --unset 2> /dev/null
```



---

Comment by @tobiasdiez created at 2022-04-01 00:02:00

That would work, I guess. But I fail to see the point of setting the upstream to "trac" even if you don't have the ssh keys configured. Why change the gitpod default? 

I would like to leave the whole trac remote business as minimal as possible.


---

Comment by mkoeppe created at 2022-04-01 00:09:26

Replying to [comment:47 gh-tobiasdiez]:
> That would work, I guess. But I fail to see the point of setting the upstream to "trac" even if you don't have the ssh keys configured. 

Because it means that there are fewer differences between "without ssh key" and "with ssh key", which reduces the complexity in explaining it to developers?


---

Comment by @tobiasdiez created at 2022-04-01 00:14:16

If you cannot push anything, then you don't need to worry about trac at all. Everything you need is in "origin". The remove trac is only added because of the limitations of git-trac you mentioned above.


---

Comment by mkoeppe created at 2022-04-01 00:16:29

OK, I think this makes sense


---

Comment by mkoeppe created at 2022-04-01 00:17:54

Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the "else" branch only when `origin` is in the `sagemath` organization.


---

Comment by mkoeppe created at 2022-04-01 00:20:03

And I'd still prefer to move the line

```
+        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
```

to the very beginning so that it runs in both cases - it's easier to understand that it is correct


---

Comment by @tobiasdiez created at 2022-04-01 00:31:35

Replying to [comment:51 mkoeppe]:
> Now if we also want to support a development model in which users use their own [GitHub](GitHub) forks as `origin`, then we should probably do the line `git remote set-url --push origin pushing-only-via-trac` in the "else" branch only when `origin` is in the `sagemath` organization.

Do you know how/with which credentials the sync hook pushes to the github mirror? Maybe its easy to setup a branch protection rule that would prevent any pushes to the mirror (except for the syncs).


---

Comment by mkoeppe created at 2022-04-01 05:04:29

No idea, sorry


---

Comment by git created at 2022-04-01 14:40:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-01 14:47:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-01 14:55:07

According to 

```
curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/networks/sagemath/sagetrac-mirror/events?per_page=100 | ConvertFrom-Json | where { $_.type -eq "PushEvent" } | Select actor
```

it is always `sageb0t`. I've now added a branch protection rule, see https://groups.google.com/g/sage-devel/c/Z1rx_uP7LtY. Thus the special handling of origin is no longer needed.


---

Comment by @tobiasdiez created at 2022-04-01 14:55:15

Replying to [comment:52 mkoeppe]:
> And I'd still prefer to move the line
> {{{
> +        git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
> }}}
> to the very beginning so that it runs in both cases - it's easier to understand that it is correct

I agree.


---

Comment by git created at 2022-04-01 14:57:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-01 15:50:36

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-04-01 16:03:05

Thanks for the review and the many helpful suggestions!


---

Comment by vbraun created at 2022-04-03 11:13:40

Resolution: fixed
