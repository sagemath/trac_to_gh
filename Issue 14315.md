# Issue 14315: Cythonize ElementWrapper and make parent the first argument

archive/issues_014315.json:
```json
{
    "body": "Assignee: @tscrim\n\nCC:  sage-combinat @nthiery simonking\n\nKeywords: cython ElementWrapper\n\nFor speed and consistency.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14519\n\n",
    "created_at": "2013-05-02T22:25:15Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Cythonize ElementWrapper and make parent the first argument",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14315",
    "user": "https://github.com/tscrim"
}
```
Assignee: @tscrim

CC:  sage-combinat @nthiery simonking

Keywords: cython ElementWrapper

For speed and consistency.

Issue created by migration from https://trac.sagemath.org/ticket/14519





---

archive/issue_comments_180469.json:
```json
{
    "body": "Initial version which has a dependencies on #14143 (minor reject) and #14516 (since `Letter` no longer inherits from `ElementWrapper`, there is nothing to do there). Both of which this can be moved past with minor-moderate cost.",
    "created_at": "2013-05-03T19:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180469",
    "user": "https://github.com/tscrim"
}
```

Initial version which has a dependencies on #14143 (minor reject) and #14516 (since `Letter` no longer inherits from `ElementWrapper`, there is nothing to do there). Both of which this can be moved past with minor-moderate cost.



---

archive/issue_comments_180470.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-03T19:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180470",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_180471.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-05-09T23:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180471",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_180472.json:
```json
{
    "body": "The UCF segfault was due to it inheriting from both `FieldElement` and `ElementWrapper`. In particular, the `_add_()` / `_mul_()` / etc. functions of the UCF elements were not being called when `ElementWrapper` is an extension class. It also segfaults when I have it inherit from `CombinatorialFreeModuleElement`, which is what it wraps. I'll see if I can reduce it down to a simple test case and post it on another ticket and sage-devel since I don't know if this is a python, cython, or sage bug...\n\nAlso #11931 can be closed as a duplicate.",
    "created_at": "2013-06-27T15:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180472",
    "user": "https://github.com/tscrim"
}
```

The UCF segfault was due to it inheriting from both `FieldElement` and `ElementWrapper`. In particular, the `_add_()` / `_mul_()` / etc. functions of the UCF elements were not being called when `ElementWrapper` is an extension class. It also segfaults when I have it inherit from `CombinatorialFreeModuleElement`, which is what it wraps. I'll see if I can reduce it down to a simple test case and post it on another ticket and sage-devel since I don't know if this is a python, cython, or sage bug...

Also #11931 can be closed as a duplicate.



---

archive/issue_comments_180473.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-06-27T15:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180473",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_180474.json:
```json
{
    "body": "Note that I did experience a very subtle Cython problem: When one constructs a Python class that simultaneously inherits from `RingElement` and `Morphism`, then the two bases seem to have a compatible layout, however two *different* cpdef attributes of the two bases get confused. Perhaps this is similar here?\n\nSorry, I am too lazy to look up the ticket number or the discussion on the cython-user mailing list.",
    "created_at": "2013-06-27T16:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180474",
    "user": "https://github.com/simon-king-jena"
}
```

Note that I did experience a very subtle Cython problem: When one constructs a Python class that simultaneously inherits from `RingElement` and `Morphism`, then the two bases seem to have a compatible layout, however two *different* cpdef attributes of the two bases get confused. Perhaps this is similar here?

Sorry, I am too lazy to look up the ticket number or the discussion on the cython-user mailing list.



---

archive/issue_comments_180475.json:
```json
{
    "body": "This is likely the same issue; luckily I could work (hack) around it here.",
    "created_at": "2013-06-28T15:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180475",
    "user": "https://github.com/tscrim"
}
```

This is likely the same issue; luckily I could work (hack) around it here.



---

archive/issue_comments_180476.json:
```json
{
    "body": "Hi Travis,\n\nI am finally looking at the patch now. Thanks for your work on this!\n\nSome points:\n\n- In those places where the patch touches a \"...\" continuation, use the occasion to make it a \"....:\"\n- Line 312 of the coercion tutorial: missing space before D (it was missing already)\n- In all the calls to MyElement: proper spacing between arguments\n- universal_cyclotomic_field.py: \n  - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.\n  - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).\n  - Check the spacing between the arguments in the call to element_class\n- disjoint_union_enumerated_sets.py: why did the type of ``el`` change?\n- The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.\n\nLet me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.",
    "created_at": "2013-07-02T14:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180476",
    "user": "https://github.com/nthiery"
}
```

Hi Travis,

I am finally looking at the patch now. Thanks for your work on this!

Some points:

- In those places where the patch touches a "..." continuation, use the occasion to make it a "....:"
- Line 312 of the coercion tutorial: missing space before D (it was missing already)
- In all the calls to MyElement: proper spacing between arguments
- universal_cyclotomic_field.py: 
  - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.
  - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).
  - Check the spacing between the arguments in the call to element_class
- disjoint_union_enumerated_sets.py: why did the type of ``el`` change?
- The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.

Let me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.



---

archive/issue_comments_180477.json:
```json
{
    "body": "Hey Nicolas,\n\nThank you for reviewing the patch.\n\nReplying to [comment:6 nthiery]:\n> Some points:\n> \n> - In those places where the patch touches a \"...\" continuation, use the occasion to make it a \"....:\"\n> - Line 312 of the coercion tutorial: missing space before D (it was missing already)\n> - In all the calls to MyElement: proper spacing between arguments\n> - universal_cyclotomic_field.py: \n>   - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.\n>   - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).\n\n\nDone.\n\n>   - Check the spacing between the arguments in the call to element_class\n\n\nI think done; if not I'll need something more specific.\n\n> - disjoint_union_enumerated_sets.py: why did the type of ``el`` change?\n\n\nBecause it because an extension class.\n\n> - The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.\n\n\nDone.\n\n> Let me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.\n\n\nThe updated patch fixes almost everything except 1 doctest in `misc/nested_class_test.py` (as opposed to 2 previously) and I'm not quite sure what the problem is currently. I don't think I need a `__reduce__()` in the element wrapper since it has a `__dict__` (and my `__reduce__()` was causing pickling to fail). If you have any insight into this, I'd appreciate it.\n\nThanks,\n\nTravis",
    "created_at": "2013-07-04T06:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180477",
    "user": "https://github.com/tscrim"
}
```

Hey Nicolas,

Thank you for reviewing the patch.

Replying to [comment:6 nthiery]:
> Some points:
> 
> - In those places where the patch touches a "..." continuation, use the occasion to make it a "....:"
> - Line 312 of the coercion tutorial: missing space before D (it was missing already)
> - In all the calls to MyElement: proper spacing between arguments
> - universal_cyclotomic_field.py: 
>   - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.
>   - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).


Done.

>   - Check the spacing between the arguments in the call to element_class


I think done; if not I'll need something more specific.

> - disjoint_union_enumerated_sets.py: why did the type of ``el`` change?


Because it because an extension class.

> - The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.


Done.

> Let me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.


The updated patch fixes almost everything except 1 doctest in `misc/nested_class_test.py` (as opposed to 2 previously) and I'm not quite sure what the problem is currently. I don't think I need a `__reduce__()` in the element wrapper since it has a `__dict__` (and my `__reduce__()` was causing pickling to fail). If you have any insight into this, I'd appreciate it.

Thanks,

Travis



---

archive/issue_comments_180478.json:
```json
{
    "body": "Attachment [trac_14519-cynthonize_element_wrapper-ts.patch](tarball://root/attachments/some-uuid/ticket14519/trac_14519-cynthonize_element_wrapper-ts.patch) by @tscrim created at 2013-07-09 12:22:02",
    "created_at": "2013-07-09T12:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180478",
    "user": "https://github.com/tscrim"
}
```

Attachment [trac_14519-cynthonize_element_wrapper-ts.patch](tarball://root/attachments/some-uuid/ticket14519/trac_14519-cynthonize_element_wrapper-ts.patch) by @tscrim created at 2013-07-09 12:22:02



---

archive/issue_comments_180479.json:
```json
{
    "body": "Okay, I figured out what was going wrong. For the nested class, `TestParent4` did not implement a `__ne__` and is not a `UniqueRepresentation`, so it does not by default check `not __eq__`. In the `ElementWrapper`, I'm testing using `__ne__`.\n\nFor the posets, the problem was that `ElementWrapper` was checking if the second argument was a `Parent` class, rather than if the first argument is not a `Parent`. Thus wrapping a `Set`, which is a `Parent`, caused the deprecation warning and a swap to occur.\n\nThe rest of the errors were trivial in the sense I needed to put a parent as the first argument. In summary: err0rz b3 pwnd.\n\nBest,\n\nTravis",
    "created_at": "2013-07-09T12:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180479",
    "user": "https://github.com/tscrim"
}
```

Okay, I figured out what was going wrong. For the nested class, `TestParent4` did not implement a `__ne__` and is not a `UniqueRepresentation`, so it does not by default check `not __eq__`. In the `ElementWrapper`, I'm testing using `__ne__`.

For the posets, the problem was that `ElementWrapper` was checking if the second argument was a `Parent` class, rather than if the first argument is not a `Parent`. Thus wrapping a `Set`, which is a `Parent`, caused the deprecation warning and a swap to occur.

The rest of the errors were trivial in the sense I needed to put a parent as the first argument. In summary: err0rz b3 pwnd.

Best,

Travis



---

archive/issue_comments_180480.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-13T12:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180480",
    "user": "https://github.com/nthiery"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_180481.json:
```json
{
    "body": "Thanks for doing the review Nicolas.",
    "created_at": "2013-07-13T12:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180481",
    "user": "https://github.com/tscrim"
}
```

Thanks for doing the review Nicolas.



---

archive/issue_events_041319.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-21T21:29:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41319"
}
```



---

archive/issue_events_041320.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:26:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41320"
}
```



---

archive/issue_events_041321.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:26:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41321"
}
```



---

archive/issue_events_041322.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-08-06T00:38:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41322"
}
```



---

archive/issue_events_041323.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-08-06T00:38:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41323"
}
```



---

archive/issue_events_041324.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:18:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14315#event-41324"
}
```



---

archive/issue_comments_180482.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-16T21:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14315#issuecomment-180482",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
