# Issue 14315: Cythonize ElementWrapper and make parent the first argument

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2013-05-02 22:25:15

Assignee: tscrim

CC:  sage-combinat nthiery simonking

Keywords: cython ElementWrapper

For speed and consistency.


---

Comment by tscrim created at 2013-05-03 19:50:25

Initial version which has a dependencies on #14143 (minor reject) and #14516 (since `Letter` no longer inherits from `ElementWrapper`, there is nothing to do there). Both of which this can be moved past with minor-moderate cost.


---

Comment by tscrim created at 2013-05-03 19:50:25

Changing status from new to needs_review.


---

Comment by tscrim created at 2013-05-09 23:45:55

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2013-06-27 15:44:37

The UCF segfault was due to it inheriting from both `FieldElement` and `ElementWrapper`. In particular, the `_add_()` / `_mul_()` / etc. functions of the UCF elements were not being called when `ElementWrapper` is an extension class. It also segfaults when I have it inherit from `CombinatorialFreeModuleElement`, which is what it wraps. I'll see if I can reduce it down to a simple test case and post it on another ticket and sage-devel since I don't know if this is a python, cython, or sage bug...

Also #11931 can be closed as a duplicate.


---

Comment by tscrim created at 2013-06-27 15:44:37

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2013-06-27 16:00:52

Note that I did experience a very subtle Cython problem: When one constructs a Python class that simultaneously inherits from `RingElement` and `Morphism`, then the two bases seem to have a compatible layout, however two _different_ cpdef attributes of the two bases get confused. Perhaps this is similar here?

Sorry, I am too lazy to look up the ticket number or the discussion on the cython-user mailing list.


---

Comment by tscrim created at 2013-06-28 15:05:50

This is likely the same issue; luckily I could work (hack) around it here.


---

Comment by nthiery created at 2013-07-02 14:33:27

Hi Travis,

I am finally looking at the patch now. Thanks for your work on this!

Some points:

- In those places where the patch touches a "..." continuation, use the occasion to make it a "....:"
- Line 312 of the coercion tutorial: missing space before D (it was missing already)
- In all the calls to MyElement: proper spacing between arguments
- universal_cyclotomic_field.py: 
  - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.
  - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).
  - Check the spacing between the arguments in the call to element_class
- disjoint_union_enumerated_sets.py: why did the type of ``el`` change?
- The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.

Let me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.


---

Comment by tscrim created at 2013-07-04 06:23:04

Hey Nicolas,

Thank you for reviewing the patch.

Replying to [comment:6 nthiery]:
> Some points:
> 
> - In those places where the patch touches a "..." continuation, use the occasion to make it a "....:"
> - Line 312 of the coercion tutorial: missing space before D (it was missing already)
> - In all the calls to MyElement: proper spacing between arguments
> - universal_cyclotomic_field.py: 
>   - Unless unavoidable, don't change the order of the imports, and keep CombinatorialFreeModule imported in the __init__ instead of in the module.
>   - Mention in the code that UCFElement can't multiple inherit from the two extension types FieldElement and ElementWrapper, which is why at this point the methods _latex_ and friends have to be duplicated (in the long run we can hope not to need anymore to inherit from FieldElement).

Done.

>   - Check the spacing between the arguments in the call to element_class

I think done; if not I'll need something more specific.

> - disjoint_union_enumerated_sets.py: why did the type of ``el`` change?

Because it because an extension class.

> - The __nonzero__ feature is new, right? I'd rather avoid it at this point, since the semantic of being zero might differ quite some depending on the use case.

Done.

> Let me know when you will have posted an updated patch fixing those as well as the failing tests detected by the patchbot.

The updated patch fixes almost everything except 1 doctest in `misc/nested_class_test.py` (as opposed to 2 previously) and I'm not quite sure what the problem is currently. I don't think I need a `__reduce__()` in the element wrapper since it has a `__dict__` (and my `__reduce__()` was causing pickling to fail). If you have any insight into this, I'd appreciate it.

Thanks,

Travis


---

Attachment


---

Comment by tscrim created at 2013-07-09 12:30:10

Okay, I figured out what was going wrong. For the nested class, `TestParent4` did not implement a `__ne__` and is not a `UniqueRepresentation`, so it does not by default check `not __eq__`. In the `ElementWrapper`, I'm testing using `__ne__`.

For the posets, the problem was that `ElementWrapper` was checking if the second argument was a `Parent` class, rather than if the first argument is not a `Parent`. Thus wrapping a `Set`, which is a `Parent`, caused the deprecation warning and a swap to occur.

The rest of the errors were trivial in the sense I needed to put a parent as the first argument. In summary: err0rz b3 pwnd.

Best,

Travis


---

Comment by nthiery created at 2013-07-13 12:05:41

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2013-07-13 12:23:55

Thanks for doing the review Nicolas.


---

Comment by jdemeyer created at 2013-08-16 21:18:51

Resolution: fixed
