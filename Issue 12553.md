# Issue 12553: termcap: copy libtermcap.a to libncurses.a

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-03-22 09:45:57

Assignee: tbd

CC:  jpflori

The install scripts for PARI and Python automatically link with `-lncurses` if `/usr/lib/libncurses.so` *exists*, even though the mere existence of that file doesn't guarantee that it actually can be linked.  This can happen in particular when "cross-compiling" a 32-bit Sage on a 64-bit operating system.

The build of the readline interface of PARI and Python might therefore fail for no good reason.  A solution is to copy Sage's `libtermcap.a` to `libncurses.a`, such that `-lncurses` will always succeed.


---

Comment by tdickey created at 2012-03-23 14:30:38

The usual way to address the problem is to install the corresponding
development package (for ncurses).  Overwriting the shared library
will break various programs that are linked against the existing
library.


---

Comment by jdemeyer created at 2012-03-23 14:48:31

Replying to [comment:3 tdickey]:
> Overwriting the shared library
> will break various programs that are linked against the existing
> library.
I'm only talking about the _static_ library archive (`libncurses.a`).  This cannot break existing programs.


---

Comment by tdickey created at 2012-03-24 00:30:01

But that would break builds of other applications which used the static library.
Also, applications using the bundled termcap library would behave differently
from those which use the ncurses library (unless Sage happened to update its
termcap source file - last I recalled it was more than ten years out of date).


---

Comment by jdemeyer created at 2012-03-24 09:17:09

Okay, a new proposal: we try to link a test program with `-lncurses` and only if that fails, we do the copying.


---

Comment by tdickey created at 2012-03-24 11:40:52

That's an improvement, but if the copy happened to be put in a different location
than the ncurses development package, it would still be a problem.


---

Comment by jdemeyer created at 2012-03-24 15:56:58

Replying to [comment:7 tdickey]:
> That's an improvement, but if the copy happened to be put in a different location
> than the ncurses development package, it would still be a problem.
??? Please explain what you mean.  The copy would be put in `$SAGE_ROOT/local/lib`.


---

Comment by tdickey created at 2012-03-24 15:58:56

I see - at the end of the patch.  The discussion above did not make that clear.


---

Comment by jdemeyer created at 2012-03-28 09:15:12

Diff for the termcap spkg, for review only


---

Attachment

The new spkg is more clever: it only makes the symbolic link for `libncurses.a` if linking against `-lncurses` doesn't work.

Needs review.


---

Comment by jdemeyer created at 2012-03-28 09:16:09

Changing priority from major to minor.


---

Comment by jdemeyer created at 2012-03-28 09:16:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-03-31 20:47:52

`@`tdickey: could you review this spkg please?


---

Comment by leif created at 2012-05-25 10:52:43

We should get rid of the termcap spkg anyway, really.

Besides that, the errors mentioned in the description should certainly get fixed (or at least reported) upstream.


---

Comment by jdemeyer created at 2012-06-25 12:00:51

Replying to [comment:12 leif]:
> Besides that, the errors mentioned in the description should certainly get fixed (or at least reported) upstream.
I don't think upstream still exists, actually.


---

Comment by tdickey created at 2012-06-25 21:01:34

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 leif]:
> > Besides that, the errors mentioned in the description should certainly get fixed (or at least reported) upstream.
> I don't think upstream still exists, actually.
Which upstream are you referring to?


---

Comment by tdickey created at 2012-06-25 21:03:03

Replying to [comment:11 jdemeyer]:
> `@`tdickey: could you review this spkg please?
Generically ok (given the explanation that it would only be used in a build-tree, not updating the system area).

However, 1.3.1.p3 is dated, and its termcap.src file is a nuisance due to the large number of differences versus ncurses.  I've noticed that Redhat's equivalent package for termcap uses the termcap.src file which I generate from ncurses.  See http://invisible-island.net/datafiles/current/termcap.src.gz for comparison.


---

Comment by jdemeyer created at 2012-06-26 06:40:09

Replying to [comment:17 tdickey]:
> Replying to [comment:11 jdemeyer]:
> > `@`tdickey: could you review this spkg please?
> Generically ok (given the explanation that it would only be used in a build-tree, not updating the system area).
> 
> However, 1.3.1.p3 is dated, and its termcap.src file is a nuisance due to the large number of differences versus ncurses.
Perhaps, but that's not the subject of this ticket.


---

Comment by jpflori created at 2013-01-29 22:28:11

Wouldn't a proper solution be to fix Pyton rather than hacking around?


---

Comment by jdemeyer created at 2013-01-29 22:33:19

Replying to [comment:19 jpflori]:
> Wouldn't a proper solution be to fix Pyton rather than hacking around?
Sure, but that's not a realistic solution I'm afraid.  It would require some redesign of the Python build system.


---

Comment by vbraun created at 2013-01-30 15:21:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-30 15:21:37

ugly workaround, but then it should never happen on a sensible install...


---

Comment by jdemeyer created at 2013-02-05 08:18:06

Resolution: fixed


---

Comment by vbraun created at 2013-04-03 11:36:40

This breaks readline in Python, see #14405 for details.
