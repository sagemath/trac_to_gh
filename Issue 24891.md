# Issue 24891: Have py_scalar_to_element convert gmpy2 numbers

Issue created by migration from Trac.

Original creator: vklein

Original creation time: 2018-04-09 14:44:31

CC:  vdelecroix

Keywords: gmpy2

Currently `py_scalar_to_element` function (`coerce.pyx`) didn't convert `gmpy2 numbers`.
`py_scalar_to_element` should work with `gmpy2` the same way it work with `numpy`.


---

Comment by vklein created at 2018-04-09 14:44:45

Set assignee to vklein.


---

Comment by vklein created at 2018-04-10 09:40:19

Changing status from new to needs_review.


---

Comment by vklein created at 2018-04-10 09:40:19

New commits:


---

Comment by vdelecroix created at 2018-04-10 12:06:49

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-04-10 12:06:49

You have C functions for type checking: `MPZ_Check`, `MPQ_Check`, `MPFR_Check` and `MPC_Check`.


---

Comment by vdelecroix created at 2018-04-10 12:07:18

(this is the kind of things that are of course not optimized by Cython)


---

Comment by git created at 2018-04-10 12:36:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-04-10 12:38:09

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2018-04-10 12:39:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-10 12:42:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-04-10 12:43:36

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-04-13 08:02:07

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-04-13 08:02:07

There needs to be a linebreak after `::`

```
+    Test gmpy2's types::
+        sage: import gmpy2                               # optional - gmpy2 
```



---

Comment by git created at 2018-04-13 08:47:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-04-13 08:47:45

Fix missing linebreak.


---

Comment by vklein created at 2018-04-13 08:47:45

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-04-13 08:49:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-04-18 08:58:26

Why `MPZ_Check(x)` instead of `type(x) is gmpy2.mpz`? There is nothing really wrong with `MPZ_Check` but all other places in Sage use the `type` check. For example in `src/sage/rings/complex_double.pyx`:

```
if HAVE_GMPY2 and type(x) is gmpy2.mpc:
```

If you use only type checks, you can also remove the `import_gmpy2`.


---

Comment by jdemeyer created at 2018-04-18 09:08:18

I just benchmarked it and `MPZ_Check()` is slightly slower than the `type()` check. This is probably because the `import_gmpy2` machinery gives a slight overhead compared to the direct import that Cython does.


---

Comment by vklein created at 2018-04-18 14:04:06

Changing status from positive_review to needs_work.


---

Comment by vklein created at 2018-04-18 14:04:06

Ok i will reverse to `type()` check then. I see no reason to keep `MPZ_Check()` if it's not faster.


---

Comment by git created at 2018-04-18 14:53:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-04-18 14:55:08

Changing status from needs_work to positive_review.


---

Comment by vklein created at 2018-04-18 14:55:08

previous commits squashed.


---

Comment by vklein created at 2018-04-18 14:55:29

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2018-04-18 16:00:03

Fine for me but I leave the final review to Vincent Delecroix.


---

Comment by vdelecroix created at 2018-04-18 16:30:30

Sure it's fine.


---

Comment by vdelecroix created at 2018-04-18 16:30:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-12 11:46:06

Resolution: fixed
