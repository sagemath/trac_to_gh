# Issue 17413: alarm broken on cygwin

archive/issues_017413.json:
```json
{
    "body": "CC:  @vbraun jpflori\n\nOn cygwin64, the alarm mechanism is broken:\n\n```\nsage: alarm(0.1); sum(xrange(100000000))\n4999999950000000\n```\n\ninstead of the expected interrupt.\n\nThis seems to be a subtle cygwin and/or ppl bug: the included header ppl.hh contains lines akin to\n\n```\nclass Parma_Polyhedra_Library::Init {\npublic:\n  Init();\n  ~Init();\n  ...\n}\nstatic Parma_Polyhedra_Library::Init Parma_Polyhedra_Library_initializer;\n```\n\n\nThe methods `Init()` and `~Init()` are never defined in the header, so there are undefined references in the ppl library. This confuses cython(?), breaking `alarm`.\n\nReplacing the above lines with\n\n```\n  Init() {};\n  ~Init() {};\n```\n\nsolves the alarm issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17650\n\n",
    "created_at": "2015-01-19T21:02:38Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "alarm broken on cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17413",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```
CC:  @vbraun jpflori

On cygwin64, the alarm mechanism is broken:

```
sage: alarm(0.1); sum(xrange(100000000))
4999999950000000
```

instead of the expected interrupt.

This seems to be a subtle cygwin and/or ppl bug: the included header ppl.hh contains lines akin to

```
class Parma_Polyhedra_Library::Init {
public:
  Init();
  ~Init();
  ...
}
static Parma_Polyhedra_Library::Init Parma_Polyhedra_Library_initializer;
```


The methods `Init()` and `~Init()` are never defined in the header, so there are undefined references in the ppl library. This confuses cython(?), breaking `alarm`.

Replacing the above lines with

```
  Init() {};
  ~Init() {};
```

solves the alarm issue.

Issue created by migration from https://trac.sagemath.org/ticket/17650





---

archive/issue_comments_232213.json:
```json
{
    "body": "Should it be considered as a PPL bug that the methods are not defined in the header? Or a cython bug that this suffices to break the interrupts mechanism? Or a cygwin bug since it does not seem to be a problem on other platforms?",
    "created_at": "2015-01-19T21:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232213",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Should it be considered as a PPL bug that the methods are not defined in the header? Or a cython bug that this suffices to break the interrupts mechanism? Or a cygwin bug since it does not seem to be a problem on other platforms?



---

archive/issue_comments_232214.json:
```json
{
    "body": "The PPL code seems to be correct, I am stuck on this one...",
    "created_at": "2015-01-20T10:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232214",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

The PPL code seems to be correct, I am stuck on this one...



---

archive/issue_comments_232215.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-01-25T13:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232215",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

New commits:



---

archive/issue_comments_232216.json:
```json
{
    "body": "Changing keywords from \"\" to \"ppl, cygwin\".",
    "created_at": "2015-01-25T13:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232216",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing keywords from "" to "ppl, cygwin".



---

archive/issue_comments_232217.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-25T13:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232217",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_232218.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-01-31T13:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232218",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_232219.json:
```json
{
    "body": "What I don't like about this ticket is that it's not clear that the \"ppl watchdog\" is not needed. What does it do and why does Sage not need it?",
    "created_at": "2015-01-31T13:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232219",
    "user": "https://github.com/jdemeyer"
}
```

What I don't like about this ticket is that it's not clear that the "ppl watchdog" is not needed. What does it do and why does Sage not need it?



---

archive/issue_comments_232220.json:
```json
{
    "body": "Excellent question. There is essentially no documentation on this ppl watchdog that I could find. It seems to be a classical watchdog mechanism, i.e., it detects if some computation loops forever, and in this case it interrupts it automatically and resets things to a nicer state. In particular, it should not play any role in non-buggy situations.\n\nIt is not necessary to PPL (since it is disabled on some platforms, those which don't have `setitimer`), and I do not see how it could be relevant to sage. So, my impression is that it is safe to disable it (note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms). On cygwin, with the patch, `sage -t all` does not show any ppl-related failure. By the way, without the patch, `sage -t all` hangs forever and eats all available memory, since some tests rely on `alarm` to be interrupted! So, in my opinion, the patch gives a definitive improvement on cygwin.",
    "created_at": "2015-01-31T16:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232220",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Excellent question. There is essentially no documentation on this ppl watchdog that I could find. It seems to be a classical watchdog mechanism, i.e., it detects if some computation loops forever, and in this case it interrupts it automatically and resets things to a nicer state. In particular, it should not play any role in non-buggy situations.

It is not necessary to PPL (since it is disabled on some platforms, those which don't have `setitimer`), and I do not see how it could be relevant to sage. So, my impression is that it is safe to disable it (note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms). On cygwin, with the patch, `sage -t all` does not show any ppl-related failure. By the way, without the patch, `sage -t all` hangs forever and eats all available memory, since some tests rely on `alarm` to be interrupted! So, in my opinion, the patch gives a definitive improvement on cygwin.



---

archive/issue_comments_232221.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-31T16:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232221",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_232222.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-31T16:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232222",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_232223.json:
```json
{
    "body": "Replying to [comment:9 gouezel]:\n> note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms\nFor me, that's actually a reason to be *against* this patch. Either we need it and we shouldn't disable it on Cygwin, or we don't need it and we can just disable it everywhere.",
    "created_at": "2015-01-31T16:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232223",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 gouezel]:
> note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms
For me, that's actually a reason to be *against* this patch. Either we need it and we shouldn't disable it on Cygwin, or we don't need it and we can just disable it everywhere.



---

archive/issue_comments_232224.json:
```json
{
    "body": "I get your point. Unfortunately, I can't say for sure that watchdog is not helpful to ppl in rare situations (for instance, maybe it uses some algorithms whose termination is not guaranteed, counting on watchdog to exit bad situations), so I would rather keep watchdog wherever possible (i.e., not on cygwin, where setitimer is not fully functional).\n\nI leave the ticket as `needs_work` until someone more knowledgeable on ppl steps up (or someone who really needs the patch on cygwin pushes for it)",
    "created_at": "2015-01-31T18:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232224",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

I get your point. Unfortunately, I can't say for sure that watchdog is not helpful to ppl in rare situations (for instance, maybe it uses some algorithms whose termination is not guaranteed, counting on watchdog to exit bad situations), so I would rather keep watchdog wherever possible (i.e., not on cygwin, where setitimer is not fully functional).

I leave the ticket as `needs_work` until someone more knowledgeable on ppl steps up (or someone who really needs the patch on cygwin pushes for it)



---

archive/issue_comments_232225.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-13T15:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232226.json:
```json
{
    "body": "I'm just posting random links potentially related:\n* http://www.cs.unipr.it/pipermail/ppl-devel/2008-October/013156.html\n\nAccording to http://trac.sagemath.org/ticket/10039#comment:49 there used to be a `--disable-watchdog` configure flag, too bad it disappeared.\n\nI guess we should open a bug on ppl bugtracker (if one exists).\n\nUnfortunately it seems cygwin does not ship ppl anymore, so we cannot look at what they would have done.\nIt could still be useful to post on the cygwin ml's.\n\n`@`sebastien: can you provide a minimal C file reproducing the issue?\nMaybe something inspired in the aforementioned 2008 post can help.",
    "created_at": "2015-09-02T08:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232226",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'm just posting random links potentially related:
* http://www.cs.unipr.it/pipermail/ppl-devel/2008-October/013156.html

According to http://trac.sagemath.org/ticket/10039#comment:49 there used to be a `--disable-watchdog` configure flag, too bad it disappeared.

I guess we should open a bug on ppl bugtracker (if one exists).

Unfortunately it seems cygwin does not ship ppl anymore, so we cannot look at what they would have done.
It could still be useful to post on the cygwin ml's.

`@`sebastien: can you provide a minimal C file reproducing the issue?
Maybe something inspired in the aforementioned 2008 post can help.



---

archive/issue_comments_232227.json:
```json
{
    "body": "The post does indeed look related. I don't understand why it was posted on PPL-devel, since it seems to have nothing to do with PPL really.\n\n> `@`sebastien: can you provide a minimal C file reproducing the issue?\nThat would be great, especially to send to the upstream bug trackers (PPL and/or Cygwin).",
    "created_at": "2015-09-02T09:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232227",
    "user": "https://github.com/jdemeyer"
}
```

The post does indeed look related. I don't understand why it was posted on PPL-devel, since it seems to have nothing to do with PPL really.

> `@`sebastien: can you provide a minimal C file reproducing the issue?
That would be great, especially to send to the upstream bug trackers (PPL and/or Cygwin).



---

archive/issue_comments_232228.json:
```json
{
    "body": "Replying to [comment:14 jpflori]:\n\n> `@`sebastien: can you provide a minimal C file reproducing the issue?\n> Maybe something inspired in the aforementioned 2008 post can help.\n\nI just tried, but unfortunately I was not able to reproduce the issue with plain C or C++ files (for instance, taking the file in the link you give and adding ppl headers and initialization does not break the itimer mechanism).\n\nFor the record, steps to reproduce the issue using python:\n\nFile `alarm.pyx`:\n\n```\nimport signal\n\ndef essai(n):\n  signal.setitimer(signal.ITIMER_REAL, 0.5 , 0)\n  return sum(xrange(n))\n```\n\n\nFile `alarme_c.cpp`\n\n```\n#include <ppl.hh>\n```\n\n\nFile `setup.py`\n\n```\nfrom distutils.core import setup\nfrom Cython.Build import cythonize\nfrom distutils.extension import Extension\n\nsetup(\n    ext_modules = cythonize(Extension(\"alarme\", ['alarme.pyx', 'alarme_c.cpp'], libraries = ['ppl']))\n)\n```\n\n\nFile `essai.py`\n\n```\nimport alarme\n\nprint alarme.essai(100000000)\n```\n\n\nCompile the extension with\n\n```\npython setup.py build_ext --inplace\n```\n\n\nThen `python essai.py` results in `4999999950000000`, no interruption.\n\nCommenting out the header inclusion in `alarme_c.cpp`, then one gets `Alarm clock` instead.",
    "created_at": "2015-10-11T20:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232228",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Replying to [comment:14 jpflori]:

> `@`sebastien: can you provide a minimal C file reproducing the issue?
> Maybe something inspired in the aforementioned 2008 post can help.

I just tried, but unfortunately I was not able to reproduce the issue with plain C or C++ files (for instance, taking the file in the link you give and adding ppl headers and initialization does not break the itimer mechanism).

For the record, steps to reproduce the issue using python:

File `alarm.pyx`:

```
import signal

def essai(n):
  signal.setitimer(signal.ITIMER_REAL, 0.5 , 0)
  return sum(xrange(n))
```


File `alarme_c.cpp`

```
#include <ppl.hh>
```


File `setup.py`

```
from distutils.core import setup
from Cython.Build import cythonize
from distutils.extension import Extension

setup(
    ext_modules = cythonize(Extension("alarme", ['alarme.pyx', 'alarme_c.cpp'], libraries = ['ppl']))
)
```


File `essai.py`

```
import alarme

print alarme.essai(100000000)
```


Compile the extension with

```
python setup.py build_ext --inplace
```


Then `python essai.py` results in `4999999950000000`, no interruption.

Commenting out the header inclusion in `alarme_c.cpp`, then one gets `Alarm clock` instead.



---

archive/issue_comments_232229.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2016-04-08T13:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232229",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_232230.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-04-14T10:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232230",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_232231.json:
```json
{
    "body": "duplicate of #21190",
    "created_at": "2017-04-14T10:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232231",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

duplicate of #21190



---

archive/issue_comments_232232.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232232",
    "user": "https://github.com/embray"
}
```

Resolution: wontfix



---

archive/issue_comments_232233.json:
```json
{
    "body": "Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17413#issuecomment-232233",
    "user": "https://github.com/embray"
}
```

Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).



---

archive/issue_events_016794.json:
```json
{
    "actor": "@embray",
    "created_at": "2017-07-13T07:54:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17413",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17413#event-16794"
}
```
