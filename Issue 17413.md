# Issue 17413: alarm broken on cygwin

Issue created by migration from https://trac.sagemath.org/ticket/17650

Original creator: gouezel

Original creation time: 2015-01-19 21:02:38

CC:  vbraun jpflori

On cygwin64, the alarm mechanism is broken:

```
sage: alarm(0.1); sum(xrange(100000000))
4999999950000000
```

instead of the expected interrupt.

This seems to be a subtle cygwin and/or ppl bug: the included header ppl.hh contains lines akin to

```
class Parma_Polyhedra_Library::Init {
public:
  Init();
  ~Init();
  ...
}
static Parma_Polyhedra_Library::Init Parma_Polyhedra_Library_initializer;
```


The methods `Init()` and `~Init()` are never defined in the header, so there are undefined references in the ppl library. This confuses cython(?), breaking `alarm`.

Replacing the above lines with

```
  Init() {};
  ~Init() {};
```

solves the alarm issue.


---

Comment by gouezel created at 2015-01-19 21:07:15

Should it be considered as a PPL bug that the methods are not defined in the header? Or a cython bug that this suffices to break the interrupts mechanism? Or a cygwin bug since it does not seem to be a problem on other platforms?


---

Comment by gouezel created at 2015-01-20 10:31:53

The PPL code seems to be correct, I am stuck on this one...


---

Comment by gouezel created at 2015-01-25 13:39:31

New commits:


---

Comment by gouezel created at 2015-01-25 13:39:31

Changing keywords from "" to "ppl, cygwin".


---

Comment by gouezel created at 2015-01-25 13:39:31

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-01-31 13:09:47

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-01-31 13:09:47

What I don't like about this ticket is that it's not clear that the "ppl watchdog" is not needed. What does it do and why does Sage not need it?


---

Comment by gouezel created at 2015-01-31 16:00:29

Excellent question. There is essentially no documentation on this ppl watchdog that I could find. It seems to be a classical watchdog mechanism, i.e., it detects if some computation loops forever, and in this case it interrupts it automatically and resets things to a nicer state. In particular, it should not play any role in non-buggy situations.

It is not necessary to PPL (since it is disabled on some platforms, those which don't have `setitimer`), and I do not see how it could be relevant to sage. So, my impression is that it is safe to disable it (note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms). On cygwin, with the patch, `sage -t all` does not show any ppl-related failure. By the way, without the patch, `sage -t all` hangs forever and eats all available memory, since some tests rely on `alarm` to be interrupted! So, in my opinion, the patch gives a definitive improvement on cygwin.


---

Comment by gouezel created at 2015-01-31 16:01:46

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2015-01-31 16:02:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-01-31 16:02:30

Replying to [comment:9 gouezel]:
> note that the patch only disables it on cygwin, so it will not break anything on officially supported platforms
For me, that's actually a reason to be _against_ this patch. Either we need it and we shouldn't disable it on Cygwin, or we don't need it and we can just disable it everywhere.


---

Comment by gouezel created at 2015-01-31 18:06:18

I get your point. Unfortunately, I can't say for sure that watchdog is not helpful to ppl in rare situations (for instance, maybe it uses some algorithms whose termination is not guaranteed, counting on watchdog to exit bad situations), so I would rather keep watchdog wherever possible (i.e., not on cygwin, where setitimer is not fully functional).

I leave the ticket as `needs_work` until someone more knowledgeable on ppl steps up (or someone who really needs the patch on cygwin pushes for it)


---

Comment by git created at 2015-02-13 15:11:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-09-02 08:36:08

I'm just posting random links potentially related:
* http://www.cs.unipr.it/pipermail/ppl-devel/2008-October/013156.html

According to http://trac.sagemath.org/ticket/10039#comment:49 there used to be a `--disable-watchdog` configure flag, too bad it disappeared.

I guess we should open a bug on ppl bugtracker (if one exists).

Unfortunately it seems cygwin does not ship ppl anymore, so we cannot look at what they would have done.
It could still be useful to post on the cygwin ml's.

`@`sebastien: can you provide a minimal C file reproducing the issue?
Maybe something inspired in the aforementioned 2008 post can help.


---

Comment by jdemeyer created at 2015-09-02 09:34:03

The post does indeed look related. I don't understand why it was posted on PPL-devel, since it seems to have nothing to do with PPL really.

> `@`sebastien: can you provide a minimal C file reproducing the issue?
That would be great, especially to send to the upstream bug trackers (PPL and/or Cygwin).


---

Comment by gouezel created at 2015-10-11 20:36:33

Replying to [comment:14 jpflori]:

> `@`sebastien: can you provide a minimal C file reproducing the issue?
> Maybe something inspired in the aforementioned 2008 post can help.

I just tried, but unfortunately I was not able to reproduce the issue with plain C or C++ files (for instance, taking the file in the link you give and adding ppl headers and initialization does not break the itimer mechanism).

For the record, steps to reproduce the issue using python:

File `alarm.pyx`:

```
import signal

def essai(n):
  signal.setitimer(signal.ITIMER_REAL, 0.5 , 0)
  return sum(xrange(n))
```


File `alarme_c.cpp`

```
#include <ppl.hh>
```


File `setup.py`

```
from distutils.core import setup
from Cython.Build import cythonize
from distutils.extension import Extension

setup(
    ext_modules = cythonize(Extension("alarme", ['alarme.pyx', 'alarme_c.cpp'], libraries = ['ppl']))
)
```


File `essai.py`

```
import alarme

print alarme.essai(100000000)
```


Compile the extension with

```
python setup.py build_ext --inplace
```


Then `python essai.py` results in `4999999950000000`, no interruption.

Commenting out the header inclusion in `alarme_c.cpp`, then one gets `Alarm clock` instead.


---

Comment by embray created at 2016-04-08 13:42:43

Set assignee to embray.


---

Comment by gouezel created at 2017-04-14 10:25:07

Changing status from needs_work to positive_review.


---

Comment by gouezel created at 2017-04-14 10:25:07

duplicate of #21190


---

Comment by embray created at 2017-07-13 07:54:31

Resolution: wontfix


---

Comment by embray created at 2017-07-13 07:54:31

Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).
