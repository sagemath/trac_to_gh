# Issue 25364: py3: towards docbuild ; fixing negative roots

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-06-18 12:22:20

CC:  tscrim

as this is one of the few remaining errors in sage3 docbuild:

https://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/4.15.0-20-generic/petitbonum/2018-06-18%2011:13:42?plugin=docbuild


---

Comment by chapoton created at 2018-06-18 12:22:42

New commits:


---

Comment by chapoton created at 2018-06-18 12:22:42

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-06-19 03:00:08

That the negative roots does not work for affine types is something I would probably say is a bug. So this change makes it worse:

```diff
diff --git a/src/sage/combinat/root_system/root_lattice_realizations.py b/src/sage/combinat/root_system/root_lattice_realizations.py
index 78d3cd7..c1b89e6 100644
--- a/src/sage/combinat/root_system/root_lattice_realizations.py
+++ b/src/sage/combinat/root_system/root_lattice_realizations.py
`@``@` -1196,7 +1196,7 `@``@` class RootLatticeRealizations(Category_over_base_ring):
             """
             if not self.cartan_type().is_finite():
                 raise ValueError("%s is not a finite Cartan type" % self.cartan_type())
-            return self.positive_roots().map(attrcall('__neg__'))
+            return [r.__neg__() for r in self.positive_roots()]
 
         ##########################################################################
         # coroots
```



---

Comment by jdemeyer created at 2018-06-19 05:32:44

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-06-19 05:32:44

What's wrong with

```
a = 1/n
```



---

Comment by jdemeyer created at 2018-06-19 05:35:32

And why `r.__neg__()` instead of `-r`?

It is almost never needed to call such double-underscore methods (main exceptions: `__new__` and when using `super`)


---

Comment by git created at 2018-06-19 06:38:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-19 06:50:19

Here is the issue, in case one of you has a better idea for a fix:

```
sage: R=RootSystem(['A',2])
sage: RS=R.root_lattice()
sage: po=RS.positive_roots()
sage: neg=RS.negative_roots()
sage: po
A recursively enumerated set with a graded structure (breadth first search)
sage: neg
Image of A recursively enumerated set with a graded structure (breadth first search) by <function RootLatticeRealizations.ParentMethods.negative_roots.<locals>.<lambda> at 0x7fa6b17f6620>
sage: next(iter(po))
alpha[1]
sage: next(iter(neg))
-alpha[1]
sage: list(po)
[alpha[1], alpha[2], alpha[1] + alpha[2]]
sage: list(neg)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-10-41be9b87c947> in <module>()
----> 1 list(neg)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/combinat.py in __len__(self)
   1350             AttributeError: __len__ has been removed; use .cardinality() instead
   1351         """
-> 1352         raise AttributeError("__len__ has been removed; use .cardinality() instead")
   1353 
   1354     def is_finite(self):

AttributeError: __len__ has been removed; use .cardinality() instead
```



---

Comment by tscrim created at 2018-06-19 07:26:46

That looks like a Sage safety check to avoid infinite iteration, but I am not sure it is really an effective one. Actually, I am somewhat curious as to why this behavior changed from 2 to 3.
Interestingly, I get the same behavior on 2 and 3 with this:

```
>>> class Foo(object):
...     def __len__(self):
...         print("len")
...         return 5
...     def __iter__(self):
...         return iter(range(5))
... 
>>> F = Foo()
>>> list(F)
len
[0, 1, 2, 3, 4]
```

However, in Python2, the error is caught and things are allowed to proceed as normal for `__iter__`. In Python3, it is not caught and aborts the computation.

I would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.


---

Comment by jdemeyer created at 2018-06-19 07:36:54

Replying to [comment:7 tscrim]:
> I would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.

I'm guessing that `__len__` was "removed" because of a technical restriction that `__len__` must return a C `long`. So the answer cannot be an arbitrarily large integer nor infinity. I agree that implementing `__len__` as `self.cardinality()` makes sense. We should just check which what Cython does if this answer is either a large integer or infinity and add doctests.


---

Comment by jdemeyer created at 2018-06-19 07:37:06

Seriously, what is wrong with `1/n`?


---

Comment by chapoton created at 2018-06-19 07:38:15

:)

oh, well. In fact my branch can just be dropped..


---

Comment by jdemeyer created at 2018-06-19 07:40:42

I am advocating `1/n` in favour of other alternatives because it's not Sage-specific (unlike `~n` which is really a hack IMHO) and it's quite fast.


---

Comment by jdemeyer created at 2018-06-19 08:16:04

Replying to [comment:8 jdemeyer]:
> I agree that implementing `__len__` as `self.cardinality()` makes sense.

Actually, the default implementation of `cardinality()` is

```
    def cardinality(self):
        c = 0
        for _ in self:
            c += 1
        return c
```

and you don't want `__len__` (which is supposed to be fast) to call that.

So maybe we should just remove `__len__` completely instead of having it raise an `AttributeError`. I created #25605 for that.


---

Comment by chapoton created at 2018-06-19 11:45:57

so maybe we can now close this one as duplicate/invalid ?


---

Comment by jdemeyer created at 2018-06-19 12:03:31

Changing component from python3 to misc.


---

Comment by chapoton created at 2018-06-19 12:08:36

no, I think Travis said that the change in negative roots is bad, as it explicitly makes the list, instead of being a Familly (kind of lazy object).
----
New commits:


---

Comment by git created at 2018-06-19 12:12:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-19 12:14:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-19 12:14:11

New commits:


---

Comment by jdemeyer created at 2018-06-19 12:14:11

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2018-06-20 18:06:21

Resolution: fixed
