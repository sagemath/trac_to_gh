# Issue 20224: Fixes for copying a MIP and its variables

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-04-19 04:05:06

CC:  dimpase vdelecroix jdemeyer nbruin chapoton

Keywords: lp

Even after merging #20414, both `copy` and (the identical) `deepcopy` have weird semantics in relation to the `MIPVariable`s in a problems -- because a MIP does not have an API to gain access to its variables; and trying to use the old `MIPVariable`s with the copy is questionable and definitely broken if one creates new components of this variable, see #15159, #19523. Same when there's no explicit `MIPVariable` and only the `_default_mipvariable` is used via the problem's `__getitem__` method. 

Here's a possible fix without having to change the whole design:

 * a new `MixedIntegerLinearProgram.copy` method that takes a `names` keyword argument, enabling this operation:

```
sage: p.<x,y> = MixedIntegerLinearProgram()
sage: q.<newx,newy> = p.copy()
```

 * `copy` and `__copy__` (and `__deepcopy__`) should make a copy of _default_variable (this requires writing a `__copy__` method for `MIPVariable`)
 * if `MixedIntegerLinearProgram.new_variable` has been called, it should set a flag and then if __copy__ (or __deepcopy__) are called, it should display a warning (deprecation??) and refer the user to the new `copy` method.


---

Comment by mkoeppe created at 2016-04-19 23:52:12

Any thoughts on this proposal?


---

Comment by nbruin created at 2016-05-12 22:37:55


```
sage: p = MixedIntegerLinearProgram()
sage: x = p.new_variable(nonnegative=True)
sage: x[0]
x_0
sage: x[1]
x_1
sage: p[0] #I don't understand this
x_2
sage: p[1]
x_3
```

But if we actually use the "generator" interface things seem OK:

```
sage: [p.gen(i) for i in [0..3]]
[x_0, x_1, x_2, x_3]
```

so I would suggest to just make sure that `p.gen(...)` works properly and indeed gives a variable of the appropriate MIP object. Then there IS an interface to get access to its variables (and really, it seems to be largely in place already) and then simply that can be used.

It looks like a variable on p is uniquely determined by its index (certainly its print name is), and `p.new_variable` seems just a funny way of obtaining such indices.

The rest of the variable data is all hanging off internal tables, and via the "is_variable_*" methods you can obtain the type of the variables.

I think you first need to make sure that all of that is accessible (and copied appropriately, but I guess that's taken care of now) and then you can think about what to do with this "new_variable" business.


---

Comment by mkoeppe created at 2016-05-13 07:12:07

If one just uses `gen()`. then everything already works as expected.

What is broken with `copy` is the funny stuff involving `MIPVariable`. This is what this ticket addresses.


---

Comment by mkoeppe created at 2016-05-13 07:23:17

Actually I spoke too fast, it seems that `gen()` does not do anything useful. 


```
sage: mip = MixedIntegerLinearProgram(solver='GLPK')
sage: mip.gen(0)           ### Names a variable, but does not create it in the backend
x_0
sage: mip.number_of_variables()
0
sage: mip[0]                  ### This now creates a variable. It prints the same as the result of gen(0), but is different.
x_0
sage: mip.get_values(mip.gen(0))
[...]
TypeError: Not a MIPVariable: x_0
sage: mip.is_real(mip.gen(0))
[...]
KeyError: x_0
sage: mip.is_real(mip[0])
True
```



---

Comment by mkoeppe created at 2016-05-13 07:52:46

Repairing `gen()` is now #20602.


---

Comment by mkoeppe created at 2016-05-23 11:43:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-05-23 11:43:23

New commits:


---

Comment by mkoeppe created at 2016-05-31 09:29:23

Needs review.


---

Comment by dimpase created at 2016-05-31 18:56:05

Shouldn't `copy_for_mip` actually become `copy` ?
Or there is a reason to keep `copy` as well?


---

Comment by mkoeppe created at 2016-05-31 20:39:34

Currently there is no `copy`. 
It seems an unusual operation to make a copy of a MIPVariable for the same problem.


---

Comment by git created at 2016-05-31 21:21:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-05-31 21:21:38

But anyway I made `__copy__` and `__deepcopy__` methods. (& rebased)


---

Comment by mkoeppe created at 2016-06-02 13:29:26

ping?


---

Comment by dimpase created at 2016-06-02 14:21:57

OK, looks good to me.


---

Comment by dimpase created at 2016-06-02 14:21:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-02 21:00:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-06-02 21:00:46

Reviewer name


---

Comment by dimpase created at 2016-06-02 21:05:24

I will never learn the drill :-)


---

Comment by dimpase created at 2016-06-02 22:35:04

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-06-05 01:10:35

Resolution: fixed
