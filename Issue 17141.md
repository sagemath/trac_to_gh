# Issue 17141: Preparser gets lost with iterated ellipsis_range

archive/issues_017141.json:
```json
{
    "body": "Here is a bug reported during a workshop at Villetaneuse today:\n\n\n```\nsage: [1..10]\n[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsage: len([1..10])\n10\nsage: [1..len([1..10])]\n[1, 2, 3]\n```\n\n\nAfter a quick look, it seems that there is a preparsing problem, `[1..len([1..10])]` should be preparsed as something like:\n\n\n```\n(ellipsis_range(Integer(1),Ellipsis,len(ellipsis_range(Integer(1),Ellipsis,Integer(10)))))\n```\n\n\nbut it is currently preparsed as:\n\n\n```\nsage: preparse('[1..len([1..10])]')\n'(ellipsis_range(Integer(1),Ellipsis,len([Integer(1),Ellipsis,Integer(10)])))'\n```\n\n\n(the second `ellipsis_range` disappeared).\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17378\n\n",
    "created_at": "2014-11-21T18:31:48Z",
    "labels": [
        "user interface",
        "major",
        "bug"
    ],
    "title": "Preparser gets lost with iterated ellipsis_range",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17141",
    "user": "tmonteil"
}
```
Here is a bug reported during a workshop at Villetaneuse today:


```
sage: [1..10]
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
sage: len([1..10])
10
sage: [1..len([1..10])]
[1, 2, 3]
```


After a quick look, it seems that there is a preparsing problem, `[1..len([1..10])]` should be preparsed as something like:


```
(ellipsis_range(Integer(1),Ellipsis,len(ellipsis_range(Integer(1),Ellipsis,Integer(10)))))
```


but it is currently preparsed as:


```
sage: preparse('[1..len([1..10])]')
'(ellipsis_range(Integer(1),Ellipsis,len([Integer(1),Ellipsis,Integer(10)])))'
```


(the second `ellipsis_range` disappeared).


Issue created by migration from https://trac.sagemath.org/ticket/17378





---

archive/issue_comments_227845.json:
```json
{
    "body": "I think we're really out of our depth here. `ellipsis_range` can actually take multiple `..` in its arguments, so we need to distinguish between\n\n```\n[1,2..10,12..20]\n```\n\nand\n\n```\n[1,2..len([10,12..20])]\n```\n\nThe code in question is presently (see sage.misc.preparser line 520)\n\n```\n    ix = code.find('..')\n    while ix != -1:\n        if ix == 0:\n            raise SyntaxError(\"Cannot start line with ellipsis.\")\n        elif code[ix-1]=='.':\n            # '...' be valid Python in index slices\n            code = code[:ix-1] + \"Ellipsis\" + code[ix+2:]\n        elif len(code) >= ix+3 and code[ix+2]=='.':\n            # '...' be valid Python in index slices\n            code = code[:ix] + \"Ellipsis\" + code[ix+3:]\n        else:\n            start_list, end_list = containing_block(code, ix, ['()','[]'])\n(*)         arguments = code[start_list+1:end_list-1].replace('...', ',Ellipsis,').replace('..', ',Ellipsis,')\n            arguments = re.sub(r',\\s*,', ',', arguments)\n            if preparse_step:\n                arguments = arguments.replace(';', ', step=')\n            range_or_iter = 'range' if code[start_list]=='[' else 'iter'\n            code = \"%s(ellipsis_%s(%s))%s\" %  (code[:start_list],\n                                               range_or_iter,\n                                               arguments,\n                                               code[end_list:])\n        ix = code.find('..')\n```\n\nThe problem is in the line marked (*). It really does need to be prepared to make multiple substitutions, but it should leave \"..\" that are enclosed in some kind of bracket for later substitutions.\n\nThis is really one of those cases where string-substitutions aren't really powerful enough. It we'd start with a '..' that has a containing block that isn't properly contained in a containing block of any other '..', rather than the first '..' we find, then we'd be ok. (because inside that containing block all the '..' do belong to the same `ellipsis_range`).\n\nI'm a little worried about cost with that approach: what happens if a whole \".sage\" file gets preparsed that has a whole lot of '..' in it? does this routine then execute on that huge string? execution time quadratic (or worse) in the number of '..' might be problematic.\n\n*EDIT:* correction: what we should do is: after we have found our initial `ix` and our `start_list,end_list`, we should do\n\n```\n    while True:\n        new_ix = code.find('..',ix+1,end_list)\n        if new_ix == -1:\n            break #EXIT HERE if there are no other '..' to consider\n        else:\n            ix = new_ix\n        new_start_list,new_end_list = containing_block(code,ix,['(),'[]'])\n        if (new_start_list != start_list) or (new_end_list != end_list):\n            start_list = new_start_list\n            end_list = new_end_list\n```\n\nThis should be pretty quick because it simply zooms in on the block that's under consideration. Those blocks should be pretty small, even in a big file.\n\nThis code should probably be edited a bit because there are apparently some occurrences of '...' that need to be treated differently and I'm not doing that here at the moment.",
    "created_at": "2014-11-21T20:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227845",
    "user": "nbruin"
}
```

I think we're really out of our depth here. `ellipsis_range` can actually take multiple `..` in its arguments, so we need to distinguish between

```
[1,2..10,12..20]
```

and

```
[1,2..len([10,12..20])]
```

The code in question is presently (see sage.misc.preparser line 520)

```
    ix = code.find('..')
    while ix != -1:
        if ix == 0:
            raise SyntaxError("Cannot start line with ellipsis.")
        elif code[ix-1]=='.':
            # '...' be valid Python in index slices
            code = code[:ix-1] + "Ellipsis" + code[ix+2:]
        elif len(code) >= ix+3 and code[ix+2]=='.':
            # '...' be valid Python in index slices
            code = code[:ix] + "Ellipsis" + code[ix+3:]
        else:
            start_list, end_list = containing_block(code, ix, ['()','[]'])
(*)         arguments = code[start_list+1:end_list-1].replace('...', ',Ellipsis,').replace('..', ',Ellipsis,')
            arguments = re.sub(r',\s*,', ',', arguments)
            if preparse_step:
                arguments = arguments.replace(';', ', step=')
            range_or_iter = 'range' if code[start_list]=='[' else 'iter'
            code = "%s(ellipsis_%s(%s))%s" %  (code[:start_list],
                                               range_or_iter,
                                               arguments,
                                               code[end_list:])
        ix = code.find('..')
```

The problem is in the line marked (*). It really does need to be prepared to make multiple substitutions, but it should leave ".." that are enclosed in some kind of bracket for later substitutions.

This is really one of those cases where string-substitutions aren't really powerful enough. It we'd start with a '..' that has a containing block that isn't properly contained in a containing block of any other '..', rather than the first '..' we find, then we'd be ok. (because inside that containing block all the '..' do belong to the same `ellipsis_range`).

I'm a little worried about cost with that approach: what happens if a whole ".sage" file gets preparsed that has a whole lot of '..' in it? does this routine then execute on that huge string? execution time quadratic (or worse) in the number of '..' might be problematic.

*EDIT:* correction: what we should do is: after we have found our initial `ix` and our `start_list,end_list`, we should do

```
    while True:
        new_ix = code.find('..',ix+1,end_list)
        if new_ix == -1:
            break #EXIT HERE if there are no other '..' to consider
        else:
            ix = new_ix
        new_start_list,new_end_list = containing_block(code,ix,['(),'[]'])
        if (new_start_list != start_list) or (new_end_list != end_list):
            start_list = new_start_list
            end_list = new_end_list
```

This should be pretty quick because it simply zooms in on the block that's under consideration. Those blocks should be pretty small, even in a big file.

This code should probably be edited a bit because there are apparently some occurrences of '...' that need to be treated differently and I'm not doing that here at the moment.



---

archive/issue_comments_227846.json:
```json
{
    "body": "Incidentally, the comma handling is perhaps a little too permissive:\n\n```\nsage: [1,,2..3]\n[1, 2, 3]\nsage: [1,,2,3]\n```\n\nRunning preparse_ellipsis has the side effect for turning something that *should* be a syntax error into valid code.",
    "created_at": "2014-11-21T21:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227846",
    "user": "nbruin"
}
```

Incidentally, the comma handling is perhaps a little too permissive:

```
sage: [1,,2..3]
[1, 2, 3]
sage: [1,,2,3]
```

Running preparse_ellipsis has the side effect for turning something that *should* be a syntax error into valid code.



---

archive/issue_comments_227847.json:
```json
{
    "body": "OK, I did not deal with the extra comma replacements (which seem relatively harmless). i think the \"...\" detection is simply a matter that those \"...\" can be replaced by `Ellipsis` but should not trigger the generation of an `ellipsis_range`/`ellipsis_iter`. That's my current interpretation.\n----\nNew commits:",
    "created_at": "2014-11-22T00:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227847",
    "user": "nbruin"
}
```

OK, I did not deal with the extra comma replacements (which seem relatively harmless). i think the "..." detection is simply a matter that those "..." can be replaced by `Ellipsis` but should not trigger the generation of an `ellipsis_range`/`ellipsis_iter`. That's my current interpretation.
----
New commits:



---

archive/issue_comments_227848.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-11-22T00:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227848",
    "user": "nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_227849.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-11-22T07:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227849",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_227850.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-11-22T07:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227850",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_227851.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-12-08T13:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227851",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_227852.json:
```json
{
    "body": "This makes sense and fixes the problem.\n\nCould you just replace `#17378` by `:trac:`17378`` in the doctest so that sphinx can handle it ?",
    "created_at": "2014-12-08T13:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227852",
    "user": "tmonteil"
}
```

This makes sense and fixes the problem.

Could you just replace `#17378` by `:trac:`17378`` in the doctest so that sphinx can handle it ?



---

archive/issue_comments_227853.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-01-07T18:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227853",
    "user": "tmonteil"
}
```

New commits:



---

archive/issue_comments_227854.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-01-07T18:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227854",
    "user": "tmonteil"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_227855.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-01-12T09:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227855",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_227856.json:
```json
{
    "body": "Conflicts with #17396",
    "created_at": "2015-01-12T09:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227856",
    "user": "vbraun"
}
```

Conflicts with #17396



---

archive/issue_comments_227857.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-12T21:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227857",
    "user": "nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_227858.json:
```json
{
    "body": "hard rebase to resolve conflict\n----\nNew commits:",
    "created_at": "2015-01-12T21:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227858",
    "user": "nbruin"
}
```

hard rebase to resolve conflict
----
New commits:



---

archive/issue_comments_227859.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-05T10:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227859",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_227860.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-08T15:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17141#issuecomment-227860",
    "user": "vbraun"
}
```

Resolution: fixed
