# Issue 23561: Fractional Chromatic Index Infinite Loop fails with GLPK

archive/issues_023561.json:
```json
{
    "body": "CC:  @dcoudert\n\nThe test\n\n```\n            sage: g = graphs.PetersenGraph()\n            sage: g.fractional_chromatic_index(solver='GLPK')\n            3.0\n```\n\nadded by #23658 fails with GLPK on 32-bit.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23798\n\n",
    "created_at": "2017-09-07T11:51:23Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fractional Chromatic Index Infinite Loop fails with GLPK",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23561",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @dcoudert

The test

```
            sage: g = graphs.PetersenGraph()
            sage: g.fractional_chromatic_index(solver='GLPK')
            3.0
```

added by #23658 fails with GLPK on 32-bit.

Issue created by migration from https://trac.sagemath.org/ticket/23798





---

archive/issue_comments_329662.json:
```json
{
    "body": "I suspect that we need to change `if M.solve(log = verbose) <= 1:` to `if M.solve(log = verbose) <= 1 + tol:`, where `tol = 0 if solver=='PPL' else 1e-6`. I don't like this solution, but I don't know what else we can do. \n\nI don't have access to a 32-bit machine and so cannot test.",
    "created_at": "2017-09-07T13:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329662",
    "user": "https://github.com/dcoudert"
}
```

I suspect that we need to change `if M.solve(log = verbose) <= 1:` to `if M.solve(log = verbose) <= 1 + tol:`, where `tol = 0 if solver=='PPL' else 1e-6`. I don't like this solution, but I don't know what else we can do. 

I don't have access to a 32-bit machine and so cannot test.



---

archive/issue_comments_329663.json:
```json
{
    "body": "You could also forbid using a non-exact solver for this problem.",
    "created_at": "2017-09-07T15:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329663",
    "user": "https://github.com/jdemeyer"
}
```

You could also forbid using a non-exact solver for this problem.



---

archive/issue_comments_329664.json:
```json
{
    "body": "Sure, we can force `PPL`, but it is way slower (can sometimes be faster on small graphs).\n\n```\nsage: G = graphs.Grid2dGraph(6,6)\nsage: %time G.fractional_chromatic_index(solver='GLPK')\nCPU times: user 43.4 ms, sys: 4.9 ms, total: 48.3 ms\nWall time: 52.1 ms\n4.0\nsage: %time G.fractional_chromatic_index(solver='PPL')\nCPU times: user 1min 11s, sys: 256 ms, total: 1min 11s\nWall time: 1min 12s\n4\n```\n\nI agree that using a tolerance gap is not a nice solution either.",
    "created_at": "2017-09-07T17:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329664",
    "user": "https://github.com/dcoudert"
}
```

Sure, we can force `PPL`, but it is way slower (can sometimes be faster on small graphs).

```
sage: G = graphs.Grid2dGraph(6,6)
sage: %time G.fractional_chromatic_index(solver='GLPK')
CPU times: user 43.4 ms, sys: 4.9 ms, total: 48.3 ms
Wall time: 52.1 ms
4.0
sage: %time G.fractional_chromatic_index(solver='PPL')
CPU times: user 1min 11s, sys: 256 ms, total: 1min 11s
Wall time: 1min 12s
4
```

I agree that using a tolerance gap is not a nice solution either.



---

archive/issue_comments_329665.json:
```json
{
    "body": "I don't see better solution than making `PPL` the default solver here.\n----\nNew commits:",
    "created_at": "2017-10-21T08:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329665",
    "user": "https://github.com/dcoudert"
}
```

I don't see better solution than making `PPL` the default solver here.
----
New commits:



---

archive/issue_comments_329666.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-21T08:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329666",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329667.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-22T20:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329667",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_329668.json:
```json
{
    "body": "\"Be aware that this method may loop endlessly when using some non exact solvers on 32-bits\". I doubt that this is problem specific to 32 bits. The wording seems to imply that it's safe to use non-exact solvers on 64-bit machines.",
    "created_at": "2017-10-22T20:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329668",
    "user": "https://github.com/jdemeyer"
}
```

"Be aware that this method may loop endlessly when using some non exact solvers on 32-bits". I doubt that this is problem specific to 32 bits. The wording seems to imply that it's safe to use non-exact solvers on 64-bit machines.



---

archive/issue_comments_329669.json:
```json
{
    "body": "Also, this isn't quite correct:\n\n```\nTickets :trac:`23658` and :trac:`23798` are fixed::\n```\n\nfollowed by a test with GLPK.",
    "created_at": "2017-10-22T20:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329669",
    "user": "https://github.com/jdemeyer"
}
```

Also, this isn't quite correct:

```
Tickets :trac:`23658` and :trac:`23798` are fixed::
```

followed by a test with GLPK.



---

archive/issue_comments_329670.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-22T21:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329670",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329671.json:
```json
{
    "body": "Is this more appropriate ?",
    "created_at": "2017-10-22T21:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329671",
    "user": "https://github.com/dcoudert"
}
```

Is this more appropriate ?



---

archive/issue_comments_329672.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-22T21:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329672",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_329673.json:
```json
{
    "body": "Well, it depends. Do you consider the code here to be a fix or a workaround? I am asking because you need to decide what to do with\n\n```\nsage: g.fractional_chromatic_index(solver='GLPK') # known bug (#23798)\n```\n\nYou cannot say that this ticket is a known bug while at the same time fixing this ticket.",
    "created_at": "2017-10-23T07:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329673",
    "user": "https://github.com/jdemeyer"
}
```

Well, it depends. Do you consider the code here to be a fix or a workaround? I am asking because you need to decide what to do with

```
sage: g.fractional_chromatic_index(solver='GLPK') # known bug (#23798)
```

You cannot say that this ticket is a known bug while at the same time fixing this ticket.



---

archive/issue_comments_329674.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-23T08:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329674",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_329675.json:
```json
{
    "body": "The problem is not fixed. That's why I changed the text to `Issue reported in :trac:`23658` and :trac:`23798` with non exact solvers::`. What else can I write to be more correct/specific?",
    "created_at": "2017-10-23T20:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329675",
    "user": "https://github.com/dcoudert"
}
```

The problem is not fixed. That's why I changed the text to `Issue reported in :trac:`23658` and :trac:`23798` with non exact solvers::`. What else can I write to be more correct/specific?



---

archive/issue_comments_329676.json:
```json
{
    "body": "Replying to [comment:13 dcoudert]:\n> The problem is not fixed.\n\nThen I'm moving your branch to a new ticket: #24099.",
    "created_at": "2017-10-24T17:18:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329676",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 dcoudert]:
> The problem is not fixed.

Then I'm moving your branch to a new ticket: #24099.



---

archive/issue_comments_329677.json:
```json
{
    "body": "OK, thanks.",
    "created_at": "2017-10-24T19:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329677",
    "user": "https://github.com/dcoudert"
}
```

OK, thanks.



---

archive/issue_comments_329678.json:
```json
{
    "body": "Since #24824, we use GLPK 4.65.\nDoes anyone with access to a 32-bit machine still see the bug ?",
    "created_at": "2020-08-30T11:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329678",
    "user": "https://github.com/dcoudert"
}
```

Since #24824, we use GLPK 4.65.
Does anyone with access to a 32-bit machine still see the bug ?



---

archive/issue_comments_329679.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329679",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_329680.json:
```json
{
    "body": "Replying to [comment:17 dcoudert]:\n> Since #24824, we use GLPK 4.65.\n> Does anyone with access to a 32-bit machine still see the bug ?\n\nI still see the bug (on a 32-bit debian virtual machine). The default solver seems instantaneous, but I let `solver='GLPK'` run for about 15 minutes and did not get an answer.",
    "created_at": "2021-07-12T04:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329680",
    "user": "https://github.com/DaveWitteMorris"
}
```

Replying to [comment:17 dcoudert]:
> Since #24824, we use GLPK 4.65.
> Does anyone with access to a 32-bit machine still see the bug ?

I still see the bug (on a 32-bit debian virtual machine). The default solver seems instantaneous, but I let `solver='GLPK'` run for about 15 minutes and did not get an answer.



---

archive/issue_comments_329681.json:
```json
{
    "body": "This is unfortunate.\n\nThe only solutions I see are:\n- Force to use `PPL`, but this is not nice for users with a 64 bits machine (most of the users I guess)\n- Raise an error when the solver is `glpk` on a 32 bits machine\nand none of them are satisfactory.",
    "created_at": "2021-07-12T22:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329681",
    "user": "https://github.com/dcoudert"
}
```

This is unfortunate.

The only solutions I see are:
- Force to use `PPL`, but this is not nice for users with a 64 bits machine (most of the users I guess)
- Raise an error when the solver is `glpk` on a 32 bits machine
and none of them are satisfactory.



---

archive/issue_comments_329682.json:
```json
{
    "body": "Replying to [comment:3 dcoudert]:\n> I suspect that we need to change `if M.solve(log = verbose) <= 1:` to `if M.solve(log = verbose) <= 1 + tol:`, where `tol = 0 if solver=='PPL' else 1e-6`. I don't like this solution, but I don't know what else we can do. \n\nUsing a tolerance is exactly the right solution. The test for exact `<= 1` and `== 1` is meaningless with a numerical LP solver. LP solvers use perturbations systematically. It is not a bug if the result is not an exact integer.",
    "created_at": "2021-07-12T22:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329682",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 dcoudert]:
> I suspect that we need to change `if M.solve(log = verbose) <= 1:` to `if M.solve(log = verbose) <= 1 + tol:`, where `tol = 0 if solver=='PPL' else 1e-6`. I don't like this solution, but I don't know what else we can do. 

Using a tolerance is exactly the right solution. The test for exact `<= 1` and `== 1` is meaningless with a numerical LP solver. LP solvers use perturbations systematically. It is not a bug if the result is not an exact integer.



---

archive/issue_comments_329683.json:
```json
{
    "body": "See also my explanations in #30635#comment:20 and following.",
    "created_at": "2021-07-12T22:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329683",
    "user": "https://github.com/mkoeppe"
}
```

See also my explanations in #30635#comment:20 and following.



---

archive/issue_comments_329684.json:
```json
{
    "body": "there are two LPs involved, one of them for a maximum weight matching, something that can be instead done by a combinatorial algorithm, see e.g. Blossom V in http://pub.ist.ac.at/~vnk/software.html",
    "created_at": "2021-07-13T10:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329684",
    "user": "https://github.com/dimpase"
}
```

there are two LPs involved, one of them for a maximum weight matching, something that can be instead done by a combinatorial algorithm, see e.g. Blossom V in http://pub.ist.ac.at/~vnk/software.html



---

archive/issue_comments_329685.json:
```json
{
    "body": "If I force PPL on the inner (matching) LP:\n\n```diff\n--- a/src/sage/graphs/graph_coloring.pyx\n+++ b/src/sage/graphs/graph_coloring.pyx\n@@ -825,7 +825,7 @@ def fractional_chromatic_index(G, solver=\"PPL\", verbose_constraints=False, verbo\n     frozen_edges = [frozenset(e) for e in G.edges(labels=False, sort=False)]\n \n     # Initialize LP for maximum weight matching\n-    M = MixedIntegerLinearProgram(solver=solver, constraint_generation=True)\n+    M = MixedIntegerLinearProgram(solver=\"PPL\", constraint_generation=True)\n \n     # One variable per edge\n     b = M.new_variable(binary=True, nonnegative=True)\n```\n\nthen on a 32-bit system it's all fine (GLPK from the system, unpatched, so these extra messages)\n\n```\nsage: G=graphs.PetersenGraph()\nsage: G.fractional_chromatic_index(solver=\"GLPK\")\nLong-step dual simplex will be used\nLong-step dual simplex will be used\nLong-step dual simplex will be used\nLong-step dual simplex will be used\nLong-step dual simplex will be used\nLong-step dual simplex will be used\n3.0\n```\n",
    "created_at": "2021-07-13T10:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329685",
    "user": "https://github.com/dimpase"
}
```

If I force PPL on the inner (matching) LP:

```diff
--- a/src/sage/graphs/graph_coloring.pyx
+++ b/src/sage/graphs/graph_coloring.pyx
@@ -825,7 +825,7 @@ def fractional_chromatic_index(G, solver="PPL", verbose_constraints=False, verbo
     frozen_edges = [frozenset(e) for e in G.edges(labels=False, sort=False)]
 
     # Initialize LP for maximum weight matching
-    M = MixedIntegerLinearProgram(solver=solver, constraint_generation=True)
+    M = MixedIntegerLinearProgram(solver="PPL", constraint_generation=True)
 
     # One variable per edge
     b = M.new_variable(binary=True, nonnegative=True)
```

then on a 32-bit system it's all fine (GLPK from the system, unpatched, so these extra messages)

```
sage: G=graphs.PetersenGraph()
sage: G.fractional_chromatic_index(solver="GLPK")
Long-step dual simplex will be used
Long-step dual simplex will be used
Long-step dual simplex will be used
Long-step dual simplex will be used
Long-step dual simplex will be used
Long-step dual simplex will be used
3.0
```




---

archive/issue_comments_329686.json:
```json
{
    "body": "Following above discussion, I added a tolerance gap for numerical LP solvers. \n\nNote that we can use the `networkx` implementation of the blossom algorithm via the `matching` method, but it does not solve the issue. Actually, it's slower and worse for the rounding as I observe the issue on a 64 bits machine...\n----\nNew commits:",
    "created_at": "2021-07-13T14:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329686",
    "user": "https://github.com/dcoudert"
}
```

Following above discussion, I added a tolerance gap for numerical LP solvers. 

Note that we can use the `networkx` implementation of the blossom algorithm via the `matching` method, but it does not solve the issue. Actually, it's slower and worse for the rounding as I observe the issue on a 64 bits machine...
----
New commits:



---

archive/issue_comments_329687.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-13T14:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329687",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_329688.json:
```json
{
    "body": "I don\u2019t  like this approach. Without explicit guarantees that these tolerances are correct, it is replacing correct algorithms with heuristics.",
    "created_at": "2021-07-13T22:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329688",
    "user": "https://github.com/dimpase"
}
```

I don’t  like this approach. Without explicit guarantees that these tolerances are correct, it is replacing correct algorithms with heuristics.



---

archive/issue_comments_329689.json:
```json
{
    "body": "\n```\n         matching = [fe for fe in frozen_edges if M.get_values(b[fe]) == 1]\n```\n\nThis line also needs changing because the test \"== 1\" is not robust.",
    "created_at": "2021-07-13T22:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329689",
    "user": "https://github.com/mkoeppe"
}
```


```
         matching = [fe for fe in frozen_edges if M.get_values(b[fe]) == 1]
```

This line also needs changing because the test "== 1" is not robust.



---

archive/issue_comments_329690.json:
```json
{
    "body": "I don\u2019t see how one can make the oracle (the inner LP) inexact, without potentially returning a very wrong answer. \n\nThe oracle checks that there is no maximum weight matching of weight >1. Say, we let it error by epsilon, i.e we terminate with oracle returning 1+epsilon. Potentially, there could be K maximum matchings with this weight, if they are disjoint this means that the final error is K times epsilon, oops\u2026",
    "created_at": "2021-07-13T22:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329690",
    "user": "https://github.com/dimpase"
}
```

I don’t see how one can make the oracle (the inner LP) inexact, without potentially returning a very wrong answer. 

The oracle checks that there is no maximum weight matching of weight >1. Say, we let it error by epsilon, i.e we terminate with oracle returning 1+epsilon. Potentially, there could be K maximum matchings with this weight, if they are disjoint this means that the final error is K times epsilon, oops…



---

archive/issue_comments_329691.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-13T22:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329691",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_329692.json:
```json
{
    "body": "I don't like this solution either but I don't know what to do when a solver returns 0.99999... instead of 1 although we have set the variable type to binary. The solvers are aware of the type of the variable and so should return a value with the correct type and not a double. The solution might be in the backends.",
    "created_at": "2021-07-14T10:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329692",
    "user": "https://github.com/dcoudert"
}
```

I don't like this solution either but I don't know what to do when a solver returns 0.99999... instead of 1 although we have set the variable type to binary. The solvers are aware of the type of the variable and so should return a value with the correct type and not a double. The solution might be in the backends.



---

archive/issue_comments_329693.json:
```json
{
    "body": "Replying to [comment:32 dcoudert]:\n> I don't like this solution either but I don't know what to do when a solver returns 0.99999... instead of 1 although we have set the variable type to binary. The solvers are aware of the type of the variable and so should return a value with the correct type and not a double. The solution might be in the backends. \n\nNo, my point is that without a special analysis it's not possible to argue that solving the oracle problem  (with non-integer objective function) inexactly provides a correct result, even if you \"correctly\" round 0.9999... to 1. It's because a small oracle error may get amplified a lot in the main LP. \nWelcome to floating point hell :-)|",
    "created_at": "2021-07-14T21:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329693",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:32 dcoudert]:
> I don't like this solution either but I don't know what to do when a solver returns 0.99999... instead of 1 although we have set the variable type to binary. The solvers are aware of the type of the variable and so should return a value with the correct type and not a double. The solution might be in the backends. 

No, my point is that without a special analysis it's not possible to argue that solving the oracle problem  (with non-integer objective function) inexactly provides a correct result, even if you "correctly" round 0.9999... to 1. It's because a small oracle error may get amplified a lot in the main LP. 
Welcome to floating point hell :-)|



---

archive/issue_comments_329694.json:
```json
{
    "body": "Replying to [comment:27 dcoudert]:\n> Following above discussion, I added a tolerance gap for numerical LP solvers. \n> \n> Note that we can use the `networkx` implementation of the blossom algorithm via the `matching` method, but it does not solve the issue. Actually, it's slower and worse for the rounding as I observe the issue on a 64 bits machine...\n\n\nThe oracle implementation here is naive, and bound to get very slow; it's integer LP without Edmonds' constraints,\ninstead of a \"normal\" LP over the matching polytope with Edmonds' constraints (aka blossom inequalities).\nSo this would need yet another oracle (as there are too exponentially many inequalities there), but well, it's polynomial time then.\nThe generated constraints can stay, so this should be fast.\n\n> ----\n> New commits:\n> ||[ebcde7c](https://git.sagemath.org/sage.git/commit?id=ebcde7c37ea3a8377fbcebe2246aae890e9df305)||`trac #23798: add tolerance gap for numerical LP solvers`||",
    "created_at": "2021-07-15T12:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329694",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:27 dcoudert]:
> Following above discussion, I added a tolerance gap for numerical LP solvers. 
> 
> Note that we can use the `networkx` implementation of the blossom algorithm via the `matching` method, but it does not solve the issue. Actually, it's slower and worse for the rounding as I observe the issue on a 64 bits machine...


The oracle implementation here is naive, and bound to get very slow; it's integer LP without Edmonds' constraints,
instead of a "normal" LP over the matching polytope with Edmonds' constraints (aka blossom inequalities).
So this would need yet another oracle (as there are too exponentially many inequalities there), but well, it's polynomial time then.
The generated constraints can stay, so this should be fast.

> ----
> New commits:
> ||[ebcde7c](https://git.sagemath.org/sage.git/commit?id=ebcde7c37ea3a8377fbcebe2246aae890e9df305)||`trac #23798: add tolerance gap for numerical LP solvers`||



---

archive/issue_comments_329695.json:
```json
{
    "body": "I took a quick look at the function now. I would suggest the following changes:\n\n1. Before adding a new constraint to the master problem, verify that `matching` is indeed a matching. In this way, the master problem will always be a correct relaxation, even if an inexact oracle is used.\n\n2. When the numerical solver that is used for solving the separation problem does not find a matching of value greater than 1 + epsilon, you can switch to PPL - then, with a bit of luck, it can prove the bound <= 1.\n\n3. It will make sense to have separate parameters for the solver used for the master problem and the one(s) used for the separation problem.",
    "created_at": "2021-07-19T14:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329695",
    "user": "https://github.com/mkoeppe"
}
```

I took a quick look at the function now. I would suggest the following changes:

1. Before adding a new constraint to the master problem, verify that `matching` is indeed a matching. In this way, the master problem will always be a correct relaxation, even if an inexact oracle is used.

2. When the numerical solver that is used for solving the separation problem does not find a matching of value greater than 1 + epsilon, you can switch to PPL - then, with a bit of luck, it can prove the bound <= 1.

3. It will make sense to have separate parameters for the solver used for the master problem and the one(s) used for the separation problem.



---

archive/issue_comments_329696.json:
```json
{
    "body": "Actually, it seems that even with PPL, the code is just wrong, as PPL does not do MILP, it only does LP, right?",
    "created_at": "2021-07-19T17:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329696",
    "user": "https://github.com/dimpase"
}
```

Actually, it seems that even with PPL, the code is just wrong, as PPL does not do MILP, it only does LP, right?



---

archive/issue_comments_329697.json:
```json
{
    "body": "The PPL does have a (very limited) MIP solver.",
    "created_at": "2021-07-19T18:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329697",
    "user": "https://github.com/mkoeppe"
}
```

The PPL does have a (very limited) MIP solver.



---

archive/issue_comments_329698.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-06T16:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329698",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329699.json:
```json
{
    "body": "I tried the ideas from #comment:35. I have let some code for debugging as the code may loop forever when using `GLPK` for both master and separation problems. The patchbot will complain...\n\nWe should search for another method not relying on LP solvers, if any...",
    "created_at": "2021-11-06T16:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23561#issuecomment-329699",
    "user": "https://github.com/dcoudert"
}
```

I tried the ideas from #comment:35. I have let some code for debugging as the code may loop forever when using `GLPK` for both master and separation problems. The patchbot will complain...

We should search for another method not relying on LP solvers, if any...
