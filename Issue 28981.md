# Issue 28981: vector.length() should be number of nonzero entries

archive/issues_028981.json:
```json
{
    "body": "\n```\nsage: vector([-1, 0, 2, 0]).length()  # should be 2\n4\n```\n\n\nAccording to the documentation of `length` from `modules_with_basis.py`:\n\n```\nReturn the number of basis elements whose coefficients in \"self\" are nonzero.\n```\n\n\nThis is solved by overwriting `length` in `FreeModuleElement`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29218\n\n",
    "created_at": "2020-02-18T22:54:26Z",
    "labels": [
        "linear algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "vector.length() should be number of nonzero entries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28981",
    "user": "@mwageringel"
}
```

```
sage: vector([-1, 0, 2, 0]).length()  # should be 2
4
```


According to the documentation of `length` from `modules_with_basis.py`:

```
Return the number of basis elements whose coefficients in "self" are nonzero.
```


This is solved by overwriting `length` in `FreeModuleElement`.


Issue created by migration from https://trac.sagemath.org/ticket/29218





---

archive/issue_comments_410239.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-02-18T22:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410239",
    "user": "@mwageringel"
}
```

New commits:



---

archive/issue_comments_410240.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-18T22:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410240",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410241.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-02-20T00:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410241",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_410242.json:
```json
{
    "body": "Hmmm...my initial thought was this is a good change to match the behavior as documented. However, there is an issue that does arise. The iterator for a vector is different than for a more generic element of a `ModuleWithBasis`. In the former, it goes over all values (in part because the basis is finite and has a fixed order) whereas in the latter it just goes over the supported basis elements. So for the latter, `x.length() == len(x.support())`, but I could see for a vector `v` someone doing something like\n\n```python\nfor i in range(v.length()):\n    v[i] += 1\n```\n\nSo this could break code and it is somewhat unnatural given the name of the method. I would propose instead overriding the documentation to reflect the more natural behavior because of the implementation and how people are expecting to use this class. I further believe this will be a very special case to allow the break in inherited behavior.",
    "created_at": "2020-02-20T00:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410242",
    "user": "@tscrim"
}
```

Hmmm...my initial thought was this is a good change to match the behavior as documented. However, there is an issue that does arise. The iterator for a vector is different than for a more generic element of a `ModuleWithBasis`. In the former, it goes over all values (in part because the basis is finite and has a fixed order) whereas in the latter it just goes over the supported basis elements. So for the latter, `x.length() == len(x.support())`, but I could see for a vector `v` someone doing something like

```python
for i in range(v.length()):
    v[i] += 1
```

So this could break code and it is somewhat unnatural given the name of the method. I would propose instead overriding the documentation to reflect the more natural behavior because of the implementation and how people are expecting to use this class. I further believe this will be a very special case to allow the break in inherited behavior.



---

archive/issue_comments_410243.json:
```json
{
    "body": "The method is also broken for matrices:\n\n```\nsage: matrix(QQ, 4).length()\n...\nTypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()\n```\n\nThis would be useful for sparse matrices in particular.\n\nWhat would you suggest to do with matrices then? Should it return the number of rows?\n\nGiven that the method does not currently work for matrices, it would not break anything if we make it return the length of the support, except that it is inconsistent with vectors.",
    "created_at": "2020-02-20T11:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410243",
    "user": "@mwageringel"
}
```

The method is also broken for matrices:

```
sage: matrix(QQ, 4).length()
...
TypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()
```

This would be useful for sparse matrices in particular.

What would you suggest to do with matrices then? Should it return the number of rows?

Given that the method does not currently work for matrices, it would not break anything if we make it return the length of the support, except that it is inconsistent with vectors.



---

archive/issue_comments_410244.json:
```json
{
    "body": "There is much less of a case for matrices as it is only because of the *internal* representation as rows that length has a distinct meaning. There is nothing really special about the number of rows versus columns, and it makes equal sense to have it be the size of the support. So I would instead fix matrices to be the size of the support and keep vectors as something special (and inconsistent).",
    "created_at": "2020-02-21T08:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410244",
    "user": "@tscrim"
}
```

There is much less of a case for matrices as it is only because of the *internal* representation as rows that length has a distinct meaning. There is nothing really special about the number of rows versus columns, and it makes equal sense to have it be the size of the support. So I would instead fix matrices to be the size of the support and keep vectors as something special (and inconsistent).



---

archive/issue_comments_410245.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410245",
    "user": "@mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_410246.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410246",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_410247.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410247",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_410248.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410248",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_410249.json:
```json
{
    "body": "Replying to [comment:3 Markus Wageringel]:\n> The method is also broken for matrices:\n> {{{\n> sage: matrix(QQ, 4).length()\n> ...\n> TypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()\n> }}}\n\nStill broken in 9.7.rc1. This must be some strange Cython-related effect:\n\n```\nsage: matrix(QQ, 4).length()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nInput In [6], in <cell line: 1>()\n----> 1 matrix(QQ, Integer(4)).length()\n\nFile ~/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/modules_with_basis.py:1531, in ModulesWithBasis.ElementMethods.length(self)\n   1511 def length(self):\n   1512     \"\"\"\n   1513     Return the number of basis elements whose coefficients in\n   1514     ``self`` are nonzero.\n   (...)\n   1529         4\n   1530     \"\"\"\n-> 1531     return len(self)\n\nTypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()\nsage: matrix(QQ, 4).__len__\n<bound method ModulesWithBasis.ElementMethods.__len__ of [0 0 0 0]\n[0 0 0 0]\n[0 0 0 0]\n[0 0 0 0]>\n```\n",
    "created_at": "2022-09-11T01:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28981#issuecomment-410249",
    "user": "@mkoeppe"
}
```

Replying to [comment:3 Markus Wageringel]:
> The method is also broken for matrices:
> {{{
> sage: matrix(QQ, 4).length()
> ...
> TypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()
> }}}

Still broken in 9.7.rc1. This must be some strange Cython-related effect:

```
sage: matrix(QQ, 4).length()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Input In [6], in <cell line: 1>()
----> 1 matrix(QQ, Integer(4)).length()

File ~/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/modules_with_basis.py:1531, in ModulesWithBasis.ElementMethods.length(self)
   1511 def length(self):
   1512     """
   1513     Return the number of basis elements whose coefficients in
   1514     ``self`` are nonzero.
   (...)
   1529         4
   1530     """
-> 1531     return len(self)

TypeError: object of type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense' has no len()
sage: matrix(QQ, 4).__len__
<bound method ModulesWithBasis.ElementMethods.__len__ of [0 0 0 0]
[0 0 0 0]
[0 0 0 0]
[0 0 0 0]>
```

