# Issue 16037: include system pkgconfig path

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-05-01 20:20:01




---

Comment by vbraun created at 2014-05-01 22:15:24

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2014-05-01 22:15:24

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2014-05-01 22:15:24

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-05-01 22:15:24

Changing priority from major to blocker.


---

Comment by vbraun created at 2014-05-01 22:15:24

New commits:


---

Comment by git created at 2014-05-01 22:17:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-01 23:20:16

Well, as mentioned on sage-devel,

```sh
pkg-config --variable pc_path pkg-config
```

doesn't work with all versions.

I'd also try to grep the output of `pkg-config --debug` for `Scanning ...`.


---

Comment by leif created at 2014-05-01 23:22:34


```sh
$ pkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) printf("%s%s",path[j],(j==i-1)?"\n":":") }'
/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
```


:-)

But `awk` may be `gawk` or whatever...


---

Comment by fbissey created at 2014-05-01 23:28:53

I think at this stage we should check if it works with other implementations of pkg-config. So far we are relying on it being a particular implementation if not version. As soon as my new build on power7 finishes I'll test the one currently shipping with sage.


---

Comment by leif created at 2014-05-02 00:00:49

More portable `awk` version:

```sh
pkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) if(j==i-1) printf("%s\n",path[j]); else printf("%s:",path[j]) }'
```



---

Comment by fbissey created at 2014-05-02 00:02:33

Version we ship in sage doesn't have "--debug" so our best effort so far relies on any pkg-config out there being the freedesktop version which to fair is not a bad assumption. Do we know any distro not defaulting to that?


---

Comment by fbissey created at 2014-05-02 00:05:15

Of course after saying that I realised that in Gentoo I can switch to the BSD one if I want (but freedesktop is the default). I would imagine debian would be similar, freedesktop is the default but you have an alternative.

Then again anyone savvy enough to use an alternative should be able to deal with the fall out.


---

Comment by leif created at 2014-05-02 00:24:57

One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.

(Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)

Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.


---

Comment by fbissey created at 2014-05-02 00:28:37

Replying to [comment:10 leif]:
> One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.
> 
> (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)
> 
> Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.
>  
Have you read Volker's patch? One of the first thing he does is removing any pkg-config already installed in sage. 
Since we are interested in hardcoded path in the application doing 

```
PKG_CONFIG_PATH="" pkg-config .....
```

would work.


---

Comment by leif created at 2014-05-02 00:52:17

Replying to [comment:11 fbissey]:
> Replying to [comment:10 leif]:
> > One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.
> > 
> > (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)
> > 
> > Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.
> >  
> Have you read Volker's patch?

Yes, a while ago though... m)

> One of the first thing he does is removing any pkg-config already installed in sage.

Well, "the" `pkg-config` if present.

> Since we are interested in hardcoded path in the application doing 
> {{{
> PKG_CONFIG_PATH="" pkg-config .....
> }}}
> would work.

Yep.  Or go with `(unset PKG_CONFIG_PATH; ...)`.


---

Comment by leif created at 2014-05-02 01:23:54

FWIW, here's the `--debug` version with just `sed` (one line per folder):

```sh
$ pkg-config --debug 2>&1 | sed -n '/^Scanning /s/.*'\_\([^'\_]*\)'\''/\1/p'
/usr/local/lib/pkgconfig
/usr/lib/pkgconfig
/usr/share/pkgconfig
```



---

Comment by leif created at 2014-05-02 10:55:38

One small problem:

While older versions of `pkg-config` (such as 0.15.0) exit with a _non-zero_ status when called with

```sh
pkg-config --variable pc_path pkg-config
```

some "newer" versions (still not supporting `pc_path`, such as 0.22) return 0 (and print a blank line).

So we cannot just check the exit code.


---

Comment by git created at 2014-05-02 19:01:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2014-05-02 19:06:22

Ok different approach. Instead of just creating a symlink "pkg-config", use a shell script that calls the system pkg-config if there is one.


---

Comment by leif created at 2014-05-02 19:26:30

Hmmm, that way broken `pkg-config` installations (seen on Darwin) aren't (or can't be) cured.

Anyway, why `/bin/sh`?

s/`"pkg-config" binary`/`"pkg-config" script`/

You'd have to change the error message (in case `m4` failed) accordingly.


---

Comment by leif created at 2014-05-02 19:31:20

Also, `PKG_CONFIG_PATH` gets _overwritten_.  (We already treat it correctly in `sage-env`, _pre_pending Sage's folders in case it's already set/non-empty.)


---

Comment by leif created at 2014-05-02 19:45:31

It's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.

(I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)


---

Comment by leif created at 2014-05-02 21:22:53

Replying to [comment:19 leif]:
> It's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.
> 
> (I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)

Hmmm, the only difference I see on a MacOS X system without a system-wide `pkg-config` is:

```
92c92
< checking for pkg-config... no
---
> checking for pkg-config... /Users/leif/Sage/sage-6.2.beta7/local/bin/pkg-config
497c497,498
< configure: not checking for cairo as pkg-config is not present
---
> checking whether pkg-config knows about cairo and pango... no
> checking whether pkg-config knows about cairo... no
```


So apparently R does rely on `pkg-config`, and _doesn't_ try to find libraries / packages by other means if there's no `pkg-config` at all.

Still, it would be best to tell `pkgconf` also which _system folders_ to search (in case there's no system-wide `pkg-config`), but that's even more kind of reinventing the wheel; the by far easiest (and IMHO most straight-forward) solution is to just make `pkg-config` a Sage prerequisite.  (IIRC there are pre-built binaries available for MacOS X as well; Linux and SunOS aren't a problem either.)


---

Comment by git created at 2014-05-02 22:14:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-02 22:25:13

Replying to [comment:21 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[46451c7](http://git.sagemath.org/sage.git/commit/?id=46451c79837606eb6a4e01249c751c3be20426cb)||`fix permisions, reviewer patches`||

In the generated script, we have to export the env vars.


---

Comment by leif created at 2014-05-02 22:38:30

I still wonder whether we should install our `pkg-config` at all if a system-wide one is already present (as William suggested, i.e., don't install it in that case), unless perhaps `SAGE_INSTALL_PKGCONFIG=yes`.  (I know you do like such environment variables very much.)

In the latter (hopefully rarely used or hardly necessary) case, we might even run something like

```sh
pc_folders_to_search=`find / -name \*.pc -exec dirname {} \; 2>/dev/null | sort -u`
```

(probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).


---

Comment by leif created at 2014-05-02 22:44:00

Replying to [comment:23 leif]:
> In the latter (hopefully rarely used or hardly necessary) case, we might even run something like
> {{{
> #!sh
> pc_folders_to_search=`find / -name \*.pc -exec dirname {} \; 2>/dev/null | sort -u`
> }}}
> (probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).

*Once*, upon installation, of course; putting the result somewhere into `local/var/lib/...`.


---

Comment by vbraun created at 2014-05-02 22:51:20

IMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.

Just searching all directories is wrong, this would find cross-compile toolchains etc.


---

Comment by git created at 2014-05-02 22:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-02 23:35:14

Replying to [comment:25 vbraun]:
> IMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.
> 
> Just searching all directories is wrong, this would find cross-compile toolchains etc.

Sure, but we should recommend to install a system-wide version, and probably document `PKG_CONFIG_PATH` even for those who don't have one.  (But that IMHO doesn't have to happen here and now.)

(I think unfortunately nobody reads the output of Sage's `configure` unless it bails out, so we'd have to document that elsewhere, or use `sleep`... ;-) )


---

Comment by fbissey created at 2014-05-03 01:28:15

I like the fact that you ended up moving a bit of sage-env in the script. As for the configure script, it should bail out if a hard requirement is not met that's part of its function. 

I agree with Volker that scanning for .pc is a bad idea, apart from his reasons it can take ages, especially if you have nfs share mounted. I certainly would not want to try that on my power7 cluster which has 170TB of space on a remote file system.

I thought we could have gone gcc (spkg that is) style on this one, William's idea really. But I am fine with the proposed solution.


---

Comment by vbraun created at 2014-05-03 08:06:22

Hmm `PKG_CONFIG_LIBDIR` also has the effect of not searching the compiled-in default path any more, removed.

I've added a `spkg-check` that will try to find the system pc files if we can guess their location.


---

Comment by git created at 2014-05-03 08:06:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-03 14:42:22

Hmmm, for whatever reason (shell caching I presume), I end up in an infinite loop.

Although `$SAGE_LOCAL/bin/pkg-config` gets deleted right before `m4` is called, `command -v pkg-config` apparently still gives `$SAGE_LOCAL/bin/pkg-config`, such that the script finally calls itself...

FWIW,

```sh
$ bash --version
GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
```


(I've run into similar a couple of times; the shell doesn't "see" freshly installed programs immediately.)

So it'd probably be better to call `PATH="$SAGE_ORIG_PATH" command -v pkg-config` (modifying `sage-env` accordingly, i.e., saving the original `PATH`).


---

Comment by leif created at 2014-05-03 15:17:48

Ah, yes:

```
       If  the name is neither a shell function nor a builtin, and contains no
       slashes, bash searches each element of the PATH for  a  directory  conâ€
       taining  an  executable  file  by that name.  Bash uses a hash table to
       remember the full pathnames of executable files (see hash  under  SHELL
       BUILTIN  COMMANDS  below).  A full search of the directories in PATH is
       performed only if the command is not found in the hash table. [...]
```

(And subshells inherit the cache.)





```diff
diff --git a/build/pkgs/pkgconf/spkg-install b/build/pkgs/pkgconf/spkg-install
index e31009b..166008e 100755
--- a/build/pkgs/pkgconf/spkg-install
+++ b/build/pkgs/pkgconf/spkg-install
`@``@` -38,8 +38,17 `@``@` if [ $? -ne 0 ]; then
 fi
 
 # pkgconf is an alternative to the "official" pkg-config, and does not
-# automatically install a "pkg-config" binary.
-rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version
+# automatically install a "pkg-config" binary, so we used to install
+# a symbolic link (now replaced by a wrapper script).
+rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version (script or symlink)
+
+# Let bash forget where it previously saw 'pkg-config', otherwise we might
+# end up in an infinite loop if 'command -v pkg-config' gives Sage's script,
+# such that the below generated script finally calls itself:
+builtin hash -d pkg-config 2>/dev/null
+
+# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-
+# wide 'pkg-config' if present (hardcoding its location at creation time):
 m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
 if [ $? -ne 0 ]; then
     echo >&2 "Error creating the pkg-config script."
```

doesn't yet work for me...


---

Comment by leif created at 2014-05-03 15:26:40

Changing status from needs_review to needs_work.


---

Comment by leif created at 2014-05-03 15:26:40

Ah, no, it's even weirder...  Take a _close_ look at

```sh
m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
```


Guess what happens...


---

Comment by leif created at 2014-05-03 15:29:41

... although it shouldn't be executable yet (but that also depends on the umask).


---

Comment by leif created at 2014-05-03 15:51:03

Hmmm, now works for me with

```diff
diff --git a/build/pkgs/pkgconf/patches/pkg-config.in b/build/pkgs/pkgconf/patches/pkg-config.in
index ccda223..4a00741 100644
--- a/build/pkgs/pkgconf/patches/pkg-config.in
+++ b/build/pkgs/pkgconf/patches/pkg-config.in
`@``@` -14,5 +14,5 `@``@` fi
 dnl Launch system pkg-config or our own pkgconf
 define(NEWLINE,`
 ')
-define(PKG_CONFIG_COMMAND, translit(esyscmd(`command -v pkg-config'), NEWLINE))
+define(PKG_CONFIG_COMMAND, translit(esyscmd(`bash -c "command -v pkg-config"'), NEWLINE))
 exec ifelse(sysval, `0', PKG_CONFIG_COMMAND, `"$SAGE_LOCAL/bin/pkgconf"') "$`@`"
```

(and the "forget" as before).


---

Comment by git created at 2014-05-03 16:13:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-03 16:29:45

I have no idea what's going on here; with

```sh
# pkgconf is an alternative to the "official" pkg-config, and does not
# automatically install a "pkg-config" binary, so we used to install
# a symbolic link (now replaced by a wrapper script).
rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version (script or symlink)

echo M4, shell\:
m4 <<"EOF"
translit(esyscmd(`command -v pkg-config'),`')
EOF
echo M4, bash\:
m4 <<"EOF"
translit(esyscmd(`bash -c "command -v pkg-config"'),`')
EOF

# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-
# wide 'pkg-config' if present (hardcoding its location at creation time):
m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
if [ $? -ne 0 ]; then
    echo >&2 "Error creating the pkg-config script."
    exit 1
fi

echo Generated script:
echo =================
cat "$SAGE_LOCAL/bin/pkg-config"
echo =================

chmod 755 "$SAGE_LOCAL/bin/pkg-config"
```

(and without `bash -c ...` in `pkg-config.in`), I'm always getting:

```
...
/usr/bin/install -c -m 644 ./pkgconf.1 /foo/local/share/man/man1/pkgconf.1
M4, shell:
/usr/bin/pkg-config

M4, bash:
/usr/bin/pkg-config

Generated script:
=================
#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "This script requires that SAGE_LOCAL is set."
    exit 1
fi  

if [ -z "$PKG_CONFIG_PATH" ]; then
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig"
else
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH"
fi



exec /foo/local/bin/pkg-config "$`@`"
=================

real	0m14.221s
user	0m1.716s
sys	0m0.572s
Successfully installed pkgconf-0.9.4
Running the test suite for pkgconf-0.9.4...
+-- /usr/lib/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Argument list too long
/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Success
Our pkg-config script failed to pick up fontconfig

real	0m8.012s
user	0m3.568s
sys	0m1.916s
************************************************************************
Error testing package pkgconf-0.9.4
************************************************************************
...
```



---

Comment by leif created at 2014-05-03 16:49:51

Changing status from needs_work to needs_review.


---

Comment by leif created at 2014-05-03 16:49:51

Replying to [comment:36 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[4067e95](http://git.sagemath.org/sage.git/commit/?id=4067e95b238af02153264658e848ef8f630e0932)||`avoid potential race when creating pkg-config`||

Works for me:

```
...
M4, shell:
/usr/bin/pkg-config

M4, bash:
/usr/bin/pkg-config

Generated script:
=================
#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "This script requires that SAGE_LOCAL is set."
    exit 1
fi  

if [ -z "$PKG_CONFIG_PATH" ]; then
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig"
else
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH"
fi



exec /usr/bin/pkg-config "$`@`"
=================

real	0m3.969s
user	0m1.660s
sys	0m0.572s
Successfully installed pkgconf-0.9.4
Running the test suite for pkgconf-0.9.4...
+-- /usr/lib/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
    +-- x11 found, using it for the pkg-config test.
+-- /usr/lib64/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
    +-- x11 found, using it for the pkg-config test.
+-- /usr/share/pkgconfig found, using it for the pkg-config test.
   +-- fontconfig not found, ignoring.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
   +-- x11 not found, ignoring.

real	0m0.018s
user	0m0.000s
sys	0m0.000s
```





I still don't get what goes wrong or who's to blame otherwise.




Varying indentation of found vs. ignored `.pc` files is presumably not intentional... ;-)


---

Comment by git created at 2014-05-03 17:12:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-03 17:33:48

[still testing...]

Is it intentional that the test suite fails if no system-wide `pkg-config` is installed?

(I mean, of course it should "fail", but shouldn't we skip the test in that case?)

Imagine having set `SAGE_CHECK=yes`...  (while having `sage -f -c pkgconf` fail would probably be ok)


---

Comment by leif created at 2014-05-03 17:52:56

At least something along these lines:

```diff
diff --git a/build/pkgs/pkgconf/spkg-check b/build/pkgs/pkgconf/spkg-check
index 843f6a0..9a0ecf7 100755
--- a/build/pkgs/pkgconf/spkg-check
+++ b/build/pkgs/pkgconf/spkg-check
`@``@` -1,5 +1,13 `@``@`
 #!/usr/bin/env bash
 
+if grep '$SAGE_LOCAL/bin/pkgconf' "$SAGE_LOCAL"/bin/pkg-config >/dev/null; then
+    echo "Skipping the tests, since no system-wide 'pkg-config' was present"
+    echo "when 'pkgconf' got installed."
+    echo "Remember to afterwards reinstall Sage's 'pkgconf' if you later decide"
+    echo "to install a system-wide version of 'pkg-config'."
+    exit 0
+fi
+
 # PC files that we do not ship but are likely available (mostly GUI stuff)
 pc_files="fontconfig gtk+-3.0 harfbuzz x11"
 
```


Although we could of course also really test our `pkgconf` with some (Sage-local) `.pc` files, not just the script we created.


---

Comment by leif created at 2014-05-03 18:04:55

... but actually a similar message should get printed by `spkg-install`; as is, with our current wrapper script, IMHO installing `pkgconf` at all if a system-wide `pkg-config` is present doesn't make much sense (unless we introduce e.g. `SAGE_INSTALL_PKGCONFIG`... ;-) ).


---

Comment by vbraun created at 2014-05-03 18:21:02

IMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.


---

Comment by leif created at 2014-05-03 19:08:44

Replying to [comment:43 vbraun]:
> IMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.

Well, I meant building and installing the `pkgconf` binary, not our script.


---

Comment by git created at 2014-05-03 19:42:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2014-05-03 20:14:44

Replying to [comment:45 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[f30bf95](http://git.sagemath.org/sage.git/commit/?id=f30bf954c5c83ec1802eb66f0134b9420b8f73af)||`skip checks if we do not use the system pkg-config`||

Ahem,

```
grep 'exec pkgconf ' ...
```

doesn't match

```
exec "$SAGE_LOCAL/bin/pkgconf" "$`@`"
```



---

Comment by git created at 2014-05-03 20:31:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-05-03 20:33:23

thanks, fixed!


---

Comment by leif created at 2014-05-03 20:49:06

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-05-03 20:49:06

Relief!

Although I don't like the approach taken; works as advertised, i.e., fixes the regression introduced by #15742.

And if it makes kiwifb happy...


---

Comment by leif created at 2014-05-03 20:49:06

Changing keywords from "" to "R cairo pango X11 graphics pkg-config".


---

Comment by fbissey created at 2014-05-03 22:27:39

I confirm that I am happy with this.


---

Comment by leif created at 2014-05-03 23:27:43

Replying to [comment:38 leif]:
> I still don't get what goes wrong or who's to blame otherwise.

Apparently some GNUish non-POSIX interpretation of how `command -v` is supposed to work.

Under "normal"(?) circumstances, bash (even when invoked as `/bin/sh`) returns the path of *any existing* (not necessarily executable or even readable) file "foo" found along `PATH` as the result of `command -v foo`.

In contrast, `bash --posix -c "command -v foo"` acts as expected.




That still doesn't explain why `esyscmd(`bash -c "command -v pkg-config"')` worked for me (without using a temporary file), whereas `esyscmd(`command -v pkg-config')` did not.

Digging through `strace`s, the former calls both `stat()` and `access()`, while the latter only calls `stat()` and seems to be happy with that.


---

Comment by vbraun created at 2014-05-04 13:56:17

Resolution: fixed


---

Comment by leif created at 2014-05-16 23:14:52

Since we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.

Or we reenable setting it in `sage-env`... (which I'd personally prefer)


---

Comment by leif created at 2014-05-16 23:41:24

Replying to [comment:54 leif]:
> Since we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.
> 
> Or we reenable setting it in `sage-env`... (which I'd personally prefer)

(Potential) follow-up: #16368
