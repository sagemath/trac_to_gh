# Issue 26557: Memory leak in breadth_first_search

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2018-12-01 08:00:21

CC:  jmantysalo

The following code leaks memory.

Analysis by Jori on https://groups.google.com/forum/#!topic/sage-devel/-t8ZGGiKgis

This is either critical or a blocker, because it kills the sage process eventually in heavy computations.


```
def check_bad5(n):
    """                                                                                                                                               
    sage: check_bad5(100000)                                                                                                                          
    """
    G = Graph(2)
    for i in range(n):
        x = 0 in G.breadth_first_search(0)
        if i % 10000 == 0:
            print get_memory_usage()

```



---

Comment by mantepse created at 2018-12-01 08:59:00

Changing priority from critical to major.


---

Comment by mantepse created at 2018-12-01 09:53:46

I have no idea how to doctest that.
----
New commits:


---

Comment by mantepse created at 2018-12-01 09:53:46

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2018-12-01 16:10:01

I am compiling this now.

See also https://groups.google.com/forum/#!topic/sage-devel/FKZOFpQfXNQ


---

Comment by jmantysalo created at 2018-12-01 18:10:27

Needs author name. Otherwise everything is OK, I tested and the leak is gone.


---

Comment by jmantysalo created at 2018-12-01 18:10:27

Changing status from needs_review to needs_work.


---

Comment by mantepse created at 2018-12-01 18:50:42

Do you have an idea about how to doctest this?


---

Comment by mantepse created at 2018-12-01 18:56:51

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2018-12-01 19:02:42

Replying to [comment:7 mantepse]:
> Do you have an idea about how to doctest this?

No. I don't know if there is a way to see exact memory usage.


---

Comment by jmantysalo created at 2018-12-01 19:02:42

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2018-12-01 20:29:05

Replying to [comment:9 jmantysalo]:
> Replying to [comment:7 mantepse]:
> > Do you have an idea about how to doctest this?
> 
> No. I don't know if there is a way to see exact memory usage.

a doctest like that should work

```
sage: G = Graph(2)
sage: mem = get_memory_usage()
sage: for i in range(100000):
....:    x = 0 in G.breadth_first_search(0)
....:    if not i % 10000 and mem != get_memory_usage():
....:        raise MemoryError("there is a memory leak")
```



---

Comment by mantepse created at 2018-12-02 07:56:19

I am somewhat afraid that `get_memory_usage` won't work when there are several threads.


---

Comment by jmantysalo created at 2018-12-02 08:06:30

Replying to [comment:11 mantepse]:
> I am somewhat afraid that `get_memory_usage` won't work when there are several threads.

And in any case we can't really know how much [PC]ython over-allocates memory. So for example here, is the magic number 100000 big enought now? In the future?

But I suppose that this is a problem already solved by someone else.


---

Comment by vbraun created at 2018-12-02 12:36:24

Resolution: fixed
