# Issue 21439: Inaccurate Bernoulli numbers from Flint

archive/issues_021202.json:
```json
{
    "body": "tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.\n\nOne has\n\n```\nsage: %time bflint = bernoulli(250408, algorithm='flint')\nCPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s\nWall time: 9.95 s\nsage: %time barb = bernoulli(250408, algorithm='arb')\nCPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s\nWall time: 10.3 s\nsage: %time bpari = bernoulli(250408, algorithm='pari')\nCPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s\nWall time: 11.7 s\nsage: %time bbernmm = bernoulli(250408, algorithm='bernmm')\nCPU times: user 13.3 s, sys: 0 ns, total: 13.3 s\nWall time: 13.3 s\n```\nAnd pari/arb/bernmm agrees on the answer (and disagree with flint)\n\n```\nsage: bbernmm == barb == bpari\nTrue\nsage: barb == bflint\nFalse\n```\n\nFredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288\n\nThis ticket modifies the default so that flint is used in small range, arb in intermediate range and bernmm in large range. The choice `algorithm=flint` with large input generates a warning. With the branch applied\n\n```\nsage: bernoulli(250408) == bernoulli(250408, algorithm='bernmm')\nTrue\nsage: b = bernoulli(250408, algorithm='flint')\n.../sage/arith/misc.py:368: UserWarning: flint is known to not be accurate for large Bernoulli numbers\n```\n\nCC:  @nexttime\n\nBranch/Commit: 98b9df59f4ce32d74591f2a172d335842379b4bd\n\nReviewer: Travis Scrimshaw\n\nAuthor: Vincent Delecroix\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21439\n\n",
    "closed_at": "2019-04-15T17:48:06Z",
    "created_at": "2016-09-06T15:04:01Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Inaccurate Bernoulli numbers from Flint",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21439",
    "user": "https://github.com/rwst"
}
```
tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.

One has

```
sage: %time bflint = bernoulli(250408, algorithm='flint')
CPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s
Wall time: 9.95 s
sage: %time barb = bernoulli(250408, algorithm='arb')
CPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s
Wall time: 10.3 s
sage: %time bpari = bernoulli(250408, algorithm='pari')
CPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s
Wall time: 11.7 s
sage: %time bbernmm = bernoulli(250408, algorithm='bernmm')
CPU times: user 13.3 s, sys: 0 ns, total: 13.3 s
Wall time: 13.3 s
```
And pari/arb/bernmm agrees on the answer (and disagree with flint)

```
sage: bbernmm == barb == bpari
True
sage: barb == bflint
False
```

Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288

This ticket modifies the default so that flint is used in small range, arb in intermediate range and bernmm in large range. The choice `algorithm=flint` with large input generates a warning. With the branch applied

```
sage: bernoulli(250408) == bernoulli(250408, algorithm='bernmm')
True
sage: b = bernoulli(250408, algorithm='flint')
.../sage/arith/misc.py:368: UserWarning: flint is known to not be accurate for large Bernoulli numbers
```

CC:  @nexttime

Branch/Commit: 98b9df59f4ce32d74591f2a172d335842379b4bd

Reviewer: Travis Scrimshaw

Author: Vincent Delecroix

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21439





---

archive/issue_comments_312768.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288\n+\n+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.\n \n Comment: 1\n \n```\n",
    "created_at": "2016-09-06T15:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312768",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
 Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288
+
+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.
 
 Comment: 1
 
```




---

archive/issue_comments_312769.json:
```json
{
    "body": "Changing component from number theory to numerical.",
    "created_at": "2016-09-07T07:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312769",
    "user": "https://github.com/rwst"
}
```

Changing component from number theory to numerical.



---

archive/issue_comments_312770.json:
```json
{
    "body": "<a id='comment:3'></a>We may temporarily just do what the reporter on sage-devel did, i.e., change the \"algorithm\" used (perhaps depending on the argument):\n\n```\nSince Sage uses flint as the default algorithm for n<=300000 the error\naffects Sage and can be observed, e.g., by comparing\nbernoulli(250408,'flint') and bernoulli(250408,'bernmm').\n```\n(Just noticed `algorithm=\"arb\"` is also already supported; there are various backends.)\n\nOr apply the upstream fix...",
    "created_at": "2016-09-07T11:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312770",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>We may temporarily just do what the reporter on sage-devel did, i.e., change the "algorithm" used (perhaps depending on the argument):

```
Since Sage uses flint as the default algorithm for n<=300000 the error
affects Sage and can be observed, e.g., by comparing
bernoulli(250408,'flint') and bernoulli(250408,'bernmm').
```
(Just noticed `algorithm="arb"` is also already supported; there are various backends.)

Or apply the upstream fix...



---

archive/issue_comments_312771.json:
```json
{
    "body": "<a id='comment:4'></a>Note the flint fix does not guarantee anything. It should fix the problem for all practical sizes, but there are no proven bounds. Arb guarantees the correct result up to bugs.",
    "created_at": "2016-09-07T20:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312771",
    "user": "https://trac.sagemath.org/admin/accounts/users/wbhart"
}
```

<a id='comment:4'></a>Note the flint fix does not guarantee anything. It should fix the problem for all practical sizes, but there are no proven bounds. Arb guarantees the correct result up to bugs.



---

archive/issue_events_056975.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2019-04-08T16:37:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21439#event-56975"
}
```



---

archive/issue_comments_312772.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,31 @@\n+Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288\n \n+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.\n+\n+I would say that pari/flint/arb timings are comparable but bernmm is a bit slower\n+\n+```\n+sage: %time bflint = bernoulli(250408, algorithm='flint')\n+CPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s\n+Wall time: 9.95 s\n+sage: %time barb = bernoulli(250408, algorithm='arb')\n+CPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s\n+Wall time: 10.3 s\n+sage: %time bpari = bernoulli(250408, algorithm='pari')\n+CPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s\n+Wall time: 11.7 s\n+sage: %time bbernmm = bernoulli(250408, algorithm='bernmm')\n+CPU times: user 13.3 s, sys: 0 ns, total: 13.3 s\n+Wall time: 13.3 s\n+```\n+And pari/arb/bernmm agrees on the answer (and disagree with flint)\n+\n+```\n+sage: bbernmm == barb == bpari\n+True\n+sage: barb == bflint\n+False\n+```\n \n Comment: 1\n \n```\n",
    "created_at": "2019-04-08T16:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312772",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,31 @@
+Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288
 
+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.
+
+I would say that pari/flint/arb timings are comparable but bernmm is a bit slower
+
+```
+sage: %time bflint = bernoulli(250408, algorithm='flint')
+CPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s
+Wall time: 9.95 s
+sage: %time barb = bernoulli(250408, algorithm='arb')
+CPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s
+Wall time: 10.3 s
+sage: %time bpari = bernoulli(250408, algorithm='pari')
+CPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s
+Wall time: 11.7 s
+sage: %time bbernmm = bernoulli(250408, algorithm='bernmm')
+CPU times: user 13.3 s, sys: 0 ns, total: 13.3 s
+Wall time: 13.3 s
+```
+And pari/arb/bernmm agrees on the answer (and disagree with flint)
+
+```
+sage: bbernmm == barb == bpari
+True
+sage: barb == bflint
+False
+```
 
 Comment: 1
 
```




---

archive/issue_comments_312773.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.\n \n+One has\n+\n+```\n+sage: %time bflint = bernoulli(250408, algorithm='flint')\n+CPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s\n+Wall time: 9.95 s\n+sage: %time barb = bernoulli(250408, algorithm='arb')\n+CPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s\n+Wall time: 10.3 s\n+sage: %time bpari = bernoulli(250408, algorithm='pari')\n+CPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s\n+Wall time: 11.7 s\n+sage: %time bbernmm = bernoulli(250408, algorithm='bernmm')\n+CPU times: user 13.3 s, sys: 0 ns, total: 13.3 s\n+Wall time: 13.3 s\n+```\n+And pari/arb/bernmm agrees on the answer (and disagree with flint)\n+\n+```\n+sage: bbernmm == barb == bpari\n+True\n+sage: barb == bflint\n+False\n+```\n+\n+Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288\n+\n+This ticket modifies the default so that flint is used in small range, arb in intermediate range and bernmm in large range. The choice `algorithm=flint` with large input generates a warning. With the branch applied\n+\n+```\n+sage: bernoulli(250408) == bernoulli(250408, algorithm='bernmm')\n+True\n+sage: b = bernoulli(250408, algorithm='flint')\n+.../sage/arith/misc.py:368: UserWarning: flint is known to not be accurate for large Bernoulli numbers\n+```\n \n Comment: 1\n \n```\n",
    "created_at": "2019-04-08T16:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312773",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,40 @@
+tldr: Bernoulli(250408) has a million digit denominator whose value differs by 1428094259 from the correct value.
 
+One has
+
+```
+sage: %time bflint = bernoulli(250408, algorithm='flint')
+CPU times: user 9.86 s, sys: 49.9 ms, total: 9.91 s
+Wall time: 9.95 s
+sage: %time barb = bernoulli(250408, algorithm='arb')
+CPU times: user 10.2 s, sys: 23.9 ms, total: 10.2 s
+Wall time: 10.3 s
+sage: %time bpari = bernoulli(250408, algorithm='pari')
+CPU times: user 11.6 s, sys: 36.9 ms, total: 11.7 s
+Wall time: 11.7 s
+sage: %time bbernmm = bernoulli(250408, algorithm='bernmm')
+CPU times: user 13.3 s, sys: 0 ns, total: 13.3 s
+Wall time: 13.3 s
+```
+And pari/arb/bernmm agrees on the answer (and disagree with flint)
+
+```
+sage: bbernmm == barb == bpari
+True
+sage: barb == bflint
+False
+```
+
+Fredrik Johansson advises to switch to Arb for computing Bernoulli numbers because of https://github.com/wbhart/flint2/issues/288
+
+This ticket modifies the default so that flint is used in small range, arb in intermediate range and bernmm in large range. The choice `algorithm=flint` with large input generates a warning. With the branch applied
+
+```
+sage: bernoulli(250408) == bernoulli(250408, algorithm='bernmm')
+True
+sage: b = bernoulli(250408, algorithm='flint')
+.../sage/arith/misc.py:368: UserWarning: flint is known to not be accurate for large Bernoulli numbers
+```
 
 Comment: 1
 
```




---

archive/issue_comments_312774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-08T16:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312774",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_312775.json:
```json
{
    "body": "<a id='comment:7'></a>New commits:",
    "created_at": "2019-04-08T16:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312775",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>New commits:



---

archive/issue_comments_312776.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:4 wbhart]:\n> Note the flint fix does not guarantee anything. It should fix the problem for all practical sizes, but there are no proven bounds. Arb guarantees the correct result up to bugs.\n\n\nAll values n <= 20000 currently used in the thresholds have been tested one by one. So that there is a guarantee (until we upgrade flint :-).",
    "created_at": "2019-04-08T16:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312776",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Replying to [comment:4 wbhart]:
> Note the flint fix does not guarantee anything. It should fix the problem for all practical sizes, but there are no proven bounds. Arb guarantees the correct result up to bugs.


All values n <= 20000 currently used in the thresholds have been tested one by one. So that there is a guarantee (until we upgrade flint :-).



---

archive/issue_comments_312777.json:
```json
{
    "body": "<a id='comment:9'></a>LGTM.",
    "created_at": "2019-04-12T08:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312777",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>LGTM.



---

archive/issue_comments_312778.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-12T08:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312778",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_312779.json:
```json
{
    "body": "<a id='comment:10'></a>thanks",
    "created_at": "2019-04-12T08:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312779",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>thanks



---

archive/issue_comments_312780.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-15T17:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21439#issuecomment-312780",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056976.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-15T17:48:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21439",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21439#event-56976"
}
```
