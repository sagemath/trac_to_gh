# Issue 21993: Polyhedron.integral_points(): OverflowError: value too large to convert to int

archive/issues_021756.json:
```json
{
    "body": "I noticed the following bug in Sage:\n\n```\nsage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()\n...\n/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)\n   4357                 box_points<threshold:\n   4358             from sage.geometry.integral_points import rectangular_box_points\n-> 4359             return rectangular_box_points(box_min, box_max, self)\n   4360 \n   4361         # for more complicate polytopes, triangulate & use smith normal form\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()\n    552     v = vector(ZZ, d)\n    553     if not return_saturated:\n--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):\n    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow\n    556             for i in range(0,d):\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()\n    601     while True:\n    602         sig_check()\n--> 603         inequalities.prepare_inner_loop(p)\n    604         i_min = box_min[0]\n    605         i_max = box_max[0]\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()\n   1256         \"\"\"\n   1257         for ineq in self.ineqs_int:\n-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)\n   1259         for ineq in self.ineqs_generic:\n   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()\n    938         cdef int j\n    939         if self.dim>1:\n--> 940             self.cache = self.cache_next + self.coeff_next*p[1]\n    941         else:\n    942             self.cache = self.cache_next\n\nOverflowError: value too large to convert to int\n```\n\n(Note that this example would not get far with the code in Sage anyway because the code tries to use the rectangle bounding box method for all non-integral polytopes.)\n\n\nCC:  @novoselt @tscrim @vbraun @videlec tmonteil @jplab\n\nKeywords: thursdaysbdx\n\nBranch/Commit: 76cd1ea370076c04901fe331760839d6c0166cf4\n\nReviewer: S\u00e9bastien Labb\u00e9\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21993\n\n",
    "closed_at": "2017-05-13T10:33:33Z",
    "created_at": "2016-11-29T19:07:52Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Polyhedron.integral_points(): OverflowError: value too large to convert to int",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21993",
    "user": "https://github.com/mkoeppe"
}
```
I noticed the following bug in Sage:

```
sage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()
...
/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)
   4357                 box_points<threshold:
   4358             from sage.geometry.integral_points import rectangular_box_points
-> 4359             return rectangular_box_points(box_min, box_max, self)
   4360 
   4361         # for more complicate polytopes, triangulate & use smith normal form

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()
    552     v = vector(ZZ, d)
    553     if not return_saturated:
--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):
    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow
    556             for i in range(0,d):

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()
    601     while True:
    602         sig_check()
--> 603         inequalities.prepare_inner_loop(p)
    604         i_min = box_min[0]
    605         i_max = box_max[0]

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()
   1256         """
   1257         for ineq in self.ineqs_int:
-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)
   1259         for ineq in self.ineqs_generic:
   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()
    938         cdef int j
    939         if self.dim>1:
--> 940             self.cache = self.cache_next + self.coeff_next*p[1]
    941         else:
    942             self.cache = self.cache_next

OverflowError: value too large to convert to int
```

(Note that this example would not get far with the code in Sage anyway because the code tries to use the rectangle bounding box method for all non-integral polytopes.)


CC:  @novoselt @tscrim @vbraun @videlec tmonteil @jplab

Keywords: thursdaysbdx

Branch/Commit: 76cd1ea370076c04901fe331760839d6c0166cf4

Reviewer: Sébastien Labbé

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21993





---

archive/issue_comments_406535.json:
```json
{
    "body": "<a id='comment:1'></a>Do you have a doctest to propose that takes less time to run?\n\n---\nNew commits:",
    "created_at": "2016-12-11T21:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406535",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:1'></a>Do you have a doctest to propose that takes less time to run?

---
New commits:



---

archive/issue_comments_406536.json:
```json
{
    "body": "Changing branch from \"\" to \"u/slabbe/21993\"",
    "created_at": "2016-12-11T21:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406536",
    "user": "https://github.com/seblabbe"
}
```

Changing branch from "" to "u/slabbe/21993"



---

archive/issue_comments_406537.json:
```json
{
    "body": "Changing commit from \"\" to \"bb912600c0f96279db35b7d93664cbd5d2be72f0\"",
    "created_at": "2016-12-11T21:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406537",
    "user": "https://github.com/seblabbe"
}
```

Changing commit from "" to "bb912600c0f96279db35b7d93664cbd5d2be72f0"



---

archive/issue_events_057930.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-05-07T01:09:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21993#event-57930"
}
```



---

archive/issue_comments_406538.json:
```json
{
    "body": "<a id='comment:3'></a>I don't think this is the correct fix -- after all, `Inequality_int` is supposed to be a fast implementation for the case that everything fits in an `int`. Just checking it (in `Inequality_int.__cinit__`) seems buggy.",
    "created_at": "2017-05-07T03:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406538",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>I don't think this is the correct fix -- after all, `Inequality_int` is supposed to be a fast implementation for the case that everything fits in an `int`. Just checking it (in `Inequality_int.__cinit__`) seems buggy.



---

archive/issue_comments_406539.json:
```json
{
    "body": "Changing branch from \"u/slabbe/21993\" to \"u/mkoeppe/21993\"",
    "created_at": "2017-05-07T04:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406539",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "u/slabbe/21993" to "u/mkoeppe/21993"



---

archive/issue_comments_406540.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2017-05-07T04:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406540",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_406541.json:
```json
{
    "body": "Changing commit from \"bb912600c0f96279db35b7d93664cbd5d2be72f0\" to \"76cd1ea370076c04901fe331760839d6c0166cf4\"",
    "created_at": "2017-05-07T04:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406541",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "bb912600c0f96279db35b7d93664cbd5d2be72f0" to "76cd1ea370076c04901fe331760839d6c0166cf4"



---

archive/issue_comments_406542.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-07T04:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406542",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406543.json:
```json
{
    "body": "<a id='comment:5'></a>Here's a fix (with doctest) for the actual bug.\nNeeds review.\n\n---\nNew commits:",
    "created_at": "2017-05-07T04:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406543",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Here's a fix (with doctest) for the actual bug.
Needs review.

---
New commits:



---

archive/issue_comments_406544.json:
```json
{
    "body": "<a id='comment:7'></a>It works. The command \n\n```\nsage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + \n....: 1/1000*polytopes.hypercube(2)).integral_points()\n```\nnow takes forever (without error in the first minutes):)",
    "created_at": "2017-05-11T10:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406544",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:7'></a>It works. The command 

```
sage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 
....: 1/1000*polytopes.hypercube(2)).integral_points()
```
now takes forever (without error in the first minutes):)



---

archive/issue_comments_406545.json:
```json
{
    "body": "Changing reviewer from \"\" to \"S\u00e9bastien Labb\u00e9\"",
    "created_at": "2017-05-11T10:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406545",
    "user": "https://github.com/seblabbe"
}
```

Changing reviewer from "" to "Sébastien Labbé"



---

archive/issue_comments_406546.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-11T10:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406546",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406547.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2017-05-11T15:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406547",
    "user": "https://github.com/seblabbe"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_406548.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/21993\" to \"76cd1ea370076c04901fe331760839d6c0166cf4\"",
    "created_at": "2017-05-13T10:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406548",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/21993" to "76cd1ea370076c04901fe331760839d6c0166cf4"



---

archive/issue_comments_406549.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-13T10:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21993#issuecomment-406549",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_057931.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-13T10:33:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21993",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21993#event-57931"
}
```
