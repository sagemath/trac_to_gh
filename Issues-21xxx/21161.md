# Issue 21161: repr of NumberFields (the parents) should indicate its embedding if there is one

archive/issues_020924.json:
```json
{
    "body": "As discussed in #21105, number fields with coercion embeddings, in particular with real embeddings, behave quite differently from those without - but there's no indication of embeddings in the print representation:\n\n```\nsage: K.<a> = NumberField(x^2 - 2)\nsage: a.parent()\nNumber Field in a with defining polynomial x^2 - 2\nsage: K.<sqrt2> = NumberField(x^2 - 2, embedding=1.4)\nsage: sqrt2.parent()\nNumber Field in sqrt2 with defining polynomial x^2 - 2\n```\n\nThis ticket changes the print representation when there is an embedding as follows.\n\n```\nNumber Field in a with defining polynomial x^13 - 2/3*x + 3 with a = -1.106745229567614?\n```\nThis also works well for more complicated situations such as this one:\n\n```\n            sage: K.<a> = NumberField(x^4 - 3); K\n            Number Field in a with defining polynomial x^4 - 3\n            sage: H.<b>, from_H = K.subfield(a^2)\n            sage: H\n            Number Field in b with defining polynomial x^2 - 3 with b = a^2\n```\n\n\nCC:  @videlec @jplab @JohnCremona @tscrim @mezzarobba @jdemeyer\n\nKeywords: number field\n\nReviewer: Jean-Philippe Labb\u00e9\n\nAuthor: Matthias Koeppe\n\nBranch: d404006b1ecdbeb5c4a70b5f43301541ae3c50f7\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21161\n\n",
    "closed_at": "2019-05-28T21:07:55Z",
    "created_at": "2016-08-03T23:12:14Z",
    "labels": [
        "component: number fields"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "repr of NumberFields (the parents) should indicate its embedding if there is one",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21161",
    "user": "https://github.com/mkoeppe"
}
```
As discussed in #21105, number fields with coercion embeddings, in particular with real embeddings, behave quite differently from those without - but there's no indication of embeddings in the print representation:

```
sage: K.<a> = NumberField(x^2 - 2)
sage: a.parent()
Number Field in a with defining polynomial x^2 - 2
sage: K.<sqrt2> = NumberField(x^2 - 2, embedding=1.4)
sage: sqrt2.parent()
Number Field in sqrt2 with defining polynomial x^2 - 2
```

This ticket changes the print representation when there is an embedding as follows.

```
Number Field in a with defining polynomial x^13 - 2/3*x + 3 with a = -1.106745229567614?
```
This also works well for more complicated situations such as this one:

```
            sage: K.<a> = NumberField(x^4 - 3); K
            Number Field in a with defining polynomial x^4 - 3
            sage: H.<b>, from_H = K.subfield(a^2)
            sage: H
            Number Field in b with defining polynomial x^2 - 3 with b = a^2
```


CC:  @videlec @jplab @JohnCremona @tscrim @mezzarobba @jdemeyer

Keywords: number field

Reviewer: Jean-Philippe Labb√©

Author: Matthias Koeppe

Branch: d404006b1ecdbeb5c4a70b5f43301541ae3c50f7

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21161





---

archive/issue_comments_288946.json:
```json
{
    "body": "<a id='comment:2'></a>Shorter sentence would be better.\n\n```\nReal Number Field in sqrt2 as the root of x^2 - 2 in [1.41, 1.42]\n```\nIdeally (as above), the `X` in `near X` should have the form of an interval `[1.41,1.42]` that specifies uniquely the root.",
    "created_at": "2016-08-03T23:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288946",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>Shorter sentence would be better.

```
Real Number Field in sqrt2 as the root of x^2 - 2 in [1.41, 1.42]
```
Ideally (as above), the `X` in `near X` should have the form of an interval `[1.41,1.42]` that specifies uniquely the root.



---

archive/issue_comments_288947.json:
```json
{
    "body": "<a id='comment:3'></a>Or possibly\n\n```\nReal Number Field in sqrt2=1.41421356237309? with defining polynomial x^2 - 2\n```",
    "created_at": "2016-08-03T23:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288947",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>Or possibly

```
Real Number Field in sqrt2=1.41421356237309? with defining polynomial x^2 - 2
```



---

archive/issue_comments_288948.json:
```json
{
    "body": "<a id='comment:4'></a>`AlgebraicGenerator` (from `qqbar`) uses \n\n```\n   Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?\n```",
    "created_at": "2016-08-03T23:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288948",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>`AlgebraicGenerator` (from `qqbar`) uses 

```
   Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?
```



---

archive/issue_comments_288949.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 mkoeppe]:\n> `AlgebraicGenerator` (from `qqbar`) uses \n> \n> ```\n>    Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?\n> ```\n\n\nWhich is not that bad except the `a in 1.618033988749895?`. Would make more sense with `a in [1.61, 1.62]` or `a = 1.618033988749895?`.",
    "created_at": "2016-08-03T23:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288949",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Replying to [comment:4 mkoeppe]:
> `AlgebraicGenerator` (from `qqbar`) uses 
> 
> ```
>    Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?
> ```


Which is not that bad except the `a in 1.618033988749895?`. Would make more sense with `a in [1.61, 1.62]` or `a = 1.618033988749895?`.



---

archive/issue_comments_288950.json:
```json
{
    "body": "<a id='comment:7'></a>This should work for number fields with a real embedding as well as a complex one. The interval notation is painful for the latter, so \"with a=...\" would probably work better. Also good if we end up with number fields with a p-adic embedding specified:\n\n```\nK.<a>=NumberField(x^2+1,embedding=pAdicField(5)(-1).sqrt())\n```",
    "created_at": "2019-02-09T21:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288950",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>This should work for number fields with a real embedding as well as a complex one. The interval notation is painful for the latter, so "with a=..." would probably work better. Also good if we end up with number fields with a p-adic embedding specified:

```
K.<a>=NumberField(x^2+1,embedding=pAdicField(5)(-1).sqrt())
```



---

archive/issue_comments_288951.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-22T14:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288951",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288952.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-22T14:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288952",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288953.json:
```json
{
    "body": "<a id='comment:11'></a>In this patch I am using a format with `with a = ...` now (as suggested by nbruin), which works well also for the complex case:\n\n```\nNumber Field in a with defining polynomial x^13 - 2/3*x + 3 with a = -1.106745229567614?\n```\nand for more complicated situations such as this one:\n\n```\n            sage: K.<a> = NumberField(x^4 - 3); K\n            Number Field in a with defining polynomial x^4 - 3\n            sage: H.<b>, from_H = K.subfield(a^2)\n            sage: H\n            Number Field in b with defining polynomial x^2 - 3 with b = a^2\n```\n\nThe output for the following looks a bit strange because printing goes through `sage.rings.real_lazy.LazyBinop`:\n\n```\nsage: QuadraticField(-1, 'a')\nNumber Field in a with defining polynomial x^2 + 1 with a = 1*I\n```\nShould we special case this?",
    "created_at": "2019-04-22T22:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288953",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>In this patch I am using a format with `with a = ...` now (as suggested by nbruin), which works well also for the complex case:

```
Number Field in a with defining polynomial x^13 - 2/3*x + 3 with a = -1.106745229567614?
```
and for more complicated situations such as this one:

```
            sage: K.<a> = NumberField(x^4 - 3); K
            Number Field in a with defining polynomial x^4 - 3
            sage: H.<b>, from_H = K.subfield(a^2)
            sage: H
            Number Field in b with defining polynomial x^2 - 3 with b = a^2
```

The output for the following looks a bit strange because printing goes through `sage.rings.real_lazy.LazyBinop`:

```
sage: QuadraticField(-1, 'a')
Number Field in a with defining polynomial x^2 + 1 with a = 1*I
```
Should we special case this?



---

archive/issue_comments_288954.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T22:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288954",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288955.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-22T22:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288955",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_events_056449.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-04-22T22:07:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21161#event-56449"
}
```



---

archive/issue_comments_288956.json:
```json
{
    "body": "Changing keywords from \"\" to \"number field\".",
    "created_at": "2019-04-23T09:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288956",
    "user": "https://github.com/jplab"
}
```

Changing keywords from "" to "number field".



---

archive/issue_comments_288957.json:
```json
{
    "body": "<a id='comment:14'></a>The patchbot gave 2 pyflakes warnings, I repaired one of them, the other one I can not make sure that it does not have side effects.\n\nOtherwise, the patchbot is happy and the resolution looks reasonable. I set it as positive review, if you agree `@`mkoeppe.\n\n---\nNew commits:",
    "created_at": "2019-04-23T09:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288957",
    "user": "https://github.com/jplab"
}
```

<a id='comment:14'></a>The patchbot gave 2 pyflakes warnings, I repaired one of them, the other one I can not make sure that it does not have side effects.

Otherwise, the patchbot is happy and the resolution looks reasonable. I set it as positive review, if you agree `@`mkoeppe.

---
New commits:



---

archive/issue_comments_288958.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-23T09:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288958",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288959.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-23T09:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288959",
    "user": "https://github.com/jplab"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_288960.json:
```json
{
    "body": "<a id='comment:15'></a>Whoooops!",
    "created_at": "2019-04-23T09:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288960",
    "user": "https://github.com/jplab"
}
```

<a id='comment:15'></a>Whoooops!



---

archive/issue_comments_288961.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-23T12:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288961",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288962.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-23T12:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288962",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_288963.json:
```json
{
    "body": "<a id='comment:17'></a>Let's see if the bot finds more. I hope I did not forget any...",
    "created_at": "2019-04-23T12:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288963",
    "user": "https://github.com/jplab"
}
```

<a id='comment:17'></a>Let's see if the bot finds more. I hope I did not forget any...



---

archive/issue_comments_288964.json:
```json
{
    "body": "<a id='comment:18'></a>Failing doctests",
    "created_at": "2019-04-24T05:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288964",
    "user": "https://github.com/jplab"
}
```

<a id='comment:18'></a>Failing doctests



---

archive/issue_comments_288965.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-04-24T05:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288965",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_288966.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-25T08:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288966",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288967.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-25T08:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288967",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_288968.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-25T10:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288968",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288969.json:
```json
{
    "body": "<a id='comment:23'></a>```\nsage -t --long src/sage/modular/local_comp/smoothchar.py\n**********************************************************************\nFile \"src/sage/modular/local_comp/smoothchar.py\", line 461, in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_\nFailed example:\n    G.coerce(GK.character(0, [4]))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_[7]>\", line 1, in <module>\n        G.coerce(GK.character(Integer(0), [Integer(4)]))\n      File \"sage/structure/parent.pyx\", line 1114, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10541)\n        cpdef coerce(self, x):\n      File \"sage/structure/parent.pyx\", line 1144, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10470)\n        raise TypeError(_LazyString(_lazy_format, (\"no canonical coercion from %s to %s\", parent(x), self), {}))\n    TypeError: no canonical coercion from Group of smooth characters of Q_3* with values in Number Field in i with defining polynomial x^2 + 1 with i = 1*I to Group of smooth characters of Q_3* with values in Rational Field\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_\n    [303 tests, 1 failure, 2.58 s]\nsage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py\n**********************************************************************\nFile \"src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py\", line 177, in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest\nFailed example:\n    for A in [QQ, ComplexField(16), GF(5), QQ[sqrt(2)]]:\n        print(str(A) + \":\")\n        print(A['x'](p).factor())\nExpected:\n    Rational Field:\n    (54) * (x + 1/3)^2 * (x^2 - 2)\n    Complex Field with 16 bits of precision:\n    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)\n    Finite Field of size 5:\n    (4) * (x + 2)^2 * (x^2 + 3)\n    Number Field in sqrt2 with defining polynomial x^2 - 2:\n    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2\nGot:\n    Rational Field:\n    (54) * (x + 1/3)^2 * (x^2 - 2)\n    Complex Field with 16 bits of precision:\n    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)\n    Finite Field of size 5:\n    (4) * (x + 2)^2 * (x^2 + 3)\n    Number Field in sqrt2 with defining polynomial x^2 - 2 with sqrt2 = 1.414213562373095?:\n    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2\n**********************************************************************\n1 item had failures:\n   1 of 111 in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest\n    [110 tests, 1 failure, 0.96 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/modular/local_comp/smoothchar.py  # 1 doctest failed\nsage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nThe first one seems to be taken care of but not the second one.",
    "created_at": "2019-04-25T13:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288969",
    "user": "https://github.com/jplab"
}
```

<a id='comment:23'></a>```
sage -t --long src/sage/modular/local_comp/smoothchar.py
**********************************************************************
File "src/sage/modular/local_comp/smoothchar.py", line 461, in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_
Failed example:
    G.coerce(GK.character(0, [4]))
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_[7]>", line 1, in <module>
        G.coerce(GK.character(Integer(0), [Integer(4)]))
      File "sage/structure/parent.pyx", line 1114, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10541)
        cpdef coerce(self, x):
      File "sage/structure/parent.pyx", line 1144, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10470)
        raise TypeError(_LazyString(_lazy_format, ("no canonical coercion from %s to %s", parent(x), self), {}))
    TypeError: no canonical coercion from Group of smooth characters of Q_3* with values in Number Field in i with defining polynomial x^2 + 1 with i = 1*I to Group of smooth characters of Q_3* with values in Rational Field
**********************************************************************
1 item had failures:
   1 of  14 in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_
    [303 tests, 1 failure, 2.58 s]
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py
**********************************************************************
File "src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py", line 177, in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest
Failed example:
    for A in [QQ, ComplexField(16), GF(5), QQ[sqrt(2)]]:
        print(str(A) + ":")
        print(A['x'](p).factor())
Expected:
    Rational Field:
    (54) * (x + 1/3)^2 * (x^2 - 2)
    Complex Field with 16 bits of precision:
    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)
    Finite Field of size 5:
    (4) * (x + 2)^2 * (x^2 + 3)
    Number Field in sqrt2 with defining polynomial x^2 - 2:
    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2
Got:
    Rational Field:
    (54) * (x + 1/3)^2 * (x^2 - 2)
    Complex Field with 16 bits of precision:
    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)
    Finite Field of size 5:
    (4) * (x + 2)^2 * (x^2 + 3)
    Number Field in sqrt2 with defining polynomial x^2 - 2 with sqrt2 = 1.414213562373095?:
    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2
**********************************************************************
1 item had failures:
   1 of 111 in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest
    [110 tests, 1 failure, 0.96 s]
----------------------------------------------------------------------
sage -t --long src/sage/modular/local_comp/smoothchar.py  # 1 doctest failed
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed
----------------------------------------------------------------------
```

The first one seems to be taken care of but not the second one.



---

archive/issue_comments_288970.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-26T15:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288971.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-26T15:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288971",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288972.json:
```json
{
    "body": "<a id='comment:26'></a>Fixed these two.",
    "created_at": "2019-04-26T15:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288972",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Fixed these two.



---

archive/issue_comments_288973.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-16T17:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288973",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_288974.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-18T14:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288974",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288975.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-18T15:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288975",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_288976.json:
```json
{
    "body": "<a id='comment:32'></a>There are only 6 failing doctests. That's not bad!\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/rings/qqbar.py  # 5 doctests failed\nsage -t --long src/sage/rings/number_field/order.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2019-05-22T16:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288976",
    "user": "https://github.com/jplab"
}
```

<a id='comment:32'></a>There are only 6 failing doctests. That's not bad!

```
----------------------------------------------------------------------
sage -t --long src/sage/rings/qqbar.py  # 5 doctests failed
sage -t --long src/sage/rings/number_field/order.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_288977.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-22T16:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288977",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_288978.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-23T02:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288979.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-23T02:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288979",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_288980.json:
```json
{
    "body": "<a id='comment:35'></a>Looks good to me. The tests seem to pass on the latest beta and the pyflakes errors are not regressions. I set this to positive review.",
    "created_at": "2019-05-25T10:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288980",
    "user": "https://github.com/jplab"
}
```

<a id='comment:35'></a>Looks good to me. The tests seem to pass on the latest beta and the pyflakes errors are not regressions. I set this to positive review.



---

archive/issue_comments_288981.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-25T10:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288981",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288982.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-28T21:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288982",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056450.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-28T21:07:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21161#event-56450"
}
```



---

archive/issue_comments_288983.json:
```json
{
    "body": "<a id='comment:37'></a>This ticket is probably causing (randomly) **infinite loops** on several patchbots.\n\nFor example, see\n\nhttps://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short\n\nEDIT:\nthe problematic doctest is\n\n```\nFile \"src/sage/structure/parent.pyx\", line 1734, in sage.structure.parent.Parent.hom.register_embedding\nFailed example:\n    K.coerce_embedding()(a)\nException raised:\n...\nRuntimeError: maximum recursion depth exceeded while calling a Python object\n```",
    "created_at": "2019-06-20T15:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288983",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:37'></a>This ticket is probably causing (randomly) **infinite loops** on several patchbots.

For example, see

https://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short

EDIT:
the problematic doctest is

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
Exception raised:
...
RuntimeError: maximum recursion depth exceeded while calling a Python object
```



---

archive/issue_comments_288984.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 chapoton]:\n> This ticket is probably causing (randomly) **infinite loops** on several patchbots.\n> \n> For example, see\n> \n> https://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short\n> \n> EDIT:\n> the problematic doctest is\n> \n> ```\n> File \"src/sage/structure/parent.pyx\", line 1734, in sage.structure.parent.Parent.hom.register_embedding\n> Failed example:\n>     K.coerce_embedding()(a)\n> Exception raised:\n> ...\n> RuntimeError: maximum recursion depth exceeded while calling a Python object\n> ```\n\n\nThe source code that changed is\n\n```diff\n--- a/src/sage/rings/number_field/number_field.py\n+++ b/src/sage/rings/number_field/number_field.py\n@@ -3087,9 +3089,16 @@ class NumberField_generic(WithEqualityById, number_field_base.NumberField):\n         \"\"\"\n-        return \"Number Field in %s with defining polynomial %s\"%(\n-                   self.variable_name(), self.polynomial())\n+        result = \"Number Field in {} with defining polynomial {}\".format(self.variable_name(), self.polynomial())\n+        gen = self.gen_embedding()\n+        if gen is not None:\n+            result += \" with {} = {}\".format(self.variable_name(), gen)\n+        return result\n```\n\nThe rest of the diff consist of adapting the doctests. Where could the infinite loop come from? Hmm.",
    "created_at": "2019-06-21T09:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288984",
    "user": "https://github.com/jplab"
}
```

<a id='comment:38'></a>Replying to [comment:37 chapoton]:
> This ticket is probably causing (randomly) **infinite loops** on several patchbots.
> 
> For example, see
> 
> https://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short
> 
> EDIT:
> the problematic doctest is
> 
> ```
> File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
> Failed example:
>     K.coerce_embedding()(a)
> Exception raised:
> ...
> RuntimeError: maximum recursion depth exceeded while calling a Python object
> ```


The source code that changed is

```diff
--- a/src/sage/rings/number_field/number_field.py
+++ b/src/sage/rings/number_field/number_field.py
@@ -3087,9 +3089,16 @@ class NumberField_generic(WithEqualityById, number_field_base.NumberField):
         """
-        return "Number Field in %s with defining polynomial %s"%(
-                   self.variable_name(), self.polynomial())
+        result = "Number Field in {} with defining polynomial {}".format(self.variable_name(), self.polynomial())
+        gen = self.gen_embedding()
+        if gen is not None:
+            result += " with {} = {}".format(self.variable_name(), gen)
+        return result
```

The rest of the diff consist of adapting the doctests. Where could the infinite loop come from? Hmm.



---

archive/issue_comments_288985.json:
```json
{
    "body": "<a id='comment:39'></a>It appears that using the embedding in the repr is a very bad idea...\n\nEven when this problematic doctest works, calling\n\n```\nK.coerce_embedding()\n```\nafter this doctest makes sage crash..\nAnd the culprit are really those 2 \"innocent\" added lines..",
    "created_at": "2019-06-21T09:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288985",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:39'></a>It appears that using the embedding in the repr is a very bad idea...

Even when this problematic doctest works, calling

```
K.coerce_embedding()
```
after this doctest makes sage crash..
And the culprit are really those 2 "innocent" added lines..



---

archive/issue_comments_288986.json:
```json
{
    "body": "<a id='comment:40'></a>I have made #28036 to revert the changes made here.",
    "created_at": "2019-06-21T11:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288986",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:40'></a>I have made #28036 to revert the changes made here.



---

archive/issue_comments_288987.json:
```json
{
    "body": "<a id='comment:41'></a>Maybe changing this line would be a way out:\n\n```\nreturn copy(self._embedding) # It might be overkill to make a copy here\n```",
    "created_at": "2019-06-21T12:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21161#issuecomment-288987",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:41'></a>Maybe changing this line would be a way out:

```
return copy(self._embedding) # It might be overkill to make a copy here
```
