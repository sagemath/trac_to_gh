# Issue 21874: Make autogen/pari Python 3 compatible

archive/issues_021637.json:
```json
{
    "body": "\n\nCC:  @defeo @fchapoton\n\nBranch/Commit: 07d262ad2bef1bfe9387ebb885ff773bcab219a0\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21874\n\n",
    "closed_at": "2016-11-19T16:34:52Z",
    "created_at": "2016-11-13T22:49:19Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Make autogen/pari Python 3 compatible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21874",
    "user": "https://github.com/jdemeyer"
}
```


CC:  @defeo @fchapoton

Branch/Commit: 07d262ad2bef1bfe9387ebb885ff773bcab219a0

Reviewer: Jeroen Demeyer

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21874





---

archive/issue_comments_319948.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2016-11-14T18:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319948",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_319949.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-14T18:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319949",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319950.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-14T19:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319950",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319951.json:
```json
{
    "body": "<a id='comment:3'></a>should be good now. Works for python3, not checked for python2.",
    "created_at": "2016-11-14T19:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319951",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>should be good now. Works for python3, not checked for python2.



---

archive/issue_comments_319952.json:
```json
{
    "body": "<a id='comment:4'></a>Doctest failure, see patchbot.",
    "created_at": "2016-11-16T12:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319952",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Doctest failure, see patchbot.



---

archive/issue_comments_319953.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-16T12:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319953",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_319954.json:
```json
{
    "body": "<a id='comment:5'></a>The \"native\" format for filenames is `bytes`. So it seems silly to convert `bytes` to `unicode` and then let Python convert it back to `bytes`. Just drop the `.decode()`.",
    "created_at": "2016-11-16T13:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319954",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>The "native" format for filenames is `bytes`. So it seems silly to convert `bytes` to `unicode` and then let Python convert it back to `bytes`. Just drop the `.decode()`.



---

archive/issue_comments_319955.json:
```json
{
    "body": "<a id='comment:6'></a>elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()",
    "created_at": "2016-11-16T14:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319955",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()



---

archive/issue_comments_319956.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-16T14:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319956",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319957.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-16T14:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319957",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_319958.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:6 chapoton]:\n> elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()\n\n\nThat string should then also be `bytes`.",
    "created_at": "2016-11-16T14:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319958",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:6 chapoton]:
> elsewhere in the code, one takes the sum (+) of datadir and a string, so one needs the decode()


That string should then also be `bytes`.



---

archive/issue_comments_319959.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-16T14:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319959",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_319960.json:
```json
{
    "body": "<a id='comment:10'></a>> The \"native\" format for filenames is `bytes`.\n\n\nAre you sure about this? In Python 3.5\n\n```\n>>> import os\n>>> type(os.listdir('.')[0])\nstr\n```",
    "created_at": "2016-11-16T14:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319960",
    "user": "https://github.com/defeo"
}
```

<a id='comment:10'></a>> The "native" format for filenames is `bytes`.


Are you sure about this? In Python 3.5

```
>>> import os
>>> type(os.listdir('.')[0])
str
```



---

archive/issue_comments_319961.json:
```json
{
    "body": "<a id='comment:11'></a>`listdir` outputs `str` when given `str` and `bytes` when given `bytes`:\n\n```\n>>> import os\n>>> type(os.listdir(b'.')[0])\n<class 'bytes'>\n```\n\n```\n>>> import os\n>>> type(os.listdir('.')[0])\n<class 'str'>\n```",
    "created_at": "2016-11-16T14:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319961",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>`listdir` outputs `str` when given `str` and `bytes` when given `bytes`:

```
>>> import os
>>> type(os.listdir(b'.')[0])
<class 'bytes'>
```

```
>>> import os
>>> type(os.listdir('.')[0])
<class 'str'>
```



---

archive/issue_comments_319962.json:
```json
{
    "body": "<a id='comment:12'></a>See https://docs.python.org/3/howto/unicode.html#unicode-filenames\n\nNote the sentence \"When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you\". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.",
    "created_at": "2016-11-16T14:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319962",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>See https://docs.python.org/3/howto/unicode.html#unicode-filenames

Note the sentence "When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.



---

archive/issue_comments_319963.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:\n> See https://docs.python.org/3/howto/unicode.html#unicode-filenames\n> \n> Note the sentence \"When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you\". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.\n\n\nBut handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.\n\nI do not even dare imagine what would happen with a WIN-1252-encoded fat filesystem mounted inside a ISO-8859 locale (these things can happen with usb keys...).",
    "created_at": "2016-11-16T15:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319963",
    "user": "https://github.com/defeo"
}
```

<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:
> See https://docs.python.org/3/howto/unicode.html#unicode-filenames
> 
> Note the sentence "When opening a file for reading or writing, you can usually just provide the Unicode string as the filename, and it will be automatically converted to the right encoding for you". This means that Python does a conversion of encoding, so it makes sense to use `bytes` for filenames to avoid conversions.


But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.

I do not even dare imagine what would happen with a WIN-1252-encoded fat filesystem mounted inside a ISO-8859 locale (these things can happen with usb keys...).



---

archive/issue_comments_319964.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 defeo]:\n> But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.\n\n\nIf `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.",
    "created_at": "2016-11-16T15:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319964",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 defeo]:
> But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.


If `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.



---

archive/issue_comments_319965.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:\n> Replying to [comment:13 defeo]:\n> > But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.\n\n> \n> If `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.\n\n\nSame goes for `datastring.decode()`, then. I was obviously thinking of the case where they contain non-ASCII characters.",
    "created_at": "2016-11-16T15:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319965",
    "user": "https://github.com/defeo"
}
```

<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 defeo]:
> > But handling the locale/filesystem encoding seems best left to Python. What if `datastring` is `bytes`, `string` is python's utf-8, and the user's locale is ISO-8859? What is safest among `open(datastring.decode() + string)` and `open(datastring + string.encode())`? Probably neither.

> 
> If `string` is ASCII, then `string.encode()` should be pretty safe since most encodings map ASCII to ASCII bytes.


Same goes for `datastring.decode()`, then. I was obviously thinking of the case where they contain non-ASCII characters.



---

archive/issue_comments_319966.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 defeo]:\n> Same goes for `datastring.decode()`, then.\n\n\nNot if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.",
    "created_at": "2016-11-16T15:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319966",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:15 defeo]:
> Same goes for `datastring.decode()`, then.


Not if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.



---

archive/issue_comments_319967.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:\n> Replying to [comment:15 defeo]:\n> > Same goes for `datastring.decode()`, then.\n\n> \n> Not if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.\n\n\nRight. I thought it was the other way around. So where are these `datadir` + `string`? I see one on line 83 of `parser.py`, and there `string` is `pari.desc`, so I agree with you (assuming that gp correctly handles locale encodings). Any other places?",
    "created_at": "2016-11-16T15:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319967",
    "user": "https://github.com/defeo"
}
```

<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 defeo]:
> > Same goes for `datastring.decode()`, then.

> 
> Not if `datastring` refers to a user-chosen path. Then we shouldn't make too many assumptions.


Right. I thought it was the other way around. So where are these `datadir` + `string`? I see one on line 83 of `parser.py`, and there `string` is `pari.desc`, so I agree with you (assuming that gp correctly handles locale encodings). Any other places?



---

archive/issue_comments_319968.json:
```json
{
    "body": "<a id='comment:18'></a>I think this is the only place. Could you please handle all this without me ?",
    "created_at": "2016-11-16T16:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319968",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>I think this is the only place. Could you please handle all this without me ?



---

archive/issue_comments_319969.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-16T19:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319969",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319970.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-16T19:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319970",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_319971.json:
```json
{
    "body": "<a id='comment:20'></a>ok, here is another try, following Jeroen's suggestion",
    "created_at": "2016-11-16T19:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319971",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:20'></a>ok, here is another try, following Jeroen's suggestion



---

archive/issue_comments_319972.json:
```json
{
    "body": "<a id='comment:21'></a>patchbot now gives a green light",
    "created_at": "2016-11-17T10:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319972",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>patchbot now gives a green light



---

archive/issue_comments_319973.json:
```json
{
    "body": "<a id='comment:22'></a>Good for me then.",
    "created_at": "2016-11-17T10:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319973",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Good for me then.



---

archive/issue_comments_319974.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-17T10:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319974",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_057755.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-19T16:34:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21874#event-57755"
}
```



---

archive/issue_comments_319975.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-19T16:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21874#issuecomment-319975",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
