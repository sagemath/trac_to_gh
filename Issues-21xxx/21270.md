# Issue 21270: Polyhedron RDF face lattice bug / intersection of polyhedra

archive/issues_021033.json:
```json
{
    "body": "Assignee: @mo271\n\nCC:  @fchapoton @mo271 @jplab\n\nKeywords: polyhedron, days84\n\nAs noted first on #20570, current Sage is not able to plot some LPs with irrational data. This appears to be due to a bug in the Sage polyhedron code for RDF data (which InteractiveLP uses when the data are not rational).\n\n```\n            sage: poly = polytopes.regular_polygon(7)\n            sage: lp, x = poly.to_linear_program(solver='InteractiveLP', return_variable=True)\n            sage: lp.set_objective(x[0] + x[1])\n            sage: b = lp.get_backend()\n            sage: P = b.interactive_lp_problem()\n            sage: p = P.plot() ### ERROR\n            sage: p.show()\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21270\n\n",
    "closed_at": "2017-04-05T19:38:05Z",
    "created_at": "2016-08-17T20:13:58Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Polyhedron RDF face lattice bug / intersection of polyhedra",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21270",
    "user": "https://github.com/mkoeppe"
}
```
Assignee: @mo271

CC:  @fchapoton @mo271 @jplab

Keywords: polyhedron, days84

As noted first on #20570, current Sage is not able to plot some LPs with irrational data. This appears to be due to a bug in the Sage polyhedron code for RDF data (which InteractiveLP uses when the data are not rational).

```
            sage: poly = polytopes.regular_polygon(7)
            sage: lp, x = poly.to_linear_program(solver='InteractiveLP', return_variable=True)
            sage: lp.set_objective(x[0] + x[1])
            sage: b = lp.get_backend()
            sage: P = b.interactive_lp_problem()
            sage: p = P.plot() ### ERROR
            sage: p.show()
```



Issue created by migration from https://trac.sagemath.org/ticket/21270





---

archive/issue_comments_291144.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to geometry.",
    "created_at": "2016-08-17T20:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291144",
    "user": "https://github.com/mkoeppe"
}
```

Changing component from PLEASE CHANGE to geometry.



---

archive/issue_comments_291145.json:
```json
{
    "body": "misleading comment deleted",
    "created_at": "2017-03-06T17:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291145",
    "user": "https://github.com/mo271"
}
```

misleading comment deleted



---

archive/issue_comments_291146.json:
```json
{
    "body": "Changing keywords from \"\" to \"polyhedron, days84\".",
    "created_at": "2017-03-06T17:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291146",
    "user": "https://github.com/mo271"
}
```

Changing keywords from "" to "polyhedron, days84".



---

archive/issue_comments_291147.json:
```json
{
    "body": "Set assignee to @mo271.",
    "created_at": "2017-03-06T17:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291147",
    "user": "https://github.com/mo271"
}
```

Set assignee to @mo271.



---

archive/issue_comments_291148.json:
```json
{
    "body": "Apperently something goes wrong when taking the intersection of a polyhedron in RDF and one in QQ:\nQ plays the role of box in the function `plot_feasible_set` of `interactive_simplex_method.py`.\n\n```\nsage: L=[[1349811595/3385908, -488029882/7345133],\n....:  [1349811595/3385908, 1349811595/5078862],\n....:  [-732044823/7345133, 1349811595/5078862],\n....:  [-732044823/7345133, -488029882/7345133]]\n....: \nsage: \nsage: Q=Polyhedron(L)\nsage: P=Polyhedron(polytopes.regular_polygon(7).vertices_list(), base_ring=RDF)\nsage: P.intersection(Q)\nA -1-dimensional polyhedron in RDF^2 defined as the convex hull of 7 vertices\nsage: Q.intersection(P)\nThe empty polyhedron in RDF^2\n```",
    "created_at": "2017-03-06T22:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291148",
    "user": "https://github.com/mo271"
}
```

Apperently something goes wrong when taking the intersection of a polyhedron in RDF and one in QQ:
Q plays the role of box in the function `plot_feasible_set` of `interactive_simplex_method.py`.

```
sage: L=[[1349811595/3385908, -488029882/7345133],
....:  [1349811595/3385908, 1349811595/5078862],
....:  [-732044823/7345133, 1349811595/5078862],
....:  [-732044823/7345133, -488029882/7345133]]
....: 
sage: 
sage: Q=Polyhedron(L)
sage: P=Polyhedron(polytopes.regular_polygon(7).vertices_list(), base_ring=RDF)
sage: P.intersection(Q)
A -1-dimensional polyhedron in RDF^2 defined as the convex hull of 7 vertices
sage: Q.intersection(P)
The empty polyhedron in RDF^2
```



---

archive/issue_comments_291149.json:
```json
{
    "body": "Here is a smaller example of the failing intersection between QQ and RDF polyhedra:\n\n```\nsage: Q=Polyhedron(ieqs=[[-499999,1000000],[1499999,-1000000]])\nsage: P=Polyhedron(ieqs=[[0,1.0],[1.0,-1.0]], base_ring=RDF)\nsage: Q.intersection(P)\nThe empty polyhedron in RDF^1\nsage: P.intersection(Q)\nA 1-dimensional polyhedron in RDF^1 defined as the convex hull of 2 vertices\nsage: Q=Polyhedron(ieqs=[[-4999999,10000000],[14999999,-10000000]])\nsage: P.intersection(Q)\n``` \nThe last command then raises \n`ValueError: *Error: Numerical inconsistency is found.  Use the GMP exact arithmetic.`, which is better than a wrong result, I guess. In any case one should perhaps do the conversions of the base ring more explicitly.\n\n\nThe relevant function in base.py reads:\n\n```       \n        new_ieqs = self.inequalities() + other.inequalities()\n        new_eqns = self.equations() + other.equations()\n        parent = self.parent()\n        try:\n            return parent.element_class(parent, None, [new_ieqs, new_eqns])\n        except TypeError as msg:\n            if self.base_ring() is ZZ:\n                parent = parent.base_extend(QQ)\n                return parent.element_class(parent, None, [new_ieqs, new_eqns])\n            else:\n                raise TypeError(msg)\n```\nSo in the example above we have in the new_ieqs variable:\n\n```\n(An inequality (1.0) x + 0.0 >= 0,\n An inequality (-1.0) x + 1.0 >= 0,\n An inequality (-10000000) x + 14999999 >= 0,\n An inequality (10000000) x - 4999999 >= 0)\n```\nWhich leads to the unexpected behaviour",
    "created_at": "2017-03-06T23:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291149",
    "user": "https://github.com/mo271"
}
```

Here is a smaller example of the failing intersection between QQ and RDF polyhedra:

```
sage: Q=Polyhedron(ieqs=[[-499999,1000000],[1499999,-1000000]])
sage: P=Polyhedron(ieqs=[[0,1.0],[1.0,-1.0]], base_ring=RDF)
sage: Q.intersection(P)
The empty polyhedron in RDF^1
sage: P.intersection(Q)
A 1-dimensional polyhedron in RDF^1 defined as the convex hull of 2 vertices
sage: Q=Polyhedron(ieqs=[[-4999999,10000000],[14999999,-10000000]])
sage: P.intersection(Q)
``` 
The last command then raises 
`ValueError: *Error: Numerical inconsistency is found.  Use the GMP exact arithmetic.`, which is better than a wrong result, I guess. In any case one should perhaps do the conversions of the base ring more explicitly.


The relevant function in base.py reads:

```       
        new_ieqs = self.inequalities() + other.inequalities()
        new_eqns = self.equations() + other.equations()
        parent = self.parent()
        try:
            return parent.element_class(parent, None, [new_ieqs, new_eqns])
        except TypeError as msg:
            if self.base_ring() is ZZ:
                parent = parent.base_extend(QQ)
                return parent.element_class(parent, None, [new_ieqs, new_eqns])
            else:
                raise TypeError(msg)
```
So in the example above we have in the new_ieqs variable:

```
(An inequality (1.0) x + 0.0 >= 0,
 An inequality (-1.0) x + 1.0 >= 0,
 An inequality (-10000000) x + 14999999 >= 0,
 An inequality (10000000) x - 4999999 >= 0)
```
Which leads to the unexpected behaviour



---

archive/issue_comments_291150.json:
```json
{
    "body": "This commit fixes the instances of the problem, that I added. \n\nThe original thing is still not working, but this is now another bug (more later).\n\n---\nNew commits:",
    "created_at": "2017-03-07T17:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291150",
    "user": "https://github.com/mo271"
}
```

This commit fixes the instances of the problem, that I added. 

The original thing is still not working, but this is now another bug (more later).

---
New commits:



---

archive/issue_comments_291151.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-07T17:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291151",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291152.json:
```json
{
    "body": "Now it works..",
    "created_at": "2017-03-07T17:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291152",
    "user": "https://github.com/mo271"
}
```

Now it works..



---

archive/issue_comments_291153.json:
```json
{
    "body": "I submitted a fix to this bug. \n\n\nExplanation:\nWhat went wrong was was happens if a polyhedron in `QQ` is intersection with a polyhedron in `RDF`; basically it takes the union of the inequalities. The inequalities are typically stored as linear inequality with coefficients in `ZZ`. Those coefficients can get very large and cause numerical trouble when converted to `RDF`. Thus it is advisable to convert the inequalities to `RDF` only after some renormalization. We choose to divide all terms of the inequality by the absolute values of the coefficient with the largest absolute value. (In case all the coefficients are zero, we leave it as is.)\n\nThis helped with the examples above. In the original question there was another problem: in the method `_solve` of the class `InteractiveLPProblem(` in the `interactive_simplex_method.py` file, taking the base ring to be something other than the base ring of the feasible region (which might have been coerced to something else) caused trouble. I changed this by simply setting \n\n```\nR = F.base_ring()\n```\n\nThen I was able to produce the plot.",
    "created_at": "2017-03-09T21:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291153",
    "user": "https://github.com/mo271"
}
```

I submitted a fix to this bug. 


Explanation:
What went wrong was was happens if a polyhedron in `QQ` is intersection with a polyhedron in `RDF`; basically it takes the union of the inequalities. The inequalities are typically stored as linear inequality with coefficients in `ZZ`. Those coefficients can get very large and cause numerical trouble when converted to `RDF`. Thus it is advisable to convert the inequalities to `RDF` only after some renormalization. We choose to divide all terms of the inequality by the absolute values of the coefficient with the largest absolute value. (In case all the coefficients are zero, we leave it as is.)

This helped with the examples above. In the original question there was another problem: in the method `_solve` of the class `InteractiveLPProblem(` in the `interactive_simplex_method.py` file, taking the base ring to be something other than the base ring of the feasible region (which might have been coerced to something else) caused trouble. I changed this by simply setting 

```
R = F.base_ring()
```

Then I was able to produce the plot.



---

archive/issue_comments_291154.json:
```json
{
    "body": "By the way a better plotting result is obtained by \n\n``` \nsage: p = P.plot(xmin=-3, xmax=8, ymin=-2, ymax=4) \nsage: p.show(dpi=500)\n```\nBut giving an explicit bounding box circumvents the first problem..",
    "created_at": "2017-03-09T21:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291154",
    "user": "https://github.com/mo271"
}
```

By the way a better plotting result is obtained by 

``` 
sage: p = P.plot(xmin=-3, xmax=8, ymin=-2, ymax=4) 
sage: p.show(dpi=500)
```
But giving an explicit bounding box circumvents the first problem..



---

archive/issue_comments_291155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-09T21:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291155",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291156.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-09T21:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291156",
    "user": "https://github.com/mo271"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_291157.json:
```json
{
    "body": "There seems to be a merge conflict. Could you rebase it?",
    "created_at": "2017-03-15T15:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291157",
    "user": "https://github.com/jplab"
}
```

There seems to be a merge conflict. Could you rebase it?



---

archive/issue_comments_291158.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-15T15:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291158",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_291159.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-16T20:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291159",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_291160.json:
```json
{
    "body": "This should now merge cleanly. (There was just an issue with some trailing whitespace that I had removed in a line that was changed in rc0.)",
    "created_at": "2017-03-16T20:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291160",
    "user": "https://github.com/mo271"
}
```

This should now merge cleanly. (There was just an issue with some trailing whitespace that I had removed in a line that was changed in rc0.)



---

archive/issue_comments_291161.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-16T20:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291161",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_291162.json:
```json
{
    "body": "Hi Moritz,\n\nThere are a couple of missing spaces between binary operator.\n\nLet's see what the bot thinks.",
    "created_at": "2017-03-17T14:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291162",
    "user": "https://github.com/jplab"
}
```

Hi Moritz,

There are a couple of missing spaces between binary operator.

Let's see what the bot thinks.



---

archive/issue_comments_291163.json:
```json
{
    "body": "Hi Moritz,\n\nThe bot is happy and it looks good to me. If you correct the 3 spacing around operators in the `parent.py`, you can set it to positive review on my behalf.",
    "created_at": "2017-03-30T09:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291163",
    "user": "https://github.com/jplab"
}
```

Hi Moritz,

The bot is happy and it looks good to me. If you correct the 3 spacing around operators in the `parent.py`, you can set it to positive review on my behalf.



---

archive/issue_comments_291164.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-30T18:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291164",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_291165.json:
```json
{
    "body": "Thank for your review, JP!",
    "created_at": "2017-03-30T18:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291165",
    "user": "https://github.com/mo271"
}
```

Thank for your review, JP!



---

archive/issue_comments_291166.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-02T20:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291166",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_056683.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-05T19:38:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21270#event-56683"
}
```



---

archive/issue_comments_291167.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-05T19:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21270#issuecomment-291167",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
