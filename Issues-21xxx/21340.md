# Issue 21340: LatticePoset: bug in testing semidistributivity

archive/issues_021103.json:
```json
{
    "assignees": [],
    "body": "Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison in logarithm of Sage `Integer`.\n\n\nCC:  @nexttime\n\nBranch/Commit: **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton**\n\nAuthor: **Jori M\u00e4ntysalo**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21340_\n\n",
    "closed_at": "2016-09-16T06:55:21Z",
    "created_at": "2016-08-26T04:50:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "LatticePoset: bug in testing semidistributivity",
    "type": "issue",
    "updated_at": "2016-09-16T06:55:21Z",
    "url": "https://github.com/sagemath/sage/issues/21340",
    "user": "https://github.com/jm58660"
}
```
Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison in logarithm of Sage `Integer`.


CC:  @nexttime

Branch/Commit: **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**

Reviewer: **Frédéric Chapoton**

Author: **Jori Mäntysalo**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/21340_





---

archive/issue_events_301273.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-08-26T04:50:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301273"
}
```



---

archive/issue_events_301274.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-08-26T04:50:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301274"
}
```



---

archive/issue_events_301275.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-08-26T04:50:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301275"
}
```



---

archive/issue_events_301276.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-08-26T04:50:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301276"
}
```



---

archive/issue_comments_312165.json:
```json
{
    "body": "Branch: **[u/jmantysalo/latticeposet__bug_in_testing_semidistributivity](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/latticeposet__bug_in_testing_semidistributivity)**",
    "created_at": "2016-08-26T06:37:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312165",
    "user": "https://github.com/jm58660"
}
```

Branch: **[u/jmantysalo/latticeposet__bug_in_testing_semidistributivity](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/latticeposet__bug_in_testing_semidistributivity)**



---

archive/issue_comments_312166.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReady for review, but let's first wait if discussion at https://groups.google.com/forum/#!topic/sage-devel/ZtwUc5c4Js0 founds better solution.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83\"><code>1a72740</code></a></td><td><code>Workaround for log bug.</code></td></tr></table>\n",
    "created_at": "2016-08-26T07:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312166",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:2" align="right">comment:2</div>

Ready for review, but let's first wait if discussion at https://groups.google.com/forum/#!topic/sage-devel/ZtwUc5c4Js0 founds better solution.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83"><code>1a72740</code></a></td><td><code>Workaround for log bug.</code></td></tr></table>




---

archive/issue_comments_312167.json:
```json
{
    "body": "Commit: **[`1a72740`](https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83)**",
    "created_at": "2016-08-26T07:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312167",
    "user": "https://github.com/jm58660"
}
```

Commit: **[`1a72740`](https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83)**



---

archive/issue_comments_312168.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,2 @@\n-Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is propably due to division by `2` that is not preparsed and was hence missed in my tests.\n+Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison between logarithm and integer.\n \n``````\n",
    "created_at": "2016-08-26T07:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312168",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,2 @@
-Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is propably due to division by `2` that is not preparsed and was hence missed in my tests.
+Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison between logarithm and integer.
 
``````




---

archive/issue_comments_312169.json:
```json
{
    "body": "Changed commit from **[`1a72740`](https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83)** to **[`9edd77b`](https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a)**",
    "created_at": "2016-08-27T05:00:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312169",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1a72740`](https://github.com/sagemath/sagetrac-mirror/commit/1a727401edf30b7217771de99acef212703eca83)** to **[`9edd77b`](https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a)**



---

archive/issue_comments_312170.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a\"><code>9edd77b</code></a></td><td><code>Workaround for logarithm bug.</code></td></tr></table>\n",
    "created_at": "2016-08-27T05:00:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312170",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a"><code>9edd77b</code></a></td><td><code>Workaround for logarithm bug.</code></td></tr></table>




---

archive/issue_comments_312171.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,2 @@\n-Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison between logarithm and integer.\n+Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison in logarithm of Sage `Integer`.\n \n``````\n",
    "created_at": "2016-08-27T05:02:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312171",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,2 @@
-Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison between logarithm and integer.
+Sage says that the Boolean lattice of `2^3=8` elements is not [meet|join]-semidistributive. This is due to comparison in logarithm of Sage `Integer`.
 
``````




---

archive/issue_comments_312172.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nLeif, can you check this basically one line patch?",
    "created_at": "2016-08-27T05:02:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312172",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:4" align="right">comment:4</div>

Leif, can you check this basically one line patch?



---

archive/issue_events_301277.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-08-27T05:02:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301277"
}
```



---

archive/issue_comments_312173.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis is a *massive* hack solution that comes from this behavior:\n\n```sage\nsage: log(8, 2)\n3\nsage: log(8, int(2))\nlog(8)/log(2)\nsage: log(int(8), int(2))\nlog(8)/log(2)\n```\nIf we are to accept this hack, we should well document it as such.",
    "created_at": "2016-08-27T05:05:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312173",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

This is a *massive* hack solution that comes from this behavior:

```sage
sage: log(8, 2)
3
sage: log(8, int(2))
log(8)/log(2)
sage: log(int(8), int(2))
log(8)/log(2)
```
If we are to accept this hack, we should well document it as such.



---

archive/issue_comments_312174.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWell, of course right solution would be correcting `log`. For example output type should depend on input type, not on input value. But\n\n```\nsage: type(log(8, 2))\n<type 'sage.rings.integer.Integer'>\nsage: type(log(9, 2))\n<type 'sage.symbolic.expression.Expression'>\n```\n\nShould I just remove the quick test of non-semidistributivity then? Won't make much difference.",
    "created_at": "2016-08-27T05:14:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312174",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:6" align="right">comment:6</div>

Well, of course right solution would be correcting `log`. For example output type should depend on input type, not on input value. But

```
sage: type(log(8, 2))
<type 'sage.rings.integer.Integer'>
sage: type(log(9, 2))
<type 'sage.symbolic.expression.Expression'>
```

Should I just remove the quick test of non-semidistributivity then? Won't make much difference.



---

archive/issue_comments_312175.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe biggest thing is just documenting why we are doing certain things, so when we go back and look again or someone else comes and looks at it, it is clear why things were done this way.\n\nOne option would be wrapping the inequality test in `bool(...)`. This evaluates the symbolic expression to a boolean and doesn't affect boolean values:\n\n```\nsage: bool(13 > 8 * log(8, 2) / 2)\nTrue\nsage: bool(12 > 8 * log(8, 2) / 2)\nFalse\nsage: bool(True)\nTrue\nsage: bool(False)\nFalse\n```\nAgain, there should be a comment. Another option would be to do `log(8,2).n()`, which could introduce some numerical noise. Or just force both values to `ZZ`.",
    "created_at": "2016-08-27T15:36:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312175",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:7" align="right">comment:7</div>

The biggest thing is just documenting why we are doing certain things, so when we go back and look again or someone else comes and looks at it, it is clear why things were done this way.

One option would be wrapping the inequality test in `bool(...)`. This evaluates the symbolic expression to a boolean and doesn't affect boolean values:

```
sage: bool(13 > 8 * log(8, 2) / 2)
True
sage: bool(12 > 8 * log(8, 2) / 2)
False
sage: bool(True)
True
sage: bool(False)
False
```
Again, there should be a comment. Another option would be to do `log(8,2).n()`, which could introduce some numerical noise. Or just force both values to `ZZ`.



---

archive/issue_comments_312176.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@tscrim](#comment:7):\n> One option would be wrapping the inequality test in `bool(...)`. This evaluates the symbolic expression to a boolean and doesn't affect boolean values:\n> \n> ```\n> sage: bool(13 > 8 * log(8, 2) / 2)\n> True\n> sage: bool(12 > 8 * log(8, 2) / 2)\n> False\n> sage: bool(True)\n> True\n> sage: bool(False)\n> False\n> ```\n\nQuoting from sage-devel:\n\n```\nRalf Stephan wrote:\n> On Saturday, August 27, 2016 at 7:05:28 AM UTC+2, Jori M\u00e4ntysalo wrote:\n>\n>     But shouldn't it work in any case? I.e. comparison of\n>     log(a+b*c^2...) to\n>     some number should work when a,b,c... are sage Integers.\n>\n>\n> log(integer) will not be expanded numerically except for log(0) and log(1).\n> If you want it expanded, either give a float argument, eg log(2.), or\n> append n().\n\nN() wasn't the problem, but (also) rounding:\n\n(s is 12 here.)\n\nsage: n*log(n, 2)\n24\nsage: n*log(n, 2r)\n8*log(8)/log(2)\nsage: N(n*log(n, 2r))\n24.0000000000000\nsage: 2*s < n*log(n, 2)\nFalse\nsage: 2*s > n*log(n, 2)\nFalse\nsage: 2*s > n*log(n, 2r)\n24 > 8*log(8)/log(2)\nsage: bool(2*s > n*log(n, 2r))\nTrue\nsage: bool(2r*s > n*log(n, 2r))\nTrue\nsage: bool(2r*s > n*log(n, 2))\nFalse\nsage: 24 > N(n*log(n, 2r))\nTrue\n```\n\nSo I'd suggest to rewrite the code, and/or call the proper `log()`, or (first) check whether `n` is a power of 2.",
    "created_at": "2016-08-27T16:46:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312176",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@tscrim](#comment:7):
> One option would be wrapping the inequality test in `bool(...)`. This evaluates the symbolic expression to a boolean and doesn't affect boolean values:
> 
> ```
> sage: bool(13 > 8 * log(8, 2) / 2)
> True
> sage: bool(12 > 8 * log(8, 2) / 2)
> False
> sage: bool(True)
> True
> sage: bool(False)
> False
> ```

Quoting from sage-devel:

```
Ralf Stephan wrote:
> On Saturday, August 27, 2016 at 7:05:28 AM UTC+2, Jori Mäntysalo wrote:
>
>     But shouldn't it work in any case? I.e. comparison of
>     log(a+b*c^2...) to
>     some number should work when a,b,c... are sage Integers.
>
>
> log(integer) will not be expanded numerically except for log(0) and log(1).
> If you want it expanded, either give a float argument, eg log(2.), or
> append n().

N() wasn't the problem, but (also) rounding:

(s is 12 here.)

sage: n*log(n, 2)
24
sage: n*log(n, 2r)
8*log(8)/log(2)
sage: N(n*log(n, 2r))
24.0000000000000
sage: 2*s < n*log(n, 2)
False
sage: 2*s > n*log(n, 2)
False
sage: 2*s > n*log(n, 2r)
24 > 8*log(8)/log(2)
sage: bool(2*s > n*log(n, 2r))
True
sage: bool(2r*s > n*log(n, 2r))
True
sage: bool(2r*s > n*log(n, 2))
False
sage: 24 > N(n*log(n, 2r))
True
```

So I'd suggest to rewrite the code, and/or call the proper `log()`, or (first) check whether `n` is a power of 2.



---

archive/issue_comments_312177.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\n(The left side of the comparison doesn't matter here, but note that\n\n  `bool(2*s > n*log(n, 2r))`\n\nand\n\n  `bool(2*s > n*log(n, 2))`\n\ngive different results due to the behaviour of `log()` and rounding issues.)",
    "created_at": "2016-08-27T16:52:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312177",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

(The left side of the comparison doesn't matter here, but note that

  `bool(2*s > n*log(n, 2r))`

and

  `bool(2*s > n*log(n, 2))`

give different results due to the behaviour of `log()` and rounding issues.)



---

archive/issue_comments_312178.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nMaybe I just wrote the `log_2` myself:\n\n```\ndef _log_2(n):\n    \"\"\"\n    Return the 2-based logarithm of `n` rounded up.\n    \n    `n` is assumed to be a positive integer.\n    \n    EXAMPLES::\n        \n        sage: sage.combinat.poset.lattices._log_2(10)\n        4\n    \"\"\"\n    bits = -1\n    i = n\n    while i:\n        i = i >> 1\n        bits += 1\n    if 1 << bits == n:\n        return bits\n    return bits+1\n```\n\n(On x86 one could use `LZCNT` and `POPCNT`. `:=)`)",
    "created_at": "2016-08-28T08:11:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312178",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:10" align="right">comment:10</div>

Maybe I just wrote the `log_2` myself:

```
def _log_2(n):
    """
    Return the 2-based logarithm of `n` rounded up.
    
    `n` is assumed to be a positive integer.
    
    EXAMPLES::
        
        sage: sage.combinat.poset.lattices._log_2(10)
        4
    """
    bits = -1
    i = n
    while i:
        i = i >> 1
        bits += 1
    if 1 << bits == n:
        return bits
    return bits+1
```

(On x86 one could use `LZCNT` and `POPCNT`. `:=)`)



---

archive/issue_comments_312179.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nSee also the `ffs()` family, `[__builtin_]clz()`, ...  (also on ARM etc.)\n\nIf you just want to know *whether* `n` is an exact power of two (<=> n==0 or popcnt(n)==1), you can use `n & ~(n-1) == n`.\n\nYou could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).",
    "created_at": "2016-08-28T12:47:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312179",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

See also the `ffs()` family, `[__builtin_]clz()`, ...  (also on ARM etc.)

If you just want to know *whether* `n` is an exact power of two (<=> n==0 or popcnt(n)==1), you can use `n & ~(n-1) == n`.

You could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).



---

archive/issue_comments_312180.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@nexttime](#comment:11):\n\n> You could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).  \n\nIsn't there the same rounding problem with `math.log`?",
    "created_at": "2016-08-28T14:59:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312180",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@nexttime](#comment:11):

> You could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).  

Isn't there the same rounding problem with `math.log`?



---

archive/issue_comments_312181.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jm58660](#comment:12):\n> Replying to [@nexttime](#comment:11):\n> \n> > You could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).  \n\n> \n> Isn't there the same rounding problem with `math.log`?\n\nProbably not for true powers of 2; don't know why Sage's log() is so bad in that regard.  (How large does `n`, or  `log(n, 2)`, practically get?)\n\nFWIW, if you want to stay in the integer domain, you could as well use `4`<sup>`s`</sup>`> n`<sup>`n`</sup>, where the right-hand side is as cheap as the left if (`n` is sufficiently small or `ctz(n)` is relatively large or) `n` is a power of 2.\n\nBut that's perhaps already towards bike-shedding.\n\n\\\\\n\nEspecially if you know `n` is a power of 2, you could do appropriate rounding as well, but I'd rather fix log() or use a different one.\n\nBut doesn't already using `sage.misc.functional.log(n, Integer(2))` solve (or, more precisely, work around) the main problem here?",
    "created_at": "2016-08-28T15:38:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312181",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jm58660](#comment:12):
> Replying to [@nexttime](#comment:11):
> 
> > You could likewise use Python's `math.log(int(n), 2)`, or various functions from GMP (since Sage Integers are based on `mpz_t`).  

> 
> Isn't there the same rounding problem with `math.log`?

Probably not for true powers of 2; don't know why Sage's log() is so bad in that regard.  (How large does `n`, or  `log(n, 2)`, practically get?)

FWIW, if you want to stay in the integer domain, you could as well use `4`<sup>`s`</sup>`> n`<sup>`n`</sup>, where the right-hand side is as cheap as the left if (`n` is sufficiently small or `ctz(n)` is relatively large or) `n` is a power of 2.

But that's perhaps already towards bike-shedding.

\\

Especially if you know `n` is a power of 2, you could do appropriate rounding as well, but I'd rather fix log() or use a different one.

But doesn't already using `sage.misc.functional.log(n, Integer(2))` solve (or, more precisely, work around) the main problem here?



---

archive/issue_comments_312182.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@nexttime](#comment:13):\n> Replying to [@jm58660](#comment:12):\n> > Isn't there the same rounding problem with `math.log`?\n\n> \n> Probably not for true powers of 2; don't know why Sage's log() is so bad in that regard.  (How large does `n`, or  `log(n, 2)`, practically get?)\n\nIt should be safe up to at least 2<sup>52</sup>+ (maybe even up to 2<sup>1022</sup>+) because Python's `float`s (returned by `math.log()`) are actually `double`s AFAIK.",
    "created_at": "2016-08-28T16:06:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312182",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@nexttime](#comment:13):
> Replying to [@jm58660](#comment:12):
> > Isn't there the same rounding problem with `math.log`?

> 
> Probably not for true powers of 2; don't know why Sage's log() is so bad in that regard.  (How large does `n`, or  `log(n, 2)`, practically get?)

It should be safe up to at least 2<sup>52</sup>+ (maybe even up to 2<sup>1022</sup>+) because Python's `float`s (returned by `math.log()`) are actually `double`s AFAIK.



---

archive/issue_comments_312183.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nDistantly related:\n\nWhile we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?",
    "created_at": "2016-08-28T17:56:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312183",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:15" align="right">comment:15</div>

Distantly related:

While we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?



---

archive/issue_comments_312184.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@nexttime](#comment:15):\n> Distantly related:\n> \n> While we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?\n\nOther than `is_semidistributive`?\n\nBut yes, you are right. Kevin said the same at #21002. Suggestion for better name?",
    "created_at": "2016-08-29T03:44:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312184",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@nexttime](#comment:15):
> Distantly related:
> 
> While we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?

Other than `is_semidistributive`?

But yes, you are right. Kevin said the same at #21002. Suggestion for better name?



---

archive/issue_comments_312185.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5\"><code>68419a4</code></a></td><td><code>Logarithm in semidistributive.</code></td></tr></table>\n",
    "created_at": "2016-08-30T05:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312185",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5"><code>68419a4</code></a></td><td><code>Logarithm in semidistributive.</code></td></tr></table>




---

archive/issue_comments_312186.json:
```json
{
    "body": "Changed commit from **[`9edd77b`](https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a)** to **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**",
    "created_at": "2016-08-30T05:52:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9edd77b`](https://github.com/sagemath/sagetrac-mirror/commit/9edd77b37e3570fdae8d77b5344678f4b6f0cf9a)** to **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**



---

archive/issue_comments_312187.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK, should work now. Also function name changed.",
    "created_at": "2016-08-30T05:53:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312187",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:18" align="right">comment:18</div>

OK, should work now. Also function name changed.



---

archive/issue_comments_312188.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jm58660](#comment:18):\n> OK, should work now. Also function name changed.\n\nDoesn't the latter require a deprecation of the old function first?",
    "created_at": "2016-08-30T16:11:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312188",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jm58660](#comment:18):
> OK, should work now. Also function name changed.

Doesn't the latter require a deprecation of the old function first?



---

archive/issue_comments_312189.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jm58660](#comment:16):\n> Replying to [@nexttime](#comment:15):\n> > Distantly related:\n> > \n> > While we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?\n\n> \n> Other than `is_semidistributive`?\n\nYes.  The first (I think) being `.is_complemented(self)`, but there are more IIRC.\n\n\\\\\n\n> But yes, you are right. Kevin said the same at #21002. Suggestion for better name?\n\n`certify`, `prove[_if_(true|false)]`, `[return_]witness[_if_false]`?  ;-)\n\n(I guess you were referring to `is_...()`, not the keyword argument, though.)\n\nI'd rather keep the `is_...()`, but add (a) keyword or boolean argument(s), and only change the return type(s).\n\nBut then you'd have to first make the old behaviour the default, for backwards compatibility.",
    "created_at": "2016-08-30T16:22:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312189",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jm58660](#comment:16):
> Replying to [@nexttime](#comment:15):
> > Distantly related:
> > 
> > While we (you?) are at it, `HasseDiagram` has a couple of `.is_...()` methods which do not return `True` or `False`, but either `None` or some sample.  Shouldn't these return the former unless a keyword argument `certificate` :-) (which they currently don't have) is passed?

> 
> Other than `is_semidistributive`?

Yes.  The first (I think) being `.is_complemented(self)`, but there are more IIRC.

\\

> But yes, you are right. Kevin said the same at #21002. Suggestion for better name?

`certify`, `prove[_if_(true|false)]`, `[return_]witness[_if_false]`?  ;-)

(I guess you were referring to `is_...()`, not the keyword argument, though.)

I'd rather keep the `is_...()`, but add (a) keyword or boolean argument(s), and only change the return type(s).

But then you'd have to first make the old behaviour the default, for backwards compatibility.



---

archive/issue_comments_312190.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nPerhaps a bit late, but did you look at `Integer.{log,exact_log}()`?",
    "created_at": "2016-08-30T16:24:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312190",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:21" align="right">comment:21</div>

Perhaps a bit late, but did you look at `Integer.{log,exact_log}()`?



---

archive/issue_comments_312191.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@nexttime](#comment:19):\n\n> > OK, should work now. Also function name changed.\n\n> \n> Doesn't the latter require a deprecation of the old function first?\n\nI have thinked that `hasse_diagram.py` is an internal implementation file that can be changed. And the function is one release old only.",
    "created_at": "2016-08-31T03:38:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312191",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@nexttime](#comment:19):

> > OK, should work now. Also function name changed.

> 
> Doesn't the latter require a deprecation of the old function first?

I have thinked that `hasse_diagram.py` is an internal implementation file that can be changed. And the function is one release old only.



---

archive/issue_comments_312192.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@nexttime](#comment:20):\n\n> (I guess you were referring to `is_...()`, not the keyword argument, though.)\n> \n> I'd rather keep the `is_...()`, but add (a) keyword or boolean argument(s), and only change the return type(s).\n\nI can think those later in another ticket. Actually there is more to think about in splitting code in `posets.py` and `lattices.py` vs. `hasse_diagram.py`.\n\nBut is there more to do for this ticket?\n\n`exact_log` rounds down, my helper function rounds up. Of course I could use it, but the code would not be much simpler. Waiting for Python 3 and log_2...",
    "created_at": "2016-08-31T10:36:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312192",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@nexttime](#comment:20):

> (I guess you were referring to `is_...()`, not the keyword argument, though.)
> 
> I'd rather keep the `is_...()`, but add (a) keyword or boolean argument(s), and only change the return type(s).

I can think those later in another ticket. Actually there is more to think about in splitting code in `posets.py` and `lattices.py` vs. `hasse_diagram.py`.

But is there more to do for this ticket?

`exact_log` rounds down, my helper function rounds up. Of course I could use it, but the code would not be much simpler. Waiting for Python 3 and log_2...



---

archive/issue_comments_312193.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAssuming that #21419 get accepted it offers a faster way to chech if a lattice is semidistributive.",
    "created_at": "2016-09-06T05:49:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312193",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:24" align="right">comment:24</div>

Assuming that #21419 get accepted it offers a faster way to chech if a lattice is semidistributive.



---

archive/issue_comments_312194.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nJust a ping... Currently Sage says that a distributive lattice is not semidistributive, which is bad. There are more to add, but IMO bugs should be corrected first.\n\nReplying to [@jm58660](#comment:23):\n\n> But is there more to do for this ticket?",
    "created_at": "2016-09-13T04:11:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312194",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:25" align="right">comment:25</div>

Just a ping... Currently Sage says that a distributive lattice is not semidistributive, which is bad. There are more to add, but IMO bugs should be corrected first.

Replying to [@jm58660](#comment:23):

> But is there more to do for this ticket?



---

archive/issue_events_301278.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-09-14T12:00:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301278"
}
```



---

archive/issue_events_301279.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-09-14T12:00:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301279"
}
```



---

archive/issue_comments_312195.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nok, ok. It would have been better to put this log2 in some other place.",
    "created_at": "2016-09-14T12:00:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312195",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:26" align="right">comment:26</div>

ok, ok. It would have been better to put this log2 in some other place.



---

archive/issue_comments_312196.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2016-09-14T12:00:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312196",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_comments_312197.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@fchapoton](#comment:26):\n> It would have been better to put this log2 in some other place.\n\nBut I think that someone, \"Fr\u00e9d\u00e9ric\" if I remember the name correctly, is converting [SageMath](../wiki/SageMath) to Python 3. `:=)` Then we will have `math.log2()`.",
    "created_at": "2016-09-14T12:06:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312197",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@fchapoton](#comment:26):
> It would have been better to put this log2 in some other place.

But I think that someone, "Frédéric" if I remember the name correctly, is converting [SageMath](../wiki/SageMath) to Python 3. `:=)` Then we will have `math.log2()`.



---

archive/issue_events_301280.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-09-16T06:55:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301280"
}
```



---

archive/issue_events_301281.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "3f8a15e86968764058a1a7b060c067532fbf77c7",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-09-16T06:55:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21340#event-301281"
}
```



---

archive/issue_comments_312198.json:
```json
{
    "body": "Changed branch from **[u/jmantysalo/latticeposet__bug_in_testing_semidistributivity](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/latticeposet__bug_in_testing_semidistributivity)** to **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**",
    "created_at": "2016-09-16T06:55:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21340",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21340#issuecomment-312198",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jmantysalo/latticeposet__bug_in_testing_semidistributivity](https://github.com/sagemath/sagetrac-mirror/tree/u/jmantysalo/latticeposet__bug_in_testing_semidistributivity)** to **[`68419a4`](https://github.com/sagemath/sagetrac-mirror/commit/68419a4806a5674caa0ea535577ef9a6eea1a5c5)**
