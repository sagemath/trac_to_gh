# Issue 21766: py3-compatible way to sort monomials

archive/issues_021529.json:
```json
{
    "body": "currently using a cmp, we need to switch to sorting using a key\n\nmay not be entirely obvious\n\nCC:  @jdemeyer @tscrim @a-andre\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nBranch: b67b06bcaa4772ee1ebdd93bc094b8025711f3aa\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21766\n\n",
    "closed_at": "2016-11-09T18:16:15Z",
    "created_at": "2016-10-25T14:08:35Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "py3-compatible way to sort monomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21766",
    "user": "https://github.com/fchapoton"
}
```
currently using a cmp, we need to switch to sorting using a key

may not be entirely obvious

CC:  @jdemeyer @tscrim @a-andre

Reviewer: Travis Scrimshaw

Author: Frédéric Chapoton

Branch: b67b06bcaa4772ee1ebdd93bc094b8025711f3aa

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21766





---

archive/issue_comments_317928.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2016-10-25T14:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317928",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_317929.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-26T19:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317929",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317930.json:
```json
{
    "body": "<a id='comment:3'></a>I now get the following surprising behaviour:\n\n```\nsage: T.<a,b> = PowerSeriesRing(ZZ,2)\nsage: f = a + b + a*b + T.O(3)\nsage: f\na + b + a*b + O(a, b)^3\nsage: f.change_ring(QQ)\na + b + a*b + O(a, b)^3\nsage: f.change_ring(RR)\na*b + b + a + O(a, b)^3\n```\nDoes anybody have any idea why ?",
    "created_at": "2016-10-27T20:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317930",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>I now get the following surprising behaviour:

```
sage: T.<a,b> = PowerSeriesRing(ZZ,2)
sage: f = a + b + a*b + T.O(3)
sage: f
a + b + a*b + O(a, b)^3
sage: f.change_ring(QQ)
a + b + a*b + O(a, b)^3
sage: f.change_ring(RR)
a*b + b + a + O(a, b)^3
```
Does anybody have any idea why ?



---

archive/issue_comments_317931.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-27T20:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317931",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317932.json:
```json
{
    "body": "<a id='comment:5'></a>This does not come from the change_ring:\n\n```\nsage: T.<a,b> = PowerSeriesRing(RDF,2)\nsage: f = a + b + a*b + T.O(3)\nsage: f\na*b + b + a + O(a, b)^3\n```",
    "created_at": "2016-10-30T15:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317932",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>This does not come from the change_ring:

```
sage: T.<a,b> = PowerSeriesRing(RDF,2)
sage: f = a + b + a*b + T.O(3)
sage: f
a*b + b + a + O(a, b)^3
```



---

archive/issue_comments_317933.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-30T17:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317934.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-30T17:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317934",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317935.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-30T20:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317935",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317936.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-31T08:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317936",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317937.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-31T13:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317937",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_317938.json:
```json
{
    "body": "<a id='comment:10'></a>green bot !",
    "created_at": "2016-10-31T13:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317938",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>green bot !



---

archive/issue_comments_317939.json:
```json
{
    "body": "<a id='comment:11'></a>For all of the `compare` methods, do we want to deprecate them?",
    "created_at": "2016-10-31T13:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317939",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>For all of the `compare` methods, do we want to deprecate them?



---

archive/issue_comments_317940.json:
```json
{
    "body": "<a id='comment:12'></a>two possibilities: remove them all, or deprecate them all. After this ticket, they will no longer be used anywhere in sage.\n\nI would rather choose removal, but I know that this breaks the rules.",
    "created_at": "2016-10-31T14:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317940",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>two possibilities: remove them all, or deprecate them all. After this ticket, they will no longer be used anywhere in sage.

I would rather choose removal, but I know that this breaks the rules.



---

archive/issue_comments_317941.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-06T08:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317942.json:
```json
{
    "body": "<a id='comment:14'></a>I have introduced the proper deprecations. This may affect a few doctests.",
    "created_at": "2016-11-06T08:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317942",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'></a>I have introduced the proper deprecations. This may affect a few doctests.



---

archive/issue_comments_317943.json:
```json
{
    "body": "<a id='comment:15'></a>Sorry, I lost track of this, I had meant to respond. However, I agree that we probably should deprecate them since they are publically reachable. Thanks.",
    "created_at": "2016-11-06T14:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317943",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Sorry, I lost track of this, I had meant to respond. However, I agree that we probably should deprecate them since they are publically reachable. Thanks.



---

archive/issue_comments_317944.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-06T14:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317944",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_317945.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-07T19:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317945",
    "user": "https://github.com/fchapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_317946.json:
```json
{
    "body": "<a id='comment:16'></a>one failing doctest",
    "created_at": "2016-11-07T19:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317946",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>one failing doctest



---

archive/issue_comments_317947.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-07T20:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317947",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317948.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-11-07T22:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317948",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_317949.json:
```json
{
    "body": "<a id='comment:19'></a>\n```\nsage -t --long src/sage/rings/polynomial/term_order.py\n**********************************************************************\nFile \"src/sage/rings/polynomial/term_order.py\", line 1542, in sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex\nFailed example:\n    f = a + c^4; f.lm() # indirect doctest\nExpected:\n    c^4\nGot:\n    doctest:warning\n      File \"/home/sage/patchbot/sage/src/bin/sage-runtests\", line 89, in <module>\n        err = DC.run()\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1130, in run\n        self.run_doctests()\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 854, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1700, in dispatch\n        self.parallel_dispatch()\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1590, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1866, in start\n        super(DocTestWorker, self).start()\n      File \"/home/sage/patchbot/sage/local/lib/python/multiprocessing/process.py\", line 130, in start\n        self._popen = Popen(self)\n      File \"/home/sage/patchbot/sage/local/lib/python/multiprocessing/forking.py\", line 126, in __init__\n        code = process_obj._bootstrap()\n      File \"/home/sage/patchbot/sage/local/lib/python/multiprocessing/process.py\", line 258, in _bootstrap\n        self.run()\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1839, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2132, in __call__\n        runner.run(test)\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 636, in run\n        return self._run(test, compileflags, out)\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex[1]>\", line 1, in <module>\n        f = a + c**Integer(4); f.lm() # indirect doctest\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_element.py\", line 1387, in lm\n        f = self._MPolynomial_element__element.lcmt( R.term_order().greater_tuple )\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.py\", line 1685, in greater_tuple_block\n        r = getattr(block,\"compare_tuples_\" + block.name())(f[n:n+len(block)],g[n:n+len(block)])\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.py\", line 982, in compare_tuples_degrevlex\n        deprecation(21766, 'sorting of polynomials now uses sortkey instead')\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/misc/superseded.py\", line 100, in deprecation\n        warning(trac_number, message, DeprecationWarning, stacklevel)\n      File \"/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/misc/superseded.py\", line 141, in warning\n        warn(message, warning_class, stacklevel)\n    :\n    DeprecationWarning: sorting of polynomials now uses sortkey instead\n    See http://trac.sagemath.org/21766 for details.\n    c^4\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex\n    [308 tests, 1 failure, 0.68 s]\n```",
    "created_at": "2016-11-07T23:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317949",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
```
sage -t --long src/sage/rings/polynomial/term_order.py
**********************************************************************
File "src/sage/rings/polynomial/term_order.py", line 1542, in sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex
Failed example:
    f = a + c^4; f.lm() # indirect doctest
Expected:
    c^4
Got:
    doctest:warning
      File "/home/sage/patchbot/sage/src/bin/sage-runtests", line 89, in <module>
        err = DC.run()
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1130, in run
        self.run_doctests()
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 854, in run_doctests
        self.dispatcher.dispatch()
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1700, in dispatch
        self.parallel_dispatch()
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1590, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1866, in start
        super(DocTestWorker, self).start()
      File "/home/sage/patchbot/sage/local/lib/python/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/home/sage/patchbot/sage/local/lib/python/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/home/sage/patchbot/sage/local/lib/python/multiprocessing/process.py", line 258, in _bootstrap
        self.run()
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1839, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2132, in __call__
        runner.run(test)
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 636, in run
        return self._run(test, compileflags, out)
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex[1]>", line 1, in <module>
        f = a + c**Integer(4); f.lm() # indirect doctest
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_element.py", line 1387, in lm
        f = self._MPolynomial_element__element.lcmt( R.term_order().greater_tuple )
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.py", line 1685, in greater_tuple_block
        r = getattr(block,"compare_tuples_" + block.name())(f[n:n+len(block)],g[n:n+len(block)])
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.py", line 982, in compare_tuples_degrevlex
        deprecation(21766, 'sorting of polynomials now uses sortkey instead')
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/misc/superseded.py", line 100, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/home/sage/patchbot/sage/local/lib/python2.7/site-packages/sage/misc/superseded.py", line 141, in warning
        warn(message, warning_class, stacklevel)
    :
    DeprecationWarning: sorting of polynomials now uses sortkey instead
    See http://trac.sagemath.org/21766 for details.
    c^4
**********************************************************************
1 item had failures:
   1 of   4 in sage.rings.polynomial.term_order.TermOrder.greater_tuple_neglex
    [308 tests, 1 failure, 0.68 s]
```



---

archive/issue_comments_317950.json:
```json
{
    "body": "<a id='comment:20'></a>Fr\u00e9d\u00e9ric took care of this on the last commit.",
    "created_at": "2016-11-08T02:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317950",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Frédéric took care of this on the last commit.



---

archive/issue_comments_317951.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-09T18:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317951",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_057582.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-09T18:16:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21766#event-57582"
}
```



---

archive/issue_comments_317952.json:
```json
{
    "body": "<a id='comment:22'></a>followup in #24409",
    "created_at": "2017-12-20T14:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21766#issuecomment-317952",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:22'></a>followup in #24409
