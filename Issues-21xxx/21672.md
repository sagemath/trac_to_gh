# Issue 21672: Add a lock around running pip

archive/issues_021435.json:
```json
{
    "assignees": [],
    "body": "Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.\n\n**First race condition:**\n\n```\n[backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4\n[pytz-2016.4.p0] Traceback (most recent call last):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/bin/pip\", line 9, in <module>\n[pytz-2016.4.p0]     load_entry_point('pip==8.1.2', 'console_scripts', 'pip')()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 542, in load_entry_point\n[pytz-2016.4.p0]     return get_distribution(dist).load_entry_point(group, name)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2569, in load_entry_point\n[pytz-2016.4.p0]     return ep.load()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2229, in load\n[pytz-2016.4.p0]     return self.resolve()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py\", line 2235, in resolve\n[pytz-2016.4.p0]     module = __import__(self.module_name, fromlist=['__name__'], level=0)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/__init__.py\", line 14, in <module>\n[pytz-2016.4.p0]     from pip.utils import get_installed_distributions, get_prog\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/utils/__init__.py\", line 27, in <module>\n[pytz-2016.4.p0]     from pip._vendor import pkg_resources\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2927, in <module>\n[pytz-2016.4.p0]     @_call_aside\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2913, in _call_aside\n[pytz-2016.4.p0]     f(*args, **kwargs)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 2940, in _initialize_master_working_set\n[pytz-2016.4.p0]     working_set = WorkingSet._build_master()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 626, in _build_master\n[pytz-2016.4.p0]     ws = cls()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 619, in __init__\n[pytz-2016.4.p0]     self.add_entry(entry)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 675, in add_entry\n[pytz-2016.4.p0]     for dist in find_distributions(entry, True):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1942, in find_eggs_in_zip\n[pytz-2016.4.p0]     if metadata.has_metadata('PKG-INFO'):\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1463, in has_metadata\n[pytz-2016.4.p0]     return self.egg_info and self._has(self._fn(self.egg_info, name))\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1824, in _has\n[pytz-2016.4.p0]     return zip_path in self.zipinfo or zip_path in self._index()\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1704, in zipinfo\n[pytz-2016.4.p0]     return self._zip_manifests.load(self.loader.archive)\n[pytz-2016.4.p0]   File \"/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py\", line 1644, in load\n[pytz-2016.4.p0]     mtime = os.stat(path).st_mtime\n[pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'\n```\nThe same error can also happen in the non-vendored `pkg_resources` package, which is part of `setuptools`.\n\n**Second race condition:**\n\nSome vendored packages inside `pip` conditionally import certain packages. One example from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`:\n\n```python\ntry:\n    from certifi import where\nexcept ImportError:\n    def where():\n        \"\"\"Return the preferred certificate bundle.\"\"\"\n        # vendored bundle inside Requests\n        return os.path.join(os.path.dirname(__file__), 'cacert.pem')\n```\nThis is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`.\n\n**Third race condition:**\nThe file `local/bin/pip` contains the line\n\n```\nfrom pkg_resources import load_entry_point\n```\nIt turns out that `pkg_resources` actually imports the packages `zope` and `mpl_toolkit` (from matplotlib) due to these packages having `.pth` files. This is again a race condition.\n\n**Note:** it seems that these race conditions only happen while *uninstalling* a package.\n\nCC:  @embray\n\nBranch: **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**\n\nReviewer: **Erik Bray, Volker Braun**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21672_\n\n",
    "closed_at": "2016-10-15T10:25:17Z",
    "created_at": "2016-10-09T18:21:02Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Add a lock around running pip",
    "type": "issue",
    "updated_at": "2016-10-19T06:47:45Z",
    "url": "https://github.com/sagemath/sage/issues/21672",
    "user": "https://github.com/jdemeyer"
}
```
Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.

**First race condition:**

```
[backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4
[pytz-2016.4.p0] Traceback (most recent call last):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/bin/pip", line 9, in <module>
[pytz-2016.4.p0]     load_entry_point('pip==8.1.2', 'console_scripts', 'pip')()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 542, in load_entry_point
[pytz-2016.4.p0]     return get_distribution(dist).load_entry_point(group, name)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2569, in load_entry_point
[pytz-2016.4.p0]     return ep.load()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2229, in load
[pytz-2016.4.p0]     return self.resolve()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pkg_resources/__init__.py", line 2235, in resolve
[pytz-2016.4.p0]     module = __import__(self.module_name, fromlist=['__name__'], level=0)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/__init__.py", line 14, in <module>
[pytz-2016.4.p0]     from pip.utils import get_installed_distributions, get_prog
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/utils/__init__.py", line 27, in <module>
[pytz-2016.4.p0]     from pip._vendor import pkg_resources
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2927, in <module>
[pytz-2016.4.p0]     @_call_aside
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2913, in _call_aside
[pytz-2016.4.p0]     f(*args, **kwargs)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[pytz-2016.4.p0]     working_set = WorkingSet._build_master()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 626, in _build_master
[pytz-2016.4.p0]     ws = cls()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 619, in __init__
[pytz-2016.4.p0]     self.add_entry(entry)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 675, in add_entry
[pytz-2016.4.p0]     for dist in find_distributions(entry, True):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[pytz-2016.4.p0]     if metadata.has_metadata('PKG-INFO'):
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1463, in has_metadata
[pytz-2016.4.p0]     return self.egg_info and self._has(self._fn(self.egg_info, name))
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1824, in _has
[pytz-2016.4.p0]     return zip_path in self.zipinfo or zip_path in self._index()
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1704, in zipinfo
[pytz-2016.4.p0]     return self._zip_manifests.load(self.loader.archive)
[pytz-2016.4.p0]   File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/pip-8.1.2-py2.7.egg/pip/_vendor/pkg_resources/__init__.py", line 1644, in load
[pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
[pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
```
The same error can also happen in the non-vendored `pkg_resources` package, which is part of `setuptools`.

**Second race condition:**

Some vendored packages inside `pip` conditionally import certain packages. One example from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`:

```python
try:
    from certifi import where
except ImportError:
    def where():
        """Return the preferred certificate bundle."""
        # vendored bundle inside Requests
        return os.path.join(os.path.dirname(__file__), 'cacert.pem')
```
This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`.

**Third race condition:**
The file `local/bin/pip` contains the line

```
from pkg_resources import load_entry_point
```
It turns out that `pkg_resources` actually imports the packages `zope` and `mpl_toolkit` (from matplotlib) due to these packages having `.pth` files. This is again a race condition.

**Note:** it seems that these race conditions only happen while *uninstalling* a package.

CC:  @embray

Branch: **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**

Reviewer: **Erik Bray, Volker Braun**

Author: **Jeroen Demeyer**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/21672_





---

archive/issue_events_304170.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-09T18:21:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304170"
}
```



---

archive/issue_events_304171.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-09T18:21:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304171"
}
```



---

archive/issue_events_304172.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-09T18:21:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304172"
}
```



---

archive/issue_events_304173.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-09T18:21:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304173"
}
```



---

archive/issue_comments_318480.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster). Although I did a `make distclean` and the Sage build went without problems, so it might not be related.",
    "created_at": "2016-10-09T18:58:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318480",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:1" align="right">comment:1</div>

I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster). Although I did a `make distclean` and the Sage build went without problems, so it might not be related.



---

archive/issue_comments_318481.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReplying to [@tscrim](#comment:1):\n> I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster).\n\nThe building of Python packages now involves uninstalling the packages first. See #21441.\n\n> Although I did a `make distclean` and the Sage build went without problems, so it might not be related.\n\nOr it further proves my hypothesis that the problems happen only while *uninstalling* a package. If you do `make distclean` first, there is nothing to uninstall.",
    "created_at": "2016-10-10T06:01:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318481",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

Replying to [@tscrim](#comment:1):
> I might have run into something like this when doing an incremental build from 7.4.beta6 to 7.4.rc0. I was getting failures trying to *build* a bunch of pip packages (e.g. alabaster).

The building of Python packages now involves uninstalling the packages first. See #21441.

> Although I did a `make distclean` and the Sage build went without problems, so it might not be related.

Or it further proves my hypothesis that the problems happen only while *uninstalling* a package. If you do `make distclean` first, there is nothing to uninstall.



---

archive/issue_comments_318482.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -43,4 +43,4 @@\n [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime\n [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'\n ```\n-Possibly, this race condition only happens while *uninstalling* a package.\n+It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.\n``````\n",
    "created_at": "2016-10-10T08:04:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318482",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -43,4 +43,4 @@
 [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
 [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
 ```
-Possibly, this race condition only happens while *uninstalling* a package.
+It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.
``````




---

archive/issue_comments_318483.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.  It was never really designed to be run in parallel like this.  Previously this was achieved in a patch sage has for setuptools (which impacted locking around easy_install).  With easy_install the situation was much more severe, and could cause broken installation.  I don't think pip has many problems surrounding installation, but I can see how it could break like this during uninstallation.\n\nJeroen is right that this specific issue was egg-related.  I don't know if there are other similar issues that could occur though even without eggs.",
    "created_at": "2016-10-10T14:51:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318483",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.  It was never really designed to be run in parallel like this.  Previously this was achieved in a patch sage has for setuptools (which impacted locking around easy_install).  With easy_install the situation was much more severe, and could cause broken installation.  I don't think pip has many problems surrounding installation, but I can see how it could break like this during uninstallation.

Jeroen is right that this specific issue was egg-related.  I don't know if there are other similar issues that could occur though even without eggs.



---

archive/issue_comments_318484.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@embray](#comment:4):\n> I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.\n\nOr a\n\n```\ntry:\n    ...\nexcept OSError:\n    pass\n```\nin the right place. But then you have to understand the code better.",
    "created_at": "2016-10-10T14:59:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318484",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@embray](#comment:4):
> I'm inclined to think we need some kind of lock around running `pip`, or at least when uninstalling.

Or a

```
try:
    ...
except OSError:
    pass
```
in the right place. But then you have to understand the code better.



---

archive/issue_comments_318485.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI specifically meant without patching anything (i.e. something at the level of `sage-pip-install`).  Though a patch that can submitted upstream would be good too.",
    "created_at": "2016-10-10T15:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318485",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

I specifically meant without patching anything (i.e. something at the level of `sage-pip-install`).  Though a patch that can submitted upstream would be good too.



---

archive/issue_comments_318486.json:
```json
{
    "body": "Branch: **[u/jdemeyer/race_condition_in_pkg_resources](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/race_condition_in_pkg_resources)**",
    "created_at": "2016-10-10T20:19:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318486",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/race_condition_in_pkg_resources](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/race_condition_in_pkg_resources)**



---

archive/issue_comments_318487.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nGood, I'm glad this was caught. On an incremental build from 7.4.beta6 to 7.4.rc0 I guess I had to type `make` close to 10 times before Sage and the docs were built. I assumed perhaps a `slow` download connection interfered with parallel building. But this seems much more reasonable.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c\">f9e8acb</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>\n",
    "created_at": "2016-10-10T23:37:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318487",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:8" align="right">comment:8</div>

Good, I'm glad this was caught. On an incremental build from 7.4.beta6 to 7.4.rc0 I guess I had to type `make` close to 10 times before Sage and the docs were built. I assumed perhaps a `slow` download connection interfered with parallel building. But this seems much more reasonable.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c">f9e8acb</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>




---

archive/issue_comments_318488.json:
```json
{
    "body": "Commit: **[`f9e8acb`](https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c)**",
    "created_at": "2016-10-10T23:37:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318488",
    "user": "https://github.com/strogdon"
}
```

Commit: **[`f9e8acb`](https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c)**



---

archive/issue_comments_318489.json:
```json
{
    "body": "Changed commit from **[`f9e8acb`](https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c)** to **[`20f48e5`](https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002)**",
    "created_at": "2016-10-11T07:43:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318489",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f9e8acb`](https://github.com/sagemath/sagetrac-mirror/commit/f9e8acb62490fb4392f1988205a06f6c28f9e15c)** to **[`20f48e5`](https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002)**



---

archive/issue_comments_318490.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002\">20f48e5</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>\n",
    "created_at": "2016-10-11T07:43:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318490",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002">20f48e5</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>




---

archive/issue_events_304174.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T07:46:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304174"
}
```



---

archive/issue_comments_318491.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThis patch seems to fix the issues within Sage. Erik, what do you think?",
    "created_at": "2016-10-11T07:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318491",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

This patch seems to fix the issues within Sage. Erik, what do you think?



---

archive/issue_comments_318492.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2016-10-11T07:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318492",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_events_304175.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T08:11:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304175"
}
```



---

archive/issue_events_304176.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T08:11:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304176"
}
```



---

archive/issue_comments_318493.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -43,4 +43,23 @@\n [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime\n [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'\n ```\n+A similar error which can happen:\n+\n+```\n+Traceback (most recent call last):\n+  File \"/usr/local/src/sage-config/local/bin/pip\", line 5, in <module>\n+    from pkg_resources import load_entry_point\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2927, in <module>\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2913, in _call_aside\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2952, in _initialize_master_working_set\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 956, in subscribe\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2952, in <lambda>\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2513, in activate\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2502, in _get_metadata\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1463, in has_metadata\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1824, in _has\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1704, in zipinfo\n+  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1644, in load\n+OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools_scm-1.11.1-py2.7.egg'\n+```\n It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.\n``````\n",
    "created_at": "2016-10-11T08:12:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318493",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -43,4 +43,23 @@
 [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
 [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
 ```
+A similar error which can happen:
+
+```
+Traceback (most recent call last):
+  File "/usr/local/src/sage-config/local/bin/pip", line 5, in <module>
+    from pkg_resources import load_entry_point
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2927, in <module>
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2913, in _call_aside
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2952, in _initialize_master_working_set
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 956, in subscribe
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2952, in <lambda>
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2513, in activate
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2502, in _get_metadata
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1463, in has_metadata
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1824, in _has
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1704, in zipinfo
+  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1644, in load
+OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools_scm-1.11.1-py2.7.egg'
+```
 It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.
``````




---

archive/issue_comments_318494.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAny idea how to interpret this traceback?\n\n```\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2913, in _call_aside\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2940, in _initialize_master_working_set\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 626, in _build_master\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 619, in __init__\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 675, in add_entry\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1942, in find_eggs_in_zip\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1463, in has_metadata\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1824, in _has\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1704, in zipinfo\n[python_openid-2.2.5.p0]   File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1644, in load\n[python_openid-2.2.5.p0] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/pathlib2-2.1.0-py2.7.egg'\n```\n\nWhy does it refer to files in `build/bdist.linux-x86_64/egg/pkg_resources`? Where is that place?",
    "created_at": "2016-10-11T08:25:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318494",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Any idea how to interpret this traceback?

```
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2913, in _call_aside
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2940, in _initialize_master_working_set
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 626, in _build_master
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 619, in __init__
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 675, in add_entry
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1942, in find_eggs_in_zip
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1463, in has_metadata
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1824, in _has
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1704, in zipinfo
[python_openid-2.2.5.p0]   File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1644, in load
[python_openid-2.2.5.p0] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/pathlib2-2.1.0-py2.7.egg'
```

Why does it refer to files in `build/bdist.linux-x86_64/egg/pkg_resources`? Where is that place?



---

archive/issue_comments_318495.json:
```json
{
    "body": "Changed commit from **[`20f48e5`](https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002)** to **[`3f1f64a`](https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659)**",
    "created_at": "2016-10-11T08:25:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318495",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`20f48e5`](https://github.com/sagemath/sagetrac-mirror/commit/20f48e54faf81c65339b542a9cf287ca5af03002)** to **[`3f1f64a`](https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659)**



---

archive/issue_comments_318496.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659\">3f1f64a</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>\n",
    "created_at": "2016-10-11T08:25:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318496",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659">3f1f64a</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>




---

archive/issue_comments_318497.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAnswering my own question:\n\n```\n>>> import pkg_resources\n>>> pkg_resources.__file__\n'/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools-24.0.2-py2.7.egg/pkg_resources/__init__.pyc'\n```\n\nSo `setuptools` also has a copy of `pkg_resources` (inside an egg, so `find` doesn't find it and tracebacks are hard to interpret)",
    "created_at": "2016-10-11T08:29:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318497",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Answering my own question:

```
>>> import pkg_resources
>>> pkg_resources.__file__
'/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools-24.0.2-py2.7.egg/pkg_resources/__init__.pyc'
```

So `setuptools` also has a copy of `pkg_resources` (inside an egg, so `find` doesn't find it and tracebacks are hard to interpret)



---

archive/issue_comments_318498.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6\">3512026</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>\n",
    "created_at": "2016-10-11T08:36:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318498",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6">3512026</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>




---

archive/issue_comments_318499.json:
```json
{
    "body": "Changed commit from **[`3f1f64a`](https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659)** to **[`3512026`](https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6)**",
    "created_at": "2016-10-11T08:36:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318499",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3f1f64a`](https://github.com/sagemath/sagetrac-mirror/commit/3f1f64a86e7697f044f160fa9841319649242659)** to **[`3512026`](https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6)**



---

archive/issue_comments_318500.json:
```json
{
    "body": "Changed commit from **[`3512026`](https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6)** to **[`fcbcf7e`](https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f)**",
    "created_at": "2016-10-11T09:12:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318500",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3512026`](https://github.com/sagemath/sagetrac-mirror/commit/3512026282a5724d3d8cce9cc45ba9c736577eb6)** to **[`fcbcf7e`](https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f)**



---

archive/issue_comments_318501.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f\">fcbcf7e</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>\n",
    "created_at": "2016-10-11T09:12:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318501",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f">fcbcf7e</a></td><td><code>Fix race condition in pip while uninstalling an egg</code></td></tr></table>




---

archive/issue_events_304177.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T11:55:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304177"
}
```



---

archive/issue_events_304178.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T11:55:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304178"
}
```



---

archive/issue_comments_318502.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK, I needed a few iterations to get this right. But now it seems to work.\n\nThe way I tested this:\n\n1. Build `sage-7.4.beta2` (the last version before #20218).\n\n2. Build `sage-7.4.beta6` (the last version before #21441).\n\n3. Build this branch with lots of processes.",
    "created_at": "2016-10-11T11:55:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318502",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

OK, I needed a few iterations to get this right. But now it seems to work.

The way I tested this:

1. Build `sage-7.4.beta2` (the last version before #20218).

2. Build `sage-7.4.beta6` (the last version before #21441).

3. Build this branch with lots of processes.



---

archive/issue_comments_318503.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.\n\n`pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.",
    "created_at": "2016-10-11T12:23:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318503",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.

`pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.



---

archive/issue_comments_318504.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nRegarding the last comment, this kind of code is problematic (example taken from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`):\n\n```python\ntry:\n    from certifi import where\nexcept ImportError:\n    def where():\n        \"\"\"Return the preferred certificate bundle.\"\"\"\n        # vendored bundle inside Requests\n        return os.path.join(os.path.dirname(__file__), 'cacert.pem')\n```\n\nIt is possible that one `pip` instance runs `from certifi import where` while another `pip` instance uninstalls `certifi` at the same time.",
    "created_at": "2016-10-11T12:36:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318504",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Regarding the last comment, this kind of code is problematic (example taken from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`):

```python
try:
    from certifi import where
except ImportError:
    def where():
        """Return the preferred certificate bundle."""
        # vendored bundle inside Requests
        return os.path.join(os.path.dirname(__file__), 'cacert.pem')
```

It is possible that one `pip` instance runs `from certifi import where` while another `pip` instance uninstalls `certifi` at the same time.



---

archive/issue_comments_318505.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nRight--my problem with this approach to fixing it is that I don't think pip was meant to run in parallel at all--much less when it's also uninstalling things.\n\nSprinkling the code with ignored `OSError`s in various places is probably not a solution that will be accepted upstream, where one would instead want more careful design to allow parallel execution in a consistent manner.\n\nThat said, if this works around the issue for our purposes for now I'm fine with it.  The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.",
    "created_at": "2016-10-11T12:38:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318505",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Right--my problem with this approach to fixing it is that I don't think pip was meant to run in parallel at all--much less when it's also uninstalling things.

Sprinkling the code with ignored `OSError`s in various places is probably not a solution that will be accepted upstream, where one would instead want more careful design to allow parallel execution in a consistent manner.

That said, if this works around the issue for our purposes for now I'm fine with it.  The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.



---

archive/issue_comments_318506.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2016-10-11T12:38:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318506",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_events_304179.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T12:38:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304179"
}
```



---

archive/issue_events_304180.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T12:38:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304180"
}
```



---

archive/issue_comments_318507.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@jdemeyer](#comment:19):\n> I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.\n> \n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nRight.  This is why I was suggesting a lock around pip itself.  Especially an \"uninstall\" lock--don't let any other pip run if one pip is uninstalling.",
    "created_at": "2016-10-11T12:41:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318507",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@jdemeyer](#comment:19):
> I found a different independent problem with `pip`, which is harder to reproduce. Since it is an independent problem, it should not block this ticket.
> 
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.



---

archive/issue_comments_318508.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@embray](#comment:21):\n> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n\nThat doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.",
    "created_at": "2016-10-11T12:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318508",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@embray](#comment:21):
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.



---

archive/issue_comments_318509.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jdemeyer](#comment:19):\n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nI am currently trying to determine how serious this is. If it's just a few places (which is what I would guess), then we can patch those to always use the vendored package.",
    "created_at": "2016-10-11T13:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318509",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jdemeyer](#comment:19):
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

I am currently trying to determine how serious this is. If it's just a few places (which is what I would guess), then we can patch those to always use the vendored package.



---

archive/issue_comments_318510.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@embray](#comment:22):\n> Right.  This is why I was suggesting a lock around pip itself.  Especially an \"uninstall\" lock--don't let any other pip run if one pip is uninstalling.\n\nI don't like that since it would slow down parallel builds.\n\nOf course, if it's the only feasible solution, we should go for that.",
    "created_at": "2016-10-11T13:05:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318510",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@embray](#comment:22):
> Right.  This is why I was suggesting a lock around pip itself.  Especially an "uninstall" lock--don't let any other pip run if one pip is uninstalling.

I don't like that since it would slow down parallel builds.

Of course, if it's the only feasible solution, we should go for that.



---

archive/issue_comments_318511.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI mean, of course the ideal solution would be if pip could run sensibly in parallel, but that might be intractable for some of the reasons you've raised.  It might not have much impact--uninstalling, after all, is little more than removing some directories--probably most of the overhead is just in process startup/shutdown.",
    "created_at": "2016-10-11T13:31:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318511",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

I mean, of course the ideal solution would be if pip could run sensibly in parallel, but that might be intractable for some of the reasons you've raised.  It might not have much impact--uninstalling, after all, is little more than removing some directories--probably most of the overhead is just in process startup/shutdown.



---

archive/issue_comments_318512.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:23):\n> Replying to [@embray](#comment:21):\n> > The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n\n> \n> That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.\n\nRight, so you would have to handle OSError in there too in some sensible way.",
    "created_at": "2016-10-11T13:33:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318512",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:23):
> Replying to [@embray](#comment:21):
> > The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

> 
> That doesn't work since also `metadata.resource_listdir('/')` can raise `OSError`.

Right, so you would have to handle OSError in there too in some sensible way.



---

archive/issue_comments_318513.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@jdemeyer](#comment:19):\n> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.\n\nTo solve this issue, I see 3 posssible solutions:\n\n1. Ensure that `sys.path` only contains the Python standard library directories (in particular, not `site-packages`) while running `pip`.\n\n2. Change the vendored code inside `pip` to not import any non-vendored libraries. For example, the code from [comment:20] could be changed to just define `def where()` unconditionally.\n\n3. Implement a locking mechanism while running `pip` (which would immediately solve all race conditions with `pip` but would slow down a parallel build).\n\nErik, what is your opinion?",
    "created_at": "2016-10-11T15:23:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318513",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@jdemeyer](#comment:19):
> `pip` (indirectly) imports various Python packages. Sometimes it can happen that one `pip` instance imports a package while a different `pip` instance uninstalls that package. This is obviously problematic.

To solve this issue, I see 3 posssible solutions:

1. Ensure that `sys.path` only contains the Python standard library directories (in particular, not `site-packages`) while running `pip`.

2. Change the vendored code inside `pip` to not import any non-vendored libraries. For example, the code from [comment:20] could be changed to just define `def where()` unconditionally.

3. Implement a locking mechanism while running `pip` (which would immediately solve all race conditions with `pip` but would slow down a parallel build).

Erik, what is your opinion?



---

archive/issue_comments_318514.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n!#3 is my favorite as I've probably already expressed.  But it's also harder/more work, but do-able.  So for now I like a combination of !#1 and !#2.  For !#2 I wonder if it wouldn't be worth adding a global flag somewhere to pip that explicitly prevents it from using any non-vendored libs, as that would be a solution that might be worth offering upstream.",
    "created_at": "2016-10-11T15:45:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318514",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

!#3 is my favorite as I've probably already expressed.  But it's also harder/more work, but do-able.  So for now I like a combination of !#1 and !#2.  For !#2 I wonder if it wouldn't be worth adding a global flag somewhere to pip that explicitly prevents it from using any non-vendored libs, as that would be a solution that might be worth offering upstream.



---

archive/issue_comments_318515.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@embray](#comment:29):\n> So for now I like a combination of !#1 and !#2.\n\nI don't quite understand what you mean with \"combination\". Either solution individually fixes the problem.",
    "created_at": "2016-10-11T18:20:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318515",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@embray](#comment:29):
> So for now I like a combination of !#1 and !#2.

I don't quite understand what you mean with "combination". Either solution individually fixes the problem.



---

archive/issue_comments_318516.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI have an idea to implement !#1. I'll see if I can make it work.",
    "created_at": "2016-10-12T08:13:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318516",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

I have an idea to implement !#1. I'll see if I can make it work.



---

archive/issue_comments_318517.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nAfter re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.",
    "created_at": "2016-10-12T08:48:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318517",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.



---

archive/issue_comments_318518.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@embray](#comment:21):\n> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.\n\nI looked into this a bit more and I honestly think that the current places where I added `OSError` are optimal. Putting the exception handling to a lower level might not necessarily make sense. For example, I don't know if every instance of `os.listdir()` should be guarded by a `except OSError`.\n\nThat being said, if you have a very concrete proposal on how to structure the exception handling, I'm listening.",
    "created_at": "2016-10-12T09:15:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318518",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@embray](#comment:21):
> The only thing I might change (but maybe it doesn't matter?) is to make a few of those try/excepts a little more localized--specifically just right around the `find_egg_in_zip` calls.

I looked into this a bit more and I honestly think that the current places where I added `OSError` are optimal. Putting the exception handling to a lower level might not necessarily make sense. For example, I don't know if every instance of `os.listdir()` should be guarded by a `except OSError`.

That being said, if you have a very concrete proposal on how to structure the exception handling, I'm listening.



---

archive/issue_comments_318519.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nOkay--you've spent more time playing with it than I have so I trust your judgment on that.  It's still a terrible patch but that's not your fault--again it just goes back to pip not being designed for this in the first place.",
    "created_at": "2016-10-12T09:35:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318519",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">comment:34</div>

Okay--you've spent more time playing with it than I have so I trust your judgment on that.  It's still a terrible patch but that's not your fault--again it just goes back to pip not being designed for this in the first place.



---

archive/issue_events_304181.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-12T09:43:39Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "title_is": "Race conditions in pkg_resources",
    "title_was": "Race condition in pkg_resources",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304181"
}
```



---

archive/issue_comments_318520.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.\n \n-Example:\n+**First race condition:**\n \n ```\n [backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4\n@@ -43,23 +43,21 @@\n [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime\n [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'\n ```\n-A similar error which can happen:\n+The same error can also happen in the non-vendored `pkg_resources` package, which is part of `setuptools`.\n \n+**Second race condition:**\n+\n+Some vendored packages inside `pip` conditionally import certain packages. One example from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`:\n+\n+```python\n+try:\n+    from certifi import where\n+except ImportError:\n+    def where():\n+        \"\"\"Return the preferred certificate bundle.\"\"\"\n+        # vendored bundle inside Requests\n+        return os.path.join(os.path.dirname(__file__), 'cacert.pem')\n ```\n-Traceback (most recent call last):\n-  File \"/usr/local/src/sage-config/local/bin/pip\", line 5, in <module>\n-    from pkg_resources import load_entry_point\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2927, in <module>\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2913, in _call_aside\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2952, in _initialize_master_working_set\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 956, in subscribe\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2952, in <lambda>\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2513, in activate\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2502, in _get_metadata\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1463, in has_metadata\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1824, in _has\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1704, in zipinfo\n-  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 1644, in load\n-OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools_scm-1.11.1-py2.7.egg'\n-```\n-It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.\n+This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`. The solution is to avoid importing anything from `site-packages` while running `pip` (except for `setuptools` and `pip` itself).\n+\n+**Note:** it seems that these race conditions only happen while *uninstalling* a package.\n``````\n",
    "created_at": "2016-10-12T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318520",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Just like `setuptools` (#13201), `pkg_resources` (vendored by `pip` or stand-alone) has race conditions when building in parallel.
 
-Example:
+**First race condition:**
 
 ```
 [backports_abc-0.4.p0]   Successfully uninstalled backports-abc-0.4
@@ -43,23 +43,21 @@
 [pytz-2016.4.p0]     mtime = os.stat(path).st_mtime
 [pytz-2016.4.p0] OSError: [Errno 2] No such file or directory: '/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/backports_abc-0.4-py2.7.egg'
 ```
-A similar error which can happen:
+The same error can also happen in the non-vendored `pkg_resources` package, which is part of `setuptools`.
 
+**Second race condition:**
+
+Some vendored packages inside `pip` conditionally import certain packages. One example from `local/lib/python/site-packages/pip/_vendor/requests/certs.py`:
+
+```python
+try:
+    from certifi import where
+except ImportError:
+    def where():
+        """Return the preferred certificate bundle."""
+        # vendored bundle inside Requests
+        return os.path.join(os.path.dirname(__file__), 'cacert.pem')
 ```
-Traceback (most recent call last):
-  File "/usr/local/src/sage-config/local/bin/pip", line 5, in <module>
-    from pkg_resources import load_entry_point
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2927, in <module>
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2913, in _call_aside
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2952, in _initialize_master_working_set
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 956, in subscribe
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2952, in <lambda>
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2513, in activate
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2502, in _get_metadata
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1463, in has_metadata
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1824, in _has
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1704, in zipinfo
-  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 1644, in load
-OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/setuptools_scm-1.11.1-py2.7.egg'
-```
-It seems that this problem only happens while *uninstalling* a package which was previously installed as egg.
+This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`. The solution is to avoid importing anything from `site-packages` while running `pip` (except for `setuptools` and `pip` itself).
+
+**Note:** it seems that these race conditions only happen while *uninstalling* a package.
``````




---

archive/issue_comments_318521.json:
```json
{
    "body": "<div id=\"comment:36\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398\">c1753b9</a></td><td><code>While running pip, do not import from site-packages</code></td></tr></table>\n",
    "created_at": "2016-10-12T09:52:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318521",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:36"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398">c1753b9</a></td><td><code>While running pip, do not import from site-packages</code></td></tr></table>




---

archive/issue_comments_318522.json:
```json
{
    "body": "Changed commit from **[`fcbcf7e`](https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f)** to **[`c1753b9`](https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398)**",
    "created_at": "2016-10-12T09:52:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318522",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fcbcf7e`](https://github.com/sagemath/sagetrac-mirror/commit/fcbcf7e2112ed87cf33e6f7bff6510223e4ce29f)** to **[`c1753b9`](https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398)**



---

archive/issue_comments_318523.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@embray](#comment:32):\n> After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.\n\nSee my last commit. I have not fully tested this yet.",
    "created_at": "2016-10-12T09:57:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318523",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@embray](#comment:32):
> After re-reading I'm not quite sure now what you mean by !#1, so I'll wait to see your idea.

See my last commit. I have not fully tested this yet.



---

archive/issue_comments_318524.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nLooking at some `strace` outputs, `pkg_resources` is totally crazy.\n\nWhen doing `import pkg_resources`, it attempts to open the file `/usr/local/src/sage-git/local/lib/python2.7/site-packages/zope.py` 81 times (failing 81 times).\n\nSimilarly, it tries to open `/usr/local/src/sage-git/local/lib/python2.7/site-packages/mpl_toolkits.py` 45 times (failing 45 times).\n\nI guess this is related to the fact that these define special `.pth` files:\n\n```\n$ ls -l local/lib/python2.7/site-packages/*.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 314 Oct 12 12:23 local/lib/python2.7/site-packages/configparser-3.5.0-py2.7-nspkg.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 256 Sep 23 14:41 local/lib/python2.7/site-packages/easy-install.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 323 Oct 12 12:20 local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-nspkg.pth\n-rw-r--r-- 1 jdemeyer jdemeyer 299 Oct 12 12:16 local/lib/python2.7/site-packages/zope.interface-4.2.0-py2.7-nspkg.pth\n```",
    "created_at": "2016-10-12T11:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318524",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Looking at some `strace` outputs, `pkg_resources` is totally crazy.

When doing `import pkg_resources`, it attempts to open the file `/usr/local/src/sage-git/local/lib/python2.7/site-packages/zope.py` 81 times (failing 81 times).

Similarly, it tries to open `/usr/local/src/sage-git/local/lib/python2.7/site-packages/mpl_toolkits.py` 45 times (failing 45 times).

I guess this is related to the fact that these define special `.pth` files:

```
$ ls -l local/lib/python2.7/site-packages/*.pth
-rw-r--r-- 1 jdemeyer jdemeyer 314 Oct 12 12:23 local/lib/python2.7/site-packages/configparser-3.5.0-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 256 Sep 23 14:41 local/lib/python2.7/site-packages/easy-install.pth
-rw-r--r-- 1 jdemeyer jdemeyer 323 Oct 12 12:20 local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-nspkg.pth
-rw-r--r-- 1 jdemeyer jdemeyer 299 Oct 12 12:16 local/lib/python2.7/site-packages/zope.interface-4.2.0-py2.7-nspkg.pth
```



---

archive/issue_comments_318525.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nSo `pkg_resources` actually *imports* `mpl_toolkit` and `zope` (and those are the only 2 packages that it imports from `site-packages` apart from `pkg_resources` itself). That's bad since it is yet another race condition.\n\nI'm starting to believe you that we should go for the lock.",
    "created_at": "2016-10-12T11:48:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318525",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

So `pkg_resources` actually *imports* `mpl_toolkit` and `zope` (and those are the only 2 packages that it imports from `site-packages` apart from `pkg_resources` itself). That's bad since it is yet another race condition.

I'm starting to believe you that we should go for the lock.



---

archive/issue_comments_318526.json:
```json
{
    "body": "<div id=\"comment:40\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55\">f3a420d</a></td><td><code>While running pip, do not import from site-packages</code></td></tr></table>\n",
    "created_at": "2016-10-12T11:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318526",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:40"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55">f3a420d</a></td><td><code>While running pip, do not import from site-packages</code></td></tr></table>




---

archive/issue_comments_318527.json:
```json
{
    "body": "Changed commit from **[`c1753b9`](https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398)** to **[`f3a420d`](https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55)**",
    "created_at": "2016-10-12T11:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318527",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c1753b9`](https://github.com/sagemath/sagetrac-mirror/commit/c1753b91afafe6d5b6efa1422397f38561682398)** to **[`f3a420d`](https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55)**



---

archive/issue_comments_318528.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nOK, I give up.\n\nThis is a much bigger can of worms than I originally anticipated.\n\nI'll look into the lock.",
    "created_at": "2016-10-12T12:11:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318528",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:41" align="right">comment:41</div>

OK, I give up.

This is a much bigger can of worms than I originally anticipated.

I'll look into the lock.



---

archive/issue_comments_318529.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -58,6 +58,14 @@\n         # vendored bundle inside Requests\n         return os.path.join(os.path.dirname(__file__), 'cacert.pem')\n ```\n-This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`. The solution is to avoid importing anything from `site-packages` while running `pip` (except for `setuptools` and `pip` itself).\n+This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`.\n+\n+**Third race condition:**\n+The file `local/bin/pip` contains the line\n+\n+```\n+from pkg_resources import load_entry_point\n+```\n+It turns out that `pkg_resources` actually imports the packages `zope` and `mpl_toolkit` (from matplotlib) due to these packages having `.pth` files. This is again a race condition.\n \n **Note:** it seems that these race conditions only happen while *uninstalling* a package.\n``````\n",
    "created_at": "2016-10-12T12:11:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318529",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -58,6 +58,14 @@
         # vendored bundle inside Requests
         return os.path.join(os.path.dirname(__file__), 'cacert.pem')
 ```
-This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`. The solution is to avoid importing anything from `site-packages` while running `pip` (except for `setuptools` and `pip` itself).
+This is bad because it can happen that we are (un)installing `certify` while running a different instance of `pip`.
+
+**Third race condition:**
+The file `local/bin/pip` contains the line
+
+```
+from pkg_resources import load_entry_point
+```
+It turns out that `pkg_resources` actually imports the packages `zope` and `mpl_toolkit` (from matplotlib) due to these packages having `.pth` files. This is again a race condition.
 
 **Note:** it seems that these race conditions only happen while *uninstalling* a package.
``````




---

archive/issue_events_304182.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-12T12:13:48Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "title_is": "Add a lock around running pip",
    "title_was": "Race conditions in pkg_resources",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304182"
}
```



---

archive/issue_comments_318530.json:
```json
{
    "body": "<div id=\"comment:43\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c5bc7b5cc414ff5fbfbb8acd9a0ba3026f39e14c\">c5bc7b5</a></td><td><code>Use $PIP_INSTALL instead of manually running pip</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27\">75c1fff</a></td><td><code>Add a lock around running pip</code></td></tr></table>\n",
    "created_at": "2016-10-12T13:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318530",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:43"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c5bc7b5cc414ff5fbfbb8acd9a0ba3026f39e14c">c5bc7b5</a></td><td><code>Use $PIP_INSTALL instead of manually running pip</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27">75c1fff</a></td><td><code>Add a lock around running pip</code></td></tr></table>




---

archive/issue_comments_318531.json:
```json
{
    "body": "Changed commit from **[`f3a420d`](https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55)** to **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**",
    "created_at": "2016-10-12T13:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318531",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f3a420d`](https://github.com/sagemath/sagetrac-mirror/commit/f3a420dbff6e78ad68ce15062c8c9be240482d55)** to **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**



---

archive/issue_events_304183.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-12T13:50:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304183"
}
```



---

archive/issue_events_304184.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-12T13:50:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304184"
}
```



---

archive/issue_comments_318532.json:
```json
{
    "body": "Changed reviewer from **Erik Bray** to **Erik Bray, Volker Braun**",
    "created_at": "2016-10-12T22:13:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318532",
    "user": "https://github.com/vbraun"
}
```

Changed reviewer from **Erik Bray** to **Erik Bray, Volker Braun**



---

archive/issue_events_304185.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-12T22:13:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304185"
}
```



---

archive/issue_events_304186.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-12T22:13:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304186"
}
```



---

archive/issue_comments_318533.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nThree things:\n\n1) If we want to implement the locking mechanism in Python (makes sense to me) might as\nwell reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.  This would further the (ideal, to me) goal of having fewer shell scripts, and would be less confusing.\n\n2) As implemented this is not at all portable, and of course portable file-locking is hard to get right.  I propose that we vendor the [fasteners](https://pypi.python.org/pypi/fasteners) module which already provides a more portable and well-tested file lock.\n\n3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n\nSince I have experience with the fasteners module I can take that over if you want.",
    "created_at": "2016-10-13T09:03:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318533",
    "user": "https://github.com/embray"
}
```

<div id="comment:46" align="right">comment:46</div>

Three things:

1) If we want to implement the locking mechanism in Python (makes sense to me) might as
well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.  This would further the (ideal, to me) goal of having fewer shell scripts, and would be less confusing.

2) As implemented this is not at all portable, and of course portable file-locking is hard to get right.  I propose that we vendor the [fasteners](https://pypi.python.org/pypi/fasteners) module which already provides a more portable and well-tested file lock.

3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

Since I have experience with the fasteners module I can take that over if you want.



---

archive/issue_events_304187.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-13T09:03:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304187"
}
```



---

archive/issue_events_304188.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-13T09:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304188"
}
```



---

archive/issue_comments_318534.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nSounds good to me but would be nice to do on another ticket so that we can release 7.4",
    "created_at": "2016-10-13T09:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318534",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:47" align="right">comment:47</div>

Sounds good to me but would be nice to do on another ticket so that we can release 7.4



---

archive/issue_events_304189.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-13T09:36:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304189"
}
```



---

archive/issue_events_304190.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-13T09:36:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304190"
}
```



---

archive/issue_comments_318535.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nIs there some rush?  I can work on this now.  And I imagine you're going to do another RC right?",
    "created_at": "2016-10-13T09:42:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318535",
    "user": "https://github.com/embray"
}
```

<div id="comment:48" align="right">comment:48</div>

Is there some rush?  I can work on this now.  And I imagine you're going to do another RC right?



---

archive/issue_comments_318536.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nReplying to [@embray](#comment:46):\n> 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n\nThat's exactly what I did.",
    "created_at": "2016-10-13T12:25:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318536",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:49" align="right">comment:49</div>

Replying to [@embray](#comment:46):
> 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

That's exactly what I did.



---

archive/issue_comments_318537.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@jdemeyer](#comment:49):\n> Replying to [@embray](#comment:46):\n> > 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.\n\n> \n> That's exactly what I did.\n\nYeah, I see that now.  I think what I meant is if using `fasteners` there isn't one built in so you have to hand-roll it with two locks, but that's simple enough.",
    "created_at": "2016-10-13T12:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318537",
    "user": "https://github.com/embray"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@jdemeyer](#comment:49):
> Replying to [@embray](#comment:46):
> > 3) I would suggest implementing a reader/writer-like lock to allow multiple `pip installs` to run simultaneously, and only prevent other `pip`s from running during a `pip uninstall`.

> 
> That's exactly what I did.

Yeah, I see that now.  I think what I meant is if using `fasteners` there isn't one built in so you have to hand-roll it with two locks, but that's simple enough.



---

archive/issue_comments_318538.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@embray](#comment:46):\n> Three things:\n> \n> 1) If we want to implement the locking mechanism in Python (makes sense to me) might as\n> well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.\n\n1. I don't see the problem with having an additional script. Even if you would implement `sage-pip-install` in Python, I would be in favour of having two scripts because you may want to run `pip` without `sage-pip-install`.\n\n2. Perhaps we might be able to push the locking of pip upstream, but that's not going to happen for `sage-pip-install`.\n\n3. Didn't you mention that you wanted to get rid of `sage-pip-install` anyway in the future?\n\n> This would further the (ideal, to me) goal of having fewer shell scripts\n\nI don't think that having few scripts should be a goal by itself.",
    "created_at": "2016-10-13T12:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318538",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@embray](#comment:46):
> Three things:
> 
> 1) If we want to implement the locking mechanism in Python (makes sense to me) might as
> well reimplement `sage-pip-install` in its entirety in Python, rather than add yet another script.

1. I don't see the problem with having an additional script. Even if you would implement `sage-pip-install` in Python, I would be in favour of having two scripts because you may want to run `pip` without `sage-pip-install`.

2. Perhaps we might be able to push the locking of pip upstream, but that's not going to happen for `sage-pip-install`.

3. Didn't you mention that you wanted to get rid of `sage-pip-install` anyway in the future?

> This would further the (ideal, to me) goal of having fewer shell scripts

I don't think that having few scripts should be a goal by itself.



---

archive/issue_comments_318539.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@embray](#comment:46):\n> 2) As implemented this is not at all portable\n\nWell, it is portable to most UNIX-like operating systems. I don't think that there is a system on which Sage runs which does not have `flock(2)`. We use it for our patch to setuptools and nobody ever complained about that.\n\nThat being said, I am not *against* using fasteners, but I agree with Volker that it's something which can be done in the future.",
    "created_at": "2016-10-13T12:41:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318539",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@embray](#comment:46):
> 2) As implemented this is not at all portable

Well, it is portable to most UNIX-like operating systems. I don't think that there is a system on which Sage runs which does not have `flock(2)`. We use it for our patch to setuptools and nobody ever complained about that.

That being said, I am not *against* using fasteners, but I agree with Volker that it's something which can be done in the future.



---

archive/issue_comments_318540.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nSince this has come up before with setuptools, what if instead of making this lock script pip-specific we just make it general?  After all, there's virtually nothing in it specific to pip.",
    "created_at": "2016-10-13T14:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318540",
    "user": "https://github.com/embray"
}
```

<div id="comment:53" align="right">comment:53</div>

Since this has come up before with setuptools, what if instead of making this lock script pip-specific we just make it general?  After all, there's virtually nothing in it specific to pip.



---

archive/issue_comments_318541.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@embray](#comment:53):\n> After all, there's virtually nothing in it specific to pip.\n\nWell, there are still various mentions of `pip` in that file (including the lock filename). And what will you do with the call\n\n```\nload_entry_point('pip', 'console_scripts', 'pip')()\n```",
    "created_at": "2016-10-13T14:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318541",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@embray](#comment:53):
> After all, there's virtually nothing in it specific to pip.

Well, there are still various mentions of `pip` in that file (including the lock filename). And what will you do with the call

```
load_entry_point('pip', 'console_scripts', 'pip')()
```



---

archive/issue_comments_318542.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nYeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.",
    "created_at": "2016-10-14T07:38:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318542",
    "user": "https://github.com/embray"
}
```

<div id="comment:55" align="right">comment:55</div>

Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.



---

archive/issue_comments_318543.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@embray](#comment:55):\n> Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.\n\nOf course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.",
    "created_at": "2016-10-14T08:45:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318543",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@embray](#comment:55):
> Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.

Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.



---

archive/issue_comments_318544.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nAnother relevant question: is this locking something that would have a chance to get accepted upstream (of course, not with this implementation and we would need to support Windows too)?\n\nSince the race conditions seem to be mostly in `pkg_resources` (part of `setuptools`), I guess that would be the most natural place to implement the locking.",
    "created_at": "2016-10-14T08:50:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318544",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:57" align="right">comment:57</div>

Another relevant question: is this locking something that would have a chance to get accepted upstream (of course, not with this implementation and we would need to support Windows too)?

Since the race conditions seem to be mostly in `pkg_resources` (part of `setuptools`), I guess that would be the most natural place to implement the locking.



---

archive/issue_comments_318545.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nI don't know. I leave it your hands.",
    "created_at": "2016-10-14T09:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318545",
    "user": "https://github.com/embray"
}
```

<div id="comment:58" align="right">comment:58</div>

I don't know. I leave it your hands.



---

archive/issue_comments_318546.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [@jdemeyer](#comment:56):\n> Replying to [@embray](#comment:55):\n> > Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.\n\n> \n> Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.\n\nI'm barely talking about anything more than making the first argument the script (where the \"SHARED\" thing really ought to be a simple flag like `-s`) the string that you hard-code as \"pip\".",
    "created_at": "2016-10-14T09:24:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318546",
    "user": "https://github.com/embray"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [@jdemeyer](#comment:56):
> Replying to [@embray](#comment:55):
> > Yeah but clearly none of that has to be hard-coded for pip.  It could wrap any command.

> 
> Of course it could, at the expense of making the script and the calling of the script more complicated. I don't care much about this. If you feel like generalizing the script, go for it. Just not on this blocker ticket.

I'm barely talking about anything more than making the first argument the script (where the "SHARED" thing really ought to be a simple flag like `-s`) the string that you hard-code as "pip".



---

archive/issue_events_304191.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-15T10:25:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304191"
}
```



---

archive/issue_events_304192.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "369aa6a31974bce191ac54bb599617e8b6a0cad4",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-10-15T10:25:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21672#event-304192"
}
```



---

archive/issue_comments_318547.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/race_condition_in_pkg_resources](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/race_condition_in_pkg_resources)** to **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**",
    "created_at": "2016-10-15T10:25:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318547",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/race_condition_in_pkg_resources](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/race_condition_in_pkg_resources)** to **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)**



---

archive/issue_comments_318548.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nIt seems like this issue puts using `pip` to install packages at odds with building in parallel. So should we not use `pip` so much, or do we not care about the speed of building that much? (I'm not complaining about the fix here at all, but I'm wondering about its consequences.)",
    "created_at": "2016-10-18T19:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318548",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:61" align="right">comment:61</div>

It seems like this issue puts using `pip` to install packages at odds with building in parallel. So should we not use `pip` so much, or do we not care about the speed of building that much? (I'm not complaining about the fix here at all, but I'm wondering about its consequences.)



---

archive/issue_comments_318549.json:
```json
{
    "body": "Changed commit from **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)** to none",
    "created_at": "2016-10-18T19:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318549",
    "user": "https://github.com/jhpalmieri"
}
```

Changed commit from **[`75c1fff`](https://github.com/sagemath/sagetrac-mirror/commit/75c1fff4c4720dd99d1d3eb99b9a2dace25d7f27)** to none



---

archive/issue_comments_318550.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nReplying to [@jhpalmieri](#comment:61):\n> or do we not care about the speed of building that much?\n\nI do care but this problem really needed fixing. I honestly tried hard to fix it by different means (look at the comments on this ticket) but I did not manage. But yes, it is certainly a regression.",
    "created_at": "2016-10-18T20:11:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318550",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:62" align="right">comment:62</div>

Replying to [@jhpalmieri](#comment:61):
> or do we not care about the speed of building that much?

I do care but this problem really needed fixing. I honestly tried hard to fix it by different means (look at the comments on this ticket) but I did not manage. But yes, it is certainly a regression.



---

archive/issue_comments_318551.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nSo should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)",
    "created_at": "2016-10-18T21:16:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318551",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:63" align="right">comment:63</div>

So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)



---

archive/issue_comments_318552.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@jhpalmieri](#comment:63):\n> So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)\n\nI would rather focus on fixing the problem at the level of `pip`. I still think that option 1. of [comment:28] should be possible to implement.",
    "created_at": "2016-10-19T06:47:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21672",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21672#issuecomment-318552",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@jhpalmieri](#comment:63):
> So should we consider changing the installation methods for certain packages which take a relatively long time to build, like `scipy`? What are the advantages to installing these via `pip`, and do they outweigh the added time? (I don't care as much about the many packages that take under 30 seconds to build; building with `pip` is fine with those.)

I would rather focus on fixing the problem at the level of `pip`. I still think that option 1. of [comment:28] should be possible to implement.
