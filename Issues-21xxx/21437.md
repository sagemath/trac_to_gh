# Issue 21437: Proper initialisation for the optional MeatAxe library

archive/issues_021200.json:
```json
{
    "body": "Modules using the optional MeatAxe package need the following initialisation:\n\n- MeatAxe executables rely on an environment variable declaring where to find multiplication tables. Of course, this needs to be done only once.\n- Each module that links against the MeatAxe library, which is a static library, has to define a certain C variable, which serves the same purpose as the aforementioned environment variable.\n\nI suggest to add here a function that does the initialisation and must be called be each module using MeatAxe functions. For that purpose, a new module `sage.libs.meataxe` is created.\n\nKeywords: MeatAxe, matrix backend\n\nReviewer: Jeroen Demeyer\n\nAuthor: Simon King\n\nBranch: 3401f04ebf9f89700b24930967e9af8033c24263\n\nDependencies: #23411 #23352\n\nCommit: 3401f04ebf9f89700b24930967e9af8033c24263\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21437\n\n",
    "closed_at": "2017-09-15T07:30:59Z",
    "created_at": "2016-09-06T12:44:38Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Proper initialisation for the optional MeatAxe library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21437",
    "user": "https://github.com/simon-king-jena"
}
```
Modules using the optional MeatAxe package need the following initialisation:

- MeatAxe executables rely on an environment variable declaring where to find multiplication tables. Of course, this needs to be done only once.
- Each module that links against the MeatAxe library, which is a static library, has to define a certain C variable, which serves the same purpose as the aforementioned environment variable.

I suggest to add here a function that does the initialisation and must be called be each module using MeatAxe functions. For that purpose, a new module `sage.libs.meataxe` is created.

Keywords: MeatAxe, matrix backend

Reviewer: Jeroen Demeyer

Author: Simon King

Branch: 3401f04ebf9f89700b24930967e9af8033c24263

Dependencies: #23411 #23352

Commit: 3401f04ebf9f89700b24930967e9af8033c24263

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21437





---

archive/issue_comments_293511.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2016-09-06T12:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293511",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_293512.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-06T12:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293512",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_293513.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2016-09-06T12:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293513",
    "user": "https://github.com/simon-king-jena"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_293514.json:
```json
{
    "body": "Changing keywords from \"\" to \"MeatAxe, matrix backend\".",
    "created_at": "2016-09-06T12:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293514",
    "user": "https://github.com/simon-king-jena"
}
```

Changing keywords from "" to "MeatAxe, matrix backend".



---

archive/issue_comments_293515.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: optional.",
    "created_at": "2016-09-06T12:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293515",
    "user": "https://github.com/simon-king-jena"
}
```

Changing component from PLEASE CHANGE to packages: optional.



---

archive/issue_comments_293516.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-06T15:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293516",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293517.json:
```json
{
    "body": "<a id='comment:4'></a>I guess you forgot some `# optional` in the doctests \n\n```\n**********************************************************************\nFile \"src/sage/matrix/matrix_gfpn_dense.pyx\", line 657, in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.get_slice\nFailed example:\n    from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense as MTX\nException raised:\n    Traceback (most recent call last):\n    ...\n    ImportError: No module named matrix_gfpn_dense\n**********************************************************************\n```",
    "created_at": "2016-09-08T09:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293517",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>I guess you forgot some `# optional` in the doctests 

```
**********************************************************************
File "src/sage/matrix/matrix_gfpn_dense.pyx", line 657, in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.get_slice
Failed example:
    from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense as MTX
Exception raised:
    Traceback (most recent call last):
    ...
    ImportError: No module named matrix_gfpn_dense
**********************************************************************
```



---

archive/issue_comments_293518.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-08T11:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293518",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293519.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 vdelecroix]:\n> I guess you forgot some `# optional` in the doctests \n\n\nDone!",
    "created_at": "2016-09-08T11:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293519",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>Replying to [comment:4 vdelecroix]:
> I guess you forgot some `# optional` in the doctests 


Done!



---

archive/issue_comments_293520.json:
```json
{
    "body": "<a id='comment:7'></a>The patchbot reports a timout. Is that reproducible?\n\nAlso, according to the coverage plugin, it seems that one function lacks testing. \n\nAnd I found that the function FfTrueRowSize is uselessly called in a couple of places: It always holds true that `FfCurrentRowSizeIo == FfTrueRowSize(FfNoc)`,  where FfCurrentRowSizeIo and FfNoc are both some global variables. Nevertheless, there are calls to `FfTrueRowSize(FfNoc)` in various places. When profiling my cohomology computations, a measurable amount of time was spent on FfTrueRowSize; therefore I want to create another patch.",
    "created_at": "2016-09-12T10:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293520",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>The patchbot reports a timout. Is that reproducible?

Also, according to the coverage plugin, it seems that one function lacks testing. 

And I found that the function FfTrueRowSize is uselessly called in a couple of places: It always holds true that `FfCurrentRowSizeIo == FfTrueRowSize(FfNoc)`,  where FfCurrentRowSizeIo and FfNoc are both some global variables. Nevertheless, there are calls to `FfTrueRowSize(FfNoc)` in various places. When profiling my cohomology computations, a measurable amount of time was spent on FfTrueRowSize; therefore I want to create another patch.



---

archive/issue_comments_293521.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-12T10:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293521",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293522.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-12T16:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293523.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-12T16:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293523",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293524.json:
```json
{
    "body": "<a id='comment:10'></a>There are strange doctest errors on arando. Could you have a look?",
    "created_at": "2016-09-13T21:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293524",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>There are strange doctest errors on arando. Could you have a look?



---

archive/issue_comments_293525.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2016-09-13T21:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293525",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_293526.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-14T11:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293526",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293527.json:
```json
{
    "body": "<a id='comment:12'></a>I have pushed another commit, since I made a typo in doc formatting.\n\nReplying to [comment:10 vdelecroix]:\n> There are strange doctest errors on arando. Could you have a look?\n\n\nMaybe it isn't strange after all. It is about a random test. The values I provide in the test are what I get when I start a fresh Sage session, but probably I forgot that the random seed in doctests is different.\n\nSo, easy to fix...",
    "created_at": "2016-09-14T11:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293527",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>I have pushed another commit, since I made a typo in doc formatting.

Replying to [comment:10 vdelecroix]:
> There are strange doctest errors on arando. Could you have a look?


Maybe it isn't strange after all. It is about a random test. The values I provide in the test are what I get when I start a fresh Sage session, but probably I forgot that the random seed in doctests is different.

So, easy to fix...



---

archive/issue_comments_293528.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-14T11:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293528",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293529.json:
```json
{
    "body": "<a id='comment:14'></a>Fixed!",
    "created_at": "2016-09-14T11:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293529",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>Fixed!



---

archive/issue_comments_293530.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2016-09-14T11:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293530",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_293531.json:
```json
{
    "body": "<a id='comment:15'></a>Admittedly, the bugs fixed here only concern users of the optional meataxe package. However, I'd appreciate a review. At least the patchbot seems happy about it.",
    "created_at": "2017-01-09T12:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293531",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>Admittedly, the bugs fixed here only concern users of the optional meataxe package. However, I'd appreciate a review. At least the patchbot seems happy about it.



---

archive/issue_comments_293532.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-02-22T10:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293532",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293533.json:
```json
{
    "body": "<a id='comment:16'></a>For Python 3 compatibility, you should use `bytes` instead of `str` for pickling.\n\nThis means changing the `PyString_...` functions to `PyBytes_...` and this:\n\n```diff\n-def mtx_unpickle(f, int nr, int nc, str Data, bint m):\n+def mtx_unpickle(f, int nr, int nc, bytes Data, bint m):\n```",
    "created_at": "2017-02-22T10:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293533",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>For Python 3 compatibility, you should use `bytes` instead of `str` for pickling.

This means changing the `PyString_...` functions to `PyBytes_...` and this:

```diff
-def mtx_unpickle(f, int nr, int nc, str Data, bint m):
+def mtx_unpickle(f, int nr, int nc, bytes Data, bint m):
```



---

archive/issue_events_056972.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-02-22T10:04:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21437#event-56972"
}
```



---

archive/issue_comments_293534.json:
```json
{
    "body": "Replying to [ticket:21437 SimonKing]:\n> - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.\n\n\nAre you sure? I thought this was handled by the `MtxLibDir` array?",
    "created_at": "2017-02-22T10:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293534",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:21437 SimonKing]:
> - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.


Are you sure? I thought this was handled by the `MtxLibDir` array?



---

archive/issue_comments_293535.json:
```json
{
    "body": "<a id='comment:18'></a>This is deprecated syntax:\n\n```\nfor i from 0<=i<self.Data.Nor:\n```\nCython understands `range()`.",
    "created_at": "2017-02-22T10:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293535",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>This is deprecated syntax:

```
for i from 0<=i<self.Data.Nor:
```
Cython understands `range()`.



---

archive/issue_comments_293536.json:
```json
{
    "body": "<a id='comment:19'></a>You're not checking the result of this call:\n\n```\nd = <char*>sig_malloc(pickle_size)\n```\nyou can use instead\n\n```\nd = check_malloc(pickle_size)\n```",
    "created_at": "2017-02-22T10:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293536",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>You're not checking the result of this call:

```
d = <char*>sig_malloc(pickle_size)
```
you can use instead

```
d = check_malloc(pickle_size)
```



---

archive/issue_comments_293537.json:
```json
{
    "body": "<a id='comment:20'></a>Wrong ticket:\n\n```\ndeprecation(12345, \"Reading this pickle may be machine dependent\")\n```",
    "created_at": "2017-02-22T10:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293537",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Wrong ticket:

```
deprecation(12345, "Reading this pickle may be machine dependent")
```



---

archive/issue_comments_293538.json:
```json
{
    "body": "<a id='comment:21'></a>This function is not used nor tested anywhere:\n\n```\ncdef Matrix_t *rawMatrix(int Field, list entries) except NULL\n```",
    "created_at": "2017-02-22T10:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293538",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>This function is not used nor tested anywhere:

```
cdef Matrix_t *rawMatrix(int Field, list entries) except NULL
```



---

archive/issue_comments_293539.json:
```json
{
    "body": "<a id='comment:22'></a>Replace\n\n```\n cdef extern from \"Python.h\":\n     object PyString_FromStringAndSize(char *s, Py_ssize_t len)\n     char* PyString_AsString(object string)\n```\nby\n\n```\nfrom cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString\n```",
    "created_at": "2017-02-22T10:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293539",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replace

```
 cdef extern from "Python.h":
     object PyString_FromStringAndSize(char *s, Py_ssize_t len)
     char* PyString_AsString(object string)
```
by

```
from cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString
```



---

archive/issue_comments_293540.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:17 jdemeyer]:\n> Replying to [ticket:21437 SimonKing]:\n> > - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.\n \n> \n> Are you sure? I thought this was handled by the `MtxLibDir` array?\n\n\nYes, I am sure. Setting the MtxLibDir variable in your programs works if your program calls mtx library functions. It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable. That's what the envirionment variable is for.",
    "created_at": "2017-02-22T10:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293540",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>Replying to [comment:17 jdemeyer]:
> Replying to [ticket:21437 SimonKing]:
> > - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.
 
> 
> Are you sure? I thought this was handled by the `MtxLibDir` array?


Yes, I am sure. Setting the MtxLibDir variable in your programs works if your program calls mtx library functions. It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable. That's what the envirionment variable is for.



---

archive/issue_comments_293541.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 SimonKing]:\n> It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.\n\n\nAnd which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?\n\nYou could set them in `sage-env` where many similar variables are handled.",
    "created_at": "2017-02-22T10:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293541",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:23 SimonKing]:
> It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.


And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?

You could set them in `sage-env` where many similar variables are handled.



---

archive/issue_comments_293542.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:\n> Replying to [comment:23 SimonKing]:\n> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.\n\n> \n> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?\n\n\nMy modular group cohomology package does. It was made dysfunctional by changes in Sage, and my long-standing plan is to turn it into a new style package.",
    "created_at": "2017-02-22T10:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293542",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 SimonKing]:
> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.

> 
> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?


My modular group cohomology package does. It was made dysfunctional by changes in Sage, and my long-standing plan is to turn it into a new style package.



---

archive/issue_comments_293543.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 SimonKing]:\n> My modular group cohomology package does.\n\n\nThen I think you should either deal with those environment variables in your package or in `sage-env`. But not in `src/sage/matrix/matrix_gfpn_dense.pyx` which has absolutely nothing to do with running meataxe executables.",
    "created_at": "2017-02-22T10:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293543",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:25 SimonKing]:
> My modular group cohomology package does.


Then I think you should either deal with those environment variables in your package or in `sage-env`. But not in `src/sage/matrix/matrix_gfpn_dense.pyx` which has absolutely nothing to do with running meataxe executables.



---

archive/issue_comments_293544.json:
```json
{
    "body": "<a id='comment:27'></a>There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.",
    "created_at": "2017-02-22T10:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293544",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.



---

archive/issue_comments_293545.json:
```json
{
    "body": "<a id='comment:28'></a>It seems that I forgot to import a couple of things: sig_malloc, sig_free.\n\nCurrently I am using sig_malloc and sig_free, but check_realloc.\nI wonder whether I use these functions correctly. Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?",
    "created_at": "2017-07-08T12:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293545",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>It seems that I forgot to import a couple of things: sig_malloc, sig_free.

Currently I am using sig_malloc and sig_free, but check_realloc.
I wonder whether I use these functions correctly. Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?



---

archive/issue_comments_293546.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:28 SimonKing]:\n> Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?\n\n\nYes: `sig_malloc` would just return `NULL` when an allocation failed while `check_allocarray` would `raise MemoryError`.",
    "created_at": "2017-07-08T12:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293546",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Replying to [comment:28 SimonKing]:
> Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?


Yes: `sig_malloc` would just return `NULL` when an allocation failed while `check_allocarray` would `raise MemoryError`.



---

archive/issue_comments_293547.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-08T12:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293547",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293548.json:
```json
{
    "body": "<a id='comment:31'></a>I think I have now addressed all your remarks, so, I put it back to \"needs review\".\n\nOne question, though. While building the code, I see one warning:\n\n```\n[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function 'initmatrix_gfpn_dense':\n[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:19604:22: warning: passing argument 1 of 'MtxSetErrorHandler' from incompatible pointer type [-Wincompatible-pointer-types]\n[sagelib-8.0.rc1]    MtxSetErrorHandler(__pyx_f_4sage_6matrix_17matrix_gfpn_dense_ErrorHandler);\n[sagelib-8.0.rc1]                       ^\n[sagelib-8.0.rc1] In file included from /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:479:0:\n[sagelib-8.0.rc1] /home/king/Sage/git/sage/local/include/meataxe.h:371:20: note: expected 'void (*)(const MtxErrorRecord_t *) {aka void (*)(const struct <anonymous> *)}' but argument is of type 'void (*)(MtxErrorRecord_t *) {aka void (*)(struct <anonymous> *)}'\n[sagelib-8.0.rc1]  MtxErrorHandler_t *MtxSetErrorHandler(MtxErrorHandler_t *h);\n[sagelib-8.0.rc1]                     ^\n```\nHow could I fix that?",
    "created_at": "2017-07-08T12:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293548",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>I think I have now addressed all your remarks, so, I put it back to "needs review".

One question, though. While building the code, I see one warning:

```
[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function 'initmatrix_gfpn_dense':
[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:19604:22: warning: passing argument 1 of 'MtxSetErrorHandler' from incompatible pointer type [-Wincompatible-pointer-types]
[sagelib-8.0.rc1]    MtxSetErrorHandler(__pyx_f_4sage_6matrix_17matrix_gfpn_dense_ErrorHandler);
[sagelib-8.0.rc1]                       ^
[sagelib-8.0.rc1] In file included from /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:479:0:
[sagelib-8.0.rc1] /home/king/Sage/git/sage/local/include/meataxe.h:371:20: note: expected 'void (*)(const MtxErrorRecord_t *) {aka void (*)(const struct <anonymous> *)}' but argument is of type 'void (*)(MtxErrorRecord_t *) {aka void (*)(struct <anonymous> *)}'
[sagelib-8.0.rc1]  MtxErrorHandler_t *MtxSetErrorHandler(MtxErrorHandler_t *h);
[sagelib-8.0.rc1]                     ^
```
How could I fix that?



---

archive/issue_comments_293549.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-08T12:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293549",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293550.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:27 jdemeyer]:\n> There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.\n\n\nWould you insist on a different ticket, or could I try to fix it here?",
    "created_at": "2017-07-08T13:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293550",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>Replying to [comment:27 jdemeyer]:
> There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.


Would you insist on a different ticket, or could I try to fix it here?



---

archive/issue_comments_293551.json:
```json
{
    "body": "<a id='comment:33'></a>I guess in some places I also have to replace `cdef str` by `cdef bytes`...",
    "created_at": "2017-07-08T13:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293551",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:33'></a>I guess in some places I also have to replace `cdef str` by `cdef bytes`...



---

archive/issue_comments_293552.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-08T13:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293552",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293553.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-08T14:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293554.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:33 SimonKing]:\n> I guess in some places I also have to replace `cdef str` by `cdef bytes`...\n\n\nDone. But I think I should also have a look at the `sig_on()` thingy...",
    "created_at": "2017-07-08T14:39:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293554",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>Replying to [comment:33 SimonKing]:
> I guess in some places I also have to replace `cdef str` by `cdef bytes`...


Done. But I think I should also have a look at the `sig_on()` thingy...



---

archive/issue_comments_293555.json:
```json
{
    "body": "<a id='comment:36'></a>Question: By \"dubious use of sig_on\", do you mean stuff like the following?\n\n```\n                sig_on()\n                if nc%MPB:\n                    for i in range(nr):\n                        y = <unsigned char*>x\n                        for j in range(FfCurrentRowSizeIo-1):\n                            y[j] = randint()%O\n                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))\n                        FfStepPtr(&(x))\n                else:\n                    for i in range(nr):\n                        y = <unsigned char*>x\n                        for j in range(FfCurrentRowSizeIo):\n                            y[j] = randint()%O\n                        FfStepPtr(&(x))\n                sig_off()\n```\nSomewhere I was reading that sig_on/sig_off should be used if there are potentially long c commands, whereas in the code above (only very short commands are executed in tight loops) one should use sig_check.\n\nDid I describe the intended use of sig_* correctly?",
    "created_at": "2017-07-08T14:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293555",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'></a>Question: By "dubious use of sig_on", do you mean stuff like the following?

```
                sig_on()
                if nc%MPB:
                    for i in range(nr):
                        y = <unsigned char*>x
                        for j in range(FfCurrentRowSizeIo-1):
                            y[j] = randint()%O
                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))
                        FfStepPtr(&(x))
                else:
                    for i in range(nr):
                        y = <unsigned char*>x
                        for j in range(FfCurrentRowSizeIo):
                            y[j] = randint()%O
                        FfStepPtr(&(x))
                sig_off()
```
Somewhere I was reading that sig_on/sig_off should be used if there are potentially long c commands, whereas in the code above (only very short commands are executed in tight loops) one should use sig_check.

Did I describe the intended use of sig_* correctly?



---

archive/issue_comments_293556.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-08T15:39:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293556",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293557.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-08T15:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293557",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293558.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:36 SimonKing]:\n> Did I describe the intended use of sig_* correctly?\n\n\nI hope that the last commit did improve the situation.",
    "created_at": "2017-07-08T15:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293558",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'></a>Replying to [comment:36 SimonKing]:
> Did I describe the intended use of sig_* correctly?


I hope that the last commit did improve the situation.



---

archive/issue_comments_293559.json:
```json
{
    "body": "<a id='comment:39'></a>I hate git.\n\nMy plan was to merge this ticket with #23352 (from my point of view it doesn't matter what is merged into what).\n\nBut there is a merge conflict. Although #23352 only has a very small diff, git apparently reports conflicts all over the place. WTF? In #23352, we just have\n\n```diff\ndiff --git a/src/sage/matrix/matrix_gfpn_dense.pyx b/src/sage/matrix/matrix_gfpn_dense.pyx\nindex 7b5fac9..a5b4ecb 100644\n--- a/src/sage/matrix/matrix_gfpn_dense.pyx\n+++ b/src/sage/matrix/matrix_gfpn_dense.pyx\n@@ -703,6 +703,12 @@ cdef class Matrix_gfpn_dense(Matrix_dense):\n             [2*z^2 + 2*z + 2               0               0   2*z^2 + z + 2               0         2*z + 1]\n             [              0       2*z^2 + z               0               1               0   2*z^2 + z + 1]\n \n+        The following tests against a bug that was fixed in :trac:`23352`::\n+\n+            sage: MS = MatrixSpace(GF(9,'x'),1,5)\n+            sage: MS.random_element()     # optional: meataxe\n+            [x + 1     x     2 x + 2 x + 2]\n+\n         \"\"\"\n         self.check_mutability()\n         cdef int fl = self.Data.Field\n@@ -741,7 +747,8 @@ cdef class Matrix_gfpn_dense(Matrix_dense):\n                         y = <unsigned char*>x\n                         for j from 0 <= j < FfCurrentRowSizeIo-1:\n                             y[j] = randint()%O\n-                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))\n+                        for j from nc-(nc%MPB) <= j < nc:\n+                            FfInsert(x, j, FfFromInt( (randint()%fl) ))\n                         FfStepPtr(&(x))\n                 else:\n                     for i from 0 <= i < nr:\n```\nBy definition, we don't have conflicts in parts of the file that are untouched by the above diff!\n\nReally, I hate git.",
    "created_at": "2017-07-08T16:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293559",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:39'></a>I hate git.

My plan was to merge this ticket with #23352 (from my point of view it doesn't matter what is merged into what).

But there is a merge conflict. Although #23352 only has a very small diff, git apparently reports conflicts all over the place. WTF? In #23352, we just have

```diff
diff --git a/src/sage/matrix/matrix_gfpn_dense.pyx b/src/sage/matrix/matrix_gfpn_dense.pyx
index 7b5fac9..a5b4ecb 100644
--- a/src/sage/matrix/matrix_gfpn_dense.pyx
+++ b/src/sage/matrix/matrix_gfpn_dense.pyx
@@ -703,6 +703,12 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
             [2*z^2 + 2*z + 2               0               0   2*z^2 + z + 2               0         2*z + 1]
             [              0       2*z^2 + z               0               1               0   2*z^2 + z + 1]
 
+        The following tests against a bug that was fixed in :trac:`23352`::
+
+            sage: MS = MatrixSpace(GF(9,'x'),1,5)
+            sage: MS.random_element()     # optional: meataxe
+            [x + 1     x     2 x + 2 x + 2]
+
         """
         self.check_mutability()
         cdef int fl = self.Data.Field
@@ -741,7 +747,8 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
                         y = <unsigned char*>x
                         for j from 0 <= j < FfCurrentRowSizeIo-1:
                             y[j] = randint()%O
-                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))
+                        for j from nc-(nc%MPB) <= j < nc:
+                            FfInsert(x, j, FfFromInt( (randint()%fl) ))
                         FfStepPtr(&(x))
                 else:
                     for i from 0 <= i < nr:
```
By definition, we don't have conflicts in parts of the file that are untouched by the above diff!

Really, I hate git.



---

archive/issue_comments_293560.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:24 jdemeyer]:\n> Replying to [comment:23 SimonKing]:\n> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.\n\n> \n> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?\n> \n> You could set them in `sage-env` where many similar variables are handled.\n\n\nWorking on #18514, I found that the situation is confusing for me.\n\nMy plan was:\n\n- With the current code from here and #23352, `sage.matrix.matrix_gfpn_dense` overrides the MtxLibDir variable that is declared in `sage.libs.meataxe`, but it doesn't touch the environment variables.\n- The cohomology code cimports MtxLibDir from `sage.matrix.matrix_gfpn_dense` and reads its content. It is then also written into an environment variable, so that the MTX-executables can find the multiplication tables.\n\nThe reality is:\n\n- When the cohomology code cimports MtxLibDir, its content is a certain location in `/usr/local/`, which is where the multiplication tables can NOT be found. Thus, any computation crashes.\n\nIf I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library. Hence, any Cython module and any C program using meataxe has to define MtxLibDir explicitly: Cimporting it won't suffice.",
    "created_at": "2017-07-08T21:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293560",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'></a>Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 SimonKing]:
> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.

> 
> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?
> 
> You could set them in `sage-env` where many similar variables are handled.


Working on #18514, I found that the situation is confusing for me.

My plan was:

- With the current code from here and #23352, `sage.matrix.matrix_gfpn_dense` overrides the MtxLibDir variable that is declared in `sage.libs.meataxe`, but it doesn't touch the environment variables.
- The cohomology code cimports MtxLibDir from `sage.matrix.matrix_gfpn_dense` and reads its content. It is then also written into an environment variable, so that the MTX-executables can find the multiplication tables.

The reality is:

- When the cohomology code cimports MtxLibDir, its content is a certain location in `/usr/local/`, which is where the multiplication tables can NOT be found. Thus, any computation crashes.

If I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library. Hence, any Cython module and any C program using meataxe has to define MtxLibDir explicitly: Cimporting it won't suffice.



---

archive/issue_comments_293561.json:
```json
{
    "body": "<a id='comment:41'></a>The following would work:\n\n- Define MtxLibDir in sage.matrix.matrix_gfpn_dense.\n- Use a copy, say, `_MtxLibDr`\n- As it turns out, when cimporting `_MtxLibDir`, one gets the correct value. Hence, one uses `_MtxLibDir` to override MtxLibDir in any module that uses the meataxe library.\n\nDo you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?",
    "created_at": "2017-07-08T22:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293561",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:41'></a>The following would work:

- Define MtxLibDir in sage.matrix.matrix_gfpn_dense.
- Use a copy, say, `_MtxLibDr`
- As it turns out, when cimporting `_MtxLibDir`, one gets the correct value. Hence, one uses `_MtxLibDir` to override MtxLibDir in any module that uses the meataxe library.

Do you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?



---

archive/issue_comments_293562.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-08T22:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293562",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293563.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:41 SimonKing]:\n> Do you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?\n\n\n... as in the latest commit.",
    "created_at": "2017-07-08T22:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293563",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:43'></a>Replying to [comment:41 SimonKing]:
> Do you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?


... as in the latest commit.



---

archive/issue_comments_293564.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:36 SimonKing]:\n> Question: By \"dubious use of sig_on\", do you mean stuff like the following?\n\n\nNot quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where *Python* code is inside `sig_on()` blocks, which shouldn't be done.",
    "created_at": "2017-07-10T07:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293564",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>Replying to [comment:36 SimonKing]:
> Question: By "dubious use of sig_on", do you mean stuff like the following?


Not quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where *Python* code is inside `sig_on()` blocks, which shouldn't be done.



---

archive/issue_comments_293565.json:
```json
{
    "body": "<a id='comment:45'></a>Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.\n\nThings like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.",
    "created_at": "2017-07-10T07:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293565",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.

Things like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.



---

archive/issue_comments_293566.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:45 jdemeyer]:\n> Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.\n> \n> Things like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.\n\n\nOK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`), and it also means that I need to import, right? \"cimport\" wouldn't suffice?",
    "created_at": "2017-07-10T08:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293566",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>Replying to [comment:45 jdemeyer]:
> Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.
> 
> Things like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.


OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`), and it also means that I need to import, right? "cimport" wouldn't suffice?



---

archive/issue_comments_293567.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:44 jdemeyer]:\n> Replying to [comment:36 SimonKing]:\n> > Question: By \"dubious use of sig_on\", do you mean stuff like the following?\n\n> \n> Not quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where *Python* code is inside `sig_on()` blocks, which shouldn't be done.\n\n\nI think I have removed all such cases. `sig_on()` now only appears three times in the code, namely\n\n```python\n        sig_on()\n        OUT.Data = MatDup(self.Data)\n        MatMul(OUT.Data,right.Data)\n        sig_off()\n```\n\n```python\n        sig_on()\n        MatMulStrassen(OUT.Data, self.Data, right.Data)\n        sig_off()\n```\n\n```python\n        sig_on()\n        try:\n            OUT.Data = MatInverse(self.Data)\n        except ZeroDivisionError:\n            sig_off()\n            raise\n        sig_off()\n```\nIt doesn't involve python code, right?",
    "created_at": "2017-07-10T08:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293567",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'></a>Replying to [comment:44 jdemeyer]:
> Replying to [comment:36 SimonKing]:
> > Question: By "dubious use of sig_on", do you mean stuff like the following?

> 
> Not quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where *Python* code is inside `sig_on()` blocks, which shouldn't be done.


I think I have removed all such cases. `sig_on()` now only appears three times in the code, namely

```python
        sig_on()
        OUT.Data = MatDup(self.Data)
        MatMul(OUT.Data,right.Data)
        sig_off()
```

```python
        sig_on()
        MatMulStrassen(OUT.Data, self.Data, right.Data)
        sig_off()
```

```python
        sig_on()
        try:
            OUT.Data = MatInverse(self.Data)
        except ZeroDivisionError:
            sig_off()
            raise
        sig_off()
```
It doesn't involve python code, right?



---

archive/issue_comments_293568.json:
```json
{
    "body": "<a id='comment:48'></a>The error handler involves Python code. So to be extra-safe, it would be better to surround the call to `PyErr_SetObject` with `sig_block()`/`sig_unblock()`.\n\nPS: 12437 is still not the correct Trac ticket.",
    "created_at": "2017-07-10T09:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293568",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>The error handler involves Python code. So to be extra-safe, it would be better to surround the call to `PyErr_SetObject` with `sig_block()`/`sig_unblock()`.

PS: 12437 is still not the correct Trac ticket.



---

archive/issue_comments_293569.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:46 SimonKing]:\n> OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)\n\n\nYes, that is what I meant.\n\n> and it also means that I need to import, right? \"cimport\" wouldn't suffice?\n\n\nYes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).",
    "created_at": "2017-07-10T09:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293569",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:49'></a>Replying to [comment:46 SimonKing]:
> OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)


Yes, that is what I meant.

> and it also means that I need to import, right? "cimport" wouldn't suffice?


Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).



---

archive/issue_comments_293570.json:
```json
{
    "body": "<a id='comment:50'></a>[comment:22] has not been addressed",
    "created_at": "2017-07-10T09:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293570",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>[comment:22] has not been addressed



---

archive/issue_comments_293571.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 jdemeyer]:\n> Replying to [comment:46 SimonKing]:\n> > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)\n\n> \n> Yes, that is what I meant.\n> \n> > and it also means that I need to import, right? \"cimport\" wouldn't suffice?\n\n> \n> Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).\n\n\nNo, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.\n\nAnd comment:22 *has* been addressed. There is no `PyString` in the files.",
    "created_at": "2017-07-10T10:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293571",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'></a>Replying to [comment:49 jdemeyer]:
> Replying to [comment:46 SimonKing]:
> > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)

> 
> Yes, that is what I meant.
> 
> > and it also means that I need to import, right? "cimport" wouldn't suffice?

> 
> Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).


No, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.

And comment:22 *has* been addressed. There is no `PyString` in the files.



---

archive/issue_comments_293572.json:
```json
{
    "body": "<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T10:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293573.json:
```json
{
    "body": "<a id='comment:53'></a>Sorry, I meant replacing\n\n```\ncdef extern from \"Python.h\":\n    char* PyBytes_AsString(object string)\n```\nby\n\n```\nfrom cpython.bytes cimport PyBytes_AsString\n```\nNote also that Cython can auto-convert between `bytes` and `char*`, so this function might not be needed at all.",
    "created_at": "2017-07-10T10:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293573",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>Sorry, I meant replacing

```
cdef extern from "Python.h":
    char* PyBytes_AsString(object string)
```
by

```
from cpython.bytes cimport PyBytes_AsString
```
Note also that Cython can auto-convert between `bytes` and `char*`, so this function might not be needed at all.



---

archive/issue_comments_293574.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:51 SimonKing]:\n> Replying to [comment:49 jdemeyer]:\n> > Replying to [comment:46 SimonKing]:\n> > > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)\n\n> > \n> > Yes, that is what I meant.\n> > \n> > > and it also means that I need to import, right? \"cimport\" wouldn't suffice?\n\n> > \n> > Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).\n\n> \n> No, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.\n\n\nExample, with the latest commit:\n\n```\nsage: M = random_matrix(GF(81,'x'),1000)\nMTX location /usr/local/mtx/lib\nos.c(254):p081.zzz: No such file or directory\n```\nwhich is an unhandled crash. So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).\n\nHow can this be overcome?",
    "created_at": "2017-07-10T10:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293574",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:54'></a>Replying to [comment:51 SimonKing]:
> Replying to [comment:49 jdemeyer]:
> > Replying to [comment:46 SimonKing]:
> > > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)

> > 
> > Yes, that is what I meant.
> > 
> > > and it also means that I need to import, right? "cimport" wouldn't suffice?

> > 
> > Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).

> 
> No, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.


Example, with the latest commit:

```
sage: M = random_matrix(GF(81,'x'),1000)
MTX location /usr/local/mtx/lib
os.c(254):p081.zzz: No such file or directory
```
which is an unhandled crash. So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).

How can this be overcome?



---

archive/issue_comments_293575.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-10T10:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293575",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293576.json:
```json
{
    "body": "<a id='comment:56'></a>Replying to [comment:54 SimonKing]:\n> ... So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).\n> \n> How can this be overcome?\n\n\nBy this, I mean: We have modules A,B,C, and A is supposed to do some initialisation to a dynamic library that A, B and C link against. Is it possible to make it so that \"import A\" in B and C automatically executes code that will do the initialisation in B resp. in C rather than only in A?\n\nHere, we have A=sage.libs.meataxe, B=sage.matrix.matrix_gfpn_dense and C=the cohomology code from #18514",
    "created_at": "2017-07-10T10:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293576",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'></a>Replying to [comment:54 SimonKing]:
> ... So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).
> 
> How can this be overcome?


By this, I mean: We have modules A,B,C, and A is supposed to do some initialisation to a dynamic library that A, B and C link against. Is it possible to make it so that "import A" in B and C automatically executes code that will do the initialisation in B resp. in C rather than only in A?

Here, we have A=sage.libs.meataxe, B=sage.matrix.matrix_gfpn_dense and C=the cohomology code from #18514



---

archive/issue_comments_293577.json:
```json
{
    "body": "<a id='comment:57'></a>A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.\n\nHowever, that sounds like an ugly hack.",
    "created_at": "2017-07-10T11:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293577",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'></a>A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.

However, that sounds like an ugly hack.



---

archive/issue_comments_293578.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:40 SimonKing]:\n> If I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library.\n\n\nYou're swapping \"static\" and \"dynamic\" but otherwise you are right: the problem with static libraries is that each Cython module gets its own \"copy\" of the static library.",
    "created_at": "2017-07-10T11:14:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293578",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>Replying to [comment:40 SimonKing]:
> If I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library.


You're swapping "static" and "dynamic" but otherwise you are right: the problem with static libraries is that each Cython module gets its own "copy" of the static library.



---

archive/issue_comments_293579.json:
```json
{
    "body": "<a id='comment:59'></a>Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.",
    "created_at": "2017-07-10T11:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293579",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:59'></a>Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.



---

archive/issue_comments_293580.json:
```json
{
    "body": "<a id='comment:60'></a>Replying to [comment:59 jdemeyer]:\n> Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.\n\n\nWould it be difficult to add support? After all, we are patching meataxe anyway.",
    "created_at": "2017-07-10T11:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293580",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:60'></a>Replying to [comment:59 jdemeyer]:
> Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.


Would it be difficult to add support? After all, we are patching meataxe anyway.



---

archive/issue_comments_293581.json:
```json
{
    "body": "<a id='comment:61'></a>Replying to [comment:60 SimonKing]:\n> Would it be difficult to add support? After all, we are patching meataxe anyway.\n\n\nInstead of \"adding support\", I would prefer to rewrite the build system to use autotools. Probably not hard, but not fun either.",
    "created_at": "2017-07-10T11:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293581",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:61'></a>Replying to [comment:60 SimonKing]:
> Would it be difficult to add support? After all, we are patching meataxe anyway.


Instead of "adding support", I would prefer to rewrite the build system to use autotools. Probably not hard, but not fun either.



---

archive/issue_comments_293582.json:
```json
{
    "body": "<a id='comment:62'></a>Replying to [comment:57 SimonKing]:\n> A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.\n\n\nHere is a better idea: in `meataxe.pxd`, define an inline function\n\n```\ncdef inline init_meataxe():\n    # set up MtxLibDir and error handler\n```\nThen you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.",
    "created_at": "2017-07-10T11:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293582",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:62'></a>Replying to [comment:57 SimonKing]:
> A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.


Here is a better idea: in `meataxe.pxd`, define an inline function

```
cdef inline init_meataxe():
    # set up MtxLibDir and error handler
```
Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.



---

archive/issue_comments_293583.json:
```json
{
    "body": "<a id='comment:63'></a>Replying to [comment:62 jdemeyer]:\n> Replying to [comment:57 SimonKing]:\n> > A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.\n\n> \n> Here is a better idea: in `meataxe.pxd`, define an inline function\n> \n> ```\n> cdef inline init_meataxe():\n>     # set up MtxLibDir and error handler\n> ```\n> Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.\n\n\nLet's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.",
    "created_at": "2017-07-10T11:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293583",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:63'></a>Replying to [comment:62 jdemeyer]:
> Replying to [comment:57 SimonKing]:
> > A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.

> 
> Here is a better idea: in `meataxe.pxd`, define an inline function
> 
> ```
> cdef inline init_meataxe():
>     # set up MtxLibDir and error handler
> ```
> Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.


Let's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.



---

archive/issue_comments_293584.json:
```json
{
    "body": "<a id='comment:64'></a>Replying to [comment:63 SimonKing]:\n> Let's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.\n\n\nThe difference between an *inline* function and a regular function is crucial here.",
    "created_at": "2017-07-10T11:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293584",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:64'></a>Replying to [comment:63 SimonKing]:
> Let's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.


The difference between an *inline* function and a regular function is crucial here.



---

archive/issue_comments_293585.json:
```json
{
    "body": "<a id='comment:65'></a>Replying to [comment:63 SimonKing]:\n> > Here is a better idea: in `meataxe.pxd`, define an inline function\n> > \n> > ```\n> > cdef inline init_meataxe():\n> >     # set up MtxLibDir and error handler\n> > ```\n> > Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.\n\n\nDoesn't work. At least not when I do the following:\n\nIn sage/libs/meataxe.pxd\n\n```python\ncdef inline meataxe_init():\n    ## Define an environment variable that enables MeatAxe to find\n    ## its multiplication tables.\n    from sage.env import DOT_SAGE\n    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))\n```\nIn sage/matrix/matrix_gfpn_dense.pyx:\n\n```python\nprint(\"MTX location\", MtxLibDir)\nmeataxe_init()\nprint(\"New location\", MtxLibDir)\n```\nBefore and after calling meataxe_init() I get the same wrong location.",
    "created_at": "2017-07-10T12:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293585",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'></a>Replying to [comment:63 SimonKing]:
> > Here is a better idea: in `meataxe.pxd`, define an inline function
> > 
> > ```
> > cdef inline init_meataxe():
> >     # set up MtxLibDir and error handler
> > ```
> > Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.


Doesn't work. At least not when I do the following:

In sage/libs/meataxe.pxd

```python
cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    from sage.env import DOT_SAGE
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
```
In sage/matrix/matrix_gfpn_dense.pyx:

```python
print("MTX location", MtxLibDir)
meataxe_init()
print("New location", MtxLibDir)
```
Before and after calling meataxe_init() I get the same wrong location.



---

archive/issue_comments_293586.json:
```json
{
    "body": "<a id='comment:66'></a>I guess the problem is the import statement in the \"cdef inline\" function. IIRC, \"inline\" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.",
    "created_at": "2017-07-10T12:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293586",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:66'></a>I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.



---

archive/issue_comments_293587.json:
```json
{
    "body": "<a id='comment:67'></a>Replying to [comment:65 SimonKing]:\n> {{{\n> #!python\n> cdef inline meataxe_init():\n>     ## Define an environment variable that enables MeatAxe to find\n>     ## its multiplication tables.\n>     from sage.env import DOT_SAGE\n>     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))\n> }}}\n\n\nThat's a beginner Python bug :-)\n\nYou need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.",
    "created_at": "2017-07-10T12:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293587",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:67'></a>Replying to [comment:65 SimonKing]:
> {{{
> #!python
> cdef inline meataxe_init():
>     ## Define an environment variable that enables MeatAxe to find
>     ## its multiplication tables.
>     from sage.env import DOT_SAGE
>     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
> }}}


That's a beginner Python bug :-)

You need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.



---

archive/issue_comments_293588.json:
```json
{
    "body": "<a id='comment:68'></a>Replying to [comment:66 SimonKing]:\n> I guess the problem is the import statement in the \"cdef inline\" function. IIRC, \"inline\" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.\n\n\nNo, this is about the **Cython** interpretation of `inline`. Whether the **C** compiler inlines it or not is irrelevant.",
    "created_at": "2017-07-10T12:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293588",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:68'></a>Replying to [comment:66 SimonKing]:
> I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.


No, this is about the **Cython** interpretation of `inline`. Whether the **C** compiler inlines it or not is irrelevant.



---

archive/issue_comments_293589.json:
```json
{
    "body": "<a id='comment:69'></a>Replying to [comment:68 jdemeyer]:\n> Replying to [comment:66 SimonKing]:\n> > I guess the problem is the import statement in the \"cdef inline\" function. IIRC, \"inline\" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.\n\n> \n> No, this is about the **Cython** interpretation of `inline`. Whether the **C** compiler inlines it or not is irrelevant.\n\n\nAnyway, it doesn't work.",
    "created_at": "2017-07-10T12:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293589",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:69'></a>Replying to [comment:68 jdemeyer]:
> Replying to [comment:66 SimonKing]:
> > I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.

> 
> No, this is about the **Cython** interpretation of `inline`. Whether the **C** compiler inlines it or not is irrelevant.


Anyway, it doesn't work.



---

archive/issue_comments_293590.json:
```json
{
    "body": "<a id='comment:70'></a>Replying to [comment:67 jdemeyer]:\n> Replying to [comment:65 SimonKing]:\n> > {{{\n> > #!python\n> > cdef inline meataxe_init():\n> >     ## Define an environment variable that enables MeatAxe to find\n> >     ## its multiplication tables.\n> >     from sage.env import DOT_SAGE\n> >     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))\n> > }}}\n\n\nIn the same pxd file:\n\n```\n    cdef extern char MtxLibDir[1024]    # Where to search/create multiplication tables\n```\nIs \"global\" needed, then?\n> That's a beginner Python bug :-)\n> \n> You need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.",
    "created_at": "2017-07-10T12:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293590",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:70'></a>Replying to [comment:67 jdemeyer]:
> Replying to [comment:65 SimonKing]:
> > {{{
> > #!python
> > cdef inline meataxe_init():
> >     ## Define an environment variable that enables MeatAxe to find
> >     ## its multiplication tables.
> >     from sage.env import DOT_SAGE
> >     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
> > }}}


In the same pxd file:

```
    cdef extern char MtxLibDir[1024]    # Where to search/create multiplication tables
```
Is "global" needed, then?
> That's a beginner Python bug :-)
> 
> You need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.



---

archive/issue_comments_293591.json:
```json
{
    "body": "<a id='comment:71'></a>Replying to [comment:70 SimonKing]:\n> Is \"global\" needed, then?\n\n\nYes. The rules for global/local variables in Cython are exactly the same as for Python.",
    "created_at": "2017-07-10T12:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293591",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:71'></a>Replying to [comment:70 SimonKing]:
> Is "global" needed, then?


Yes. The rules for global/local variables in Cython are exactly the same as for Python.



---

archive/issue_comments_293592.json:
```json
{
    "body": "<a id='comment:72'></a>The following doesn't work either:\n\n```\ncdef inline meataxe_init():\n    ## Define an environment variable that enables MeatAxe to find\n    ## its multiplication tables.\n    global MtxLibDir\n    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))\n    ## Error handling for MeatAxe, to prevent immediate exit of the program\n    MtxSetErrorHandler(ErrorHandler)\n```\n\nHere, I have moved the definition into a pyx file, where I do all the python imports and also the definition of a the dictionary that is used in the ErrorHandler --- am I right that it would be problematic to define the dictionary in a pxd file?",
    "created_at": "2017-07-10T12:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293592",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:72'></a>The following doesn't work either:

```
cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    global MtxLibDir
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
    ## Error handling for MeatAxe, to prevent immediate exit of the program
    MtxSetErrorHandler(ErrorHandler)
```

Here, I have moved the definition into a pyx file, where I do all the python imports and also the definition of a the dictionary that is used in the ErrorHandler --- am I right that it would be problematic to define the dictionary in a pxd file?



---

archive/issue_comments_293593.json:
```json
{
    "body": "<a id='comment:73'></a>Replying to [comment:72 SimonKing]:\n> Here, I have moved the definition into a pyx file\n\n\nDon't! This **MUST** be inline and it **MUST** be in the `.pxd` file.",
    "created_at": "2017-07-10T12:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293593",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:73'></a>Replying to [comment:72 SimonKing]:
> Here, I have moved the definition into a pyx file


Don't! This **MUST** be inline and it **MUST** be in the `.pxd` file.



---

archive/issue_comments_293594.json:
```json
{
    "body": "<a id='comment:74'></a>Replying to [comment:72 SimonKing]:\n> am I right that it would be problematic to define the dictionary in a pxd file?\n\n\nProbably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file. Something like:\n\n```\ncdef void ErrorHandler(...)\n\ncdef inline meataxe_init():\n    ## Define an environment variable that enables MeatAxe to find\n    ## its multiplication tables.\n    global MtxLibDir\n    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))\n    ## Error handling for MeatAxe, to prevent immediate exit of the program\n    MtxSetErrorHandler(ErrorHandler)\n```",
    "created_at": "2017-07-10T12:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293594",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:74'></a>Replying to [comment:72 SimonKing]:
> am I right that it would be problematic to define the dictionary in a pxd file?


Probably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file. Something like:

```
cdef void ErrorHandler(...)

cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    global MtxLibDir
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
    ## Error handling for MeatAxe, to prevent immediate exit of the program
    MtxSetErrorHandler(ErrorHandler)
```



---

archive/issue_comments_293595.json:
```json
{
    "body": "<a id='comment:75'></a>Replying to [comment:74 jdemeyer]:\n> Replying to [comment:72 SimonKing]:\n> > am I right that it would be problematic to define the dictionary in a pxd file?\n\n> \n> Probably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file.\n\n\nHooray, that seems to work!",
    "created_at": "2017-07-10T12:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293595",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:75'></a>Replying to [comment:74 jdemeyer]:
> Replying to [comment:72 SimonKing]:
> > am I right that it would be problematic to define the dictionary in a pxd file?

> 
> Probably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file.


Hooray, that seems to work!



---

archive/issue_comments_293596.json:
```json
{
    "body": "<a id='comment:76'></a>BTW: I would change the name `ErrorHandler` to something more descriptive, like `sage_meataxe_error_handler` or something.",
    "created_at": "2017-07-10T12:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293596",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:76'></a>BTW: I would change the name `ErrorHandler` to something more descriptive, like `sage_meataxe_error_handler` or something.



---

archive/issue_comments_293597.json:
```json
{
    "body": "<a id='comment:77'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T12:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:77'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293598.json:
```json
{
    "body": "<a id='comment:78'></a>Am I right in guessing that I shouldn't simplify the git history of this ticket? After all, there are commits that just revert what previous commits have done.\n\n---\nNew commits:",
    "created_at": "2017-07-10T12:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293598",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:78'></a>Am I right in guessing that I shouldn't simplify the git history of this ticket? After all, there are commits that just revert what previous commits have done.

---
New commits:



---

archive/issue_comments_293599.json:
```json
{
    "body": "<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T13:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293599",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293600.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-10T13:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293600",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293601.json:
```json
{
    "body": "<a id='comment:81'></a>Replying to [comment:78 SimonKing]:\n> Am I right in guessing that I shouldn't simplify the git history of this ticket?\n\n\nIt depends mainly on whether you think that somebody else is building on top of your branch here. I guess chances are very small , so you could simplify the git history. Just keep in mind #23352.",
    "created_at": "2017-07-10T13:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293601",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:81'></a>Replying to [comment:78 SimonKing]:
> Am I right in guessing that I shouldn't simplify the git history of this ticket?


It depends mainly on whether you think that somebody else is building on top of your branch here. I guess chances are very small , so you could simplify the git history. Just keep in mind #23352.



---

archive/issue_comments_293602.json:
```json
{
    "body": "<a id='comment:82'></a>For Python 3 compatibility, it would be good to add\n\n```\nfrom __future__ import absolute_import, division\n```\nin `src/sage/matrix/matrix_gfpn_dense.pyx`\n\nThen you should also use floor division if that's what you want, for example here:\n\n```\ncdef size_t pickled_rowsize = len(Data)/nr\n```\nThere might be other such places too, I have not checked.",
    "created_at": "2017-07-10T13:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293602",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:82'></a>For Python 3 compatibility, it would be good to add

```
from __future__ import absolute_import, division
```
in `src/sage/matrix/matrix_gfpn_dense.pyx`

Then you should also use floor division if that's what you want, for example here:

```
cdef size_t pickled_rowsize = len(Data)/nr
```
There might be other such places too, I have not checked.



---

archive/issue_comments_293603.json:
```json
{
    "body": "Replying to [ticket:21437 SimonKing]:\n> - There are some auxiliary functions that I would like to use in my group cohomology package (related with slicing).\n\n\nSince this patch is getting rather big, would it be possible to separate this part? Then we could keep this ticket just to fix things, not adding new functionality.\n\nIf you feel up to it, I would actually suggest to split it up even further. For example, the pickling fixes alone deserve a separate ticket.\n\nNOTE: I'm not saying this just out of principle. My experience is that it's a lot easier to get multiple small tickets reviewed than one big ticket.",
    "created_at": "2017-07-10T13:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293603",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:21437 SimonKing]:
> - There are some auxiliary functions that I would like to use in my group cohomology package (related with slicing).


Since this patch is getting rather big, would it be possible to separate this part? Then we could keep this ticket just to fix things, not adding new functionality.

If you feel up to it, I would actually suggest to split it up even further. For example, the pickling fixes alone deserve a separate ticket.

NOTE: I'm not saying this just out of principle. My experience is that it's a lot easier to get multiple small tickets reviewed than one big ticket.



---

archive/issue_comments_293604.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-10T13:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293604",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293605.json:
```json
{
    "body": "<a id='comment:84'></a>The deprecation ticket number is still wrong.",
    "created_at": "2017-07-10T13:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293605",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:84'></a>The deprecation ticket number is still wrong.



---

archive/issue_comments_293606.json:
```json
{
    "body": "<a id='comment:85'></a>About this comment:\n\n```\n###############################################################\n## It is needed to do some initialisation. Since meataxe is\n## a dynamic library, it is needed to do this initialisation\n## in all modules cimporting sage.libs.meataxe. So, you HAVE\n## to call the meataxe_init() function when you cimport sage.libs.meataxe!\n```\n\n1. Replace \"dynamic\" by \"static\"\n\n2. It's not really correct that `meataxe_init()` must be called whenever `sage.libs.meataxe` is cimported. It's more correct to say that `meataxe_init()` must be called whenever the MeatAxe library is used. This may seem like a silly difference, but it is possible that some module needs access to some MeatAxe type (say, to pass around pointers or for simple conversions) without actually using anything from the MeatAxe static library.",
    "created_at": "2017-07-10T13:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293606",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:85'></a>About this comment:

```
###############################################################
## It is needed to do some initialisation. Since meataxe is
## a dynamic library, it is needed to do this initialisation
## in all modules cimporting sage.libs.meataxe. So, you HAVE
## to call the meataxe_init() function when you cimport sage.libs.meataxe!
```

1. Replace "dynamic" by "static"

2. It's not really correct that `meataxe_init()` must be called whenever `sage.libs.meataxe` is cimported. It's more correct to say that `meataxe_init()` must be called whenever the MeatAxe library is used. This may seem like a silly difference, but it is possible that some module needs access to some MeatAxe type (say, to pass around pointers or for simple conversions) without actually using anything from the MeatAxe static library.



---

archive/issue_comments_293607.json:
```json
{
    "body": "<a id='comment:86'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T13:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293607",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:86'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293608.json:
```json
{
    "body": "<a id='comment:87'></a>If I see that correctly, the following git commits belong to this ticket:\n\n* b6c8114 - (HEAD -> t/21437/fix-mtx-matrices) Make matrix_gfpn_dense python 3 compliant; fix a deprecation (20 seconds ago) <Simon King>\n* 08e03c2 - Change ErrorHandler into sage_meataxe_error_handler (48 minutes ago) <Simon King>\n* 353a8b9 - meataxe_init() inline function (49 minutes ago) <Simon King>\n* 67a85ca - Move meataxe definitions from sage.matrix to sage.libs (4 hours ago) <Simon King>\n* 6a65600 - Use a fixed copy of MtxLibDir (2 days ago) <Simon King>\n* 04e7986 - Improve use of sig_on/off/check (2 days ago) <Simon King>\n* b70bc5f - Change some str into bytes (2 days ago) <Simon King>\n* c929fcc - Remove unused MTX* environment variables (2 days ago) <Simon King>\n* d943f93 - Remove rawMatrix function (2 days ago) <Simon King>\n* 413e4a9 - Remove deprecated Cython syntax, use check_malloc (2 days ago) <Simon King>\n* 5ed2269 - Fix one doctest (10 months ago) <Simon King>\n* 03ce5c0 - Fix bad INPUT::/OUTPUT:: blocks (10 months ago) <Simon King>\n* 291f4dc - Some minor tweaks for performance (10 months ago) <Simon King>\n* e17e4df - Document and test _rowlist_() (10 months ago) <Simon King>\n* a4dded9 - Make new tests optional (10 months ago) <Simon King>\n* 4f3d56c - Fix index check in get_slice (10 months ago) <Simon King>\n* e861781 - Add c(p)def functions to get/set horizontal matrix slices (10 months ago) <Simon King>\n* 02fa8a2 - Make pickling machine independent (10 months ago) <Simon King>\n* 778df7d - Help using MeatAxe executables in Sage (10 months ago) <Simon King>\n* 9e0f5d4 - Fix reading mtx-matrix from non-existent file (10 months ago) <Simon King>\n\nOn top of that, #23352 adds one more commit:\n* 6e33226 - (t/23352/fix_random_matrix_gfpn_dense) Properly fill the last few columns of random meataxe matrices (2 days ago) <Simon King>\n\nOK, quite a lot...\n\nHow to split that into smaller chunks? I see the following four topics:\n\n1. Bug fixes, for example:\n   * 6e33226 - Properly fill the last few columns of random meataxe matrices\n   * 02fa8a2 - Make pickling machine independent\n   * 9e0f5d4 - Fix reading mtx-matrix from non-existent file\n2. Code style/cleanliness, for example:\n   * b6c8114 - Make matrix_gfpn_dense python 3 compliant\n   * 04e7986 - Improve use of sig_on/off/check\n   * b70bc5f - Change some str into bytes\n   * 413e4a9 - Remove deprecated Cython syntax, use check_malloc\n   * d943f93 - Remove rawMatrix function \n3. Proper MeatAxe initialisation, for example\n   * 08e03c2 - Change ErrorHandler? into sage_meataxe_error_handler\n   * 353a8b9 - meataxe_init() inline function\n   * 67a85ca - Move meataxe definitions from sage.matrix to sage.libs\n   * c929fcc - Remove unused MTX* environment variables\n4. Additions, for example\n   * e17e4df - Document and test _rowlist_()\n   * e861781 - Add c(p)def functions to get/set horizontal matrix slices\n\nSince this ticket's name is about \"addition\", I suggest to deal with 4. *here*.\n\nSince #23352 is about fixing something, I suggest to deal with 1. *there*, and make it a dependency of everything else.\n\nAnd then there should be two new tickets for 2. and 3. Probably I will not cherry-pick commits, but will go through the whole diff and manually move stuff to the different topics.\nDoes that sound reasonable to you?\n\n---\nNew commits:",
    "created_at": "2017-07-10T14:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293608",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:87'></a>If I see that correctly, the following git commits belong to this ticket:

* b6c8114 - (HEAD -> t/21437/fix-mtx-matrices) Make matrix_gfpn_dense python 3 compliant; fix a deprecation (20 seconds ago) <Simon King>
* 08e03c2 - Change ErrorHandler into sage_meataxe_error_handler (48 minutes ago) <Simon King>
* 353a8b9 - meataxe_init() inline function (49 minutes ago) <Simon King>
* 67a85ca - Move meataxe definitions from sage.matrix to sage.libs (4 hours ago) <Simon King>
* 6a65600 - Use a fixed copy of MtxLibDir (2 days ago) <Simon King>
* 04e7986 - Improve use of sig_on/off/check (2 days ago) <Simon King>
* b70bc5f - Change some str into bytes (2 days ago) <Simon King>
* c929fcc - Remove unused MTX* environment variables (2 days ago) <Simon King>
* d943f93 - Remove rawMatrix function (2 days ago) <Simon King>
* 413e4a9 - Remove deprecated Cython syntax, use check_malloc (2 days ago) <Simon King>
* 5ed2269 - Fix one doctest (10 months ago) <Simon King>
* 03ce5c0 - Fix bad INPUT::/OUTPUT:: blocks (10 months ago) <Simon King>
* 291f4dc - Some minor tweaks for performance (10 months ago) <Simon King>
* e17e4df - Document and test _rowlist_() (10 months ago) <Simon King>
* a4dded9 - Make new tests optional (10 months ago) <Simon King>
* 4f3d56c - Fix index check in get_slice (10 months ago) <Simon King>
* e861781 - Add c(p)def functions to get/set horizontal matrix slices (10 months ago) <Simon King>
* 02fa8a2 - Make pickling machine independent (10 months ago) <Simon King>
* 778df7d - Help using MeatAxe executables in Sage (10 months ago) <Simon King>
* 9e0f5d4 - Fix reading mtx-matrix from non-existent file (10 months ago) <Simon King>

On top of that, #23352 adds one more commit:
* 6e33226 - (t/23352/fix_random_matrix_gfpn_dense) Properly fill the last few columns of random meataxe matrices (2 days ago) <Simon King>

OK, quite a lot...

How to split that into smaller chunks? I see the following four topics:

1. Bug fixes, for example:
   * 6e33226 - Properly fill the last few columns of random meataxe matrices
   * 02fa8a2 - Make pickling machine independent
   * 9e0f5d4 - Fix reading mtx-matrix from non-existent file
2. Code style/cleanliness, for example:
   * b6c8114 - Make matrix_gfpn_dense python 3 compliant
   * 04e7986 - Improve use of sig_on/off/check
   * b70bc5f - Change some str into bytes
   * 413e4a9 - Remove deprecated Cython syntax, use check_malloc
   * d943f93 - Remove rawMatrix function 
3. Proper MeatAxe initialisation, for example
   * 08e03c2 - Change ErrorHandler? into sage_meataxe_error_handler
   * 353a8b9 - meataxe_init() inline function
   * 67a85ca - Move meataxe definitions from sage.matrix to sage.libs
   * c929fcc - Remove unused MTX* environment variables
4. Additions, for example
   * e17e4df - Document and test _rowlist_()
   * e861781 - Add c(p)def functions to get/set horizontal matrix slices

Since this ticket's name is about "addition", I suggest to deal with 4. *here*.

Since #23352 is about fixing something, I suggest to deal with 1. *there*, and make it a dependency of everything else.

And then there should be two new tickets for 2. and 3. Probably I will not cherry-pick commits, but will go through the whole diff and manually move stuff to the different topics.
Does that sound reasonable to you?

---
New commits:



---

archive/issue_comments_293609.json:
```json
{
    "body": "<a id='comment:89'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-07-11T11:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293609",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:89'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_293610.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-11T11:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293610",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293611.json:
```json
{
    "body": "<a id='comment:90'></a>From my perspective, the work is done. Thus, together with #23352, #23399 and #23400, it needs review!",
    "created_at": "2017-07-11T11:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293611",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:90'></a>From my perspective, the work is done. Thus, together with #23352, #23399 and #23400, it needs review!



---

archive/issue_comments_293612.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-12T18:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293612",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293613.json:
```json
{
    "body": "<a id='comment:92'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-13T00:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:92'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_293614.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-13T00:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293614",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293615.json:
```json
{
    "body": "<a id='comment:93'></a>I hope it is ok that this now has three dependencies...",
    "created_at": "2017-07-13T00:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293615",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:93'></a>I hope it is ok that this now has three dependencies...



---

archive/issue_comments_293616.json:
```json
{
    "body": "<a id='comment:94'></a>#23410 is not a dependency (and merges cleanly). So, let's simplify the list of dependencies.",
    "created_at": "2017-07-16T13:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293616",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:94'></a>#23410 is not a dependency (and merges cleanly). So, let's simplify the list of dependencies.



---

archive/issue_comments_293617.json:
```json
{
    "body": "<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-16T13:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293618.json:
```json
{
    "body": "<a id='comment:96'></a>Manual merging of the last few commits of #23352 was needed.",
    "created_at": "2017-07-16T13:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293618",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:96'></a>Manual merging of the last few commits of #23352 was needed.



---

archive/issue_comments_293619.json:
```json
{
    "body": "<a id='comment:98'></a>Better use `RuntimeError` instead of `SystemError` for unknown error messages.",
    "created_at": "2017-07-17T12:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293619",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:98'></a>Better use `RuntimeError` instead of `SystemError` for unknown error messages.



---

archive/issue_comments_293620.json:
```json
{
    "body": "<a id='comment:99'></a>Replying to [comment:98 jdemeyer]:\n> Better use `RuntimeError` instead of `SystemError` for unknown error messages.\n\n\nOK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).",
    "created_at": "2017-07-17T12:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293620",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:99'></a>Replying to [comment:98 jdemeyer]:
> Better use `RuntimeError` instead of `SystemError` for unknown error messages.


OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).



---

archive/issue_comments_293621.json:
```json
{
    "body": "<a id='comment:100'></a>Replying to [comment:99 SimonKing]:\n> Replying to [comment:98 jdemeyer]:\n> > Better use `RuntimeError` instead of `SystemError` for unknown error messages.\n\n> \n> OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).\n\n\n`OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.",
    "created_at": "2017-07-17T13:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293621",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:100'></a>Replying to [comment:99 SimonKing]:
> Replying to [comment:98 jdemeyer]:
> > Better use `RuntimeError` instead of `SystemError` for unknown error messages.

> 
> OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).


`OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.



---

archive/issue_comments_293622.json:
```json
{
    "body": "<a id='comment:101'></a>Replying to [comment:100 jdemeyer]:\n> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).\n  \n> \n> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.\n\n\nIn that case I should change the current IOError as well. And since #23411 introduces another test with a SystemError that should better be an OSError, I'll merge #23411.",
    "created_at": "2017-07-17T14:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293622",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:101'></a>Replying to [comment:100 jdemeyer]:
> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
  
> 
> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.


In that case I should change the current IOError as well. And since #23411 introduces another test with a SystemError that should better be an OSError, I'll merge #23411.



---

archive/issue_comments_293623.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-17T15:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293623",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293624.json:
```json
{
    "body": "<a id='comment:103'></a>Replying to [comment:100 jdemeyer]:\n> Replying to [comment:99 SimonKing]:\n> > Replying to [comment:98 jdemeyer]:\n> > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.\n\n> > \n> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).\n  \n> \n> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.\n\n\nDone and done!",
    "created_at": "2017-07-17T15:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293624",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:103'></a>Replying to [comment:100 jdemeyer]:
> Replying to [comment:99 SimonKing]:
> > Replying to [comment:98 jdemeyer]:
> > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.

> > 
> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
  
> 
> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.


Done and done!



---

archive/issue_comments_293625.json:
```json
{
    "body": "<a id='comment:104'></a>Replying to [comment:103 SimonKing]:\n> Replying to [comment:100 jdemeyer]:\n> > Replying to [comment:99 SimonKing]:\n> > > Replying to [comment:98 jdemeyer]:\n> > > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.\n\n> > > \n> > > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).\n  \n> > \n> > `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.\n\n> \n> Done and done!\n\n\nI think I have addressed all objections...",
    "created_at": "2017-08-18T14:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293625",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:104'></a>Replying to [comment:103 SimonKing]:
> Replying to [comment:100 jdemeyer]:
> > Replying to [comment:99 SimonKing]:
> > > Replying to [comment:98 jdemeyer]:
> > > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.

> > > 
> > > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
  
> > 
> > `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.

> 
> Done and done!


I think I have addressed all objections...



---

archive/issue_comments_293626.json:
```json
{
    "body": "<a id='comment:5'></a>Jeroen, do you plan on finishing the review on this ticket? You already have been through this code and are more of a Cython expert than I am. However, I can probably finishing reviewing this ticket if you'd prefer.",
    "created_at": "2017-08-25T22:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293626",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Jeroen, do you plan on finishing the review on this ticket? You already have been through this code and are more of a Cython expert than I am. However, I can probably finishing reviewing this ticket if you'd prefer.



---

archive/issue_comments_293627.json:
```json
{
    "body": "<a id='comment:6'></a>Viewing the diff of this ticket fails with HTTP error 500. I just sent an email to `sagemath-admins` for this.",
    "created_at": "2017-08-30T15:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293627",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Viewing the diff of this ticket fails with HTTP error 500. I just sent an email to `sagemath-admins` for this.



---

archive/issue_comments_293628.json:
```json
{
    "body": "<a id='comment:7'></a>For now the best thing to do might be to rebase this on the latest develop branch and then `git push -f`.  SimonKing: Let me know if you need any help with the git-fu.",
    "created_at": "2017-08-31T12:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293628",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>For now the best thing to do might be to rebase this on the latest develop branch and then `git push -f`.  SimonKing: Let me know if you need any help with the git-fu.



---

archive/issue_comments_293629.json:
```json
{
    "body": "<a id='comment:9'></a>I just did that.\n\n---\nNew commits:",
    "created_at": "2017-08-31T12:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293629",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>I just did that.

---
New commits:



---

archive/issue_comments_293630.json:
```json
{
    "body": "<a id='comment:0'></a>This is not going to work on Python 3:\n\n```\nMtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE, 'meataxe'))\n```\n(the reason is that `os.path.join(DOT_SAGE, 'meataxe')` is `unicode`, not `bytes`.\n\nI'm not sure if this should hold back this ticket, there are probably many issues like this in Sage.",
    "created_at": "2017-08-31T12:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293630",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:0'></a>This is not going to work on Python 3:

```
MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE, 'meataxe'))
```
(the reason is that `os.path.join(DOT_SAGE, 'meataxe')` is `unicode`, not `bytes`.

I'm not sure if this should hold back this ticket, there are probably many issues like this in Sage.



---

archive/issue_comments_293631.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-31T13:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293631",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293632.json:
```json
{
    "body": "<a id='comment:1'></a>Some imports can be cleaned up.\n\nYou can remove\n\n```\ncdef extern from \"Python.h\":\n    object PyString_FromStringAndSize(char *s, Py_ssize_t len)\n    char* PyString_AsString(object string)\n```\nand\n\n```\n####################\n#\n# auxiliary functions\n#\n####################\nimport sys\nfrom libc.string cimport memcpy\n```\n\nI would also remove\n\n```\nfrom libc.stdlib cimport free\n```\nand replace `free()` by `sig_free()` in `free(old)`.",
    "created_at": "2017-08-31T13:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293632",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>Some imports can be cleaned up.

You can remove

```
cdef extern from "Python.h":
    object PyString_FromStringAndSize(char *s, Py_ssize_t len)
    char* PyString_AsString(object string)
```
and

```
####################
#
# auxiliary functions
#
####################
import sys
from libc.string cimport memcpy
```

I would also remove

```
from libc.stdlib cimport free
```
and replace `free()` by `sig_free()` in `free(old)`.



---

archive/issue_comments_293633.json:
```json
{
    "body": "<a id='comment:2'></a>Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Fr\u00e9d\u00e9ric) pull their hair out later.\n\nFor one, why is it unicode (on Python 2) in the first place?",
    "created_at": "2017-08-31T13:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293633",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frdric) pull their hair out later.

For one, why is it unicode (on Python 2) in the first place?



---

archive/issue_comments_293634.json:
```json
{
    "body": "<a id='comment:113'></a>Replying to [comment:112 embray]:\n> For one, why is it unicode (on Python 2) in the first place?\n\n\nIt's really `str` which is `bytes` on Python 2 but `unicode` (a.k.a. `str`) on Python 3.",
    "created_at": "2017-08-31T13:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293634",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:113'></a>Replying to [comment:112 embray]:
> For one, why is it unicode (on Python 2) in the first place?


It's really `str` which is `bytes` on Python 2 but `unicode` (a.k.a. `str`) on Python 3.



---

archive/issue_comments_293635.json:
```json
{
    "body": "<a id='comment:114'></a>Replying to [comment:112 embray]:\n> Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Fr\u00e9d\u00e9ric) pull their hair out later.\n\n\nRight, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx",
    "created_at": "2017-08-31T13:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293635",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:114'></a>Replying to [comment:112 embray]:
> Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frdric) pull their hair out later.


Right, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx



---

archive/issue_comments_293636.json:
```json
{
    "body": "<a id='comment:5'></a>What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?",
    "created_at": "2017-08-31T13:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293636",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?



---

archive/issue_comments_293637.json:
```json
{
    "body": "<a id='comment:116'></a>Replying to [comment:115 SimonKing]:\n> What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?\n\n\nSorry, I just realise that `PyBytes_AsString` is the probable culprit.\n\nIn any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?",
    "created_at": "2017-08-31T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293637",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:116'></a>Replying to [comment:115 SimonKing]:
> What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?


Sorry, I just realise that `PyBytes_AsString` is the probable culprit.

In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?



---

archive/issue_comments_293638.json:
```json
{
    "body": "<a id='comment:117'></a>Replying to [comment:116 SimonKing]:\n> In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?\n\n\nIt's not so easy, see [comment:114]",
    "created_at": "2017-08-31T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293638",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:117'></a>Replying to [comment:116 SimonKing]:
> In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?


It's not so easy, see [comment:114]



---

archive/issue_comments_293639.json:
```json
{
    "body": "<a id='comment:118'></a>Replying to [comment:117 jdemeyer]:\n> Replying to [comment:116 SimonKing]:\n> > In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?\n\n> \n> It's not so easy, see [comment:114]\n\n\nIf I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.\n\nSo, for now, I will change the code only according to your other objections.",
    "created_at": "2017-09-01T09:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293639",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:118'></a>Replying to [comment:117 jdemeyer]:
> Replying to [comment:116 SimonKing]:
> > In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?

> 
> It's not so easy, see [comment:114]


If I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.

So, for now, I will change the code only according to your other objections.



---

archive/issue_comments_293640.json:
```json
{
    "body": "<a id='comment:120'></a>Replying to [comment:118 SimonKing]:\n> If I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.\n> \n> So, for now, I will change the code only according to your other objections.\n\n\nDone. Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.",
    "created_at": "2017-09-01T09:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293640",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:120'></a>Replying to [comment:118 SimonKing]:
> If I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.
> 
> So, for now, I will change the code only according to your other objections.


Done. Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.



---

archive/issue_comments_293641.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-01T09:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293641",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293642.json:
```json
{
    "body": "<a id='comment:121'></a>Replying to [comment:114 jdemeyer]:\n> Replying to [comment:112 embray]:\n> > Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Fr\u00e9d\u00e9ric) pull their hair out later.\n\n> \n> Right, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx\n\n\nI see. I didn't realize that wasn't already the case.  Is there any reason these have to be written in Cython? I don't see functions like these getting much speedup from it.  In any case , maybe I can just copy these directly into Sage and sprinkle them around the appropriate places.",
    "created_at": "2017-09-01T09:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293642",
    "user": "https://github.com/embray"
}
```

<a id='comment:121'></a>Replying to [comment:114 jdemeyer]:
> Replying to [comment:112 embray]:
> > Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frdric) pull their hair out later.

> 
> Right, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx


I see. I didn't realize that wasn't already the case.  Is there any reason these have to be written in Cython? I don't see functions like these getting much speedup from it.  In any case , maybe I can just copy these directly into Sage and sprinkle them around the appropriate places.



---

archive/issue_comments_293643.json:
```json
{
    "body": "<a id='comment:122'></a>Replying to [comment:121 embray]:\n> I don't see functions like these getting much speedup from it.\n\n\nYou do get the speedup from *calling* those functions (calling a `cdef` function vs. calling a Python function).\n\nAnd for `cypari2`, Cython was an obvious choice since `cypari2` is completely implemented in Cython.",
    "created_at": "2017-09-01T12:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293643",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:122'></a>Replying to [comment:121 embray]:
> I don't see functions like these getting much speedup from it.


You do get the speedup from *calling* those functions (calling a `cdef` function vs. calling a Python function).

And for `cypari2`, Cython was an obvious choice since `cypari2` is completely implemented in Cython.



---

archive/issue_comments_293644.json:
```json
{
    "body": "<a id='comment:123'></a>Replying to [comment:120 SimonKing]:\n> Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.\n\n\nKnown bug: https://github.com/sagemath/sage_trac_plugin/issues/10",
    "created_at": "2017-09-04T10:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293644",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:123'></a>Replying to [comment:120 SimonKing]:
> Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.


Known bug: https://github.com/sagemath/sage_trac_plugin/issues/10



---

archive/issue_comments_293645.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-06T08:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293645",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293646.json:
```json
{
    "body": "<a id='comment:4'></a>[comment:85]",
    "created_at": "2017-09-06T08:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293646",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>[comment:85]



---

archive/issue_comments_293647.json:
```json
{
    "body": "<a id='comment:5'></a>Also: please merge 8.1.beta4",
    "created_at": "2017-09-06T08:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293647",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Also: please merge 8.1.beta4



---

archive/issue_comments_293648.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-11T12:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293648",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293649.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-11T12:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293649",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293650.json:
```json
{
    "body": "<a id='comment:7'></a>Done, so \"needs review\", with the caveat that I didn't run tests again.",
    "created_at": "2017-09-11T12:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293650",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>Done, so "needs review", with the caveat that I didn't run tests again.



---

archive/issue_comments_293651.json:
```json
{
    "body": "<a id='comment:8'></a>One detail:\n\n```\n    ## Define an environment variable that enables MeatAxe to find\n    ## its multiplication tables.\n```\nIt's not an environment variable, it's a string inside the meataxe library.\n\nIf you fix this comment, you can set this ticket to positive review.",
    "created_at": "2017-09-14T11:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293651",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>One detail:

```
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
```
It's not an environment variable, it's a string inside the meataxe library.

If you fix this comment, you can set this ticket to positive review.



---

archive/issue_comments_293652.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-14T12:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293653.json:
```json
{
    "body": "<a id='comment:0'></a>Thank you! I hope the comment is fine now.",
    "created_at": "2017-09-14T12:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293653",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>Thank you! I hope the comment is fine now.



---

archive/issue_comments_293654.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-14T12:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293654",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_056973.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-15T07:30:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21437#event-56973"
}
```



---

archive/issue_comments_293655.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-15T07:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21437#issuecomment-293655",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
