# Issue 21894: Do not compare dictionaries which might contain caches

archive/issues_021657.json:
```json
{
    "body": "The following is a common pattern in implementations of `__cmp__` or `__eq__`:\n\n```\nsage: search_src(\"__dict__ == \")\ncategories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\ncombinat/dlx.py:142:        return self.__dict__ == other.__dict__\ncombinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__\ngeometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__\nmisc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__\nmodules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__\nmodules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\n```\n\nThis fails as soon as `self` has a ``@`cached_method`:\n\n* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.\n* A restored pickle contains a `PickledMethod` which is not considered the same as the `CachedMethodCaller(NoArgs)` in the original object.\n\nInterestingly, almost all these cases, do not implement `__ne__` which makes `!=` not the negation of `==`. Also, most do not implement `__hash__`, or implement it incorrectly,\n\nThe instances which use this in their implementations of `__cmp__` seem to be limited to `doctest/`. There, such an implementation should be fine:\n\n```\nsage: search_src(\"cmp\\(self.__dict__,\")\ndoctest/control.py:139:        return cmp(self.__dict__,other.__dict__)\ndoctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)\ndoctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)\ndoctest/util.py:193:        return cmp(self.__dict__, other.__dict__)\n```\n\nStatus: new\n\nDependencies: #19820, #21995\n\nIssue created by migration from https://trac.sagemath.org/ticket/21894\n\n",
    "created_at": "2016-11-18T04:29:57Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Do not compare dictionaries which might contain caches",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21894",
    "user": "https://github.com/saraedum"
}
```
The following is a common pattern in implementations of `__cmp__` or `__eq__`:

```
sage: search_src("__dict__ == ")
categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
combinat/dlx.py:142:        return self.__dict__ == other.__dict__
combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__
geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__
misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__
modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__
modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
```

This fails as soon as `self` has a ``@`cached_method`:

* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.
* A restored pickle contains a `PickledMethod` which is not considered the same as the `CachedMethodCaller(NoArgs)` in the original object.

Interestingly, almost all these cases, do not implement `__ne__` which makes `!=` not the negation of `==`. Also, most do not implement `__hash__`, or implement it incorrectly,

The instances which use this in their implementations of `__cmp__` seem to be limited to `doctest/`. There, such an implementation should be fine:

```
sage: search_src("cmp\(self.__dict__,")
doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)
doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)
doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)
doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)
```

Status: new

Dependencies: #19820, #21995

Issue created by migration from https://trac.sagemath.org/ticket/21894





---

archive/issue_comments_320180.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -19,7 +19,7 @@\n This fails as soon as \\`self\\` has a \\`\\`@\\`cached_method\\`:\n \n * Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.\n-* A pickle contains a \\`PickledMethod\\` which is not considered the same as the \\`CachedMethodCaller(NoArgs)\\` in the original object.\n+* A restored pickle contains a \\`PickledMethod\\` which is not considered the same as the \\`CachedMethodCaller(NoArgs)\\` in the original object.\n \n Comment: 1\n \n```\n",
    "created_at": "2016-11-18T05:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21894#issuecomment-320180",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -19,7 +19,7 @@
 This fails as soon as \`self\` has a \`\`@\`cached_method\`:
 
 * Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.
-* A pickle contains a \`PickledMethod\` which is not considered the same as the \`CachedMethodCaller(NoArgs)\` in the original object.
+* A restored pickle contains a \`PickledMethod\` which is not considered the same as the \`CachedMethodCaller(NoArgs)\` in the original object.
 
 Comment: 1
 
```




---

archive/issue_comments_320181.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,30 @@\n+The following is a common pattern in implementations of \\`__cmp__\\` or \\`__eq__\\`:\n \n+\\`\\`\\`\n+sage: search_src(\"__dict__ == \")\n+categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\n+combinat/dlx.py:142:        return self.__dict__ == other.__dict__\n+combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__\n+geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__\n+misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__\n+modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__\n+modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\n+\\`\\`\\`\n+\n+This fails as soon as \\`self\\` has a \\`\\`@\\`cached_method\\`:\n+\n+* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.\n+* A restored pickle contains a \\`PickledMethod\\` which is not considered the same as the \\`CachedMethodCaller(NoArgs)\\` in the original object.\n+\n+The instances which use this in their implementations of \\`__cmp__\\` seem to be limited to \\`doctest/\\`. There, such an implementation should be fine:\n+\n+\\`\\`\\`\n+sage: search_src(\"cmp\\(self.__dict__,\")\n+doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)\n+doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)\n+doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)\n+doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)\n+\\`\\`\\`\n \n Comment: 1\n \n```\n",
    "created_at": "2016-11-18T05:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21894#issuecomment-320181",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,30 @@
+The following is a common pattern in implementations of \`__cmp__\` or \`__eq__\`:
 
+\`\`\`
+sage: search_src("__dict__ == ")
+categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
+combinat/dlx.py:142:        return self.__dict__ == other.__dict__
+combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__
+geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__
+misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__
+modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__
+modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
+\`\`\`
+
+This fails as soon as \`self\` has a \`\`@\`cached_method\`:
+
+* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.
+* A restored pickle contains a \`PickledMethod\` which is not considered the same as the \`CachedMethodCaller(NoArgs)\` in the original object.
+
+The instances which use this in their implementations of \`__cmp__\` seem to be limited to \`doctest/\`. There, such an implementation should be fine:
+
+\`\`\`
+sage: search_src("cmp\(self.__dict__,")
+doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)
+doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)
+doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)
+doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)
+\`\`\`
 
 Comment: 1
 
```




---

archive/issue_comments_320182.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+The following is a common pattern in implementations of \\`__cmp__\\` or \\`__eq__\\`:\n \n+\\`\\`\\`\n+sage: search_src(\"__dict__ == \")\n+categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\n+combinat/dlx.py:142:        return self.__dict__ == other.__dict__\n+combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__\n+geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__\n+misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__\n+modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__\n+modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__\n+\\`\\`\\`\n+\n+This fails as soon as \\`self\\` has a \\`\\`@\\`cached_method\\`:\n+\n+* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.\n+* A restored pickle contains a \\`PickledMethod\\` which is not considered the same as the \\`CachedMethodCaller(NoArgs)\\` in the original object.\n+\n+Interestingly, almost all these cases, do not implement \\`__ne__\\` which makes \\`!=\\` not the negation of \\`==\\`. Also, most do not implement \\`__hash__\\`, or implement it incorrectly,\n+\n+The instances which use this in their implementations of \\`__cmp__\\` seem to be limited to \\`doctest/\\`. There, such an implementation should be fine:\n+\n+\\`\\`\\`\n+sage: search_src(\"cmp\\(self.__dict__,\")\n+doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)\n+doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)\n+doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)\n+doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)\n+\\`\\`\\`\n \n Comment: 1\n \n```\n",
    "created_at": "2016-11-18T05:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21894#issuecomment-320182",
    "user": "https://github.com/saraedum"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,32 @@
+The following is a common pattern in implementations of \`__cmp__\` or \`__eq__\`:
 
+\`\`\`
+sage: search_src("__dict__ == ")
+categories/poor_man_map.py:93:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
+combinat/dlx.py:142:        return self.__dict__ == other.__dict__
+combinat/knutson_tao_puzzles.py:586:            return self.__dict__ == other.__dict__
+geometry/toric_plotter.py:264:        return type(self) is type(other) and self.__dict__ == other.__dict__
+misc/misc.py:1611:        return self.__class__ == other.__class__ and self.__dict__ == other.__dict__
+modules/with_basis/morphism.py:334:        return self.__class__ is other.__class__ and parent(self) == parent(other) and self.__dict__ == other.__dict__
+modules/with_basis/morphism.py:1474:        return self.__class__ is other.__class__ and self.__dict__ == other.__dict__
+\`\`\`
+
+This fails as soon as \`self\` has a \`\`@\`cached_method\`:
+
+* Instances that would be considered equal but have different elements in their cache are not detected as being equal anymore.
+* A restored pickle contains a \`PickledMethod\` which is not considered the same as the \`CachedMethodCaller(NoArgs)\` in the original object.
+
+Interestingly, almost all these cases, do not implement \`__ne__\` which makes \`!=\` not the negation of \`==\`. Also, most do not implement \`__hash__\`, or implement it incorrectly,
+
+The instances which use this in their implementations of \`__cmp__\` seem to be limited to \`doctest/\`. There, such an implementation should be fine:
+
+\`\`\`
+sage: search_src("cmp\(self.__dict__,")
+doctest/control.py:139:        return cmp(self.__dict__,other.__dict__)
+doctest/parsing.py:458:        return cmp(self.__dict__, other.__dict__)
+doctest/sources.py:152:        return cmp(self.__dict__, other.__dict__)
+doctest/util.py:193:        return cmp(self.__dict__, other.__dict__)
+\`\`\`
 
 Comment: 1
 
```




---

archive/issue_comments_320183.json:
```json
{
    "body": "<a id='comment:4'></a>See #19820 for the module morphism.",
    "created_at": "2016-11-18T06:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21894#issuecomment-320183",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>See #19820 for the module morphism.



---

archive/issue_comments_320184.json:
```json
{
    "body": "<a id='comment:5'></a>Thanks for pointing that one out.",
    "created_at": "2016-11-18T21:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21894#issuecomment-320184",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>Thanks for pointing that one out.
