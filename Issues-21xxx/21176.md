# Issue 21176: getting rid of some more cmp() in pyx files

archive/issues_020939.json:
```json
{
    "body": "as small steps towards py3\n\nhere is another bunch of cmp removed\n\nmethod: try to compile sage with python3 and solve one failure after the other.\n\nThis should help to see what kinds of problems and solutions we will meet about cmp.\n\nCC:  @jdemeyer @tscrim\n\nBranch/Commit: [38cce3dcd24ce9b8096fda496e0bc2babbf7b293](https://github.com/sagemath/sagetrac-mirror/commit/38cce3dcd24ce9b8096fda496e0bc2babbf7b293)\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21176\n\n",
    "closed_at": "2016-08-14T19:05:42Z",
    "created_at": "2016-08-05T15:25:34Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "getting rid of some more cmp() in pyx files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21176",
    "user": "https://github.com/fchapoton"
}
```
as small steps towards py3

here is another bunch of cmp removed

method: try to compile sage with python3 and solve one failure after the other.

This should help to see what kinds of problems and solutions we will meet about cmp.

CC:  @jdemeyer @tscrim

Branch/Commit: [38cce3dcd24ce9b8096fda496e0bc2babbf7b293](https://github.com/sagemath/sagetrac-mirror/commit/38cce3dcd24ce9b8096fda496e0bc2babbf7b293)

Reviewer: Jeroen Demeyer

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21176





---

archive/issue_comments_391050.json:
```json
{
    "body": "Changing branch from \"\" to \"public/21176\"",
    "created_at": "2016-08-05T15:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391050",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "public/21176"



---

archive/issue_comments_391051.json:
```json
{
    "body": "Changing commit from \"\" to \"4b3e415280e4975d595f77aebe03b85c034425f8\"",
    "created_at": "2016-08-05T15:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391051",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "4b3e415280e4975d595f77aebe03b85c034425f8"



---

archive/issue_comments_391052.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------|\n|[74b61ca](https://github.com/sagemath/sagetrac-mirror/commit/74b61cacf799ad7984b9f873afa6000f63d21381)|`cmp in morphism.pyx`|\n|[49c9122](https://github.com/sagemath/sagetrac-mirror/commit/49c9122ab0d7284d45805a9538c0691b8b469a81)|`fix`|\n|[d69bb0f](https://github.com/sagemath/sagetrac-mirror/commit/d69bb0ff4419f59787c95a826e8440d69dbe3f8e)|`cmp in binary_code`|\n|[5099c4d](https://github.com/sagemath/sagetrac-mirror/commit/5099c4db711a84346df4c782aff309785d5a931d)|`cmp in data_structures_pyx.pxi`|\n|[0f559c8](https://github.com/sagemath/sagetrac-mirror/commit/0f559c81501949e68fbded7dadaa0906aac39674)|`fix`|\n|[2933e53](https://github.com/sagemath/sagetrac-mirror/commit/2933e53f59a3a8667bdc50130c1f0dea8fe73455)|`cmp in codecan`|\n|[94dd42c](https://github.com/sagemath/sagetrac-mirror/commit/94dd42c05975480caeb254d29d337c7f9fc3bb49)|`cmp in crystals of letters`|\n|[eea60dd](https://github.com/sagemath/sagetrac-mirror/commit/eea60ddaf6581eb3bfc9ba79ff5b5130ad0b57d9)|`using a sign function`|\n|[4b3e415](https://github.com/sagemath/sagetrac-mirror/commit/4b3e415280e4975d595f77aebe03b85c034425f8)|`cmp in dancing_links`|",
    "created_at": "2016-08-05T15:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391052",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                     |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------|
|[74b61ca](https://github.com/sagemath/sagetrac-mirror/commit/74b61cacf799ad7984b9f873afa6000f63d21381)|`cmp in morphism.pyx`|
|[49c9122](https://github.com/sagemath/sagetrac-mirror/commit/49c9122ab0d7284d45805a9538c0691b8b469a81)|`fix`|
|[d69bb0f](https://github.com/sagemath/sagetrac-mirror/commit/d69bb0ff4419f59787c95a826e8440d69dbe3f8e)|`cmp in binary_code`|
|[5099c4d](https://github.com/sagemath/sagetrac-mirror/commit/5099c4db711a84346df4c782aff309785d5a931d)|`cmp in data_structures_pyx.pxi`|
|[0f559c8](https://github.com/sagemath/sagetrac-mirror/commit/0f559c81501949e68fbded7dadaa0906aac39674)|`fix`|
|[2933e53](https://github.com/sagemath/sagetrac-mirror/commit/2933e53f59a3a8667bdc50130c1f0dea8fe73455)|`cmp in codecan`|
|[94dd42c](https://github.com/sagemath/sagetrac-mirror/commit/94dd42c05975480caeb254d29d337c7f9fc3bb49)|`cmp in crystals of letters`|
|[eea60dd](https://github.com/sagemath/sagetrac-mirror/commit/eea60ddaf6581eb3bfc9ba79ff5b5130ad0b57d9)|`using a sign function`|
|[4b3e415](https://github.com/sagemath/sagetrac-mirror/commit/4b3e415280e4975d595f77aebe03b85c034425f8)|`cmp in dancing_links`|



---

archive/issue_comments_391053.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|\n|[c7c7b0c](https://github.com/sagemath/sagetrac-mirror/commit/c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73)|`remove cmp in morphism, binary_code, data_structures_pyx.pxi, codecan, etc`|",
    "created_at": "2016-08-05T16:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
|[c7c7b0c](https://github.com/sagemath/sagetrac-mirror/commit/c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73)|`remove cmp in morphism, binary_code, data_structures_pyx.pxi, codecan, etc`|



---

archive/issue_comments_391054.json:
```json
{
    "body": "Changing commit from \"4b3e415280e4975d595f77aebe03b85c034425f8\" to \"c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73\"",
    "created_at": "2016-08-05T16:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4b3e415280e4975d595f77aebe03b85c034425f8" to "c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73"



---

archive/issue_comments_391055.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-05T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391055",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391056.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n as small steps towards py3\n+\n+here is another bunch of cmp removed\n+\n+method: try to compile sage with python3 and solve one failure after the other.\n+\n+This should help to see what kinds of problems and solutions we will meet about cmp.\n``````\n",
    "created_at": "2016-08-05T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391056",
    "user": "https://github.com/fchapoton"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,7 @@
 as small steps towards py3
+
+here is another bunch of cmp removed
+
+method: try to compile sage with python3 and solve one failure after the other.
+
+This should help to see what kinds of problems and solutions we will meet about cmp.
``````




---

archive/issue_comments_391057.json:
```json
{
    "body": "<a id='comment:4'></a>\nFor the record, I think that getting rid of `__cmp__` is more important than getting rid of `cmp`. The reason is that we could always just write a `cmp()` function but we cannot easily deal with `__cmp__`.",
    "created_at": "2016-08-05T19:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391057",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
For the record, I think that getting rid of `__cmp__` is more important than getting rid of `cmp`. The reason is that we could always just write a `cmp()` function but we cannot easily deal with `__cmp__`.



---

archive/issue_comments_391058.json:
```json
{
    "body": "<a id='comment:5'></a>\nbot is green",
    "created_at": "2016-08-06T06:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391058",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
bot is green



---

archive/issue_comments_391059.json:
```json
{
    "body": "<a id='comment:6'></a>\nAbout `src/sage/categories/morphism.pyx`:\n\nYou are changing code of the form\n\n```\nc = cmp(x.A, y.A)\nif c: return c\nc = cmp(x.B, y.B)\nif c: return c\nc = cmp(x.C, y.C)\nreturn c\n```\nto\n\n```\nt = (x.A, x.B, x.C)\nu = (y.A, y.B, y.C)\nreturn richcmp(t, u, op)\n```\n\nThe latter is less efficient because it does not \"lazily\" compute the `.B` and `.C` attributes.\n\nI think that more efficient code should be written. Here is an idea:\n\n```\n# Helper method in sage_object.pxd (based on #21128 to avoid conflicts)\ncpdef inline richcmp_not_equal(x, y, int op):\n    \"\"\"\n    Like ``richcmp(x, y, op)`` but where it is known that `x` is not equal to `y`.\n    \"\"\"\n    if op == Py_EQ:\n        return False\n    if op == Py_NE:\n        return True\n    return PyObject_RichCompare(x, y, op)\n    \n# Actual code in _richcmp_\nif x.A != y.A:\n    return richcmp_not_equal(x.A, y.A, op)\nif x.B != y.B:\n    return richcmp_not_equal(x.B, y.B, op)\nreturn PyObject_RichCompare(x.C, y.C, op)\n```",
    "created_at": "2016-08-06T09:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391059",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
About `src/sage/categories/morphism.pyx`:

You are changing code of the form

```
c = cmp(x.A, y.A)
if c: return c
c = cmp(x.B, y.B)
if c: return c
c = cmp(x.C, y.C)
return c
```
to

```
t = (x.A, x.B, x.C)
u = (y.A, y.B, y.C)
return richcmp(t, u, op)
```

The latter is less efficient because it does not "lazily" compute the `.B` and `.C` attributes.

I think that more efficient code should be written. Here is an idea:

```
# Helper method in sage_object.pxd (based on #21128 to avoid conflicts)
cpdef inline richcmp_not_equal(x, y, int op):
    """
    Like ``richcmp(x, y, op)`` but where it is known that `x` is not equal to `y`.
    """
    if op == Py_EQ:
        return False
    if op == Py_NE:
        return True
    return PyObject_RichCompare(x, y, op)
    
# Actual code in _richcmp_
if x.A != y.A:
    return richcmp_not_equal(x.A, y.A, op)
if x.B != y.B:
    return richcmp_not_equal(x.B, y.B, op)
return PyObject_RichCompare(x.C, y.C, op)
```



---

archive/issue_comments_391060.json:
```json
{
    "body": "<a id='comment:7'></a>\nIn fact, I think this `_cmp_` in morphism is probably never used anywhere. The current code in the branch is broken (self.domain is missing parentheses), and yet all doctests pass !\n\nAbout the general issue you ask, what about having a method\n\n```\nrichcmp_lazy_for_list(self, other, list_of_functions, op)\n```\nwhere list of functions would be used as a \"lazy-key\" for comparison.\n\nIn the example appearing in morphism, we would use\n\n```\nrichcmp_lazy_for_list(self, other, [lambda x: x.domain(), lambda x: x.codomain(),\n  lambda x: tuple(x(gen) for gen in x.domain().gens())], op)\n```\n\nThis `richcmp_lazy_for_list` would evaluate step by step, using as few functions as possible.\n\nWe are really hit hard here by the rather dubious preference in python3 for sorting keys rather than sorting functions. I think we need some kind of lazy-key mechanism.",
    "created_at": "2016-08-07T11:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391060",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
In fact, I think this `_cmp_` in morphism is probably never used anywhere. The current code in the branch is broken (self.domain is missing parentheses), and yet all doctests pass !

About the general issue you ask, what about having a method

```
richcmp_lazy_for_list(self, other, list_of_functions, op)
```
where list of functions would be used as a "lazy-key" for comparison.

In the example appearing in morphism, we would use

```
richcmp_lazy_for_list(self, other, [lambda x: x.domain(), lambda x: x.codomain(),
  lambda x: tuple(x(gen) for gen in x.domain().gens())], op)
```

This `richcmp_lazy_for_list` would evaluate step by step, using as few functions as possible.

We are really hit hard here by the rather dubious preference in python3 for sorting keys rather than sorting functions. I think we need some kind of lazy-key mechanism.



---

archive/issue_comments_391061.json:
```json
{
    "body": "<a id='comment:8'></a>\nMy main goal was to improve performance. I don't know whether complicated constructions using lists of `lambda`s will meet that goal.",
    "created_at": "2016-08-07T16:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391061",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
My main goal was to improve performance. I don't know whether complicated constructions using lists of `lambda`s will meet that goal.



---

archive/issue_comments_391062.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-08T07:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391062",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_391063.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|\n|[38cce3d](https://github.com/sagemath/sagetrac-mirror/commit/38cce3dcd24ce9b8096fda496e0bc2babbf7b293)|`remove cmp in binary_code, codecan, etc`|",
    "created_at": "2016-08-08T07:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
|[38cce3d](https://github.com/sagemath/sagetrac-mirror/commit/38cce3dcd24ce9b8096fda496e0bc2babbf7b293)|`remove cmp in binary_code, codecan, etc`|



---

archive/issue_comments_391064.json:
```json
{
    "body": "Changing commit from \"c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73\" to \"38cce3dcd24ce9b8096fda496e0bc2babbf7b293\"",
    "created_at": "2016-08-08T07:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c7c7b0cbcc90ad04f872507418a3fb3c0ed2db73" to "38cce3dcd24ce9b8096fda496e0bc2babbf7b293"



---

archive/issue_comments_391065.json:
```json
{
    "body": "<a id='comment:11'></a>\nI removed the changes in `src/sage/categories/morphism.pyx` and `src/sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi`. For the latter, I don't think your branch was equivalent with the old code (at least it was not obvious to me).",
    "created_at": "2016-08-08T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391065",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
I removed the changes in `src/sage/categories/morphism.pyx` and `src/sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi`. For the latter, I don't think your branch was equivalent with the old code (at least it was not obvious to me).



---

archive/issue_comments_391066.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2016-08-08T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391066",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_391067.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-08-08T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391067",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_391068.json:
```json
{
    "body": "<a id='comment:12'></a>\nThanks. \n\nFor morphism, I understand and agree.\n\nThe other one was good I think.",
    "created_at": "2016-08-08T07:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391068",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>
Thanks. 

For morphism, I understand and agree.

The other one was good I think.



---

archive/issue_comments_391069.json:
```json
{
    "body": "Changing branch from \"public/21176\" to \"38cce3dcd24ce9b8096fda496e0bc2babbf7b293\"",
    "created_at": "2016-08-14T19:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391069",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/21176" to "38cce3dcd24ce9b8096fda496e0bc2babbf7b293"



---

archive/issue_comments_391070.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-14T19:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21176#issuecomment-391070",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064235.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-14T19:05:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21176",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21176#event-64235"
}
```
