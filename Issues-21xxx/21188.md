# Issue 21188: Patch to Singular build to not explicitly link to MPIR

archive/issues_020951.json:
```json
{
    "assignees": [],
    "body": "When building Singular on a system that has Flint (i.e. in Sage), its configure/makefiles add some compiler and linker flags specifically \"needed\" for Flint.\n\nOne of these flags includes `-lmpir` which is incongruous with the fact that Singular itself links with GMP with `-lgmp`.\n\nThis patch removes the unnecessary `-lmpir`.  As was mentioned in [this thread](https://groups.google.com/d/msg/sage-devel/6niNzyvh55I/VPtl88tUBwAJ), there has been effort in the past (for compatibility purposes) to remove explicit mentions of \"mpir\" in build systems for Sage packages in favor of \"gmp\".  This is just an example that slipped through the cracks.\n\nIt didn't cause a problem on Linux because everything in Singular linked first with GMP via `-lgmp`, so all symbols got resolved to libgmp, and libmpir was never even used (not even added as a `DT_NEEDED` entry).  However due to subtle linking differences in Cygwin (that I have no worked out the specifics of), some symbols end up being found in libgmp while most others are found in libmpir, and the resulting executables end up loading both.\n\nThis is related to #21174, but not necessarily dependent.  Not sure whether or not this is worth reporting upstream.\n\nCC:  @nexttime\n\nKeywords: **FLINT not found --with-mp=gmp -lmpir**\n\nBranch/Commit: **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**\n\nReviewer: **Jeroen Demeyer, Leif Leonhardy**\n\nAuthor: **Erik Bray**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21188_\n\n",
    "closed_at": "2016-08-13T22:51:18Z",
    "created_at": "2016-08-08T08:01:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Patch to Singular build to not explicitly link to MPIR",
    "type": "issue",
    "updated_at": "2016-08-13T22:51:18Z",
    "url": "https://github.com/sagemath/sage/issues/21188",
    "user": "https://github.com/embray"
}
```
When building Singular on a system that has Flint (i.e. in Sage), its configure/makefiles add some compiler and linker flags specifically "needed" for Flint.

One of these flags includes `-lmpir` which is incongruous with the fact that Singular itself links with GMP with `-lgmp`.

This patch removes the unnecessary `-lmpir`.  As was mentioned in [this thread](https://groups.google.com/d/msg/sage-devel/6niNzyvh55I/VPtl88tUBwAJ), there has been effort in the past (for compatibility purposes) to remove explicit mentions of "mpir" in build systems for Sage packages in favor of "gmp".  This is just an example that slipped through the cracks.

It didn't cause a problem on Linux because everything in Singular linked first with GMP via `-lgmp`, so all symbols got resolved to libgmp, and libmpir was never even used (not even added as a `DT_NEEDED` entry).  However due to subtle linking differences in Cygwin (that I have no worked out the specifics of), some symbols end up being found in libgmp while most others are found in libmpir, and the resulting executables end up loading both.

This is related to #21174, but not necessarily dependent.  Not sure whether or not this is worth reporting upstream.

CC:  @nexttime

Keywords: **FLINT not found --with-mp=gmp -lmpir**

Branch/Commit: **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**

Reviewer: **Jeroen Demeyer, Leif Leonhardy**

Author: **Erik Bray**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/21188_





---

archive/issue_events_295277.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-08T08:01:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "0000b0",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295277"
}
```



---

archive/issue_events_295278.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-08T08:01:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295278"
}
```



---

archive/issue_events_295279.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-08T08:01:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295279"
}
```



---

archive/issue_comments_308921.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI would prefer to bump the Singular version number, to force the patch to take effect.\n\nAnd remember to set the ticket to needs_review when you are done.",
    "created_at": "2016-08-08T08:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308921",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

I would prefer to bump the Singular version number, to force the patch to take effect.

And remember to set the ticket to needs_review when you are done.



---

archive/issue_comments_308922.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nOkay, yes of course.",
    "created_at": "2016-08-08T11:54:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308922",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">comment:2</div>

Okay, yes of course.



---

archive/issue_events_295280.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-08T11:55:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295280"
}
```



---

archive/issue_comments_308923.json:
```json
{
    "body": "Changed commit from **[`e577451`](https://github.com/sagemath/sagetrac-mirror/commit/e57745150784ac435b6150bb5cab9dcb494e0a74)** to **[`ff9fb0a`](https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08)**",
    "created_at": "2016-08-08T11:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308923",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`e577451`](https://github.com/sagemath/sagetrac-mirror/commit/e57745150784ac435b6150bb5cab9dcb494e0a74)** to **[`ff9fb0a`](https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08)**



---

archive/issue_comments_308924.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08\"><code>ff9fb0a</code></a></td><td><code>Bump Singular spkg version number</code></td></tr></table>\n",
    "created_at": "2016-08-08T11:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308924",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08"><code>ff9fb0a</code></a></td><td><code>Bump Singular spkg version number</code></td></tr></table>




---

archive/issue_comments_308925.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n\n```\n[singular-3.1.7p1.p2] Applying ../patches/flint-libs.patch\n[singular-3.1.7p1.p2] can't find file to patch at input line 6\n[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?\n[singular-3.1.7p1.p2] The text leading up to this was:\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] |Remove explicit references to -lmpir; instead use plain GMP (which may have\n[singular-3.1.7p1.p2] |been provided by MPIR).\n[singular-3.1.7p1.p2] |diff -ruN a/factory/configure b/factory/configure\n[singular-3.1.7p1.p2] |--- a/factory/configure  2016-08-04 14:32:27.460652100 +0200\n[singular-3.1.7p1.p2] |+++ b/factory/configure  2016-08-04 14:31:41.086952100 +0200\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] File to patch: \n[singular-3.1.7p1.p2] Skip this patch? [y] \n[singular-3.1.7p1.p2] Skipping patch.\n[singular-3.1.7p1.p2] 1 out of 1 hunk ignored\n[singular-3.1.7p1.p2] can't find file to patch at input line 18\n[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?\n[singular-3.1.7p1.p2] The text leading up to this was:\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] |diff -ruN a/factory/flint-check.m4 b/factory/flint-check.m4\n[singular-3.1.7p1.p2] |--- a/factory/flint-check.m4     2016-08-04 14:32:27.439640500 +0200\n[singular-3.1.7p1.p2] |+++ b/factory/flint-check.m4     2016-08-04 14:31:26.780956400 +0200\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] File to patch: \n[singular-3.1.7p1.p2] Skip this patch? [y] \n[singular-3.1.7p1.p2] Skipping patch.\n[singular-3.1.7p1.p2] 1 out of 1 hunk ignored\n[singular-3.1.7p1.p2] can't find file to patch at input line 30\n[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?\n[singular-3.1.7p1.p2] The text leading up to this was:\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] |diff -ruN a/Singular/configure.in b/Singular/configure.in\n[singular-3.1.7p1.p2] |--- a/Singular/configure.in      2016-08-04 14:32:25.813801600 +0200\n[singular-3.1.7p1.p2] |+++ b/Singular/configure.in      2016-08-04 14:31:08.788116800 +0200\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] File to patch: \n[singular-3.1.7p1.p2] Skip this patch? [y] \n[singular-3.1.7p1.p2] Skipping patch.\n[singular-3.1.7p1.p2] 1 out of 1 hunk ignored\n[singular-3.1.7p1.p2] can't find file to patch at input line 41\n[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?\n[singular-3.1.7p1.p2] The text leading up to this was:\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] |--- a/Singular/configure 2016-08-04 14:32:27.084437500 +0200\n[singular-3.1.7p1.p2] |+++ b/Singular/configure 2016-08-04 15:12:29.084236200 +0200\n[singular-3.1.7p1.p2] --------------------------\n[singular-3.1.7p1.p2] File to patch: \n[singular-3.1.7p1.p2] Skip this patch? [y] \n[singular-3.1.7p1.p2] Skipping patch.\n[singular-3.1.7p1.p2] 1 out of 1 hunk ignored\n[singular-3.1.7p1.p2] Error applying '../patches/flint-libs.patch'\n[singular-3.1.7p1.p2] Error building Singular (error in apply_patches).\n```",
    "created_at": "2016-08-08T12:28:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308925",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>


```
[singular-3.1.7p1.p2] Applying ../patches/flint-libs.patch
[singular-3.1.7p1.p2] can't find file to patch at input line 6
[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?
[singular-3.1.7p1.p2] The text leading up to this was:
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] |Remove explicit references to -lmpir; instead use plain GMP (which may have
[singular-3.1.7p1.p2] |been provided by MPIR).
[singular-3.1.7p1.p2] |diff -ruN a/factory/configure b/factory/configure
[singular-3.1.7p1.p2] |--- a/factory/configure  2016-08-04 14:32:27.460652100 +0200
[singular-3.1.7p1.p2] |+++ b/factory/configure  2016-08-04 14:31:41.086952100 +0200
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] File to patch: 
[singular-3.1.7p1.p2] Skip this patch? [y] 
[singular-3.1.7p1.p2] Skipping patch.
[singular-3.1.7p1.p2] 1 out of 1 hunk ignored
[singular-3.1.7p1.p2] can't find file to patch at input line 18
[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?
[singular-3.1.7p1.p2] The text leading up to this was:
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] |diff -ruN a/factory/flint-check.m4 b/factory/flint-check.m4
[singular-3.1.7p1.p2] |--- a/factory/flint-check.m4     2016-08-04 14:32:27.439640500 +0200
[singular-3.1.7p1.p2] |+++ b/factory/flint-check.m4     2016-08-04 14:31:26.780956400 +0200
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] File to patch: 
[singular-3.1.7p1.p2] Skip this patch? [y] 
[singular-3.1.7p1.p2] Skipping patch.
[singular-3.1.7p1.p2] 1 out of 1 hunk ignored
[singular-3.1.7p1.p2] can't find file to patch at input line 30
[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?
[singular-3.1.7p1.p2] The text leading up to this was:
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] |diff -ruN a/Singular/configure.in b/Singular/configure.in
[singular-3.1.7p1.p2] |--- a/Singular/configure.in      2016-08-04 14:32:25.813801600 +0200
[singular-3.1.7p1.p2] |+++ b/Singular/configure.in      2016-08-04 14:31:08.788116800 +0200
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] File to patch: 
[singular-3.1.7p1.p2] Skip this patch? [y] 
[singular-3.1.7p1.p2] Skipping patch.
[singular-3.1.7p1.p2] 1 out of 1 hunk ignored
[singular-3.1.7p1.p2] can't find file to patch at input line 41
[singular-3.1.7p1.p2] Perhaps you used the wrong -p or --strip option?
[singular-3.1.7p1.p2] The text leading up to this was:
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] |--- a/Singular/configure 2016-08-04 14:32:27.084437500 +0200
[singular-3.1.7p1.p2] |+++ b/Singular/configure 2016-08-04 15:12:29.084236200 +0200
[singular-3.1.7p1.p2] --------------------------
[singular-3.1.7p1.p2] File to patch: 
[singular-3.1.7p1.p2] Skip this patch? [y] 
[singular-3.1.7p1.p2] Skipping patch.
[singular-3.1.7p1.p2] 1 out of 1 hunk ignored
[singular-3.1.7p1.p2] Error applying '../patches/flint-libs.patch'
[singular-3.1.7p1.p2] Error building Singular (error in apply_patches).
```



---

archive/issue_events_295281.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-08-08T12:28:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295281"
}
```



---

archive/issue_events_295282.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-08-08T12:28:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295282"
}
```



---

archive/issue_events_295283.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-08-08T12:28:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295283"
}
```



---

archive/issue_comments_308926.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2016-08-08T12:28:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308926",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_308927.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nNote that #17254 upgrades Singular to 4.x (but it doesn't seem this ticket will be ready soon).\n\nWhile (I've heard) a lot has changed in the new Singular version, including the build, I haven't looked at the latter yet.\n\nSo we *may* have to apply a similar patch to Singular 4.x as well.",
    "created_at": "2016-08-08T12:50:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308927",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Note that #17254 upgrades Singular to 4.x (but it doesn't seem this ticket will be ready soon).

While (I've heard) a lot has changed in the new Singular version, including the build, I haven't looked at the latter yet.

So we *may* have to apply a similar patch to Singular 4.x as well.



---

archive/issue_comments_308928.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIt is still unclear to me why the linker didn't bail out when I built Sage with `--with-mp=gmp` from scratch on a Linux system where MPIR isn't installed.\n\nI also have no traces of MPIR in my Singular build logs even in Sage builds with MPIR.\n\n\\\\\n\nAnd btw., unless you specify `--as-needed`, any shared library you give on the linker command line will appear as a dependency in the shared library or program you create, no matter whether any symbol from it is referenced or not, provided the library can be found of course.  (This may be the default on some systems though.)\n\nAFAIK on Cygwin static import libraries are used, where in principle only object files with referenced symbols should get included into the link (unless one specifies `--whole-archive`).",
    "created_at": "2016-08-08T13:30:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308928",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:7" align="right">comment:7</div>

It is still unclear to me why the linker didn't bail out when I built Sage with `--with-mp=gmp` from scratch on a Linux system where MPIR isn't installed.

I also have no traces of MPIR in my Singular build logs even in Sage builds with MPIR.

\\

And btw., unless you specify `--as-needed`, any shared library you give on the linker command line will appear as a dependency in the shared library or program you create, no matter whether any symbol from it is referenced or not, provided the library can be found of course.  (This may be the default on some systems though.)

AFAIK on Cygwin static import libraries are used, where in principle only object files with referenced symbols should get included into the link (unless one specifies `--whole-archive`).



---

archive/issue_comments_308929.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nNot sure what the problem is here.  The patch applies fine for me.\n\n```\n[singular-3.1.7p1.p1] Applying /home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/singular-3.1.7p1.p1/patches/flint-libs.patch\n[singular-3.1.7p1.p1] patching file factory/configure\n[singular-3.1.7p1.p1] patching file factory/flint-check.m4\n[singular-3.1.7p1.p1] patching file Singular/configure.in\n[singular-3.1.7p1.p1] patching file Singular/configure\n```\n\nInteresting that you get a relative path in the \"Applying\" message while I get an absolute path.  Odd.",
    "created_at": "2016-08-08T15:56:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308929",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

Not sure what the problem is here.  The patch applies fine for me.

```
[singular-3.1.7p1.p1] Applying /home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/singular-3.1.7p1.p1/patches/flint-libs.patch
[singular-3.1.7p1.p1] patching file factory/configure
[singular-3.1.7p1.p1] patching file factory/flint-check.m4
[singular-3.1.7p1.p1] patching file Singular/configure.in
[singular-3.1.7p1.p1] patching file Singular/configure
```

Interesting that you get a relative path in the "Applying" message while I get an absolute path.  Odd.



---

archive/issue_comments_308930.json:
```json
{
    "body": "Changed keywords from none to **FLINT not found --with-mp=gmp -lmpir**",
    "created_at": "2016-08-08T16:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308930",
    "user": "https://github.com/nexttime"
}
```

Changed keywords from none to **FLINT not found --with-mp=gmp -lmpir**



---

archive/issue_comments_308931.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@nexttime](#comment:7):\n> It is still unclear to me why the linker didn't bail out when I built Sage with `--with-mp=gmp` from scratch on a Linux system where MPIR isn't installed.\n\nOk, looking closer, the `configure` check for FLINT simply failed (because of the `-lmpir`), and Singular \"silently\" got built without FLINT, without me ever noticing. XD\n\n\\\\\n\n> I also have no traces of MPIR in my Singular build logs even in Sage builds with MPIR.\n\nTrying again I have to take that back; no idea how, but I somehow must have misgrepped `mpir`, or accidentally only searched Sage trees that were in fact built with GMP, searched all logs but Singular's was deleted, or whatever.  When building with MPIR, `-lmpir` is of course there.\n\n---\n\nSo more or less incidentally, this ticket will also fix that when configuring Sage with `--with-mp=gmp`, currently Singular gets built without (using) FLINT. :-)",
    "created_at": "2016-08-08T16:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308931",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@nexttime](#comment:7):
> It is still unclear to me why the linker didn't bail out when I built Sage with `--with-mp=gmp` from scratch on a Linux system where MPIR isn't installed.

Ok, looking closer, the `configure` check for FLINT simply failed (because of the `-lmpir`), and Singular "silently" got built without FLINT, without me ever noticing. XD

\\

> I also have no traces of MPIR in my Singular build logs even in Sage builds with MPIR.

Trying again I have to take that back; no idea how, but I somehow must have misgrepped `mpir`, or accidentally only searched Sage trees that were in fact built with GMP, searched all logs but Singular's was deleted, or whatever.  When building with MPIR, `-lmpir` is of course there.

---

So more or less incidentally, this ticket will also fix that when configuring Sage with `--with-mp=gmp`, currently Singular gets built without (using) FLINT. :-)



---

archive/issue_comments_308932.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@embray](#comment:8):\n> Not sure what the problem is here.  The patch applies fine for me.\n\nThe `-p1` when patching (I think).\n\nLooks like you didn't put `latest/` in when creating the patches.\n\n(Just try `head build/pkgs/singular/patches/*.patch`.)",
    "created_at": "2016-08-08T16:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308932",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@embray](#comment:8):
> Not sure what the problem is here.  The patch applies fine for me.

The `-p1` when patching (I think).

Looks like you didn't put `latest/` in when creating the patches.

(Just try `head build/pkgs/singular/patches/*.patch`.)



---

archive/issue_comments_308933.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOh. It looks like maybe #20933 was merged into develop since I started this branch, or something.  Or more specifically, since I committed to the branch that this branch cherry-picked from (which I don't pull in from develop often because I'm trying to get *a version* of Sage working, and pulling too frequently from develop is too much of a fast moving target).",
    "created_at": "2016-08-08T16:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308933",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Oh. It looks like maybe #20933 was merged into develop since I started this branch, or something.  Or more specifically, since I committed to the branch that this branch cherry-picked from (which I don't pull in from develop often because I'm trying to get *a version* of Sage working, and pulling too frequently from develop is too much of a fast moving target).



---

archive/issue_comments_308934.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSo although #20933 was closed as fixed 11 days ago, and its milestone is 7.3, it's not merged into 7.3?\n\nOr am I missing something?",
    "created_at": "2016-08-08T16:28:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308934",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:12" align="right">comment:12</div>

So although #20933 was closed as fixed 11 days ago, and its milestone is 7.3, it's not merged into 7.3?

Or am I missing something?



---

archive/issue_comments_308935.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\n#20933 was merged in 7.3.rc0, and the branch on this ticket also contains #20933.",
    "created_at": "2016-08-08T16:32:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308935",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

#20933 was merged in 7.3.rc0, and the branch on this ticket also contains #20933.



---

archive/issue_comments_308936.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@jdemeyer](#comment:13):\n> #20933 was merged in 7.3.rc0, and the branch on this ticket also contains #20933.\n\nAh, ok.  I thought it was the other way around, as I recalled the patches had `latest/` in already before, but only some, and now it's `a/latest/` for these.",
    "created_at": "2016-08-08T17:22:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308936",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@jdemeyer](#comment:13):
> #20933 was merged in 7.3.rc0, and the branch on this ticket also contains #20933.

Ah, ok.  I thought it was the other way around, as I recalled the patches had `latest/` in already before, but only some, and now it's `a/latest/` for these.



---

archive/issue_comments_308937.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI thought I clarified this above, but I'm working in an older branch that is a few weeks behind because I don't want incoming changes to constantly impede my progress.\n\nBut for the purpose of creating tickets I'm branching off the latest develop and cherry-picking individual commits.",
    "created_at": "2016-08-09T09:32:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308937",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

I thought I clarified this above, but I'm working in an older branch that is a few weeks behind because I don't want incoming changes to constantly impede my progress.

But for the purpose of creating tickets I'm branching off the latest develop and cherry-picking individual commits.



---

archive/issue_comments_308938.json:
```json
{
    "body": "Changed commit from **[`ff9fb0a`](https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08)** to **[`8b48583`](https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35)**",
    "created_at": "2016-08-09T09:35:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308938",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ff9fb0a`](https://github.com/sagemath/sagetrac-mirror/commit/ff9fb0a0f37e43f95a0de0963db4efceff95cd08)** to **[`8b48583`](https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35)**



---

archive/issue_comments_308939.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35\"><code>8b48583</code></a></td><td><code>Bump Singular spkg version number</code></td></tr></table>\n",
    "created_at": "2016-08-09T09:35:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308939",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35"><code>8b48583</code></a></td><td><code>Bump Singular spkg version number</code></td></tr></table>




---

archive/issue_comments_308940.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI updated the commit in this branch so that the newly added patch conforms to the \"standardized\" patch format, and also added a direct reference to this ticket.",
    "created_at": "2016-08-09T09:36:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308940",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

I updated the commit in this branch so that the newly added patch conforms to the "standardized" patch format, and also added a direct reference to this ticket.



---

archive/issue_comments_308941.json:
```json
{
    "body": "Changed commit from **[`8b48583`](https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35)** to **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**",
    "created_at": "2016-08-09T09:38:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308941",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8b48583`](https://github.com/sagemath/sagetrac-mirror/commit/8b48583dd29f66228b081259081ee8fddcdafd35)** to **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**



---

archive/issue_comments_308942.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17\"><code>bc84a91</code></a></td><td><code>Adds a patch to Singular to remove spurious -lmpir flags when linking--never use 'mpir' explicitly.</code></td></tr></table>\n",
    "created_at": "2016-08-09T09:38:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308942",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17"><code>bc84a91</code></a></td><td><code>Adds a patch to Singular to remove spurious -lmpir flags when linking--never use 'mpir' explicitly.</code></td></tr></table>




---

archive/issue_events_295284.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T13:12:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295284"
}
```



---

archive/issue_events_295285.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T13:12:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295285"
}
```



---

archive/issue_events_295286.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T14:08:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295286"
}
```



---

archive/issue_events_295287.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T14:08:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295287"
}
```



---

archive/issue_comments_308943.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Leif Leonhardy**",
    "created_at": "2016-08-09T14:08:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308943",
    "user": "https://github.com/nexttime"
}
```

Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Leif Leonhardy**



---

archive/issue_comments_308944.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nROFL, this also fixes three failing doctests with GMP (two of them due to different ordering in results, the third a more weird one, namely an NTL abort when doing `unpickle_all()` twice, cf. #5838).",
    "created_at": "2016-08-09T15:58:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308944",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:21" align="right">comment:21</div>

ROFL, this also fixes three failing doctests with GMP (two of them due to different ordering in results, the third a more weird one, namely an NTL abort when doing `unpickle_all()` twice, cf. #5838).



---

archive/issue_events_295288.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T16:01:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295288"
}
```



---

archive/issue_events_295289.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T16:01:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295289"
}
```



---

archive/issue_comments_308945.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nOr maybe even a blocker.",
    "created_at": "2016-08-09T16:01:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308945",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:22" align="right">comment:22</div>

Or maybe even a blocker.



---

archive/issue_events_295290.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T16:05:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "0000b0",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295290"
}
```



---

archive/issue_events_295291.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-09T16:05:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295291"
}
```



---

archive/issue_comments_308946.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nHow was #5838 resolved before?  Were the tests just disabled or something?  I tried skimming through but it wasn't clear.\n\nUpdate: I think I see what you mean now--just that they were failing when building Sage with GMP instead of MPIR.  Well that's cool, I guess ;)",
    "created_at": "2016-08-10T08:58:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308946",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

How was #5838 resolved before?  Were the tests just disabled or something?  I tried skimming through but it wasn't clear.

Update: I think I see what you mean now--just that they were failing when building Sage with GMP instead of MPIR.  Well that's cool, I guess ;)



---

archive/issue_comments_308947.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@embray](#comment:24):\n> How was #5838 resolved before?  Were the tests just disabled or something?  I tried skimming through but it wasn't clear.\n\nThe double-unpickle error presumably vanished with Singular using FLINT (because the failing code apparently gets shadowed); you can at least get it back (also with MPIR) by simply configuring Singular `--without-flint` (as I've posted [here](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/88220); haven't updated #5838 yet). :-)\n\nNote that the actual test that it's \"solved\" (or \"worksforme\") was added years after the issue popped up.",
    "created_at": "2016-08-10T09:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308947",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@embray](#comment:24):
> How was #5838 resolved before?  Were the tests just disabled or something?  I tried skimming through but it wasn't clear.

The double-unpickle error presumably vanished with Singular using FLINT (because the failing code apparently gets shadowed); you can at least get it back (also with MPIR) by simply configuring Singular `--without-flint` (as I've posted [here](http://permalink.gmane.org/gmane.comp.mathematics.sage.devel/88220); haven't updated #5838 yet). :-)

Note that the actual test that it's "solved" (or "worksforme") was added years after the issue popped up.



---

archive/issue_comments_308948.json:
```json
{
    "body": "Changed branch from **[u/embray/singular-flint-mpir-patch](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/singular-flint-mpir-patch)** to **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**",
    "created_at": "2016-08-13T22:51:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21188#issuecomment-308948",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/singular-flint-mpir-patch](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/singular-flint-mpir-patch)** to **[`bc84a91`](https://github.com/sagemath/sagetrac-mirror/commit/bc84a9124e8f6eb88e1120ebb4d36ba0ceec7d17)**



---

archive/issue_events_295292.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-13T22:51:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295292"
}
```



---

archive/issue_events_295293.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "79735ebf8003556d21f381e2771f02fae266d845",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-08-13T22:51:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21188",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21188#event-295293"
}
```
