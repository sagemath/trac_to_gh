# Issue 21918: Adding subgraph_clusters argument to graphviz_string

archive/issues_021681.json:
```json
{
    "assignees": [],
    "body": "\nWe define some graph. It is the both sided Cayley graph of the monoid generated by two partial maps (defined in Chapter 5 Green\u2019s relations and local theory of the book by Jean \u00c9ric Pin):\n\n```python\nsage: S = FiniteSetMaps(5)\nsage: I = S((0,1,2,3,4))\nsage: a = S((0,1,3,0,0))\nsage: b = S((0,2,4,1,0))\nsage: roots = [I]\nsage: succ = lambda v:[v*a,v*b,a*v,b*v]\nsage: R = RecursivelyEnumeratedSet(roots, succ)\nsage: G = R.to_digraph()\nsage: G\nLooped multi-digraph on 27 vertices\n```\n\nWe view the graph:\n\n```python\nsage: G.latex_options().set_options(prog='dot',format='dot2tex')\nsage: view(G, tightpage=True)\n```\n\nWe view it using dot language subgraphs clusters (here the strongly connected components) and also using optional package dot2tex:\n\n```python\nsage: G.latex_options().set_options(prog='dot',format='dot2tex')\nsage: C = G.strongly_connected_components()\nsage: G.latex_options().set_options(subgraph_clusters=C)\nsage: view(G, tightpage=True)\n```\n\n\nCC:  @sagetrac-jepperlein\n\nKeywords: **days79**\n\nBranch/Commit: **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**\n\nReviewer: **David Coudert**\n\nAuthor: **S\u00e9bastien Labb\u00e9**\n\nComponent: **graph theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21918_\n\n",
    "closed_at": "2017-01-18T20:39:11Z",
    "created_at": "2016-11-21T20:03:48Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Adding subgraph_clusters argument to graphviz_string",
    "type": "issue",
    "updated_at": "2017-01-18T20:39:11Z",
    "url": "https://github.com/sagemath/sage/issues/21918",
    "user": "https://github.com/seblabbe"
}
```

We define some graph. It is the both sided Cayley graph of the monoid generated by two partial maps (defined in Chapter 5 Green’s relations and local theory of the book by Jean Éric Pin):

```python
sage: S = FiniteSetMaps(5)
sage: I = S((0,1,2,3,4))
sage: a = S((0,1,3,0,0))
sage: b = S((0,2,4,1,0))
sage: roots = [I]
sage: succ = lambda v:[v*a,v*b,a*v,b*v]
sage: R = RecursivelyEnumeratedSet(roots, succ)
sage: G = R.to_digraph()
sage: G
Looped multi-digraph on 27 vertices
```

We view the graph:

```python
sage: G.latex_options().set_options(prog='dot',format='dot2tex')
sage: view(G, tightpage=True)
```

We view it using dot language subgraphs clusters (here the strongly connected components) and also using optional package dot2tex:

```python
sage: G.latex_options().set_options(prog='dot',format='dot2tex')
sage: C = G.strongly_connected_components()
sage: G.latex_options().set_options(subgraph_clusters=C)
sage: view(G, tightpage=True)
```


CC:  @sagetrac-jepperlein

Keywords: **days79**

Branch/Commit: **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**

Reviewer: **David Coudert**

Author: **Sébastien Labbé**

Component: **graph theory**

_Issue created by migration from https://trac.sagemath.org/ticket/21918_





---

archive/issue_events_304520.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T20:03:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304520"
}
```



---

archive/issue_events_304521.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T20:03:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "c: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304521"
}
```



---

archive/issue_events_304522.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T20:03:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304522"
}
```



---

archive/issue_events_304523.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T20:03:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304523"
}
```



---

archive/issue_comments_322888.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,8 @@\n \n+```python\n+sage: d = {0:[1],1:[2],2:[3],3:[0,4,9],4:[5],5:[6],6:[7],7:[7,8],8:[6,10],9:[10]}\n+sage: G = DiGraph(d)\n+sage: kwds = dict(prog='dot',format='dot2tex',edge_labels=True, color_by_label=True, prog='dot',subgraphs=[[2,5,8], [1,6,10]])\n+sage: G.latex_options().set_options(**kwds)\n+sage: view(G, tightpage=True)\n+```\n``````\n",
    "created_at": "2016-11-21T20:22:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322888",
    "user": "https://github.com/seblabbe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,8 @@
 
+```python
+sage: d = {0:[1],1:[2],2:[3],3:[0,4,9],4:[5],5:[6],6:[7],7:[7,8],8:[6,10],9:[10]}
+sage: G = DiGraph(d)
+sage: kwds = dict(prog='dot',format='dot2tex',edge_labels=True, color_by_label=True, prog='dot',subgraphs=[[2,5,8], [1,6,10]])
+sage: G.latex_options().set_options(**kwds)
+sage: view(G, tightpage=True)
+```
``````




---

archive/issue_comments_322889.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,32 @@\n+\n+We define some graph. It is the both sided Cayley graph of the monoid generated by two partial maps (defined in Chapter 5 Green\u2019s relations and local theory of the book by Jean \u00c9ric Pin):\n \n ```python\n-sage: d = {0:[1],1:[2],2:[3],3:[0,4,9],4:[5],5:[6],6:[7],7:[7,8],8:[6,10],9:[10]}\n-sage: G = DiGraph(d)\n-sage: kwds = dict(prog='dot',format='dot2tex',edge_labels=True, color_by_label=True, prog='dot',subgraphs=[[2,5,8], [1,6,10]])\n-sage: G.latex_options().set_options(**kwds)\n+sage: S = FiniteSetMaps(5)\n+sage: I = S((0,1,2,3,4))\n+sage: a = S((0,1,3,0,0))\n+sage: b = S((0,2,4,1,0))\n+sage: roots = [I]\n+sage: succ = lambda v:[v*a,v*b,a*v,b*v]\n+sage: R = RecursivelyEnumeratedSet(roots, succ)\n+sage: G = R.to_digraph()\n+sage: G\n+Looped multi-digraph on 27 vertices\n+```\n+\n+We view the graph:\n+\n+```python\n+sage: G.latex_options().set_options(prog='dot',format='dot2tex')\n sage: view(G, tightpage=True)\n ```\n+\n+We view it using dot language subgraphs clusters (here the strongly connected components) and also using optional package dot2tex:\n+\n+```python\n+sage: G.latex_options().set_options(prog='dot',format='dot2tex')\n+sage: C = G.strongly_connected_components()\n+sage: G.latex_options().set_options(subgraph_clusters=C)\n+sage: view(G, tightpage=True)\n+```\n+\n``````\n",
    "created_at": "2016-11-21T21:02:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322889",
    "user": "https://github.com/seblabbe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,32 @@
+
+We define some graph. It is the both sided Cayley graph of the monoid generated by two partial maps (defined in Chapter 5 Green’s relations and local theory of the book by Jean Éric Pin):
 
 ```python
-sage: d = {0:[1],1:[2],2:[3],3:[0,4,9],4:[5],5:[6],6:[7],7:[7,8],8:[6,10],9:[10]}
-sage: G = DiGraph(d)
-sage: kwds = dict(prog='dot',format='dot2tex',edge_labels=True, color_by_label=True, prog='dot',subgraphs=[[2,5,8], [1,6,10]])
-sage: G.latex_options().set_options(**kwds)
+sage: S = FiniteSetMaps(5)
+sage: I = S((0,1,2,3,4))
+sage: a = S((0,1,3,0,0))
+sage: b = S((0,2,4,1,0))
+sage: roots = [I]
+sage: succ = lambda v:[v*a,v*b,a*v,b*v]
+sage: R = RecursivelyEnumeratedSet(roots, succ)
+sage: G = R.to_digraph()
+sage: G
+Looped multi-digraph on 27 vertices
+```
+
+We view the graph:
+
+```python
+sage: G.latex_options().set_options(prog='dot',format='dot2tex')
 sage: view(G, tightpage=True)
 ```
+
+We view it using dot language subgraphs clusters (here the strongly connected components) and also using optional package dot2tex:
+
+```python
+sage: G.latex_options().set_options(prog='dot',format='dot2tex')
+sage: C = G.strongly_connected_components()
+sage: G.latex_options().set_options(subgraph_clusters=C)
+sage: view(G, tightpage=True)
+```
+
``````




---

archive/issue_comments_322890.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5\"><code>9bba185</code></a></td><td><code>21918: adding subgraph_clusters argument to graphviz_string</code></td></tr></table>\n",
    "created_at": "2016-11-21T21:21:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322890",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:3"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5"><code>9bba185</code></a></td><td><code>21918: adding subgraph_clusters argument to graphviz_string</code></td></tr></table>




---

archive/issue_comments_322891.json:
```json
{
    "body": "Branch: **[u/slabbe/21918](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/21918)**",
    "created_at": "2016-11-21T21:21:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322891",
    "user": "https://github.com/seblabbe"
}
```

Branch: **[u/slabbe/21918](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/21918)**



---

archive/issue_events_304524.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T21:21:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304524"
}
```



---

archive/issue_comments_322892.json:
```json
{
    "body": "Commit: **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**",
    "created_at": "2016-11-21T21:21:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322892",
    "user": "https://github.com/seblabbe"
}
```

Commit: **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**



---

archive/issue_events_304525.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-11-21T21:25:05Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "title_is": "Adding subgraph_clusters argument to graphviz_string",
    "title_was": "Adding subgraphs argument to graphviz_string",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304525"
}
```



---

archive/issue_comments_322893.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nMaybe you want to review this?",
    "created_at": "2016-11-23T21:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322893",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:5" align="right">comment:5</div>

Maybe you want to review this?



---

archive/issue_comments_322894.json:
```json
{
    "body": "Author: **S\u00e9bastien Labb\u00e9**",
    "created_at": "2016-11-23T21:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322894",
    "user": "https://github.com/seblabbe"
}
```

Author: **Sébastien Labbé**



---

archive/issue_events_304526.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2016-12-11T12:07:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304526"
}
```



---

archive/issue_events_304527.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2016-12-11T12:07:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304527"
}
```



---

archive/issue_comments_322895.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe patch is working well, except when we set `edge_labels=True`. Is such case, the vertices are effectively grouped by clusters, but the boxes around the clusters are not drawn.\n\n```\nsage: G = digraphs.Kautz(3, 2)\nsage: C = [[u for u in G.vertices() if int(u[0])==l] for l in range(4)]\nsage: G.latex_options().set_options(prog='dot',format='dot2tex', subgraph_clusters=C)\nsage: view(G, tightpage=True)\nsage: G = digraphs.Kautz(3, 2)\nsage: G.latex_options().set_options(prog='dot',format='dot2tex', edge_labels=True, subgraph_clusters=C)\nsage: view(G, tightpage=True)\nsage: G = digraphs.Kautz(3, 2)\nsage: G.latex_options().set_options(prog='dot',format='dot2tex', color_by_label=True, subgraph_clusters=C)\nsage: view(G, tightpage=True)\nsage: G = digraphs.Kautz(3, 2)\nsage: G.latex_options().set_options(prog='dot',format='dot2tex', color_by_label=True, edge_labels=True, subgraph_clusters=C)\nsage: view(G, tightpage=True)\n```",
    "created_at": "2016-12-11T12:07:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322895",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:6" align="right">comment:6</div>

The patch is working well, except when we set `edge_labels=True`. Is such case, the vertices are effectively grouped by clusters, but the boxes around the clusters are not drawn.

```
sage: G = digraphs.Kautz(3, 2)
sage: C = [[u for u in G.vertices() if int(u[0])==l] for l in range(4)]
sage: G.latex_options().set_options(prog='dot',format='dot2tex', subgraph_clusters=C)
sage: view(G, tightpage=True)
sage: G = digraphs.Kautz(3, 2)
sage: G.latex_options().set_options(prog='dot',format='dot2tex', edge_labels=True, subgraph_clusters=C)
sage: view(G, tightpage=True)
sage: G = digraphs.Kautz(3, 2)
sage: G.latex_options().set_options(prog='dot',format='dot2tex', color_by_label=True, subgraph_clusters=C)
sage: view(G, tightpage=True)
sage: G = digraphs.Kautz(3, 2)
sage: G.latex_options().set_options(prog='dot',format='dot2tex', color_by_label=True, edge_labels=True, subgraph_clusters=C)
sage: view(G, tightpage=True)
```



---

archive/issue_comments_322896.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIndeed, but `graphviz` seems to create the boxes correctly:\n\n```\nsage: G = digraphs.Kautz(3, 2)\nsage: C = [[u for u in G.vertices() if int(u[0])==l] for l in range(4)]\nsage: with open('file.dot', 'w') as f:\n....:     f.write(G.graphviz_string(edge_labels=True, subgraph_clusters=C, color_by_label=True))\n....: \nsage: !dot file.dot -Tpdf -ofile.pdf\nsage: !open file.pdf\n```\n\nso maybe it is a problem in `dot2tex`. I will see if I can find a workaround...",
    "created_at": "2016-12-12T20:17:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322896",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:7" align="right">comment:7</div>

Indeed, but `graphviz` seems to create the boxes correctly:

```
sage: G = digraphs.Kautz(3, 2)
sage: C = [[u for u in G.vertices() if int(u[0])==l] for l in range(4)]
sage: with open('file.dot', 'w') as f:
....:     f.write(G.graphviz_string(edge_labels=True, subgraph_clusters=C, color_by_label=True))
....: 
sage: !dot file.dot -Tpdf -ofile.pdf
sage: !open file.pdf
```

so maybe it is a problem in `dot2tex`. I will see if I can find a workaround...



---

archive/issue_comments_322897.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI was able to construct a small example showing the bug:\n\n```python\nedges = [(i,(i+1)%3,a) for i,a in enumerate('abc')]\nG_no_labels = DiGraph(edges)\nG_with_labels = DiGraph(edges)\nC = [[0,1], [2]]\nkwds = dict(subgraph_clusters=C,color_by_label=True,prog='dot',format='dot2tex')\nG_no_labels.latex_options().set_options(edge_labels=False, **kwds)\nG_with_labels.latex_options().set_options(edge_labels=True, **kwds)\n```\n\nWith no labels, each cluster is constructed within a scope including a `\\filldraw` line:\n\n```\nsage: latex(G_no_labels)\n\\begin{tikzpicture}[>=latex,line join=bevel,]\n%%\n\\begin{scope}\n  \\pgfsetstrokecolor{black}\n  \\definecolor{strokecol}{rgb}{0.0,0.0,0.0};\n  \\pgfsetstrokecolor{strokecol}\n  \\definecolor{fillcol}{rgb}{0.94,1.0,1.0};\n  \\pgfsetfillcolor{fillcol}\n  \\filldraw (8.0bp,57.0bp) -- (8.0bp,135.0bp) -- (36.0bp,135.0bp) -- (36.0bp,57.0bp) -- cycle;\n\\end{scope}\n\\begin{scope}\n  \\pgfsetstrokecolor{black}\n  \\definecolor{strokecol}{rgb}{0.0,0.0,0.0};\n  \\pgfsetstrokecolor{strokecol}\n  \\definecolor{fillcol}{rgb}{0.94,1.0,1.0};\n  \\pgfsetfillcolor{fillcol}\n  \\filldraw (17.0bp,8.0bp) -- (17.0bp,37.0bp) -- (45.0bp,37.0bp) -- (45.0bp,8.0bp) -- cycle;\n\\end{scope}\n...\n\\end{tikzpicture}\n```\n\nWith labels, some `\\filldraw` line is missing in one of the scope:\n\n```\nsage: latex(G_with_labels)\n\\begin{tikzpicture}[>=latex,line join=bevel,]\n%%\n\\begin{scope}\n  \\pgfsetstrokecolor{black}\n  \\definecolor{strokecol}{rgb}{0.0,0.0,0.0};\n  \\pgfsetstrokecolor{strokecol}\n  \\definecolor{fillcol}{rgb}{0.94,1.0,1.0};\n  \\pgfsetfillcolor{fillcol}\n\\end{scope}\n\\begin{scope}\n  \\pgfsetstrokecolor{black}\n  \\definecolor{strokecol}{rgb}{0.0,0.0,0.0};\n  \\pgfsetstrokecolor{strokecol}\n  \\definecolor{fillcol}{rgb}{0.94,1.0,1.0};\n  \\pgfsetfillcolor{fillcol}\n  \\filldraw (25.0bp,8.0bp) -- (25.0bp,37.0bp) -- (53.0bp,37.0bp) -- (53.0bp,8.0bp) -- cycle;\n\\end{scope}\n...\n\\end{tikzpicture}\n```",
    "created_at": "2016-12-12T21:25:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322897",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:8" align="right">comment:8</div>

I was able to construct a small example showing the bug:

```python
edges = [(i,(i+1)%3,a) for i,a in enumerate('abc')]
G_no_labels = DiGraph(edges)
G_with_labels = DiGraph(edges)
C = [[0,1], [2]]
kwds = dict(subgraph_clusters=C,color_by_label=True,prog='dot',format='dot2tex')
G_no_labels.latex_options().set_options(edge_labels=False, **kwds)
G_with_labels.latex_options().set_options(edge_labels=True, **kwds)
```

With no labels, each cluster is constructed within a scope including a `\filldraw` line:

```
sage: latex(G_no_labels)
\begin{tikzpicture}[>=latex,line join=bevel,]
%%
\begin{scope}
  \pgfsetstrokecolor{black}
  \definecolor{strokecol}{rgb}{0.0,0.0,0.0};
  \pgfsetstrokecolor{strokecol}
  \definecolor{fillcol}{rgb}{0.94,1.0,1.0};
  \pgfsetfillcolor{fillcol}
  \filldraw (8.0bp,57.0bp) -- (8.0bp,135.0bp) -- (36.0bp,135.0bp) -- (36.0bp,57.0bp) -- cycle;
\end{scope}
\begin{scope}
  \pgfsetstrokecolor{black}
  \definecolor{strokecol}{rgb}{0.0,0.0,0.0};
  \pgfsetstrokecolor{strokecol}
  \definecolor{fillcol}{rgb}{0.94,1.0,1.0};
  \pgfsetfillcolor{fillcol}
  \filldraw (17.0bp,8.0bp) -- (17.0bp,37.0bp) -- (45.0bp,37.0bp) -- (45.0bp,8.0bp) -- cycle;
\end{scope}
...
\end{tikzpicture}
```

With labels, some `\filldraw` line is missing in one of the scope:

```
sage: latex(G_with_labels)
\begin{tikzpicture}[>=latex,line join=bevel,]
%%
\begin{scope}
  \pgfsetstrokecolor{black}
  \definecolor{strokecol}{rgb}{0.0,0.0,0.0};
  \pgfsetstrokecolor{strokecol}
  \definecolor{fillcol}{rgb}{0.94,1.0,1.0};
  \pgfsetfillcolor{fillcol}
\end{scope}
\begin{scope}
  \pgfsetstrokecolor{black}
  \definecolor{strokecol}{rgb}{0.0,0.0,0.0};
  \pgfsetstrokecolor{strokecol}
  \definecolor{fillcol}{rgb}{0.94,1.0,1.0};
  \pgfsetfillcolor{fillcol}
  \filldraw (25.0bp,8.0bp) -- (25.0bp,37.0bp) -- (53.0bp,37.0bp) -- (53.0bp,8.0bp) -- cycle;
\end{scope}
...
\end{tikzpicture}
```



---

archive/issue_comments_322898.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nDo you understand why?",
    "created_at": "2016-12-13T07:45:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322898",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:9" align="right">comment:9</div>

Do you understand why?



---

archive/issue_comments_322899.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nNot yet. My first hypothesis was: it works when the size of the cluster is one. But it turns out to be false when I constructed another example where bigger cluster were drawn. Next thing I want to do is check dot2tex code to see why `\\filldraw` is missing.",
    "created_at": "2016-12-13T09:24:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322899",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:10" align="right">comment:10</div>

Not yet. My first hypothesis was: it works when the size of the cluster is one. But it turns out to be false when I constructed another example where bigger cluster were drawn. Next thing I want to do is check dot2tex code to see why `\filldraw` is missing.



---

archive/issue_comments_322900.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe only place where `\\filldraw` appears in `dot2tex.py` file is inside the method `draw_polygon`. The only place where `draw_polygon` is called is in method `do_draw_op` which does something like:\n\n```\n            if op in ['e', 'E']:\n                s += self.draw_ellipse(drawop, style)\n            elif op in ['p', 'P']:\n                s += self.draw_polygon(drawop, style)\n            elif op == 'L':\n                s += self.draw_polyline(drawop, style)\n            elif op in ['C', 'c']:\n                s += self.set_color(drawop)\n            elif op == 'S':\n                s += self.set_style(drawop)\n            elif op in ['B']:\n                s += self.draw_bezier(drawop, style)\n            elif op in ['T']:\n                ...\n                many lines\n                ...\n                s += self.draw_text(drawop, lblstyle)\n         return s\n```\n\nwith no `else:` clause!! So, I did this change:\n\n```\n$ diff upstream/dot2tex-2.9.0/dot2tex/dot2tex.py local/lib/python2.7/site-packages/dot2tex/dot2tex.py\n607a608,609\n>             else:\n>                 raise ValueError(\"Unknown op(={})\".format(op))\n```\n\nand I get:\n\n```\nsage: _ = latex(G_no_labels)       # no errors\nsage: _ = latex(G_with_labels)\nTraceback (most recent call last):\n...\nValueError: Unknown op(=F)\n```",
    "created_at": "2016-12-13T09:53:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322900",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:11" align="right">comment:11</div>

The only place where `\filldraw` appears in `dot2tex.py` file is inside the method `draw_polygon`. The only place where `draw_polygon` is called is in method `do_draw_op` which does something like:

```
            if op in ['e', 'E']:
                s += self.draw_ellipse(drawop, style)
            elif op in ['p', 'P']:
                s += self.draw_polygon(drawop, style)
            elif op == 'L':
                s += self.draw_polyline(drawop, style)
            elif op in ['C', 'c']:
                s += self.set_color(drawop)
            elif op == 'S':
                s += self.set_style(drawop)
            elif op in ['B']:
                s += self.draw_bezier(drawop, style)
            elif op in ['T']:
                ...
                many lines
                ...
                s += self.draw_text(drawop, lblstyle)
         return s
```

with no `else:` clause!! So, I did this change:

```
$ diff upstream/dot2tex-2.9.0/dot2tex/dot2tex.py local/lib/python2.7/site-packages/dot2tex/dot2tex.py
607a608,609
>             else:
>                 raise ValueError("Unknown op(={})".format(op))
```

and I get:

```
sage: _ = latex(G_no_labels)       # no errors
sage: _ = latex(G_with_labels)
Traceback (most recent call last):
...
ValueError: Unknown op(=F)
```



---

archive/issue_comments_322901.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAnd the fix is not as easy as:\n\n```\n$ diff upstream/dot2tex-2.9.0/dot2tex/dot2tex.py local/lib/python2.7/site-packages/dot2tex/dot2tex.py\n543c543\n<             elif op in ['p', 'P']:\n---\n>             elif op in ['p', 'P', 'F']:\n607a608,609\n>             else:\n>                 raise ValueError(\"Unknown op(={})\".format(op))\n```\n\nbecause\n\n```\nsage: _ = latex(G_with_labels)\n...\n/home/labbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dot2tex.py in do_draw_op(self, drawoperations, drawobj, stat, texlbl_name, use_drawstring_pos)\n    542                 s += self.draw_ellipse(drawop, style)\n    543             elif op in ['p', 'P', 'F']:\n--> 544                 s += self.draw_polygon(drawop, style)\n    545             elif op == 'L':\n    546                 s += self.draw_polyline(drawop, style)\n\n/home/labbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dot2tex.py in draw_polygon(self, drawop, style)\n   1735 \n   1736     def draw_polygon(self, drawop, style=None):\n-> 1737         op, points = drawop\n   1738         pp = ['(%sbp,%sbp)' % (smart_float(p[0]), smart_float(p[1])) for p in points]\n   1739         cmd = \"draw\"\n\nValueError: too many values to unpack\n```",
    "created_at": "2016-12-13T10:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322901",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:12" align="right">comment:12</div>

And the fix is not as easy as:

```
$ diff upstream/dot2tex-2.9.0/dot2tex/dot2tex.py local/lib/python2.7/site-packages/dot2tex/dot2tex.py
543c543
<             elif op in ['p', 'P']:
---
>             elif op in ['p', 'P', 'F']:
607a608,609
>             else:
>                 raise ValueError("Unknown op(={})".format(op))
```

because

```
sage: _ = latex(G_with_labels)
...
/home/labbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dot2tex.py in do_draw_op(self, drawoperations, drawobj, stat, texlbl_name, use_drawstring_pos)
    542                 s += self.draw_ellipse(drawop, style)
    543             elif op in ['p', 'P', 'F']:
--> 544                 s += self.draw_polygon(drawop, style)
    545             elif op == 'L':
    546                 s += self.draw_polyline(drawop, style)

/home/labbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dot2tex.py in draw_polygon(self, drawop, style)
   1735 
   1736     def draw_polygon(self, drawop, style=None):
-> 1737         op, points = drawop
   1738         pp = ['(%sbp,%sbp)' % (smart_float(p[0]), smart_float(p[1])) for p in points]
   1739         cmd = "draw"

ValueError: too many values to unpack
```



---

archive/issue_events_304528.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-12-15T14:43:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304528"
}
```



---

archive/issue_events_304529.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2016-12-15T14:43:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304529"
}
```



---

archive/issue_comments_322902.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn summary, the bug reported by the reviewer when `edge_labels=True` really belongs to `dot2tex`. The method `graphviz_string` that is enhanced in this ticket works correctly as confirmed by running `dot` on the `dot` string output by `graphviz_string` (see [comment 7](#comment%3A7)). Therefore, if David you agree, I suggest to open another ticket to deal with that missing `\\filldraw` line and continue the review of this ticket independently of that `dot2tex` bug.",
    "created_at": "2016-12-15T14:43:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322902",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:13" align="right">comment:13</div>

In summary, the bug reported by the reviewer when `edge_labels=True` really belongs to `dot2tex`. The method `graphviz_string` that is enhanced in this ticket works correctly as confirmed by running `dot` on the `dot` string output by `graphviz_string` (see [comment 7](#comment%3A7)). Therefore, if David you agree, I suggest to open another ticket to deal with that missing `\filldraw` line and continue the review of this ticket independently of that `dot2tex` bug.



---

archive/issue_comments_322903.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI agree with you to open an independent ticket to fix the dot2tex issue.\n\nFor me this patch is good to go.",
    "created_at": "2016-12-15T22:11:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322903",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:14" align="right">comment:14</div>

I agree with you to open an independent ticket to fix the dot2tex issue.

For me this patch is good to go.



---

archive/issue_comments_322904.json:
```json
{
    "body": "Reviewer: **David Coudert**",
    "created_at": "2016-12-15T22:11:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322904",
    "user": "https://github.com/dcoudert"
}
```

Reviewer: **David Coudert**



---

archive/issue_events_304530.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2016-12-15T22:11:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304530"
}
```



---

archive/issue_events_304531.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2016-12-15T22:11:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304531"
}
```



---

archive/issue_comments_322905.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI created #22070 for the dot2tex issue.",
    "created_at": "2016-12-16T14:56:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322905",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:16" align="right">comment:16</div>

I created #22070 for the dot2tex issue.



---

archive/issue_events_304532.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-01-18T20:39:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304532"
}
```



---

archive/issue_events_304533.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a8fb1f841cd916d456921f8fc5a85539c3486f16",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-01-18T20:39:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21918#event-304533"
}
```



---

archive/issue_comments_322906.json:
```json
{
    "body": "Changed branch from **[u/slabbe/21918](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/21918)** to **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**",
    "created_at": "2017-01-18T20:39:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21918#issuecomment-322906",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/slabbe/21918](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/21918)** to **[`9bba185`](https://github.com/sagemath/sagetrac-mirror/commit/9bba1854eb533ae36caa3aac715dd5dd5cf7e2d5)**
