# Issue 21092: Unhandled case in EllipticCurve_from_cubic

archive/issues_020855.json:
```json
{
    "body": "I ran into an unexpected error in `EllipticCurve_from_cubic`, with the following cubic and rational point:\n\n```\nsage: R.<x,y,z> = QQ[]\nsage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\nsage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5))\n```\n\nNote that it works as expected using instead the different rational point (1, 1, 0).\n\nOn investigation, I found there is a case that isn\u2019t handled correctly. The code computes\n\n```\nP2 = chord_and_tangent(F, P)\n```\nand if P2 is projectively equivalent to P then it uses a different algorithm. If they\u2019re different, it then computes\n\n```\nP3 = chord_and_tangent(F, P2)\n```\nand uses an algorithm that fails if P3 is equivalent to P2.\n\nI think the attached patch fixes this problem. At least, with this patch it now works for my examples.\n\nBest wishes,\nRobin\n\n---\n\n```diff\n\ndiff --git a/src/sage/schemes/elliptic_curves/constructor.py b/src/sage/schemes/elliptic_curves/constructor.py\nindex ec2d59c..d28dda3 100644\n--- a/src/sage/schemes/elliptic_curves/constructor.py\n+++ b/src/sage/schemes/elliptic_curves/constructor.py\n@@ -873,6 +873,16 @@ def EllipticCurve_from_cubic(F, P, morphism=True):\n         sage: cubic = x^2*y + 4*x*y^2 + x^2*z + 8*x*y*z + 4*y^2*z + 9*x*z^2 + 9*y*z^2\n         sage: EllipticCurve_from_cubic(cubic, [1,-1,1], morphism=False)\n         Elliptic Curve defined by y^2 - 882*x*y - 2560000*y = x^3 - 127281*x^2 over Rational Field\n+\n+        sage: R.<x,y,z> = QQ[]\n+        sage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\n+        sage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )\n+        Scheme morphism:\n+          From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:\n+          -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\n+          To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field\n+          Defn: Defined on coordinates by sending (x : y : z) to\n+                (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)\n     \"\"\"\n     import sage.matrix.all as matrix\n \n@@ -895,9 +905,18 @@ def EllipticCurve_from_cubic(F, P, morphism=True):\n         raise TypeError('%s is not a projective point'%P)\n     x, y, z = R.gens()\n \n-    # First case: if P = P2 then P is a flex\n+    # First case: if P = P2 then P is a flex, or if P2 = P3 then P2 is a flex\n     P2 = chord_and_tangent(F, P)\n+    flex_point = None\n     if are_projectively_equivalent(P, P2, base_ring=K):\n+        flex_point = P\n+    else:\n+        P3 = chord_and_tangent(F, P2)\n+        if are_projectively_equivalent(P2, P3, base_ring=K):\n+            flex_point = P2\n+\n+    if flex_point is not None:\n+        P = flex_point\n         # find the tangent to F in P\n         dx = K(F.derivative(x)(P))\n         dy = K(F.derivative(y)(P))\n@@ -934,9 +953,8 @@ def EllipticCurve_from_cubic(F, P, morphism=True):\n         fwd_defining_poly = [trans_x, trans_y, -b*trans_z]\n         fwd_post = -a\n \n-    # Second case: P is not a flex, then P, P2, P3 are different\n+    # Second case: P, P2, P3 are different\n     else:\n-        P3 = chord_and_tangent(F, P2)\n         # send P, P2, P3 to (1:0:0), (0:1:0), (0:0:1) respectively\n         M = matrix.matrix(K, [P, P2, P3]).transpose()\n         F2 = M.act_on_polynomial(F)\n```\n\nCC:  @JohnCremona @nexttime\n\nBranch/Commit: bd39a1ff082cb5f0ceb2f9a93f736434e24597ab\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Robin Houston, John Cremona\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21092\n\n",
    "closed_at": "2018-02-01T19:13:31Z",
    "created_at": "2016-07-25T15:43:24Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Unhandled case in EllipticCurve_from_cubic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21092",
    "user": "https://github.com/jdemeyer"
}
```
I ran into an unexpected error in `EllipticCurve_from_cubic`, with the following cubic and rational point:

```
sage: R.<x,y,z> = QQ[]
sage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
sage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5))
```

Note that it works as expected using instead the different rational point (1, 1, 0).

On investigation, I found there is a case that isn’t handled correctly. The code computes

```
P2 = chord_and_tangent(F, P)
```
and if P2 is projectively equivalent to P then it uses a different algorithm. If they’re different, it then computes

```
P3 = chord_and_tangent(F, P2)
```
and uses an algorithm that fails if P3 is equivalent to P2.

I think the attached patch fixes this problem. At least, with this patch it now works for my examples.

Best wishes,
Robin

---

```diff

diff --git a/src/sage/schemes/elliptic_curves/constructor.py b/src/sage/schemes/elliptic_curves/constructor.py
index ec2d59c..d28dda3 100644
--- a/src/sage/schemes/elliptic_curves/constructor.py
+++ b/src/sage/schemes/elliptic_curves/constructor.py
@@ -873,6 +873,16 @@ def EllipticCurve_from_cubic(F, P, morphism=True):
         sage: cubic = x^2*y + 4*x*y^2 + x^2*z + 8*x*y*z + 4*y^2*z + 9*x*z^2 + 9*y*z^2
         sage: EllipticCurve_from_cubic(cubic, [1,-1,1], morphism=False)
         Elliptic Curve defined by y^2 - 882*x*y - 2560000*y = x^3 - 127281*x^2 over Rational Field
+
+        sage: R.<x,y,z> = QQ[]
+        sage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
+        sage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )
+        Scheme morphism:
+          From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
+          -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
+          To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field
+          Defn: Defined on coordinates by sending (x : y : z) to
+                (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
     """
     import sage.matrix.all as matrix
 
@@ -895,9 +905,18 @@ def EllipticCurve_from_cubic(F, P, morphism=True):
         raise TypeError('%s is not a projective point'%P)
     x, y, z = R.gens()
 
-    # First case: if P = P2 then P is a flex
+    # First case: if P = P2 then P is a flex, or if P2 = P3 then P2 is a flex
     P2 = chord_and_tangent(F, P)
+    flex_point = None
     if are_projectively_equivalent(P, P2, base_ring=K):
+        flex_point = P
+    else:
+        P3 = chord_and_tangent(F, P2)
+        if are_projectively_equivalent(P2, P3, base_ring=K):
+            flex_point = P2
+
+    if flex_point is not None:
+        P = flex_point
         # find the tangent to F in P
         dx = K(F.derivative(x)(P))
         dy = K(F.derivative(y)(P))
@@ -934,9 +953,8 @@ def EllipticCurve_from_cubic(F, P, morphism=True):
         fwd_defining_poly = [trans_x, trans_y, -b*trans_z]
         fwd_post = -a
 
-    # Second case: P is not a flex, then P, P2, P3 are different
+    # Second case: P, P2, P3 are different
     else:
-        P3 = chord_and_tangent(F, P2)
         # send P, P2, P3 to (1:0:0), (0:1:0), (0:0:1) respectively
         M = matrix.matrix(K, [P, P2, P3]).transpose()
         F2 = M.act_on_polynomial(F)
```

CC:  @JohnCremona @nexttime

Branch/Commit: bd39a1ff082cb5f0ceb2f9a93f736434e24597ab

Reviewer: Frédéric Chapoton

Author: Robin Houston, John Cremona

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21092





---

archive/issue_comments_386086.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-26T07:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386086",
    "user": "https://github.com/slel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386087.json:
```json
{
    "body": "<a id='comment:1'></a>\nDuplicate of #21093.",
    "created_at": "2016-07-26T07:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386087",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>
Duplicate of #21093.



---

archive/issue_events_056318.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2016-07-26T07:03:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56318"
}
```



---

archive/issue_events_056319.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-26T07:38:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56319"
}
```



---

archive/issue_events_056320.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-26T07:38:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56320"
}
```



---

archive/issue_comments_386088.json:
```json
{
    "body": "Changing author from \"\" to \"Robin Houston\"",
    "created_at": "2016-07-26T07:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386088",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Robin Houston"



---

archive/issue_comments_386089.json:
```json
{
    "body": "Changing branch from \"\" to \"u/slelievre/unhandled_case_in_ellipticcurve_from_cubic\"",
    "created_at": "2016-07-27T08:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386089",
    "user": "https://github.com/slel"
}
```

Changing branch from "" to "u/slelievre/unhandled_case_in_ellipticcurve_from_cubic"



---

archive/issue_comments_386090.json:
```json
{
    "body": "<a id='comment:5'></a>\nI applied the patch from #21093. Any reason to set the milestone to sage-7.4 rather than sage-7.3?\n\n---\nNew commits:\n|                                                                                                                                          |                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[507d312](https://git.sagemath.org/sage.git/commit?id=507d31230e79b0cc0bf849818fb9a99981333644)|`#21092 Unhandled case in EllipticCurve_from_cubic`|",
    "created_at": "2016-07-27T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386090",
    "user": "https://github.com/slel"
}
```

<a id='comment:5'></a>
I applied the patch from #21093. Any reason to set the milestone to sage-7.4 rather than sage-7.3?

---
New commits:
|                                                                                                                                          |                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[507d312](https://git.sagemath.org/sage.git/commit?id=507d31230e79b0cc0bf849818fb9a99981333644)|`#21092 Unhandled case in EllipticCurve_from_cubic`|



---

archive/issue_comments_386091.json:
```json
{
    "body": "Changing commit from \"\" to \"507d31230e79b0cc0bf849818fb9a99981333644\"",
    "created_at": "2016-07-27T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386091",
    "user": "https://github.com/slel"
}
```

Changing commit from "" to "507d31230e79b0cc0bf849818fb9a99981333644"



---

archive/issue_comments_386092.json:
```json
{
    "body": "<a id='comment:6'></a>\nTesting the patched src/sage/schemes/elliptic_curves/constructor.py fails for me:\n\n```\nsage -t --long --warn-long 59.7 src/sage/schemes/elliptic_curves/constructor.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/constructor.py\", line 880, in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic\nFailed example:\n    EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )\nExpected:\n    Scheme morphism:\n      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:\n      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\n      To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field\n      Defn: Defined on coordinates by sending (x : y : z) to\n            (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)\nGot:\n    Scheme morphism:\n      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:\n      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\n      To:   Elliptic Curve defined by y^2 - 6*x*y - 112*y = x^3 + 62*x^2 + 560*x over Rational Field\n      Defn: Defined on coordinates by sending (x : y : z) to\n            (1/3*z : -y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)\n**********************************************************************\n1 item had failures:\n   1 of  36 in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic\n    [185 tests, 1 failure, 81.44 s]\n```\n\nIs there some randomness involved?\n\nAlso, when this works, it would be worth adding a reference to \"`:trac:`21092``\".",
    "created_at": "2016-07-27T11:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386092",
    "user": "https://github.com/slel"
}
```

<a id='comment:6'></a>
Testing the patched src/sage/schemes/elliptic_curves/constructor.py fails for me:

```
sage -t --long --warn-long 59.7 src/sage/schemes/elliptic_curves/constructor.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/constructor.py", line 880, in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic
Failed example:
    EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )
Expected:
    Scheme morphism:
      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
      To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field
      Defn: Defined on coordinates by sending (x : y : z) to
            (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
Got:
    Scheme morphism:
      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
      To:   Elliptic Curve defined by y^2 - 6*x*y - 112*y = x^3 + 62*x^2 + 560*x over Rational Field
      Defn: Defined on coordinates by sending (x : y : z) to
            (1/3*z : -y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
**********************************************************************
1 item had failures:
   1 of  36 in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic
    [185 tests, 1 failure, 81.44 s]
```

Is there some randomness involved?

Also, when this works, it would be worth adding a reference to "`:trac:`21092``".



---

archive/issue_comments_386093.json:
```json
{
    "body": "Changing branch from \"u/slelievre/unhandled_case_in_ellipticcurve_from_cubic\" to \"public/21092\"",
    "created_at": "2016-07-28T07:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386093",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "u/slelievre/unhandled_case_in_ellipticcurve_from_cubic" to "public/21092"



---

archive/issue_comments_386094.json:
```json
{
    "body": "<a id='comment:7'></a>\nI have changed the result of the failing doctest. Hopefully this is correct.\n\nI have also added the required link to trac.\n\n---\nNew commits:\n|                                                                                                                                          |                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|\n|[df73f43](https://git.sagemath.org/sage.git/commit?id=df73f437cb2e5e5c7efa0bc53d3fd66569e18565)|`trac 21092 correct failing doctest, plus link to trac ticket`|",
    "created_at": "2016-07-28T07:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386094",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
I have changed the result of the failing doctest. Hopefully this is correct.

I have also added the required link to trac.

---
New commits:
|                                                                                                                                          |                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|
|[df73f43](https://git.sagemath.org/sage.git/commit?id=df73f437cb2e5e5c7efa0bc53d3fd66569e18565)|`trac 21092 correct failing doctest, plus link to trac ticket`|



---

archive/issue_comments_386095.json:
```json
{
    "body": "Changing commit from \"507d31230e79b0cc0bf849818fb9a99981333644\" to \"df73f437cb2e5e5c7efa0bc53d3fd66569e18565\"",
    "created_at": "2016-07-28T07:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386095",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "507d31230e79b0cc0bf849818fb9a99981333644" to "df73f437cb2e5e5c7efa0bc53d3fd66569e18565"



---

archive/issue_comments_386096.json:
```json
{
    "body": "<a id='comment:8'></a>\nI am looking at this (better late than never).  In the docstring there is a remark that when the supplied point is not a flex then the map returned is a \"birational equivalence\", and only for a flex is it an isomorphism.  This is incorrect: in both cases it is a birational isomorphism, but in the case where the point is a flex it is a linear isomorphism.  Otherwise it is a quadratic map -- but still an isomorphism of curves.",
    "created_at": "2017-11-18T18:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386096",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>
I am looking at this (better late than never).  In the docstring there is a remark that when the supplied point is not a flex then the map returned is a "birational equivalence", and only for a flex is it an isomorphism.  This is incorrect: in both cases it is a birational isomorphism, but in the case where the point is a flex it is a linear isomorphism.  Otherwise it is a quadratic map -- but still an isomorphism of curves.



---

archive/issue_comments_386097.json:
```json
{
    "body": "<a id='comment:9'></a>\nWhile waiting for the branch to build I am looking at the code more.  (I am happy that the patch fixes the bug but...)\n\nIt is easy to find any rational flexes (there are 0, 1 or 3):\n\n```\nC = Curve(cubic)\nhessian_pol = Matrix([[cubic.derivative(v1, v2) for v1 in R.gens()] for v2 in R.gens()]).det()\nH = Curve(hessian_pol)\nflexes = C.intersection(H).rational_points()\n```\nand simpler code would (1) test if P is a flex (iff it is on the Hessian), use it if so; else (2) look for any rational flexes and use one instead if they exist; else (3) use the generic case of what is here already.\n\nSomething else about the documentation:  assuming that C is smooth, its Jacobian J is an elliptic curve whether or not C has a rational point, and (as already observed) the Jacobian can be constructed using a different function.  But of course unless C has a rational point, C and J cannot be isomorphic.  The Jacobian() function seems to do everything one would want here:\n\n```\nsage: Jacobian(cubic, curve=Curve(cubic))\n\nScheme morphism:\n  From: Projective Plane Curve over Rational Field defined by -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3\n  To:   Elliptic Curve defined by y^2 = x^3 - 2353/3*x + 227950/27 over Rational Field\n  Defn: Defined on coordinates by sending (x : y : z) to\n...\n```\nand the only point about supplying a point on the original cubic is that you then know that this map is an isomorphism.",
    "created_at": "2017-11-18T18:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386097",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
While waiting for the branch to build I am looking at the code more.  (I am happy that the patch fixes the bug but...)

It is easy to find any rational flexes (there are 0, 1 or 3):

```
C = Curve(cubic)
hessian_pol = Matrix([[cubic.derivative(v1, v2) for v1 in R.gens()] for v2 in R.gens()]).det()
H = Curve(hessian_pol)
flexes = C.intersection(H).rational_points()
```
and simpler code would (1) test if P is a flex (iff it is on the Hessian), use it if so; else (2) look for any rational flexes and use one instead if they exist; else (3) use the generic case of what is here already.

Something else about the documentation:  assuming that C is smooth, its Jacobian J is an elliptic curve whether or not C has a rational point, and (as already observed) the Jacobian can be constructed using a different function.  But of course unless C has a rational point, C and J cannot be isomorphic.  The Jacobian() function seems to do everything one would want here:

```
sage: Jacobian(cubic, curve=Curve(cubic))

Scheme morphism:
  From: Projective Plane Curve over Rational Field defined by -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
  To:   Elliptic Curve defined by y^2 = x^3 - 2353/3*x + 227950/27 over Rational Field
  Defn: Defined on coordinates by sending (x : y : z) to
...
```
and the only point about supplying a point on the original cubic is that you then know that this map is an isomorphism.



---

archive/issue_comments_386098.json:
```json
{
    "body": "<a id='comment:10'></a>\nI built the branch in order to test it, and was planning to edit the docstrings a little.  But even though \"make build\" completed successfully, running Sage crashed.  Now \"make build\" also crashes after trying to build a package called iml.\n\nThis is ridiculous.  Reviewing patches never used to be quite this bad, but it is hardly surprising that there are 182 tickets waiting review.  Must I really 'make dist-clean' every time now?\n\nPS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.",
    "created_at": "2017-11-19T15:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386098",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>
I built the branch in order to test it, and was planning to edit the docstrings a little.  But even though "make build" completed successfully, running Sage crashed.  Now "make build" also crashes after trying to build a package called iml.

This is ridiculous.  Reviewing patches never used to be quite this bad, but it is hardly surprising that there are 182 tickets waiting review.  Must I really 'make dist-clean' every time now?

PS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.



---

archive/issue_comments_386099.json:
```json
{
    "body": "<a id='comment:11'></a>\nI'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.",
    "created_at": "2017-11-23T16:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386099",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:11'></a>
I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.



---

archive/issue_comments_386100.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [cremona](#comment%3A11):\n> I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.\n\n\nSorry to hear that. I have no idea what you are doing wrong. That never happens to me.\n\nEither you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.\n\nIf you want, you can report such issues. Maybe we can try to see what the problem is.",
    "created_at": "2017-11-23T17:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386100",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [cremona](#comment%3A11):
> I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.


Sorry to hear that. I have no idea what you are doing wrong. That never happens to me.

Either you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.

If you want, you can report such issues. Maybe we can try to see what the problem is.



---

archive/issue_comments_386101.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [cremona](#comment%3A10):\n> PS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.\n\n\nWell, that depends on which you are. If the change of branch caused a change in MPIR version number, obviously MPIR will be rebuilt.",
    "created_at": "2017-11-23T17:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386101",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [cremona](#comment%3A10):
> PS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.


Well, that depends on which you are. If the change of branch caused a change in MPIR version number, obviously MPIR will be rebuilt.



---

archive/issue_comments_386102.json:
```json
{
    "body": "<a id='comment:14'></a>\nYou are right of course that switching branches can cause dependencies to be rebuilt.  I just merged develop into this branch and am building with that.  Assuming all goes OK I'll make any additional changes to that and upload it here.  I should perhaps trash this sage clone and start a new one on this machine but I have about 8 branches in there which don't get listed with \"git branch --merged\" so I would have to spend some time working out if there is anything in there I would want to keep.",
    "created_at": "2017-11-23T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386102",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>
You are right of course that switching branches can cause dependencies to be rebuilt.  I just merged develop into this branch and am building with that.  Assuming all goes OK I'll make any additional changes to that and upload it here.  I should perhaps trash this sage clone and start a new one on this machine but I have about 8 branches in there which don't get listed with "git branch --merged" so I would have to spend some time working out if there is anything in there I would want to keep.



---

archive/issue_comments_386103.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jdemeyer](#comment%3A12):\n> Replying to [cremona](#comment%3A11):\n> > I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.\n\n> \n> Sorry to hear that. I have no idea what you are doing wrong. That never happens to me.\n> \n> Either you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.\n> \n> If you want, you can report such issues. Maybe we can try to see what the problem is.\n\n\nIt would be hard to give a proper reproducible bug report.  From what I remember, I started with a current develop branch in which \"make build\" runs fine, then checked out the public/21092 branch on this ticket and did \"make build\" again but that failed, and when I then checked out the develop branch again \"make build\" failed once again.  I don't think that should happen, but I am quite capable of having done something different in between which would invalidate the report.",
    "created_at": "2017-11-23T19:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386103",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>
Replying to [jdemeyer](#comment%3A12):
> Replying to [cremona](#comment%3A11):
> > I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.

> 
> Sorry to hear that. I have no idea what you are doing wrong. That never happens to me.
> 
> Either you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.
> 
> If you want, you can report such issues. Maybe we can try to see what the problem is.


It would be hard to give a proper reproducible bug report.  From what I remember, I started with a current develop branch in which "make build" runs fine, then checked out the public/21092 branch on this ticket and did "make build" again but that failed, and when I then checked out the develop branch again "make build" failed once again.  I don't think that should happen, but I am quite capable of having done something different in between which would invalidate the report.



---

archive/issue_comments_386104.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [cremona](#comment%3A15):\n> when I then checked out the develop branch again \"make build\" failed once again.\n\n\nThat is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.",
    "created_at": "2017-11-24T09:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386104",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [cremona](#comment%3A15):
> when I then checked out the develop branch again "make build" failed once again.


That is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.



---

archive/issue_comments_386105.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A16):\n> Replying to [cremona](#comment%3A15):\n> > when I then checked out the develop branch again \"make build\" failed once again.\n\n> \n> That is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.\n\n\nThat's what I thought.  It might be relevant that this is the same machien where I was trying to install jupyter, jupyter-hub via anaconda and all that, without having much of an idea of what I was doing (the documentation for all that is really bad).\n\nAnyway \"make distclean; make build\" ran overnight OK and so I do now have a working branch with 8.1.rc2 + the patch from this ticket.",
    "created_at": "2017-11-24T09:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386105",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A16):
> Replying to [cremona](#comment%3A15):
> > when I then checked out the develop branch again "make build" failed once again.

> 
> That is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.


That's what I thought.  It might be relevant that this is the same machien where I was trying to install jupyter, jupyter-hub via anaconda and all that, without having much of an idea of what I was doing (the documentation for all that is really bad).

Anyway "make distclean; make build" ran overnight OK and so I do now have a working branch with 8.1.rc2 + the patch from this ticket.



---

archive/issue_comments_386106.json:
```json
{
    "body": "Changing commit from \"df73f437cb2e5e5c7efa0bc53d3fd66569e18565\" to \"52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54\"",
    "created_at": "2018-01-23T14:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386106",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "df73f437cb2e5e5c7efa0bc53d3fd66569e18565" to "52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54"



---

archive/issue_comments_386107.json:
```json
{
    "body": "<a id='comment:18'></a>\nready for another tentative, John ?\n\n---\nNew commits:\n|                                                                                                                                          |                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[52ddbf9](https://git.sagemath.org/sage.git/commit?id=52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54)|`21092 Unhandled case in EllipticCurve_from_cubic`|",
    "created_at": "2018-01-23T14:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386107",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>
ready for another tentative, John ?

---
New commits:
|                                                                                                                                          |                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[52ddbf9](https://git.sagemath.org/sage.git/commit?id=52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54)|`21092 Unhandled case in EllipticCurve_from_cubic`|



---

archive/issue_comments_386108.json:
```json
{
    "body": "Changing branch from \"public/21092\" to \"public/ticket/21092\"",
    "created_at": "2018-01-23T14:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386108",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "public/21092" to "public/ticket/21092"



---

archive/issue_events_056321.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-23T14:51:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56321"
}
```



---

archive/issue_events_056322.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-01-23T14:51:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56322"
}
```



---

archive/issue_comments_386109.json:
```json
{
    "body": "<a id='comment:20'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------|\n|[4a6e589](https://git.sagemath.org/sage.git/commit/?id=4a6e589acfaae3c31245fc866356982db33f420a)|`21092 better ?`|",
    "created_at": "2018-01-23T14:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386109",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------|
|[4a6e589](https://git.sagemath.org/sage.git/commit/?id=4a6e589acfaae3c31245fc866356982db33f420a)|`21092 better ?`|



---

archive/issue_comments_386110.json:
```json
{
    "body": "Changing commit from \"52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54\" to \"4a6e589acfaae3c31245fc866356982db33f420a\"",
    "created_at": "2018-01-23T14:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "52ddbf9ef5252a0d8c4729d23b94d3b1a58fee54" to "4a6e589acfaae3c31245fc866356982db33f420a"



---

archive/issue_comments_386111.json:
```json
{
    "body": "Changing commit from \"4a6e589acfaae3c31245fc866356982db33f420a\" to \"2c6f7d5cca8039363968cb286583e0095607a1c4\"",
    "created_at": "2018-01-23T14:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386111",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4a6e589acfaae3c31245fc866356982db33f420a" to "2c6f7d5cca8039363968cb286583e0095607a1c4"



---

archive/issue_comments_386112.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[2c6f7d5](https://git.sagemath.org/sage.git/commit/?id=2c6f7d5cca8039363968cb286583e0095607a1c4)|`trac 21092 details of doc`|",
    "created_at": "2018-01-23T14:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386112",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[2c6f7d5](https://git.sagemath.org/sage.git/commit/?id=2c6f7d5cca8039363968cb286583e0095607a1c4)|`trac 21092 details of doc`|



---

archive/issue_comments_386113.json:
```json
{
    "body": "<a id='comment:22'></a>\nI'll take another look.  Last time I did I started completely rewriting the function, but of course did not finish....however I have an unpushed commit on my branch for this called \"work in progress\" dated 2 Dec so I'll have to remind myself what that was about too.",
    "created_at": "2018-01-23T15:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386113",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:22'></a>
I'll take another look.  Last time I did I started completely rewriting the function, but of course did not finish....however I have an unpushed commit on my branch for this called "work in progress" dated 2 Dec so I'll have to remind myself what that was about too.



---

archive/issue_comments_386114.json:
```json
{
    "body": "<a id='comment:23'></a>\nOK, I am doing some more rewriting of this, having found at least one bug (in the line \"for tangent in ...\" the last entry in the last triple should be dy) which might take years before it was hit.",
    "created_at": "2018-01-23T16:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386114",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:23'></a>
OK, I am doing some more rewriting of this, having found at least one bug (in the line "for tangent in ..." the last entry in the last triple should be dy) which might take years before it was hit.



---

archive/issue_comments_386115.json:
```json
{
    "body": "<a id='comment:24'></a>\nI am about to upload a major rewrite of this, with code which (I think) is much clearer, and more examples.  I also rewrote the helper function chord_and_tangent though I no longer use it (and it is misnamed).  I spotted (actually pyflakes did) that there is a call to a non-existent function coefficients_from_cubic elsewhere in the file constructor.py.\n\nSince the code is a different implementation of the same basic algorithm, in quite a few examples the output is different, though on balance I think the equations are simpler.  All the examples are over Q (which is not good) where it is very tempting to compose with the map to the global minimal model, but I have not done that.\n\nI did one possibly controversial thing: it is much easier when there is a rational flex since then there is a linear isomorphism with a Weierstrass cubic, and the new code uses a rational flex when one exists even if the given point is not a flex.  I think this is preferable to using the more complicated code and returning a quadratic map when a linea map is possible.  But I could change that (or make it optional).",
    "created_at": "2018-01-25T17:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386115",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>
I am about to upload a major rewrite of this, with code which (I think) is much clearer, and more examples.  I also rewrote the helper function chord_and_tangent though I no longer use it (and it is misnamed).  I spotted (actually pyflakes did) that there is a call to a non-existent function coefficients_from_cubic elsewhere in the file constructor.py.

Since the code is a different implementation of the same basic algorithm, in quite a few examples the output is different, though on balance I think the equations are simpler.  All the examples are over Q (which is not good) where it is very tempting to compose with the map to the global minimal model, but I have not done that.

I did one possibly controversial thing: it is much easier when there is a rational flex since then there is a linear isomorphism with a Weierstrass cubic, and the new code uses a rational flex when one exists even if the given point is not a flex.  I think this is preferable to using the more complicated code and returning a quadratic map when a linea map is possible.  But I could change that (or make it optional).



---

archive/issue_comments_386116.json:
```json
{
    "body": "Changing branch from \"public/ticket/21092\" to \"u/cremona/21092\"",
    "created_at": "2018-01-25T18:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386116",
    "user": "https://github.com/JohnCremona"
}
```

Changing branch from "public/ticket/21092" to "u/cremona/21092"



---

archive/issue_comments_386117.json:
```json
{
    "body": "<a id='comment:25'></a>\nI am pushing my branch to u/cremona/21092, leaving the previous version at public/ticket/21092.\n\n---\nNew commits:\n|                                                                                                                                          |                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[507d312](https://git.sagemath.org/sage.git/commit?id=507d31230e79b0cc0bf849818fb9a99981333644)|`#21092 Unhandled case in EllipticCurve_from_cubic`|\n|[df73f43](https://git.sagemath.org/sage.git/commit?id=df73f437cb2e5e5c7efa0bc53d3fd66569e18565)|`trac 21092 correct failing doctest, plus link to trac ticket`|\n|[c030058](https://git.sagemath.org/sage.git/commit?id=c030058787aca5f5c7e10f9ce924e19a5be2085c)|`Merge branch 'develop' into 21092`|\n|[f758180](https://git.sagemath.org/sage.git/commit?id=f75818036ed31474d76a0d0f60637dc037b87f79)|`#21092 work in progress`|\n|[b54119a](https://git.sagemath.org/sage.git/commit?id=b54119adede31e33e987987371ee02973fb40388)|`Merge branch 'develop' into 21092`|\n|[d36d0fd](https://git.sagemath.org/sage.git/commit?id=d36d0fd74e1723dd9f256ddcdb8632e977dd5084)|`Merge remote-tracking branch 'trac/public/ticket/21092' into 21092`|",
    "created_at": "2018-01-25T18:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386117",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:25'></a>
I am pushing my branch to u/cremona/21092, leaving the previous version at public/ticket/21092.

---
New commits:
|                                                                                                                                          |                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[507d312](https://git.sagemath.org/sage.git/commit?id=507d31230e79b0cc0bf849818fb9a99981333644)|`#21092 Unhandled case in EllipticCurve_from_cubic`|
|[df73f43](https://git.sagemath.org/sage.git/commit?id=df73f437cb2e5e5c7efa0bc53d3fd66569e18565)|`trac 21092 correct failing doctest, plus link to trac ticket`|
|[c030058](https://git.sagemath.org/sage.git/commit?id=c030058787aca5f5c7e10f9ce924e19a5be2085c)|`Merge branch 'develop' into 21092`|
|[f758180](https://git.sagemath.org/sage.git/commit?id=f75818036ed31474d76a0d0f60637dc037b87f79)|`#21092 work in progress`|
|[b54119a](https://git.sagemath.org/sage.git/commit?id=b54119adede31e33e987987371ee02973fb40388)|`Merge branch 'develop' into 21092`|
|[d36d0fd](https://git.sagemath.org/sage.git/commit?id=d36d0fd74e1723dd9f256ddcdb8632e977dd5084)|`Merge remote-tracking branch 'trac/public/ticket/21092' into 21092`|



---

archive/issue_comments_386118.json:
```json
{
    "body": "Changing commit from \"2c6f7d5cca8039363968cb286583e0095607a1c4\" to \"d36d0fd74e1723dd9f256ddcdb8632e977dd5084\"",
    "created_at": "2018-01-25T18:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386118",
    "user": "https://github.com/JohnCremona"
}
```

Changing commit from "2c6f7d5cca8039363968cb286583e0095607a1c4" to "d36d0fd74e1723dd9f256ddcdb8632e977dd5084"



---

archive/issue_comments_386119.json:
```json
{
    "body": "Changing author from \"Robin Houston\" to \"Robin Houston, John Cremona\"",
    "created_at": "2018-01-25T18:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386119",
    "user": "https://github.com/JohnCremona"
}
```

Changing author from "Robin Houston" to "Robin Houston, John Cremona"



---

archive/issue_comments_386120.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[e30fb3d](https://git.sagemath.org/sage.git/commit/?id=e30fb3d02298bf032e2980485cba15cdd8441800)|`#21092: rewrite of plane cubic to Weierstrass`|",
    "created_at": "2018-01-25T18:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[e30fb3d](https://git.sagemath.org/sage.git/commit/?id=e30fb3d02298bf032e2980485cba15cdd8441800)|`#21092: rewrite of plane cubic to Weierstrass`|



---

archive/issue_comments_386121.json:
```json
{
    "body": "Changing commit from \"d36d0fd74e1723dd9f256ddcdb8632e977dd5084\" to \"e30fb3d02298bf032e2980485cba15cdd8441800\"",
    "created_at": "2018-01-25T18:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386121",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d36d0fd74e1723dd9f256ddcdb8632e977dd5084" to "e30fb3d02298bf032e2980485cba15cdd8441800"



---

archive/issue_comments_386122.json:
```json
{
    "body": "<a id='comment:27'></a>\nI just noticed that the docstring now promises that it's OK to give P=None if the curve has a rational flex, since it is easy to find these and use one -- but forgot to implement that.  I'll leave is Needs Review anyway but will update the branch with this (and examples) tomorrow.",
    "created_at": "2018-01-25T18:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386122",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:27'></a>
I just noticed that the docstring now promises that it's OK to give P=None if the curve has a rational flex, since it is easy to find these and use one -- but forgot to implement that.  I'll leave is Needs Review anyway but will update the branch with this (and examples) tomorrow.



---

archive/issue_comments_386123.json:
```json
{
    "body": "Changing commit from \"e30fb3d02298bf032e2980485cba15cdd8441800\" to \"84483fe5a41f3465f25ab7461bafb7929df7a8cc\"",
    "created_at": "2018-01-25T19:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386123",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e30fb3d02298bf032e2980485cba15cdd8441800" to "84483fe5a41f3465f25ab7461bafb7929df7a8cc"



---

archive/issue_comments_386124.json:
```json
{
    "body": "<a id='comment:28'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------|\n|[84483fe](https://git.sagemath.org/sage.git/commit/?id=84483fe5a41f3465f25ab7461bafb7929df7a8cc)|`#21092: added support for giving no point when there is a rational flex`|",
    "created_at": "2018-01-25T19:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386124",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------|
|[84483fe](https://git.sagemath.org/sage.git/commit/?id=84483fe5a41f3465f25ab7461bafb7929df7a8cc)|`#21092: added support for giving no point when there is a rational flex`|



---

archive/issue_comments_386125.json:
```json
{
    "body": "<a id='comment:29'></a>\nFirst review pass:\n\nplease use `.. NOTE::` in capital\n\nmaybe say somewhere that the given point may be ignored if the curve has a rational flex ?\n\ntypo `returned cannor be evaluated`\n\ntypo `anf the inverse morphism`\n\ntypo `will beused as a base`\n\ntypo `if not point is given and there are not rational` where not should be no (twice)\n\nIn chord_and_tangent, the new doc line is too long (should break at 80 chars)\n\nIn chord_and_tangent, I am concerned that the use of rational points may restrict the use of this function to the field QQ.\n\nEverywhere, we need at least one example over QQ[sqrt(5)] for instance. And if possible one over QQ(t) ?",
    "created_at": "2018-01-27T07:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386125",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>
First review pass:

please use `.. NOTE::` in capital

maybe say somewhere that the given point may be ignored if the curve has a rational flex ?

typo `returned cannor be evaluated`

typo `anf the inverse morphism`

typo `will beused as a base`

typo `if not point is given and there are not rational` where not should be no (twice)

In chord_and_tangent, the new doc line is too long (should break at 80 chars)

In chord_and_tangent, I am concerned that the use of rational points may restrict the use of this function to the field QQ.

Everywhere, we need at least one example over QQ[sqrt(5)] for instance. And if possible one over QQ(t) ?



---

archive/issue_comments_386126.json:
```json
{
    "body": "<a id='comment:30'></a>\nThanks -- I have fixed the typos and will test over other fields.  (Not that the old code was no tested except over Q in the doctests).\n\nGood point (!) about the use of `rational_points`, which is in fact used in the main function here and not just in the (now redundant) {{chord_and_tangent}}}.  We use it in two ways: to find the 3rd intersection point of the cubic with the tangent at some rational point; and to find the intersection of the cubic with its Hessian.  The first could be done \"by hand\" if necessary, though it is a lot cleaner as it is.  I'll see how it goes.",
    "created_at": "2018-01-27T09:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386126",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:30'></a>
Thanks -- I have fixed the typos and will test over other fields.  (Not that the old code was no tested except over Q in the doctests).

Good point (!) about the use of `rational_points`, which is in fact used in the main function here and not just in the (now redundant) {{chord_and_tangent}}}.  We use it in two ways: to find the 3rd intersection point of the cubic with the tangent at some rational point; and to find the intersection of the cubic with its Hessian.  The first could be done "by hand" if necessary, though it is a lot cleaner as it is.  I'll see how it goes.



---

archive/issue_comments_386127.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-27T09:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386127",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_386128.json:
```json
{
    "body": "<a id='comment:31'></a>\nIt seems to work fine as it is over finite fields and number fields.  Over Q(t) it doesn't because somehwere (not in this code itself) a polynomial factorization is done which requires \"proof=False\"; however the old code (before this patch also fails over Q(t) for a quite different and stupid reason (the function `projective_point` fails when the coordinates of points are not integers (or perhaps rationals)!  So this is already better regarding support of base fields other than Q.\n\nAll we need do as add the parameter factor=False each time we call `tangents()` and all these cases work fine!\n\nI will prepare the new patch when I can.",
    "created_at": "2018-01-27T09:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386128",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:31'></a>
It seems to work fine as it is over finite fields and number fields.  Over Q(t) it doesn't because somehwere (not in this code itself) a polynomial factorization is done which requires "proof=False"; however the old code (before this patch also fails over Q(t) for a quite different and stupid reason (the function `projective_point` fails when the coordinates of points are not integers (or perhaps rationals)!  So this is already better regarding support of base fields other than Q.

All we need do as add the parameter factor=False each time we call `tangents()` and all these cases work fine!

I will prepare the new patch when I can.



---

archive/issue_comments_386129.json:
```json
{
    "body": "Changing commit from \"84483fe5a41f3465f25ab7461bafb7929df7a8cc\" to \"bd39a1ff082cb5f0ceb2f9a93f736434e24597ab\"",
    "created_at": "2018-01-28T15:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386129",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "84483fe5a41f3465f25ab7461bafb7929df7a8cc" to "bd39a1ff082cb5f0ceb2f9a93f736434e24597ab"



---

archive/issue_comments_386130.json:
```json
{
    "body": "<a id='comment:32'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|\n|[bd39a1f](https://git.sagemath.org/sage.git/commit/?id=bd39a1ff082cb5f0ceb2f9a93f736434e24597ab)|`#21092: now works over function fields, extra examples included over finite and number fields`|",
    "created_at": "2018-01-28T15:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386130",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|
|[bd39a1f](https://git.sagemath.org/sage.git/commit/?id=bd39a1ff082cb5f0ceb2f9a93f736434e24597ab)|`#21092: now works over function fields, extra examples included over finite and number fields`|



---

archive/issue_comments_386131.json:
```json
{
    "body": "<a id='comment:33'></a>\nReady for review again.  I factored out the construction of the tangent line to a separate function which uses the factor=False when necessary only.  Experiment showed that using factor=False over QQ led to worse models since (for example) it would return 3*x+3*y instead of x+y.  Noe the code works over all fields I tried: function fields, finite fields, number fields.  Several extra doctests show this.\n\nI fixed the typos, and hope I did not introduce more.\n\nThere was already a note that the supplied point is not always mapped to the point at infinity on the elliptic curve, which I did not change.",
    "created_at": "2018-01-28T15:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386131",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:33'></a>
Ready for review again.  I factored out the construction of the tangent line to a separate function which uses the factor=False when necessary only.  Experiment showed that using factor=False over QQ led to worse models since (for example) it would return 3*x+3*y instead of x+y.  Noe the code works over all fields I tried: function fields, finite fields, number fields.  Several extra doctests show this.

I fixed the typos, and hope I did not introduce more.

There was already a note that the supplied point is not always mapped to the point at infinity on the elliptic curve, which I did not change.



---

archive/issue_comments_386132.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-28T15:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386132",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_386133.json:
```json
{
    "body": "<a id='comment:34'></a>\nBTW some patch bots are reporting errors which only prove that they (the patchbots) are broken, nothing to do with these changes,",
    "created_at": "2018-01-29T08:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386133",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:34'></a>
BTW some patch bots are reporting errors which only prove that they (the patchbots) are broken, nothing to do with these changes,



---

archive/issue_comments_386134.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-29T15:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386134",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386135.json:
```json
{
    "body": "<a id='comment:35'></a>\nok, let it be. Thanks!",
    "created_at": "2018-01-29T15:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386135",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:35'></a>
ok, let it be. Thanks!



---

archive/issue_comments_386136.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2018-01-29T15:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386136",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Frédéric Chapoton"



---

archive/issue_comments_386137.json:
```json
{
    "body": "<a id='comment:36'></a>\nThanks for the review.",
    "created_at": "2018-01-30T09:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386137",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:36'></a>
Thanks for the review.



---

archive/issue_comments_386138.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-01T19:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386138",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_386139.json:
```json
{
    "body": "Changing branch from \"u/cremona/21092\" to \"bd39a1ff082cb5f0ceb2f9a93f736434e24597ab\"",
    "created_at": "2018-02-01T19:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21092#issuecomment-386139",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/cremona/21092" to "bd39a1ff082cb5f0ceb2f9a93f736434e24597ab"



---

archive/issue_events_056323.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-01T19:13:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21092",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21092#event-56323"
}
```
