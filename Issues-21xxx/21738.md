# Issue 21738: %attach has a weird behaviour when dealing with SyntaxError

archive/issues_021501.json:
```json
{
    "body": "The new `%attach` behaves in a strange way when dealing with files that contain errors. Sometimes it parses color escapes sometimes it does not.\n\nHere is how to reproduce the issue:\n\n```\n$ echo \"1 + \" > /tmp/test.py\n$ sage\nsage: %attach /tmp/test.py\n  File \"/tmp/test.py\", line 1\n    1 +\n        ^\nSyntaxError: invalid syntax\n\nsage: os.system('echo \"1 + 1\" > /tmp/test.py')\n0\n### reloading attached file test.py modified at 12:32:53 ###\nsage: os.system('echo \"1 + \" > /tmp/test.py')\n0\n### reloading attached file test.py modified at 12:33:14 ###\n?[1;36m  File ?[1;32m\"/tmp/test.py\"?[1;36m, line ?[1;32m1?[0m\n?[1;33m    1 +?[0m\n?[1;37m        ^?[0m\n?[1;31mSyntaxError?[0m?[1;31m:?[0m invalid syntax\n\nsage: \n```\n\n\nCC:  @vbraun @tscrim @fchapoton\n\nKeywords: %attach\n\nBranch/Commit: 576d387c948311be4ad0244a198534f6cbbbcd6c\n\nReviewer: Travis Scrimshaw\n\nAuthor: Volker Braun\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21738\n\n",
    "closed_at": "2016-10-31T12:32:37Z",
    "created_at": "2016-10-21T12:37:26Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "%attach has a weird behaviour when dealing with SyntaxError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21738",
    "user": "https://github.com/etn40ff"
}
```
The new `%attach` behaves in a strange way when dealing with files that contain errors. Sometimes it parses color escapes sometimes it does not.

Here is how to reproduce the issue:

```
$ echo "1 + " > /tmp/test.py
$ sage
sage: %attach /tmp/test.py
  File "/tmp/test.py", line 1
    1 +
        ^
SyntaxError: invalid syntax

sage: os.system('echo "1 + 1" > /tmp/test.py')
0
### reloading attached file test.py modified at 12:32:53 ###
sage: os.system('echo "1 + " > /tmp/test.py')
0
### reloading attached file test.py modified at 12:33:14 ###
?[1;36m  File ?[1;32m"/tmp/test.py"?[1;36m, line ?[1;32m1?[0m
?[1;33m    1 +?[0m
?[1;37m        ^?[0m
?[1;31mSyntaxError?[0m?[1;31m:?[0m invalid syntax

sage: 
```


CC:  @vbraun @tscrim @fchapoton

Keywords: %attach

Branch/Commit: 576d387c948311be4ad0244a198534f6cbbbcd6c

Reviewer: Travis Scrimshaw

Author: Volker Braun

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21738





---

archive/issue_comments_403991.json:
```json
{
    "body": "<a id='comment:1'></a>\nNote that it works the first time (when you call attach yourself) but not when the attached file is changed. In the latter case, there is already a sage: prompt that needs to be erased, the output printed, and the prompt redrawn. \n\nThats done in IPython's prompt_toolkit patch_stdout_context context, which also screws up ansi sequences.",
    "created_at": "2016-10-22T20:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403991",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
Note that it works the first time (when you call attach yourself) but not when the attached file is changed. In the latter case, there is already a sage: prompt that needs to be erased, the output printed, and the prompt redrawn. 

Thats done in IPython's prompt_toolkit patch_stdout_context context, which also screws up ansi sequences.



---

archive/issue_comments_403992.json:
```json
{
    "body": "Changing branch from \"\" to \"u/vbraun/_attach_has_a_weird_behaviour_when_dealing_with_syntaxerror\"",
    "created_at": "2016-10-22T20:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403992",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "" to "u/vbraun/_attach_has_a_weird_behaviour_when_dealing_with_syntaxerror"



---

archive/issue_comments_403993.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403993",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403994.json:
```json
{
    "body": "Changing author from \"\" to \"Volker Braun\"",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403994",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Volker Braun"



---

archive/issue_comments_403995.json:
```json
{
    "body": "Changing commit from \"\" to \"576d387c948311be4ad0244a198534f6cbbbcd6c\"",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403995",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "" to "576d387c948311be4ad0244a198534f6cbbbcd6c"



---

archive/issue_comments_403996.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[576d387](https://github.com/sagemath/sagetrac-mirror/commit/576d387c948311be4ad0244a198534f6cbbbcd6c)|`Do not escape ansi sequences in patch_stdout_context`|",
    "created_at": "2016-10-22T20:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403996",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[576d387](https://github.com/sagemath/sagetrac-mirror/commit/576d387c948311be4ad0244a198534f6cbbbcd6c)|`Do not escape ansi sequences in patch_stdout_context`|



---

archive/issue_comments_403997.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-23T16:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403997",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403998.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2016-10-23T16:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403998",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_403999.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-31T12:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-403999",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065451.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-31T12:32:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21738#event-65451"
}
```



---

archive/issue_comments_404000.json:
```json
{
    "body": "Changing branch from \"u/vbraun/_attach_has_a_weird_behaviour_when_dealing_with_syntaxerror\" to \"576d387c948311be4ad0244a198534f6cbbbcd6c\"",
    "created_at": "2016-10-31T12:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21738#issuecomment-404000",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/vbraun/_attach_has_a_weird_behaviour_when_dealing_with_syntaxerror" to "576d387c948311be4ad0244a198534f6cbbbcd6c"
