# Issue 21322: coerce_binop has dangerous behaviour wrt additional arguments

archive/issues_021085.json:
```json
{
    "body": "``@`coerce_binop` is an important decorator used on binary operators to automagically apply the coercion framework on its arguments. It's widely used on e.g. `gcd` operations (`_add_`, `_sub_` etc. have coercion handled with another mechanism).\n\nThe current ``@`coerce_binop` has the following dangerous behaviour, where, if the decorated method is given an extra unnamed argument, the `self`-argument is swallowed:\n\n```\n    sage: P.<x> = GF(5)[]\n    sage: f = x^2\n    sage: g = x\n    sage: f.gcd(g)\n    x\n    sage: f.gcd(g, 1)\n    1\n```\n\nThe reason is that ``@`coerce_binop` included a hack to allow calls such as\n`Polynomial.gcd(f,g)` where `f` and `g` are polynomials and the `gcd` method is\ndecorated with ``@`coerce_binop`. The reason that this required a hack at all is that ``@`coerce_binop` was implemented as a class: it seems that creating decorators as classes implies a very unfortunate behaviour:\n\n```\nclass MyDec:\n\n   def __init__(self, f):\n       self.f = f\n\n   def __call__(self, x):\n       print \"decorated: \", self , x\n       self.f(x)\n\nmydec = MyDec\n\nclass A:\n\n    def __init__(self, a):\n        self.a = a\n\n    @mydec\n    def met(self, x):\n        print \"x:\", x\n        \nmyA = A(1)\nmyA.met(5)\n\n```\n\nthe above prints something like\n\n```\n    decorated:  <__main__.MyDec instance at 0x7f63c5ab6c20> 5\n```\n\nand then crashes with \n\n```\n    AttributeError: MyDec instance has no attribute 'a'\n```\n\nThis is because the `self` in `__call__` of `MyDec` becomes the `MyDec` instance\n-- the `A` instance is never passed to the decorating class instance!\n\n\nThe solution here is to rewrite `coerce_binop` as a function. At the same time, we can use ``@`sage_wraps` which ensures proper documentation (e.g. source file and line which was not retained in the previous `coerce_binop`).\n\n\nCC:  @xcaruso @miguelmarco\n\nKeywords: sd75\n\nBranch/Commit: 7344f3a7a1eaf9b9bd35f37556f7bac2614364c0\n\nReviewer: Miguel Marco\n\nAuthor: Johan Rosenkilde, Xavier Caruso\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21322\n\n",
    "closed_at": "2016-08-25T21:45:42Z",
    "created_at": "2016-08-23T21:44:56Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "coerce_binop has dangerous behaviour wrt additional arguments",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21322",
    "user": "https://github.com/johanrosenkilde"
}
```
``@`coerce_binop` is an important decorator used on binary operators to automagically apply the coercion framework on its arguments. It's widely used on e.g. `gcd` operations (`_add_`, `_sub_` etc. have coercion handled with another mechanism).

The current ``@`coerce_binop` has the following dangerous behaviour, where, if the decorated method is given an extra unnamed argument, the `self`-argument is swallowed:

```
    sage: P.<x> = GF(5)[]
    sage: f = x^2
    sage: g = x
    sage: f.gcd(g)
    x
    sage: f.gcd(g, 1)
    1
```

The reason is that ``@`coerce_binop` included a hack to allow calls such as
`Polynomial.gcd(f,g)` where `f` and `g` are polynomials and the `gcd` method is
decorated with ``@`coerce_binop`. The reason that this required a hack at all is that ``@`coerce_binop` was implemented as a class: it seems that creating decorators as classes implies a very unfortunate behaviour:

```
class MyDec:

   def __init__(self, f):
       self.f = f

   def __call__(self, x):
       print "decorated: ", self , x
       self.f(x)

mydec = MyDec

class A:

    def __init__(self, a):
        self.a = a

    @mydec
    def met(self, x):
        print "x:", x
        
myA = A(1)
myA.met(5)

```

the above prints something like

```
    decorated:  <__main__.MyDec instance at 0x7f63c5ab6c20> 5
```

and then crashes with 

```
    AttributeError: MyDec instance has no attribute 'a'
```

This is because the `self` in `__call__` of `MyDec` becomes the `MyDec` instance
-- the `A` instance is never passed to the decorating class instance!


The solution here is to rewrite `coerce_binop` as a function. At the same time, we can use ``@`sage_wraps` which ensures proper documentation (e.g. source file and line which was not retained in the previous `coerce_binop`).


CC:  @xcaruso @miguelmarco

Keywords: sd75

Branch/Commit: 7344f3a7a1eaf9b9bd35f37556f7bac2614364c0

Reviewer: Miguel Marco

Author: Johan Rosenkilde, Xavier Caruso

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21322





---

archive/issue_comments_386592.json:
```json
{
    "body": "Changing author from \"Johan Rosenkilde\" to \"Johan Rosenkilde, Xavier Caruso\"",
    "created_at": "2016-08-23T21:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386592",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing author from "Johan Rosenkilde" to "Johan Rosenkilde, Xavier Caruso"



---

archive/issue_comments_386593.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jsrn/21322_coerce_binop\"",
    "created_at": "2016-08-23T22:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386593",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing branch from "" to "u/jsrn/21322_coerce_binop"



---

archive/issue_comments_386594.json:
```json
{
    "body": "Changing commit from \"\" to \"f49db4ab66d2e6c693981ef7fd5c5552a94629c2\"",
    "created_at": "2016-08-23T22:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386594",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing commit from "" to "f49db4ab66d2e6c693981ef7fd5c5552a94629c2"



---

archive/issue_comments_386595.json:
```json
{
    "body": "<a id='comment:3'></a>\nAs described.\n\n---\nNew commits:\n|                                                                                                                                          |                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|\n|[f49db4a](https://github.com/sagemath/sagetrac-mirror/commit/f49db4ab66d2e6c693981ef7fd5c5552a94629c2)|`Rewrite coerce_binop. Fix a bug exposed by this in fields.py`|",
    "created_at": "2016-08-23T22:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386595",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:3'></a>
As described.

---
New commits:
|                                                                                                                                          |                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|
|[f49db4a](https://github.com/sagemath/sagetrac-mirror/commit/f49db4ab66d2e6c693981ef7fd5c5552a94629c2)|`Rewrite coerce_binop. Fix a bug exposed by this in fields.py`|



---

archive/issue_comments_386596.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd75\".",
    "created_at": "2016-08-23T22:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386596",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing keywords from "" to "sd75".



---

archive/issue_comments_386597.json:
```json
{
    "body": "<a id='comment:4'></a>\nFor information, the popular decorator ``@`cached_method` is also implemented by a class as uses the same hack consisting in creating on the fly a new decorator for each instance (through a `__get__` method).",
    "created_at": "2016-08-24T08:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386597",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:4'></a>
For information, the popular decorator ``@`cached_method` is also implemented by a class as uses the same hack consisting in creating on the fly a new decorator for each instance (through a `__get__` method).



---

archive/issue_comments_386598.json:
```json
{
    "body": "<a id='comment:5'></a>\nI got the following, possibly spurious doc-test failures:\n\n```\nsage -t src/sage/interfaces/sage0.py  # Timed out\nsage -t src/sage/graphs/tutte_polynomial.py  # Timed out\nsage -t src/sage/categories/euclidean_domains.py  # 1 doctest failed\nsage -t src/sage/tests/cmdline.py  # 8 doctests failed\nsage -t src/sage/interacts/debugger.py  # Timed out\nsage -t src/sage/structure/element.pyx  # 6 doctests failed\nsage -t src/sage/quivers/algebra_elements.pxi  # Timed out\nsage -t src/sage/misc/randstate.pyx  # Timed out\nsage -t src/sage/rings/polynomial/padics/polynomial_padic_capped_relative_dense.py  # 1 doctest failed\nsage -t src/sage/doctest/forker.py  # Timed out\nsage -t src/sage/repl/interpreter.py  # Tab character found\n----------------------------------------------------------------------\n```",
    "created_at": "2016-08-24T08:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386598",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:5'></a>
I got the following, possibly spurious doc-test failures:

```
sage -t src/sage/interfaces/sage0.py  # Timed out
sage -t src/sage/graphs/tutte_polynomial.py  # Timed out
sage -t src/sage/categories/euclidean_domains.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 8 doctests failed
sage -t src/sage/interacts/debugger.py  # Timed out
sage -t src/sage/structure/element.pyx  # 6 doctests failed
sage -t src/sage/quivers/algebra_elements.pxi  # Timed out
sage -t src/sage/misc/randstate.pyx  # Timed out
sage -t src/sage/rings/polynomial/padics/polynomial_padic_capped_relative_dense.py  # 1 doctest failed
sage -t src/sage/doctest/forker.py  # Timed out
sage -t src/sage/repl/interpreter.py  # Tab character found
----------------------------------------------------------------------
```



---

archive/issue_comments_386599.json:
```json
{
    "body": "Changing branch from \"u/jsrn/21322_coerce_binop\" to \"u/caruso/21322_coerce_binop\"",
    "created_at": "2016-08-24T14:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386599",
    "user": "https://github.com/xcaruso"
}
```

Changing branch from "u/jsrn/21322_coerce_binop" to "u/caruso/21322_coerce_binop"



---

archive/issue_comments_386600.json:
```json
{
    "body": "Changing commit from \"f49db4ab66d2e6c693981ef7fd5c5552a94629c2\" to \"cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa\"",
    "created_at": "2016-08-24T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386600",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f49db4ab66d2e6c693981ef7fd5c5552a94629c2" to "cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa"



---

archive/issue_comments_386601.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[cfb5326](https://github.com/sagemath/sagetrac-mirror/commit/cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa)|`Small fixes. All doctests pass (hopefully)`|",
    "created_at": "2016-08-24T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386601",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[cfb5326](https://github.com/sagemath/sagetrac-mirror/commit/cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa)|`Small fixes. All doctests pass (hopefully)`|



---

archive/issue_comments_386602.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-24T14:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386602",
    "user": "https://github.com/xcaruso"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386603.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[7344f3a](https://github.com/sagemath/sagetrac-mirror/commit/7344f3a7a1eaf9b9bd35f37556f7bac2614364c0)|`Small change in a doctest`|",
    "created_at": "2016-08-24T18:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386603",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[7344f3a](https://github.com/sagemath/sagetrac-mirror/commit/7344f3a7a1eaf9b9bd35f37556f7bac2614364c0)|`Small change in a doctest`|



---

archive/issue_comments_386604.json:
```json
{
    "body": "Changing commit from \"cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa\" to \"7344f3a7a1eaf9b9bd35f37556f7bac2614364c0\"",
    "created_at": "2016-08-24T18:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386604",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cfb532633e7b7df58b8b4ec00c7dc1e0b99c90aa" to "7344f3a7a1eaf9b9bd35f37556f7bac2614364c0"



---

archive/issue_comments_386605.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-24T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386605",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386606.json:
```json
{
    "body": "<a id='comment:10'></a>\nI don't get any of the errors pointed by jsm.\n\nOtherwise, lgtm.\n\n---\nNew commits:\n|                                                                                                                                          |                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[7344f3a](https://github.com/sagemath/sagetrac-mirror/commit/7344f3a7a1eaf9b9bd35f37556f7bac2614364c0)|`Small change in a doctest`|",
    "created_at": "2016-08-24T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386606",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:10'></a>
I don't get any of the errors pointed by jsm.

Otherwise, lgtm.

---
New commits:
|                                                                                                                                          |                           |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[7344f3a](https://github.com/sagemath/sagetrac-mirror/commit/7344f3a7a1eaf9b9bd35f37556f7bac2614364c0)|`Small change in a doctest`|



---

archive/issue_comments_386607.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Miguel Marco\"",
    "created_at": "2016-08-24T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386607",
    "user": "https://github.com/miguelmarco"
}
```

Changing reviewer from "" to "Miguel Marco"



---

archive/issue_comments_386608.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-25T21:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386608",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_072332.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-25T21:45:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21322#event-72332"
}
```



---

archive/issue_comments_386609.json:
```json
{
    "body": "Changing branch from \"u/caruso/21322_coerce_binop\" to \"7344f3a7a1eaf9b9bd35f37556f7bac2614364c0\"",
    "created_at": "2016-08-25T21:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-386609",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/caruso/21322_coerce_binop" to "7344f3a7a1eaf9b9bd35f37556f7bac2614364c0"
