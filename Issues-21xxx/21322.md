# Issue 21322: coerce_binop has dangerous behaviour wrt additional arguments

archive/issues_021085.json:
```json
{
    "body": "CC:  @xcaruso @miguelmarco\n\nKeywords: sd75\n\n``@`coerce_binop` is an important decorator used on binary operators to automagically apply the coercion framework on its arguments. It's widely used on e.g. `gcd` operations (`_add_`, `_sub_` etc. have coercion handled with another mechanism).\n\nThe current ``@`coerce_binop` has the following dangerous behaviour, where, if the decorated method is given an extra unnamed argument, the `self`-argument is swallowed:\n\n```\n    sage: P.<x> = GF(5)[]\n    sage: f = x^2\n    sage: g = x\n    sage: f.gcd(g)\n    x\n    sage: f.gcd(g, 1)\n    1\n```\n\nThe reason is that ``@`coerce_binop` included a hack to allow calls such as\n`Polynomial.gcd(f,g)` where `f` and `g` are polynomials and the `gcd` method is\ndecorated with ``@`coerce_binop`. The reason that this required a hack at all is that ``@`coerce_binop` was implemented as a class: it seems that creating decorators as classes implies a very unfortunate behaviour:\n\n```\nclass MyDec:\n\n   def __init__(self, f):\n       self.f = f\n\n   def __call__(self, x):\n       print \"decorated: \", self , x\n       self.f(x)\n\nmydec = MyDec\n\nclass A:\n\n    def __init__(self, a):\n        self.a = a\n\n    @mydec\n    def met(self, x):\n        print \"x:\", x\n        \nmyA = A(1)\nmyA.met(5)\n\n```\n\nthe above prints something like\n\n```\n    decorated:  <__main__.MyDec instance at 0x7f63c5ab6c20> 5\n```\n\nand then crashes with \n\n```\n    AttributeError: MyDec instance has no attribute 'a'\n```\n\nThis is because the `self` in `__call__` of `MyDec` becomes the `MyDec` instance\n-- the `A` instance is never passed to the decorating class instance!\n\n\nThe solution here is to rewrite `coerce_binop` as a function. At the same time, we can use ``@`sage_wraps` which ensures proper documentation (e.g. source file and line which was not retained in the previous `coerce_binop`).\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21322\n\n",
    "closed_at": "2016-08-25T21:45:42Z",
    "created_at": "2016-08-23T21:44:56Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "coerce_binop has dangerous behaviour wrt additional arguments",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21322",
    "user": "https://github.com/johanrosenkilde"
}
```
CC:  @xcaruso @miguelmarco

Keywords: sd75

``@`coerce_binop` is an important decorator used on binary operators to automagically apply the coercion framework on its arguments. It's widely used on e.g. `gcd` operations (`_add_`, `_sub_` etc. have coercion handled with another mechanism).

The current ``@`coerce_binop` has the following dangerous behaviour, where, if the decorated method is given an extra unnamed argument, the `self`-argument is swallowed:

```
    sage: P.<x> = GF(5)[]
    sage: f = x^2
    sage: g = x
    sage: f.gcd(g)
    x
    sage: f.gcd(g, 1)
    1
```

The reason is that ``@`coerce_binop` included a hack to allow calls such as
`Polynomial.gcd(f,g)` where `f` and `g` are polynomials and the `gcd` method is
decorated with ``@`coerce_binop`. The reason that this required a hack at all is that ``@`coerce_binop` was implemented as a class: it seems that creating decorators as classes implies a very unfortunate behaviour:

```
class MyDec:

   def __init__(self, f):
       self.f = f

   def __call__(self, x):
       print "decorated: ", self , x
       self.f(x)

mydec = MyDec

class A:

    def __init__(self, a):
        self.a = a

    @mydec
    def met(self, x):
        print "x:", x
        
myA = A(1)
myA.met(5)

```

the above prints something like

```
    decorated:  <__main__.MyDec instance at 0x7f63c5ab6c20> 5
```

and then crashes with 

```
    AttributeError: MyDec instance has no attribute 'a'
```

This is because the `self` in `__call__` of `MyDec` becomes the `MyDec` instance
-- the `A` instance is never passed to the decorating class instance!


The solution here is to rewrite `coerce_binop` as a function. At the same time, we can use ``@`sage_wraps` which ensures proper documentation (e.g. source file and line which was not retained in the previous `coerce_binop`).


Issue created by migration from https://trac.sagemath.org/ticket/21322





---

archive/issue_comments_291797.json:
```json
{
    "body": "As described.\n\n---\nNew commits:",
    "created_at": "2016-08-23T22:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291797",
    "user": "https://github.com/johanrosenkilde"
}
```

As described.

---
New commits:



---

archive/issue_comments_291798.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd75\".",
    "created_at": "2016-08-23T22:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291798",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing keywords from "" to "sd75".



---

archive/issue_comments_291799.json:
```json
{
    "body": "For information, the popular decorator ``@`cached_method` is also implemented by a class as uses the same hack consisting in creating on the fly a new decorator for each instance (through a `__get__` method).",
    "created_at": "2016-08-24T08:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291799",
    "user": "https://github.com/xcaruso"
}
```

For information, the popular decorator ``@`cached_method` is also implemented by a class as uses the same hack consisting in creating on the fly a new decorator for each instance (through a `__get__` method).



---

archive/issue_comments_291800.json:
```json
{
    "body": "I got the following, possibly spurious doc-test failures:\n\n```\nsage -t src/sage/interfaces/sage0.py  # Timed out\nsage -t src/sage/graphs/tutte_polynomial.py  # Timed out\nsage -t src/sage/categories/euclidean_domains.py  # 1 doctest failed\nsage -t src/sage/tests/cmdline.py  # 8 doctests failed\nsage -t src/sage/interacts/debugger.py  # Timed out\nsage -t src/sage/structure/element.pyx  # 6 doctests failed\nsage -t src/sage/quivers/algebra_elements.pxi  # Timed out\nsage -t src/sage/misc/randstate.pyx  # Timed out\nsage -t src/sage/rings/polynomial/padics/polynomial_padic_capped_relative_dense.py  # 1 doctest failed\nsage -t src/sage/doctest/forker.py  # Timed out\nsage -t src/sage/repl/interpreter.py  # Tab character found\n----------------------------------------------------------------------\n```",
    "created_at": "2016-08-24T08:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291800",
    "user": "https://github.com/johanrosenkilde"
}
```

I got the following, possibly spurious doc-test failures:

```
sage -t src/sage/interfaces/sage0.py  # Timed out
sage -t src/sage/graphs/tutte_polynomial.py  # Timed out
sage -t src/sage/categories/euclidean_domains.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 8 doctests failed
sage -t src/sage/interacts/debugger.py  # Timed out
sage -t src/sage/structure/element.pyx  # 6 doctests failed
sage -t src/sage/quivers/algebra_elements.pxi  # Timed out
sage -t src/sage/misc/randstate.pyx  # Timed out
sage -t src/sage/rings/polynomial/padics/polynomial_padic_capped_relative_dense.py  # 1 doctest failed
sage -t src/sage/doctest/forker.py  # Timed out
sage -t src/sage/repl/interpreter.py  # Tab character found
----------------------------------------------------------------------
```



---

archive/issue_comments_291801.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-24T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291801",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291802.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-24T14:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291802",
    "user": "https://github.com/xcaruso"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_291803.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-24T18:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291804.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-24T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291804",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291805.json:
```json
{
    "body": "I don't get any of the errors pointed by jsm.\n\nOtherwise, lgtm.\n\n---\nNew commits:",
    "created_at": "2016-08-24T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291805",
    "user": "https://github.com/miguelmarco"
}
```

I don't get any of the errors pointed by jsm.

Otherwise, lgtm.

---
New commits:



---

archive/issue_comments_291806.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-25T21:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21322#issuecomment-291806",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056763.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-25T21:45:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21322",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21322#event-56763"
}
```
