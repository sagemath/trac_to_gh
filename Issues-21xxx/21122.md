# Issue 21122: Do not force non-facade posets as the indexing set for the Möbuis algebra basis

archive/issues_020885.json:
```json
{
    "body": "This can cause subtle bugs with comparisons between wrapped elements of a poset, which might not be given by the poset. We fix this and the triangularity issue that was hacked around in #21054, which introduced this problem.\n\nSee the discussion on #21054.\n\nCC:  sage-combinat @nthiery @darijgr\n\nKeywords: poset\n\nBranch/Commit: 56e4fb38f47ee24a88a2752393cf2a0b16eead0b\n\nReviewer: Darij Grinberg\n\nAuthor: Travis Scrimshaw\n\nDependencies: #21054, #21043\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21122\n\n",
    "closed_at": "2016-08-21T13:13:54Z",
    "created_at": "2016-07-28T21:56:23Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Do not force non-facade posets as the indexing set for the M\u00f6buis algebra basis",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21122",
    "user": "https://github.com/tscrim"
}
```
This can cause subtle bugs with comparisons between wrapped elements of a poset, which might not be given by the poset. We fix this and the triangularity issue that was hacked around in #21054, which introduced this problem.

See the discussion on #21054.

CC:  sage-combinat @nthiery @darijgr

Keywords: poset

Branch/Commit: 56e4fb38f47ee24a88a2752393cf2a0b16eead0b

Reviewer: Darij Grinberg

Author: Travis Scrimshaw

Dependencies: #21054, #21043

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21122





---

archive/issue_comments_386780.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-28T21:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386780",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386781.json:
```json
{
    "body": "<a id='comment:1'></a>This is at least a much better solution than the hack I had to do on #21054.\n\n---\nNew commits:",
    "created_at": "2016-07-28T21:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386781",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>This is at least a much better solution than the hack I had to do on #21054.

---
New commits:



---

archive/issue_comments_386782.json:
```json
{
    "body": "Changing commit from \"\" to \"c09d3b086d3ba180743d7bc02ba150783ca76d4d\"",
    "created_at": "2016-07-28T21:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386782",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "" to "c09d3b086d3ba180743d7bc02ba150783ca76d4d"



---

archive/issue_comments_386783.json:
```json
{
    "body": "Changing branch from \"\" to \"public/combinat/moebius_algebra_basis_keys-21122\"",
    "created_at": "2016-07-28T21:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386783",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "" to "public/combinat/moebius_algebra_basis_keys-21122"



---

archive/issue_comments_386784.json:
```json
{
    "body": "<a id='comment:2'></a>Great job! Two things, though:\n\n- I suggest replacing the doc of `_Key` by something more readable:\n\n```\n    Helper class to serve as a key for comparing elements of the\n    lattice.\n\n    The change-of-basis morphisms between the bases of the\n    :class:`MoebiusAlgebra` are triangular with respect to the partial\n    order of the poset. Since this partial order might not agree with\n    the standard comparison function ``cmp``, we need a wrapper around\n    the elements of the lattice which ensures that calling ``cmp`` on\n    them (when wrapped) actually compares them using the lattice's\n    partial order. This helper class is precisely that.\n```\n(You probably can do better.)\n\n- Do we know that whatever the `module_morphism` infrastructure does to `key` allows `key` to live in a poset? I see `leading_item` being called in https://github.com/sagemath/sage/blob/develop/src/sage/modules/with_basis/morphism.py ; what does this return when there are several maximal items?",
    "created_at": "2016-07-29T01:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386784",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:2'></a>Great job! Two things, though:

- I suggest replacing the doc of `_Key` by something more readable:

```
    Helper class to serve as a key for comparing elements of the
    lattice.

    The change-of-basis morphisms between the bases of the
    :class:`MoebiusAlgebra` are triangular with respect to the partial
    order of the poset. Since this partial order might not agree with
    the standard comparison function ``cmp``, we need a wrapper around
    the elements of the lattice which ensures that calling ``cmp`` on
    them (when wrapped) actually compares them using the lattice's
    partial order. This helper class is precisely that.
```
(You probably can do better.)

- Do we know that whatever the `module_morphism` infrastructure does to `key` allows `key` to live in a poset? I see `leading_item` being called in https://github.com/sagemath/sage/blob/develop/src/sage/modules/with_basis/morphism.py ; what does this return when there are several maximal items?



---

archive/issue_comments_386785.json:
```json
{
    "body": "Changing commit from \"c09d3b086d3ba180743d7bc02ba150783ca76d4d\" to \"499bbe65ec6fd20546c15f815f2a40faf29eb972\"",
    "created_at": "2016-07-29T01:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386785",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c09d3b086d3ba180743d7bc02ba150783ca76d4d" to "499bbe65ec6fd20546c15f815f2a40faf29eb972"



---

archive/issue_comments_386786.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-29T01:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386786",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386787.json:
```json
{
    "body": "<a id='comment:4'></a>Thank you for looking at this.\n\nI made that a lot shorter because (IMO) this class does not deserve any real documentation because it is hidden from the doc and never exposed to the user. You are only going to see this if you are looking at the code, but it is clear from the code what this class does. I feel it is just an implementation detail because of how we handle posets.\n\nThere is only one maximal element because the M\u00f6bius algebra is only defined for lattices.",
    "created_at": "2016-07-29T01:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386787",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Thank you for looking at this.

I made that a lot shorter because (IMO) this class does not deserve any real documentation because it is hidden from the doc and never exposed to the user. You are only going to see this if you are looking at the code, but it is clear from the code what this class does. I feel it is just an implementation detail because of how we handle posets.

There is only one maximal element because the Möbius algebra is only defined for lattices.



---

archive/issue_comments_386788.json:
```json
{
    "body": "<a id='comment:5'></a>?\n\nI'm talking about leading terms of elements in the lattice algebra. Those can easily have multiple \"leading\" terms.",
    "created_at": "2016-07-29T01:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386788",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:5'></a>?

I'm talking about leading terms of elements in the lattice algebra. Those can easily have multiple "leading" terms.



---

archive/issue_comments_386789.json:
```json
{
    "body": "<a id='comment:6'></a>We don't care, it just does reduction and the triangularity guarantees the invertibility.",
    "created_at": "2016-07-29T01:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386789",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>We don't care, it just does reduction and the triangularity guarantees the invertibility.



---

archive/issue_comments_386790.json:
```json
{
    "body": "<a id='comment:7'></a>OK, I am still unconvinced of any guarantees, but that's probably the best I can do without knowing the module_morphism code (I'm not sure I ever did, for all the doc edits I made on that file). But in the worst case, it will just throw errors or endless-loop on methods which would otherwise just be not implemented; so there's no harm done here (and if there was, it would have been done by #21054, not by this ticket).\n\nSorry for my lack of faith in anything Sage lately... your code is good, that's not the issue.",
    "created_at": "2016-07-29T02:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386790",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:7'></a>OK, I am still unconvinced of any guarantees, but that's probably the best I can do without knowing the module_morphism code (I'm not sure I ever did, for all the doc edits I made on that file). But in the worst case, it will just throw errors or endless-loop on methods which would otherwise just be not implemented; so there's no harm done here (and if there was, it would have been done by #21054, not by this ticket).

Sorry for my lack of faith in anything Sage lately... your code is good, that's not the issue.



---

archive/issue_comments_386791.json:
```json
{
    "body": "<a id='comment:8'></a>It's okay, and skepticism is good. As I understand it, the triangular module morphism code will not throw errors or result in endless loops here because it is only used for computing the inverse, which uses the triangularity, something the theory guarantees. Can I count this as a positive review, or do you think we need more discussion?",
    "created_at": "2016-07-29T03:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386791",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>It's okay, and skepticism is good. As I understand it, the triangular module morphism code will not throw errors or result in endless loops here because it is only used for computing the inverse, which uses the triangularity, something the theory guarantees. Can I count this as a positive review, or do you think we need more discussion?



---

archive/issue_comments_386792.json:
```json
{
    "body": "<a id='comment:9'></a>See my comment on the previous ticket: maybe it's not needed to have a class for this. Well, maybe it is if we want the morphism to be picklable.",
    "created_at": "2016-07-29T05:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386792",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:9'></a>See my comment on the previous ticket: maybe it's not needed to have a class for this. Well, maybe it is if we want the morphism to be picklable.



---

archive/issue_comments_386793.json:
```json
{
    "body": "<a id='comment:10'></a>Oops, yes, I forgot to say: it's a positive review, if the tests pass.\n\n`@`Nicolas: out of curiosity, why does a key class make morphisms picklable, but a custom cmp doesn't?\n\n`@`Travis: it's also used for computing preimages, for example. Though, as I said, I'm fine with all sorts of bad behavior short of wrong results here, because these would be NotImplementedErrors without the triangularity parameters.",
    "created_at": "2016-07-29T11:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386793",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:10'></a>Oops, yes, I forgot to say: it's a positive review, if the tests pass.

`@`Nicolas: out of curiosity, why does a key class make morphisms picklable, but a custom cmp doesn't?

`@`Travis: it's also used for computing preimages, for example. Though, as I said, I'm fine with all sorts of bad behavior short of wrong results here, because these would be NotImplementedErrors without the triangularity parameters.



---

archive/issue_comments_386794.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-30T14:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386795.json:
```json
{
    "body": "Changing commit from \"499bbe65ec6fd20546c15f815f2a40faf29eb972\" to \"872f3c0e21ab0d8608257f980c7ce6867dbcca8b\"",
    "created_at": "2016-07-30T14:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "499bbe65ec6fd20546c15f815f2a40faf29eb972" to "872f3c0e21ab0d8608257f980c7ce6867dbcca8b"



---

archive/issue_comments_386796.json:
```json
{
    "body": "<a id='comment:12'></a>The reason why it doesn't pickle is because lambda functions don't pickle. I've fixed this by adding a method to the category. However, I have uncovered a very subtle bug with pickling of the module morphisms with cached methods, see #21133. All tests pass for me.",
    "created_at": "2016-07-30T15:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386796",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>The reason why it doesn't pickle is because lambda functions don't pickle. I've fixed this by adding a method to the category. However, I have uncovered a very subtle bug with pickling of the module morphisms with cached methods, see #21133. All tests pass for me.



---

archive/issue_comments_386797.json:
```json
{
    "body": "<a id='comment:13'></a>Patchbot passes all tests as well. Positive review?",
    "created_at": "2016-07-31T14:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386797",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Patchbot passes all tests as well. Positive review?



---

archive/issue_comments_386798.json:
```json
{
    "body": "<a id='comment:14'></a>As far as I'm concerned, yes, positive_review. Nicolas, any objections?",
    "created_at": "2016-07-31T14:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386798",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:14'></a>As far as I'm concerned, yes, positive_review. Nicolas, any objections?



---

archive/issue_comments_386799.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Darij Grinberg\"",
    "created_at": "2016-08-03T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386799",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Darij Grinberg"



---

archive/issue_comments_386800.json:
```json
{
    "body": "<a id='comment:15'></a>Ping, Nicolas?",
    "created_at": "2016-08-03T14:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386800",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Ping, Nicolas?



---

archive/issue_comments_386801.json:
```json
{
    "body": "<a id='comment:16'></a>Sorry, I am about to take off for vacations and was busy with preparation. I just had a look at the code. I believe the key function, should really just be an ranker according to the default linear extension. Luckily, I just remembered that we already had rankers as a picklable object:\n\n```\nsage: key = sage.combinat.ranker.rank_from_list(['a', 'b', 'c'])\nsage: key('b')\n1\nsage: loads(dumps(key))\n{'a': 0, 'c': 2, 'b': 1}\nsage: key == loads(dumps(key))\nTrue\n```",
    "created_at": "2016-08-03T18:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386801",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:16'></a>Sorry, I am about to take off for vacations and was busy with preparation. I just had a look at the code. I believe the key function, should really just be an ranker according to the default linear extension. Luckily, I just remembered that we already had rankers as a picklable object:

```
sage: key = sage.combinat.ranker.rank_from_list(['a', 'b', 'c'])
sage: key('b')
1
sage: loads(dumps(key))
{'a': 0, 'c': 2, 'b': 1}
sage: key == loads(dumps(key))
True
```



---

archive/issue_comments_386802.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-03T21:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386802",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386803.json:
```json
{
    "body": "Changing commit from \"872f3c0e21ab0d8608257f980c7ce6867dbcca8b\" to \"56e4fb38f47ee24a88a2752393cf2a0b16eead0b\"",
    "created_at": "2016-08-03T21:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "872f3c0e21ab0d8608257f980c7ce6867dbcca8b" to "56e4fb38f47ee24a88a2752393cf2a0b16eead0b"



---

archive/issue_comments_386804.json:
```json
{
    "body": "<a id='comment:18'></a>That actually gave me a good idea, where we can use data from the poset. In particular, we have `_element_to_vertex` and the promise that `[1..n]` is a linear extension of the `HasseDiagram`. Unfortunately using (the [marginally] faster) `_element_to_vertex_dict.__getitem__` didn't want to unpickle. Anyways, this is a much better solution than what I had before.",
    "created_at": "2016-08-03T21:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386804",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>That actually gave me a good idea, where we can use data from the poset. In particular, we have `_element_to_vertex` and the promise that `[1..n]` is a linear extension of the `HasseDiagram`. Unfortunately using (the [marginally] faster) `_element_to_vertex_dict.__getitem__` didn't want to unpickle. Anyways, this is a much better solution than what I had before.



---

archive/issue_comments_386805.json:
```json
{
    "body": "<a id='comment:19'></a>OOps, I completely forgot about this one! Yeah, you found the best possible solution. Great job!",
    "created_at": "2016-08-19T23:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386805",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:19'></a>OOps, I completely forgot about this one! Yeah, you found the best possible solution. Great job!



---

archive/issue_comments_386806.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-19T23:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386806",
    "user": "https://github.com/darijgr"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386807.json:
```json
{
    "body": "Changing branch from \"public/combinat/moebius_algebra_basis_keys-21122\" to \"56e4fb38f47ee24a88a2752393cf2a0b16eead0b\"",
    "created_at": "2016-08-21T13:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386807",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/combinat/moebius_algebra_basis_keys-21122" to "56e4fb38f47ee24a88a2752393cf2a0b16eead0b"



---

archive/issue_comments_386808.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-21T13:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21122#issuecomment-386808",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056378.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-21T13:13:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21122#event-56378"
}
```
