# Issue 21600: Use custom build_ext to compile Cython code

archive/issues_021363.json:
```json
{
    "assignees": [],
    "body": "In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.\n\nThis is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py\nUnfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.\n\nDue to a [Cython bug](https://github.com/cython/cython/pull/1476), this warning gets displayed even though the `cache` option is valid: `UserWarning: got unknown compilation option, please remove: cache`.\n\nDepends on #21604\n\nCC:  @mkoeppe @embray\n\nBranch/Commit: **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**\n\nReviewer: **Matthias Koeppe, Erik Bray**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21600_\n\n",
    "closed_at": "2016-10-21T07:03:39Z",
    "created_at": "2016-09-26T15:18:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use custom build_ext to compile Cython code",
    "type": "issue",
    "updated_at": "2016-10-21T07:03:39Z",
    "url": "https://github.com/sagemath/sage/issues/21600",
    "user": "https://github.com/jdemeyer"
}
```
In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.

This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py
Unfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.

Due to a [Cython bug](https://github.com/cython/cython/pull/1476), this warning gets displayed even though the `cache` option is valid: `UserWarning: got unknown compilation option, please remove: cache`.

Depends on #21604

CC:  @mkoeppe @embray

Branch/Commit: **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**

Reviewer: **Matthias Koeppe, Erik Bray**

Author: **Jeroen Demeyer**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/21600_





---

archive/issue_events_300615.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T15:18:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300615"
}
```



---

archive/issue_events_300616.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T15:18:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300616"
}
```



---

archive/issue_events_300617.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T15:18:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300617"
}
```



---

archive/issue_events_300618.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T15:18:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300618"
}
```



---

archive/issue_comments_317275.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n-In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use Cython's `build_ext` command for that (new since Cython 0.25, so this ticket needs to depend on #20596).\n+In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.\n \n-See http://cython.readthedocs.io/en/latest/src/reference/compilation.html?highlight=build_ext#distributing-cython-modules\n+This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py\n+Unfortunately, we cannot really use that since it doesn't allow to pass options to `build_ext`.\n``````\n",
    "created_at": "2016-09-27T09:26:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317275",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
-In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use Cython's `build_ext` command for that (new since Cython 0.25, so this ticket needs to depend on #20596).
+In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.
 
-See http://cython.readthedocs.io/en/latest/src/reference/compilation.html?highlight=build_ext#distributing-cython-modules
+This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py
+Unfortunately, we cannot really use that since it doesn't allow to pass options to `build_ext`.
``````




---

archive/issue_events_300619.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-27T09:28:16Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "title_is": "Use custom build_ext to compile Cython code",
    "title_was": "Use Cython's build_ext",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300619"
}
```



---

archive/issue_comments_317276.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.\n \n This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py\n-Unfortunately, we cannot really use that since it doesn't allow to pass options to `build_ext`.\n+Unfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.\n``````\n",
    "created_at": "2016-09-27T12:37:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317276",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 In `src/setup.py`, we should not run `cythonize()` manually. It would be better to use a custom `build_ext` command for that.
 
 This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py
-Unfortunately, we cannot really use that since it doesn't allow to pass options to `build_ext`.
+Unfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.
``````




---

archive/issue_comments_317277.json:
```json
{
    "body": "Branch: **[u/jdemeyer/ticket/21600](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/21600)**",
    "created_at": "2016-09-27T13:16:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317277",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/ticket/21600](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/21600)**



---

archive/issue_comments_317278.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a5586239a97bb99245055b39c2594f376822784\"><code>5a55862</code></a></td><td><code>Fix build of pyzmq with Cython 0.25</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/85634c2fd76698254125c215eadb34d136284617\"><code>85634c2</code></a></td><td><code>Upgrade Cython to version 0.25</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/547424765e2e2e89a6b0154516f351238345abec\"><code>5474247</code></a></td><td><code>Move old_style_globals to modules; other directives to cythonize() call</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37\"><code>6d6d349</code></a></td><td><code>Run cythonize() inside build_ext command</code></td></tr></table>\n",
    "created_at": "2016-09-28T08:40:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317278",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a5586239a97bb99245055b39c2594f376822784"><code>5a55862</code></a></td><td><code>Fix build of pyzmq with Cython 0.25</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/85634c2fd76698254125c215eadb34d136284617"><code>85634c2</code></a></td><td><code>Upgrade Cython to version 0.25</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/547424765e2e2e89a6b0154516f351238345abec"><code>5474247</code></a></td><td><code>Move old_style_globals to modules; other directives to cythonize() call</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37"><code>6d6d349</code></a></td><td><code>Run cythonize() inside build_ext command</code></td></tr></table>




---

archive/issue_comments_317279.json:
```json
{
    "body": "Commit: **[`6d6d349`](https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37)**",
    "created_at": "2016-09-28T08:40:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317279",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`6d6d349`](https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37)**



---

archive/issue_comments_317280.json:
```json
{
    "body": "Changed dependencies from **#20596** to **#21604**",
    "created_at": "2016-09-28T08:40:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317280",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#20596** to **#21604**



---

archive/issue_comments_317281.json:
```json
{
    "body": "Changed commit from **[`6d6d349`](https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37)** to **[`35ecf4b`](https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81)**",
    "created_at": "2016-09-28T12:08:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317281",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6d6d349`](https://github.com/sagemath/sagetrac-mirror/commit/6d6d3490d1aa434acfdb9ebed4730df38aae6a37)** to **[`35ecf4b`](https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81)**



---

archive/issue_comments_317282.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a8cc0e1bc0c09142275a7ea6b03775e83d73e28\"><code>3a8cc0e</code></a></td><td><code>Fix typo in comment</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0dd9c50021302e4d8cfc6f95e8bbdea232c60b97\"><code>0dd9c50</code></a></td><td><code>Respect environment variable MAKE</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/17f90d8d1e8b35f9ae08bb98bb876083ba968824\"><code>17f90d8</code></a></td><td><code>beautification</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e5f90659f21cc7ac1e39cdcf7974dba2ba223da5\"><code>e5f9065</code></a></td><td><code>More comments</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7791cd987347dfe253e3ed3ce74214f4527485d8\"><code>7791cd9</code></a></td><td><code>Remove --buildbase code</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/74169e75b0c650e6b1070c6beca231422cf62eaa\"><code>74169e7</code></a></td><td><code>Pass SAGE_SRC to generate_py_source.mk</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0394333a54e51c53b9404f248220a412cf13e00e\"><code>0394333</code></a></td><td><code>Add new file to MANIFEST.in</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fdedb029434cba49db4249c5511af8c8efc08217\"><code>fdedb02</code></a></td><td><code>Install SAGE_LOCAL/bin/sage instead of SAGE_ROOT/sage as Jupyter kernel</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5ba95ed73aa3df532a2b6256510f2e2d842a0a35\"><code>5ba95ed</code></a></td><td><code>Clean up stale installed files in install command</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81\"><code>35ecf4b</code></a></td><td><code>Run cythonize() inside build_ext command</code></td></tr></table>\n",
    "created_at": "2016-09-28T12:08:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317282",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a8cc0e1bc0c09142275a7ea6b03775e83d73e28"><code>3a8cc0e</code></a></td><td><code>Fix typo in comment</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0dd9c50021302e4d8cfc6f95e8bbdea232c60b97"><code>0dd9c50</code></a></td><td><code>Respect environment variable MAKE</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/17f90d8d1e8b35f9ae08bb98bb876083ba968824"><code>17f90d8</code></a></td><td><code>beautification</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e5f90659f21cc7ac1e39cdcf7974dba2ba223da5"><code>e5f9065</code></a></td><td><code>More comments</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7791cd987347dfe253e3ed3ce74214f4527485d8"><code>7791cd9</code></a></td><td><code>Remove --buildbase code</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/74169e75b0c650e6b1070c6beca231422cf62eaa"><code>74169e7</code></a></td><td><code>Pass SAGE_SRC to generate_py_source.mk</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0394333a54e51c53b9404f248220a412cf13e00e"><code>0394333</code></a></td><td><code>Add new file to MANIFEST.in</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fdedb029434cba49db4249c5511af8c8efc08217"><code>fdedb02</code></a></td><td><code>Install SAGE_LOCAL/bin/sage instead of SAGE_ROOT/sage as Jupyter kernel</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5ba95ed73aa3df532a2b6256510f2e2d842a0a35"><code>5ba95ed</code></a></td><td><code>Clean up stale installed files in install command</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81"><code>35ecf4b</code></a></td><td><code>Run cythonize() inside build_ext command</code></td></tr></table>




---

archive/issue_comments_317283.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIf I'm to understand  correctly, this is mostly just taking the existing Cython build code and moving into the build_ext command, right?  Or was anything substantive changed in the build code too (beyond what was already from #21604)?",
    "created_at": "2016-09-29T15:59:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317283",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

If I'm to understand  correctly, this is mostly just taking the existing Cython build code and moving into the build_ext command, right?  Or was anything substantive changed in the build code too (beyond what was already from #21604)?



---

archive/issue_comments_317284.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment%3A8):\n> If I'm to understand  correctly, this is mostly just taking the existing Cython build code and moving into the build_ext command, right?\n\nExactly. But it interacts in non-trivial ways with other parts of `setup.py` (in particular, finding the data files), so this isn't ready yet.",
    "created_at": "2016-09-29T16:43:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317284",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment%3A8):
> If I'm to understand  correctly, this is mostly just taking the existing Cython build code and moving into the build_ext command, right?

Exactly. But it interacts in non-trivial ways with other parts of `setup.py` (in particular, finding the data files), so this isn't ready yet.



---

archive/issue_comments_317285.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nCould you be more specific?  I can probably help.",
    "created_at": "2016-09-30T09:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317285",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Could you be more specific?  I can probably help.



---

archive/issue_comments_317286.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWell, I haven't figured out precisely what to do with this part from `src/setup.py`:\n\n```python\nfrom sage_setup.find import find_python_sources, find_extra_files\npython_packages, python_modules = find_python_sources(\n    SAGE_SRC, ['sage', 'sage_setup'])\npython_data_files = find_extra_files(python_packages,\n    \".\", SAGE_CYTHONIZED, SAGE_LIB, [\"ntlwrap.cpp\"])\n```\n\nThis code determines some inputs to the `setup()` call, so logically it should come before calling `setup()`.\n\nOn the other hand, the last line assumes that Cython has run because it looks for files in `SAGE_CYTHONIZED`. So, if we run Cython in the `build_ext` command of `setup()` (what this ticket already implements), then we can no longer determine the `python_data_files` before calling `setup()`.",
    "created_at": "2016-09-30T10:19:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317286",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Well, I haven't figured out precisely what to do with this part from `src/setup.py`:

```python
from sage_setup.find import find_python_sources, find_extra_files
python_packages, python_modules = find_python_sources(
    SAGE_SRC, ['sage', 'sage_setup'])
python_data_files = find_extra_files(python_packages,
    ".", SAGE_CYTHONIZED, SAGE_LIB, ["ntlwrap.cpp"])
```

This code determines some inputs to the `setup()` call, so logically it should come before calling `setup()`.

On the other hand, the last line assumes that Cython has run because it looks for files in `SAGE_CYTHONIZED`. So, if we run Cython in the `build_ext` command of `setup()` (what this ticket already implements), then we can no longer determine the `python_data_files` before calling `setup()`.



---

archive/issue_comments_317287.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOne secret about distutils, which is both a bug and a feature--and the fact that it's often exploited is why it's so hard to change anything about distutils--is that in many cases it doesn't really matter what you pass to `setup()`.  It's mostly important for static metadata, but most other details about building the package can be tweaked in various places along the line (albeit sometimes requiring care).\n\nSo for example, the `data_files` passed to `setup()` is stored on the `Distribution` object in the `.data_files` attribute.  So this can be accessed from any *command* via `self.distribution.data_files`.  If a command, like `build_py` or `build_ext` is also responsible for generating files, some of which might result in installable resource files (for Cython modules this is mainly header files), it can also append those generated files, as appropriate, to `self.distribution.data_files` for later use.\n\nWhere this requires care is it's sometimes important to make sure you're using those attributes in ways that are compatible with how other commands use them, for which the best documentation is the source code (another misfeature).  `data_files` is an easy one because it's only used by a couple other commands, mainly `install`/`install_data`, and `sdist`.  This is easy because the `build` command is normally run automatically before `install`, so as long as the `build_ext` command updates the `data_files` appropriately they will be handled correctly.\n\n`sdist` is a little trickier--it does *not* normally run build first, though if you invoke `setup.py` with multiple commands it will work correctly (like `./setup.py build sdist`).  I normally subclass `sdist` to have it automatically run `build` first if I have Cython modules, because I also want to include the C sources in my source dist.  But I'm not too worried about that right now since `./setup.py sdist` doesn't work right for Sage for other reasons too.  That will be a separate issue.",
    "created_at": "2016-09-30T10:40:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317287",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

One secret about distutils, which is both a bug and a feature--and the fact that it's often exploited is why it's so hard to change anything about distutils--is that in many cases it doesn't really matter what you pass to `setup()`.  It's mostly important for static metadata, but most other details about building the package can be tweaked in various places along the line (albeit sometimes requiring care).

So for example, the `data_files` passed to `setup()` is stored on the `Distribution` object in the `.data_files` attribute.  So this can be accessed from any *command* via `self.distribution.data_files`.  If a command, like `build_py` or `build_ext` is also responsible for generating files, some of which might result in installable resource files (for Cython modules this is mainly header files), it can also append those generated files, as appropriate, to `self.distribution.data_files` for later use.

Where this requires care is it's sometimes important to make sure you're using those attributes in ways that are compatible with how other commands use them, for which the best documentation is the source code (another misfeature).  `data_files` is an easy one because it's only used by a couple other commands, mainly `install`/`install_data`, and `sdist`.  This is easy because the `build` command is normally run automatically before `install`, so as long as the `build_ext` command updates the `data_files` appropriately they will be handled correctly.

`sdist` is a little trickier--it does *not* normally run build first, though if you invoke `setup.py` with multiple commands it will work correctly (like `./setup.py build sdist`).  I normally subclass `sdist` to have it automatically run `build` first if I have Cython modules, because I also want to include the C sources in my source dist.  But I'm not too worried about that right now since `./setup.py sdist` doesn't work right for Sage for other reasons too.  That will be a separate issue.



---

archive/issue_comments_317288.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThanks a lot! I think I have enough information now to work on this.",
    "created_at": "2016-09-30T11:18:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317288",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Thanks a lot! I think I have enough information now to work on this.



---

archive/issue_comments_317289.json:
```json
{
    "body": "Changed commit from **[`35ecf4b`](https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81)** to **[`2b5fa98`](https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6)**",
    "created_at": "2016-10-04T11:21:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317289",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`35ecf4b`](https://github.com/sagemath/sagetrac-mirror/commit/35ecf4b0fca0c13dad3e38826fc33211bbd66c81)** to **[`2b5fa98`](https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6)**



---

archive/issue_comments_317290.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6\"><code>2b5fa98</code></a></td><td><code>Copy extra files to build directory instead of using data_files</code></td></tr></table>\n",
    "created_at": "2016-10-04T11:21:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317290",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6"><code>2b5fa98</code></a></td><td><code>Copy extra files to build directory instead of using data_files</code></td></tr></table>




---

archive/issue_comments_317291.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI'm not quite sure why you're not not using `data_files` at all, though for files installed with the Python modules themselves it's more customary to use `package_data` but that's neither here nor there.  I suspect the problem might have to do in part with oddity in how `find_extra_files` is expected to work.\n\nI'm not sure why the `dist.extra_files =` either.  There's no reason now to go assigning arbitrary *new* attributes to the Distribution instance.",
    "created_at": "2016-10-04T12:15:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317291",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

I'm not quite sure why you're not not using `data_files` at all, though for files installed with the Python modules themselves it's more customary to use `package_data` but that's neither here nor there.  I suspect the problem might have to do in part with oddity in how `find_extra_files` is expected to work.

I'm not sure why the `dist.extra_files =` either.  There's no reason now to go assigning arbitrary *new* attributes to the Distribution instance.



---

archive/issue_comments_317292.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@embray](#comment%3A15):\n> I'm not quite sure why you're not not using `data_files` at all\n\nI could have done that, but the usage of `data_files` in Sage has always been a bit fishy, see #20108. So given that I'm changing the data file handling anyway, I decided to stop using `data_files`.\n\n> though for files installed with the Python modules themselves it's more customary to use `package_data`\n\nThat doesn't work either: `package_data` assumes that the package data files are in the same directory as the Python sources. This is not the case for the Cython-generated files, so I cannot use `package_data`. But I am processing the data files similarly as what distutils does with `package_data`: copying them to the build directory. Since the data files appear in the build directory, they are automatically installed in `site-packages`.\n\n> I suspect the problem might have to do in part with oddity in how `find_extra_files` is expected to work.\n\nNo, we can always change `find_extra_files` to do whatever we want it to do.\n\n> I'm not sure why the `dist.extra_files =` either.  There's no reason now to go assigning arbitrary *new* attributes to the Distribution instance.\n\nThese `extra_files` are also needed for cleaning in the `sage_install` class. So I need to pass them somehow and assigning an attribute to the Distribution instance seemed like the most natural way.",
    "created_at": "2016-10-04T12:54:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317292",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@embray](#comment%3A15):
> I'm not quite sure why you're not not using `data_files` at all

I could have done that, but the usage of `data_files` in Sage has always been a bit fishy, see #20108. So given that I'm changing the data file handling anyway, I decided to stop using `data_files`.

> though for files installed with the Python modules themselves it's more customary to use `package_data`

That doesn't work either: `package_data` assumes that the package data files are in the same directory as the Python sources. This is not the case for the Cython-generated files, so I cannot use `package_data`. But I am processing the data files similarly as what distutils does with `package_data`: copying them to the build directory. Since the data files appear in the build directory, they are automatically installed in `site-packages`.

> I suspect the problem might have to do in part with oddity in how `find_extra_files` is expected to work.

No, we can always change `find_extra_files` to do whatever we want it to do.

> I'm not sure why the `dist.extra_files =` either.  There's no reason now to go assigning arbitrary *new* attributes to the Distribution instance.

These `extra_files` are also needed for cleaning in the `sage_install` class. So I need to pass them somehow and assigning an attribute to the Distribution instance seemed like the most natural way.



---

archive/issue_comments_317293.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60\"><code>7e3a492</code></a></td><td><code>Rename extra_files -> sage_extra_files</code></td></tr></table>\n",
    "created_at": "2016-10-04T13:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317293",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60"><code>7e3a492</code></a></td><td><code>Rename extra_files -> sage_extra_files</code></td></tr></table>




---

archive/issue_comments_317294.json:
```json
{
    "body": "Changed commit from **[`2b5fa98`](https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6)** to **[`7e3a492`](https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60)**",
    "created_at": "2016-10-04T13:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317294",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2b5fa98`](https://github.com/sagemath/sagetrac-mirror/commit/2b5fa98244c5d9f3481c7d15061e3e0f4c4b0ee6)** to **[`7e3a492`](https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60)**



---

archive/issue_events_300620.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T13:04:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300620"
}
```



---

archive/issue_comments_317295.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment%3A16):\n> Replying to [@embray](#comment%3A15):\n> > though for files installed with the Python modules themselves it's more customary to use `package_data`\n\n> \n> That doesn't work either: `package_data` assumes that the package data files are in the same directory as the Python sources. This is not the case for the Cython-generated files, so I cannot use `package_data`. But I am processing the data files similarly as what distutils does with `package_data`: copying them to the build directory. Since the data files appear in the build directory, they are automatically installed in `site-packages`.\n\nSince the purpose of `package_data` is specifically to list data files that should be installed in the Python packages, I think it makes sense to use anyways.  Normally this wouldn't be a problem even for Cython generated files, and the only reason it is is because we're handling those in a \"weird\" (to distutils) and unexpected way.  That's fine--I mean, I don't agree with it but it's not abhorrent or anything--we just need to make some tweaks to how `package_data` is handled so that it searches additional file hierarchies.\n\nBut for coherency I would rather use the existing option that is specifically for this purpose, and use our command subclasses to enhance its functionality to work for our purposes, rather than make up something entirely new.",
    "created_at": "2016-10-04T13:13:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317295",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment%3A16):
> Replying to [@embray](#comment%3A15):
> > though for files installed with the Python modules themselves it's more customary to use `package_data`

> 
> That doesn't work either: `package_data` assumes that the package data files are in the same directory as the Python sources. This is not the case for the Cython-generated files, so I cannot use `package_data`. But I am processing the data files similarly as what distutils does with `package_data`: copying them to the build directory. Since the data files appear in the build directory, they are automatically installed in `site-packages`.

Since the purpose of `package_data` is specifically to list data files that should be installed in the Python packages, I think it makes sense to use anyways.  Normally this wouldn't be a problem even for Cython generated files, and the only reason it is is because we're handling those in a "weird" (to distutils) and unexpected way.  That's fine--I mean, I don't agree with it but it's not abhorrent or anything--we just need to make some tweaks to how `package_data` is handled so that it searches additional file hierarchies.

But for coherency I would rather use the existing option that is specifically for this purpose, and use our command subclasses to enhance its functionality to work for our purposes, rather than make up something entirely new.



---

archive/issue_comments_317296.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,3 +2,5 @@\n \n This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py\n Unfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.\n+\n+Due to a [Cython bug](https://github.com/cython/cython/pull/1476), this warning gets displayed even though the `cache` option is valid: `UserWarning: got unknown compilation option, please remove: cache`.\n``````\n",
    "created_at": "2016-10-04T13:30:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317296",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,3 +2,5 @@
 
 This is inspired by the `build_ext` from Cython 0.25: https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py
 Unfortunately, we cannot really use that since it doesn't allow to pass options to `cythonize()`.
+
+Due to a [Cython bug](https://github.com/cython/cython/pull/1476), this warning gets displayed even though the `cache` option is valid: `UserWarning: got unknown compilation option, please remove: cache`.
``````




---

archive/issue_comments_317297.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@embray](#comment%3A19):\n> we just need to make some tweaks to how package_data is handled so that it searches additional file hierarchies.\n\nThere is another issue: `package_data` is handled in the `build_py` command, which happens *before* `build_ext`, which runs Cython. So even if you manage to handle the Cython-generated files using `package_data`, you either need to reorder the `build` subcommands or you need to run Cython in `build_py`.\n\n> But for coherency I would rather use the existing option that is specifically for this purpose\n\nYou mean: going back to use `data_files`?",
    "created_at": "2016-10-04T13:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317297",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@embray](#comment%3A19):
> we just need to make some tweaks to how package_data is handled so that it searches additional file hierarchies.

There is another issue: `package_data` is handled in the `build_py` command, which happens *before* `build_ext`, which runs Cython. So even if you manage to handle the Cython-generated files using `package_data`, you either need to reorder the `build` subcommands or you need to run Cython in `build_py`.

> But for coherency I would rather use the existing option that is specifically for this purpose

You mean: going back to use `data_files`?



---

archive/issue_comments_317298.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI see, that's a bit annoying. I'm surprised I haven't run into that before.  If I have I don't know what solution I used--maybe just manually copying the generated Cython files to the appropriate build path.  It would still not be a bad idea to add relevant entries to `package_data` though since that's also used by the `sdist` command to ensure that all those files are included in the source tarball (though this can also be achieved simply with the correct MANIFEST.in rule).\n\nLooking at the source again, I think the simplest thing to do would be after Cythonization to copy the appropriate generated files to the appropriate build/ directory (basically emulating what `build_py.build_package_data` is doing, which you basically already have.  But then also add entries for either of:\n\n1. `self.get_finalized_command('build_py').data_files or\n2. `self.distribution.data_files\n\nThe former is the same as if those files were included in `package_data` in the first place.\n\n\nAn alternative I kind of like, but that's more complicated, is to make cythonize and entirely separate command (`build_cython` or something) and insert that into the front of the `build` command's sub-commands.  But that's more complicated and probably not worth it for now.\n\nMy only real problem at this point is with the new attribute you're tacking on.  It seems easily avoidable.",
    "created_at": "2016-10-05T10:06:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317298",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

I see, that's a bit annoying. I'm surprised I haven't run into that before.  If I have I don't know what solution I used--maybe just manually copying the generated Cython files to the appropriate build path.  It would still not be a bad idea to add relevant entries to `package_data` though since that's also used by the `sdist` command to ensure that all those files are included in the source tarball (though this can also be achieved simply with the correct MANIFEST.in rule).

Looking at the source again, I think the simplest thing to do would be after Cythonization to copy the appropriate generated files to the appropriate build/ directory (basically emulating what `build_py.build_package_data` is doing, which you basically already have.  But then also add entries for either of:

1. `self.get_finalized_command('build_py').data_files or
2. `self.distribution.data_files

The former is the same as if those files were included in `package_data` in the first place.


An alternative I kind of like, but that's more complicated, is to make cythonize and entirely separate command (`build_cython` or something) and insert that into the front of the `build` command's sub-commands.  But that's more complicated and probably not worth it for now.

My only real problem at this point is with the new attribute you're tacking on.  It seems easily avoidable.



---

archive/issue_comments_317299.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@embray](#comment%3A22):\n> My only real problem at this point is with the new attribute you're tacking on.\n\nSeriously, why is that a problem? I even explicitly added a `sage_` prefix.",
    "created_at": "2016-10-05T11:48:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317299",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@embray](#comment%3A22):
> My only real problem at this point is with the new attribute you're tacking on.

Seriously, why is that a problem? I even explicitly added a `sage_` prefix.



---

archive/issue_comments_317300.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@embray](#comment%3A22):\n> I see, that's a bit annoying. I'm surprised I haven't run into that before.  If I have I don't know what solution I used--maybe just manually copying the generated Cython files to the appropriate build path.  It would still not be a bad idea to add relevant entries to `package_data` though since that's also used by the `sdist` command to ensure that all those files are included in the source tarball (though this can also be achieved simply with the correct MANIFEST.in rule).\n> \n> Looking at the source again, I think the simplest thing to do would be after Cythonization to copy the appropriate generated files to the appropriate build/ directory (basically emulating what `build_py.build_package_data` is doing, which you basically already have.  But then also add entries for either of:\n> \n> 1. `self.get_finalized_command('build_py').data_files or\n> 2. `self.distribution.data_files\n> \n> The former is the same as if those files were included in `package_data` in the first place.\n\nDo you want me to make those changes here? Or do you accept the current code on this branch and should we leave that for another ticket?",
    "created_at": "2016-10-05T11:51:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317300",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@embray](#comment%3A22):
> I see, that's a bit annoying. I'm surprised I haven't run into that before.  If I have I don't know what solution I used--maybe just manually copying the generated Cython files to the appropriate build path.  It would still not be a bad idea to add relevant entries to `package_data` though since that's also used by the `sdist` command to ensure that all those files are included in the source tarball (though this can also be achieved simply with the correct MANIFEST.in rule).
> 
> Looking at the source again, I think the simplest thing to do would be after Cythonization to copy the appropriate generated files to the appropriate build/ directory (basically emulating what `build_py.build_package_data` is doing, which you basically already have.  But then also add entries for either of:
> 
> 1. `self.get_finalized_command('build_py').data_files or
> 2. `self.distribution.data_files
> 
> The former is the same as if those files were included in `package_data` in the first place.

Do you want me to make those changes here? Or do you accept the current code on this branch and should we leave that for another ticket?



---

archive/issue_comments_317301.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment%3A23):\n> Replying to [@embray](#comment%3A22):\n> > My only real problem at this point is with the new attribute you're tacking on.\n\n> \n> Seriously, why is that a problem? I even explicitly added a `sage_` prefix.\n\n1) Because it's not at all clear why it's even necessary, and it only confuses things.\n\n2) Just because distutils is \"meant to be\" tinkered with in a flexible manner, monkeypatching the `Distribution` option is definitely an anti-pattern.  More commonly, if some command has some data it would like to share with other commands, the pattern is to add an attribute to that command instead (and usually at least initialize that attribute with a default value in the `finalize_command` method).  Then, if other commands need that data, they would first ensure that the command it comes from is finalized, and may also run that command if necessary (using `self.distribution.run_command`, which doesn't run the command a second time if it has already been run).  That way if command `B` uses `A.data`, it ensures that `A.data` has been generated first.\n\nI'm just looking out for distutils being used the way it's intended.  This is unfortunately very undocumented, but if you spend enough time in it you'll see that there are various conventions that are best to follow.  That said, I don't see why you need to add this in the first place.",
    "created_at": "2016-10-05T14:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317301",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment%3A23):
> Replying to [@embray](#comment%3A22):
> > My only real problem at this point is with the new attribute you're tacking on.

> 
> Seriously, why is that a problem? I even explicitly added a `sage_` prefix.

1) Because it's not at all clear why it's even necessary, and it only confuses things.

2) Just because distutils is "meant to be" tinkered with in a flexible manner, monkeypatching the `Distribution` option is definitely an anti-pattern.  More commonly, if some command has some data it would like to share with other commands, the pattern is to add an attribute to that command instead (and usually at least initialize that attribute with a default value in the `finalize_command` method).  Then, if other commands need that data, they would first ensure that the command it comes from is finalized, and may also run that command if necessary (using `self.distribution.run_command`, which doesn't run the command a second time if it has already been run).  That way if command `B` uses `A.data`, it ensures that `A.data` has been generated first.

I'm just looking out for distutils being used the way it's intended.  This is unfortunately very undocumented, but if you spend enough time in it you'll see that there are various conventions that are best to follow.  That said, I don't see why you need to add this in the first place.



---

archive/issue_comments_317302.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@embray](#comment%3A25):\n> Because it's not at all clear why it's even necessary, and it only confuses things.\n\nIt's necessary because I need that list of files in more than one place.",
    "created_at": "2016-10-05T14:31:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317302",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@embray](#comment%3A25):
> Because it's not at all clear why it's even necessary, and it only confuses things.

It's necessary because I need that list of files in more than one place.



---

archive/issue_comments_317303.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nHmmm...I think I can appreciate what the `clean_stale_files` stuff is for.  In most projects I would just blow away the `build` directory, or just individual files in it if applicable.  But sage is so large this is a real pain to do--that's something which itself could use a better approach but that's well beyond this ticket.\n\nI don't think that should just happen when you \"install\" though, but really prior to any build.",
    "created_at": "2016-10-05T14:50:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317303",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

Hmmm...I think I can appreciate what the `clean_stale_files` stuff is for.  In most projects I would just blow away the `build` directory, or just individual files in it if applicable.  But sage is so large this is a real pain to do--that's something which itself could use a better approach but that's well beyond this ticket.

I don't think that should just happen when you "install" though, but really prior to any build.



---

archive/issue_comments_317304.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@embray](#comment%3A27):\n> Hmmm...I think I can appreciate what the `clean_stale_files` stuff is for.\n\nThis isn't part of this ticket, but #21604.",
    "created_at": "2016-10-05T14:59:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317304",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@embray](#comment%3A27):
> Hmmm...I think I can appreciate what the `clean_stale_files` stuff is for.

This isn't part of this ticket, but #21604.



---

archive/issue_comments_317305.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI've tested it (on top of 7.4.beta6), and it seems to work for me. \nErik, objections to setting this ticket to \"positive review\"?",
    "created_at": "2016-10-07T22:04:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317305",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

I've tested it (on top of 7.4.beta6), and it seems to work for me. 
Erik, objections to setting this ticket to "positive review"?



---

archive/issue_comments_317306.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2016-10-07T22:04:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317306",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_317307.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@embray](#comment%3A25):\n> 2) Just because distutils is \"meant to be\" tinkered with in a flexible manner, monkeypatching the `Distribution` option is definitely an anti-pattern.\n\nAdding attributes to a class is a completely normal thing when subclassing. In this case, I could make a trivial subclass\n\n```\nclass SageDistribution(Distribution):\n    pass\n```\nand define that `SageDistribution` supports a `sage_extra_files` attribute. Because of the way Python works though, there is no need for such a subclass.\n\nSo, I still don't get why it's perfectly fine to have `dist.data_files` (what `distutils` itself uses) but not `dist.sage_extra_files`. They serve very analogous purposes, so why not implement them analogously?",
    "created_at": "2016-10-08T08:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317307",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@embray](#comment%3A25):
> 2) Just because distutils is "meant to be" tinkered with in a flexible manner, monkeypatching the `Distribution` option is definitely an anti-pattern.

Adding attributes to a class is a completely normal thing when subclassing. In this case, I could make a trivial subclass

```
class SageDistribution(Distribution):
    pass
```
and define that `SageDistribution` supports a `sage_extra_files` attribute. Because of the way Python works though, there is no need for such a subclass.

So, I still don't get why it's perfectly fine to have `dist.data_files` (what `distutils` itself uses) but not `dist.sage_extra_files`. They serve very analogous purposes, so why not implement them analogously?



---

archive/issue_comments_317308.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nPlease--you don't have to explain to me how Python works.\n\nThe point I'm trying to make is that the way you're doing this is antithetical to the common programming patterns used specifically in the context of writing distutils commands.  I'm *still* not convinced that you *need* this extra attribute at all.  But for now I'd be satisfied if it were implemented as I described above.  If that's not clear I'll just do it.",
    "created_at": "2016-10-10T12:45:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317308",
    "user": "https://github.com/embray"
}
```

<div id="comment:31" align="right">comment:31</div>

Please--you don't have to explain to me how Python works.

The point I'm trying to make is that the way you're doing this is antithetical to the common programming patterns used specifically in the context of writing distutils commands.  I'm *still* not convinced that you *need* this extra attribute at all.  But for now I'd be satisfied if it were implemented as I described above.  If that's not clear I'll just do it.



---

archive/issue_comments_317309.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@embray](#comment%3A31):\n> Please--you don't have to explain to me how Python works.\n\nOf course I don't need to explain Python. I wanted to explain the philosophy behind what I was doing.\n\n> I'm *still* not convinced that you *need* this extra attribute at all.\n\nAnd I'm *still* not convinced that what I'm doing is somehow wrong.\n\n> But for now I'd be satisfied if it were implemented as I described above.\n\nI'll try it.",
    "created_at": "2016-10-10T12:54:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317309",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@embray](#comment%3A31):
> Please--you don't have to explain to me how Python works.

Of course I don't need to explain Python. I wanted to explain the philosophy behind what I was doing.

> I'm *still* not convinced that you *need* this extra attribute at all.

And I'm *still* not convinced that what I'm doing is somehow wrong.

> But for now I'd be satisfied if it were implemented as I described above.

I'll try it.



---

archive/issue_comments_317310.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nBTW I should add--if what I suggested is *not* clear that's of course my fault for explaining poorly.  My point is that it's not good practice *in general* to use classes as dumping grounds for arbitrary attributes.  Python allows it, sure, but it's almost always confusing and error-prone.  For example it's possible to run the \"install\" command *without* running \"build_py\" first, in which case you'll get an attribute error.  There are myriad little corner cases like that in distutils.\n\nI think instead of \"sage_extra_files\" it might be fine to call this \"cythonized_files\" or something like that, and have it be an attribute of the custom \"build_ext\".  That way it's clearer exactly what this is about (and that the only reason it needs to exist at all is due to how we're putting the cythonized files in a separate, parallel directory structure).",
    "created_at": "2016-10-10T13:02:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317310",
    "user": "https://github.com/embray"
}
```

<div id="comment:33" align="right">comment:33</div>

BTW I should add--if what I suggested is *not* clear that's of course my fault for explaining poorly.  My point is that it's not good practice *in general* to use classes as dumping grounds for arbitrary attributes.  Python allows it, sure, but it's almost always confusing and error-prone.  For example it's possible to run the "install" command *without* running "build_py" first, in which case you'll get an attribute error.  There are myriad little corner cases like that in distutils.

I think instead of "sage_extra_files" it might be fine to call this "cythonized_files" or something like that, and have it be an attribute of the custom "build_ext".  That way it's clearer exactly what this is about (and that the only reason it needs to exist at all is due to how we're putting the cythonized files in a separate, parallel directory structure).



---

archive/issue_comments_317311.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee\"><code>dfcd817</code></a></td><td><code>extra_files -> sage_build_ext.cythonized_files</code></td></tr></table>\n",
    "created_at": "2016-10-10T15:51:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317311",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee"><code>dfcd817</code></a></td><td><code>extra_files -> sage_build_ext.cythonized_files</code></td></tr></table>




---

archive/issue_comments_317312.json:
```json
{
    "body": "Changed commit from **[`7e3a492`](https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60)** to **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**",
    "created_at": "2016-10-10T15:51:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317312",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7e3a492`](https://github.com/sagemath/sagetrac-mirror/commit/7e3a492edaa54fc9c724d183534d27d171c8cf60)** to **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**



---

archive/issue_comments_317313.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nNeeds review.",
    "created_at": "2016-10-10T15:53:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317313",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

Needs review.



---

archive/issue_comments_317314.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nThis looks along the right lines.  It occurs to me there's something kind of problematic here, which is that it runs `run_cython` in `finalize_command`.  `finalize_command` is basically supposed to be like an `__init__`--it should just set default values for things and not actually have much in the way of side-effects.\n\n`run_cython()` should happen at the beginning of the `run()`.  `finalize_command` should just set `cythonized_files` to a default value (such as an empty list or `None`).  I think I see why you did things the way you did--you wanted to make sure one way or another that `find_extra_files` was run.  I might instead move the `find_extra_files` call into a method on `build_ext` (such as `find_cythonized_files()` or something).  When called after `run_cython()` that could update the `cythonized_files` attribute, and then be used to copy the files.  But from the install command you would just called `find_cythonized_files()` if `cythonized_files` isn't already set.",
    "created_at": "2016-10-10T16:26:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317314",
    "user": "https://github.com/embray"
}
```

<div id="comment:36" align="right">comment:36</div>

This looks along the right lines.  It occurs to me there's something kind of problematic here, which is that it runs `run_cython` in `finalize_command`.  `finalize_command` is basically supposed to be like an `__init__`--it should just set default values for things and not actually have much in the way of side-effects.

`run_cython()` should happen at the beginning of the `run()`.  `finalize_command` should just set `cythonized_files` to a default value (such as an empty list or `None`).  I think I see why you did things the way you did--you wanted to make sure one way or another that `find_extra_files` was run.  I might instead move the `find_extra_files` call into a method on `build_ext` (such as `find_cythonized_files()` or something).  When called after `run_cython()` that could update the `cythonized_files` attribute, and then be used to copy the files.  But from the install command you would just called `find_cythonized_files()` if `cythonized_files` isn't already set.



---

archive/issue_comments_317315.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSomething like\n\n```python\nclass sage_build_ext(build_ext):\n    def finalize_options(self):\n        ...\n        self.cythonized_files = None\n\n    def run(self):\n        self.run_cython()\n\n        # The following two lines, or the equivalent thereof, could be called\n        # directly from run_cython() too\n        self.find_cythonized_files()\n        self.copy_cythonized_files()\n        build_ext.run(self)\n\n    def find_cythonized_files(self):\n        if self.cythonized_files is None:\n            ...\n            self.cythonized_files = ...\n\n\nclass sage_install(install):\n    def clean_stale_files(self):\n        ...\n        cmd_build_ext = self.get_finalized_command('build_ext')\n        cmd.find_cythonized_files()\n\n        # Do stuff with cmd.find_cythonized_files()\n```\n\nAnd the rest pretty much exactly as you have it.  Would that work?\n\nIt's not pretty but with distutils you have to write code like you're writing for Python 2.1 or something :)",
    "created_at": "2016-10-10T16:35:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317315",
    "user": "https://github.com/embray"
}
```

<div id="comment:37" align="right">comment:37</div>

Something like

```python
class sage_build_ext(build_ext):
    def finalize_options(self):
        ...
        self.cythonized_files = None

    def run(self):
        self.run_cython()

        # The following two lines, or the equivalent thereof, could be called
        # directly from run_cython() too
        self.find_cythonized_files()
        self.copy_cythonized_files()
        build_ext.run(self)

    def find_cythonized_files(self):
        if self.cythonized_files is None:
            ...
            self.cythonized_files = ...


class sage_install(install):
    def clean_stale_files(self):
        ...
        cmd_build_ext = self.get_finalized_command('build_ext')
        cmd.find_cythonized_files()

        # Do stuff with cmd.find_cythonized_files()
```

And the rest pretty much exactly as you have it.  Would that work?

It's not pretty but with distutils you have to write code like you're writing for Python 2.1 or something :)



---

archive/issue_comments_317316.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@embray](#comment%3A36):\n> This looks along the right lines.  It occurs to me there's something kind of problematic here, which is that it runs `run_cython` in `finalize_command`.\n\nThat's exactly what [upstream Cython 0.25](https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py) does (which was the inspiration for this ticket), so I'm not inclined to change this.",
    "created_at": "2016-10-10T18:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317316",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@embray](#comment%3A36):
> This looks along the right lines.  It occurs to me there's something kind of problematic here, which is that it runs `run_cython` in `finalize_command`.

That's exactly what [upstream Cython 0.25](https://github.com/cython/cython/blob/master/Cython/Distutils/build_ext.py) does (which was the inspiration for this ticket), so I'm not inclined to change this.



---

archive/issue_comments_317317.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nErik, on this ticket (and elsewhere) you have mentioned various subtle issues of `setup.py` commands and their interaction. I've opened ticket #21678 (Testsuite for src/setup.py) to formalize this, and to make sure that everything that is implemented correctly on the present ticket, according to your comments, will not be lost by regressions in the future.",
    "created_at": "2016-10-10T19:51:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317317",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">comment:39</div>

Erik, on this ticket (and elsewhere) you have mentioned various subtle issues of `setup.py` commands and their interaction. I've opened ticket #21678 (Testsuite for src/setup.py) to formalize this, and to make sure that everything that is implemented correctly on the present ticket, according to your comments, will not be lost by regressions in the future.



---

archive/issue_comments_317318.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nThen I'll have to bother upstream Cython about this.  There may be a reason they're doing it that way, but it doesn't make a lot of sense on its face.\n\nThe point of `finalize_command` is to initialize any options / set up defaults, not actually *do* anything.  \"But they do it\" is not a good reason if we don't know why they're doing it.",
    "created_at": "2016-10-11T09:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317318",
    "user": "https://github.com/embray"
}
```

<div id="comment:40" align="right">comment:40</div>

Then I'll have to bother upstream Cython about this.  There may be a reason they're doing it that way, but it doesn't make a lot of sense on its face.

The point of `finalize_command` is to initialize any options / set up defaults, not actually *do* anything.  "But they do it" is not a good reason if we don't know why they're doing it.



---

archive/issue_comments_317319.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nIf I had to guess, the reason they're doing it that way is because of how the \"sdist\" command uses the \"build_ext\" command to get a list of source files to include in the sdist.  I think the right way to do that is not really to run `cythonize()` in the `finalize_command()` method, but rather to modify the `sdist` command so that it runs `cythonize()` as a sub-command.",
    "created_at": "2016-10-11T09:20:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317319",
    "user": "https://github.com/embray"
}
```

<div id="comment:41" align="right">comment:41</div>

If I had to guess, the reason they're doing it that way is because of how the "sdist" command uses the "build_ext" command to get a list of source files to include in the sdist.  I think the right way to do that is not really to run `cythonize()` in the `finalize_command()` method, but rather to modify the `sdist` command so that it runs `cythonize()` as a sub-command.



---

archive/issue_comments_317320.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@embray](#comment%3A40):\n> Then I'll have to bother upstream Cython about this.\n\nPlease do that.",
    "created_at": "2016-10-11T09:49:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317320",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@embray](#comment%3A40):
> Then I'll have to bother upstream Cython about this.

Please do that.



---

archive/issue_comments_317321.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@jdemeyer](#comment%3A42):\n> Replying to [@embray](#comment%3A40):\n> > Then I'll have to bother upstream Cython about this.\n\n> \n> Please do that.\n\nI will try to work with them more closely on that.\n\nIn the interest of harmony and in making progress, if this is *working* for you as is, then I give it a positive review.  I'll open a separate ticket with my ideas for how to build on this to make it a bit cleaner, but I don't think it's *bad* as is as long as it works.  I just know we can do better.",
    "created_at": "2016-10-11T11:32:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317321",
    "user": "https://github.com/embray"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@jdemeyer](#comment%3A42):
> Replying to [@embray](#comment%3A40):
> > Then I'll have to bother upstream Cython about this.

> 
> Please do that.

I will try to work with them more closely on that.

In the interest of harmony and in making progress, if this is *working* for you as is, then I give it a positive review.  I'll open a separate ticket with my ideas for how to build on this to make it a bit cleaner, but I don't think it's *bad* as is as long as it works.  I just know we can do better.



---

archive/issue_comments_317322.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe** to **Matthias Koeppe, Erik Bray**",
    "created_at": "2016-10-11T12:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317322",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Matthias Koeppe** to **Matthias Koeppe, Erik Bray**



---

archive/issue_comments_317323.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nI'll let the other reviewer (Matthias Koeppe) decide on giving positive review.",
    "created_at": "2016-10-11T12:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317323",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:44" align="right">comment:44</div>

I'll let the other reviewer (Matthias Koeppe) decide on giving positive review.



---

archive/issue_comments_317324.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nSee #21682",
    "created_at": "2016-10-11T15:31:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317324",
    "user": "https://github.com/embray"
}
```

<div id="comment:45" align="right">comment:45</div>

See #21682



---

archive/issue_events_300621.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-10-11T17:50:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300621"
}
```



---

archive/issue_events_300622.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-10-11T17:50:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300622"
}
```



---

archive/issue_comments_317325.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nTested on top of 7.4.rc0.",
    "created_at": "2016-10-11T17:50:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317325",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:46" align="right">comment:46</div>

Tested on top of 7.4.rc0.



---

archive/issue_events_300623.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300623"
}
```



---

archive/issue_events_300624.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "b8890d89d183e9c1c1a813f707dd66c88a2e654b",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-10-21T07:03:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21600#event-300624"
}
```



---

archive/issue_comments_317326.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/21600](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/21600)** to **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**",
    "created_at": "2016-10-21T07:03:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21600#issuecomment-317326",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/ticket/21600](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/21600)** to **[`dfcd817`](https://github.com/sagemath/sagetrac-mirror/commit/dfcd8177447c7eab491569f08777f585deda93ee)**
