# Issue 21480: Make sagelib setup.py self-contained and independent of SAGE_ROOT

archive/issues_021243.json:
```json
{
    "body": "This ticket changes the build process of sagelib in the following way:\n- `src/Makefile` delegates ALL building to `src/setup.py`\n- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n\nThis ticket is meant as:\n- preparation for VPATH builds of sage-the-distribution (#21469)\n- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n- making the flow of directory information at build time clearer for developers\n\n More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n\n. . . . . . . \n\nSome possibly useful information:\n- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n\n**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-185.tar.gz\n\nCC:  felixs @jdemeyer @kiwifb @embray @nexttime @vbraun @dimpase @jhpalmieri @videlec @saraedum @seblabbe @nthiery @mezzarobba\n\nBranch/Commit: 0c2ac9583ed97ffc74e99c876a8cf4506f5b0162\n\nReviewer: Jeroen Demeyer\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21480\n\n",
    "closed_at": "2016-10-12T06:53:25Z",
    "created_at": "2016-09-12T22:00:56Z",
    "labels": [
        "component: build",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Make sagelib setup.py self-contained and independent of SAGE_ROOT",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21480",
    "user": "https://github.com/mkoeppe"
}
```
This ticket changes the build process of sagelib in the following way:
- `src/Makefile` delegates ALL building to `src/setup.py`
- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.

This ticket is meant as:
- preparation for VPATH builds of sage-the-distribution (#21469)
- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
- making the flow of directory information at build time clearer for developers

 More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)

. . . . . . . 

Some possibly useful information:
- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
 `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.

**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-185.tar.gz

CC:  felixs @jdemeyer @kiwifb @embray @nexttime @vbraun @dimpase @jhpalmieri @videlec @saraedum @seblabbe @nthiery @mezzarobba

Branch/Commit: 0c2ac9583ed97ffc74e99c876a8cf4506f5b0162

Reviewer: Jeroen Demeyer

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21480





---

archive/issue_comments_313526.json:
```json
{
    "body": "<a id='comment:1'></a>Am interesting issue is that technically `cython_debug` has to be installed somewhere (preferably somewhere standard) to be accessible at runtime separately from the source. \n\nI do something in sage-on-gentoo but that's not really satisfactory.",
    "created_at": "2016-09-12T22:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313526",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>Am interesting issue is that technically `cython_debug` has to be installed somewhere (preferably somewhere standard) to be accessible at runtime separately from the source. 

I do something in sage-on-gentoo but that's not really satisfactory.



---

archive/issue_comments_313527.json:
```json
{
    "body": "Replying to [ticket:21480 mkoeppe]:\n> In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`\n\n\nPlease use `--build-base=$SAGE_BUILD_DIR/sagelib`.",
    "created_at": "2016-09-12T22:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313527",
    "user": "https://github.com/nexttime"
}
```

Replying to [ticket:21480 mkoeppe]:
> In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`


Please use `--build-base=$SAGE_BUILD_DIR/sagelib`.



---

archive/issue_comments_313528.json:
```json
{
    "body": "<a id='comment:3'></a>... and `sagelib` perhaps with a version suffix.",
    "created_at": "2016-09-12T22:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313528",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>... and `sagelib` perhaps with a version suffix.



---

archive/issue_comments_313529.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:2 leif]:\n> Replying to [ticket:21480 mkoeppe]:\n> > In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`\n\n> \n> Please use `--build-base=$SAGE_BUILD_DIR/sagelib`.\n\n\nYes, the plan *after* #21469 is to use the Sage builddir -- not just for sagelib, but also for other packages.\n\n*Before* #21469 is merged, I want to use `$SAGE_ROOT/var/tmp/sage/build/sagelib` to match what other packages do.",
    "created_at": "2016-09-12T22:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313529",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Replying to [comment:2 leif]:
> Replying to [ticket:21480 mkoeppe]:
> > In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`

> 
> Please use `--build-base=$SAGE_BUILD_DIR/sagelib`.


Yes, the plan *after* #21469 is to use the Sage builddir -- not just for sagelib, but also for other packages.

*Before* #21469 is merged, I want to use `$SAGE_ROOT/var/tmp/sage/build/sagelib` to match what other packages do.



---

archive/issue_comments_313530.json:
```json
{
    "body": "<a id='comment:5'></a>Ah, I see what you meant, now I've found $SAGE_BUILD_DIR. Changed description accordingly.",
    "created_at": "2016-09-12T22:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313530",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Ah, I see what you meant, now I've found $SAGE_BUILD_DIR. Changed description accordingly.



---

archive/issue_comments_313531.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,9 @@\n Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. \n \n-In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`\n+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib-VERSION`\n+\n+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-12T22:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313531",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,9 @@
 Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. 
 
-In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`
+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib-VERSION`
+
+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)
+
 
 Comment: 1
 
``````




---

archive/issue_comments_313532.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 mkoeppe]:\n> Replying to [comment:2 leif]:\n> > Replying to [ticket:21480 mkoeppe]:\n> > > In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`\n\n> > \n> > Please use `--build-base=$SAGE_BUILD_DIR/sagelib`.\n\n> \n> Yes, the plan *after* #21469 is to use the Sage builddir -- not just for sagelib, but also for other packages.\n\n\n??? `SAGE_BUILD_DIR` exists since years already...  (Its *default* is `$SAGE_ROOT/var/tmp/sage/build/`.)\n\n\\\\\n\n> *Before* #21469 is merged, I want to use `$SAGE_ROOT/var/tmp/sage/build/sagelib` to match what other packages do.",
    "created_at": "2016-09-12T22:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313532",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>Replying to [comment:4 mkoeppe]:
> Replying to [comment:2 leif]:
> > Replying to [ticket:21480 mkoeppe]:
> > > In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_ROOT/var/tmp/sage/build/sagelib`

> > 
> > Please use `--build-base=$SAGE_BUILD_DIR/sagelib`.

> 
> Yes, the plan *after* #21469 is to use the Sage builddir -- not just for sagelib, but also for other packages.


??? `SAGE_BUILD_DIR` exists since years already...  (Its *default* is `$SAGE_ROOT/var/tmp/sage/build/`.)

\\

> *Before* #21469 is merged, I want to use `$SAGE_ROOT/var/tmp/sage/build/sagelib` to match what other packages do.



---

archive/issue_comments_313533.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 leif]:\n> ??? `SAGE_BUILD_DIR` exists since years already...  (Its *default* is `$SAGE_ROOT/var/tmp/sage/build/`.)\n\n\nYes, thanks, see my other comment.",
    "created_at": "2016-09-12T22:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313533",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Replying to [comment:6 leif]:
> ??? `SAGE_BUILD_DIR` exists since years already...  (Its *default* is `$SAGE_ROOT/var/tmp/sage/build/`.)


Yes, thanks, see my other comment.



---

archive/issue_comments_313534.json:
```json
{
    "body": "<a id='comment:8'></a>Ah ok, race condition.",
    "created_at": "2016-09-12T22:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313534",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>Ah ok, race condition.



---

archive/issue_comments_313535.json:
```json
{
    "body": "<a id='comment:9'></a>By the way, help with implementing this change would be appreciated. I haven't looked at the sagelib build system at all so far.",
    "created_at": "2016-09-12T22:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313535",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>By the way, help with implementing this change would be appreciated. I haven't looked at the sagelib build system at all so far.



---

archive/issue_comments_313536.json:
```json
{
    "body": "<a id='comment:11'></a>New commits:",
    "created_at": "2016-09-13T16:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313536",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>New commits:



---

archive/issue_comments_313537.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. \n \n+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib-VERSION`\n+\n+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)\n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages). However, there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-13T19:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313537",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. 
 
+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib-VERSION`
+
+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages). However, there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313538.json:
```json
{
    "body": "<a id='comment:13'></a>Really `sagelib-$SAGE_VERSION`? Do you want to fill up everybody's hard disks with Sage build directories? Not to mention that this would require to rebuild everything whenever the Sage version changes.",
    "created_at": "2016-09-13T20:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313538",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Really `sagelib-$SAGE_VERSION`? Do you want to fill up everybody's hard disks with Sage build directories? Not to mention that this would require to rebuild everything whenever the Sage version changes.



---

archive/issue_comments_313539.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. \n \n+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`\n+\n+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)\n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages). However, there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-13T20:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313539",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. 
 
+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`
+
+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages). However, there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313540.json:
```json
{
    "body": "<a id='comment:15'></a>Fine with me without $SAGE_VERSION; I was just following leif's suggestion in comment 3.",
    "created_at": "2016-09-13T20:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313540",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Fine with me without $SAGE_VERSION; I was just following leif's suggestion in comment 3.



---

archive/issue_comments_313541.json:
```json
{
    "body": "<a id='comment:16'></a>i understand that SAGE_BUILD_DIR is the srcdir for toplevel configure.\n\nas long as sagelib is rooted in $(toplevel)/src, it might be less confusing to choose $SAGE_BUILD_DIR/src (not $SAGE_BUILD_DIR/sagelib) as the builddir for sagelib.\n\n(future: replace src by sagelib, but on both ends)\n\ni dont know exactly how the approach using setup.py will emulate VPATH builds. i think it should imitate \"what automake would do\", where applicable.",
    "created_at": "2016-09-13T20:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313541",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:16'></a>i understand that SAGE_BUILD_DIR is the srcdir for toplevel configure.

as long as sagelib is rooted in $(toplevel)/src, it might be less confusing to choose $SAGE_BUILD_DIR/src (not $SAGE_BUILD_DIR/sagelib) as the builddir for sagelib.

(future: replace src by sagelib, but on both ends)

i dont know exactly how the approach using setup.py will emulate VPATH builds. i think it should imitate "what automake would do", where applicable.



---

archive/issue_comments_313542.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 felixs]:\n> i understand that SAGE_BUILD_DIR is the srcdir for toplevel configure.\n\n\nNo, it's $SAGE_ROOT/var/tmp/sage/build/",
    "created_at": "2016-09-13T20:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313542",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:16 felixs]:
> i understand that SAGE_BUILD_DIR is the srcdir for toplevel configure.


No, it's $SAGE_ROOT/var/tmp/sage/build/



---

archive/issue_comments_313543.json:
```json
{
    "body": "<a id='comment:18'></a>ok, nevermind (i meant to write \"SAGE_BUILD_DIR is the *builddir* for toplevel\"). that does not seem to be the case either.\n\nstill i am wondering why \"src\" does not (simply) translate to \"src\". (sure, i am slightly autotools biased).",
    "created_at": "2016-09-13T22:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313543",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:18'></a>ok, nevermind (i meant to write "SAGE_BUILD_DIR is the *builddir* for toplevel"). that does not seem to be the case either.

still i am wondering why "src" does not (simply) translate to "src". (sure, i am slightly autotools biased).



---

archive/issue_comments_313544.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-14T01:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313545.json:
```json
{
    "body": "<a id='comment:20'></a>Here's a first version for review. It seems to work for me.\n\nThere are still some to-do items (see comments in `src/Makefile`):\n\n- I am now using `--build-base`, but setup.sh also depends on `SAGE_CYTHONIZED`, defined in `src/sage/env.py`.\n\n I think it would be better if `setup.sh` instead inferred that location from the build-base that was passed to it. \n\n However, setup.sh already does a lot of stuff depending on `SAGE_CYTHONIZED` before `distutils.core.setup` is even called.\n Can this be fixed?\n\n I think I could use some help from the Python experts in the cc list of this ticket on this.\n\n- `sage/libs/pari/auto_gen.pxi` and `sage/ext/interpreters/__init__.py` still need to be taken care of in preparation for the VPATH build.",
    "created_at": "2016-09-14T02:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313545",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Here's a first version for review. It seems to work for me.

There are still some to-do items (see comments in `src/Makefile`):

- I am now using `--build-base`, but setup.sh also depends on `SAGE_CYTHONIZED`, defined in `src/sage/env.py`.

 I think it would be better if `setup.sh` instead inferred that location from the build-base that was passed to it. 

 However, setup.sh already does a lot of stuff depending on `SAGE_CYTHONIZED` before `distutils.core.setup` is even called.
 Can this be fixed?

 I think I could use some help from the Python experts in the cc list of this ticket on this.

- `sage/libs/pari/auto_gen.pxi` and `sage/ext/interpreters/__init__.py` still need to be taken care of in preparation for the VPATH build.



---

archive/issue_comments_313546.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-14T02:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313546",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_313547.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. \n \n+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`\n+\n+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)\n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-14T02:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313547",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. 
 
+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`
+
+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313548.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-14T10:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313548",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_313549.json:
```json
{
    "body": "<a id='comment:22'></a>Thinking about it more, I disagree with building in `$SAGE_BUILD_DIR/sagelib` by default.\n\n`$SAGE_LOCAL` (which contains `$SAGE_BUILD_DIR`) is meant as *install* directory, not as *build* directory.\n\nLet's keep `$SAGE_LOCAL` to be exactly the install directory and nothing else (*).\n\nI *do* agree with making the build directory configurable for `VPATH` builds. For typical packages however, if you do not do a `VPATH` build, the build directory is the same as the source directory. Sage should follow the same model. This means that the build directory should be `$SAGE_SRC` *by default*.\n\n\n (*) One could argue that `$SAGE_BUILD_DIR` is currently used as build directory for packages. That is true, but they are only used temporarily, they are not meant to actually store stuff. So this isn't so bad.",
    "created_at": "2016-09-14T10:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313549",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Thinking about it more, I disagree with building in `$SAGE_BUILD_DIR/sagelib` by default.

`$SAGE_LOCAL` (which contains `$SAGE_BUILD_DIR`) is meant as *install* directory, not as *build* directory.

Let's keep `$SAGE_LOCAL` to be exactly the install directory and nothing else (*).

I *do* agree with making the build directory configurable for `VPATH` builds. For typical packages however, if you do not do a `VPATH` build, the build directory is the same as the source directory. Sage should follow the same model. This means that the build directory should be `$SAGE_SRC` *by default*.


 (*) One could argue that `$SAGE_BUILD_DIR` is currently used as build directory for packages. That is true, but they are only used temporarily, they are not meant to actually store stuff. So this isn't so bad.



---

archive/issue_comments_313550.json:
```json
{
    "body": "<a id='comment:23'></a>> Let's keep $SAGE_LOCAL to be exactly the install directory and nothing else (*). \n\n\nthis is part of the problem with the current \"build system\". SAGE_LOCAL is *not* the install directory. it is where stuff ends up during the build process.\n\noutside sage, an install directory is typically what you pass to --prefix, and where stuff is put into by \"make install\". you do that (if you are a sysadmin), after assuring that \"make check\" passes...\n\nyes i know why SAGE_LOCAL exists, but it should be clear that it's not necessary and that it only has \"evolved\" that way. having simplified things in the past, now it is falling on your feet.\n\nnote how i tried to fix/work\\ around that in my attempt to autotoolize sage (both the library and the distribution)... my point: the best approach will be to *not use SAGE_LOCAL* at all. here's the chance to cleanup sagelib, as a start.\n\nthat said: keep up the good and interesting work `@`mkoeppe. i hope i will have some more time later this year ...",
    "created_at": "2016-09-14T10:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313550",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:23'></a>> Let's keep $SAGE_LOCAL to be exactly the install directory and nothing else (*). 


this is part of the problem with the current "build system". SAGE_LOCAL is *not* the install directory. it is where stuff ends up during the build process.

outside sage, an install directory is typically what you pass to --prefix, and where stuff is put into by "make install". you do that (if you are a sysadmin), after assuring that "make check" passes...

yes i know why SAGE_LOCAL exists, but it should be clear that it's not necessary and that it only has "evolved" that way. having simplified things in the past, now it is falling on your feet.

note how i tried to fix/work\ around that in my attempt to autotoolize sage (both the library and the distribution)... my point: the best approach will be to *not use SAGE_LOCAL* at all. here's the chance to cleanup sagelib, as a start.

that said: keep up the good and interesting work `@`mkoeppe. i hope i will have some more time later this year ...



---

archive/issue_comments_313551.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 felixs]:\n> this is part of the problem with the current \"build system\". SAGE_LOCAL is *not* the install directory.\n\n\nWhy do you think that `$SAGE_LOCAL` is **not** the install directory? It is the directory where everything is installed, which by definition makes it the install directory. The fact that Sage does not (yet) support `--prefix` doesn't change this fact.\n\n> the best approach will be to *not use SAGE_LOCAL* at all.\n\n\nI like to know why you think that.\n\n> that said: keep up the good and interesting work `@`mkoeppe. i hope i will have some more time later this year ...\n\n\nTo be clear: I didn't say that this branch needs to be thrown out. I am just saying: keep the build directory configurable but keep the default what it currently is.",
    "created_at": "2016-09-14T11:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313551",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:23 felixs]:
> this is part of the problem with the current "build system". SAGE_LOCAL is *not* the install directory.


Why do you think that `$SAGE_LOCAL` is **not** the install directory? It is the directory where everything is installed, which by definition makes it the install directory. The fact that Sage does not (yet) support `--prefix` doesn't change this fact.

> the best approach will be to *not use SAGE_LOCAL* at all.


I like to know why you think that.

> that said: keep up the good and interesting work `@`mkoeppe. i hope i will have some more time later this year ...


To be clear: I didn't say that this branch needs to be thrown out. I am just saying: keep the build directory configurable but keep the default what it currently is.



---

archive/issue_comments_313552.json:
```json
{
    "body": "<a id='comment:25'></a>> Why do you think that $SAGE_LOCAL is not the install directory?\n\n\nyou wrote it. \"--prefix\" is not implemented/supported. (but it should be). there's no way to really \"install\" stuff in the usual sense. e.g., there is no way to *install stuff after make check has passed*. (i don't know if toplevel make check is currently implemented at all, just a thought).\n\n> where everything is installed, which by definition makes it the install directory\n\n\nactually nothing gets installed. what is done is mostly overhead. working around the fact that some packages don't work right after the build alone. when i was done with the \"package content lists\" for spkg-install, i noticed that it was a huge waste of time... don't repeat that, better just skip the \"install\" step.\n\n> I like to know why you think that [SAGE_LOCAL should not be used].\n\n\nevery instance/use of SAGE_LOCAL breaks sagelib on (lets call it) foreign distros a bit. that's not helpful. it will as well interfere with any attempt on rewriting sage-the-distribution (be it autotools based, or pip or ebuild). the autotools approach (not a necessary step, but an example) provides a transition path to anything...\n\nsage-the-distribution is a platform for sage (core) development. no more, no less. other platforms will come and go. what is needed is sagelib without the dependency on this (and on SAGE_LOCAL). why: because developers should be able to use sagelib and develop sage extensions on *their own platforms*, with *their own* tools and *their own* review policies.\n\nso: please embrace contributions that reduce the use of SAGE_LOCAL.\n\n(yes, its getting off-topic. but i hope, this answers the question.)",
    "created_at": "2016-09-14T12:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313552",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:25'></a>> Why do you think that $SAGE_LOCAL is not the install directory?


you wrote it. "--prefix" is not implemented/supported. (but it should be). there's no way to really "install" stuff in the usual sense. e.g., there is no way to *install stuff after make check has passed*. (i don't know if toplevel make check is currently implemented at all, just a thought).

> where everything is installed, which by definition makes it the install directory


actually nothing gets installed. what is done is mostly overhead. working around the fact that some packages don't work right after the build alone. when i was done with the "package content lists" for spkg-install, i noticed that it was a huge waste of time... don't repeat that, better just skip the "install" step.

> I like to know why you think that [SAGE_LOCAL should not be used].


every instance/use of SAGE_LOCAL breaks sagelib on (lets call it) foreign distros a bit. that's not helpful. it will as well interfere with any attempt on rewriting sage-the-distribution (be it autotools based, or pip or ebuild). the autotools approach (not a necessary step, but an example) provides a transition path to anything...

sage-the-distribution is a platform for sage (core) development. no more, no less. other platforms will come and go. what is needed is sagelib without the dependency on this (and on SAGE_LOCAL). why: because developers should be able to use sagelib and develop sage extensions on *their own platforms*, with *their own* tools and *their own* review policies.

so: please embrace contributions that reduce the use of SAGE_LOCAL.

(yes, its getting off-topic. but i hope, this answers the question.)



---

archive/issue_comments_313553.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:22 jdemeyer]:\n> Thinking about it more, I disagree with building in `$SAGE_BUILD_DIR/sagelib` by default.\n> \n> `$SAGE_LOCAL` (which contains `$SAGE_BUILD_DIR`) is meant as *install* directory, not as *build* directory.\n> \n> Let's keep `$SAGE_LOCAL` to be exactly the install directory and nothing else (*).\n\n\nI agree with you; see #21479.",
    "created_at": "2016-09-14T15:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313553",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Replying to [comment:22 jdemeyer]:
> Thinking about it more, I disagree with building in `$SAGE_BUILD_DIR/sagelib` by default.
> 
> `$SAGE_LOCAL` (which contains `$SAGE_BUILD_DIR`) is meant as *install* directory, not as *build* directory.
> 
> Let's keep `$SAGE_LOCAL` to be exactly the install directory and nothing else (*).


I agree with you; see #21479.



---

archive/issue_comments_313554.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:23 felixs]:\n> outside sage, an install directory is typically what you pass to --prefix, and where stuff is put into by \"make install\". you do that (if you are a sysadmin), after assuring that \"make check\" passes...\n\n\nSee #21479 for a discussion of `--prefix` and `make` vs. `make install`.\n\nBut let's keep the discussion of the present ticket focused on the task at hand.",
    "created_at": "2016-09-14T15:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313554",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Replying to [comment:23 felixs]:
> outside sage, an install directory is typically what you pass to --prefix, and where stuff is put into by "make install". you do that (if you are a sysadmin), after assuring that "make check" passes...


See #21479 for a discussion of `--prefix` and `make` vs. `make install`.

But let's keep the discussion of the present ticket focused on the task at hand.



---

archive/issue_comments_313555.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:22 jdemeyer]:\n> I *do* agree with making the build directory configurable for `VPATH` builds. For typical packages however, if you do not do a `VPATH` build, the build directory is the same as the source directory. Sage should follow the same model. This means that the build directory should be `$SAGE_SRC` *by default*.\n\n\nI agree on this as well. #21469 (VPATH for distro) will do that.\n\nIn this ticket, I first want to make the `--build-base` work. In particular, get rid of SAGE_CYTHONIZED.\n\nThis also works towards the eventual goal of making 'sagelib' pip-installable.\n\nThe actual location used is a detail that will be easy to change later.\n\n>  (*) One could argue that `$SAGE_BUILD_DIR` is currently used as build directory for packages. That is true, but they are only used temporarily, they are not meant to actually store stuff. So this isn't so bad.\n\n\nYes, the current patch follows this practice. But this is temporary until #21469 is done.",
    "created_at": "2016-09-14T15:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313555",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>Replying to [comment:22 jdemeyer]:
> I *do* agree with making the build directory configurable for `VPATH` builds. For typical packages however, if you do not do a `VPATH` build, the build directory is the same as the source directory. Sage should follow the same model. This means that the build directory should be `$SAGE_SRC` *by default*.


I agree on this as well. #21469 (VPATH for distro) will do that.

In this ticket, I first want to make the `--build-base` work. In particular, get rid of SAGE_CYTHONIZED.

This also works towards the eventual goal of making 'sagelib' pip-installable.

The actual location used is a detail that will be easy to change later.

>  (*) One could argue that `$SAGE_BUILD_DIR` is currently used as build directory for packages. That is true, but they are only used temporarily, they are not meant to actually store stuff. So this isn't so bad.


Yes, the current patch follows this practice. But this is temporary until #21469 is done.



---

archive/issue_comments_313556.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:25 felixs]:\n> > Why do you think that $SAGE_LOCAL is not the install directory?\n\n> \n> you wrote it. \"--prefix\" is not implemented/supported.\n\n\nThe fact that the installation process does not implement `./configure --prefix` does not mean that it's not an installation process...\n\n> every instance/use of SAGE_LOCAL breaks sagelib\n\n\nBut why? \n\nOf course, it's all a matter of definition. I consider the process of copying files to `$SAGE_LOCAL` an \"installation\" and you do not (for reasons which are still unclear to me). I think things will become much simpler for you if you accept the fact that `$SAGE_LOCAL` is the installation directory and that copying files to `$SAGE_LOCAL` is an installation.\n\n> but i hope, this answers the question\n\n\nI absolutely does not. You are just saying \"it breaks stuff\" but not explaining *why*.",
    "created_at": "2016-09-14T17:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313556",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Replying to [comment:25 felixs]:
> > Why do you think that $SAGE_LOCAL is not the install directory?

> 
> you wrote it. "--prefix" is not implemented/supported.


The fact that the installation process does not implement `./configure --prefix` does not mean that it's not an installation process...

> every instance/use of SAGE_LOCAL breaks sagelib


But why? 

Of course, it's all a matter of definition. I consider the process of copying files to `$SAGE_LOCAL` an "installation" and you do not (for reasons which are still unclear to me). I think things will become much simpler for you if you accept the fact that `$SAGE_LOCAL` is the installation directory and that copying files to `$SAGE_LOCAL` is an installation.

> but i hope, this answers the question


I absolutely does not. You are just saying "it breaks stuff" but not explaining *why*.



---

archive/issue_comments_313557.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 jdemeyer]:\n> Replying to [comment:25 felixs]:\n\n[...] \n> > but i hope, this answers the question\n\n> \n> I absolutely does not. You are just saying \"it breaks stuff\" but not explaining *why*.\n\n\nOne reason *why* is that in many deployment scenarios  you will want to test what you have built before installing it. And Sage does not support this.",
    "created_at": "2016-09-14T19:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313557",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>Replying to [comment:29 jdemeyer]:
> Replying to [comment:25 felixs]:

[...] 
> > but i hope, this answers the question

> 
> I absolutely does not. You are just saying "it breaks stuff" but not explaining *why*.


One reason *why* is that in many deployment scenarios  you will want to test what you have built before installing it. And Sage does not support this.



---

archive/issue_comments_313558.json:
```json
{
    "body": "<a id='comment:31'></a>indeed. in \"build\"-\"check\"-\"install\" there is not much room for definitions of \"build\" and \"install\".\n\nthis is drifting towards the question of whether or not sage should stick to common practices and terminology. you know i think it should.\n\napologies for being off-topic again, this may be more related to #15105 -- there is no ticket for just \"practices and terminology\".",
    "created_at": "2016-09-14T20:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313558",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:31'></a>indeed. in "build"-"check"-"install" there is not much room for definitions of "build" and "install".

this is drifting towards the question of whether or not sage should stick to common practices and terminology. you know i think it should.

apologies for being off-topic again, this may be more related to #15105 -- there is no ticket for just "practices and terminology".



---

archive/issue_comments_313559.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:30 dimpase]:\n> One reason why is that in many deployment scenarios you will want to test what you have built before installing it. And Sage does not support this.\n\n\nHow does this relate to the existence of `$SAGE_LOCAL`?",
    "created_at": "2016-09-14T20:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313559",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>Replying to [comment:30 dimpase]:
> One reason why is that in many deployment scenarios you will want to test what you have built before installing it. And Sage does not support this.


How does this relate to the existence of `$SAGE_LOCAL`?



---

archive/issue_comments_313560.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-14T21:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313560",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313561.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:31 felixs]:\n> this is drifting towards the question of whether or not sage should stick to common practices and terminology. you know i think it should.\n\n\nIf those \"common\" practices and terminology make sense, of course it should.\n\nAnyway, I am completely not following what you are trying to say. I feel that you are always wandering around my questions instead of answering them.",
    "created_at": "2016-09-14T21:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313561",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [comment:31 felixs]:
> this is drifting towards the question of whether or not sage should stick to common practices and terminology. you know i think it should.


If those "common" practices and terminology make sense, of course it should.

Anyway, I am completely not following what you are trying to say. I feel that you are always wandering around my questions instead of answering them.



---

archive/issue_comments_313562.json:
```json
{
    "body": "<a id='comment:35'></a>I have created #21495 as a place for such discussions.",
    "created_at": "2016-09-14T21:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313562",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>I have created #21495 as a place for such discussions.



---

archive/issue_comments_313563.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. \n \n+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`\n+\n+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)\n+\n+As a second goal of this ticket, `setup.sh` is put in charge of ALL sagelib building. \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-14T21:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313563",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,16 @@
+Currently, building sagelib creates the `src/build` directory, with subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME`. 
 
+In preparation for VPATH builds of sage-the-distribution (#21469), let's keep `src/` clean by using `setup.py --build-base=$SAGE_BUILD_DIR/sagelib`
+
+(`$SAGE_BUILD_DIR` defaults to `$SAGE_ROOT/var/tmp/sage/build/`)
+
+As a second goal of this ticket, `setup.sh` is put in charge of ALL sagelib building. 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313564.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:32 jdemeyer]:\n> Replying to [comment:30 dimpase]:\n> > One reason why is that in many deployment scenarios you will want to test what you have built before installing it. And Sage does not support this.\n\n> \n> How does this relate to the existence of `$SAGE_LOCAL`?\n\n\n`$SAGE_LOCAL` is fine as long as you can also install things from there somewhere else. Currently you cannot do this in a proper way (yes, you can certainly create symbolic links etc, but this is often not enough).",
    "created_at": "2016-09-14T21:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313564",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>Replying to [comment:32 jdemeyer]:
> Replying to [comment:30 dimpase]:
> > One reason why is that in many deployment scenarios you will want to test what you have built before installing it. And Sage does not support this.

> 
> How does this relate to the existence of `$SAGE_LOCAL`?


`$SAGE_LOCAL` is fine as long as you can also install things from there somewhere else. Currently you cannot do this in a proper way (yes, you can certainly create symbolic links etc, but this is often not enough).



---

archive/issue_comments_313565.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 dimpase]:\n> `$SAGE_LOCAL` is fine as long as you can also install things from there somewhere else. Currently you cannot do this in a proper way\n\n\nOf course you can:\n\n```\n$ cd $package_source\n$ sage --sh\n$ ./configure --prefix=\"$SAGE_LOCAL\"\n$ make install\n```\n\nI have done this many times as first step of testing a new package or a package upgrade.",
    "created_at": "2016-09-15T05:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313565",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>Replying to [comment:37 dimpase]:
> `$SAGE_LOCAL` is fine as long as you can also install things from there somewhere else. Currently you cannot do this in a proper way


Of course you can:

```
$ cd $package_source
$ sage --sh
$ ./configure --prefix="$SAGE_LOCAL"
$ make install
```

I have done this many times as first step of testing a new package or a package upgrade.



---

archive/issue_comments_313566.json:
```json
{
    "body": "<a id='comment:39'></a>If I understand Dima correctly, he wants to install \"from\" $SAGE_LOCAL, not \"to\" $SAGE_LOCAL.\n\nBut really this discussion should go to #21495. \nThanks!",
    "created_at": "2016-09-15T05:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313566",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>If I understand Dima correctly, he wants to install "from" $SAGE_LOCAL, not "to" $SAGE_LOCAL.

But really this discussion should go to #21495. 
Thanks!



---

archive/issue_comments_313567.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T05:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313567",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313568.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-15T05:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313568",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_313569.json:
```json
{
    "body": "<a id='comment:41'></a>Jeroen, how does this look to you now?\n(I haven't changed $SAGE_BUILD_DIR yet, but will in a moment.)",
    "created_at": "2016-09-15T05:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313569",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Jeroen, how does this look to you now?
(I haven't changed $SAGE_BUILD_DIR yet, but will in a moment.)



---

archive/issue_comments_313570.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T06:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313571.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T18:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313571",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313572.json:
```json
{
    "body": "<a id='comment:44'></a>I've changed the description of this ticket, as it has changed its focus. \nReady for review.",
    "created_at": "2016-09-15T18:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313572",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>I've changed the description of this ticket, as it has changed its focus. 
Ready for review.



---

archive/issue_comments_313573.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.sh`\n+- `src/setup.sh` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n+- `src/setup.sh` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).\n+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable \n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-15T18:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313573",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,20 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.sh`
+- `src/setup.sh` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
+- `src/setup.sh` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).
+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable 
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313574.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T18:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313575.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T19:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313575",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313576.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T19:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313576",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313577.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).\n+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable \n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-16T08:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313577",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,20 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).
+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable 
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313578.json:
```json
{
    "body": "<a id='comment:51'></a>I would prefer to do this ticket after #21479 because there might be non-trivial interactions.",
    "created_at": "2016-09-16T08:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313578",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>I would prefer to do this ticket after #21479 because there might be non-trivial interactions.



---

archive/issue_comments_313579.json:
```json
{
    "body": "<a id='comment:52'></a>Also in the code `setup.sh` -> `setup.py`",
    "created_at": "2016-09-16T08:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313579",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>Also in the code `setup.sh` -> `setup.py`



---

archive/issue_comments_313580.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-16T08:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313580",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_313581.json:
```json
{
    "body": "<a id='comment:53'></a>Regarding\n\n```\n(cd $(srcdir) && export SAGE_ROOT=/doesnotexist SAGE_SRC=/doesnotexist SAGE_SRC_ROOT=/doesnotexist SAGE_DOC_SRC=/doesnotexist SAGE_SCRIPTS_DIR=/doesnotexist SAGE_BUILD_DIR=/doesnotexist SAGE_CYTHONIZED=/doesnotexist SAGE_PKGS=$(abs_top_srcdir)/build/pkgs && python -u setup.py build --build-base=$(abs_builddir)/build-sagelib install)\n```\n\nDid you know that `make` supports backslash-continued lines? :-)",
    "created_at": "2016-09-16T08:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313581",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>Regarding

```
(cd $(srcdir) && export SAGE_ROOT=/doesnotexist SAGE_SRC=/doesnotexist SAGE_SRC_ROOT=/doesnotexist SAGE_DOC_SRC=/doesnotexist SAGE_SCRIPTS_DIR=/doesnotexist SAGE_BUILD_DIR=/doesnotexist SAGE_CYTHONIZED=/doesnotexist SAGE_PKGS=$(abs_top_srcdir)/build/pkgs && python -u setup.py build --build-base=$(abs_builddir)/build-sagelib install)
```

Did you know that `make` supports backslash-continued lines? :-)



---

archive/issue_comments_313582.json:
```json
{
    "body": "<a id='comment:54'></a>For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?",
    "created_at": "2016-09-16T08:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313582",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?



---

archive/issue_comments_313583.json:
```json
{
    "body": "<a id='comment:55'></a>What is the rationale for splitting the `Makefile` in two (`Makefile` and `generate_py_source.mk`)? That seems like additional complication without reason.\n\nIn any case, using `make` is wrong. You need to use `os.environ[\"MAKE\"]`.",
    "created_at": "2016-09-16T08:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313583",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>What is the rationale for splitting the `Makefile` in two (`Makefile` and `generate_py_source.mk`)? That seems like additional complication without reason.

In any case, using `make` is wrong. You need to use `os.environ["MAKE"]`.



---

archive/issue_comments_313584.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T08:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313584",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313585.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:54 jdemeyer]:\n> For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?\n\n\nIf I keep the default, it's hard to demonstrate that \"--build-base\" actually works.\n\nMoreover, there are too many things already called \"build\" -- better be specific.",
    "created_at": "2016-09-16T08:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313585",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:57'></a>Replying to [comment:54 jdemeyer]:
> For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?


If I keep the default, it's hard to demonstrate that "--build-base" actually works.

Moreover, there are too many things already called "build" -- better be specific.



---

archive/issue_comments_313586.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:55 jdemeyer]:\n> What is the rationale for splitting the `Makefile` in two (`Makefile` and `generate_py_source.mk`)? That seems like additional complication without reason.\n\n\n`setup.sh` needs to be in charge of building everything, if sagelib is to become a well-behaved Python package.",
    "created_at": "2016-09-16T08:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313586",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>Replying to [comment:55 jdemeyer]:
> What is the rationale for splitting the `Makefile` in two (`Makefile` and `generate_py_source.mk`)? That seems like additional complication without reason.


`setup.sh` needs to be in charge of building everything, if sagelib is to become a well-behaved Python package.



---

archive/issue_comments_313587.json:
```json
{
    "body": "<a id='comment:59'></a>`generate_py_source.mk` could certainly be implemented in pure Python and could become a part of `setup.py`. But I don't want to work on this.",
    "created_at": "2016-09-16T08:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313587",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:59'></a>`generate_py_source.mk` could certainly be implemented in pure Python and could become a part of `setup.py`. But I don't want to work on this.



---

archive/issue_comments_313588.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T09:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313589.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T09:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313590.json:
```json
{
    "body": "<a id='comment:62'></a>Replying to [comment:57 mkoeppe]:\n> Replying to [comment:54 jdemeyer]:\n> > For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?\n\n> \n> If I keep the default, it's hard to demonstrate that \"--build-base\" actually works.\n\n\nWell, it's easy for the reviewer to test a different value of `--build-base`.\n\n> Moreover, there are too many things already called \"build\" -- better be specific.\n\n\nBut `src/build` is pretty clear: it is the build directory corresponding to `src`, which is the Sage library. I don't like to change it just for the sake of changing it.",
    "created_at": "2016-09-16T09:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313590",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:62'></a>Replying to [comment:57 mkoeppe]:
> Replying to [comment:54 jdemeyer]:
> > For backwards compatibility, can we please keep the name `build` instead of changing it to `build-sagelib`?

> 
> If I keep the default, it's hard to demonstrate that "--build-base" actually works.


Well, it's easy for the reviewer to test a different value of `--build-base`.

> Moreover, there are too many things already called "build" -- better be specific.


But `src/build` is pretty clear: it is the build directory corresponding to `src`, which is the Sage library. I don't like to change it just for the sake of changing it.



---

archive/issue_comments_313591.json:
```json
{
    "body": "<a id='comment:63'></a>Replying to [comment:59 mkoeppe]:\n> `generate_py_source.mk` could certainly be implemented in pure Python and could become a part of `setup.py`\n\n\nThat doesn't answer my question. Why do you not keep this in `src/Makefile`?",
    "created_at": "2016-09-16T09:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313591",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:63'></a>Replying to [comment:59 mkoeppe]:
> `generate_py_source.mk` could certainly be implemented in pure Python and could become a part of `setup.py`


That doesn't answer my question. Why do you not keep this in `src/Makefile`?



---

archive/issue_comments_313592.json:
```json
{
    "body": "<a id='comment:64'></a>Replying to [comment:58 mkoeppe]:\n> `setup.sh` needs to be in charge of building everything, if sagelib is to become a well-behaved Python package.\n\n\nSorry, I didn't see this comment. Okay, that makes sense but it wasn't clear to me,\n\nI guess you should add some comments to `src/Makefile` to explain this better than just\n\n```\n## All sagelib-building is done by setup.py.\n## DON'T ADD ADDITIONAL STEPS TO THIS MAKEFILE.\n```",
    "created_at": "2016-09-16T09:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313592",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:64'></a>Replying to [comment:58 mkoeppe]:
> `setup.sh` needs to be in charge of building everything, if sagelib is to become a well-behaved Python package.


Sorry, I didn't see this comment. Okay, that makes sense but it wasn't clear to me,

I guess you should add some comments to `src/Makefile` to explain this better than just

```
## All sagelib-building is done by setup.py.
## DON'T ADD ADDITIONAL STEPS TO THIS MAKEFILE.
```



---

archive/issue_comments_313593.json:
```json
{
    "body": "<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T09:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313594.json:
```json
{
    "body": "<a id='comment:66'></a>Replying to [comment:51 jdemeyer]:\n> I would prefer to do this ticket after #21479 because there might be non-trivial interactions.\n\n\nOr at least I will test it with #21501 applied.",
    "created_at": "2016-09-16T09:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313594",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:66'></a>Replying to [comment:51 jdemeyer]:
> I would prefer to do this ticket after #21479 because there might be non-trivial interactions.


Or at least I will test it with #21501 applied.



---

archive/issue_comments_313595.json:
```json
{
    "body": "<a id='comment:67'></a>OK, I'll have #21479 ready in a few days.",
    "created_at": "2016-09-16T10:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313595",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:67'></a>OK, I'll have #21479 ready in a few days.



---

archive/issue_comments_313596.json:
```json
{
    "body": "<a id='comment:68'></a>I just tested this with #21501. It mostly works but there are these two doctest failures:\n\n```\nsage -t src/sage_setup/find.py\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 107, in sage_setup.find.find_extra_files\nFailed example:\n    find_extra_files([\"sage.modular.arithgroup\"], SAGE_SRC, SAGE_CYTHONIZED, \".\")\nExpected:\n    [('./sage/modular/arithgroup',\n      ['.../src/sage/modular/arithgroup/farey.pxd', ...farey_symbol.h...])]\nGot:\n    [('./sage/modular/arithgroup',\n      ['/usr/local/src/sage-config/src/sage/modular/arithgroup/farey.pxd'])]\n**********************************************************************\nFile \"src/sage_setup/clean.py\", line 87, in sage_setup.clean._find_stale_files\nFailed example:\n    for f in stale_iter:\n        if f.endswith(skip_extensions): continue\n        print('Found stale file: ' + f)\nExpected nothing\nGot:\n    Found stale file: sage/stats/distributions/dgs_gauss.h\n    Found stale file: sage/libs/lcalc/lcalc_sage.h\n    Found stale file: sage/geometry/triangulation/data.h\n    Found stale file: sage/misc/cython_metaclass.h\n    Found stale file: sage/rings/finite_rings/stdint.h\n    Found stale file: sage/stats/distributions/dgs_misc.h\n    Found stale file: sage/misc/darwin_memory_usage.h\n    Found stale file: sage/stats/distributions/dgs.h\n    Found stale file: sage/ext/python_debug.h\n    Found stale file: sage/libs/eclsig.h\n    Found stale file: sage/ext/solaris_fixes.h\n    Found stale file: sage/ext/pyx_visit.h\n    Found stale file: sage/matroids/minorfix.h\n    Found stale file: sage/modular/arithgroup/farey_symbol.h\n    Found stale file: sage/ext/mod_int.h\n    Found stale file: sage/combinat/matrices/dancing_links_c.h\n    Found stale file: sage/ext/interpreters/wrapper_rr.h\n    Found stale file: sage/symbolic/ginac_wrap.h\n    Found stale file: sage/ext/interpreters/wrapper_cdf.h\n    Found stale file: sage/ext/interpreters/wrapper_el.h\n    Found stale file: sage/groups/perm_gps/partn_ref2/refinement_generic.h\n    Found stale file: sage/libs/polybori/pb_wrap.h\n    Found stale file: sage/sat/solvers/cryptominisat/solverconf_helper.h\n    Found stale file: sage/combinat/partitions_c.h\n    Found stale file: sage/ext/ccobject.h\n    Found stale file: sage/geometry/triangulation/triangulations.h\n    Found stale file: sage/libs/ntl/ntlwrap.h\n    Found stale file: sage/stats/distributions/dgs_bern.h\n    Found stale file: sage/sat/solvers/cryptominisat/cryptominisat_helper.h\n    Found stale file: sage/libs/pari/parisage.h\n    Found stale file: sage/geometry/triangulation/functions.h\n**********************************************************************\n```",
    "created_at": "2016-09-16T11:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313596",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:68'></a>I just tested this with #21501. It mostly works but there are these two doctest failures:

```
sage -t src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 107, in sage_setup.find.find_extra_files
Failed example:
    find_extra_files(["sage.modular.arithgroup"], SAGE_SRC, SAGE_CYTHONIZED, ".")
Expected:
    [('./sage/modular/arithgroup',
      ['.../src/sage/modular/arithgroup/farey.pxd', ...farey_symbol.h...])]
Got:
    [('./sage/modular/arithgroup',
      ['/usr/local/src/sage-config/src/sage/modular/arithgroup/farey.pxd'])]
**********************************************************************
File "src/sage_setup/clean.py", line 87, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: sage/stats/distributions/dgs_gauss.h
    Found stale file: sage/libs/lcalc/lcalc_sage.h
    Found stale file: sage/geometry/triangulation/data.h
    Found stale file: sage/misc/cython_metaclass.h
    Found stale file: sage/rings/finite_rings/stdint.h
    Found stale file: sage/stats/distributions/dgs_misc.h
    Found stale file: sage/misc/darwin_memory_usage.h
    Found stale file: sage/stats/distributions/dgs.h
    Found stale file: sage/ext/python_debug.h
    Found stale file: sage/libs/eclsig.h
    Found stale file: sage/ext/solaris_fixes.h
    Found stale file: sage/ext/pyx_visit.h
    Found stale file: sage/matroids/minorfix.h
    Found stale file: sage/modular/arithgroup/farey_symbol.h
    Found stale file: sage/ext/mod_int.h
    Found stale file: sage/combinat/matrices/dancing_links_c.h
    Found stale file: sage/ext/interpreters/wrapper_rr.h
    Found stale file: sage/symbolic/ginac_wrap.h
    Found stale file: sage/ext/interpreters/wrapper_cdf.h
    Found stale file: sage/ext/interpreters/wrapper_el.h
    Found stale file: sage/groups/perm_gps/partn_ref2/refinement_generic.h
    Found stale file: sage/libs/polybori/pb_wrap.h
    Found stale file: sage/sat/solvers/cryptominisat/solverconf_helper.h
    Found stale file: sage/combinat/partitions_c.h
    Found stale file: sage/ext/ccobject.h
    Found stale file: sage/geometry/triangulation/triangulations.h
    Found stale file: sage/libs/ntl/ntlwrap.h
    Found stale file: sage/stats/distributions/dgs_bern.h
    Found stale file: sage/sat/solvers/cryptominisat/cryptominisat_helper.h
    Found stale file: sage/libs/pari/parisage.h
    Found stale file: sage/geometry/triangulation/functions.h
**********************************************************************
```



---

archive/issue_comments_313597.json:
```json
{
    "body": "<a id='comment:69'></a>One thing I don't like about the approach of this ticket is that `SAGE_CYTHONIZED` is set by the value of `--build-base`. I would much rather have it the other way around: that some environment variable is set by `configure` which is then used to define the value for `--build-base` and for the environment variable `SAGE_CYTHONIZED`.\n\nThis would be more analogous to #21501 where I want to set `$SAGE_LOCAL` just once and then derive everything from that.",
    "created_at": "2016-09-16T12:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313597",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:69'></a>One thing I don't like about the approach of this ticket is that `SAGE_CYTHONIZED` is set by the value of `--build-base`. I would much rather have it the other way around: that some environment variable is set by `configure` which is then used to define the value for `--build-base` and for the environment variable `SAGE_CYTHONIZED`.

This would be more analogous to #21501 where I want to set `$SAGE_LOCAL` just once and then derive everything from that.



---

archive/issue_comments_313598.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).\n+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable.\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS to be set. The hope is that #20382 or a future ticket will develop a better mechanism to communicate package information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-16T15:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313598",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,22 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).
+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable.
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS to be set. The hope is that #20382 or a future ticket will develop a better mechanism to communicate package information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313599.json:
```json
{
    "body": "<a id='comment:71'></a>Replying to [comment:69 jdemeyer]:\n> One thing I don't like about the approach of this ticket is that `SAGE_CYTHONIZED` is set by the value of `--build-base`. I would much rather have it the other way around: that some environment variable is set by `configure` which is then used to define the value for `--build-base` and for the environment variable `SAGE_CYTHONIZED`.\n> \n> This would be more analogous to #21501 where I want to set `$SAGE_LOCAL` just once and then derive everything from that.\n\n\nI've updated the description to explain better why --build-base needs to be in charge of setting all build directories.",
    "created_at": "2016-09-16T15:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313599",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:71'></a>Replying to [comment:69 jdemeyer]:
> One thing I don't like about the approach of this ticket is that `SAGE_CYTHONIZED` is set by the value of `--build-base`. I would much rather have it the other way around: that some environment variable is set by `configure` which is then used to define the value for `--build-base` and for the environment variable `SAGE_CYTHONIZED`.
> 
> This would be more analogous to #21501 where I want to set `$SAGE_LOCAL` just once and then derive everything from that.


I've updated the description to explain better why --build-base needs to be in charge of setting all build directories.



---

archive/issue_comments_313600.json:
```json
{
    "body": "<a id='comment:72'></a>But yes, I'll introduce something like `SAGE_SRC_BUILDBASE` that can be used in `src/Makefile.in` and to define `SAGE_CYTHONIZED` for that doctest.",
    "created_at": "2016-09-16T15:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313600",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:72'></a>But yes, I'll introduce something like `SAGE_SRC_BUILDBASE` that can be used in `src/Makefile.in` and to define `SAGE_CYTHONIZED` for that doctest.



---

archive/issue_comments_313601.json:
```json
{
    "body": "<a id='comment:73'></a>Replying to [comment:71 mkoeppe]:\n> I've updated the description to explain better why --build-base needs to be in charge of setting all build directories.\n\n\nSorry, but the paragraph you added does not explain this. It explains better the **what** but not the **why**. This reminds me of what I recently said at [https://trac.sagemath.org/ticket/21469#comment:17](https://trac.sagemath.org/ticket/21469#comment:17)",
    "created_at": "2016-09-16T15:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313601",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:73'></a>Replying to [comment:71 mkoeppe]:
> I've updated the description to explain better why --build-base needs to be in charge of setting all build directories.


Sorry, but the paragraph you added does not explain this. It explains better the **what** but not the **why**. This reminds me of what I recently said at [https://trac.sagemath.org/ticket/21469#comment:17](https://trac.sagemath.org/ticket/21469#comment:17)



---

archive/issue_comments_313602.json:
```json
{
    "body": "<a id='comment:74'></a>Replying to [comment:72 mkoeppe]:\n> But yes, I'll introduce something like `SAGE_SRC_BUILDBASE` that can be used in `src/Makefile.in` and to define `SAGE_CYTHONIZED` for that doctest.\n\n\nNow I am even more lost...\n\nFirst you say that `--build-base` should determine everything but this comment seems to contradict that.",
    "created_at": "2016-09-16T15:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313602",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:74'></a>Replying to [comment:72 mkoeppe]:
> But yes, I'll introduce something like `SAGE_SRC_BUILDBASE` that can be used in `src/Makefile.in` and to define `SAGE_CYTHONIZED` for that doctest.


Now I am even more lost...

First you say that `--build-base` should determine everything but this comment seems to contradict that.



---

archive/issue_comments_313603.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).\n+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS to be set. The hope is that #20382 or a future ticket will develop a better mechanism to communicate package information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-16T16:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313603",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,22 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
+- `src/setup.py` accepts `build --build-base=BUILD-BASE`. This is where building takes place (where subdirectories `cython_debug`, `cythonized`, `lib.UNAME`, `temp.UNAME` are created). The default is the `build` subdirectory (of `src`).
+- `src/Makefile` sets `--build-base` to the `build-sagelib` subdirectory (of `src`).
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS to be set. The hope is that #20382 or a future ticket will develop a better mechanism to communicate package information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313604.json:
```json
{
    "body": "<a id='comment:76'></a>Replying to [comment:73 jdemeyer]:\n> Replying to [comment:71 mkoeppe]:\n> > I've updated the description to explain better why --build-base needs to be in charge of setting all build directories.\n\n> \n> Sorry, but the paragraph you added does not explain this. It explains better the **what** but not the **why**. \n\n\nI've created ticket #21507 to put the technical goals of the present ticket in the context of a bigger goal. Please take a look.",
    "created_at": "2016-09-16T16:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313604",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:76'></a>Replying to [comment:73 jdemeyer]:
> Replying to [comment:71 mkoeppe]:
> > I've updated the description to explain better why --build-base needs to be in charge of setting all build directories.

> 
> Sorry, but the paragraph you added does not explain this. It explains better the **what** but not the **why**. 


I've created ticket #21507 to put the technical goals of the present ticket in the context of a bigger goal. Please take a look.



---

archive/issue_comments_313605.json:
```json
{
    "body": "<a id='comment:77'></a>For this ticket, can you please keep `SAGE_CYTHONIZED` independent of `--build-base` (and set them both from the common environment variable you mention in [comment:72]). That will also solve the doctest failures from [comment:68].\n\nThe current code which figures out `SAGE_CYTHONIZED` from the command line is quite ugly and fragile. I think that we can do a bigger reorganization of `setup.py` which will make things simpler. Also Cython 0.25 (not released yet) has some potential to simplify cythonization.\n\nPS: I like the fact that you are splitting this up over many tickets, it gets things moving more quickly.",
    "created_at": "2016-09-16T17:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313605",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:77'></a>For this ticket, can you please keep `SAGE_CYTHONIZED` independent of `--build-base` (and set them both from the common environment variable you mention in [comment:72]). That will also solve the doctest failures from [comment:68].

The current code which figures out `SAGE_CYTHONIZED` from the command line is quite ugly and fragile. I think that we can do a bigger reorganization of `setup.py` which will make things simpler. Also Cython 0.25 (not released yet) has some potential to simplify cythonization.

PS: I like the fact that you are splitting this up over many tickets, it gets things moving more quickly.



---

archive/issue_comments_313606.json:
```json
{
    "body": "<a id='comment:78'></a>Replying to [comment:67 mkoeppe]:\n> OK, I'll have #21479 ready in a few days.\n\n\nActually, maybe this doesn't really need to depend on #21479, since it doesn't involve `./configure`. If you address the points I made, then this might be good to go.",
    "created_at": "2016-09-16T17:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313606",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:78'></a>Replying to [comment:67 mkoeppe]:
> OK, I'll have #21479 ready in a few days.


Actually, maybe this doesn't really need to depend on #21479, since it doesn't involve `./configure`. If you address the points I made, then this might be good to go.



---

archive/issue_comments_313607.json:
```json
{
    "body": "<a id='comment:79'></a>Replying to [comment:77 jdemeyer]:\n> For this ticket, can you please keep `SAGE_CYTHONIZED` independent of `--build-base` (and set them both from the common environment variable you mention in [comment:72]). That will also solve the doctest failures from [comment:68].\n\n\nI disagree. I consider setup.py deriving `SAGE_CYTHONIZED` from `--build-base` a crucial feature of this patch.\nWhat I meant above is simply that `setup.py` will set an intermediate variable, rather than SAGE_CYTHONIZED, and SAGE_CYTHONIZED would be determined by env.py.\n\n> The current code which figures out `SAGE_CYTHONIZED` from the command line is quite ugly and fragile. I think that we can do a bigger reorganization of `setup.py` which will make things simpler. Also Cython 0.25 (not released yet) has some potential to simplify cythonization.\n\n\nI am aware that the arg parsing code is ad hoc, but it's easy to understand code. \n\nI do not want to defer getting `--build-base` working to some distant future, when someone finds the time to clean up `setup.py`.",
    "created_at": "2016-09-16T17:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313607",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:79'></a>Replying to [comment:77 jdemeyer]:
> For this ticket, can you please keep `SAGE_CYTHONIZED` independent of `--build-base` (and set them both from the common environment variable you mention in [comment:72]). That will also solve the doctest failures from [comment:68].


I disagree. I consider setup.py deriving `SAGE_CYTHONIZED` from `--build-base` a crucial feature of this patch.
What I meant above is simply that `setup.py` will set an intermediate variable, rather than SAGE_CYTHONIZED, and SAGE_CYTHONIZED would be determined by env.py.

> The current code which figures out `SAGE_CYTHONIZED` from the command line is quite ugly and fragile. I think that we can do a bigger reorganization of `setup.py` which will make things simpler. Also Cython 0.25 (not released yet) has some potential to simplify cythonization.


I am aware that the arg parsing code is ad hoc, but it's easy to understand code. 

I do not want to defer getting `--build-base` working to some distant future, when someone finds the time to clean up `setup.py`.



---

archive/issue_comments_313608.json:
```json
{
    "body": "<a id='comment:80'></a>Replying to [comment:79 mkoeppe]:\n> I do not want to defer getting `--build-base` working to some distant future, when someone finds the time to clean up `setup.py`.\n\n\nAt least you shouldn't determine the directory from the command line. That's too fragile to work correctly. You should find a way to get the directory from `distutils` which is going to require some refactoring anyway.",
    "created_at": "2016-09-16T17:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313608",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:80'></a>Replying to [comment:79 mkoeppe]:
> I do not want to defer getting `--build-base` working to some distant future, when someone finds the time to clean up `setup.py`.


At least you shouldn't determine the directory from the command line. That's too fragile to work correctly. You should find a way to get the directory from `distutils` which is going to require some refactoring anyway.



---

archive/issue_comments_313609.json:
```json
{
    "body": "<a id='comment:81'></a>Replying to [comment:80 jdemeyer]:\n> At least you shouldn't determine the directory from the command line. That's too fragile to work correctly. You should find a way to get the directory from `distutils` which is going to require some refactoring anyway.\n\n\nThe current structure of `setup.py` does not make this easy. SAGE_CYTHONIZED is used before `setup` is even invoked.\nIt can't be the job of this ticket to bring `setup.py` to standard distutils behavior.",
    "created_at": "2016-09-16T17:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313609",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:81'></a>Replying to [comment:80 jdemeyer]:
> At least you shouldn't determine the directory from the command line. That's too fragile to work correctly. You should find a way to get the directory from `distutils` which is going to require some refactoring anyway.


The current structure of `setup.py` does not make this easy. SAGE_CYTHONIZED is used before `setup` is even invoked.
It can't be the job of this ticket to bring `setup.py` to standard distutils behavior.



---

archive/issue_comments_313610.json:
```json
{
    "body": "<a id='comment:82'></a>I've created a ticket #21508 for setup.py cleanup issues.",
    "created_at": "2016-09-16T17:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313610",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:82'></a>I've created a ticket #21508 for setup.py cleanup issues.



---

archive/issue_comments_313611.json:
```json
{
    "body": "<a id='comment:83'></a>Replying to [comment:81 mkoeppe]:\n> The current structure of `setup.py` does not make this easy.\n\n\nI know! That exactly why I proposed in [comment:77] to postpone this piece of your patch.\n\nIf you really want to go for #21507, you will need a lot of changes to `setup.py` anyway. So the cleanup will need to happen sooner or later.",
    "created_at": "2016-09-16T17:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313611",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:83'></a>Replying to [comment:81 mkoeppe]:
> The current structure of `setup.py` does not make this easy.


I know! That exactly why I proposed in [comment:77] to postpone this piece of your patch.

If you really want to go for #21507, you will need a lot of changes to `setup.py` anyway. So the cleanup will need to happen sooner or later.



---

archive/issue_comments_313612.json:
```json
{
    "body": "<a id='comment:84'></a>Replying to [comment:83 jdemeyer]:\n> Replying to [comment:81 mkoeppe]:\n> > The current structure of `setup.py` does not make this easy.\n\n> \n> I know! That exactly why I proposed in [comment:77] to postpone this piece of your patch.\n\n\nI want the feature of `--build-base` now, not in the distant future. It is easily achieved with this patch. \nThe arg parsing is ad hoc; but given the current state of `setup.py`, which does not take care at all about standard distutils behavior, it is an improvement.\n\n> If you really want to go for #21507, you will need a lot of changes to `setup.py` anyway. So the cleanup will need to happen sooner or later.\n\n\nI prefer to do one concrete step (technical goal) at a time. Let's get `--build-base` working right now.",
    "created_at": "2016-09-16T18:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313612",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:84'></a>Replying to [comment:83 jdemeyer]:
> Replying to [comment:81 mkoeppe]:
> > The current structure of `setup.py` does not make this easy.

> 
> I know! That exactly why I proposed in [comment:77] to postpone this piece of your patch.


I want the feature of `--build-base` now, not in the distant future. It is easily achieved with this patch. 
The arg parsing is ad hoc; but given the current state of `setup.py`, which does not take care at all about standard distutils behavior, it is an improvement.

> If you really want to go for #21507, you will need a lot of changes to `setup.py` anyway. So the cleanup will need to happen sooner or later.


I prefer to do one concrete step (technical goal) at a time. Let's get `--build-base` working right now.



---

archive/issue_comments_313613.json:
```json
{
    "body": "<a id='comment:85'></a>Replying to [comment:84 mkoeppe]:\n> Let's get `--build-base` working right now.\n\n\nIn my opinion, this branch is *not* making `--build-base` work. This branch is adding hacks to pretend like `--build-base` is working.\n\nIn general, hacks can have their place, but only if there is a clear reason for them. In this case, I see no reason. This ticket has no reason to exist except for going towards #21507. And this hack that you added will get us no closer to #21507 since we will need to refactor the `SAGE_CYTHONIZED` code anyway.",
    "created_at": "2016-09-16T19:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313613",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:85'></a>Replying to [comment:84 mkoeppe]:
> Let's get `--build-base` working right now.


In my opinion, this branch is *not* making `--build-base` work. This branch is adding hacks to pretend like `--build-base` is working.

In general, hacks can have their place, but only if there is a clear reason for them. In this case, I see no reason. This ticket has no reason to exist except for going towards #21507. And this hack that you added will get us no closer to #21507 since we will need to refactor the `SAGE_CYTHONIZED` code anyway.



---

archive/issue_comments_313614.json:
```json
{
    "body": "<a id='comment:86'></a>Anyway, I will leave this issue for other people to comment, since we probably won't come to an agreement.",
    "created_at": "2016-09-16T19:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313614",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:86'></a>Anyway, I will leave this issue for other people to comment, since we probably won't come to an agreement.



---

archive/issue_comments_313615.json:
```json
{
    "body": "<a id='comment:87'></a>Replying to [comment:85 jdemeyer]:\n> Replying to [comment:84 mkoeppe]:\n> > Let's get `--build-base` working right now.\n\n> \n> In my opinion, this branch is *not* making `--build-base` work. This branch is adding hacks to pretend like `--build-base` is working.\n\n\nIt does implement --build-base correctly. \n\n> \n> In general, hacks can have their place, but only if there is a clear reason for them. In this case, I see no reason. This ticket has no reason to exist except for going towards #21507. And this hack that you added will get us no closer to #21507 since we will need to refactor the `SAGE_CYTHONIZED` code anyway.\n\n\nApart from #21507, it is also needed for the VPATH build, as explained in the description.",
    "created_at": "2016-09-16T19:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313615",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:87'></a>Replying to [comment:85 jdemeyer]:
> Replying to [comment:84 mkoeppe]:
> > Let's get `--build-base` working right now.

> 
> In my opinion, this branch is *not* making `--build-base` work. This branch is adding hacks to pretend like `--build-base` is working.


It does implement --build-base correctly. 

> 
> In general, hacks can have their place, but only if there is a clear reason for them. In this case, I see no reason. This ticket has no reason to exist except for going towards #21507. And this hack that you added will get us no closer to #21507 since we will need to refactor the `SAGE_CYTHONIZED` code anyway.


Apart from #21507, it is also needed for the VPATH build, as explained in the description.



---

archive/issue_comments_313616.json:
```json
{
    "body": "<a id='comment:88'></a>Hum. I am not sure myself. I install sagelib in sage-on-gentoo like a normal package (I just don't install sage_setup and do not clean before hand since this is done by the package manager) with `python setup.py build` and then `python setup.py install --root=...`. I guess `pip` may have extra requirements. Of course I patch a lot of the sagelib code itself to help with various issues, and this ticket does nothing for them. But given your goals, I'd say you'll have to deal with most of them.\n\nThere are definitely things to do and getting setup.py to control the autogenerated files may help me. I will have to see it in action before forming a definitive opinion.\n\nMy other concerns while they could influence design here are separate issues:\n* separation of build time, doctest time and runtime variables. `SAGE_SRC` shouldn't be found in runtime code for example, neither does `package.py` belong there.\n* Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`.",
    "created_at": "2016-09-16T20:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313616",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:88'></a>Hum. I am not sure myself. I install sagelib in sage-on-gentoo like a normal package (I just don't install sage_setup and do not clean before hand since this is done by the package manager) with `python setup.py build` and then `python setup.py install --root=...`. I guess `pip` may have extra requirements. Of course I patch a lot of the sagelib code itself to help with various issues, and this ticket does nothing for them. But given your goals, I'd say you'll have to deal with most of them.

There are definitely things to do and getting setup.py to control the autogenerated files may help me. I will have to see it in action before forming a definitive opinion.

My other concerns while they could influence design here are separate issues:
* separation of build time, doctest time and runtime variables. `SAGE_SRC` shouldn't be found in runtime code for example, neither does `package.py` belong there.
* Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`.



---

archive/issue_comments_313617.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-16T20:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313617",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_313618.json:
```json
{
    "body": "<a id='comment:90'></a>Replying to [comment:88 fbissey]:\n>\n>* Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. \n\n\nAre you saying that it should be installed under SAGE_LOCAL?\nThis should be a separate ticket.",
    "created_at": "2016-09-16T20:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313618",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:90'></a>Replying to [comment:88 fbissey]:
>
>* Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. 


Are you saying that it should be installed under SAGE_LOCAL?
This should be a separate ticket.



---

archive/issue_comments_313619.json:
```json
{
    "body": "<a id='comment:91'></a>Agreed on a separate ticket. But I mention `cython_debug` because it is mentioned in the summary. I am pointing to the fact that it should be installable when it is currently not. I am on an awareness campaign :)",
    "created_at": "2016-09-16T20:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313619",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:91'></a>Agreed on a separate ticket. But I mention `cython_debug` because it is mentioned in the summary. I am pointing to the fact that it should be installable when it is currently not. I am on an awareness campaign :)



---

archive/issue_comments_313620.json:
```json
{
    "body": "<a id='comment:92'></a>Replying to [comment:87 mkoeppe]:\n> Apart from #21507, it is also needed for the VPATH build, as explained in the description.\n\n\nYou don't need the `--build-base` hack for VPATH builds to work. You could just set `SAGE_CYTHONIZED` correctly from the `Makefile`.",
    "created_at": "2016-09-16T21:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313620",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:92'></a>Replying to [comment:87 mkoeppe]:
> Apart from #21507, it is also needed for the VPATH build, as explained in the description.


You don't need the `--build-base` hack for VPATH builds to work. You could just set `SAGE_CYTHONIZED` correctly from the `Makefile`.



---

archive/issue_comments_313621.json:
```json
{
    "body": "<a id='comment:93'></a>Replying to [comment:91 fbissey]:\n> Agreed on a separate ticket. But I mention `cython_debug` because it is mentioned in the summary. I am pointing to the fact that it should be installable when it is currently not. I am on an awareness campaign :)\n\nI've created #21509 for this; but I guess you should explain more on that ticket.",
    "created_at": "2016-09-16T22:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313621",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:93'></a>Replying to [comment:91 fbissey]:
> Agreed on a separate ticket. But I mention `cython_debug` because it is mentioned in the summary. I am pointing to the fact that it should be installable when it is currently not. I am on an awareness campaign :)

I've created #21509 for this; but I guess you should explain more on that ticket.



---

archive/issue_comments_313622.json:
```json
{
    "body": "<a id='comment:94'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T23:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:94'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313623.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-16T23:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313623",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC`, `$SAGE_CYTHONIZED` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313624.json:
```json
{
    "body": "<a id='comment:96'></a>I have simplified this ticket to facilitate easier review.\nJeroen, please take a look.",
    "created_at": "2016-09-16T23:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313624",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:96'></a>I have simplified this ticket to facilitate easier review.
Jeroen, please take a look.



---

archive/issue_comments_313625.json:
```json
{
    "body": "<a id='comment:97'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-17T04:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:97'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313626.json:
```json
{
    "body": "<a id='comment:98'></a>Looks good on first sight, but I need to test it.",
    "created_at": "2016-09-17T07:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313626",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:98'></a>Looks good on first sight, but I need to test it.



---

archive/issue_comments_313627.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-18T19:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313627",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_313628.json:
```json
{
    "body": "<a id='comment:0'></a>Thanks!",
    "created_at": "2016-09-18T19:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313628",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:0'></a>Thanks!



---

archive/issue_comments_313629.json:
```json
{
    "body": "<a id='comment:1'></a>Trouble with Jupyter...",
    "created_at": "2016-09-19T07:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313629",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>Trouble with Jupyter...



---

archive/issue_comments_313630.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-09-19T07:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313630",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_313631.json:
```json
{
    "body": "<a id='comment:2'></a>`src/setup.py` runs code from `src/sage/repl/ipython_kernel/install.py` which still uses some of the directories that you blacklist.",
    "created_at": "2016-09-19T07:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313631",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>`src/setup.py` runs code from `src/sage/repl/ipython_kernel/install.py` which still uses some of the directories that you blacklist.



---

archive/issue_comments_313632.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-21T04:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313632",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_313633.json:
```json
{
    "body": "<a id='comment:4'></a>With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook. \n`SAGE_LOCAL/bin/sage` picks up its environment variables from the server that runs it, so everything works.\nDoes it have to work in other settings that I'm unaware of as well?",
    "created_at": "2016-09-21T04:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313633",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook. 
`SAGE_LOCAL/bin/sage` picks up its environment variables from the server that runs it, so everything works.
Does it have to work in other settings that I'm unaware of as well?



---

archive/issue_comments_313634.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-21T04:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313634",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_313635.json:
```json
{
    "body": "<a id='comment:6'></a>What about the use of `SAGE_DOC` and `SAGE_EXTCODE` in that file?",
    "created_at": "2016-09-21T07:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313635",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>What about the use of `SAGE_DOC` and `SAGE_EXTCODE` in that file?



---

archive/issue_comments_313636.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-21T21:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313636",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313637.json:
```json
{
    "body": "<a id='comment:8'></a>`SAGE_DOC` and `SAGE_EXTCODE` are fine as they are subdirectories of `SAGE_LOCAL`.\nThe patch does not poison any environment variables that are subdirectories of `SAGE_LOCAL`.",
    "created_at": "2016-09-21T21:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313637",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>`SAGE_DOC` and `SAGE_EXTCODE` are fine as they are subdirectories of `SAGE_LOCAL`.
The patch does not poison any environment variables that are subdirectories of `SAGE_LOCAL`.



---

archive/issue_comments_313638.json:
```json
{
    "body": "<a id='comment:9'></a>Very interesting--I'd like to take some time to review this and all the comments on it.  I probably won't get to it in detail until next week but I'd really like a chance to look it over.",
    "created_at": "2016-09-22T15:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313638",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Very interesting--I'd like to take some time to review this and all the comments on it.  I probably won't get to it in detail until next week but I'd really like a chance to look it over.



---

archive/issue_comments_313639.json:
```json
{
    "body": "<a id='comment:110'></a>Replying to [comment:104 mkoeppe]:\n> With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook.\n\n\nDid you test with a custom value for `SAGE_LOCAL` (#21501)? Because that should be done (I could do that, but not right now).",
    "created_at": "2016-09-22T15:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313639",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:110'></a>Replying to [comment:104 mkoeppe]:
> With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook.


Did you test with a custom value for `SAGE_LOCAL` (#21501)? Because that should be done (I could do that, but not right now).



---

archive/issue_comments_313640.json:
```json
{
    "body": "<a id='comment:1'></a>I would probably rather test with `--prefix` (#21479).",
    "created_at": "2016-09-22T22:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313640",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>I would probably rather test with `--prefix` (#21479).



---

archive/issue_comments_313641.json:
```json
{
    "body": "<a id='comment:112'></a>Replying to [comment:111 mkoeppe]:\n> I would probably rather test with `--prefix` (#21479).\n\n\nFrom a distro point of view, I would also want it to be tested with the underdocumented `--root`.",
    "created_at": "2016-09-22T23:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313641",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:112'></a>Replying to [comment:111 mkoeppe]:
> I would probably rather test with `--prefix` (#21479).


From a distro point of view, I would also want it to be tested with the underdocumented `--root`.



---

archive/issue_comments_313642.json:
```json
{
    "body": "<a id='comment:113'></a>Replying to [comment:112 fbissey]:\n> Replying to [comment:111 mkoeppe]:\n> > I would probably rather test with `--prefix` (#21479).\n\n> \n> From a distro point of view, I would also want it to be tested with the underdocumented `--root`.\n\n\nIs `--root` an option of `setup.sh`? (I was referring to `./configure --prefix`)",
    "created_at": "2016-09-22T23:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313642",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:113'></a>Replying to [comment:112 fbissey]:
> Replying to [comment:111 mkoeppe]:
> > I would probably rather test with `--prefix` (#21479).

> 
> From a distro point of view, I would also want it to be tested with the underdocumented `--root`.


Is `--root` an option of `setup.sh`? (I was referring to `./configure --prefix`)



---

archive/issue_comments_313643.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.py; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-22T23:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313643",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.py; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313644.json:
```json
{
    "body": "<a id='comment:5'></a>(I meant `setup.py` of course -- I keep making the typo \"`setup.sh`\")",
    "created_at": "2016-09-22T23:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313644",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>(I meant `setup.py` of course -- I keep making the typo "`setup.sh`")



---

archive/issue_comments_313645.json:
```json
{
    "body": "<a id='comment:6'></a>Yes, `setup.py` I should abstain from commenting until my fever goes down :(",
    "created_at": "2016-09-22T23:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313645",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>Yes, `setup.py` I should abstain from commenting until my fever goes down :(



---

archive/issue_comments_313646.json:
```json
{
    "body": "<a id='comment:117'></a>Replying to [comment:112 fbissey]:\n> From a distro point of view, I would also want it to be tested with the underdocumented `--root`.\n\n\nThis is now #21573: Make sure `src/setup.py` respects `--install-base` and `--root`.",
    "created_at": "2016-09-23T04:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313646",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:117'></a>Replying to [comment:112 fbissey]:
> From a distro point of view, I would also want it to be tested with the underdocumented `--root`.


This is now #21573: Make sure `src/setup.py` respects `--install-base` and `--root`.



---

archive/issue_comments_313647.json:
```json
{
    "body": "<a id='comment:118'></a>Replying to [comment:110 jdemeyer]:\n> Replying to [comment:104 mkoeppe]:\n> > With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook.\n\n> \n> Did you test with a custom value for `SAGE_LOCAL` (#21501)? Because that should be done (I could do that, but not right now).\n\n\nI've now tested with #21501 and a fresh build with `SAGE_LOCAL` set to `$SAGE_ROOT/very/far/away/but/still/local`. The Jupyter notebook works.",
    "created_at": "2016-09-23T15:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313647",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:118'></a>Replying to [comment:110 jdemeyer]:
> Replying to [comment:104 mkoeppe]:
> > With this change I've tested that I can do `sage -n jupyter` and then run a kernel from the Jupyter notebook.

> 
> Did you test with a custom value for `SAGE_LOCAL` (#21501)? Because that should be done (I could do that, but not right now).


I've now tested with #21501 and a fresh build with `SAGE_LOCAL` set to `$SAGE_ROOT/very/far/away/but/still/local`. The Jupyter notebook works.



---

archive/issue_comments_313648.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-24T13:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313648",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_313649.json:
```json
{
    "body": "<a id='comment:9'></a>Good enough for me.",
    "created_at": "2016-09-24T13:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313649",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Good enough for me.



---

archive/issue_comments_313650.json:
```json
{
    "body": "<a id='comment:0'></a>Not that it really matters, but `python -u setup.py build install` is superfluous--the `install` command always runs `build` as a sub-command.",
    "created_at": "2016-09-26T11:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313650",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>Not that it really matters, but `python -u setup.py build install` is superfluous--the `install` command always runs `build` as a sub-command.



---

archive/issue_comments_313651.json:
```json
{
    "body": "<a id='comment:1'></a>For the sake of keeping this ticket focused I think it's fine for now, but something definitely needs to be done about using make for the autogenerated sources.  My [comment](https://trac.sagemath.org/ticket/21507#comment:22) in #21507 has some suggestions toward that.  Is there already a separate ticket for dealing with that?  If so I can work on it.",
    "created_at": "2016-09-26T11:29:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313651",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>For the sake of keeping this ticket focused I think it's fine for now, but something definitely needs to be done about using make for the autogenerated sources.  My [comment](https://trac.sagemath.org/ticket/21507#comment:22) in #21507 has some suggestions toward that.  Is there already a separate ticket for dealing with that?  If so I can work on it.



---

archive/issue_comments_313652.json:
```json
{
    "body": "<a id='comment:2'></a>Also, if you'd like, I can suggest a much less \"hacky\" way of handling `--build-base`, is there already a separate ticket for that?",
    "created_at": "2016-09-26T11:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313652",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Also, if you'd like, I can suggest a much less "hacky" way of handling `--build-base`, is there already a separate ticket for that?



---

archive/issue_comments_313653.json:
```json
{
    "body": "<a id='comment:123'></a>Replying to [comment:122 embray]:\n> Also, if you'd like, I can suggest a much less \"hacky\" way of handling `--build-base`, is there already a separate ticket for that?\n\n\n#21573 I guess.",
    "created_at": "2016-09-26T13:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313653",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:123'></a>Replying to [comment:122 embray]:
> Also, if you'd like, I can suggest a much less "hacky" way of handling `--build-base`, is there already a separate ticket for that?


#21573 I guess.



---

archive/issue_comments_313654.json:
```json
{
    "body": "<a id='comment:4'></a>#21573 is for `--install-base` and `--root`.\n\n`--build-base` work should go on either one of the following two:\n- #21508: Clean up src/setup.py to bring it to standard distutils behavior\n- #21535: Make src/setup.py independent of SAGE_CYTHONIZED",
    "created_at": "2016-09-26T14:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313654",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>#21573 is for `--install-base` and `--root`.

`--build-base` work should go on either one of the following two:
- #21508: Clean up src/setup.py to bring it to standard distutils behavior
- #21535: Make src/setup.py independent of SAGE_CYTHONIZED



---

archive/issue_comments_313655.json:
```json
{
    "body": "<a id='comment:125'></a>Replying to [comment:120 embray]:\n> Not that it really matters, but `python -u setup.py build install` is superfluous--the `install` command always runs `build` as a sub-command.\n\nI've left it like this as a little reminder that `--build-base` can go in between.",
    "created_at": "2016-09-26T14:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313655",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:125'></a>Replying to [comment:120 embray]:
> Not that it really matters, but `python -u setup.py build install` is superfluous--the `install` command always runs `build` as a sub-command.

I've left it like this as a little reminder that `--build-base` can go in between.



---

archive/issue_comments_313656.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-09-29T15:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313656",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
 
 Comment: 1
 
``````




---

archive/issue_comments_313657.json:
```json
{
    "body": "<a id='comment:6'></a>For `generate_py_source.mk`, we could even get rid of that and not invoke `make` at all.  For simplicity's sake I could do that as a separate ticket with this one as a dependency.\n\nTo add, I especially don't like what this branch currently does as far as unconditionally invoking `make` every time `setup.py` is run.  But I'm happy to ignore it for now as long as we follow up with further work--I'm opening a new ticket now.",
    "created_at": "2016-09-29T15:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313657",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>For `generate_py_source.mk`, we could even get rid of that and not invoke `make` at all.  For simplicity's sake I could do that as a separate ticket with this one as a dependency.

To add, I especially don't like what this branch currently does as far as unconditionally invoking `make` every time `setup.py` is run.  But I'm happy to ignore it for now as long as we follow up with further work--I'm opening a new ticket now.



---

archive/issue_comments_313658.json:
```json
{
    "body": "<a id='comment:127'></a>Replying to [comment:88 fbissey]:\n> * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. \n\n\nOn the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.\n\nMaybe the location for `cython_debug` can be improved, but I think you should only install it in `SAGE_LOCAL` if you also install the sources somewhere in `SAGE_LOCAL`.",
    "created_at": "2016-09-29T15:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313658",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:127'></a>Replying to [comment:88 fbissey]:
> * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. 


On the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.

Maybe the location for `cython_debug` can be improved, but I think you should only install it in `SAGE_LOCAL` if you also install the sources somewhere in `SAGE_LOCAL`.



---

archive/issue_comments_313659.json:
```json
{
    "body": "<a id='comment:128'></a>Replying to [comment:126 embray]:\n> For `generate_py_source.mk`, we could even get rid of that and not invoke `make` at all.\n\n\nBut `make` does automatic dependency checking for you. Whatever Python alternative you come up with will be more complex than a simple makefile.",
    "created_at": "2016-09-29T15:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313659",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:128'></a>Replying to [comment:126 embray]:
> For `generate_py_source.mk`, we could even get rid of that and not invoke `make` at all.


But `make` does automatic dependency checking for you. Whatever Python alternative you come up with will be more complex than a simple makefile.



---

archive/issue_comments_313660.json:
```json
{
    "body": "<a id='comment:9'></a>I would disagree.  In fact as the discussion in #20730 demonstrates that writing a technically correct makefile for this case results in a makefile that's \"too complicated to understand\".  I can do this correctly in Python with about the same amount of code it takes to invoke make as a subprocess (which is also pretty non-standard to do anything in a Python setup). Not to mention the contents of the Makefile itself (no matter how \"correct\" it is).\n\nPart of the idea is also not to make non-Sage developers blanche when they look inside of sage's setup.py.",
    "created_at": "2016-09-29T15:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313660",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>I would disagree.  In fact as the discussion in #20730 demonstrates that writing a technically correct makefile for this case results in a makefile that's "too complicated to understand".  I can do this correctly in Python with about the same amount of code it takes to invoke make as a subprocess (which is also pretty non-standard to do anything in a Python setup). Not to mention the contents of the Makefile itself (no matter how "correct" it is).

Part of the idea is also not to make non-Sage developers blanche when they look inside of sage's setup.py.



---

archive/issue_comments_313661.json:
```json
{
    "body": "<a id='comment:130'></a>Replying to [comment:127 jdemeyer]:\n> Replying to [comment:88 fbissey]:\n> > * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. \n \n> \n> On the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.\n\n\nThis is why I also like to output the C(++) sources themselves to be close to the cython sources but you said you don't like :)",
    "created_at": "2016-09-29T16:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313661",
    "user": "https://github.com/embray"
}
```

<a id='comment:130'></a>Replying to [comment:127 jdemeyer]:
> Replying to [comment:88 fbissey]:
> > * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. 
 
> 
> On the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.


This is why I also like to output the C(++) sources themselves to be close to the cython sources but you said you don't like :)



---

archive/issue_comments_313662.json:
```json
{
    "body": "<a id='comment:131'></a>Replying to [comment:128 jdemeyer]:\n> But `make` does automatic dependency checking for you. Whatever Python alternative you come up with will be more complex than a simple makefile.\n\n\ntrue.\n\nthere is a python alternative that is no more complex than a simple makefile *plus* make. it's the simple makefile + a *subset* of make implemented in python. (yes, you could use GNU make as an intermediate solution...)\n\nbut seriously: what's all the fuss about reinventing and replacing make? it should obviously be the other way round: python is not the right tool for the job, it's make. unlike python, make is *designed* for this. no matter which language you implement it in.\n\nif there's a need for a make replacement (completely different[tm]), is sage the right community or the right project to invent it in?",
    "created_at": "2016-09-29T16:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313662",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:131'></a>Replying to [comment:128 jdemeyer]:
> But `make` does automatic dependency checking for you. Whatever Python alternative you come up with will be more complex than a simple makefile.


true.

there is a python alternative that is no more complex than a simple makefile *plus* make. it's the simple makefile + a *subset* of make implemented in python. (yes, you could use GNU make as an intermediate solution...)

but seriously: what's all the fuss about reinventing and replacing make? it should obviously be the other way round: python is not the right tool for the job, it's make. unlike python, make is *designed* for this. no matter which language you implement it in.

if there's a need for a make replacement (completely different[tm]), is sage the right community or the right project to invent it in?



---

archive/issue_comments_313663.json:
```json
{
    "body": "<a id='comment:132'></a>Replying to [comment:130 embray]:\n> Replying to [comment:127 jdemeyer]:\n> > Replying to [comment:88 fbissey]:\n> > > * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. \n \n> > \n> > On the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.\n\n> \n> This is why I also like to output the C(++) sources themselves to be close to the cython sources but you said you don't like :)\n\n\n\nFor the record: in sage-on-gentoo I ship the `.pyx` files next to the matching `.so` files. In any case distro ship debugging symbols without the sources. Of course at some point you may need the source code but this is trivial to get and unfold separately in most cases.",
    "created_at": "2016-09-29T20:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313663",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:132'></a>Replying to [comment:130 embray]:
> Replying to [comment:127 jdemeyer]:
> > Replying to [comment:88 fbissey]:
> > > * Is there a standard place where `cython_debug` can be installed? It is needed for debugging and shouldn't live under `SAGE_SRC`. 
 
> > 
> > On the other hand, debugging also requires the *sources* to be available. So it is not a crazy idea to keep the debug info close to the sources.

> 
> This is why I also like to output the C(++) sources themselves to be close to the cython sources but you said you don't like :)



For the record: in sage-on-gentoo I ship the `.pyx` files next to the matching `.so` files. In any case distro ship debugging symbols without the sources. Of course at some point you may need the source code but this is trivial to get and unfold separately in most cases.



---

archive/issue_comments_313664.json:
```json
{
    "body": "<a id='comment:3'></a>This ticket introduces an autotools dependency (src/Makefile.in) and fails on OSX",
    "created_at": "2016-10-03T10:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313664",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>This ticket introduces an autotools dependency (src/Makefile.in) and fails on OSX



---

archive/issue_comments_313665.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-03T10:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313665",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_313666.json:
```json
{
    "body": "<a id='comment:4'></a>The is the usual breakage of your release management scripts in case of changes to `configure`.",
    "created_at": "2016-10-03T13:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313666",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>The is the usual breakage of your release management scripts in case of changes to `configure`.



---

archive/issue_comments_313667.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,23 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n+\n+**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-183.tar.gz\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-10-03T13:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313667",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,23 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
+
+**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-183.tar.gz
 
 Comment: 1
 
``````




---

archive/issue_comments_313668.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-03T13:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313668",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_313669.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2016-10-03T13:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313669",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_313670.json:
```json
{
    "body": "<a id='comment:7'></a>This now conflicts with the configure spkg version change in 7.4.rc0.\nSeems to me incrementing configure spkg versions is something that should be done by the release manager.",
    "created_at": "2016-10-08T19:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313670",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>This now conflicts with the configure spkg version change in 7.4.rc0.
Seems to me incrementing configure spkg versions is something that should be done by the release manager.



---

archive/issue_comments_313671.json:
```json
{
    "body": "<a id='comment:138'></a>Replying to [comment:137 mkoeppe]:\n> This now conflicts with the configure spkg version change in 7.4.rc0.\n> Seems to me incrementing configure spkg versions is something that should be done by the release manager.\n\n\nI know, it is really annoying.",
    "created_at": "2016-10-09T07:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313671",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:138'></a>Replying to [comment:137 mkoeppe]:
> This now conflicts with the configure spkg version change in 7.4.rc0.
> Seems to me incrementing configure spkg versions is something that should be done by the release manager.


I know, it is really annoying.



---

archive/issue_comments_313672.json:
```json
{
    "body": "<a id='comment:9'></a>This problem happens every time that you make non-trivial changes to `configure.ac`",
    "created_at": "2016-10-09T07:44:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313672",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>This problem happens every time that you make non-trivial changes to `configure.ac`



---

archive/issue_comments_313673.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,23 @@\n+This ticket changes the build process of sagelib in the following way:\n+- `src/Makefile` delegates ALL building to `src/setup.py`\n+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.\n \n+This ticket is meant as:\n+- preparation for VPATH builds of sage-the-distribution (#21469)\n+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI\n+- making the flow of directory information at build time clearer for developers\n+\n+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)\n+\n+. . . . . . . \n+\n+Some possibly useful information:\n+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.\n+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. \n+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this\n+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.\n+\n+**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-185.tar.gz\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-10-09T07:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313673",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,23 @@
+This ticket changes the build process of sagelib in the following way:
+- `src/Makefile` delegates ALL building to `src/setup.py`
+- `src/setup.py` no longer depends on environment variables `$SAGE_ROOT`, `$SAGE_SRC`, `$SAGE_DOC_SRC` etc. (to demonstrate this, `Makefile` poisons these environment variables). It still depends on `$SAGE_LOCAL` and environment variables that point below it.
 
+This ticket is meant as:
+- preparation for VPATH builds of sage-the-distribution (#21469)
+- working towards the goal of making `sagelib` pip-installable -- see #21507 for the eventual goal of having sagelib on PyPI
+- making the flow of directory information at build time clearer for developers
+
+ More specifically, the goal of this ticket is that only SAGE_LOCAL needs to be set when the user does 'pip install' of the sagelib. (This ticket almost achieves this, except it also needs SAGE_PKGS and SAGE_CYTHONIZED to be set. The hope is that #20382 and other future tickets will develop better mechanisms to communicate package and directory information to the build.)
+
+. . . . . . . 
+
+Some possibly useful information:
+- Documentation on distutils (https://docs.python.org/2/install/), describing use of `--build-base` to do VPATH builds.
+- `pip install` keeps the source directory clean, building instead in a temporary directory, by copying the sources. 
+ `pip install` also offers options `--build` to select a build directory, but there are some pip issues: [2060](https://github.com/pypa/pip/issues/2060), [2053](https://github.com/pypa/pip/issues/2053), [804](https://github.com/pypa/pip/issues/804) that affect this
+- #14807 has some tricks to making VPATH builds work without copying all python source files. But it uses automake instead of setup.sh; we will not do this in our ticket.
+
+**configure tarball**: http://sage.ugent.be/www/jdemeyer/sage/configure-185.tar.gz
 
 Comment: 1
 
``````




---

archive/issue_comments_313674.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2016-10-09T07:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313674",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_313675.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-10-09T07:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313675",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_313676.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-09T07:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313676",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_313677.json:
```json
{
    "body": "<a id='comment:3'></a>This should be merged as soon as possible to avoid further problems with `configure`.",
    "created_at": "2016-10-09T08:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313677",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>This should be merged as soon as possible to avoid further problems with `configure`.



---

archive/issue_comments_313678.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2016-10-09T08:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313678",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_313679.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-12T06:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21480#issuecomment-313679",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_057045.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-12T06:53:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21480",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21480#event-57045"
}
```
