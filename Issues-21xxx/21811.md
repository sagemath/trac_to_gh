# Issue 21811: libecl does not install with libffi 3.3 (e.g. on OpenSuSE gcc5-7, Debian 11, etc)

archive/issues_021574.json:
```json
{
    "body": "Compile on OpenSuSE 42.2/15.1 with gcc stops at\n\n```\n[ecl-16.1.2.p2] gcc -DECLDIR=\"\\\"/home/ralf/sage/local/lib/ecl-16.1.2\\\"\" -I. -I/h\nome/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/build -I/home/ralf/sage\n/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c -I../ecl/gc -DECL_API -DECL_NO\n_LEGACY   -I/home/ralf/sage/local/include  -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 \n-g -O2  -fPIC -Dlinux -c -o ffi.o ffi.o.c\n[ecl-16.1.2.p2] /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c\n/ffi.d:148:44: error: 'FFI_SYSV' undeclared here (not in a function)\n[ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed\n```\n\nThe package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h\n\nIt turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if `__x86_64__` is defined because the `__x86_64__` case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:\n\n```\n#ifdef HAVE_LIBFFI\nstatic struct {\n        const cl_object symbol;\n        ffi_abi abi;\n} ecl_foreign_cc_table[] = {\n        {@':default', FFI_DEFAULT_ABI},\n#ifdef X86_WIN32\n        {@':cdecl', FFI_SYSV},\n        {@':sysv', FFI_SYSV},\n        {@':stdcall', FFI_STDCALL},\n#elif defined(X86_WIN64)\n        {@':win64', FFI_WIN64},\n#elif defined(X86_ANY) || defined(X86) || defined(X86_64)\n        {@':cdecl', FFI_SYSV},\n        {@':sysv', FFI_SYSV},\n        {@':unix64', FFI_UNIX64},\n#endif\n};\n```\n\nReported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302\n\nThe workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.\n\nAnother workaround is using `SAGE_INSTALL_GCC=yes` when making Sage.\n\nLog is attached to #21804.\n\nSee also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n\nCC:  crmafra@gmail.com @mkoeppe @kiwifb\n\nBranch/Commit: [72c76961846da1ee6280053b2443d9407b2546fc](https://github.com/sagemath/sagetrac-mirror/commit/72c76961846da1ee6280053b2443d9407b2546fc)\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Matthias Koeppe\n\nAuthor: Dima Pasechnik\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21811\n\n",
    "closed_at": "2020-02-10T20:06:06Z",
    "created_at": "2016-11-03T14:49:11Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "libecl does not install with libffi 3.3 (e.g. on OpenSuSE gcc5-7, Debian 11, etc)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21811",
    "user": "https://github.com/rwst"
}
```
Compile on OpenSuSE 42.2/15.1 with gcc stops at

```
[ecl-16.1.2.p2] gcc -DECLDIR="\"/home/ralf/sage/local/lib/ecl-16.1.2\"" -I. -I/h
ome/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/build -I/home/ralf/sage
/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c -I../ecl/gc -DECL_API -DECL_NO
_LEGACY   -I/home/ralf/sage/local/include  -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 
-g -O2  -fPIC -Dlinux -c -o ffi.o ffi.o.c
[ecl-16.1.2.p2] /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c
/ffi.d:148:44: error: 'FFI_SYSV' undeclared here (not in a function)
[ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed
```

The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h

It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if `__x86_64__` is defined because the `__x86_64__` case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:

```
#ifdef HAVE_LIBFFI
static struct {
        const cl_object symbol;
        ffi_abi abi;
} ecl_foreign_cc_table[] = {
        {@':default', FFI_DEFAULT_ABI},
#ifdef X86_WIN32
        {@':cdecl', FFI_SYSV},
        {@':sysv', FFI_SYSV},
        {@':stdcall', FFI_STDCALL},
#elif defined(X86_WIN64)
        {@':win64', FFI_WIN64},
#elif defined(X86_ANY) || defined(X86) || defined(X86_64)
        {@':cdecl', FFI_SYSV},
        {@':sysv', FFI_SYSV},
        {@':unix64', FFI_UNIX64},
#endif
};
```

Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302

The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.

Another workaround is using `SAGE_INSTALL_GCC=yes` when making Sage.

Log is attached to #21804.

See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU

CC:  crmafra@gmail.com @mkoeppe @kiwifb

Branch/Commit: [72c76961846da1ee6280053b2443d9407b2546fc](https://github.com/sagemath/sagetrac-mirror/commit/72c76961846da1ee6280053b2443d9407b2546fc)

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Matthias Koeppe

Author: Dima Pasechnik

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21811





---

archive/issue_comments_405596.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -11,6 +11,8 @@\n [ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed\n ```\n \n+The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h\n+\n Log is attached to #21804.\n \n See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n``````\n",
    "created_at": "2016-11-03T14:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405596",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -11,6 +11,8 @@
 [ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed
 ```
 
+The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h
+
 Log is attached to #21804.
 
 See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU
``````




---

archive/issue_comments_405597.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,6 +13,8 @@\n \n The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h\n \n+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well).\n+\n Log is attached to #21804.\n \n See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n``````\n",
    "created_at": "2016-11-03T15:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405597",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,6 +13,8 @@
 
 The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h
 
+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well).
+
 Log is attached to #21804.
 
 See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU
``````




---

archive/issue_comments_405598.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,7 +13,30 @@\n \n The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h\n \n-It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well).\n+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:\n+\n+```\n+#ifdef HAVE_LIBFFI\n+static struct {\n+        const cl_object symbol;\n+        ffi_abi abi;\n+} ecl_foreign_cc_table[] = {\n+        {@':default', FFI_DEFAULT_ABI},\n+#ifdef X86_WIN32\n+        {@':cdecl', FFI_SYSV},\n+        {@':sysv', FFI_SYSV},\n+        {@':stdcall', FFI_STDCALL},\n+#elif defined(X86_WIN64)\n+        {@':win64', FFI_WIN64},\n+#elif defined(X86_ANY) || defined(X86) || defined(X86_64)\n+        {@':cdecl', FFI_SYSV},\n+        {@':sysv', FFI_SYSV},\n+        {@':unix64', FFI_UNIX64},\n+#endif\n+};\n+```\n+\n+https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87\n \n Log is attached to #21804.\n \n``````\n",
    "created_at": "2016-11-03T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405598",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,7 +13,30 @@
 
 The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h
 
-It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well).
+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:
+
+```
+#ifdef HAVE_LIBFFI
+static struct {
+        const cl_object symbol;
+        ffi_abi abi;
+} ecl_foreign_cc_table[] = {
+        {@':default', FFI_DEFAULT_ABI},
+#ifdef X86_WIN32
+        {@':cdecl', FFI_SYSV},
+        {@':sysv', FFI_SYSV},
+        {@':stdcall', FFI_STDCALL},
+#elif defined(X86_WIN64)
+        {@':win64', FFI_WIN64},
+#elif defined(X86_ANY) || defined(X86) || defined(X86_64)
+        {@':cdecl', FFI_SYSV},
+        {@':sysv', FFI_SYSV},
+        {@':unix64', FFI_UNIX64},
+#endif
+};
+```
+
+https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87
 
 Log is attached to #21804.
 
``````




---

archive/issue_comments_405599.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe incompatible libffi change happened here:\n\n```\ncommit ef76205647bca77796882d31f6ab5e889f461f07\nAuthor: Richard Henderson <rth@twiddle.net>\nDate:   Thu Oct 30 12:13:31 2014 -0700\n\n    x86: Tidy ffi_abi\n    \n    The x86_64 unix port only handles one ABI; don't define all of the\n    other symbols.  The UNIX64 symbol retains the same value.\n    \n    The i386 ports ought to have the same symbols, even if we can't yet\n    unify the values without incrementing the libffi soname.\n```\n\nThis means all libffi versions from 3.2 up are incompatible.",
    "created_at": "2016-11-03T16:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405599",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>
The incompatible libffi change happened here:

```
commit ef76205647bca77796882d31f6ab5e889f461f07
Author: Richard Henderson <rth@twiddle.net>
Date:   Thu Oct 30 12:13:31 2014 -0700

    x86: Tidy ffi_abi
    
    The x86_64 unix port only handles one ABI; don't define all of the
    other symbols.  The UNIX64 symbol retains the same value.
    
    The i386 ports ought to have the same symbols, even if we can't yet
    unify the values without incrementing the libffi soname.
```

This means all libffi versions from 3.2 up are incompatible.



---

archive/issue_comments_405600.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,7 +13,7 @@\n \n The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h\n \n-It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:\n+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if `__x86_64__` is defined because the `__x86_64__` case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:\n \n ```\n #ifdef HAVE_LIBFFI\n@@ -35,6 +35,7 @@\n #endif\n };\n ```\n+(The macro `__x86_64__` gets somewhere copied to `X86_64`)\n \n https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87\n \n``````\n",
    "created_at": "2016-11-03T16:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405600",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,7 +13,7 @@
 
 The package libffi-devel-gcc5 is installed. The file `/usr/include/ffi.h` does not contain FFI_SYSV but the file ffitarget.h does and it is included unconditionally in ffi.h
 
-It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if X86_64 is defined because the X86_64 case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:
+It turns out the reason for the failure on OpenSuSE is that in ffitarget.h FFI_SYSV is not defined if `__x86_64__` is defined because the `__x86_64__` case preceeds the default case (where FFI_SYSV is defined as well). ECL however has this in `src/c/ffi.d`:
 
 ```
 #ifdef HAVE_LIBFFI
@@ -35,6 +35,7 @@
 #endif
 };
 ```
+(The macro `__x86_64__` gets somewhere copied to `X86_64`)
 
 https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87
 
``````




---

archive/issue_comments_405601.json:
```json
{
    "body": "<a id='comment:6'></a>\nHave you reported this upstream?",
    "created_at": "2016-11-03T17:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405601",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Have you reported this upstream?



---

archive/issue_comments_405602.json:
```json
{
    "body": "<a id='comment:7'></a>\nWhat would be upstream here? Libffi or libecl? Remember also that it shows only on OpenSUSE so maybe we're missing something about these flags.",
    "created_at": "2016-11-03T17:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405602",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>
What would be upstream here? Libffi or libecl? Remember also that it shows only on OpenSUSE so maybe we're missing something about these flags.



---

archive/issue_comments_405603.json:
```json
{
    "body": "<a id='comment:8'></a>\nI know nothing about ffi nor ecl but I think this should be reported to ecl.",
    "created_at": "2016-11-03T19:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405603",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I know nothing about ffi nor ecl but I think this should be reported to ecl.



---

archive/issue_comments_405604.json:
```json
{
    "body": "<a id='comment:9'></a>\ngiven that libffi is used all over the place, including CPython, it's most probably ECL-specific issue, or OpenSUSE-specific issue...",
    "created_at": "2016-11-03T22:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405604",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
given that libffi is used all over the place, including CPython, it's most probably ECL-specific issue, or OpenSUSE-specific issue...



---

archive/issue_comments_405605.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -37,7 +37,7 @@\n ```\n (The macro `__x86_64__` gets somewhere copied to `X86_64`)\n \n-https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87\n+Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302\n \n Log is attached to #21804.\n \n``````\n",
    "created_at": "2016-11-04T07:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405605",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -37,7 +37,7 @@
 ```
 (The macro `__x86_64__` gets somewhere copied to `X86_64`)
 
-https://github.com/libffi/libffi/blob/master/src/x86/ffitarget.h#L87
+Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302
 
 Log is attached to #21804.
 
``````




---

archive/issue_comments_405606.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2016-11-04T07:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405606",
    "user": "https://github.com/rwst"
}
```

Changing upstream from "N/A" to "Reported upstream. No feedback yet."



---

archive/issue_comments_405607.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -39,6 +39,8 @@\n \n Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302\n \n+The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.\n+\n Log is attached to #21804.\n \n See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n``````\n",
    "created_at": "2016-11-05T08:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405607",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -39,6 +39,8 @@
 
 Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302
 
+The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.
+
 Log is attached to #21804.
 
 See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU
``````




---

archive/issue_comments_405608.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -35,12 +35,13 @@\n #endif\n };\n ```\n-(The macro `__x86_64__` gets somewhere copied to `X86_64`)\n \n Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302\n \n The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.\n \n+Another workaround is using `SAGE_INTERNAL_GCC=yes` when making Sage.\n+\n Log is attached to #21804.\n \n See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n``````\n",
    "created_at": "2016-11-05T14:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405608",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -35,12 +35,13 @@
 #endif
 };
 ```
-(The macro `__x86_64__` gets somewhere copied to `X86_64`)
 
 Reported as https://gitlab.com/embeddable-common-lisp/ecl/issues/302
 
 The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.
 
+Another workaround is using `SAGE_INTERNAL_GCC=yes` when making Sage.
+
 Log is attached to #21804.
 
 See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU
``````




---

archive/issue_comments_405609.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -40,7 +40,7 @@\n \n The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.\n \n-Another workaround is using `SAGE_INTERNAL_GCC=yes` when making Sage.\n+Another workaround is using `SAGE_INSTALL_GCC=yes` when making Sage.\n \n Log is attached to #21804.\n \n``````\n",
    "created_at": "2016-11-17T09:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405609",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -40,7 +40,7 @@
 
 The workaround would be to deinstall the OpenSuSE package libffi-devel-gcc5 which falls back to installing an earlier version of libffi-devel. Ultimately this must be resolved in libecl/libffi however.
 
-Another workaround is using `SAGE_INTERNAL_GCC=yes` when making Sage.
+Another workaround is using `SAGE_INSTALL_GCC=yes` when making Sage.
 
 Log is attached to #21804.
 
``````




---

archive/issue_comments_405610.json:
```json
{
    "body": "<a id='comment:15'></a>\nis this still relevant (the OS most probably has been updated...)",
    "created_at": "2019-05-28T13:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405610",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>
is this still relevant (the OS most probably has been updated...)



---

archive/issue_comments_405611.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [dimpase](#comment%3A15):\n> is this still relevant (the OS most probably has been updated...)\n\n\nIt is still relevant. I am using the modern openSUSE Leap 15.0 and compiling sage gives the same error as in this bug report (a google search on the error led me here).\nI had to uninstall libffi-devel from openSUSE.",
    "created_at": "2019-05-28T14:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405611",
    "user": "https://trac.sagemath.org/admin/accounts/users/mafra"
}
```

<a id='comment:16'></a>
Replying to [dimpase](#comment%3A15):
> is this still relevant (the OS most probably has been updated...)


It is still relevant. I am using the modern openSUSE Leap 15.0 and compiling sage gives the same error as in this bug report (a google search on the error led me here).
I had to uninstall libffi-devel from openSUSE.



---

archive/issue_comments_405612.json:
```json
{
    "body": "<a id='comment:17'></a>\nOne thing in the ticket description is buffling - that building Sage's gcc package is another workaround. As well, the topic still says gcc5 - aren't you on gcc7 meanwhile?\n\nSo all this needs an update, I suppose.",
    "created_at": "2019-05-28T20:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405612",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
One thing in the ticket description is buffling - that building Sage's gcc package is another workaround. As well, the topic still says gcc5 - aren't you on gcc7 meanwhile?

So all this needs an update, I suppose.



---

archive/issue_comments_405613.json:
```json
{
    "body": "<a id='comment:18'></a>\nConfirm this happens on OpenSuSE Leap 15.1/gcc-7.4.1 as well, and the deinstall workaround is still valid.",
    "created_at": "2019-08-27T07:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405613",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>
Confirm this happens on OpenSuSE Leap 15.1/gcc-7.4.1 as well, and the deinstall workaround is still valid.



---

archive/issue_events_065579.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2019-08-27T07:32:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65579"
}
```



---

archive/issue_comments_405614.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Compile on OpenSuSE 42.2 with gcc set to gcc5 stops at\n+Compile on OpenSuSE 42.2/15.1 with gcc stops at\n \n ```\n [ecl-16.1.2.p2] gcc -DECLDIR=\"\\\"/home/ralf/sage/local/lib/ecl-16.1.2\\\"\" -I. -I/h\n``````\n",
    "created_at": "2019-08-27T07:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405614",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Compile on OpenSuSE 42.2 with gcc set to gcc5 stops at
+Compile on OpenSuSE 42.2/15.1 with gcc stops at
 
 ```
 [ecl-16.1.2.p2] gcc -DECLDIR="\"/home/ralf/sage/local/lib/ecl-16.1.2\"" -I. -I/h
``````




---

archive/issue_events_065580.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "rename": {
        "from": "libecl does not install with OpenSuSE gcc5",
        "to": "libecl does not install with OpenSuSE gcc5-7"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65580"
}
```



---

archive/issue_comments_405615.json:
```json
{
    "body": "<a id='comment:19'></a>\ndoes it help to build Sage's libffi, rather than use the system's one?\n(i.e., do `./sage -f libffi` followed by a rebuild?) \n\n---\n\nUPDATE - no, it does not, according to\nhttps://groups.google.com/d/msg/sage-devel/h0BhI2HPUb0/tEXci95CAgAJ",
    "created_at": "2019-08-27T07:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405615",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
does it help to build Sage's libffi, rather than use the system's one?
(i.e., do `./sage -f libffi` followed by a rebuild?) 

---

UPDATE - no, it does not, according to
https://groups.google.com/d/msg/sage-devel/h0BhI2HPUb0/tEXci95CAgAJ



---

archive/issue_comments_405616.json:
```json
{
    "body": "<a id='comment:20'></a>\nI'm seeing the same issue on NixOS since the recent (https://github.com/libffi/libffi/releases) libffi v3.3 update. More specifically, git-bisect shows https://github.com/libffi/libffi/commit/982b89c01aca99c7bc229914fc1521f96930919b to be responsible. The headers were formerly installed in the lib dir, and are how (correctly) installed in the include dir.\n\nIts possible that OpenSuSE had already adopted a patch to fix this. Can anybody else confirm that ecl fails with libffi v3.3?",
    "created_at": "2019-12-14T12:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405616",
    "user": "https://github.com/timokau"
}
```

<a id='comment:20'></a>
I'm seeing the same issue on NixOS since the recent (https://github.com/libffi/libffi/releases) libffi v3.3 update. More specifically, git-bisect shows https://github.com/libffi/libffi/commit/982b89c01aca99c7bc229914fc1521f96930919b to be responsible. The headers were formerly installed in the lib dir, and are how (correctly) installed in the include dir.

Its possible that OpenSuSE had already adopted a patch to fix this. Can anybody else confirm that ecl fails with libffi v3.3?



---

archive/issue_comments_405617.json:
```json
{
    "body": "<a id='comment:21'></a>\nI made a mistake when bisecting. Now I also end up at the same commit `@`rws reported a couple of years ago. I was able to fix it by replacing the usage of FFI_SYSV as suggested by gentoo: https://wiki.gentoo.org/wiki/Libffi_3.3_porting_notes/FFI_SYSV\n\nCuriously enough, gentoo hasn't patched ecl themselves yet. But they haven't marked libffi 3.3 as stable either yet.",
    "created_at": "2019-12-16T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405617",
    "user": "https://github.com/timokau"
}
```

<a id='comment:21'></a>
I made a mistake when bisecting. Now I also end up at the same commit `@`rws reported a couple of years ago. I was able to fix it by replacing the usage of FFI_SYSV as suggested by gentoo: https://wiki.gentoo.org/wiki/Libffi_3.3_porting_notes/FFI_SYSV

Curiously enough, gentoo hasn't patched ecl themselves yet. But they haven't marked libffi 3.3 as stable either yet.



---

archive/issue_comments_405618.json:
```json
{
    "body": "<a id='comment:22'></a>\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405618",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
Ticket retargeted after milestone closed



---

archive/issue_events_065581.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65581"
}
```



---

archive/issue_events_065582.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65582"
}
```



---

archive/issue_comments_405619.json:
```json
{
    "body": "<a id='comment:23'></a>\nWe're going to fix the Sage side of this on #29128 (ECL must get the prefix of libffi intallation, so that the good one can be used).",
    "created_at": "2020-01-31T22:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405619",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
We're going to fix the Sage side of this on #29128 (ECL must get the prefix of libffi intallation, so that the good one can be used).



---

archive/issue_comments_405620.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. No feedback yet.\" to \"Fixed upstream, but not in a stable release.\"",
    "created_at": "2020-02-03T17:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405620",
    "user": "https://github.com/dimpase"
}
```

Changing upstream from "Reported upstream. No feedback yet." to "Fixed upstream, but not in a stable release."



---

archive/issue_comments_405621.json:
```json
{
    "body": "<a id='comment:25'></a>\nSee https://gitlab.com/embeddable-common-lisp/ecl/commit/b2f09b4809441a92d6c11a2b39d5399580e56ae7\n\nfor upstream fix, pointed by https://gitlab.com/embeddable-common-lisp/ecl/issues/302",
    "created_at": "2020-02-03T17:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405621",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
See https://gitlab.com/embeddable-common-lisp/ecl/commit/b2f09b4809441a92d6c11a2b39d5399580e56ae7

for upstream fix, pointed by https://gitlab.com/embeddable-common-lisp/ecl/issues/302



---

archive/issue_comments_405622.json:
```json
{
    "body": "Changing author from \"\" to \"Dima Pasechnik\"",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405622",
    "user": "https://github.com/dimpase"
}
```

Changing author from "" to "Dima Pasechnik"



---

archive/issue_comments_405623.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405623",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405624.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dimpase/packages/ecl/ffi_abi_libffi33.patch\"",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405624",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "" to "u/dimpase/packages/ecl/ffi_abi_libffi33.patch"



---

archive/issue_comments_405625.json:
```json
{
    "body": "Changing commit from \"\" to \"72c76961846da1ee6280053b2443d9407b2546fc\"",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405625",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "72c76961846da1ee6280053b2443d9407b2546fc"



---

archive/issue_comments_405626.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'll close  #29128 as won't fix and work here instead. \n\n---\nNew commits:\n|                                                                                                                                          |                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[72c7696](https://github.com/sagemath/sagetrac-mirror/commit/72c76961846da1ee6280053b2443d9407b2546fc)|`allow use of libffi version >= 3.3 by ECL`|",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405626",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
I'll close  #29128 as won't fix and work here instead. 

---
New commits:
|                                                                                                                                          |                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[72c7696](https://github.com/sagemath/sagetrac-mirror/commit/72c76961846da1ee6280053b2443d9407b2546fc)|`allow use of libffi version >= 3.3 by ECL`|



---

archive/issue_comments_405627.json:
```json
{
    "body": "<a id='comment:27'></a>\ntested with system libffi 3.3 on Debian 11 (x86_64), as well as on various x86_64 and i386 linuxis with libffi 3.2.",
    "created_at": "2020-02-03T23:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405627",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
tested with system libffi 3.3 on Debian 11 (x86_64), as well as on various x86_64 and i386 linuxis with libffi 3.2.



---

archive/issue_events_065583.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "rename": {
        "from": "libecl does not install with OpenSuSE gcc5-7",
        "to": "libecl does not install with libffi 3.3 (e.g. on OpenSuSE gcc5-7, Debian 11, etc)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65583"
}
```



---

archive/issue_comments_405628.json:
```json
{
    "body": "<a id='comment:29'></a>\nTesting at https://github.com/mkoeppe/sage/pull/2",
    "created_at": "2020-02-06T15:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405628",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
Testing at https://github.com/mkoeppe/sage/pull/2



---

archive/issue_comments_405629.json:
```json
{
    "body": "<a id='comment:30'></a>\nand at https://github.com/mkoeppe/sage/actions/runs/35630769",
    "created_at": "2020-02-06T21:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405629",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
and at https://github.com/mkoeppe/sage/actions/runs/35630769



---

archive/issue_comments_405630.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-02-07T20:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405630",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_405631.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-07T20:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405631",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405632.json:
```json
{
    "body": "<a id='comment:31'></a>\nLooking good.",
    "created_at": "2020-02-07T20:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405632",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>
Looking good.



---

archive/issue_comments_405633.json:
```json
{
    "body": "<a id='comment:32'></a>\nFWIW, I just checked that 9.1.beta3 + #21811 can be built after `make distclean` On Debian testing running on core i7 + 16 GB RAM.\n\nHTH,",
    "created_at": "2020-02-08T20:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405633",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:32'></a>
FWIW, I just checked that 9.1.beta3 + #21811 can be built after `make distclean` On Debian testing running on core i7 + 16 GB RAM.

HTH,



---

archive/issue_comments_405634.json:
```json
{
    "body": "Changing branch from \"u/dimpase/packages/ecl/ffi_abi_libffi33.patch\" to \"72c76961846da1ee6280053b2443d9407b2546fc\"",
    "created_at": "2020-02-10T20:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405634",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dimpase/packages/ecl/ffi_abi_libffi33.patch" to "72c76961846da1ee6280053b2443d9407b2546fc"



---

archive/issue_comments_405635.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-10T20:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21811#issuecomment-405635",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065584.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-02-10T20:06:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21811",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21811#event-65584"
}
```
