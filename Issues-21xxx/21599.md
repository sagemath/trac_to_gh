# Issue 21599: Work around non-deterministic failure of uncompress on Windows

archive/issues_021362.json:
```json
{
    "body": "I've noticed sometimes while building on Windows / Cygwin (though this isn't cygwin-specific) some package builds can fail randomly, usually during the uncompress step.  Re-rerunning the build a second time always succeeds.\n\nThis happened one time recently and I realized there was a Python traceback leading back to the `os.rename` call wrapped by the attached patch.\n\nThis can happen because if any background process happens to have any file in the tree open, even briefly, the renaming the entire directory can fail.  So this is especially likely to happen when unpacking source tarballs containing a large number of files.\n\nThere may be other points where this can happen, and I'll apply the same workaround if/when I encounter them. \n\n**Branch/Commit:** [69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Erik Bray\n\nIssue created by migration from https://trac.sagemath.org/ticket/21599\n\n",
    "closed_at": "2016-10-29T14:27:08Z",
    "created_at": "2016-09-26T12:55:17Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Work around non-deterministic failure of uncompress on Windows",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21599",
    "user": "https://github.com/embray"
}
```
I've noticed sometimes while building on Windows / Cygwin (though this isn't cygwin-specific) some package builds can fail randomly, usually during the uncompress step.  Re-rerunning the build a second time always succeeds.

This happened one time recently and I realized there was a Python traceback leading back to the `os.rename` call wrapped by the attached patch.

This can happen because if any background process happens to have any file in the tree open, even briefly, the renaming the entire directory can fail.  So this is especially likely to happen when unpacking source tarballs containing a large number of files.

There may be other points where this can happen, and I'll apply the same workaround if/when I encounter them. 

**Branch/Commit:** [69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)

**Reviewer:** Jeroen Demeyer

**Author:** Erik Bray

Issue created by migration from https://trac.sagemath.org/ticket/21599





---

archive/issue_events_197210.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-09-26T12:55:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197210"
}
```



---

archive/issue_events_197211.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T13:33:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197211"
}
```



---

archive/issue_events_197212.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-26T13:33:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197212"
}
```



---

archive/issue_comments_321409.json:
```json
{
    "body": "<a id='comment:2'></a>\n1. If the final try failed, the exception should be raised!\n\nAnd then some bikeshedding:\n\n2. The usual way to handle such things is an exponential sleep. So I would suggest a `delay *= 2` in the while loop.\n\n3. I would also prefer to see `tries` instead of `retries`. I find it easier to understand \"3 tries\" instead of \"1 try and 2 retries\". And you know that, because you found it necessary to explain in the docstring.\n\nAnd of course this is an ugly hack, but that's not your fault.",
    "created_at": "2016-09-26T13:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321409",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
1. If the final try failed, the exception should be raised!

And then some bikeshedding:

2. The usual way to handle such things is an exponential sleep. So I would suggest a `delay *= 2` in the while loop.

3. I would also prefer to see `tries` instead of `retries`. I find it easier to understand "3 tries" instead of "1 try and 2 retries". And you know that, because you found it necessary to explain in the docstring.

And of course this is an ugly hack, but that's not your fault.



---

archive/issue_comments_321410.json:
```json
{
    "body": "<a id='comment:3'></a>\nD'oh! Agreed with all of the above.",
    "created_at": "2016-09-26T15:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321410",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
D'oh! Agreed with all of the above.



---

archive/issue_comments_321411.json:
```json
{
    "body": "<a id='comment:4'></a>\nAnd yes it's an ugly hack but not an uncommon one.  I feel like I've done this a dozen other times for Windows support in various places.",
    "created_at": "2016-09-26T15:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321411",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
And yes it's an ugly hack but not an uncommon one.  I feel like I've done this a dozen other times for Windows support in various places.



---

archive/issue_comments_321412.json:
```json
{
    "body": "**Changing commit** from \"[21d46ab3f71017d5e982ee6c844b44c6ca2f2528](https://github.com/sagemath/sagetrac-mirror/commit/21d46ab3f71017d5e982ee6c844b44c6ca2f2528)\" to \"[822f0d11c83d0f9812d435ef65a47f750820e142](https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142)\".",
    "created_at": "2016-09-26T16:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321412",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[21d46ab3f71017d5e982ee6c844b44c6ca2f2528](https://github.com/sagemath/sagetrac-mirror/commit/21d46ab3f71017d5e982ee6c844b44c6ca2f2528)" to "[822f0d11c83d0f9812d435ef65a47f750820e142](https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142)".



---

archive/issue_comments_321413.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142\">822f0d1</a></td><td><code>Re-raise the exception if it is raised on the final try.</code></td></tr></table>\n",
    "created_at": "2016-09-26T16:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321413",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142">822f0d1</a></td><td><code>Re-raise the exception if it is raised on the final try.</code></td></tr></table>




---

archive/issue_events_197213.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-09-26T16:25:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197213"
}
```



---

archive/issue_events_197214.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-09-26T16:25:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197214"
}
```



---

archive/issue_comments_321414.json:
```json
{
    "body": "<a id='comment:7'></a>\nTwo minor things again:\n\n1. Replace `func()` by `return func()`. This way, you support functions which return something. It also means that you can remove the `else: break`.\n\n2. The condition `while tries > 0:` is now always true. So for simplicity, I would prefer to see `while True` there. That makes it clear that the loop can never be exited normally. By the way, this is a good example of code which would be cleaner with a `goto` statement.",
    "created_at": "2016-09-27T07:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321414",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Two minor things again:

1. Replace `func()` by `return func()`. This way, you support functions which return something. It also means that you can remove the `else: break`.

2. The condition `while tries > 0:` is now always true. So for simplicity, I would prefer to see `while True` there. That makes it clear that the loop can never be exited normally. By the way, this is a good example of code which would be cleaner with a `goto` statement.



---

archive/issue_events_197215.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-27T07:56:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197215"
}
```



---

archive/issue_events_197216.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-27T07:56:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197216"
}
```



---

archive/issue_comments_321415.json:
```json
{
    "body": "<a id='comment:8'></a>\nAgreed again on all of the above.\n\nThe only people who think gotos are evil have never written non-trivial C code and haven't read/don't understand the context of Dijkstra's essay :)",
    "created_at": "2016-09-27T11:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321415",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Agreed again on all of the above.

The only people who think gotos are evil have never written non-trivial C code and haven't read/don't understand the context of Dijkstra's essay :)



---

archive/issue_comments_321416.json:
```json
{
    "body": "**Changing commit** from \"[822f0d11c83d0f9812d435ef65a47f750820e142](https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142)\" to \"[69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)\".",
    "created_at": "2016-09-28T06:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321416",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[822f0d11c83d0f9812d435ef65a47f750820e142](https://github.com/sagemath/sagetrac-mirror/commit/822f0d11c83d0f9812d435ef65a47f750820e142)" to "[69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)".



---

archive/issue_comments_321417.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae\">69830cd</a></td><td><code>Additional minor cleanup:</code></td></tr></table>\n",
    "created_at": "2016-09-28T06:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321417",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae">69830cd</a></td><td><code>Additional minor cleanup:</code></td></tr></table>




---

archive/issue_events_197217.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-09-28T06:42:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197217"
}
```



---

archive/issue_events_197218.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-09-28T06:42:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197218"
}
```



---

archive/issue_comments_321418.json:
```json
{
    "body": "<a id='comment:10'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae\">69830cd</a></td><td><code>Additional minor cleanup:</code></td></tr></table>\n",
    "created_at": "2016-09-28T06:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321418",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae">69830cd</a></td><td><code>Additional minor cleanup:</code></td></tr></table>




---

archive/issue_events_197219.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-28T07:32:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197219"
}
```



---

archive/issue_events_197220.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-28T07:32:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197220"
}
```



---

archive/issue_comments_321419.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2016-09-28T07:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321419",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_321420.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/bug/uncompress-windows](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/bug/uncompress-windows)\" to \"[69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)\".",
    "created_at": "2016-10-29T14:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21599#issuecomment-321420",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/bug/uncompress-windows](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/bug/uncompress-windows)" to "[69830cd977cd6ca47d623044e3cdf9fea6f164ae](https://github.com/sagemath/sagetrac-mirror/commit/69830cd977cd6ca47d623044e3cdf9fea6f164ae)".



---

archive/issue_events_197221.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-29T14:27:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197221"
}
```



---

archive/issue_events_197222.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-29T14:27:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21599",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21599#event-197222"
}
```
