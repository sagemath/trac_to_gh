# Issue 21335: Extend normalize() and use it instead of Maxima in simplify_rational()

archive/issues_021098.json:
```json
{
    "body": "At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final numerator is expanded:\n\n```\nsage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).normalize()\n(x^(1/2*y) + 1)^2*(x^(1/2*y) - 1)^2/(x^y - 1)\nsage: (x + y^2/(x + 2)).normalize()\n(x^2 + y^2 + 2*x)/(x + 2)\n```\n\nThe alternatives are provided atm by Maxima\n\n```\nsage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).simplify_rational(algorithm='simple')\n(x^(2*y) - 2*x^y + 1)/(x^y - 1)\nsage: (x + y^2/(x + 2)).simplify_rational(algorithm='noexpand')\n((x + 2)*x + y^2)/(x + 2)\n```\n\nhttps://github.com/pynac/pynac/issues/191\n\nAfter Pynac will have implemented `normalize()` options to these effect the calls to Maxima in `simplify_rational` should be replaced by the respective calls to Pynac.\n\nAuthor: Ralf Stephan\n\nBranch: u/rws/noexpand_simple_options_for_ex_normalize__\n\nStatus: needs_work\n\nDependencies: #21369, #21529\n\nCommit: 30bc79e56390859ee732a0d08152cb93bc7528ed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21335\n\n",
    "created_at": "2016-08-25T13:17:47Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Extend normalize() and use it instead of Maxima in simplify_rational()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21335",
    "user": "https://github.com/rwst"
}
```
At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final numerator is expanded:

```
sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).normalize()
(x^(1/2*y) + 1)^2*(x^(1/2*y) - 1)^2/(x^y - 1)
sage: (x + y^2/(x + 2)).normalize()
(x^2 + y^2 + 2*x)/(x + 2)
```

The alternatives are provided atm by Maxima

```
sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).simplify_rational(algorithm='simple')
(x^(2*y) - 2*x^y + 1)/(x^y - 1)
sage: (x + y^2/(x + 2)).simplify_rational(algorithm='noexpand')
((x + 2)*x + y^2)/(x + 2)
```

https://github.com/pynac/pynac/issues/191

After Pynac will have implemented `normalize()` options to these effect the calls to Maxima in `simplify_rational` should be replaced by the respective calls to Pynac.

Author: Ralf Stephan

Branch: u/rws/noexpand_simple_options_for_ex_normalize__

Status: needs_work

Dependencies: #21369, #21529

Commit: 30bc79e56390859ee732a0d08152cb93bc7528ed

Issue created by migration from https://trac.sagemath.org/ticket/21335





---

archive/issue_comments_311001.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final denominator is expanded:\n+At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final numerator is expanded:\n \n ```\n sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).normalize()\n```\n",
    "created_at": "2016-08-25T13:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311001",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final denominator is expanded:
+At the moment `normalize()` will not expand factors of fractions. If fractions are combined however, the final numerator is expanded:
 
 ```
 sage: ((x^(y/2) + 1)^2*(x^(y/2) - 1)^2/(x^y - 1)).normalize()
```




---

archive/issue_comments_311002.json:
```json
{
    "body": "<a id='comment:2'></a>This is implemented in Pynac master ~~but one doctest depends on #21360~~. Also, nested application (\"full\") needs to be done.",
    "created_at": "2016-08-29T13:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311002",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>This is implemented in Pynac master ~~but one doctest depends on #21360~~. Also, nested application ("full") needs to be done.



---

archive/issue_comments_311003.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2016-08-31T08:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311003",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_311004.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-02T08:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311005.json:
```json
{
    "body": "<a id='comment:7'></a>Three doctest fails in `symbolic/expression.pyx`.",
    "created_at": "2016-09-18T06:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311005",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>Three doctest fails in `symbolic/expression.pyx`.



---

archive/issue_comments_311006.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-18T14:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311007.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-02T14:46:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311007",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_311008.json:
```json
{
    "body": "<a id='comment:12'></a>Minor point: \"and and\" should be \"and\".\n\nApart from that, I don't understand why `algorithm=\"full\"` attempts to factor the simplified fraction (which is a potentially costly operation). Is there something in the way the Pynac `normal()` function works that makes it necessary to do so?",
    "created_at": "2016-10-03T12:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311008",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:12'></a>Minor point: "and and" should be "and".

Apart from that, I don't understand why `algorithm="full"` attempts to factor the simplified fraction (which is a potentially costly operation). Is there something in the way the Pynac `normal()` function works that makes it necessary to do so?



---

archive/issue_comments_311009.json:
```json
{
    "body": "<a id='comment:13'></a>Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important. Without `factor` the following doctests will fail:\n\n```\nFile \"src/sage/symbolic/expression.pyx\", line 9427, in sage.symbolic.expression.Expression.simplify_rational\nFailed example:\n    f.simplify_rational()\nExpected:\n    -2*sqrt(x - 1)/sqrt((x + 1)*(x - 1))\nGot:\n    ((x - 1)^(3/2) - sqrt(x - 1)*x - sqrt(x - 1))/sqrt((x + 1)*(x - 1))\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 9451, in sage.symbolic.expression.Expression.simplify_rational\nFailed example:\n    g.simplify_rational()\nExpected:\n    x^y - 1\nGot:\n    (x^(2*y) - 2*x^y + 1)/(x^y - 1)\n```",
    "created_at": "2016-10-05T08:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311009",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important. Without `factor` the following doctests will fail:

```
File "src/sage/symbolic/expression.pyx", line 9427, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    f.simplify_rational()
Expected:
    -2*sqrt(x - 1)/sqrt((x + 1)*(x - 1))
Got:
    ((x - 1)^(3/2) - sqrt(x - 1)*x - sqrt(x - 1))/sqrt((x + 1)*(x - 1))
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9451, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    g.simplify_rational()
Expected:
    x^y - 1
Got:
    (x^(2*y) - 2*x^y + 1)/(x^y - 1)
```



---

archive/issue_comments_311010.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-05T08:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311010",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311011.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 rws]:\n> Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important.\n\n\nI don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but *expand* the denominators instead of calling `factor()`?",
    "created_at": "2016-10-05T09:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311011",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:15'></a>Replying to [comment:13 rws]:
> Indeed the performance question was the source of some headaches to me, as well. I figured at the time consistency with Maxima behaviour was more important.


I don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but *expand* the denominators instead of calling `factor()`?



---

archive/issue_comments_311012.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 mmezzarobba]:\n> I don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but *expand* the denominators instead of calling `factor()`?\n\n\nThis will, additionally to the two doctests above, fail this doctest:\n\n```\nFile \"src/sage/symbolic/expression.pyx\", line 9458, in sage.symbolic.expression.Expression.simplify_rational\nFailed example:\n    f.simplify_rational()\nExpected:\n    (2*x^2 + 5*x + 4)/((x + 2)^2*(x + 1))\nGot:\n    (2*x^2 + 5*x + 4)/(x^3 + 5*x^2 + 8*x + 4)\n```",
    "created_at": "2016-10-05T12:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311012",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>Replying to [comment:15 mmezzarobba]:
> I don't know exactly what either Maxima or Pynac does, but just by chance, do you think it would be okay to keep the loop but *expand* the denominators instead of calling `factor()`?


This will, additionally to the two doctests above, fail this doctest:

```
File "src/sage/symbolic/expression.pyx", line 9458, in sage.symbolic.expression.Expression.simplify_rational
Failed example:
    f.simplify_rational()
Expected:
    (2*x^2 + 5*x + 4)/((x + 2)^2*(x + 1))
Got:
    (2*x^2 + 5*x + 4)/(x^3 + 5*x^2 + 8*x + 4)
```



---

archive/issue_comments_311013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-28T16:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311013",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_311014.json:
```json
{
    "body": "<a id='comment:17'></a>I think I see now how to resolve the three tests without factoring. Pynac's gcd needs to be a bit more aware of powers in the expression and needs to replace some of them with new symbols. This way also exponentials can be handled identically (which does not work atm).",
    "created_at": "2016-11-28T16:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21335#issuecomment-311014",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>I think I see now how to resolve the three tests without factoring. Pynac's gcd needs to be a bit more aware of powers in the expression and needs to replace some of them with new symbols. This way also exponentials can be handled identically (which does not work atm).
