# Issue 21637: Bug with PARI interface gen.eval on Cygwin

archive/issues_021400.json:
```json
{
    "body": "With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\nhello\n0\n```\n\n**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n\nThis branch simply adds a patch from upstream.\n\nDepends on #21582\n\n**Keywords:** pari windows cygwin\n\n**Branch:** [0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)\n\n**Upstream:** Fixed upstream, but not in a stable release.\n\n**Reviewer:** Erik Bray\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/21637\n\n",
    "closed_at": "2016-10-21T07:03:44Z",
    "created_at": "2016-10-04T09:12:29Z",
    "labels": [
        "component: packages: standard",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "title": "Bug with PARI interface gen.eval on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/21637",
    "user": "https://github.com/embray"
}
```
With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:

```
sage: pari("x -> print(x);")("hello")
hello
0
```

**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html

This branch simply adds a patch from upstream.

Depends on #21582

**Keywords:** pari windows cygwin

**Branch:** [0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)

**Upstream:** Fixed upstream, but not in a stable release.

**Reviewer:** Erik Bray

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/21637





---

archive/issue_comments_320490.json:
```json
{
    "body": "<a id='comment:1'></a>\nJust FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.",
    "created_at": "2016-10-04T10:03:22Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320490",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.



---

archive/issue_comments_320491.json:
```json
{
    "body": "<a id='comment:2'></a>\nCan you test this:\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T10:06:34Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320491",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Can you test this:

```
sage: pari("x -> print(x);")("hello")
hello
```



---

archive/issue_comments_320492.json:
```json
{
    "body": "<a id='comment:3'></a>\nThat test fails too in the same way.",
    "created_at": "2016-10-04T10:56:06Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320492",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
That test fails too in the same way.



---

archive/issue_comments_320493.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [jdemeyer](#comment%3A1):\n> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.\n\n\nI see--that helps explain it.  Maybe there's something odd going on with pointer comparison.",
    "created_at": "2016-10-04T10:57:00Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320493",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Replying to [jdemeyer](#comment%3A1):
> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.


I see--that helps explain it.  Maybe there's something odd going on with pointer comparison.



---

archive/issue_comments_320494.json:
```json
{
    "body": "<a id='comment:5'></a>\nOK, next thing is to try GP itself:\n\n```\n$ ./sage --gp\n```\nand then\n\n```\n? (x -> print(x))(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T11:28:11Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320494",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
OK, next thing is to try GP itself:

```
$ ./sage --gp
```
and then

```
? (x -> print(x))("hello")
hello
```



---

archive/issue_comments_320495.json:
```json
{
    "body": "<a id='comment:6'></a>\nCould you try this patch to PARI:\n\n```diff\ndiff --git a/src/headers/pariinl.h b/src/headers/pariinl.h\nindex 2567d55..e37b435 100644\n--- a/src/headers/pariinl.h\n+++ b/src/headers/pariinl.h\n@@ -1272,7 +1272,7 @@ INLINE void\n killblock(GEN x) { gunclone(x); }\n \n INLINE int\n-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }\n+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }\n \n /*******************************************************************/\n /*                                                                 */\n```\n\nJust copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.",
    "created_at": "2016-10-04T11:35:56Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320495",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Could you try this patch to PARI:

```diff
diff --git a/src/headers/pariinl.h b/src/headers/pariinl.h
index 2567d55..e37b435 100644
--- a/src/headers/pariinl.h
+++ b/src/headers/pariinl.h
@@ -1272,7 +1272,7 @@ INLINE void
 killblock(GEN x) { gunclone(x); }
 
 INLINE int
-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }
+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }
 
 /*******************************************************************/
 /*                                                                 */
```

Just copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.



---

archive/issue_comments_320496.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -16,17 +16,14 @@\n             return P.new_gen(result)\n ```\n \n-So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:\n+So it seems like `result != gnil` when it is expected to be.  For example:\n \n ```\n-sage: def printme(x):\n-....:     print(x)\n-....:\n-sage: objtoclosure(printme)('matid(2)')\n-[1, 0; 0, 1]\n+sage: pari(\"x -> print(x);\")(\"hello\")\n+hello\n 0\n ```\n \n-The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.\n+The final `0` is the return value from calling the closure. It should return `None`.\n \n I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n``````\n",
    "created_at": "2016-10-04T11:35:56Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320496",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -16,17 +16,14 @@
             return P.new_gen(result)
 ```
 
-So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:
+So it seems like `result != gnil` when it is expected to be.  For example:
 
 ```
-sage: def printme(x):
-....:     print(x)
-....:
-sage: objtoclosure(printme)('matid(2)')
-[1, 0; 0, 1]
+sage: pari("x -> print(x);")("hello")
+hello
 0
 ```
 
-The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.
+The final `0` is the return value from calling the closure. It should return `None`.
 
 I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.
``````




---

archive/issue_comments_320497.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk, I'll try that.  Any idea why that patch?",
    "created_at": "2016-10-04T11:40:27Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320497",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Ok, I'll try that.  Any idea why that patch?



---

archive/issue_comments_320498.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnother potentially useful patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c0f015f 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,14 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z = %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil = %p\\n\", gnil);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c = %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T11:48:04Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320498",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Another potentially useful patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c0f015f 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,14 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z = %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil = %p\n", gnil);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c = %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_320499.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [embray](#comment%3A7):\n> Ok, I'll try that.  Any idea why that patch?\n\n\nPARI's handling for closure return values has special code to deal with \"universal constants\". I'm suspecting a problem there.",
    "created_at": "2016-10-04T11:50:20Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320499",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [embray](#comment%3A7):
> Ok, I'll try that.  Any idea why that patch?


PARI's handling for closure return values has special code to deal with "universal constants". I'm suspecting a problem there.



---

archive/issue_comments_320500.json:
```json
{
    "body": "<a id='comment:10'></a>\nNever mind the patch from [comment:6], that's not the problem.\n\nI found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c7c4c62 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,16 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z =     %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil =  %p\\n\", gnil);\n+  printf(\"gen_0 = %p\\n\", gen_0);\n+  printf(\"ghalf = %p\\n\", ghalf);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c =     %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T12:02:21Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320500",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Never mind the patch from [comment:6], that's not the problem.

I found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c7c4c62 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,16 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z =     %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil =  %p\n", gnil);
+  printf("gen_0 = %p\n", gen_0);
+  printf("ghalf = %p\n", ghalf);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c =     %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_320501.json:
```json
{
    "body": "<a id='comment:11'></a>\nOnce you applied the patch from [comment:10], I need you to try\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n```",
    "created_at": "2016-10-04T12:03:30Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320501",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Once you applied the patch from [comment:10], I need you to try

```
sage: pari("x -> print(x);")("hello")
```



---

archive/issue_comments_320502.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnother thing to try (with or without the patches) in GP. You should get an error message here:\n\n```\n? install(gaffect, \"vGG\"); gaffect(0, print())\n  ***   at top-level: install(gaffect,\"vGG\");gaffect(0,print())\n  ***                                        ^------------------\n  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.\n```",
    "created_at": "2016-10-04T12:07:17Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320502",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Another thing to try (with or without the patches) in GP. You should get an error message here:

```
? install(gaffect, "vGG"); gaffect(0, print())
  ***   at top-level: install(gaffect,"vGG");gaffect(0,print())
  ***                                        ^------------------
  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.
```



---

archive/issue_comments_320503.json:
```json
{
    "body": "<a id='comment:13'></a>\nActually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.",
    "created_at": "2016-10-04T13:02:43Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320503",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Actually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.



---

archive/issue_comments_320504.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [embray](#comment%3A13):\n> Actually, it appears the patch in [comment:6] fixed it.\n\n\nThat's impossible :-)\n\nI would be very interested in the debug output from the patch at [comment:10] with or without the other patch.",
    "created_at": "2016-10-04T13:07:50Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320504",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [embray](#comment%3A13):
> Actually, it appears the patch in [comment:6] fixed it.


That's impossible :-)

I would be very interested in the debug output from the patch at [comment:10] with or without the other patch.



---

archive/issue_comments_320505.json:
```json
{
    "body": "Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:\n\n> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n\n\n> Actually, it appears the patch in [comment:6] fixed it.\n",
    "created_at": "2016-10-04T13:10:05Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320505",
    "user": "https://github.com/jdemeyer"
}
```

Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:

> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.


> Actually, it appears the patch in [comment:6] fixed it.




---

archive/issue_comments_320506.json:
```json
{
    "body": "<a id='comment:16'></a>\nFWIW Here's the output with the patch from [comment:10]\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n\navma = 0x6fff79c0000\nhello\nz =     0x2e01690\nis_universal_constant(z) = 1\ngnil =  0x2e01690\ngen_0 = 0x2e01680\nghalf = 0x2e01700\nc =     0x2e01690\n```\n\nbut yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)",
    "created_at": "2016-10-04T13:17:05Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320506",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
FWIW Here's the output with the patch from [comment:10]

```
sage: pari("x -> print(x);")("hello")

avma = 0x6fff79c0000
hello
z =     0x2e01690
is_universal_constant(z) = 1
gnil =  0x2e01690
gen_0 = 0x2e01680
ghalf = 0x2e01700
c =     0x2e01690
```

but yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)



---

archive/issue_comments_320507.json:
```json
{
    "body": "<a id='comment:17'></a>\nThough I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?",
    "created_at": "2016-10-04T13:26:04Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320507",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?



---

archive/issue_comments_320508.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [embray](#comment%3A16):\n> but yeah, the other patch really did fix it.\n\n\nJust to double-check, can you remove that patch and check again (with the debugging info from [comment:10])",
    "created_at": "2016-10-04T13:26:54Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320508",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Replying to [embray](#comment%3A16):
> but yeah, the other patch really did fix it.


Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])



---

archive/issue_comments_320509.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [embray](#comment%3A17):\n> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  \n\n\nYes, the patch is wrong and it shouldn't fix the problem.",
    "created_at": "2016-10-04T13:27:31Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320509",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [embray](#comment%3A17):
> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  


Yes, the patch is wrong and it shouldn't fix the problem.



---

archive/issue_comments_320510.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [jdemeyer](#comment%3A18):\n> Replying to [embray](#comment%3A16):\n> > but yeah, the other patch really did fix it.\n\n> \n> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])\n\n\nYeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.",
    "created_at": "2016-10-04T13:32:50Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320510",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Replying to [jdemeyer](#comment%3A18):
> Replying to [embray](#comment%3A16):
> > but yeah, the other patch really did fix it.

> 
> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])


Yeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.



---

archive/issue_comments_320511.json:
```json
{
    "body": "<a id='comment:21'></a>\nWell the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A\n\nThe output I get is\n\n```\navma = 0x6fff77c0000\n[1, 0; 0, 1]\nz =     0x2e86890\nis_universal_constant(z) = 0\ngnil =  0x2e86890\ngen_0 = 0x2e86880\nghalf = 0x2e86850\nc =     0x2e86890\n0\n```\n\nFor some reason with optimizations enabled `ghalf` winds up below `gen_0`.",
    "created_at": "2016-10-04T13:52:59Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320511",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Well the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A

The output I get is

```
avma = 0x6fff77c0000
[1, 0; 0, 1]
z =     0x2e86890
is_universal_constant(z) = 0
gnil =  0x2e86890
gen_0 = 0x2e86880
ghalf = 0x2e86850
c =     0x2e86890
0
```

For some reason with optimizations enabled `ghalf` winds up below `gen_0`.



---

archive/issue_comments_320512.json:
```json
{
    "body": "<a id='comment:22'></a>\nBy the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.",
    "created_at": "2016-10-04T13:58:22Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320512",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.



---

archive/issue_comments_320513.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [embray](#comment%3A22):\n> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.\n\n\nOf course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.",
    "created_at": "2016-10-04T14:03:08Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320513",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
Replying to [embray](#comment%3A22):
> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.


Of course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.



---

archive/issue_comments_320514.json:
```json
{
    "body": "<a id='comment:24'></a>\nI will report it upstream.",
    "created_at": "2016-10-04T14:03:22Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320514",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
I will report it upstream.



---

archive/issue_comments_320515.json:
```json
{
    "body": "**Upstream:** Not yet reported upstream; Will do shortly.",
    "created_at": "2016-10-04T14:03:22Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320515",
    "user": "https://github.com/jdemeyer"
}
```

**Upstream:** Not yet reported upstream; Will do shortly.



---

archive/issue_comments_320516.json:
```json
{
    "body": "<a id='comment:25'></a>\nI've realized I should never make logical assumptions.",
    "created_at": "2016-10-04T14:12:59Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320516",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>
I've realized I should never make logical assumptions.



---

archive/issue_comments_320517.json:
```json
{
    "body": "**Changing upstream** from \"Not yet reported upstream; Will do shortly.\" to \"\".",
    "created_at": "2016-10-04T14:12:59Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320517",
    "user": "https://github.com/embray"
}
```

**Changing upstream** from "Not yet reported upstream; Will do shortly." to "".



---

archive/issue_events_193874.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T14:56:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "component: porting: cygwin",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193874"
}
```



---

archive/issue_events_193875.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T14:56:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "component: packages: standard",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193875"
}
```



---

archive/issue_comments_320518.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,22 +1,4 @@\n-It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is\n-\n-```cython\n-        if t == t_CLOSURE:\n-            if nkwds > 0:\n-                raise TypeError(\"cannot evaluate a PARI closure using keyword arguments\")\n-            if closure_is_variadic(self.g):\n-                arity = closure_arity(self.g) - 1\n-                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]\n-            t0 = objtogen(args)\n-            sig_on()\n-            result = closure_callgenvec(self.g, t0.g)\n-            if result == gnil:\n-                P.clear_stack()\n-                return None\n-            return P.new_gen(result)\n-```\n-\n-So it seems like `result != gnil` when it is expected to be.  For example:\n+With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:\n \n ```\n sage: pari(\"x -> print(x);\")(\"hello\")\n@@ -24,6 +6,4 @@\n 0\n ```\n \n-The final `0` is the return value from calling the closure. It should return `None`.\n-\n-I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n``````\n",
    "created_at": "2016-10-04T14:56:11Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320518",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,22 +1,4 @@
-It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is
-
-```cython
-        if t == t_CLOSURE:
-            if nkwds > 0:
-                raise TypeError("cannot evaluate a PARI closure using keyword arguments")
-            if closure_is_variadic(self.g):
-                arity = closure_arity(self.g) - 1
-                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]
-            t0 = objtogen(args)
-            sig_on()
-            result = closure_callgenvec(self.g, t0.g)
-            if result == gnil:
-                P.clear_stack()
-                return None
-            return P.new_gen(result)
-```
-
-So it seems like `result != gnil` when it is expected to be.  For example:
+With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:
 
 ```
 sage: pari("x -> print(x);")("hello")
@@ -24,6 +6,4 @@
 0
 ```
 
-The final `0` is the return value from calling the closure. It should return `None`.
-
-I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.
+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html
``````




---

archive/issue_comments_320519.json:
```json
{
    "body": "**Upstream:** Reported upstream. No feedback yet.",
    "created_at": "2016-10-04T14:56:11Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320519",
    "user": "https://github.com/jdemeyer"
}
```

**Upstream:** Reported upstream. No feedback yet.



---

archive/issue_comments_320520.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)",
    "created_at": "2016-10-04T15:02:35Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320520",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)



---

archive/issue_comments_320521.json:
```json
{
    "body": "<a id='comment:28'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11\">7879f08</a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>\n",
    "created_at": "2016-10-04T15:23:18Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320521",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11">7879f08</a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>




---

archive/issue_comments_320522.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2016-10-04T15:23:18Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320522",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_320523.json:
```json
{
    "body": "**Commit:** [7879f089f19730a902da28c5a072e31b0d0d2f11](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)",
    "created_at": "2016-10-04T15:23:18Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320523",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [7879f089f19730a902da28c5a072e31b0d0d2f11](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)



---

archive/issue_events_193876.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T15:23:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193876"
}
```



---

archive/issue_comments_320524.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"Fixed upstream, but not in a stable release.\".",
    "created_at": "2016-10-04T19:56:19Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320524",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "Fixed upstream, but not in a stable release.".



---

archive/issue_comments_320525.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61\">fb8b1d2</a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>\n",
    "created_at": "2016-10-04T20:29:16Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320525",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61">fb8b1d2</a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>




---

archive/issue_comments_320526.json:
```json
{
    "body": "**Changing commit** from \"[7879f089f19730a902da28c5a072e31b0d0d2f11](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)\" to \"[fb8b1d22fefc72faf5932bab9327df6e4c7c7f61](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)\".",
    "created_at": "2016-10-04T20:29:16Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320526",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7879f089f19730a902da28c5a072e31b0d0d2f11](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)" to "[fb8b1d22fefc72faf5932bab9327df6e4c7c7f61](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)".



---

archive/issue_comments_320527.json:
```json
{
    "body": "<a id='comment:31'></a>\nThis is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)",
    "created_at": "2016-10-04T20:31:36Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320527",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
This is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)



---

archive/issue_comments_320528.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n ```\n \n **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n+\n+This branch simply adds a patch from upstream.\n``````\n",
    "created_at": "2016-10-05T08:35:00Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320528",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 ```
 
 **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html
+
+This branch simply adds a patch from upstream.
``````




---

archive/issue_comments_320529.json:
```json
{
    "body": "<a id='comment:33'></a>\nGreat.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.\n\nI need to fire up a new non-debug build in order to test this but I think this will fix it.",
    "created_at": "2016-10-05T10:15:30Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320529",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>
Great.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.

I need to fire up a new non-debug build in order to test this but I think this will fix it.



---

archive/issue_events_193877.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T13:35:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193877"
}
```



---

archive/issue_events_193878.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T13:35:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193878"
}
```



---

archive/issue_comments_320530.json:
```json
{
    "body": "<a id='comment:34'></a>\nMeant to update on this sooner.  I can confirm that the new patch fixes the issue as well.",
    "created_at": "2016-10-11T13:35:29Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320530",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
Meant to update on this sooner.  I can confirm that the new patch fixes the issue as well.



---

archive/issue_comments_320531.json:
```json
{
    "body": "<a id='comment:35'></a>\n**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510\">0e7d231</a></td><td><code>Merge tag '7.4.rc0' into t/21637/bug_with_pari_interface_gen_eval_on_cygwin</code></td></tr></table>\n",
    "created_at": "2016-10-11T14:59:31Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320531",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>
**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510">0e7d231</a></td><td><code>Merge tag '7.4.rc0' into t/21637/bug_with_pari_interface_gen_eval_on_cygwin</code></td></tr></table>




---

archive/issue_comments_320532.json:
```json
{
    "body": "**Changing commit** from \"[fb8b1d22fefc72faf5932bab9327df6e4c7c7f61](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)\" to \"[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)\".",
    "created_at": "2016-10-11T14:59:31Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320532",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[fb8b1d22fefc72faf5932bab9327df6e4c7c7f61](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)" to "[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)".



---

archive/issue_events_193879.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/git",
    "created_at": "2016-10-11T14:59:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193879"
}
```



---

archive/issue_events_193880.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/git",
    "created_at": "2016-10-11T14:59:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193880"
}
```



---

archive/issue_comments_320533.json:
```json
{
    "body": "<a id='comment:36'></a>\nBumping the PARI version (there was another PARI ticket merged in rc0).",
    "created_at": "2016-10-11T15:00:13Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320533",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>
Bumping the PARI version (there was another PARI ticket merged in rc0).



---

archive/issue_events_193881.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T15:00:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193881"
}
```



---

archive/issue_events_193882.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T15:00:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193882"
}
```



---

archive/issue_comments_320534.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2016-10-11T15:00:20Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320534",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_320535.json:
```json
{
    "body": "**Dependencies:** #21582",
    "created_at": "2016-10-11T15:00:48Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320535",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #21582



---

archive/issue_events_193883.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193883"
}
```



---

archive/issue_events_193884.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "12042c39020fe4c13efaf41db323ca26c061a2e4",
    "created_at": "2016-10-21T07:03:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-193884"
}
```



---

archive/issue_comments_320536.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)\" to \"[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)\".",
    "created_at": "2016-10-21T07:03:44Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320536",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)" to "[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)".



---

archive/issue_comments_320537.json:
```json
{
    "body": "log of compilation of 7.5beta0 WITHOUT #20523 (okay)",
    "created_at": "2016-10-23T16:47:21Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320537",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

log of compilation of 7.5beta0 WITHOUT #20523 (okay)



---

archive/attachments_020817.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "pari-2.8.0.alpha.p2.log",
    "asset_url": "tarball://root/attachments/ticket21637/pari-2.8.0.alpha.p2.log",
    "created_at": "2016-10-23T16:48:47Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket21637/pari-2.8.0.alpha.p2.log",
    "user": "https://github.com/EmmanuelCharpentier"
}
```



---

archive/issue_comments_320538.json:
```json
{
    "body": "Attachment [pari-2.8.0.alpha.p2.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8.0.alpha.p2.log) by @EmmanuelCharpentier created at 2016-10-23 16:48:47\n\nLog of compilation of 7.5beta0 WITH #20523 (problematic)",
    "created_at": "2016-10-23T16:48:47Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320538",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment [pari-2.8.0.alpha.p2.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8.0.alpha.p2.log) by @EmmanuelCharpentier created at 2016-10-23 16:48:47

Log of compilation of 7.5beta0 WITH #20523 (problematic)



---

archive/issue_comments_320539.json:
```json
{
    "body": "**Changing commit** from \"[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)\" to \"\".",
    "created_at": "2016-10-23T16:56:37Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320539",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Changing commit** from "[0e7d231ec555f0c320add18d2cbc75b028cfb510](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)" to "".



---

archive/attachments_020818.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "pari-2.8-2771-gb70b447.p0.log",
    "asset_url": "tarball://root/attachments/ticket21637/pari-2.8-2771-gb70b447.p0.log",
    "created_at": "2016-10-23T16:56:37Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket21637/pari-2.8-2771-gb70b447.p0.log",
    "user": "https://github.com/EmmanuelCharpentier"
}
```



---

archive/issue_comments_320540.json:
```json
{
    "body": "<a id='comment:40'></a>\nAttachment [pari-2.8-2771-gb70b447.p0.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8-2771-gb70b447.p0.log) by @EmmanuelCharpentier created at 2016-10-23 16:56:37\n\nI have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.\n\nI'll annotate #20523 (reminder...).",
    "created_at": "2016-10-23T16:56:37Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320540",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:40'></a>
Attachment [pari-2.8-2771-gb70b447.p0.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8-2771-gb70b447.p0.log) by @EmmanuelCharpentier created at 2016-10-23 16:56:37

I have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.

I'll annotate #20523 (reminder...).



---

archive/issue_comments_320541.json:
```json
{
    "body": "<a id='comment:41'></a>\n`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.",
    "created_at": "2016-10-23T18:26:49Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320541",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.



---

archive/issue_comments_320542.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [jdemeyer](#comment%3A41):\n> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n\nI have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.\n\n\nI see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.\n\n\nCurrently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).\n\nI'll keep you posted after a `ptestlong` of this 7.4 patched version.\n\n[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n{{{charpent@asus16-ec:/usr/local/sage-7$ sage -standard\n[package]...............................[latest version] ([version])\n....\npari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)\n...}}}",
    "created_at": "2016-10-23T19:37:24Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320542",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:42'></a>
Replying to [jdemeyer](#comment%3A41):
> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.


I have already tried that : The damn thing sprouts back (and the error is the same...).

> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.


I see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.


Currently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).

I'll keep you posted after a `ptestlong` of this 7.4 patched version.

[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

{{{charpent@asus16-ec:/usr/local/sage-7$ sage -standard
[package]...............................[latest version] ([version])
....
pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)
...}}}



---

archive/issue_comments_320543.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [charpent](#comment%3A42):\n> Replying to [jdemeyer](#comment%3A41):\n> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> \n> I have already tried that : The damn thing sprouts back (and the error is the same...).\n\n\nIn that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).",
    "created_at": "2016-10-23T19:44:02Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320543",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>
Replying to [charpent](#comment%3A42):
> Replying to [jdemeyer](#comment%3A41):
> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> 
> I have already tried that : The damn thing sprouts back (and the error is the same...).


In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).



---

archive/issue_comments_320544.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [jdemeyer](#comment%3A43):\n> Replying to [charpent](#comment%3A42):\n> > Replying to [jdemeyer](#comment%3A41):\n> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> > \n> > I have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> \n> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).\n\n\n`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.\n\nMaybe I should try a fresh tree ?",
    "created_at": "2016-10-23T19:52:19Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320544",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:44'></a>
Replying to [jdemeyer](#comment%3A43):
> Replying to [charpent](#comment%3A42):
> > Replying to [jdemeyer](#comment%3A41):
> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> > 
> > I have already tried that : The damn thing sprouts back (and the error is the same...).

> 
> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).


`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.

Maybe I should try a fresh tree ?



---

archive/issue_comments_320545.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [charpent](#comment%3A42), because my edit didn't went through the mail...\n\n[EDIT] According to \u200bVolker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n`charpent@asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`",
    "created_at": "2016-10-23T20:04:21Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320545",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:45'></a>
Replying to [charpent](#comment%3A42), because my edit didn't went through the mail...

[EDIT] According to Volker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

`charpent@asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`



---

archive/issue_comments_320546.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [charpent](#comment%3A44):\n> `develop`##20523+#21744\n\n\nDouble-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.",
    "created_at": "2016-10-23T20:09:11Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320546",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>
Replying to [charpent](#comment%3A44):
> `develop`##20523+#21744


Double-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.



---

archive/issue_comments_320547.json:
```json
{
    "body": "<a id='comment:47'></a>\nStarting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.\n\nI still do not understand how I managed to mess up my previous attempts.",
    "created_at": "2016-10-24T07:33:46Z",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-320547",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:47'></a>
Starting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.

I still do not understand how I managed to mess up my previous attempts.
