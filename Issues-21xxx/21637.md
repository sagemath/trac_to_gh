# Issue 21637: Bug with PARI interface gen.eval on Cygwin

archive/issues_021400.json:
```json
{
    "assignees": [],
    "body": "With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\nhello\n0\n```\n\n**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n\nThis branch simply adds a patch from upstream.\n\nDepends on #21582\n\nKeywords: **pari windows cygwin**\n\nBranch: **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**\n\nUpstream: **Fixed upstream, but not in a stable release.**\n\nReviewer: **Erik Bray**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21637_\n\n",
    "closed_at": "2016-10-21T07:03:44Z",
    "created_at": "2016-10-04T09:12:29Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Bug with PARI interface gen.eval on Cygwin",
    "type": "issue",
    "updated_at": "2016-10-24T07:33:46Z",
    "url": "https://github.com/sagemath/sage/issues/21637",
    "user": "https://github.com/embray"
}
```
With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:

```
sage: pari("x -> print(x);")("hello")
hello
0
```

**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html

This branch simply adds a patch from upstream.

Depends on #21582

Keywords: **pari windows cygwin**

Branch: **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**

Upstream: **Fixed upstream, but not in a stable release.**

Reviewer: **Erik Bray**

Author: **Jeroen Demeyer**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/21637_





---

archive/issue_events_305235.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-04T09:12:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305235"
}
```



---

archive/issue_events_305236.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-04T09:12:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305236"
}
```



---

archive/issue_events_305237.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-04T09:12:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305237"
}
```



---

archive/issue_events_305238.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-04T09:12:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305238"
}
```



---

archive/issue_events_305239.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-04T09:12:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305239"
}
```



---

archive/issue_comments_317956.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nJust FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.",
    "created_at": "2016-10-04T10:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317956",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.



---

archive/issue_comments_317957.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nCan you test this:\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T10:06:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317957",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

Can you test this:

```
sage: pari("x -> print(x);")("hello")
hello
```



---

archive/issue_comments_317958.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThat test fails too in the same way.",
    "created_at": "2016-10-04T10:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317958",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

That test fails too in the same way.



---

archive/issue_comments_317959.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@jdemeyer](#comment:1):\n> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.\n\nI see--that helps explain it.  Maybe there's something odd going on with pointer comparison.",
    "created_at": "2016-10-04T10:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317959",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@jdemeyer](#comment:1):
> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.

I see--that helps explain it.  Maybe there's something odd going on with pointer comparison.



---

archive/issue_comments_317960.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOK, next thing is to try GP itself:\n\n```\n$ ./sage --gp\n```\nand then\n\n```\n? (x -> print(x))(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T11:28:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317960",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

OK, next thing is to try GP itself:

```
$ ./sage --gp
```
and then

```
? (x -> print(x))("hello")
hello
```



---

archive/issue_comments_317961.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nCould you try this patch to PARI:\n\n```diff\ndiff --git a/src/headers/pariinl.h b/src/headers/pariinl.h\nindex 2567d55..e37b435 100644\n--- a/src/headers/pariinl.h\n+++ b/src/headers/pariinl.h\n@@ -1272,7 +1272,7 @@ INLINE void\n killblock(GEN x) { gunclone(x); }\n \n INLINE int\n-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }\n+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }\n \n /*******************************************************************/\n /*                                                                 */\n```\n\nJust copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.",
    "created_at": "2016-10-04T11:35:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317961",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Could you try this patch to PARI:

```diff
diff --git a/src/headers/pariinl.h b/src/headers/pariinl.h
index 2567d55..e37b435 100644
--- a/src/headers/pariinl.h
+++ b/src/headers/pariinl.h
@@ -1272,7 +1272,7 @@ INLINE void
 killblock(GEN x) { gunclone(x); }
 
 INLINE int
-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }
+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }
 
 /*******************************************************************/
 /*                                                                 */
```

Just copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.



---

archive/issue_comments_317962.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,17 +16,14 @@\n             return P.new_gen(result)\n ```\n \n-So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:\n+So it seems like `result != gnil` when it is expected to be.  For example:\n \n ```\n-sage: def printme(x):\n-....:     print(x)\n-....:\n-sage: objtoclosure(printme)('matid(2)')\n-[1, 0; 0, 1]\n+sage: pari(\"x -> print(x);\")(\"hello\")\n+hello\n 0\n ```\n \n-The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.\n+The final `0` is the return value from calling the closure. It should return `None`.\n \n I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n``````\n",
    "created_at": "2016-10-04T11:35:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317962",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,17 +16,14 @@
             return P.new_gen(result)
 ```
 
-So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:
+So it seems like `result != gnil` when it is expected to be.  For example:
 
 ```
-sage: def printme(x):
-....:     print(x)
-....:
-sage: objtoclosure(printme)('matid(2)')
-[1, 0; 0, 1]
+sage: pari("x -> print(x);")("hello")
+hello
 0
 ```
 
-The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.
+The final `0` is the return value from calling the closure. It should return `None`.
 
 I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.
``````




---

archive/issue_comments_317963.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOk, I'll try that.  Any idea why that patch?",
    "created_at": "2016-10-04T11:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317963",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Ok, I'll try that.  Any idea why that patch?



---

archive/issue_comments_317964.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAnother potentially useful patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c0f015f 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,14 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z = %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil = %p\\n\", gnil);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c = %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T11:48:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317964",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Another potentially useful patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c0f015f 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,14 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z = %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil = %p\n", gnil);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c = %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_317965.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment:7):\n> Ok, I'll try that.  Any idea why that patch?\n\nPARI's handling for closure return values has special code to deal with \"universal constants\". I'm suspecting a problem there.",
    "created_at": "2016-10-04T11:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317965",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment:7):
> Ok, I'll try that.  Any idea why that patch?

PARI's handling for closure return values has special code to deal with "universal constants". I'm suspecting a problem there.



---

archive/issue_comments_317966.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nNever mind the patch from [comment:6], that's not the problem.\n\nI found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c7c4c62 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,16 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z =     %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil =  %p\\n\", gnil);\n+  printf(\"gen_0 = %p\\n\", gen_0);\n+  printf(\"ghalf = %p\\n\", ghalf);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c =     %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T12:02:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317966",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Never mind the patch from [comment:6], that's not the problem.

I found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c7c4c62 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,16 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z =     %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil =  %p\n", gnil);
+  printf("gen_0 = %p\n", gen_0);
+  printf("ghalf = %p\n", ghalf);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c =     %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_317967.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOnce you applied the patch from [comment:10], I need you to try\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n```",
    "created_at": "2016-10-04T12:03:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317967",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Once you applied the patch from [comment:10], I need you to try

```
sage: pari("x -> print(x);")("hello")
```



---

archive/issue_comments_317968.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAnother thing to try (with or without the patches) in GP. You should get an error message here:\n\n```\n? install(gaffect, \"vGG\"); gaffect(0, print())\n  ***   at top-level: install(gaffect,\"vGG\");gaffect(0,print())\n  ***                                        ^------------------\n  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.\n```",
    "created_at": "2016-10-04T12:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317968",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Another thing to try (with or without the patches) in GP. You should get an error message here:

```
? install(gaffect, "vGG"); gaffect(0, print())
  ***   at top-level: install(gaffect,"vGG");gaffect(0,print())
  ***                                        ^------------------
  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.
```



---

archive/issue_comments_317969.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nActually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.",
    "created_at": "2016-10-04T13:02:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317969",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Actually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.



---

archive/issue_comments_317970.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@embray](#comment:13):\n> Actually, it appears the patch in [comment:6] fixed it.\n\nThat's impossible :-)\n\nI would be very interested in the debug output from the patch at [comment:10] with or without the other patch.",
    "created_at": "2016-10-04T13:07:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317970",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@embray](#comment:13):
> Actually, it appears the patch in [comment:6] fixed it.

That's impossible :-)

I would be very interested in the debug output from the patch at [comment:10] with or without the other patch.



---

archive/issue_comments_317971.json:
```json
{
    "body": "Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:\n\n> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n\n> Actually, it appears the patch in [comment:6] fixed it.",
    "created_at": "2016-10-04T13:10:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317971",
    "user": "https://github.com/jdemeyer"
}
```

Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:

> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.

> Actually, it appears the patch in [comment:6] fixed it.



---

archive/issue_comments_317972.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nFWIW Here's the output with the patch from [comment:10]\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n\navma = 0x6fff79c0000\nhello\nz =     0x2e01690\nis_universal_constant(z) = 1\ngnil =  0x2e01690\ngen_0 = 0x2e01680\nghalf = 0x2e01700\nc =     0x2e01690\n```\n\nbut yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)",
    "created_at": "2016-10-04T13:17:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317972",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

FWIW Here's the output with the patch from [comment:10]

```
sage: pari("x -> print(x);")("hello")

avma = 0x6fff79c0000
hello
z =     0x2e01690
is_universal_constant(z) = 1
gnil =  0x2e01690
gen_0 = 0x2e01680
ghalf = 0x2e01700
c =     0x2e01690
```

but yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)



---

archive/issue_comments_317973.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThough I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?",
    "created_at": "2016-10-04T13:26:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317973",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?



---

archive/issue_comments_317974.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@embray](#comment:16):\n> but yeah, the other patch really did fix it.\n\nJust to double-check, can you remove that patch and check again (with the debugging info from [comment:10])",
    "created_at": "2016-10-04T13:26:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317974",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@embray](#comment:16):
> but yeah, the other patch really did fix it.

Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])



---

archive/issue_comments_317975.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@embray](#comment:17):\n> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  \n\nYes, the patch is wrong and it shouldn't fix the problem.",
    "created_at": "2016-10-04T13:27:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317975",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@embray](#comment:17):
> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  

Yes, the patch is wrong and it shouldn't fix the problem.



---

archive/issue_comments_317976.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jdemeyer](#comment:18):\n> Replying to [@embray](#comment:16):\n> > but yeah, the other patch really did fix it.\n\n> \n> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])\n\nYeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.",
    "created_at": "2016-10-04T13:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317976",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jdemeyer](#comment:18):
> Replying to [@embray](#comment:16):
> > but yeah, the other patch really did fix it.

> 
> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])

Yeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.



---

archive/issue_comments_317977.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nWell the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A\n\nThe output I get is\n\n```\navma = 0x6fff77c0000\n[1, 0; 0, 1]\nz =     0x2e86890\nis_universal_constant(z) = 0\ngnil =  0x2e86890\ngen_0 = 0x2e86880\nghalf = 0x2e86850\nc =     0x2e86890\n0\n```\n\nFor some reason with optimizations enabled `ghalf` winds up below `gen_0`.",
    "created_at": "2016-10-04T13:52:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317977",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Well the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A

The output I get is

```
avma = 0x6fff77c0000
[1, 0; 0, 1]
z =     0x2e86890
is_universal_constant(z) = 0
gnil =  0x2e86890
gen_0 = 0x2e86880
ghalf = 0x2e86850
c =     0x2e86890
0
```

For some reason with optimizations enabled `ghalf` winds up below `gen_0`.



---

archive/issue_comments_317978.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nBy the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.",
    "created_at": "2016-10-04T13:58:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317978",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.



---

archive/issue_comments_317979.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@embray](#comment:22):\n> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.\n\nOf course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.",
    "created_at": "2016-10-04T14:03:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317979",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@embray](#comment:22):
> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.

Of course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.



---

archive/issue_comments_317980.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI will report it upstream.",
    "created_at": "2016-10-04T14:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317980",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

I will report it upstream.



---

archive/issue_comments_317981.json:
```json
{
    "body": "Upstream: **Not yet reported upstream; Will do shortly.**",
    "created_at": "2016-10-04T14:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317981",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Not yet reported upstream; Will do shortly.**



---

archive/issue_comments_317982.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI've realized I should never make logical assumptions.",
    "created_at": "2016-10-04T14:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317982",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>

I've realized I should never make logical assumptions.



---

archive/issue_comments_317983.json:
```json
{
    "body": "Changed upstream from **Not yet reported upstream; Will do shortly.** to none",
    "created_at": "2016-10-04T14:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317983",
    "user": "https://github.com/embray"
}
```

Changed upstream from **Not yet reported upstream; Will do shortly.** to none



---

archive/issue_events_305240.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T14:56:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305240"
}
```



---

archive/issue_comments_317984.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,22 +1,4 @@\n-It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is\n-\n-```cython\n-        if t == t_CLOSURE:\n-            if nkwds > 0:\n-                raise TypeError(\"cannot evaluate a PARI closure using keyword arguments\")\n-            if closure_is_variadic(self.g):\n-                arity = closure_arity(self.g) - 1\n-                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]\n-            t0 = objtogen(args)\n-            sig_on()\n-            result = closure_callgenvec(self.g, t0.g)\n-            if result == gnil:\n-                P.clear_stack()\n-                return None\n-            return P.new_gen(result)\n-```\n-\n-So it seems like `result != gnil` when it is expected to be.  For example:\n+With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:\n \n ```\n sage: pari(\"x -> print(x);\")(\"hello\")\n@@ -24,6 +6,4 @@\n 0\n ```\n \n-The final `0` is the return value from calling the closure. It should return `None`.\n-\n-I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n``````\n",
    "created_at": "2016-10-04T14:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317984",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,22 +1,4 @@
-It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is
-
-```cython
-        if t == t_CLOSURE:
-            if nkwds > 0:
-                raise TypeError("cannot evaluate a PARI closure using keyword arguments")
-            if closure_is_variadic(self.g):
-                arity = closure_arity(self.g) - 1
-                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]
-            t0 = objtogen(args)
-            sig_on()
-            result = closure_callgenvec(self.g, t0.g)
-            if result == gnil:
-                P.clear_stack()
-                return None
-            return P.new_gen(result)
-```
-
-So it seems like `result != gnil` when it is expected to be.  For example:
+With certain operating systems, certain compilers and certain compiler flags (in particular Cygwin with `SAGE_DEBUG=yes`), the PARI function `is_universal_constant()` can be broken. This leads to a `0` return value for closures returning `gnil`:
 
 ```
 sage: pari("x -> print(x);")("hello")
@@ -24,6 +6,4 @@
 0
 ```
 
-The final `0` is the return value from calling the closure. It should return `None`.
-
-I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.
+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html
``````




---

archive/issue_comments_317985.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2016-10-04T14:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317985",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_317986.json:
```json
{
    "body": "Branch: **[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)**",
    "created_at": "2016-10-04T15:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317986",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)**



---

archive/issue_comments_317987.json:
```json
{
    "body": "<div id=\"comment:28\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11\"><code>7879f08</code></a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>\n",
    "created_at": "2016-10-04T15:23:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317987",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11"><code>7879f08</code></a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>




---

archive/issue_comments_317988.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2016-10-04T15:23:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317988",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_317989.json:
```json
{
    "body": "Commit: **[`7879f08`](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)**",
    "created_at": "2016-10-04T15:23:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317989",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`7879f08`](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)**



---

archive/issue_events_305241.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-04T15:23:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305241"
}
```



---

archive/issue_comments_317990.json:
```json
{
    "body": "Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, but not in a stable release.**",
    "created_at": "2016-10-04T19:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317990",
    "user": "https://github.com/jdemeyer"
}
```

Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, but not in a stable release.**



---

archive/issue_comments_317991.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61\"><code>fb8b1d2</code></a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>\n",
    "created_at": "2016-10-04T20:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317991",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61"><code>fb8b1d2</code></a></td><td><code>Add PARI patch to fix is_universal_constant()</code></td></tr></table>




---

archive/issue_comments_317992.json:
```json
{
    "body": "Changed commit from **[`7879f08`](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)** to **[`fb8b1d2`](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)**",
    "created_at": "2016-10-04T20:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317992",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7879f08`](https://github.com/sagemath/sagetrac-mirror/commit/7879f089f19730a902da28c5a072e31b0d0d2f11)** to **[`fb8b1d2`](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)**



---

archive/issue_comments_317993.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nThis is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)",
    "created_at": "2016-10-04T20:31:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317993",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

This is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)



---

archive/issue_comments_317994.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n ```\n \n **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html\n+\n+This branch simply adds a patch from upstream.\n``````\n",
    "created_at": "2016-10-05T08:35:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317994",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 ```
 
 **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00006.html
+
+This branch simply adds a patch from upstream.
``````




---

archive/issue_comments_317995.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nGreat.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.\n\nI need to fire up a new non-debug build in order to test this but I think this will fix it.",
    "created_at": "2016-10-05T10:15:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317995",
    "user": "https://github.com/embray"
}
```

<div id="comment:33" align="right">comment:33</div>

Great.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.

I need to fire up a new non-debug build in order to test this but I think this will fix it.



---

archive/issue_events_305242.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T13:35:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305242"
}
```



---

archive/issue_events_305243.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-10-11T13:35:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305243"
}
```



---

archive/issue_comments_317996.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nMeant to update on this sooner.  I can confirm that the new patch fixes the issue as well.",
    "created_at": "2016-10-11T13:35:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317996",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">comment:34</div>

Meant to update on this sooner.  I can confirm that the new patch fixes the issue as well.



---

archive/issue_comments_317997.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510\"><code>0e7d231</code></a></td><td><code>Merge tag '7.4.rc0' into t/21637/bug_with_pari_interface_gen_eval_on_cygwin</code></td></tr></table>\n",
    "created_at": "2016-10-11T14:59:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317997",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510"><code>0e7d231</code></a></td><td><code>Merge tag '7.4.rc0' into t/21637/bug_with_pari_interface_gen_eval_on_cygwin</code></td></tr></table>




---

archive/issue_comments_317998.json:
```json
{
    "body": "Changed commit from **[`fb8b1d2`](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)** to **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**",
    "created_at": "2016-10-11T14:59:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317998",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fb8b1d2`](https://github.com/sagemath/sagetrac-mirror/commit/fb8b1d22fefc72faf5932bab9327df6e4c7c7f61)** to **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**



---

archive/issue_events_305244.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2016-10-11T14:59:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305244"
}
```



---

archive/issue_events_305245.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2016-10-11T14:59:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305245"
}
```



---

archive/issue_comments_317999.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nBumping the PARI version (there was another PARI ticket merged in rc0).",
    "created_at": "2016-10-11T15:00:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-317999",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

Bumping the PARI version (there was another PARI ticket merged in rc0).



---

archive/issue_events_305246.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T15:00:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305246"
}
```



---

archive/issue_events_305247.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-11T15:00:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305247"
}
```



---

archive/issue_comments_318000.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2016-10-11T15:00:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318000",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Erik Bray**



---

archive/issue_comments_318001.json:
```json
{
    "body": "Dependencies: **#21582**",
    "created_at": "2016-10-11T15:00:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318001",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#21582**



---

archive/issue_events_305248.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305248"
}
```



---

archive/issue_events_305249.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "12042c39020fe4c13efaf41db323ca26c061a2e4",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-10-21T07:03:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21637#event-305249"
}
```



---

archive/issue_comments_318002.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)** to **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**",
    "created_at": "2016-10-21T07:03:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318002",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/bug_with_pari_interface_gen_eval_on_cygwin)** to **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)**



---

archive/issue_comments_318003.json:
```json
{
    "body": "log of compilation of 7.5beta0 WITHOUT #20523 (okay)",
    "created_at": "2016-10-23T16:47:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318003",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

log of compilation of 7.5beta0 WITHOUT #20523 (okay)



---

archive/issue_comments_318004.json:
```json
{
    "body": "Attachment: **[pari-2.8.0.alpha.p2.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8.0.alpha.p2.log)**\n\nLog of compilation of 7.5beta0 WITH #20523 (problematic)",
    "created_at": "2016-10-23T16:48:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318004",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment: **[pari-2.8.0.alpha.p2.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8.0.alpha.p2.log)**

Log of compilation of 7.5beta0 WITH #20523 (problematic)



---

archive/issue_comments_318005.json:
```json
{
    "body": "Changed commit from **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)** to none",
    "created_at": "2016-10-23T16:56:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318005",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changed commit from **[`0e7d231`](https://github.com/sagemath/sagetrac-mirror/commit/0e7d231ec555f0c320add18d2cbc75b028cfb510)** to none



---

archive/issue_comments_318006.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nAttachment: **[pari-2.8-2771-gb70b447.p0.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8-2771-gb70b447.p0.log)**\n\nI have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.\n\nI'll annotate #20523 (reminder...).",
    "created_at": "2016-10-23T16:56:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318006",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:40" align="right">comment:40</div>

Attachment: **[pari-2.8-2771-gb70b447.p0.log](https://github.com/sagemath/sage/files/ticket21637/pari-2.8-2771-gb70b447.p0.log)**

I have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.

I'll annotate #20523 (reminder...).



---

archive/issue_comments_318007.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\n`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.",
    "created_at": "2016-10-23T18:26:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318007",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:41" align="right">comment:41</div>

`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.



---

archive/issue_comments_318008.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@jdemeyer](#comment:41):\n> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\nI have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.\n\nI see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.\n\n\nCurrently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).\n\nI'll keep you posted after a `ptestlong` of this 7.4 patched version.\n\n[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n{{{charpent@asus16-ec:/usr/local/sage-7$ sage -standard\n[package]...............................[latest version] ([version])\n....\npari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)\n...}}}",
    "created_at": "2016-10-23T19:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318008",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@jdemeyer](#comment:41):
> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

I have already tried that : The damn thing sprouts back (and the error is the same...).

> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.

I see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.


Currently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).

I'll keep you posted after a `ptestlong` of this 7.4 patched version.

[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

{{{charpent@asus16-ec:/usr/local/sage-7$ sage -standard
[package]...............................[latest version] ([version])
....
pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)
...}}}



---

archive/issue_comments_318009.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@EmmanuelCharpentier](#comment:42):\n> Replying to [@jdemeyer](#comment:41):\n> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> \n> I have already tried that : The damn thing sprouts back (and the error is the same...).\n\nIn that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).",
    "created_at": "2016-10-23T19:44:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318009",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@EmmanuelCharpentier](#comment:42):
> Replying to [@jdemeyer](#comment:41):
> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> 
> I have already tried that : The damn thing sprouts back (and the error is the same...).

In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).



---

archive/issue_comments_318010.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@jdemeyer](#comment:43):\n> Replying to [@EmmanuelCharpentier](#comment:42):\n> > Replying to [@jdemeyer](#comment:41):\n> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> > \n> > I have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> \n> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).\n\n`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.\n\nMaybe I should try a fresh tree ?",
    "created_at": "2016-10-23T19:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318010",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@jdemeyer](#comment:43):
> Replying to [@EmmanuelCharpentier](#comment:42):
> > Replying to [@jdemeyer](#comment:41):
> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> > 
> > I have already tried that : The damn thing sprouts back (and the error is the same...).

> 
> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).

`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.

Maybe I should try a fresh tree ?



---

archive/issue_comments_318011.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@EmmanuelCharpentier](#comment:42), because my edit didn't went through the mail...\n\n[EDIT] According to \u200bVolker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n`charpent@asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`",
    "created_at": "2016-10-23T20:04:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318011",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@EmmanuelCharpentier](#comment:42), because my edit didn't went through the mail...

[EDIT] According to Volker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

`charpent@asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`



---

archive/issue_comments_318012.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@EmmanuelCharpentier](#comment:44):\n> `develop`##20523+#21744\n\nDouble-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.",
    "created_at": "2016-10-23T20:09:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318012",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@EmmanuelCharpentier](#comment:44):
> `develop`##20523+#21744

Double-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.



---

archive/issue_comments_318013.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nStarting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.\n\nI still do not understand how I managed to mess up my previous attempts.",
    "created_at": "2016-10-24T07:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21637#issuecomment-318013",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:47" align="right">comment:47</div>

Starting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.

I still do not understand how I managed to mess up my previous attempts.
