# Issue 21582: PARI: use PROT_NONE for unused virtual stack memory

archive/issues_021345.json:
```json
{
    "assignees": [],
    "body": "This ticket is meant to improve support for Linux with [vm.overcommit = 2](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting).\n\nIn Sage, the PARI stack takes a large amount of virtual memory but only a small part is usually used.\n\nWhen allocating memory, this memory is \"committed\" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.\n\nThis can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.\n\nThis branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.\n\nFinally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n\n**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html\n\n**Release manager**: merge with #21637\n\n**CC:**  bober @nexttime\n\n**Branch:** [ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)\n\n**Upstream:** Reported upstream. Developers acknowledge bug.\n\n**Reviewer:** Jonathan Bober\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/21582\n\n",
    "closed_at": "2016-10-21T07:03:46Z",
    "created_at": "2016-09-23T21:18:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "PARI: use PROT_NONE for unused virtual stack memory",
    "type": "issue",
    "updated_at": "2016-10-21T09:04:59Z",
    "url": "https://github.com/sagemath/sage/issues/21582",
    "user": "https://github.com/jdemeyer"
}
```
This ticket is meant to improve support for Linux with [vm.overcommit = 2](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting).

In Sage, the PARI stack takes a large amount of virtual memory but only a small part is usually used.

When allocating memory, this memory is "committed" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.

This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.

This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.

Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).

**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html

**Release manager**: merge with #21637

**CC:**  bober @nexttime

**Branch:** [ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)

**Upstream:** Reported upstream. Developers acknowledge bug.

**Reviewer:** Jonathan Bober

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/21582





---

archive/issue_events_262512.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-23T21:18:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262512"
}
```



---

archive/issue_events_262513.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-23T21:18:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "08517b",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262513"
}
```



---

archive/issue_events_262514.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-23T21:18:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262514"
}
```



---

archive/issue_comments_319360.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n+Improve support for Linux with vm.overcommit = 2\n \n+(details to follow)\n``````\n",
    "created_at": "2016-09-23T21:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319360",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
+Improve support for Linux with vm.overcommit = 2
 
+(details to follow)
``````




---

archive/issue_comments_319361.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-Improve support for Linux with vm.overcommit = 2\n+Improve support for Linux with `vm.overcommit = 2`\n \n (details to follow)\n``````\n",
    "created_at": "2016-09-23T21:20:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319361",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-Improve support for Linux with vm.overcommit = 2
+Improve support for Linux with `vm.overcommit = 2`
 
 (details to follow)
``````




---

archive/issue_comments_319362.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory)",
    "created_at": "2016-09-23T21:21:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319362",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory)



---

archive/issue_comments_319363.json:
```json
{
    "body": "**Commit:** [f54ecb5a5ef39fd67dd64e64d5f29840a33013d0](https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0)",
    "created_at": "2016-09-23T21:29:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319363",
    "user": "https://github.com/sagetrac-git"
}
```

**Commit:** [f54ecb5a5ef39fd67dd64e64d5f29840a33013d0](https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0)



---

archive/issue_comments_319364.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0\">f54ecb5</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>\n",
    "created_at": "2016-09-23T21:29:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319364",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'>**Comment 4:**</a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0">f54ecb5</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>




---

archive/issue_comments_319365.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n-Improve support for Linux with `vm.overcommit = 2`\n+This ticket is meant to improve support for Linux with [vm.overcommit = 2](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting).\n \n-(details to follow)\n+In Sage, the PARI stack takes a large amount of virtual memory but only a small part is usually used.\n+\n+When allocating memory, this memory is \"committed\" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.\n+\n+This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`).\n+\n+This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.\n``````\n",
    "created_at": "2016-09-24T06:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319365",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
-Improve support for Linux with `vm.overcommit = 2`
+This ticket is meant to improve support for Linux with [vm.overcommit = 2](https://www.kernel.org/doc/Documentation/vm/overcommit-accounting).
 
-(details to follow)
+In Sage, the PARI stack takes a large amount of virtual memory but only a small part is usually used.
+
+When allocating memory, this memory is "committed" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.
+
+This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`).
+
+This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.
``````




---

archive/issue_comments_319366.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,6 +4,6 @@\n \n When allocating memory, this memory is \"committed\" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.\n \n-This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`).\n+This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.\n \n This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.\n``````\n",
    "created_at": "2016-09-24T06:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319366",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,6 +4,6 @@
 
 When allocating memory, this memory is "committed" which means that it is made available as virtual memory. However, as long as a program is not using that memory, this costs nothing because the kernel does not need to make available actual memory (physical or swap) for it. This is different with `vm.overcommit = 2`: then all committed memory is counted. In that case, even unused virtual memory means that the system will have less memory available.
 
-This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`).
+This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.
 
 This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.
``````




---

archive/issue_comments_319367.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.\n \n This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.\n+\n+Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n``````\n",
    "created_at": "2016-09-24T06:15:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319367",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 This can be solved by using the `PROT_NONE` flag of [mmap(2)](https://linux.die.net/man/2/mmap). This means that the memory cannot be read nor written. In this case, the kernel does not commit this memory (it does show up as virtual memory in `top`). Note that this is not actually documented anywhere, but that is how it works.
 
 This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.
+
+Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).
``````




---

archive/issue_comments_319368.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57\">d165794</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>\n",
    "created_at": "2016-09-24T06:23:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319368",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'>**Comment 8:**</a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57">d165794</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>




---

archive/issue_comments_319369.json:
```json
{
    "body": "**Changing commit** from \"[f54ecb5a5ef39fd67dd64e64d5f29840a33013d0](https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0)\" to \"[d165794ed50d715606fe7d5c101f5c5b258b5a57](https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57)\".",
    "created_at": "2016-09-24T06:23:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319369",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[f54ecb5a5ef39fd67dd64e64d5f29840a33013d0](https://github.com/sagemath/sagetrac-mirror/commit/f54ecb5a5ef39fd67dd64e64d5f29840a33013d0)" to "[d165794ed50d715606fe7d5c101f5c5b258b5a57](https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57)".



---

archive/issue_events_262515.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-24T06:34:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262515"
}
```



---

archive/issue_comments_319370.json:
```json
{
    "body": "**Changing upstream** from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\".",
    "created_at": "2016-09-24T06:34:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319370",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet.".



---

archive/issue_comments_319371.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -9,3 +9,5 @@\n This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.\n \n Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n+\n+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html\n``````\n",
    "created_at": "2016-09-24T06:34:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319371",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -9,3 +9,5 @@
 This branch adds a PARI patch which implements this `PROT_NONE` trick. We first allocate the PARI stack in the usual way (so the maximum stack size is limited by the available virtual memory, which makes sense) but then uncommit most of the stack by reallocating it with `PROT_NONE`.
 
 Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).
+
+**Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html
``````




---

archive/issue_comments_319372.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536\">ccd9c1e</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>\n",
    "created_at": "2016-09-24T10:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319372",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'>**Comment 10:**</a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536">ccd9c1e</a></td><td><code>Improve support for Linux with vm.overcommit = 2</code></td></tr></table>




---

archive/issue_comments_319373.json:
```json
{
    "body": "**Changing commit** from \"[d165794ed50d715606fe7d5c101f5c5b258b5a57](https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57)\" to \"[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)\".",
    "created_at": "2016-09-24T10:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319373",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[d165794ed50d715606fe7d5c101f5c5b258b5a57](https://github.com/sagemath/sagetrac-mirror/commit/d165794ed50d715606fe7d5c101f5c5b258b5a57)" to "[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)".



---

archive/issue_events_262516.json:
```json
{
    "actor": "https://github.com/sagetrac-bober",
    "created_at": "2016-09-25T19:44:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262516"
}
```



---

archive/issue_events_262517.json:
```json
{
    "actor": "https://github.com/sagetrac-bober",
    "created_at": "2016-09-25T19:44:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262517"
}
```



---

archive/issue_comments_319374.json:
```json
{
    "body": "**Reviewer:** Jonathan Bober",
    "created_at": "2016-09-25T19:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319374",
    "user": "https://github.com/sagetrac-bober"
}
```

**Reviewer:** Jonathan Bober



---

archive/issue_comments_319375.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nLooks good to me. make ptest gives a few unrelated doctest failures that seem to be completely unrelated (and also occur on other branches).\n\nThe memory commit accounting works as expected for me; an immediate test is that I can test and build the documentation in parallel, while I couldn't before. Another test is that I can get parisizemax in my gprc and watch the committed memory go up and then down during a significant computation.\n\nAlso, it is at least not completely broken on OS X: https://groups.google.com/d/msg/sage-devel/rw4h229qZbk/oxeKCX-kBgAJ\n\n\nI just want to add that I don't really like that this seems to be relying on undocumented (as far as I can tell) low level memory management features, though it is behavior that seems to be used by other libraries that have interesting memory management strategies, such as openJDK and jemalloc. So be it.",
    "created_at": "2016-09-25T19:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319375",
    "user": "https://github.com/sagetrac-bober"
}
```

<a id='comment:11'>**Comment 11:**</a>
Looks good to me. make ptest gives a few unrelated doctest failures that seem to be completely unrelated (and also occur on other branches).

The memory commit accounting works as expected for me; an immediate test is that I can test and build the documentation in parallel, while I couldn't before. Another test is that I can get parisizemax in my gprc and watch the committed memory go up and then down during a significant computation.

Also, it is at least not completely broken on OS X: https://groups.google.com/d/msg/sage-devel/rw4h229qZbk/oxeKCX-kBgAJ


I just want to add that I don't really like that this seems to be relying on undocumented (as far as I can tell) low level memory management features, though it is behavior that seems to be used by other libraries that have interesting memory management strategies, such as openJDK and jemalloc. So be it.



---

archive/issue_comments_319376.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nReplying to [bober](#comment%3A11):\n> I just want to add that I don't really like that this seems to be relying on undocumented (as far as I can tell) low level memory management features, though it is behavior that seems to be used by other libraries that have interesting memory management strategies, such as openJDK and jemalloc. So be it.\n\nIndeed. It seems to be a more-or-less known trick, but it's not officially documented.",
    "created_at": "2016-09-26T13:22:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319376",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'>**Comment 12:**</a>
Replying to [bober](#comment%3A11):
> I just want to add that I don't really like that this seems to be relying on undocumented (as far as I can tell) low level memory management features, though it is behavior that seems to be used by other libraries that have interesting memory management strategies, such as openJDK and jemalloc. So be it.

Indeed. It seems to be a more-or-less known trick, but it's not officially documented.



---

archive/issue_comments_319377.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nThanks for the review by the way!",
    "created_at": "2016-09-26T13:22:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319377",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'>**Comment 13:**</a>
Thanks for the review by the way!



---

archive/issue_comments_319378.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nThank you for fixing problems that might only affect me!",
    "created_at": "2016-09-28T01:55:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319378",
    "user": "https://github.com/sagetrac-bober"
}
```

<a id='comment:14'>**Comment 14:**</a>
Thank you for fixing problems that might only affect me!



---

archive/issue_comments_319379.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -11,3 +11,5 @@\n Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n \n **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html\n+\n+**Release manager**: merge together with #21622.\n``````\n",
    "created_at": "2016-10-02T09:20:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319379",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -11,3 +11,5 @@
 Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).
 
 **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html
+
+**Release manager**: merge together with #21622.
``````




---

archive/issue_comments_319380.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nCurious as to whether I'll get a notification when this gets merged...",
    "created_at": "2016-10-02T12:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319380",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'>**Comment 16:**</a>
Curious as to whether I'll get a notification when this gets merged...



---

archive/issue_comments_319381.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -11,5 +11,3 @@\n Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n \n **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html\n-\n-**Release manager**: merge together with #21622.\n``````\n",
    "created_at": "2016-10-11T15:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319381",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -11,5 +11,3 @@
 Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).
 
 **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html
-
-**Release manager**: merge together with #21622.
``````




---

archive/issue_events_262518.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-20T06:56:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262518"
}
```



---

archive/issue_events_262519.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-20T06:56:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262519"
}
```



---

archive/issue_comments_319382.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nSee patchbot",
    "created_at": "2016-10-20T06:56:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319382",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'>**Comment 18:**</a>
See patchbot



---

archive/issue_comments_319383.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nThe reason is that several tickets bump the PARI version number.\n\n#21622 has an explicit instruction to merge it together with #21582 (this ticket). That did not happen.\n\nInstead, please merge this together with #21637, which also includes a PARI version bump.",
    "created_at": "2016-10-20T07:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319383",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'>**Comment 19:**</a>
The reason is that several tickets bump the PARI version number.

#21622 has an explicit instruction to merge it together with #21582 (this ticket). That did not happen.

Instead, please merge this together with #21637, which also includes a PARI version bump.



---

archive/issue_events_262520.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-20T07:01:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262520"
}
```



---

archive/issue_events_262521.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-20T07:01:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262521"
}
```



---

archive/issue_comments_319384.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -11,3 +11,5 @@\n Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).\n \n **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html\n+\n+**Release manager**: merge with #21637\n``````\n",
    "created_at": "2016-10-20T07:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319384",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -11,3 +11,5 @@
 Finally, note that this patch does not functionally affect PARI (but I did run doctests just in case).
 
 **Upstream report**: http://pari.math.u-bordeaux.fr/archives/pari-dev-1609/msg00008.html
+
+**Release manager**: merge with #21637
``````




---

archive/issue_events_262522.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262522"
}
```



---

archive/issue_events_262523.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "861618dbd1cdab11be9a81c5254f9d44334eccf0",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-10-21T07:03:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21582#event-262523"
}
```



---

archive/issue_comments_319385.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory)\" to \"[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)\".",
    "created_at": "2016-10-21T07:03:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319385",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory)" to "[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)".



---

archive/issue_comments_319386.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nJeroen, do you know what the status is upstream? The thread do not point to a final commit.",
    "created_at": "2016-10-21T08:45:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319386",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:21'>**Comment 21:**</a>
Jeroen, do you know what the status is upstream? The thread do not point to a final commit.



---

archive/issue_comments_319387.json:
```json
{
    "body": "**Changing commit** from \"[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)\" to \"\".",
    "created_at": "2016-10-21T08:45:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319387",
    "user": "https://github.com/kiwifb"
}
```

**Changing commit** from "[ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536](https://github.com/sagemath/sagetrac-mirror/commit/ccd9c1ebb4393b9c0fc741fd4dc608a67fe7c536)" to "".



---

archive/issue_comments_319388.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\nIt's still being discussed on pari-dev (the mailing list website tracks messages per month, so you need to look at october 2016): http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00015.html",
    "created_at": "2016-10-21T08:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319388",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'>**Comment 22:**</a>
It's still being discussed on pari-dev (the mailing list website tracks messages per month, so you need to look at october 2016): http://pari.math.u-bordeaux.fr/archives/pari-dev-1610/msg00015.html



---

archive/issue_comments_319389.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"Reported upstream. Developers acknowledge bug.\".",
    "created_at": "2016-10-21T08:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319389",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "Reported upstream. Developers acknowledge bug.".



---

archive/issue_comments_319390.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nNote that this patch really only matters in very specific cases. So it won't matter much if you don't apply it for sage-on-gentoo.",
    "created_at": "2016-10-21T08:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319390",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'>**Comment 23:**</a>
Note that this patch really only matters in very specific cases. So it won't matter much if you don't apply it for sage-on-gentoo.



---

archive/issue_comments_319391.json:
```json
{
    "body": "<a id='comment:24'>**Comment 24:**</a>\nThanks for the info, saves me some work. It will give a doctest failure though.",
    "created_at": "2016-10-21T08:57:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319391",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:24'>**Comment 24:**</a>
Thanks for the info, saves me some work. It will give a doctest failure though.



---

archive/issue_comments_319392.json:
```json
{
    "body": "<a id='comment:25'>**Comment 25:**</a>\nReplying to [@kiwifb](#comment%3A24):\n> It will give a doctest failure though.\n\nTrue, but that might be easily fixed with a minor adjustment to my patch.",
    "created_at": "2016-10-21T09:04:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21582#issuecomment-319392",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'>**Comment 25:**</a>
Replying to [@kiwifb](#comment%3A24):
> It will give a doctest failure though.

True, but that might be easily fixed with a minor adjustment to my patch.
