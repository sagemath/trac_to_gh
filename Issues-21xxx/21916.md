# Issue 21916: KeyError in graphviz_string the second time after adding a vertex

archive/issues_021679.json:
```json
{
    "body": "This works:\n\n```python\ng = graphs.PetersenGraph()\ng.add_vertex(\"a\")\nprint g.graphviz_string()\n```\n\nThis doesn't:\n\n```python\ng = graphs.PetersenGraph()\nkey = g._keys_for_vertices()\ng.add_vertex(\"a\")\nprint g.graphviz_string()\n\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n<ipython-input-36-67d7816cb08c> in <module>()\n      2 key = g._keys_for_vertices()\n      3 g.add_vertex(\"a\")\n----> 4 print g.graphviz_string()\n\n/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)\n    552                 options['__original_opts'] = kwds\n    553             options.update(kwds)\n--> 554             return func(*args, **options)\n    555 \n    556         #Add the options specified by @options to the signature of the wrapped\n\n/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in graphviz_string(self, **options)\n  19219                 node_options = \" [label=\\\"%s\\\"]\" %quoted_str(v)\n  19220 \n> 19221             s += '  %s %s;\\n'%(key(v),node_options)\n  19222 \n  19223         s += \"\\n\"\n\n/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in get_label(vertex)\n  18811             label[v] = 'node_{0}'.format(i)\n  18812         def get_label(vertex):\n> 18813             return label[vertex]\n  18814         return get_label\n  18815 \n\nKeyError: 'a'\n```\n\nThe problem most probably is that \n\n```python\ng._keys_for_vertices()\n```\nis a cached method.\n\nCC:  @seblabbe\n\nKeywords: days79\n\nBranch/Commit: 48fd7f52777fda51c5b007f3e53ee91d426e0780\n\nReviewer: David Coudert\n\nAuthor: S\u00e9bastien Labb\u00e9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21916\n\n",
    "closed_at": "2016-12-13T23:55:40Z",
    "created_at": "2016-11-21T14:48:56Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "KeyError in graphviz_string the second time after adding a vertex",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21916",
    "user": "https://trac.sagemath.org/admin/accounts/users/jepperlein"
}
```
This works:

```python
g = graphs.PetersenGraph()
g.add_vertex("a")
print g.graphviz_string()
```

This doesn't:

```python
g = graphs.PetersenGraph()
key = g._keys_for_vertices()
g.add_vertex("a")
print g.graphviz_string()

---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-36-67d7816cb08c> in <module>()
      2 key = g._keys_for_vertices()
      3 g.add_vertex("a")
----> 4 print g.graphviz_string()

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)
    552                 options['__original_opts'] = kwds
    553             options.update(kwds)
--> 554             return func(*args, **options)
    555 
    556         #Add the options specified by @options to the signature of the wrapped

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in graphviz_string(self, **options)
  19219                 node_options = " [label=\"%s\"]" %quoted_str(v)
  19220 
> 19221             s += '  %s %s;\n'%(key(v),node_options)
  19222 
  19223         s += "\n"

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in get_label(vertex)
  18811             label[v] = 'node_{0}'.format(i)
  18812         def get_label(vertex):
> 18813             return label[vertex]
  18814         return get_label
  18815 

KeyError: 'a'
```

The problem most probably is that 

```python
g._keys_for_vertices()
```
is a cached method.

CC:  @seblabbe

Keywords: days79

Branch/Commit: 48fd7f52777fda51c5b007f3e53ee91d426e0780

Reviewer: David Coudert

Author: Sébastien Labbé

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21916





---

archive/issue_comments_320378.json:
```json
{
    "body": "Changing keywords from \"\" to \"days79\".",
    "created_at": "2016-11-21T14:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320378",
    "user": "https://trac.sagemath.org/admin/accounts/users/jepperlein"
}
```

Changing keywords from "" to "days79".



---

archive/issue_comments_320379.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -45,6 +45,13 @@\n KeyError: 'a'\n ```\n \n+The problem most probably is that \n+\n+```python\n+_keys_for_vertices(self):\n+```\n+is a cached method.\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/21916\n``````\n",
    "created_at": "2016-11-21T15:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320379",
    "user": "https://trac.sagemath.org/admin/accounts/users/jepperlein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -45,6 +45,13 @@
 KeyError: 'a'
 ```
 
+The problem most probably is that 
+
+```python
+_keys_for_vertices(self):
+```
+is a cached method.
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/21916
``````




---

archive/issue_comments_320380.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,56 @@\n+This works:\n \n+```python\n+g = graphs.PetersenGraph()\n+g.add_vertex(\"a\")\n+print g.graphviz_string()\n+```\n+\n+This doesn't:\n+\n+```python\n+g = graphs.PetersenGraph()\n+key = g._keys_for_vertices()\n+g.add_vertex(\"a\")\n+print g.graphviz_string()\n+\n+---------------------------------------------------------------------------\n+KeyError                                  Traceback (most recent call last)\n+<ipython-input-36-67d7816cb08c> in <module>()\n+      2 key = g._keys_for_vertices()\n+      3 g.add_vertex(\"a\")\n+----> 4 print g.graphviz_string()\n+\n+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)\n+    552                 options['__original_opts'] = kwds\n+    553             options.update(kwds)\n+--> 554             return func(*args, **options)\n+    555 \n+    556         #Add the options specified by @options to the signature of the wrapped\n+\n+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in graphviz_string(self, **options)\n+  19219                 node_options = \" [label=\\\"%s\\\"]\" %quoted_str(v)\n+  19220 \n+> 19221             s += '  %s %s;\\n'%(key(v),node_options)\n+  19222 \n+  19223         s += \"\\n\"\n+\n+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in get_label(vertex)\n+  18811             label[v] = 'node_{0}'.format(i)\n+  18812         def get_label(vertex):\n+> 18813             return label[vertex]\n+  18814         return get_label\n+  18815 \n+\n+KeyError: 'a'\n+```\n+\n+The problem most probably is that \n+\n+```python\n+g._keys_for_vertices()\n+```\n+is a cached method.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-11-21T15:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320380",
    "user": "https://trac.sagemath.org/admin/accounts/users/jepperlein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,56 @@
+This works:
 
+```python
+g = graphs.PetersenGraph()
+g.add_vertex("a")
+print g.graphviz_string()
+```
+
+This doesn't:
+
+```python
+g = graphs.PetersenGraph()
+key = g._keys_for_vertices()
+g.add_vertex("a")
+print g.graphviz_string()
+
+---------------------------------------------------------------------------
+KeyError                                  Traceback (most recent call last)
+<ipython-input-36-67d7816cb08c> in <module>()
+      2 key = g._keys_for_vertices()
+      3 g.add_vertex("a")
+----> 4 print g.graphviz_string()
+
+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)
+    552                 options['__original_opts'] = kwds
+    553             options.update(kwds)
+--> 554             return func(*args, **options)
+    555 
+    556         #Add the options specified by @options to the signature of the wrapped
+
+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in graphviz_string(self, **options)
+  19219                 node_options = " [label=\"%s\"]" %quoted_str(v)
+  19220 
+> 19221             s += '  %s %s;\n'%(key(v),node_options)
+  19222 
+  19223         s += "\n"
+
+/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in get_label(vertex)
+  18811             label[v] = 'node_{0}'.format(i)
+  18812         def get_label(vertex):
+> 18813             return label[vertex]
+  18814         return get_label
+  18815 
+
+KeyError: 'a'
+```
+
+The problem most probably is that 
+
+```python
+g._keys_for_vertices()
+```
+is a cached method.
 
 Comment: 1
 
``````




---

archive/issue_comments_320381.json:
```json
{
    "body": "<a id='comment:4'></a>The only method that is using `cached_method` in the `generic_graph.py` file is the method `__hash__` and this methods works only if the graph is immutable. Therefore, to my opinion, I believe it was a bug that the method `_keys_for_vertices` was cached.\n\nNeeds review!\n\n---\nNew commits:",
    "created_at": "2016-11-23T22:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320381",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:4'></a>The only method that is using `cached_method` in the `generic_graph.py` file is the method `__hash__` and this methods works only if the graph is immutable. Therefore, to my opinion, I believe it was a bug that the method `_keys_for_vertices` was cached.

Needs review!

---
New commits:



---

archive/issue_comments_320382.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-23T22:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320382",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_320383.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-23T22:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320383",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320384.json:
```json
{
    "body": "<a id='comment:6'></a>I tried this patch on top of 7.5.beta6 and it works well (and passes all tests).\nGood to go.",
    "created_at": "2016-12-11T10:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320384",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:6'></a>I tried this patch on top of 7.5.beta6 and it works well (and passes all tests).
Good to go.



---

archive/issue_comments_320385.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-11T10:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320385",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_057819.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-13T23:55:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21916#event-57819"
}
```



---

archive/issue_comments_320386.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-12-13T23:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21916#issuecomment-320386",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
