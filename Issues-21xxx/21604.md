# Issue 21604: Cleaning up stale installed files in setup()

archive/issues_021367.json:
```json
{
    "body": "This part of `src/setup.py` should be moved inside some distutils command:\n\n```\n#########################################################\n### Clean\n#########################################################\n\nprint('Cleaning up stale installed files....')\nt = time.time()\nfrom sage_setup.clean import clean_install_dir\noutput_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))\nfor output_dir in output_dirs:\n    print('- cleaning {0}'.format(output_dir))\n    clean_install_dir(output_dir, python_packages, python_modules,\n            ext_modules, python_data_files)\nprint('Finished cleaning, time: %.2f seconds.' % (time.time() - t))\n```\n\nCC:  @mkoeppe\n\nBranch/Commit: 5ba95ed73aa3df532a2b6256510f2e2d842a0a35\n\nReviewer: Matthias Koeppe\n\nAuthor: Jeroen Demeyer\n\nDependencies: #21480\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21604\n\n",
    "closed_at": "2016-10-21T07:03:58Z",
    "created_at": "2016-09-27T13:23:39Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Cleaning up stale installed files in setup()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21604",
    "user": "https://github.com/jdemeyer"
}
```
This part of `src/setup.py` should be moved inside some distutils command:

```
#########################################################
### Clean
#########################################################

print('Cleaning up stale installed files....')
t = time.time()
from sage_setup.clean import clean_install_dir
output_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))
for output_dir in output_dirs:
    print('- cleaning {0}'.format(output_dir))
    clean_install_dir(output_dir, python_packages, python_modules,
            ext_modules, python_data_files)
print('Finished cleaning, time: %.2f seconds.' % (time.time() - t))
```

CC:  @mkoeppe

Branch/Commit: 5ba95ed73aa3df532a2b6256510f2e2d842a0a35

Reviewer: Matthias Koeppe

Author: Jeroen Demeyer

Dependencies: #21480

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21604





---

archive/issue_comments_401350.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/cleaning_up_stale_installed_files_in_setup__\"",
    "created_at": "2016-09-27T15:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401350",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/cleaning_up_stale_installed_files_in_setup__"



---

archive/issue_comments_401351.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[274d8b3](https://github.com/sagemath/sagetrac-mirror/commit/274d8b378586814a35d67ce342192f617bcbe97e)|`Clean up stale installed files in install command`|",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401351",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[274d8b3](https://github.com/sagemath/sagetrac-mirror/commit/274d8b378586814a35d67ce342192f617bcbe97e)|`Clean up stale installed files in install command`|



---

archive/issue_comments_401352.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401352",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401353.json:
```json
{
    "body": "Changing commit from \"\" to \"274d8b378586814a35d67ce342192f617bcbe97e\"",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401353",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "274d8b378586814a35d67ce342192f617bcbe97e"



---

archive/issue_comments_401354.json:
```json
{
    "body": "<a id='comment:3'></a>\nCould you add a few lines of comments to the patch that explain what \"stale installed files\" are?",
    "created_at": "2016-09-27T16:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401354",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
Could you add a few lines of comments to the patch that explain what "stale installed files" are?



---

archive/issue_comments_401355.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[e50f978](https://github.com/sagemath/sagetrac-mirror/commit/e50f978de0967be95d76534f7e9a5cfd740f8008)|`Add some documentation`|",
    "created_at": "2016-09-28T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[e50f978](https://github.com/sagemath/sagetrac-mirror/commit/e50f978de0967be95d76534f7e9a5cfd740f8008)|`Add some documentation`|



---

archive/issue_comments_401356.json:
```json
{
    "body": "Changing commit from \"274d8b378586814a35d67ce342192f617bcbe97e\" to \"e50f978de0967be95d76534f7e9a5cfd740f8008\"",
    "created_at": "2016-09-28T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401356",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "274d8b378586814a35d67ce342192f617bcbe97e" to "e50f978de0967be95d76534f7e9a5cfd740f8008"



---

archive/issue_comments_401357.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-28T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401357",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_401358.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#21580\"",
    "created_at": "2016-09-28T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401358",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#21580"



---

archive/issue_comments_401359.json:
```json
{
    "body": "Changing dependencies from \"#21580\" to \"#21480\"",
    "created_at": "2016-09-28T10:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401359",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#21580" to "#21480"



---

archive/issue_comments_401360.json:
```json
{
    "body": "Changing commit from \"e50f978de0967be95d76534f7e9a5cfd740f8008\" to \"5ba95ed73aa3df532a2b6256510f2e2d842a0a35\"",
    "created_at": "2016-09-28T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401360",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e50f978de0967be95d76534f7e9a5cfd740f8008" to "5ba95ed73aa3df532a2b6256510f2e2d842a0a35"



---

archive/issue_comments_401361.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n|                                                                                                                                           |                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|\n|[751bd0f](https://github.com/sagemath/sagetrac-mirror/commit/751bd0fbde10aa234867122308c7bb76673cbaba)|`Reword TODO item`|\n|[3a8cc0e](https://github.com/sagemath/sagetrac-mirror/commit/3a8cc0e1bc0c09142275a7ea6b03775e83d73e28)|`Fix typo in comment`|\n|[0dd9c50](https://github.com/sagemath/sagetrac-mirror/commit/0dd9c50021302e4d8cfc6f95e8bbdea232c60b97)|`Respect environment variable MAKE`|\n|[17f90d8](https://github.com/sagemath/sagetrac-mirror/commit/17f90d8d1e8b35f9ae08bb98bb876083ba968824)|`beautification`|\n|[e5f9065](https://github.com/sagemath/sagetrac-mirror/commit/e5f90659f21cc7ac1e39cdcf7974dba2ba223da5)|`More comments`|\n|[7791cd9](https://github.com/sagemath/sagetrac-mirror/commit/7791cd987347dfe253e3ed3ce74214f4527485d8)|`Remove --buildbase code`|\n|[74169e7](https://github.com/sagemath/sagetrac-mirror/commit/74169e75b0c650e6b1070c6beca231422cf62eaa)|`Pass SAGE_SRC to generate_py_source.mk`|\n|[0394333](https://github.com/sagemath/sagetrac-mirror/commit/0394333a54e51c53b9404f248220a412cf13e00e)|`Add new file to MANIFEST.in`|\n|[fdedb02](https://github.com/sagemath/sagetrac-mirror/commit/fdedb029434cba49db4249c5511af8c8efc08217)|`Install SAGE_LOCAL/bin/sage instead of SAGE_ROOT/sage as Jupyter kernel`|\n|[5ba95ed](https://github.com/sagemath/sagetrac-mirror/commit/5ba95ed73aa3df532a2b6256510f2e2d842a0a35)|`Clean up stale installed files in install command`|",
    "created_at": "2016-09-28T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401361",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
|                                                                                                                                           |                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|
|[751bd0f](https://github.com/sagemath/sagetrac-mirror/commit/751bd0fbde10aa234867122308c7bb76673cbaba)|`Reword TODO item`|
|[3a8cc0e](https://github.com/sagemath/sagetrac-mirror/commit/3a8cc0e1bc0c09142275a7ea6b03775e83d73e28)|`Fix typo in comment`|
|[0dd9c50](https://github.com/sagemath/sagetrac-mirror/commit/0dd9c50021302e4d8cfc6f95e8bbdea232c60b97)|`Respect environment variable MAKE`|
|[17f90d8](https://github.com/sagemath/sagetrac-mirror/commit/17f90d8d1e8b35f9ae08bb98bb876083ba968824)|`beautification`|
|[e5f9065](https://github.com/sagemath/sagetrac-mirror/commit/e5f90659f21cc7ac1e39cdcf7974dba2ba223da5)|`More comments`|
|[7791cd9](https://github.com/sagemath/sagetrac-mirror/commit/7791cd987347dfe253e3ed3ce74214f4527485d8)|`Remove --buildbase code`|
|[74169e7](https://github.com/sagemath/sagetrac-mirror/commit/74169e75b0c650e6b1070c6beca231422cf62eaa)|`Pass SAGE_SRC to generate_py_source.mk`|
|[0394333](https://github.com/sagemath/sagetrac-mirror/commit/0394333a54e51c53b9404f248220a412cf13e00e)|`Add new file to MANIFEST.in`|
|[fdedb02](https://github.com/sagemath/sagetrac-mirror/commit/fdedb029434cba49db4249c5511af8c8efc08217)|`Install SAGE_LOCAL/bin/sage instead of SAGE_ROOT/sage as Jupyter kernel`|
|[5ba95ed](https://github.com/sagemath/sagetrac-mirror/commit/5ba95ed73aa3df532a2b6256510f2e2d842a0a35)|`Clean up stale installed files in install command`|



---

archive/issue_comments_401362.json:
```json
{
    "body": "<a id='comment:8'></a>\nRebased on top of #21480.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401362",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Rebased on top of #21480.



---

archive/issue_comments_401363.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401363",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_401364.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-29T06:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401364",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401365.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2016-09-29T06:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401365",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_401366.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401366",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_401367.json:
```json
{
    "body": "<a id='comment:10'></a>\nAs I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401367",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.



---

archive/issue_comments_401368.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A10):\n> As I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.\n\n\nCouldn't this be done as follow-up ticket? Otherwise we will never make progress.\n\nWhat you say makes sense, but the changes made in this ticket also make sense.",
    "created_at": "2016-10-05T15:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401368",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A10):
> As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.


Couldn't this be done as follow-up ticket? Otherwise we will never make progress.

What you say makes sense, but the changes made in this ticket also make sense.



---

archive/issue_comments_401369.json:
```json
{
    "body": "<a id='comment:12'></a>\nI agree with Jeroen. \nThis ticket is an important step, moving the \"clean\" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. \nA follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.",
    "created_at": "2016-10-05T18:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401369",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
I agree with Jeroen. 
This ticket is an important step, moving the "clean" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. 
A follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.



---

archive/issue_comments_401370.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-05T19:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401370",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_401371.json:
```json
{
    "body": "<a id='comment:14'></a>\nI've created the follow-up ticket at #21654.",
    "created_at": "2016-10-05T19:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401371",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
I've created the follow-up ticket at #21654.



---

archive/issue_comments_401372.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401372",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_401373.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/cleaning_up_stale_installed_files_in_setup__\" to \"5ba95ed73aa3df532a2b6256510f2e2d842a0a35\"",
    "created_at": "2016-10-21T07:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-401373",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/cleaning_up_stale_installed_files_in_setup__" to "5ba95ed73aa3df532a2b6256510f2e2d842a0a35"



---

archive/issue_events_065172.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21604#event-65172"
}
```
