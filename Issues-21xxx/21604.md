# Issue 21604: Cleaning up stale installed files in setup()

archive/issues_021367.json:
```json
{
    "body": "This part of `src/setup.py` should be moved inside some distutils command:\n\n```\n#########################################################\n### Clean\n#########################################################\n\nprint('Cleaning up stale installed files....')\nt = time.time()\nfrom sage_setup.clean import clean_install_dir\noutput_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))\nfor output_dir in output_dirs:\n    print('- cleaning {0}'.format(output_dir))\n    clean_install_dir(output_dir, python_packages, python_modules,\n            ext_modules, python_data_files)\nprint('Finished cleaning, time: %.2f seconds.' % (time.time() - t))\n```\n\nCC:  @mkoeppe\n\nBranch/Commit: 5ba95ed73aa3df532a2b6256510f2e2d842a0a35\n\nReviewer: Matthias Koeppe\n\nAuthor: Jeroen Demeyer\n\nDependencies: #21480\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21604\n\n",
    "closed_at": "2016-10-21T07:03:58Z",
    "created_at": "2016-09-27T13:23:39Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Cleaning up stale installed files in setup()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21604",
    "user": "https://github.com/jdemeyer"
}
```
This part of `src/setup.py` should be moved inside some distutils command:

```
#########################################################
### Clean
#########################################################

print('Cleaning up stale installed files....')
t = time.time()
from sage_setup.clean import clean_install_dir
output_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))
for output_dir in output_dirs:
    print('- cleaning {0}'.format(output_dir))
    clean_install_dir(output_dir, python_packages, python_modules,
            ext_modules, python_data_files)
print('Finished cleaning, time: %.2f seconds.' % (time.time() - t))
```

CC:  @mkoeppe

Branch/Commit: 5ba95ed73aa3df532a2b6256510f2e2d842a0a35

Reviewer: Matthias Koeppe

Author: Jeroen Demeyer

Dependencies: #21480

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21604





---

archive/issue_comments_398517.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/cleaning_up_stale_installed_files_in_setup__\"",
    "created_at": "2016-09-27T15:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398517",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/cleaning_up_stale_installed_files_in_setup__"



---

archive/issue_comments_398518.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398518",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_398519.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398519",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_398520.json:
```json
{
    "body": "Changing commit from \"\" to \"274d8b378586814a35d67ce342192f617bcbe97e\"",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398520",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "274d8b378586814a35d67ce342192f617bcbe97e"



---

archive/issue_comments_398521.json:
```json
{
    "body": "<a id='comment:3'></a>Could you add a few lines of comments to the patch that explain what \"stale installed files\" are?",
    "created_at": "2016-09-27T16:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398521",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Could you add a few lines of comments to the patch that explain what "stale installed files" are?



---

archive/issue_comments_398522.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-28T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_398523.json:
```json
{
    "body": "Changing commit from \"274d8b378586814a35d67ce342192f617bcbe97e\" to \"e50f978de0967be95d76534f7e9a5cfd740f8008\"",
    "created_at": "2016-09-28T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398523",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "274d8b378586814a35d67ce342192f617bcbe97e" to "e50f978de0967be95d76534f7e9a5cfd740f8008"



---

archive/issue_comments_398524.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-28T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398524",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_398525.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#21580\"",
    "created_at": "2016-09-28T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398525",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#21580"



---

archive/issue_comments_398526.json:
```json
{
    "body": "Changing dependencies from \"#21580\" to \"#21480\"",
    "created_at": "2016-09-28T10:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398526",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#21580" to "#21480"



---

archive/issue_comments_398527.json:
```json
{
    "body": "Changing commit from \"e50f978de0967be95d76534f7e9a5cfd740f8008\" to \"5ba95ed73aa3df532a2b6256510f2e2d842a0a35\"",
    "created_at": "2016-09-28T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398527",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e50f978de0967be95d76534f7e9a5cfd740f8008" to "5ba95ed73aa3df532a2b6256510f2e2d842a0a35"



---

archive/issue_comments_398528.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2016-09-28T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398528",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_398529.json:
```json
{
    "body": "<a id='comment:8'></a>Rebased on top of #21480.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398529",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Rebased on top of #21480.



---

archive/issue_comments_398530.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398530",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_398531.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-29T06:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398531",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_398532.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2016-09-29T06:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398532",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_398533.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398533",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_398534.json:
```json
{
    "body": "<a id='comment:10'></a>As I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398534",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.



---

archive/issue_comments_398535.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [embray](#comment%3A10):\n> As I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.\n\n\nCouldn't this be done as follow-up ticket? Otherwise we will never make progress.\n\nWhat you say makes sense, but the changes made in this ticket also make sense.",
    "created_at": "2016-10-05T15:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398535",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [embray](#comment%3A10):
> As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.


Couldn't this be done as follow-up ticket? Otherwise we will never make progress.

What you say makes sense, but the changes made in this ticket also make sense.



---

archive/issue_comments_398536.json:
```json
{
    "body": "<a id='comment:12'></a>I agree with Jeroen. \nThis ticket is an important step, moving the \"clean\" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. \nA follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.",
    "created_at": "2016-10-05T18:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398536",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>I agree with Jeroen. 
This ticket is an important step, moving the "clean" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. 
A follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.



---

archive/issue_comments_398537.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-05T19:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398537",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_398538.json:
```json
{
    "body": "<a id='comment:14'></a>I've created the follow-up ticket at #21654.",
    "created_at": "2016-10-05T19:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398538",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>I've created the follow-up ticket at #21654.



---

archive/issue_comments_398539.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398539",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_398540.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/cleaning_up_stale_installed_files_in_setup__\" to \"5ba95ed73aa3df532a2b6256510f2e2d842a0a35\"",
    "created_at": "2016-10-21T07:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21604#issuecomment-398540",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/cleaning_up_stale_installed_files_in_setup__" to "5ba95ed73aa3df532a2b6256510f2e2d842a0a35"



---

archive/issue_events_057320.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21604",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21604#event-57320"
}
```
