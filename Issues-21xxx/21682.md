# Issue 21682: Add a separate "build_cython" command to setup.py

archive/issues_021445.json:
```json
{
    "body": "This is a follow-on to #21600.  It adds a new `cythonize` command to the `setup.py`, and moves most of the logic for running `cythonize()` (previously in the customized `build_ext`) command, into this new command.\n\nThe new `cythonize` command is run always from `build_ext` anyways, but this has a couple advantages:\n\n1) It is possible to run *just* `cythonize`, without compiling extension modules.  This maybe isn't that common, but can be useful for development, especially when testing issues with Cython itself.  It will also be useful for generating source distributions, where we might want to ship Cythonized sources in the source tarball, and hence would need to generate them as part of the process of building the tarball (without necessarily compiling).\n\nThis also allows passing options directly from the command-line to `cythonize`.  This isn't much taken advantage of currently but the possibility is there.\n\n2) Code is clearer and more modular.  Specific details for compiling cython code are kept separate from details for compiling C/C++ code.\n\nSee also upstream discussion of a \"generic\" implementation: https://github.com/cython/cython/issues/1514\n\nCC:  @mkoeppe\n\nKeywords: cython distutils\n\nBranch/Commit: a049f2d968d9ad5d901e68b44d46f1c06b5e747f\n\nUpstream: Reported upstream. Developers acknowledge bug.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21682\n\n",
    "closed_at": "2017-04-05T19:38:02Z",
    "created_at": "2016-10-11T15:31:23Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Add a separate \"build_cython\" command to setup.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21682",
    "user": "https://github.com/embray"
}
```
This is a follow-on to #21600.  It adds a new `cythonize` command to the `setup.py`, and moves most of the logic for running `cythonize()` (previously in the customized `build_ext`) command, into this new command.

The new `cythonize` command is run always from `build_ext` anyways, but this has a couple advantages:

1) It is possible to run *just* `cythonize`, without compiling extension modules.  This maybe isn't that common, but can be useful for development, especially when testing issues with Cython itself.  It will also be useful for generating source distributions, where we might want to ship Cythonized sources in the source tarball, and hence would need to generate them as part of the process of building the tarball (without necessarily compiling).

This also allows passing options directly from the command-line to `cythonize`.  This isn't much taken advantage of currently but the possibility is there.

2) Code is clearer and more modular.  Specific details for compiling cython code are kept separate from details for compiling C/C++ code.

See also upstream discussion of a "generic" implementation: https://github.com/cython/cython/issues/1514

CC:  @mkoeppe

Keywords: cython distutils

Branch/Commit: a049f2d968d9ad5d901e68b44d46f1c06b5e747f

Upstream: Reported upstream. Developers acknowledge bug.

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21682





---

archive/issue_comments_316733.json:
```json
{
    "body": "<a id='comment:1'></a>I have a few other to-do issues in this code, but they're not essential.  Not sure if they should be worried about for now, or in a follow-up issue if this code is accepted.",
    "created_at": "2016-10-11T15:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316733",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>I have a few other to-do issues in this code, but they're not essential.  Not sure if they should be worried about for now, or in a follow-up issue if this code is accepted.



---

archive/issue_comments_316734.json:
```json
{
    "body": "<a id='comment:2'></a>I suggest that you first discuss this with upstream `cython`.",
    "created_at": "2016-10-11T15:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316734",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>I suggest that you first discuss this with upstream `cython`.



---

archive/issue_comments_316735.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-11-07T12:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_316736.json:
```json
{
    "body": "<a id='comment:4'></a>Rebased--I agree this could also be worth bringing upstream in some form, but do you have any other comments?",
    "created_at": "2016-11-07T12:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316736",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Rebased--I agree this could also be worth bringing upstream in some form, but do you have any other comments?



---

archive/issue_comments_316737.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-07T12:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316737",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_316738.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 embray]:\n> do you have any other comments?\n\n\nIt would be better to separate the Sage-specific parts from the general code which could be upstreamed.",
    "created_at": "2016-11-07T12:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316738",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [comment:4 embray]:
> do you have any other comments?


It would be better to separate the Sage-specific parts from the general code which could be upstreamed.



---

archive/issue_comments_316739.json:
```json
{
    "body": "<a id='comment:8'></a>Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?",
    "created_at": "2016-11-07T12:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316739",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?



---

archive/issue_comments_316740.json:
```json
{
    "body": "<a id='comment:9'></a>Why did you change\n\n```\nos.environ.get('SAGE_DEBUG', None) != 'no'\n```\nto\n\n```\nos.environ.get('SAGE_DEBUG', 'no') != 'no'\n```",
    "created_at": "2016-11-07T13:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316740",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Why did you change

```
os.environ.get('SAGE_DEBUG', None) != 'no'
```
to

```
os.environ.get('SAGE_DEBUG', 'no') != 'no'
```



---

archive/issue_comments_316741.json:
```json
{
    "body": "<a id='comment:10'></a>Regarding this:\n\n```\n    # TODO: This works for the C sources themselves, but this logic\n    # should also apply to Cython sources--shouldn't the be rebuilt\n    # if this file changes?  Alternatively, we could add more details\n    # (e.g. cythonize() flags) to the .cython_version file\n```\nI implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.\n\nYou are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.",
    "created_at": "2016-11-07T13:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316741",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Regarding this:

```
    # TODO: This works for the C sources themselves, but this logic
    # should also apply to Cython sources--shouldn't the be rebuilt
    # if this file changes?  Alternatively, we could add more details
    # (e.g. cythonize() flags) to the .cython_version file
```
I implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.

You are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.



---

archive/issue_comments_316742.json:
```json
{
    "body": "<a id='comment:11'></a>I would suggest to simplify\n\n```\n        if self.parallel is None:\n            self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))\n\n        if isinstance(self.parallel, str):\n            try:\n                self.parallel = int(self.parallel)\n            except ValueError:\n                raise DistutilsOptionError(\"parallel should be an integer\")\n```\nto\n\n```\n        if self.parallel is None:\n            self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)\n\n        try:\n            self.parallel = int(self.parallel)\n        except ValueError:\n            raise DistutilsOptionError(\"parallel should be an integer\")\n```",
    "created_at": "2016-11-07T13:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316742",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I would suggest to simplify

```
        if self.parallel is None:
            self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))

        if isinstance(self.parallel, str):
            try:
                self.parallel = int(self.parallel)
            except ValueError:
                raise DistutilsOptionError("parallel should be an integer")
```
to

```
        if self.parallel is None:
            self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)

        try:
            self.parallel = int(self.parallel)
        except ValueError:
            raise DistutilsOptionError("parallel should be an integer")
```



---

archive/issue_comments_316743.json:
```json
{
    "body": "<a id='comment:12'></a>In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?",
    "created_at": "2016-11-07T13:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316743",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?



---

archive/issue_comments_316744.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:8 jdemeyer]:\n> Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?\n\n\nI think that was my first inclination as well.  I went with `cythonize` just to emphasize that this was mostly a wrapper around that, but I think you've convinced me (just by confirming my initial idea) over toward `build_cython`",
    "created_at": "2016-11-07T14:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316744",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Replying to [comment:8 jdemeyer]:
> Bikeshed: since all `build` commands start with `build`, wouldn't this command better be called `build_cython` or something like that?


I think that was my first inclination as well.  I went with `cythonize` just to emphasize that this was mostly a wrapper around that, but I think you've convinced me (just by confirming my initial idea) over toward `build_cython`



---

archive/issue_comments_316745.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:9 jdemeyer]:\n> Why did you change\n> \n> ```\n> os.environ.get('SAGE_DEBUG', None) != 'no'\n> ```\n> to\n> \n> ```\n> os.environ.get('SAGE_DEBUG', 'no') != 'no'\n> ```\n\n\nI don't think I meant to.  I think originally it *was* `os.environ.get('SAGE_DEBUG', 'no')` and the fact that it's changed now might be a symptom of rebasing.  I'll fix that.  I definitely like the current spelling better.",
    "created_at": "2016-11-07T14:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316745",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Replying to [comment:9 jdemeyer]:
> Why did you change
> 
> ```
> os.environ.get('SAGE_DEBUG', None) != 'no'
> ```
> to
> 
> ```
> os.environ.get('SAGE_DEBUG', 'no') != 'no'
> ```


I don't think I meant to.  I think originally it *was* `os.environ.get('SAGE_DEBUG', 'no')` and the fact that it's changed now might be a symptom of rebasing.  I'll fix that.  I definitely like the current spelling better.



---

archive/issue_comments_316746.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:11 jdemeyer]:\n> I would suggest to simplify\n> \n> ```\n>         if self.parallel is None:\n>             self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))\n> \n>         if isinstance(self.parallel, str):\n>             try:\n>                 self.parallel = int(self.parallel)\n>             except ValueError:\n>                 raise DistutilsOptionError(\"parallel should be an integer\")\n> ```\n> to\n> \n> ```\n>         if self.parallel is None:\n>             self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)\n> \n>         try:\n>             self.parallel = int(self.parallel)\n>         except ValueError:\n>             raise DistutilsOptionError(\"parallel should be an integer\")\n> ```\n\n\nAgreed",
    "created_at": "2016-11-07T14:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316746",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Replying to [comment:11 jdemeyer]:
> I would suggest to simplify
> 
> ```
>         if self.parallel is None:
>             self.parallel = int(os.environ.get('SAGE_NUM_THREADS', 0))
> 
>         if isinstance(self.parallel, str):
>             try:
>                 self.parallel = int(self.parallel)
>             except ValueError:
>                 raise DistutilsOptionError("parallel should be an integer")
> ```
> to
> 
> ```
>         if self.parallel is None:
>             self.parallel = os.environ.get('SAGE_NUM_THREADS', 0)
> 
>         try:
>             self.parallel = int(self.parallel)
>         except ValueError:
>             raise DistutilsOptionError("parallel should be an integer")
> ```


Agreed



---

archive/issue_comments_316747.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:12 jdemeyer]:\n> In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?\n\n\nYes, IIRC that was in anticipation of fixing #21535, but I left the actual value hard-coded for now so as to not change existing behavior (since currently setting it to anything else will break other things that hard-code `SAGE_CYTHONIZED`).  For the purposes of this ticket as a stand-alone enhancement that is confusing though.  I could leave the internal `build_dir` attribute for now and just get rid of the user option (temporarily).",
    "created_at": "2016-11-07T14:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316747",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Replying to [comment:12 jdemeyer]:
> In `finalize_options`, you are setting `build_dir` unconditionally. Does that mean that the `--build-dir` option is ignored?


Yes, IIRC that was in anticipation of fixing #21535, but I left the actual value hard-coded for now so as to not change existing behavior (since currently setting it to anything else will break other things that hard-code `SAGE_CYTHONIZED`).  For the purposes of this ticket as a stand-alone enhancement that is confusing though.  I could leave the internal `build_dir` attribute for now and just get rid of the user option (temporarily).



---

archive/issue_comments_316748.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:14 embray]:\n> I definitely like the current spelling better.\n\n\nIt's not just a matter of spelling. It is a functional difference.",
    "created_at": "2016-11-07T15:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316748",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:14 embray]:
> I definitely like the current spelling better.


It's not just a matter of spelling. It is a functional difference.



---

archive/issue_comments_316749.json:
```json
{
    "body": "<a id='comment:18'></a>For history about this `os.environ.get('SAGE_DEBUG', None)`, see #13881.",
    "created_at": "2016-11-07T15:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316749",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>For history about this `os.environ.get('SAGE_DEBUG', None)`, see #13881.



---

archive/issue_comments_316750.json:
```json
{
    "body": "<a id='comment:19'></a>I agree, I wasn't being flippant :)",
    "created_at": "2016-11-07T15:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316750",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>I agree, I wasn't being flippant :)



---

archive/issue_comments_316751.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:10 jdemeyer]:\n> Regarding this:\n> \n> ```\n>     # TODO: This works for the C sources themselves, but this logic\n>     # should also apply to Cython sources--shouldn't the be rebuilt\n>     # if this file changes?  Alternatively, we could add more details\n>     # (e.g. cythonize() flags) to the .cython_version file\n> ```\n> I implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.\n> \n> You are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.\n\n\nWhat if we made a \"version 2\" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?",
    "created_at": "2016-11-07T15:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316751",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Replying to [comment:10 jdemeyer]:
> Regarding this:
> 
> ```
>     # TODO: This works for the C sources themselves, but this logic
>     # should also apply to Cython sources--shouldn't the be rebuilt
>     # if this file changes?  Alternatively, we could add more details
>     # (e.g. cythonize() flags) to the .cython_version file
> ```
> I implemented that dependency on `setup.py` for the C files only because Cythonization does not really depend on `setup.py`.
> 
> You are right that the `cythonize()` flags affect Cythonization, but that is why we have `.cython_version`. But it would indeed be better if `.cython_version` would be more auto-generated with the relevant arguments given to `cythonize()`.


What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?



---

archive/issue_comments_316752.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 embray]:\n> What if we made a \"version 2\" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?\n\n\nI think that's a good idea. But that should be an independent ticket. I don't see the need for the \"backwards compat for the old format\" though.",
    "created_at": "2016-11-07T15:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316752",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [comment:20 embray]:
> What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?


I think that's a good idea. But that should be an independent ticket. I don't see the need for the "backwards compat for the old format" though.



---

archive/issue_comments_316753.json:
```json
{
    "body": "<a id='comment:22'></a>Opened an upstream issue at https://github.com/cython/cython/issues/1514\n\nA generic build_cython command could take most any `cythonize()` arguments as options.  A sage-specific wrapper around that would just be setting (or possibly enforcing) certain defaults.",
    "created_at": "2016-11-07T15:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316753",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Opened an upstream issue at https://github.com/cython/cython/issues/1514

A generic build_cython command could take most any `cythonize()` arguments as options.  A sage-specific wrapper around that would just be setting (or possibly enforcing) certain defaults.



---

archive/issue_comments_316754.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,6 +7,8 @@\n This also allows passing options directly from the command-line to `cythonize`.  This isn't much taken advantage of currently but the possibility is there.\n \n 2) Code is clearer and more modular.  Specific details for compiling cython code are kept separate from details for compiling C/C++ code.\n+\n+See also upstream discussion of a \"generic\" implementation: https://github.com/cython/cython/issues/1514\n \n Author: Erik Bray\n \n``````\n",
    "created_at": "2016-11-07T15:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316754",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,6 +7,8 @@
 This also allows passing options directly from the command-line to `cythonize`.  This isn't much taken advantage of currently but the possibility is there.
 
 2) Code is clearer and more modular.  Specific details for compiling cython code are kept separate from details for compiling C/C++ code.
+
+See also upstream discussion of a "generic" implementation: https://github.com/cython/cython/issues/1514
 
 Author: Erik Bray
 
``````




---

archive/issue_comments_316755.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:21 jdemeyer]:\n> Replying to [comment:20 embray]:\n> > What if we made a \"version 2\" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?\n\n> \n> I think that's a good idea. But that should be an independent ticket. I don't see the need for the \"backwards compat for the old format\" though.\n\n\nAgree it's a separate issue.  As for backwards-compat, it at least needs to fail gracefully if the existing file is not in the new format, and rebuild + regenerate the file but that's fine.",
    "created_at": "2016-11-07T15:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316755",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 embray]:
> > What if we made a "version 2" `.cython_version` (with backwards compat for the old format of course), with a new format in JSON that can accurately reflect the options passed to `cythonize()`?

> 
> I think that's a good idea. But that should be an independent ticket. I don't see the need for the "backwards compat for the old format" though.


Agree it's a separate issue.  As for backwards-compat, it at least needs to fail gracefully if the existing file is not in the new format, and rebuild + regenerate the file but that's fine.



---

archive/issue_comments_316756.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:9 jdemeyer]:\n> Why did you change\n> \n> ```\n> os.environ.get('SAGE_DEBUG', None) != 'no'\n> ```\n> to\n> \n> ```\n> os.environ.get('SAGE_DEBUG', 'no') != 'no'\n> ```\n\n\nActually, just to make sure I'm clear about this, is the point that debug should be enabled *by default* if SAGE_DEBUG is not explicitly set to \"no\"?",
    "created_at": "2016-11-08T12:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316756",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>Replying to [comment:9 jdemeyer]:
> Why did you change
> 
> ```
> os.environ.get('SAGE_DEBUG', None) != 'no'
> ```
> to
> 
> ```
> os.environ.get('SAGE_DEBUG', 'no') != 'no'
> ```


Actually, just to make sure I'm clear about this, is the point that debug should be enabled *by default* if SAGE_DEBUG is not explicitly set to "no"?



---

archive/issue_comments_316757.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 embray]:\n> Actually, just to make sure I'm clear about this, is the point that debug should be enabled *by default* if SAGE_DEBUG is not explicitly set to \"no\"?\n\n\nExactly.",
    "created_at": "2016-11-08T12:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316757",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:25 embray]:
> Actually, just to make sure I'm clear about this, is the point that debug should be enabled *by default* if SAGE_DEBUG is not explicitly set to "no"?


Exactly.



---

archive/issue_comments_316758.json:
```json
{
    "body": "<a id='comment:27'></a>I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.  I'd be happy to change that in Sage's build_* commands, but it should be changed across the board, and a `--no-debug` option to turn it off is added.  But it would be simpler to not make it the default.\n\nInstead, if we want to enable debug by default (which I agree is the best choice for development) we can either add it in the setup.cfg (but it would have to be removed when making a release) or in your local pydistutils.cfg.  \n\nOr am I missing something here?",
    "created_at": "2016-11-08T12:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316758",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.  I'd be happy to change that in Sage's build_* commands, but it should be changed across the board, and a `--no-debug` option to turn it off is added.  But it would be simpler to not make it the default.

Instead, if we want to enable debug by default (which I agree is the best choice for development) we can either add it in the setup.cfg (but it would have to be removed when making a release) or in your local pydistutils.cfg.  

Or am I missing something here?



---

archive/issue_comments_316759.json:
```json
{
    "body": "<a id='comment:28'></a>(I realize that the \"gdb_debug\" option for Cythonize and the \"debug\" option for building C sources are not the same thing, but they also kind of go hand-in-hand).",
    "created_at": "2016-11-08T12:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316759",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>(I realize that the "gdb_debug" option for Cythonize and the "debug" option for building C sources are not the same thing, but they also kind of go hand-in-hand).



---

archive/issue_comments_316760.json:
```json
{
    "body": "<a id='comment:29'></a>Nevermind--I read the docs for `SAGE_DEBUG` and that gave me a better understanding.  I'll play around a bit more with how the command-line option works, but I agree that the behavior you requested is consistent with how the `SAGE_DEBUG` environment variable itself should be interpreted.\n\nI think for the `build_cython` command I'll remove the `--debug` option entirely, and make `gdb_debug=True` by default pending the value of `SAGE_DEBUG` (that is, identical to the previous behavior).  There's no huge advantage to having an option to explicitly disable it.",
    "created_at": "2016-11-08T13:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316760",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>Nevermind--I read the docs for `SAGE_DEBUG` and that gave me a better understanding.  I'll play around a bit more with how the command-line option works, but I agree that the behavior you requested is consistent with how the `SAGE_DEBUG` environment variable itself should be interpreted.

I think for the `build_cython` command I'll remove the `--debug` option entirely, and make `gdb_debug=True` by default pending the value of `SAGE_DEBUG` (that is, identical to the previous behavior).  There's no huge advantage to having an option to explicitly disable it.



---

archive/issue_comments_316761.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-08T13:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_316762.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:27 embray]:\n> I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.\n\n\nIn practice, `--debug` is the default because Python compiles by default with `-g` (even twice!). The *default* gcc command line starts with\n\n```\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC\n```\n(Sage adds the `-Wno-unused` flag to this and removes `-Wstrict-prototypes`)\n\nAdding the `--debug` option to distutils adds an *additional* `-g` but that doesn't change anything really.",
    "created_at": "2016-11-08T13:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316762",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Replying to [comment:27 embray]:
> I'm not sure how I feel about that--it goes against the default for building extension modules which is that the `--debug` option is not on by default.


In practice, `--debug` is the default because Python compiles by default with `-g` (even twice!). The *default* gcc command line starts with

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC
```
(Sage adds the `-Wno-unused` flag to this and removes `-Wstrict-prototypes`)

Adding the `--debug` option to distutils adds an *additional* `-g` but that doesn't change anything really.



---

archive/issue_comments_316763.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:29 embray]:\n> There's no huge advantage to having an option to explicitly disable it.\n\n\nThe only potential advantage would be disk space (and maybe build time).",
    "created_at": "2016-11-08T13:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316763",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>Replying to [comment:29 embray]:
> There's no huge advantage to having an option to explicitly disable it.


The only potential advantage would be disk space (and maybe build time).



---

archive/issue_comments_316764.json:
```json
{
    "body": "<a id='comment:34'></a>I recently did some work on the `setup.py` for `cysignals` and I realized that it makes the most sense to run Cython as *first* build command, before `build_py`. This is because `build_py` handles `package_data` and we may want to handle Cython-generated files as `package_data` some day (see #20108).\n\nFor this reason, in `cysignals` I decided to run Cython in the base `build` command.",
    "created_at": "2016-11-22T16:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316764",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>I recently did some work on the `setup.py` for `cysignals` and I realized that it makes the most sense to run Cython as *first* build command, before `build_py`. This is because `build_py` handles `package_data` and we may want to handle Cython-generated files as `package_data` some day (see #20108).

For this reason, in `cysignals` I decided to run Cython in the base `build` command.



---

archive/issue_comments_316765.json:
```json
{
    "body": "<a id='comment:35'></a>I see--that does make sense.  It simplifies things too--we can just insert `build_cython` into the front of the `build` sub-commands list.",
    "created_at": "2016-11-23T11:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316765",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>I see--that does make sense.  It simplifies things too--we can just insert `build_cython` into the front of the `build` sub-commands list.



---

archive/issue_comments_316766.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-23T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_316767.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-08T19:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316767",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_316768.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-12-09T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_316769.json:
```json
{
    "body": "<a id='comment:39'></a>Rebased\n\n---\nNew commits:",
    "created_at": "2016-12-09T12:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316769",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'></a>Rebased

---
New commits:



---

archive/issue_comments_316770.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-12-09T12:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316770",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_316771.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-29T12:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316771",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_316772.json:
```json
{
    "body": "<a id='comment:40'></a>Needs rebasing, and should work with #21682",
    "created_at": "2016-12-29T12:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316772",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>Needs rebasing, and should work with #21682



---

archive/issue_comments_316773.json:
```json
{
    "body": "<a id='comment:41'></a>You mean #22106?",
    "created_at": "2016-12-29T17:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316773",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>You mean #22106?



---

archive/issue_comments_316774.json:
```json
{
    "body": "<a id='comment:42'></a>Yes, I meant #22106.  Thanks for the catch.",
    "created_at": "2016-12-30T11:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316774",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'></a>Yes, I meant #22106.  Thanks for the catch.



---

archive/issue_comments_316775.json:
```json
{
    "body": "<a id='comment:43'></a>Ah, since #22106 is at least in \"positive review\" status I should rebase this on it.",
    "created_at": "2017-03-29T15:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316775",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>Ah, since #22106 is at least in "positive review" status I should rebase this on it.



---

archive/issue_comments_316776.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-29T15:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316776",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_316777.json:
```json
{
    "body": "<a id='comment:45'></a>Rebased this on top of the current branch for #22106, which should be good to merge it looks like.\n\nOther than the rebasing I don't think this needed any additional work.",
    "created_at": "2017-03-29T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316777",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'></a>Rebased this on top of the current branch for #22106, which should be good to merge it looks like.

Other than the rebasing I don't think this needed any additional work.



---

archive/issue_comments_316778.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-29T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316778",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_316779.json:
```json
{
    "body": "<a id='comment:47'></a>Merged with `8.0.beta0`\n\n---\nNew commits:",
    "created_at": "2017-04-01T15:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316779",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Merged with `8.0.beta0`

---
New commits:



---

archive/issue_comments_316780.json:
```json
{
    "body": "<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-01T16:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316780",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_316781.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-01T16:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316781",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_316782.json:
```json
{
    "body": "<a id='comment:51'></a>Erik, I'm happy with this. If you like my changes, you can set this to positive_review.",
    "created_at": "2017-04-02T07:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316782",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>Erik, I'm happy with this. If you like my changes, you can set this to positive_review.



---

archive/issue_comments_316783.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-04-03T06:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316783",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_316784.json:
```json
{
    "body": "<a id='comment:52'></a>I'm happy with the last change except in the `sage_build_cython.initialize_options` it should also set `self.extensions = None`.  I know, it's a bit silly, but I like to stick to the convention on this. (The reason for this convention has to do with how distutils commands can set their options from options on other commands, i.e. `self.set_undefined_options`. No, it's not likely to be used this way here, but I do also like that documents what attributes *should* be set on the finalized command.)",
    "created_at": "2017-04-03T06:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316784",
    "user": "https://github.com/embray"
}
```

<a id='comment:52'></a>I'm happy with the last change except in the `sage_build_cython.initialize_options` it should also set `self.extensions = None`.  I know, it's a bit silly, but I like to stick to the convention on this. (The reason for this convention has to do with how distutils commands can set their options from options on other commands, i.e. `self.set_undefined_options`. No, it's not likely to be used this way here, but I do also like that documents what attributes *should* be set on the finalized command.)



---

archive/issue_comments_316785.json:
```json
{
    "body": "<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-03T08:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316785",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_316786.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-04-03T09:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316786",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_316787.json:
```json
{
    "body": "<a id='comment:55'></a>Thanks!",
    "created_at": "2017-04-03T09:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316787",
    "user": "https://github.com/embray"
}
```

<a id='comment:55'></a>Thanks!



---

archive/issue_events_057432.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-05T19:38:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21682#event-57432"
}
```



---

archive/issue_comments_316788.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-05T19:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21682#issuecomment-316788",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
