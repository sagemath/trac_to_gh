# Issue 21100: division error in normalize_coordinates

archive/issues_020863.json:
```json
{
    "body": "Note: This ticket is now superseded by #21108.\n\nWhen the gcd is a multivariate polynomial, it does not cancel upon scaling\n\n```\nR.<a,b>=QQ[]\nP.<x,y,z>=ProjectiveSpace(R,2)\nH=End(P)\nf=H([a*(x+y)*x^2,b*(x+y)*y^2,(x+y)*z^2])\nf.normalize_coordinates()\n```\n\nThis division can be done through maxima\n\nIssue created by migration from https://trac.sagemath.org/ticket/21100\n\n",
    "closed_at": "2016-08-30T13:32:25Z",
    "created_at": "2016-07-26T20:36:33Z",
    "labels": [
        "component: algebraic geometry",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "division error in normalize_coordinates",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21100",
    "user": "https://github.com/bhutz"
}
```
Note: This ticket is now superseded by #21108.

When the gcd is a multivariate polynomial, it does not cancel upon scaling

```
R.<a,b>=QQ[]
P.<x,y,z>=ProjectiveSpace(R,2)
H=End(P)
f=H([a*(x+y)*x^2,b*(x+y)*y^2,(x+y)*z^2])
f.normalize_coordinates()
```

This division can be done through maxima

Issue created by migration from https://trac.sagemath.org/ticket/21100





---

archive/issue_comments_288095.json:
```json
{
    "body": "This fixes the found bug. I haven't found any additional examples that we should be able to compute that we cannot. Searching for some additional difficult examples would be good.\n\n---\nNew commits:",
    "created_at": "2016-07-26T21:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288095",
    "user": "https://github.com/bhutz"
}
```

This fixes the found bug. I haven't found any additional examples that we should be able to compute that we cannot. Searching for some additional difficult examples would be good.

---
New commits:



---

archive/issue_comments_288096.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-26T21:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288096",
    "user": "https://github.com/bhutz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_288097.json:
```json
{
    "body": "I would prefer\n\n```\ndef normalize_coordinates(self, method=None):\n    if method is None:\n        # document why it is done this way\n        try:\n            self.normalize_coordinates(method='singular')\n        except (TypeError, NotImplementedError):\n            self.normalize_coordinates(method='maxima')\n    elif method == 'singular':\n        # do singular way\n    elif method == 'maxima':\n        # do maxima way\n    else:\n        raise ValueError(\"method={} not available\".format(method))\n```\nThis way you could have doctests for:\n- the singular failure reported in this doctest\n- comparison between maxima and singular versions\n\nBy the way, why do you catch both `TypeError` and `NotImplementedError`?\n\nDoes it work on last versions of singular?",
    "created_at": "2016-07-26T22:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288097",
    "user": "https://github.com/videlec"
}
```

I would prefer

```
def normalize_coordinates(self, method=None):
    if method is None:
        # document why it is done this way
        try:
            self.normalize_coordinates(method='singular')
        except (TypeError, NotImplementedError):
            self.normalize_coordinates(method='maxima')
    elif method == 'singular':
        # do singular way
    elif method == 'maxima':
        # do maxima way
    else:
        raise ValueError("method={} not available".format(method))
```
This way you could have doctests for:
- the singular failure reported in this doctest
- comparison between maxima and singular versions

By the way, why do you catch both `TypeError` and `NotImplementedError`?

Does it work on last versions of singular?



---

archive/issue_comments_288098.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-26T22:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288098",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_288099.json:
```json
{
    "body": "Yes, I see the logic in that. I can do it that way.\n\nerr...I'll need to check but the NotImplementedError may not occur in this case. That is a carry over from dynatomic_polynomial where a similar thing is done. I'll look into the 'method' approach for that function too so the singular failure can be tracked.\n\nas for the most recent version of singular. I'm not sure, this fails on sage 7.3.beta9 and whatever singular is in that. I don't have a stand-alone singular.",
    "created_at": "2016-07-27T01:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288099",
    "user": "https://github.com/bhutz"
}
```

Yes, I see the logic in that. I can do it that way.

err...I'll need to check but the NotImplementedError may not occur in this case. That is a carry over from dynatomic_polynomial where a similar thing is done. I'll look into the 'method' approach for that function too so the singular failure can be tracked.

as for the most recent version of singular. I'm not sure, this fails on sage 7.3.beta9 and whatever singular is in that. I don't have a stand-alone singular.



---

archive/issue_comments_288100.json:
```json
{
    "body": "We are far away in Sage. Singular 4.0.2 is available (see #17254 almost 2 years old ticket) and Sage ships 3.1.7.",
    "created_at": "2016-07-27T01:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288100",
    "user": "https://github.com/videlec"
}
```

We are far away in Sage. Singular 4.0.2 is available (see #17254 almost 2 years old ticket) and Sage ships 3.1.7.



---

archive/issue_comments_288101.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-27T01:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288102.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-27T01:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288102",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_288103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-27T01:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288103",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288104.json:
```json
{
    "body": "I did not see, but with what I proposed you might end up computing twice the GCD... don't know if it is a big problem.",
    "created_at": "2016-07-27T02:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288104",
    "user": "https://github.com/videlec"
}
```

I did not see, but with what I proposed you might end up computing twice the GCD... don't know if it is a big problem.



---

archive/issue_comments_288105.json:
```json
{
    "body": "actually three times!",
    "created_at": "2016-07-27T02:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288105",
    "user": "https://github.com/videlec"
}
```

actually three times!



---

archive/issue_comments_288106.json:
```json
{
    "body": "Another option seems to flatten the polynomial ring in order to make singular happier\n\n```\nsage: R.<a,b> = QQ[]\nsage: P.<x,y,z> = R[]\nsage: p0 = a*(x+y)*x^2\nsage: g = x + y\nsage: p0.quo_rem(g)\nTraceback (most recent call last):\n...\nTypeError: no conversion of this ring to a Singular ring defined\nsage: Pflat.<x,y,z,a,b> = QQ[]\nsage: p0 = Pflat(str(p0))   # conversion hack ;-)\nsage: g = Pflat(g)\nsage: p0.quo_rem(g)\n(x^2*a, 0)\n```",
    "created_at": "2016-07-27T02:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288106",
    "user": "https://github.com/videlec"
}
```

Another option seems to flatten the polynomial ring in order to make singular happier

```
sage: R.<a,b> = QQ[]
sage: P.<x,y,z> = R[]
sage: p0 = a*(x+y)*x^2
sage: g = x + y
sage: p0.quo_rem(g)
Traceback (most recent call last):
...
TypeError: no conversion of this ring to a Singular ring defined
sage: Pflat.<x,y,z,a,b> = QQ[]
sage: p0 = Pflat(str(p0))   # conversion hack ;-)
sage: g = Pflat(g)
sage: p0.quo_rem(g)
(x^2*a, 0)
```



---

archive/issue_comments_288107.json:
```json
{
    "body": "We can introduce a method to multivariate polynomial ring to build a \"flattening morphism\" like `QQ[a,b][x,y,z] -> QQ[a,b,x,y,z]` (as soon as variable names do not clash).",
    "created_at": "2016-07-27T02:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288107",
    "user": "https://github.com/videlec"
}
```

We can introduce a method to multivariate polynomial ring to build a "flattening morphism" like `QQ[a,b][x,y,z] -> QQ[a,b,x,y,z]` (as soon as variable names do not clash).



---

archive/issue_comments_288108.json:
```json
{
    "body": "Attachment [flatten.py](tarball://root/attachments/some-uuid/ticket21100/flatten.py) by @videlec created at 2016-07-27 03:04:56",
    "created_at": "2016-07-27T03:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288108",
    "user": "https://github.com/videlec"
}
```

Attachment [flatten.py](tarball://root/attachments/some-uuid/ticket21100/flatten.py) by @videlec created at 2016-07-27 03:04:56



---

archive/issue_comments_288109.json:
```json
{
    "body": "Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.\n\nI didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.\n\nDo you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?",
    "created_at": "2016-07-27T12:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288109",
    "user": "https://github.com/bhutz"
}
```

Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.

I didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.

Do you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?



---

archive/issue_comments_288110.json:
```json
{
    "body": "Replying to [comment:13 bhutz]:\n> Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.\n> \n> I didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.\n> \n> Do you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?\n\n\nI guess the flattening can be done in another ticket. Concerning this one, it can either wait for flattening or it can be closed and refactored later on. If you have time for working on it please go ahead.",
    "created_at": "2016-07-27T13:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288110",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:13 bhutz]:
> Yes, I wasn't very happy with computing the gcd multiple times, but it did track the issue and the gcd is faster than the actual division step, so it wasn't a big performance hit in what we were doing.
> 
> I didn't experiment with the flattening code, but that sounds promising. I think it would also be useful for specialization in families.
> 
> Do you want to add the flattening functionality to polynomial rings, or have me take your flatten.py and flesh it out?


I guess the flattening can be done in another ticket. Concerning this one, it can either wait for flattening or it can be closed and refactored later on. If you have time for working on it please go ahead.



---

archive/issue_comments_288111.json:
```json
{
    "body": "flattening is now #21106",
    "created_at": "2016-07-27T15:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288111",
    "user": "https://github.com/bhutz"
}
```

flattening is now #21106



---

archive/issue_comments_288112.json:
```json
{
    "body": "This ticket is now superseded by #21108.",
    "created_at": "2016-07-27T21:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288112",
    "user": "https://github.com/bhutz"
}
```

This ticket is now superseded by #21108.



---

archive/issue_comments_288113.json:
```json
{
    "body": "Not necessarily. In `dynatomic_polynomial` there are still problematic rings, namely\n- p-adic ring\n- fraction fields\nWill they appear in `normalize_coordinates`?",
    "created_at": "2016-07-27T22:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288113",
    "user": "https://github.com/videlec"
}
```

Not necessarily. In `dynatomic_polynomial` there are still problematic rings, namely
- p-adic ring
- fraction fields
Will they appear in `normalize_coordinates`?



---

archive/issue_comments_288114.json:
```json
{
    "body": "No, the further problematic rings treated in dynatomic don't have gcds, so it doesn't get that far.\n\nI do think some of the special casing in dynatomic can now also be removed. I was going to do that in a different ticket.",
    "created_at": "2016-07-27T22:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288114",
    "user": "https://github.com/bhutz"
}
```

No, the further problematic rings treated in dynatomic don't have gcds, so it doesn't get that far.

I do think some of the special casing in dynatomic can now also be removed. I was going to do that in a different ticket.



---

archive/issue_comments_288115.json:
```json
{
    "body": "in further testing, it looks like the _maxima_ still is needed in dynatomic_polynomial",
    "created_at": "2016-07-27T22:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288115",
    "user": "https://github.com/bhutz"
}
```

in further testing, it looks like the _maxima_ still is needed in dynatomic_polynomial



---

archive/issue_comments_288116.json:
```json
{
    "body": "What do you want to do with this one? If you want to close it you should change the milestone to `duplicate/won't fix`.",
    "created_at": "2016-07-28T12:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288116",
    "user": "https://github.com/videlec"
}
```

What do you want to do with this one? If you want to close it you should change the milestone to `duplicate/won't fix`.



---

archive/issue_events_056335.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2016-07-28T12:49:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21100#event-56335"
}
```



---

archive/issue_comments_288117.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-28T14:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288117",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_056336.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-30T13:32:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21100#event-56336"
}
```



---

archive/issue_comments_288118.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2016-08-30T13:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288118",
    "user": "https://github.com/embray"
}
```

Resolution: wontfix



---

archive/issue_comments_288119.json:
```json
{
    "body": "Determined to be invalid/duplicate/wontfix (closing as \"wontfix\" as a catch-all resolution).",
    "created_at": "2016-08-30T13:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21100",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21100#issuecomment-288119",
    "user": "https://github.com/embray"
}
```

Determined to be invalid/duplicate/wontfix (closing as "wontfix" as a catch-all resolution).
