# Issue 21398: Fix doctest failure in doctest.forker on Cygwin

archive/issues_021161.json:
```json
{
    "body": "Unfortunately this is one I don't fully understand.  At its core, this issue here is that on Windows (including Cygwin), the `tempfile.TemporaryFile` class is just an alias for `tempfile.NamedTemporaryFile`:  https://hg.python.org/cpython/file/2.7/Lib/tempfile.py#l484\n\nThis is a bit unfortunate because the two don't have fully compatible interfaces.  At any rate, a major difference between the two is that in `NamedTemporaryFile.close()` the file is deleted after the object is closed (this of course assumes the file isn't being deleted before the handle is closed).  This was leading, in these tests to `OSError` exceptions being printed to stderr, related to deleting a file that didn't already exist.  Because these exceptions were coming from a `__del__` the exception is not raised, but just printed.  This caused unpredictable test failures later on, due to the error messages being randomly inserted into test output.\n\nThe part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.  I couldn't find any place in our code that would explicitly delete them (not even `atexit` handlers).  Nor do I think the OS should be deleting them.  So that's a bit disconcerting.\n\nI found this one place where explicitly using a `with` statement to ensure that the file was closed as soon as it was done with did the trick.  There are probably other places that could be more explicit about cleanup, but after fixing this one spot I was not able to reproduce the problem again.\n\nCC:  @tscrim gouezel jpflori\n\nKeywords: windows cygwin doctest tempfile\n\nBranch/Commit: [d840c13a4aa860ac4fd8299e39c5de5f63cac348](https://github.com/sagemath/sagetrac-mirror/commit/d840c13a4aa860ac4fd8299e39c5de5f63cac348)\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21398\n\n",
    "closed_at": "2016-09-04T00:13:10Z",
    "created_at": "2016-09-02T14:12:31Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Fix doctest failure in doctest.forker on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21398",
    "user": "https://github.com/embray"
}
```
Unfortunately this is one I don't fully understand.  At its core, this issue here is that on Windows (including Cygwin), the `tempfile.TemporaryFile` class is just an alias for `tempfile.NamedTemporaryFile`:  https://hg.python.org/cpython/file/2.7/Lib/tempfile.py#l484

This is a bit unfortunate because the two don't have fully compatible interfaces.  At any rate, a major difference between the two is that in `NamedTemporaryFile.close()` the file is deleted after the object is closed (this of course assumes the file isn't being deleted before the handle is closed).  This was leading, in these tests to `OSError` exceptions being printed to stderr, related to deleting a file that didn't already exist.  Because these exceptions were coming from a `__del__` the exception is not raised, but just printed.  This caused unpredictable test failures later on, due to the error messages being randomly inserted into test output.

The part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.  I couldn't find any place in our code that would explicitly delete them (not even `atexit` handlers).  Nor do I think the OS should be deleting them.  So that's a bit disconcerting.

I found this one place where explicitly using a `with` statement to ensure that the file was closed as soon as it was done with did the trick.  There are probably other places that could be more explicit about cleanup, but after fixing this one spot I was not able to reproduce the problem again.

CC:  @tscrim gouezel jpflori

Keywords: windows cygwin doctest tempfile

Branch/Commit: [d840c13a4aa860ac4fd8299e39c5de5f63cac348](https://github.com/sagemath/sagetrac-mirror/commit/d840c13a4aa860ac4fd8299e39c5de5f63cac348)

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21398





---

archive/issue_comments_396305.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-02T14:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396305",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396306.json:
```json
{
    "body": "Reviewer: Jeroen Demeyer",
    "created_at": "2016-09-02T15:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396306",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: Jeroen Demeyer



---

archive/issue_comments_396307.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-02T15:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396307",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396308.json:
```json
{
    "body": "<a id='comment:3'></a>\nMakes sense regardless of Cygwin issues.",
    "created_at": "2016-09-02T15:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396308",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Makes sense regardless of Cygwin issues.



---

archive/issue_comments_396309.json:
```json
{
    "body": "Replying to [ticket:21398 embray]:\n> The part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.\n\n\nJust a guess: maybe it has to do with the fact that the doctester forks and that the file is deleted by each forked subprocess?",
    "created_at": "2016-09-02T15:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396309",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:21398 embray]:
> The part of this that's mysterious to me is that I don't know why the temp files were being deleted before they got closed.


Just a guess: maybe it has to do with the fact that the doctester forks and that the file is deleted by each forked subprocess?



---

archive/issue_comments_396310.json:
```json
{
    "body": "<a id='comment:5'></a>\nThat was what I figured, but I couldn't find anything that would actually delete that file.  It's just a random temp file in `/tmp`--the subprocesses wouldn't even know about it.  I suppose maybe if I ran an `strace` on it that *might* offer some hints, but it's not worth it now.",
    "created_at": "2016-09-02T18:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396310",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
That was what I figured, but I couldn't find anything that would actually delete that file.  It's just a random temp file in `/tmp`--the subprocesses wouldn't even know about it.  I suppose maybe if I ran an `strace` on it that *might* offer some hints, but it's not worth it now.



---

archive/issue_comments_396311.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-04T00:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396311",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064693.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-09-04T00:13:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21398#event-64693"
}
```



---

archive/issue_comments_396312.json:
```json
{
    "body": "Changing branch from \"[u/embray/doctest-forker-failure](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest-forker-failure)\" to \"[d840c13a4aa860ac4fd8299e39c5de5f63cac348](https://github.com/sagemath/sagetrac-mirror/commit/d840c13a4aa860ac4fd8299e39c5de5f63cac348)\"",
    "created_at": "2016-09-04T00:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21398",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21398#issuecomment-396312",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "[u/embray/doctest-forker-failure](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest-forker-failure)" to "[d840c13a4aa860ac4fd8299e39c5de5f63cac348](https://github.com/sagemath/sagetrac-mirror/commit/d840c13a4aa860ac4fd8299e39c5de5f63cac348)"
