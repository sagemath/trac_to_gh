# Issue 21064: Enable NTL's '-march=native' more cautiously

archive/issues_020827.json:
```json
{
    "body": "Take more care in passing `NATIVE=on` to NTL's `configure`.\n\nUpstream only checks whether *the compiler accepts the option*, nothing beyond that.\n\nThis causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with `-march=native`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficient to build Sage).\n\nWhile we could (and hopefully will) add more sophisticated checks regarding the assembler's capabilities (or use an alternate one, e.g. clang's/LLVM's on Darwin, cf. #20779), we need a quick (and safe) fix for Sage 7.3.\n\n\nAssignee: @nexttime\n\nCC:  @NathanDunfield @kiwifb\n\nKeywords: assembler shlx mulx\n\nBranch/Commit: 41ea5daf35f02a6e53bd62a08a423a472edbb2d4\n\nReviewer: Jeroen Demeyer, Volker Braun\n\nAuthor: Leif Leonhardy\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21064\n\n",
    "closed_at": "2016-07-27T20:24:50Z",
    "created_at": "2016-07-20T16:16:15Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Enable NTL's '-march=native' more cautiously",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21064",
    "user": "https://github.com/nexttime"
}
```
Take more care in passing `NATIVE=on` to NTL's `configure`.

Upstream only checks whether *the compiler accepts the option*, nothing beyond that.

This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with `-march=native`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficient to build Sage).

While we could (and hopefully will) add more sophisticated checks regarding the assembler's capabilities (or use an alternate one, e.g. clang's/LLVM's on Darwin, cf. #20779), we need a quick (and safe) fix for Sage 7.3.


Assignee: @nexttime

CC:  @NathanDunfield @kiwifb

Keywords: assembler shlx mulx

Branch/Commit: 41ea5daf35f02a6e53bd62a08a423a472edbb2d4

Reviewer: Jeroen Demeyer, Volker Braun

Author: Leif Leonhardy

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21064





---

archive/issue_comments_306203.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -2,9 +2,10 @@\n \n Upstream only checks whether *the compiler accepts the option*, nothing beyond that.\n \n-This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with \\`-march=native\\`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficent to build Sage).\n+This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with \\`-march=native\\`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficient to build Sage).\n \n While we could (and hopefully will) add more sophisticated checks regarding the assembler's capabilities (or use an alternate one, e.g. clang's/LLVM's on Darwin, cf. #20779), we need a quick (and safe) fix for Sage 7.3.\n+\n \n Work_Issues: push a branch :-)\n \n```\n",
    "created_at": "2016-07-20T16:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306203",
    "user": "https://github.com/nexttime"
}
```

Description changed:
```diff
--- 
+++ 
@@ -2,9 +2,10 @@
 
 Upstream only checks whether *the compiler accepts the option*, nothing beyond that.
 
-This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with \`-march=native\`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficent to build Sage).
+This causes problems if the assembler isn't recent enough to understand all of the instructions GCC emits with \`-march=native\`, e.g. on older versions of MacOS X (with an ancient GAS as the default assembler), or on older Linux distros where Sage's GCC got built because the native one is outdated (more precisely, not sufficient to build Sage).
 
 While we could (and hopefully will) add more sophisticated checks regarding the assembler's capabilities (or use an alternate one, e.g. clang's/LLVM's on Darwin, cf. #20779), we need a quick (and safe) fix for Sage 7.3.
+
 
 Work_Issues: push a branch :-)
 
```




---

archive/issue_comments_306204.json:
```json
{
    "body": "Set assignee to @nexttime.",
    "created_at": "2016-07-20T16:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306204",
    "user": "https://github.com/nexttime"
}
```

Set assignee to @nexttime.



---

archive/issue_comments_306205.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-20T23:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306205",
    "user": "https://github.com/nexttime"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_306206.json:
```json
{
    "body": "<a id='comment:3'></a>Here it is.\n\nFeel free to vote for the second commit; the third is less restrictive.\n\n---\nNew commits:",
    "created_at": "2016-07-20T23:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306206",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>Here it is.

Feel free to vote for the second commit; the third is less restrictive.

---
New commits:



---

archive/issue_comments_306207.json:
```json
{
    "body": "<a id='comment:4'></a>Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).\n\nBeing refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.",
    "created_at": "2016-07-21T00:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306207",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).

Being refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.



---

archive/issue_comments_306208.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 fbissey]:\n> Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).\n> \n> Being refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.\n\n\nYep, it became more lengthy than I first thought.  (Empathy with Apple fan boys is no good. ;-) )\n\nW.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.\n\nOn the other hand, I actually intended to add proper feature checks (for each \"non-standard\" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually *executing* instructions), because what CPUID reports isn't always correct (and hence GCC could be \"wrong\" as well), be it a crippled *and* flawed Intel chip, or a VM bug.",
    "created_at": "2016-07-21T00:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306208",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>Replying to [comment:4 fbissey]:
> Option 3 forced by brain to work and conduct some little checks on my machine. Option 3 is more complicated but more refined in its treatment of corner cases, and it is well documented (all options are documented well enough).
> 
> Being refined is always going to be more complicated. Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version? That would be even better in my opinion. But in the meantime. I'll vote for (3) against my better judgement about its complexity.


Yep, it became more lengthy than I first thought.  (Empathy with Apple fan boys is no good. ;-) )

W.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.

On the other hand, I actually intended to add proper feature checks (for each "non-standard" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually *executing* instructions), because what CPUID reports isn't always correct (and hence GCC could be "wrong" as well), be it a crippled *and* flawed Intel chip, or a VM bug.



---

archive/issue_comments_306209.json:
```json
{
    "body": "<a id='comment:6'></a>I tried out version (3) of this patch on OS X version 10.9 (which has the old `as`) and now NTL compiles fine.  So it looks good at my end.  \n\nOne very minor quibble with the OS X-specific comment in the spkg-install file:\n\n```\nTODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.\n```\n\nIt is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...",
    "created_at": "2016-07-21T02:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306209",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:6'></a>I tried out version (3) of this patch on OS X version 10.9 (which has the old `as`) and now NTL compiles fine.  So it looks good at my end.  

One very minor quibble with the OS X-specific comment in the spkg-install file:

```
TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.
```

It is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...



---

archive/issue_comments_306210.json:
```json
{
    "body": "<a id='comment:7'></a>That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.",
    "created_at": "2016-07-21T03:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306210",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.



---

archive/issue_comments_306211.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 dunfield]:\n> One very minor quibble with the OS X-specific comment in the spkg-install file:\n> \n> \n> ```\n> TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.\n> ```\n> \n> It is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...\n\n\nBetter this way?\n\n```diff\ndiff --git a/build/pkgs/ntl/spkg-install b/build/pkgs/ntl/spkg-install\nindex 0a35355..cb5ad4e 100755\n--- a/build/pkgs/ntl/spkg-install\n+++ b/build/pkgs/ntl/spkg-install\n@@ -109,8 +109,7 @@ ntl_configure()\n                 assembler_ok=true # perhaps until we upgrade Sage's GCC... ;-)\n                 ;;\n               1.38) # This is Apple's ancient version of GNU as.\n-                # TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which\n-                #       should work.\n+                # If we passed '-q', it would suddenly become LLVM's 'as'.\n                 ;;\n             esac\n         elif [ -n \"$LLVMAS_VERSION\" ]; then\n```\n\n(The [corresponding commit message](https://git.sagemath.org/sage.git/commit?id=7e1ceb270804b7525db553d35be29ccecc03206a) is more explicit.)",
    "created_at": "2016-07-21T03:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306211",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>Replying to [comment:6 dunfield]:
> One very minor quibble with the OS X-specific comment in the spkg-install file:
> 
> 
> ```
> TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which should work.
> ```
> 
> It is true that NTL will compile if you add `-q`, but I wouldn't recommend doing so just for NTL, only Sage as a whole; I've seen weird segfaults when I've tried mixing the two assemblers...


Better this way?

```diff
diff --git a/build/pkgs/ntl/spkg-install b/build/pkgs/ntl/spkg-install
index 0a35355..cb5ad4e 100755
--- a/build/pkgs/ntl/spkg-install
+++ b/build/pkgs/ntl/spkg-install
@@ -109,8 +109,7 @@ ntl_configure()
                 assembler_ok=true # perhaps until we upgrade Sage's GCC... ;-)
                 ;;
               1.38) # This is Apple's ancient version of GNU as.
-                # TODO: If we pass '-q', it suddenly becomes LLVM's 'as', which
-                #       should work.
+                # If we passed '-q', it would suddenly become LLVM's 'as'.
                 ;;
             esac
         elif [ -n "$LLVMAS_VERSION" ]; then
```

(The [corresponding commit message](https://git.sagemath.org/sage.git/commit?id=7e1ceb270804b7525db553d35be29ccecc03206a) is more explicit.)



---

archive/issue_comments_306212.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 fbissey]:\n> That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.\n\n\nI think (3) is still OK in this regard since it never changes the assembler, but just determines which will be used (and consequently whether we can expect it to work with the `-march=native` flag).",
    "created_at": "2016-07-21T03:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306212",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:9'></a>Replying to [comment:7 fbissey]:
> That's a good point and in that case it would be motivation for (2) where you don't touch the assembler.


I think (3) is still OK in this regard since it never changes the assembler, but just determines which will be used (and consequently whether we can expect it to work with the `-march=native` flag).



---

archive/issue_comments_306213.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 leif]:\n> Better this way?\n\n\nYes, that looks good to me.",
    "created_at": "2016-07-21T03:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306213",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:10'></a>Replying to [comment:8 leif]:
> Better this way?


Yes, that looks good to me.



---

archive/issue_comments_306214.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-21T03:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306214",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306215.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 dunfield]:\n> Replying to [comment:8 leif]:\n> > Better this way?\n\n> \n> Yes, that looks good to me.\n\n\nCommitted.",
    "created_at": "2016-07-21T03:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306215",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:12'></a>Replying to [comment:10 dunfield]:
> Replying to [comment:8 leif]:
> > Better this way?

> 
> Yes, that looks good to me.


Committed.



---

archive/issue_comments_306216.json:
```json
{
    "body": "<a id='comment:13'></a>That's a lot of complicated logic which looks quite fragile. Why not simply:\n\n1. Try to build normally.\n\n2. If that failed, retry without `-march=native`.",
    "created_at": "2016-07-21T16:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306216",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>That's a lot of complicated logic which looks quite fragile. Why not simply:

1. Try to build normally.

2. If that failed, retry without `-march=native`.



---

archive/issue_comments_306217.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:\n> That's a lot of complicated logic which looks quite fragile.\n\n\nIt's about 30 lines of code, 10 of them `echo`s.  And I fail to see where it's \"fragile\", as we don't do dangerous things here, just try to not lose performance without reason.\n\n\\\\\n\n> Why not simply:\n> \n> 1. Try to build normally.\n> \n> 2. If that failed, retry without `-march=native`.\n\n\nThat's nearly dumber than simply disabling `NATIVE`; if NTL took a few seconds (maybe minutes) to build, I'd perhaps agree.  And we cannot be sure it will fail *early*.\n\nImagine we'd do so for every package, probably trying more than one option.\n\nAs I said, in the long run, proper tests belong to NTL's `configure`, and the general problem on MacOS X will be solved on #20779.  I'd also appreciate if we had an (optional) binutils package for older Linux distros, otherwise we should perhaps stop building our own GCC (on those at least).",
    "created_at": "2016-07-21T19:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306217",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:
> That's a lot of complicated logic which looks quite fragile.


It's about 30 lines of code, 10 of them `echo`s.  And I fail to see where it's "fragile", as we don't do dangerous things here, just try to not lose performance without reason.

\\

> Why not simply:
> 
> 1. Try to build normally.
> 
> 2. If that failed, retry without `-march=native`.


That's nearly dumber than simply disabling `NATIVE`; if NTL took a few seconds (maybe minutes) to build, I'd perhaps agree.  And we cannot be sure it will fail *early*.

Imagine we'd do so for every package, probably trying more than one option.

As I said, in the long run, proper tests belong to NTL's `configure`, and the general problem on MacOS X will be solved on #20779.  I'd also appreciate if we had an (optional) binutils package for older Linux distros, otherwise we should perhaps stop building our own GCC (on those at least).



---

archive/issue_comments_306218.json:
```json
{
    "body": "<a id='comment:15'></a>P.S.:  If we solve the toolchain problems (partially caused by Apple, but also by *us*), we should IMHO by default build everything with `-march=native`, unless `SAGE_FAT_BINARY=yes`.",
    "created_at": "2016-07-21T19:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306218",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>P.S.:  If we solve the toolchain problems (partially caused by Apple, but also by *us*), we should IMHO by default build everything with `-march=native`, unless `SAGE_FAT_BINARY=yes`.



---

archive/issue_comments_306219.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 leif]:\n> And I fail to see where it's \"fragile\"\n\n\nThe part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22. But even if you fix that, you still have to \"parse\" the output of `as --version` correctly.",
    "created_at": "2016-07-22T07:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306219",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:14 leif]:
> And I fail to see where it's "fragile"


The part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22. But even if you fix that, you still have to "parse" the output of `as --version` correctly.



---

archive/issue_comments_306220.json:
```json
{
    "body": "<a id='comment:17'></a>Can you remove this pointless code:\n\n```\n              1.38) # This is Apple's ancient version of GNU as.\n                # If we passed '-q', it would suddenly become LLVM's 'as'.\n                ;;\n```",
    "created_at": "2016-07-22T07:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Can you remove this pointless code:

```
              1.38) # This is Apple's ancient version of GNU as.
                # If we passed '-q', it would suddenly become LLVM's 'as'.
                ;;
```



---

archive/issue_comments_306221.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-22T09:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306222.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:16 jdemeyer]:\n> Replying to [comment:14 leif]:\n> > And I fail to see where it's \"fragile\"\n\n> \n> The part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22.\n\n\nShow me a system where GAS 2.3 is used (and Sage at least partially builds)...\n\n(Fixed that though.)\n\n\\\\\n\n> But even if you fix that, you still have to \"parse\" the output of `as --version` correctly.\n\n\nIf it contains `LLVM`, it's LLVM's `as`, certainly not GAS at least, and completely sufficient *here*.\n\nIf you instead meant to refer to `as -v`,\n\n```sh\n        GAS_VERSION=$( ${AS:-as} -v </dev/null -o /dev/null 2>&1 \\\n            | sed  -n '/GNU assembler/s/^.* \\([12]\\.[^ ][^ ]*\\).*$/\\1/p' )\n```\nworks for all versions I encountered in this context (namely, Sage).  This is `spkg-install`, not `configure.ac`.  (Note that GAS doesn't support anything like `-dumpversion`, and distro packagers mess up what vanilla GAS gives.)\n\n\\\\\n\nAnd, again repeating myself, I'm not going to mess with Darwin and Xcode versions here, that belongs elsewhere.  (You may have noticed that I do not even check whether we're on Darwin if GAS is 1.38 or LLVM's assembler is present, because that's far beyond what we need here.  This ticket works around a fall-out of other bugs in Sage:  Not properly checking / requiring Xcode versions, and installing a GCC which may not fit, hence break, the other parts of the toolchain -- that's why I'm voting for offering an adequate binutils Sage package.)",
    "created_at": "2016-07-22T09:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306222",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:19'></a>Replying to [comment:16 jdemeyer]:
> Replying to [comment:14 leif]:
> > And I fail to see where it's "fragile"

> 
> The part where you are checking version numbers in strings. This `2.2[2-9]*|2.3*)` for example is a very wrong way to test for a version number >= 2.22.


Show me a system where GAS 2.3 is used (and Sage at least partially builds)...

(Fixed that though.)

\\

> But even if you fix that, you still have to "parse" the output of `as --version` correctly.


If it contains `LLVM`, it's LLVM's `as`, certainly not GAS at least, and completely sufficient *here*.

If you instead meant to refer to `as -v`,

```sh
        GAS_VERSION=$( ${AS:-as} -v </dev/null -o /dev/null 2>&1 \
            | sed  -n '/GNU assembler/s/^.* \([12]\.[^ ][^ ]*\).*$/\1/p' )
```
works for all versions I encountered in this context (namely, Sage).  This is `spkg-install`, not `configure.ac`.  (Note that GAS doesn't support anything like `-dumpversion`, and distro packagers mess up what vanilla GAS gives.)

\\

And, again repeating myself, I'm not going to mess with Darwin and Xcode versions here, that belongs elsewhere.  (You may have noticed that I do not even check whether we're on Darwin if GAS is 1.38 or LLVM's assembler is present, because that's far beyond what we need here.  This ticket works around a fall-out of other bugs in Sage:  Not properly checking / requiring Xcode versions, and installing a GCC which may not fit, hence break, the other parts of the toolchain -- that's why I'm voting for offering an adequate binutils Sage package.)



---

archive/issue_comments_306223.json:
```json
{
    "body": "<a id='comment:20'></a>P.S.:  I'll probably write some script which converts `-march=native` in `*FLAGS` to `-march=native -mno-foo -mno-bar ...` as appropriate, but including (and regularly updating!) such somewhere in Sage is something for future tickets.  (We could do that, i.e., build `SAGE_NATIVE_*FLAGS`, in Sage's top-level `configure`, and again after having installed Sage's GCC and probably binutils.  But in general, `-march=native` *is supposed to work **without** additional hacks* on platforms where GCC supports that option.)",
    "created_at": "2016-07-22T10:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306223",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>P.S.:  I'll probably write some script which converts `-march=native` in `*FLAGS` to `-march=native -mno-foo -mno-bar ...` as appropriate, but including (and regularly updating!) such somewhere in Sage is something for future tickets.  (We could do that, i.e., build `SAGE_NATIVE_*FLAGS`, in Sage's top-level `configure`, and again after having installed Sage's GCC and probably binutils.  But in general, `-march=native` *is supposed to work **without** additional hacks* on platforms where GCC supports that option.)



---

archive/issue_comments_306224.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:5 leif]:\n> Replying to [comment:4 fbissey]:\n> > Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version?\n\n> W.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.\n> \n> On the other hand, I actually intended to add proper feature checks (for each \"non-standard\" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually *executing* instructions), because what CPUID reports isn't always correct (and hence GCC could be \"wrong\" as well), be it a crippled *and* flawed Intel chip, or a VM bug.\n\n\nLooking deeper into NTL's configure process (I haven't done for a while), there's certainly room for improvements, i.e., changes we could submit upstream in the long run.\n\nWhile there are tests for AVX, AVX2 and `__builtin_clzl()` actually running test code (implicitly testing the toolchain), the test program (which gets compiled *and* linked, but currently not run) for `CXXAUTOFLAGS` (which include `-march=native` if `NATIVE=on`) is the following:\n\n```C\nint main() { return 0; }\n```\nI think it's *unlikely* that GCC will generate code containing *any* ISA extension instructions for this, so the assembler won't complain there (and the program -- as is -- is likely to run without errors on *any* machine with the same [generic] architecture, not only on those with the specific one GCC *thinks* is the native).",
    "created_at": "2016-07-23T14:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306224",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:21'></a>Replying to [comment:5 leif]:
> Replying to [comment:4 fbissey]:
> > Anyone has contacted Victor to see if he could make a check that would also test the assembler in a new version?

> W.r.t. upstream, thinking more about it I came to the conclusion that it's pretty ok to assume that the parts of the toolchain fit, and for an ordinary user manually running NTL's `configure` it's easy to just pass `NATIVE=off` if something doesn't work.
> 
> On the other hand, I actually intended to add proper feature checks (for each "non-standard" ISA extension enabled by `-march=native`, which of course is a moving target), probably also with some runtime checks (actually *executing* instructions), because what CPUID reports isn't always correct (and hence GCC could be "wrong" as well), be it a crippled *and* flawed Intel chip, or a VM bug.


Looking deeper into NTL's configure process (I haven't done for a while), there's certainly room for improvements, i.e., changes we could submit upstream in the long run.

While there are tests for AVX, AVX2 and `__builtin_clzl()` actually running test code (implicitly testing the toolchain), the test program (which gets compiled *and* linked, but currently not run) for `CXXAUTOFLAGS` (which include `-march=native` if `NATIVE=on`) is the following:

```C
int main() { return 0; }
```
I think it's *unlikely* that GCC will generate code containing *any* ISA extension instructions for this, so the assembler won't complain there (and the program -- as is -- is likely to run without errors on *any* machine with the same [generic] architecture, not only on those with the specific one GCC *thinks* is the native).



---

archive/issue_comments_306225.json:
```json
{
    "body": "<a id='comment:22'></a>Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.",
    "created_at": "2016-07-25T20:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306225",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.



---

archive/issue_comments_306226.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-25T20:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306226",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306227.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 vbraun]:\n> Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.\n\n\nYep.  Unfortunately NTL doesn't have the usual `configure && make` structure; `configure` calls a Perl script which generates (and continually rewrites) a makefile (and indirectly config files) which is then again called (`make -f ...`) from the script to perform some tests.\n\nThe \"final\" makefile then first builds kind of another configure chain and runs that before building the library; there, some tests simply happen \"too late\" (as building the tools may already fail).\n\n(This is similar to a shell script which first tests features of the shell it is run with, but, when run with the wrong shell, already bails out with a syntax error when performing the tests supposed to avoid exactly that.)\n\nSo it's not easy to submit anything useful / acceptable upstream (without completely rewriting the above, or being too specific and probably kind of redundant in just fixing our problem which is rather uncommon).",
    "created_at": "2016-07-25T23:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306227",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:23'></a>Replying to [comment:22 vbraun]:
> Fixing the configure tests would be the best solution, but for now we should probably ship this workaround.


Yep.  Unfortunately NTL doesn't have the usual `configure && make` structure; `configure` calls a Perl script which generates (and continually rewrites) a makefile (and indirectly config files) which is then again called (`make -f ...`) from the script to perform some tests.

The "final" makefile then first builds kind of another configure chain and runs that before building the library; there, some tests simply happen "too late" (as building the tools may already fail).

(This is similar to a shell script which first tests features of the shell it is run with, but, when run with the wrong shell, already bails out with a syntax error when performing the tests supposed to avoid exactly that.)

So it's not easy to submit anything useful / acceptable upstream (without completely rewriting the above, or being too specific and probably kind of redundant in just fixing our problem which is rather uncommon).



---

archive/issue_events_056274.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-27T20:24:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21064#event-56274"
}
```



---

archive/issue_comments_306228.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-27T20:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21064#issuecomment-306228",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
