# Issue 21509: Improve Cython debugging

archive/issues_021272.json:
```json
{
    "body": "1. Store `cython_debug` in `site-packages/sage/cython_debug` instead of in the Cython build directory.\n\n2. Upgrade cysignals:\n\n**Tarball**: https://pypi.python.org/packages/92/15/9ca4a50304fca8debaccac2e9b630626c13f4c91992ca5a86f52732bb983/cysignals-1.6.9.tar.gz#md5=d8155169fefb8ea9c036c2a8ee1495bd\n\nCC:  @kiwifb\n\nBranch/Commit: fa789c2793dda97129ad7c7839a636bf6be29c60\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21509\n\n",
    "closed_at": "2018-03-21T06:19:06Z",
    "created_at": "2016-09-16T22:17:37Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Improve Cython debugging",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21509",
    "user": "https://github.com/mkoeppe"
}
```
1. Store `cython_debug` in `site-packages/sage/cython_debug` instead of in the Cython build directory.

2. Upgrade cysignals:

**Tarball**: https://pypi.python.org/packages/92/15/9ca4a50304fca8debaccac2e9b630626c13f4c91992ca5a86f52732bb983/cysignals-1.6.9.tar.gz#md5=d8155169fefb8ea9c036c2a8ee1495bd

CC:  @kiwifb

Branch/Commit: fa789c2793dda97129ad7c7839a636bf6be29c60

Reviewer: Fran√ßois Bissey

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21509





---

archive/issue_events_057099.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-09-17T04:58:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21509#event-57099"
}
```



---

archive/issue_comments_294848.json:
```json
{
    "body": "<a id='comment:3'></a>Can you explain what 'cython_debug' is used for precisely, in the description? (Or point to a reference?)",
    "created_at": "2016-09-17T05:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294848",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Can you explain what 'cython_debug' is used for precisely, in the description? (Or point to a reference?)



---

archive/issue_comments_294849.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 mkoeppe]:\n> Can you explain what 'cython_debug' is used for precisely, in the description? (Or point to a reference?)\n\n\nIt is used by https://github.com/sagemath/cysignals/blob/master/src/scripts/cysignals-CSI-helper.py#L43",
    "created_at": "2016-09-29T15:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294849",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Replying to [comment:3 mkoeppe]:
> Can you explain what 'cython_debug' is used for precisely, in the description? (Or point to a reference?)


It is used by https://github.com/sagemath/cysignals/blob/master/src/scripts/cysignals-CSI-helper.py#L43



---

archive/issue_comments_294850.json:
```json
{
    "body": "Replying to [ticket:21509 mkoeppe]:\n> fbissey [proposes](https://trac.sagemath.org/ticket/21480#comment:88) to install cython_debug somewhere in SAGE_LOCAL because it is needed for debugging at runtime.\n\n\nSee #21480#comment:127 where I question this proposal.",
    "created_at": "2016-09-29T15:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294850",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:21509 mkoeppe]:
> fbissey [proposes](https://trac.sagemath.org/ticket/21480#comment:88) to install cython_debug somewhere in SAGE_LOCAL because it is needed for debugging at runtime.


See #21480#comment:127 where I question this proposal.



---

archive/issue_comments_294851.json:
```json
{
    "body": "<a id='comment:10'></a>New commits:",
    "created_at": "2018-02-10T11:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294851",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>New commits:



---

archive/issue_events_057100.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-10T11:51:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21509#event-57100"
}
```



---

archive/issue_events_057101.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-10T11:51:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21509#event-57101"
}
```



---

archive/issue_comments_294852.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-10T12:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294852",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_294853.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-10T12:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294853",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_294854.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-18T22:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294854",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_294855.json:
```json
{
    "body": "<a id='comment:15'></a>Let's make some progress here. It needs to go to the bots now.",
    "created_at": "2018-02-18T22:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294855",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>Let's make some progress here. It needs to go to the bots now.



---

archive/issue_comments_294856.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-20T23:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294856",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_294857.json:
```json
{
    "body": "<a id='comment:16'></a>Tests fail on OSX\n\n```\n[cysignals-1.6.7] Successfully installed cysignals-1.6.7\n[cysignals-1.6.7] Cleaning up...\n[cysignals-1.6.7] python -B rundoctests.py src/cysignals/*.pyx\n[cysignals-1.6.7] cd example && python setup.py clean build\n[cysignals-1.6.7] sigaltstack: Cannot allocate memory\n[cysignals-1.6.7] Doctesting 5 files.\n[cysignals-1.6.7] make[3]: *** [check-doctest] Error 1\n[cysignals-1.6.7] Compiling cysignals_example.pyx because it changed.\n[cysignals-1.6.7] [1/1] Cythonizing cysignals_example.pyx\n[cysignals-1.6.7] running clean\n[cysignals-1.6.7] running build\n[cysignals-1.6.7] running build_ext\n[cysignals-1.6.7] building 'cysignals_example' extension\n[cysignals-1.6.7] creating build\n[cysignals-1.6.7] creating build/temp.macosx-10.9-x86_64-2.7\n[cysignals-1.6.7] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c cysignals_example.cpp -o build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o\n[cysignals-1.6.7] creating build/lib.macosx-10.9-x86_64-2.7\n[cysignals-1.6.7] g++ -bundle -undefined dynamic_lookup -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o -L/Users/buildslave-sage/slave/sage_git/build/local/lib -o build/lib.macosx-10.9-x86_64-2.7/cysignals_example.so -lpari\n[cysignals-1.6.7] make[3]: Target `check-install' not remade because of errors.\n[cysignals-1.6.7] \n[cysignals-1.6.7] real\t0m9.707s\n[cysignals-1.6.7] user\t0m8.247s\n[cysignals-1.6.7] sys\t0m1.497s\n[cysignals-1.6.7] ************************************************************************\n[cysignals-1.6.7] Error testing package cysignals-1.6.7\n[cysignals-1.6.7] ************************************************************************\n```",
    "created_at": "2018-02-20T23:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294857",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Tests fail on OSX

```
[cysignals-1.6.7] Successfully installed cysignals-1.6.7
[cysignals-1.6.7] Cleaning up...
[cysignals-1.6.7] python -B rundoctests.py src/cysignals/*.pyx
[cysignals-1.6.7] cd example && python setup.py clean build
[cysignals-1.6.7] sigaltstack: Cannot allocate memory
[cysignals-1.6.7] Doctesting 5 files.
[cysignals-1.6.7] make[3]: *** [check-doctest] Error 1
[cysignals-1.6.7] Compiling cysignals_example.pyx because it changed.
[cysignals-1.6.7] [1/1] Cythonizing cysignals_example.pyx
[cysignals-1.6.7] running clean
[cysignals-1.6.7] running build
[cysignals-1.6.7] running build_ext
[cysignals-1.6.7] building 'cysignals_example' extension
[cysignals-1.6.7] creating build
[cysignals-1.6.7] creating build/temp.macosx-10.9-x86_64-2.7
[cysignals-1.6.7] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c cysignals_example.cpp -o build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o
[cysignals-1.6.7] creating build/lib.macosx-10.9-x86_64-2.7
[cysignals-1.6.7] g++ -bundle -undefined dynamic_lookup -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib build/temp.macosx-10.9-x86_64-2.7/cysignals_example.o -L/Users/buildslave-sage/slave/sage_git/build/local/lib -o build/lib.macosx-10.9-x86_64-2.7/cysignals_example.so -lpari
[cysignals-1.6.7] make[3]: Target `check-install' not remade because of errors.
[cysignals-1.6.7] 
[cysignals-1.6.7] real	0m9.707s
[cysignals-1.6.7] user	0m8.247s
[cysignals-1.6.7] sys	0m1.497s
[cysignals-1.6.7] ************************************************************************
[cysignals-1.6.7] Error testing package cysignals-1.6.7
[cysignals-1.6.7] ************************************************************************
```



---

archive/issue_comments_294858.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 vbraun]:\n> Tests fail on OSX\n> \n> ```\n> [cysignals-1.6.7] sigaltstack: Cannot allocate memory\n> ```\n\n\nThat's really strange...",
    "created_at": "2018-02-21T06:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294858",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:16 vbraun]:
> Tests fail on OSX
> 
> ```
> [cysignals-1.6.7] sigaltstack: Cannot allocate memory
> ```


That's really strange...



---

archive/issue_comments_294859.json:
```json
{
    "body": "<a id='comment:18'></a>I see, OS X requires a minimum stack size of 2<sup>15</sup> bytes compared to 2<sup>11</sup> on Linux and I'm using a hardcoded value of 2<sup>14</sup>.",
    "created_at": "2018-02-21T06:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294859",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>I see, OS X requires a minimum stack size of 2<sup>15</sup> bytes compared to 2<sup>11</sup> on Linux and I'm using a hardcoded value of 2<sup>14</sup>.



---

archive/issue_comments_294860.json:
```json
{
    "body": "<a id='comment:19'></a>Fixing the stack size is easy but it's not the only problem. The stack overflow test raises `SIGILL` for some reason...",
    "created_at": "2018-02-22T13:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294860",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Fixing the stack size is easy but it's not the only problem. The stack overflow test raises `SIGILL` for some reason...



---

archive/issue_comments_294861.json:
```json
{
    "body": "<a id='comment:20'></a>Strange... it seems that `test_stack_overflow()` works in the main process but not in a forked child process. Why should that even matter?",
    "created_at": "2018-02-22T14:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294861",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Strange... it seems that `test_stack_overflow()` works in the main process but not in a forked child process. Why should that even matter?



---

archive/issue_comments_294862.json:
```json
{
    "body": "<a id='comment:21'></a>As far as I can tell, this is an OS X bug... `sigaltstack` doesn't survive after a `fork`. It's as if `sigaltstack` was never run.",
    "created_at": "2018-02-22T14:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294862",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>As far as I can tell, this is an OS X bug... `sigaltstack` doesn't survive after a `fork`. It's as if `sigaltstack` was never run.



---

archive/issue_comments_294863.json:
```json
{
    "body": "<a id='comment:22'></a>Ugh... even after working around that, there are still problems with `sigaltstack`. Once it's on the alt stack, it is stuck running there somehow.",
    "created_at": "2018-02-22T15:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294863",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Ugh... even after working around that, there are still problems with `sigaltstack`. Once it's on the alt stack, it is stuck running there somehow.



---

archive/issue_comments_294864.json:
```json
{
    "body": "<a id='comment:23'></a>Why is OS X implementing `sigaltstack` so differently? This even works on Solaris...",
    "created_at": "2018-02-22T16:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294864",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Why is OS X implementing `sigaltstack` so differently? This even works on Solaris...



---

archive/issue_comments_294865.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-08T11:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_294866.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-03-08T11:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294866",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_294867.json:
```json
{
    "body": "<a id='comment:26'></a>Fixed cysignals on OS X.",
    "created_at": "2018-03-08T11:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294867",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Fixed cysignals on OS X.



---

archive/issue_comments_294868.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-03-13T14:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294868",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_294869.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-13T14:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_294870.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-03-13T14:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294870",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_294871.json:
```json
{
    "body": "<a id='comment:30'></a>New release of cysignals.",
    "created_at": "2018-03-13T14:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294871",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>New release of cysignals.



---

archive/issue_comments_294872.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-03-19T22:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294872",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_294873.json:
```json
{
    "body": "<a id='comment:31'></a>See #21509",
    "created_at": "2018-03-19T22:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294873",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>See #21509



---

archive/issue_comments_294874.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-03-19T22:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294874",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_057102.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-21T06:19:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21509#event-57102"
}
```



---

archive/issue_comments_294875.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-21T06:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21509#issuecomment-294875",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
