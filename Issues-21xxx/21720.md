# Issue 21720: Fix memory allocations in sparse_graph.pyx

archive/issues_021483.json:
```json
{
    "body": "1. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.\n\n2. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.\n\n**CC:**  @jm58660\n\n**Branch/Commit:** [5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)\n\n**Reviewer:** Marc Mezzarobba\n\n**Author:** Jeroen Demeyer\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21720\n\n",
    "closed_at": "2016-11-07T18:27:42Z",
    "created_at": "2016-10-18T09:07:23Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Fix memory allocations in sparse_graph.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21720",
    "user": "https://github.com/jdemeyer"
}
```
1. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.

2. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.

**CC:**  @jm58660

**Branch/Commit:** [5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)

**Reviewer:** Marc Mezzarobba

**Author:** Jeroen Demeyer

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/21720





---

archive/issue_comments_403604.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+A `malloc(n)` followed by a memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.\n``````\n",
    "created_at": "2016-10-18T09:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403604",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+A `malloc(n)` followed by a memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.
``````




---

archive/issue_comments_403605.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-A `malloc(n)` followed by a memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.\n+A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.\n``````\n",
    "created_at": "2016-10-18T09:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403605",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-A `malloc(n)` followed by a memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.
+A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.
``````




---

archive/issue_comments_403606.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.\n+1. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.\n+\n+2. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.\n``````\n",
    "created_at": "2016-10-18T10:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403606",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`. Also use checking allocation functions from `cysignals`.
+1. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.
+
+2. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.
``````




---

archive/issue_comments_403607.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx)",
    "created_at": "2016-10-18T10:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403607",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx)



---

archive/issue_comments_403608.json:
```json
{
    "body": "**Commit:** [5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)",
    "created_at": "2016-10-18T10:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403608",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)



---

archive/issue_comments_403609.json:
```json
{
    "body": "<a id='comment:5'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700\">5d1b42e</a></td><td><code>Fix memory allocations</code></td></tr></table>\n",
    "created_at": "2016-10-18T10:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403609",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700">5d1b42e</a></td><td><code>Fix memory allocations</code></td></tr></table>




---

archive/issue_comments_403610.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2016-10-18T10:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403610",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_events_065419.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "rename": {
        "from": "Fix some memory allocations in sparse_graph.pyx",
        "to": "Fix memory allocations in sparse_graph.pyx"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21720#event-65419"
}
```



---

archive/issue_comments_403611.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-1. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.\n+1. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.\n \n-2. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.\n+2. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.\n``````\n",
    "created_at": "2016-10-18T12:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403611",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-1. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.
+1. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.
 
-2. Use checking allocation functions from `cysignals` to avoid a crash when running out of memory.
+2. A `malloc(n)` followed by a `memset(..., 0, n)` should be a `calloc()`.
``````




---

archive/issue_comments_403612.json:
```json
{
    "body": "<a id='comment:8'></a>\nI don't know enough cython to review this, but at least it seems to work. With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`, with `2` the error message is `MemoryError: failed to allocate 1342177280 * 8 bytes`.",
    "created_at": "2016-10-18T13:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403612",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:8'></a>
I don't know enough cython to review this, but at least it seems to work. With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`, with `2` the error message is `MemoryError: failed to allocate 1342177280 * 8 bytes`.



---

archive/issue_comments_403613.json:
```json
{
    "body": "<a id='comment:9'></a>\nBtw, is there same problem for example in `src/sage/combinat/degree_sequences.pyx`\n\n```\n    sig_on()\n    seq = <unsigned char *> sig_malloc((n+1)*sizeof(unsigned char))\n    memset(seq,0,(n+1)*sizeof(unsigned char))\n    sig_off()\n```\n\n?",
    "created_at": "2016-10-18T14:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403613",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:9'></a>
Btw, is there same problem for example in `src/sage/combinat/degree_sequences.pyx`

```
    sig_on()
    seq = <unsigned char *> sig_malloc((n+1)*sizeof(unsigned char))
    memset(seq,0,(n+1)*sizeof(unsigned char))
    sig_off()
```

?



---

archive/issue_comments_403614.json:
```json
{
    "body": "<a id='comment:10'></a>\nI can't fix all problems in Sage...",
    "created_at": "2016-10-18T14:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403614",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
I can't fix all problems in Sage...



---

archive/issue_comments_403615.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [jdemeyer](#comment%3A10):\n> I can't fix all problems in Sage...\n\n\nI know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?",
    "created_at": "2016-10-18T14:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403615",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:11'></a>
Replying to [jdemeyer](#comment%3A10):
> I can't fix all problems in Sage...


I know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?



---

archive/issue_comments_403616.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [jmantysalo](#comment%3A11):\n> Replying to [jdemeyer](#comment%3A10):\n> > I can't fix all problems in Sage...\n\n> \n> I know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?\n\n\nTo be honest... unless you plan to fix it yourself, there is probably not much point.",
    "created_at": "2016-10-18T14:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403616",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [jmantysalo](#comment%3A11):
> Replying to [jdemeyer](#comment%3A10):
> > I can't fix all problems in Sage...

> 
> I know... But will it help someone if I open a ticket and search other uses of unnecessay `memset`?


To be honest... unless you plan to fix it yourself, there is probably not much point.



---

archive/issue_comments_403617.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [jmantysalo](#comment%3A8):\n> With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`\n\n\nWhat is \"it\" in the sentence above?",
    "created_at": "2016-10-18T15:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403617",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [jmantysalo](#comment%3A8):
> With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`


What is "it" in the sentence above?



---

archive/issue_comments_403618.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A13):\n> Replying to [jmantysalo](#comment%3A8):\n> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`\n\n> \n> What is \"it\" in the sentence above?\n\n\nError message.",
    "created_at": "2016-10-18T15:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403618",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A13):
> Replying to [jmantysalo](#comment%3A8):
> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`

> 
> What is "it" in the sentence above?


Error message.



---

archive/issue_comments_403619.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jmantysalo](#comment%3A14):\n> Replying to [jdemeyer](#comment%3A13):\n> > Replying to [jmantysalo](#comment%3A8):\n> > > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`\n\n> > \n> > What is \"it\" in the sentence above?\n\n> \n> Error message.\n\n\nThe error message when doing *what*?",
    "created_at": "2016-10-18T15:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403619",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [jmantysalo](#comment%3A14):
> Replying to [jdemeyer](#comment%3A13):
> > Replying to [jmantysalo](#comment%3A8):
> > > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`

> > 
> > What is "it" in the sentence above?

> 
> Error message.


The error message when doing *what*?



---

archive/issue_comments_403620.json:
```json
{
    "body": "<a id='comment:16'></a>\nUh, sorry. I tested `Graph(10^10)`, but wrote that only in sage-devel, not here.",
    "created_at": "2016-10-18T15:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403620",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:16'></a>
Uh, sorry. I tested `Graph(10^10)`, but wrote that only in sage-devel, not here.



---

archive/issue_comments_403621.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A13):\n> Replying to [jmantysalo](#comment%3A8):\n> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`\n\n\nBy the way, this number shows that some integer overflow is happening also (a different issue from this ticket).\n\nThe number 18446744072098938880 equals `<size_t><int>(10 << 28)` where the correct value would be just `<size_t>(10 << 28)` = 2684354560.",
    "created_at": "2016-10-18T20:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403621",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A13):
> Replying to [jmantysalo](#comment%3A8):
> > With `/proc/sys/vm/overcommit_memory` as `0` or `1` it ends with `MemoryError: failed to allocate 18446744072098938880 * 8 bytes`


By the way, this number shows that some integer overflow is happening also (a different issue from this ticket).

The number 18446744072098938880 equals `<size_t><int>(10 << 28)` where the correct value would be just `<size_t>(10 << 28)` = 2684354560.



---

archive/issue_comments_403622.json:
```json
{
    "body": "<a id='comment:18'></a>\nPlease review...",
    "created_at": "2016-11-02T11:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403622",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Please review...



---

archive/issue_comments_403623.json:
```json
{
    "body": "**Reviewer:** Marc Mezzarobba",
    "created_at": "2016-11-02T12:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403623",
    "user": "https://github.com/mezzarobba"
}
```

**Reviewer:** Marc Mezzarobba



---

archive/issue_comments_403624.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2016-11-02T12:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403624",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_403625.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2016-11-07T18:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403625",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_065420.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-07T18:27:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21720#event-65420"
}
```



---

archive/issue_comments_403626.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx)\" to \"[5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)\".",
    "created_at": "2016-11-07T18:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21720#issuecomment-403626",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_some_memory_allocations_in_sparse_graph_pyx)" to "[5d1b42ec9d101f45af7ea1fa77dab3d1784fa700](https://github.com/sagemath/sagetrac-mirror/commit/5d1b42ec9d101f45af7ea1fa77dab3d1784fa700)".
