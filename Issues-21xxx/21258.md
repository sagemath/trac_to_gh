# Issue 21258: Random failure in trace.py

archive/issues_021021.json:
```json
{
    "assignees": [],
    "body": "Reported by Emmanuel Charpentier, Daniel Krenn, Steven Trogdon in [the sage-release discussion about Sage 7.4.beta1](https://groups.google.com/d/topic/sage-release/MhAwPVWfK28/discussion).\n\n```\nsage -t --long src/sage/misc/trace.py\n**********************************************************************\nFile \"src/sage/misc/trace.py\", line 66, in sage.misc.trace.trace\nFailed example:\n    print(s.before[s.before.find('--'):])\nExpected:\n    --...\n    ipdb> c\n    2 * 5\nGot:\n    --Return--\n\n    None\n\n    > /home/buildbot/slave/sage_git/build/build/bdist.linux-x86_64/egg/prompt_toolkit/terminal/vt\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage.misc.trace.trace\n```\n\nNote: [previous discussions of trace.py on sage-release](https://groups.google.com/forum/#!searchin/sage-release/trace.py%7Csort:date).\n\nCC:  @sagetrac-tmonteil @jdemeyer @slel\n\nKeywords: **random_fail**\n\nBranch/Commit: **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**\n\nReviewer: **Thierry Monteil**\n\nAuthor: **Volker Braun**\n\nComponent: **misc**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21258_\n\n",
    "closed_at": "2017-05-21T21:52:01Z",
    "created_at": "2016-08-17T06:42:57Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Random failure in trace.py",
    "type": "issue",
    "updated_at": "2017-05-21T21:52:01Z",
    "url": "https://github.com/sagemath/sage/issues/21258",
    "user": "https://github.com/vbraun"
}
```
Reported by Emmanuel Charpentier, Daniel Krenn, Steven Trogdon in [the sage-release discussion about Sage 7.4.beta1](https://groups.google.com/d/topic/sage-release/MhAwPVWfK28/discussion).

```
sage -t --long src/sage/misc/trace.py
**********************************************************************
File "src/sage/misc/trace.py", line 66, in sage.misc.trace.trace
Failed example:
    print(s.before[s.before.find('--'):])
Expected:
    --...
    ipdb> c
    2 * 5
Got:
    --Return--

    None

    > /home/buildbot/slave/sage_git/build/build/bdist.linux-x86_64/egg/prompt_toolkit/terminal/vt
**********************************************************************
1 item had failures:
   1 of  10 in sage.misc.trace.trace
```

Note: [previous discussions of trace.py on sage-release](https://groups.google.com/forum/#!searchin/sage-release/trace.py%7Csort:date).

CC:  @sagetrac-tmonteil @jdemeyer @slel

Keywords: **random_fail**

Branch/Commit: **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**

Reviewer: **Thierry Monteil**

Author: **Volker Braun**

Component: **misc**

_Issue created by migration from https://trac.sagemath.org/ticket/21258_





---

archive/issue_events_298905.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-17T06:42:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298905"
}
```



---

archive/issue_events_298906.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-17T06:42:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298906"
}
```



---

archive/issue_events_298907.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-17T06:42:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298907"
}
```



---

archive/issue_comments_310762.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI got the same error (within a VM).",
    "created_at": "2016-08-20T13:49:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310762",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:1" align="right">comment:1</div>

I got the same error (within a VM).



---

archive/issue_comments_310763.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNote that in my case, the failure does not appear randomly, but at each test.",
    "created_at": "2016-08-21T00:15:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310763",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:2" align="right">comment:2</div>

Note that in my case, the failure does not appear randomly, but at each test.



---

archive/issue_comments_310764.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nA few additional remarks:\n\n- Changing the `TERM` variable (`vt100`, `linux`, `screen`, `''`, ...) has no effect.\n- When i reninstall `prompt_toolkit`, the doctest pass once. Then further tests fail.\n- The directory mentionned in the failed doctest (`$SAGE_ROOT/build/build/bdist.linux-${ARCH}/egg/prompt_toolkit/terminal/vt`) does not exist.",
    "created_at": "2016-08-21T10:12:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310764",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:3" align="right">comment:3</div>

A few additional remarks:

- Changing the `TERM` variable (`vt100`, `linux`, `screen`, `''`, ...) has no effect.
- When i reninstall `prompt_toolkit`, the doctest pass once. Then further tests fail.
- The directory mentionned in the failed doctest (`$SAGE_ROOT/build/build/bdist.linux-${ARCH}/egg/prompt_toolkit/terminal/vt`) does not exist.



---

archive/issue_comments_310765.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nFurther investigation:\n\nif i remove the following `.pyc` files, the test pass again (only once, of course):\n\n```\n$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/core/completer.pyc\n$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc\n$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/lib/display.pyc\n```\n\nIf i run the culprit test in a `.sage` file, i only have to remove the first two files.",
    "created_at": "2016-08-21T11:38:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310765",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:4" align="right">comment:4</div>

Further investigation:

if i remove the following `.pyc` files, the test pass again (only once, of course):

```
$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/core/completer.pyc
$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc
$SAGE_ROOT/local/lib/python2.7/site-packages/IPython/lib/display.pyc
```

If i run the culprit test in a `.sage` file, i only have to remove the first two files.



---

archive/issue_comments_310766.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nVolker, on which kind of machine was the error found ? Was it within a VM ?",
    "created_at": "2016-08-21T12:03:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310766",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:5" align="right">comment:5</div>

Volker, on which kind of machine was the error found ? Was it within a VM ?



---

archive/issue_comments_310767.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nIts obviously the test before \n\n```\n        sage: _ = s.expect('100', timeout=90)                                                                                                           \n```\ntriggering at the ...egg/prompt_toolkit/terminal/vt**100** instead of the output of print(3+97)",
    "created_at": "2016-08-21T15:46:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310767",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

Its obviously the test before 

```
        sage: _ = s.expect('100', timeout=90)                                                                                                           
```
triggering at the ...egg/prompt_toolkit/terminal/vt**100** instead of the output of print(3+97)



---

archive/issue_comments_310768.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nCan you reproduce it with `SAGE_PEXPECT_LOG=yes` (log will be in ~/.sage/pexpect_logs)",
    "created_at": "2016-08-21T15:51:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310768",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

Can you reproduce it with `SAGE_PEXPECT_LOG=yes` (log will be in ~/.sage/pexpect_logs)



---

archive/issue_comments_310769.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nNothing appears in the `~/.sage/pexpect_logs` directory (even after starting with a fresh .sage directory).",
    "created_at": "2016-08-21T16:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310769",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:8" align="right">comment:8</div>

Nothing appears in the `~/.sage/pexpect_logs` directory (even after starting with a fresh .sage directory).



---

archive/issue_comments_310770.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIf i replace `3+97` with `3+98` and `s.expect('100', timeout=90)` with `s.expect('101', timeout=90)`, i got a `pexpect.exceptions.TIMEOUT: Timeout exceeded.`. But i guess that 90s is more than enough.\n\n\nIf it replace the last `expect` command with a `sleep(10)`, and if i print the whole `s`, i got:\n\n\n```\n<pexpect.pty_spawn.spawn object at 0x8c45258c>\ncommand: /opt/patchbot/sage-7.3/src/bin/sage\nargs: ['/opt/patchbot/sage-7.3/src/bin/sage']\nbuffer (last 100 chars): ' '\nbefore (last 100 chars): '/build/bdist.linux-i686/egg/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()\\r\\n\\r\\n'\nafter: 'ipdb>'\nmatch: <_sre.SRE_Match object at 0x8c4ca950>\nmatch_index: 0\nexitstatus: None\nflag_eof: False\npid: 21633\nchild_fd: 5\nclosed: False\ntimeout: 30\ndelimiter: <class 'pexpect.exceptions.EOF'>\nlogfile: None\nlogfile_read: None\nlogfile_send: None\nmaxread: 2000\nignorecase: False\nsearchwindowsize: None\ndelaybeforesend: 0.05\ndelayafterclose: 0.1\ndelayafterterminate: 0.1\n```\n\n\nIn the \"normal\" situation (i.e. after removing the `.pyc` files, and with the last `expect` command), the whole `s` is\n\n```\n<pexpect.pty_spawn.spawn object at 0x8c40268c>\ncommand: /opt/patchbot/sage-7.3/src/bin/sage\nargs: ['/opt/patchbot/sage-7.3/src/bin/sage']\nbuffer (last 100 chars): '\\r\\n'\nbefore (last 100 chars): ' \"\"\"\\r\\n   2321     Returns the factorization of ``n``.  The result depends on the\\r\\n\\r\\nipdb> c\\r\\n2 * 5\\r\\n'\nafter: '101'\nmatch: <_sre.SRE_Match object at 0x8c47a988>\nmatch_index: 0\nexitstatus: None\nflag_eof: False\npid: 21962\nchild_fd: 5\nclosed: False\ntimeout: 30\ndelimiter: <class 'pexpect.exceptions.EOF'>\nlogfile: None\nlogfile_read: None\nlogfile_send: None\nmaxread: 2000\nignorecase: False\nsearchwindowsize: None\ndelaybeforesend: 0.05\ndelayafterclose: 0.1\ndelayafterterminate: 0.1\n```",
    "created_at": "2016-08-21T16:29:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310770",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:9" align="right">comment:9</div>

If i replace `3+97` with `3+98` and `s.expect('100', timeout=90)` with `s.expect('101', timeout=90)`, i got a `pexpect.exceptions.TIMEOUT: Timeout exceeded.`. But i guess that 90s is more than enough.


If it replace the last `expect` command with a `sleep(10)`, and if i print the whole `s`, i got:


```
<pexpect.pty_spawn.spawn object at 0x8c45258c>
command: /opt/patchbot/sage-7.3/src/bin/sage
args: ['/opt/patchbot/sage-7.3/src/bin/sage']
buffer (last 100 chars): ' '
before (last 100 chars): '/build/bdist.linux-i686/egg/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()\r\n\r\n'
after: 'ipdb>'
match: <_sre.SRE_Match object at 0x8c4ca950>
match_index: 0
exitstatus: None
flag_eof: False
pid: 21633
child_fd: 5
closed: False
timeout: 30
delimiter: <class 'pexpect.exceptions.EOF'>
logfile: None
logfile_read: None
logfile_send: None
maxread: 2000
ignorecase: False
searchwindowsize: None
delaybeforesend: 0.05
delayafterclose: 0.1
delayafterterminate: 0.1
```


In the "normal" situation (i.e. after removing the `.pyc` files, and with the last `expect` command), the whole `s` is

```
<pexpect.pty_spawn.spawn object at 0x8c40268c>
command: /opt/patchbot/sage-7.3/src/bin/sage
args: ['/opt/patchbot/sage-7.3/src/bin/sage']
buffer (last 100 chars): '\r\n'
before (last 100 chars): ' """\r\n   2321     Returns the factorization of ``n``.  The result depends on the\r\n\r\nipdb> c\r\n2 * 5\r\n'
after: '101'
match: <_sre.SRE_Match object at 0x8c47a988>
match_index: 0
exitstatus: None
flag_eof: False
pid: 21962
child_fd: 5
closed: False
timeout: 30
delimiter: <class 'pexpect.exceptions.EOF'>
logfile: None
logfile_read: None
logfile_send: None
maxread: 2000
ignorecase: False
searchwindowsize: None
delaybeforesend: 0.05
delayafterclose: 0.1
delayafterterminate: 0.1
```



---

archive/issue_comments_310771.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nIn both cases there is trash in s.before that seems to come from a different process, the vt100 thing is just a symptom. E.g. the \"Returns the factorization of n\" part is from src/sage/arith/misc.py and not src/sage/misc/trace.py. The failing doctest is literally the first one in src/sage/misc/trace.py.\n\nIts as if pexpect does not flush stdout before forking, or something with STDOUT gets messed up. Jeroen, since you are the pexpect expert, any idea?",
    "created_at": "2016-08-21T16:55:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310771",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

In both cases there is trash in s.before that seems to come from a different process, the vt100 thing is just a symptom. E.g. the "Returns the factorization of n" part is from src/sage/arith/misc.py and not src/sage/misc/trace.py. The failing doctest is literally the first one in src/sage/misc/trace.py.

Its as if pexpect does not flush stdout before forking, or something with STDOUT gets messed up. Jeroen, since you are the pexpect expert, any idea?



---

archive/issue_comments_310772.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nNote that in the logs of [comment 9](#comment:9), i ran only the culprit doctest in a separate `./sage script.sage`, where script.sage is:\n\n```\nimport pexpect\ns = pexpect.spawn('sage')\n_ = s.sendline(\"trace('print(factor(10))'); print(3+98)\")\n_ = s.expect('ipdb>', timeout=90)\n_ = s.sendline(\"s\"); _ = s.sendline(\"c\")\n_ = s.expect('101', timeout=90)\n# print(s.before[s.before.find('--'):])\nprint(s)\n```",
    "created_at": "2016-08-21T17:45:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310772",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:11" align="right">comment:11</div>

Note that in the logs of [comment 9](#comment:9), i ran only the culprit doctest in a separate `./sage script.sage`, where script.sage is:

```
import pexpect
s = pexpect.spawn('sage')
_ = s.sendline("trace('print(factor(10))'); print(3+98)")
_ = s.expect('ipdb>', timeout=90)
_ = s.sendline("s"); _ = s.sendline("c")
_ = s.expect('101', timeout=90)
# print(s.before[s.before.find('--'):])
print(s)
```



---

archive/issue_comments_310773.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+Reported by Emmanuel Charpentier, Daniel Krenn, Steven Trogdon in [the sage-release discussion about Sage 7.4.beta1](https://groups.google.com/d/topic/sage-release/MhAwPVWfK28/discussion).\n \n ```\n sage -t --long src/sage/misc/trace.py\n@@ -19,3 +20,5 @@\n 1 item had failures:\n    1 of  10 in sage.misc.trace.trace\n ```\n+\n+Note: [previous discussions of trace.py on sage-release](https://groups.google.com/forum/#!searchin/sage-release/trace.py%7Csort:date).\n``````\n",
    "created_at": "2016-08-24T09:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310773",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
+Reported by Emmanuel Charpentier, Daniel Krenn, Steven Trogdon in [the sage-release discussion about Sage 7.4.beta1](https://groups.google.com/d/topic/sage-release/MhAwPVWfK28/discussion).
 
 ```
 sage -t --long src/sage/misc/trace.py
@@ -19,3 +20,5 @@
 1 item had failures:
    1 of  10 in sage.misc.trace.trace
 ```
+
+Note: [previous discussions of trace.py on sage-release](https://groups.google.com/forum/#!searchin/sage-release/trace.py%7Csort:date).
``````




---

archive/issue_comments_310774.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nExpand ticket description with link to sage-release discussion.",
    "created_at": "2016-08-24T09:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310774",
    "user": "https://github.com/slel"
}
```

<div id="comment:12" align="right">comment:12</div>

Expand ticket description with link to sage-release discussion.



---

archive/issue_comments_310775.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nHere the `trace.py` doctest passes if I make the change\n\n```\n@@ -53,7 +53,7 @@ def trace(code, preparse=True):\n \n         sage: import pexpect\n         sage: s = pexpect.spawn('sage')\n-        sage: _ = s.sendline(\"trace('print(factor(10))'); print(3+97)\")\n+        sage: _ = s.sendline(\"trace('print(factor(10))'); print(100)\")\n         sage: _ = s.expect('ipdb>', timeout=90)\n         sage: _ = s.sendline(\"s\"); _ = s.sendline(\"c\");\n         sage: _ = s.expect('100', timeout=90)\n```\nor is this cheating?",
    "created_at": "2016-08-25T00:34:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310775",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:13" align="right">comment:13</div>

Here the `trace.py` doctest passes if I make the change

```
@@ -53,7 +53,7 @@ def trace(code, preparse=True):
 
         sage: import pexpect
         sage: s = pexpect.spawn('sage')
-        sage: _ = s.sendline("trace('print(factor(10))'); print(3+97)")
+        sage: _ = s.sendline("trace('print(factor(10))'); print(100)")
         sage: _ = s.expect('ipdb>', timeout=90)
         sage: _ = s.sendline("s"); _ = s.sendline("c");
         sage: _ = s.expect('100', timeout=90)
```
or is this cheating?



---

archive/issue_comments_310776.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI should note that I have a sage-on-gentoo install and the `trace.py` doctest passes without modification. And I don't believe anything special is done with `pexpect`. And it is `pexpect-4.1.0` that's installed.",
    "created_at": "2016-08-25T01:06:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310776",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:14" align="right">comment:14</div>

I should note that I have a sage-on-gentoo install and the `trace.py` doctest passes without modification. And I don't believe anything special is done with `pexpect`. And it is `pexpect-4.1.0` that's installed.



---

archive/issue_comments_310777.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI think the test feeds in print(3+97) to avoid matching the \"100\" from the terminal echo.",
    "created_at": "2016-08-25T06:46:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310777",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:15" align="right">comment:15</div>

I think the test feeds in print(3+97) to avoid matching the "100" from the terminal echo.



---

archive/issue_comments_310778.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nCuriously, this does not now fail for me with `sage-7.4.beta2`.",
    "created_at": "2016-08-26T19:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310778",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:16" align="right">comment:16</div>

Curiously, this does not now fail for me with `sage-7.4.beta2`.



---

archive/issue_comments_310779.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nLet me relaunch my patchbot, it might pass now :P",
    "created_at": "2016-08-26T20:29:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310779",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:17" align="right">comment:17</div>

Let me relaunch my patchbot, it might pass now :P



---

archive/issue_comments_310780.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@vbraun](#comment:10):\n> Its as if pexpect does not flush stdout before forking, or something with STDOUT gets messed up. Jeroen, since you are the pexpect expert, any idea?\n\nI cannot reproduce the problem.",
    "created_at": "2016-08-27T19:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310780",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@vbraun](#comment:10):
> Its as if pexpect does not flush stdout before forking, or something with STDOUT gets messed up. Jeroen, since you are the pexpect expert, any idea?

I cannot reproduce the problem.



---

archive/issue_comments_310781.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nTo somebody who can reproduce the problem: what happens when you do the following in an interactive session:\n\n```\njdemeyer@tamiyo:/usr/local/src/sage-git$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 7.4.beta2, Release Date: 2016-08-26               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: trace('print(factor(10))'); print(3+97)\n> <string>(1)<module>()\n\nipdb> \n```\n\nNow type `s`:\n\n```\nipdb> s\n--Call--\n> /usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/arith/misc.py(2319)factor()\n   2317         return ZZ(n).trial_division(bound)\n   2318 \n-> 2319 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):\n   2320     \"\"\"\n   2321     Returns the factorization of ``n``.  The result depends on the\n\n```\n\nNow type `c`:\n\n```\nipdb> c\n2 * 5\n100\n```",
    "created_at": "2016-08-27T19:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310781",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

To somebody who can reproduce the problem: what happens when you do the following in an interactive session:

```
jdemeyer@tamiyo:/usr/local/src/sage-git$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.4.beta2, Release Date: 2016-08-26               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: trace('print(factor(10))'); print(3+97)
> <string>(1)<module>()

ipdb> 
```

Now type `s`:

```
ipdb> s
--Call--
> /usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/arith/misc.py(2319)factor()
   2317         return ZZ(n).trial_division(bound)
   2318 
-> 2319 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):
   2320     """
   2321     Returns the factorization of ``n``.  The result depends on the

```

Now type `c`:

```
ipdb> c
2 * 5
100
```



---

archive/issue_comments_310782.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@vbraun](#comment:10):\n> the vt100 thing is just a symptom\n\nI doubt that, I think it really is the cause. Something must print the `vt100` string and I wonder what does that.",
    "created_at": "2016-08-27T19:56:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310782",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@vbraun](#comment:10):
> the vt100 thing is just a symptom

I doubt that, I think it really is the cause. Something must print the `vt100` string and I wonder what does that.



---

archive/issue_comments_310783.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThats what I meant: The test failure is entirely accidental, the real problem is that there is unrelated stuff in the pexpect input.",
    "created_at": "2016-08-27T20:14:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310783",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:21" align="right">comment:21</div>

Thats what I meant: The test failure is entirely accidental, the real problem is that there is unrelated stuff in the pexpect input.



---

archive/issue_comments_310784.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@vbraun](#comment:21):\n> the real problem is that there is unrelated stuff in the pexpect input.\n\nBut not because of a `pexpect` problem. The strange input is real, the question is: where does it come from?",
    "created_at": "2016-08-27T20:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310784",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@vbraun](#comment:21):
> the real problem is that there is unrelated stuff in the pexpect input.

But not because of a `pexpect` problem. The strange input is real, the question is: where does it come from?



---

archive/issue_comments_310785.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nTests pass for me on `7.4.beta2`. Let me recompile for `7.4.beta1` to reproduce the thing.",
    "created_at": "2016-08-27T21:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310785",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:23" align="right">comment:23</div>

Tests pass for me on `7.4.beta2`. Let me recompile for `7.4.beta1` to reproduce the thing.



---

archive/issue_comments_310786.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nInteractively, i got nothing weird:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 7.4.beta1, Release Date: 2016-08-17               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: trace('print(factor(10))'); print(3+97)\n> <string>(1)<module>()\n\nipdb> s\n--Call--\n> /opt/patchbot/sage-7.3/local/lib/python2.7/site-packages/sage/arith/misc.py(2319)factor()\n   2317         return ZZ(n).trial_division(bound)\n   2318 \n-> 2319 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):\n   2320     \"\"\"\n   2321     Returns the factorization of ``n``.  The result depends on the\n\nipdb> c\n2 * 5\n100\n```\n\nSee my previous comments for behaviour within a sage script.",
    "created_at": "2016-08-28T00:42:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310786",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:24" align="right">comment:24</div>

Interactively, i got nothing weird:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.4.beta1, Release Date: 2016-08-17               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: trace('print(factor(10))'); print(3+97)
> <string>(1)<module>()

ipdb> s
--Call--
> /opt/patchbot/sage-7.3/local/lib/python2.7/site-packages/sage/arith/misc.py(2319)factor()
   2317         return ZZ(n).trial_division(bound)
   2318 
-> 2319 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):
   2320     """
   2321     Returns the factorization of ``n``.  The result depends on the

ipdb> c
2 * 5
100
```

See my previous comments for behaviour within a sage script.



---

archive/issue_comments_310787.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@sagetrac-tmonteil](#comment:24):\n> Interactively, i got nothing weird:\n> \n\nIf you still have your `7.4.beta1` could you try:\n\n```\nimport pexpect\ns = pexpect.spawn('sage')\n_ = s.sendline(\"trace('print(factor(10))'); print(3+97)\")\n_ = s.expect('ipdb>', timeout=90)\nprint(s.before)\n```\nfrom a `.sage` script? I don't have a `7.4.beta1` but with a sage-on-gentoo (7.4.beta2) if I run the script 20+ times successively I occasionally get this failure\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 7.4.beta2, Release Date: 2016-08-26               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\ntrace('print(factor(10))'); print(3+97)\nsage: trace('print(factor(10))'); print(3+97)\nGeneratorExit: None\n> /storage/strogdon/gentoo-rap/usr/lib64/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()\n    264             return None\n    265 \n--> 266     def _input_parser_generator(self):\n    267         \"\"\"\n    268         Coroutine (state machine) for the input parser.\n```\nwhich I believe `looks` like the failure I was getting in vanilla Sage, modulo the path to the indicated file. I don't know about the `GeneratorExit:`?",
    "created_at": "2016-08-29T02:20:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310787",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@sagetrac-tmonteil](#comment:24):
> Interactively, i got nothing weird:
> 

If you still have your `7.4.beta1` could you try:

```
import pexpect
s = pexpect.spawn('sage')
_ = s.sendline("trace('print(factor(10))'); print(3+97)")
_ = s.expect('ipdb>', timeout=90)
print(s.before)
```
from a `.sage` script? I don't have a `7.4.beta1` but with a sage-on-gentoo (7.4.beta2) if I run the script 20+ times successively I occasionally get this failure

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.4.beta2, Release Date: 2016-08-26               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
trace('print(factor(10))'); print(3+97)
sage: trace('print(factor(10))'); print(3+97)
GeneratorExit: None
> /storage/strogdon/gentoo-rap/usr/lib64/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()
    264             return None
    265 
--> 266     def _input_parser_generator(self):
    267         """
    268         Coroutine (state machine) for the input parser.
```
which I believe `looks` like the failure I was getting in vanilla Sage, modulo the path to the indicated file. I don't know about the `GeneratorExit:`?



---

archive/issue_comments_310788.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI've reverted my vanilla `7.4.beta2` to `7.4.beta1` and I seem to be unable to now get `trace.py` to fail. And it failed consistently when moving from `7.4.beta0` to `7.4.beta1`.",
    "created_at": "2016-08-29T19:15:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310788",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:26" align="right">comment:26</div>

I've reverted my vanilla `7.4.beta2` to `7.4.beta1` and I seem to be unable to now get `trace.py` to fail. And it failed consistently when moving from `7.4.beta0` to `7.4.beta1`.



---

archive/issue_comments_310789.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nWhen I add a log file `pexpect.spawn(..., logfile=...)` I get the following for a successful run, together with the 4+97=101 trick to avoid matching the vt100:\n\n```\ntrace('print(factor(10))'); print(4+97)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 7.6, Release Date: 2017-03-25                     \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\ntrace('print(factor(10))'); print(4+97)\nsage: ^[sage: trace('print(factor(10))'); print(4+97)\n> <string>(1)<module>()\n\nipdb> s\nc\ns\n--Call--\n> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/arith/misc.py(2281)factor()\n   2279         return ZZ(n).trial_division(bound)\n   2280 \n-> 2281 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):\n   2282     \"\"\"\n   2283     Returns the factorization of ``n``.  The result depends on the\n\nipdb> c\n2 * 5\n101\n```\nand this in the random error case:\n\n```\ntrace('print(factor(10))'); print(4+97)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 7.6, Release Date: 2017-03-25                     \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\ntrace('print(factor(10))'); print(4+97)\nsage: ^[sage: trace('print(factor(10))'); print(4+97)\nGeneratorExit: None\n> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()\n    264             return None\n    265 \n--> 266     def _input_parser_generator(self):\n    267         \"\"\"\n    268         Coroutine (state machine) for the input parser.\n\nipdb> s\nc\ns\n--Return--\nNone\n> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()\n    264             return None\n    265 \n--> 266     def _input_parser_generator(self):\n    267         \"\"\"\n    268         Coroutine (state machine) for the input parser.\n\nipdb> c\nu'\\n'\n```",
    "created_at": "2017-03-30T22:16:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310789",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:27" align="right">comment:27</div>

When I add a log file `pexpect.spawn(..., logfile=...)` I get the following for a successful run, together with the 4+97=101 trick to avoid matching the vt100:

```
trace('print(factor(10))'); print(4+97)
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.6, Release Date: 2017-03-25                     │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
trace('print(factor(10))'); print(4+97)
sage: ^[sage: trace('print(factor(10))'); print(4+97)
> <string>(1)<module>()

ipdb> s
c
s
--Call--
> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/arith/misc.py(2281)factor()
   2279         return ZZ(n).trial_division(bound)
   2280 
-> 2281 def factor(n, proof=None, int_=False, algorithm='pari', verbose=0, **kwds):
   2282     """
   2283     Returns the factorization of ``n``.  The result depends on the

ipdb> c
2 * 5
101
```
and this in the random error case:

```
trace('print(factor(10))'); print(4+97)
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.6, Release Date: 2017-03-25                     │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
trace('print(factor(10))'); print(4+97)
sage: ^[sage: trace('print(factor(10))'); print(4+97)
GeneratorExit: None
> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()
    264             return None
    265 
--> 266     def _input_parser_generator(self):
    267         """
    268         Coroutine (state machine) for the input parser.

ipdb> s
c
s
--Return--
None
> /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/prompt_toolkit/terminal/vt100_input.py(266)_input_parser_generator()
    264             return None
    265 
--> 266     def _input_parser_generator(self):
    267         """
    268         Coroutine (state machine) for the input parser.

ipdb> c
u'\n'
```



---

archive/issue_comments_310790.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThe GeneratorExit is part of the mechanism of a generator being garbage collected; Looks like ipdb accidentally catches that exception by lucky timing?",
    "created_at": "2017-03-30T22:33:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310790",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:28" align="right">comment:28</div>

The GeneratorExit is part of the mechanism of a generator being garbage collected; Looks like ipdb accidentally catches that exception by lucky timing?



---

archive/issue_comments_310791.json:
```json
{
    "body": "Branch: **[u/vbraun/random_failure_in_trace_py](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/random_failure_in_trace_py)**",
    "created_at": "2017-04-01T15:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310791",
    "user": "https://github.com/vbraun"
}
```

Branch: **[u/vbraun/random_failure_in_trace_py](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/random_failure_in_trace_py)**



---

archive/issue_events_298908.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-01T15:36:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298908"
}
```



---

archive/issue_events_298909.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-01T15:36:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298909"
}
```



---

archive/issue_comments_310792.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nSo the hypothesis is that the debugger can (though unlikely) jump into an internal GeneratorExit that is part of garbage collection. \n\nIn the attached patch I disabled garbage collection for the test, and I wasn't able to trigger the bug again. Either its fixed or timings changed so that I can't trigger it any more...\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b\">c1062b6</a></td><td><code>Disable garbage collection while testing ipdb</code></td></tr></table>\n",
    "created_at": "2017-04-01T15:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310792",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:30" align="right">comment:30</div>

So the hypothesis is that the debugger can (though unlikely) jump into an internal GeneratorExit that is part of garbage collection. 

In the attached patch I disabled garbage collection for the test, and I wasn't able to trigger the bug again. Either its fixed or timings changed so that I can't trigger it any more...

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b">c1062b6</a></td><td><code>Disable garbage collection while testing ipdb</code></td></tr></table>




---

archive/issue_comments_310793.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2017-04-01T15:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310793",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_events_298910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-01T15:36:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298910"
}
```



---

archive/issue_comments_310794.json:
```json
{
    "body": "Commit: **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**",
    "created_at": "2017-04-01T15:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310794",
    "user": "https://github.com/vbraun"
}
```

Commit: **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**



---

archive/issue_events_298911.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2017-04-14T16:26:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298911"
}
```



---

archive/issue_events_298912.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2017-04-14T16:26:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298912"
}
```



---

archive/issue_comments_310795.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nping",
    "created_at": "2017-05-20T22:33:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310795",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:32" align="right">comment:32</div>

ping



---

archive/issue_comments_310796.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@vbraun](#comment:32):\n> ping\n\nTrying the fix right now, compilation might take time.",
    "created_at": "2017-05-20T23:09:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310796",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@vbraun](#comment:32):
> ping

Trying the fix right now, compilation might take time.



---

archive/issue_comments_310797.json:
```json
{
    "body": "Reviewer: **Thierry Monteil**",
    "created_at": "2017-05-21T02:18:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310797",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Reviewer: **Thierry Monteil**



---

archive/issue_events_298913.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2017-05-21T02:18:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298913"
}
```



---

archive/issue_events_298914.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2017-05-21T02:18:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298914"
}
```



---

archive/issue_comments_310798.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nSame on my side: the issue disapeared both on this branch and on `8.0.beta7`. So, i am not sure whether the disabling of the garbage collection is of any help. Let it be like this.",
    "created_at": "2017-05-21T02:18:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310798",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:34" align="right">comment:34</div>

Same on my side: the issue disapeared both on this branch and on `8.0.beta7`. So, i am not sure whether the disabling of the garbage collection is of any help. Let it be like this.



---

archive/issue_events_298915.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-21T21:52:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298915"
}
```



---

archive/issue_events_298916.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "acddf4544e5b23c9e81c7403d8c5cc8580279cea",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-05-21T21:52:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21258#event-298916"
}
```



---

archive/issue_comments_310799.json:
```json
{
    "body": "Changed branch from **[u/vbraun/random_failure_in_trace_py](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/random_failure_in_trace_py)** to **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**",
    "created_at": "2017-05-21T21:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21258#issuecomment-310799",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/vbraun/random_failure_in_trace_py](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/random_failure_in_trace_py)** to **[`c1062b6`](https://github.com/sagemath/sagetrac-mirror/commit/c1062b631b529c2755abcce53924db472ee5360b)**
