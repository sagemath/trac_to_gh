# Issue 21991: Problems with RealLazyField

archive/issues_021754.json:
```json
{
    "body": "As I was working with quadratic fields I encountered #21979 that might have been caused by `RealLazyField` related problems. Namely\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: v = RLF(u)\nsage: v\n0.?e6\nsage: v.is_zero()\nFalse\nsage: RealIntervalField(128)(v)\n0\n```\n\nBranch/Commit: 13b8f3fa915439e5edbc2df077c22fc679b6593e\n\nReviewer: Vincent Delecroix\n\nAuthor: Marc Mezzarobba\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21991\n\n",
    "closed_at": "2021-07-23T20:11:37Z",
    "created_at": "2016-11-29T15:21:37Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Problems with RealLazyField",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21991",
    "user": "https://github.com/videlec"
}
```
As I was working with quadratic fields I encountered #21979 that might have been caused by `RealLazyField` related problems. Namely

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0
```

Branch/Commit: 13b8f3fa915439e5edbc2df077c22fc679b6593e

Reviewer: Vincent Delecroix

Author: Marc Mezzarobba

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21991





---

archive/issue_comments_406478.json:
```json
{
    "body": "<a id='comment:1'></a>\nI don't think the bug is in `RLF`:\n\n```\nsage: RealIntervalField(100)(u)\n0\nsage: RealIntervalField(100)(u).is_exact()\nTrue\n```",
    "created_at": "2016-12-02T13:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406478",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:1'></a>
I don't think the bug is in `RLF`:

```
sage: RealIntervalField(100)(u)
0
sage: RealIntervalField(100)(u).is_exact()
True
```



---

archive/issue_comments_406479.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [mmezzarobba](#comment%3A1):\n> I don't think the bug is in `RLF`:\n> \n> ```\n> sage: RealIntervalField(100)(u)\n> 0\n> sage: RealIntervalField(100)(u).is_exact()\n> True\n> ```\n\n\nI don't understand. This is fixed in #21979 mentioned in the description and which is merged in beta5\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: RealIntervalField(100)(u)\n0.?e-9\nsage: RealIntervalField(100)(u).is_exact()\nFalse\n```",
    "created_at": "2016-12-02T13:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406479",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>
Replying to [mmezzarobba](#comment%3A1):
> I don't think the bug is in `RLF`:
> 
> ```
> sage: RealIntervalField(100)(u)
> 0
> sage: RealIntervalField(100)(u).is_exact()
> True
> ```


I don't understand. This is fixed in #21979 mentioned in the description and which is merged in beta5

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: RealIntervalField(100)(u)
0.?e-9
sage: RealIntervalField(100)(u).is_exact()
False
```



---

archive/issue_comments_406480.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhoops, I tested with an older beta by accident. Sorry for the noise.",
    "created_at": "2016-12-02T13:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406480",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>
Whoops, I tested with an older beta by accident. Sorry for the noise.



---

archive/issue_comments_406481.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe attached patch fixes the problem reported in this ticket. However, the reason the conversion worked in some cases in spite of the misnamed conversion method: namely, that `RealIntervalFieldElement.__init__()` has a code path that attempts conversions to `RealField`s with directed rounding. This is sort-of-okay (and used in sage...) in the case of an \u201catomic\u201d floating-point evaluation (assuming the conversion code correctly takes the rounding mode into account), but certainly not in that of `RLF`, which calls the conversion recursively on the operands of a `LazyBinop`. I'd be tempted to remove this code path altogether. However, it is used elsewhere; besides, some code in Sage does seem to have been written with the idea that it is each parent's responsibility to ensure that its conversions to `RealField` with directed rounding return upper/lower bounds on the true value.\n\nSo I'm not sure what to do. An option might be to move all existing conversions to `RealField` that return rigorous bounds to separate methods (`_mpfr_upper_bound_()` and similar, say), and call these methods directly when we expect rigorous bounds...",
    "created_at": "2016-12-02T14:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406481",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:4'></a>
The attached patch fixes the problem reported in this ticket. However, the reason the conversion worked in some cases in spite of the misnamed conversion method: namely, that `RealIntervalFieldElement.__init__()` has a code path that attempts conversions to `RealField`s with directed rounding. This is sort-of-okay (and used in sage...) in the case of an “atomic” floating-point evaluation (assuming the conversion code correctly takes the rounding mode into account), but certainly not in that of `RLF`, which calls the conversion recursively on the operands of a `LazyBinop`. I'd be tempted to remove this code path altogether. However, it is used elsewhere; besides, some code in Sage does seem to have been written with the idea that it is each parent's responsibility to ensure that its conversions to `RealField` with directed rounding return upper/lower bounds on the true value.

So I'm not sure what to do. An option might be to move all existing conversions to `RealField` that return rigorous bounds to separate methods (`_mpfr_upper_bound_()` and similar, say), and call these methods directly when we expect rigorous bounds...



---

archive/issue_comments_406482.json:
```json
{
    "body": "Changing branch from \"\" to \"public/ticket/21991\"",
    "created_at": "2016-12-02T14:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406482",
    "user": "https://github.com/mezzarobba"
}
```

Changing branch from "" to "public/ticket/21991"



---

archive/issue_comments_406483.json:
```json
{
    "body": "Changing commit from \"\" to \"0ace29f89e243a7a557f8a47a5f3e69192f5e6d4\"",
    "created_at": "2016-12-02T14:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406483",
    "user": "https://github.com/mezzarobba"
}
```

Changing commit from "" to "0ace29f89e243a7a557f8a47a5f3e69192f5e6d4"



---

archive/issue_comments_406484.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|\n|[9c39994](https://git.sagemath.org/sage.git/commit/?id=9c399944c85ee53772d0cd375e31a49d56063442)|`#21991 incorrect conversion from RLF to real interval fieds`|",
    "created_at": "2016-12-02T14:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
|[9c39994](https://git.sagemath.org/sage.git/commit/?id=9c399944c85ee53772d0cd375e31a49d56063442)|`#21991 incorrect conversion from RLF to real interval fieds`|



---

archive/issue_comments_406485.json:
```json
{
    "body": "Changing commit from \"0ace29f89e243a7a557f8a47a5f3e69192f5e6d4\" to \"9c399944c85ee53772d0cd375e31a49d56063442\"",
    "created_at": "2016-12-02T14:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406485",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0ace29f89e243a7a557f8a47a5f3e69192f5e6d4" to "9c399944c85ee53772d0cd375e31a49d56063442"



---

archive/issue_comments_406486.json:
```json
{
    "body": "<a id='comment:6'></a>\nI am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense. Did you make a list of what break when removing these methods?\n\nGetting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).",
    "created_at": "2016-12-02T15:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406486",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense. Did you make a list of what break when removing these methods?

Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).



---

archive/issue_comments_406487.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [vdelecroix](#comment%3A6):\n> I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense.\n\n\nWhat do you mean?\n\n> Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).\n\n\nIt certainly would be possible to use them less (and also more efficiently), but it is also very convenient to have a unified way to represent constants that can be evaluated to arbitrary precision.",
    "created_at": "2016-12-02T15:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406487",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Replying to [vdelecroix](#comment%3A6):
> I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense.


What do you mean?

> Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).


It certainly would be possible to use them less (and also more efficiently), but it is also very convenient to have a unified way to represent constants that can be evaluated to arbitrary precision.



---

archive/issue_comments_406488.json:
```json
{
    "body": "<a id='comment:8'></a>\nIn SageMath 9.3.rc2:\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: v = RLF(u)\nsage: v\n0.?e6\nsage: v.is_zero()\nFalse\nsage: RealIntervalField(128)(v)\n0.?e-17\n```",
    "created_at": "2021-04-11T09:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406488",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>
In SageMath 9.3.rc2:

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0.?e-17
```



---

archive/issue_comments_406489.json:
```json
{
    "body": "Changing commit from \"9c399944c85ee53772d0cd375e31a49d56063442\" to \"13b8f3fa915439e5edbc2df077c22fc679b6593e\"",
    "created_at": "2021-04-11T12:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406489",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9c399944c85ee53772d0cd375e31a49d56063442" to "13b8f3fa915439e5edbc2df077c22fc679b6593e"



---

archive/issue_comments_406490.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[13b8f3f](https://git.sagemath.org/sage.git/commit/?id=13b8f3fa915439e5edbc2df077c22fc679b6593e)|`#21991 regression test for issue fixed in #24371`|",
    "created_at": "2021-04-11T12:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406490",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[13b8f3f](https://git.sagemath.org/sage.git/commit/?id=13b8f3fa915439e5edbc2df077c22fc679b6593e)|`#21991 regression test for issue fixed in #24371`|



---

archive/issue_comments_406491.json:
```json
{
    "body": "Changing author from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406491",
    "user": "https://github.com/mezzarobba"
}
```

Changing author from "" to "Marc Mezzarobba"



---

archive/issue_comments_406492.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406492",
    "user": "https://github.com/mezzarobba"
}
```

Changing priority from major to minor.



---

archive/issue_comments_406493.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks Samuel!",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406493",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:10'></a>
Thanks Samuel!



---

archive/issue_events_057927.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2021-04-11T12:35:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21991#event-57927"
}
```



---

archive/issue_comments_406494.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406494",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406495.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2021-04-11T12:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406495",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_406496.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-11T12:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406496",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406497.json:
```json
{
    "body": "<a id='comment:12'></a>\nPromoting the oldest 5 positively reviewed tickets to \"major\"",
    "created_at": "2021-07-19T20:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406497",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Promoting the oldest 5 positively reviewed tickets to "major"



---

archive/issue_comments_406498.json:
```json
{
    "body": "Changing branch from \"public/ticket/21991\" to \"13b8f3fa915439e5edbc2df077c22fc679b6593e\"",
    "created_at": "2021-07-23T20:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406498",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/ticket/21991" to "13b8f3fa915439e5edbc2df077c22fc679b6593e"



---

archive/issue_events_057928.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:11:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21991#event-57928"
}
```



---

archive/issue_comments_406499.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21991",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21991#issuecomment-406499",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
