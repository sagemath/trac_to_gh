# Issue 21535: Make src/setup.py respect --build-base and --inplace, independent of SAGE_CYTHONIZED

archive/issues_021298.json:
```json
{
    "body": "This is a follow-up on #21480, which put `src/setup.py` in charge of all `sagelib`building and removed dependencies on various environment variables, as a step towards the goal of making `sagelib` an ordinary Python package (#21507). \n\nHowever, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by `setup.py build --build-base`).\n\nThis dependency should be removed.\n\nAlso, `--inplace` should be supported.\n(See also: #12659: build the sage library in place)\n\nSee also #21508 on other cleanup issues of `src/setup.py`. \n\nDepends on #21480\n\nDepends on #21600\n\nDepends on #21604\n\nDepends on #23744\n\n**Assignee:** @embray\n\n**CC:**  @jdemeyer @embray\n\n**Branch/Commit:** [bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)\n\n**Reviewer:** Matthias Koeppe\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/21535\n\n",
    "closed_at": "2017-09-10T22:05:52Z",
    "created_at": "2016-09-18T20:17:39Z",
    "labels": [
        "component: build",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "title": "Make src/setup.py respect --build-base and --inplace, independent of SAGE_CYTHONIZED",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/21535",
    "user": "https://github.com/mkoeppe"
}
```
This is a follow-up on #21480, which put `src/setup.py` in charge of all `sagelib`building and removed dependencies on various environment variables, as a step towards the goal of making `sagelib` an ordinary Python package (#21507). 

However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by `setup.py build --build-base`).

This dependency should be removed.

Also, `--inplace` should be supported.
(See also: #12659: build the sage library in place)

See also #21508 on other cleanup issues of `src/setup.py`. 

Depends on #21480

Depends on #21600

Depends on #21604

Depends on #23744

**Assignee:** @embray

**CC:**  @jdemeyer @embray

**Branch/Commit:** [bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)

**Reviewer:** Matthias Koeppe

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/21535





---

archive/issue_comments_318591.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think I've brought this up with jdemeyer before, who had some objections (I think where I brought it up originally was in the context of cysignals, but same applies to sage itself).  Ultimately what it came down to is that he prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the \"edit-build-install\" cycle.\n\nIn any case, these are subjective preferences for development practice, and I think either way should work--eliminating dependency on `$SAGE_CYTHONIZED` should be a step in the right direction.",
    "created_at": "2016-09-22T15:18:50Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318591",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I think I've brought this up with jdemeyer before, who had some objections (I think where I brought it up originally was in the context of cysignals, but same applies to sage itself).  Ultimately what it came down to is that he prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the "edit-build-install" cycle.

In any case, these are subjective preferences for development practice, and I think either way should work--eliminating dependency on `$SAGE_CYTHONIZED` should be a step in the right direction.



---

archive/issue_comments_318592.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [embray](#comment%3A1):\n> Ultimately what it came down to is that `[`jdemeyer`]` prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and \n\n\nI also like to keep the source tree clean, which is why I usually use VPATH builds. I have created #21469 for that.\n\n> like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the \"edit-build-install\" cycle.\n\n\nThanks for pointing out `--inplace`. I'll look into this.",
    "created_at": "2016-09-22T17:05:34Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318592",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
Replying to [embray](#comment%3A1):
> Ultimately what it came down to is that `[`jdemeyer`]` prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and 


I also like to keep the source tree clean, which is why I usually use VPATH builds. I have created #21469 for that.

> like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the "edit-build-install" cycle.


Thanks for pointing out `--inplace`. I'll look into this.



---

archive/issue_comments_318593.json:
```json
{
    "body": "**Dependencies:** #21480, #21600, #21604",
    "created_at": "2016-10-11T18:20:51Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318593",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #21480, #21600, #21604



---

archive/issue_events_193002.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-10-11T18:20:51Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "rename": {
        "from": "Make src/setup.py independent of SAGE_CYTHONIZED",
        "to": "Make src/setup.py respect --build-base and --inplace, independent of SAGE_CYTHONIZED"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193002"
}
```



---

archive/issue_comments_318594.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,9 @@\n This is a follow-up on #21480, which put `src/setup.py` in charge of all `sagelib`building and removed dependencies on various environment variables, as a step towards the goal of making `sagelib` an ordinary Python package (#21507). \n \n-However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by setup.py build --build-base).\n+However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by `setup.py build --build-base`).\n \n This dependency should be removed.\n \n+Also, `--inplace` should be supported.\n+\n See also #21508 on other cleanup issues of `src/setup.py`. \n``````\n",
    "created_at": "2016-10-11T18:20:51Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318594",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,9 @@
 This is a follow-up on #21480, which put `src/setup.py` in charge of all `sagelib`building and removed dependencies on various environment variables, as a step towards the goal of making `sagelib` an ordinary Python package (#21507). 
 
-However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by setup.py build --build-base).
+However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by `setup.py build --build-base`).
 
 This dependency should be removed.
 
+Also, `--inplace` should be supported.
+
 See also #21508 on other cleanup issues of `src/setup.py`. 
``````




---

archive/issue_comments_318595.json:
```json
{
    "body": "<a id='comment:4'></a>\n#21682 might help with this one--it makes SAGE_CYTHONIZED mostly irrelevant IMO.",
    "created_at": "2016-10-12T08:44:37Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318595",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
#21682 might help with this one--it makes SAGE_CYTHONIZED mostly irrelevant IMO.



---

archive/issue_events_193003.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-10-30T18:16:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193003"
}
```



---

archive/issue_events_193004.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-10-30T18:16:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193004"
}
```



---

archive/issue_comments_318596.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,5 +5,6 @@\n This dependency should be removed.\n \n Also, `--inplace` should be supported.\n+(See also: #12659: build the sage library in place)\n \n See also #21508 on other cleanup issues of `src/setup.py`. \n``````\n",
    "created_at": "2016-10-30T18:16:13Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318596",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,5 +5,6 @@
 This dependency should be removed.
 
 Also, `--inplace` should be supported.
+(See also: #12659: build the sage library in place)
 
 See also #21508 on other cleanup issues of `src/setup.py`. 
``````




---

archive/issue_comments_318597.json:
```json
{
    "body": "<a id='comment:6'></a>\nI should be able to fix this with or without #21682, though I think it helps.",
    "created_at": "2016-11-07T13:27:48Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318597",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
I should be able to fix this with or without #21682, though I think it helps.



---

archive/issue_comments_318598.json:
```json
{
    "body": "**Assignee:** @embray",
    "created_at": "2016-11-07T13:27:48Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318598",
    "user": "https://github.com/embray"
}
```

**Assignee:** @embray



---

archive/issue_comments_318599.json:
```json
{
    "body": "<a id='comment:7'></a>\nWouldn't it be easier to fix with #21682, given that you are adding a `--build-dir` option?",
    "created_at": "2016-11-07T13:37:58Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318599",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Wouldn't it be easier to fix with #21682, given that you are adding a `--build-dir` option?



---

archive/issue_comments_318600.json:
```json
{
    "body": "<a id='comment:8'></a>\nYes, it would be easier.",
    "created_at": "2016-11-07T14:37:50Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318600",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Yes, it would be easier.



---

archive/issue_comments_318601.json:
```json
{
    "body": "<a id='comment:9'></a>\nSo what would be the impact of removing SAGE_CYTHONIZED entirely?  As far as I can tell it is only really used by setup.py/sage_setup.  Implementing this ticket makes it pretty pointless I think--it makes SAGE_CYTHONIZED not even make sense, really.\n\nWould it be a problem to outright remove it?  Or does it need to still be supported somehow?",
    "created_at": "2016-11-08T12:22:54Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318601",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
So what would be the impact of removing SAGE_CYTHONIZED entirely?  As far as I can tell it is only really used by setup.py/sage_setup.  Implementing this ticket makes it pretty pointless I think--it makes SAGE_CYTHONIZED not even make sense, really.

Would it be a problem to outright remove it?  Or does it need to still be supported somehow?



---

archive/issue_comments_318602.json:
```json
{
    "body": "<a id='comment:10'></a>\n+1 for getting rid of SAGE_CYTHONIZED completely if you can.",
    "created_at": "2016-11-08T12:28:25Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318602",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
+1 for getting rid of SAGE_CYTHONIZED completely if you can.



---

archive/issue_comments_318603.json:
```json
{
    "body": "<a id='comment:11'></a>\nErik and Jeroen, given that #21682 (`setup.py build_cython`) is merged, can we now get rid of `SAGE_CYTHONIZED` and support `setup.py build --build-base`?",
    "created_at": "2017-08-27T04:46:42Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318603",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Erik and Jeroen, given that #21682 (`setup.py build_cython`) is merged, can we now get rid of `SAGE_CYTHONIZED` and support `setup.py build --build-base`?



---

archive/issue_comments_318604.json:
```json
{
    "body": "<a id='comment:12'></a>\nI'd be all for that. Do you need me to work on it?",
    "created_at": "2017-08-29T10:36:27Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318604",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
I'd be all for that. Do you need me to work on it?



---

archive/issue_comments_318605.json:
```json
{
    "body": "**Changing dependencies** from \"#21480, #21600, #21604\" to \"#21480, #21600, #21604, #23744\".",
    "created_at": "2017-08-29T13:31:33Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318605",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#21480, #21600, #21604" to "#21480, #21600, #21604, #23744".



---

archive/issue_comments_318606.json:
```json
{
    "body": "<a id='comment:13'></a>\nAs a small first step, see #23744.",
    "created_at": "2017-08-29T13:31:33Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318606",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
As a small first step, see #23744.



---

archive/issue_comments_318607.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [embray](#comment%3A12):\n> I'd be all for that. Do you need me to work on it?\n\n\nThat would be great!\n\nBy the way, in my current attempt at #21469 I noticed that `--build-base` already works. \n\nThis line in `src/setup.py`:\n\n```\nbuild_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.\n```\nis probably a leftover from my earlier changes, and should probably be removed. The variable `build_base` does not seem to be used, and the comment is no longer correct.",
    "created_at": "2017-08-29T17:50:21Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318607",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
Replying to [embray](#comment%3A12):
> I'd be all for that. Do you need me to work on it?


That would be great!

By the way, in my current attempt at #21469 I noticed that `--build-base` already works. 

This line in `src/setup.py`:

```
build_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.
```
is probably a leftover from my earlier changes, and should probably be removed. The variable `build_base` does not seem to be used, and the comment is no longer correct.



---

archive/issue_comments_318608.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/no_SAGE_CYTHONIZED](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/no_SAGE_CYTHONIZED)",
    "created_at": "2017-09-01T12:18:27Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318608",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/no_SAGE_CYTHONIZED](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/no_SAGE_CYTHONIZED)



---

archive/issue_events_193005.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-01T12:23:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193005"
}
```



---

archive/issue_comments_318609.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2017-09-01T12:23:09Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318609",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_318610.json:
```json
{
    "body": "<a id='comment:16'></a>\nHere is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/33746a28f185fbabd69319ca3cde6a7316dff017\">33746a2</a></td><td><code>Don't use SAGE_CYTHONIZED in sage_include_directories()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c\">769de13</a></td><td><code>Stop using SAGE_CYTHONIZED</code></td></tr></table>\n",
    "created_at": "2017-09-01T12:23:09Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318610",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Here is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/33746a28f185fbabd69319ca3cde6a7316dff017">33746a2</a></td><td><code>Don't use SAGE_CYTHONIZED in sage_include_directories()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c">769de13</a></td><td><code>Stop using SAGE_CYTHONIZED</code></td></tr></table>




---

archive/issue_comments_318611.json:
```json
{
    "body": "**Commit:** [769de13efb2d23fcb511dc1987ab82204e15150c](https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c)",
    "created_at": "2017-09-01T12:23:09Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318611",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [769de13efb2d23fcb511dc1987ab82204e15150c](https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c)



---

archive/issue_events_193006.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-01T12:23:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193006"
}
```



---

archive/issue_events_193007.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-01T12:23:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193007"
}
```



---

archive/issue_comments_318612.json:
```json
{
    "body": "<a id='comment:17'></a>\nHmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.",
    "created_at": "2017-09-01T12:52:10Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318612",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
Hmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.



---

archive/issue_comments_318613.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A16):\n> Here is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.\n\n\nCommit 33746a2 is good, but I think some of the changes in 769de13 are not going in the right direction.\n\n1) In particular the following, I think, breaks the already working `--build-base` feature (see comment 14)!\n\n```diff\ndiff --git a/src/setup.py b/src/setup.py\nindex 6354427..be4036d 100755\n--- a/src/setup.py\n+++ b/src/setup.py\n@@ -52,12 +52,16 @@ sys.excepthook = excepthook\n \n build_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.\n \n+# Directory to store Cython-generated files\n+SAGE_CYTHONIZED = os.path.join(build_base, \"cythonized\")\n+\n```\n\n2) The hardcoded paths depending on SAGE_SRC make it harder for the VPATH patch. Perhaps it's best to do this work after VPATH (#21469) is done.",
    "created_at": "2017-09-01T15:40:19Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318613",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A16):
> Here is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.


Commit 33746a2 is good, but I think some of the changes in 769de13 are not going in the right direction.

1) In particular the following, I think, breaks the already working `--build-base` feature (see comment 14)!

```diff
diff --git a/src/setup.py b/src/setup.py
index 6354427..be4036d 100755
--- a/src/setup.py
+++ b/src/setup.py
@@ -52,12 +52,16 @@ sys.excepthook = excepthook
 
 build_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.
 
+# Directory to store Cython-generated files
+SAGE_CYTHONIZED = os.path.join(build_base, "cythonized")
+
```

2) The hardcoded paths depending on SAGE_SRC make it harder for the VPATH patch. Perhaps it's best to do this work after VPATH (#21469) is done.



---

archive/issue_comments_318614.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [embray](#comment%3A17):\n> Hmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.\n\n\nYes, I think this is a good idea. Basically this is part of #21707 (Split `sage-env` into `sage-build-env`, `sagelib-build-env` and `sage-env`) -- `setup.sh` should be responsible for writing out a configuration file concerning sagelib.",
    "created_at": "2017-09-01T15:47:12Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318614",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>
Replying to [embray](#comment%3A17):
> Hmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.


Yes, I think this is a good idea. Basically this is part of #21707 (Split `sage-env` into `sage-build-env`, `sagelib-build-env` and `sage-env`) -- `setup.sh` should be responsible for writing out a configuration file concerning sagelib.



---

archive/issue_events_193008.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-09-01T15:48:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193008"
}
```



---

archive/issue_events_193009.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-09-01T15:48:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193009"
}
```



---

archive/issue_comments_318615.json:
```json
{
    "body": "<a id='comment:21'></a>\nI see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.",
    "created_at": "2017-09-02T11:00:52Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318615",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.



---

archive/issue_comments_318616.json:
```json
{
    "body": "<a id='comment:22'></a>\nWorking on this...",
    "created_at": "2017-09-02T13:07:17Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318616",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Working on this...



---

archive/issue_comments_318617.json:
```json
{
    "body": "**Changing commit** from \"[769de13efb2d23fcb511dc1987ab82204e15150c](https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c)\" to \"[bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)\".",
    "created_at": "2017-09-02T15:06:15Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[769de13efb2d23fcb511dc1987ab82204e15150c](https://github.com/sagemath/sagetrac-mirror/commit/769de13efb2d23fcb511dc1987ab82204e15150c)" to "[bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)".



---

archive/issue_comments_318618.json:
```json
{
    "body": "<a id='comment:23'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9\">bd91b43</a></td><td><code>Stop using SAGE_CYTHONIZED</code></td></tr></table>\n",
    "created_at": "2017-09-02T15:06:15Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318618",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9">bd91b43</a></td><td><code>Stop using SAGE_CYTHONIZED</code></td></tr></table>




---

archive/issue_events_193010.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-02T15:11:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193010"
}
```



---

archive/issue_events_193011.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-02T15:11:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193011"
}
```



---

archive/issue_comments_318619.json:
```json
{
    "body": "<a id='comment:24'></a>\nThis should address the concerns about `build_base`. The doctests still hardcode `build/cythonized`, but I prefer to fix that in a different ticket. I think this branch here does enough good things (even if it's not perfect), so I'm setting it back to needs_review.",
    "created_at": "2017-09-02T15:11:18Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318619",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
This should address the concerns about `build_base`. The doctests still hardcode `build/cythonized`, but I prefer to fix that in a different ticket. I think this branch here does enough good things (even if it's not perfect), so I'm setting it back to needs_review.



---

archive/issue_comments_318620.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [jdemeyer](#comment%3A21):\n> I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.\n\n\nWell, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.",
    "created_at": "2017-09-02T21:31:12Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318620",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Replying to [jdemeyer](#comment%3A21):
> I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.


Well, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.



---

archive/issue_comments_318621.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [mkoeppe](#comment%3A25):\n> Replying to [jdemeyer](#comment%3A21):\n> > I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.\n\n> \n> Well, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.\n\n\nI'm not actively concerned about any of my existing open tickets addressing issues in the setup.py.  I'd like to get back to that at some point but if any of those tickets still end up being useful I'll rework them.",
    "created_at": "2017-09-05T09:19:23Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318621",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
Replying to [mkoeppe](#comment%3A25):
> Replying to [jdemeyer](#comment%3A21):
> > I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.

> 
> Well, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.


I'm not actively concerned about any of my existing open tickets addressing issues in the setup.py.  I'd like to get back to that at some point but if any of those tickets still end up being useful I'll rework them.



---

archive/issue_comments_318622.json:
```json
{
    "body": "<a id='comment:27'></a>\nHi Erik, there's no problem; to the contrary, as a result of these changes that are already merged, `--build-base` already works.",
    "created_at": "2017-09-05T20:48:43Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318622",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
Hi Erik, there's no problem; to the contrary, as a result of these changes that are already merged, `--build-base` already works.



---

archive/issue_comments_318623.json:
```json
{
    "body": "<a id='comment:28'></a>\nIndeed. What this ticket does is also use the `build_base` directory for the `cythonized` files.",
    "created_at": "2017-09-06T08:23:41Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318623",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Indeed. What this ticket does is also use the `build_base` directory for the `cythonized` files.



---

archive/issue_comments_318624.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2017-09-06T22:24:51Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318624",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_events_193012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-09-06T22:24:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193012"
}
```



---

archive/issue_events_193013.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-09-06T22:24:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193013"
}
```



---

archive/issue_comments_318625.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/no_SAGE_CYTHONIZED](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/no_SAGE_CYTHONIZED)\" to \"[bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)\".",
    "created_at": "2017-09-10T22:05:52Z",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21535#issuecomment-318625",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/no_SAGE_CYTHONIZED](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/no_SAGE_CYTHONIZED)" to "[bd91b438f6992c21ee4da35a850c81f28563d2e9](https://github.com/sagemath/sagetrac-mirror/commit/bd91b438f6992c21ee4da35a850c81f28563d2e9)".



---

archive/issue_events_193014.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-10T22:05:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193014"
}
```



---

archive/issue_events_193015.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-10T22:05:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21535",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21535#event-193015"
}
```
