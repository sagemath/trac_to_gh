# Issue 21726: Support splitting spkg install into `spkg-build` and `spkg-install` (for SAGE_SUDO)

archive/issues_021489.json:
```json
{
    "body": "Here's a new attempt toward #21537 that is perhaps more elegant.\n\nLet's change `build/bin/sage-spkg` as follows:\n\n- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)\n\n\nThe patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.\n\nBefore the patch:\n\n```\n$ rm -Rf local/share/4ti2\n$ mkdir local/share/4ti2\n$ sudo chown root local/share/4ti2\n$ ./sage -f 4ti2\n[...]\n[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied\n[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1\n[...]\n$ sudo chown root local/bin/ local/bin/lcalc\n$ ./sage -f lcalc \n[...]\n[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.\n[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied\n[...] \n```\n\nThen, after the patch:\n\n```\n$ export SAGE_SUDO=\"sudo -E\"\n$ ./sage -f 4ti2 lcalc  # succeeds\n```\n\nOther packages will be handled in follow-up tickets.\n\nSee also: \n- #21844: Update developer manual regarding spkg-build, spkg-install, SAGE_SUDO\n- Task ticket: #21537 \n\nCC:  @jdemeyer @kiwifb @embray @vbraun @dimpase @tscrim\n\nReviewer: Erik Bray\n\nAuthor: Matthias Koeppe\n\nBranch: 48053d0af7bef79e41a581aa492e58a285c9feb6\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21726\n\n",
    "closed_at": "2016-11-09T18:16:17Z",
    "created_at": "2016-10-19T01:25:18Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Support splitting spkg install into `spkg-build` and `spkg-install` (for SAGE_SUDO)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21726",
    "user": "https://github.com/mkoeppe"
}
```
Here's a new attempt toward #21537 that is perhaps more elegant.

Let's change `build/bin/sage-spkg` as follows:

- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)


The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.

Before the patch:

```
$ rm -Rf local/share/4ti2
$ mkdir local/share/4ti2
$ sudo chown root local/share/4ti2
$ ./sage -f 4ti2
[...]
[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied
[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1
[...]
$ sudo chown root local/bin/ local/bin/lcalc
$ ./sage -f lcalc 
[...]
[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.
[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied
[...] 
```

Then, after the patch:

```
$ export SAGE_SUDO="sudo -E"
$ ./sage -f 4ti2 lcalc  # succeeds
```

Other packages will be handled in follow-up tickets.

See also: 
- #21844: Update developer manual regarding spkg-build, spkg-install, SAGE_SUDO
- Task ticket: #21537 

CC:  @jdemeyer @kiwifb @embray @vbraun @dimpase @tscrim

Reviewer: Erik Bray

Author: Matthias Koeppe

Branch: 48053d0af7bef79e41a581aa492e58a285c9feb6

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21726





---

archive/issue_comments_400973.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,7 +3,9 @@\n Let's change `build/bin/sage-spkg` as follows:\n \n - If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n-- Otherwise, just call `spkg-install` (with $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)\n+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)\n+\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-10-19T01:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400973",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,7 +3,9 @@
 Let's change `build/bin/sage-spkg` as follows:
 
 - If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
-- Otherwise, just call `spkg-install` (with $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)
+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)
+
+
 
 Comment: 1
 
``````




---

archive/issue_comments_400974.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n+Here's a new attempt toward #21537 that is perhaps more elegant.\n+\n+Let's change `build/bin/sage-spkg` as follows:\n+\n+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2016-10-19T01:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400974",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,10 @@
+Here's a new attempt toward #21537 that is perhaps more elegant.
+
+Let's change `build/bin/sage-spkg` as follows:
+
+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)
+
 
 
 Comment: 1
``````




---

archive/issue_comments_400975.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/support_splitting_spkg_install_into__spkg_build__and__spkg_install___for_sage_sudo_\"",
    "created_at": "2016-10-19T03:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400975",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/support_splitting_spkg_install_into__spkg_build__and__spkg_install___for_sage_sudo_"



---

archive/issue_comments_400976.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400976",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_400977.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400977",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_400978.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+Here's a new attempt toward #21537 that is perhaps more elegant.\n \n+Let's change `build/bin/sage-spkg` as follows:\n+\n+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)\n+\n+\n+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.\n+\n+Before the patch:\n+\n+```\n+$ rm -Rf local/share/4ti2\n+$ mkdir local/share/4ti2\n+$ sudo chown root local/\n+$ ./sage -f 4ti2\n+[...]\n+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied\n+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1\n+[...]\n+$ sudo chown root local/bin/ local/bin/lcalc\n+$ ./sage -f lcalc \n+[...]\n+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.\n+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied\n+[...] \n+```\n+\n+Then, after the patch:\n+\n+```\n+$ export SAGE_SUDO=\"sudo -E\"\n+$ ./sage -f 4ti2 lcalc  # succeeds\n+```\n+\n+Other packages will be handled in follow-up tickets.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400978",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,40 @@
+Here's a new attempt toward #21537 that is perhaps more elegant.
 
+Let's change `build/bin/sage-spkg` as follows:
+
+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)
+
+
+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.
+
+Before the patch:
+
+```
+$ rm -Rf local/share/4ti2
+$ mkdir local/share/4ti2
+$ sudo chown root local/
+$ ./sage -f 4ti2
+[...]
+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied
+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1
+[...]
+$ sudo chown root local/bin/ local/bin/lcalc
+$ ./sage -f lcalc 
+[...]
+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.
+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied
+[...] 
+```
+
+Then, after the patch:
+
+```
+$ export SAGE_SUDO="sudo -E"
+$ ./sage -f 4ti2 lcalc  # succeeds
+```
+
+Other packages will be handled in follow-up tickets.
 
 Comment: 1
 
``````




---

archive/issue_comments_400979.json:
```json
{
    "body": "Changing commit from \"\" to \"48053d0af7bef79e41a581aa492e58a285c9feb6\"",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400979",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "48053d0af7bef79e41a581aa492e58a285c9feb6"



---

archive/issue_comments_400980.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400980",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_400981.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+Here's a new attempt toward #21537 that is perhaps more elegant.\n \n+Let's change `build/bin/sage-spkg` as follows:\n+\n+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)\n+\n+\n+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.\n+\n+Before the patch:\n+\n+```\n+$ rm -Rf local/share/4ti2\n+$ mkdir local/share/4ti2\n+$ sudo chown root local/share/4ti2\n+$ ./sage -f 4ti2\n+[...]\n+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied\n+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1\n+[...]\n+$ sudo chown root local/bin/ local/bin/lcalc\n+$ ./sage -f lcalc \n+[...]\n+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.\n+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied\n+[...] \n+```\n+\n+Then, after the patch:\n+\n+```\n+$ export SAGE_SUDO=\"sudo -E\"\n+$ ./sage -f 4ti2 lcalc  # succeeds\n+```\n+\n+Other packages will be handled in follow-up tickets.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-10-19T03:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400981",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,40 @@
+Here's a new attempt toward #21537 that is perhaps more elegant.
 
+Let's change `build/bin/sage-spkg` as follows:
+
+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)
+
+
+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.
+
+Before the patch:
+
+```
+$ rm -Rf local/share/4ti2
+$ mkdir local/share/4ti2
+$ sudo chown root local/share/4ti2
+$ ./sage -f 4ti2
+[...]
+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied
+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1
+[...]
+$ sudo chown root local/bin/ local/bin/lcalc
+$ ./sage -f lcalc 
+[...]
+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.
+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied
+[...] 
+```
+
+Then, after the patch:
+
+```
+$ export SAGE_SUDO="sudo -E"
+$ ./sage -f 4ti2 lcalc  # succeeds
+```
+
+Other packages will be handled in follow-up tickets.
 
 Comment: 1
 
``````




---

archive/issue_comments_400982.json:
```json
{
    "body": "<a id='comment:8'></a>So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be \"special\" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?",
    "created_at": "2016-11-07T11:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400982",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be "special" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?



---

archive/issue_comments_400983.json:
```json
{
    "body": "<a id='comment:9'></a>What is this about?\n\n```\n+    if [ ! -x spkg-build ]; then\n+\techo >&2 \"WARNING: spkg-build is not executable, making it executable\"\n+\tchmod +x spkg-build\n+    fi\n```\n\nWhy not just require it to be executable in the first place?",
    "created_at": "2016-11-07T11:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400983",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>What is this about?

```
+    if [ ! -x spkg-build ]; then
+	echo >&2 "WARNING: spkg-build is not executable, making it executable"
+	chmod +x spkg-build
+    fi
```

Why not just require it to be executable in the first place?



---

archive/issue_comments_400984.json:
```json
{
    "body": "<a id='comment:10'></a>LGTM otherwise.  This looks like what I had in mind in #21537.",
    "created_at": "2016-11-07T11:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400984",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>LGTM otherwise.  This looks like what I had in mind in #21537.



---

archive/issue_comments_400985.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 embray]:\n> So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be \"special\" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?\n\n\nThat's right.",
    "created_at": "2016-11-08T12:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400985",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Replying to [comment:8 embray]:
> So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be "special" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?


That's right.



---

archive/issue_comments_400986.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:9 embray]:\n> What is this about?\n> \n> \n> ```\n> +    if [ ! -x spkg-build ]; then\n> +\techo >&2 \"WARNING: spkg-build is not executable, making it executable\"\n> +\tchmod +x spkg-build\n> +    fi\n> ```\n> \n> Why not just require it to be executable in the first place?\n\n\nIt's imitating existing code that does the same for `spkg-install`. I don't know why it does that. Hysterical raisins?",
    "created_at": "2016-11-08T12:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400986",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Replying to [comment:9 embray]:
> What is this about?
> 
> 
> ```
> +    if [ ! -x spkg-build ]; then
> +	echo >&2 "WARNING: spkg-build is not executable, making it executable"
> +	chmod +x spkg-build
> +    fi
> ```
> 
> Why not just require it to be executable in the first place?


It's imitating existing code that does the same for `spkg-install`. I don't know why it does that. Hysterical raisins?



---

archive/issue_comments_400987.json:
```json
{
    "body": "<a id='comment:13'></a>I see that now.  Might as well keep it for now then :(",
    "created_at": "2016-11-08T12:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400987",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I see that now.  Might as well keep it for now then :(



---

archive/issue_comments_400988.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-08T12:50:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400988",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400989.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Erik Bray\"",
    "created_at": "2016-11-08T12:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400989",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Erik Bray"



---

archive/issue_comments_400990.json:
```json
{
    "body": "<a id='comment:16'></a>Thanks!",
    "created_at": "2016-11-08T18:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400990",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Thanks!



---

archive/issue_comments_400991.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,44 @@\n+Here's a new attempt toward #21537 that is perhaps more elegant.\n \n+Let's change `build/bin/sage-spkg` as follows:\n+\n+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)\n+\n+\n+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.\n+\n+Before the patch:\n+\n+```\n+$ rm -Rf local/share/4ti2\n+$ mkdir local/share/4ti2\n+$ sudo chown root local/share/4ti2\n+$ ./sage -f 4ti2\n+[...]\n+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied\n+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1\n+[...]\n+$ sudo chown root local/bin/ local/bin/lcalc\n+$ ./sage -f lcalc \n+[...]\n+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.\n+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied\n+[...] \n+```\n+\n+Then, after the patch:\n+\n+```\n+$ export SAGE_SUDO=\"sudo -E\"\n+$ ./sage -f 4ti2 lcalc  # succeeds\n+```\n+\n+Other packages will be handled in follow-up tickets.\n+\n+See also: \n+- #21844: Update developer manual regarding spkg-build, spkg-install, SAGE_SUDO\n+- Task ticket: #21537 \n \n Comment: 1\n \n``````\n",
    "created_at": "2016-11-08T18:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400991",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,44 @@
+Here's a new attempt toward #21537 that is perhaps more elegant.
 
+Let's change `build/bin/sage-spkg` as follows:
+
+- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
+- Otherwise, just call `spkg-install` (withOUT $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable, unless they use $SAGE_SUDO themselves.)
+
+
+The patch changes two example packages, to demonstrate this: `4ti2` and `lcalc`.
+
+Before the patch:
+
+```
+$ rm -Rf local/share/4ti2
+$ mkdir local/share/4ti2
+$ sudo chown root local/share/4ti2
+$ ./sage -f 4ti2
+[...]
+[4ti2-1.6.7] mkdir: /Users/mkoeppe/s/sage/sage-rebasing/local/share/4ti2/doc: Permission denied
+[4ti2-1.6.7] make[4]: *** [install-docDATA] Error 1
+[...]
+$ sudo chown root local/bin/ local/bin/lcalc
+$ ./sage -f lcalc 
+[...]
+[lcalc-1.23.p14] cp -f lcalc /Users/mkoeppe/s/sage/sage-rebasing/local//bin/.
+[lcalc-1.23.p14] cp: /Users/mkoeppe/s/sage/sage-rebasing/local//bin/./lcalc: Permission denied
+[...] 
+```
+
+Then, after the patch:
+
+```
+$ export SAGE_SUDO="sudo -E"
+$ ./sage -f 4ti2 lcalc  # succeeds
+```
+
+Other packages will be handled in follow-up tickets.
+
+See also: 
+- #21844: Update developer manual regarding spkg-build, spkg-install, SAGE_SUDO
+- Task ticket: #21537 
 
 Comment: 1
 
``````




---

archive/issue_events_057542.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-09T18:16:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21726#event-57542"
}
```



---

archive/issue_comments_400992.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/support_splitting_spkg_install_into__spkg_build__and__spkg_install___for_sage_sudo_\" to \"48053d0af7bef79e41a581aa492e58a285c9feb6\"",
    "created_at": "2016-11-09T18:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400992",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/support_splitting_spkg_install_into__spkg_build__and__spkg_install___for_sage_sudo_" to "48053d0af7bef79e41a581aa492e58a285c9feb6"



---

archive/issue_comments_400993.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-09T18:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400993",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_400994.json:
```json
{
    "body": "Changing commit from \"48053d0af7bef79e41a581aa492e58a285c9feb6\" to \"\"",
    "created_at": "2017-03-03T13:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400994",
    "user": "https://github.com/embray"
}
```

Changing commit from "48053d0af7bef79e41a581aa492e58a285c9feb6" to ""



---

archive/issue_comments_400995.json:
```json
{
    "body": "<a id='comment:19'></a>Semi-related, see #22510.",
    "created_at": "2017-03-03T13:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21726#issuecomment-400995",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Semi-related, see #22510.
