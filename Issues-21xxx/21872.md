# Issue 21872: Conversion from a function field to its field of constants

archive/issues_021635.json:
```json
{
    "assignees": [],
    "body": "Currently, there is no such conversion\n\n```\nsage: K.<x> = FunctionField(QQ)\nsage: K(1) in QQ\nFalse\n```\n\n**Keywords:** function field, conversion\n\n**Branch/Commit:** [21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)\n\n**Reviewer:** David Roe\n\n**Author:** Julian R\u00fcth\n\nIssue created by migration from https://trac.sagemath.org/ticket/21872\n\n",
    "closed_at": "2016-11-19T22:09:44Z",
    "created_at": "2016-11-13T14:12:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Conversion from a function field to its field of constants",
    "type": "issue",
    "updated_at": "2016-11-19T22:09:44Z",
    "url": "https://github.com/sagemath/sage/issues/21872",
    "user": "https://github.com/saraedum"
}
```
Currently, there is no such conversion

```
sage: K.<x> = FunctionField(QQ)
sage: K(1) in QQ
False
```

**Keywords:** function field, conversion

**Branch/Commit:** [21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)

**Reviewer:** David Roe

**Author:** Julian Rüth

Issue created by migration from https://trac.sagemath.org/ticket/21872





---

archive/issue_events_265856.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-11-13T14:12:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265856"
}
```



---

archive/issue_events_265857.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-11-13T14:12:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
    "label_color": "08517b",
    "label_name": "component: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265857"
}
```



---

archive/issue_events_265858.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-11-13T14:12:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/minor",
    "label_color": "ff0000",
    "label_name": "minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265858"
}
```



---

archive/issue_events_265859.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-11-13T14:12:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265859"
}
```



---

archive/issue_comments_324873.json:
```json
{
    "body": "**Branch:** [u/saraedum/conversion_from_a_function_field_to_its_field_of_constants](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/conversion_from_a_function_field_to_its_field_of_constants)",
    "created_at": "2016-11-13T14:55:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324873",
    "user": "https://github.com/saraedum"
}
```

**Branch:** [u/saraedum/conversion_from_a_function_field_to_its_field_of_constants](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/conversion_from_a_function_field_to_its_field_of_constants)



---

archive/issue_comments_324874.json:
```json
{
    "body": "**Commit:** [69bcf160a9f7dcbedcb8e621d6c0c427dea7c278](https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278)",
    "created_at": "2016-11-13T14:56:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324874",
    "user": "https://github.com/saraedum"
}
```

**Commit:** [69bcf160a9f7dcbedcb8e621d6c0c427dea7c278](https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278)



---

archive/issue_comments_324875.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7960d44b77c69a34f39da8bdc855838cd356c0da\">7960d44</a></td><td><code>Fix conversion from rational function fields to its constant base field</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278\">69bcf16</a></td><td><code>Fix conversion of function fields into their subfields</code></td></tr></table>\n",
    "created_at": "2016-11-13T14:56:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324875",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:2'>**Comment 2:**</a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7960d44b77c69a34f39da8bdc855838cd356c0da">7960d44</a></td><td><code>Fix conversion from rational function fields to its constant base field</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278">69bcf16</a></td><td><code>Fix conversion of function fields into their subfields</code></td></tr></table>




---

archive/issue_events_265860.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-11-13T14:56:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265860"
}
```



---

archive/issue_comments_324876.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f\">bb2e08e</a></td><td><code>removed indirect doctest marker</code></td></tr></table>\n",
    "created_at": "2016-11-13T14:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324876",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:3'>**Comment 3:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f">bb2e08e</a></td><td><code>removed indirect doctest marker</code></td></tr></table>




---

archive/issue_comments_324877.json:
```json
{
    "body": "**Changing commit** from \"[69bcf160a9f7dcbedcb8e621d6c0c427dea7c278](https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278)\" to \"[bb2e08e7ea03c06c03762c0226531d2f7768650f](https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f)\".",
    "created_at": "2016-11-13T14:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324877",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[69bcf160a9f7dcbedcb8e621d6c0c427dea7c278](https://github.com/sagemath/sagetrac-mirror/commit/69bcf160a9f7dcbedcb8e621d6c0c427dea7c278)" to "[bb2e08e7ea03c06c03762c0226531d2f7768650f](https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f)".



---

archive/issue_comments_324878.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nI ran doctests in `function_fields/`. The documentation builds without errors. Let's see whether the patchbot likes it as well\u2026",
    "created_at": "2016-11-13T15:06:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324878",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'>**Comment 4:**</a>
I ran doctests in `function_fields/`. The documentation builds without errors. Let's see whether the patchbot likes it as well…



---

archive/issue_comments_324879.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nAre you sure that installing a *conversion* map is the right solution? In many similar situations, there is no such map:\n\n```\nsage: K.<I>=NumberField(x^2+1)\nsage: K(1) in QQ\nTrue\nsage: QQ._convert_map_from_(K) == None\nsage: P.<t>=ZZ[]\nsage: P(1) in ZZ\nTrue\nsage: ZZ._convert_map_from_(P) == None\nTrue\nsage: L.<u>=FunctionField(QQ) #this is one of your cases\nsage: L(1) in QQ\nFalse\n```\n\nIt might be worth checking how these other cases succeed in making this work, and why they're doing it. It might be because their methods predate the coercion framework, but it might also be because introducing cycles in the conversion graph is not preferred.",
    "created_at": "2016-11-13T16:21:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324879",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'>**Comment 5:**</a>
Are you sure that installing a *conversion* map is the right solution? In many similar situations, there is no such map:

```
sage: K.<I>=NumberField(x^2+1)
sage: K(1) in QQ
True
sage: QQ._convert_map_from_(K) == None
sage: P.<t>=ZZ[]
sage: P(1) in ZZ
True
sage: ZZ._convert_map_from_(P) == None
True
sage: L.<u>=FunctionField(QQ) #this is one of your cases
sage: L(1) in QQ
False
```

It might be worth checking how these other cases succeed in making this work, and why they're doing it. It might be because their methods predate the coercion framework, but it might also be because introducing cycles in the conversion graph is not preferred.



---

archive/issue_comments_324880.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nnbruin: Thanks for having a look at this.\n\nConversion to `ZZ` works differently:\n\n```\nsage: sage: K.<I>=NumberField(x^2+1)\nsage: ZZ.convert_map_from(K)\n\nConversion via _integer_ method map:\n  From: Number Field in I with defining polynomial x^2 + 1\n  To:   Integer Ring\nsage: ZZ.convert_map_from(QQ)\n```\nSo, this path does not apply for function fields.\n\nAsking for a conversion to `QQ`:\n\n```\nsage: QQ.convert_map_from(K)\nConversion map:\n  From: Number Field in I with defining polynomial x^2 + 1\n  To:   Rational Field\n```\nso a `DefaultConvertMap_unique` which\n\n```\n    [\u2026] defers action to the codomain's\n    element_constructor method, WITHOUT passing in the codomain as the\n    first argument. [\u2026]\n```\ni.e., the target ring needs to understand what to do with the elements. I certainly do not want to teach the rational ring what a function field element is.\n\nFinally, cycles in conversions are no problem. Conversions are not automatically composed (unlike coercions.)",
    "created_at": "2016-11-13T17:15:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324880",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'>**Comment 6:**</a>
nbruin: Thanks for having a look at this.

Conversion to `ZZ` works differently:

```
sage: sage: K.<I>=NumberField(x^2+1)
sage: ZZ.convert_map_from(K)

Conversion via _integer_ method map:
  From: Number Field in I with defining polynomial x^2 + 1
  To:   Integer Ring
sage: ZZ.convert_map_from(QQ)
```
So, this path does not apply for function fields.

Asking for a conversion to `QQ`:

```
sage: QQ.convert_map_from(K)
Conversion map:
  From: Number Field in I with defining polynomial x^2 + 1
  To:   Rational Field
```
so a `DefaultConvertMap_unique` which

```
    […] defers action to the codomain's
    element_constructor method, WITHOUT passing in the codomain as the
    first argument. […]
```
i.e., the target ring needs to understand what to do with the elements. I certainly do not want to teach the rational ring what a function field element is.

Finally, cycles in conversions are no problem. Conversions are not automatically composed (unlike coercions.)



---

archive/issue_comments_324881.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nI believe that installing a conversion map down to the constant base field is necessary. For the intermediate fields, one could also change `_element_constructor_` to make sense of function field elements but then the `_to_constant_field` would get quite a bit more complicated.",
    "created_at": "2016-11-13T17:31:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324881",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'>**Comment 7:**</a>
I believe that installing a conversion map down to the constant base field is necessary. For the intermediate fields, one could also change `_element_constructor_` to make sense of function field elements but then the `_to_constant_field` would get quite a bit more complicated.



---

archive/issue_comments_324882.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nI agree with Julian that there's no problem having cycles in the conversion graph, and many rings in Sage with a concept of base ring have a conversion back to it for constants.\n\nJulian, have you looked at how this change impacts object creation time for function fields?  Maybe it would be better to implement this in `_convert_map_from_` rather than calling `register_conversion` in `__init__`.  I think `register_conversion` is available for end users who aren't able to modify `_convert_map_from_`.\n\nOtherwise, I'm happy with this change, and willing to give a positive review once we hear back from the patchbot.",
    "created_at": "2016-11-13T17:34:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324882",
    "user": "https://github.com/roed314"
}
```

<a id='comment:8'>**Comment 8:**</a>
I agree with Julian that there's no problem having cycles in the conversion graph, and many rings in Sage with a concept of base ring have a conversion back to it for constants.

Julian, have you looked at how this change impacts object creation time for function fields?  Maybe it would be better to implement this in `_convert_map_from_` rather than calling `register_conversion` in `__init__`.  I think `register_conversion` is available for end users who aren't able to modify `_convert_map_from_`.

Otherwise, I'm happy with this change, and willing to give a positive review once we hear back from the patchbot.



---

archive/issue_comments_324883.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nFor the conversion down to the constant base field, I do not really have an option. (I would have to change `_convert_map_from_` for `Field` or something similar.)\n\n```\nsage: K.<x> = FunctionField(QQ)\nsage: from sage.rings.function_field.function_field import FunctionField_polymod\nsage: K.<x> = FunctionField(QQ)\nsage: R.<y> = K[]\nsage: # work around caching by calling the class directly\nsage: %timeit FunctionField_polymod(y^2-x, 'y')\n```\nYes, object creation time does go up here from 332 \u00b5s to 555 \u00b5s. I am not sure if that is an issue. Function fields are cached after all, and I have a hard time imagining someone to create tons of them with different defining polynomials. I implemented this with `_convert_map_from_` on the level of function fields (but I still need the `register_conversion_map` for the constant base field) which gets this number down to 440 \u00b5s. Imho, the code is substantially less readable that way. So, about 110 \u00b5s seems to be the cost of a call to `register_conversion_map`.\n\nDavid, what do you think?",
    "created_at": "2016-11-13T18:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324883",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:9'>**Comment 9:**</a>
For the conversion down to the constant base field, I do not really have an option. (I would have to change `_convert_map_from_` for `Field` or something similar.)

```
sage: K.<x> = FunctionField(QQ)
sage: from sage.rings.function_field.function_field import FunctionField_polymod
sage: K.<x> = FunctionField(QQ)
sage: R.<y> = K[]
sage: # work around caching by calling the class directly
sage: %timeit FunctionField_polymod(y^2-x, 'y')
```
Yes, object creation time does go up here from 332 µs to 555 µs. I am not sure if that is an issue. Function fields are cached after all, and I have a hard time imagining someone to create tons of them with different defining polynomials. I implemented this with `_convert_map_from_` on the level of function fields (but I still need the `register_conversion_map` for the constant base field) which gets this number down to 440 µs. Imho, the code is substantially less readable that way. So, about 110 µs seems to be the cost of a call to `register_conversion_map`.

David, what do you think?



---

archive/issue_comments_324884.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nPS: I am planning to install another conversion down to the polynomial ring that is used to implement the elements of the function field, i.e., K(x) to K[x]. Here again, I won't have no choice but to register the conversion in `__init__`, so using `_convert_map_from_` is about 660 \u00b5s or 550 \u00b5s which does not look like that much of a difference anymore.",
    "created_at": "2016-11-13T18:35:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324884",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:10'>**Comment 10:**</a>
PS: I am planning to install another conversion down to the polynomial ring that is used to implement the elements of the function field, i.e., K(x) to K[x]. Here again, I won't have no choice but to register the conversion in `__init__`, so using `_convert_map_from_` is about 660 µs or 550 µs which does not look like that much of a difference anymore.



---

archive/issue_comments_324885.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nYou're right that we'll need `register_conversion_map` for the constant field and for `K[x]`.  I'm fine with a 20% slowdown in parent creation for the sake of readibility, though I would be curious to know if Nils has use cases where he wants to create tons of different function fields and object creation is the bottleneck.  I guess another instance where your approach would cause problems is deeply nested relative extensions of function fields, where the total number of conversion maps created grows quadratically with the depth.  I don't think that's a common use case though....",
    "created_at": "2016-11-13T18:41:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324885",
    "user": "https://github.com/roed314"
}
```

<a id='comment:11'>**Comment 11:**</a>
You're right that we'll need `register_conversion_map` for the constant field and for `K[x]`.  I'm fine with a 20% slowdown in parent creation for the sake of readibility, though I would be curious to know if Nils has use cases where he wants to create tons of different function fields and object creation is the bottleneck.  I guess another instance where your approach would cause problems is deeply nested relative extensions of function fields, where the total number of conversion maps created grows quadratically with the depth.  I don't think that's a common use case though....



---

archive/issue_comments_324886.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nReplying to [@roed314](#comment%3A11):\n> I would be curious to know if Nils has use cases where he wants to create tons of different function fields and object creation is the bottleneck.\n\nI don't have immediate examples, although I could imagine that fibred surfaces (either arithmetic or otherwise) might give rise to such a scenario. The bottleneck could arise if someone wants to try something really easy with the fibers, but ends up creating the fibers as curves and perhaps creating the function fields as an unintended side-effect. I don't know if the kind of slow-downs we're talking about here would be likely to be significant in such a setting.\n\n> I guess another instance where your approach would cause problems is deeply nested relative extensions of function fields, where the total number of conversion maps created grows quadratically with the depth.  I don't think that's a common use case though....\n\nIndeed, but I would suggest being a little conservative with implementing this. Can we first just install the conversion to the base ring and not transitively close over all the base rings below that?\n\nIncidentally, you have to be very careful about how you implement the conversion maps to the base rings. They will be cached on the codomain (i.e., on the base ring), so you should make sure you're *not* storing any references to the domain or its elements in the map object. All of that needs to be recovered from the argument (this is part of the reason why conversion to ZZ is implemented the way it is).\n\nOtherwise, you'll see that function fields over QQ end up not being garbage collected, because an eternal object (QQ) is keeping a reference to them in the form of registered conversion maps.\nThis is why maps in the coercion system do NOT store their domain. See #14711 for some of the black magic that was required.\n\nSo, one thing you should probably test is that\n\n```\nK.<t>=FunctionField(QQ)\nP.<X>=PolynomialRing(K)\nc=1\nwhile True:\n  L=K.extension(X^2-t^2+c*t)\n  u=QQ(L(1))\n```\ndoesn't leak.",
    "created_at": "2016-11-13T23:11:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324886",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'>**Comment 12:**</a>
Replying to [@roed314](#comment%3A11):
> I would be curious to know if Nils has use cases where he wants to create tons of different function fields and object creation is the bottleneck.

I don't have immediate examples, although I could imagine that fibred surfaces (either arithmetic or otherwise) might give rise to such a scenario. The bottleneck could arise if someone wants to try something really easy with the fibers, but ends up creating the fibers as curves and perhaps creating the function fields as an unintended side-effect. I don't know if the kind of slow-downs we're talking about here would be likely to be significant in such a setting.

> I guess another instance where your approach would cause problems is deeply nested relative extensions of function fields, where the total number of conversion maps created grows quadratically with the depth.  I don't think that's a common use case though....

Indeed, but I would suggest being a little conservative with implementing this. Can we first just install the conversion to the base ring and not transitively close over all the base rings below that?

Incidentally, you have to be very careful about how you implement the conversion maps to the base rings. They will be cached on the codomain (i.e., on the base ring), so you should make sure you're *not* storing any references to the domain or its elements in the map object. All of that needs to be recovered from the argument (this is part of the reason why conversion to ZZ is implemented the way it is).

Otherwise, you'll see that function fields over QQ end up not being garbage collected, because an eternal object (QQ) is keeping a reference to them in the form of registered conversion maps.
This is why maps in the coercion system do NOT store their domain. See #14711 for some of the black magic that was required.

So, one thing you should probably test is that

```
K.<t>=FunctionField(QQ)
P.<X>=PolynomialRing(K)
c=1
while True:
  L=K.extension(X^2-t^2+c*t)
  u=QQ(L(1))
```
doesn't leak.



---

archive/issue_comments_324887.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nReplying to [@nbruin](#comment%3A12):\n> Incidentally, you have to be very careful about how you implement the conversion maps to the base rings. They will be cached on the codomain (i.e., on the base ring), so you should make sure you're *not* storing any references to the domain or its elements in the map object. All of that needs to be recovered from the argument (this is part of the reason why conversion to ZZ is implemented the way it is).\n\nGood point; I think the current implementation has this problem.\n\n> Otherwise, you'll see that function fields over QQ end up not being garbage collected, because an eternal object (QQ) is keeping a reference to them in the form of registered conversion maps.\n> This is why maps in the coercion system do NOT store their domain. See #14711 for some of the black magic that was required.\n\n#14711 is interesting.  I'll have to think about how that should affect conversions.  But the memory leak issue definitely should be addressed.\n\n> So, one thing you should probably test is that\n> \n> ```\n> K.<t>=FunctionField(QQ)\n> P.<X>=PolynomialRing(K)\n> c=1\n> while True:\n>   L=K.extension(X^2-t^2+c*t)\n>   u=QQ(L(1))\n> ```\n> doesn't leak.\n\nI assume you want to increment `c` inside your loop.",
    "created_at": "2016-11-13T23:29:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324887",
    "user": "https://github.com/roed314"
}
```

<a id='comment:13'>**Comment 13:**</a>
Replying to [@nbruin](#comment%3A12):
> Incidentally, you have to be very careful about how you implement the conversion maps to the base rings. They will be cached on the codomain (i.e., on the base ring), so you should make sure you're *not* storing any references to the domain or its elements in the map object. All of that needs to be recovered from the argument (this is part of the reason why conversion to ZZ is implemented the way it is).

Good point; I think the current implementation has this problem.

> Otherwise, you'll see that function fields over QQ end up not being garbage collected, because an eternal object (QQ) is keeping a reference to them in the form of registered conversion maps.
> This is why maps in the coercion system do NOT store their domain. See #14711 for some of the black magic that was required.

#14711 is interesting.  I'll have to think about how that should affect conversions.  But the memory leak issue definitely should be addressed.

> So, one thing you should probably test is that
> 
> ```
> K.<t>=FunctionField(QQ)
> P.<X>=PolynomialRing(K)
> c=1
> while True:
>   L=K.extension(X^2-t^2+c*t)
>   u=QQ(L(1))
> ```
> doesn't leak.

I assume you want to increment `c` inside your loop.



---

archive/issue_comments_324888.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nNote that #14711 has a TODO of adding an option to `register_conversion` to use weak references as well.  I think we need that option here, but that should solve the problem you've pointed out.",
    "created_at": "2016-11-14T00:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324888",
    "user": "https://github.com/roed314"
}
```

<a id='comment:14'>**Comment 14:**</a>
Note that #14711 has a TODO of adding an option to `register_conversion` to use weak references as well.  I think we need that option here, but that should solve the problem you've pointed out.



---

archive/issue_comments_324889.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\n> I assume you want to increment c inside your loop. \n\nyes, although I now realize that this ticket only seems to be dealing with rational function fields, so the test should be amended accordingly.\n\nReplying to [@roed314](#comment%3A14):\n> Note that #14711 has a TODO of adding an option to `register_conversion` to use weak references as well.  I think we need that option here, but that should solve the problem you've pointed out.\n\nYes, with the implementation of the conversion map proposed here, it should. I don't think the maps store any references to the domain internally. In the mean time, you should use something like\n\n```\n   phi = to_be_registered_map\n   phi._make_weak_references() #this should remove the strong references\n   K.register_conversion(phi)\n   del phi #or just make sure that phi doesn't escape elsewhere\n```",
    "created_at": "2016-11-14T01:20:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324889",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'>**Comment 15:**</a>
> I assume you want to increment c inside your loop. 

yes, although I now realize that this ticket only seems to be dealing with rational function fields, so the test should be amended accordingly.

Replying to [@roed314](#comment%3A14):
> Note that #14711 has a TODO of adding an option to `register_conversion` to use weak references as well.  I think we need that option here, but that should solve the problem you've pointed out.

Yes, with the implementation of the conversion map proposed here, it should. I don't think the maps store any references to the domain internally. In the mean time, you should use something like

```
   phi = to_be_registered_map
   phi._make_weak_references() #this should remove the strong references
   K.register_conversion(phi)
   del phi #or just make sure that phi doesn't escape elsewhere
```



---

archive/issue_comments_324890.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nThanks for all the input. I had not thought about leaks here.\nSadly, `_make_weak_references()` does not do the trick.\nThe `register_convert_map` implementation has a line that says `self._convert_from_hash.set(mor.domain(),mor)` which does not seem to use weak references.",
    "created_at": "2016-11-14T19:43:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324890",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:16'>**Comment 16:**</a>
Thanks for all the input. I had not thought about leaks here.
Sadly, `_make_weak_references()` does not do the trick.
The `register_convert_map` implementation has a line that says `self._convert_from_hash.set(mor.domain(),mor)` which does not seem to use weak references.



---

archive/issue_comments_324891.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\nActually `_convert_from_hash` does use weak references, so it must be leaking somewhere else\u2026",
    "created_at": "2016-11-14T19:59:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324891",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:17'>**Comment 17:**</a>
Actually `_convert_from_hash` does use weak references, so it must be leaking somewhere else…



---

archive/issue_comments_324892.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nOk. The problem is the `SetMorphism` that I have been using. The parameter `self._to_constant_base_field` that I pass in holds a reference to the function field. I am going to upload a version that uses a proper `FunctionFieldConversionToConstantBaseField` map. Also, I found a way to implement `_conversion_map_from_` that makes the code not unreadable.",
    "created_at": "2016-11-14T20:24:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324892",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:18'>**Comment 18:**</a>
Ok. The problem is the `SetMorphism` that I have been using. The parameter `self._to_constant_base_field` that I pass in holds a reference to the function field. I am going to upload a version that uses a proper `FunctionFieldConversionToConstantBaseField` map. Also, I found a way to implement `_conversion_map_from_` that makes the code not unreadable.



---

archive/issue_comments_324893.json:
```json
{
    "body": "**Changing commit** from \"[bb2e08e7ea03c06c03762c0226531d2f7768650f](https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f)\" to \"[0b87e90806da4aaddec4948c0c531d41762483f7](https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7)\".",
    "created_at": "2016-11-14T20:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324893",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[bb2e08e7ea03c06c03762c0226531d2f7768650f](https://github.com/sagemath/sagetrac-mirror/commit/bb2e08e7ea03c06c03762c0226531d2f7768650f)" to "[0b87e90806da4aaddec4948c0c531d41762483f7](https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7)".



---

archive/issue_comments_324894.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b2d90c69cc74443c935181dda68e6c229035222\">7b2d90c</a></td><td><code>Use _convert_map_from_</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7\">0b87e90</a></td><td><code>Wire up conversion to the constant base field in the FunctionField base class</code></td></tr></table>\n",
    "created_at": "2016-11-14T20:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324894",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:19'>**Comment 19:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b2d90c69cc74443c935181dda68e6c229035222">7b2d90c</a></td><td><code>Use _convert_map_from_</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7">0b87e90</a></td><td><code>Wire up conversion to the constant base field in the FunctionField base class</code></td></tr></table>




---

archive/issue_comments_324895.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nThis needs review again.",
    "created_at": "2016-11-14T20:34:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324895",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:20'>**Comment 20:**</a>
This needs review again.



---

archive/issue_comments_324896.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nLittle doc nitpick:\n\n```\n+    def _to_base_field(self, f):\n...\n+        - ``f`` -- an element of this function field which is already defined\n+          over the base field\n```\nyou probably mean \"an element of the function field that lies in the base field\". All elements of the function field are defined *over* the base field by definition.\n\nElsewhere: be careful with calling subfields \"constants\". For instance, the function field `QQ(x)[y]/(y^2-2)` has as constant subfield `QQ(sqrt(2))`, whereas the base field is QQ. Finding the exact constant field (i.e., the algebraic closure of the base field in the function field) takes considerable computation, so I'm not sure this is part of the scope of this ticket.",
    "created_at": "2016-11-14T21:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324896",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:21'>**Comment 21:**</a>
Little doc nitpick:

```
+    def _to_base_field(self, f):
...
+        - ``f`` -- an element of this function field which is already defined
+          over the base field
```
you probably mean "an element of the function field that lies in the base field". All elements of the function field are defined *over* the base field by definition.

Elsewhere: be careful with calling subfields "constants". For instance, the function field `QQ(x)[y]/(y^2-2)` has as constant subfield `QQ(sqrt(2))`, whereas the base field is QQ. Finding the exact constant field (i.e., the algebraic closure of the base field in the function field) takes considerable computation, so I'm not sure this is part of the scope of this ticket.



---

archive/issue_comments_324897.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653\">21a6a10</a></td><td><code>improve wording on base fields</code></td></tr></table>\n",
    "created_at": "2016-11-15T01:45:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324897",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:22'>**Comment 22:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653">21a6a10</a></td><td><code>improve wording on base fields</code></td></tr></table>




---

archive/issue_comments_324898.json:
```json
{
    "body": "**Changing commit** from \"[0b87e90806da4aaddec4948c0c531d41762483f7](https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7)\" to \"[21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)\".",
    "created_at": "2016-11-15T01:45:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324898",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[0b87e90806da4aaddec4948c0c531d41762483f7](https://github.com/sagemath/sagetrac-mirror/commit/0b87e90806da4aaddec4948c0c531d41762483f7)" to "[21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)".



---

archive/issue_comments_324899.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nThe patchbot complains about `modsym/space.py`. I checked locally and it works fine. (It would also have been very suprising if this made a difference there.)",
    "created_at": "2016-11-17T23:11:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324899",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:23'>**Comment 23:**</a>
The patchbot complains about `modsym/space.py`. I checked locally and it works fine. (It would also have been very suprising if this made a difference there.)



---

archive/issue_comments_324900.json:
```json
{
    "body": "<a id='comment:24'>**Comment 24:**</a>\nI'm happy with the changes.  Nils, thanks for the suggestions: feel free to add yourself as a reviewer.",
    "created_at": "2016-11-18T03:58:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324900",
    "user": "https://github.com/roed314"
}
```

<a id='comment:24'>**Comment 24:**</a>
I'm happy with the changes.  Nils, thanks for the suggestions: feel free to add yourself as a reviewer.



---

archive/issue_comments_324901.json:
```json
{
    "body": "**Reviewer:** David Roe",
    "created_at": "2016-11-18T03:58:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324901",
    "user": "https://github.com/roed314"
}
```

**Reviewer:** David Roe



---

archive/issue_events_265861.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2016-11-18T03:58:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265861"
}
```



---

archive/issue_events_265862.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2016-11-18T03:58:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265862"
}
```



---

archive/issue_comments_324902.json:
```json
{
    "body": "**Changing branch** from \"[u/saraedum/conversion_from_a_function_field_to_its_field_of_constants](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/conversion_from_a_function_field_to_its_field_of_constants)\" to \"[21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)\".",
    "created_at": "2016-11-19T22:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21872#issuecomment-324902",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/saraedum/conversion_from_a_function_field_to_its_field_of_constants](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/conversion_from_a_function_field_to_its_field_of_constants)" to "[21a6a105637a9ecafe6b103e8dfae54c59b82653](https://github.com/sagemath/sagetrac-mirror/commit/21a6a105637a9ecafe6b103e8dfae54c59b82653)".



---

archive/issue_events_265863.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-19T22:09:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265863"
}
```



---

archive/issue_events_265864.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d1a9b98456721af7c464cb9b1782404a26da60e9",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-11-19T22:09:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21872",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21872#event-265864"
}
```
