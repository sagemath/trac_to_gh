# Issue 21610: Fix "warning: -jN forced in submake: disabling jobserver mode" warnings

archive/issues_021373.json:
```json
{
    "assignees": [],
    "body": "We should try to fix these warnings:\n\n```\nwarning: -jN forced in submake: disabling jobserver mode.\n```\n\nThere are 3 different issues:\n\n1. The warnings appears several times at the top-level (not inside a package build) and during the build of the Sage library. This can probably be fixed by moving this snippet from `sage-env` higher up:\n\n```sh\n# If MAKEFLAGS exists, assume it got set by make.\n# Therefore, remove all flags from $MAKE\nif [ \"${MAKEFLAGS-__unset__}\" != \"__unset__\" ]; then\n    MAKE=`echo \"$MAKE\" | sed 's/ .*//'`\nfi\nexport MAKE\n```\n\n2. For several packages, the warning correctly appears because we explicitly force `-j1` (presumably to fix parallel build issues):\n- `brial`\n- `gap`\n- `pari`\n- `pkgconf`\n- `python2`\n- `singular`\n- `zeromq`\n\n3. Other packages where this warnings appears:\n- `openblas`: no idea where it comes from, probably the `openblas` build system itself.\n\nCC:  @embray @jdemeyer @vbraun @jhpalmieri @dimpase @orlitzky\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21610_\n\n",
    "created_at": "2016-09-29T06:53:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix \"warning: -jN forced in submake: disabling jobserver mode\" warnings",
    "type": "issue",
    "updated_at": "2022-08-31T02:51:13Z",
    "url": "https://github.com/sagemath/sage/issues/21610",
    "user": "https://github.com/mkoeppe"
}
```
We should try to fix these warnings:

```
warning: -jN forced in submake: disabling jobserver mode.
```

There are 3 different issues:

1. The warnings appears several times at the top-level (not inside a package build) and during the build of the Sage library. This can probably be fixed by moving this snippet from `sage-env` higher up:

```sh
# If MAKEFLAGS exists, assume it got set by make.
# Therefore, remove all flags from $MAKE
if [ "${MAKEFLAGS-__unset__}" != "__unset__" ]; then
    MAKE=`echo "$MAKE" | sed 's/ .*//'`
fi
export MAKE
```

2. For several packages, the warning correctly appears because we explicitly force `-j1` (presumably to fix parallel build issues):
- `brial`
- `gap`
- `pari`
- `pkgconf`
- `python2`
- `singular`
- `zeromq`

3. Other packages where this warnings appears:
- `openblas`: no idea where it comes from, probably the `openblas` build system itself.

CC:  @embray @jdemeyer @vbraun @jhpalmieri @dimpase @orlitzky

_Issue created by migration from https://trac.sagemath.org/ticket/21610_





---

archive/issue_events_285525.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-09-29T06:53:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285525"
}
```



---

archive/issue_events_285526.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-09-29T06:53:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "component: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285526"
}
```



---

archive/issue_events_285527.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-09-29T06:53:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285527"
}
```



---

archive/issue_events_285528.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-09-29T06:53:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285528"
}
```



---

archive/issue_comments_320137.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nI always wondered about the reason for the current recommendation; it would be good to get to the bottom of it.",
    "created_at": "2016-09-29T07:07:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320137",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'>Comment 1:</a>
I always wondered about the reason for the current recommendation; it would be good to get to the bottom of it.



---

archive/issue_events_285529.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-29T07:24:13Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "title_is": "Fix \"warning: -jN forced in submake: disabling jobserver mode\" warnings",
    "title_was": "Installation manual: Recommend `make -jNUM` instead of `MAKE='make -jNUM' make`",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285529"
}
```



---

archive/issue_comments_320138.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,4 @@\n-The current recommendation in the installation manual\n-causes a lot of:\n+We should try to fix these warnings:\n \n ```\n warning: -jN forced in submake: disabling jobserver mode.\n``````\n",
    "created_at": "2016-09-29T07:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320138",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,4 @@
-The current recommendation in the installation manual
-causes a lot of:
+We should try to fix these warnings:
 
 ```
 warning: -jN forced in submake: disabling jobserver mode.
``````




---

archive/issue_comments_320139.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nThe `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.\n\nI am adjusting the ticket issue.",
    "created_at": "2016-09-29T07:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320139",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'>Comment 2:</a>
The `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.

I am adjusting the ticket issue.



---

archive/issue_events_285530.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-29T07:24:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "component: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285530"
}
```



---

archive/issue_events_285531.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-09-29T07:24:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285531"
}
```



---

archive/issue_comments_320140.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nIn other words, the `MAKE=\"make -jNUM` thing is a hack, but it works.",
    "created_at": "2016-09-29T07:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320140",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'>Comment 3:</a>
In other words, the `MAKE="make -jNUM` thing is a hack, but it works.



---

archive/issue_comments_320141.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nReplying to [@jdemeyer](#comment%3A2):\n> The `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.\n\nOK, would this mean that it's just an unfortunate choice of the name for this variable?\nSo if we renamed it to something it would also fix these warnings, etc?",
    "created_at": "2016-09-29T07:30:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320141",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'>Comment 4:</a>
Replying to [@jdemeyer](#comment%3A2):
> The `make -jNUM` command can only work properly if you use `make` for everything. In Sage, we don't use `make` for all Python-related builds, in particular the build of the Sage library and the documentation. For this, we actually look at the environment variable `MAKE`. So this proposal just doesn't work.

OK, would this mean that it's just an unfortunate choice of the name for this variable?
So if we renamed it to something it would also fix these warnings, etc?



---

archive/issue_comments_320142.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@dimpase](#comment%3A4):\n> OK, would this mean that it's just an unfortunate choice of the name for this variable?\n\nNo, because it also serves as `MAKE` variable.\n\n> So if we renamed it to something it would also fix these warnings, etc?\n\nI think that we can fix the warnings without changing the variable name.",
    "created_at": "2016-09-29T07:41:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320142",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@dimpase](#comment%3A4):
> OK, would this mean that it's just an unfortunate choice of the name for this variable?

No, because it also serves as `MAKE` variable.

> So if we renamed it to something it would also fix these warnings, etc?

I think that we can fix the warnings without changing the variable name.



---

archive/issue_comments_320143.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nI am currently doing a build from scratch of Sage, I'll check when those warnings appear.",
    "created_at": "2016-09-29T07:58:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320143",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
I am currently doing a build from scratch of Sage, I'll check when those warnings appear.



---

archive/issue_comments_320144.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nIn all cases where the warning occurs inside a package build, it is because of problems with the upstream package and it has nothing to do with the `MAKE` variable. Sometimes the upstream `Makefile` does not properly support a parallel build and we need to force `-j1`.",
    "created_at": "2016-09-29T08:10:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320144",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
In all cases where the warning occurs inside a package build, it is because of problems with the upstream package and it has nothing to do with the `MAKE` variable. Sometimes the upstream `Makefile` does not properly support a parallel build and we need to force `-j1`.



---

archive/issue_comments_320145.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,15 @@\n warning: -jN forced in submake: disabling jobserver mode.\n ```\n \n+For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):\n+- `brial`\n+- `gap`\n+- `pari`\n+- `pkgconf`\n+- `python2`\n+- `zeromq`\n+\n+Other packages where this warnings appears:\n+- `openblas`: no idea where it comes from, probably the `openblas` build system itself.\n+\n+The warnings also appears several times at the top-level (not inside a package build).\n``````\n",
    "created_at": "2016-09-29T08:10:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320145",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,15 @@
 warning: -jN forced in submake: disabling jobserver mode.
 ```
 
+For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):
+- `brial`
+- `gap`
+- `pari`
+- `pkgconf`
+- `python2`
+- `zeromq`
+
+Other packages where this warnings appears:
+- `openblas`: no idea where it comes from, probably the `openblas` build system itself.
+
+The warnings also appears several times at the top-level (not inside a package build).
``````




---

archive/issue_comments_320146.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,6 +10,7 @@\n - `pari`\n - `pkgconf`\n - `python2`\n+- `singular`\n - `zeromq`\n \n Other packages where this warnings appears:\n``````\n",
    "created_at": "2016-09-29T08:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320146",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,6 +10,7 @@
 - `pari`
 - `pkgconf`
 - `python2`
+- `singular`
 - `zeromq`
 
 Other packages where this warnings appears:
``````




---

archive/issue_comments_320147.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,4 +16,13 @@\n Other packages where this warnings appears:\n - `openblas`: no idea where it comes from, probably the `openblas` build system itself.\n \n-The warnings also appears several times at the top-level (not inside a package build).\n+The warnings also appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:\n+\n+```\n+# If MAKEFLAGS exists, assume it got set by make.\n+# Therefore, remove all flags from $MAKE\n+if [ \"${MAKEFLAGS-__unset__}\" != \"__unset__\" ]; then\n+    MAKE=`echo \"$MAKE\" | sed 's/ .*//'`\n+fi\n+export MAKE\n+```\n``````\n",
    "created_at": "2016-09-29T08:16:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320147",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,4 +16,13 @@
 Other packages where this warnings appears:
 - `openblas`: no idea where it comes from, probably the `openblas` build system itself.
 
-The warnings also appears several times at the top-level (not inside a package build).
+The warnings also appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:
+
+```
+# If MAKEFLAGS exists, assume it got set by make.
+# Therefore, remove all flags from $MAKE
+if [ "${MAKEFLAGS-__unset__}" != "__unset__" ]; then
+    MAKE=`echo "$MAKE" | sed 's/ .*//'`
+fi
+export MAKE
+```
``````




---

archive/issue_comments_320148.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,20 @@\n warning: -jN forced in submake: disabling jobserver mode.\n ```\n \n-For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):\n+There are 3 different issues:\n+\n+1. The warnings appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:\n+\n+```sh\n+# If MAKEFLAGS exists, assume it got set by make.\n+# Therefore, remove all flags from $MAKE\n+if [ \"${MAKEFLAGS-__unset__}\" != \"__unset__\" ]; then\n+    MAKE=`echo \"$MAKE\" | sed 's/ .*//'`\n+fi\n+export MAKE\n+```\n+\n+2. For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):\n - `brial`\n - `gap`\n - `pari`\n@@ -13,16 +26,5 @@\n - `singular`\n - `zeromq`\n \n-Other packages where this warnings appears:\n+3. Other packages where this warnings appears:\n - `openblas`: no idea where it comes from, probably the `openblas` build system itself.\n-\n-The warnings also appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:\n-\n-```\n-# If MAKEFLAGS exists, assume it got set by make.\n-# Therefore, remove all flags from $MAKE\n-if [ \"${MAKEFLAGS-__unset__}\" != \"__unset__\" ]; then\n-    MAKE=`echo \"$MAKE\" | sed 's/ .*//'`\n-fi\n-export MAKE\n-```\n``````\n",
    "created_at": "2016-09-29T08:19:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320148",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,20 @@
 warning: -jN forced in submake: disabling jobserver mode.
 ```
 
-For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):
+There are 3 different issues:
+
+1. The warnings appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:
+
+```sh
+# If MAKEFLAGS exists, assume it got set by make.
+# Therefore, remove all flags from $MAKE
+if [ "${MAKEFLAGS-__unset__}" != "__unset__" ]; then
+    MAKE=`echo "$MAKE" | sed 's/ .*//'`
+fi
+export MAKE
+```
+
+2. For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):
 - `brial`
 - `gap`
 - `pari`
@@ -13,16 +26,5 @@
 - `singular`
 - `zeromq`
 
-Other packages where this warnings appears:
+3. Other packages where this warnings appears:
 - `openblas`: no idea where it comes from, probably the `openblas` build system itself.
-
-The warnings also appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:
-
-```
-# If MAKEFLAGS exists, assume it got set by make.
-# Therefore, remove all flags from $MAKE
-if [ "${MAKEFLAGS-__unset__}" != "__unset__" ]; then
-    MAKE=`echo "$MAKE" | sed 's/ .*//'`
-fi
-export MAKE
-```
``````




---

archive/issue_comments_320149.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n export MAKE\n ```\n \n-2. For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):\n+2. For several packages, the warning correctly appears because we explicitly force `-j1` (presumably to fix parallel build issues):\n - `brial`\n - `gap`\n - `pari`\n``````\n",
    "created_at": "2016-09-29T08:20:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320149",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 export MAKE
 ```
 
-2. For several packages, this is because we explicitly force `-j1` (presumably to fix parallel build issues):
+2. For several packages, the warning correctly appears because we explicitly force `-j1` (presumably to fix parallel build issues):
 - `brial`
 - `gap`
 - `pari`
``````




---

archive/issue_comments_320150.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nStill, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter). Why do we do this highly non-standard way of starting the build, with setting MAKE variable manually?",
    "created_at": "2016-09-29T10:02:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320150",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'>Comment 12:</a>
Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter). Why do we do this highly non-standard way of starting the build, with setting MAKE variable manually?



---

archive/issue_comments_320151.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nI've had this same thought before--really we should not be passing down `MAKE=make -jN` to sub-makes.\n\nThe problem is that for Sage's build it's being used for cross-purposes.  For packages that use make we want them to be able to take advantage of parallel builds (but jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).  But at the same time we want to take advantage of it for Sage to build multiple packages simultaneously.\n\nI experimented with this a bit in the past and found that it could actually speed things up quite a bit, but only in limited cases.  To really make it work properly we need further reworking of the spkg structure so that the builds for packages that use make are actually launched as proper sub-makes.",
    "created_at": "2016-09-29T10:52:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320151",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'>Comment 13:</a>
I've had this same thought before--really we should not be passing down `MAKE=make -jN` to sub-makes.

The problem is that for Sage's build it's being used for cross-purposes.  For packages that use make we want them to be able to take advantage of parallel builds (but jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).  But at the same time we want to take advantage of it for Sage to build multiple packages simultaneously.

I experimented with this a bit in the past and found that it could actually speed things up quite a bit, but only in limited cases.  To really make it work properly we need further reworking of the spkg structure so that the builds for packages that use make are actually launched as proper sub-makes.



---

archive/issue_comments_320152.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@dimpase](#comment%3A12):\n> Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).\n\nBecause there is no simple way to figure out the value of `-j` from a running instance of `make`.",
    "created_at": "2016-09-29T14:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320152",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@dimpase](#comment%3A12):
> Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).

Because there is no simple way to figure out the value of `-j` from a running instance of `make`.



---

archive/issue_comments_320153.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@embray](#comment%3A13):\n> jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).\n\nThis statement is wrong. In Sage, parallel `make` works for packages using `make`. The problem is the parts of the build which do not use `make`, in particular the build of the Sage library and documentation.",
    "created_at": "2016-09-29T14:39:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320153",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@embray](#comment%3A13):
> jobserver mode is disabled that means the number of jobs started by make can actually well overtake `N`).

This statement is wrong. In Sage, parallel `make` works for packages using `make`. The problem is the parts of the build which do not use `make`, in particular the build of the Sage library and documentation.



---

archive/issue_comments_320154.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,7 +6,7 @@\n \n There are 3 different issues:\n \n-1. The warnings appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:\n+1. The warnings appears several times at the top-level (not inside a package build) and during the build of the Sage library. This can probably be fixed by moving this snippet from `sage-env` higher up:\n \n ```sh\n # If MAKEFLAGS exists, assume it got set by make.\n``````\n",
    "created_at": "2016-09-29T14:45:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320154",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,7 +6,7 @@
 
 There are 3 different issues:
 
-1. The warnings appears several times at the top-level (not inside a package build). This can probably be fixed by moving this snippet from `sage-env` higher up:
+1. The warnings appears several times at the top-level (not inside a package build) and during the build of the Sage library. This can probably be fixed by moving this snippet from `sage-env` higher up:
 
 ```sh
 # If MAKEFLAGS exists, assume it got set by make.
``````




---

archive/issue_comments_320155.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@jdemeyer](#comment%3A14):\n> Replying to [@dimpase](#comment%3A12):\n> > Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).\n\n> \n> Because there is no simple way to figure out the value of `-j` from a running instance of `make`.\n\nHow about this:\n\n```\n$ cat Makefile \nall: opts\n\nopts:\n\t@echo $(MAKEFLAGS)\n```\nNow:\n\n```\n$ make -j10\n-j10 --jobserver-auth=3,4\n```\nThat is, you can parse top-level MAKEFLAGS and get the value you need.",
    "created_at": "2016-09-29T15:00:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320155",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@jdemeyer](#comment%3A14):
> Replying to [@dimpase](#comment%3A12):
> > Still, I don't understand why the toplevel makefile can't set MAKE (or appropriately renamed) variable as it sees fit (from the value of -j parameter).

> 
> Because there is no simple way to figure out the value of `-j` from a running instance of `make`.

How about this:

```
$ cat Makefile 
all: opts

opts:
	@echo $(MAKEFLAGS)
```
Now:

```
$ make -j10
-j10 --jobserver-auth=3,4
```
That is, you can parse top-level MAKEFLAGS and get the value you need.



---

archive/issue_comments_320156.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nWhat does `make --version` say? I would swear that I have tested this at some point and then it didn't work.",
    "created_at": "2016-09-29T15:05:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320156",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
What does `make --version` say? I would swear that I have tested this at some point and then it didn't work.



---

archive/issue_comments_320157.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nWell, your trick does *not* work with\n\n```\nGNU Make 4.1\nBuilt for x86_64-pc-linux-gnu\nCopyright (C) 1988-2014 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n```\n\nThe output is `-j --jobserver-fds=3,4`",
    "created_at": "2016-09-29T15:06:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320157",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'>Comment 19:</a>
Well, your trick does *not* work with

```
GNU Make 4.1
Built for x86_64-pc-linux-gnu
Copyright (C) 1988-2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```

The output is `-j --jobserver-fds=3,4`



---

archive/issue_comments_320158.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [@jdemeyer](#comment%3A19):\n> Well, your trick does *not* work with\n> \n> ```\n> GNU Make 4.1\n> Built for x86_64-pc-linux-gnu\n> Copyright (C) 1988-2014 Free Software Foundation, Inc.\n> License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\n> This is free software: you are free to change and redistribute it.\n> There is NO WARRANTY, to the extent permitted by law.\n> ```\n> \n> The output is `-j --jobserver-fds=3,4`\n\nmine is 4.2.1. Well, a bug in `make`...\nIn 3.81 it is `--jobserver-fds=3,4 -j` So they tried to fix it ;-)",
    "created_at": "2016-09-29T15:12:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320158",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [@jdemeyer](#comment%3A19):
> Well, your trick does *not* work with
> 
> ```
> GNU Make 4.1
> Built for x86_64-pc-linux-gnu
> Copyright (C) 1988-2014 Free Software Foundation, Inc.
> License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
> This is free software: you are free to change and redistribute it.
> There is NO WARRANTY, to the extent permitted by law.
> ```
> 
> The output is `-j --jobserver-fds=3,4`

mine is 4.2.1. Well, a bug in `make`...
In 3.81 it is `--jobserver-fds=3,4 -j` So they tried to fix it ;-)



---

archive/issue_comments_320159.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nSo there is hope that we might be able to implement this in the future...",
    "created_at": "2016-09-29T15:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320159",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>Comment 21:</a>
So there is hope that we might be able to implement this in the future...



---

archive/issue_comments_320160.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [@jdemeyer](#comment%3A21):\n> So there is hope that we might be able to implement this in the future...\n\nor we can add `make 4.2.1` package and have it now ;-)",
    "created_at": "2016-09-29T15:17:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320160",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [@jdemeyer](#comment%3A21):
> So there is hope that we might be able to implement this in the future...

or we can add `make 4.2.1` package and have it now ;-)



---

archive/issue_comments_320161.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nReplying to [@dimpase](#comment%3A22):\n> or we can add `make 4.2.1` package and have it now ;-)\n\nNot really because we are talking about the user running the system `make`.\n\nWhat we *could* do is try to support both mechanisms: for users running a recent enough version of `make`, we could support `make -j10`.",
    "created_at": "2016-09-29T15:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320161",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'>Comment 23:</a>
Replying to [@dimpase](#comment%3A22):
> or we can add `make 4.2.1` package and have it now ;-)

Not really because we are talking about the user running the system `make`.

What we *could* do is try to support both mechanisms: for users running a recent enough version of `make`, we could support `make -j10`.



---

archive/issue_comments_320162.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\njust for the sake of it, added this piece of `make` info as an answer at http://stackoverflow.com/questions/10898528/how-can-i-tell-what-j-option-was-provided-to-make",
    "created_at": "2016-09-29T15:29:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320162",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'>Comment 24:</a>
just for the sake of it, added this piece of `make` info as an answer at http://stackoverflow.com/questions/10898528/how-can-i-tell-what-j-option-was-provided-to-make



---

archive/issue_events_285532.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T14:37:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285532"
}
```



---

archive/issue_events_285533.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T14:37:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285533"
}
```



---

archive/issue_comments_320163.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nSee #30369 for another approach -- actually using the jobserver protocol.",
    "created_at": "2020-08-15T13:41:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320163",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'>Comment 27:</a>
See #30369 for another approach -- actually using the jobserver protocol.



---

archive/issue_events_285534.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285534"
}
```



---

archive/issue_events_285535.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285535"
}
```



---

archive/issue_events_285536.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285536"
}
```



---

archive/issue_events_285537.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285537"
}
```



---

archive/issue_comments_320164.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nSage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21610#issuecomment-320164",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'>Comment 29:</a>
Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_285538.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285538"
}
```



---

archive/issue_events_285539.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285539"
}
```



---

archive/issue_events_285540.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285540"
}
```



---

archive/issue_events_285541.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285541"
}
```



---

archive/issue_events_285542.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T04:32:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285542"
}
```



---

archive/issue_events_285543.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T04:32:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285543"
}
```



---

archive/issue_events_285544.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285544"
}
```



---

archive/issue_events_285545.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21610",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21610#event-285545"
}
```
