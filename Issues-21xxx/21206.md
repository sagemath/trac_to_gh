# Issue 21206: Add improved process shutdown code for PALPreader._iterate_list

archive/issues_020969.json:
```json
{
    "assignees": [],
    "body": "This is to fix the tests in `sage.geometry.polyhedron.palp_database`, which were irregularly failing on Cygwin.  I don't think there's really anything Cygwin-specific about the issue, actually.  It just tends to exhibit itself on Cygwin because process shutdown takes longer, giving a wider window for the race condition described below.\n\nThis method had some code to force the PALP process to shut down at the end of iteration, rather than waiting for it to complete naturally.   However, this was failing randomly, at least on Windows, due to a race condition where the process could end between calling `poll()` and calling `terminate()` (and/or `kill()`)--the `terminate()` call would in turn cause an `OSError` (\"No such process\").\n\nThe newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.\n\nSince the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.\n\nAs discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.\n\n**Update:** The Cygwin issue is now fixed upstream: https://cygwin.com/git/?p=newlib-cygwin.git;a=commitdiff;h=86f79af827729f3968d8b3b8f860ac29d200da0d  No harm in checking for this behavior regardless though.\n\nDepends on #22695\n\nCC:  @sagetrac-gouezel @jdemeyer @vbraun\n\nKeywords: **palp subprocess**\n\nBranch/Commit: **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**\n\nUpstream: **Fixed upstream, in a later stable release.**\n\nReviewer: **Erik Bray, Jeroen Demeyer**\n\nAuthor: **Erik Bray, Jeroen Demeyer**\n\nComponent: **porting: Cygwin**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/21206_\n\n",
    "closed_at": "2017-04-25T17:40:12Z",
    "created_at": "2016-08-10T14:37:38Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
        "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Add improved process shutdown code for PALPreader._iterate_list",
    "type": "issue",
    "updated_at": "2017-04-25T17:40:12Z",
    "url": "https://github.com/sagemath/sage/issues/21206",
    "user": "https://github.com/embray"
}
```
This is to fix the tests in `sage.geometry.polyhedron.palp_database`, which were irregularly failing on Cygwin.  I don't think there's really anything Cygwin-specific about the issue, actually.  It just tends to exhibit itself on Cygwin because process shutdown takes longer, giving a wider window for the race condition described below.

This method had some code to force the PALP process to shut down at the end of iteration, rather than waiting for it to complete naturally.   However, this was failing randomly, at least on Windows, due to a race condition where the process could end between calling `poll()` and calling `terminate()` (and/or `kill()`)--the `terminate()` call would in turn cause an `OSError` ("No such process").

The newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.

Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.

As discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.

**Update:** The Cygwin issue is now fixed upstream: https://cygwin.com/git/?p=newlib-cygwin.git;a=commitdiff;h=86f79af827729f3968d8b3b8f860ac29d200da0d  No harm in checking for this behavior regardless though.

Depends on #22695

CC:  @sagetrac-gouezel @jdemeyer @vbraun

Keywords: **palp subprocess**

Branch/Commit: **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**

Upstream: **Fixed upstream, in a later stable release.**

Reviewer: **Erik Bray, Jeroen Demeyer**

Author: **Erik Bray, Jeroen Demeyer**

Component: **porting: Cygwin**

_Issue created by migration from https://trac.sagemath.org/ticket/21206_





---

archive/issue_events_295532.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-10T14:37:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "0000b0",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295532"
}
```



---

archive/issue_events_295533.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-10T14:37:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295533"
}
```



---

archive/issue_events_295534.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-10T14:37:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295534"
}
```



---

archive/issue_comments_309410.json:
```json
{
    "body": "Commit: **[`db6085b`](https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e)**",
    "created_at": "2016-08-10T14:38:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309410",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`db6085b`](https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e)**



---

archive/issue_comments_309411.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e\"><code>db6085b</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr></table>\n",
    "created_at": "2016-08-10T14:38:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309411",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:1"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e"><code>db6085b</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr></table>




---

archive/issue_events_295535.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-10T14:38:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295535"
}
```



---

archive/issue_comments_309412.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nDuplicate of #17864?",
    "created_at": "2016-08-10T14:59:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309412",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Duplicate of #17864?



---

archive/issue_comments_309413.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAt least it's related to #17864, but the descriptions of both tickets seem to indicate a differnt cause.",
    "created_at": "2016-08-10T15:03:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309413",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

At least it's related to #17864, but the descriptions of both tickets seem to indicate a differnt cause.



---

archive/issue_comments_309414.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n0.1 seconds is a ridiculously short time to wait. You might as well send `SIGKILL` directly...",
    "created_at": "2016-08-10T15:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309414",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

0.1 seconds is a ridiculously short time to wait. You might as well send `SIGKILL` directly...



---

archive/issue_comments_309415.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThis `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.\n\nSince it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).",
    "created_at": "2016-08-10T15:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309415",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.

Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).



---

archive/issue_comments_309416.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nJust a pointer: you should have a look at the code for killing `SagePtyProcess` in `src/sage/interfaces/sagespawn.pyx`",
    "created_at": "2016-08-10T15:18:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309416",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Just a pointer: you should have a look at the code for killing `SagePtyProcess` in `src/sage/interfaces/sagespawn.pyx`



---

archive/issue_comments_309417.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOkay on all of the above.  I don't know about #17864--this seems to fix any problem I had with this on Cygwin.",
    "created_at": "2016-08-10T15:45:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309417",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

Okay on all of the above.  I don't know about #17864--this seems to fix any problem I had with this on Cygwin.



---

archive/issue_events_295536.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-11T09:57:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295536"
}
```



---

archive/issue_events_295537.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-08-11T09:57:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295537"
}
```



---

archive/issue_comments_309418.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n The newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.\n \n Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.\n+\n+As discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.\n``````\n",
    "created_at": "2016-08-11T09:57:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309418",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
 The newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.
 
 Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.
+
+As discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.
``````




---

archive/issue_comments_309419.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2016-08-11T09:57:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309419",
    "user": "https://github.com/embray"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_309420.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nFor the purposes of PALP, would it be possible to just do a normal process termination? That is, work around the Cygwin bug but don't do stuff like sending `SIGKILL` in case the process does not terminate within a given time.",
    "created_at": "2016-08-12T08:19:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309420",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

For the purposes of PALP, would it be possible to just do a normal process termination? That is, work around the Cygwin bug but don't do stuff like sending `SIGKILL` in case the process does not terminate within a given time.



---

archive/issue_comments_309421.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.\n \n As discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.\n+\n+**Update:** The Cygwin issue is now fixed upstream: https://cygwin.com/git/?p=newlib-cygwin.git;a=commitdiff;h=86f79af827729f3968d8b3b8f860ac29d200da0d  No harm in checking for this behavior regardless though.\n``````\n",
    "created_at": "2016-08-12T08:46:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309421",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.
 
 As discussed in #17864, a more general problem here is that `kill()` should not return an error when sent to already exited processes, and the fact that it does on Cygwin is probably a misfeature, so I have reported it upstream: https://cygwin.com/ml/cygwin/2016-08/msg00188.html  This issue isn't *necessarily* unique to Cygwin though.
+
+**Update:** The Cygwin issue is now fixed upstream: https://cygwin.com/git/?p=newlib-cygwin.git;a=commitdiff;h=86f79af827729f3968d8b3b8f860ac29d200da0d  No harm in checking for this behavior regardless though.
``````




---

archive/issue_comments_309422.json:
```json
{
    "body": "Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, in a later stable release.**",
    "created_at": "2016-08-12T08:46:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309422",
    "user": "https://github.com/embray"
}
```

Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, in a later stable release.**



---

archive/issue_comments_309423.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI know this needs other work, but when I build the docs with this fix applied I get:\n\n```\n[dochtml] OSError: [geometry ] /home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/geometry/polyhedron/palp_database.py:docstring of sage.geometry.polyhedron.palp_database.terminate:31: WARNING: Block quote ends without a blank line; unexpected unindent.\n```\n\nI can't for the life of me figure out what this needs.  If I look at other docstrings there are plenty that have a blockquote at the end of the docstring with no newline.  But even when I add an additional newline it still complains.  Anyone seen this before?",
    "created_at": "2016-08-16T15:47:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309423",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

I know this needs other work, but when I build the docs with this fix applied I get:

```
[dochtml] OSError: [geometry ] /home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/geometry/polyhedron/palp_database.py:docstring of sage.geometry.polyhedron.palp_database.terminate:31: WARNING: Block quote ends without a blank line; unexpected unindent.
```

I can't for the life of me figure out what this needs.  If I look at other docstrings there are plenty that have a blockquote at the end of the docstring with no newline.  But even when I add an additional newline it still complains.  Anyone seen this before?



---

archive/issue_comments_309424.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAbout `SIGALRM`: I have some ideas to improve `cysignals` to better cooperate with other libraries. Remember that `cysignals` was originally written just for Sage without much regard for more general usage.",
    "created_at": "2016-08-17T07:54:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309424",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

About `SIGALRM`: I have some ideas to improve `cysignals` to better cooperate with other libraries. Remember that `cysignals` was originally written just for Sage without much regard for more general usage.



---

archive/issue_comments_309425.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@embray](#comment:12):\n> But even when I add an additional newline it still complains.  Anyone seen this before?\n\n```\n\"\"\"\n[...]\nsignal(SIGTERM, SIG_IGN)\\n\n[...]\n\"\"\"\n```\nYou need to use a `r\"\"\"` string to make the `\\n` literal instead of an actual newline.",
    "created_at": "2016-08-17T07:56:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309425",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@embray](#comment:12):
> But even when I add an additional newline it still complains.  Anyone seen this before?

```
"""
[...]
signal(SIGTERM, SIG_IGN)\n
[...]
"""
```
You need to use a `r"""` string to make the `\n` literal instead of an actual newline.



---

archive/issue_comments_309426.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jdemeyer](#comment:14):\n> You need to use a `r\"\"\"` string to make the `\\n` literal instead of an actual newline.\n\nAh! Thanks for catching that.  Subtle(-ish).\n\nAs for SIGALRM I think that was about another ticket--I don't think there's really an issue with SIGALRM here, unless I'm missing something.  I'd be interested to hear your thoughts though.",
    "created_at": "2016-08-17T08:03:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309426",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jdemeyer](#comment:14):
> You need to use a `r"""` string to make the `\n` literal instead of an actual newline.

Ah! Thanks for catching that.  Subtle(-ish).

As for SIGALRM I think that was about another ticket--I don't think there's really an issue with SIGALRM here, unless I'm missing something.  I'd be interested to hear your thoughts though.



---

archive/issue_comments_309427.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jdemeyer](#comment:6):\n> This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.\n> \n> Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).\n\nI'm fine with this, but should I keep a `sage.parallel.safefork` alias for backwards compatibility?  And if so, what is the best way to deprecate it?",
    "created_at": "2016-11-24T11:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309427",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jdemeyer](#comment:6):
> This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.
> 
> Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).

I'm fine with this, but should I keep a `sage.parallel.safefork` alias for backwards compatibility?  And if so, what is the best way to deprecate it?



---

archive/issue_comments_309428.json:
```json
{
    "body": "Changed branch from **[u/embray/cygwin-palp-database](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin-palp-database)** to **[u/embray/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage_interfaces_process)**",
    "created_at": "2016-11-29T13:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309428",
    "user": "https://github.com/embray"
}
```

Changed branch from **[u/embray/cygwin-palp-database](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin-palp-database)** to **[u/embray/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage_interfaces_process)**



---

archive/issue_comments_309429.json:
```json
{
    "body": "Changed commit from **[`db6085b`](https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e)** to **[`f1ecb0e`](https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49)**",
    "created_at": "2016-11-29T13:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309429",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`db6085b`](https://github.com/sagemath/sagetrac-mirror/commit/db6085b7df8080929629b4c6d1e75696ddc4d00e)** to **[`f1ecb0e`](https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49)**



---

archive/issue_events_295538.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-11-29T13:37:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295538"
}
```



---

archive/issue_events_295539.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-11-29T13:37:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295539"
}
```



---

archive/issue_comments_309430.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nAs suggested I combined the `terminate` context manager and the `ContainChildren` context manager into a single module called `sage.interfaces.process` (to me that still seems like an odd place for it but I don't have a better suggestion).\n\nStill an open question is what to do with `sage.parallel.safefork` and it should be kept for backwards compatibility?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/448a9f87d41a3424f4aaef145233dbe4f3eb4401\"><code>448a9f8</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cb3d195f1dd24ecf4ef9470f1ce703d10481b70b\"><code>cb3d195</code></a></td><td><code>Move the terminate and ContainChildren context managers into a new sage.interfaces.process module</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49\"><code>f1ecb0e</code></a></td><td><code>Updated terminate() to add a little more customizability in its behavior, with I think reasonable defaults.</code></td></tr></table>\n",
    "created_at": "2016-11-29T13:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309430",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

As suggested I combined the `terminate` context manager and the `ContainChildren` context manager into a single module called `sage.interfaces.process` (to me that still seems like an odd place for it but I don't have a better suggestion).

Still an open question is what to do with `sage.parallel.safefork` and it should be kept for backwards compatibility?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/448a9f87d41a3424f4aaef145233dbe4f3eb4401"><code>448a9f8</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cb3d195f1dd24ecf4ef9470f1ce703d10481b70b"><code>cb3d195</code></a></td><td><code>Move the terminate and ContainChildren context managers into a new sage.interfaces.process module</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49"><code>f1ecb0e</code></a></td><td><code>Updated terminate() to add a little more customizability in its behavior, with I think reasonable defaults.</code></td></tr></table>




---

archive/issue_comments_309431.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAny comments on this?  Per Jeroen's suggestion I moved the contents of `sage.parallel.safefork` into a new `sage.interfaces.process` module.  The open question for me is whether there should be a deprecation process for `sage.parallel.safefork` or if it can just be dropped entirely?",
    "created_at": "2017-01-03T11:30:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309431",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

Any comments on this?  Per Jeroen's suggestion I moved the contents of `sage.parallel.safefork` into a new `sage.interfaces.process` module.  The open question for me is whether there should be a deprecation process for `sage.parallel.safefork` or if it can just be dropped entirely?



---

archive/issue_comments_309432.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nFor me, there is no need to deprecate anything...",
    "created_at": "2017-01-03T15:55:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309432",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

For me, there is no need to deprecate anything...



---

archive/issue_comments_309433.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.",
    "created_at": "2017-01-03T15:58:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309433",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.



---

archive/issue_comments_309434.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThe docstring formatting of `terminate` is messed up: there is a stray `\"\"\"`.",
    "created_at": "2017-01-03T16:00:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309434",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

The docstring formatting of `terminate` is messed up: there is a stray `"""`.



---

archive/issue_comments_309435.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nIf `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.",
    "created_at": "2017-01-03T16:02:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309435",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.



---

archive/issue_comments_309436.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI also suggest to add the delay between closing the streams and the first killing attempt. So the result would be:\n\n1. Close streams\n\n2. Wait\n\n3. Send `SIGTERM`\n\n4. Wait\n\n5. Send `SIGKILL`",
    "created_at": "2017-01-03T16:05:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309436",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

I also suggest to add the delay between closing the streams and the first killing attempt. So the result would be:

1. Close streams

2. Wait

3. Send `SIGTERM`

4. Wait

5. Send `SIGKILL`



---

archive/issue_comments_309437.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jdemeyer](#comment:20):\n> I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.\n\nI think you're right--there's no point in resending the signal.  Either it gets handled (eventually) or is blocked forever in which case we move on to the next signal.",
    "created_at": "2017-01-03T16:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309437",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jdemeyer](#comment:20):
> I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.

I think you're right--there's no point in resending the signal.  Either it gets handled (eventually) or is blocked forever in which case we move on to the next signal.



---

archive/issue_comments_309438.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment:19):\n> For me, there is no need to deprecate anything...\n\nI ask because Sage does not have a well defined API.  I bet there are some things that if they were renamed/moved it would be a big problem.  Other things less so.  I have no way of knowing.",
    "created_at": "2017-01-03T16:29:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309438",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment:19):
> For me, there is no need to deprecate anything...

I ask because Sage does not have a well defined API.  I bet there are some things that if they were renamed/moved it would be a big problem.  Other things less so.  I have no way of knowing.



---

archive/issue_comments_309439.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment:21):\n> The docstring formatting of `terminate` is messed up: there is a stray `\"\"\"`.\n\nOops, not sure how that got there.  Must have been a stray paste last time I saved the file--it was weeks ago but I seem to recall confirming that all the tests were running and passing.",
    "created_at": "2017-01-03T16:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309439",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment:21):
> The docstring formatting of `terminate` is messed up: there is a stray `"""`.

Oops, not sure how that got there.  Must have been a stray paste last time I saved the file--it was weeks ago but I seem to recall confirming that all the tests were running and passing.



---

archive/issue_comments_309440.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:22):\n> If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.\n\nIt's not really poll() itself that has a problem, but I see what you're saying.  If the point is to immediately terminate the process rather than let it finish (assuming it hasn't already finished) then I agree, there's no reason to call poll() or wait() in the first place.  I think I kept it just going off the original code this was based on.  You still need the try/except block regardless.\n\nAlternatively, the context manager could take a timeout argument allowing the process a little more time to finish on its own, but I don't see it being needed right now.",
    "created_at": "2017-01-03T16:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309440",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:22):
> If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.

It's not really poll() itself that has a problem, but I see what you're saying.  If the point is to immediately terminate the process rather than let it finish (assuming it hasn't already finished) then I agree, there's no reason to call poll() or wait() in the first place.  I think I kept it just going off the original code this was based on.  You still need the try/except block regardless.

Alternatively, the context manager could take a timeout argument allowing the process a little more time to finish on its own, but I don't see it being needed right now.



---

archive/issue_comments_309441.json:
```json
{
    "body": "<div id=\"comment:28\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b24d072ac08859fe4b2eaa532ddda9589a3c5bcd\"><code>b24d072</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/03c5e01841d9669eb70c1b9ff09cc1d3d9748fd4\"><code>03c5e01</code></a></td><td><code>Move the terminate and ContainChildren context managers into a new sage.interfaces.process module</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/973313cfe8c24261646d3752f9245c6bcdcdbb6d\"><code>973313c</code></a></td><td><code>Updated terminate() to add a little more customizability in its behavior, with I think reasonable defaults.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b\"><code>bcbe8e9</code></a></td><td><code>some simplifications: got rid of the unecessary 'retry' option; add delay after closing streams</code></td></tr></table>\n",
    "created_at": "2017-04-11T16:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309441",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:28"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b24d072ac08859fe4b2eaa532ddda9589a3c5bcd"><code>b24d072</code></a></td><td><code>Add improved process shutdown code for PALPreader._iterate_list</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/03c5e01841d9669eb70c1b9ff09cc1d3d9748fd4"><code>03c5e01</code></a></td><td><code>Move the terminate and ContainChildren context managers into a new sage.interfaces.process module</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/973313cfe8c24261646d3752f9245c6bcdcdbb6d"><code>973313c</code></a></td><td><code>Updated terminate() to add a little more customizability in its behavior, with I think reasonable defaults.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b"><code>bcbe8e9</code></a></td><td><code>some simplifications: got rid of the unecessary 'retry' option; add delay after closing streams</code></td></tr></table>




---

archive/issue_comments_309442.json:
```json
{
    "body": "Changed commit from **[`f1ecb0e`](https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49)** to **[`bcbe8e9`](https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b)**",
    "created_at": "2017-04-11T16:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309442",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f1ecb0e`](https://github.com/sagemath/sagetrac-mirror/commit/f1ecb0ebfb6c20f22df87b6aa4dd392c76435b49)** to **[`bcbe8e9`](https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b)**



---

archive/issue_comments_309443.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nFinally updated this--I think this addresses your last comments.  I kept the `poll()` call because I want to check if the process actually ended before making other attempts.",
    "created_at": "2017-04-11T16:21:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309443",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

Finally updated this--I think this addresses your last comments.  I kept the `poll()` call because I want to check if the process actually ended before making other attempts.



---

archive/issue_events_295540.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-11T16:21:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295540"
}
```



---

archive/issue_events_295541.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-11T16:21:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295541"
}
```



---

archive/issue_comments_309444.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nDo you have a reference for this claim about `SIGHUP`?\n\n```\nit also first closes all standard I/O pipes, which should send a SIGHUP.\n```\n\nWriting to a closed pipe can give `SIGPIPE` but I don't think that just closing a pipe would send any signal.",
    "created_at": "2017-04-12T08:13:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309444",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Do you have a reference for this claim about `SIGHUP`?

```
it also first closes all standard I/O pipes, which should send a SIGHUP.
```

Writing to a closed pipe can give `SIGPIPE` but I don't think that just closing a pipe would send any signal.



---

archive/issue_comments_309445.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nYou're right, that should probably say SIGPIPE.  It *would* be SIGHUP if this were a tty but that's not the case here (I think I was working on pexect more recently so that's probably what I was thinking about).",
    "created_at": "2017-04-12T14:27:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309445",
    "user": "https://github.com/embray"
}
```

<div id="comment:31" align="right">comment:31</div>

You're right, that should probably say SIGPIPE.  It *would* be SIGHUP if this were a tty but that's not the case here (I think I was working on pexect more recently so that's probably what I was thinking about).



---

archive/issue_comments_309446.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThe `time.sleep()` is a inefficient. If the process exits after 1ms, we still have to wait 999ms to notice it.\n\nI suggest to improve this with a `SIGCHLD` handler. I have recently added code to `cysignals` to temporarily change a signal handler, so I could use that to implement the `SIGCHLD` trick.",
    "created_at": "2017-04-12T20:11:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309446",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:32" align="right">comment:32</div>

The `time.sleep()` is a inefficient. If the process exits after 1ms, we still have to wait 999ms to notice it.

I suggest to improve this with a `SIGCHLD` handler. I have recently added code to `cysignals` to temporarily change a signal handler, so I could use that to implement the `SIGCHLD` trick.



---

archive/issue_events_295542.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-12T20:11:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295542"
}
```



---

archive/issue_events_295543.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-12T20:11:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295543"
}
```



---

archive/issue_events_295544.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-13T08:50:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295544"
}
```



---

archive/issue_comments_309447.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nWorking on this...",
    "created_at": "2017-04-13T08:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309447",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

Working on this...



---

archive/issue_comments_309448.json:
```json
{
    "body": "Changed author from **Erik Bray** to **Erik Bray, Jeroen Demeyer**",
    "created_at": "2017-04-13T08:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309448",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Erik Bray** to **Erik Bray, Jeroen Demeyer**



---

archive/issue_comments_309449.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nOkay.  I see what you're saying though and I agree.",
    "created_at": "2017-04-13T09:29:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309449",
    "user": "https://github.com/embray"
}
```

<div id="comment:35" align="right">comment:35</div>

Okay.  I see what you're saying though and I agree.



---

archive/issue_comments_309450.json:
```json
{
    "body": "Changed branch from **[u/embray/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage_interfaces_process)** to **[u/jdemeyer/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/sage_interfaces_process)**",
    "created_at": "2017-04-13T10:20:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309450",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage_interfaces_process)** to **[u/jdemeyer/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/sage_interfaces_process)**



---

archive/issue_comments_309451.json:
```json
{
    "body": "Changed commit from **[`bcbe8e9`](https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b)** to **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**",
    "created_at": "2017-04-13T14:32:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309451",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`bcbe8e9`](https://github.com/sagemath/sagetrac-mirror/commit/bcbe8e90bd75c89a0a7a0bc6daed9eb8ab395a5b)** to **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**



---

archive/issue_events_295545.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-13T14:32:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295545"
}
```



---

archive/issue_events_295546.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-13T14:32:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295546"
}
```



---

archive/issue_comments_309452.json:
```json
{
    "body": "Dependencies: **#22695**",
    "created_at": "2017-04-13T14:32:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309452",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#22695**



---

archive/issue_comments_309453.json:
```json
{
    "body": "<div id=\"comment:37\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c89d7eff3178b79b8e51e221cea13ea209991422\"><code>c89d7ef</code></a></td><td><code>Fix compiler warning</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94\"><code>87623c2</code></a></td><td><code>Improve shutdown code</code></td></tr></table>\n",
    "created_at": "2017-04-13T14:32:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309453",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c89d7eff3178b79b8e51e221cea13ea209991422"><code>c89d7ef</code></a></td><td><code>Fix compiler warning</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94"><code>87623c2</code></a></td><td><code>Improve shutdown code</code></td></tr></table>




---

archive/issue_comments_309454.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nFine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?",
    "created_at": "2017-04-14T08:46:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309454",
    "user": "https://github.com/embray"
}
```

<div id="comment:38" align="right">comment:38</div>

Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?



---

archive/issue_comments_309455.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@embray](#comment:38):\n> Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?\n\nThe `t <= 4.0` part is to check that the sleep inside the `with terminate(sp, interval=5.0):` block was actually interrupted. If the interrupt didn't work, at least 5 seconds would have passed.\n\nThe `or t` part is a neat trick I learned from Robert Bradshaw. In case of a doctest failure (where `t <= 4.0` would be `False`), you see the actual value of `t` instead of just `False`.",
    "created_at": "2017-04-15T12:05:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309455",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@embray](#comment:38):
> Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?

The `t <= 4.0` part is to check that the sleep inside the `with terminate(sp, interval=5.0):` block was actually interrupted. If the interrupt didn't work, at least 5 seconds would have passed.

The `or t` part is a neat trick I learned from Robert Bradshaw. In case of a doctest failure (where `t <= 4.0` would be `False`), you see the actual value of `t` instead of just `False`.



---

archive/issue_comments_309456.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI see--it was the `or t` I didn't get.  That makes sense for a doctest.  Works for me.",
    "created_at": "2017-04-17T12:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309456",
    "user": "https://github.com/embray"
}
```

<div id="comment:40" align="right">comment:40</div>

I see--it was the `or t` I didn't get.  That makes sense for a doctest.  Works for me.



---

archive/issue_events_295547.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-17T12:38:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295547"
}
```



---

archive/issue_events_295548.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-17T12:38:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295548"
}
```



---

archive/issue_events_295549.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-17T12:49:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295549"
}
```



---

archive/issue_events_295550.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-17T12:49:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295550"
}
```



---

archive/issue_comments_309457.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nExcept--the cysignals in Sage currently does not have a `.pysignals` module.",
    "created_at": "2017-04-17T12:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309457",
    "user": "https://github.com/embray"
}
```

<div id="comment:41" align="right">comment:41</div>

Except--the cysignals in Sage currently does not have a `.pysignals` module.



---

archive/issue_comments_309458.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@embray](#comment:41):\n> Except--the cysignals in Sage currently does not have a `.pysignals` module.\n\nWell, that's why I added #22695 as dependency.",
    "created_at": "2017-04-17T16:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309458",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@embray](#comment:41):
> Except--the cysignals in Sage currently does not have a `.pysignals` module.

Well, that's why I added #22695 as dependency.



---

archive/issue_events_295551.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-17T16:34:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295551"
}
```



---

archive/issue_events_295552.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-17T16:34:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295552"
}
```



---

archive/issue_comments_309459.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nOkay I didn't see that, I'll test that in bit.",
    "created_at": "2017-04-19T09:36:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309459",
    "user": "https://github.com/embray"
}
```

<div id="comment:43" align="right">comment:43</div>

Okay I didn't see that, I'll test that in bit.



---

archive/issue_comments_309460.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReviewer name missing...",
    "created_at": "2017-04-21T22:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309460",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:44" align="right">comment:44</div>

Reviewer name missing...



---

archive/issue_events_295553.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-21T22:35:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295553"
}
```



---

archive/issue_events_295554.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-21T22:35:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295554"
}
```



---

archive/issue_events_295555.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-23T13:38:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295555"
}
```



---

archive/issue_events_295556.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-23T13:38:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295556"
}
```



---

archive/issue_comments_309461.json:
```json
{
    "body": "Reviewer: **Erik Bray, Jeroen Demeyer**",
    "created_at": "2017-04-23T13:38:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309461",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Erik Bray, Jeroen Demeyer**



---

archive/issue_comments_309462.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/sage_interfaces_process)** to **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**",
    "created_at": "2017-04-25T17:40:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/21206#issuecomment-309462",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/sage_interfaces_process](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/sage_interfaces_process)** to **[`87623c2`](https://github.com/sagemath/sagetrac-mirror/commit/87623c2f4cfee74c465000ff8df5eaf5e61e0e94)**



---

archive/issue_events_295557.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-25T17:40:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295557"
}
```



---

archive/issue_events_295558.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "33f91b532d53a28d4011c3e22d2ac6bc942cafb3",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-04-25T17:40:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/21206",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/21206#event-295558"
}
```
