# Issue 21501: Allow SAGE_LOCAL to be customized

archive/issues_021264.json:
```json
{
    "body": "This ticket allows a `$SAGE_LOCAL` directory different from `$SAGE_ROOT/local`.\n\nThe idea is that #21479 would set `$SAGE_LOCAL` to the `--prefix` chosen by the user.\n\nCC:  @mkoeppe\n\nReviewer: Matthias Koeppe\n\nAuthor: Jeroen Demeyer\n\nBranch: 64e697ddb971366afb7382d429729effa260d4a0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/21501\n\n",
    "closed_at": "2016-09-17T20:09:38Z",
    "created_at": "2016-09-15T11:07:50Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Allow SAGE_LOCAL to be customized",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21501",
    "user": "https://github.com/jdemeyer"
}
```
This ticket allows a `$SAGE_LOCAL` directory different from `$SAGE_ROOT/local`.

The idea is that #21479 would set `$SAGE_LOCAL` to the `--prefix` chosen by the user.

CC:  @mkoeppe

Reviewer: Matthias Koeppe

Author: Jeroen Demeyer

Branch: 64e697ddb971366afb7382d429729effa260d4a0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/21501





---

archive/issue_comments_396142.json:
```json
{
    "body": "<a id='comment:1'></a>that seems to make sense. but it's dangerous really. SAGE_LOCAL is an internal directory and an implementation detail currently.\n\nif you expose this, users will start expecting stuff in SAGE_LOCAL created by the build process. an ideal build process does not (will not/should not) use SAGE_LOCAL. any transition to fixing this will heavily interfere with user experience (only if they override SAGE_LOCAL, of course).\n\nok, now i explained why \"set prefix==SAGE_LOCAL\" is probably not a good idea. and here, an alternative, \"expose SAGE_LOCAL\", appears to be much worse... hmm\n\nthere's a problem here. can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?\n\nthanks",
    "created_at": "2016-09-15T11:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396142",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:1'></a>that seems to make sense. but it's dangerous really. SAGE_LOCAL is an internal directory and an implementation detail currently.

if you expose this, users will start expecting stuff in SAGE_LOCAL created by the build process. an ideal build process does not (will not/should not) use SAGE_LOCAL. any transition to fixing this will heavily interfere with user experience (only if they override SAGE_LOCAL, of course).

ok, now i explained why "set prefix==SAGE_LOCAL" is probably not a good idea. and here, an alternative, "expose SAGE_LOCAL", appears to be much worse... hmm

there's a problem here. can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?

thanks



---

archive/issue_comments_396143.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-See #21479 for the rationale.\n+This ticket allows a `$SAGE_LOCAL` directory different from `$SAGE_ROOT/local`.\n+\n+The idea is that #21479 would set `$SAGE_LOCAL` to the `--prefix` chosen by the user.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2016-09-15T13:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396143",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-See #21479 for the rationale.
+This ticket allows a `$SAGE_LOCAL` directory different from `$SAGE_ROOT/local`.
+
+The idea is that #21479 would set `$SAGE_LOCAL` to the `--prefix` chosen by the user.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_396144.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 felixs]:\n> SAGE_LOCAL is an internal directory and an implementation detail currently.\n\n\nI am not changing that. I still consider it an implementation detail.\n\n> can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?\n\n\nI am allowing Sage to be installed in a custom directory, which is not `$SAGE_ROOT/local`.",
    "created_at": "2016-09-15T13:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396144",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Replying to [comment:1 felixs]:
> SAGE_LOCAL is an internal directory and an implementation detail currently.


I am not changing that. I still consider it an implementation detail.

> can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?


I am allowing Sage to be installed in a custom directory, which is not `$SAGE_ROOT/local`.



---

archive/issue_comments_396145.json:
```json
{
    "body": "<a id='comment:3'></a>> I am allowing Sage to be installed in a custom directory,\n\n\nSAGE_LOCAL cannot be the installation directory *and* an implementation detail.\n\nbut you seem to have your own definition for both these terms, rendering this discussion pointless.",
    "created_at": "2016-09-15T13:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396145",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:3'></a>> I am allowing Sage to be installed in a custom directory,


SAGE_LOCAL cannot be the installation directory *and* an implementation detail.

but you seem to have your own definition for both these terms, rendering this discussion pointless.



---

archive/issue_comments_396146.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 felixs]:\n> > I am allowing Sage to be installed in a custom directory,\n\n> \n> SAGE_LOCAL cannot be the installation directory *and* an implementation detail.\n\n\nThe current reality is that `$SAGE_LOCAL` is the installation directory and an implementation detail. So I am really not changing that.",
    "created_at": "2016-09-15T15:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396146",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Replying to [comment:3 felixs]:
> > I am allowing Sage to be installed in a custom directory,

> 
> SAGE_LOCAL cannot be the installation directory *and* an implementation detail.


The current reality is that `$SAGE_LOCAL` is the installation directory and an implementation detail. So I am really not changing that.



---

archive/issue_comments_396147.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 jdemeyer]:\n> The current reality\n\n\nyou put \"Allow SAGE_LOCAL to be customized\" into the title. this (to me) implies that SAGE_LOCAL would become a user controlled variable (see above). i hope not! but is it really your intent?\n\ni figured, that maybe/actually/hopefully you want to introduce prefix (defaulting to $(builddir)/local), then set SAGE_LOCAL=prefix. then do some modifications so the rest of dist can cope with it.\n\nabout the title... what about \"implement pretend-prefix using SAGE_LOCAL\" or \"use SAGE_LOCAL to implement pretend-prefix\"? (yes, \"pretend\", because it will look like prefix to the user, while the build process will still write to it).",
    "created_at": "2016-09-15T16:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396147",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

<a id='comment:5'></a>Replying to [comment:4 jdemeyer]:
> The current reality


you put "Allow SAGE_LOCAL to be customized" into the title. this (to me) implies that SAGE_LOCAL would become a user controlled variable (see above). i hope not! but is it really your intent?

i figured, that maybe/actually/hopefully you want to introduce prefix (defaulting to $(builddir)/local), then set SAGE_LOCAL=prefix. then do some modifications so the rest of dist can cope with it.

about the title... what about "implement pretend-prefix using SAGE_LOCAL" or "use SAGE_LOCAL to implement pretend-prefix"? (yes, "pretend", because it will look like prefix to the user, while the build process will still write to it).



---

archive/issue_comments_396148.json:
```json
{
    "body": "<a id='comment:6'></a>Jeroen, are you working on this? \nWhich changes should go into this ticket, and which changes into #21479?",
    "created_at": "2016-09-15T16:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396148",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Jeroen, are you working on this? 
Which changes should go into this ticket, and which changes into #21479?



---

archive/issue_comments_396149.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 mkoeppe]:\n> Jeroen, are you working on this?\n\n\nYes.\n\n> Which changes should go into this ticket, and which changes into #21479?\n\n\nMy idea is that this ticket simply allows `SAGE_LOCAL` to be set to a different directory and that #21479 implements the `./configure` logic to automatically set `SAGE_LOCAL` to the `--prefix` given.",
    "created_at": "2016-09-15T16:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396149",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 mkoeppe]:
> Jeroen, are you working on this?


Yes.

> Which changes should go into this ticket, and which changes into #21479?


My idea is that this ticket simply allows `SAGE_LOCAL` to be set to a different directory and that #21479 implements the `./configure` logic to automatically set `SAGE_LOCAL` to the `--prefix` given.



---

archive/issue_comments_396150.json:
```json
{
    "body": "<a id='comment:8'></a>OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?",
    "created_at": "2016-09-15T16:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396150",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?



---

archive/issue_comments_396151.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 mkoeppe]:\n> OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?\n\n\nYes.",
    "created_at": "2016-09-15T17:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396151",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:8 mkoeppe]:
> OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?


Yes.



---

archive/issue_comments_396152.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/21501\"",
    "created_at": "2016-09-15T21:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396152",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/21501"



---

archive/issue_comments_396153.json:
```json
{
    "body": "<a id='comment:11'></a>New commits:",
    "created_at": "2016-09-15T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396153",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>New commits:



---

archive/issue_comments_396154.json:
```json
{
    "body": "Changing commit from \"\" to \"64e697ddb971366afb7382d429729effa260d4a0\"",
    "created_at": "2016-09-15T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396154",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "64e697ddb971366afb7382d429729effa260d4a0"



---

archive/issue_comments_396155.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-15T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396155",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396156.json:
```json
{
    "body": "<a id='comment:12'></a>\n```diff\n--- a/build/pkgs/autotools/spkg-write-makefile\n+++ b/build/pkgs/autotools/spkg-write-makefile\n@@ -45,8 +45,8 @@ source version-list\n # Extract upstream autotools tarball\n cd \"$SAGE_ROOT\"\n PKG=autotools-`cat build/pkgs/autotools/package-version.txt`\n-mkdir -p local/var/tmp/sage\n-cd \"$SAGE_ROOT/local/var/tmp/sage\"\n+mkdir -p \"$SAGE_LOCAL/tmp/sage\"\n+cd \"$SAGE_LOCAL/tmp/sage\"\n tar xjf \"$SAGE_ROOT/upstream/$PKG.tar.bz2\"\n cd $PKG\n```\nWas dropping \"var\" intentional?",
    "created_at": "2016-09-15T21:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396156",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
```diff
--- a/build/pkgs/autotools/spkg-write-makefile
+++ b/build/pkgs/autotools/spkg-write-makefile
@@ -45,8 +45,8 @@ source version-list
 # Extract upstream autotools tarball
 cd "$SAGE_ROOT"
 PKG=autotools-`cat build/pkgs/autotools/package-version.txt`
-mkdir -p local/var/tmp/sage
-cd "$SAGE_ROOT/local/var/tmp/sage"
+mkdir -p "$SAGE_LOCAL/tmp/sage"
+cd "$SAGE_LOCAL/tmp/sage"
 tar xjf "$SAGE_ROOT/upstream/$PKG.tar.bz2"
 cd $PKG
```
Was dropping "var" intentional?



---

archive/issue_comments_396157.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:\n> Was dropping \"var\" intentional?\n\n\nYes, it was. This is a really temporary directory. So it should be `tmp`, not `var/tmp`.",
    "created_at": "2016-09-16T05:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396157",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:
> Was dropping "var" intentional?


Yes, it was. This is a really temporary directory. So it should be `tmp`, not `var/tmp`.



---

archive/issue_comments_396158.json:
```json
{
    "body": "<a id='comment:14'></a>It seems a bit unusual, I don't think there's such a thing as a tmp directory other than `/tmp` or more precisely, whatever `mktemp(1)` provides.\n\nBut I don't insist. It's just a maintenance script for autotools, after all.",
    "created_at": "2016-09-16T06:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396158",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>It seems a bit unusual, I don't think there's such a thing as a tmp directory other than `/tmp` or more precisely, whatever `mktemp(1)` provides.

But I don't insist. It's just a maintenance script for autotools, after all.



---

archive/issue_comments_396159.json:
```json
{
    "body": "<a id='comment:15'></a>In any case, I have installed Sage with this patch to a custom `$SAGE_LOCAL` directory and all doctests pass. I also tested the command line, SageNB and the Jupyter notebook.",
    "created_at": "2016-09-16T07:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396159",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>In any case, I have installed Sage with this patch to a custom `$SAGE_LOCAL` directory and all doctests pass. I also tested the command line, SageNB and the Jupyter notebook.



---

archive/issue_comments_396160.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-16T07:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396160",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396161.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2016-09-16T07:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396161",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_events_057067.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-09-17T20:09:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21501#event-57067"
}
```



---

archive/issue_comments_396162.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-17T20:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396162",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_396163.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/21501\" to \"64e697ddb971366afb7382d429729effa260d4a0\"",
    "created_at": "2016-09-17T20:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396163",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/ticket/21501" to "64e697ddb971366afb7382d429729effa260d4a0"



---

archive/issue_comments_396164.json:
```json
{
    "body": "<a id='comment:18'></a>Interesting and I see Volker already merged it. Guys, I am expecting the link `src/doc/common/themes/sage/static/thebe.js` which is pointing to `../../../../../../local/share/thebe/thebe.js` to be dangling for you. I have no solution for you, I usually deal with those at the package manager level. Although in that particular case I just added `thebe.js` to the source in place.",
    "created_at": "2016-09-17T20:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396164",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:18'></a>Interesting and I see Volker already merged it. Guys, I am expecting the link `src/doc/common/themes/sage/static/thebe.js` which is pointing to `../../../../../../local/share/thebe/thebe.js` to be dangling for you. I have no solution for you, I usually deal with those at the package manager level. Although in that particular case I just added `thebe.js` to the source in place.



---

archive/issue_comments_396165.json:
```json
{
    "body": "Changing commit from \"64e697ddb971366afb7382d429729effa260d4a0\" to \"\"",
    "created_at": "2016-09-17T20:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396165",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "64e697ddb971366afb7382d429729effa260d4a0" to ""



---

archive/issue_comments_396166.json:
```json
{
    "body": "<a id='comment:19'></a>Oh, there's a symbolic link in our sources?",
    "created_at": "2016-09-18T05:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396166",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Oh, there's a symbolic link in our sources?



---

archive/issue_comments_396167.json:
```json
{
    "body": "<a id='comment:20'></a>I've created #21527 for this and other cleanup issues for this patch.",
    "created_at": "2016-09-18T05:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396167",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>I've created #21527 for this and other cleanup issues for this patch.



---

archive/issue_comments_396168.json:
```json
{
    "body": "<a id='comment:21'></a>This didn't exist when this ticket was created:\n\n```\n$ ls src/doc/common/themes/sage/static/thebe.js\nls: cannot access src/doc/common/themes/sage/static/thebe.js: No such file or directory\n```",
    "created_at": "2016-09-18T10:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21501#issuecomment-396168",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>This didn't exist when this ticket was created:

```
$ ls src/doc/common/themes/sage/static/thebe.js
ls: cannot access src/doc/common/themes/sage/static/thebe.js: No such file or directory
```
