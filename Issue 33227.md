# Issue 33227: get rid of some coerce_try

Issue created by migration from https://trac.sagemath.org/ticket/33464

Original creator: chapoton

Original creation time: 2022-03-05 15:59:24

CC:  tscrim

that was part of the "auld coercion systeme"


---

Comment by chapoton created at 2022-03-05 16:07:12

New commits:


---

Comment by chapoton created at 2022-03-05 16:07:12

Changing status from new to needs_review.


---

Comment by git created at 2022-03-05 16:08:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-03-06 10:02:10

green, but not sure that this is a good idea..


---

Comment by tscrim created at 2022-03-07 03:12:38

This change could have a number of unintended consequences with code in the wild. It essentially is doing some of the job via `_coerce_map_via`. I would aim to remove all of the `_coerce_try` as there are only 5 of them with the corresponding checks using `_coerce_map_via`. Technically, this is a more strict behavior because `_coerce_try` does

```
R => S -> T
```

where `=>` is a coercion and `->` is a conversion, and `_coerce_map_via` is seeing if we can do

```
R => S => T
```

Although from what I can see, the `S -> T` always has a coercion map. If we instead do the replacement I am suggesting, then there should be no behavior change and we are one step closer to fully removing the old parent/coercion system.


---

Comment by git created at 2022-03-07 07:40:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-03-07 09:12:07

well, seems to work smoothly too


---

Comment by tscrim created at 2022-03-07 10:58:10

Thank you. However, I donâ€™t think these code paths are not doctested because your change returns a map, whereas before they returned an element, and the inputs do not seem to match what the documentation of `_coerce_map_via` says.

We also will want to deprecate `_coerce_try` formally too.


---

Comment by git created at 2022-03-07 13:23:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-07 14:07:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-07 18:08:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-03-07 21:02:12

almost good.

But somebody is doing something strange with hyperelliptic curves, sigh...


---

Comment by tscrim created at 2022-03-08 01:00:55

I am curious why you have a deprecation in `parent_base.pyx` rather than replacing it with the equivalent code?

```diff
-return self._coerce_try(x,(self._base))
+return self(self._base._coerce_(x))
```

That class is there currently for backwards compatibility for the parents not yet fully to the new coercion system. I think this will take care of those deprecation messages.

I think you can also simplify this in `polynomial_quotient_ring.py`:

```diff
-return self._coerce_map_via([self.polynomial_ring()], P)(x)
+return self.coerce(self.polynomial_ring().coerce(x))
```



---

Comment by git created at 2022-03-08 07:42:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-03-08 10:01:21

and the bot is green ! Thanks a lot for the suggestions, Travis !


---

Comment by chapoton created at 2022-03-08 10:01:56

no idea on how to doctest the new deprecation, though..


---

Comment by tscrim created at 2022-03-08 11:48:07

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-03-08 11:48:07

Thank you. I think it is fine without an explicit doctest. Nobody is using it, nor should they be. I don't think it is worth the time to have a test showing the deprecation is working.


---

Comment by mkoeppe created at 2022-03-08 17:31:02


```
     def _coerce_impl(self, x):
         """
         Return the coercion of x into this polynomial quotient ring.
 
         The rings that coerce into the quotient ring canonically are:
 
         - this ring
 
         - any canonically isomorphic ring
 
         - anything that coerces into the ring of which this is the
           quotient
         """
+        P = x.parent()
         if isinstance(x, PolynomialQuotientRingElement):
-            if x.parent() == self:
+            if P == self:
                 return self.element_class(self, self.__ring(x.lift()), check=False)
```


In this change, is it allowed to assume that `x` is an `Element`?


---

Comment by mkoeppe created at 2022-03-08 17:40:37

Changing status from positive_review to needs_info.


---

Comment by git created at 2022-03-08 18:54:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2022-03-08 19:05:23

I have undone this change, and squeezed all commits into one


---

Comment by mkoeppe created at 2022-03-08 19:09:29

Changing status from needs_info to positive_review.


---

Comment by tscrim created at 2022-03-08 23:56:18

Good catch; thanks. (An alternative would be `P = parent(x)`, but since that method is also bound for the digital wastebin, we can just leave it alone.)


---

Comment by vbraun created at 2022-03-12 15:11:04

Resolution: fixed
