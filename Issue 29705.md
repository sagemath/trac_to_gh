# Issue 29705: More efficient rank and unrank for Permutations_mset

archive/issues_029705.json:
```json
{
    "body": "CC:  @slel\n\nThe [Permutations_mset](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.Permutations_mset)\n`rank` and `unrank` methods inherit a generic implementation from `EnumeratedSets`\n[rank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.rank) and\n[unrank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.unrank),\nwhich have running time proportional to the rank:\n\n\n```\nsage: mset = list(range(10)) * 3\nsage: p = Permutations(mset)\nsage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)\n1 loop, best of 5: 24.2 \u03bcs per loop\n1 loop, best of 5: 39.1 \u03bcs per loop\n1 loop, best of 5: 191 \u03bcs per loop\n1 loop, best of 5: 1.28 ms per loop\n1 loop, best of 5: 12.7 ms per loop\n1 loop, best of 5: 126 ms per loop\n1 loop, best of 5: 1.27 s per loop\n1 loop, best of 5: 13 s per loop\nsage: p.rank(list(reversed(sorted(mset))))\n... never finishes ...\n```\n\n\nThis branch makes the running time roughtly proportional to the size of the multiset:\n\n\n```\nsage: mset = list(range(10)) * 3\nsage: p = Permutations(mset)\nsage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)\n1 loop, best of 5: 1.35 ms per loop\n1 loop, best of 5: 1.43 ms per loop\n1 loop, best of 5: 1.37 ms per loop\n1 loop, best of 5: 1.37 ms per loop\n1 loop, best of 5: 2.23 ms per loop\n1 loop, best of 5: 2.12 ms per loop\n1 loop, best of 5: 1.46 ms per loop\n1 loop, best of 5: 1.44 ms per loop\nsage: timeit('p.rank(list(reversed(sorted(mset))))', number=1, repeat=5)\n1 loop, best of 5: 1.51 ms per loop\n```\n\n\n\n## Algorithm\n\nThe `rank` algorithm is a straightforward application of the solution to exercise 7.2.1.2\u20134 in\n*The Art of Computer Programming*, Volume 4A.\nI will quote the exercise:\n\n> Q. Generalizing exercise 3, explain how to compute the rank of\n>    *a*<sub>1</sub>\u2026*a*<sub>*n*</sub>\n>    with respect to Algorithm L [lexicographic permutation generation]\n>    when {*a*<sub>1</sub>, \u2026, *a*<sub>*n*</sub>} is the multiset {*n*<sub>1</sub>\u00b7*x*<sub>1</sub>, \u2026, *n*<sub>*t*</sub>\u00b7*x*<sub>*t*</sub>};\n>    here *n*<sub>1</sub> + \u2026 + *n*<sub>*t*</sub> = *n* and\n>    *x*<sub>1</sub> < \u2026 < *x*<sub>*t*</sub>. (The total number of permutations is, of course, the multinomial coefficient\n>        multinomial(*n*<sub>1</sub>, \u2026, *n*<sub>*t*</sub>) = *n*! / (*n*<sub>1</sub>! \u2026 *n*<sub>*t*</sub>!);\n>    see Eq. 5.1.2\u2013(3).) What is the rank of 314159265?\n\n> A. Use the recurrence rank(*a*<sub>1</sub> \u2026 *a*<sub>*n*</sub>) =\n>    1/*n* \u03a3<sub>j=1\u2026*t*</sub> *n*<sub>*j*</sub> [*x*<sub>*j*</sub> < *a*<sub>1</sub>] multinomial(*n*<sub>1</sub>, \u2026, *n*<sub>*t*</sub>) + rank(*a*<sub>2</sub> \u2026 *a*<sub>*n*</sub>).\n>    For example, rank(314159265) is\n>        3/9 multinomial(2, 1, 1, 1, 2, 1, 1)\n>        + 0\n>        + 2/7 multinomial(1, 1, 1, 2, 1, 1)\n>        + 0\n>        + 1/5 multinomial(1, 2, 1, 1)\n>        + 3/4 multinomial(1, 1, 1, 1)\n>        + 0\n>        + 1/2 multinomial(1, 1) = 30991.\n\nThe `unrank` algorithm is also based on this recurrence;\nhowever the application is not so straightforward.\nI did not find an explicit statement of an unranking algorithm elsewhere,\nand the algorithm I came up with isn't particularly elegant.\nI'd appreciate having another opinion on it or a pointer to some other reference.\nThe main idea is that given a rank *r* and a multiset\n*m* = {*n*<sub>1</sub>\u00b7*x*<sub>1</sub>, \u2026, *n*<sub>*t*</sub>\u00b7*x*<sub>*t*</sub>},\nwe know that\n*r* = *c*/*n* multinomial(*n*<sub>1</sub>, \u2026, *n*<sub>*t*</sub>) + rank(*m*\\*c*),\nwhere *c* is the number of elements in *m* that are strictly less than\nthe first element of the output sequence, and *m*\\*c* stands for\n*m* with one instance of the *c*th smallest element removed.\n\n\n## Notes/caveats\n\nThe `rank` method is actually independent of the `Permutations_mset` object\nit is attached to.\nOther than the `self(p).check()` line,\nit never refers to `self`.\nIt could be defined in terms of a standalone function,\nas [StandardPermutations_n.unrank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.StandardPermutations_n.unrank)\nis defined in terms of [from_rank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.from_rank).\n\nI am aware of two ways in which this branch differs in behavior from what is there now.\nThey both seem to me to be because of bugs in the `EnumeratedSets` fallback implementations,\nbut I'll document them here in case complete compatibility is needed.\n\nThe first is that the existing\n[rank](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/categories/enumerated_sets.py?h=9.1#n668)\nmethod returns `None` when passed a list or a tuple,\nbecause it uses `==` comparison with an `element_class` type\n(I'm not sure how that works exactly, but at any rate it doesn't compare equal.)\nTo get `rank` to return something other than `None`, you have to pass in\na permutation produced by the `Permutations_mset` object itself.\n\n\n```\nsage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]\nsage: p = Permutations(mset)\nsage: p.rank(mset)\nsage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])\nsage: p.unrank(3)\n[1, 1, 2, 3, 4, 5, 6, 9, 5]\nsage: type(p.unrank(3))\n<class 'sage.combinat.permutation.Permutations_mset_with_category.element_class'>\nsage: p.rank(p.unrank(3))\n3\n```\n\n\nIn this branch, the value passed to `rank` doesn't have to be an `element_class`.\n\n\n```\nsage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]\nsage: p = Permutations(mset)\nsage: p.rank(mset)\n0\nsage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])\n0\nsage: p.unrank(3)\n[1, 1, 2, 3, 4, 5, 6, 9, 5]\nsage: type(p.unrank(3))\n<class 'list'>\nsage: p.rank(p.unrank(3))\n3\n```\n\n\nThe other way in which this branch changes behavior\nis that the current code does not canonicalize the multiset\nused to create the `Permutations_mset` object.\n`Permutations([1, 1, 2, 3, 4])` and `Permutations([3, 2, 1, 4, 1])`\nvisit the same permutations but in a different order;\nthe latter acts like an already partially enumerated version of the former:\n\n\n```\nsage: Permutations([1, 1, 2, 3, 4]).unrank(0)\n[1, 1, 2, 3, 4]\nsage: Permutations([3, 2, 1, 4, 1]).unrank(0)\n[3, 2, 1, 1, 4]\n```\n\n\nIn this branch, the order of the input multiset does not make a difference:\n\n\n```\nsage: Permutations([1, 1, 2, 3, 4]).unrank(0)\n[1, 1, 2, 3, 4]\nsage: Permutations([3, 2, 1, 4, 1]).unrank(0)\n[1, 1, 2, 3, 4]\n```\n\n\nIt would be possible to work around this canonicalization, if necessary,\nby computing the rank of the input multiset on creation,\nand using it as an offset for future calls to `unrank`.\n\nI was working on a project that needed fast unranking of a multiset,\nwhen I found that Sage could not handle a multiset of the size I needed.\nI came up with [an algorithm](https://www.bamsoftware.com/comicrando/seed.html#algorithm)\nthat worked well enough for my purposes, however its ranking order is not lexicographic.\nThe algorithms in this branch are the result of a little more research\nto find a lexicographic algorithm.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29942\n\n",
    "created_at": "2020-06-23T06:43:12Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "More efficient rank and unrank for Permutations_mset",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29705",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```
CC:  @slel

The [Permutations_mset](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.Permutations_mset)
`rank` and `unrank` methods inherit a generic implementation from `EnumeratedSets`
[rank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.rank) and
[unrank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.unrank),
which have running time proportional to the rank:


```
sage: mset = list(range(10)) * 3
sage: p = Permutations(mset)
sage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)
1 loop, best of 5: 24.2 μs per loop
1 loop, best of 5: 39.1 μs per loop
1 loop, best of 5: 191 μs per loop
1 loop, best of 5: 1.28 ms per loop
1 loop, best of 5: 12.7 ms per loop
1 loop, best of 5: 126 ms per loop
1 loop, best of 5: 1.27 s per loop
1 loop, best of 5: 13 s per loop
sage: p.rank(list(reversed(sorted(mset))))
... never finishes ...
```


This branch makes the running time roughtly proportional to the size of the multiset:


```
sage: mset = list(range(10)) * 3
sage: p = Permutations(mset)
sage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)
1 loop, best of 5: 1.35 ms per loop
1 loop, best of 5: 1.43 ms per loop
1 loop, best of 5: 1.37 ms per loop
1 loop, best of 5: 1.37 ms per loop
1 loop, best of 5: 2.23 ms per loop
1 loop, best of 5: 2.12 ms per loop
1 loop, best of 5: 1.46 ms per loop
1 loop, best of 5: 1.44 ms per loop
sage: timeit('p.rank(list(reversed(sorted(mset))))', number=1, repeat=5)
1 loop, best of 5: 1.51 ms per loop
```



## Algorithm

The `rank` algorithm is a straightforward application of the solution to exercise 7.2.1.2–4 in
*The Art of Computer Programming*, Volume 4A.
I will quote the exercise:

> Q. Generalizing exercise 3, explain how to compute the rank of
>    *a*<sub>1</sub>…*a*<sub>*n*</sub>
>    with respect to Algorithm L [lexicographic permutation generation]
>    when {*a*<sub>1</sub>, …, *a*<sub>*n*</sub>} is the multiset {*n*<sub>1</sub>·*x*<sub>1</sub>, …, *n*<sub>*t*</sub>·*x*<sub>*t*</sub>};
>    here *n*<sub>1</sub> + … + *n*<sub>*t*</sub> = *n* and
>    *x*<sub>1</sub> < … < *x*<sub>*t*</sub>. (The total number of permutations is, of course, the multinomial coefficient
>        multinomial(*n*<sub>1</sub>, …, *n*<sub>*t*</sub>) = *n*! / (*n*<sub>1</sub>! … *n*<sub>*t*</sub>!);
>    see Eq. 5.1.2–(3).) What is the rank of 314159265?

> A. Use the recurrence rank(*a*<sub>1</sub> … *a*<sub>*n*</sub>) =
>    1/*n* Σ<sub>j=1…*t*</sub> *n*<sub>*j*</sub> [*x*<sub>*j*</sub> < *a*<sub>1</sub>] multinomial(*n*<sub>1</sub>, …, *n*<sub>*t*</sub>) + rank(*a*<sub>2</sub> … *a*<sub>*n*</sub>).
>    For example, rank(314159265) is
>        3/9 multinomial(2, 1, 1, 1, 2, 1, 1)
>        + 0
>        + 2/7 multinomial(1, 1, 1, 2, 1, 1)
>        + 0
>        + 1/5 multinomial(1, 2, 1, 1)
>        + 3/4 multinomial(1, 1, 1, 1)
>        + 0
>        + 1/2 multinomial(1, 1) = 30991.

The `unrank` algorithm is also based on this recurrence;
however the application is not so straightforward.
I did not find an explicit statement of an unranking algorithm elsewhere,
and the algorithm I came up with isn't particularly elegant.
I'd appreciate having another opinion on it or a pointer to some other reference.
The main idea is that given a rank *r* and a multiset
*m* = {*n*<sub>1</sub>·*x*<sub>1</sub>, …, *n*<sub>*t*</sub>·*x*<sub>*t*</sub>},
we know that
*r* = *c*/*n* multinomial(*n*<sub>1</sub>, …, *n*<sub>*t*</sub>) + rank(*m*\*c*),
where *c* is the number of elements in *m* that are strictly less than
the first element of the output sequence, and *m*\*c* stands for
*m* with one instance of the *c*th smallest element removed.


## Notes/caveats

The `rank` method is actually independent of the `Permutations_mset` object
it is attached to.
Other than the `self(p).check()` line,
it never refers to `self`.
It could be defined in terms of a standalone function,
as [StandardPermutations_n.unrank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.StandardPermutations_n.unrank)
is defined in terms of [from_rank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.from_rank).

I am aware of two ways in which this branch differs in behavior from what is there now.
They both seem to me to be because of bugs in the `EnumeratedSets` fallback implementations,
but I'll document them here in case complete compatibility is needed.

The first is that the existing
[rank](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/categories/enumerated_sets.py?h=9.1#n668)
method returns `None` when passed a list or a tuple,
because it uses `==` comparison with an `element_class` type
(I'm not sure how that works exactly, but at any rate it doesn't compare equal.)
To get `rank` to return something other than `None`, you have to pass in
a permutation produced by the `Permutations_mset` object itself.


```
sage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]
sage: p = Permutations(mset)
sage: p.rank(mset)
sage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])
sage: p.unrank(3)
[1, 1, 2, 3, 4, 5, 6, 9, 5]
sage: type(p.unrank(3))
<class 'sage.combinat.permutation.Permutations_mset_with_category.element_class'>
sage: p.rank(p.unrank(3))
3
```


In this branch, the value passed to `rank` doesn't have to be an `element_class`.


```
sage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]
sage: p = Permutations(mset)
sage: p.rank(mset)
0
sage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])
0
sage: p.unrank(3)
[1, 1, 2, 3, 4, 5, 6, 9, 5]
sage: type(p.unrank(3))
<class 'list'>
sage: p.rank(p.unrank(3))
3
```


The other way in which this branch changes behavior
is that the current code does not canonicalize the multiset
used to create the `Permutations_mset` object.
`Permutations([1, 1, 2, 3, 4])` and `Permutations([3, 2, 1, 4, 1])`
visit the same permutations but in a different order;
the latter acts like an already partially enumerated version of the former:


```
sage: Permutations([1, 1, 2, 3, 4]).unrank(0)
[1, 1, 2, 3, 4]
sage: Permutations([3, 2, 1, 4, 1]).unrank(0)
[3, 2, 1, 1, 4]
```


In this branch, the order of the input multiset does not make a difference:


```
sage: Permutations([1, 1, 2, 3, 4]).unrank(0)
[1, 1, 2, 3, 4]
sage: Permutations([3, 2, 1, 4, 1]).unrank(0)
[1, 1, 2, 3, 4]
```


It would be possible to work around this canonicalization, if necessary,
by computing the rank of the input multiset on creation,
and using it as an offset for future calls to `unrank`.

I was working on a project that needed fast unranking of a multiset,
when I found that Sage could not handle a multiset of the size I needed.
I came up with [an algorithm](https://www.bamsoftware.com/comicrando/seed.html#algorithm)
that worked well enough for my purposes, however its ranking order is not lexicographic.
The algorithms in this branch are the result of a little more research
to find a lexicographic algorithm.

Issue created by migration from https://trac.sagemath.org/ticket/29942





---

archive/issue_comments_421482.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-23T06:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421482",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421483.json:
```json
{
    "body": "The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.\n\nsee https://doc.sagemath.org/html/en/developer/coding_basics.html#template",
    "created_at": "2020-06-23T07:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421483",
    "user": "https://github.com/fchapoton"
}
```

The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.

see https://doc.sagemath.org/html/en/developer/coding_basics.html#template



---

archive/issue_comments_421484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-23T14:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421485.json:
```json
{
    "body": "Replying to [comment:2 chapoton]:\n> The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.\n\nThanks. I fixed the formatting in [9b9d936](https://git.sagemath.org/sage.git/commit/?id=9b9d936081bc4b04d5476ce4c4e54af0997a9295). I can see the difference with `sage --docbuild --include-tests-blocks`.",
    "created_at": "2020-06-23T14:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421485",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```

Replying to [comment:2 chapoton]:
> The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.

Thanks. I fixed the formatting in [9b9d936](https://git.sagemath.org/sage.git/commit/?id=9b9d936081bc4b04d5476ce4c4e54af0997a9295). I can see the difference with `sage --docbuild --include-tests-blocks`.



---

archive/issue_comments_421486.json:
```json
{
    "body": "A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size such that\n\n```python\nfor i, p in enumerate(X):\n    assert X.rank(p) == i\n    assert X.unrank(i) == p\n```\n",
    "created_at": "2020-06-25T23:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421486",
    "user": "https://github.com/tscrim"
}
```

A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size such that

```python
for i, p in enumerate(X):
    assert X.rank(p) == i
    assert X.unrank(i) == p
```




---

archive/issue_comments_421487.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-27T19:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421487",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421488.json:
```json
{
    "body": "Replying to [comment:6 tscrim]:\n> A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size\n\nI did so in [4adb8a](https://git.sagemath.org/sage.git/commit/?id=a4adb8a15db91dfdec4d9fe43e3826397c47e607) over the multiset `[2, 2, 3, 3, 3, 5, 5, 5, 5, 5]`, which has 2520 permutations. (I wasn't sure what a reasonable size for a test case would be.) In the same loop, I added a check for lexicographic ordering. I had to convert the permutations from a `list` to a `tuple` to facilitate comparison.",
    "created_at": "2020-06-27T19:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421488",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```

Replying to [comment:6 tscrim]:
> A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size

I did so in [4adb8a](https://git.sagemath.org/sage.git/commit/?id=a4adb8a15db91dfdec4d9fe43e3826397c47e607) over the multiset `[2, 2, 3, 3, 3, 5, 5, 5, 5, 5]`, which has 2520 permutations. (I wasn't sure what a reasonable size for a test case would be.) In the same loop, I added a check for lexicographic ordering. I had to convert the permutations from a `list` to a `tuple` to facilitate comparison.



---

archive/issue_comments_421489.json:
```json
{
    "body": "I think that is a reasonable size; thank you.\n\nI just have three more minor changes:\n\n```diff\n-        - ``p`` -- a permutation of `M`.\n+        - ``p`` -- a permutation of `M`\n```\n\n\n```diff\n         - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``\n-          inclusive.\n+          inclusive\n```\n\nUpdate the Knuth reference based off #30005.\n\nSomething that is stylistic, so it is up to you if you want to change it, but I would change the\n\n```\n-Some sentence explanation. ::\n+Some sentence explanation::\n```\n\nto have it end each block with a colon as the code is better associated with the sentence. However, that is something you can ignore.\n\nFr\u00e9d\u00e9ric, do you have any other comments?",
    "created_at": "2020-07-01T08:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421489",
    "user": "https://github.com/tscrim"
}
```

I think that is a reasonable size; thank you.

I just have three more minor changes:

```diff
-        - ``p`` -- a permutation of `M`.
+        - ``p`` -- a permutation of `M`
```


```diff
         - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``
-          inclusive.
+          inclusive
```

Update the Knuth reference based off #30005.

Something that is stylistic, so it is up to you if you want to change it, but I would change the

```
-Some sentence explanation. ::
+Some sentence explanation::
```

to have it end each block with a colon as the code is better associated with the sentence. However, that is something you can ignore.

Frédéric, do you have any other comments?



---

archive/issue_comments_421490.json:
```json
{
    "body": "ok, looks good to me too. The patchbot warning are false-positive. Once Travis suggestions are fixed, this can be set to positive and will be a very nice improvement.",
    "created_at": "2020-07-01T20:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421490",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good to me too. The patchbot warning are false-positive. Once Travis suggestions are fixed, this can be set to positive and will be a very nice improvement.



---

archive/issue_comments_421491.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-04T17:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421491",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421492.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> {{{#!diff\n> -        - ``p`` -- a permutation of `M`.\n> +        - ``p`` -- a permutation of `M`\n> }}}\n> {{{#!diff\n>          - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``\n> -          inclusive.\n> +          inclusive\n> }}}\n> \n> {{{\n> -Some sentence explanation. ::\n> +Some sentence explanation::\n> }}}\n\nI made these changes in [\u200ba694a35](https://git.sagemath.org/sage.git/commit/?id=a694a352f26f0c6236334f485a6c0e7237eecabc).\n\n> Update the Knuth reference based off #30005.\n\nIt seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 \"[Knu2011]\"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?",
    "created_at": "2020-07-04T17:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421492",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```

Replying to [comment:9 tscrim]:
> {{{#!diff
> -        - ``p`` -- a permutation of `M`.
> +        - ``p`` -- a permutation of `M`
> }}}
> {{{#!diff
>          - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``
> -          inclusive.
> +          inclusive
> }}}
> 
> {{{
> -Some sentence explanation. ::
> +Some sentence explanation::
> }}}

I made these changes in [​a694a35](https://git.sagemath.org/sage.git/commit/?id=a694a352f26f0c6236334f485a6c0e7237eecabc).

> Update the Knuth reference based off #30005.

It seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 "[Knu2011]"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?



---

archive/issue_comments_421493.json:
```json
{
    "body": "Replying to [comment:12 dcfifield]:\n> Replying to [comment:9 tscrim]:\n> > Update the Knuth reference based off #30005.\n> \n> It seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 \"[Knu2011]\"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?\n\nYou merge in the branch from #30005 into this one and set it as a dependency in the ticket. Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.",
    "created_at": "2020-07-04T21:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421493",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:12 dcfifield]:
> Replying to [comment:9 tscrim]:
> > Update the Knuth reference based off #30005.
> 
> It seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 "[Knu2011]"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?

You merge in the branch from #30005 into this one and set it as a dependency in the ticket. Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.



---

archive/issue_comments_421494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-04T23:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421495.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> You merge in the branch from #30005 into this one and set it as a dependency in the ticket.\n\nThanks for your guidance. I've merged #30005 into this branch and made it a dependency.\n\n> Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.\n\nIt was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.",
    "created_at": "2020-07-04T23:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421495",
    "user": "https://trac.sagemath.org/admin/accounts/users/dcfifield"
}
```

Replying to [comment:13 tscrim]:
> You merge in the branch from #30005 into this one and set it as a dependency in the ticket.

Thanks for your guidance. I've merged #30005 into this branch and made it a dependency.

> Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.

It was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.



---

archive/issue_comments_421496.json:
```json
{
    "body": "Replying to [comment:15 dcfifield]:\n> Replying to [comment:13 tscrim]:\n> > Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.\n> \n> It was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.\n\nThe reason I was saying that was because #30005 was positively reviewed (and not clear there should be a dependency relation). However, I am happy with the changes here. I will just wait for the patchbot one more time.",
    "created_at": "2020-07-04T23:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421496",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:15 dcfifield]:
> Replying to [comment:13 tscrim]:
> > Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.
> 
> It was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.

The reason I was saying that was because #30005 was positively reviewed (and not clear there should be a dependency relation). However, I am happy with the changes here. I will just wait for the patchbot one more time.



---

archive/issue_comments_421497.json:
```json
{
    "body": "Finished testing locally. LGTM.",
    "created_at": "2020-07-06T00:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421497",
    "user": "https://github.com/tscrim"
}
```

Finished testing locally. LGTM.



---

archive/issue_comments_421498.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-06T00:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421498",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_027398.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-07-10T19:33:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29705#event-27398"
}
```



---

archive/issue_comments_421499.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-10T19:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29705",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29705#issuecomment-421499",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
