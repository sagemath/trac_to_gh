# Issue 29705: More efficient rank and unrank for Permutations_mset

Issue created by migration from https://trac.sagemath.org/ticket/29942

Original creator: dcfifield

Original creation time: 2020-06-23 06:43:12

CC:  slelievre

The [Permutations_mset](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.Permutations_mset)
`rank` and `unrank` methods inherit a generic implementation from `EnumeratedSets`
[rank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.rank) and
[unrank](https://doc.sagemath.org/html/en/reference/categories/sage/categories/enumerated_sets.html#sage.categories.enumerated_sets.EnumeratedSets.ParentMethods.unrank),
which have running time proportional to the rank:


```
sage: mset = list(range(10)) * 3
sage: p = Permutations(mset)
sage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)
1 loop, best of 5: 24.2 μs per loop
1 loop, best of 5: 39.1 μs per loop
1 loop, best of 5: 191 μs per loop
1 loop, best of 5: 1.28 ms per loop
1 loop, best of 5: 12.7 ms per loop
1 loop, best of 5: 126 ms per loop
1 loop, best of 5: 1.27 s per loop
1 loop, best of 5: 13 s per loop
sage: p.rank(list(reversed(sorted(mset))))
... never finishes ...
```


This branch makes the running time roughtly proportional to the size of the multiset:


```
sage: mset = list(range(10)) * 3
sage: p = Permutations(mset)
sage: for e in range(8): timeit('p.unrank({})'.format(10^e), number=1, repeat=5)
1 loop, best of 5: 1.35 ms per loop
1 loop, best of 5: 1.43 ms per loop
1 loop, best of 5: 1.37 ms per loop
1 loop, best of 5: 1.37 ms per loop
1 loop, best of 5: 2.23 ms per loop
1 loop, best of 5: 2.12 ms per loop
1 loop, best of 5: 1.46 ms per loop
1 loop, best of 5: 1.44 ms per loop
sage: timeit('p.rank(list(reversed(sorted(mset))))', number=1, repeat=5)
1 loop, best of 5: 1.51 ms per loop
```



## Algorithm

The `rank` algorithm is a straightforward application of the solution to exercise 7.2.1.2–4 in
_The Art of Computer Programming_, Volume 4A.
I will quote the exercise:

> Q. Generalizing exercise 3, explain how to compute the rank of
>    _a_<sub>1</sub>…_a_<sub>_n_</sub>
>    with respect to Algorithm L [lexicographic permutation generation]
>    when {_a_<sub>1</sub>, …, _a_<sub>_n_</sub>} is the multiset {_n_<sub>1</sub>·_x_<sub>1</sub>, …, _n_<sub>_t_</sub>·_x_<sub>_t_</sub>};
>    here _n_<sub>1</sub> + … + _n_<sub>_t_</sub> = _n_ and
>    _x_<sub>1</sub> < … < _x_<sub>_t_</sub>. (The total number of permutations is, of course, the multinomial coefficient
>        multinomial(_n_<sub>1</sub>, …, _n_<sub>_t_</sub>) = _n_! / (_n_<sub>1</sub>! … _n_<sub>_t_</sub>!);
>    see Eq. 5.1.2–(3).) What is the rank of 314159265?

> A. Use the recurrence rank(_a_<sub>1</sub> … _a_<sub>_n_</sub>) =
>    1/_n_ Σ<sub>j=1…_t_</sub> _n_<sub>_j_</sub> [_x_<sub>_j_</sub> < _a_<sub>1</sub>] multinomial(_n_<sub>1</sub>, …, _n_<sub>_t_</sub>) + rank(_a_<sub>2</sub> … _a_<sub>_n_</sub>).
>    For example, rank(314159265) is
>        3/9 multinomial(2, 1, 1, 1, 2, 1, 1)
>        + 0
>        + 2/7 multinomial(1, 1, 1, 2, 1, 1)
>        + 0
>        + 1/5 multinomial(1, 2, 1, 1)
>        + 3/4 multinomial(1, 1, 1, 1)
>        + 0
>        + 1/2 multinomial(1, 1) = 30991.

The `unrank` algorithm is also based on this recurrence;
however the application is not so straightforward.
I did not find an explicit statement of an unranking algorithm elsewhere,
and the algorithm I came up with isn't particularly elegant.
I'd appreciate having another opinion on it or a pointer to some other reference.
The main idea is that given a rank _r_ and a multiset
_m_ = {_n_<sub>1</sub>·_x_<sub>1</sub>, …, _n_<sub>_t_</sub>·_x_<sub>_t_</sub>},
we know that
_r_ = _c_/_n_ multinomial(_n_<sub>1</sub>, …, _n_<sub>_t_</sub>) + rank(_m_\_c_),
where _c_ is the number of elements in _m_ that are strictly less than
the first element of the output sequence, and _m_\_c_ stands for
_m_ with one instance of the _c_th smallest element removed.


## Notes/caveats

The `rank` method is actually independent of the `Permutations_mset` object
it is attached to.
Other than the `self(p).check()` line,
it never refers to `self`.
It could be defined in terms of a standalone function,
as [StandardPermutations_n.unrank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.StandardPermutations_n.unrank)
is defined in terms of [from_rank](https://doc.sagemath.org/html/en/reference/combinat/sage/combinat/permutation.html#sage.combinat.permutation.from_rank).

I am aware of two ways in which this branch differs in behavior from what is there now.
They both seem to me to be because of bugs in the `EnumeratedSets` fallback implementations,
but I'll document them here in case complete compatibility is needed.

The first is that the existing
[rank](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/categories/enumerated_sets.py?h=9.1#n668)
method returns `None` when passed a list or a tuple,
because it uses `==` comparison with an `element_class` type
(I'm not sure how that works exactly, but at any rate it doesn't compare equal.)
To get `rank` to return something other than `None`, you have to pass in
a permutation produced by the `Permutations_mset` object itself.


```
sage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]
sage: p = Permutations(mset)
sage: p.rank(mset)
sage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])
sage: p.unrank(3)
[1, 1, 2, 3, 4, 5, 6, 9, 5]
sage: type(p.unrank(3))
<class 'sage.combinat.permutation.Permutations_mset_with_category.element_class'>
sage: p.rank(p.unrank(3))
3
```


In this branch, the value passed to `rank` doesn't have to be an `element_class`.


```
sage: mset = [1, 1, 2, 3, 4, 5, 5, 6, 9]
sage: p = Permutations(mset)
sage: p.rank(mset)
0
sage: p.rank([1, 1, 2, 3, 4, 5, 5, 6, 9])
0
sage: p.unrank(3)
[1, 1, 2, 3, 4, 5, 6, 9, 5]
sage: type(p.unrank(3))
<class 'list'>
sage: p.rank(p.unrank(3))
3
```


The other way in which this branch changes behavior
is that the current code does not canonicalize the multiset
used to create the `Permutations_mset` object.
`Permutations([1, 1, 2, 3, 4])` and `Permutations([3, 2, 1, 4, 1])`
visit the same permutations but in a different order;
the latter acts like an already partially enumerated version of the former:


```
sage: Permutations([1, 1, 2, 3, 4]).unrank(0)
[1, 1, 2, 3, 4]
sage: Permutations([3, 2, 1, 4, 1]).unrank(0)
[3, 2, 1, 1, 4]
```


In this branch, the order of the input multiset does not make a difference:


```
sage: Permutations([1, 1, 2, 3, 4]).unrank(0)
[1, 1, 2, 3, 4]
sage: Permutations([3, 2, 1, 4, 1]).unrank(0)
[1, 1, 2, 3, 4]
```


It would be possible to work around this canonicalization, if necessary,
by computing the rank of the input multiset on creation,
and using it as an offset for future calls to `unrank`.

I was working on a project that needed fast unranking of a multiset,
when I found that Sage could not handle a multiset of the size I needed.
I came up with [an algorithm](https://www.bamsoftware.com/comicrando/seed.html#algorithm)
that worked well enough for my purposes, however its ranking order is not lexicographic.
The algorithms in this branch are the result of a little more research
to find a lexicographic algorithm.


---

Comment by dcfifield created at 2020-06-23 06:44:28

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-06-23 07:11:17

The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.

see https://doc.sagemath.org/html/en/developer/coding_basics.html#template


---

Comment by git created at 2020-06-23 14:22:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcfifield created at 2020-06-23 14:26:19

Replying to [comment:2 chapoton]:
> The documentation is not formatted correctly. Each time you insert a sentence or TEST between two blocks of tests, it should end with `::` unless there is another sentence just after.

Thanks. I fixed the formatting in [9b9d936](https://git.sagemath.org/sage.git/commit/?id=9b9d936081bc4b04d5476ce4c4e54af0997a9295). I can see the difference with `sage --docbuild --include-tests-blocks`.


---

Comment by tscrim created at 2020-06-25 23:55:46

A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size such that

```python
for i, p in enumerate(X):
    assert X.rank(p) == i
    assert X.unrank(i) == p
```



---

Comment by git created at 2020-06-27 19:41:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcfifield created at 2020-06-27 19:48:49

Replying to [comment:6 tscrim]:
> A quick comment for testing coverage. I would add an exhaustive test on something `X` of reasonable size

I did so in [4adb8a](https://git.sagemath.org/sage.git/commit/?id=a4adb8a15db91dfdec4d9fe43e3826397c47e607) over the multiset `[2, 2, 3, 3, 3, 5, 5, 5, 5, 5]`, which has 2520 permutations. (I wasn't sure what a reasonable size for a test case would be.) In the same loop, I added a check for lexicographic ordering. I had to convert the permutations from a `list` to a `tuple` to facilitate comparison.


---

Comment by tscrim created at 2020-07-01 08:00:57

I think that is a reasonable size; thank you.

I just have three more minor changes:

```diff
-        - ``p`` -- a permutation of `M`.
+        - ``p`` -- a permutation of `M`
```


```diff
         - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``
-          inclusive.
+          inclusive
```

Update the Knuth reference based off #30005.

Something that is stylistic, so it is up to you if you want to change it, but I would change the

```
-Some sentence explanation. ::
+Some sentence explanation::
```

to have it end each block with a colon as the code is better associated with the sentence. However, that is something you can ignore.

Frédéric, do you have any other comments?


---

Comment by chapoton created at 2020-07-01 20:00:18

ok, looks good to me too. The patchbot warning are false-positive. Once Travis suggestions are fixed, this can be set to positive and will be a very nice improvement.


---

Comment by git created at 2020-07-04 17:33:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcfifield created at 2020-07-04 17:46:51

Replying to [comment:9 tscrim]:
> {{{#!diff
> -        - ``p`` -- a permutation of `M`.
> +        - ``p`` -- a permutation of `M`
> }}}
> {{{#!diff
>          - ``r`` -- an integer between ``0`` and ``self.cardinality()-1``
> -          inclusive.
> +          inclusive
> }}}
> 
> {{{
> -Some sentence explanation. ::
> +Some sentence explanation::
> }}}

I made these changes in [​a694a35](https://git.sagemath.org/sage.git/commit/?id=a694a352f26f0c6236334f485a6c0e7237eecabc).

> Update the Knuth reference based off #30005.

It seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 "[Knu2011]"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?


---

Comment by tscrim created at 2020-07-04 21:53:37

Replying to [comment:12 dcfifield]:
> Replying to [comment:9 tscrim]:
> > Update the Knuth reference based off #30005.
> 
> It seems the right way to handle this is to remove the [REFERENCES](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/combinat/gray_codes.py?h=b45d5fb82ba163f5df09223cfc27327dd0b58f44#n4) section from gray_codes.py, containing the [Knuth-TAOCP4A] reference used in that file only, and update [Knuth-TAOCP4A] references to point to the new [https://github.com/sagemath/sagetrac-mirror/blob/master/src/doc/en/reference/references/index.rst?id=a694a352f26f0c6236334f485a6c0e7237eecabc#n3216 "[Knu2011]"] in references/index.rst. But #30005 is not merged yet and [Knu2011] does not exist in its branch; while modifying gray_codes.py in this branch may prevent #30005 from merging cleanly. How should I handle this?

You merge in the branch from #30005 into this one and set it as a dependency in the ticket. Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.


---

Comment by git created at 2020-07-04 23:22:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcfifield created at 2020-07-04 23:28:10

Replying to [comment:13 tscrim]:
> You merge in the branch from #30005 into this one and set it as a dependency in the ticket.

Thanks for your guidance. I've merged #30005 into this branch and made it a dependency.

> Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.

It was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.


---

Comment by tscrim created at 2020-07-04 23:39:45

Replying to [comment:15 dcfifield]:
> Replying to [comment:13 tscrim]:
> > Actually, you probably should remove that reference on this ticket (again, after merging in #30005) and use the one in the master reference file.
> 
> It was actually the other way around. It is this ticket (#29942) that adds a reference to the master reference file, and #30005 that used a REFERENCES section local to gray_codes.py. In [141f9a9](https://git.sagemath.org/sage.git/commit/?id=141f9a97c16facf1780bf14402915d68d814f354) I edited gray_codes.py to point to the master reference file.

The reason I was saying that was because #30005 was positively reviewed (and not clear there should be a dependency relation). However, I am happy with the changes here. I will just wait for the patchbot one more time.


---

Comment by tscrim created at 2020-07-06 00:13:53

Finished testing locally. LGTM.


---

Comment by tscrim created at 2020-07-06 00:13:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-10 19:33:49

Resolution: fixed
