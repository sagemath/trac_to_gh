# Issue 30406: cygwin-minimal: scipy build fails: 'u_int' has not been declared

archive/issues_030406.json:
```json
{
    "body": "CC:  @embray @darijgr @slel @tscrim\n\nhttps://github.com/mkoeppe/sage/runs/1153050152\n\n```\nIn file included from /usr/include/sys/config.h:5,\n                   from /usr/include/_ansi.h:11,\n                   from /usr/include/sys/reent.h:13,\n                   from /usr/include/math.h:5,\n                   from /usr/lib/gcc/x86_64-pc-cygwin/10/include/c++/cmath:45,\n                   from scipy/spatial/ckdtree/src/query.cxx:1:\n  /usr/include/sys/features.h:255: note: this is the location of the previous definition\n    255 | #define __BSD_VISIBLE  0\n        |\n  In file included from /cygdrive/d/a/sage/sage/local/include/python3.8/pyport.h:219,\n                   from /cygdrive/d/a/sage/sage/local/include/python3.8/Python.h:63,\n                   from /cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include/numpy/npy_common.h:11,\n                   from scipy/spatial/ckdtree/src/ckdtree_decl.h:10,\n                   from scipy/spatial/ckdtree/src/query.cxx:13:\n  /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared\n    106 | bintime_mul(struct bintime *_bt, u_int _x)\n        |                                  ^~~~~\n  g++: scipy/spatial/ckdtree/src/build.cxx\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30643\n\n",
    "created_at": "2020-09-23T12:17:57Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "cygwin-minimal: scipy build fails: 'u_int' has not been declared",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30406",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @embray @darijgr @slel @tscrim

https://github.com/mkoeppe/sage/runs/1153050152

```
In file included from /usr/include/sys/config.h:5,
                   from /usr/include/_ansi.h:11,
                   from /usr/include/sys/reent.h:13,
                   from /usr/include/math.h:5,
                   from /usr/lib/gcc/x86_64-pc-cygwin/10/include/c++/cmath:45,
                   from scipy/spatial/ckdtree/src/query.cxx:1:
  /usr/include/sys/features.h:255: note: this is the location of the previous definition
    255 | #define __BSD_VISIBLE  0
        |
  In file included from /cygdrive/d/a/sage/sage/local/include/python3.8/pyport.h:219,
                   from /cygdrive/d/a/sage/sage/local/include/python3.8/Python.h:63,
                   from /cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include/numpy/npy_common.h:11,
                   from scipy/spatial/ckdtree/src/ckdtree_decl.h:10,
                   from scipy/spatial/ckdtree/src/query.cxx:13:
  /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared
    106 | bintime_mul(struct bintime *_bt, u_int _x)
        |                                  ^~~~~
  g++: scipy/spatial/ckdtree/src/build.cxx
```


Issue created by migration from https://trac.sagemath.org/ticket/30643





---

archive/issue_comments_433217.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-10-01T03:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433217",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_433218.json:
```json
{
    "body": "This build problem that we see on the CI infrastructure could use help from a real Cygwin user",
    "created_at": "2020-10-02T18:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433218",
    "user": "https://github.com/mkoeppe"
}
```

This build problem that we see on the CI infrastructure could use help from a real Cygwin user



---

archive/issue_comments_433219.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-10-08T17:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433219",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_433220.json:
```json
{
    "body": "Possibly relevant: https://stackoverflow.com/questions/39786845/cygwin-g-compiling-with-python-h-duplicated-definition-of-bsd-visible",
    "created_at": "2020-10-10T23:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433220",
    "user": "https://github.com/vbraun"
}
```

Possibly relevant: https://stackoverflow.com/questions/39786845/cygwin-g-compiling-with-python-h-duplicated-definition-of-bsd-visible



---

archive/issue_comments_433221.json:
```json
{
    "body": "What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.\n\nI'm still on an older version that doesn't have this problem:\n\n\n```\n$ uname -a\nCYGWIN_NT-10.0 <Hostname> 3.0.7(0.338/5/3) 2019-04-30 18:08 x86_64 Cygwin\n```\n",
    "created_at": "2020-10-13T14:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433221",
    "user": "https://github.com/embray"
}
```

What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.

I'm still on an older version that doesn't have this problem:


```
$ uname -a
CYGWIN_NT-10.0 <Hostname> 3.0.7(0.338/5/3) 2019-04-30 18:08 x86_64 Cygwin
```




---

archive/issue_comments_433222.json:
```json
{
    "body": "I've seen issues like this before.  The problem is visible in this line from the log:\n\n\n```\n  [scipy-1.5.2]     error: Command \"g++ -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/cygdrive/d/a/sage/sage/local/include/python3.8 -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -Iscipy/_lib -Iscipy/_build_utils/src -Iscipy/spatial/ckdtree/src -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -I/cygdrive/d/a/sage/sage/local/include/python3.8 -c scipy/spatial/ckdtree/src/query.cxx -o build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o -MMD -MF build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o.d -std=c++14\" failed with exit status 1\n```\n\n\nIn Cygwin's libc, `__BSD_VISIBLE = 0` by default, because when using `-std=c[++]<nn>` flags it defined `__STRICT_ANSI__` and non-ANSI C extensions are not declared as you can see with the following test program:\n\n\n```\n$ cat bsd_visible.c\n#include <stdio.h>\n#include <sys/features.h>\n\n#if defined(__STRICT_ANSI__)\n#define DEFINED__STRICT_ANSI__ 1\n#else\n#define DEFINED__STRICT_ANSI__ 0\n#endif\n\nint main(void) {\n    printf(\"defined(__STRICT_ANSI__) = %d\\n\", DEFINED__STRICT_ANSI__);\n    printf(\"__BSD_VISIBLE = %d\\n\", __BSD_VISIBLE);\n    return 0;\n}\n```\n\n\n\n```\n$ g++ -std=c++14 bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 1\n__BSD_VISIBLE = 0\n```\n\n\n\nHowever, if you compile with `-std=gnu[++]<nn>` the \"kitchen sink\" is enabled:\n\n\n```\n$ g++ -std=gnu++14 bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 0\n__BSD_VISIBLE = 1\n```\n\n\nYou can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:\n\n\n```\n$ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 1\n__BSD_VISIBLE = 1\n```\n",
    "created_at": "2020-10-13T15:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433222",
    "user": "https://github.com/embray"
}
```

I've seen issues like this before.  The problem is visible in this line from the log:


```
  [scipy-1.5.2]     error: Command "g++ -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/cygdrive/d/a/sage/sage/local/include/python3.8 -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -Iscipy/_lib -Iscipy/_build_utils/src -Iscipy/spatial/ckdtree/src -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -I/cygdrive/d/a/sage/sage/local/include/python3.8 -c scipy/spatial/ckdtree/src/query.cxx -o build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o -MMD -MF build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o.d -std=c++14" failed with exit status 1
```


In Cygwin's libc, `__BSD_VISIBLE = 0` by default, because when using `-std=c[++]<nn>` flags it defined `__STRICT_ANSI__` and non-ANSI C extensions are not declared as you can see with the following test program:


```
$ cat bsd_visible.c
#include <stdio.h>
#include <sys/features.h>

#if defined(__STRICT_ANSI__)
#define DEFINED__STRICT_ANSI__ 1
#else
#define DEFINED__STRICT_ANSI__ 0
#endif

int main(void) {
    printf("defined(__STRICT_ANSI__) = %d\n", DEFINED__STRICT_ANSI__);
    printf("__BSD_VISIBLE = %d\n", __BSD_VISIBLE);
    return 0;
}
```



```
$ g++ -std=c++14 bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 1
__BSD_VISIBLE = 0
```



However, if you compile with `-std=gnu[++]<nn>` the "kitchen sink" is enabled:


```
$ g++ -std=gnu++14 bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 0
__BSD_VISIBLE = 1
```


You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:


```
$ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 1
__BSD_VISIBLE = 1
```




---

archive/issue_comments_433223.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.\n\nThe GH runs always use the most current version. I was not able to reproduce the error on my Windows 10 tablet (both with Cygwin 3.1.4 and after upgrading to the current 3.1.7). So whether the error shows up seems to depend in a subtle way on the list of Cygwin packages installed. I'm investigating this at the moment.",
    "created_at": "2020-10-13T16:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433223",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 embray]:
> What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.

The GH runs always use the most current version. I was not able to reproduce the error on my Windows 10 tablet (both with Cygwin 3.1.4 and after upgrading to the current 3.1.7). So whether the error shows up seems to depend in a subtle way on the list of Cygwin packages installed. I'm investigating this at the moment.



---

archive/issue_comments_433224.json:
```json
{
    "body": "It would most likely be caused by something that changed in newlib.  I can't see any obvious culprits in the the history.  But in fact it seems like what was changed was actually fixing something that shouldn't have worked in the first place.  Once of the workarounds I suggested above should be used.",
    "created_at": "2020-10-13T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433224",
    "user": "https://github.com/embray"
}
```

It would most likely be caused by something that changed in newlib.  I can't see any obvious culprits in the the history.  But in fact it seems like what was changed was actually fixing something that shouldn't have worked in the first place.  Once of the workarounds I suggested above should be used.



---

archive/issue_comments_433225.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:\n> \n> {{{\n> $ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible\n> $ ./bsd_visible.exe\n> defined(__STRICT_ANSI__) = 1\n> __BSD_VISIBLE = 1\n> }}}\n\nThanks a lot. I'm trying this solution now. Let's see how this goes.\n\n----\nNew commits:",
    "created_at": "2020-10-13T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433225",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 embray]:
> You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:
> 
> {{{
> $ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible
> $ ./bsd_visible.exe
> defined(__STRICT_ANSI__) = 1
> __BSD_VISIBLE = 1
> }}}

Thanks a lot. I'm trying this solution now. Let's see how this goes.

----
New commits:



---

archive/issue_comments_433226.json:
```json
{
    "body": "This seems to have done the trick. See https://github.com/mkoeppe/sage/runs/1250401299?check_suite_focus=true",
    "created_at": "2020-10-14T05:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433226",
    "user": "https://github.com/mkoeppe"
}
```

This seems to have done the trick. See https://github.com/mkoeppe/sage/runs/1250401299?check_suite_focus=true



---

archive/issue_comments_433227.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-14T05:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433227",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_433228.json:
```json
{
    "body": "Great!",
    "created_at": "2020-10-14T12:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433228",
    "user": "https://github.com/embray"
}
```

Great!



---

archive/issue_comments_433229.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-14T12:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433229",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_433230.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-10-18T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30406#issuecomment-433230",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_027939.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-10-18T08:38:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30406",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30406#event-27939"
}
```
