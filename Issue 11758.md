# Issue 11758: function to check if hyperelliptitc curve is singular in the sense of hyperelliptic curves

Issue created by migration from https://trac.sagemath.org/ticket/11930

Original creator: dkrenn

Original creation time: 2011-10-17 14:12:59

Assignee: cremona

CC:  d.testa@warwick.ac.uk jpflori davideklund

Keywords: hyperelliptic curve, singular

We have

```
sage: R.<x> = PolynomialRing(GF(3))
sage: H=HyperellipticCurve(x^5+1)
sage: H.is_singular()
True
```

but `H` is a non-singular hyperelliptic curve. Although this is *not* an error, since all hyperelliptic curves, where the degree of the defining polynomial is at least 5, have a singularity at infinity. 

The term non-singular hyperelliptic curve is used to say that all finite points are non-singular. Therefore it would be nice to have a function that returns the (non-)singularity of the finite points of an hyperelliptic curve.


---

Comment by cremona created at 2011-10-17 15:59:40

This is a good idea.  When we implemented the one-line test for nonsingularity of general curves over finite fields last year (after discovering to our surprise that it was not implemented) we did not think of this special case.  The generic is_singular() method is defined in sage/schemes/plane_curves/projective_curve.py as a method of class ProjectiveCurve_generic.  Your H is of a derived class, so it would be possible to write a different is_singular() method for that subclass.


---

Comment by dkrenn created at 2011-11-02 14:49:51

Changing status from new to needs_review.


---

Attachment


---

Comment by mstreng created at 2011-12-17 15:07:00

The cause is of course the computationally convenient, but mathematically inaccurate, ambient space. The curve is smooth and projective, but not in `P^2`:

```
sage: R.<x> = GF(3)[]
sage: H = HyperellipticCurve(x^5+1)
sage: H.ambient_space()
Projective Space of dimension 2 over Finite Field of size 3
```



---

Comment by mstreng created at 2011-12-17 15:37:04

There is a much faster way to get the same answer for fields of characteristic not 2:

```
sage: R.<x> = GF(3)[]
sage: H = HyperellipticCurve(x^5+1)
sage: timeit('H.is_singular()')
125 loops, best of 3: 5.14 ms per loop
sage: timeit('H.hyperelliptic_polynomials()[0].discriminant()!=0')
625 loops, best of 3: 266 Âµs per loop
```



---

Comment by mstreng created at 2011-12-18 15:16:09

Changing keywords from "hyperelliptic curve, singular" to "hyperelliptic curve, singular, sd35".


---

Comment by mstreng created at 2011-12-18 15:16:09

Disagreement with Magma, there should still be some condition at infinity for this to be a nice hyperelliptic curve. We are now figuring out what that condition should be.

```
sage: P.<x> = GF(2)[]
sage: H = HyperellipticCurve(x^6+1, 1)
sage: H.is_singular()
False
sage: magma(H)
TypeError: Error evaluating Magma code.
Runtime error in 'HyperellipticCurve': Curve is singular at infinity
```


Also, it seems from the code in HyperellipticCurve that some partial check for singularity is performed there. Should that be a full check or no check at all?


---

Comment by mstreng created at 2011-12-18 15:16:09

Changing status from needs_review to needs_work.


---

Attachment

change the constructor of hyperelliptic curve to check if the input makes sense


---

Comment by mstreng created at 2011-12-18 22:00:44

Apply 11930_singular_hyperelliptic.patch and 11930_is_singular.patch

The first of these patches (written by Damiano and I) adds tests to the HyperellipticCurve constructor. It tests whether the input polynomials f(x) and h(x) really make sense. In other words, it checks if there is some g such that, when f and h are homogenized wrt x to degrees 2g+2 and g+1 respectively, one gets a smooth projective curve. We compared it with the independent implementation in Magma, and the test turns out to be equivalent to Magma's test for all input polynomials over GF(2) and GF(3) where deg(f) is 5 or 6 and deg(h) <= 3.

The second patch is Daniel's function, but with a simpler algorithm that uses the fact that only smooth curves are constructed.


---

Comment by mstreng created at 2011-12-18 22:16:38

See also #11800 and #11980


---

Attachment

new version, fixes doctests


---

Attachment


---

Comment by mstreng created at 2011-12-20 16:38:37

apply 11930b.patch and 11930_is_singular.patch


---

Comment by zimmerma created at 2011-12-24 11:37:59

Marco, I tried to apply this patch to 4.7.2 (this is needed to check #11800).
However the example in the description still fails:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
Loading Sage library. Current Mercurial branch is: 11800
sage: R.<x> = PolynomialRing(GF(3))
sage: H=HyperellipticCurve(x^5+1)
sage: H.is_singular()
True
```

Paul


---

Comment by mstreng created at 2011-12-26 13:28:29

Oops, sorry, yes. I wrote "True" in [attachment:11930_is_singular.patch] where it should have been "False".


---

Comment by mstreng created at 2011-12-27 13:51:36

I can finish this, but not in the next couple of weeks. If anyone wants to work on this, post to this ticket first.


---

Comment by mstreng created at 2012-01-07 22:26:54

disallow non-smooth hyperelliptic curves


---

Attachment

is_singular always returns False for hyperelliptic curves


---

Comment by mstreng created at 2012-01-07 22:34:12

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by mstreng created at 2012-01-07 22:34:12

Changing type from enhancement to defect.


---

Comment by mstreng created at 2012-01-07 22:34:12

Changing priority from minor to major.


---

Comment by mstreng created at 2012-01-07 22:44:31

To check whether a polynomial has repeated roots, this patch uses both GCDs and resultants. It tries the GCD first, because that is fastest. If that fails, it tries the resultant.

The reason for needing both gcds and resultants is actually quite funny: Qp has no gcd currently implemented in Sage, while extensions of Qp have no resultants in Sage!

With 4.8.alpha4, I get

```
sage: P.<x> = Qp(5,7)[]
sage: x.gcd(x)
# AttributeError: 'Polynomial_padic_capped_relative_dense' object has no attribute 'gcd'
sage: x.resultant(x)
# 0
sage: K.<a> = Qp(5,7).extension(x^2-5)
sage: P.<x> = K[]
sage: x.gcd(x)
# (1 + O(a^14))*x
sage: x.resultant(x)
# TypeError: no conversion of this ring to a Singular ring defined
```



---

Comment by mstreng created at 2012-01-07 22:46:13

Changing keywords from "hyperelliptic curve, singular, sd35" to "hyperelliptic curve singular smooth sd35".


---

Comment by mstreng created at 2012-01-07 22:46:13

Patch was written on top of 4.8.alpha4.
Apply 11930c.patch and 11930_is_singular.patch


---

Comment by davidloeffler created at 2012-03-13 00:02:51

I'm not happy with this:

```
 	51	    .. NOTE:: 
 	52	 
 	53	        The words "hyperelliptic curve" are normally only used for curves of 
 	54	        genus at least two, but this class allows more general smooth double 
 	55	        covers of the projective line (conics and elliptic curves), even though 
 	56	        the class is not meant for those and some outputs may be incorrect.
```

I don't think we can merge this if we know or suspect that it gives incorrect results! We should either raise an error in these cases, or check that the results that are returned are correct.


---

Comment by davidloeffler created at 2012-03-13 00:02:51

Changing status from needs_review to needs_work.


---

Comment by mstreng created at 2012-03-13 06:40:39

Replying to [comment:19 davidloeffler]:
> I'm not happy with this:

...

> I don't think we can merge this if we know or suspect that it gives incorrect results! We should either raise an error in these cases, or check that the results that are returned are correct.

Hi David,

This "NOTE" is just a warning that we added about the code as it was. It is not about a change that we are making. We decided to leave support for conics and elliptic curves intact, as people may be running a loop over general double covers, or not care too much.

Removing support for conics and elliptic curves would be something for a discussion on sage-nt, and then a new ticket. I can remove this note if you'd like, and leave the rest of the patch as it is. Would that be an improvement?

Marco


---

Comment by mstreng created at 2012-03-20 06:55:20

Changing status from needs_work to needs_review.


---

Comment by davideklund created at 2012-05-04 22:57:55

I tested this on Sage 4.8.

There is a method is_smooth() which can be applied to a hyperelliptic curve. With the patches applied:


```
sage: R.<x> = PolynomialRing(GF(3))
sage: H=HyperellipticCurve(x^5+1)
sage: H.is_singular()
False
sage: H.is_smooth()
False
```


Maybe these two methods should give consistent results. The is_smooth() method seems to be defined in the class AlgebraicScheme_subscheme_projective in algebraic_scheme.py.


---

Comment by mstreng created at 2012-05-05 08:22:34

Replying to [comment:22 davideklund]:
> Maybe these two methods should give consistent results.

yes (go ahead)


---

Comment by mstreng created at 2012-05-05 08:25:33

Replying to [comment:23 mstreng]:
> Replying to [comment:22 davideklund]:
> > Maybe these two methods should give consistent results.
> 
> yes (go ahead)

(to elaborate on this: I don't have time now, but yes, it would be good if is_smooth() always returns True for these curves)


---

Comment by mstreng created at 2012-05-11 12:05:34

use this instead of 11930_is_singular.patch


---

Attachment


---

Comment by mstreng created at 2012-05-11 21:43:44

Replying to [comment:22 davideklund]:
> Maybe these two methods should give consistent results.

Thanks, they do now. So the ticket needs review again.


---

Comment by davideklund created at 2012-05-13 16:04:30

Replying to [comment:26 mstreng]:
> Replying to [comment:22 davideklund]:
> > Maybe these two methods should give consistent results.
> 
> Thanks, they do now. So the ticket needs review again.

Ok, nice. I'm on it!


---

Comment by davideklund created at 2012-05-13 16:13:02

Apply 11930c.patch and 11930_is_singular2.patch


---

Comment by davideklund created at 2012-05-17 20:12:28

These patches look good. I'll be back in a few days after having looked a bit more on the details.

In the meantime, here is a question/issue: when I apply 11930c.patch using Sage 5.0 (on OS X lion 10.7.3) I get the following:

`patching file sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py`\\
`Hunk #8 succeeded at 653 with fuzz 1 (offset 95 lines).`

I'm not sure what this means or how to get rid off the fuzz.


---

Comment by mstreng created at 2012-05-18 08:28:52

Replying to [comment:29 davideklund]:
> I'm not sure what this means or how to get rid off the fuzz.

When applying the patch, mercurial will look for a certain block of code and replace it by another. The code to look for also has three surrounding unchanged lines on each side. Fuzz means that there is a slight mismatch in the surrounding code, due to changes in Sage between after I wrote the patch. More precisely, fuzz n means that a block can only be matched if the outermost n lines of the surrounding code are ignored. I've seen patches be rejected because of fuzz 2, but I think fuzz 1 is fine: there are still 2 lines unchanged around every patched line.

In this particular case, it means that a doctest nearby one of the changed doctests in hyperelliptic_finite_field.py has changed since I wrote the patch.

To get rid of the fuzz, the patch can be rebased (apply to latest version, then qrefresh and export), but I don't think it is necessary with fuzz 1.


---

Comment by davideklund created at 2012-05-18 16:06:57

Replying to [comment:30 mstreng]:

Ok. Thank you for that explanation.

> Replying to [comment:29 davideklund]:
> > I'm not sure what this means or how to get rid off the fuzz.
> 
> When applying the patch, mercurial will look for a certain block of code and replace it by another. The code to look for also has three surrounding unchanged lines on each side. Fuzz means that there is a slight mismatch in the surrounding code, due to changes in Sage between after I wrote the patch. More precisely, fuzz n means that a block can only be matched if the outermost n lines of the surrounding code are ignored. I've seen patches be rejected because of fuzz 2, but I think fuzz 1 is fine: there are still 2 lines unchanged around every patched line.
> 
> In this particular case, it means that a doctest nearby one of the changed doctests in hyperelliptic_finite_field.py has changed since I wrote the patch.
> 
> To get rid of the fuzz, the patch can be rebased (apply to latest version, then qrefresh and export), but I don't think it is necessary with fuzz 1.
>


---

Comment by davideklund created at 2012-05-18 16:21:07

Here are two more beginner questions related to these patches: 

I have a recurring doc-test failure (Sage 5.0 on Mac OS lion) so I can't really doc-test these patches locally without failures. But I interpret what the patch-bot has done on this ticket as sufficient for a positive review as far as doc-testing goes (it seems that all tests pass). Sounds reasonable?

The patch-bot's blue blob and the "plug-in failed" I believe is only about trailing white space, and therefore harmless. Sounds reasonable?


---

Comment by mstreng created at 2012-05-18 16:53:47

Replying to [comment:32 davideklund]:
> Here are two more beginner questions related to these patches: 

It may be better to ask these in email or on the mailing lists, but I'll just answer them anyway.

>
> I have a recurring doc-test failure (Sage 5.0 on Mac OS lion) so I can't really doc-test these patches locally without failures. But I interpret what the patch-bot has done on this ticket as sufficient for a positive review as far as doc-testing goes (it seems that all tests pass). Sounds reasonable?

I'm not sure whether just using the patchbot is ok. According to the [developer's guide](http://www.sagemath.org/doc/developer/walk_through.html#reviewing-a-patch), you are supposed to run the tests marked "#long" as well, and I don't see where the patchbot does this.

As for your failing tests, any tests that fail on an unpatched Sage can be safely ignored, they are not due to the patch.

>
> The patch-bot's blue blob and the "plug-in failed" I believe is only about trailing white space, and therefore harmless. Sounds reasonable?

In this particular case, it is ok.

In detail: it seems that many people are very annoyed by trailing whitespaces on non-empty lines (see [here](http://groups.google.com/group/sage-devel/browse_thread/thread/f6a783b3a52bfa5d/30809dba7cfb13dd)), hence don't want any new ones to be introduced. That's probably where the plugin came from in the first place. In any case, I just checked and this patch does not introduce any new trailing whitespaces on non-empty lines. I did change two lines that already had trailing whitespaces, which I didn't notice, so I did not remove them. That's where the plugin warning comes from.


---

Comment by davideklund created at 2012-05-19 22:22:07

All tests pass except one which fails on an unaltered Sage 5.0 (on OS X 10.7.3). 

The failure was with "rings/polynomial/pbori.pyx" and the tests are not flagged # long time and so are covered by the tests run by the patchbot on this ticket.


---

Comment by davideklund created at 2012-05-20 04:39:42

This all looks good. If the other reviewers agree, we can change the status to positive review.

I only have two small comments on the patches:

About the example beginning with "A hyperelliptic curve should not be given by polynomials of degree greater than `2g+2`, where `g` is the genus." I'm not sure I understand what this means. The genus of what? It is slightly unclear since I gather that in this example there is no hyperelliptic curve whose genus we could be referring to. Is it the genus of the desingularization of the corresponding plane curve? The way I view this, the equation `y^2+hy=f`, where `h=x^100` and `f=x<sup>6+1-h</sup>2/4` (appropriately homogenized with `z`) defines a curve in weighted projected space `P(1,100,1)` but that curve is singular at the point `(x,y,z)=(1,-1/2,0)`.

About the example beginning "Input with integer coefficients creates objects with the integers as base ring, but only checks smoothness over `QQ`, not `ZZ`". Is this to be interpreted as saying that the example provided is not smooth as a scheme over `Spec(ZZ)`?


---

Comment by mstreng created at 2012-05-21 08:05:48

Replying to [comment:35 davideklund]:
> I only have two small comments on the patches:

I don't want the documentation to be confusing, so I'll address your comments and post a new patch.

> 
> About the example beginning with "A hyperelliptic curve should not be given by polynomials of degree greater than `2g+2`, where `g` is the genus." I'm not sure I understand what this means. The genus of what? It is slightly unclear since I gather that in this example there is no hyperelliptic curve whose genus we could be referring to. Is it the genus of the desingularization of the corresponding plane curve?

Yes, I will explain that better.

> The way I view this, the equation `y^2+hy=f`, where `h=x^100` and `f=x<sup>6+1-h</sup>2/4` (appropriately homogenized with `z`) defines a curve in weighted projected space `P(1,100,1)` but that curve is singular at the point `(x,y,z)=(1,-1/2,0)`.

Yes, and we should not allow that.

> About the example beginning "Input with integer coefficients creates objects with the integers as base ring, but only checks smoothness over `QQ`, not `ZZ`". Is this to be interpreted as saying that the example provided is not smooth as a scheme over `Spec(ZZ)`?

Yes. But I see that Spec(ZZ) may confuse or scare people, so I will clarify this.


---

Comment by mstreng created at 2012-05-21 09:35:52

replaces 11930c.patch: rebased on top of 5.0.beta14, removed trailing whitespaces, clarified examples


---

Attachment

Here's a diff between the c and d patches, excluding changed line numbers and hashes:

```
< +    This class also allows curves of genus zero or one, which are stricly
> +    This class also allows curves of genus zero or one, which are strictly
126,127c126,130
< +    A hyperelliptic curve should not be given by polynomials of degree greater
< +    than `2g+2`, where `g` is the genus.::
> +    The input for a (smooth) hyperelliptic curve of genus `g` should not
> +    contain polynomials of degree greater than `2g+2`. In the following
> +    example, the hyperelliptic curve has genus 2 and there exists a model
> +    `y^2 = F` of degree 6, so the model `y^2 + yh = f` of degree 200 is not
> +    allowed.::
137c140
< +        
> +
152c155,157
< +    as base ring, but only checks smoothness over `QQ`, not `ZZ`::
---
> +    as base ring, but only checks smoothness over `\QQ`, not over Spec(`\ZZ`).
> +    In other words, it is checked that the discriminant is non-zero, but it is
> +    not checked whether the discriminant is a unit in `\ZZ^*`.::
155,156c160,161
< +        sage: HyperellipticCurve(4*x^7+8*x+8)
< +        Hyperelliptic Curve over Integer Ring defined by y^2 = 4*x^7 + 8*x + 8
> +        sage: HyperellipticCurve(3*x^7+6*x+6)
> +        Hyperelliptic Curve over Integer Ring defined by y^2 = 3*x^7 + 6*x + 6
264c269
< +            ValueError: curve is not smooth    
> +            ValueError: curve is not smooth
273c278
< +            raise ValueError, "curve is not smooth"   
> +            raise ValueError, "curve is not smooth"
308c313
<          #checking first that Cartier matrix is not already cached. Since it can be called by either Hasse_Witt or a_number
>          #checking first that Cartier matrix is not already cached. Since
```


Apply 11930d.patch and then 11930_is_singular2.patch


---

Comment by mstreng created at 2012-05-21 09:42:03

Replying to [comment:35 davideklund]:
> This all looks good. If the other reviewers agree, we can change the status to positive review.

The other reviewers are the authors of the current version, so you don't need to consult us (we are the ones who set this to "needs review" in the first place). If you agree with the new patch, you can set it to "positive review" yourself.


---

Comment by davideklund created at 2012-05-22 00:34:56

Nice! Those extra comments in the examples really clarified things (for me at least).


---

Comment by davideklund created at 2012-05-22 00:34:56

Changing status from needs_review to positive_review.


---

Comment by mstreng created at 2012-05-22 08:03:33

Replying to [comment:39 davideklund].

Thanks!


---

Comment by jdemeyer created at 2012-06-02 12:10:15

Resolution: fixed
