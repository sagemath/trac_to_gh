# Issue 17610: Cython: embed signatures in docstrings

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-02-24 10:39:40

CC:  simonking




---

Comment by jdemeyer created at 2015-02-24 14:03:54

The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`

In particular, I need help with navigating this maze:

```python
def _sage_getsourcelines_name_with_dot(object):
    r"""
    [...]
    AUTHOR:

    - Simon King (2011-09)
    """
    # First, split the name:
    if '.' in object.__name__:
        splitted_name = object.__name__.split('.')
    elif hasattr(object,'__qualname__'):
        splitted_name = object.__qualname__.split('.')
    else:
        splitted_name = object.__name__
    path = object.__module__.split('.')+splitted_name[:-1]
    name = splitted_name[-1]
    try:
        M = __import__(path.pop(0))
    except ImportError:
        try:
            B = object.__base__
            if B is None:
                raise AttributeError
        except AttributeError:
            raise IOError("could not get source code")
        return sage_getsourcelines(B)
    # M should just be the top-most module.
    # Hence, normally it is just 'sage'
    try:
        while path:
            M = getattr(M, path.pop(0))
    except AttributeError:
        try:
            B = object.__base__
            if B is None:
                raise AttributeError
        except AttributeError:
            raise IOError("could not get source code")
        return sage_getsourcelines(B)

    lines, base_lineno = sage_getsourcelines(M)
    [...]
```



---

Comment by jdemeyer created at 2015-02-24 14:12:35

New commits:


---

Comment by SimonKing created at 2015-02-24 15:21:24

Replying to [comment:6 jdemeyer]:
> The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`
> 
> In particular, I need help with navigating this maze:
> {{{
> #!python
> def _sage_getsourcelines_name_with_dot(object):
> }}}

That's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.

Details: In the category framework we have all these nested dynamic classes which get a name that is formed by the name of a class they will be attribute of. Hence:

```python
class Modules(Category):
    def __init__(...):
        ...
    class Homset(Homset_generic):
        def __init__(...)
```

Hence, you have a class `Modules` and you have an attribute `Modules.Homset` that itself is a class (nested classes). Now, you will find:

```
sage: Modules.Homset.__name__
'Modules.Homset'
```


Hence, you will NOT find the source code of the class by searching the name in the source file. But the name does give you a possibility to find the code, namely by first searching for the source of the class `Modules` in the source file and then searching for the source of the class `Homset` in the source of `Modules`.

It isn't relevant for Cython classes, since there is a metaclass at work (and you can't have metaclass for Cython classes). It _could_ perhaps be in a cython file, though.


---

Comment by git created at 2015-02-25 08:10:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-25 09:23:16

Replying to [comment:9 SimonKing]:
> Replying to [comment:6 jdemeyer]:
> > The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`
> > 
> > In particular, I need help with navigating this maze:
> > {{{
> > #!python
> > def _sage_getsourcelines_name_with_dot(object):
> > }}}
> 
> That's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.
Apparently it _is_ relevant, since I'm getting doctest failures in this function:

```
sage -t src/sage/misc/nested_class_test.py
**********************************************************************
File "src/sage/misc/nested_class_test.py", line 215, in sage.misc.nested_class_test.TestNestedParent
Failed example:
    print sage_getsource(E)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.nested_class_test.TestNestedParent[5]>", line 1, in <module>
        print sage_getsource(E)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1641, in sage_getsource
        t = sage_getsourcelines(obj, is_binary)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1895, in sage_getsourcelines
        return obj._sage_src_lines_()
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 392, in _sage_src_lines
        return sage_getsourcelines(doccls)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1921, in sage_getsourcelines
        return _sage_getsourcelines_name_with_dot(obj)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1755, in _sage_getsourcelines_name_with_dot
        raise IOError('could not find class definition')
    IOError: could not find class definition
**********************************************************************
```



---

Comment by jdemeyer created at 2015-02-25 09:25:40

The `TestNestedParent` does inherit from the Cython class `Parent`, perhaps that's how Cython comes in.


---

Comment by git created at 2015-04-07 09:41:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-07 09:49:33

Rebased and included upstream Cython patch, but it still doesn't work due to the issue with `_sage_getsourcelines_name_with_dot()`


---

Comment by SimonKing created at 2015-04-07 10:04:44

OK, I'll have a look.

Do I need to do "sage -ba" to build it, or is that done automatically because of dependency checking?

Best regards,
Simon


---

Comment by SimonKing created at 2015-04-07 10:37:06


```
Error building Sage.

The following package(s) may have failed to build:

package: sagenb-0.11.4
log file: /home/king/Sage/git/sage/logs/pkgs/sagenb-0.11.4.log
build directory: /home/king/Sage/git/sage/local/var/tmp/sage/build/sagenb-0.11.4

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

Makefile:19: recipe for target 'build' failed
make: *** [build] Error 1
```


Reason:

```
Traceback (most recent call last):
  File "/home/king/Sage/git/sage/local/bin/pip", line 9, in <module>
    load_entry_point('pip==1.5.6', 'console_scripts', 'pip')()
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 521, in load_entry_point
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2632, in load_entry_point
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2312, in load
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2318, in resolve
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/__init__.py", l
ine 10, in <module>
    from pip.util import get_installed_distributions, get_prog
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/util.py", line 
18, in <module>
    from pip._vendor.distlib import version
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib
/version.py", line 14, in <module>
    from .compat import string_types
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib
/compat.py", line 31, in <module>
    from urllib2 import (Request, urlopen, URLError, HTTPError,
ImportError: cannot import name HTTPSHandler
Error: Installing SageNB failed.
```

Why does pip come into play here? Isn't pip optional?


---

Comment by SimonKing created at 2015-04-07 10:42:42

Note that I do have pip installed in Sage.


---

Comment by jdemeyer created at 2015-04-07 11:40:33

Replying to [comment:19 SimonKing]:
> Do I need to do "sage -ba" to build it
No (and if you do, that's a bug).


---

Comment by jdemeyer created at 2015-04-07 11:40:59

Replying to [comment:20 SimonKing]:
> Why does pip come into play here?
This is #18131.

> Isn't pip optional?
Not anymore.


---

Comment by SimonKing created at 2015-04-07 17:38:40

First observation: The underlying problem appears to not be in `_sage_getsourcelines_name_with_dot`.

Namely, the reason why the element class' source can not be found is that the "parent" class can not be found:

```
sage: from sage.misc.sageinspect import sage_getsourcelines
sage: from sage.misc.nested_class_test import TestNestedParent
sage: sage_getsourcelines(TestNestedParent)[0][0]
'cdef class Parent(category_object.CategoryObject):\n'
```

So, we need to find out why `sage_getsourcelines` returns the sources of `Parent` (a super-class of `TestNestedParent`).


```
sage: from sage.misc.sageinspect import sage_getfile
sage: sage_getfile(TestNestedParent)
'/home/king/Sage/git/sage/src/sage/structure/parent.pyx'
```

OK, that's wrong.


---

Comment by SimonKing created at 2015-04-07 17:50:39

`sage_getfile` relatively early tries to extract the file from the docstring --- and when it fails, then it tries to extract it from the `__init__` of the object!

So, since `TestNestedParent.__init__` is the same as `Parent.__init__`, things become wrong.


---

Comment by SimonKing created at 2015-04-07 17:52:02

Note that in the present case, Python's `inspect.getfile` returns the right thing.


---

Comment by SimonKing created at 2015-04-07 18:52:02

Oops:

```
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: print _sage_getdoc_unformatted(TestNestedParent)
File: sage/structure/parent.pyx (starting at line 228)

        Base class for all parents.

        Parents are the Sage/mathematical analogues of container
        objects in computer science.

...
```

So, even though `TestNestedParent` has its own docstring, `_sage_getdoc_unformatted` ignores it.


---

Comment by SimonKing created at 2015-04-07 18:57:17

... and that's on purpose, according to the documentation of `_sage_getdoc_unformatted`:

```
If ``__init__`` has embedding information, we prefer that::

        sage: C = QQ['x', 'y'].__class__
        sage: print C.__doc__
        MPolynomialRing_libsingular(base_ring, n, names, order='degrevlex')
        sage: print C.__init__.__doc__
        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)
        <BLANKLINE>
                Construct a multivariate polynomial ring...
        sage: print _sage_getdoc_unformatted(C)
        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)
        <BLANKLINE>
                Construct a multivariate polynomial ring...
```

Thus, `_sage_getdoc_unformatted` is the wrong tool for our purpose, since we do _not_ want to prefer the doc of `__init__`.

Also: What happens if a class derived from `Parent` has no docstring?


---

Comment by SimonKing created at 2015-04-07 19:04:09

At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would _not_ prefer the doc of `__init__` if an embedding information is missing.


---

Comment by SimonKing created at 2015-04-07 19:17:44

Replying to [comment:29 SimonKing]:
> At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would _not_ prefer the doc of `__init__` if an embedding information is missing.

It does solve the current problem. And after all, I think it is not the job of `_sage_getdoc_unformatted` to search for embedding information. If some functions absolutely want to get embedding information, then it is _their_ job to search the information. Of course I need to see how much would break.


---

Comment by SimonKing created at 2015-04-07 20:08:15

Note that the following crashes:

```
    sage: class Foo:
    ....:     def __init__(self):
    ....:         'docstring'
    ....:         pass
    sage: import inspect
    sage: inspect.getsource(Foo)
```

That's strange, since it is all pure Python, and since

```
sage: inspect.getsource(Foo.__init__)
```

works.

Even more strange: In `getsource(Foo.__init__)`, the whole source of `Foo` is determined. Hence, it _it_ possible to get the source of `Foo`. That's a bug in Python's inspect.getsource.

I wonder if we should fix that. Certainly not here, though.


---

Comment by SimonKing created at 2015-04-07 21:09:15

Meanwhile I became aware that the it was in your commits that `_sage_getdoc_unformatted` was changed to actively search for docstrings with embedding information. I am preparing a commit that reverts it. 

I really think the job of `_sage_getdoc_unformatted(obj)` is to get the docstring of `obj` without formatting. The user of `_sage_getdoc_unformatted` has to decide for him or herself whether `obj.__init__.__doc__` would be more useful than `obj.__doc__`.

Something else: Do I see that correctly that you did not change `sage_getargspec` to using the new embedded information on the argspec? Or is Python's `inspect.getargspec` using that information, so that we will benefit from it implicitly?


---

Comment by SimonKing created at 2015-04-07 21:13:45

Something else is not good. The purpose of this ticket is to embed signatures into docstrings. Well, it isn't done even with the ticket branch:

```
sage: cython("""
....: class Foo:
....:     def __init__(self, bla, int x):
....:         pass
....: """)
sage: Foo.__init__.__doc__
'File: _home_king__sage_temp_linux_va3e_site_18607_tmp_QtW4tF_spyx_0.pyx (starting at line 8)'
```

In other words, the file information is in the docstring, but the signature is missing.

Why is that?


---

Comment by SimonKing created at 2015-04-07 21:25:10

The doctests pass with my new commit.

However, two issues should be addressed:
- The signature for interactively defined Cython methods (I don't know if "interactive" is the reason why it fails) should be embedded, too
- The embedded signature should be used in sage_getargspec. There should be a function that extracts both the method/function name and the argspec from the embedded signature.
----
New commits:


---

Comment by SimonKing created at 2015-04-07 21:36:54

There is some more error in `sage -t src/sage/sets/set_from_iterator.py`, which is caused by additional blank lines at the beginning of what `sage_getdoc` returns. Ought to be fixed one way or another (tomorrow).


---

Comment by jdemeyer created at 2015-04-08 06:09:50

Replying to [comment:33 SimonKing]:
> Why is that?
Most likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)


---

Comment by jdemeyer created at 2015-04-08 06:12:52

Both these issues are outside the scope of this ticket.


---

Comment by SimonKing created at 2015-04-08 08:40:58

Replying to [comment:37 jdemeyer]:
> Replying to [comment:33 SimonKing]:
> > Why is that?
> Most likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)

Why do you think it is outside the scope of this ticket? It is about Cython embedding the signature into docstring, and I don't see why Cython should distinguish `sage -b` from compilation of interactive code.

For sure, we can only use the embedded signature when it is _uniformely_ embedded. Otherwise I don't see the point of embedding.

What about the additional blank line in a doc string? Do you think we should simply insert it into the failing test in `src/sage/sets/set_from_iterator.py`, or make it so that there is no additional blankline?


---

Comment by jdemeyer created at 2015-04-08 09:28:15

Replying to [comment:39 SimonKing]:
> Why do you think it is outside the scope of this ticket?
Because the actual bug is that `cython()` works differently from `./sage -b`. This issue has nothing to do with `embedsignature` and it is also much broader than `embedsignature`. Did you know that even `print -1/3` behaves differently in `cython()` than in Sage library Cython code?

Fixing this has been on my Cython TODO list for a long time, but I currently have too many tickets related to Cython that they would surely conflict.


---

Comment by jdemeyer created at 2015-04-08 10:33:51

Replying to [comment:39 SimonKing]:
> What about the additional blank line in a doc string?
Fixed by this extra commit.

Note however that `make doc` still fails...
----
New commits:


---

Comment by jdemeyer created at 2015-04-08 12:31:39


```
sage -t src/doc/en/developer/coding_basics.rst
**********************************************************************
File "src/doc/en/developer/coding_basics.rst", line 501, in doc.en.developer.coding_basics
Failed example:
    sage_getdoc(foo)              # class docstring
Expected:
    'Construct a Foo.\n'
Got:
    ''
**********************************************************************
```



---

Comment by SimonKing created at 2015-04-08 14:44:32

Replying to [comment:44 jdemeyer]:
> sage -t src/doc/en/developer/coding_basics.rst

Strange, I didn't notice this one.

Anyway, I suppose if make doc fails, that's more serious.


---

Comment by SimonKing created at 2015-04-08 15:04:30

The make doc error says:

```
OSError: [polynomia] docstring of sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative:1: WARNING: Inline emphasis start-string without end-string.
```


The doc string is:

```
sage: print sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative.__doc__
LaurentPolynomial_mpair.derivative(self, *args)
File: sage/rings/polynomial/laurent_polynomial.pyx (starting at line 2283)

        The formal derivative of this Laurent polynomial, with respect
        to variables supplied in args.

        Multiple variables and iteration counts may be supplied; see
        documentation for the global derivative() function for more
        details.

        .. seealso::

           :meth:`_derivative`

        EXAMPLES::

            sage: R = LaurentPolynomialRing(ZZ,'x, y')
            sage: x, y = R.gens()
            sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)
            sage: t.derivative(x, x)
            12*x^2*y + 2*x^-3
            sage: t.derivative(y, 2)
            12*y^-5
```

`*args` would be interpreted as an emphasis to the text of the docstring, which indeed isn't ended by another `*`.

But isn't sage_getdoc called for creating the docs? It _does_ strip the embedded information!

```
sage: print sage.misc.sageinspect.sage_getdoc(sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative)
   The formal derivative of this Laurent polynomial, with respect to
   variables supplied in args.

   Multiple variables and iteration counts may be supplied; see
   documentation for the global derivative() function for more
   details.

   See also: "_derivative()"

   EXAMPLES:

      sage: R = LaurentPolynomialRing(ZZ,'x, y')
      sage: x, y = R.gens()
      sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)
      sage: t.derivative(x, x)
      12*x^2*y + 2*x^-3
      sage: t.derivative(y, 2)
      12*y^-5
```

Or is `_sage_getdoc_unformatted` used to build the docs?


---

Comment by jdemeyer created at 2015-04-08 15:29:24

Replying to [comment:46 SimonKing]:
> Or is `_sage_getdoc_unformatted` used to build the docs?

That's certainly the intention of `src/doc/common/sage_autodoc.py`


---

Comment by SimonKing created at 2015-04-08 15:44:00

Replying to [comment:47 jdemeyer]:
> Replying to [comment:46 SimonKing]:
> > Or is `_sage_getdoc_unformatted` used to build the docs?
> 
> That's certainly the intention of `src/doc/common/sage_autodoc.py`

Thanks! Shouldn't sage_getdoc be used instead? Anyway, the embedded information does in my opinion not belong into the reference manual. Hence, it needs to be stripped one way or another. And if sage_autodoc has a custom way of stripping, then either the custom way should be changed to take into account the new embedded signature, or it should use a specialised tool (namely sage_getdoc) right away.


---

Comment by jdemeyer created at 2015-04-08 15:46:42

I agree, let me work on a fix.


---

Comment by SimonKing created at 2015-04-08 15:48:45

Am I right that stripping the old embedding information is stripped by stuff from `sphinx.util`?


---

Comment by git created at 2015-04-08 16:11:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-08 16:14:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-08 16:47:56

It looks like there is still an issue with cached functions:

```
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: print _sage_getdoc_unformatted(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)

        Return an algebraic closure of ``self``.
...
```



---

Comment by SimonKing created at 2015-04-08 16:51:32

`make doc` still fails. I see several errors.

One error looks like this:

```
[combinat ] /home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/__init__.py:docstring of sage.combinat:39: WARNING: undefined label: sage.coding (if the link has no caption the label must precede a section header)
```

No idea what that means.

Another error:

```
[finite_ri] docstring of sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure:1: WARNING: Inline strong start-string without end-string.
```

That again seems like a failing removal of `**kwds` from the signature, or similar problems.
Indeed:

```
sage: print sage_getdoc_original(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)

        Return an algebraic closure of ``self``.

        INPUT:
...
```

So, although `sage_getdoc_original` is supposed to strip the embedding information, it doesn't!

You are right, it seems to be a problem with cached methods.


---

Comment by SimonKing created at 2015-04-08 16:55:10

Aha, the embedding information is inserted twice:

```
sage: obj = sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure
sage: s = _sage_getdoc_unformatted(obj)
sage: print s
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
...
```

I guess that happens in the cached_method's _sage_doc_ method.


---

Comment by SimonKing created at 2015-04-08 17:04:19

Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.

Let me fix it, please, I guess I'll be done in 5 minutes.


---

Comment by git created at 2015-04-08 17:06:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-08 17:06:38

Replying to [comment:56 SimonKing]:
> Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.
> 
> Let me fix it, please, I guess I'll be done in 5 minutes.
Too late...


---

Comment by jdemeyer created at 2015-04-08 17:08:05

This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:

```
sage: print sage.structure.parent.Parent.__doc__
Parent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)
```


This should be fixed since now this causes `make doc` to fail.

I'll leave this ticket alone for today, so you can make changes if you want.


---

Comment by SimonKing created at 2015-04-08 17:09:32

Replying to [comment:58 jdemeyer]:
> Replying to [comment:56 SimonKing]:
> > Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.
> > 
> > Let me fix it, please, I guess I'll be done in 5 minutes.
> Too late...

Bad. I just pushed it.
----
New commits:


---

Comment by SimonKing created at 2015-04-08 17:14:04

Actually I don't like your way of fixing it. If I understand correctly, we _do_ want to insert embedding information into the doc of a cached function, even if the embedding information is missing in the doc of the wrapped function.

So, I suggest we work on top of the now attached branch.

In any case, the `Parent` problem persists.


---

Comment by SimonKing created at 2015-04-08 17:16:23

Replying to [comment:59 jdemeyer]:
> This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:
> {{{
> sage: print sage.structure.parent.Parent.__doc__
> Parent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)
> }}}

Why is that? If there is no doc string, shouldn't Cython change it so that it consists of the signature and the embedding information? Why is the embedding information not inserted?


---

Comment by jdemeyer created at 2015-04-08 17:24:14

Replying to [comment:62 SimonKing]:
> If I understand correctly, we _do_ want to insert embedding information into the doc of a cached function
Why should the cached function change _anything_ to the doc? I think it should just pass through the original documentation unchanged.


---

Comment by SimonKing created at 2015-04-08 17:24:32

I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.

When we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.

I'll try to figure out how it works.


---

Comment by SimonKing created at 2015-04-08 17:27:22

Replying to [comment:64 jdemeyer]:
> Why should the cached function change _anything_ to the doc? I think it should just pass through the original documentation unchanged.

For the same reason that Cython inserts additional information to the doc. It helps to retrieve file information. As you have observed, we have no `_sage_file_` method, but only have `_sage_doc_` and `_sage_argspec_`. We would need to have such method, if we would not insert the embedding information of the _original function_ into the doc of the _cached function_.

Actually, having the signature embedded may help to remove the `_sage_argspec_` method!


---

Comment by SimonKing created at 2015-04-08 17:33:43

Replying to [comment:65 SimonKing]:
> I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.
> 
> When we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.
> 
> I'll try to figure out how it works.

Hm. `__init__` is not explicitly considered in your patch. So, I can't figure out what needs to be done.

Do we have a possibility to convince Cython to either not use `Foo.__init__` for inserting the signature into `Foo.__doc__`, or to add the embedding information in addition to the signature into `Foo.__doc__`?


---

Comment by SimonKing created at 2015-04-08 19:05:21

Strangely, when I remove the signature information (admittedly I do so using a heuristics, I get the error

```
OSError: [combinat ] None:4: WARNING: citation not found: BBSSZ2012
```

Why is that? Clearly the citation is defined in `src/sage/combinat/ncsf_qsym/qsym.py`.

I am frustrated, since I don't see how it could be related with the change I did.


---

Comment by SimonKing created at 2015-04-08 19:07:29

Hang on, now I see it! The citation is defined in `dualImmaculate.__init__`, whereas `dualImmaculate` has no docstring at all. In such a situation, I guess we want to use the documentation of the `__init__` method instead.


---

Comment by SimonKing created at 2015-04-08 20:25:08

Introspection is a can of worms, and I hate it. After inserting the docstring of `__init__` in case that the class' docstring is empty, I now get

```
OSError: [graphs   ] /home/king/Sage/git/sage/src/doc/en/reference/graphs/sage/graphs/isgci.rst:11: WARNING: error while formatting signature for sage.graphs.isgci.graph_classes: obj is not a code object
```



---

Comment by SimonKing created at 2015-04-08 20:35:32

Aha! `sage.graphs.isgci.graph_classes.__init__` is obtained from `object.__init__` (even though `sage.graphs.isgci.graph_classes.__init__==object.__init__` returns False), and the docstring of `sage.graphs.isgci.graph_classes` is empty.

Since the doc of the inherited init method is then used (with my not-yet-commited changes), it is also attempted to insert the argspec of `sage.graphs.isgci.graph_classes`. And big surprise:

```
sage: callable(sage.graphs.isgci.graph_classes)
False
sage: callable(object)
True
```

Since `sage.graphs.isgci.graph_classes` surprisingly isn't callable, `sage_getargspec` raises an error.

In any case, I think it is slightly cleaner to use `obj.__init__.__doc__` only if obj is a class, `obj.__doc__` is essentially empty (up to embedding information), *and* if `obj.__init__.__objclass__==obj`.


---

Comment by SimonKing created at 2015-04-08 21:24:11

I am in "WTF" mood. With my current changes, INSTANCES of `sage.plot.colors.Color` are attempted to be inserted into the reference manual, which fails since they are not callable, hence, their argspec can not be determined. It is a mess. Time to call it a day.


---

Comment by SimonKing created at 2015-04-09 07:54:35

I don't get it. With my current (unpushed) branch, I get

```
sage: sage_getdoc_original(sage.plot.colors.aliceblue)
''
```

Nonetheless, `aliceblue`, which is an instance (!) of `sage.plot.colors.Color`, is attempted to be inserted into the reference manual, which currently is not the case.

Why could that be?


---

Comment by SimonKing created at 2015-04-09 08:46:50

Meanwhile it looks a bit better. I think the key is to treat a class and and instance of that class in the same way when determining the docstring. Now, I return the doc of `obj.__init__` if the docstring of `obj` is empty after stripping signature and embedding. Before, I only did so if `obj` is a class. Problem: The doc builder removes duplicates, and thus it will only document a class instance in addition to the class if it has its _own_ docstring. Hence, docstrings of classes and instances must be treated equal.


---

Comment by git created at 2015-04-09 10:16:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-04-09 10:35:16

With the new commit, the documentation builds. I hope it builds fine. Actually I think there should be no change to how it has previously looked like. I didn't finish all tests yet.

Comments on the commits:

As I said, it is essential for source code inspection that embedding information of a function is available in the docstring of a cached version of that function. That's why I did not work on top of your branch.

Here are a couple of reasons for what I did:

- The signature is sometimes not understood by sphinx, as for sphinx both `*` and `**` have different meanings than for the embedded signature. Hence, the signature should be stripped from the documentation. I used a heuristics for stripping the signature, assuming that
  - the signature appears in the first line
  - it starts with the undotted name of the object resp. of its class, followed by an opening bracket.

  If this pattern is found, the first line will be removed. Note that if there is embedding information then the signature information will be cut off anyway by `_extract_embedded_position`.

- When the signature is inserted, a previously empty docstring becomes non-empty, which means that an object would appear in the documentation that previously didn't. Worse: When an object's docstring is empty, its `__init__` docstring was used for documentation instead. There are cases (mainly in sage.combinat) providing documentation AND references in the `__init__` docstring. Hence, it is essential to have them, since otherwise the doc doesn't build. So, I let `sage_getdoc_original` use `__init__` when nothing else is found after stripping _both_ signature and embedding information.

- It is important that `sage_getdoc_unformatted` returns the same docstring for a class and for an instance of the class (unless the instance explicitly has its own `__doc__` attribute). Otherwise, each of such instance found in a module would appear in the reference manual.

I documented my changes, and so far the tests have passed. Hence: Needs review!


---

Comment by SimonKing created at 2015-04-09 10:35:16

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-09 10:39:34

Simon, I assume that "needs_review" implies that you agree with the commits on this branch that I made?


---

Comment by SimonKing created at 2015-04-09 10:46:35

Replying to [comment:77 jdemeyer]:
> Simon, I assume that "needs_review" implies that you agree with the commits on this branch that I made?

That's why I inserted my name as a reviewer `:-)`

But I must admit that I don't understand _why_ your changes result in inserting the signature into the docstring. I just see that they _do_. And I see that we can cope with it, and shall eventually be able to use the new information.

So, perhaps you can explain how your changes really work, so that I'd really qualify as a reviewer...


---

Comment by jdemeyer created at 2015-04-09 10:56:02

> I don't understand _why_ your changes result in inserting the signature into the docstring.
Easy: Cython has a [compiler directive](http://docs.cython.org/src/reference/compilation.html#compiler-directives) `embedsignature=True` which does this and all I did was enabling this flag (plus add a patch from upstream to fix a bug when `embedsignature` is True)


---

Comment by jdemeyer created at 2015-04-09 11:06:09

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-09 11:06:09

Shouldn't this give the docstring of `__init__`?

```
sage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)
''
```



---

Comment by jdemeyer created at 2015-04-09 11:09:10

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2015-04-09 11:09:33

Replying to [comment:80 jdemeyer]:
> Shouldn't this give the docstring of `__init__`?
> {{{
> sage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)
> ''
> }}}

Yes, it should. I'll see after lunch why it doesn't.


---

Comment by jdemeyer created at 2015-04-09 11:09:56

False alarm, `sage.symbolic.callable.CallableSymbolicExpressionRingFactory.__init__` is just `UniqueFactory.__init__` so your code is correct.


---

Comment by jdemeyer created at 2015-04-09 11:15:34

I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes. Interestingly, I also see changes of the form

```diff
-<a class="reference external" href="../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring" title="(in Sage Reference Manual v6.6.rc2)"><tt class="xref py py-mod docutils literal"><span class="pre">quotient_ring</span></tt></a>.</p>
+<a class="reference external" href="../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring" title="(in Sage Reference Manual: General Rings, Ideals, and Morphisms v6.6.rc2)"><tt class="xref py py-mod docutils literal"><span class="pre">quotient_ring</span></tt></a>.</p>
```

which are good but I cannot explain.


---

Comment by jdemeyer created at 2015-04-09 12:10:36

New commits:


---

Comment by jdemeyer created at 2015-04-09 12:23:40

Hang on, it seems old-style classes might not have an `__init__` method...


---

Comment by git created at 2015-04-09 12:28:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-04-09 12:40:00

Replying to [comment:84 jdemeyer]:
> I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.

Do we want to keep these?

Your new changes seem good to me. Let's do tests.


---

Comment by jdemeyer created at 2015-04-09 12:52:05

Replying to [comment:89 SimonKing]:
> Replying to [comment:84 jdemeyer]:
> > I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.
> 
> Do we want to keep these?
No, I think the output is good. I was commenting. There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.


---

Comment by jdemeyer created at 2015-04-09 13:06:48

Can we remove the support for embedding information from `sagedoc.format`? I think that `format()` should take only "original" docstrings as input, i.e. without embedding information.


---

Comment by SimonKing created at 2015-04-09 13:09:34

Replying to [comment:90 jdemeyer]:
> There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.

I guess I am responsible for some of them. When I have a class whose instances are supposed to be created by a factory, I would document the "expected" way of using the class in the class' docstring. In the `__init__` docstring, I would provide technical details that are normally taken care of by the factory. In that way, the details are available to developers, but are hidden from (and can thus not confuse) the casual users.


---

Comment by SimonKing created at 2015-04-09 13:12:34

Replying to [comment:91 jdemeyer]:
> Can we remove the support for embedding information from `sagedoc.format`?

I thought that this was orthogonal to the "embedded information" question. In the sense that it is not format's job to remove the information.

Where would it be relevant? When doing `obj?`? What happens when `obj?` is typed? I guess `sagedoc.format` is applied in that case, but _what_ is it applied to?


---

Comment by jdemeyer created at 2015-04-09 13:14:58

Replying to [comment:93 SimonKing]:
> Replying to [comment:91 jdemeyer]:
> > Can we remove the support for embedding information from `sagedoc.format`?
> 
> I thought that this was orthogonal to the "embedded information" question. In the sense that it is not format's job to remove the information.
I'll read this as an agreement...

> What happens when `obj?` is typed?
I think that just calls `sageinspect.sage_getdoc`, which calls `format()` on the original (i.e. without embedding info) doc.


---

Comment by git created at 2015-04-09 13:28:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-09 13:30:32

I couldn't find any difference in behaviour between `foo?` or `foo??` with or without this patch.


---

Comment by jdemeyer created at 2015-04-09 13:34:06

What is this for?

```
getattr(init, 'im_class', None) == typ
```



---

Comment by git created at 2015-04-09 13:42:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-04-09 13:46:38

Replying to [comment:98 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[02ee3cc](http://git.sagemath.org/sage.git/commit/?id=02ee3cc5478de184783d64c609da0d9a083db9c2)||`Fix raise syntax`||

Thanks, I thought that `except (TypeError, AttributeError), err` assigns the caught error to `err`.


---

Comment by SimonKing created at 2015-04-09 13:48:55

Replying to [comment:97 jdemeyer]:
> What is this for?
> {{{
> getattr(init, 'im_class', None) == typ
> }}}

I wanted to test that the init method belongs to typ and is not inherited from a super class.

But on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.


---

Comment by SimonKing created at 2015-04-09 13:51:10

Replying to [comment:100 SimonKing]:
> I wanted to test that the init method belongs to typ and is not inherited from a super class.

The original rationale was this: The init method may contain embedding information for the class. If it is obtained from the super-class, then the embedding information belongs to a different class and is thus misleading.


---

Comment by jdemeyer created at 2015-04-09 13:52:03

Replying to [comment:100 SimonKing]:
> But on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.

I don't think this should be changed.
I would not like to see the doc of `Parent` just because esomething something inherits from `Parent`.


---

Comment by jdemeyer created at 2015-04-09 13:52:44

For me, this branch is good to go if you add some comment in the sources about this part:

```
            if (getattr(init, '__objclass__', None) or
                getattr(init, 'im_class', None)) == typ:
                return sage_getdoc_original(init)
```



---

Comment by SimonKing created at 2015-04-09 13:54:18

Replying to [comment:103 jdemeyer]:
> For me, this branch is good to go if you add some comment in the sources about this part:
> {{{
>             if (getattr(init, '__objclass__', None) or
>                 getattr(init, 'im_class', None)) == typ:
>                 return sage_getdoc_original(init)
> }}}

I will do so a bit later, as I have an appointment now.


---

Comment by jdemeyer created at 2015-04-09 14:34:50

Hmm, this patch doesn't behave so nicely for some of Python's docs:

```
sage: print type.__doc__
type(object) -> the object's type
type(name, bases, dict) -> a new type

sage: print sage_getdoc_original(type)
type(name, bases, dict) -> a new type
```


This causes

```
sage -t --long src/sage/repl/ipython_tests.py
**********************************************************************
File "src/sage/repl/ipython_tests.py", line 10, in sage.repl.ipython_tests
Failed example:
    shell.run_cell(u'%pinfo dummy')
Expected:
    Type:            function
    String form:     <function dummy at 0x...>
    File:            /.../sage/repl/ipython_tests.py
    Definition:      dummy(argument, optional=None)
    Docstring:
       Dummy Docstring Title
    <BLANKLINE>
       Dummy docstring explanation.
    <BLANKLINE>
       INPUT:
    <BLANKLINE>
       * "argument" -- anything. Dummy argument.
    <BLANKLINE>
       * "optional" -- anything (optional). Dummy optional.
    <BLANKLINE>
       EXAMPLES:
    ...
    Class docstring:
    function(code, globals[, name[, argdefs[, closure]]])
    <BLANKLINE>
    Create a function object from a code object and a dictionary. The
    optional name string overrides the name from the code object. The
    optional argdefs tuple specifies the default argument values. The
    optional closure tuple supplies the bindings for free variables.
    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature
Got:
    Type:            function
    String form:     <function dummy at 0x7f8a0ffe76e0>
    File:            /usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/repl/ipython_tests.py
    Definition:      dummy(argument, optional=None)
    Docstring:
       Dummy Docstring Title
    <BLANKLINE>
       Dummy docstring explanation.
    <BLANKLINE>
       INPUT:
    <BLANKLINE>
       * "argument" -- anything. Dummy argument.
    <BLANKLINE>
       * "optional" -- anything (optional). Dummy optional.
    <BLANKLINE>
       EXAMPLES:
    <BLANKLINE>
          sage: from sage.repl.ipython_tests import dummy sage: dummy(1)
          'Source code would be here'
    <BLANKLINE>
    Class docstring:
    Create a function object from a code object and a dictionary. The
    optional name string overrides the name from the code object. The
    optional argdefs tuple specifies the default argument values. The
    optional closure tuple supplies the bindings for free variables.
    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature
**********************************************************************
```



---

Comment by jdemeyer created at 2015-04-09 14:34:50

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2015-04-09 15:53:44

Replying to [comment:105 jdemeyer]:
> Hmm, this patch doesn't behave so nicely for some of Python's docs:
> {{{
> sage: print sage_getdoc_original(type)
> type(name, bases, dict) -> a new type
> }}}

Yes. That's because of my attempt to remove the signature. After all, what I have is only a heuristics.

How could we improve the heuristics? Special-case `type`? Test whether the first line ends with `')'`?

I'll finish a commit now. Please wait.


---

Comment by SimonKing created at 2015-04-09 16:01:03

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2015-04-09 16:01:41

Why has the branch that I just pushed be reverted???
----
New commits:


---

Comment by SimonKing created at 2015-04-09 16:02:13

Now it should be ready for review.


---

Comment by SimonKing created at 2015-04-10 09:28:18

Sorry that I didn't fix that doctest.
----
New commits:


---

Comment by jdemeyer created at 2015-04-10 15:08:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-14 19:43:56

Resolution: fixed
