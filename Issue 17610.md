# Issue 17610: Cython: embed signatures in docstrings

archive/issues_017610.json:
```json
{
    "body": "CC:  simonking\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17847\n\n",
    "created_at": "2015-02-24T10:39:40Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Cython: embed signatures in docstrings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17610",
    "user": "@jdemeyer"
}
```
CC:  simonking



Issue created by migration from https://trac.sagemath.org/ticket/17847





---

archive/issue_comments_235194.json:
```json
{
    "body": "The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`\n\nIn particular, I need help with navigating this maze:\n\n```python\ndef _sage_getsourcelines_name_with_dot(object):\n    r\"\"\"\n    [...]\n    AUTHOR:\n\n    - Simon King (2011-09)\n    \"\"\"\n    # First, split the name:\n    if '.' in object.__name__:\n        splitted_name = object.__name__.split('.')\n    elif hasattr(object,'__qualname__'):\n        splitted_name = object.__qualname__.split('.')\n    else:\n        splitted_name = object.__name__\n    path = object.__module__.split('.')+splitted_name[:-1]\n    name = splitted_name[-1]\n    try:\n        M = __import__(path.pop(0))\n    except ImportError:\n        try:\n            B = object.__base__\n            if B is None:\n                raise AttributeError\n        except AttributeError:\n            raise IOError(\"could not get source code\")\n        return sage_getsourcelines(B)\n    # M should just be the top-most module.\n    # Hence, normally it is just 'sage'\n    try:\n        while path:\n            M = getattr(M, path.pop(0))\n    except AttributeError:\n        try:\n            B = object.__base__\n            if B is None:\n                raise AttributeError\n        except AttributeError:\n            raise IOError(\"could not get source code\")\n        return sage_getsourcelines(B)\n\n    lines, base_lineno = sage_getsourcelines(M)\n    [...]\n```\n",
    "created_at": "2015-02-24T14:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235194",
    "user": "@jdemeyer"
}
```

The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`

In particular, I need help with navigating this maze:

```python
def _sage_getsourcelines_name_with_dot(object):
    r"""
    [...]
    AUTHOR:

    - Simon King (2011-09)
    """
    # First, split the name:
    if '.' in object.__name__:
        splitted_name = object.__name__.split('.')
    elif hasattr(object,'__qualname__'):
        splitted_name = object.__qualname__.split('.')
    else:
        splitted_name = object.__name__
    path = object.__module__.split('.')+splitted_name[:-1]
    name = splitted_name[-1]
    try:
        M = __import__(path.pop(0))
    except ImportError:
        try:
            B = object.__base__
            if B is None:
                raise AttributeError
        except AttributeError:
            raise IOError("could not get source code")
        return sage_getsourcelines(B)
    # M should just be the top-most module.
    # Hence, normally it is just 'sage'
    try:
        while path:
            M = getattr(M, path.pop(0))
    except AttributeError:
        try:
            B = object.__base__
            if B is None:
                raise AttributeError
        except AttributeError:
            raise IOError("could not get source code")
        return sage_getsourcelines(B)

    lines, base_lineno = sage_getsourcelines(M)
    [...]
```




---

archive/issue_comments_235195.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-24T14:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235195",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_235196.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`\n> \n> In particular, I need help with navigating this maze:\n> {{{\n> #!python\n> def _sage_getsourcelines_name_with_dot(object):\n> }}}\n\nThat's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.\n\nDetails: In the category framework we have all these nested dynamic classes which get a name that is formed by the name of a class they will be attribute of. Hence:\n\n```python\nclass Modules(Category):\n    def __init__(...):\n        ...\n    class Homset(Homset_generic):\n        def __init__(...)\n```\n\nHence, you have a class `Modules` and you have an attribute `Modules.Homset` that itself is a class (nested classes). Now, you will find:\n\n```\nsage: Modules.Homset.__name__\n'Modules.Homset'\n```\n\n\nHence, you will NOT find the source code of the class by searching the name in the source file. But the name does give you a possibility to find the code, namely by first searching for the source of the class `Modules` in the source file and then searching for the source of the class `Homset` in the source of `Modules`.\n\nIt isn't relevant for Cython classes, since there is a metaclass at work (and you can't have metaclass for Cython classes). It *could* perhaps be in a cython file, though.",
    "created_at": "2015-02-24T15:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235196",
    "user": "@simon-king-jena"
}
```

Replying to [comment:6 jdemeyer]:
> The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`
> 
> In particular, I need help with navigating this maze:
> {{{
> #!python
> def _sage_getsourcelines_name_with_dot(object):
> }}}

That's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.

Details: In the category framework we have all these nested dynamic classes which get a name that is formed by the name of a class they will be attribute of. Hence:

```python
class Modules(Category):
    def __init__(...):
        ...
    class Homset(Homset_generic):
        def __init__(...)
```

Hence, you have a class `Modules` and you have an attribute `Modules.Homset` that itself is a class (nested classes). Now, you will find:

```
sage: Modules.Homset.__name__
'Modules.Homset'
```


Hence, you will NOT find the source code of the class by searching the name in the source file. But the name does give you a possibility to find the code, namely by first searching for the source of the class `Modules` in the source file and then searching for the source of the class `Homset` in the source of `Modules`.

It isn't relevant for Cython classes, since there is a metaclass at work (and you can't have metaclass for Cython classes). It *could* perhaps be in a cython file, though.



---

archive/issue_comments_235197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-25T08:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235197",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235198.json:
```json
{
    "body": "Replying to [comment:9 SimonKing]:\n> Replying to [comment:6 jdemeyer]:\n> > The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`\n> > \n> > In particular, I need help with navigating this maze:\n> > {{{\n> > #!python\n> > def _sage_getsourcelines_name_with_dot(object):\n> > }}}\n> \n> That's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.\nApparently it *is* relevant, since I'm getting doctest failures in this function:\n\n```\nsage -t src/sage/misc/nested_class_test.py\n**********************************************************************\nFile \"src/sage/misc/nested_class_test.py\", line 215, in sage.misc.nested_class_test.TestNestedParent\nFailed example:\n    print sage_getsource(E)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 488, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 850, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.nested_class_test.TestNestedParent[5]>\", line 1, in <module>\n        print sage_getsource(E)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py\", line 1641, in sage_getsource\n        t = sage_getsourcelines(obj, is_binary)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py\", line 1895, in sage_getsourcelines\n        return obj._sage_src_lines_()\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 392, in _sage_src_lines\n        return sage_getsourcelines(doccls)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py\", line 1921, in sage_getsourcelines\n        return _sage_getsourcelines_name_with_dot(obj)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py\", line 1755, in _sage_getsourcelines_name_with_dot\n        raise IOError('could not find class definition')\n    IOError: could not find class definition\n**********************************************************************\n```\n",
    "created_at": "2015-02-25T09:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235198",
    "user": "@jdemeyer"
}
```

Replying to [comment:9 SimonKing]:
> Replying to [comment:6 jdemeyer]:
> > The attached branch mostly works, but there are still issues in `src/sage/misc/sageinspect.py`
> > 
> > In particular, I need help with navigating this maze:
> > {{{
> > #!python
> > def _sage_getsourcelines_name_with_dot(object):
> > }}}
> 
> That's for dynamic classes, hence, it is pure Python, and the embedding in docstrings isn't relevant here.
Apparently it *is* relevant, since I'm getting doctest failures in this function:

```
sage -t src/sage/misc/nested_class_test.py
**********************************************************************
File "src/sage/misc/nested_class_test.py", line 215, in sage.misc.nested_class_test.TestNestedParent
Failed example:
    print sage_getsource(E)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.nested_class_test.TestNestedParent[5]>", line 1, in <module>
        print sage_getsource(E)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1641, in sage_getsource
        t = sage_getsourcelines(obj, is_binary)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1895, in sage_getsourcelines
        return obj._sage_src_lines_()
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 392, in _sage_src_lines
        return sage_getsourcelines(doccls)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1921, in sage_getsourcelines
        return _sage_getsourcelines_name_with_dot(obj)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.py", line 1755, in _sage_getsourcelines_name_with_dot
        raise IOError('could not find class definition')
    IOError: could not find class definition
**********************************************************************
```




---

archive/issue_comments_235199.json:
```json
{
    "body": "The `TestNestedParent` does inherit from the Cython class `Parent`, perhaps that's how Cython comes in.",
    "created_at": "2015-02-25T09:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235199",
    "user": "@jdemeyer"
}
```

The `TestNestedParent` does inherit from the Cython class `Parent`, perhaps that's how Cython comes in.



---

archive/issue_comments_235200.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-07T09:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235200",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_235201.json:
```json
{
    "body": "Rebased and included upstream Cython patch, but it still doesn't work due to the issue with `_sage_getsourcelines_name_with_dot()`",
    "created_at": "2015-04-07T09:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235201",
    "user": "@jdemeyer"
}
```

Rebased and included upstream Cython patch, but it still doesn't work due to the issue with `_sage_getsourcelines_name_with_dot()`



---

archive/issue_comments_235202.json:
```json
{
    "body": "OK, I'll have a look.\n\nDo I need to do \"sage -ba\" to build it, or is that done automatically because of dependency checking?\n\nBest regards,\nSimon",
    "created_at": "2015-04-07T10:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235202",
    "user": "@simon-king-jena"
}
```

OK, I'll have a look.

Do I need to do "sage -ba" to build it, or is that done automatically because of dependency checking?

Best regards,
Simon



---

archive/issue_comments_235203.json:
```json
{
    "body": "\n```\nError building Sage.\n\nThe following package(s) may have failed to build:\n\npackage: sagenb-0.11.4\nlog file: /home/king/Sage/git/sage/logs/pkgs/sagenb-0.11.4.log\nbuild directory: /home/king/Sage/git/sage/local/var/tmp/sage/build/sagenb-0.11.4\n\nThe build directory may contain configuration files and other potentially\nhelpful information. WARNING: if you now run 'make' again, the build\ndirectory will, by default, be deleted. Set the environment variable\nSAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.\n\nMakefile:19: recipe for target 'build' failed\nmake: *** [build] Error 1\n```\n\n\nReason:\n\n```\nTraceback (most recent call last):\n  File \"/home/king/Sage/git/sage/local/bin/pip\", line 9, in <module>\n    load_entry_point('pip==1.5.6', 'console_scripts', 'pip')()\n  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 521, in load_entry_point\n  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2632, in load_entry_point\n  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2312, in load\n  File \"build/bdist.linux-x86_64/egg/pkg_resources/__init__.py\", line 2318, in resolve\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/__init__.py\", l\nine 10, in <module>\n    from pip.util import get_installed_distributions, get_prog\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/util.py\", line \n18, in <module>\n    from pip._vendor.distlib import version\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib\n/version.py\", line 14, in <module>\n    from .compat import string_types\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib\n/compat.py\", line 31, in <module>\n    from urllib2 import (Request, urlopen, URLError, HTTPError,\nImportError: cannot import name HTTPSHandler\nError: Installing SageNB failed.\n```\n\nWhy does pip come into play here? Isn't pip optional?",
    "created_at": "2015-04-07T10:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235203",
    "user": "@simon-king-jena"
}
```


```
Error building Sage.

The following package(s) may have failed to build:

package: sagenb-0.11.4
log file: /home/king/Sage/git/sage/logs/pkgs/sagenb-0.11.4.log
build directory: /home/king/Sage/git/sage/local/var/tmp/sage/build/sagenb-0.11.4

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

Makefile:19: recipe for target 'build' failed
make: *** [build] Error 1
```


Reason:

```
Traceback (most recent call last):
  File "/home/king/Sage/git/sage/local/bin/pip", line 9, in <module>
    load_entry_point('pip==1.5.6', 'console_scripts', 'pip')()
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 521, in load_entry_point
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2632, in load_entry_point
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2312, in load
  File "build/bdist.linux-x86_64/egg/pkg_resources/__init__.py", line 2318, in resolve
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/__init__.py", l
ine 10, in <module>
    from pip.util import get_installed_distributions, get_prog
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/util.py", line 
18, in <module>
    from pip._vendor.distlib import version
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib
/version.py", line 14, in <module>
    from .compat import string_types
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/pip-1.5.6-py2.7.egg/pip/_vendor/distlib
/compat.py", line 31, in <module>
    from urllib2 import (Request, urlopen, URLError, HTTPError,
ImportError: cannot import name HTTPSHandler
Error: Installing SageNB failed.
```

Why does pip come into play here? Isn't pip optional?



---

archive/issue_comments_235204.json:
```json
{
    "body": "Note that I do have pip installed in Sage.",
    "created_at": "2015-04-07T10:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235204",
    "user": "@simon-king-jena"
}
```

Note that I do have pip installed in Sage.



---

archive/issue_comments_235205.json:
```json
{
    "body": "Replying to [comment:19 SimonKing]:\n> Do I need to do \"sage -ba\" to build it\nNo (and if you do, that's a bug).",
    "created_at": "2015-04-07T11:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235205",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 SimonKing]:
> Do I need to do "sage -ba" to build it
No (and if you do, that's a bug).



---

archive/issue_comments_235206.json:
```json
{
    "body": "Replying to [comment:20 SimonKing]:\n> Why does pip come into play here?\nThis is #18131.\n\n> Isn't pip optional?\nNot anymore.",
    "created_at": "2015-04-07T11:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235206",
    "user": "@jdemeyer"
}
```

Replying to [comment:20 SimonKing]:
> Why does pip come into play here?
This is #18131.

> Isn't pip optional?
Not anymore.



---

archive/issue_comments_235207.json:
```json
{
    "body": "First observation: The underlying problem appears to not be in `_sage_getsourcelines_name_with_dot`.\n\nNamely, the reason why the element class' source can not be found is that the \"parent\" class can not be found:\n\n```\nsage: from sage.misc.sageinspect import sage_getsourcelines\nsage: from sage.misc.nested_class_test import TestNestedParent\nsage: sage_getsourcelines(TestNestedParent)[0][0]\n'cdef class Parent(category_object.CategoryObject):\\n'\n```\n\nSo, we need to find out why `sage_getsourcelines` returns the sources of `Parent` (a super-class of `TestNestedParent`).\n\n\n```\nsage: from sage.misc.sageinspect import sage_getfile\nsage: sage_getfile(TestNestedParent)\n'/home/king/Sage/git/sage/src/sage/structure/parent.pyx'\n```\n\nOK, that's wrong.",
    "created_at": "2015-04-07T17:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235207",
    "user": "@simon-king-jena"
}
```

First observation: The underlying problem appears to not be in `_sage_getsourcelines_name_with_dot`.

Namely, the reason why the element class' source can not be found is that the "parent" class can not be found:

```
sage: from sage.misc.sageinspect import sage_getsourcelines
sage: from sage.misc.nested_class_test import TestNestedParent
sage: sage_getsourcelines(TestNestedParent)[0][0]
'cdef class Parent(category_object.CategoryObject):\n'
```

So, we need to find out why `sage_getsourcelines` returns the sources of `Parent` (a super-class of `TestNestedParent`).


```
sage: from sage.misc.sageinspect import sage_getfile
sage: sage_getfile(TestNestedParent)
'/home/king/Sage/git/sage/src/sage/structure/parent.pyx'
```

OK, that's wrong.



---

archive/issue_comments_235208.json:
```json
{
    "body": "`sage_getfile` relatively early tries to extract the file from the docstring --- and when it fails, then it tries to extract it from the `__init__` of the object!\n\nSo, since `TestNestedParent.__init__` is the same as `Parent.__init__`, things become wrong.",
    "created_at": "2015-04-07T17:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235208",
    "user": "@simon-king-jena"
}
```

`sage_getfile` relatively early tries to extract the file from the docstring --- and when it fails, then it tries to extract it from the `__init__` of the object!

So, since `TestNestedParent.__init__` is the same as `Parent.__init__`, things become wrong.



---

archive/issue_comments_235209.json:
```json
{
    "body": "Note that in the present case, Python's `inspect.getfile` returns the right thing.",
    "created_at": "2015-04-07T17:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235209",
    "user": "@simon-king-jena"
}
```

Note that in the present case, Python's `inspect.getfile` returns the right thing.



---

archive/issue_comments_235210.json:
```json
{
    "body": "Oops:\n\n```\nsage: from sage.misc.sageinspect import _sage_getdoc_unformatted\nsage: print _sage_getdoc_unformatted(TestNestedParent)\nFile: sage/structure/parent.pyx (starting at line 228)\n\n        Base class for all parents.\n\n        Parents are the Sage/mathematical analogues of container\n        objects in computer science.\n\n...\n```\n\nSo, even though `TestNestedParent` has its own docstring, `_sage_getdoc_unformatted` ignores it.",
    "created_at": "2015-04-07T18:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235210",
    "user": "@simon-king-jena"
}
```

Oops:

```
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: print _sage_getdoc_unformatted(TestNestedParent)
File: sage/structure/parent.pyx (starting at line 228)

        Base class for all parents.

        Parents are the Sage/mathematical analogues of container
        objects in computer science.

...
```

So, even though `TestNestedParent` has its own docstring, `_sage_getdoc_unformatted` ignores it.



---

archive/issue_comments_235211.json:
```json
{
    "body": "... and that's on purpose, according to the documentation of `_sage_getdoc_unformatted`:\n\n```\nIf ``__init__`` has embedding information, we prefer that::\n\n        sage: C = QQ['x', 'y'].__class__\n        sage: print C.__doc__\n        MPolynomialRing_libsingular(base_ring, n, names, order='degrevlex')\n        sage: print C.__init__.__doc__\n        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)\n        <BLANKLINE>\n                Construct a multivariate polynomial ring...\n        sage: print _sage_getdoc_unformatted(C)\n        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)\n        <BLANKLINE>\n                Construct a multivariate polynomial ring...\n```\n\nThus, `_sage_getdoc_unformatted` is the wrong tool for our purpose, since we do *not* want to prefer the doc of `__init__`.\n\nAlso: What happens if a class derived from `Parent` has no docstring?",
    "created_at": "2015-04-07T18:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235211",
    "user": "@simon-king-jena"
}
```

... and that's on purpose, according to the documentation of `_sage_getdoc_unformatted`:

```
If ``__init__`` has embedding information, we prefer that::

        sage: C = QQ['x', 'y'].__class__
        sage: print C.__doc__
        MPolynomialRing_libsingular(base_ring, n, names, order='degrevlex')
        sage: print C.__init__.__doc__
        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)
        <BLANKLINE>
                Construct a multivariate polynomial ring...
        sage: print _sage_getdoc_unformatted(C)
        File: sage/rings/polynomial/multi_polynomial_libsingular.pyx (starting at line ...)
        <BLANKLINE>
                Construct a multivariate polynomial ring...
```

Thus, `_sage_getdoc_unformatted` is the wrong tool for our purpose, since we do *not* want to prefer the doc of `__init__`.

Also: What happens if a class derived from `Parent` has no docstring?



---

archive/issue_comments_235212.json:
```json
{
    "body": "At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would *not* prefer the doc of `__init__` if an embedding information is missing.",
    "created_at": "2015-04-07T19:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235212",
    "user": "@simon-king-jena"
}
```

At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would *not* prefer the doc of `__init__` if an embedding information is missing.



---

archive/issue_comments_235213.json:
```json
{
    "body": "Replying to [comment:29 SimonKing]:\n> At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would *not* prefer the doc of `__init__` if an embedding information is missing.\n\nIt does solve the current problem. And after all, I think it is not the job of `_sage_getdoc_unformatted` to search for embedding information. If some functions absolutely want to get embedding information, then it is *their* job to search the information. Of course I need to see how much would break.",
    "created_at": "2015-04-07T19:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235213",
    "user": "@simon-king-jena"
}
```

Replying to [comment:29 SimonKing]:
> At the moment, I try to find out what happens if `_sage_getdoc_unformatted` would *not* prefer the doc of `__init__` if an embedding information is missing.

It does solve the current problem. And after all, I think it is not the job of `_sage_getdoc_unformatted` to search for embedding information. If some functions absolutely want to get embedding information, then it is *their* job to search the information. Of course I need to see how much would break.



---

archive/issue_comments_235214.json:
```json
{
    "body": "Note that the following crashes:\n\n```\n    sage: class Foo:\n    ....:     def __init__(self):\n    ....:         'docstring'\n    ....:         pass\n    sage: import inspect\n    sage: inspect.getsource(Foo)\n```\n\nThat's strange, since it is all pure Python, and since\n\n```\nsage: inspect.getsource(Foo.__init__)\n```\n\nworks.\n\nEven more strange: In `getsource(Foo.__init__)`, the whole source of `Foo` is determined. Hence, it *it* possible to get the source of `Foo`. That's a bug in Python's inspect.getsource.\n\nI wonder if we should fix that. Certainly not here, though.",
    "created_at": "2015-04-07T20:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235214",
    "user": "@simon-king-jena"
}
```

Note that the following crashes:

```
    sage: class Foo:
    ....:     def __init__(self):
    ....:         'docstring'
    ....:         pass
    sage: import inspect
    sage: inspect.getsource(Foo)
```

That's strange, since it is all pure Python, and since

```
sage: inspect.getsource(Foo.__init__)
```

works.

Even more strange: In `getsource(Foo.__init__)`, the whole source of `Foo` is determined. Hence, it *it* possible to get the source of `Foo`. That's a bug in Python's inspect.getsource.

I wonder if we should fix that. Certainly not here, though.



---

archive/issue_comments_235215.json:
```json
{
    "body": "Meanwhile I became aware that the it was in your commits that `_sage_getdoc_unformatted` was changed to actively search for docstrings with embedding information. I am preparing a commit that reverts it. \n\nI really think the job of `_sage_getdoc_unformatted(obj)` is to get the docstring of `obj` without formatting. The user of `_sage_getdoc_unformatted` has to decide for him or herself whether `obj.__init__.__doc__` would be more useful than `obj.__doc__`.\n\nSomething else: Do I see that correctly that you did not change `sage_getargspec` to using the new embedded information on the argspec? Or is Python's `inspect.getargspec` using that information, so that we will benefit from it implicitly?",
    "created_at": "2015-04-07T21:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235215",
    "user": "@simon-king-jena"
}
```

Meanwhile I became aware that the it was in your commits that `_sage_getdoc_unformatted` was changed to actively search for docstrings with embedding information. I am preparing a commit that reverts it. 

I really think the job of `_sage_getdoc_unformatted(obj)` is to get the docstring of `obj` without formatting. The user of `_sage_getdoc_unformatted` has to decide for him or herself whether `obj.__init__.__doc__` would be more useful than `obj.__doc__`.

Something else: Do I see that correctly that you did not change `sage_getargspec` to using the new embedded information on the argspec? Or is Python's `inspect.getargspec` using that information, so that we will benefit from it implicitly?



---

archive/issue_comments_235216.json:
```json
{
    "body": "Something else is not good. The purpose of this ticket is to embed signatures into docstrings. Well, it isn't done even with the ticket branch:\n\n```\nsage: cython(\"\"\"\n....: class Foo:\n....:     def __init__(self, bla, int x):\n....:         pass\n....: \"\"\")\nsage: Foo.__init__.__doc__\n'File: _home_king__sage_temp_linux_va3e_site_18607_tmp_QtW4tF_spyx_0.pyx (starting at line 8)'\n```\n\nIn other words, the file information is in the docstring, but the signature is missing.\n\nWhy is that?",
    "created_at": "2015-04-07T21:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235216",
    "user": "@simon-king-jena"
}
```

Something else is not good. The purpose of this ticket is to embed signatures into docstrings. Well, it isn't done even with the ticket branch:

```
sage: cython("""
....: class Foo:
....:     def __init__(self, bla, int x):
....:         pass
....: """)
sage: Foo.__init__.__doc__
'File: _home_king__sage_temp_linux_va3e_site_18607_tmp_QtW4tF_spyx_0.pyx (starting at line 8)'
```

In other words, the file information is in the docstring, but the signature is missing.

Why is that?



---

archive/issue_comments_235217.json:
```json
{
    "body": "The doctests pass with my new commit.\n\nHowever, two issues should be addressed:\n- The signature for interactively defined Cython methods (I don't know if \"interactive\" is the reason why it fails) should be embedded, too\n- The embedded signature should be used in sage_getargspec. There should be a function that extracts both the method/function name and the argspec from the embedded signature.\n----\nNew commits:",
    "created_at": "2015-04-07T21:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235217",
    "user": "@simon-king-jena"
}
```

The doctests pass with my new commit.

However, two issues should be addressed:
- The signature for interactively defined Cython methods (I don't know if "interactive" is the reason why it fails) should be embedded, too
- The embedded signature should be used in sage_getargspec. There should be a function that extracts both the method/function name and the argspec from the embedded signature.
----
New commits:



---

archive/issue_comments_235218.json:
```json
{
    "body": "There is some more error in `sage -t src/sage/sets/set_from_iterator.py`, which is caused by additional blank lines at the beginning of what `sage_getdoc` returns. Ought to be fixed one way or another (tomorrow).",
    "created_at": "2015-04-07T21:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235218",
    "user": "@simon-king-jena"
}
```

There is some more error in `sage -t src/sage/sets/set_from_iterator.py`, which is caused by additional blank lines at the beginning of what `sage_getdoc` returns. Ought to be fixed one way or another (tomorrow).



---

archive/issue_comments_235219.json:
```json
{
    "body": "Replying to [comment:33 SimonKing]:\n> Why is that?\nMost likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)",
    "created_at": "2015-04-08T06:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235219",
    "user": "@jdemeyer"
}
```

Replying to [comment:33 SimonKing]:
> Why is that?
Most likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)



---

archive/issue_comments_235220.json:
```json
{
    "body": "Both these issues are outside the scope of this ticket.",
    "created_at": "2015-04-08T06:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235220",
    "user": "@jdemeyer"
}
```

Both these issues are outside the scope of this ticket.



---

archive/issue_comments_235221.json:
```json
{
    "body": "Replying to [comment:37 jdemeyer]:\n> Replying to [comment:33 SimonKing]:\n> > Why is that?\n> Most likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)\n\nWhy do you think it is outside the scope of this ticket? It is about Cython embedding the signature into docstring, and I don't see why Cython should distinguish `sage -b` from compilation of interactive code.\n\nFor sure, we can only use the embedded signature when it is *uniformely* embedded. Otherwise I don't see the point of embedding.\n\nWhat about the additional blank line in a doc string? Do you think we should simply insert it into the failing test in `src/sage/sets/set_from_iterator.py`, or make it so that there is no additional blankline?",
    "created_at": "2015-04-08T08:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235221",
    "user": "@simon-king-jena"
}
```

Replying to [comment:37 jdemeyer]:
> Replying to [comment:33 SimonKing]:
> > Why is that?
> Most likely, it is because `cython()` works completely independently from `./sage -b` (this is certainly a bug, but outside the scope of this ticket)

Why do you think it is outside the scope of this ticket? It is about Cython embedding the signature into docstring, and I don't see why Cython should distinguish `sage -b` from compilation of interactive code.

For sure, we can only use the embedded signature when it is *uniformely* embedded. Otherwise I don't see the point of embedding.

What about the additional blank line in a doc string? Do you think we should simply insert it into the failing test in `src/sage/sets/set_from_iterator.py`, or make it so that there is no additional blankline?



---

archive/issue_comments_235222.json:
```json
{
    "body": "Replying to [comment:39 SimonKing]:\n> Why do you think it is outside the scope of this ticket?\nBecause the actual bug is that `cython()` works differently from `./sage -b`. This issue has nothing to do with `embedsignature` and it is also much broader than `embedsignature`. Did you know that even `print -1/3` behaves differently in `cython()` than in Sage library Cython code?\n\nFixing this has been on my Cython TODO list for a long time, but I currently have too many tickets related to Cython that they would surely conflict.",
    "created_at": "2015-04-08T09:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235222",
    "user": "@jdemeyer"
}
```

Replying to [comment:39 SimonKing]:
> Why do you think it is outside the scope of this ticket?
Because the actual bug is that `cython()` works differently from `./sage -b`. This issue has nothing to do with `embedsignature` and it is also much broader than `embedsignature`. Did you know that even `print -1/3` behaves differently in `cython()` than in Sage library Cython code?

Fixing this has been on my Cython TODO list for a long time, but I currently have too many tickets related to Cython that they would surely conflict.



---

archive/issue_comments_235223.json:
```json
{
    "body": "Replying to [comment:39 SimonKing]:\n> What about the additional blank line in a doc string?\nFixed by this extra commit.\n\nNote however that `make doc` still fails...\n----\nNew commits:",
    "created_at": "2015-04-08T10:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235223",
    "user": "@jdemeyer"
}
```

Replying to [comment:39 SimonKing]:
> What about the additional blank line in a doc string?
Fixed by this extra commit.

Note however that `make doc` still fails...
----
New commits:



---

archive/issue_comments_235224.json:
```json
{
    "body": "\n```\nsage -t src/doc/en/developer/coding_basics.rst\n**********************************************************************\nFile \"src/doc/en/developer/coding_basics.rst\", line 501, in doc.en.developer.coding_basics\nFailed example:\n    sage_getdoc(foo)              # class docstring\nExpected:\n    'Construct a Foo.\\n'\nGot:\n    ''\n**********************************************************************\n```\n",
    "created_at": "2015-04-08T12:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235224",
    "user": "@jdemeyer"
}
```


```
sage -t src/doc/en/developer/coding_basics.rst
**********************************************************************
File "src/doc/en/developer/coding_basics.rst", line 501, in doc.en.developer.coding_basics
Failed example:
    sage_getdoc(foo)              # class docstring
Expected:
    'Construct a Foo.\n'
Got:
    ''
**********************************************************************
```




---

archive/issue_comments_235225.json:
```json
{
    "body": "Replying to [comment:44 jdemeyer]:\n> sage -t src/doc/en/developer/coding_basics.rst\n\nStrange, I didn't notice this one.\n\nAnyway, I suppose if make doc fails, that's more serious.",
    "created_at": "2015-04-08T14:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235225",
    "user": "@simon-king-jena"
}
```

Replying to [comment:44 jdemeyer]:
> sage -t src/doc/en/developer/coding_basics.rst

Strange, I didn't notice this one.

Anyway, I suppose if make doc fails, that's more serious.



---

archive/issue_comments_235226.json:
```json
{
    "body": "The make doc error says:\n\n```\nOSError: [polynomia] docstring of sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative:1: WARNING: Inline emphasis start-string without end-string.\n```\n\n\nThe doc string is:\n\n```\nsage: print sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative.__doc__\nLaurentPolynomial_mpair.derivative(self, *args)\nFile: sage/rings/polynomial/laurent_polynomial.pyx (starting at line 2283)\n\n        The formal derivative of this Laurent polynomial, with respect\n        to variables supplied in args.\n\n        Multiple variables and iteration counts may be supplied; see\n        documentation for the global derivative() function for more\n        details.\n\n        .. seealso::\n\n           :meth:`_derivative`\n\n        EXAMPLES::\n\n            sage: R = LaurentPolynomialRing(ZZ,'x, y')\n            sage: x, y = R.gens()\n            sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)\n            sage: t.derivative(x, x)\n            12*x^2*y + 2*x^-3\n            sage: t.derivative(y, 2)\n            12*y^-5\n```\n\n`*args` would be interpreted as an emphasis to the text of the docstring, which indeed isn't ended by another `*`.\n\nBut isn't sage_getdoc called for creating the docs? It *does* strip the embedded information!\n\n```\nsage: print sage.misc.sageinspect.sage_getdoc(sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative)\n   The formal derivative of this Laurent polynomial, with respect to\n   variables supplied in args.\n\n   Multiple variables and iteration counts may be supplied; see\n   documentation for the global derivative() function for more\n   details.\n\n   See also: \"_derivative()\"\n\n   EXAMPLES:\n\n      sage: R = LaurentPolynomialRing(ZZ,'x, y')\n      sage: x, y = R.gens()\n      sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)\n      sage: t.derivative(x, x)\n      12*x^2*y + 2*x^-3\n      sage: t.derivative(y, 2)\n      12*y^-5\n```\n\nOr is `_sage_getdoc_unformatted` used to build the docs?",
    "created_at": "2015-04-08T15:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235226",
    "user": "@simon-king-jena"
}
```

The make doc error says:

```
OSError: [polynomia] docstring of sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative:1: WARNING: Inline emphasis start-string without end-string.
```


The doc string is:

```
sage: print sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative.__doc__
LaurentPolynomial_mpair.derivative(self, *args)
File: sage/rings/polynomial/laurent_polynomial.pyx (starting at line 2283)

        The formal derivative of this Laurent polynomial, with respect
        to variables supplied in args.

        Multiple variables and iteration counts may be supplied; see
        documentation for the global derivative() function for more
        details.

        .. seealso::

           :meth:`_derivative`

        EXAMPLES::

            sage: R = LaurentPolynomialRing(ZZ,'x, y')
            sage: x, y = R.gens()
            sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)
            sage: t.derivative(x, x)
            12*x^2*y + 2*x^-3
            sage: t.derivative(y, 2)
            12*y^-5
```

`*args` would be interpreted as an emphasis to the text of the docstring, which indeed isn't ended by another `*`.

But isn't sage_getdoc called for creating the docs? It *does* strip the embedded information!

```
sage: print sage.misc.sageinspect.sage_getdoc(sage.rings.polynomial.laurent_polynomial.LaurentPolynomial_mpair.derivative)
   The formal derivative of this Laurent polynomial, with respect to
   variables supplied in args.

   Multiple variables and iteration counts may be supplied; see
   documentation for the global derivative() function for more
   details.

   See also: "_derivative()"

   EXAMPLES:

      sage: R = LaurentPolynomialRing(ZZ,'x, y')
      sage: x, y = R.gens()
      sage: t = x**4*y+x*y+y+x**(-1)+y**(-3)
      sage: t.derivative(x, x)
      12*x^2*y + 2*x^-3
      sage: t.derivative(y, 2)
      12*y^-5
```

Or is `_sage_getdoc_unformatted` used to build the docs?



---

archive/issue_comments_235227.json:
```json
{
    "body": "Replying to [comment:46 SimonKing]:\n> Or is `_sage_getdoc_unformatted` used to build the docs?\n\nThat's certainly the intention of `src/doc/common/sage_autodoc.py`",
    "created_at": "2015-04-08T15:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235227",
    "user": "@jdemeyer"
}
```

Replying to [comment:46 SimonKing]:
> Or is `_sage_getdoc_unformatted` used to build the docs?

That's certainly the intention of `src/doc/common/sage_autodoc.py`



---

archive/issue_comments_235228.json:
```json
{
    "body": "Replying to [comment:47 jdemeyer]:\n> Replying to [comment:46 SimonKing]:\n> > Or is `_sage_getdoc_unformatted` used to build the docs?\n> \n> That's certainly the intention of `src/doc/common/sage_autodoc.py`\n\nThanks! Shouldn't sage_getdoc be used instead? Anyway, the embedded information does in my opinion not belong into the reference manual. Hence, it needs to be stripped one way or another. And if sage_autodoc has a custom way of stripping, then either the custom way should be changed to take into account the new embedded signature, or it should use a specialised tool (namely sage_getdoc) right away.",
    "created_at": "2015-04-08T15:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235228",
    "user": "@simon-king-jena"
}
```

Replying to [comment:47 jdemeyer]:
> Replying to [comment:46 SimonKing]:
> > Or is `_sage_getdoc_unformatted` used to build the docs?
> 
> That's certainly the intention of `src/doc/common/sage_autodoc.py`

Thanks! Shouldn't sage_getdoc be used instead? Anyway, the embedded information does in my opinion not belong into the reference manual. Hence, it needs to be stripped one way or another. And if sage_autodoc has a custom way of stripping, then either the custom way should be changed to take into account the new embedded signature, or it should use a specialised tool (namely sage_getdoc) right away.



---

archive/issue_comments_235229.json:
```json
{
    "body": "I agree, let me work on a fix.",
    "created_at": "2015-04-08T15:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235229",
    "user": "@jdemeyer"
}
```

I agree, let me work on a fix.



---

archive/issue_comments_235230.json:
```json
{
    "body": "Am I right that stripping the old embedding information is stripped by stuff from `sphinx.util`?",
    "created_at": "2015-04-08T15:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235230",
    "user": "@simon-king-jena"
}
```

Am I right that stripping the old embedding information is stripped by stuff from `sphinx.util`?



---

archive/issue_comments_235231.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-08T16:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235231",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235232.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-08T16:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235232",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235233.json:
```json
{
    "body": "It looks like there is still an issue with cached functions:\n\n```\nsage: from sage.misc.sageinspect import _sage_getdoc_unformatted\nsage: print _sage_getdoc_unformatted(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)\nFile: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)\nFiniteField.algebraic_closure(self, name='z', **kwds)\nFile: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)\n\n        Return an algebraic closure of ``self``.\n...\n```\n",
    "created_at": "2015-04-08T16:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235233",
    "user": "@jdemeyer"
}
```

It looks like there is still an issue with cached functions:

```
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: print _sage_getdoc_unformatted(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)

        Return an algebraic closure of ``self``.
...
```




---

archive/issue_comments_235234.json:
```json
{
    "body": "`make doc` still fails. I see several errors.\n\nOne error looks like this:\n\n```\n[combinat ] /home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/__init__.py:docstring of sage.combinat:39: WARNING: undefined label: sage.coding (if the link has no caption the label must precede a section header)\n```\n\nNo idea what that means.\n\nAnother error:\n\n```\n[finite_ri] docstring of sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure:1: WARNING: Inline strong start-string without end-string.\n```\n\nThat again seems like a failing removal of `**kwds` from the signature, or similar problems.\nIndeed:\n\n```\nsage: print sage_getdoc_original(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)\nFiniteField.algebraic_closure(self, name='z', **kwds)\nFile: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)\n\n        Return an algebraic closure of ``self``.\n\n        INPUT:\n...\n```\n\nSo, although `sage_getdoc_original` is supposed to strip the embedding information, it doesn't!\n\nYou are right, it seems to be a problem with cached methods.",
    "created_at": "2015-04-08T16:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235234",
    "user": "@simon-king-jena"
}
```

`make doc` still fails. I see several errors.

One error looks like this:

```
[combinat ] /home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/combinat/__init__.py:docstring of sage.combinat:39: WARNING: undefined label: sage.coding (if the link has no caption the label must precede a section header)
```

No idea what that means.

Another error:

```
[finite_ri] docstring of sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure:1: WARNING: Inline strong start-string without end-string.
```

That again seems like a failing removal of `**kwds` from the signature, or similar problems.
Indeed:

```
sage: print sage_getdoc_original(sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)

        Return an algebraic closure of ``self``.

        INPUT:
...
```

So, although `sage_getdoc_original` is supposed to strip the embedding information, it doesn't!

You are right, it seems to be a problem with cached methods.



---

archive/issue_comments_235235.json:
```json
{
    "body": "Aha, the embedding information is inserted twice:\n\n```\nsage: obj = sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure\nsage: s = _sage_getdoc_unformatted(obj)\nsage: print s\nFile: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)\nFiniteField.algebraic_closure(self, name='z', **kwds)\nFile: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)\n...\n```\n\nI guess that happens in the cached_method's _sage_doc_ method.",
    "created_at": "2015-04-08T16:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235235",
    "user": "@simon-king-jena"
}
```

Aha, the embedding information is inserted twice:

```
sage: obj = sage.rings.finite_rings.finite_field_base.FiniteField.algebraic_closure
sage: s = _sage_getdoc_unformatted(obj)
sage: print s
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
FiniteField.algebraic_closure(self, name='z', **kwds)
File: sage/rings/finite_rings/finite_field_base.pyx (starting at line 1278)
...
```

I guess that happens in the cached_method's _sage_doc_ method.



---

archive/issue_comments_235236.json:
```json
{
    "body": "Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.\n\nLet me fix it, please, I guess I'll be done in 5 minutes.",
    "created_at": "2015-04-08T17:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235236",
    "user": "@simon-king-jena"
}
```

Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.

Let me fix it, please, I guess I'll be done in 5 minutes.



---

archive/issue_comments_235237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-08T17:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235237",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235238.json:
```json
{
    "body": "Replying to [comment:56 SimonKing]:\n> Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.\n> \n> Let me fix it, please, I guess I'll be done in 5 minutes.\nToo late...",
    "created_at": "2015-04-08T17:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235238",
    "user": "@jdemeyer"
}
```

Replying to [comment:56 SimonKing]:
> Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.
> 
> Let me fix it, please, I guess I'll be done in 5 minutes.
Too late...



---

archive/issue_comments_235239.json:
```json
{
    "body": "This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:\n\n```\nsage: print sage.structure.parent.Parent.__doc__\nParent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)\n```\n\n\nThis should be fixed since now this causes `make doc` to fail.\n\nI'll leave this ticket alone for today, so you can make changes if you want.",
    "created_at": "2015-04-08T17:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235239",
    "user": "@jdemeyer"
}
```

This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:

```
sage: print sage.structure.parent.Parent.__doc__
Parent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)
```


This should be fixed since now this causes `make doc` to fail.

I'll leave this ticket alone for today, so you can make changes if you want.



---

archive/issue_comments_235240.json:
```json
{
    "body": "Replying to [comment:58 jdemeyer]:\n> Replying to [comment:56 SimonKing]:\n> > Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.\n> > \n> > Let me fix it, please, I guess I'll be done in 5 minutes.\n> Too late...\n\nBad. I just pushed it.\n----\nNew commits:",
    "created_at": "2015-04-08T17:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235240",
    "user": "@simon-king-jena"
}
```

Replying to [comment:58 jdemeyer]:
> Replying to [comment:56 SimonKing]:
> > Yep, I found the problem: cached_method's _sage_doc_ only looks for the first line of the original docstring to extract information from. Instead, the whole docstring should be passed to _extract_embedded_position.
> > 
> > Let me fix it, please, I guess I'll be done in 5 minutes.
> Too late...

Bad. I just pushed it.
----
New commits:



---

archive/issue_comments_235241.json:
```json
{
    "body": "Actually I don't like your way of fixing it. If I understand correctly, we *do* want to insert embedding information into the doc of a cached function, even if the embedding information is missing in the doc of the wrapped function.\n\nSo, I suggest we work on top of the now attached branch.\n\nIn any case, the `Parent` problem persists.",
    "created_at": "2015-04-08T17:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235241",
    "user": "@simon-king-jena"
}
```

Actually I don't like your way of fixing it. If I understand correctly, we *do* want to insert embedding information into the doc of a cached function, even if the embedding information is missing in the doc of the wrapped function.

So, I suggest we work on top of the now attached branch.

In any case, the `Parent` problem persists.



---

archive/issue_comments_235242.json:
```json
{
    "body": "Replying to [comment:59 jdemeyer]:\n> This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:\n> {{{\n> sage: print sage.structure.parent.Parent.__doc__\n> Parent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)\n> }}}\n\nWhy is that? If there is no doc string, shouldn't Cython change it so that it consists of the signature and the embedding information? Why is the embedding information not inserted?",
    "created_at": "2015-04-08T17:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235242",
    "user": "@simon-king-jena"
}
```

Replying to [comment:59 jdemeyer]:
> This is the reason why the docstring of `__init__` was preferred when `__doc__` contains no embedding information:
> {{{
> sage: print sage.structure.parent.Parent.__doc__
> Parent(base=None, category=None, *, element_constructor=None, gens=None, names=None, normalize=True, facade=None, **kwds)
> }}}

Why is that? If there is no doc string, shouldn't Cython change it so that it consists of the signature and the embedding information? Why is the embedding information not inserted?



---

archive/issue_comments_235243.json:
```json
{
    "body": "Replying to [comment:62 SimonKing]:\n> If I understand correctly, we *do* want to insert embedding information into the doc of a cached function\nWhy should the cached function change *anything* to the doc? I think it should just pass through the original documentation unchanged.",
    "created_at": "2015-04-08T17:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235243",
    "user": "@jdemeyer"
}
```

Replying to [comment:62 SimonKing]:
> If I understand correctly, we *do* want to insert embedding information into the doc of a cached function
Why should the cached function change *anything* to the doc? I think it should just pass through the original documentation unchanged.



---

archive/issue_comments_235244.json:
```json
{
    "body": "I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.\n\nWhen we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.\n\nI'll try to figure out how it works.",
    "created_at": "2015-04-08T17:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235244",
    "user": "@simon-king-jena"
}
```

I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.

When we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.

I'll try to figure out how it works.



---

archive/issue_comments_235245.json:
```json
{
    "body": "Replying to [comment:64 jdemeyer]:\n> Why should the cached function change *anything* to the doc? I think it should just pass through the original documentation unchanged.\n\nFor the same reason that Cython inserts additional information to the doc. It helps to retrieve file information. As you have observed, we have no `_sage_file_` method, but only have `_sage_doc_` and `_sage_argspec_`. We would need to have such method, if we would not insert the embedding information of the *original function* into the doc of the *cached function*.\n\nActually, having the signature embedded may help to remove the `_sage_argspec_` method!",
    "created_at": "2015-04-08T17:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235245",
    "user": "@simon-king-jena"
}
```

Replying to [comment:64 jdemeyer]:
> Why should the cached function change *anything* to the doc? I think it should just pass through the original documentation unchanged.

For the same reason that Cython inserts additional information to the doc. It helps to retrieve file information. As you have observed, we have no `_sage_file_` method, but only have `_sage_doc_` and `_sage_argspec_`. We would need to have such method, if we would not insert the embedding information of the *original function* into the doc of the *cached function*.

Actually, having the signature embedded may help to remove the `_sage_argspec_` method!



---

archive/issue_comments_235246.json:
```json
{
    "body": "Replying to [comment:65 SimonKing]:\n> I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.\n> \n> When we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.\n> \n> I'll try to figure out how it works.\n\nHm. `__init__` is not explicitly considered in your patch. So, I can't figure out what needs to be done.\n\nDo we have a possibility to convince Cython to either not use `Foo.__init__` for inserting the signature into `Foo.__doc__`, or to add the embedding information in addition to the signature into `Foo.__doc__`?",
    "created_at": "2015-04-08T17:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235246",
    "user": "@simon-king-jena"
}
```

Replying to [comment:65 SimonKing]:
> I'd suggest that the signature should not be inserted. There is no reason to insert the signature of `Parent.__init__` into `Parent.__doc__`, since the same signature is also inserted into `Parent.__init__.__doc__`, where it belongs.
> 
> When we will be using the inserted signature in a new version of `sage_getargspec`, we will be considering `__init__` anyway when it is used on a class.
> 
> I'll try to figure out how it works.

Hm. `__init__` is not explicitly considered in your patch. So, I can't figure out what needs to be done.

Do we have a possibility to convince Cython to either not use `Foo.__init__` for inserting the signature into `Foo.__doc__`, or to add the embedding information in addition to the signature into `Foo.__doc__`?



---

archive/issue_comments_235247.json:
```json
{
    "body": "Strangely, when I remove the signature information (admittedly I do so using a heuristics, I get the error\n\n```\nOSError: [combinat ] None:4: WARNING: citation not found: BBSSZ2012\n```\n\nWhy is that? Clearly the citation is defined in `src/sage/combinat/ncsf_qsym/qsym.py`.\n\nI am frustrated, since I don't see how it could be related with the change I did.",
    "created_at": "2015-04-08T19:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235247",
    "user": "@simon-king-jena"
}
```

Strangely, when I remove the signature information (admittedly I do so using a heuristics, I get the error

```
OSError: [combinat ] None:4: WARNING: citation not found: BBSSZ2012
```

Why is that? Clearly the citation is defined in `src/sage/combinat/ncsf_qsym/qsym.py`.

I am frustrated, since I don't see how it could be related with the change I did.



---

archive/issue_comments_235248.json:
```json
{
    "body": "Hang on, now I see it! The citation is defined in `dualImmaculate.__init__`, whereas `dualImmaculate` has no docstring at all. In such a situation, I guess we want to use the documentation of the `__init__` method instead.",
    "created_at": "2015-04-08T19:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235248",
    "user": "@simon-king-jena"
}
```

Hang on, now I see it! The citation is defined in `dualImmaculate.__init__`, whereas `dualImmaculate` has no docstring at all. In such a situation, I guess we want to use the documentation of the `__init__` method instead.



---

archive/issue_comments_235249.json:
```json
{
    "body": "Introspection is a can of worms, and I hate it. After inserting the docstring of `__init__` in case that the class' docstring is empty, I now get\n\n```\nOSError: [graphs   ] /home/king/Sage/git/sage/src/doc/en/reference/graphs/sage/graphs/isgci.rst:11: WARNING: error while formatting signature for sage.graphs.isgci.graph_classes: obj is not a code object\n```\n",
    "created_at": "2015-04-08T20:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235249",
    "user": "@simon-king-jena"
}
```

Introspection is a can of worms, and I hate it. After inserting the docstring of `__init__` in case that the class' docstring is empty, I now get

```
OSError: [graphs   ] /home/king/Sage/git/sage/src/doc/en/reference/graphs/sage/graphs/isgci.rst:11: WARNING: error while formatting signature for sage.graphs.isgci.graph_classes: obj is not a code object
```




---

archive/issue_comments_235250.json:
```json
{
    "body": "Aha! `sage.graphs.isgci.graph_classes.__init__` is obtained from `object.__init__` (even though `sage.graphs.isgci.graph_classes.__init__==object.__init__` returns False), and the docstring of `sage.graphs.isgci.graph_classes` is empty.\n\nSince the doc of the inherited init method is then used (with my not-yet-commited changes), it is also attempted to insert the argspec of `sage.graphs.isgci.graph_classes`. And big surprise:\n\n```\nsage: callable(sage.graphs.isgci.graph_classes)\nFalse\nsage: callable(object)\nTrue\n```\n\nSince `sage.graphs.isgci.graph_classes` surprisingly isn't callable, `sage_getargspec` raises an error.\n\nIn any case, I think it is slightly cleaner to use `obj.__init__.__doc__` only if obj is a class, `obj.__doc__` is essentially empty (up to embedding information), **and** if `obj.__init__.__objclass__==obj`.",
    "created_at": "2015-04-08T20:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235250",
    "user": "@simon-king-jena"
}
```

Aha! `sage.graphs.isgci.graph_classes.__init__` is obtained from `object.__init__` (even though `sage.graphs.isgci.graph_classes.__init__==object.__init__` returns False), and the docstring of `sage.graphs.isgci.graph_classes` is empty.

Since the doc of the inherited init method is then used (with my not-yet-commited changes), it is also attempted to insert the argspec of `sage.graphs.isgci.graph_classes`. And big surprise:

```
sage: callable(sage.graphs.isgci.graph_classes)
False
sage: callable(object)
True
```

Since `sage.graphs.isgci.graph_classes` surprisingly isn't callable, `sage_getargspec` raises an error.

In any case, I think it is slightly cleaner to use `obj.__init__.__doc__` only if obj is a class, `obj.__doc__` is essentially empty (up to embedding information), **and** if `obj.__init__.__objclass__==obj`.



---

archive/issue_comments_235251.json:
```json
{
    "body": "I am in \"WTF\" mood. With my current changes, INSTANCES of `sage.plot.colors.Color` are attempted to be inserted into the reference manual, which fails since they are not callable, hence, their argspec can not be determined. It is a mess. Time to call it a day.",
    "created_at": "2015-04-08T21:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235251",
    "user": "@simon-king-jena"
}
```

I am in "WTF" mood. With my current changes, INSTANCES of `sage.plot.colors.Color` are attempted to be inserted into the reference manual, which fails since they are not callable, hence, their argspec can not be determined. It is a mess. Time to call it a day.



---

archive/issue_comments_235252.json:
```json
{
    "body": "I don't get it. With my current (unpushed) branch, I get\n\n```\nsage: sage_getdoc_original(sage.plot.colors.aliceblue)\n''\n```\n\nNonetheless, `aliceblue`, which is an instance (!) of `sage.plot.colors.Color`, is attempted to be inserted into the reference manual, which currently is not the case.\n\nWhy could that be?",
    "created_at": "2015-04-09T07:54:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235252",
    "user": "@simon-king-jena"
}
```

I don't get it. With my current (unpushed) branch, I get

```
sage: sage_getdoc_original(sage.plot.colors.aliceblue)
''
```

Nonetheless, `aliceblue`, which is an instance (!) of `sage.plot.colors.Color`, is attempted to be inserted into the reference manual, which currently is not the case.

Why could that be?



---

archive/issue_comments_235253.json:
```json
{
    "body": "Meanwhile it looks a bit better. I think the key is to treat a class and and instance of that class in the same way when determining the docstring. Now, I return the doc of `obj.__init__` if the docstring of `obj` is empty after stripping signature and embedding. Before, I only did so if `obj` is a class. Problem: The doc builder removes duplicates, and thus it will only document a class instance in addition to the class if it has its *own* docstring. Hence, docstrings of classes and instances must be treated equal.",
    "created_at": "2015-04-09T08:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235253",
    "user": "@simon-king-jena"
}
```

Meanwhile it looks a bit better. I think the key is to treat a class and and instance of that class in the same way when determining the docstring. Now, I return the doc of `obj.__init__` if the docstring of `obj` is empty after stripping signature and embedding. Before, I only did so if `obj` is a class. Problem: The doc builder removes duplicates, and thus it will only document a class instance in addition to the class if it has its *own* docstring. Hence, docstrings of classes and instances must be treated equal.



---

archive/issue_comments_235254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-09T10:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235254",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235255.json:
```json
{
    "body": "With the new commit, the documentation builds. I hope it builds fine. Actually I think there should be no change to how it has previously looked like. I didn't finish all tests yet.\n\nComments on the commits:\n\nAs I said, it is essential for source code inspection that embedding information of a function is available in the docstring of a cached version of that function. That's why I did not work on top of your branch.\n\nHere are a couple of reasons for what I did:\n\n- The signature is sometimes not understood by sphinx, as for sphinx both `*` and `**` have different meanings than for the embedded signature. Hence, the signature should be stripped from the documentation. I used a heuristics for stripping the signature, assuming that\n  - the signature appears in the first line\n  - it starts with the undotted name of the object resp. of its class, followed by an opening bracket.\n\n  If this pattern is found, the first line will be removed. Note that if there is embedding information then the signature information will be cut off anyway by `_extract_embedded_position`.\n\n- When the signature is inserted, a previously empty docstring becomes non-empty, which means that an object would appear in the documentation that previously didn't. Worse: When an object's docstring is empty, its `__init__` docstring was used for documentation instead. There are cases (mainly in sage.combinat) providing documentation AND references in the `__init__` docstring. Hence, it is essential to have them, since otherwise the doc doesn't build. So, I let `sage_getdoc_original` use `__init__` when nothing else is found after stripping *both* signature and embedding information.\n\n- It is important that `sage_getdoc_unformatted` returns the same docstring for a class and for an instance of the class (unless the instance explicitly has its own `__doc__` attribute). Otherwise, each of such instance found in a module would appear in the reference manual.\n\nI documented my changes, and so far the tests have passed. Hence: Needs review!",
    "created_at": "2015-04-09T10:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235255",
    "user": "@simon-king-jena"
}
```

With the new commit, the documentation builds. I hope it builds fine. Actually I think there should be no change to how it has previously looked like. I didn't finish all tests yet.

Comments on the commits:

As I said, it is essential for source code inspection that embedding information of a function is available in the docstring of a cached version of that function. That's why I did not work on top of your branch.

Here are a couple of reasons for what I did:

- The signature is sometimes not understood by sphinx, as for sphinx both `*` and `**` have different meanings than for the embedded signature. Hence, the signature should be stripped from the documentation. I used a heuristics for stripping the signature, assuming that
  - the signature appears in the first line
  - it starts with the undotted name of the object resp. of its class, followed by an opening bracket.

  If this pattern is found, the first line will be removed. Note that if there is embedding information then the signature information will be cut off anyway by `_extract_embedded_position`.

- When the signature is inserted, a previously empty docstring becomes non-empty, which means that an object would appear in the documentation that previously didn't. Worse: When an object's docstring is empty, its `__init__` docstring was used for documentation instead. There are cases (mainly in sage.combinat) providing documentation AND references in the `__init__` docstring. Hence, it is essential to have them, since otherwise the doc doesn't build. So, I let `sage_getdoc_original` use `__init__` when nothing else is found after stripping *both* signature and embedding information.

- It is important that `sage_getdoc_unformatted` returns the same docstring for a class and for an instance of the class (unless the instance explicitly has its own `__doc__` attribute). Otherwise, each of such instance found in a module would appear in the reference manual.

I documented my changes, and so far the tests have passed. Hence: Needs review!



---

archive/issue_comments_235256.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-09T10:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235256",
    "user": "@simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_235257.json:
```json
{
    "body": "Simon, I assume that \"needs_review\" implies that you agree with the commits on this branch that I made?",
    "created_at": "2015-04-09T10:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235257",
    "user": "@jdemeyer"
}
```

Simon, I assume that "needs_review" implies that you agree with the commits on this branch that I made?



---

archive/issue_comments_235258.json:
```json
{
    "body": "Replying to [comment:77 jdemeyer]:\n> Simon, I assume that \"needs_review\" implies that you agree with the commits on this branch that I made?\n\nThat's why I inserted my name as a reviewer `:-)`\n\nBut I must admit that I don't understand *why* your changes result in inserting the signature into the docstring. I just see that they *do*. And I see that we can cope with it, and shall eventually be able to use the new information.\n\nSo, perhaps you can explain how your changes really work, so that I'd really qualify as a reviewer...",
    "created_at": "2015-04-09T10:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235258",
    "user": "@simon-king-jena"
}
```

Replying to [comment:77 jdemeyer]:
> Simon, I assume that "needs_review" implies that you agree with the commits on this branch that I made?

That's why I inserted my name as a reviewer `:-)`

But I must admit that I don't understand *why* your changes result in inserting the signature into the docstring. I just see that they *do*. And I see that we can cope with it, and shall eventually be able to use the new information.

So, perhaps you can explain how your changes really work, so that I'd really qualify as a reviewer...



---

archive/issue_comments_235259.json:
```json
{
    "body": "> I don't understand *why* your changes result in inserting the signature into the docstring.\nEasy: Cython has a [compiler directive](http://docs.cython.org/src/reference/compilation.html#compiler-directives) `embedsignature=True` which does this and all I did was enabling this flag (plus add a patch from upstream to fix a bug when `embedsignature` is True)",
    "created_at": "2015-04-09T10:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235259",
    "user": "@jdemeyer"
}
```

> I don't understand *why* your changes result in inserting the signature into the docstring.
Easy: Cython has a [compiler directive](http://docs.cython.org/src/reference/compilation.html#compiler-directives) `embedsignature=True` which does this and all I did was enabling this flag (plus add a patch from upstream to fix a bug when `embedsignature` is True)



---

archive/issue_comments_235260.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-09T11:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235260",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_235261.json:
```json
{
    "body": "Shouldn't this give the docstring of `__init__`?\n\n```\nsage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)\n''\n```\n",
    "created_at": "2015-04-09T11:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235261",
    "user": "@jdemeyer"
}
```

Shouldn't this give the docstring of `__init__`?

```
sage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)
''
```




---

archive/issue_comments_235262.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-09T11:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235262",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_235263.json:
```json
{
    "body": "Replying to [comment:80 jdemeyer]:\n> Shouldn't this give the docstring of `__init__`?\n> {{{\n> sage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)\n> ''\n> }}}\n\nYes, it should. I'll see after lunch why it doesn't.",
    "created_at": "2015-04-09T11:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235263",
    "user": "@simon-king-jena"
}
```

Replying to [comment:80 jdemeyer]:
> Shouldn't this give the docstring of `__init__`?
> {{{
> sage: sage_getdoc_original(sage.symbolic.callable.CallableSymbolicExpressionRingFactory)
> ''
> }}}

Yes, it should. I'll see after lunch why it doesn't.



---

archive/issue_comments_235264.json:
```json
{
    "body": "False alarm, `sage.symbolic.callable.CallableSymbolicExpressionRingFactory.__init__` is just `UniqueFactory.__init__` so your code is correct.",
    "created_at": "2015-04-09T11:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235264",
    "user": "@jdemeyer"
}
```

False alarm, `sage.symbolic.callable.CallableSymbolicExpressionRingFactory.__init__` is just `UniqueFactory.__init__` so your code is correct.



---

archive/issue_comments_235265.json:
```json
{
    "body": "I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes. Interestingly, I also see changes of the form\n\n```diff\n-<a class=\"reference external\" href=\"../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring\" title=\"(in Sage Reference Manual v6.6.rc2)\"><tt class=\"xref py py-mod docutils literal\"><span class=\"pre\">quotient_ring</span></tt></a>.</p>\n+<a class=\"reference external\" href=\"../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring\" title=\"(in Sage Reference Manual: General Rings, Ideals, and Morphisms v6.6.rc2)\"><tt class=\"xref py py-mod docutils literal\"><span class=\"pre\">quotient_ring</span></tt></a>.</p>\n```\n\nwhich are good but I cannot explain.",
    "created_at": "2015-04-09T11:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235265",
    "user": "@jdemeyer"
}
```

I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes. Interestingly, I also see changes of the form

```diff
-<a class="reference external" href="../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring" title="(in Sage Reference Manual v6.6.rc2)"><tt class="xref py py-mod docutils literal"><span class="pre">quotient_ring</span></tt></a>.</p>
+<a class="reference external" href="../../../rings/sage/rings/quotient_ring.html#modulesage.rings.quotient_ring" title="(in Sage Reference Manual: General Rings, Ideals, and Morphisms v6.6.rc2)"><tt class="xref py py-mod docutils literal"><span class="pre">quotient_ring</span></tt></a>.</p>
```

which are good but I cannot explain.



---

archive/issue_comments_235266.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-09T12:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235266",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_235267.json:
```json
{
    "body": "Hang on, it seems old-style classes might not have an `__init__` method...",
    "created_at": "2015-04-09T12:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235267",
    "user": "@jdemeyer"
}
```

Hang on, it seems old-style classes might not have an `__init__` method...



---

archive/issue_comments_235268.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-09T12:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235268",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235269.json:
```json
{
    "body": "Replying to [comment:84 jdemeyer]:\n> I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.\n\nDo we want to keep these?\n\nYour new changes seem good to me. Let's do tests.",
    "created_at": "2015-04-09T12:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235269",
    "user": "@simon-king-jena"
}
```

Replying to [comment:84 jdemeyer]:
> I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.

Do we want to keep these?

Your new changes seem good to me. Let's do tests.



---

archive/issue_comments_235270.json:
```json
{
    "body": "Replying to [comment:89 SimonKing]:\n> Replying to [comment:84 jdemeyer]:\n> > I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.\n> \n> Do we want to keep these?\nNo, I think the output is good. I was commenting. There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.",
    "created_at": "2015-04-09T12:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235270",
    "user": "@jdemeyer"
}
```

Replying to [comment:89 SimonKing]:
> Replying to [comment:84 jdemeyer]:
> > I'm diffing the old and new HTML manual, and things look good. The newer manual seems to omit docstrings, but that's just because you're no longer displaying the `__init__` methods of base classes.
> 
> Do we want to keep these?
No, I think the output is good. I was commenting. There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.



---

archive/issue_comments_235271.json:
```json
{
    "body": "Can we remove the support for embedding information from `sagedoc.format`? I think that `format()` should take only \"original\" docstrings as input, i.e. without embedding information.",
    "created_at": "2015-04-09T13:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235271",
    "user": "@jdemeyer"
}
```

Can we remove the support for embedding information from `sagedoc.format`? I think that `format()` should take only "original" docstrings as input, i.e. without embedding information.



---

archive/issue_comments_235272.json:
```json
{
    "body": "Replying to [comment:90 jdemeyer]:\n> There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.\n\nI guess I am responsible for some of them. When I have a class whose instances are supposed to be created by a factory, I would document the \"expected\" way of using the class in the class' docstring. In the `__init__` docstring, I would provide technical details that are normally taken care of by the factory. In that way, the details are available to developers, but are hidden from (and can thus not confuse) the casual users.",
    "created_at": "2015-04-09T13:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235272",
    "user": "@simon-king-jena"
}
```

Replying to [comment:90 jdemeyer]:
> There are annoying cases where both the class and `__init__` have non-trivial docstrings, that really should be discouraged.

I guess I am responsible for some of them. When I have a class whose instances are supposed to be created by a factory, I would document the "expected" way of using the class in the class' docstring. In the `__init__` docstring, I would provide technical details that are normally taken care of by the factory. In that way, the details are available to developers, but are hidden from (and can thus not confuse) the casual users.



---

archive/issue_comments_235273.json:
```json
{
    "body": "Replying to [comment:91 jdemeyer]:\n> Can we remove the support for embedding information from `sagedoc.format`?\n\nI thought that this was orthogonal to the \"embedded information\" question. In the sense that it is not format's job to remove the information.\n\nWhere would it be relevant? When doing `obj?`? What happens when `obj?` is typed? I guess `sagedoc.format` is applied in that case, but *what* is it applied to?",
    "created_at": "2015-04-09T13:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235273",
    "user": "@simon-king-jena"
}
```

Replying to [comment:91 jdemeyer]:
> Can we remove the support for embedding information from `sagedoc.format`?

I thought that this was orthogonal to the "embedded information" question. In the sense that it is not format's job to remove the information.

Where would it be relevant? When doing `obj?`? What happens when `obj?` is typed? I guess `sagedoc.format` is applied in that case, but *what* is it applied to?



---

archive/issue_comments_235274.json:
```json
{
    "body": "Replying to [comment:93 SimonKing]:\n> Replying to [comment:91 jdemeyer]:\n> > Can we remove the support for embedding information from `sagedoc.format`?\n> \n> I thought that this was orthogonal to the \"embedded information\" question. In the sense that it is not format's job to remove the information.\nI'll read this as an agreement...\n\n> What happens when `obj?` is typed?\nI think that just calls `sageinspect.sage_getdoc`, which calls `format()` on the original (i.e. without embedding info) doc.",
    "created_at": "2015-04-09T13:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235274",
    "user": "@jdemeyer"
}
```

Replying to [comment:93 SimonKing]:
> Replying to [comment:91 jdemeyer]:
> > Can we remove the support for embedding information from `sagedoc.format`?
> 
> I thought that this was orthogonal to the "embedded information" question. In the sense that it is not format's job to remove the information.
I'll read this as an agreement...

> What happens when `obj?` is typed?
I think that just calls `sageinspect.sage_getdoc`, which calls `format()` on the original (i.e. without embedding info) doc.



---

archive/issue_comments_235275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-09T13:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235275",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235276.json:
```json
{
    "body": "I couldn't find any difference in behaviour between `foo?` or `foo??` with or without this patch.",
    "created_at": "2015-04-09T13:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235276",
    "user": "@jdemeyer"
}
```

I couldn't find any difference in behaviour between `foo?` or `foo??` with or without this patch.



---

archive/issue_comments_235277.json:
```json
{
    "body": "What is this for?\n\n```\ngetattr(init, 'im_class', None) == typ\n```\n",
    "created_at": "2015-04-09T13:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235277",
    "user": "@jdemeyer"
}
```

What is this for?

```
getattr(init, 'im_class', None) == typ
```




---

archive/issue_comments_235278.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-09T13:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235278",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235279.json:
```json
{
    "body": "Replying to [comment:98 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[02ee3cc](http://git.sagemath.org/sage.git/commit/?id=02ee3cc5478de184783d64c609da0d9a083db9c2)||`Fix raise syntax`||\n\nThanks, I thought that `except (TypeError, AttributeError), err` assigns the caught error to `err`.",
    "created_at": "2015-04-09T13:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235279",
    "user": "@simon-king-jena"
}
```

Replying to [comment:98 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[02ee3cc](http://git.sagemath.org/sage.git/commit/?id=02ee3cc5478de184783d64c609da0d9a083db9c2)||`Fix raise syntax`||

Thanks, I thought that `except (TypeError, AttributeError), err` assigns the caught error to `err`.



---

archive/issue_comments_235280.json:
```json
{
    "body": "Replying to [comment:97 jdemeyer]:\n> What is this for?\n> {{{\n> getattr(init, 'im_class', None) == typ\n> }}}\n\nI wanted to test that the init method belongs to typ and is not inherited from a super class.\n\nBut on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.",
    "created_at": "2015-04-09T13:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235280",
    "user": "@simon-king-jena"
}
```

Replying to [comment:97 jdemeyer]:
> What is this for?
> {{{
> getattr(init, 'im_class', None) == typ
> }}}

I wanted to test that the init method belongs to typ and is not inherited from a super class.

But on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.



---

archive/issue_comments_235281.json:
```json
{
    "body": "Replying to [comment:100 SimonKing]:\n> I wanted to test that the init method belongs to typ and is not inherited from a super class.\n\nThe original rationale was this: The init method may contain embedding information for the class. If it is obtained from the super-class, then the embedding information belongs to a different class and is thus misleading.",
    "created_at": "2015-04-09T13:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235281",
    "user": "@simon-king-jena"
}
```

Replying to [comment:100 SimonKing]:
> I wanted to test that the init method belongs to typ and is not inherited from a super class.

The original rationale was this: The init method may contain embedding information for the class. If it is obtained from the super-class, then the embedding information belongs to a different class and is thus misleading.



---

archive/issue_comments_235282.json:
```json
{
    "body": "Replying to [comment:100 SimonKing]:\n> But on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.\n\nI don't think this should be changed.\nI would not like to see the doc of `Parent` just because esomething something inherits from `Parent`.",
    "created_at": "2015-04-09T13:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235282",
    "user": "@jdemeyer"
}
```

Replying to [comment:100 SimonKing]:
> But on second thought, it would perhaps be better to work with inheritance: After all, docstrings are inherited, too.

I don't think this should be changed.
I would not like to see the doc of `Parent` just because esomething something inherits from `Parent`.



---

archive/issue_comments_235283.json:
```json
{
    "body": "For me, this branch is good to go if you add some comment in the sources about this part:\n\n```\n            if (getattr(init, '__objclass__', None) or\n                getattr(init, 'im_class', None)) == typ:\n                return sage_getdoc_original(init)\n```\n",
    "created_at": "2015-04-09T13:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235283",
    "user": "@jdemeyer"
}
```

For me, this branch is good to go if you add some comment in the sources about this part:

```
            if (getattr(init, '__objclass__', None) or
                getattr(init, 'im_class', None)) == typ:
                return sage_getdoc_original(init)
```




---

archive/issue_comments_235284.json:
```json
{
    "body": "Replying to [comment:103 jdemeyer]:\n> For me, this branch is good to go if you add some comment in the sources about this part:\n> {{{\n>             if (getattr(init, '__objclass__', None) or\n>                 getattr(init, 'im_class', None)) == typ:\n>                 return sage_getdoc_original(init)\n> }}}\n\nI will do so a bit later, as I have an appointment now.",
    "created_at": "2015-04-09T13:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235284",
    "user": "@simon-king-jena"
}
```

Replying to [comment:103 jdemeyer]:
> For me, this branch is good to go if you add some comment in the sources about this part:
> {{{
>             if (getattr(init, '__objclass__', None) or
>                 getattr(init, 'im_class', None)) == typ:
>                 return sage_getdoc_original(init)
> }}}

I will do so a bit later, as I have an appointment now.



---

archive/issue_comments_235285.json:
```json
{
    "body": "Hmm, this patch doesn't behave so nicely for some of Python's docs:\n\n```\nsage: print type.__doc__\ntype(object) -> the object's type\ntype(name, bases, dict) -> a new type\n\nsage: print sage_getdoc_original(type)\ntype(name, bases, dict) -> a new type\n```\n\n\nThis causes\n\n```\nsage -t --long src/sage/repl/ipython_tests.py\n**********************************************************************\nFile \"src/sage/repl/ipython_tests.py\", line 10, in sage.repl.ipython_tests\nFailed example:\n    shell.run_cell(u'%pinfo dummy')\nExpected:\n    Type:            function\n    String form:     <function dummy at 0x...>\n    File:            /.../sage/repl/ipython_tests.py\n    Definition:      dummy(argument, optional=None)\n    Docstring:\n       Dummy Docstring Title\n    <BLANKLINE>\n       Dummy docstring explanation.\n    <BLANKLINE>\n       INPUT:\n    <BLANKLINE>\n       * \"argument\" -- anything. Dummy argument.\n    <BLANKLINE>\n       * \"optional\" -- anything (optional). Dummy optional.\n    <BLANKLINE>\n       EXAMPLES:\n    ...\n    Class docstring:\n    function(code, globals[, name[, argdefs[, closure]]])\n    <BLANKLINE>\n    Create a function object from a code object and a dictionary. The\n    optional name string overrides the name from the code object. The\n    optional argdefs tuple specifies the default argument values. The\n    optional closure tuple supplies the bindings for free variables.\n    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature\nGot:\n    Type:            function\n    String form:     <function dummy at 0x7f8a0ffe76e0>\n    File:            /usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/repl/ipython_tests.py\n    Definition:      dummy(argument, optional=None)\n    Docstring:\n       Dummy Docstring Title\n    <BLANKLINE>\n       Dummy docstring explanation.\n    <BLANKLINE>\n       INPUT:\n    <BLANKLINE>\n       * \"argument\" -- anything. Dummy argument.\n    <BLANKLINE>\n       * \"optional\" -- anything (optional). Dummy optional.\n    <BLANKLINE>\n       EXAMPLES:\n    <BLANKLINE>\n          sage: from sage.repl.ipython_tests import dummy sage: dummy(1)\n          'Source code would be here'\n    <BLANKLINE>\n    Class docstring:\n    Create a function object from a code object and a dictionary. The\n    optional name string overrides the name from the code object. The\n    optional argdefs tuple specifies the default argument values. The\n    optional closure tuple supplies the bindings for free variables.\n    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature\n**********************************************************************\n```\n",
    "created_at": "2015-04-09T14:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235285",
    "user": "@jdemeyer"
}
```

Hmm, this patch doesn't behave so nicely for some of Python's docs:

```
sage: print type.__doc__
type(object) -> the object's type
type(name, bases, dict) -> a new type

sage: print sage_getdoc_original(type)
type(name, bases, dict) -> a new type
```


This causes

```
sage -t --long src/sage/repl/ipython_tests.py
**********************************************************************
File "src/sage/repl/ipython_tests.py", line 10, in sage.repl.ipython_tests
Failed example:
    shell.run_cell(u'%pinfo dummy')
Expected:
    Type:            function
    String form:     <function dummy at 0x...>
    File:            /.../sage/repl/ipython_tests.py
    Definition:      dummy(argument, optional=None)
    Docstring:
       Dummy Docstring Title
    <BLANKLINE>
       Dummy docstring explanation.
    <BLANKLINE>
       INPUT:
    <BLANKLINE>
       * "argument" -- anything. Dummy argument.
    <BLANKLINE>
       * "optional" -- anything (optional). Dummy optional.
    <BLANKLINE>
       EXAMPLES:
    ...
    Class docstring:
    function(code, globals[, name[, argdefs[, closure]]])
    <BLANKLINE>
    Create a function object from a code object and a dictionary. The
    optional name string overrides the name from the code object. The
    optional argdefs tuple specifies the default argument values. The
    optional closure tuple supplies the bindings for free variables.
    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature
Got:
    Type:            function
    String form:     <function dummy at 0x7f8a0ffe76e0>
    File:            /usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/repl/ipython_tests.py
    Definition:      dummy(argument, optional=None)
    Docstring:
       Dummy Docstring Title
    <BLANKLINE>
       Dummy docstring explanation.
    <BLANKLINE>
       INPUT:
    <BLANKLINE>
       * "argument" -- anything. Dummy argument.
    <BLANKLINE>
       * "optional" -- anything (optional). Dummy optional.
    <BLANKLINE>
       EXAMPLES:
    <BLANKLINE>
          sage: from sage.repl.ipython_tests import dummy sage: dummy(1)
          'Source code would be here'
    <BLANKLINE>
    Class docstring:
    Create a function object from a code object and a dictionary. The
    optional name string overrides the name from the code object. The
    optional argdefs tuple specifies the default argument values. The
    optional closure tuple supplies the bindings for free variables.
    Init docstring:  x.__init__(...) initializes x; see help(type(x)) for signature
**********************************************************************
```




---

archive/issue_comments_235286.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-09T14:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235286",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_235287.json:
```json
{
    "body": "Replying to [comment:105 jdemeyer]:\n> Hmm, this patch doesn't behave so nicely for some of Python's docs:\n> {{{\n> sage: print sage_getdoc_original(type)\n> type(name, bases, dict) -> a new type\n> }}}\n\nYes. That's because of my attempt to remove the signature. After all, what I have is only a heuristics.\n\nHow could we improve the heuristics? Special-case `type`? Test whether the first line ends with `')'`?\n\nI'll finish a commit now. Please wait.",
    "created_at": "2015-04-09T15:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235287",
    "user": "@simon-king-jena"
}
```

Replying to [comment:105 jdemeyer]:
> Hmm, this patch doesn't behave so nicely for some of Python's docs:
> {{{
> sage: print sage_getdoc_original(type)
> type(name, bases, dict) -> a new type
> }}}

Yes. That's because of my attempt to remove the signature. After all, what I have is only a heuristics.

How could we improve the heuristics? Special-case `type`? Test whether the first line ends with `')'`?

I'll finish a commit now. Please wait.



---

archive/issue_comments_235288.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-09T16:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235288",
    "user": "@simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_235289.json:
```json
{
    "body": "Why has the branch that I just pushed be reverted???\n----\nNew commits:",
    "created_at": "2015-04-09T16:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235289",
    "user": "@simon-king-jena"
}
```

Why has the branch that I just pushed be reverted???
----
New commits:



---

archive/issue_comments_235290.json:
```json
{
    "body": "Now it should be ready for review.",
    "created_at": "2015-04-09T16:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235290",
    "user": "@simon-king-jena"
}
```

Now it should be ready for review.



---

archive/issue_comments_235291.json:
```json
{
    "body": "Sorry that I didn't fix that doctest.\n----\nNew commits:",
    "created_at": "2015-04-10T09:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235291",
    "user": "@simon-king-jena"
}
```

Sorry that I didn't fix that doctest.
----
New commits:



---

archive/issue_comments_235292.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-10T15:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235292",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_235293.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17610",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17610#issuecomment-235293",
    "user": "@vbraun"
}
```

Resolution: fixed
