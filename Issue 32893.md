# Issue 32893: Fix silent "sage -b" after #32759

Issue created by migration from https://trac.sagemath.org/ticket/33130

Original creator: mkoeppe

Original creation time: 2022-01-08 06:49:14

CC:  mjo jhpalmieri

(from #33125)

#32759 slightly broke `sage -b`: It silently rebuilds sagelib and then reports "Nothing to do".

This behavior comes from `build/make/install`, which first calls `make -q sagelib` with output suppressed. But `-q` handling got broken by #32759, as explained in #33125.

We fix it here.



---

Comment by mkoeppe created at 2022-01-08 06:58:36

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-01-08 06:58:36

Last 10 new commits:


---

Comment by mjo created at 2022-01-08 23:46:43

Can I ask why the plus signs were added to the `$(1)-$(4)-no-deps` rules in the first place? Do I really want `make -n doc-html` to fail?


```
$ make -n doc-html
...
make --no-print-directory pplpy_doc-SAGE_DOCS-no-deps
if [ -z '' ]; then echo "Error: The installation tree SAGE_DOCS has been disabled" 2>&1; echo "This Sage build is configured with "configure --disable-doc", so building the documentation will not work." 2>&1; exit 1; else sage-logger -p 'SAGE_CHECK=no PATH=/bin:$PATH sage-spkg -o  pplpy_doc-0.8.6 ' '/home/mjo/src/sage.git/logs/pkgs/pplpy_doc-0.8.6.log'; fi
Error: The installation tree SAGE_DOCS has been disabled
This Sage build is configured with configure --disable-doc, so building the documentation will not work.
make[2]: *** [Makefile:2702: pplpy_doc-SAGE_DOCS-no-deps] Error 1
make[1]: *** [Makefile:2702: /var/lib/sage/installed/pplpy_doc-0.8.6] Error 2
make[1]: Leaving directory '/home/mjo/src/sage.git/build/make'
```



---

Comment by mkoeppe created at 2022-01-08 23:59:20

The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`


---

Comment by mjo created at 2022-01-09 00:18:06

Replying to [comment:5 mkoeppe]:
> The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`

Oh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: 

- https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html


---

Comment by mkoeppe created at 2022-01-09 02:07:47

Replying to [comment:6 mjo]:
> Replying to [comment:5 mkoeppe]:
> > The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`
> 
> Oh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: 
> 
> - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html

No, I think MAKE does not pass on the jobserver pipe unless `+` is in use. 
https://git.savannah.gnu.org/cgit/make.git/tree/src/job.c#n1459, https://git.savannah.gnu.org/cgit/make.git/tree/src/posixos.c#n219


---

Comment by mjo created at 2022-01-09 03:18:31

Replying to [comment:7 mkoeppe]:
> Replying to [comment:6 mjo]:
> > Replying to [comment:5 mkoeppe]:
> ...you are apparently expected to handle `-n` in the program being run: 
> > 
> > - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html
> 
> No, I think MAKE does not pass on the jobserver pipe unless `+` is in use. 

True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make". So for example in the hack I suggested in #33125, running `MAKEFLAGS="$(MAKEFLAGS)" ./install` essentially passes the pipe to the subprocess, just like using `+` in the command would have. I think the same thing should work here.

However, while it seems a bit overcomplicated, I think it would be better to do what the documentation says and add a MAKEFLAGS check at the top of any scripts that we intend to both (1) be invoked by make and (2) to invoke make themselves. That way using those scripts requires no special knowledge or consideration; they'll always just do the right thing.


---

Comment by mkoeppe created at 2022-01-09 03:21:42

Replying to [comment:8 mjo]:
> True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make"

Passing the flag does not pass the pipe.


---

Comment by mjo created at 2022-01-09 03:34:58

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 mjo]:
> > True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make"
> 
> Passing the flag does not pass the pipe.

Ohhkay, I see the problem. What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?

If you think it's a good idea but don't want to deal with it right now, I'd be satisfied to open an enhancement ticket and merge this to solve the immediate problem. Maybe with the one caveat that we should replace `+` with `$(PLUS)` in the other no-deps rule as well, so that things like `make -n doc-html` don't try to build anything.


---

Comment by mkoeppe created at 2022-01-09 04:09:10

Replying to [comment:10 mjo]:
> What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?

For script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)


---

Comment by mjo created at 2022-01-09 15:25:01

Replying to [comment:11 mkoeppe]:
> Replying to [comment:10 mjo]:
> > What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?
> 
> For script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)

Ok, I'll open a ticket to think about it later. Do you want to add `$(PLUS)` to the other no-deps rule here, or worry about that in #33125?


---

Comment by mkoeppe created at 2022-01-09 16:50:35

Yes, let's defer larger changes to #33125 (so to the next release cycle)


---

Comment by mjo created at 2022-01-09 20:15:46

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2022-01-09 20:15:46

Ok


---

Comment by mkoeppe created at 2022-01-09 20:19:44

Thanks!


---

Comment by vbraun created at 2022-01-12 17:17:45

Resolution: fixed


---

Comment by mkoeppe created at 2022-01-28 19:20:18

Follow up in #33243.
