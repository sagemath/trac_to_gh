# Issue 32893: Fix silent "sage -b" after #32759

archive/issues_032893.json:
```json
{
    "body": "CC:  @orlitzky @jhpalmieri\n\n(from #33125)\n\n#32759 slightly broke `sage -b`: It silently rebuilds sagelib and then reports \"Nothing to do\".\n\nThis behavior comes from `build/make/install`, which first calls `make -q sagelib` with output suppressed. But `-q` handling got broken by #32759, as explained in #33125.\n\nWe fix it here.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33130\n\n",
    "created_at": "2022-01-08T06:49:14Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Fix silent \"sage -b\" after #32759",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32893",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @orlitzky @jhpalmieri

(from #33125)

#32759 slightly broke `sage -b`: It silently rebuilds sagelib and then reports "Nothing to do".

This behavior comes from `build/make/install`, which first calls `make -q sagelib` with output suppressed. But `-q` handling got broken by #32759, as explained in #33125.

We fix it here.


Issue created by migration from https://trac.sagemath.org/ticket/33130





---

archive/issue_comments_468547.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-08T06:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468547",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468548.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2022-01-08T06:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468548",
    "user": "https://github.com/mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_468549.json:
```json
{
    "body": "Can I ask why the plus signs were added to the `$(1)-$(4)-no-deps` rules in the first place? Do I really want `make -n doc-html` to fail?\n\n\n```\n$ make -n doc-html\n...\nmake --no-print-directory pplpy_doc-SAGE_DOCS-no-deps\nif [ -z '' ]; then echo \"Error: The installation tree SAGE_DOCS has been disabled\" 2>&1; echo \"This Sage build is configured with \"configure --disable-doc\", so building the documentation will not work.\" 2>&1; exit 1; else sage-logger -p 'SAGE_CHECK=no PATH=/bin:$PATH sage-spkg -o  pplpy_doc-0.8.6 ' '/home/mjo/src/sage.git/logs/pkgs/pplpy_doc-0.8.6.log'; fi\nError: The installation tree SAGE_DOCS has been disabled\nThis Sage build is configured with configure --disable-doc, so building the documentation will not work.\nmake[2]: *** [Makefile:2702: pplpy_doc-SAGE_DOCS-no-deps] Error 1\nmake[1]: *** [Makefile:2702: /var/lib/sage/installed/pplpy_doc-0.8.6] Error 2\nmake[1]: Leaving directory '/home/mjo/src/sage.git/build/make'\n```\n",
    "created_at": "2022-01-08T23:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468549",
    "user": "https://github.com/orlitzky"
}
```

Can I ask why the plus signs were added to the `$(1)-$(4)-no-deps` rules in the first place? Do I really want `make -n doc-html` to fail?


```
$ make -n doc-html
...
make --no-print-directory pplpy_doc-SAGE_DOCS-no-deps
if [ -z '' ]; then echo "Error: The installation tree SAGE_DOCS has been disabled" 2>&1; echo "This Sage build is configured with "configure --disable-doc", so building the documentation will not work." 2>&1; exit 1; else sage-logger -p 'SAGE_CHECK=no PATH=/bin:$PATH sage-spkg -o  pplpy_doc-0.8.6 ' '/home/mjo/src/sage.git/logs/pkgs/pplpy_doc-0.8.6.log'; fi
Error: The installation tree SAGE_DOCS has been disabled
This Sage build is configured with configure --disable-doc, so building the documentation will not work.
make[2]: *** [Makefile:2702: pplpy_doc-SAGE_DOCS-no-deps] Error 1
make[1]: *** [Makefile:2702: /var/lib/sage/installed/pplpy_doc-0.8.6] Error 2
make[1]: Leaving directory '/home/mjo/src/sage.git/build/make'
```




---

archive/issue_comments_468550.json:
```json
{
    "body": "The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`",
    "created_at": "2022-01-08T23:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468550",
    "user": "https://github.com/mkoeppe"
}
```

The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`



---

archive/issue_comments_468551.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`\n\nOh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: \n\n- https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html",
    "created_at": "2022-01-09T00:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468551",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:5 mkoeppe]:
> The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`

Oh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: 

- https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html



---

archive/issue_comments_468552.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> Replying to [comment:5 mkoeppe]:\n> > The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`\n> \n> Oh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: \n> \n> - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html\n\nNo, I think MAKE does not pass on the jobserver pipe unless `+` is in use. \nhttps://git.savannah.gnu.org/cgit/make.git/tree/src/job.c#n1459, https://git.savannah.gnu.org/cgit/make.git/tree/src/posixos.c#n219",
    "created_at": "2022-01-09T02:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468552",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 mjo]:
> Replying to [comment:5 mkoeppe]:
> > The + is needed so that jobserver flags are passed to the spkg-install script, which in turn calls again `make`
> 
> Oh, ok. Could we not do that by passing in `MAKEFLAGS` explicitly, and then forwarding it on to `make`? If not, adding the plus sign does it implicitly, but then you are apparently expected to handle `-n` in the program being run: 
> 
> - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html

No, I think MAKE does not pass on the jobserver pipe unless `+` is in use. 
https://git.savannah.gnu.org/cgit/make.git/tree/src/job.c#n1459, https://git.savannah.gnu.org/cgit/make.git/tree/src/posixos.c#n219



---

archive/issue_comments_468553.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> Replying to [comment:6 mjo]:\n> > Replying to [comment:5 mkoeppe]:\n> ...you are apparently expected to handle `-n` in the program being run: \n> > \n> > - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html\n> \n> No, I think MAKE does not pass on the jobserver pipe unless `+` is in use. \n\nTrue, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run \"make\". So for example in the hack I suggested in #33125, running `MAKEFLAGS=\"$(MAKEFLAGS)\" ./install` essentially passes the pipe to the subprocess, just like using `+` in the command would have. I think the same thing should work here.\n\nHowever, while it seems a bit overcomplicated, I think it would be better to do what the documentation says and add a MAKEFLAGS check at the top of any scripts that we intend to both (1) be invoked by make and (2) to invoke make themselves. That way using those scripts requires no special knowledge or consideration; they'll always just do the right thing.",
    "created_at": "2022-01-09T03:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468553",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:7 mkoeppe]:
> Replying to [comment:6 mjo]:
> > Replying to [comment:5 mkoeppe]:
> ...you are apparently expected to handle `-n` in the program being run: 
> > 
> > - https://www.gnu.org/software/make/manual/html_node/POSIX-Jobserver.html
> 
> No, I think MAKE does not pass on the jobserver pipe unless `+` is in use. 

True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make". So for example in the hack I suggested in #33125, running `MAKEFLAGS="$(MAKEFLAGS)" ./install` essentially passes the pipe to the subprocess, just like using `+` in the command would have. I think the same thing should work here.

However, while it seems a bit overcomplicated, I think it would be better to do what the documentation says and add a MAKEFLAGS check at the top of any scripts that we intend to both (1) be invoked by make and (2) to invoke make themselves. That way using those scripts requires no special knowledge or consideration; they'll always just do the right thing.



---

archive/issue_comments_468554.json:
```json
{
    "body": "Replying to [comment:8 mjo]:\n> True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run \"make\"\n\nPassing the flag does not pass the pipe.",
    "created_at": "2022-01-09T03:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468554",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:8 mjo]:
> True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make"

Passing the flag does not pass the pipe.



---

archive/issue_comments_468555.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> Replying to [comment:8 mjo]:\n> > True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run \"make\"\n> \n> Passing the flag does not pass the pipe.\n\nOhhkay, I see the problem. What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke \"make\" themselves?\n\nIf you think it's a good idea but don't want to deal with it right now, I'd be satisfied to open an enhancement ticket and merge this to solve the immediate problem. Maybe with the one caveat that we should replace `+` with `$(PLUS)` in the other no-deps rule as well, so that things like `make -n doc-html` don't try to build anything.",
    "created_at": "2022-01-09T03:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468555",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 mjo]:
> > True, but the `--jobserver-auth` flag gets added to `MAKEFLAGS` as soon as you run "make"
> 
> Passing the flag does not pass the pipe.

Ohhkay, I see the problem. What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?

If you think it's a good idea but don't want to deal with it right now, I'd be satisfied to open an enhancement ticket and merge this to solve the immediate problem. Maybe with the one caveat that we should replace `+` with `$(PLUS)` in the other no-deps rule as well, so that things like `make -n doc-html` don't try to build anything.



---

archive/issue_comments_468556.json:
```json
{
    "body": "Replying to [comment:10 mjo]:\n> What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke \"make\" themselves?\n\nFor script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)",
    "created_at": "2022-01-09T04:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468556",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:10 mjo]:
> What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?

For script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)



---

archive/issue_comments_468557.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> Replying to [comment:10 mjo]:\n> > What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke \"make\" themselves?\n> \n> For script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)\n\nOk, I'll open a ticket to think about it later. Do you want to add `$(PLUS)` to the other no-deps rule here, or worry about that in #33125?",
    "created_at": "2022-01-09T15:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468557",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:11 mkoeppe]:
> Replying to [comment:10 mjo]:
> > What do you think about adding that `MAKEFLAGS` check to the scripts that (re)invoke "make" themselves?
> 
> For script packages, `make` directly calls `spkg-install` of the script package; so this solution would mean that we have to add it to all `spkg-install` scripts of all script packages. (This would change with #29386.)

Ok, I'll open a ticket to think about it later. Do you want to add `$(PLUS)` to the other no-deps rule here, or worry about that in #33125?



---

archive/issue_comments_468558.json:
```json
{
    "body": "Yes, let's defer larger changes to #33125 (so to the next release cycle)",
    "created_at": "2022-01-09T16:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468558",
    "user": "https://github.com/mkoeppe"
}
```

Yes, let's defer larger changes to #33125 (so to the next release cycle)



---

archive/issue_comments_468559.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-09T20:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468559",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468560.json:
```json
{
    "body": "Ok",
    "created_at": "2022-01-09T20:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468560",
    "user": "https://github.com/orlitzky"
}
```

Ok



---

archive/issue_comments_468561.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-01-09T20:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468561",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_468562.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-12T17:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468562",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087540.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-12T17:17:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32893#event-87540"
}
```



---

archive/issue_comments_468563.json:
```json
{
    "body": "Follow up in #33243.",
    "created_at": "2022-01-28T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32893#issuecomment-468563",
    "user": "https://github.com/mkoeppe"
}
```

Follow up in #33243.
