# Issue 21196: pushout and unique parent for finite fields

Issue created by migration from https://trac.sagemath.org/ticket/21433

Original creator: caruso

Original creation time: 2016-09-06 09:18:28

CC:  defeo nthiery jdemeyer roed malb pbruin

Keywords: coercion, category, unique parent, finite fields

I think that this is a bug:


```
    sage: K = GF(5^2); K
    Finite Field in z2 of size 5^2
    sage: L = GF(5^4); L
    Finite Field in z4 of size 5^4
    sage: from sage.categories.pushout import pushout
    sage: P = pushout(K,L); P
    Finite Field in z4 of size 5^4
    sage: P is L
    False
```



---

Comment by caruso created at 2016-09-06 11:26:58

I had a closer look at this issue. Here is what happens: the function `pushout` recreates the finite field with the extra attribute `structure=None` which becomes part of the key used in `UniqueFactory`. Actually the key is built from all attributes including those that are not used or have no meaning. E.g.:


```
    sage: K = GF(5^2)
    sage: L = GF(5^2, irrelevant_attribute='Hello')
    sage: K is L
    False
```


I would gladly remove the component `str(kwds)` from the key (see `sage.rings.finite_rings.finite_field_constructor:549`). Any comment?


---

Comment by git created at 2016-09-07 22:54:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-07 23:22:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2016-09-07 23:27:12

My proposal was too coarse and broke many doctests.

My new weaker suggestion is to remove from the key only the named attributes whose value is None (cf patch implemented in the current branch).

Ticket set to needs_review.
----
New commits:


---

Comment by caruso created at 2016-09-07 23:27:12

Changing status from new to needs_review.


---

Comment by saraedum created at 2016-09-08 01:21:37

Isn't using `str(...)` in a key a questionable idea anyway? Is this just a hack to work around the fact that a `dict` is not hashable?

Dropping the `None`s is just assuming that these are the default values, right? Wouldn't it be better to add the default values explicitly to the key?


---

Comment by saraedum created at 2016-09-08 01:21:47

Changing status from needs_review to needs_info.


---

Comment by caruso created at 2016-09-08 08:08:49

Replying to [comment:7 saraedum]:
> Dropping the `None`s is just assuming that these are the default values, right? Wouldn't it be better to add the default values explicitly to the key?

As far as I understand, the point is that we don't know - or more exactly we don't want to precise at this point - what kind of attributes can arise and thus a fortiori we don't know their default values.

For example, the Givaro library accepts an attribute `repr` (for specifying the internal representation of the elements of the finite field). Of course, two Givaro finite fields with different `repr` option cannot be equal, so that `repr` should definitely be a part of the key.

Another option would be to make the list of all possible attributes and only include them in the key.


---

Comment by git created at 2016-09-24 19:52:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-09-24 21:21:13

Sorry for holding up this simple fix. I know this is frustrating. I'll try to be more responsive.

What do you think about just removing the attributes that we know to cause trouble here?


---

Comment by caruso created at 2017-05-26 07:18:06

I agree with this solution.


---

Comment by tscrim created at 2017-05-26 13:35:40

Changing status from needs_info to needs_work.


---

Comment by tscrim created at 2017-05-26 13:35:40

I do not like this solution as this has a code smell. Instead, I would add `structure` to `create_key_and_extra_args` and say we explicitly ignore it in the documentation (saying we include it for compatibility with `AlgebraicExtensionFunctor`. Another possibility that comes to mind is remove `structures` from `AlgebraicExtensionFunctor` and create a new subclass that also handles `structures` specifically for number fields. Last option I can think of would be for `AlgebraicExtensionFunctor` to not pass along `structures` when it does not contain any information.


---

Comment by saraedum created at 2017-06-06 22:14:03

Replying to [comment:14 tscrim]:
> I do not like this solution as this has a code smell. Instead, I would add `structure` to `create_key_and_extra_args` and say we explicitly ignore it in the documentation (saying we include it for compatibility with `AlgebraicExtensionFunctor`.
I do not how understand how what we do differs from this. Is it about the explict mention of the AlgebraicExtensionFunctor? I would not want to add it to the method interface explicitly since it has no effect.


---

Comment by saraedum created at 2017-06-06 22:16:21

Changing keywords from "coercion, category, unique parent, finite fields" to "coercion, category, unique parent, finite fields, sd86.5".


---

Comment by saraedum created at 2017-06-06 22:16:42

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-07 12:36:52

The biggest difference is it becomes an explicit keyword that is handled in all cases by truly ignoring the value. It is also cleaner code in the sense that the interface is more uniform (i.e., it is implicitly expecting to receive such a keyword at some point).


---

Comment by saraedum created at 2017-06-10 01:16:54

Feel free to make that change but I do not see the need to do so. Since we are ignoring the keyword anyway, I think it is equally confusing to have it explicitly in the interface.


---

Comment by saraedum created at 2017-06-10 07:14:28


```
File "src/sage/rings/finite_rings/finite_field_constructor.py", line 482, in sage.rings.finite_rings.finite_field_constructor.FiniteFieldFactory.?
Failed example:
    GF.create_key_and_extra_args(9, 'a', structure=None)
Expected:
    ((9, ('a',), x^2 + 2*x + 2, 'givaro', '{}', 3, 2, True), {}
Got:
    ((9, ('a',), x^2 + 2*x + 2, 'givaro', '{}', 3, 2, True), {})
```



---

Comment by saraedum created at 2017-06-10 07:14:28

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-06-10 22:56:20

This needs to better handle the extra keyword arguments and their defaults. I see a good way forward on how to do that. I will also fix that doctest.


---

Comment by tscrim created at 2017-06-10 23:47:40

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-10 23:47:40

The last commit now means we do not had oddities like:

```
sage: GF(25, impl='givaro') is GF(25, impl='givaro', repr='poly')
False
```

It also means we no longer accept junk keywords that makes different keys (i.e., this now raises a `TypeError`):

```
sage: GF(25) is GF(25, foo='bar')
False
```

I was tempted to have `elem_cache` and `repr` raise an error when the implementation is not givaro, but because `elem_cache` was listed as an argument, I decided to just ignore it for backwards compatibility.

IMO, what we really should be using is `UniqueRepresentation` and letting subclasses handle this through their `__classcall__` and `__classcall_private__`. However, that is a much more invasive change and this is on the path towards that.
----
New commits:


---

Comment by saraedum created at 2017-06-11 00:44:02

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2017-06-11 00:44:37

positive review assuming that the patchbot likes it.


---

Comment by vbraun created at 2017-06-11 14:27:02

You can't set something to positive review assuming that the patchbot likes it and then not check it, WTF


---

Comment by vbraun created at 2017-06-11 14:27:02

Changing status from positive_review to needs_work.


---

Comment by saraedum created at 2017-06-11 16:38:11

Travis, please feel free to set this to positive review once the doctests pass.

Volker, I was not aware of that. I thought that passing doctests were a prerequisite for merging things. Not for positively reviewing things; in particular since there were hardly any patchbots left until a few days ago (when we started a couple of additional ones.) Sure the manual says that all tests should pass but it also tells me to build the reference manual which I can't because I have not enough RAM for that. In any case, I will be more careful with that in the future but I found "wtf" to be a slightly too strong remark here.


---

Comment by vbraun created at 2017-06-11 17:20:26

Sorry if it was worded too strongly; But actually working (including doctests) is a prerequistite for "positive review".


---

Comment by saraedum created at 2017-06-11 18:37:30

Ok. Thanks for clarifying.


---

Comment by git created at 2017-06-11 22:43:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-11 22:44:35

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2017-06-11 22:44:35

All tests now pass.


---

Comment by vbraun created at 2017-06-13 06:51:46

Resolution: fixed
