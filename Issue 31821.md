# Issue 31821: add typing annotations in permutations

Issue created by migration from https://trac.sagemath.org/ticket/32058

Original creator: chapoton

Original creation time: 2021-06-25 12:36:09

CC:  tscrim slelievre @tobiasdiez

not everywhere, but a good start


---

Comment by chapoton created at 2021-06-25 12:37:31

New commits:


---

Comment by chapoton created at 2021-06-25 12:37:31

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-06-26 11:12:29

bot is morally green, please have a look


---

Comment by slelievre created at 2021-06-26 12:31:33

Can you say why `"Permutation"` needs quotes but not `Composition`?

Some changes I would consider (unless they slow things down):

```diff
-        return [i + 1 for i in range(len(self)) if i + 1 == self[i]]
+        return [i for i, v in enumerate(self, start=1) if i == v]
```


```diff
-        return {i + 1: self[i] for i in range(len(self))}
+        return dict(enumerate(self, start=1))
```

But feel free to ignore as this leaves the ticket's scope.

Your changes in passing from the previous loops
are a clear improvement.


---

Comment by git created at 2021-06-26 16:26:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-26 16:44:17

merci pour les suggestions. C'est fait.

Pour "Permutation", c'est parce que c'est nécessaire pour annoter les méthodes d'une classe par elle-même. Pour éviter une boucle. Enfin, je crois.


---

Comment by mkoeppe created at 2021-06-26 17:09:32

Please add `from __future__ import annotations` to the top of files that use type annotations.


---

Comment by chapoton created at 2021-06-26 19:27:08

this is not necessary for the annotations applied here, if I am not mistaken

and this was not applied to the existing annotations:

```
:~/sage$ git grep -c ") -> .*:$" src/sage/combinat/
src/sage/combinat/affine_permutation.py:10
src/sage/combinat/combinat.py:35
src/sage/combinat/interval_posets.py:81
src/sage/combinat/knutson_tao_puzzles.py:28
src/sage/combinat/necklace.py:3
src/sage/combinat/parking_functions.py:22
src/sage/combinat/permutation.py:64
src/sage/combinat/plane_partition.py:19
src/sage/combinat/posets/posets.py:15
~/sage$ git grep -c "future__.*annota" src/sage/combinat/
```



---

Comment by mkoeppe created at 2021-06-26 19:45:20

The previous annotations were probably written before we dropped Python 3.6 support in #30551. Only since Python 3.7, `from __future__ import annotations` exists.

I would think it's better to write these type annotations to one language standard instead of waiting for the first incompatibility to happen...


---

Comment by @tobiasdiez created at 2021-06-27 07:36:00

With the future import, you no longer have problems with the forward references. So in particular, you can simply write


```
- def inverse(self) -> "Permutation":
+ def inverse(self) -> Permutation:
```



Moreover, it would be good if the type of the list items would also be specified, i.e. `list[int]` instead of only `list`. Please also use `list[int]` instead of `List[int]` (with capital L). The latter is deprecated with Python 3.9, see https://docs.python.org/3/library/typing.html#typing.List.


---

Comment by @tobiasdiez created at 2021-06-27 07:40:24

`@`mkoeppe: The future import is not always necessarily. If you only use simple types, then there is no practical difference (except for the minimal performance impact of the runtime evaluation of types), so I don't think we need to import it in every file that uses type information. But as soon as you would use string-literal typing or the soon-deprecated `List` etc, I would say the future import makes sense.


---

Comment by chapoton created at 2021-06-27 08:55:03

I agree that we should try to use typing annotations in a coherent way. Alas, this has been a moving ground, with behaviour changing a lot between 3.6 and 3.9. As long as we do not refuse python 3.7 and 3.8, we should keep things simple.

This ticket is intended only as a first approximation of typing on this file. So please, let us move on and keep enhancements for later.


---

Comment by mkoeppe created at 2021-06-27 15:23:08

Replying to [comment:10 gh-tobiasdiez]:
> `@`mkoeppe: The future import is not always necessarily. 

My point is that -- whether it is necessary or not for a specific file -- it is better to add it, because that reduces both the cognitive load for developers, and reduces the chance that things get broken.


---

Comment by mkoeppe created at 2021-06-27 15:25:49

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-27 15:25:49

Replying to [comment:11 chapoton]:
> I agree that we should try to use typing annotations in a coherent way. Alas, this has been a moving ground, with behaviour changing a lot between 3.6 and 3.9. As long as we do not refuse python 3.7 and 3.8, we should keep things simple.

There is no point in writing code to an already outdated standard when adding `from __future__ import annotations` makes the current standard available to all supported Python versions.


---

Comment by mkoeppe created at 2021-06-27 15:44:47

Replying to [comment:9 gh-tobiasdiez]:
> Please also use `list[int]` instead of `List[int]` (with capital L). The latter is deprecated with Python 3.9, see https://docs.python.org/3/library/typing.html#typing.List. 

But `list[int]` was only introduced in Python 3.9, so we can't use it yet as we still support Python 3.7 and 3.8.  So we have to either use `List[int]` -- or keep things simple and just use `list`.


---

Comment by @tobiasdiez created at 2021-06-27 16:01:05

Replying to [comment:14 mkoeppe]:
> Replying to [comment:9 gh-tobiasdiez]:
> > Please also use `list[int]` instead of `List[int]` (with capital L). The latter is deprecated with Python 3.9, see https://docs.python.org/3/library/typing.html#typing.List. 
> 
> But `list[int]` was only introduced in Python 3.9, so we can't use it yet as we still support Python 3.7 and 3.8.  So we have to either use `List[int]` -- or keep things simple and just use `list`.
> 

It's backported to Python 3.7 using `from __future__ import annotations`, see https://www.python.org/dev/peps/pep-0585/#implementation


---

Comment by @tobiasdiez created at 2021-06-27 16:04:02

Replying to [comment:12 mkoeppe]:
> Replying to [comment:10 gh-tobiasdiez]:
> > `@`mkoeppe: The future import is not always necessarily. 
> 
> My point is that -- whether it is necessary or not for a specific file -- it is better to add it, because that reduces both the cognitive load for developers, and reduces the chance that things get broken.

Good point. Maybe it's worthwhile to document this in the dev docs.


---

Comment by mkoeppe created at 2021-06-27 16:08:53

Replying to [comment:16 gh-tobiasdiez]:
> Maybe it's worthwhile to document this in the dev docs.

+1 on a section on best practices for type annotations! I've opened #32067 for this.

I think we may also want to add a patchbot plugin that enforces presence of `from __future__ import annotations` whenever something that looks like a typing annotation is found in the file.


---

Comment by mkoeppe created at 2021-06-27 16:09:23

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:14 mkoeppe]:
> > Replying to [comment:9 gh-tobiasdiez]:
> > > Please also use `list[int]` instead of `List[int]` (with capital L). The latter is deprecated with Python 3.9, see https://docs.python.org/3/library/typing.html#typing.List. 
> > 
> > But `list[int]` was only introduced in Python 3.9, so we can't use it yet as we still support Python 3.7 and 3.8.  So we have to either use `List[int]` -- or keep things simple and just use `list`.
> > 
> 
> It's backported to Python 3.7 using `from __future__ import annotations`, see https://www.python.org/dev/peps/pep-0585/#implementation 

Thanks for the pointer! I didn't know that.


---

Comment by git created at 2021-06-27 19:04:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-27 19:07:50

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-06-27 19:07:50

here is a version

* not using "List", that is going soon to be deprecated

* not using "list[int]" or anything that would require a `__future__` import

so backs to needs review


---

Comment by mkoeppe created at 2021-06-27 19:09:12

Please, let's use the `__future__`. Not doing so just sets the stage for a thousand "cleanup" tickets later.


---

Comment by mkoeppe created at 2021-06-27 19:09:12

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-06-27 19:33:17

I you insist, I can do that, but I do not see the point, because I am not doing here anything that will need any cleanup later.


---

Comment by git created at 2021-06-27 19:38:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-27 19:38:49

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-06-27 19:38:49

here we go


---

Comment by mkoeppe created at 2021-06-27 19:39:23

Replying to [comment:22 chapoton]:
> I you insist, I can do that, but I do not see the point

comment 12 above

> because I am not doing here anything that will need any cleanup later.

yes you do, comment 9 above.


---

Comment by mkoeppe created at 2021-06-29 17:00:28

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-29 17:00:28

The type annotation "Permutation" is unnecessarily string-quoted - https://www.python.org/dev/peps/pep-0563/


---

Comment by git created at 2021-06-29 19:02:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-06-29 19:03:05

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-06-29 19:03:05

done
----
New commits:
----
New commits:


---

Comment by mkoeppe created at 2021-06-29 19:18:19

Thank you, LGTM.


---

Comment by mkoeppe created at 2021-06-29 19:18:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-01 21:53:19

merge conflict


---

Comment by vbraun created at 2021-07-01 21:53:19

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-07-02 19:55:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-07-02 19:55:53

setting back to positive after trivial rebase


---

Comment by chapoton created at 2021-07-02 19:55:53

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-07-09 20:23:28

Resolution: fixed
