# Issue 24252: modernize complex_mpfr

archive/issues_024252.json:
```json
{
    "body": "CC:  @mezzarobba jpflori\n\n- get rid of the factory `ComplexField` by making the class `ComplexField_class` inherits from `UniqueRepresentation`\n- rename `CompleNumber`/`ComplexField` into `ComplexFloatingPoint`/`ComplexFloatingPointField`\n- remove the attribute `_prec` of `ComplexNumber` (a `mpfr_t` carries its precision that can be obtained with `mpfr_get_prec`)\n- deprecate `is_ComplexNumber(x)`/`is_ComplexField(x)` in favor of `isinstance(x, ComplexFloatingPoint)`/`isinstance(x, ComplexFloatingPointField)`\n- clarify the behavior of rounding (currently there is a global (sic) variable taking care of it)\n\nIssue created by migration from https://trac.sagemath.org/ticket/24489\n\n",
    "created_at": "2018-01-08T08:46:13Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "modernize complex_mpfr",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24252",
    "user": "https://github.com/videlec"
}
```
CC:  @mezzarobba jpflori

- get rid of the factory `ComplexField` by making the class `ComplexField_class` inherits from `UniqueRepresentation`
- rename `CompleNumber`/`ComplexField` into `ComplexFloatingPoint`/`ComplexFloatingPointField`
- remove the attribute `_prec` of `ComplexNumber` (a `mpfr_t` carries its precision that can be obtained with `mpfr_get_prec`)
- deprecate `is_ComplexNumber(x)`/`is_ComplexField(x)` in favor of `isinstance(x, ComplexFloatingPoint)`/`isinstance(x, ComplexFloatingPointField)`
- clarify the behavior of rounding (currently there is a global (sic) variable taking care of it)

Issue created by migration from https://trac.sagemath.org/ticket/24489





---

archive/issue_comments_339221.json:
```json
{
    "body": "If you are going to do serious refactoring, here is a different proposal: deprecate `complex_mpfr` altogether and use `complex_mpc` instead as the default complex floating point field.",
    "created_at": "2018-01-08T09:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339221",
    "user": "https://github.com/jdemeyer"
}
```

If you are going to do serious refactoring, here is a different proposal: deprecate `complex_mpfr` altogether and use `complex_mpc` instead as the default complex floating point field.



---

archive/issue_comments_339222.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> If you are going to do serious refactoring, here is a different proposal: deprecate `complex_mpfr` altogether and use `complex_mpc` instead as the default complex floating point field.\n\n\n+1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed. I will be more than happy to recycle this ticket in order to do this!\n\nThough the branch in #24483 is still useful to liberate the module `sage.rings.complex_field` needed for #24456.",
    "created_at": "2018-01-08T09:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339222",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:4 jdemeyer]:
> If you are going to do serious refactoring, here is a different proposal: deprecate `complex_mpfr` altogether and use `complex_mpc` instead as the default complex floating point field.


+1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed. I will be more than happy to recycle this ticket in order to do this!

Though the branch in #24483 is still useful to liberate the module `sage.rings.complex_field` needed for #24456.



---

archive/issue_comments_339223.json:
```json
{
    "body": "> +1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed.\n\n\nPlease keep in mind #24353 which will almost certainly change timings. Unfortunately, that ticket is current stalled because it breaks MPFI. If there is a proper release of MPC, maybe I'll try to patch MPFI in Sage.",
    "created_at": "2018-01-08T10:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339223",
    "user": "https://github.com/jdemeyer"
}
```

> +1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed.


Please keep in mind #24353 which will almost certainly change timings. Unfortunately, that ticket is current stalled because it breaks MPFI. If there is a proper release of MPC, maybe I'll try to patch MPFI in Sage.



---

archive/issue_comments_339224.json:
```json
{
    "body": "Changing type from enhancement to task.",
    "created_at": "2018-01-11T19:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339224",
    "user": "https://github.com/videlec"
}
```

Changing type from enhancement to task.



---

archive/issue_comments_339225.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> Replying to [comment:4 jdemeyer]:\n\n>> +1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed. I will be more than happy to recycle this ticket in order to do this!\n\nMy bad: [it was JP Flori](https://groups.google.com/forum/#!topic/sage-devel/rCvZw4c0SYM).",
    "created_at": "2018-01-25T21:20:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339225",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:5 vdelecroix]:
> Replying to [comment:4 jdemeyer]:

>> +1. I wanted to do that at some point but Marc Mezzarobba claimed that the mpfr version was faster and hence still needed. I will be more than happy to recycle this ticket in order to do this!

My bad: [it was JP Flori](https://groups.google.com/forum/#!topic/sage-devel/rCvZw4c0SYM).



---

archive/issue_comments_339226.json:
```json
{
    "body": "Yes it used to be the case, and Paul Zimmerman improved MPC but my last souvenir is that for basic operations Sage's complex_mpfr was still faster than complex_mpc surely because it does not handle special cases (NaN, infinities, and i don't know what) gracefully.\n\nThings can have changed but there is only one way to knwom: benchmark both implementations, and I don't think I have any time for this.\n\nOn a side note, I would think it is a very good idea to get rid of complex_mpfr if we can.",
    "created_at": "2018-01-26T09:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339226",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Yes it used to be the case, and Paul Zimmerman improved MPC but my last souvenir is that for basic operations Sage's complex_mpfr was still faster than complex_mpc surely because it does not handle special cases (NaN, infinities, and i don't know what) gracefully.

Things can have changed but there is only one way to knwom: benchmark both implementations, and I don't think I have any time for this.

On a side note, I would think it is a very good idea to get rid of complex_mpfr if we can.



---

archive/issue_comments_339227.json:
```json
{
    "body": "Replying to [comment:12 jpflori]:\n> because it does not handle special cases (NaN, infinities, and i don't know what) gracefully.\n\n\nCertainly *not* because of that reason. First of all, checking for a special value is really trivial compared to dealing with Python objects. You need to work with least ~100 bits of precision to have a sensible benchmark because otherwise you are only benchmarking the Python overhead anyway.",
    "created_at": "2018-01-26T09:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339227",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 jpflori]:
> because it does not handle special cases (NaN, infinities, and i don't know what) gracefully.


Certainly *not* because of that reason. First of all, checking for a special value is really trivial compared to dealing with Python objects. You need to work with least ~100 bits of precision to have a sensible benchmark because otherwise you are only benchmarking the Python overhead anyway.



---

archive/issue_comments_339228.json:
```json
{
    "body": "Replying to [comment:12 jpflori]:\n> my last souvenir is that for basic operations Sage's complex_mpfr was still faster than complex_mpc\n\n\nOf course it's always going to be faster. But that's not the point. If you really want speed, use `CDF`.\n\nThe thing that we should focus on is the correctness. With MPC, you are guaranteed that the answer that you receive is as good as it can be. With MPFR complex numbers, we are using some arbitrary formulas and we hope that everything works. On the one hand, we use an arbitrary-precision library but we cannot say whether the many bits that you get are actually meaningful.",
    "created_at": "2018-01-26T17:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24252",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24252#issuecomment-339228",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 jpflori]:
> my last souvenir is that for basic operations Sage's complex_mpfr was still faster than complex_mpc


Of course it's always going to be faster. But that's not the point. If you really want speed, use `CDF`.

The thing that we should focus on is the correctness. With MPC, you are guaranteed that the answer that you receive is as good as it can be. With MPFR complex numbers, we are using some arbitrary formulas and we hope that everything works. On the one hand, we use an arbitrary-precision library but we cannot say whether the many bits that you get are actually meaningful.
