# Issue 22890: Stop using cysignals .pxi files (part 6)

archive/issues_022890.json:
```json
{
    "body": "Follow-up to #22806 and #22896: we should stop using the deprecated files `cysignals/memory.pxi` and `cysignals/signals.pxi`.\n\nGiven the large number of files which need to be changed, this is done in parts.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23127\n\n",
    "created_at": "2017-06-02T10:29:23Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "title": "Stop using cysignals .pxi files (part 6)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22890",
    "user": "jdemeyer"
}
```
Follow-up to #22806 and #22896: we should stop using the deprecated files `cysignals/memory.pxi` and `cysignals/signals.pxi`.

Given the large number of files which need to be changed, this is done in parts.

Issue created by migration from https://trac.sagemath.org/ticket/23127





---

archive/issue_comments_320168.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-02T12:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320168",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_320169.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-02T12:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320169",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_320170.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-03T00:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320170",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_320171.json:
```json
{
    "body": "LGTM.",
    "created_at": "2017-06-03T00:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320171",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_320172.json:
```json
{
    "body": "I'm getting random failures in `matrix_integer_dense`, like\n\n```\nsage -t --long src/sage/geometry/cone.py\n**********************************************************************\nFile \"src/sage/geometry/cone.py\", line 4862, in sage.geometry.cone.?.lyapunov_rank\nFailed example:\n    b = K.lyapunov_rank()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 509, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 872, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.geometry.cone.?.lyapunov_rank[48]>\", line 1, in <module>\n        b = K.lyapunov_rank()\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 4926, in lyapunov_rank\n        return len(K_SP.lyapunov_like_basis()) + l*m + (n - m)*n\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 4688, in lyapunov_like_basis\n        for (x,s) in self.discrete_complementarity_set() ]\n      File \"sage/misc/cachefunc.pyx\", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/misc/cachefunc.c:13463)\n        self.cache = f(self._instance)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 4540, in discrete_complementarity_set\n        return tuple( (x,s) for x in self\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 4541, in <genexpr>\n        for s in self.dual()\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 2067, in dual\n        for ray in self.orthogonal_sublattice().gens():\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py\", line 3694, in orthogonal_sublattice\n        self._orthogonal_sublattice = self.sublattice_quotient().dual()\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/toric_lattice.py\", line 1709, in dual\n        self.W().basis_matrix().transpose().integer_kernel().gens())\n      File \"sage/matrix/matrix2.pyx\", line 4499, in sage.matrix.matrix2.Matrix.integer_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:32685)\n        return A.kernel()\n      File \"sage/matrix/matrix2.pyx\", line 4350, in sage.matrix.matrix2.Matrix.left_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31925)\n        K = self.transpose().right_kernel(*args, **kwds)\n      File \"sage/matrix/matrix2.pyx\", line 4191, in sage.matrix.matrix2.Matrix.right_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31366)\n        M = self.right_kernel_matrix(*args, **kwds)\n      File \"sage/matrix/matrix2.pyx\", line 3796, in sage.matrix.matrix2.Matrix.right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:29865)\n        format, M = self._right_kernel_matrix(algorithm=algorithm, proof=proof)\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 2565, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:21866)\n        K = self._rational_kernel_flint().transpose().saturation(proof=proof)\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 2092, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.saturation (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:18845)\n        return saturation(self, p=p, proof=proof, max_dets=max_dets)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense_saturation.py\", line 222, in saturation\n        r = A.rank()\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)\n        r = self._rank_modp()\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)\n        return A.rank()\n    SystemError: NULL result without error in PyObject_Call\n```\n\nIts always different for each run but happens ~50% of the cases on Ubuntu 14 32&64-bit",
    "created_at": "2017-06-07T20:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320172",
    "user": "vbraun"
}
```

I'm getting random failures in `matrix_integer_dense`, like

```
sage -t --long src/sage/geometry/cone.py
**********************************************************************
File "src/sage/geometry/cone.py", line 4862, in sage.geometry.cone.?.lyapunov_rank
Failed example:
    b = K.lyapunov_rank()
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.cone.?.lyapunov_rank[48]>", line 1, in <module>
        b = K.lyapunov_rank()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4926, in lyapunov_rank
        return len(K_SP.lyapunov_like_basis()) + l*m + (n - m)*n
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4688, in lyapunov_like_basis
        for (x,s) in self.discrete_complementarity_set() ]
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/misc/cachefunc.c:13463)
        self.cache = f(self._instance)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4540, in discrete_complementarity_set
        return tuple( (x,s) for x in self
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4541, in <genexpr>
        for s in self.dual()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 2067, in dual
        for ray in self.orthogonal_sublattice().gens():
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 3694, in orthogonal_sublattice
        self._orthogonal_sublattice = self.sublattice_quotient().dual()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/toric_lattice.py", line 1709, in dual
        self.W().basis_matrix().transpose().integer_kernel().gens())
      File "sage/matrix/matrix2.pyx", line 4499, in sage.matrix.matrix2.Matrix.integer_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:32685)
        return A.kernel()
      File "sage/matrix/matrix2.pyx", line 4350, in sage.matrix.matrix2.Matrix.left_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31925)
        K = self.transpose().right_kernel(*args, **kwds)
      File "sage/matrix/matrix2.pyx", line 4191, in sage.matrix.matrix2.Matrix.right_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31366)
        M = self.right_kernel_matrix(*args, **kwds)
      File "sage/matrix/matrix2.pyx", line 3796, in sage.matrix.matrix2.Matrix.right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:29865)
        format, M = self._right_kernel_matrix(algorithm=algorithm, proof=proof)
      File "sage/matrix/matrix_integer_dense.pyx", line 2565, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:21866)
        K = self._rational_kernel_flint().transpose().saturation(proof=proof)
      File "sage/matrix/matrix_integer_dense.pyx", line 2092, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.saturation (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:18845)
        return saturation(self, p=p, proof=proof, max_dets=max_dets)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense_saturation.py", line 222, in saturation
        r = A.rank()
      File "sage/matrix/matrix_integer_dense.pyx", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)
        r = self._rank_modp()
      File "sage/matrix/matrix_integer_dense.pyx", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)
        return A.rank()
    SystemError: NULL result without error in PyObject_Call
```

Its always different for each run but happens ~50% of the cases on Ubuntu 14 32&64-bit



---

archive/issue_comments_320173.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-06-07T20:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320173",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_320174.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> Its always different for each run\n\nWhat do you mean with that?",
    "created_at": "2017-06-07T20:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320174",
    "user": "jdemeyer"
}
```

Replying to [comment:4 vbraun]:
> Its always different for each run

What do you mean with that?



---

archive/issue_comments_320175.json:
```json
{
    "body": "I.e. crashes in different tests or sometimes not at all.",
    "created_at": "2017-06-07T22:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320175",
    "user": "vbraun"
}
```

I.e. crashes in different tests or sometimes not at all.



---

archive/issue_comments_320176.json:
```json
{
    "body": "Maybe it comes from this becoming a `calloc` instead of a `malloc` and doing the 0 initialization (this was done a few places)?\n\n```diff\n@@ -145,20 +148,18 @@ cdef class Matrix_modn_sparse(matrix_sparse.Matrix_sparse):\n         p = parent.base_ring().order()\n         self.p = p\n \n-\n-        self.rows = <c_vector_modint*> sig_malloc(nr*sizeof(c_vector_modint))\n-        if self.rows == NULL:\n-            raise MemoryError(\"error allocating memory for sparse matrix\")\n+        self.rows = <c_vector_modint*>check_calloc(nr, sizeof(c_vector_modint))\n \n         for i from 0 <= i < nr:\n             init_c_vector_modint(&self.rows[i], p, nc, 0)\n \n```\n\nAlthough that doesn't make much sense to me (or why it would only appear some of the time).\n\nThe only other change in logic (other than adding extra checks that it did allocate) is this one:\n\n```diff\n@@ -457,19 +458,8 @@ cdef class Matrix_modn_dense_template(Matrix_dense):\n         if p >= MAX_MODULUS:\n             raise OverflowError(\"p (=%s) must be < %s.\"%(p, MAX_MODULUS))\n \n-        sig_on()\n-        self._entries = <celement *> sig_malloc(sizeof(celement)*self._nrows*self._ncols)\n-        sig_off()\n-        if self._entries == NULL:\n-           raise MemoryError(\"Error allocating matrix.\")\n-\n-        sig_on()\n-        self._matrix = <celement **> sig_malloc(sizeof(celement*)*self._nrows)\n-        sig_off()\n-        if self._matrix == NULL:\n-            sig_free(self._entries)\n-            self._entries = NULL\n-            raise MemoryError(\"Error allocating memory.\")\n+        self._entries = <celement *>check_allocarray(self._nrows * self._ncols, sizeof(celement))\n+        self._matrix = <celement **>check_allocarray(self._nrows, sizeof(celement*))\n \n         cdef unsigned int k\n         cdef Py_ssize_t i\n```\n\nHowever, the only difference there is we do not cleanup the `self._entries` if the latter happens to fail but the former succeeds (actually, shouldn't we still do that?).\n\n*scratches head*",
    "created_at": "2017-06-08T00:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320176",
    "user": "tscrim"
}
```

Maybe it comes from this becoming a `calloc` instead of a `malloc` and doing the 0 initialization (this was done a few places)?

```diff
@@ -145,20 +148,18 @@ cdef class Matrix_modn_sparse(matrix_sparse.Matrix_sparse):
         p = parent.base_ring().order()
         self.p = p
 
-
-        self.rows = <c_vector_modint*> sig_malloc(nr*sizeof(c_vector_modint))
-        if self.rows == NULL:
-            raise MemoryError("error allocating memory for sparse matrix")
+        self.rows = <c_vector_modint*>check_calloc(nr, sizeof(c_vector_modint))
 
         for i from 0 <= i < nr:
             init_c_vector_modint(&self.rows[i], p, nc, 0)
 
```

Although that doesn't make much sense to me (or why it would only appear some of the time).

The only other change in logic (other than adding extra checks that it did allocate) is this one:

```diff
@@ -457,19 +458,8 @@ cdef class Matrix_modn_dense_template(Matrix_dense):
         if p >= MAX_MODULUS:
             raise OverflowError("p (=%s) must be < %s."%(p, MAX_MODULUS))
 
-        sig_on()
-        self._entries = <celement *> sig_malloc(sizeof(celement)*self._nrows*self._ncols)
-        sig_off()
-        if self._entries == NULL:
-           raise MemoryError("Error allocating matrix.")
-
-        sig_on()
-        self._matrix = <celement **> sig_malloc(sizeof(celement*)*self._nrows)
-        sig_off()
-        if self._matrix == NULL:
-            sig_free(self._entries)
-            self._entries = NULL
-            raise MemoryError("Error allocating memory.")
+        self._entries = <celement *>check_allocarray(self._nrows * self._ncols, sizeof(celement))
+        self._matrix = <celement **>check_allocarray(self._nrows, sizeof(celement*))
 
         cdef unsigned int k
         cdef Py_ssize_t i
```

However, the only difference there is we do not cleanup the `self._entries` if the latter happens to fail but the former succeeds (actually, shouldn't we still do that?).

*scratches head*



---

archive/issue_comments_320177.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Maybe it comes from this becoming a `calloc` instead of a `malloc`\n\nThat was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.",
    "created_at": "2017-06-08T07:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320177",
    "user": "jdemeyer"
}
```

Replying to [comment:7 tscrim]:
> Maybe it comes from this becoming a `calloc` instead of a `malloc`

That was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.



---

archive/issue_comments_320178.json:
```json
{
    "body": "So far, I have not been able to reproduce the issue on my laptop.",
    "created_at": "2017-06-08T07:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320178",
    "user": "jdemeyer"
}
```

So far, I have not been able to reproduce the issue on my laptop.



---

archive/issue_comments_320179.json:
```json
{
    "body": "I am moving the part of this patch not involving `src/sage/matrix` to #23176.",
    "created_at": "2017-06-08T07:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320179",
    "user": "jdemeyer"
}
```

I am moving the part of this patch not involving `src/sage/matrix` to #23176.



---

archive/issue_comments_320180.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-06-08T07:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320180",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_320181.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> I.e. crashes in different tests or sometimes not at all.\n\nBut does the traceback always involve\n\n```\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)\n        r = self._rank_modp()\n      File \"sage/matrix/matrix_integer_dense.pyx\", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)\n        return A.rank()\n    SystemError: NULL result without error in PyObject_Call\n```\n",
    "created_at": "2017-06-08T07:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320181",
    "user": "jdemeyer"
}
```

Replying to [comment:6 vbraun]:
> I.e. crashes in different tests or sometimes not at all.

But does the traceback always involve

```
      File "sage/matrix/matrix_integer_dense.pyx", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)
        r = self._rank_modp()
      File "sage/matrix/matrix_integer_dense.pyx", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)
        return A.rank()
    SystemError: NULL result without error in PyObject_Call
```




---

archive/issue_comments_320182.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 tscrim]:\n> > Maybe it comes from this becoming a `calloc` instead of a `malloc`\n> \n> That was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.\n\nRight. I'm not saying it was wrong, but I'm just looking for logical changes. At least those were the most explicit I could see; the others push the logic to cysignals unless I am missing or misreading something. So if there was an issue not related to one of those changes, I would think it is an upstream bug...",
    "created_at": "2017-06-08T08:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320182",
    "user": "tscrim"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > Maybe it comes from this becoming a `calloc` instead of a `malloc`
> 
> That was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.

Right. I'm not saying it was wrong, but I'm just looking for logical changes. At least those were the most explicit I could see; the others push the logic to cysignals unless I am missing or misreading something. So if there was an issue not related to one of those changes, I would think it is an upstream bug...



---

archive/issue_comments_320183.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> So if there was an issue not related to one of those changes, I would think it is an upstream bug...\n\nThere are no bugs in cysignals :-)\n\nI find it a bit strange that the errors are non-deterministic. Usually, calls to `malloc()` are pretty predictable (the addresses that it returns are not, but I don't see how that would matter).",
    "created_at": "2017-06-08T08:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320183",
    "user": "jdemeyer"
}
```

Replying to [comment:13 tscrim]:
> So if there was an issue not related to one of those changes, I would think it is an upstream bug...

There are no bugs in cysignals :-)

I find it a bit strange that the errors are non-deterministic. Usually, calls to `malloc()` are pretty predictable (the addresses that it returns are not, but I don't see how that would matter).



---

archive/issue_comments_320184.json:
```json
{
    "body": "> There are no bugs in cysignals :-) \n\nOf course, there are other upstreams too. :)\n\nSo the randomness almost certainly comes from the test:\n\n```sage\nsage: set_random_seed()\nsage: K = random_cone(max_ambient_dim=8,\n....:                 min_rays=1,\n....:                 strictly_convex=True,\n....:                 solid=True)\nsage: b = K.lyapunov_rank()\nsage: n = K.lattice_dim()\nsage: 1 <= b <= n\nTrue\nsage: b == n-1\nFalse\n```\n\nIn certain cases, it must fail in some way. The only change that is made in chasing down the codepath in `linbox_copy`:\n\n```diff\n@@ -234,7 +235,7 @@ cdef inline celement *linbox_copy(celement modulus, celement *entries,  Py_ssize\n     \"\"\"\n     Create a copy of the entries array.\n     \"\"\"\n-    cdef celement *entries_copy = <celement*>sig_malloc(sizeof(celement)*nrows*ncols)\n+    cdef celement *entries_copy = <celement*>check_allocarray(nrows * ncols, sizeof(celement))\n     memcpy(entries_copy, entries, sizeof(celement)*nrows*ncols)\n     return entries_copy\n \n```\n\nIt might have to do with the fact that an error gets raised during some tests by `check_allocarray`, which then results in the error message because the `except NULL` that gets percolated up to Python.",
    "created_at": "2017-06-08T08:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320184",
    "user": "tscrim"
}
```

> There are no bugs in cysignals :-) 

Of course, there are other upstreams too. :)

So the randomness almost certainly comes from the test:

```sage
sage: set_random_seed()
sage: K = random_cone(max_ambient_dim=8,
....:                 min_rays=1,
....:                 strictly_convex=True,
....:                 solid=True)
sage: b = K.lyapunov_rank()
sage: n = K.lattice_dim()
sage: 1 <= b <= n
True
sage: b == n-1
False
```

In certain cases, it must fail in some way. The only change that is made in chasing down the codepath in `linbox_copy`:

```diff
@@ -234,7 +235,7 @@ cdef inline celement *linbox_copy(celement modulus, celement *entries,  Py_ssize
     """
     Create a copy of the entries array.
     """
-    cdef celement *entries_copy = <celement*>sig_malloc(sizeof(celement)*nrows*ncols)
+    cdef celement *entries_copy = <celement*>check_allocarray(nrows * ncols, sizeof(celement))
     memcpy(entries_copy, entries, sizeof(celement)*nrows*ncols)
     return entries_copy
 
```

It might have to do with the fact that an error gets raised during some tests by `check_allocarray`, which then results in the error message because the `except NULL` that gets percolated up to Python.



---

archive/issue_comments_320185.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-08T09:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320185",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320186.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-08T09:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320186",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_320187.json:
```json
{
    "body": "Travis, if your analysis is correct, this should fix it.",
    "created_at": "2017-06-08T09:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320187",
    "user": "jdemeyer"
}
```

Travis, if your analysis is correct, this should fix it.



---

archive/issue_comments_320188.json:
```json
{
    "body": "I never got this failure either. So I apologize in advance to Volker if this doesn't work.",
    "created_at": "2017-06-08T09:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320188",
    "user": "tscrim"
}
```

I never got this failure either. So I apologize in advance to Volker if this doesn't work.



---

archive/issue_comments_320189.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-08T09:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320189",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_320190.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-06-09T21:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320190",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_320191.json:
```json
{
    "body": "Doesn't build (probably conflicts with another ticket).",
    "created_at": "2017-06-09T21:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320191",
    "user": "vbraun"
}
```

Doesn't build (probably conflicts with another ticket).



---

archive/issue_comments_320192.json:
```json
{
    "body": "Indeed, this is due to #15104.",
    "created_at": "2017-06-12T12:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320192",
    "user": "jdemeyer"
}
```

Indeed, this is due to #15104.



---

archive/issue_comments_320193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-12T12:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320193",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320194.json:
```json
{
    "body": "Trivial fix, setting back to positive_review.",
    "created_at": "2017-06-12T12:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320194",
    "user": "jdemeyer"
}
```

Trivial fix, setting back to positive_review.



---

archive/issue_comments_320195.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-06-12T12:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320195",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_320196.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-13T06:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320196",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_320197.json:
```json
{
    "body": "Great! Travis, thanks a lot for your analysis in [comment:15]!",
    "created_at": "2017-06-13T18:46:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320197",
    "user": "jdemeyer"
}
```

Great! Travis, thanks a lot for your analysis in [comment:15]!



---

archive/issue_comments_320198.json:
```json
{
    "body": "No problem, although I feel more like I cured the symptom than the disease.",
    "created_at": "2017-06-14T00:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22890#issuecomment-320198",
    "user": "tscrim"
}
```

No problem, although I feel more like I cured the symptom than the disease.
