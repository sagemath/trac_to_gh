# Issue 22890: Stop using cysignals .pxi files (part 6)

Issue created by migration from https://trac.sagemath.org/ticket/23127

Original creator: jdemeyer

Original creation time: 2017-06-02 10:29:23

Follow-up to #22806 and #22896: we should stop using the deprecated files `cysignals/memory.pxi` and `cysignals/signals.pxi`.

Given the large number of files which need to be changed, this is done in parts.


---

Comment by jdemeyer created at 2017-06-02 12:29:31

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-06-02 12:29:31

New commits:


---

Comment by tscrim created at 2017-06-03 00:13:48

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-06-03 00:13:48

LGTM.


---

Comment by vbraun created at 2017-06-07 20:07:19

I'm getting random failures in `matrix_integer_dense`, like

```
sage -t --long src/sage/geometry/cone.py
**********************************************************************
File "src/sage/geometry/cone.py", line 4862, in sage.geometry.cone.?.lyapunov_rank
Failed example:
    b = K.lyapunov_rank()
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.cone.?.lyapunov_rank[48]>", line 1, in <module>
        b = K.lyapunov_rank()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4926, in lyapunov_rank
        return len(K_SP.lyapunov_like_basis()) + l*m + (n - m)*n
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4688, in lyapunov_like_basis
        for (x,s) in self.discrete_complementarity_set() ]
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/misc/cachefunc.c:13463)
        self.cache = f(self._instance)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4540, in discrete_complementarity_set
        return tuple( (x,s) for x in self
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 4541, in <genexpr>
        for s in self.dual()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 2067, in dual
        for ray in self.orthogonal_sublattice().gens():
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/cone.py", line 3694, in orthogonal_sublattice
        self._orthogonal_sublattice = self.sublattice_quotient().dual()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/geometry/toric_lattice.py", line 1709, in dual
        self.W().basis_matrix().transpose().integer_kernel().gens())
      File "sage/matrix/matrix2.pyx", line 4499, in sage.matrix.matrix2.Matrix.integer_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:32685)
        return A.kernel()
      File "sage/matrix/matrix2.pyx", line 4350, in sage.matrix.matrix2.Matrix.left_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31925)
        K = self.transpose().right_kernel(*args, **kwds)
      File "sage/matrix/matrix2.pyx", line 4191, in sage.matrix.matrix2.Matrix.right_kernel (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:31366)
        M = self.right_kernel_matrix(*args, **kwds)
      File "sage/matrix/matrix2.pyx", line 3796, in sage.matrix.matrix2.Matrix.right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix2.c:29865)
        format, M = self._right_kernel_matrix(algorithm=algorithm, proof=proof)
      File "sage/matrix/matrix_integer_dense.pyx", line 2565, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._right_kernel_matrix (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:21866)
        K = self._rational_kernel_flint().transpose().saturation(proof=proof)
      File "sage/matrix/matrix_integer_dense.pyx", line 2092, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.saturation (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:18845)
        return saturation(self, p=p, proof=proof, max_dets=max_dets)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense_saturation.py", line 222, in saturation
        r = A.rank()
      File "sage/matrix/matrix_integer_dense.pyx", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)
        r = self._rank_modp()
      File "sage/matrix/matrix_integer_dense.pyx", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)
        return A.rank()
    SystemError: NULL result without error in PyObject_Call
```

Its always different for each run but happens ~50% of the cases on Ubuntu 14 32&64-bit


---

Comment by vbraun created at 2017-06-07 20:07:19

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-06-07 20:25:24

Replying to [comment:4 vbraun]:
> Its always different for each run

What do you mean with that?


---

Comment by vbraun created at 2017-06-07 22:32:44

I.e. crashes in different tests or sometimes not at all.


---

Comment by tscrim created at 2017-06-08 00:13:54

Maybe it comes from this becoming a `calloc` instead of a `malloc` and doing the 0 initialization (this was done a few places)?

```diff
@@ -145,20 +148,18 @@ cdef class Matrix_modn_sparse(matrix_sparse.Matrix_sparse):
         p = parent.base_ring().order()
         self.p = p
 
-
-        self.rows = <c_vector_modint*> sig_malloc(nr*sizeof(c_vector_modint))
-        if self.rows == NULL:
-            raise MemoryError("error allocating memory for sparse matrix")
+        self.rows = <c_vector_modint*>check_calloc(nr, sizeof(c_vector_modint))
 
         for i from 0 <= i < nr:
             init_c_vector_modint(&self.rows[i], p, nc, 0)
 
```

Although that doesn't make much sense to me (or why it would only appear some of the time).

The only other change in logic (other than adding extra checks that it did allocate) is this one:

```diff
@@ -457,19 +458,8 @@ cdef class Matrix_modn_dense_template(Matrix_dense):
         if p >= MAX_MODULUS:
             raise OverflowError("p (=%s) must be < %s."%(p, MAX_MODULUS))
 
-        sig_on()
-        self._entries = <celement *> sig_malloc(sizeof(celement)*self._nrows*self._ncols)
-        sig_off()
-        if self._entries == NULL:
-           raise MemoryError("Error allocating matrix.")
-
-        sig_on()
-        self._matrix = <celement **> sig_malloc(sizeof(celement*)*self._nrows)
-        sig_off()
-        if self._matrix == NULL:
-            sig_free(self._entries)
-            self._entries = NULL
-            raise MemoryError("Error allocating memory.")
+        self._entries = <celement *>check_allocarray(self._nrows * self._ncols, sizeof(celement))
+        self._matrix = <celement **>check_allocarray(self._nrows, sizeof(celement*))
 
         cdef unsigned int k
         cdef Py_ssize_t i
```

However, the only difference there is we do not cleanup the `self._entries` if the latter happens to fail but the former succeeds (actually, shouldn't we still do that?).

*scratches head*


---

Comment by jdemeyer created at 2017-06-08 07:43:24

Replying to [comment:7 tscrim]:
> Maybe it comes from this becoming a `calloc` instead of a `malloc`

That was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.


---

Comment by jdemeyer created at 2017-06-08 07:49:12

So far, I have not been able to reproduce the issue on my laptop.


---

Comment by jdemeyer created at 2017-06-08 07:55:40

I am moving the part of this patch not involving `src/sage/matrix` to #23176.


---

Comment by git created at 2017-06-08 07:56:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-06-08 07:58:11

Replying to [comment:6 vbraun]:
> I.e. crashes in different tests or sometimes not at all.

But does the traceback always involve

```
      File "sage/matrix/matrix_integer_dense.pyx", line 3463, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.rank (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30139)
        r = self._rank_modp()
      File "sage/matrix/matrix_integer_dense.pyx", line 3493, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._rank_modp (/home/buildbot/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_integer_dense.c:30501)
        return A.rank()
    SystemError: NULL result without error in PyObject_Call
```



---

Comment by tscrim created at 2017-06-08 08:04:32

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > Maybe it comes from this becoming a `calloc` instead of a `malloc`
> 
> That was actually meant to be safer. If you have an array of pointers, it's good practice to initialize it with zeros such that you can safely `free()` them.

Right. I'm not saying it was wrong, but I'm just looking for logical changes. At least those were the most explicit I could see; the others push the logic to cysignals unless I am missing or misreading something. So if there was an issue not related to one of those changes, I would think it is an upstream bug...


---

Comment by jdemeyer created at 2017-06-08 08:11:12

Replying to [comment:13 tscrim]:
> So if there was an issue not related to one of those changes, I would think it is an upstream bug...

There are no bugs in cysignals :-)

I find it a bit strange that the errors are non-deterministic. Usually, calls to `malloc()` are pretty predictable (the addresses that it returns are not, but I don't see how that would matter).


---

Comment by tscrim created at 2017-06-08 08:31:34

> There are no bugs in cysignals :-) 

Of course, there are other upstreams too. :)

So the randomness almost certainly comes from the test:

```sage
sage: set_random_seed()
sage: K = random_cone(max_ambient_dim=8,
....:                 min_rays=1,
....:                 strictly_convex=True,
....:                 solid=True)
sage: b = K.lyapunov_rank()
sage: n = K.lattice_dim()
sage: 1 <= b <= n
True
sage: b == n-1
False
```

In certain cases, it must fail in some way. The only change that is made in chasing down the codepath in `linbox_copy`:

```diff
@@ -234,7 +235,7 @@ cdef inline celement *linbox_copy(celement modulus, celement *entries,  Py_ssize
     """
     Create a copy of the entries array.
     """
-    cdef celement *entries_copy = <celement*>sig_malloc(sizeof(celement)*nrows*ncols)
+    cdef celement *entries_copy = <celement*>check_allocarray(nrows * ncols, sizeof(celement))
     memcpy(entries_copy, entries, sizeof(celement)*nrows*ncols)
     return entries_copy
 
```

It might have to do with the fact that an error gets raised during some tests by `check_allocarray`, which then results in the error message because the `except NULL` that gets percolated up to Python.


---

Comment by git created at 2017-06-08 09:04:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-06-08 09:04:55

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-06-08 09:04:55

Travis, if your analysis is correct, this should fix it.


---

Comment by tscrim created at 2017-06-08 09:26:25

I never got this failure either. So I apologize in advance to Volker if this doesn't work.


---

Comment by tscrim created at 2017-06-08 09:30:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-09 21:01:42

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-06-09 21:01:42

Doesn't build (probably conflicts with another ticket).


---

Comment by jdemeyer created at 2017-06-12 12:41:43

Indeed, this is due to #15104.


---

Comment by git created at 2017-06-12 12:45:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-06-12 12:47:40

Trivial fix, setting back to positive_review.


---

Comment by jdemeyer created at 2017-06-12 12:47:40

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-06-13 06:51:39

Resolution: fixed


---

Comment by jdemeyer created at 2017-06-13 18:46:00

Great! Travis, thanks a lot for your analysis in [comment:15]!


---

Comment by tscrim created at 2017-06-14 00:04:10

No problem, although I feel more like I cured the symptom than the disease.
