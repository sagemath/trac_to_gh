# Issue 23891: A framework for finite dynamics (permutations of finite sets)

Issue created by migration from https://trac.sagemath.org/ticket/24128

Original creator: darij

Original creation time: 2017-10-31 02:33:11

CC:  troby sage-combinat

Keywords: IMA coding sprint, homomesy, cyclic sieving, permutations

Create a class that takes a finite set and an automorphism as inputs, and computes the orbit sizes and verifies homomesy with respect to any given statistic or cyclic sieving with respect to any given polynomial. Something like that seems to have been envisioned in ticket #18062, but to our knowledge never implemented.


---

Comment by roed created at 2017-11-01 21:19:00

Changing component from PLEASE CHANGE to dynamics.


---

Comment by darij created at 2018-03-31 21:43:12

I realize some of this is done in `src/sage/combinat/cyclic_sieving_phenomenon.py`. Of course, we'd want more: homomesy checking; finding the orbit of a single point rather than all the orbits.

What is the general opinion about this module? Should we just add to it, or should it be completely refactored?


---

Comment by tscrim created at 2018-03-31 23:35:40

My approach would be to refactor.


---

Comment by darij created at 2018-04-01 19:56:45

I assume it would be


```
class DiscreteDynamicalSystem(...):
```


Do you have any suggestions as to what class should we copypaste to get a reasonable format? What kind of methods would it need? `__init__`, `_repr_`, etc.?


---

Comment by tscrim created at 2018-04-02 01:37:01

You may just want to start crafting your own class without using another as a template. You should do the basic methods of `__init__`, `_repr_`, and go from there. I would think about how you want to use an instance of `DiscreteDynamicalSystem` and work from there. In other words, do test-based programming (write the tests you want it to pass and then fill in the code until it does).


---

Comment by darij created at 2018-04-04 00:18:36

Some work done. The class is functional for what we need -- homomesy checking for dynamical systems with invertible evolution --, but its doc is very bare-bones and it's lacking a lot of bells and whistles. Also, the three examples are "def"-functions rather than subclasses of their own; thus, their "repr" is crap.
----
New commits:


---

Comment by tscrim created at 2018-04-04 01:22:38

I know I had mentioned `object` to you, but `SageObject` is actually the better thing to inherit from. Mea culpa. Then you can use `_repr_` (and `_latex_`, `_ascii_art_`, and `_unicode_art_`).

Note that if you do `self._X = tuple(X)`, then you force `X` to be finite.

I would also consider not putting the evolution function in the repr. Things like that can be more trouble than its worth IMO.

I noticed on a quick look: you have `FDDS` in the `DiscreteDynamicalSystem` doc.


---

Comment by git created at 2018-04-04 17:53:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-04-07 07:07:58

Missing doctests in combinat/finite_dynamical_system.py: 7 / 15 = 46%


---

Comment by darij created at 2018-04-07 13:13:34

Thank you, but this is nowhere near completion. I'll work on it whenever I have time (which is probably not too often this semester...).


---

Comment by git created at 2018-10-05 19:51:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-06 20:42:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @darijgr created at 2018-10-06 20:46:01

This now has sufficient functionality for anything I personally want to do. Not sure if the class hierarchy is up to Sage standards, though:


```
- :class:`DiscreteDynamicalSystem`: general discrete dynamical
  system, as above.
  Inherit from this class if the ground set of your DDS is
  infinite or large enough that you want to avoid it getting
  stored as a list.

- :class:`FiniteDynamicalSystem`: finite discrete dynamical
  system.

- :class:`InvertibleDiscreteDynamicalSystem`: invertible
  discrete dynamical system.
  This implements an ``inverse_evolution`` method for `\phi^{-1}`
  (the default implementation simply applies `\phi` over and
  over until the original value is revisited; the last value
  before that is then taken to be the result).

- :class:`InvertibleFiniteDynamicalSystem`: invertible
  finite discrete dynamical system.
```


(This would perhaps be easier with the category framework, but I don't know it well enough.)

There are a few examples, all of which are implemented as staticmethods on a class `class discrete_dynamical_systems()`.


---

Comment by @darijgr created at 2018-10-06 20:46:01

Changing keywords from "IMA coding sprint, homomesy, cyclic sieving, permutations" to "IMA coding sprint, homomesy, cyclic sieving, permutations, sage-combinat".


---

Comment by git created at 2018-10-06 20:51:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-06 21:00:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @darijgr created at 2018-10-06 21:01:01

Little questions:

- Implement `_repr_` or `__repr__`?

- Should the repr function output the evolution function, even when it is going to be a faceless lambda most of the time?


---

Comment by git created at 2018-10-06 21:02:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-10-06 23:06:11

I am not sure if we should get the category framework involved or not. At present, there does not seem to be any benefit to using that machinery. You don't have any parents or elements (granted, your systems could be considered as faÃ§ade parents). So this seems fine for now. We can always refactor it later as things evolve (your welcome Tom).

I would not have a class `discrete_dynamical_systems` with ``@`staticmethod`s. Instead, I would implement a catalog module and have functions there. You then import the catalog file in the global namespace as `discrete_dynamical_systems`. I would also make them faux-classes in terms of naming (i.e., using CamelCase).

Some things to note:

- You should use `_repr_` so you can override this with `rename` and you are inheriting from `SageObject`.
- I probably would not add the rule to the output because it will not be so useful.
- `.. TODO ::` -> `.. TODO::` and what follows should be indented.
- ~~You should call the method `evolve` instead of `evolution` because you evolve the system, you don't evolution the system.~~ Edit: I misread the code
- I have been doing similar things on #25796 and #25797 and `sage/dynamics/cellular_automata/soliton.py`. It probably is coming to the point where we should make things have a fairly consistent API and see what we can learn from both.


---

Comment by git created at 2018-10-06 23:10:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-08 18:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-24 18:05:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-24 18:06:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-10-24 18:08:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-10-24 18:15:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2018-10-24 18:20:56

Changing status from new to needs_review.


---

Comment by @darijgr created at 2018-10-24 18:20:56

This is now needs_review.

For now, the functionality is fairly shallow (the most complicated algorithm is finding all cycles of a finite DDS); the main use of the module is convenience and examples. There are lots of todos in the doc, some of which I may want to deal with one day.

The file is called `sage/combinat/finite_dynamical_system.py` because it is mainly meant for use by combinatorialists and because most of the functionality concerns finite DDSes, but I am open to renaming and/or moving it.


---

Comment by tscrim created at 2018-10-27 02:47:50

I think this should go in the `sage/dynamics` folder and then be listed in the `Discrete dynamics` header in the corresponding `index.rst` file.

I am not sure I agree with putting the important doc at the module level. This makes it really difficult for people using `?` to see it. Moreover, if the module level is really short, people will quickly find the class to see the doc when looking at it from the html.

You should put the `INPUT:` block in the class level doc because it will only get seen by people looking at the source code in the `__init__`. Same for the `EXAMPLES::`. A good test to do in `__init__` is a `TestSuite(Foo).run()`.

Why do you not automatically force `X` to be a tuple? Concerned if `X` is a parent object? Why not test `if isinstance(X, Parent):` and otherwise (if not also `None`) force `X` to be a tuple. I don't see the reason why it should be allowed to stay mutable.

This would be cleaner and faster if you pull out the `self.evolution()` and `self.inverse_evolution()` as variables:

```
            if self.evolution()(self.inverse_evolution()(y)) != y:
                return False
            if self.inverse_evolution()(self.evolution()(y)) != y:
```


If you change `inverse_evolution_default` to `_inverse`, then you only have to do

```diff
-        if inverse is None:
-            self._inverse = self.inverse_evolution_default
-        else:
+        if inverse is not None:
            self._inverse = inverse
```


Again, I think you should have a catalog (module) instead of a class with a bunch of ``@`staticmethod`s.


---

Comment by tscrim created at 2018-10-27 02:47:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-11-05 18:09:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-09 02:07:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-18 14:36:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-18 14:41:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-03-18 14:42:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-03-18 14:49:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2019-03-18 17:56:55

Note to self:

- doctest the classcall dispatcher

- remove all but the main class from global namespace

- check Algebras and Crystals for catalog examples

- document the "inverse" argument on main class


---

Comment by git created at 2019-07-11 07:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 07:23:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 07:50:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 07:51:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 07:58:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 08:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 08:14:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 08:17:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 08:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 08:32:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2019-07-11 08:40:51

I've reviewed the classcall functionality and adapted the patch to it (now, only the main class is in the global namespace, and all but a few doctests have been adapted to use the classcall). In the classcall itself, I have added an `is_finite` parameter that lets you specify finiteness directly rather than letting Sage figure it out (otherwise, `Words(2, 5)` would not be considered finite).

I'm a bit scared of the catalogs. Algebras and crystals have a bare-bones catalog.py file that just links to other files. Is this really something I should imitate, or should everything be in a single file?


---

Comment by git created at 2019-07-11 09:21:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 09:44:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 09:48:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-11 10:00:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 10:02:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 10:02:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 10:06:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2019-07-11 10:10:49

b4a4b2ed50f51ffff74918b1e327e0d196b2e50f = latest working commit.

e91750eae98541d8c220560ad80b9a281351a375 = attempt at making a catalog; tests broken. Can't shave yaks at this point. If anyone can help, would be great. Can also revert.

Tom suggests D.evolution(x) instead of D.evolution()(x). Would that be better? I'm worried about situations when the evolution is a callable provided to the system (possibly mutable?) rather than a function, and about methods vs. variables. Again, any suggestions?

create_tuple: What was the final agreement about this? Should True be the default?


---

Comment by git created at 2019-07-11 12:55:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 12:57:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-11 13:00:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 13:07:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 13:13:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-11 13:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 13:43:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 13:46:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-11 13:48:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-11 13:56:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @darijgr created at 2019-07-11 14:03:50

OK, the catalog is done and works! Unlike the crystals catalog, its contents are functions, not classes, but that's ok, right?


---

Comment by tscrim created at 2019-07-11 14:06:42

Replying to [comment:63 gh-darijgr]:
> OK, the catalog is done and works! Unlike the crystals catalog, its contents are functions, not classes, but that's ok, right?

Either (including a mix of the two) are fine (see, e.g., the Lie algebras in `algebras/lie_algebras/examples.py`).


---

Comment by git created at 2019-07-11 14:06:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2019-07-11 14:23:45

Only remaining questions:

- Should the evolution map be self.evolution() or self.evolution? Former looks more "right" to me, but I'm not sure why. Latter is easier to type.

- create_tuple=True as default? If so, when? Is there an "is_mutable" test that (quickly) returns True on lists and other mutable things but False on enumerated sets and such?


---

Comment by @darijgr created at 2019-07-11 14:23:45

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-07-11 16:09:43

A few little things:

(Optional) `cyclic_sieving_phenomenon.py` -> `:mod:`sage.combinat.cyclic_sieving_phenomenon`` and similar such things to make the doc better linked.

For inputs:

```
- ``foo`` -- the type (default: bar); the detailed info
```


The `__init__` is missing doctests (a `TestSuite(foo).run()` is good here). (A few places.)

Extra space after the `x`:

```
sage: F = DiscreteDynamicalSystem(W, lambda x : x[1:] + Word([x[0]]), is_finite=True, inverse=True)
```

(Similar in a few a places.)


```diff
-        return "An invertible discrete dynamical system with ground set " \
-               + repr(self._X)
+        return "An invertible discrete dynamical system with ground set " repr(self._X)
```



```diff
-        for i in self._X:
-            if f(phi(i)) != f(i):
-                return False
-        return True
+        return all(f(phi(i)) == f(i) for i in self._X)
```


For lists split over multiple lines, it looks better with a space before it; e.g.,

```
+        [2, 7, 7, 7, 7, 7, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14,
+         14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
```



```diff
-nu = list(reversed(sorted(mu + [len(lam)])))
+nu = sorted(mu + [len(lam)], reverse=True)
```



---

Comment by git created at 2019-07-11 18:55:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-11 19:05:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2019-07-19 21:21:36

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-07-19 21:21:36

Changing keywords from "IMA coding sprint, homomesy, cyclic sieving, permutations, sage-combinat" to "IMA coding sprint, homomesy, cyclic sieving, permutations, fpsac2019".


---

Comment by tscrim created at 2019-07-19 21:21:36

LGTM. Thank you.


---

Comment by @darijgr created at 2019-07-19 21:23:04

Thank you for the review!


---

Comment by vbraun created at 2019-07-20 09:11:02

Resolution: fixed
