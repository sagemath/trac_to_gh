# Issue 31330: tox.ini: Add local-macos-nohomebrew environments

archive/issues_031330.json:
```json
{
    "body": "CC:  jhpalmieri @zlscherr\n\nThis will do a \"best effort\" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31567\n\n",
    "created_at": "2021-03-26T21:36:43Z",
    "labels": [
        "porting",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "tox.ini: Add local-macos-nohomebrew environments",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31330",
    "user": "mkoeppe"
}
```
CC:  jhpalmieri @zlscherr

This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.

Issue created by migration from https://trac.sagemath.org/ticket/31567





---

archive/issue_comments_448078.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-27T00:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448078",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-27T02:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448079",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-27T02:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448080",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448081.json:
```json
{
    "body": "This is best tested together with #31552, #31562, which do some of the necessary isolation work.\n\nMore isolation work is needed at least for `pillow` and `freetype` - as observed in #31396#comment:32",
    "created_at": "2021-03-27T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448081",
    "user": "mkoeppe"
}
```

This is best tested together with #31552, #31562, which do some of the necessary isolation work.

More isolation work is needed at least for `pillow` and `freetype` - as observed in #31396#comment:32



---

archive/issue_comments_448082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-27T03:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448082",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448083.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-27T03:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448083",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448084.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T00:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448084",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448085.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-28T00:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448085",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448086.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-03-28T01:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448086",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_448087.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-03-28T01:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448087",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_448088.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T05:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448088",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448089.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-28T06:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448089",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_448090.json:
```json
{
    "body": "Now pillow does not find zlib",
    "created_at": "2021-03-28T06:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448090",
    "user": "mkoeppe"
}
```

Now pillow does not find zlib



---

archive/issue_comments_448091.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T06:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448091",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448092.json:
```json
{
    "body": "pillow still finds various libraries in `/usr/local` because of very creative discovery code that finds everything in `/usr/local` because we told it that it can have `/usr/local/opt/xz/include` - see `_add_directory` (https://github.com/python-pillow/Pillow/blob/8.1.x/setup.py#L197)",
    "created_at": "2021-03-29T01:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448092",
    "user": "mkoeppe"
}
```

pillow still finds various libraries in `/usr/local` because of very creative discovery code that finds everything in `/usr/local` because we told it that it can have `/usr/local/opt/xz/include` - see `_add_directory` (https://github.com/python-pillow/Pillow/blob/8.1.x/setup.py#L197)



---

archive/issue_comments_448093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-29T01:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448093",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448094.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-29T02:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448094",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_448095.json:
```json
{
    "body": "Fixed pillow. Now I can build a wheel in #31396 that does not have any dependencies on shared libraries in `/usr/local`.",
    "created_at": "2021-03-29T02:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448095",
    "user": "mkoeppe"
}
```

Fixed pillow. Now I can build a wheel in #31396 that does not have any dependencies on shared libraries in `/usr/local`.



---

archive/issue_comments_448096.json:
```json
{
    "body": "For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)\n\n- cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`\n- pillow says `Appending path /usr/local/Cellar/xz/5.2.5/include` and then the `gcc` flag `-I/usr/local/Cellar/xz/5.2.5/include`.",
    "created_at": "2021-03-30T22:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448096",
    "user": "jhpalmieri"
}
```

For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)

- cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`
- pillow says `Appending path /usr/local/Cellar/xz/5.2.5/include` and then the `gcc` flag `-I/usr/local/Cellar/xz/5.2.5/include`.



---

archive/issue_comments_448097.json:
```json
{
    "body": "The xz include is on purpose -- see comment added in `tox.ini`",
    "created_at": "2021-03-30T22:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448097",
    "user": "mkoeppe"
}
```

The xz include is on purpose -- see comment added in `tox.ini`



---

archive/issue_comments_448098.json:
```json
{
    "body": "Replying to [comment:25 jhpalmieri]:\n> For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)\n\nYes, this a good setting for testing this ticket. The build using tox is designed to be isolated from the effects of `.homebrew-build-env`. \n\n> - cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`\n\nThis is probably https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55 in combination with a bug in our build system - #31584.",
    "created_at": "2021-03-30T22:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448098",
    "user": "mkoeppe"
}
```

Replying to [comment:25 jhpalmieri]:
> For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)

Yes, this a good setting for testing this ticket. The build using tox is designed to be isolated from the effects of `.homebrew-build-env`. 

> - cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`

This is probably https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55 in combination with a bug in our build system - #31584.



---

archive/issue_comments_448099.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-30T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448099",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448100.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-31T02:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448100",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448101.json:
```json
{
    "body": "Okay, this looks good to me.",
    "created_at": "2021-03-31T02:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448101",
    "user": "jhpalmieri"
}
```

Okay, this looks good to me.



---

archive/issue_comments_448102.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-03-31T02:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448102",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_448103.json:
```json
{
    "body": "By the way, should commands like `make distclean` also clean the `.tox` directory?",
    "created_at": "2021-03-31T02:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448103",
    "user": "jhpalmieri"
}
```

By the way, should commands like `make distclean` also clean the `.tox` directory?



---

archive/issue_comments_448104.json:
```json
{
    "body": "I think it should not because `.tox` is not a \"build artifact\" - if this reasoning makes sense.",
    "created_at": "2021-03-31T02:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448104",
    "user": "mkoeppe"
}
```

I think it should not because `.tox` is not a "build artifact" - if this reasoning makes sense.



---

archive/issue_comments_448105.json:
```json
{
    "body": "That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?",
    "created_at": "2021-03-31T16:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448105",
    "user": "jhpalmieri"
}
```

That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?



---

archive/issue_comments_448106.json:
```json
{
    "body": "Replying to [comment:34 jhpalmieri]:\n> That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?\n\nThat works, but you can also pass the `-r` option to `tox`, which will start from scratch.",
    "created_at": "2021-03-31T16:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448106",
    "user": "mkoeppe"
}
```

Replying to [comment:34 jhpalmieri]:
> That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?

That works, but you can also pass the `-r` option to `tox`, which will start from scratch.



---

archive/issue_comments_448107.json:
```json
{
    "body": "Great, thanks!",
    "created_at": "2021-03-31T17:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448107",
    "user": "jhpalmieri"
}
```

Great, thanks!



---

archive/issue_comments_448108.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31330#issuecomment-448108",
    "user": "vbraun"
}
```

Resolution: fixed
