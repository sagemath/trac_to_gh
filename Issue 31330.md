# Issue 31330: tox.ini: Add local-macos-nohomebrew environments

Issue created by migration from https://trac.sagemath.org/ticket/31567

Original creator: mkoeppe

Original creation time: 2021-03-26 21:36:43

CC:  jhpalmieri @zlscherr

This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.


---

Comment by git created at 2021-03-27 00:16:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-27 02:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-27 02:21:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-03-27 02:49:50

This is best tested together with #31552, #31562, which do some of the necessary isolation work.

More isolation work is needed at least for `pillow` and `freetype` - as observed in #31396#comment:32


---

Comment by git created at 2021-03-27 03:01:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-27 03:09:36

Changing status from new to needs_review.


---

Comment by git created at 2021-03-28 00:54:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-28 00:55:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-28 01:54:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-03-28 01:58:34

Changing priority from major to critical.


---

Comment by git created at 2021-03-28 05:50:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-28 06:02:50

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-03-28 06:02:50

Now pillow does not find zlib


---

Comment by git created at 2021-03-28 06:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-29 01:26:21

pillow still finds various libraries in `/usr/local` because of very creative discovery code that finds everything in `/usr/local` because we told it that it can have `/usr/local/opt/xz/include` - see `_add_directory` (https://github.com/python-pillow/Pillow/blob/8.1.x/setup.py#L197)


---

Comment by git created at 2021-03-29 01:59:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-29 02:08:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-03-29 02:08:31

Fixed pillow. Now I can build a wheel in #31396 that does not have any dependencies on shared libraries in `/usr/local`.


---

Comment by jhpalmieri created at 2021-03-30 22:02:25

For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)

- cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`
- pillow says `Appending path /usr/local/Cellar/xz/5.2.5/include` and then the `gcc` flag `-I/usr/local/Cellar/xz/5.2.5/include`.


---

Comment by mkoeppe created at 2021-03-30 22:12:43

The xz include is on purpose -- see comment added in `tox.ini`


---

Comment by mkoeppe created at 2021-03-30 22:39:10

Replying to [comment:25 jhpalmieri]:
> For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)

Yes, this a good setting for testing this ticket. The build using tox is designed to be isolated from the effects of `.homebrew-build-env`. 

> - cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`

This is probably https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55 in combination with a bug in our build system - #31584.


---

Comment by git created at 2021-03-30 22:56:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-03-31 02:04:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-03-31 02:04:23

Okay, this looks good to me.


---

Comment by mkoeppe created at 2021-03-31 02:11:32

Thanks!


---

Comment by jhpalmieri created at 2021-03-31 02:35:50

By the way, should commands like `make distclean` also clean the `.tox` directory?


---

Comment by mkoeppe created at 2021-03-31 02:59:16

I think it should not because `.tox` is not a "build artifact" - if this reasoning makes sense.


---

Comment by jhpalmieri created at 2021-03-31 16:49:25

That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?


---

Comment by mkoeppe created at 2021-03-31 16:52:46

Replying to [comment:34 jhpalmieri]:
> That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?

That works, but you can also pass the `-r` option to `tox`, which will start from scratch.


---

Comment by jhpalmieri created at 2021-03-31 17:21:28

Great, thanks!


---

Comment by vbraun created at 2021-05-27 20:28:46

Resolution: fixed
