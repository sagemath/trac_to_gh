# Issue 12151: make docbuild cache corruption error message usable

Issue created by migration from Trac.

Original creator: was

Original creation time: 2012-01-18 19:58:15

Assignee: mvngu

I ran into this, perhaps due to hitting control-c at the wrong moment:

```
deep:d wstein$ sage -docbuild en/reference html
Traceback (most recent call last):
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 1060, in <module>
    getattr(get_builder(name), type)()
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 332, in _wrapper
    inherit_prev = self.get_cache().get('option_inherited')
  File "cachefunc.pyx", line 1397, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (sage/misc/cachefunc.c:7026)
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 383, in get_cache
    cache = cPickle.load(file)
EOFError
```


It took a fair bit of cleverness to figure out what file I had to delete in order to get back to work.  Instead, we should use `try: except` and if the load fails, print the file name and suggest that the user delete it and try again.   This will be easy to implement and save people time and frustration.  Since building documentation takes a long time, it is probably not that uncommon for people to control-c out of it, perhaps at the "wrong" moment.  

We could also harden writing the cache file, so that it is more difficult to corrupt.  But at a bare minimum, making a better error message has to be done.


---

Comment by was created at 2012-01-18 20:20:45

Changing status from new to needs_review.


---

Attachment


---

Comment by jhpalmieri created at 2012-01-19 02:36:32

This seems like a good idea, but why not just delete the cache file?  See the attached patch.


---

Attachment

I think your solution is better. Positive review.


---

Comment by was created at 2012-01-19 02:49:37

Changing status from needs_review to positive_review.


---

Comment by was created at 2012-01-19 02:50:16

APPLY ONLY:  trac_12323-delete-broken-cache.patch


---

Comment by jdemeyer created at 2012-01-19 16:20:09

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-01-19 16:20:09

I know I'm being pedantic, but shouldn't

```
file.close() 
logger.debug("Loaded .rst file cache: %s", filename) 
return cache 
```

be outside the try/except?


---

Comment by jhpalmieri created at 2012-01-19 16:24:40

What difference does it make?


---

Attachment

apply only this


---

Comment by jdemeyer created at 2012-01-19 16:34:16

In practice little difference, but it's considered good style to "try" as few as possible.  You really care about the

```
cache = cPickle.load(file)
```

line raising exception, not the other three lines.


---

Comment by was created at 2012-01-19 16:38:47

I agree with jdemeyer, since it could mask errors.  I've attached another version of the patch.


---

Comment by was created at 2012-01-19 16:38:47

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-01-19 17:17:02

You forgot to delete the cache file.  Was that intentional?  It seems to work this way -- I think Sphinx just overwrites the file if this function returns `{}` -- but perhaps the message should say "Cache file '%s' is corrupted; ignoring it..." instead of "deleting it...".


---

Comment by was created at 2012-01-19 17:39:49

That wasn't intentional, but it makes sense to do that.  Yes, the error message has to be changed. I'm uploading a new patch.


---

Attachment


---

Comment by jhpalmieri created at 2012-01-19 18:02:05

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-01-19 18:02:05

Okay, looks good to me.


---

Comment by jdemeyer created at 2012-01-19 18:52:41

Nice illustration of try/except/else/finally :-)


---

Comment by jdemeyer created at 2012-01-21 23:38:55

Resolution: fixed
