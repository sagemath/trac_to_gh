# Issue 22718: Put MatrixSpace in the category of ModulesWithBasis

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2017-05-06 18:04:44

CC:  nthiery chapoton kcrisman darij

`MatrixSpace` has a basis, so we should put it into the category of `ModulesWithBasis`. We also use `dict` as `monomial_coefficients` with the extra keyword `copy` (default `True`) and change the `basis` to return a `Family`.

**note** the change to `basis` is backwards incompatible.


---

Comment by tscrim created at 2017-05-06 18:05:49

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-05-06 18:05:49

New commits:


---

Comment by git created at 2017-05-06 18:21:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-05-06 18:23:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-05-06 18:28:02

Changing component from categories to linear algebra.


---

Comment by nthiery created at 2017-05-07 21:39:40

Altogether it looks good. And it's very nice to have `MatrixSpaces` get finally closer from proper ModulesWithBasis`. Thanks Travis!

I still need to double check on the changes in `Family`. Maybe they are unavoidable with the current `FiniteFamily` API which makes it a pinch cumbursome to create a family from a set of indices and a function. For consistency it could be good to create the basis through `Family` and have the latter use `keys` to specify the indices as is already done when it creates a `FiniteFamily`. More later.

One additional question: rather than loading more categories upon startup, would we have a chance to avoid creating a matrix space upon Sage startup? That's what we would want in the long run.


---

Comment by nthiery created at 2017-05-08 01:48:37

Plausibly unrelated, but just in case, see #12099.


---

Comment by tscrim created at 2017-05-08 06:18:52

Replying to [comment:6 nthiery]:
> Altogether it looks good. And it's very nice to have `MatrixSpaces` get finally closer from proper ModulesWithBasis`. Thanks Travis!

This has been something I have wanted for a long time too with some use cases.

> I still need to double check on the changes in `Family`. Maybe they are unavoidable with the current `FiniteFamily` API which makes it a pinch cumbursome to create a family from a set of indices and a function. For consistency it could be good to create the basis through `Family` and have the latter use `keys` to specify the indices as is already done when it creates a `FiniteFamily`. More later.

Really the only reason I make these changes is so the print order is fixed. I feel this is a natural change. I don't think I am quite following what you are saying about the API.

> One additional question: rather than loading more categories upon startup, would we have a chance to avoid creating a matrix space upon Sage startup? That's what we would want in the long run.

I agree. Maybe I shouldn't be so lazy here... <.< >.>


---

Comment by nthiery created at 2017-05-08 13:52:28

Replying to [comment:8 tscrim]:
> Really the only reason I make these changes is so the print order is fixed.
> I feel this is a natural change.

Agreed.

> I don't think I am quite following what you are saying about the API.

I'll give it a shot in terms of code now.


---

Comment by tscrim created at 2017-05-08 13:53:40

Replying to [comment:9 nthiery]:
> Replying to [comment:8 tscrim]:
> > I don't think I am quite following what you are saying about the API.
> 
> I'll give it a shot in terms of code now.

Great, thanks.


---

Comment by git created at 2017-05-08 14:33:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-05-08 14:50:29

Ok, after reading in detail the Family changes, that's actually how I would have done it myself; all good! I added a test. It would have been best done in a separate ticket, but let's move on.

About the changes in `*tour_linalg`, we have a slight problem: the change in the example would require to update the comment just above which says that `basis` returns a list. No big deal in itself, but we need to change that in a bunch of languages; I could take care of the german, french, and english versions; maybe you can handle one or two more. We need people for the others. Dima for russian?

About the change in the `french_book` directory: changes there require a discussion with the book authors, to make sure the book is kept in sync. I discussed with myself, so that's done :-)


---

Comment by tscrim created at 2017-05-08 15:35:31

Replying to [comment:12 nthiery]:
> About the changes in `*tour_linalg`, we have a slight problem: the change in the example would require to update the comment just above which says that `basis` returns a list. No big deal in itself, but we need to change that in a bunch of languages; I could take care of the german, french, and english versions; maybe you can handle one or two more. We need people for the others. Dima for russian?

I can do the Spanish and Japanese and probably the Portugese. We could also ask Darij for the Russian too.

> About the change in the `french_book` directory: changes there require a discussion with the book authors, to make sure the book is kept in sync. I discussed with myself, so that's done :-)

`<sup>_</sup>`


---

Comment by tscrim created at 2017-05-08 15:38:01

Is the only change you plan to do `list` -> `family`?


---

Comment by nthiery created at 2017-05-08 15:49:32

Let me do the French and English now, to see how it feels under the fingers ...


---

Comment by git created at 2017-05-08 16:03:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-05-08 16:07:07

I ended up doing a first draft for all languages but Japanese. Some translations are plain google ... I double checked they seemed reasonable, and I imagine that, for very constrainted technical sentences like this, google should do a fair job. But please proofread!


---

Comment by nthiery created at 2017-05-08 16:08:01

Replying to [comment:8 tscrim]:
> I agree. Maybe I shouldn't be so lazy here... <.< >.>

:-)

Please go ahead and explore. If it's not too hard, let's do it in this ticket. If not, oh well.


---

Comment by git created at 2017-05-08 17:01:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-08 17:05:28

So the current issue is in the `modular/arithgroup` imports at startup as they create a number of matrices at the module level. So I could go through and lazily import all of that, but I am not sure I want to go through that on this ticket.

The Spanish and English translations look good. I'm doing the Japanese now.


---

Comment by git created at 2017-05-08 17:14:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-08 17:16:42

Okay, this should be the correct Japanese version.


---

Comment by nthiery created at 2017-05-08 18:58:56

Replying to [comment:20 tscrim]:
> So the current issue is in the `modular/arithgroup` imports at startup as they create a number of matrices at the module level. So I could go through and lazily import all of that, but I am not sure I want to go through that on this ticket.

All right. We want to do this at some point, but that's going beyond the scope of this ticket. 
Could you just add, near the relevant atStartup=True, a reference to this ticket?
Thanks for investigating!


---

Comment by nthiery created at 2017-05-08 19:01:15

Do you have any chance to have someone cross check the russian / japanese? Otherwise, up to the above comment, and assuming all tests pass, I believe this is good to go.


---

Comment by git created at 2017-05-08 21:19:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-08 21:20:29

I've added the comment. I don't have anyone offhand who I could ask about the Japanese. Darij, could you take a very quick look at the Russian?


---

Comment by darij created at 2017-05-08 21:21:49

The change to rc/doc/ru/tutorial/tour_linalg.rst is perfectly fine.


---

Comment by tscrim created at 2017-05-08 21:23:50

Thank you for checking Darij!


---

Comment by git created at 2017-05-19 20:46:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-19 20:48:54

If you wait until July, then I can get someone to look at the Japanese when I am in Japan. Although I am fairly confident about the translation, and we can always make additional changes later.

However, we currently have 1 failing doctest in `categories/covariant_functorial_construction.py` that I do not know if we need to simply change the output or change the test.

```
sage -t src/sage/categories/covariant_functorial_construction.py
**********************************************************************
File "src/sage/categories/covariant_functorial_construction.py", line 262, in sage.categories.covariant_functorial_construction.FunctorialConstructionCategory._base_category_class
Failed example:
    F._foo
Expected:
    Traceback (most recent call last):
    ...
    ValueError: could not infer axiom for the nested class
    <...AlgebrasWithBasis'> of <...GradedAlgebrasWithBasis'>
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.covariant_functorial_construction.FunctorialConstructionCategory._base_category_class[4]>", line 1, in <module>
        F._foo
      File "sage/misc/classcall_metaclass.pyx", line 409, in sage.misc.classcall_metaclass.ClasscallMetaclass.__get__ (/home/travis/sage-build/src/build/cythonized/sage/misc/classcall_metaclass.c:1537)
        return cls.classget(cls, instance, owner)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/categories/category_with_axiom.py", line 2059, in __classget__
        cls, cls._base_category_class_and_axiom[0], base_category_class)
    AssertionError: base category class for <class 'sage.categories.algebras_with_basis.AlgebrasWithBasis'> mismatch; expected <class 'sage.categories.algebras.Algebras'>, got <class 'sage.categories.graded_algebras_with_basis.GradedAlgebrasWithBasis'>
**********************************************************************
```



---

Comment by tscrim created at 2017-05-19 20:49:02

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-06-05 08:53:50

Changing status from needs_work to needs_info.


---

Comment by tscrim created at 2017-06-05 08:53:50

That should have been needs_info for comment:30.


---

Comment by git created at 2017-06-14 04:44:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-14 04:46:56

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2017-06-14 04:46:56

After a discussion with Nicolas, we concluded that we can simply change the doctest and we should put a note in about what will happen when `Algebras.WithBasis` is again lazy rather than resolved at startup. At this point, it just needs someone to flip the switch.


---

Comment by git created at 2017-06-18 02:41:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-18 02:43:27

One more change: I made the matrix spaces know they were finite dimensional. This caused some problems with checking to see if certain inputs could be treated as vectors by seeing if they have a `_vector_` attribute. I took the approach that matrices were not to be considered as vectors in those cases.


---

Comment by chapoton created at 2017-06-18 14:25:41

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-06-18 14:25:41

failing doctests, see patchbot report


---

Comment by git created at 2017-06-18 14:42:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-18 14:45:17

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-18 14:45:17

Trivial fixes.


---

Comment by nthiery created at 2017-06-19 19:57:50

Thanks Travis!

The Runtime Type Checking to distinguish vectors from matrices is somewhat smelly but I don't see a better way. And it's very nice to finally have matrix spaces as finite dimensional modules. So let it be.

I am assuming the patchbot will go green after your latest fixes. Therefore positive review!
(could you just double check that the pdf doc compiles?)


---

Comment by nthiery created at 2017-06-19 19:58:03

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-06-20 01:08:30

Replying to [comment:41 nthiery]:
> The Runtime Type Checking to distinguish vectors from matrices is somewhat smelly but I don't see a better way. And it's very nice to finally have matrix spaces as finite dimensional modules. So let it be.

I agree. There might be some better ways by checking dimensions or number of entries. However, it wasn't clear what was the best way forward and this kept the old behavior. We can always change it on a followup.

> I am assuming the patchbot will go green after your latest fixes. Therefore positive review!
> (could you just double check that the pdf doc compiles?)

Patchbot came back (essentially) green, and I didn't notice a problem with the pdf doc.


---

Comment by vbraun created at 2017-06-22 07:24:30

Resolution: fixed
