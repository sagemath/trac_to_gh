# Issue 18924: LatticePoset: faster is_complemented()

Issue created by migration from https://trac.sagemath.org/ticket/19161

Original creator: jmantysalo

Original creation time: 2015-09-08 07:56:36

CC:  mlapointe nadialafreniere

As playing with matrices is much faster than looping over elements, this patch makes `is_complemented()` much faster.

Let `L10` bet the list of all lattices of 10 elements and `B10` be the Boolean lattice with `2^10` elements. Then without the patch it takes 7,76 seconds to run `len([L for L in L10 if L.is_complemented()])` and 101,84 seconds to run `L.is_complemented()`. With the patch the time reduces to 0,38 and 0,23 seconds.


---

Comment by jmantysalo created at 2015-09-08 07:58:21

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2015-09-08 07:58:21

Nathann, want an easy review?
----
New commits:


---

Comment by ncohen created at 2015-09-08 09:59:37

HMmmm... The speedup is cool, but the algorithm is slightly less clear. Is it slower to do it like that:


```
from itertools import izip
for row1,row2 in izip(meet,join):
    for c1,c2 in izip(row1,row2):
        if c1==0 and c2==n-1:
            break
    else:
        retun False
return True
```


Sorry but it is a bit hard for me to try it today: I burned the two main fingers of my right hand while cooking, and I type mostly with my left hand `:-/`

Nathann


---

Comment by jmantysalo created at 2015-09-08 10:47:34

Replying to [comment:4 ncohen]:

>Is it slower to do it like that:

It depends. For `B10`-example your algorithm is clearly faster, it takes about half of the time of matrix-based algorithm. And for the `L10`-example it is twise slower. I guess that your is better, but I will check that with some more tests.
 
> Sorry but it is a bit hard for me to try it today: I burned the two main fingers of my right hand while cooking, and I type mostly with my left hand `:-/`

Use professionals. Eat at MacDonalds.


---

Comment by ncohen created at 2015-09-08 10:49:58

> It depends. For `B10`-example your algorithm is clearly faster, it takes about half of the time of matrix-based algorithm. And for the `L10`-example it is twise slower. I guess that your is better, but I will check that with some more tests.

Hmmmm.. I do not know what to think of it. It "may" answer "no" slightly faster, but then iterators are not free. Sigh. That would be straightforward in C with real arrays, and not those unreliable matrices `-_-`

> Use professionals. Eat at MacDonalds.

Ahah.

Nathann


---

Comment by jmantysalo created at 2015-09-08 10:58:49

That was fast to test. Matrix-based loses by factor of 6 when going through posets of size 11.

(About food: When you want a car, do you go to mine to get some iron ore? Why should it be different with food? `:=)` (But my wife has different opinion on that...))


---

Comment by ncohen created at 2015-09-08 11:03:00

> That was fast to test. Matrix-based loses by factor of 6 when going through posets of size 11.

Both are matrix based, so I do not know what you have in mind. Keep the one that is the fastest, and if it is the current one then consider it in `positive_review`, provided that tests pass (the patchbot still silent).

> (About food: When you want a car, do you go to mine to get some iron ore? Why should it be different with food? `:=)` (But my wife has different opinion on that...))

She has a different opinion about mining? Amazing.

In the case at hand (if I may say), I do not see the need to generalize to cooking in general. Let me just hope that I will not make the same mistake, with the same hand, tomorrow morning.

Nathann


---

Comment by git created at 2015-09-08 11:10:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-09-08 11:19:41

Replying to [comment:8 ncohen]:

> > That was fast to test. Matrix-based loses by factor of 6 when going through posets of size 11.
> 
> Both are matrix based, so I do not know what you have in mind.

I meant that mine was "matrix-based", i.e. the speed come from speed of matrix operations.

> Keep the one that is the fastest

Your implementation is faster.

Mélodie, can you review this? The code is now mostly from Nathann, but if it does not work, it might also be that I have made a mistake.

> She has a different opinion about mining? Amazing.

`;=)`


---

Comment by ncohen created at 2015-09-08 11:30:17

HMmmmm... Factor 6?... `O_o`

Weird, weird... `:-/`


---

Comment by jmantysalo created at 2015-09-08 12:34:37

Replying to [comment:11 ncohen]:
> HMmmmm... Factor 6?... `O_o`
> 
> Weird, weird... `:-/`

Not really. Original code checks ALL element pairs. My code takes one element, and kind of check it against all other elements, and stops when an element has no complement. Your code jumps to next element when it founds a complement and return `False` if it found an element without the complement.

Even your code is not optimal, because meet and join are commutative operations. But it may be slower to optimize that, because the code would be more complicated.

In any case, this is now quite fast and IMO ready for review.


---

Comment by nadialafreniere created at 2015-09-08 17:47:48

Hi Jori,
I'm Mélodie's colleague and I reviewed the graph documentation ticket with her.

About your new ticket, now.


```diff
+        n = self.cardinality()-1
+        for row1,row2 in izip(mt, jn):
+            for c1,c2 in izip(row1,row2):
+                if c1==0 and c2==n:
```


You should respect the Python / Sage conventions and add spaces before and after binary operators of the lowest priority : `self.cardinality() - 1`, `c1  == 0`, etc. This includes equality and assignments.

As well, there should be spaces after every coma sign:  `row1, row2`, `c1, c2`, `izip(row1, row2)`. For more info on these conventions, see http://doc.sagemath.org/html/en/developer/coding_basics.html#python-code-style


---

Comment by nadialafreniere created at 2015-09-08 17:47:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-09-08 18:32:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-09-08 18:39:16

Replying to [comment:13 nadialafreniere]:

> I'm Mélodie's colleague and I reviewed the graph documentation ticket with her.

Thanks! I did the changes.


---

Comment by jmantysalo created at 2015-09-08 18:39:16

Changing status from needs_work to needs_review.


---

Comment by nadialafreniere created at 2015-09-08 21:36:47

Most of the things look fine. One last thing: I know you didn't touch to this, but the examples should also respect the python conventions. Therefore, I'm hoping to see a space after each of the commas.


```
sage: L = LatticePoset({0:[1,2,3],1:[4],2:[4],3:[4]})
```


```
sage: L = LatticePoset({0:[1,2],1:[3],2:[3],3:[4]})
```


should look like

```
sage: L = LatticePoset({0:[1, 2, 3], 1:[4], 2:[4], 3:[4]})
```



---

Comment by nadialafreniere created at 2015-09-08 21:37:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-09-09 04:02:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-09-09 04:04:21

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2015-09-09 04:04:21

Replying to [comment:16 nadialafreniere]:

> - - but the examples should also respect the python conventions. Therefore, I'm hoping to see a space after each of the commas.

Done this.


---

Comment by nadialafreniere created at 2015-09-09 05:24:27

Changing status from needs_review to positive_review.


---

Comment by nadialafreniere created at 2015-09-09 05:25:38

Replying to [comment:19 jmantysalo]:
> Replying to [comment:16 nadialafreniere]:
> 
> > - - but the examples should also respect the python conventions. Therefore, I'm hoping to see a space after each of the commas.
> 
> Done this.



Everything looks fine!


---

Comment by vbraun created at 2015-09-09 22:14:56

Resolution: fixed
