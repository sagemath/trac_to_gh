# Issue 14465: autogenerate the list of subdirectories of doc/en/reference

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2013-05-30 18:44:22

Assignee: mvngu

CC:  vbraun

As the summary says. Currently, the file `doc/en/reference/conf.py` explicitly lists all of the subdirectories which contain components of the reference manual. If anyone adds a new component, they have to edit this file, and if they forget, they can get opaque error messages. So instead, the list should be generated on the fly.



---

Comment by jhpalmieri created at 2013-05-30 18:46:37

Slightly different from the patch at #7477: I've removed 'sage', 'sagenb', 'media', and 'other' from the list of directories -- these might be present if upgrading Sage.


---

Comment by jhpalmieri created at 2013-05-30 18:46:37

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-05-30 19:06:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-05-30 19:06:53

Looks good to me.


---

Comment by leif created at 2013-05-30 20:10:41

Minor thing:  The new list isn't sorted.


---

Comment by leif created at 2013-05-30 20:26:23

Stylewise:  It would be better to create a _set_ of the subdir names and afterwards remove the "bad" ones from that (with `.difference_update()`).


---

Comment by vbraun created at 2013-05-30 20:32:06

To the best of my knowledge neither the order of the entry nor the performance of this step of the doc build matter.


---

Comment by leif created at 2013-05-30 20:55:54

Replying to [comment:5 vbraun]:
> To the best of my knowledge neither the order of the entry nor the performance of this step of the doc build matter.

To you...

If the folders are sorted (or more precisely, get processed in alphabetical order), you at least get an idea of the progress.

W.r.t. performance:  It certainly doesn't matter _here_ (at least currently ;-) ), that's why I wrote _stylewise_.  People<sup>*</sup> tend to get used to such, adding overhead here and there, and at some point it _does_ matter.

(<sup>*</sup> which includes people _reading_ such code, not necessarily their author(s))


---

Comment by jhpalmieri created at 2013-05-30 21:10:19

I don't mind sorting the list, but note that once you pass the list off to parallel processing, you tend to lose control of the ordering. For example, I usually see `polynomial_rings` build first. As far as style goes, there is frequently a trade-off between readability and performance. In this case, I think that just using lists is more readable, and since performance is not an issue, we should leave it as is.


---

Comment by jhpalmieri created at 2013-05-30 21:11:19

Difference between the old and new patch:

```diff
diff --git a/doc/en/reference/conf.py b/doc/en/reference/conf.py
--- a/doc/en/reference/conf.py
+++ b/doc/en/reference/conf.py
`@``@` -64,13 +64,13 `@``@`
 
 multidocs_is_master = True
 
-# List of subdocs. Include all subdirectories of ref_src except for
-# 'static' and 'templates', and to deal with upgrades: 'sage',
+# Sorted list of subdocs. Include all subdirectories of ref_src except
+# for 'static' and 'templates', and to deal with upgrades: 'sage',
 # 'sagenb', 'media', and 'other'.
 bad_directories = ['static', 'templates', 'sage', 'sagenb', 'media', 'other']
-multidocs_subdoc_list = [x for x in os.listdir(ref_src) if
-                         os.path.isdir(os.path.join(ref_src, x))
-                         and x not in bad_directories]
+multidocs_subdoc_list = [x for x in os.listdir(ref_src)
+                         if os.path.isdir(os.path.join(ref_src, x))
+                         and x not in bad_directories].sort()
 
 # List of directories, relative to source directory, that shouldn't be
 # searched for source files.
```

EDIT: the patch uses `sorted([...])` rather than `[...].sort()`, of course.


---

Comment by leif created at 2013-05-30 21:24:38

ahknst, KO.


---

Attachment


---

Comment by vbraun created at 2013-05-30 22:34:00

The docbuilder will sort the bags of work by decreasing number of subdirectories (approx. computational effort), so its pointless to sort here.


---

Comment by jhpalmieri created at 2013-05-30 23:09:56

I think that the value of `multidocs_subdoc_list` is part of the pickle stored for the documentation. So in the unlikely event that repeated execution of `os.listdir(...)` produces lists in different orders, we should sort it to make sure the pickle is consistent from one run to the next.


---

Comment by leif created at 2013-05-31 00:21:11

Replying to [comment:10 vbraun]:
> The docbuilder will sort the bags of work by decreasing number of subdirectories (approx. computational effort), 

... which again will maximize the (expected) peak memory usage.


---

Comment by rbeezer created at 2013-05-31 01:41:52

Step out for a few hours and you miss a lot.  ;-)

I just used this to build the reference manual on 5.10.beta5 by nuking `doc/output` and doing


```
sage -docbuild reference inventory
sage -docbuild reference html
```


and it seemed to work just fine.  At least the matroid documentation rendered fine.  So I'm all for a positive review based on my testing.  I'll stay out of the sorted discussion.

Rob


---

Comment by vbraun created at 2013-05-31 09:29:03

Replying to [comment:12 leif]:
> ... which again will maximize the (expected) peak memory usage.

Exactly! You finally got the point of parallelism ;-) We are trying to use all resources of the computer at once. If you don't have enough memory or your IO is slow then you don't benefit from multiple processors.


---

Comment by jdemeyer created at 2013-06-06 12:34:23

Resolution: fixed
