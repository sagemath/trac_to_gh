# Issue 31694: _sympy_ methods for some parent classes

Issue created by migration from https://trac.sagemath.org/ticket/31931

Original creator: mkoeppe

Original creation time: 2021-06-08 01:54:20

CC:  tscrim kcrisman certik vdelecroix

We add `_sympy_` methods to various parent classes, returning sympy `Integers`, `Reals`, `Complexes`, `ProductSet`.

Part of #31926 Meta-ticket: Connect Sage sets to sympy sets


---

Comment by mkoeppe created at 2021-06-09 00:11:14

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-09 00:11:14

New commits:


---

Comment by kcrisman created at 2021-06-09 00:43:23

Nice - if patchbot says yes this this seems to be good.  

Question: Do these reimport into Sage as one might expect (does the diagram commute in either direction)?  If so, some tests for that might be appropriate.  Also, with the products, what happens if one of the parts doesn't have a Sympy version - presumably there is an error message, but is it a useful one?


---

Comment by mkoeppe created at 2021-06-09 01:29:40

Replying to [comment:3 kcrisman]:
> Do these reimport into Sage as one might expect (does the diagram commute in either direction)?

No, the other direction of conversion is not implemented yet, this would be part of #31935. The closest we have is `sage.interfaces.sympy.sympy_set_to_list`, which converts from various sympy set types to lists of Sage SR relation expressions.


---

Comment by mkoeppe created at 2021-06-09 01:35:33

Replying to [comment:3 kcrisman]:
> with the products, what happens if one of the parts doesn't have a Sympy version - presumably there is an error message, but is it a useful one?

It fails with an unpleasant error message because SymPy tries too hard to make sense of it. Example:

```
sage: F = FiniteEnumeratedSets().example()
sage: cartesian_product([F, F])._sympy_()
SymPyDeprecationWarning: 

String fallback in sympify has been deprecated since SymPy 1.6. Use
sympify(str(obj)) or sympy.core.sympify.converter or obj._sympy_
instead. See https://github.com/sympy/sympy/issues/18066 for more
info.

  SymPyDeprecationWarning(.....)

SyntaxError: invalid syntax (<string>, line 1)

During handling of the above exception, another exception occurred:

SympifyError: Sympify of expression 'could not parse 'An example of a finite enumerated set: {1,2,3}'' failed, because of exception being raised:
SyntaxError: invalid syntax (<string>, line 1)
```


#31938 will provide all Sage sets with a `_sympy_` method.


---

Comment by kcrisman created at 2021-06-09 11:35:38

Replying to [comment:5 mkoeppe]:
> Replying to [comment:3 kcrisman]:
> > with the products, what happens if one of the parts doesn't have a Sympy version - presumably there is an error message, but is it a useful one?
> 
> It fails with an unpleasant error message because SymPy tries too hard to make sense of it. Example:

I agree this isn't as helpful to the end user.  What I'd formally recommend as a review, until #31938 is merged, is to document this type of error as a doctest so it is at least searchable if someone comes across it.


---

Comment by mkoeppe created at 2021-06-09 20:58:47

Now, after merging #31938, this example works:

```
sage: F = FiniteEnumeratedSets().example()
sage: cartesian_product([F, F])._sympy_()
ProductSet(SageSet(An example of a finite enumerated set: {1,2,3}), SageSet(An example of a finite enumerated set: {1,2,3}))
```



---

Comment by git created at 2021-06-10 00:11:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-10 00:19:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2021-06-10 00:54:31

> Now, after merging #31938, this example works:
Nice.  I am not reviewing that one, but anyway that was my only comment on this one.


---

Comment by tscrim created at 2021-06-10 02:03:17

`@`kcrisman Will you be reviewing this ticket? I have basically reviewed #31938; just waiting on patchbot approval.


---

Comment by kcrisman created at 2021-06-10 03:25:45

> `@`kcrisman Will you be reviewing this ticket? I have basically reviewed #31938; just waiting on patchbot approval.
I'm happy with this one given your review of that one, as long as patchbot is.  I am unable to manually test however, so your additional green light would be great.


---

Comment by tscrim created at 2021-06-10 23:03:37

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2021-06-10 23:03:37


```
sage -t --long --random-seed=0 src/sage/sets/real_set.py  # 7 doctests failed
```

because there is no `ambient()` method called via the `is_universe()` method.


---

Comment by git created at 2021-06-11 00:28:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-11 00:29:20

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-11 00:29:20

Right, that method comes from #31877, which I have now merged


---

Comment by tscrim created at 2021-06-11 00:35:58

Now to wait for the patchbot one more time.


---

Comment by slelievre created at 2021-06-11 08:02:08

Patchbots seem stuck on #31928,
see ticket:31928#comment:1.


---

Comment by tscrim created at 2021-06-12 08:38:29

Setting to positive as per comment:13.


---

Comment by tscrim created at 2021-06-12 08:38:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-12 13:46:38

Thanks!


---

Comment by vbraun created at 2021-06-29 23:08:27

Resolution: fixed
