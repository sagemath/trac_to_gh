# Issue 24407: Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-02-02 12:02:13

Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.


---

Comment by embray created at 2018-02-02 12:02:22

Changing status from new to needs_review.


---

Comment by git created at 2018-02-02 12:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-02 12:20:21

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-02-02 12:23:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-02-02 12:24:15

(I was doing some JavaScript earlier and got some wires crossed)


---

Comment by embray created at 2018-02-02 12:24:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-03 09:14:36

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-02-03 09:14:36

If this is really meant for installations as "root", then the installation in `DESTDIR` should already be done under the "sudo" user. So I think that this patch actually reverses existing correct behaviour.

=> Proposal: close as wontfix.


---

Comment by jdemeyer created at 2018-02-03 09:29:11

No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.


---

Comment by embray created at 2018-02-05 10:33:57

I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a "build" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.

On Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by "root" (but fakeroot allows you to do this without _actually_ having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.

So only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.


---

Comment by embray created at 2018-02-05 12:47:31

Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

But if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.


---

Comment by mkoeppe created at 2018-03-05 23:15:50

Replying to [comment:10 embray]:
> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

This is addressed by #21532.


---

Comment by embray created at 2018-04-05 10:24:07

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-04-10 16:26:24

Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.


---

Comment by saraedum created at 2018-04-10 22:49:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-08 17:26:27

Resolution: fixed
