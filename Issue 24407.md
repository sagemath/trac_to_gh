# Issue 24407: Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL

archive/issues_024407.json:
```json
{
    "body": "Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24644\n\n",
    "created_at": "2018-02-02T12:02:13Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24407",
    "user": "embray"
}
```
Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.

Issue created by migration from https://trac.sagemath.org/ticket/24644





---

archive/issue_comments_341938.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-02T12:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341938",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_341939.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-02T12:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341939",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341940.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-02T12:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341940",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_341941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-02T12:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341941",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_341942.json:
```json
{
    "body": "(I was doing some JavaScript earlier and got some wires crossed)",
    "created_at": "2018-02-02T12:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341942",
    "user": "embray"
}
```

(I was doing some JavaScript earlier and got some wires crossed)



---

archive/issue_comments_341943.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-02T12:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341943",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_341944.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-02-03T09:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341944",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_341945.json:
```json
{
    "body": "If this is really meant for installations as \"root\", then the installation in `DESTDIR` should already be done under the \"sudo\" user. So I think that this patch actually reverses existing correct behaviour.\n\n=> Proposal: close as wontfix.",
    "created_at": "2018-02-03T09:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341945",
    "user": "jdemeyer"
}
```

If this is really meant for installations as "root", then the installation in `DESTDIR` should already be done under the "sudo" user. So I think that this patch actually reverses existing correct behaviour.

=> Proposal: close as wontfix.



---

archive/issue_comments_341946.json:
```json
{
    "body": "No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.",
    "created_at": "2018-02-03T09:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341946",
    "user": "jdemeyer"
}
```

No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.



---

archive/issue_comments_341947.json:
```json
{
    "body": "I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a \"build\" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.\n\nOn Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by \"root\" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.\n\nSo only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.",
    "created_at": "2018-02-05T10:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341947",
    "user": "embray"
}
```

I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a "build" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.

On Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by "root" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.

So only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.



---

archive/issue_comments_341948.json:
```json
{
    "body": "Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nBut if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.",
    "created_at": "2018-02-05T12:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341948",
    "user": "embray"
}
```

Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

But if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.



---

archive/issue_comments_341949.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nThis is addressed by #21532.",
    "created_at": "2018-03-05T23:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341949",
    "user": "mkoeppe"
}
```

Replying to [comment:10 embray]:
> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

This is addressed by #21532.



---

archive/issue_comments_341950.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-04-05T10:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341950",
    "user": "embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_341951.json:
```json
{
    "body": "Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.",
    "created_at": "2018-04-10T16:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341951",
    "user": "embray"
}
```

Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.



---

archive/issue_comments_341952.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-10T22:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341952",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_341953.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-08T17:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24407#issuecomment-341953",
    "user": "vbraun"
}
```

Resolution: fixed
