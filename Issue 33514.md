# Issue 33514: random doctest failure in src/sage/matrix/matrix_integer_dense_hnf.py

Issue created by migration from https://trac.sagemath.org/ticket/33751

Original creator: lorenz

Original creation time: 2022-04-24 08:50:54

Part of #32544:


```sage
sage -t --random-seed=47467259736041671371069989299524409608 src/sage/matrix/matrix_integer_dense_hnf.py
**********************************************************************
File "src/sage/matrix/matrix_integer_dense_hnf.py", line 1240, in sage.matrix.matrix_integer_dense_hnf.?
Failed example:
    matrix_integer_dense_hnf.sanity_checks(times=5, check_using_magma=False)
Exception raised:
    Traceback (most recent call last):
      File "~/sage/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "~/sage/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_integer_dense_hnf.?[1]>", line 1, in <module>
        matrix_integer_dense_hnf.sanity_checks(times=Integer(5), check_using_magma=False)
      File "~/sage/src/sage/matrix/matrix_integer_dense_hnf.py", line 1285, in sanity_checks
        __do_check([random_matrix(ZZ, n, m, x=-2**32, y=2**32)
      File "~/sage/src/sage/matrix/matrix_integer_dense_hnf.py", line 1276, in __do_check
        if hnf(a)[0] != a.echelon_form(algorithm='pari'):
      File "~/sage/src/sage/matrix/matrix_integer_dense_hnf.py", line 1106, in hnf
        H, pivots = probable_hnf(A, include_zero_rows=include_zero_rows,
      File "~/sage/src/sage/matrix/matrix_integer_dense_hnf.py", line 926, in probable_hnf
        H = hnf_square(C, proof=proof)
      File "~/sage/src/sage/matrix/matrix_integer_dense_hnf.py", line 568, in hnf_square
        raise ValueError("A must be square.")
    ValueError: A must be square.
**********************************************************************
```


(From a patchbot run in #33619.)


---

Comment by @kliem created at 2022-04-25 05:23:05

This is awful.

`hnf` calls `probable_hnf` unconditionally. `probable_hnf` clearly states that it might raise an exception and must be called again in this case. The documentation of `hnf` makes no such statements and I guess just assumes that `probable_hnf` is always correct.


---

Comment by @kliem created at 2022-04-25 05:33:00

But running something in an infinite loop until it works is also an awful idea, I guess.


---

Comment by @kliem created at 2022-04-25 05:38:46

I guess in the case of `proof=True` we just add another test to the loop.
I still do not like the idea of running something in infinite loop (especially as I don't even know what it is doing).

But `probable_hnf` explicitly states that this can happen and that in this case it should be called again, so `hnf` with `proof=True` should account for this.
----
New commits:


---

Comment by @kliem created at 2022-04-25 05:38:46

Changing status from new to needs_review.


---

Comment by klui created at 2022-04-26 04:40:25

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2022-04-26 05:31:12

Thank you.


---

Comment by mkoeppe created at 2022-05-07 18:35:50

Changing priority from minor to blocker.


---

Comment by vbraun created at 2022-05-12 21:42:28

Resolution: fixed
