# Issue 28934: Move giacpy_sage into sage source code

Issue created by migration from https://trac.sagemath.org/ticket/29171

Original creator: vdelecroix

Original creation time: 2020-02-09 11:03:36

CC:  frederichan @mwageringel slelievre fbissey

As discussed on [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/uYXGzG_py28), we propose to move the Cython code that used to be in the optional package `giacpy_sage` into `sage/libs/giac/`.


---

Comment by vdelecroix created at 2020-02-09 11:05:35

New commits:


---

Comment by git created at 2020-02-09 11:06:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by frederichan created at 2020-02-09 23:48:49

Thank you.
The doc you want for a giac keyword (Ex: gbasis) is avaible like this:


```
sage: from sage.libs.giac.giac import *
sage: libgiac.gbasis._help()
sage: libgiac.gbasis._sage_doc_()
```

Indeed 
`libgiac.gbasis?` doesn't give the good help string. 
NB: you removed the def help(self):
so now libgiac.gbasis.help()   crashes. You should also remove the property help or use _help in it.


---

Comment by frederichan created at 2020-02-10 00:06:31

NB: we should think about the new name you chose. Ex backward compatibility or confusions?

Ex: in the past I had often to say: "This  already appears in giac, it doesn't come from giacpy_sage".
giac is already the name of the C++ library, the name of the external giac program and the pexpect interface...


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-08-10 02:30:13

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-10 17:57:56

Currently `giacpy_sage` seems to try to support older Sage versions (see https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/setup.py). 

Frederic, is this something important to preserve, or is it fine to merge these files into Sage?


---

Comment by mkoeppe created at 2020-08-10 18:41:34

Changing status from new to needs_info.


---

Comment by frederichan created at 2020-08-10 19:36:06

Replying to [comment:8 mkoeppe]:
> Currently `giacpy_sage` seems to try to support older Sage versions (see https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/setup.py). 
> 
> Frederic, is this something important to preserve, or is it fine to merge these files into Sage?
> 
No I think it this situation where giacpy_sage is not a package anymore it is not important to keep backward comptatibility. I think here it is better to just drop the giacpy_sage setup.py and let sage build it via the entry in module.py as vincent did in this branch.


---

Comment by mkoeppe created at 2020-08-10 19:51:26

Thanks for the quick reaction. Yes, we would just take the Cython files. 
Part of my question, I guess, was to make sure that there is no plan to continue development in https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/ after we merge the Cython files into Sage. (That would be a fork and increase, not decrease, maintenance burden.)


---

Comment by git created at 2020-08-11 00:28:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-08-11 00:28:38

Rebased on 9.2.beta8


---

Comment by git created at 2020-08-11 01:15:07

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-08-11 01:39:18

Changing status from needs_info to needs_review.


---

Comment by git created at 2020-08-11 01:52:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-11 01:52:56


```
[sagelib-9.2.beta8] In file included from build/cythonized/sage/libs/giac/giac.cpp:7695:
[sagelib-9.2.beta8] build/cythonized/sage/libs/giac/misc.h:104:12: error: implicit instantiation of undefined template 'std::__1::basic_ofstream<char, std::__1::char_traits<char> >'
[sagelib-9.2.beta8]   ofstream of(filename.c_str());
[sagelib-9.2.beta8]            ^
[sagelib-9.2.beta8] /Library/Developer/CommandLineTools/usr/bin/../include/c++/v1/iosfwd:146:32: note: template is declared here
[sagelib-9.2.beta8]     class _LIBCPP_TEMPLATE_VIS basic_ofstream;
[sagelib-9.2.beta8]                                ^
[sagelib-9.2.beta8] In file included from build/cythonized/sage/libs/giac/giac.cpp:7695:
[sagelib-9.2.beta8] build/cythonized/sage/libs/giac/misc.h:110:12: error: implicit instantiation of undefined template 'std::__1::basic_ifstream<char, std::__1::char_traits<char> >'
[sagelib-9.2.beta8]   ifstream f(filename.c_str());
[sagelib-9.2.beta8]            ^
[sagelib-9.2.beta8] /Library/Developer/CommandLineTools/usr/bin/../include/c++/v1/iosfwd:144:32: note: template is declared here
[sagelib-9.2.beta8]     class _LIBCPP_TEMPLATE_VIS basic_ifstream;
[sagelib-9.2.beta8]                                ^
```



---

Comment by git created at 2020-08-11 01:55:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-11 02:02:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-11 02:33:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-11 02:38:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-11 02:40:36

Several errors remain -- expert help is needed


```
sage -t --random-seed=0 src/sage/libs/giac/giac.pyx
**********************************************************************
File "src/sage/libs/giac/giac.pyx", line 30, in sage.libs.giac.giac
Failed example:
    from sage.libs.giac.giac import *
Expected nothing
Got:
    Help file /Applications/usr/share/giac/doc/fr/aide_cas not found
    Added 0 synonyms
**********************************************************************
File "src/sage/libs/giac/giac.pyx", line 980, in sage.libs.giac.giac.encstring23.GiacSetting.Pygen.__getitem__
Failed example:
    l[0]
Expected:
    Traceback (most recent call last):
      File "<stdin>", line 1, in <module>
    ...
    IndexError: list index 0 out of range
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/libs/giac/giac.pyx", line 996, in sage.libs.giac.giac.Pygen.__getitem__ (build/cythonized/sage/libs/giac/giac.cpp:12218)
        result=self.gptr[0][<int>i]
    RuntimeError: Index outside range : 0, vector size is 0, syntax compatibility mode xcas
     Error: Invalid dimension
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.giac.encstring23.GiacSetting.Pygen.__getitem__[11]>", line 1, in <module>
        l[Integer(0)]
      File "sage/libs/giac/giac.pyx", line 1000, in sage.libs.giac.giac.Pygen.__getitem__ (build/cythonized/sage/libs/giac/giac.cpp:12285)
        raise RuntimeError
    RuntimeError
**********************************************************************
File "src/sage/libs/giac/giac.pyx", line 985, in sage.libs.giac.giac.encstring23.GiacSetting.Pygen.__getitem__
Failed example:
    sig_on_count() # check sig_on/off pairings (virtual doctest)
Expected:
    0
Got:
    1
**********************************************************************
```



---

Comment by git created at 2020-08-14 14:31:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2020-08-14 14:49:30

NB: the first time that giacpy is loaded the C++ library  outputs an OS dependant message so we need to put a `# random` flag in the doctests at the first import

I have modified giacpy __len__ to work with 1.5.0.87 whatever if we patch it or not.


---

Comment by mkoeppe created at 2020-08-14 15:22:35

Does this also work with earlier 1.5.0.x? Then perhaps we can go forward with this ticket without the upgrade in #29552


---

Comment by mkoeppe created at 2020-08-14 15:25:12

Replying to [comment:4 frederichan]:
> NB: we should think about the new name you chose. Ex backward compatibility or confusions?
> 
> Ex: in the past I had often to say: "This  already appears in giac, it doesn't come from giacpy_sage".
> giac is already the name of the C++ library, the name of the external giac program and the pexpect interface...

Sorry I missed this comment. Are you referring to the name of the module, `sage.libs.giac`?


---

Comment by git created at 2020-08-14 17:01:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-08-14 17:02:11

Replying to [comment:29 mkoeppe]:
> Does this also work with earlier 1.5.0.x? Then perhaps we can go forward with this ticket without the upgrade in #29552

OK, I have rebased it, dropping the merge of the upgrade ticket #29552.

This seems to work.


---

Comment by mkoeppe created at 2020-08-14 17:02:11

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-14 17:31:15

It would probably be good to add some docstrings, for example for `GiacInstance`...


---

Comment by git created at 2020-08-15 12:01:37

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-08-15 21:20:43

This seems to work well.
We need another reviewer on this ticket...


---

Comment by git created at 2020-08-16 07:02:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2020-08-16 07:36:19

Can we import the  libgiac function from sage/libs/all.py such that it is avaiable in a similar way as libgap?
the problem if I add `lazy_import('sage.libs.giac.giac', 'libgiac')`
is that the first time one type libgiac(2) the user might be confused by the loading message of the giac library:

```
sage: libgiac(2)                                                                                              
// Giac share root-directory:/home/fred-dev/sage/develop/sage.new/local/share/giac/
// Giac share root-directory:/home/fred-dev/sage/develop/sage.new/local/share/giac/
Help file /home/fred-dev/sage/develop/sage.new/local/share/giac/doc/fr/aide_cas not found
Added 0 synonyms
2
```


is it better to not use lazy_import or to force the loading at startup  or just keep this message during the first use of libgiac?


---

Comment by frederichan created at 2020-08-16 08:48:23

I have used this file [https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/mkkeywords.py](https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/mkkeywords.py)  to create the auto-methods.pxi file. But I don't know where to put it.
It can be usefull for maintenance but it is not used by giacpy. Building auto-methods.pxi is quite long and too dangerous to be rebuilt on the fly. (not implementing a new giac keyword doesn"t break the giacpy built but some new giac keywords often cause trouble)

also how should we deal with backward compatibility?
Example: in snappy tree i see some: `from giacpy_sage import libgiac` here
[https://bitbucket.org/mgoerner/snappy/src/default/dev/extended_ptolemy/giac_helper.py](https://bitbucket.org/mgoerner/snappy/src/default/dev/extended_ptolemy/giac_helper.py)


---

Comment by mkoeppe created at 2020-08-16 12:57:36

Replying to [comment:42 frederichan]:
> I have used this file [https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/mkkeywords.py](https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/mkkeywords.py)  to create the auto-methods.pxi file. But I don't know where to put it.
> It can be usefull for maintenance but it is not used by giacpy. Building auto-methods.pxi is quite long and too dangerous to be rebuilt on the fly. (not implementing a new giac keyword doesn"t break the giacpy built but some new giac keywords often cause trouble)

I think `src/sage_setup/autogen/` is the right place for that. Include comments like the above that explain why it's not called automatically.


---

Comment by mkoeppe created at 2020-08-16 13:08:17

Replying to [comment:41 frederichan]:
> Can we import the  libgiac function from sage/libs/all.py such that it is avaiable in a similar way as libgap?

Yes, this is a good idea - it would match `libgap` and `maxima_calculus`, which are available too.

> the problem if I add `lazy_import('sage.libs.giac.giac', 'libgiac')`
> is that the first time one type libgiac(2) the user might be confused by the loading message of the giac library [...]:

That's not a big problem. 
> sage: libgiac(2)                                                                                              
> // Giac share root-directory:/home/fred-dev/sage/develop/sage.new/local/share/giac/
> // Giac share root-directory:/home/fred-dev/sage/develop/sage.new/local/share/giac/

Perhaps open an issue with upstream to reduce verbosity in library mode?

> Help file /home/fred-dev/sage/develop/sage.new/local/share/giac/doc/fr/aide_cas not found

There's something wrong with our installation, as mentioned in #29552

> is it better to not use lazy_import or to force the loading at startup 

No, definitely not. We don't want to load it at startup.


---

Comment by mkoeppe created at 2020-08-16 13:17:03

Replying to [comment:42 frederichan]:
> also how should we deal with backward compatibility?
> Example: in snappy tree i see some: `from giacpy_sage import libgiac` here
> [https://bitbucket.org/mgoerner/snappy/src/default/dev/extended_ptolemy/giac_helper.py](https://bitbucket.org/mgoerner/snappy/src/default/dev/extended_ptolemy/giac_helper.py)

I would suggest that we don't do anything, leaving it to the user libraries to add some try/except to their imports.


---

Comment by git created at 2020-08-17 09:11:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2020-08-17 09:38:25

Ok so I have added giacpy-mkeywords.py in src/sage_setup/autogen and added a lazy import.
about the message
`Help file /Applications/usr/share/giac/doc/en/aide_cas not found`
I don't think that it is a broken installation. This text file have a builtin version in the library. I think it is only usefull if you want to overide the builtin version without recompiling giac.
Ex: if in icas I do `?smith` I have the same information as in share/giac/doc/aide_cas


---

Comment by mkoeppe created at 2020-08-17 18:09:19

Replying to [comment:47 frederichan]:
> Ok so I have added giacpy-mkeywords.py in src/sage_setup/autogen and added a lazy import.

Looks great.

> about the message
> `Help file /Applications/usr/share/giac/doc/en/aide_cas not found`
> I don't think that it is a broken installation. This text file have a builtin version in the library. I think it is only usefull if you want to overide the builtin version without recompiling giac.
> Ex: if in icas I do `?smith` I have the same information as in share/giac/doc/aide_cas 

Thanks for the information. It's just that it looks like an error message, and moreover the path (`/Applications/usr...`) is really strange and is unrelated to the actual installation location of giac in sage.

Perhaps upstream could add a way to suppress these messages?


---

Comment by mkoeppe created at 2020-08-17 18:10:22

Ready for "positive review" from my side...


---

Comment by frederichan created at 2020-08-18 09:44:50

So do I. (I know that there is room for improvement in the speed of evaluation of functions as vincent suggested in its first branch but it would not be a minor change. I'd rather in a first step keep things close to the giacpy_sage package to see if there are problems in the migration, and improve later with a list of functions that wants a direct implementation for speed.)


---

Comment by mkoeppe created at 2020-08-18 13:32:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-19 22:17:32

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-08-19 22:17:32


```
sage -t --long --warn-long 60.7 --random-seed=0 src/sage/interfaces/giac.py
**********************************************************************
File "src/sage/interfaces/giac.py", line 1002, in sage.interfaces.giac.GiacElement._latex_
Failed example:
    latex(gM)
Expected:
    \left(\begin{array}{cc}
    1 & 2 \\
    3 & 4
    \end{array}\right)
Got:
    \left[\begin{array}{cc}1&2\\3&4\end{array}\right]
**********************************************************************
1 item had failures:
   1 of   7 in sage.interfaces.giac.GiacElement._latex_
    [172 tests, 1 failure, 2.47 s]
----------------------------------------------------------------------
```



---

Comment by git created at 2020-08-19 23:32:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-19 23:33:07

Cherry-picked one commit from #29541


---

Comment by mkoeppe created at 2020-08-19 23:33:07

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-20 13:38:24

Quick review?


---

Comment by dimpase created at 2020-08-20 15:08:05

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-20 15:08:05

lgtm


---

Comment by mkoeppe created at 2020-08-20 18:26:03

Thanks


---

Comment by vbraun created at 2020-08-23 17:51:11

Resolution: fixed
