# Issue 22985: Incorrect output from Vélu's formulas on j=0?

Issue created by migration from https://trac.sagemath.org/ticket/23222

Original creator: defeo

Original creation time: 2017-06-12 11:55:31

CC:  cremona

Keywords: isogenies, supersingular

I'm not sure about what's happening here. While playing around with supersingular curves:


```
sage: K = GF(47^2)
sage: E = EllipticCurve([0,K.gen()])
sage: E.trace_of_frobenius()
-47
sage: [E.isogeny(f).codomain().j_invariant() for f,_ in E.division_polynomial(7).factor()[3:]]
[0, 24*z2 + 1, 24*z2 + 1, 24*z2 + 1, 36, 36, 36]
sage: [E.isogeny(f).codomain().trace_of_frobenius() for f,_ in E.division_polynomial(7).factor()[3:]]
[-47, -49, -49, -49, 94, 94, 94]
```


The first curve is ok. The occurrences of trace 94 are weird, but j=0 and j=36 (1728) are 7-isogenous nevertheless. But trace -49?! That's not even supersingular!

What's even more weird is that Magma gives the same results, so I'm starting to doubt of my own sanity.


---

Comment by cremona created at 2017-06-12 19:16:48

Remember that the Trace of Frobenius is an integer, not an element of the field, so seeing 94 which is 0 mod 47 is ok.
Secondly, you have omitted the isogeny whose kernel is the product of the 3 linear factors of the 7-division polynomial.
Thirdly, if you want to see the 7-isogenous curves it is better to do

```
E.isogenies_prime_degree(7)
```

since it is non-trivial to combine the factors of the division polynomial correctly.  In this case there are only two 7-isogenies.  Not that E.isogeny(f) does *not* actually check that f is a valid kernel polynomial even when check=True is give (the default).  It should!  When it was written we did not have code to do that but now we do.  It is slightly buried in the function isogenies_prime_degree_general().


---

Comment by defeo created at 2017-06-12 21:15:58

Replying to [comment:1 cremona]:
> Remember that the Trace of Frobenius is an integer, not an element of the field, so seeing 94 which is 0 mod 47 is ok.

I agree with that, but doesn't Sato-Tate say that two curves are isogenous over a finite field iff they have the *same* trace? As I said, j=0 and j=36 are isogenous over GF(47<sup>2</sup>), but the exact curves in the example are not. And, indeed:


```
sage: phi = E.isogeny(E.division_polynomial(7).factor()[8][0])
sage: phi(E.random_point())
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: Coordinates [16*z2 + 30, 3*z2 + 22, 1] do not define a point on Elliptic Curve defined by y^2 = x^3 + (3*z2+36)*x over Finite Field in z2 of size 47^2
```


> Secondly, you have omitted the isogeny whose kernel is the product of the 3 linear factors of the 7-division polynomial.

Yes. I just wanted to highlight the bug. One of the buggy factors would have been enough.

> Thirdly, if you want to see the 7-isogenous curves it is better to do
> {{{
> E.isogenies_prime_degree(7)
> }}}
> since it is non-trivial to combine the factors of the division polynomial correctly.

Absolutely. However, I found the bug while doing a more general search.

> Not that E.isogeny(f) does *not* actually check that f is a valid kernel polynomial even when check=True is give (the default).  It should!  When it was written we did not have code to do that but now we do.  It is slightly buried in the function isogenies_prime_degree_general().

Well, that's not completely correct:


```
sage: E.isogeny(E.base_field().polynomial_ring().random_element(3))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: The polynomial does not define a finite subgroup of the elliptic curve.
```


So there are some checks, but they are buggy, at least for j=0,1728, I suspect.

I do not have time to dig this further right now. Hopefully in a couple of weeks I can come up with a fix.


---

Comment by cremona created at 2017-06-13 07:30:50

The j-invariant does not determine the trace since it only determines the curve up to twist; in your case there are more than 2 twists as well.

Yes, some checking is done for validity of kernel polys, but that is misleading since bad input passes those tests as they are not complete.

We'll come back to that.


---

Comment by cremona created at 2018-04-13 08:55:25

Can we close this as invalid / won't fix?  I just re-read the comments and think that I explained why none of the output which had been thought to be suspect was incorrect.


---

Comment by defeo created at 2018-04-13 13:12:24

I still don't get it. Admittedly, `E.isogeny(f)` does not test that `f` is a valid kernel polynomial. But, why is `f` not a valid kernel polynomial in this example:


```
sage: f = E.division_polynomial(7).factor()[4][0]
sage: E.is_supersingular()
True
sage: E.isogeny(f).codomain().is_supersingular()
False
```


Also, the `TypeError` in [comment:2 comment 2] is not nice and would deserve fixing.


---

Comment by cremona created at 2018-04-13 13:34:37

The kernel poly of a 7-isogeny is a degree 3 factor of the 7-division poly but not every degree 3 factor is a kernel poly!  In this case the 3 roots of your degree 3 factor, which all lie in GF(47^6), are the x-coordinates of points in 3 different subgroups of order 7.

In the function isogenies_prime_degree_general() in sage.schemes.elliptic_curves.isogeny_small_degree, this is implemented properly: factor the l-division poly (here l is an odd prime); keep only factors of degree dividing (l-1)/2;  for each such factor work out whether or not it is an irreducible factor of a kernel poly.

It would be possible to extract from the code of that function a test for whether a polynomial of degree (l-1)/2 actually is a kernel poly.  Feel free to make a ticket for that!  The relevent theory is in Kimi Tsukazaki's thesis (cited in that file).


---

Comment by defeo created at 2018-04-13 14:16:12

Oh, right!

Can't we just edit this ticket so that it points to the problem, instead of closing it and opening a new one?


---

Comment by cremona created at 2018-04-13 14:26:32

Sure, go ahead.  Once we have a stand-alone function test_kernel_poly(E,f,ell) it is clear where to put a call to it: in place of lines 2450-2454 where now it only tests if the polynomial divides the division poly.  I should have done this ages ago.


---

Comment by defeo created at 2018-04-13 14:52:39

Changing type from defect to enhancement.


---

Comment by defeo created at 2018-04-13 14:52:39

Changing keywords from "isogenies, supersingular" to "isogenies, vélu's formulas".


---

Comment by cremona created at 2018-04-16 11:22:58

Changing type from enhancement to defect.


---

Comment by cremona created at 2018-04-16 11:22:58

Working on it...


---

Comment by cremona created at 2018-04-16 14:39:08

New commits:


---

Comment by cremona created at 2018-04-16 14:39:08

Changing status from new to needs_review.


---

Comment by git created at 2018-04-16 15:28:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-12-01 13:42:32

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-12-01 13:42:32

red banch, needs rebasing


---

Comment by cremona created at 2018-12-01 15:06:31

Replying to [comment:13 chapoton]:
> red branch, needs rebasing
I will rebase it, but it would be good to have a commitment from someone to review it, since the actual work on this was done over 6 months ago.


---

Comment by git created at 2018-12-01 20:28:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2018-12-01 20:28:36

Changing status from needs_work to needs_review.


---

Comment by defeo created at 2018-12-02 09:47:03

It's been in my todo list for 6 months indeed. But I won't have time before Christmas.


---

Comment by defeo created at 2019-01-15 10:26:21

I have one doctest failure:


```
sage -t --long --warn-long 83.4 src/sage/schemes/elliptic_curves/ell_field.py                                                          
**********************************************************************                                                                 
File "src/sage/schemes/elliptic_curves/ell_field.py", line 1023, in sage.schemes.elliptic_curves.ell_field.EllipticCurve_field.isogeni$
s_prime_degree
Failed example:
    E.isogenies_prime_degree(5)
Exception raised:
    Traceback (most recent call last):
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_field.EllipticCurve_field.isogenies_prime_degree[28]>", line 1, in <module>
        E.isogenies_prime_degree(Integer(5))
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_field.py", line 1091, in isogenies_prime$
degree
        return sum([isogenies_prime_degree(self, d) for d in L], [])
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 2328, in isog$
nies_prime_degree
        return isogenies_prime_degree_general(E,l, minimal_models=minimal_models)
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 2197, in isog$
nies_prime_degree_general
        return [E.isogeny(k) for k in ker]
      File "/data/dfl/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_field.py", line 880, in isogeny
        raise RuntimeError("Unable to construct isogeny: %s" % e)
    RuntimeError: Unable to construct isogeny: 'sage.rings.fraction_field_FpT.FpTElement' object has no attribute 'divides'
**********************************************************************
```


...investigating.


---

Comment by defeo created at 2019-01-15 17:30:54

The doctest failure is due to #27064. No issue to be addressed here.


---

Comment by defeo created at 2019-01-15 18:13:59

In `is_kernel_polynomial`, there is this test:


```
psi_m = E.division_polynomial(m)
if not f.divides(psi_m):
    return False
```


isn't it (much) more efficient to do


```
if E.division_polynomial(m, x=f.parent().quo(f).gen()) != 0:
    return False
```



---

Comment by defeo created at 2019-01-15 18:34:28

The doc still says


```
   * "check" (default: True) does some partial checks that the

        input is valid (e.g., that the kernel polynomial provided is
        valid); however, invalid input can in some cases still pass,
        since that the points define a group is not checked.
```


what are the invalid inputs that still pass?


---

Comment by cremona created at 2019-01-17 12:29:44

I will correct the docstring and also avoid using f.divides as suggested.


---

Comment by cremona created at 2019-01-17 12:29:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-01-17 13:03:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2019-01-17 13:03:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-01-17 16:12:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2019-01-17 16:24:17

Doctests pass. I just fixed a minor problem in the docstring (`r"""` instead of `"""`). Thanks, and sorry for the long time.


---

Comment by defeo created at 2019-01-17 16:24:17

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2019-01-17 16:24:42

Thanks!


---

Comment by vbraun created at 2019-01-22 12:40:34

Resolution: fixed


---

Comment by chapoton created at 2019-01-24 11:00:54

one py3-incompatible import was added here ; fix at #27107
