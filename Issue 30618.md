# Issue 30618: Refactor environment config variables

Issue created by migration from https://trac.sagemath.org/ticket/30855

Original creator: @tobiasdiez

Original creation time: 2020-11-03 10:40:26

CC:  mkoeppe

Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).

This idea is illustrated at the example of the `ellCurve` data directory. Refactoring the other config variables will be done in follow-up tickets.


---

Comment by @tobiasdiez created at 2020-11-03 10:42:40

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-11-03 15:49:04

Note that in `sage.features` we have a rather similar approach to configuration. Can't redo this again in `sage.env`


---

Comment by @tobiasdiez created at 2020-11-03 16:35:20

Thanks for the pointer to `sage.features`.
It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. I don't see any disadvantages of replacing this string variable with a method returning a `Path` object. In particular, there is no code duplication (although the code in `features.databases` can then easily be streamlined using the pathlib library).

Or are you proposing to replace/encapsulate all variables in `sage.env` in separate features?


---

Comment by mkoeppe created at 2020-11-03 16:55:10

Replying to [comment:3 gh-tobiasdiez]:
> Thanks for the pointer to `sage.features`.
> It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. 

Yes, `sage.features.databases` provides an abstraction on top of `sage.env`.

I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`.


---

Comment by mkoeppe created at 2020-11-03 16:58:49

Replying to [comment:3 gh-tobiasdiez]:
> are you proposing to replace/encapsulate all variables in `sage.env` in separate features?

Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going.


---

Comment by @tobiasdiez created at 2020-11-03 17:58:50

Replying to [comment:4 mkoeppe]:
> I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`. 
> 

I think you misunderstood my intention a bit. I didn't add another layer of abstraction, I just changed the interface to the same information. Instead of yielding a string path, it returns now a proper `Path` object. I can also readd the variable `ELLCURVE_DATA_DIR` having type `Path` if you prefer that instead of the getter-method. I just thought that since there is a disk access involved, it might speedup initiation a bit to encapsulate everything in a method. That can easily changed, of course.


> Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going. 
> 

ok, but adding such an abstraction for the ellCurve data directory can be done later (and wasn't my intention).


---

Comment by mkoeppe created at 2020-11-03 18:21:19

The patch is adding file system inspection to `sage.env` - this makes things less uniform.  The other database features are doing this in `sage.features` via `StaticFile`.


---

Comment by @tobiasdiez created at 2020-11-03 19:22:45

I agree, it's less uniform because of the special handling of paths.

To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
1. If user sets the path via an env variable, and the path exists, take it.
2. If not, but `sage.conf` sets a path that exists, take it.
3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

I see the following two approaches:
Option a) is to have all this logic in `sage.env` (maybe with a light wrapper in `sage.features`) and Option b) is to expose the steps 1 and 2 as methods `get_env_variable` and `get_sage_conf_variable` in `sage.env` and put the file check logic in `sage.features`. I have a light preference for Option a) as this would require the least amount of changes but Option b) also sounds fine with me. Which option do you prefer?


---

Comment by mkoeppe created at 2020-11-03 19:29:35

Replying to [comment:8 gh-tobiasdiez]:
> To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
> 1. If user sets the path via an env variable, and the path exists, take it.
> 2. If not, but `sage.conf` sets a path that exists, take it.
> 3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

That's different and more complex than the current behavior. Do you need this? Then please clarify the ticket description - it's not just refactoring.


---

Comment by @tobiasdiez created at 2020-11-03 19:34:48

I don't really need this, but thought it might be helpful / desired. If you don't think it's needed, then I can easily remove this extra logic again.


---

Comment by @tobiasdiez created at 2020-11-03 20:12:32

On a second thought, I actually need something like this in #30371. Not so much for paths but for package names. In fact the package name check implemented in #30706 has pretty much the same spirit as this the refactoring done in this ticket.


---

Comment by mkoeppe created at 2020-11-03 23:14:23

If you need a new behavior for configuration of "package names" (not sure what you mean by that), please open a ticket for it. In general, I recommend to keep tickets that implement new features or change behavior separate from tickets that refactor existing code.


---

Comment by @tobiasdiez created at 2020-11-04 08:30:49

What I meant was that in #30706 the added method `get_cblas_pc_module_name` has the same structure as `get_ellcurve_data_dir`: it checks the env variables and the `sage.conf` information for the first existing option (using `pkgconfig`).

Anyway, is the filepath handling described above in #30855#comment:8 desired or not? I don't really the need this additional logic, but it was easy to implement so I went for it while refactoring. I can easily revert it, just please let me know.


---

Comment by mkoeppe created at 2020-11-04 21:53:16

Changing priority from major to minor.


---

Comment by git created at 2021-01-25 11:48:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-25 12:53:12

Changing priority from minor to major.


---

Comment by git created at 2021-01-25 12:53:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-25 13:46:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-25 18:10:36

Replying to [comment:13 gh-tobiasdiez]:
> is the filepath handling described above in #30855#comment:8 desired or not? 

No use case motivating this change his been described. So let's please not continue just because the ticket is open.


---

Comment by mkoeppe created at 2021-01-25 18:10:36

Changing status from needs_review to needs_info.


---

Comment by @tobiasdiez created at 2021-01-25 18:37:50

As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. Otherwise one has to check every time that the path exists, and the fallbacks are never used in this case.

However, if this is not desired, then I can remove this again. It's only removing the exist check here:

```
+    def converter(value: Optional[str]) -> Optional[Path]:
+        if value is None:
+            return None
+
+        path = Path(value)
+        if path.exists():
+            return path
+        else:
+            return None
```



---

Comment by mkoeppe created at 2021-01-25 18:42:05

Replying to [comment:20 gh-tobiasdiez]:
> As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. 

I disagree. Things like this should really be done in `sage.features`.


---

Comment by git created at 2021-01-25 20:04:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-25 20:05:52

I have a hard time seeing how `SAGE_LOCAL` is a feature, but I've now removed the existence check. So this is really only a refactoring from string-paths to pathlib-paths.


---

Comment by @tobiasdiez created at 2021-01-25 20:07:12

Changing status from needs_info to needs_review.


---

Comment by git created at 2021-01-25 20:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-25 20:12:36

`SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.


---

Comment by mkoeppe created at 2021-01-25 20:18:14

For example this one here:

```
--- a/src/sage/interfaces/lie.py
+++ b/src/sage/interfaces/lie.py
@@ -331,7 +331,7 @@ class LiE(ExtraTabCompletion, Expect):
                         prompt = '> ',
 
                         # This is the command that starts up your program
-                        command = "bash "+ SAGE_LOCAL + "/bin/lie",
+                        command = f"bash { SAGE_LOCAL / 'bin' / 'lie' }",
 
                         server=server,
                         script_subdirectory = script_subdirectory,
```

This would better be rewritten using an `Executable` feature.


---

Comment by mkoeppe created at 2021-01-25 20:25:18

Also, as changes like this one indicate:

```
--- a/src/sage/doctest/sources.py
+++ b/src/sage/doctest/sources.py
@@ -87,8 +87,8 @@ def get_basename(path):
     root = os.path.dirname(path)
     # If the file is in the sage library, we can use our knowledge of
     # the directory structure
-    dev = SAGE_SRC
-    sp = SAGE_LIB
+    dev = str(SAGE_SRC)
+    sp = str(SAGE_LIB)
     if path.startswith(dev):
         # there will be a branch name
         i = path.find(os.path.sep, len(dev))
```

The change of the type of the variables is not backwards-compatible (although in some contexts you can use path like a string). So there is a danger of breaking user code.


---

Comment by @tobiasdiez created at 2021-01-25 21:01:49

I agree, that some of the code can be further refactored and e.g. moved to the feature module. However, this only changes the location of code such as `SAGE_LOCAL + "/bin/lie"` and thus it is still advantageous to have `SAGE_LOCAL` as path.

What do you propose to do about the backward-compatibility? What are sage's conventions concerning breaking changes (especially concerning relatively internal things like sage.env)?


---

Comment by mkoeppe created at 2021-01-25 23:06:05

It's really very simple:
We have a low-level interface (`sage.env`), we have a high-level interface (`sage.features`). It is not a clear improvement to make the existing low-level interface slightly higher-level. Instead, improve code that uses the low-level interface by using the high-level interface instead.


---

Comment by @tobiasdiez created at 2021-01-25 23:41:35

There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). All of these calls profit from the strengthen of the interface to use pathlib. Even if refactoring to sage.features would remove half of them, that's still a huge number of string -> path conversions that have to be repeatedly done in many places. So why not fix this at the origin?


---

Comment by mkoeppe created at 2021-01-26 01:24:32

Replying to [comment:29 gh-tobiasdiez]:
> What are sage's conventions concerning breaking changes 

We use the deprecation mechanism if we have to make incompatible changes.

Hard to do use deprecation here - which is another reason why this old interface (`sage.env`) is best left alone.


---

Comment by mkoeppe created at 2021-01-26 18:44:01

Replying to [comment:26 mkoeppe]:
> `SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.

For reference - #30818


---

Comment by @tobiasdiez created at 2021-01-30 10:38:36

Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). So it is natural that many place in sage will access this information. And I don't understand why you don't want to have an universal check for basic consistency (paths specified exist, boolean flags are yes/no etc). Right now these things are checked in various places, leading to code duplication and additional work for maintenance.

For deprecation, that's possible using a wrapper around `Path` and `str` that prints warning messages if the string-methods are used (similar to https://stackoverflow.com/questions/922550/how-to-mark-a-global-as-deprecated-in-python)


---

Comment by mkoeppe created at 2021-01-30 16:40:25

Replying to [comment:34 gh-tobiasdiez]:
> Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). 

See comment 4. 
`sage.env` is a low-level interface - a thin wrapper around os.environ, combining environment variables and `sage_conf` and simple fallbacks. It maps string keys to strings. 

Adding complexity there is not an improvement.

`sage.features` was designed to provide a high-level interface to the system environment of sagelib (#20382).

It already does what it seems you are trying to introduce in `sage.env`: It is typed and it implements filesystem lookups.


---

Comment by mkoeppe created at 2021-01-30 18:17:12

Replying to [comment:31 gh-tobiasdiez]:
> There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). 

`git grep 'join(SAGE' src/sage | grep -v 'sage:' ` (ignoring lines that are in doctests!) gives 97 hits, which will need review. That's really just a small remainder of refactoring work that has already been done in the past few years.

For example, all places using `SAGE_EXTCODE` would be changed by #31306.


---

Comment by @tobiasdiez created at 2021-01-30 18:28:45

And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? And why is it not helpful for this if these variables are Paths?


---

Comment by mkoeppe created at 2021-01-30 19:08:25

Replying to [comment:37 gh-tobiasdiez]:
> And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? 

`sage.features.Executable` uses `PATH`. See #31296 for a proposed improvement.

`sage.features.StaticFile` uses a customizable search path, which defaults to `SAGE_SHARE` - this probably needs a better design, as we are moving away from assumptions related to the installation scheme of the Sage distribution.

> And why is it not helpful for this if these variables are Paths?

That's not how this works. A proposed change needs to be sufficiently motivated - what problem is the ticket trying to solve?  In particular, convincing motivation is necessary when breaking changes to the interface are proposed or the complexity of the code is increased by the change.

`pathlib` is nice, but I don't think there is any sort of consensus in the Python community that it is "better" than `os.path`. It's just a matter of preferences.


---

Comment by @tobiasdiez created at 2021-01-30 20:01:12

Changing component from refactoring to interfaces: optional.


---

Comment by @tobiasdiez created at 2021-01-30 20:01:12

Replying to [comment:38 mkoeppe]:
> what problem is the ticket trying to solve?

The idea was to provide basic existence and consistency checks that would apply to all path-based env variables. Since this is apparently not desired, let's close this ticket to not spent more time discussing this.


---

Comment by mkoeppe created at 2021-01-30 20:21:23

In any case, the discussion was fruitful as it led to creating tickets #31291, #31292, #31293, #31296, #31306. Any work on these tickets would be very welcome!


---

Comment by mkoeppe created at 2021-01-30 20:21:23

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-08-26 02:08:43

Resolution: invalid
