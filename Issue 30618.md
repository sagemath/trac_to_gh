# Issue 30618: Refactor environment config variables

archive/issues_030618.json:
```json
{
    "body": "CC:  mkoeppe\n\nCurrently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).\n\nThis idea is illustrated at the example of the `ellCurve` data directory. Refactoring the other config variables will be done in follow-up tickets.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30855\n\n",
    "created_at": "2020-11-03T10:40:26Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "title": "Refactor environment config variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30618",
    "user": "@tobiasdiez"
}
```
CC:  mkoeppe

Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).

This idea is illustrated at the example of the `ellCurve` data directory. Refactoring the other config variables will be done in follow-up tickets.

Issue created by migration from https://trac.sagemath.org/ticket/30855





---

archive/issue_comments_437677.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-03T10:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437677",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_437678.json:
```json
{
    "body": "Note that in `sage.features` we have a rather similar approach to configuration. Can't redo this again in `sage.env`",
    "created_at": "2020-11-03T15:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437678",
    "user": "mkoeppe"
}
```

Note that in `sage.features` we have a rather similar approach to configuration. Can't redo this again in `sage.env`



---

archive/issue_comments_437679.json:
```json
{
    "body": "Thanks for the pointer to `sage.features`.\nIt seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. I don't see any disadvantages of replacing this string variable with a method returning a `Path` object. In particular, there is no code duplication (although the code in `features.databases` can then easily be streamlined using the pathlib library).\n\nOr are you proposing to replace/encapsulate all variables in `sage.env` in separate features?",
    "created_at": "2020-11-03T16:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437679",
    "user": "@tobiasdiez"
}
```

Thanks for the pointer to `sage.features`.
It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. I don't see any disadvantages of replacing this string variable with a method returning a `Path` object. In particular, there is no code duplication (although the code in `features.databases` can then easily be streamlined using the pathlib library).

Or are you proposing to replace/encapsulate all variables in `sage.env` in separate features?



---

archive/issue_comments_437680.json:
```json
{
    "body": "Replying to [comment:3 gh-tobiasdiez]:\n> Thanks for the pointer to `sage.features`.\n> It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. \n\nYes, `sage.features.databases` provides an abstraction on top of `sage.env`.\n\nI would not consider it an improvement to put another, intermediate abstraction inside `sage.env`.",
    "created_at": "2020-11-03T16:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437680",
    "user": "mkoeppe"
}
```

Replying to [comment:3 gh-tobiasdiez]:
> Thanks for the pointer to `sage.features`.
> It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. 

Yes, `sage.features.databases` provides an abstraction on top of `sage.env`.

I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`.



---

archive/issue_comments_437681.json:
```json
{
    "body": "Replying to [comment:3 gh-tobiasdiez]:\n> are you proposing to replace/encapsulate all variables in `sage.env` in separate features?\n\nWell, encapsulating these variables is the direction in which the code added to `sage.features` has been going.",
    "created_at": "2020-11-03T16:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437681",
    "user": "mkoeppe"
}
```

Replying to [comment:3 gh-tobiasdiez]:
> are you proposing to replace/encapsulate all variables in `sage.env` in separate features?

Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going.



---

archive/issue_comments_437682.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`. \n> \n\nI think you misunderstood my intention a bit. I didn't add another layer of abstraction, I just changed the interface to the same information. Instead of yielding a string path, it returns now a proper `Path` object. I can also readd the variable `ELLCURVE_DATA_DIR` having type `Path` if you prefer that instead of the getter-method. I just thought that since there is a disk access involved, it might speedup initiation a bit to encapsulate everything in a method. That can easily changed, of course.\n\n\n> Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going. \n> \n\nok, but adding such an abstraction for the ellCurve data directory can be done later (and wasn't my intention).",
    "created_at": "2020-11-03T17:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437682",
    "user": "@tobiasdiez"
}
```

Replying to [comment:4 mkoeppe]:
> I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`. 
> 

I think you misunderstood my intention a bit. I didn't add another layer of abstraction, I just changed the interface to the same information. Instead of yielding a string path, it returns now a proper `Path` object. I can also readd the variable `ELLCURVE_DATA_DIR` having type `Path` if you prefer that instead of the getter-method. I just thought that since there is a disk access involved, it might speedup initiation a bit to encapsulate everything in a method. That can easily changed, of course.


> Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going. 
> 

ok, but adding such an abstraction for the ellCurve data directory can be done later (and wasn't my intention).



---

archive/issue_comments_437683.json:
```json
{
    "body": "The patch is adding file system inspection to `sage.env` - this makes things less uniform.  The other database features are doing this in `sage.features` via `StaticFile`.",
    "created_at": "2020-11-03T18:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437683",
    "user": "mkoeppe"
}
```

The patch is adding file system inspection to `sage.env` - this makes things less uniform.  The other database features are doing this in `sage.features` via `StaticFile`.



---

archive/issue_comments_437684.json:
```json
{
    "body": "I agree, it's less uniform because of the special handling of paths.\n\nTo make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?\n1. If user sets the path via an env variable, and the path exists, take it.\n2. If not, but `sage.conf` sets a path that exists, take it.\n3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.\n\nI see the following two approaches:\nOption a) is to have all this logic in `sage.env` (maybe with a light wrapper in `sage.features`) and Option b) is to expose the steps 1 and 2 as methods `get_env_variable` and `get_sage_conf_variable` in `sage.env` and put the file check logic in `sage.features`. I have a light preference for Option a) as this would require the least amount of changes but Option b) also sounds fine with me. Which option do you prefer?",
    "created_at": "2020-11-03T19:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437684",
    "user": "@tobiasdiez"
}
```

I agree, it's less uniform because of the special handling of paths.

To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
1. If user sets the path via an env variable, and the path exists, take it.
2. If not, but `sage.conf` sets a path that exists, take it.
3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

I see the following two approaches:
Option a) is to have all this logic in `sage.env` (maybe with a light wrapper in `sage.features`) and Option b) is to expose the steps 1 and 2 as methods `get_env_variable` and `get_sage_conf_variable` in `sage.env` and put the file check logic in `sage.features`. I have a light preference for Option a) as this would require the least amount of changes but Option b) also sounds fine with me. Which option do you prefer?



---

archive/issue_comments_437685.json:
```json
{
    "body": "Replying to [comment:8 gh-tobiasdiez]:\n> To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?\n> 1. If user sets the path via an env variable, and the path exists, take it.\n> 2. If not, but `sage.conf` sets a path that exists, take it.\n> 3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.\n\nThat's different and more complex than the current behavior. Do you need this? Then please clarify the ticket description - it's not just refactoring.",
    "created_at": "2020-11-03T19:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437685",
    "user": "mkoeppe"
}
```

Replying to [comment:8 gh-tobiasdiez]:
> To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
> 1. If user sets the path via an env variable, and the path exists, take it.
> 2. If not, but `sage.conf` sets a path that exists, take it.
> 3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

That's different and more complex than the current behavior. Do you need this? Then please clarify the ticket description - it's not just refactoring.



---

archive/issue_comments_437686.json:
```json
{
    "body": "I don't really need this, but thought it might be helpful / desired. If you don't think it's needed, then I can easily remove this extra logic again.",
    "created_at": "2020-11-03T19:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437686",
    "user": "@tobiasdiez"
}
```

I don't really need this, but thought it might be helpful / desired. If you don't think it's needed, then I can easily remove this extra logic again.



---

archive/issue_comments_437687.json:
```json
{
    "body": "On a second thought, I actually need something like this in #30371. Not so much for paths but for package names. In fact the package name check implemented in #30706 has pretty much the same spirit as this the refactoring done in this ticket.",
    "created_at": "2020-11-03T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437687",
    "user": "@tobiasdiez"
}
```

On a second thought, I actually need something like this in #30371. Not so much for paths but for package names. In fact the package name check implemented in #30706 has pretty much the same spirit as this the refactoring done in this ticket.



---

archive/issue_comments_437688.json:
```json
{
    "body": "If you need a new behavior for configuration of \"package names\" (not sure what you mean by that), please open a ticket for it. In general, I recommend to keep tickets that implement new features or change behavior separate from tickets that refactor existing code.",
    "created_at": "2020-11-03T23:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437688",
    "user": "mkoeppe"
}
```

If you need a new behavior for configuration of "package names" (not sure what you mean by that), please open a ticket for it. In general, I recommend to keep tickets that implement new features or change behavior separate from tickets that refactor existing code.



---

archive/issue_comments_437689.json:
```json
{
    "body": "What I meant was that in #30706 the added method `get_cblas_pc_module_name` has the same structure as `get_ellcurve_data_dir`: it checks the env variables and the `sage.conf` information for the first existing option (using `pkgconfig`).\n\nAnyway, is the filepath handling described above in #30855#comment:8 desired or not? I don't really the need this additional logic, but it was easy to implement so I went for it while refactoring. I can easily revert it, just please let me know.",
    "created_at": "2020-11-04T08:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437689",
    "user": "@tobiasdiez"
}
```

What I meant was that in #30706 the added method `get_cblas_pc_module_name` has the same structure as `get_ellcurve_data_dir`: it checks the env variables and the `sage.conf` information for the first existing option (using `pkgconfig`).

Anyway, is the filepath handling described above in #30855#comment:8 desired or not? I don't really the need this additional logic, but it was easy to implement so I went for it while refactoring. I can easily revert it, just please let me know.



---

archive/issue_comments_437690.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2020-11-04T21:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437690",
    "user": "mkoeppe"
}
```

Changing priority from major to minor.



---

archive/issue_comments_437691.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T11:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437691",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437692.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2021-01-25T12:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437692",
    "user": "@tobiasdiez"
}
```

Changing priority from minor to major.



---

archive/issue_comments_437693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T12:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437693",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437694.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T13:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437694",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437695.json:
```json
{
    "body": "Replying to [comment:13 gh-tobiasdiez]:\n> is the filepath handling described above in #30855#comment:8 desired or not? \n\nNo use case motivating this change his been described. So let's please not continue just because the ticket is open.",
    "created_at": "2021-01-25T18:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437695",
    "user": "mkoeppe"
}
```

Replying to [comment:13 gh-tobiasdiez]:
> is the filepath handling described above in #30855#comment:8 desired or not? 

No use case motivating this change his been described. So let's please not continue just because the ticket is open.



---

archive/issue_comments_437696.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-01-25T18:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437696",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_437697.json:
```json
{
    "body": "As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. Otherwise one has to check every time that the path exists, and the fallbacks are never used in this case.\n\nHowever, if this is not desired, then I can remove this again. It's only removing the exist check here:\n\n```\n+    def converter(value: Optional[str]) -> Optional[Path]:\n+        if value is None:\n+            return None\n+\n+        path = Path(value)\n+        if path.exists():\n+            return path\n+        else:\n+            return None\n```\n",
    "created_at": "2021-01-25T18:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437697",
    "user": "@tobiasdiez"
}
```

As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. Otherwise one has to check every time that the path exists, and the fallbacks are never used in this case.

However, if this is not desired, then I can remove this again. It's only removing the exist check here:

```
+    def converter(value: Optional[str]) -> Optional[Path]:
+        if value is None:
+            return None
+
+        path = Path(value)
+        if path.exists():
+            return path
+        else:
+            return None
```




---

archive/issue_comments_437698.json:
```json
{
    "body": "Replying to [comment:20 gh-tobiasdiez]:\n> As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. \n\nI disagree. Things like this should really be done in `sage.features`.",
    "created_at": "2021-01-25T18:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437698",
    "user": "mkoeppe"
}
```

Replying to [comment:20 gh-tobiasdiez]:
> As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. 

I disagree. Things like this should really be done in `sage.features`.



---

archive/issue_comments_437699.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T20:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437699",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437700.json:
```json
{
    "body": "I have a hard time seeing how `SAGE_LOCAL` is a feature, but I've now removed the existence check. So this is really only a refactoring from string-paths to pathlib-paths.",
    "created_at": "2021-01-25T20:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437700",
    "user": "@tobiasdiez"
}
```

I have a hard time seeing how `SAGE_LOCAL` is a feature, but I've now removed the existence check. So this is really only a refactoring from string-paths to pathlib-paths.



---

archive/issue_comments_437701.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-01-25T20:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437701",
    "user": "@tobiasdiez"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_437702.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T20:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437702",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437703.json:
```json
{
    "body": "`SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.",
    "created_at": "2021-01-25T20:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437703",
    "user": "mkoeppe"
}
```

`SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.



---

archive/issue_comments_437704.json:
```json
{
    "body": "For example this one here:\n\n```\n--- a/src/sage/interfaces/lie.py\n+++ b/src/sage/interfaces/lie.py\n@@ -331,7 +331,7 @@ class LiE(ExtraTabCompletion, Expect):\n                         prompt = '> ',\n \n                         # This is the command that starts up your program\n-                        command = \"bash \"+ SAGE_LOCAL + \"/bin/lie\",\n+                        command = f\"bash { SAGE_LOCAL / 'bin' / 'lie' }\",\n \n                         server=server,\n                         script_subdirectory = script_subdirectory,\n```\n\nThis would better be rewritten using an `Executable` feature.",
    "created_at": "2021-01-25T20:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437704",
    "user": "mkoeppe"
}
```

For example this one here:

```
--- a/src/sage/interfaces/lie.py
+++ b/src/sage/interfaces/lie.py
@@ -331,7 +331,7 @@ class LiE(ExtraTabCompletion, Expect):
                         prompt = '> ',
 
                         # This is the command that starts up your program
-                        command = "bash "+ SAGE_LOCAL + "/bin/lie",
+                        command = f"bash { SAGE_LOCAL / 'bin' / 'lie' }",
 
                         server=server,
                         script_subdirectory = script_subdirectory,
```

This would better be rewritten using an `Executable` feature.



---

archive/issue_comments_437705.json:
```json
{
    "body": "Also, as changes like this one indicate:\n\n```\n--- a/src/sage/doctest/sources.py\n+++ b/src/sage/doctest/sources.py\n@@ -87,8 +87,8 @@ def get_basename(path):\n     root = os.path.dirname(path)\n     # If the file is in the sage library, we can use our knowledge of\n     # the directory structure\n-    dev = SAGE_SRC\n-    sp = SAGE_LIB\n+    dev = str(SAGE_SRC)\n+    sp = str(SAGE_LIB)\n     if path.startswith(dev):\n         # there will be a branch name\n         i = path.find(os.path.sep, len(dev))\n```\n\nThe change of the type of the variables is not backwards-compatible (although in some contexts you can use path like a string). So there is a danger of breaking user code.",
    "created_at": "2021-01-25T20:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437705",
    "user": "mkoeppe"
}
```

Also, as changes like this one indicate:

```
--- a/src/sage/doctest/sources.py
+++ b/src/sage/doctest/sources.py
@@ -87,8 +87,8 @@ def get_basename(path):
     root = os.path.dirname(path)
     # If the file is in the sage library, we can use our knowledge of
     # the directory structure
-    dev = SAGE_SRC
-    sp = SAGE_LIB
+    dev = str(SAGE_SRC)
+    sp = str(SAGE_LIB)
     if path.startswith(dev):
         # there will be a branch name
         i = path.find(os.path.sep, len(dev))
```

The change of the type of the variables is not backwards-compatible (although in some contexts you can use path like a string). So there is a danger of breaking user code.



---

archive/issue_comments_437706.json:
```json
{
    "body": "I agree, that some of the code can be further refactored and e.g. moved to the feature module. However, this only changes the location of code such as `SAGE_LOCAL + \"/bin/lie\"` and thus it is still advantageous to have `SAGE_LOCAL` as path.\n\nWhat do you propose to do about the backward-compatibility? What are sage's conventions concerning breaking changes (especially concerning relatively internal things like sage.env)?",
    "created_at": "2021-01-25T21:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437706",
    "user": "@tobiasdiez"
}
```

I agree, that some of the code can be further refactored and e.g. moved to the feature module. However, this only changes the location of code such as `SAGE_LOCAL + "/bin/lie"` and thus it is still advantageous to have `SAGE_LOCAL` as path.

What do you propose to do about the backward-compatibility? What are sage's conventions concerning breaking changes (especially concerning relatively internal things like sage.env)?



---

archive/issue_comments_437707.json:
```json
{
    "body": "It's really very simple:\nWe have a low-level interface (`sage.env`), we have a high-level interface (`sage.features`). It is not a clear improvement to make the existing low-level interface slightly higher-level. Instead, improve code that uses the low-level interface by using the high-level interface instead.",
    "created_at": "2021-01-25T23:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437707",
    "user": "mkoeppe"
}
```

It's really very simple:
We have a low-level interface (`sage.env`), we have a high-level interface (`sage.features`). It is not a clear improvement to make the existing low-level interface slightly higher-level. Instead, improve code that uses the low-level interface by using the high-level interface instead.



---

archive/issue_comments_437708.json:
```json
{
    "body": "There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). All of these calls profit from the strengthen of the interface to use pathlib. Even if refactoring to sage.features would remove half of them, that's still a huge number of string -> path conversions that have to be repeatedly done in many places. So why not fix this at the origin?",
    "created_at": "2021-01-25T23:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437708",
    "user": "@tobiasdiez"
}
```

There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). All of these calls profit from the strengthen of the interface to use pathlib. Even if refactoring to sage.features would remove half of them, that's still a huge number of string -> path conversions that have to be repeatedly done in many places. So why not fix this at the origin?



---

archive/issue_comments_437709.json:
```json
{
    "body": "Replying to [comment:29 gh-tobiasdiez]:\n> What are sage's conventions concerning breaking changes \n\nWe use the deprecation mechanism if we have to make incompatible changes.\n\nHard to do use deprecation here - which is another reason why this old interface (`sage.env`) is best left alone.",
    "created_at": "2021-01-26T01:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437709",
    "user": "mkoeppe"
}
```

Replying to [comment:29 gh-tobiasdiez]:
> What are sage's conventions concerning breaking changes 

We use the deprecation mechanism if we have to make incompatible changes.

Hard to do use deprecation here - which is another reason why this old interface (`sage.env`) is best left alone.



---

archive/issue_comments_437710.json:
```json
{
    "body": "Replying to [comment:26 mkoeppe]:\n> `SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.\n\nFor reference - #30818",
    "created_at": "2021-01-26T18:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437710",
    "user": "mkoeppe"
}
```

Replying to [comment:26 mkoeppe]:
> `SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.

For reference - #30818



---

archive/issue_comments_437711.json:
```json
{
    "body": "Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). So it is natural that many place in sage will access this information. And I don't understand why you don't want to have an universal check for basic consistency (paths specified exist, boolean flags are yes/no etc). Right now these things are checked in various places, leading to code duplication and additional work for maintenance.\n\nFor deprecation, that's possible using a wrapper around `Path` and `str` that prints warning messages if the string-methods are used (similar to https://stackoverflow.com/questions/922550/how-to-mark-a-global-as-deprecated-in-python)",
    "created_at": "2021-01-30T10:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437711",
    "user": "@tobiasdiez"
}
```

Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). So it is natural that many place in sage will access this information. And I don't understand why you don't want to have an universal check for basic consistency (paths specified exist, boolean flags are yes/no etc). Right now these things are checked in various places, leading to code duplication and additional work for maintenance.

For deprecation, that's possible using a wrapper around `Path` and `str` that prints warning messages if the string-methods are used (similar to https://stackoverflow.com/questions/922550/how-to-mark-a-global-as-deprecated-in-python)



---

archive/issue_comments_437712.json:
```json
{
    "body": "Replying to [comment:34 gh-tobiasdiez]:\n> Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). \n\nSee comment 4. \n`sage.env` is a low-level interface - a thin wrapper around os.environ, combining environment variables and `sage_conf` and simple fallbacks. It maps string keys to strings. \n\nAdding complexity there is not an improvement.\n\n`sage.features` was designed to provide a high-level interface to the system environment of sagelib (#20382).\n\nIt already does what it seems you are trying to introduce in `sage.env`: It is typed and it implements filesystem lookups.",
    "created_at": "2021-01-30T16:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437712",
    "user": "mkoeppe"
}
```

Replying to [comment:34 gh-tobiasdiez]:
> Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). 

See comment 4. 
`sage.env` is a low-level interface - a thin wrapper around os.environ, combining environment variables and `sage_conf` and simple fallbacks. It maps string keys to strings. 

Adding complexity there is not an improvement.

`sage.features` was designed to provide a high-level interface to the system environment of sagelib (#20382).

It already does what it seems you are trying to introduce in `sage.env`: It is typed and it implements filesystem lookups.



---

archive/issue_comments_437713.json:
```json
{
    "body": "Replying to [comment:31 gh-tobiasdiez]:\n> There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). \n\n`git grep 'join(SAGE' src/sage | grep -v 'sage:' ` (ignoring lines that are in doctests!) gives 97 hits, which will need review. That's really just a small remainder of refactoring work that has already been done in the past few years.\n\nFor example, all places using `SAGE_EXTCODE` would be changed by #31306.",
    "created_at": "2021-01-30T18:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437713",
    "user": "mkoeppe"
}
```

Replying to [comment:31 gh-tobiasdiez]:
> There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). 

`git grep 'join(SAGE' src/sage | grep -v 'sage:' ` (ignoring lines that are in doctests!) gives 97 hits, which will need review. That's really just a small remainder of refactoring work that has already been done in the past few years.

For example, all places using `SAGE_EXTCODE` would be changed by #31306.



---

archive/issue_comments_437714.json:
```json
{
    "body": "And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? And why is it not helpful for this if these variables are Paths?",
    "created_at": "2021-01-30T18:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437714",
    "user": "@tobiasdiez"
}
```

And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? And why is it not helpful for this if these variables are Paths?



---

archive/issue_comments_437715.json:
```json
{
    "body": "Replying to [comment:37 gh-tobiasdiez]:\n> And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? \n\n`sage.features.Executable` uses `PATH`. See #31296 for a proposed improvement.\n\n`sage.features.StaticFile` uses a customizable search path, which defaults to `SAGE_SHARE` - this probably needs a better design, as we are moving away from assumptions related to the installation scheme of the Sage distribution.\n\n> And why is it not helpful for this if these variables are Paths?\n\nThat's not how this works. A proposed change needs to be sufficiently motivated - what problem is the ticket trying to solve?  In particular, convincing motivation is necessary when breaking changes to the interface are proposed or the complexity of the code is increased by the change.\n\n`pathlib` is nice, but I don't think there is any sort of consensus in the Python community that it is \"better\" than `os.path`. It's just a matter of preferences.",
    "created_at": "2021-01-30T19:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437715",
    "user": "mkoeppe"
}
```

Replying to [comment:37 gh-tobiasdiez]:
> And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? 

`sage.features.Executable` uses `PATH`. See #31296 for a proposed improvement.

`sage.features.StaticFile` uses a customizable search path, which defaults to `SAGE_SHARE` - this probably needs a better design, as we are moving away from assumptions related to the installation scheme of the Sage distribution.

> And why is it not helpful for this if these variables are Paths?

That's not how this works. A proposed change needs to be sufficiently motivated - what problem is the ticket trying to solve?  In particular, convincing motivation is necessary when breaking changes to the interface are proposed or the complexity of the code is increased by the change.

`pathlib` is nice, but I don't think there is any sort of consensus in the Python community that it is "better" than `os.path`. It's just a matter of preferences.



---

archive/issue_comments_437716.json:
```json
{
    "body": "Changing component from refactoring to interfaces: optional.",
    "created_at": "2021-01-30T20:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437716",
    "user": "@tobiasdiez"
}
```

Changing component from refactoring to interfaces: optional.



---

archive/issue_comments_437717.json:
```json
{
    "body": "Replying to [comment:38 mkoeppe]:\n> what problem is the ticket trying to solve?\n\nThe idea was to provide basic existence and consistency checks that would apply to all path-based env variables. Since this is apparently not desired, let's close this ticket to not spent more time discussing this.",
    "created_at": "2021-01-30T20:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437717",
    "user": "@tobiasdiez"
}
```

Replying to [comment:38 mkoeppe]:
> what problem is the ticket trying to solve?

The idea was to provide basic existence and consistency checks that would apply to all path-based env variables. Since this is apparently not desired, let's close this ticket to not spent more time discussing this.



---

archive/issue_comments_437718.json:
```json
{
    "body": "In any case, the discussion was fruitful as it led to creating tickets #31291, #31292, #31293, #31296, #31306. Any work on these tickets would be very welcome!",
    "created_at": "2021-01-30T20:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437718",
    "user": "mkoeppe"
}
```

In any case, the discussion was fruitful as it led to creating tickets #31291, #31292, #31293, #31296, #31306. Any work on these tickets would be very welcome!



---

archive/issue_comments_437719.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-30T20:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437719",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_437720.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-08-26T02:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30618#issuecomment-437720",
    "user": "mkoeppe"
}
```

Resolution: invalid
