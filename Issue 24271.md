# Issue 24271: py3: problems with tests that use random_element

archive/issues_024271.json:
```json
{
    "body": "Lots and lots of tests fail on Python 3 due to the use of `random_element`s in tests.\n\nThe problem, I've found, is not to do with seeding the RNG.  Python's `random` produces the same sequence with the same seed on Python 2 and 3.  However, there is a slight difference in the implementation of `random.randint`, such that it does produce different values, annoyingly.\n\nI'm not sure how we want to deal with this.  In Sage there's a `sage.misc.prandom` that for some reason provides wrappers around functions from Python's `random` module.  Perhaps one thing we could do is ensure that `sage.misc.prandom` is always used, and modify its wrapper to `randint` (actually `randrange`, which `randint` is implemented on top of), to provide consistent results.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24508\n\n",
    "created_at": "2018-01-10T13:58:57Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "py3: problems with tests that use random_element",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24271",
    "user": "embray"
}
```
Lots and lots of tests fail on Python 3 due to the use of `random_element`s in tests.

The problem, I've found, is not to do with seeding the RNG.  Python's `random` produces the same sequence with the same seed on Python 2 and 3.  However, there is a slight difference in the implementation of `random.randint`, such that it does produce different values, annoyingly.

I'm not sure how we want to deal with this.  In Sage there's a `sage.misc.prandom` that for some reason provides wrappers around functions from Python's `random` module.  Perhaps one thing we could do is ensure that `sage.misc.prandom` is always used, and modify its wrapper to `randint` (actually `randrange`, which `randint` is implemented on top of), to provide consistent results.



Issue created by migration from https://trac.sagemath.org/ticket/24508





---

archive/issue_comments_339811.json:
```json
{
    "body": "Also worth pointing out: There were good reasons to change the implementation, AFAICT, as some bugs were addressed.  So using the Python 3 implementation might be better.  However, that would mean fixing hundreds, possibly thousands of tests, so maybe it's not such a good idea (or maybe the Python 2 implementation should be used only in testing or something).",
    "created_at": "2018-01-10T14:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339811",
    "user": "embray"
}
```

Also worth pointing out: There were good reasons to change the implementation, AFAICT, as some bugs were addressed.  So using the Python 3 implementation might be better.  However, that would mean fixing hundreds, possibly thousands of tests, so maybe it's not such a good idea (or maybe the Python 2 implementation should be used only in testing or something).



---

archive/issue_comments_339812.json:
```json
{
    "body": "there is also an issue about\n\n```\nsrc/sage/interfaces/interface.py: \n       return long(randstate().seed()&0x1FFFFFFF)\n```\n\nthat I have already point out elsewhere",
    "created_at": "2018-01-10T15:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339812",
    "user": "chapoton"
}
```

there is also an issue about

```
src/sage/interfaces/interface.py: 
       return long(randstate().seed()&0x1FFFFFFF)
```

that I have already point out elsewhere



---

archive/issue_comments_339813.json:
```json
{
    "body": "What's really the problem there?  I think the `long()` can just be dropped.",
    "created_at": "2018-01-10T15:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339813",
    "user": "embray"
}
```

What's really the problem there?  I think the `long()` can just be dropped.



---

archive/issue_comments_339814.json:
```json
{
    "body": "well, nobody tried to drop it (not me at least)",
    "created_at": "2018-01-10T15:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339814",
    "user": "chapoton"
}
```

well, nobody tried to drop it (not me at least)



---

archive/issue_comments_339815.json:
```json
{
    "body": "It's gone in my branch. I don't think it has anything to do with this problem.",
    "created_at": "2018-01-10T16:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339815",
    "user": "embray"
}
```

It's gone in my branch. I don't think it has anything to do with this problem.



---

archive/issue_comments_339816.json:
```json
{
    "body": "Here's a possible workaround for this issue.  This is far from ideal in that it wholesale copy/pastes the Python 2 implementation of `random.Random`.  Hypothetically we could get away with copying only smaller sections, but this seemed like the most practical and sure to be consistent solution.\n\nThis is also not great since we should be testing against the real `random.Random` implementation being used at runtime.  I think that for the sake of initial porting of Python 3 this is acceptable, however, and the likelihood of bugs specific to the `Random` implementation are low.  This can be removed once Sage drops Python 2 support, whenever that happens...\n----\nNew commits:",
    "created_at": "2018-02-20T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339816",
    "user": "embray"
}
```

Here's a possible workaround for this issue.  This is far from ideal in that it wholesale copy/pastes the Python 2 implementation of `random.Random`.  Hypothetically we could get away with copying only smaller sections, but this seemed like the most practical and sure to be consistent solution.

This is also not great since we should be testing against the real `random.Random` implementation being used at runtime.  I think that for the sake of initial porting of Python 3 this is acceptable, however, and the likelihood of bugs specific to the `Random` implementation are low.  This can be removed once Sage drops Python 2 support, whenever that happens...
----
New commits:



---

archive/issue_comments_339817.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-20T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339817",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339818.json:
```json
{
    "body": "I confirmed that this fixed most tests that were known to be failing due to this issue (of which there were quite a lot).",
    "created_at": "2018-02-20T12:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339818",
    "user": "embray"
}
```

I confirmed that this fixed most tests that were known to be failing due to this issue (of which there were quite a lot).



---

archive/issue_comments_339819.json:
```json
{
    "body": "1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.\n\n2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`",
    "created_at": "2018-03-12T00:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339819",
    "user": "jdemeyer"
}
```

1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.

2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`



---

archive/issue_comments_339820.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-03-12T00:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339820",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_339821.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> 1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.\n\nI considered that--it seemed unlikely considering that through Python 2.7.14 this has never been an issue, and most non-essential fixes are not being backported to Python 2.\n\nThen again, Python 2 will still be receiving security-related fixes for a while, and the `random` module is definitely a potential target for security fixes, so indeed it might be worth pinning even for Python 2.\n\n> 2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`\n\nA minor point but true.",
    "created_at": "2018-03-12T13:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339821",
    "user": "embray"
}
```

Replying to [comment:8 jdemeyer]:
> 1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.

I considered that--it seemed unlikely considering that through Python 2.7.14 this has never been an issue, and most non-essential fixes are not being backported to Python 2.

Then again, Python 2 will still be receiving security-related fixes for a while, and the `random` module is definitely a potential target for security fixes, so indeed it might be worth pinning even for Python 2.

> 2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`

A minor point but true.



---

archive/issue_comments_339822.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2018-03-12T13:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339822",
    "user": "embray"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_339823.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-13T22:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339823",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_339824.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-13T22:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339824",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_339825.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-13T22:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339825",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_339826.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-23T13:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339826",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339827.json:
```json
{
    "body": "Patchbot suggests that \"plugins failed\" but it's completely non-obvious from the output what plugins failed...",
    "created_at": "2018-05-02T18:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339827",
    "user": "embray"
}
```

Patchbot suggests that "plugins failed" but it's completely non-obvious from the output what plugins failed...



---

archive/issue_comments_339828.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-08T17:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24271#issuecomment-339828",
    "user": "vbraun"
}
```

Resolution: fixed
