# Issue 24271: py3: problems with tests that use random_element

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-01-10 13:58:57

Lots and lots of tests fail on Python 3 due to the use of `random_element`s in tests.

The problem, I've found, is not to do with seeding the RNG.  Python's `random` produces the same sequence with the same seed on Python 2 and 3.  However, there is a slight difference in the implementation of `random.randint`, such that it does produce different values, annoyingly.

I'm not sure how we want to deal with this.  In Sage there's a `sage.misc.prandom` that for some reason provides wrappers around functions from Python's `random` module.  Perhaps one thing we could do is ensure that `sage.misc.prandom` is always used, and modify its wrapper to `randint` (actually `randrange`, which `randint` is implemented on top of), to provide consistent results.




---

Comment by embray created at 2018-01-10 14:06:33

Also worth pointing out: There were good reasons to change the implementation, AFAICT, as some bugs were addressed.  So using the Python 3 implementation might be better.  However, that would mean fixing hundreds, possibly thousands of tests, so maybe it's not such a good idea (or maybe the Python 2 implementation should be used only in testing or something).


---

Comment by chapoton created at 2018-01-10 15:26:40

there is also an issue about

```
src/sage/interfaces/interface.py: 
       return long(randstate().seed()&0x1FFFFFFF)
```

that I have already point out elsewhere


---

Comment by embray created at 2018-01-10 15:40:30

What's really the problem there?  I think the `long()` can just be dropped.


---

Comment by chapoton created at 2018-01-10 15:50:10

well, nobody tried to drop it (not me at least)


---

Comment by embray created at 2018-01-10 16:35:59

It's gone in my branch. I don't think it has anything to do with this problem.


---

Comment by embray created at 2018-02-20 12:53:01

Here's a possible workaround for this issue.  This is far from ideal in that it wholesale copy/pastes the Python 2 implementation of `random.Random`.  Hypothetically we could get away with copying only smaller sections, but this seemed like the most practical and sure to be consistent solution.

This is also not great since we should be testing against the real `random.Random` implementation being used at runtime.  I think that for the sake of initial porting of Python 3 this is acceptable, however, and the likelihood of bugs specific to the `Random` implementation are low.  This can be removed once Sage drops Python 2 support, whenever that happens...
----
New commits:


---

Comment by embray created at 2018-02-20 12:53:01

Changing status from new to needs_review.


---

Comment by embray created at 2018-02-20 12:53:46

I confirmed that this fixed most tests that were known to be failing due to this issue (of which there were quite a lot).


---

Comment by jdemeyer created at 2018-03-12 00:01:32

1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.

2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`


---

Comment by jdemeyer created at 2018-03-12 00:01:32

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-03-12 13:31:06

Replying to [comment:8 jdemeyer]:
> 1. Shouldn't you use `_py2_random.py` also on Python 2? Then you are sure that doctests will remain consistent, independently of any future changes to the upstream `random` module.

I considered that--it seemed unlikely considering that through Python 2.7.14 this has never been an issue, and most non-essential fixes are not being backported to Python 2.

Then again, Python 2 will still be receiving security-related fixes for a while, and the `random` module is definitely a potential target for security fixes, so indeed it might be worth pinning even for Python 2.

> 2. You can optimize `if self._python_random is not None and type(self._python_random) is cls:` to `type(self._python_random) is cls:`

A minor point but true.


---

Comment by embray created at 2018-03-12 13:31:22

Changing status from needs_info to needs_work.


---

Comment by git created at 2018-03-13 22:15:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-13 22:15:23

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-03-13 22:15:23

New commits:


---

Comment by jdemeyer created at 2018-04-23 13:46:26

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-05-02 18:22:09

Patchbot suggests that "plugins failed" but it's completely non-obvious from the output what plugins failed...


---

Comment by vbraun created at 2018-05-08 17:26:48

Resolution: fixed
