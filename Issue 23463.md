# Issue 23463: update gc to version 7.6

Issue created by migration from https://trac.sagemath.org/ticket/23700

Original creator: dimpase

Original creation time: 2017-08-24 13:58:07

CC:  fbissey embray

An update to gc is needed to support arm64/aarch64, see #23687.

The source is here: http://www.hboehm.info/gc/gc_source/gc-7.6.0.tar.gz

On some platforms this new version also needs libatomic_ops.


---

Comment by git created at 2017-08-24 15:09:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-08-24 15:16:33

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-08-24 15:16:33

Erik, could you please check whether this works on Cygwin without your patch?

(one need #23701 first, and re-running `./configure` to register the new package)


---

Comment by embray created at 2017-08-25 15:33:57

Ah, yes. I remember this.  I'll give it a go.


---

Comment by embray created at 2017-08-25 15:44:31

I think this branch needs to be updated on the latest version of #23701 since it's using 7.4.6 and this branch is using 7.4.4.


---

Comment by git created at 2017-08-25 15:46:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-08-25 15:47:15

You're right - done now.


---

Comment by embray created at 2017-08-25 15:57:01

Thanks--now it's working. Or at least, it's building.  Can't say anything about tests right now.


---

Comment by dimpase created at 2017-08-30 12:09:16

on FreeBSD this needs the patch fixing https://github.com/ivmai/bdwgc/issues/132


---

Comment by git created at 2017-08-30 14:09:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-09-28 03:51:59

On Linux tests pass, but I can trigger a nasty crash interactively:

```
sage: from sage.libs.ecl import *
sage: from sage.interfaces.maxima_lib import <TAB>
```

Debian [experimental uses gc 7.4.4](https://people.debian.org/~thansen/debian-sage-status.html), so this would be one to test for this regression, too.


---

Comment by dimpase created at 2017-09-28 03:51:59

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2017-09-28 08:59:33

With GC included in ECL (tagged version 7.5.0 in ECL source, although I haven't checked how canonical this is) I do get the crash in comment 11.


---

Comment by git created at 2017-10-03 10:13:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-10-03 10:17:05

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-09 12:04:34

Turns out this is still not building properly on Cygwin.  It fails to produce a shared lib at link time:


```
/bin/sh ./libtool  --tag=CC   --mode=link gcc   -fexceptions -Wall -Wextra -O2 -g  -fno-strict-aliasing  -version-info 1:3:0 -no-undefined -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib  -o libgc.la -rpath /home/embray/src/sagemath/sage/local/lib allchblk.lo alloc.lo blacklst.lo checksums.lo dbg_mlc.lo dyn_load.lo finalize.lo gc_dlopen.lo gcj_mlc.lo headers.lo mach_dep.lo malloc.lo mallocx.lo mark.lo mark_rts.lo misc.lo new_hblk.lo obj_map.lo os_dep.lo pcr_interface.lo ptr_chck.lo real_malloc.lo reclaim.lo specific.lo stubborn.lo thread_local_alloc.lo typd_mlc.lo win32_threads.lo     fnlz_mlc.lo    -L/home/embray/src/sagemath/sage/local/lib -latomic_ops
mv -f cord/.deps/libcord_la-cordxtra.Tpo cord/.deps/libcord_la-cordxtra.Plo

*** Warning: linker path does not have real file for library -latomic_ops.
*** I have the capability to make that library automatically link in when
*** you link to this library.  But I can only do this if you have a
*** shared version of the library, which you do not appear to have
*** because I did check the linker path looking for a file starting
*** with libatomic_ops and none of the candidates passed a file format test
*** using a file magic. Last file checked: /home/embray/src/sagemath/sage/local/lib/libatomic_ops.a
*** The inter-library dependencies that have been dropped here will be
*** automatically added whenever a program is linked with this library
*** or is declared to -dlopen it.

*** Since this library must not contain undefined symbols,
*** because either the platform does not support them or
*** it was explicitly requested with -no-undefined,
*** libtool will only create a static version of it.
libtool: link: ar cru .libs/libgc.a  allchblk.o alloc.o blacklst.o checksums.o dbg_mlc.o dyn_load.o finalize.o gc_dlopen.o gcj_mlc.o headers.o mach_dep.o malloc.o mallocx.o mark.o mark_rts.o misc.o new_hblk.o obj_map.o os_dep.o pcr_interface.o ptr_chck.o real_malloc.o reclaim.o specific.o stubborn.o thread_local_alloc.o typd_mlc.o win32_threads.o fnlz_mlc.o
libtool: link: ranlib .libs/libgc.a
libtool: link: ( cd ".libs" && rm -f "libgc.la" && ln -s "../libgc.la" "libgc.la" )
/bin/sh ./libtool  --tag=CC   --mode=link gcc   -fexceptions -Wall -Wextra -O2 -g  -fno-strict-aliasing -version-info 1:3:0 -no-undefined -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib  -o libcord.la -rpath /home/embray/src/sagemath/sage/local/lib cord/libcord_la-cordbscs.lo cord/libcord_la-cordprnt.lo cord/libcord_la-cordxtra.lo ./libgc.la

*** Warning: This system cannot link to static lib archive ./libgc.la.
*** I have the capability to make that library automatically link in when
*** you link to this library.  But I can only do this if you have a
*** shared version of the library, which you do not appear to have.

*** Warning: linker path does not have real file for library -latomic_ops.
*** I have the capability to make that library automatically link in when
*** you link to this library.  But I can only do this if you have a
*** shared version of the library, which you do not appear to have
*** because I did check the linker path looking for a file starting
*** with libatomic_ops and none of the candidates passed a file format test
*** using a file magic. Last file checked: /home/embray/src/sagemath/sage/local/lib/libatomic_ops.a
*** The inter-library dependencies that have been dropped here will be
*** automatically added whenever a program is linked with this library
*** or is declared to -dlopen it.

*** Since this library must not contain undefined symbols,
*** because either the platform does not support them or
*** it was explicitly requested with -no-undefined,
*** libtool will only create a static version of it.
libtool: link: ar cru .libs/libcord.a  cord/libcord_la-cordbscs.o cord/libcord_la-cordprnt.o cord/libcord_la-cordxtra.o
libtool: link: ranlib .libs/libcord.a
libtool: link: ( cd ".libs" && rm -f "libcord.la" && ln -s "../libcord.la" "libcord.la" )
```


It's probably a minor issue with link flag ordering.  I will investigate and provide a solution.


---

Comment by embray created at 2017-10-09 12:04:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-09 14:09:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-10-09 14:10:17

updated the branch to take into account update on #23701


---

Comment by embray created at 2017-10-09 14:15:08

Ah, I should have warned you, I'm about to propose another needed change for #23701.


---

Comment by dimpase created at 2018-01-06 00:22:47

We should go for 7.6.2:
https://github.com/ivmai/bdwgc/releases/tag/v7.6.2
In particular, this includes the patches needed by the FreeBSD port.
I will update this accordingly.


---

Comment by git created at 2018-01-06 01:28:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-06 01:45:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-08 14:31:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2018-01-08 14:33:02

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2018-01-08 14:33:02

OK, another advantage is that all our patches are now upstream!


---

Comment by embray created at 2018-01-10 11:11:53

I'm trying to get this built on Cygwin--will report back with any findings.


---

Comment by embray created at 2018-02-02 14:50:51

IIRC I had some trouble with this on Cygwin (specifically with libatomic_ops), but that was a while ago and I got distracted.  Going to give it another try.


---

Comment by embray created at 2018-02-02 16:05:17

Likewise with ticket:23701#comment:15 would you accept a small update to this for Cygwin?


---

Comment by dimpase created at 2018-02-02 16:29:25

sure


---

Comment by embray created at 2018-02-05 09:56:08

Rebased on top of my updates to #23701 and incorporated a minor change for Cygwin.
----
New commits:


---

Comment by dimpase created at 2018-02-20 16:11:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-21 19:36:47


```
Found local metadata for gc-7.6.2
Using cached file /mnt/disk/home/release/Sage/upstream/gc-7.6.2.tar.gz
gc-7.6.2
====================================================
Setting up build directory for gc-7.6.2
Finished extraction
Applying patches from ../patches...
Applying ../patches/0001-On-Cygwin-use-mprotect-instead-of-mmap-to-set-PROT_N.patch
patching file os_dep.c
Hunk #1 FAILED at 698.
Hunk #2 FAILED at 2404.
Hunk #3 FAILED at 2515.
3 out of 3 hunks FAILED -- saving rejects to file os_dep.c.rej
Error applying '../patches/0001-On-Cygwin-use-mprotect-instead-of-mmap-to-set-PROT_N.patch'
************************************************************************
Error applying patches
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /mnt/disk/home/release/Sage/logs/pkgs/gc-7.6.2.log
Describe your computer, operating system, etc.
************************************************************************
```



---

Comment by vbraun created at 2018-02-21 19:36:47

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2018-02-21 20:19:11

facepalm...
we should bump it up to 7.6.4 anyway.


---

Comment by dimpase created at 2018-02-21 23:21:23

I believe that the failing patch is already in 7.6.4, see
https://github.com/ivmai/bdwgc/commit/be148f4141ab5d6812928a7bceeb2617384e7fe7


---

Comment by dimpase created at 2018-02-21 23:55:49

Last 10 new commits:


---

Comment by dimpase created at 2018-02-21 23:55:49

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-27 09:08:00

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-27 09:08:00

1. `build/pkgs/libatomic_ops/spkg-install`: you are wrongly using "BoehmGC".

2. `build/pkgs/libatomic_ops/spkg-install`: instead of a generic variable like `CONFIGURE_FLAGS`, please use `LIBATOMIC_OPS_CONFIGURE` to be more consistent with other packages.

3. `build/pkgs/libatomic_ops/spkg-check`: there is no longer need for the `if [ -z "$SAGE_LOCAL" ]; then` boilerplate.


---

Comment by dimpase created at 2018-02-27 09:30:19

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2018-02-27 09:30:19

Jeroen, `libatomic_ops` has nothing to do with this ticket. It was #23701.
If you think #23701 needs an improvement please open another ticket.


---

Comment by jdemeyer created at 2018-02-27 09:54:46

They were just minor comments, nothing serious.


---

Comment by jdemeyer created at 2018-02-27 10:46:13

Replying to [comment:38 dimpase]:
> Jeroen, `libatomic_ops` has nothing to do with this ticket. It was #23701.
> If you think #23701 needs an improvement please open another ticket.

To be very precise, the commits which are supposedly from #23701 do not actually appear on the branch at #23701. So this ticket needs to be rebased.


---

Comment by jdemeyer created at 2018-02-27 10:46:13

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-27 10:47:03

There is also the obvious missing dependency

```
[gc-7.6.4] checking for atomic_ops... no
[gc-7.6.4] checking atomic_ops.h usability... no
[gc-7.6.4] checking atomic_ops.h presence... no
[gc-7.6.4] checking for atomic_ops.h... no
[gc-7.6.4] configure: error: libatomic_ops is required.  You can either install it on
[gc-7.6.4]                   your system, or fetch and unpack a recent version into the
[gc-7.6.4]                   source directory and link or rename it to libatomic_ops.
[gc-7.6.4] Error configuring BoehmGC.
```



---

Comment by dimpase created at 2018-02-27 11:07:11

Replying to [comment:41 jdemeyer]:
> There is also the obvious missing dependency
> {{{
> [gc-7.6.4] checking for atomic_ops... no
> [gc-7.6.4] checking atomic_ops.h usability... no
> [gc-7.6.4] checking atomic_ops.h presence... no
> [gc-7.6.4] checking for atomic_ops.h... no
> [gc-7.6.4] configure: error: libatomic_ops is required.  You can either install it on
> [gc-7.6.4]                   your system, or fetch and unpack a recent version into the
> [gc-7.6.4]                   source directory and link or rename it to libatomic_ops.
> [gc-7.6.4] Error configuring BoehmGC.
> }}}

good catch, but how do you get this? OS/compiler?


---

Comment by jdemeyer created at 2018-02-27 11:17:18

Replying to [comment:42 dimpase]:
> OS/compiler?

Doesn't matter. Any OS, any compiler.


---

Comment by git created at 2018-02-27 11:57:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-02-27 11:57:54

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2018-02-27 11:57:54

all fixed, hopefully.


---

Comment by jdemeyer created at 2018-02-27 14:25:09

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-27 14:25:09

1. This branch still needs to be rebased to the branch at #23701.

2. You should replace `CONFIGURE_FLAGS` -> `LIBATOMIC_OPS_CONFIGURE` everywhere in `build/pkgs/libatomic_ops/spkg-install`


---

Comment by git created at 2018-02-27 18:00:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-02-27 18:03:39

I've addressed the comment 46.


---

Comment by dimpase created at 2018-02-27 18:03:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-27 19:41:39

The git history is a total mess now... at least messy enough that I'd like to see it merged with the next beta before considering to review it.


---

Comment by dimpase created at 2018-02-27 19:44:30

well, yes, I tried to rebase, and it was really doing weird stuff, such as creating `LICENSE` file and changing `.gitignore`, so I merged instead.


---

Comment by embray created at 2018-03-02 10:27:53

Perhaps I could try to clean it up?


---

Comment by dimpase created at 2018-03-05 05:43:59

Hopefully it is clean enough now, as the merge of #23701 has happened.


---

Comment by jdemeyer created at 2018-03-06 16:14:12

Replying to [comment:52 dimpase]:
> Hopefully it is clean enough now

It's not cleaner than before since the branch didn't change. The fact that #23701 was merged does mean that the diff is easier to read on Trac.


---

Comment by dimpase created at 2018-03-06 17:45:45

The diff is pretty small now: there are largish patches removed, and the rest it really "admin".

Erik, does the branch work on Cygwin for you now? (You never answered comment 34 above).
The commit in the upstream repo seems to do the same job and is authored by you, but it looks differently---hopefully it does the same thing.


---

Comment by jdemeyer created at 2018-03-06 19:32:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-03-06 19:32:15

Replying to [comment:54 dimpase]:
> The diff is pretty small now

Yes, the diff is small but the history remains ugly: there are several commits on this branch which are really duplicates of commits from #23701.

Now, all that doesn't really matter.


---

Comment by embray created at 2018-03-07 09:48:42

LGTM. My offer still stands to clean up the commit history if desired, but otherwise I'll let it be.


---

Comment by vbraun created at 2018-03-08 00:02:44

Resolution: fixed
