# Issue 14756: Upgrade matplotlib to 1.3.0

Issue created by migration from https://trac.sagemath.org/ticket/14993

Original creator: jason

Original creation time: 2013-07-31 18:08:05

Matplotlib 1.3.0 was released today.  Here is what is new: http://matplotlib.org/1.3.0/users/whats_new.html#new-in-matplotlib-1-3

Of particular note is that pytz, dateutil, and pyparsing are no longer included and need to be installed separately: http://matplotlib.org/1.3.0/users/whats_new.html#new-setup-script


---

Comment by ncohen created at 2013-12-19 19:42:37

I just gave it a try but gave up not very long after
1) Sage patches matplotlib for some libpng detection issue, and this patch does not apply
2) As it only seemed useful on Mac OS X I tried without that patch
3) There is an error during the installation because of some "https" protocol that isn't supported

That's when I lost hope `^^;`

Nathann


---

Comment by jhpalmieri created at 2013-12-20 19:42:05

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2013-12-20 19:42:05

I'm trying to attach the branch `u/jhpalmieri/14993` to this ticket, but trac isn't letting me. I'm attaching a diff, in case it helps with reviewing (and because I find the git/trac interface very slow).

Edit: The branch `u/jhpalmieri/14993` exists, so you can test out my changes, but at the moment I can't attach it to this ticket in the `Branch` field.


---

Attachment

diff file, since I'm having problems uploading the relevant branch...


---

Comment by jhpalmieri created at 2013-12-21 00:22:42

Sorry, I had a typo: it's `u/jhpalmieri/14993` (not `14933`). I can't set the branch to this: it leads to the error mentioned by Travis [on sage-devel](https://groups.google.com/d/topic/sage-devel/_fuMME8gUbk/discussion).


---

Comment by ncohen created at 2013-12-21 09:33:22

HellooooooooooooO !

Could you also provide the .tar.gz files for each package ? I tried to make mine but the hashes don't match, soo... `^^;`

Nathann


---

Comment by jhpalmieri created at 2013-12-21 16:11:32

The links for the tarballs are in the ticket description. Is that what you're looking for?


---

Comment by jhpalmieri created at 2013-12-21 16:12:14

New commits:


---

Comment by ncohen created at 2013-12-22 10:47:41

Helloooooo !

> The links for the tarballs are in the ticket description. Is that what you're looking for?

Ooops sorry, I had not noticed you had updated it.

Well, I gave it another try with those files and this part worked fine, but I still get the error I saw when I first tried it by myself :
http://www.steinertriples.fr/m.log

By the way, for some reason the .log file that Sage claims should be located at /home/ncohen/.Sage/logs/pkgs/matplotlib-1.3.1.log does not exist.. But well `O_o`

Nathann


---

Comment by jhpalmieri created at 2013-12-22 16:12:58

I don't know why the error is occurring, but it looks like it is happening because of downloading the `distribute` package. 

On one hand, I think if you updated `setuptools` (that is, ticket #15510), it would avoid this error. On the other hand, updating `setuptools` will cause problems with building and (if you get past that) doctesting the notebook.

Maybe you can try downloading and installing `distribute` manually:

```
curl -O http://pypi.python.org/packages/source/d/distribute/distribute-0.6.28.tar.gz
tar xfz distribute-0.6.28.tar.gz
cd distribute-0.6.28
sage -sh
python setup.py install
exit
```

?


---

Comment by ncohen created at 2013-12-22 16:30:47

HMmmm... Well I prefer to keep my Sage install "bad", this way I will really be able to check whether this patch is okay when I will test it. If I install distribute I guess I won't be able to come back without recompiling Sage from scratch. So I guess my distribution is more useful, broken, to test this ticket `:-D`

Nathann


---

Comment by jhpalmieri created at 2013-12-24 06:20:34

Now #15510 should be okay to install, along with the new sagenb (#15569).


---

Comment by fbissey created at 2013-12-26 20:02:21

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2013-12-26 20:02:21

I have been using it in sage-on-gentoo not long after it was released. There is no problem with it. The only issue here is because of matplotlib unbundling we have so many packages coming. I am positiving this.


---

Comment by ncohen created at 2013-12-26 20:09:01

Hmmmmmmm `O_o`

And so you have no problem with `distribute` it seems `O_o`

Nathann


---

Comment by fbissey created at 2013-12-26 22:18:29

I am cheating but going to a version of setuptools that is that recent is not necessary I believe but you need something more recent than 0.6.16 that I and Steve Trogdon put in sage for the upgrade to python 2.7 in sage 5.0 :)
You can blame me for the current version of setuptools in sage.


---

Comment by ncohen created at 2013-12-27 09:11:05

Oh, you think it is solved by #15510 and #15569 ? I'll try !

Nathann


---

Comment by vbraun created at 2014-01-31 23:13:39

Merge conflict in build/pkgs/sagenb/checksums.ini, please fix


---

Comment by git created at 2014-01-31 23:35:32

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-01-31 23:35:32

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by jhpalmieri created at 2014-01-31 23:36:44

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2014-01-31 23:36:44

That should take care of it.


---

Comment by vbraun created at 2014-02-01 21:31:49

Fails to install with an infinite recursion

```
[...]
                libagg: yes [pkg-config information for 'libagg' could not
                        be found. Using local copy.]
              freetype: yes [version 17.1.11]
Traceback (most recent call last):
  File "setup.py", line 148, in <module>
    result = package.check()
  File "/home/release/Sage/local/var/tmp/sage/build/matplotlib-1.3.1/src/setupext.py", line 915, in check
    min_version='1.2')
  File "/home/release/Sage/local/var/tmp/sage/build/matplotlib-1.3.1/src/setupext.py", line 434, in _check_for_pkg_config
    ext = self.get_extension()
  File "/home/release/Sage/local/var/tmp/sage/build/matplotlib-1.3.1/src/setupext.py", line 925, in get_extension
    if self.check().find('Using unknown') == -1:
  File "/home/release/Sage/local/var/tmp/sage/build/matplotlib-1.3.1/src/setupext.py", line 915, in check
    min_version='1.2')
  File "/home/release/Sage/local/var/tmp/sage/build/matplotlib-1.3.1/src/setupext.py", line 434, in _check_for_pkg_config
[... repeat unil recursion limit...]
```



---

Comment by fbissey created at 2014-02-02 02:01:06

Very strange. Is pkg-config on the machine? That's the only thing I can think of looking at the code.


---

Comment by vbraun created at 2014-02-11 15:16:15

Yes, pkg-config is installed like on every modern machine.


---

Comment by fbissey created at 2014-02-24 01:30:01

I think we should try to drop the setupext.py patch. I think it is responsible for the problem Volker sees and I am not sure why it is needed at all.
If we end up with a problem without it, then ok we patch but in this case it will need revision. Even so I am not sure how it generates the recursion.


---

Comment by jhpalmieri created at 2014-02-24 03:28:25

I think that's a fine idea, but I don't have time to work on it right now. Can someone else produce a new version to see if that fixes Volker's problem (and also whether it builds on OS X)?


---

Comment by fbissey created at 2014-02-24 09:31:32

OK so I tried things out a little bit. I reproduced Volker's problem locally (yuck). Removing setupext.py.patch enabled it to build and install on my linux x86_64 box. For various reasons I won't be starting testing things on maverick before Wednesday (OK Tuesday for most of you).


---

Comment by jason created at 2014-02-24 13:54:42

I guess the big question is if it will build and work on an OS X machine without pkg-config.

What's the status of Sage distributing pkg-config as a standard package?  That would make the patch a moot point.


---

Comment by fbissey created at 2014-02-25 00:28:47

There was an easier way of checking that. I renamed the pkg-config executable(s) on my system and tried to re-install matplotlib. It failed. So we either need a work around or make pkg-config a dependency of this ticket. I am favouring the later.


---

Comment by fbissey created at 2014-02-25 07:29:20

Also if we really want to patch, let's just not make it as a fallback but as a full blown configuration. After all the default you feed to build on OS X are just as valid on other platforms. I also notice that the building recommendations for matplotlib upstream for OS X will lead you to have pkg-config installed, either explicitly or as a dependency.


---

Comment by fbissey created at 2014-02-26 02:43:32

Actually I am not even sure how that patch is supposed to work on OS X, feels fishy to me. It certainly fail with that patch if I hide pkg-config.


---

Comment by fbissey created at 2014-02-26 08:56:24

Just confirmed, this doesn't work on my maverick laptop.


---

Comment by vbraun created at 2014-02-26 10:03:33

IMHO pkgconfig #15742 is ready to be merged. Just to clarify, Maverics with pkgconfig works for you?


---

Comment by fbissey created at 2014-02-26 10:05:14

Didn't try that but I don't see how it wouldn't. Probably no time to test this tonight but will endeavour to do it sometimes tomorrow (past 11pm in my time zone).


---

Comment by fbissey created at 2014-02-26 10:06:22

Of course using pkg-config this ticket needs updating to reflect the dependency and remove the patch. I guess it needs a clean up.


---

Comment by fbissey created at 2014-02-27 09:05:45

OK so #15742 is a good help here. With it we can remove the setupext.py.patch and things install as they are meant too. I am not quite ready to make and push the two changes needed for this ticket:
 * Add pkgconf to matplotlib's dependencies
 * Remove the patch
I'll give this a positive review if those things are done by someone else before me.


---

Comment by jhpalmieri created at 2014-02-27 16:16:39

This fixes one or two other things: it adds licensing information for the new packages (tornado, etc.), it updates licensing information for matplotlib, it removes discussion of the deleted patch from SPKG.txt, and it fixes an error of mine in spkg-install.
----
New commits:


---

Comment by vbraun created at 2014-02-27 21:28:37

Resolution: fixed


---

Comment by vbraun created at 2014-02-28 13:33:17

Resolution changed from fixed to 


---

Comment by vbraun created at 2014-02-28 13:33:17

Changing status from closed to new.


---

Comment by vbraun created at 2014-02-28 13:33:17

Fails on SPARC Solaris:

```
/home/buildbot/build/sage/mark-1/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include/numpy/npy_deprecated_api.h:11:2: warning: #warning "Using deprecated NumPy API, disable it by #defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-Wcpp]
In file included from lib/matplotlib/tri/_tri.cpp:8:0:
lib/matplotlib/tri/_tri.h:821:33: error: expected unqualified-id before numeric constant
lib/matplotlib/tri/_tri.cpp: In constructor 'RandomNumberGenerator::RandomNumberGenerator(long unsigned int)':
lib/matplotlib/tri/_tri.cpp:2180:28: error: expected identifier before numeric constant
lib/matplotlib/tri/_tri.cpp:2180:28: error: expected '{' before numeric constant
lib/matplotlib/tri/_tri.cpp: At global scope:
lib/matplotlib/tri/_tri.cpp:2180:28: error: expected unqualified-id before numeric constant
error: command 'gcc' failed with exit status 1
```

See http://build.sagemath.org/sage/builders/%20%20slow%20Skynet%20mark%20%28SunOS%205.10-32%29%20incremental/builds/26/steps/compile/logs/matplotlib


---

Comment by fbissey created at 2014-02-28 18:40:48

Hum, compiling c++ with a c compiler as well that was potential trouble anyway. Who has contact upstream?


---

Comment by vbraun created at 2014-02-28 20:34:03

Fixed in this commit: https://github.com/matplotlib/matplotlib/pull/2464


---

Comment by jhpalmieri created at 2014-02-28 21:38:55

Okay, I've imported their patch.
----
New commits:


---

Comment by jhpalmieri created at 2014-02-28 21:38:55

Changing status from new to needs_review.


---

Comment by git created at 2014-02-28 22:24:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-03-15 06:38:26

Hum - oops let it slip. Now that all is well let's put it back to positive :)


---

Comment by fbissey created at 2014-03-15 06:38:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-03-19 18:27:22

Resolution: fixed


---

Comment by aschilling created at 2014-03-29 16:31:29

This ticket seems to cause massive problems with view, dot2tex and latex. None of the crystal viewing tools work any longer! See comments on http://trac.sagemath.org/ticket/16026 . For example

```
d184:sage anne$ sage -i dot2tex
Attempting to download package dot2tex
>>> Checking online list of optional packages.
[.]
>>> Found dot2tex-2.8.7.p2
Package dot2tex-2.8.7.p2 is already installed.
Use 'sage -f http://www.sagemath.org/spkg/optional/dot2tex-2.8.7.p2.spkg' to force a reinstallation.
d184:sage anne$ sage
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.2.beta5, Release Date: 2014-03-23                   │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: C = KirillovReshetikhinCrystal(['A',5,2], 3,1)
sage: view(C)
dot2tex not available.  Install after running 'sage -sh'
```



---

Comment by bsalisbury1 created at 2014-03-29 16:43:56

I am having the same problem as Anne.


```
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.2.beta5, Release Date: 2014-03-23                   │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: C = crystals.Tableaux("B2",shape=[2,1])
sage: view(C)
dot2tex not available.  Install after running 'sage -sh'
sage: quit
BenBook:sage-git Ben$ sage -i dot2tex
Found package dot2tex in /Users/Ben/sage-git/upstream/dot2tex-2.8.7.p2.spkg
Package dot2tex-2.8.7.p2 is already installed.
```


The same problem also occurred after a forced reinstallation of dot2tex using `sage -i -f dot2tex`.  It should be noted that this problem only occurred after the upgrade from 6.2.beta4 to 6.2.beta5.


---

Comment by kcrisman created at 2014-04-02 16:40:02

Note that #16047 is adding a patch to matplotlib (already in upstream) so if there is something similar to do to fix this crystal viewing problem with dot2tex one could add it at the same time.


---

Comment by aschilling created at 2014-04-02 20:10:45

Replying to [comment:50 kcrisman]:
> Note that #16047 is adding a patch to matplotlib (already in upstream) so if there is something similar to do to fix this crystal viewing problem with dot2tex one could add it at the same time.

The KR problem with dot2tex was fixed in #16026.
