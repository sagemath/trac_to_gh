# Issue 22371: Remove PYTHONPATH environment variable from sage

archive/issues_022371.json:
```json
{
    "body": "CC:  @videlec @embray\n\nKeywords: PYTHONPATH\n\nFollowing sage-devel PYTHONPATH breaks Python3[https://groups.google.com/forum/#!topic/sage-devel/ITtF1vWIxIk](https://groups.google.com/forum/#!topic/sage-devel/ITtF1vWIxIk)\n\nHaving PYTHONPATH sets as an environment variable is reported to be incompatible with the installation of both Python2 and Python3 and with the use of gdb to debug.\n\nWe should remove the setting of the PYTHONPATH environment variable\n\nIssue created by migration from https://trac.sagemath.org/ticket/22608\n\n",
    "created_at": "2017-03-15T17:58:05Z",
    "labels": [
        "misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Remove PYTHONPATH environment variable from sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22371",
    "user": "@vinklein"
}
```
CC:  @videlec @embray

Keywords: PYTHONPATH

Following sage-devel PYTHONPATH breaks Python3[https://groups.google.com/forum/#!topic/sage-devel/ITtF1vWIxIk](https://groups.google.com/forum/#!topic/sage-devel/ITtF1vWIxIk)

Having PYTHONPATH sets as an environment variable is reported to be incompatible with the installation of both Python2 and Python3 and with the use of gdb to debug.

We should remove the setting of the PYTHONPATH environment variable

Issue created by migration from https://trac.sagemath.org/ticket/22608





---

archive/issue_comments_311022.json:
```json
{
    "body": "Set assignee to @vinklein.",
    "created_at": "2017-03-15T18:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311022",
    "user": "@vinklein"
}
```

Set assignee to @vinklein.



---

archive/issue_comments_311023.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-16T22:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311023",
    "user": "@vinklein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_311024.json:
```json
{
    "body": "Note to reviewer : the doctest in all.py has been modified. I choose to modify allowed.append(os.path.join(\"lib\", \"python\", \"multiprocessing\")) into allowed.append(os.path.join(\"multiprocessing\")) rather than allowed.append(os.path.join(\"lib\", \"python2.7\", \"multiprocessing\")) in order to stay compatible with future python version. \n----\nNew commits:",
    "created_at": "2017-03-16T22:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311024",
    "user": "@vinklein"
}
```

Note to reviewer : the doctest in all.py has been modified. I choose to modify allowed.append(os.path.join("lib", "python", "multiprocessing")) into allowed.append(os.path.join("multiprocessing")) rather than allowed.append(os.path.join("lib", "python2.7", "multiprocessing")) in order to stay compatible with future python version. 
----
New commits:



---

archive/issue_comments_311025.json:
```json
{
    "body": "I don't fully understand the impact of this patch or why sage-env was setting `PYTHONPATH` in the first place, so I'm not sure I'm the best to give a review.  But I definitely support this.",
    "created_at": "2017-03-16T23:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311025",
    "user": "@embray"
}
```

I don't fully understand the impact of this patch or why sage-env was setting `PYTHONPATH` in the first place, so I'm not sure I'm the best to give a review.  But I definitely support this.



---

archive/issue_comments_311026.json:
```json
{
    "body": "I don't understand your changes to `all.py`:\n\n1) What is the reason of this modification? Were the tests failing without it? If not, I would prefer to not touch anything there. You said to \"stay compatible with future Python version\" but did you actually checked this?\n\n2) The aim of `os.path.join` is precisely to *join* several directories and files into a path like\n\n```python\n>>> import os\n>>> os.path.join('my', 'path', 'to', 'my_file.py')\n'my/path/to/my_file.py'\n```\n\n   if the path would only be one string there is no need to use join\n\n3) If you start touching this, why not modifying at the same time\n\n```\nwallowed = [os.path.join(\"lib\",\"python\",\"threading.py\")]\n```\n",
    "created_at": "2017-03-17T07:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311026",
    "user": "@videlec"
}
```

I don't understand your changes to `all.py`:

1) What is the reason of this modification? Were the tests failing without it? If not, I would prefer to not touch anything there. You said to "stay compatible with future Python version" but did you actually checked this?

2) The aim of `os.path.join` is precisely to *join* several directories and files into a path like

```python
>>> import os
>>> os.path.join('my', 'path', 'to', 'my_file.py')
'my/path/to/my_file.py'
```

   if the path would only be one string there is no need to use join

3) If you start touching this, why not modifying at the same time

```
wallowed = [os.path.join("lib","python","threading.py")]
```




---

archive/issue_comments_311027.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-17T07:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311027",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_311028.json:
```json
{
    "body": "1) Yes the all.py doctest fail without the modification. If PYTHONPATH is set you get the frames\n\\\\\n<sage_path>/local/lib/python/multiprocessing/process.py\\\\\n\n<sage_path>/local/lib/python/multiprocessing/forking.py\\\\\n\n<sage_path>/local/lib/python/multiprocessing/process.py.\\\\\n\nIf PYTHONPATH is not set you get \\\\\n\n<sage_path>/local/lib/python2.7/multiprocessing/process.py\\\\\n\n<sage_path>/local/lib/python2.7/multiprocessing/forking.py\\\\\n\n<sage_path>/local/lib/python2.7/multiprocessing/process.py instead and the old doctest failed.\n\n2) Ok.\n\n3) Basically because i didn't get a matching frame during my tests but that's the case for several other item's of the allowed list. Should we rewrite this doctest with this ticket ?",
    "created_at": "2017-03-17T09:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311028",
    "user": "@vinklein"
}
```

1) Yes the all.py doctest fail without the modification. If PYTHONPATH is set you get the frames
\\
<sage_path>/local/lib/python/multiprocessing/process.py\\

<sage_path>/local/lib/python/multiprocessing/forking.py\\

<sage_path>/local/lib/python/multiprocessing/process.py.\\

If PYTHONPATH is not set you get \\

<sage_path>/local/lib/python2.7/multiprocessing/process.py\\

<sage_path>/local/lib/python2.7/multiprocessing/forking.py\\

<sage_path>/local/lib/python2.7/multiprocessing/process.py instead and the old doctest failed.

2) Ok.

3) Basically because i didn't get a matching frame during my tests but that's the case for several other item's of the allowed list. Should we rewrite this doctest with this ticket ?



---

archive/issue_comments_311029.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-17T10:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311029",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311030.json:
```json
{
    "body": "Replying to [comment:8 vklein]:\n> 1) Yes the all.py doctest fail without the modification. If PYTHONPATH is set you get the frames\n> \n> [...]\n\nThen you would better say it in the ticket description!\n\n> 2) Ok.\n> \n> 3) Basically because i didn't get a matching frame during my tests but that's the case for several other item's of the allowed list. Should we rewrite this doctest with this ticket ?\n\nDefinitely!",
    "created_at": "2017-03-17T11:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311030",
    "user": "@videlec"
}
```

Replying to [comment:8 vklein]:
> 1) Yes the all.py doctest fail without the modification. If PYTHONPATH is set you get the frames
> 
> [...]

Then you would better say it in the ticket description!

> 2) Ok.
> 
> 3) Basically because i didn't get a matching frame during my tests but that's the case for several other item's of the allowed list. Should we rewrite this doctest with this ticket ?

Definitely!



---

archive/issue_comments_311031.json:
```json
{
    "body": "There are a handful of other hardcoded local/lib/python/ paths instead of local/lib/pythonx.y/ in the Sage sources; They don't hurt us yet but will sooner or later. Its always good to get rid of it and make no assumptions about where a particular python module resides.",
    "created_at": "2017-03-18T15:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311031",
    "user": "@vbraun"
}
```

There are a handful of other hardcoded local/lib/python/ paths instead of local/lib/pythonx.y/ in the Sage sources; They don't hurt us yet but will sooner or later. Its always good to get rid of it and make no assumptions about where a particular python module resides.



---

archive/issue_comments_311032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-18T17:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311032",
    "user": "@vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_311033.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-18T17:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311033",
    "user": "@vbraun"
}
```

New commits:



---

archive/issue_comments_311034.json:
```json
{
    "body": "I don't like the ellipsis there. It does not catch the fact that only `generating_series` is there. Only that it is first. For example the following is a perfectly valid doctest\n\n```\n    sage: print \"<mod1 hello>, <mod2 hello>, <mod3 hello>\"\n    <mod1 ...>\n```\n\nYou should also check the length of `[inspect.getmodule(f) for f in frames if is_not_allowed(f)]`.\n\nBTW, do you know why is this module listed there!?",
    "created_at": "2017-03-18T21:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311034",
    "user": "@videlec"
}
```

I don't like the ellipsis there. It does not catch the fact that only `generating_series` is there. Only that it is first. For example the following is a perfectly valid doctest

```
    sage: print "<mod1 hello>, <mod2 hello>, <mod3 hello>"
    <mod1 ...>
```

You should also check the length of `[inspect.getmodule(f) for f in frames if is_not_allowed(f)]`.

BTW, do you know why is this module listed there!?



---

archive/issue_comments_311035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-18T22:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311035",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311036.json:
```json
{
    "body": "I don't know why generating_series is there, clearly it shouldn't. But thats not the point of this ticket.\n----\nNew commits:",
    "created_at": "2017-03-18T22:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311036",
    "user": "@vbraun"
}
```

I don't know why generating_series is there, clearly it shouldn't. But thats not the point of this ticket.
----
New commits:



---

archive/issue_comments_311037.json:
```json
{
    "body": "I opened #22647 to track the bad apple...",
    "created_at": "2017-03-19T08:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311037",
    "user": "@videlec"
}
```

I opened #22647 to track the bad apple...



---

archive/issue_comments_311038.json:
```json
{
    "body": "Code looks good to me, but I feel very weakly qualified, and have no time to test.",
    "created_at": "2017-03-21T20:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311038",
    "user": "@fchapoton"
}
```

Code looks good to me, but I feel very weakly qualified, and have no time to test.



---

archive/issue_comments_311039.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-27T16:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311039",
    "user": "@videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_311040.json:
```json
{
    "body": "Breaks on OSX:\n\n```\nmake -j8 base\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nsage-logger -p 'sage-spkg patch-2.7.5' '/Users/buildslave-sage/slave/sage_git/build/logs/pkgs/patch-2.7.5.log'\n[patch-2.7.5] Found local metadata for patch-2.7.5\n[patch-2.7.5] ImportError: No module named site\n[patch-2.7.5] ************************************************************************\n[patch-2.7.5] Error downloading patch-2.7.5.tar.gz\n[patch-2.7.5] ************************************************************************\n[patch-2.7.5] Please email sage-devel (http://groups.google.com/group/sage-devel)\n[patch-2.7.5] explaining the problem and including the log file\n[patch-2.7.5]   /Users/buildslave-sage/slave/sage_git/build/logs/pkgs/patch-2.7.5.log\n[patch-2.7.5] Describe your computer, operating system, etc.\n[patch-2.7.5] ************************************************************************\n```\n\nShorter test\n\n```\n./sage -p patch\nFound local metadata for patch-2.7.5\nImportError: No module named site\n************************************************************************\nError downloading patch-2.7.5.tar.gz\n************************************************************************\n```\n",
    "created_at": "2017-04-02T12:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311040",
    "user": "@vbraun"
}
```

Breaks on OSX:

```
make -j8 base
make[2]: warning: -jN forced in submake: disabling jobserver mode.
sage-logger -p 'sage-spkg patch-2.7.5' '/Users/buildslave-sage/slave/sage_git/build/logs/pkgs/patch-2.7.5.log'
[patch-2.7.5] Found local metadata for patch-2.7.5
[patch-2.7.5] ImportError: No module named site
[patch-2.7.5] ************************************************************************
[patch-2.7.5] Error downloading patch-2.7.5.tar.gz
[patch-2.7.5] ************************************************************************
[patch-2.7.5] Please email sage-devel (http://groups.google.com/group/sage-devel)
[patch-2.7.5] explaining the problem and including the log file
[patch-2.7.5]   /Users/buildslave-sage/slave/sage_git/build/logs/pkgs/patch-2.7.5.log
[patch-2.7.5] Describe your computer, operating system, etc.
[patch-2.7.5] ************************************************************************
```

Shorter test

```
./sage -p patch
Found local metadata for patch-2.7.5
ImportError: No module named site
************************************************************************
Error downloading patch-2.7.5.tar.gz
************************************************************************
```




---

archive/issue_comments_311041.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-02T12:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311041",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_311042.json:
```json
{
    "body": "In fact its nothing to do with OSX, this kills our ability to call the system python as soon as SAGE_LOCAL is created (which is way sooner in the build process than when we install our own python):\n\n```\nif [ -d \"$SAGE_LOCAL\" ]; then\n    PYTHONHOME=\"$SAGE_LOCAL\"\n    export PYTHONHOME\nfi\n```\n\nresulting in \n\n```\n$ PYTHONHOME=/foo/bar python\nImportError: No module named site\n```\n\nIMHO we should just unset PYTHONHOME/PYTHONPATH if they are set (and print a warning that this can't work); Then python will just default to whichever directory is compiled in. The whole PYTHONHOME/PYTHONPATH thing is probably a holdover from the past where we did not clean up paths compiled into binaries.",
    "created_at": "2017-04-02T12:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311042",
    "user": "@vbraun"
}
```

In fact its nothing to do with OSX, this kills our ability to call the system python as soon as SAGE_LOCAL is created (which is way sooner in the build process than when we install our own python):

```
if [ -d "$SAGE_LOCAL" ]; then
    PYTHONHOME="$SAGE_LOCAL"
    export PYTHONHOME
fi
```

resulting in 

```
$ PYTHONHOME=/foo/bar python
ImportError: No module named site
```

IMHO we should just unset PYTHONHOME/PYTHONPATH if they are set (and print a warning that this can't work); Then python will just default to whichever directory is compiled in. The whole PYTHONHOME/PYTHONPATH thing is probably a holdover from the past where we did not clean up paths compiled into binaries.



---

archive/issue_comments_311043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-02T13:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311043",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311044.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-02T13:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311044",
    "user": "@vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_311045.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-03T07:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311045",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_311046.json:
```json
{
    "body": "Fine be me.",
    "created_at": "2017-04-03T07:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311046",
    "user": "@embray"
}
```

Fine be me.



---

archive/issue_comments_311047.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-05T19:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311047",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_311048.json:
```json
{
    "body": "After this ticket the use of `$SAGE_PATH` broke which is still documented so I created the follow up ticket #23614",
    "created_at": "2017-08-11T19:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22371#issuecomment-311048",
    "user": "@koffie"
}
```

After this ticket the use of `$SAGE_PATH` broke which is still documented so I created the follow up ticket #23614
