# Issue 21367: Cleaning up stale installed files in setup()

Issue created by migration from https://trac.sagemath.org/ticket/21604

Original creator: jdemeyer

Original creation time: 2016-09-27 13:23:39

CC:  mkoeppe

This part of `src/setup.py` should be moved inside some distutils command:

```
#########################################################
### Clean
#########################################################

print('Cleaning up stale installed files....')
t = time.time()
from sage_setup.clean import clean_install_dir
output_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))
for output_dir in output_dirs:
    print('- cleaning {0}'.format(output_dir))
    clean_install_dir(output_dir, python_packages, python_modules,
            ext_modules, python_data_files)
print('Finished cleaning, time: %.2f seconds.' % (time.time() - t))
```



---

Comment by jdemeyer created at 2016-09-27 15:07:58

New commits:


---

Comment by jdemeyer created at 2016-09-27 15:07:58

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-09-27 16:38:44

Could you add a few lines of comments to the patch that explain what "stale installed files" are?


---

Comment by git created at 2016-09-28 07:43:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-28 10:36:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-09-28 12:39:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by jdemeyer created at 2016-09-28 12:50:31

Rebased on top of #21480.


---

Comment by jdemeyer created at 2016-09-28 12:50:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-09-29 06:25:14

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-10-05 15:26:41

Changing status from positive_review to needs_work.


---

Comment by embray created at 2016-10-05 15:26:41

As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.


---

Comment by jdemeyer created at 2016-10-05 15:34:43

Replying to [comment:10 embray]:
> As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.

Couldn't this be done as follow-up ticket? Otherwise we will never make progress.

What you say makes sense, but the changes made in this ticket also make sense.


---

Comment by mkoeppe created at 2016-10-05 18:51:16

I agree with Jeroen. 
This ticket is an important step, moving the "clean" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. 
A follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.


---

Comment by mkoeppe created at 2016-10-05 19:56:41

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2016-10-05 19:59:22

I've created the follow-up ticket at #21654.


---

Comment by vbraun created at 2016-10-21 07:03:58

Resolution: fixed
