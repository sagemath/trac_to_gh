# Issue 21367: Cleaning up stale installed files in setup()

archive/issues_021367.json:
```json
{
    "body": "CC:  mkoeppe\n\nThis part of `src/setup.py` should be moved inside some distutils command:\n\n```\n#########################################################\n### Clean\n#########################################################\n\nprint('Cleaning up stale installed files....')\nt = time.time()\nfrom sage_setup.clean import clean_install_dir\noutput_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))\nfor output_dir in output_dirs:\n    print('- cleaning {0}'.format(output_dir))\n    clean_install_dir(output_dir, python_packages, python_modules,\n            ext_modules, python_data_files)\nprint('Finished cleaning, time: %.2f seconds.' % (time.time() - t))\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21604\n\n",
    "created_at": "2016-09-27T13:23:39Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Cleaning up stale installed files in setup()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21367",
    "user": "jdemeyer"
}
```
CC:  mkoeppe

This part of `src/setup.py` should be moved inside some distutils command:

```
#########################################################
### Clean
#########################################################

print('Cleaning up stale installed files....')
t = time.time()
from sage_setup.clean import clean_install_dir
output_dirs = SITE_PACKAGES + glob.glob(os.path.join(SAGE_SRC, 'build', 'lib*'))
for output_dir in output_dirs:
    print('- cleaning {0}'.format(output_dir))
    clean_install_dir(output_dir, python_packages, python_modules,
            ext_modules, python_data_files)
print('Finished cleaning, time: %.2f seconds.' % (time.time() - t))
```


Issue created by migration from https://trac.sagemath.org/ticket/21604





---

archive/issue_comments_296623.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296623",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_296624.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-27T15:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296624",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_296625.json:
```json
{
    "body": "Could you add a few lines of comments to the patch that explain what \"stale installed files\" are?",
    "created_at": "2016-09-27T16:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296625",
    "user": "mkoeppe"
}
```

Could you add a few lines of comments to the patch that explain what "stale installed files" are?



---

archive/issue_comments_296626.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-28T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296626",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_296627.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-28T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296627",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_296628.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2016-09-28T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296628",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_296629.json:
```json
{
    "body": "Rebased on top of #21480.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296629",
    "user": "jdemeyer"
}
```

Rebased on top of #21480.



---

archive/issue_comments_296630.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-28T12:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296630",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_296631.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-29T06:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296631",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_296632.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296632",
    "user": "embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_296633.json:
```json
{
    "body": "As I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.",
    "created_at": "2016-10-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296633",
    "user": "embray"
}
```

As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.



---

archive/issue_comments_296634.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> As I wrote in #21600 this makes sense, but I think this should happen prior to any \"build\" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.\n\nCouldn't this be done as follow-up ticket? Otherwise we will never make progress.\n\nWhat you say makes sense, but the changes made in this ticket also make sense.",
    "created_at": "2016-10-05T15:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296634",
    "user": "jdemeyer"
}
```

Replying to [comment:10 embray]:
> As I wrote in #21600 this makes sense, but I think this should happen prior to any "build" command, not just at install time, since this is really an issue of keeping around a build/ dir from a previous build and expecting to be able to reuse it for a new build.  I can appreciate the need for that, I would just move this step earlier, maybe even as a sub-command of `build`.  If you don't mind, I can update this with what I have in mind.

Couldn't this be done as follow-up ticket? Otherwise we will never make progress.

What you say makes sense, but the changes made in this ticket also make sense.



---

archive/issue_comments_296635.json:
```json
{
    "body": "I agree with Jeroen. \nThis ticket is an important step, moving the \"clean\" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. \nA follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.",
    "created_at": "2016-10-05T18:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296635",
    "user": "mkoeppe"
}
```

I agree with Jeroen. 
This ticket is an important step, moving the "clean" part inside of setup. So, for example, `setup.py --help` no longer invokes cleaning. 
A follow-up ticket (please make one) should disentangle the cleaning of the build directory and the cleaning of the install directory.



---

archive/issue_comments_296636.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-05T19:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296636",
    "user": "mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_296637.json:
```json
{
    "body": "I've created the follow-up ticket at #21654.",
    "created_at": "2016-10-05T19:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296637",
    "user": "mkoeppe"
}
```

I've created the follow-up ticket at #21654.



---

archive/issue_comments_296638.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21367",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21367#issuecomment-296638",
    "user": "vbraun"
}
```

Resolution: fixed
