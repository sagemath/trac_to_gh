# Issue 16350: evaluation of sgn(expr) fails

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2014-06-29 16:16:48

CC:  kcrisman

Keywords: sgn, evaluation

As reported in http://ask.sagemath.org/question/8535/problem-with-sign-sgn-and-n/ by Louis Cypher:

```
sage: M = sgn(cos(3/2))
sage: M.n()
TypeError                                 Traceback (most recent call last)
<ipython-input-5-0f11e9bd1e87> in <module>()
----> 1 M.n()

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._numerical_approx (build/cythonized/sage/symbolic/expression.cpp:24086)()

TypeError: cannot evaluate symbolic expression numerically
```

kcrisman:

Problem seems to be that in `M.n??` we see that it's looking for `is_a_numeric(x._gobj)` but apparently that fails, as does the constant, so it thinks we are looking at evaluating `sgn(cos(x))` instead of `sgn(cos(3/2))`.


---

Comment by kcrisman created at 2014-06-30 13:00:19

You can always feel free to cc: me on any ticket coming from something I was involved in :)


---

Comment by rws created at 2014-11-02 16:56:08

Actually all functions in `generalized.py` show this problem. Moreover, the `cos` can be left out:

```
sage: M = sgn((3/2),hold=True); M.n()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-18-b9940d9ad473> in <module>()
----> 1 M = sgn((Integer(3)/Integer(2)),hold=True); M.n()

/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._numerical_approx (build/cythonized/sage/symbolic/expression.cpp:27093)()

TypeError: cannot evaluate symbolic expression numerically
```

All the generalized functions have this code in `_eval_()` and I believe the bug to be there:

```
        try:
            approx_x = ComplexIntervalField()(x)
            if bool(approx_x.imag() == 0):      # x is real
                if bool(approx_x.real() == 0):  # x is zero
                    return ...
                else:
                    return ...
            else:
                return ...            # x is complex
        except Exception:                     # x is symbolic
            pass
        return None
```



---

Comment by jdemeyer created at 2014-11-03 09:39:57

Isn't the problem simply that these functions are missing an `_evalf_()` method?


---

Comment by rws created at 2014-11-03 17:05:36

Thanks. This begs for a subclass of `BuiltinFunction`.


---

Comment by jdemeyer created at 2014-11-03 19:59:43

Replying to [comment:5 rws]:
> Thanks. This begs for a subclass of `BuiltinFunction`.
I don't see why.


---

Comment by jdemeyer created at 2014-11-03 20:00:53

Let me also mention that this ticket touches on similar issues as #17130. So if you make a patch, I would prefer it to be based on #17130 (although that ticket is still in needs_review).


---

Comment by rws created at 2014-11-04 09:56:47

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 rws]:
> > Thanks. This begs for a subclass of `BuiltinFunction`.
> I don't see why.
Because I didn't want to create an `evalf` for everyone of these. Documentation writing is pending your approval of this construct.
----
New commits:


---

Comment by jdemeyer created at 2014-11-04 10:20:08

Replying to [comment:9 rws]:
> Because I didn't want to create an `evalf` for everyone of these.
But now you create a `gen_eval()` method for everyone of those, why is that better?

> Documentation writing is pending your approval of this construct.
No, I still do not see the reason for a new class.


---

Comment by jdemeyer created at 2014-11-04 10:26:45

Also, do we really need the `ComplexIntervalField` stuff in `_eval_`? I would replace it by a simple `if x == 0` or something like other functions...


---

Comment by jdemeyer created at 2014-11-04 10:32:39

We also should decide whether

```
sage: sgn(cos(3/2))
```

should automatically simplify to

```
1
```

or remain unevaluated.


---

Comment by jdemeyer created at 2014-11-04 10:37:27

Related: #17285


---

Comment by git created at 2014-11-04 16:06:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-11-04 16:09:24

Please confirm this is what you think should go in as basic change to address the original issue. I feel `sgn(cos(3/2))` should give `1`. I'll try now if this works without `ComplexIntervalField`.


---

Comment by jdemeyer created at 2014-11-05 20:30:44

After thinking about this more, perhaps the `ComplexIntervalField` solution isn't so bad after all. In any case, #17285 is the main reason that

```
sgn(cos(3/2))
```

doesn't currently simplify to `1`.


---

Comment by rws created at 2015-03-31 06:04:32

Is this related?
https://groups.google.com/forum/?hl=en#!topic/sage-devel/rkkdK5qbPY0


---

Comment by rws created at 2015-03-31 07:27:54

Replying to [comment:4 jdemeyer]:
> Isn't the problem simply that these functions are missing an `_evalf_()` method?
To finally answer this, no, it will still trigger the exception with `M = sgn((3/2),hold=True); M.n()` and with `M = sgn(cos(3/2)); M.n()`.


---

Comment by rws created at 2015-07-08 13:06:04

Changing status from new to needs_review.


---

Comment by rws created at 2015-07-08 13:06:04

Replying to [comment:4 jdemeyer]:
> Isn't the problem simply that these functions are missing an `_evalf_()` method?
You were of course right. Please review. The polylog issue mentioned previously is part of #18386.
----
New commits:


---

Comment by paulmasson created at 2016-07-07 01:39:23

I tried to checkout this ticket and rebuild Sage but that failed. Branch needs updating.


---

Comment by git created at 2016-07-07 05:43:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-07-07 05:46:14

The branch merges cleanly with develop (green link) so it should have worked after `git merge develop` on your machine. However, I've done it for you in the branch now, so you can simply check out.


---

Comment by paulmasson created at 2016-07-08 01:31:34

Doctests pass. `dirac_delta`, `heaviside`, `unit_step` and `sign` function as expected for real arguments.

`kronecker_delta` returns an unexpected error for real arguments:


```
sage: kronecker_delta(1,2,hold=True).n()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-27-089ce283036d> in <module>()
----> 1 kronecker_delta(Integer(1),Integer(2),hold=True).n()

/Users/Masson/Downloads/GitHub/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._numerical_approx (/Users/Masson/Downloads/GitHub/sage/src/build/cythonized/sage/symbolic/expression.cpp:31167)()
   5430             pass          # try again with complex
   5431             kwds['parent'] = R.complex_field()
-> 5432             x = x._convert(kwds)
   5433 
   5434         # we have to consider constants as well, since infinity is a constant

/Users/Masson/Downloads/GitHub/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._convert (/Users/Masson/Downloads/GitHub/sage/src/build/cythonized/sage/symbolic/expression.cpp:9677)()
   1242             -0.989992496600445*sqrt(2)
   1243         """
-> 1244         cdef GEx res = self._gobj.evalf(0, kwds)
   1245         return new_Expression_from_GEx(self._parent, res)
   1246 

TypeError: _evalf_() takes exactly 2 arguments (5 given)

```


Looks like its trying to evaluate arguments as complex numbers.

And for future reference, is it expected practice for people to merge the current develop branch before pushing to Trac? Or is it a matter of how the branch is assembled, especially for older tickets, and I just need to pay attention to what gets pulled?


---

Comment by rws created at 2016-07-08 13:12:48

Replying to [comment:26 paulmasson]:
> And for future reference, is it expected practice for people to merge the current develop branch before pushing to Trac? Or is it a matter of how the branch is assembled, especially for older tickets, and I just need to pay attention to what gets pulled?

There should be as few merge commits as possible but you can't always adhere to that.

As author, you of course need to merge if what you uploaded before doesn't with develop (red link on ticket). But as you saw, there was a branch that was so old that it could no longer be compiled so I needed to merge it too. Note that as a reviewer you do not need to do `git trac checkout 12345; git merge develop` to get an up-to-date version of an older branch (that still merges cleanly). You can also branch from develop and pull changes: `git checkout -b tmp; git trac pull 12345`. This way your local Sage is not changed to the version of the branch and only the specific branch changes need to be compiled in.

So, to answer, in principle you need not merge the current develop branch before pushing as long as the branch merges cleanly with develop. A good reason to do it nevertheless would be that you want to make sure your changes pass tests (which are always done by patchbot or the RM with develop). What you want to pay attention to as reviewer OTOH is the age of the last merge commit (or the first commit if none) and rather pull (see above) than checkout if older than say 18 months.


---

Comment by rws created at 2016-07-08 14:31:58

I rewrote it all and pushed a new branch (this is also a way to get rid of merge commits). There was danger of infinite loops (see #12121). It also resolved the `kronecker` issue. Please review.
----
New commits:


---

Comment by paulmasson created at 2016-07-08 21:47:29

Doctests pass. Functions behaved as expected as per ticket. Ready to go.


---

Comment by paulmasson created at 2016-07-08 21:47:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-07-09 16:29:25

Resolution: fixed
