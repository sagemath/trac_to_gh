# Issue 21519: Upgrade to PARI 2.8.1

Issue created by migration from https://trac.sagemath.org/ticket/21756

Original creator: jdemeyer

Original creation time: 2016-10-24 12:03:27

CC:  pbruin cremona kedlaya jpflori

*Tarball*: http://pari.math.u-bordeaux.fr/pub/pari/unstable/pari-2.8.1.beta.tar.gz


---

Comment by jdemeyer created at 2016-11-03 13:45:26

New commits:


---

Comment by git created at 2016-11-03 16:19:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-11-04 11:12:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-11-04 11:43:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-11-04 12:05:05

Changing status from new to needs_review.


---

Comment by jpflori created at 2016-11-18 14:39:21

CC'ing random number theory people.

Given that the sum of the two result is of 3-torsion, the new point is still a generator, so should we really worry?
`@`Jeroen: do you think the precision change is worrying?


---

Comment by cremona created at 2016-11-18 14:56:31

Nothing to worry about (in answer to the first question).  The algorithm is computing E(Q)/2E(Q) anyway.


---

Comment by jdemeyer created at 2016-11-18 16:42:33

My worry is that PARI 2.8.0 found a point with the default settings of Simon's 2-descent, while PARI 2.9.0 does not find a point (it only finds a point after increasing some bound).


---

Comment by fbissey created at 2016-11-22 08:45:09

I am having trouble with the new stackwarn patch and a pristine pari-2.9.0 tarball.

```
patching file src/gp/gp.c
patching file src/language/init.c
Hunk #1 succeeded at 740 (offset -34 lines).
Hunk #2 succeeded at 755 (offset -34 lines).
Hunk #3 FAILED at 804.
1 out of 3 hunks FAILED -- saving rejects to file src/language/init.c.rej
```

Am I doing something wrong?


---

Comment by jdemeyer created at 2016-11-22 09:06:11

The two patches need to be applied in order.


---

Comment by fbissey created at 2016-11-22 09:11:29

I see!


---

Comment by jpflori created at 2016-11-29 08:19:36

Did you ask about the prec issue on pari-devel?


---

Comment by jdemeyer created at 2016-11-29 08:26:22

Replying to [comment:18 jpflori]:
> Did you ask about the prec issue on pari-devel?

No. Do you think that I should? It's not really a PARI issue, but a potential issue with the 2-descent script.


---

Comment by jpflori created at 2016-11-29 08:32:40

Sure, but Karim or someone else there could be more knowledgeable than us.


---

Comment by cremona created at 2016-11-29 09:18:53

Allow me to comment, since I know Simon's script quite well (he first wrote it at my suggestion in 1997 when he was Henri Cohen's grad student in Bordeaux and I was visiting).    In the algorithm, various auxiliary curves ("homogeneous spaces") are constructed on which one must find rational points (one on each such curve is enough).  The construction of these is dependent on some purely algebraic number field computations, of class groups and units, where the results are representatives of some equivalence classes, or generators of some group, and are not canonical.  As we well know, new versions of pari often result in such representatives and/or generators changing.  For Simon's code this means that the equations of the auxiliary curves  will change but the curves represented by those equations are equivalent (in a technical sense which is all that matters for the algorithm).  Now the new curves / equations will have rational points if and only if the old ones did, but they may be larger and harder to find, so as a side effect of a theoretically unimportant change in number fields code, one has to increase some search (*not* precision) bounds to get equally informative output.


---

Comment by jdemeyer created at 2016-11-30 12:24:57

So, John, can I conclude that you consider the change to be harmless (even though it looks like a regression).


---

Comment by cremona created at 2016-11-30 12:28:19

Yes, that's right!


---

Comment by jpflori created at 2016-11-30 12:31:52

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2016-11-30 12:31:52

Then LGTM.


---

Comment by vbraun created at 2016-11-30 23:28:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-11-30 23:28:36

I'm getting

```
3348sage -t --long src/sage/interfaces/gp.py
3349**********************************************************************
3350File "src/sage/interfaces/gp.py", line 433, in sage.interfaces.gp.Gp._eval_line
3351Failed example:
3352    gp._eval_line('a='+str(list(range(2*10^5))))[:70]
3353Exception raised:
3354    Traceback (most recent call last):
3355      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
3356        self.compile_and_execute(example, compiler, test.globs)
3357      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
3358        exec(compiled, globs)
3359      File "<doctest sage.interfaces.gp.Gp._eval_line[1]>", line 1, in <module>
3360        gp._eval_line('a='+str(list(range(Integer(2)*Integer(10)**Integer(5)))))[:Integer(70)]
3361      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gp.py", line 441, in _eval_line
3362        wait_for_prompt=wait_for_prompt)
3363      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 902, in _eval_line
3364        return self._eval_line_using_file(line)
3365      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 790, in _eval_line_using_file
3366        raise RuntimeError('%s terminated unexpectedly while reading in a large line:\n%s'%(self,msg[0]))
3367    RuntimeError: PARI/GP interpreter terminated unexpectedly while reading in a large line:
3368    PARI/GP interpreter terminated unexpectedly while reading in a large line
3369**********************************************************************
3370File "src/sage/interfaces/gp.py", line 628, in sage.interfaces.gp.Gp._next_var_name
3371Failed example:
3372    for n in [1..13000]:  # long time
3373        a = g(n)          # long time
3374Exception raised:
3375    Traceback (most recent call last):
3376      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
3377        self.compile_and_execute(example, compiler, test.globs)
3378      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
3379        exec(compiled, globs)
3380      File "<doctest sage.interfaces.gp.Gp._next_var_name[5]>", line 2, in <module>
3381        a = g(n)          # long time
3382      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 246, in __call__
3383        return self._coerce_from_special_method(x)
3384      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 272, in _coerce_from_special_method
3385        return (x.__getattribute__(s))(self)
3386      File "sage/structure/sage_object.pyx", line 715, in sage.structure.sage_object.SageObject._gp_ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/structure/sage_object.c:7387)
3387        return self._interface_(G)
3388      File "sage/structure/sage_object.pyx", line 680, in sage.structure.sage_object.SageObject._interface_ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/structure/sage_object.c:6554)
3389        X = I(s)
3390      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 244, in __call__
3391        return cls(self, x, name=name)
3392      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1380, in __init__
3393        self._name = parent._create(value, name=name)
3394      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 434, in _create
3395        self.set(name, value)
3396      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gp.py", line 557, in set
3397        raise TypeError("Error executing code in GP:\nCODE:\n\t%s\nPARI/GP ERROR:\n%s"%(cmd, out))
3398    TypeError: Error executing code in GP:
3399    CODE:
3400    	sage[12001]=12001;
3401    PARI/GP ERROR:
3402      ***   at top-level: sage[12001]=12001
3403      ***                     ^-------------
3404      ***   non-existent component: index > 12000
3405**********************************************************************
34062 items had failures:
3407   1 of   3 in sage.interfaces.gp.Gp._eval_line
3408   1 of   8 in sage.interfaces.gp.Gp._next_var_name
3409    [155 tests, 2 failures, 10.25 s]
```



---

Comment by cremona created at 2016-12-01 17:47:02

Since 2.9.1 was released today surely we might as well get that in rather than working more on 2.9.0?


---

Comment by fbissey created at 2016-12-01 20:13:07

They ignored my two reports to the "maintainer" issues list. It is minor but not cool.


---

Comment by git created at 2017-01-02 15:09:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-01-02 15:09:50

Replying to [comment:25 vbraun]:
> I'm getting
> {{{
> 3348sage -t --long src/sage/interfaces/gp.py
> 3349**********************************************************************
> 3350File "src/sage/interfaces/gp.py", line 433, in sage.interfaces.gp.Gp._eval_line
> 3351Failed example:
> 3352    gp._eval_line('a='+str(list(range(2*10^5))))[:70]
> 3353Exception raised:
> 3354    Traceback (most recent call last):
> 3355      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
> 3356        self.compile_and_execute(example, compiler, test.globs)
> 3357      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
> 3358        exec(compiled, globs)
> 3359      File "<doctest sage.interfaces.gp.Gp._eval_line[1]>", line 1, in <module>
> 3360        gp._eval_line('a='+str(list(range(Integer(2)*Integer(10)**Integer(5)))))[:Integer(70)]
> 3361      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gp.py", line 441, in _eval_line
> 3362        wait_for_prompt=wait_for_prompt)
> 3363      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 902, in _eval_line
> 3364        return self._eval_line_using_file(line)
> 3365      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 790, in _eval_line_using_file
> 3366        raise RuntimeError('%s terminated unexpectedly while reading in a large line:\n%s'%(self,msg[0]))
> 3367    RuntimeError: PARI/GP interpreter terminated unexpectedly while reading in a large line:
> 3368    PARI/GP interpreter terminated unexpectedly while reading in a large line
> 3369**********************************************************************
> 3370File "src/sage/interfaces/gp.py", line 628, in sage.interfaces.gp.Gp._next_var_name
> 3371Failed example:
> 3372    for n in [1..13000]:  # long time
> 3373        a = g(n)          # long time
> 3374Exception raised:
> 3375    Traceback (most recent call last):
> 3376      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
> 3377        self.compile_and_execute(example, compiler, test.globs)
> 3378      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
> 3379        exec(compiled, globs)
> 3380      File "<doctest sage.interfaces.gp.Gp._next_var_name[5]>", line 2, in <module>
> 3381        a = g(n)          # long time
> 3382      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 246, in __call__
> 3383        return self._coerce_from_special_method(x)
> 3384      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 272, in _coerce_from_special_method
> 3385        return (x.__getattribute__(s))(self)
> 3386      File "sage/structure/sage_object.pyx", line 715, in sage.structure.sage_object.SageObject._gp_ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/structure/sage_object.c:7387)
> 3387        return self._interface_(G)
> 3388      File "sage/structure/sage_object.pyx", line 680, in sage.structure.sage_object.SageObject._interface_ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/structure/sage_object.c:6554)
> 3389        X = I(s)
> 3390      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 244, in __call__
> 3391        return cls(self, x, name=name)
> 3392      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1380, in __init__
> 3393        self._name = parent._create(value, name=name)
> 3394      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 434, in _create
> 3395        self.set(name, value)
> 3396      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gp.py", line 557, in set
> 3397        raise TypeError("Error executing code in GP:\nCODE:\n\t%s\nPARI/GP ERROR:\n%s"%(cmd, out))
> 3398    TypeError: Error executing code in GP:
> 3399    CODE:
> 3400    	sage[12001]=12001;
> 3401    PARI/GP ERROR:
> 3402      ***   at top-level: sage[12001]=12001
> 3403      ***                     ^-------------
> 3404      ***   non-existent component: index > 12000
> 3405**********************************************************************
> 34062 items had failures:
> 3407   1 of   3 in sage.interfaces.gp.Gp._eval_line
> 3408   1 of   8 in sage.interfaces.gp.Gp._next_var_name
> 3409    [155 tests, 2 failures, 10.25 s]
> }}}

Confirmed (with PARI-2.9.1).


---

Comment by jdemeyer created at 2017-01-02 15:11:15

Replying to [comment:26 cremona]:
> Since 2.9.1 was released today surely we might as well get that in rather than working more on 2.9.0?

Done. Since this is a minor change, I don't expect any new doctest failures.


---

Comment by jdemeyer created at 2017-01-02 20:46:40

Just ran `make ptestlong` and the only issue is indeed [comment:25].


---

Comment by jdemeyer created at 2017-01-03 16:30:29

[comment:25] is an upstream bug :-(


---

Comment by jdemeyer created at 2017-01-03 17:01:41

It's not an upstream bug, it's fallout from `prot_none.patch`.


---

Comment by git created at 2017-01-04 10:25:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-04 10:47:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-04 10:52:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-05 13:22:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-01-05 15:43:47

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-01-05 15:43:47

This now passes all tests on 32-bit and 64-bit.


---

Comment by git created at 2017-01-08 09:33:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-01-09 17:03:27

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-01-09 17:03:27

Probably unrelated but I had one doctest failure running all tests in parallel

```
sage -t src/sage/libs/gap/assigned_names.py  # 1 doctest failed
```

I am not able to reproduce it.


---

Comment by vdelecroix created at 2017-01-10 09:34:01

Changing keywords from "" to "atelierpari2017".


---

Comment by vbraun created at 2017-01-18 20:39:32

Resolution: fixed
