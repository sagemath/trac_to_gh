# Issue 30061: Fix broken jupyter notebook - by running kernel installation code outside of setup.py

archive/issues_030061.json:
```json
{
    "body": "CC:  dimpase nbruin slelievre paulmasson fbissey charpent jhpalmieri\n\nWe make the following changes to `sagelib`:\n- remove the call to `sage.repl.ipython_kernel.install` from the installation steps done by sagelib's `setup.py` -- it is not compatible with modern python packaging methods anyway\n- add a `console_script` that installs a kernel spec (using `sage.repl.ipython_kernel.install`), call it `sage-kernel` (interface similar to: https://ipython.readthedocs.io/en/stable/install/kernel_install.html)\n- Change `sage-notebook` (which implements `sage -n`) to a shell script that invokes the correct jupyter (from system if installed in system, from SAGE_LOCAL if installed there)\n\nWe call `sage-kernel` in `build/pkgs/sagelib/spkg-install` instead.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30298\n\n",
    "created_at": "2020-08-06T00:58:56Z",
    "labels": [
        "build",
        "blocker",
        "bug"
    ],
    "title": "Fix broken jupyter notebook - by running kernel installation code outside of setup.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30061",
    "user": "mkoeppe"
}
```
CC:  dimpase nbruin slelievre paulmasson fbissey charpent jhpalmieri

We make the following changes to `sagelib`:
- remove the call to `sage.repl.ipython_kernel.install` from the installation steps done by sagelib's `setup.py` -- it is not compatible with modern python packaging methods anyway
- add a `console_script` that installs a kernel spec (using `sage.repl.ipython_kernel.install`), call it `sage-kernel` (interface similar to: https://ipython.readthedocs.io/en/stable/install/kernel_install.html)
- Change `sage-notebook` (which implements `sage -n`) to a shell script that invokes the correct jupyter (from system if installed in system, from SAGE_LOCAL if installed there)

We call `sage-kernel` in `build/pkgs/sagelib/spkg-install` instead.

Issue created by migration from https://trac.sagemath.org/ticket/30298





---

archive/issue_comments_427261.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2020-08-06T02:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427261",
    "user": "mkoeppe"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_427262.json:
```json
{
    "body": "If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the \"doc\" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?",
    "created_at": "2020-08-06T21:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427262",
    "user": "nbruin"
}
```

If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?



---

archive/issue_comments_427263.json:
```json
{
    "body": "Replying to [comment:6 nbruin]:\n> If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the \"doc\" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?\n\nThanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?",
    "created_at": "2020-08-08T15:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427263",
    "user": "mkoeppe"
}
```

Replying to [comment:6 nbruin]:
> If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?

Thanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?



---

archive/issue_comments_427264.json:
```json
{
    "body": "I think it gets linked in the help menu.\n\nBy the looks of it, the standard Python3 kernel populates that help menu with external links to the python website.\n\nI suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)\n\nI think the kernelspec is NOT the place to host this doc. Perhaps this was chosen as a spot that's guaranteed to be accessible by the kernel, and possibly a place that's not problematic to serve files from? I'm actually a little surprised: you'd think the kernel config directory is exactly what you DON'T want a web server to serve.\n\nGenerally, I'd say serving /usr/local/doc shouldn't be much of a problem, so perhaps just not symlinking and serving SAGE_DOC instead? I guess looking around the jupyter ecosystem a bit to see what solutions other projects come up with ...",
    "created_at": "2020-08-08T16:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427264",
    "user": "nbruin"
}
```

I think it gets linked in the help menu.

By the looks of it, the standard Python3 kernel populates that help menu with external links to the python website.

I suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)

I think the kernelspec is NOT the place to host this doc. Perhaps this was chosen as a spot that's guaranteed to be accessible by the kernel, and possibly a place that's not problematic to serve files from? I'm actually a little surprised: you'd think the kernel config directory is exactly what you DON'T want a web server to serve.

Generally, I'd say serving /usr/local/doc shouldn't be much of a problem, so perhaps just not symlinking and serving SAGE_DOC instead? I guess looking around the jupyter ecosystem a bit to see what solutions other projects come up with ...



---

archive/issue_comments_427265.json:
```json
{
    "body": "Thanks. If it turns out that this symlinking business is indispensable, we could go for the following solution:\n   1. Use `KernelSpecManager` to install it (copying)\n   2. Query it to reveal the resources directory (e.g., using `jupyter kernelspec list --json`)\n   3. Place the symlink.",
    "created_at": "2020-08-08T16:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427265",
    "user": "mkoeppe"
}
```

Thanks. If it turns out that this symlinking business is indispensable, we could go for the following solution:
   1. Use `KernelSpecManager` to install it (copying)
   2. Query it to reveal the resources directory (e.g., using `jupyter kernelspec list --json`)
   3. Place the symlink.



---

archive/issue_comments_427266.json:
```json
{
    "body": "Replying to [comment:9 nbruin]:\n> I suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)\n\nYes, and I think it's important to preserve fully offline operation as a feature.",
    "created_at": "2020-08-08T16:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427266",
    "user": "mkoeppe"
}
```

Replying to [comment:9 nbruin]:
> I suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)

Yes, and I think it's important to preserve fully offline operation as a feature.



---

archive/issue_comments_427267.json:
```json
{
    "body": "I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).",
    "created_at": "2020-08-08T17:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427267",
    "user": "mkoeppe"
}
```

I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).



---

archive/issue_comments_427268.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).\n\nI've expanded on this in #29868.",
    "created_at": "2020-08-08T17:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427268",
    "user": "mkoeppe"
}
```

Replying to [comment:12 mkoeppe]:
> I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).

I've expanded on this in #29868.



---

archive/issue_comments_427269.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Replying to [comment:6 nbruin]:\n> > If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the \"doc\" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?\n> \n> Thanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?\n> \n\nisn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?",
    "created_at": "2020-08-09T06:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427269",
    "user": "dimpase"
}
```

Replying to [comment:8 mkoeppe]:
> Replying to [comment:6 nbruin]:
> > If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?
> 
> Thanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?
> 

isn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?



---

archive/issue_comments_427270.json:
```json
{
    "body": "See #30306 for the full context of this discussion.",
    "created_at": "2020-08-09T15:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427270",
    "user": "mkoeppe"
}
```

See #30306 for the full context of this discussion.



---

archive/issue_comments_427271.json:
```json
{
    "body": "Replying to [comment:14 dimpase]:\n> isn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?\n\nIt's about the location. Sure, installing the docs `.../local/share/docs` is completely reasonable. That's an installed location, not a source or build location.\n\nInstalling the sagemath kernel in jupyter produces a link to it in `.../local/share/jupyter/kernels/sagemath`. That's a different location (and possibly in a different \"local\" tree: for instance, the first might be in `$SAGE_LOCAL` whereas the latter might be in `$HOME/.local` if someone decides to install the sagemath kernel for the system-jupyter but only for the one user.\n\nTelling the standard jupyter install_kernel machinery to make `doc` available in the relevant `kernels/sagemath` would *copy* it; not symlink. From jupyter's perspective that's probably a reasonable thing and the most reliable, but it's not what we want, because we don't want two copies of the sage doc -- we probably want 0 or 1.\n\nOther kernels do seem to make doclinks available in the help menu, but they are links to the actual documentation hosted by the project; so not a local copy.\n\nIt looks like a symlink was an easy solution to make the docs available to jupyter to serve without copying them over. But it seems that having a symlink in the `kernels/sagemath` directory is a little unusual from a jupyter perspective.",
    "created_at": "2020-08-09T16:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427271",
    "user": "nbruin"
}
```

Replying to [comment:14 dimpase]:
> isn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?

It's about the location. Sure, installing the docs `.../local/share/docs` is completely reasonable. That's an installed location, not a source or build location.

Installing the sagemath kernel in jupyter produces a link to it in `.../local/share/jupyter/kernels/sagemath`. That's a different location (and possibly in a different "local" tree: for instance, the first might be in `$SAGE_LOCAL` whereas the latter might be in `$HOME/.local` if someone decides to install the sagemath kernel for the system-jupyter but only for the one user.

Telling the standard jupyter install_kernel machinery to make `doc` available in the relevant `kernels/sagemath` would *copy* it; not symlink. From jupyter's perspective that's probably a reasonable thing and the most reliable, but it's not what we want, because we don't want two copies of the sage doc -- we probably want 0 or 1.

Other kernels do seem to make doclinks available in the help menu, but they are links to the actual documentation hosted by the project; so not a local copy.

It looks like a symlink was an easy solution to make the docs available to jupyter to serve without copying them over. But it seems that having a symlink in the `kernels/sagemath` directory is a little unusual from a jupyter perspective.



---

archive/issue_comments_427272.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427272",
    "user": "mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_427273.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427273",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_427274.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427274",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_427275.json:
```json
{
    "body": "From #33855#comment:5:\n\n  The kernel might also be missing in the wheels. Best to redo the kernelspec generation/installation similar to \u200bhttps://github.com/ipython/ipykernel/blob/main/setup.py#L108\n\n  When building a wheel, the symlink `doc` must be omitted but the other files should be listed as `data_files`.",
    "created_at": "2022-05-16T20:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30061",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30061#issuecomment-427275",
    "user": "mkoeppe"
}
```

From #33855#comment:5:

  The kernel might also be missing in the wheels. Best to redo the kernelspec generation/installation similar to ​https://github.com/ipython/ipykernel/blob/main/setup.py#L108

  When building a wheel, the symlink `doc` must be omitted but the other files should be listed as `data_files`.
