# Issue 30061: Fix broken jupyter notebook - by running kernel installation code outside of setup.py

Issue created by migration from https://trac.sagemath.org/ticket/30298

Original creator: mkoeppe

Original creation time: 2020-08-06 00:58:56

CC:  dimpase nbruin slelievre paulmasson fbissey charpent jhpalmieri

We make the following changes to `sagelib`:
 - remove the call to `sage.repl.ipython_kernel.install` from the installation steps done by sagelib's `setup.py` -- it is not compatible with modern python packaging methods anyway
 - add a `console_script` that installs a kernel spec (using `sage.repl.ipython_kernel.install`), call it `sage-kernel` (interface similar to: https://ipython.readthedocs.io/en/stable/install/kernel_install.html)
 - Change `sage-notebook` (which implements `sage -n`) to a shell script that invokes the correct jupyter (from system if installed in system, from SAGE_LOCAL if installed there)

We call `sage-kernel` in `build/pkgs/sagelib/spkg-install` instead.


---

Comment by mkoeppe created at 2020-08-06 02:21:44

Changing priority from blocker to major.


---

Comment by nbruin created at 2020-08-06 21:14:52

If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?


---

Comment by mkoeppe created at 2020-08-08 15:08:14

Replying to [comment:6 nbruin]:
> If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?

Thanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?


---

Comment by nbruin created at 2020-08-08 16:19:30

I think it gets linked in the help menu.

By the looks of it, the standard Python3 kernel populates that help menu with external links to the python website.

I suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)

I think the kernelspec is NOT the place to host this doc. Perhaps this was chosen as a spot that's guaranteed to be accessible by the kernel, and possibly a place that's not problematic to serve files from? I'm actually a little surprised: you'd think the kernel config directory is exactly what you DON'T want a web server to serve.

Generally, I'd say serving /usr/local/doc shouldn't be much of a problem, so perhaps just not symlinking and serving SAGE_DOC instead? I guess looking around the jupyter ecosystem a bit to see what solutions other projects come up with ...


---

Comment by mkoeppe created at 2020-08-08 16:23:45

Thanks. If it turns out that this symlinking business is indispensable, we could go for the following solution:
 1. Use `KernelSpecManager` to install it (copying)
 2. Query it to reveal the resources directory (e.g., using `jupyter kernelspec list --json`)
 3. Place the symlink.


---

Comment by mkoeppe created at 2020-08-08 16:25:23

Replying to [comment:9 nbruin]:
> I suspect this locally hosted approach was taken to make sagemath more functional in offline settings (which do happen, particularly in more remote places where internet connections aren't so plentiful or are unreliable)

Yes, and I think it's important to preserve fully offline operation as a feature.


---

Comment by mkoeppe created at 2020-08-08 17:10:43

I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).


---

Comment by mkoeppe created at 2020-08-08 17:24:03

Replying to [comment:12 mkoeppe]:
> I think packaging the built HTML documentation as an nbextension could also be a solution. This would facilitate remote sage kernels as described in #30306 (3).

I've expanded on this in #29868.


---

Comment by dimpase created at 2020-08-09 06:57:13

Replying to [comment:8 mkoeppe]:
> Replying to [comment:6 nbruin]:
> > If I recall correctly, the main issue that arises if you want to install the sagemath kernel in the default way is that files are *copied*. That includes the "doc" directory, which is huge. Making it a symlink works much better. Or perhaps the documentation shouldn't be part of the kernelspec in `share/jupyter/kernels` anyway?
> 
> Thanks. I see the symlink `doc` created in `$SAGE_LOCAL/share/jupyter/kernels/sagemath`. Do we know how this symlink is used?
> 

isn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?


---

Comment by mkoeppe created at 2020-08-09 15:44:38

See #30306 for the full context of this discussion.


---

Comment by nbruin created at 2020-08-09 16:59:23

Replying to [comment:14 dimpase]:
> isn't copying/building the docs and optionally deleting the installation source the normal way to install software docs?

It's about the location. Sure, installing the docs `.../local/share/docs` is completely reasonable. That's an installed location, not a source or build location.

Installing the sagemath kernel in jupyter produces a link to it in `.../local/share/jupyter/kernels/sagemath`. That's a different location (and possibly in a different "local" tree: for instance, the first might be in `$SAGE_LOCAL` whereas the latter might be in `$HOME/.local` if someone decides to install the sagemath kernel for the system-jupyter but only for the one user.

Telling the standard jupyter install_kernel machinery to make `doc` available in the relevant `kernels/sagemath` would *copy* it; not symlink. From jupyter's perspective that's probably a reasonable thing and the most reliable, but it's not what we want, because we don't want two copies of the sage doc -- we probably want 0 or 1.

Other kernels do seem to make doclinks available in the help menu, but they are links to the actual documentation hosted by the project; so not a local copy.

It looks like a symlink was an easy solution to make the docs available to jupyter to serve without copying them over. But it seems that having a symlink in the `kernels/sagemath` directory is a little unusual from a jupyter perspective.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-05-16 20:20:14

From #33855#comment:5:

  The kernel might also be missing in the wheels. Best to redo the kernelspec generation/installation similar to â€‹https://github.com/ipython/ipykernel/blob/main/setup.py#L108

  When building a wheel, the symlink `doc` must be omitted but the other files should be listed as `data_files`.
