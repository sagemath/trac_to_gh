# Issue 18403: Topological manifolds: scalar fields

Issue created by migration from Trac.

Original creator: egourgoulhon

Original creation time: 2015-06-08 21:42:27

Assignee: egourgoulhon

CC:  mbejger

Keywords: topological manifolds

This ticket implements scalar fields on topological manifolds. This is a follow up of ticket #18529 within the [SageManifolds project](http://sagemanifolds.obspm.fr/). See the meta-ticket #18528 for an overview.
By _scalar field_, it is meant a continuous map f: M --> K, where K is a topological field and M a topological manifold over K.

This ticket implements the following Python classes:
- `CoordFunction`: abstract base class for coordinate functions, i.e. functions
  V\subset K<sup>n</sup> --> K, where V is some chart codomain and n=dim(M)
  - `CoordFunctionSymb`: symbolic coordinate functions
- `MultiCoordFunction`: functions V\subset K<sup>n</sup> --> K<sup>m</sup>, where V is some chart codomain and m some
  positive integer
- `ScalarFieldAlgebra`: set C<sup>0</sup>(M) of scalar fields M --> K as a commutative algebra over K 
  (Parent class)
- `ScalarField`: scalar field M --> K (Element class)
Internally, `ScalarField`'s are described by their coordinate representations in various charts, which are implemented as a dictionary of `CoordFunction`'s, with the charts as keys. 
At the moment, there is only one concrete class for coordinate functions: `CoordFunctionSymb` (functions described by symbolic expressions of the coordinates), but in the future there should be numerical coordinate functions (hence the abstract base class `CoordFunction`).


---

Comment by git created at 2015-06-14 21:43:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 15:51:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-16 16:13:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-17 08:56:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 16:14:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-23 15:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-26 16:10:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-23 16:15:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-01 22:11:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-13 21:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-14 14:10:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-15 13:16:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2015-10-15 20:44:50

Changing status from new to needs_review.


---

Comment by git created at 2015-10-19 09:18:35

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-11-09 10:18:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2015-11-09 10:51:22

The above commit takes into account [this discussion on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/Vzfj1haZHho) and on ticket #18529: it removes `UniqueRepresentation` for the class `ScalarFieldAlgebra`, leaving only `WithEqualityById`.


---

Comment by git created at 2015-11-17 13:47:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-02 16:24:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-06 20:43:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-06 21:24:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-16 17:12:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-03 19:56:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-11 10:47:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-24 20:45:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-28 13:45:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-28 14:06:00

Yay, finally had time to go through this. So, compared to the previous ticket, there is a lot less to discuss. I've mostly pushed a bunch of documentation changes on my last commit. However, I think there are still a few things to do.

- I am guessing there will eventually be another subclass of `CoordFunction`? At present, there does not seem to be a reason to have an ABC. Moreover, you could probably make any numerical coordinate chart be `._express` with the appropriate methods. However, I am wondering if there should be a parent for `CoordFunction` (and have `CoordFunction` be a subclass of `AlgebraElement`), which would allow you to not duplicate code and use the coercion framework. Actually, perhaps `CoordFunction` should be a subclass of `Morphism`.

  Also, I converted the methods in `CoordFunction` to ``@`abstract_method` since these get picked up by the `TestSuite` as opposed to raising a `NotImplementedError`. (I haven't fixed the doctests yet in case the ABC gets removed.)

- I understand why you want to put "the" in the string representations (e.g., in `ScalarFieldAlgebra`) because it is how we would say it (in English), but this breaks convention with other parts of Sage. Moreover, it implies a certain amount of uniqueness to the manifold. However, there could be 2 different manifolds with the same dimension, name, etc.

- Similarly, in the docstrings, we should change "the *" to "this *" (sorry I didn't catch this previously).

- I don't like `omit_function_args` and `nice_derivatives` being included in the global namespace. I think these are better converted to global options. The question becomes what to attach the global options to. I am thinking `Manifold` (a function is a Python object too, so we can attach data to it) and `TopologicalManifold`. Either that, or we just have one object `ManifoldOptions` into the global namespace (but I am less favorable to this option).

- There are failing doctests in `utilities.py` likely due to recent changes in the symbolic function code (independent of my changes).

There's still likely a few more things that might need a little bit of attention, but I am pretty sure these are all of the main points.


---

Comment by tscrim created at 2016-04-28 14:06:00

Changing status from needs_review to needs_info.


---

Comment by egourgoulhon created at 2016-04-29 09:13:29

Replying to [comment:28 tscrim]:
> Yay, finally had time to go through this. So, compared to the previous ticket, there is a lot less to discuss. I've mostly pushed a bunch of documentation changes on my last commit. 

Thank you very much for working on this !

>However, I think there are still a few things to do.
> 
> - I am guessing there will eventually be another subclass of `CoordFunction`? At present, there does not seem to be a reason to have an ABC.

Yes there will be other subclasses of `CoordFunction`: a major project is to have a subclass for numerical functions, in order to deal with numerical manifolds (for instance computer-generated spacetimes on a grid). This was the very purpose for creating this ABC: it provides the unique interface with the rest of tensor calculus on manifolds, factoring out what has to be implemented by a concrete class (the abstract methods). So I think it is important to maintain the ABC.

> Moreover, you could probably make any numerical coordinate chart be `._express` with the appropriate methods. However, I am wondering if there should be a parent for `CoordFunction` (and have `CoordFunction` be a subclass of `AlgebraElement`), which would allow you to not duplicate code and use the coercion framework. Actually, perhaps `CoordFunction` should be a subclass of `Morphism`.

OK, I will give a try to this, introducing the proper algebra (no time to do it right now, though...)

>   Also, I converted the methods in `CoordFunction` to ``@`abstract_method` since these get picked up by the `TestSuite` as opposed to raising a `NotImplementedError`.

Thanks. I didn't know about this.

> (I haven't fixed the doctests yet in case the ABC gets removed.)
> 
> - I understand why you want to put "the" in the string representations (e.g., in `ScalarFieldAlgebra`) because it is how we would say it (in English), but this breaks convention with other parts of Sage. Moreover, it implies a certain amount of uniqueness to the manifold. However, there could be 2 different manifolds with the same dimension, name, etc.
>

Sorry, I am not sure I understand what you mean. Can you elaborate on this?
 
> - Similarly, in the docstrings, we should change "the *" to "this *" (sorry I didn't catch this previously).
> 
> - I don't like `omit_function_args` and `nice_derivatives` being included in the global namespace. I think these are better converted to global options. 

Agreed.

>The question becomes what to attach the global options to. I am thinking `Manifold` (a function is a Python object too, so we can attach data to it) and `TopologicalManifold`. 

`TopologicalManifold` sounds good, since this where the charts live in the current approach.

>Either that, or we just have one object `ManifoldOptions` into the global namespace (but I am less favorable to this option).
> 
> - There are failing doctests in `utilities.py` likely due to recent changes in the symbolic function code (independent of my changes).

Indeed this reflects some bug in the latest pynac (cf. #20456); fortunately it is fixed by #20475; so if the latter is merged before the current ticket, we can leave the doctests as they are.
> 
> There's still likely a few more things that might need a little bit of attention, but I am pretty sure these are all of the main points.


---

Comment by tscrim created at 2016-04-29 20:10:44

Replying to [comment:29 egourgoulhon]:
> Replying to [comment:28 tscrim]:
> > - I am guessing there will eventually be another subclass of `CoordFunction`? At present, there does not seem to be a reason to have an ABC.
> 
> Yes there will be other subclasses of `CoordFunction`: a major project is to have a subclass for numerical functions, in order to deal with numerical manifolds (for instance computer-generated spacetimes on a grid). This was the very purpose for creating this ABC: it provides the unique interface with the rest of tensor calculus on manifolds, factoring out what has to be implemented by a concrete class (the abstract methods). So I think it is important to maintain the ABC.

I guess what I am asking is how much of concrete class `CoordFunctionSym` can be lifted to the ABC?

> > Moreover, you could probably make any numerical coordinate chart be `._express` with the appropriate methods. However, I am wondering if there should be a parent for `CoordFunction` (and have `CoordFunction` be a subclass of `AlgebraElement`), which would allow you to not duplicate code and use the coercion framework. Actually, perhaps `CoordFunction` should be a subclass of `Morphism`.
> 
> OK, I will give a try to this, introducing the proper algebra (no time to do it right now, though...)

It should be a fairly small class; a parent that takes a chart as input. I can work on this for my next commit.

> > - I understand why you want to put "the" in the string representations (e.g., in `ScalarFieldAlgebra`) because it is how we would say it (in English), but this breaks convention with other parts of Sage. Moreover, it implies a certain amount of uniqueness to the manifold. However, there could be 2 different manifolds with the same dimension, name, etc.
> 
> Sorry, I am not sure I understand what you mean. Can you elaborate on this?

When you say "the manifold," you are saying there is a unique manifold. Context makes it clear exactly which manifold you're talking about (and hence unique), but for something like documentation, "this manifold" better defines what you are reference (although personally, I would just replace it by ```self```...).

> >The question becomes what to attach the global options to. I am thinking `Manifold` (a function is a Python object too, so we can attach data to it) and `TopologicalManifold`. 
> 
> `TopologicalManifold` sounds good, since this where the charts live in the current approach.

I will do this on the next commit.

> > - There are failing doctests in `utilities.py` likely due to recent changes in the symbolic function code (independent of my changes).
> 
> Indeed this reflects some bug in the latest pynac (cf. #20456); fortunately it is fixed by #20475; so if the latter is merged before the current ticket, we can leave the doctests as they are.

So we will just watch what happens with #20475, which might means we need to mark them as `# known bug` and revert them in #20475.


---

Comment by egourgoulhon created at 2016-04-30 10:04:17

Replying to [comment:30 tscrim]:
> 
> I guess what I am asking is how much of concrete class `CoordFunctionSym` can be lifted to the ABC?
> 

Not much: I would say that `CoordFunctionSymb` is optimal: everything that could be lifted to the ABC `CoordFunction` is already  there. 

> > > Moreover, you could probably make any numerical coordinate chart be `._express` with the appropriate methods. However, I am wondering if there should be a parent for `CoordFunction` (and have `CoordFunction` be a subclass of `AlgebraElement`), which would allow you to not duplicate code and use the coercion framework. Actually, perhaps `CoordFunction` should be a subclass of `Morphism`.
> > 
> > OK, I will give a try to this, introducing the proper algebra (no time to do it right now, though...)
> 
> It should be a fairly small class; a parent that takes a chart as input. I can work on this for my next commit.

OK thanks. 
> 

> 
> When you say "the manifold," you are saying there is a unique manifold. Context makes it clear exactly which manifold you're talking about (and hence unique), but for something like documentation, "this manifold" better defines what you are reference (although personally, I would just replace it by ```self```...).

Thanks for these explanations. As you, I would favor `self` (which is completely unambiguous), but I remember a discussion on sage-devel, the conclusion of which was that one should avoid the mention of `self` in the documentation, to make it more readable for newcomers. So let's go for "this manifold". 

> 
> > >The question becomes what to attach the global options to. I am thinking `Manifold` (a function is a Python object too, so we can attach data to it) and `TopologicalManifold`. 
> > 
> > `TopologicalManifold` sounds good, since this where the charts live in the current approach.
> 
> I will do this on the next commit.

OK very good.
> 
> > > - There are failing doctests in `utilities.py` likely due to recent changes in the symbolic function code (independent of my changes).
> > 
> > Indeed this reflects some bug in the latest pynac (cf. #20456); fortunately it is fixed by #20475; so if the latter is merged before the current ticket, we can leave the doctests as they are.
> 
> So we will just watch what happens with #20475, which might means we need to mark them as `# known bug` and revert them in #20475.

OK.


---

Comment by tscrim created at 2016-05-01 18:36:40

Another question, should `MultiCoordFunction` be a subclass of `CoordFunction`, should they have a common ABC, or should they be unrelated (as they are now)?


---

Comment by egourgoulhon created at 2016-05-01 19:51:31

Replying to [comment:32 tscrim]:
> Another question, should `MultiCoordFunction` be a subclass of `CoordFunction`, should they have a common ABC, or should they be unrelated (as they are now)?

It seems to me that they should be unrelated, as far as inheritance is concerned. Basically a `MultiCoordFunction` object is a tuple of `CoordFunction` objects.


---

Comment by tscrim created at 2016-05-01 20:27:38

Okay, next question. Do you have a reason why `jacobian` does not return a matrix?


---

Comment by tscrim created at 2016-05-01 20:31:13

Ah, it is because its elements are instances of `CoordFunction` rather than elements of `SR`. Nevermind.


---

Comment by git created at 2016-05-03 05:13:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-05-03 05:18:10

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2016-05-03 05:18:10

Wee, finally had time to get it all done. I started to use ```self``` because I recall less consensus on the sage-devel thread; a good chuck of code uses it; if we add more code, it becomes standard; and it simplifies a number of the doc sentences' structure. I did not implement as much coercion as might be possible (i.e., coordinate functions could coerce to the smallest chart they are defined on), but the door is open to do so. I also added the global options and marked the tests in `utilities.py` as `# known bug`. So if my changes are good with you, then we can set this to a positive review.


---

Comment by git created at 2016-05-05 21:54:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-05-05 22:08:34

Replying to [comment:37 tscrim]:
> Wee, finally had time to get it all done. 

Thanks a lot for your work. It's nice to have the coordinate functions in the parent/element scheme! In the above commit, I have simply changed the category of the parent to `CommutativeAlgebras(SR)` and suppressed the alias `is_commutative`. I have also added a few doctests and made some slight improvements in the documentation.
>I started to use ```self``` because I recall less consensus on the sage-devel thread; a good chuck of code uses it; if we add more code, it becomes standard; and it simplifies a number of the doc sentences' structure. 
OK
>I did not implement as much coercion as might be possible (i.e., coordinate functions could coerce to the smallest chart they are defined on), but the door is open to do so. 
Indeed.
>I also added the global options and marked the tests in `utilities.py` as `# known bug`.
Fine.
>So if my changes are good with you, then we can set this to a positive review.
Please wait until tomorrow: I will check that the changes propagate nicely to all tickets of #18528 (I've done it already for the next ticket (#18725).


---

Comment by tscrim created at 2016-05-05 22:48:45

Your changes look good to me. So if everything propagates up nicely. Then you can set a positive review (unfortunately it seems like this won't get into 7.2 :/).


---

Comment by git created at 2016-05-06 03:47:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-06 14:20:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2016-05-06 21:16:47

Replying to [comment:42 tscrim]:
> Your changes look good to me. So if everything propagates up nicely. Then you can set a positive review (unfortunately it seems like this won't get into 7.2 :/).

Good news: I've propagated the changes to all tickets up to #19209 (pseudo-Riemannian metrics): everything works fine! (this was also the occasion to move all print instructions to Python3 syntax and to correct the bibliographic references according to #20496). So everything is OK for me.


---

Comment by tscrim created at 2016-05-06 22:00:54

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-05-06 22:00:54

Great. All is good with me. Positive review.


---

Comment by egourgoulhon created at 2016-05-07 07:40:33

Replying to [comment:46 tscrim]:
> Great. All is good with me. Positive review.

Thanks !


---

Comment by vbraun created at 2016-05-17 07:16:44

Resolution: fixed
