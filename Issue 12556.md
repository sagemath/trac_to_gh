# Issue 12556: sage's spkg sources should use correct include paths instead of having ../../../../whatever everywhere

Issue created by migration from Trac.

Original creator: Snark

Original creation time: 2012-03-22 13:46:46

Assignee: Snark

There are many places in sage's spkg sources where inclusions are made with a filename which looks like ../../../../../whatever (no exageration: up to *five* levels!).

Those should be removed, and the right path added to the include
line.

I'll work on it in the coming days ; this ticket is so I can be pestered about it if I have no patch ready soon enough.


---

Comment by Snark created at 2012-03-24 08:30:20

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-04-02 09:51:39

I don't like [attachment:compile_with_no_up_in_includes.patch].  I would prefer the patch to add only `SAGE_ROOT/devel/sage` and not all those other directories.


---

Comment by Snark created at 2012-04-02 10:38:20

There are two problems with "../../../../.." :
 1. it doesn't give any serious information, so why is it here?
 2. the code is supposed to provide features ; it shouldn't worry about building.

It's better to have the build system provide ten "-I" flags than having a thousand places in the code where those ten paths are engraved, for maintainability reasons.


---

Comment by jdemeyer created at 2012-07-27 20:40:22

Please fill in your real name as Author.


---

Comment by fbissey created at 2012-08-08 11:21:30

Some dedication here. The second patch at least will need rebasing against at least 5.2. I am not sure you should add all these paths to CYTHON_INCLUDE_DIRS. Is there a reason why they are not in their own variable. Do you need all these and not just SAGE_ROOT + '/devel/sage/sage/'?


---

Comment by Snark created at 2012-08-08 12:15:41

Yes, it's now old and deprecated. And yes, I think it was needed to add all those paths.

I plan to rework on the matter differently -- the question is when. The plan would be to have some script with a list of the included headers with their full paths and their wanted path, which would normalize the paths in includes. That might still require changing CYTHON_INCLUDE_DIRS, but hopefully adding less paths.


---

Comment by jdemeyer created at 2012-08-08 12:40:51

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2013-01-06 12:25:51

On Sage-devel, you reported that by changing the include paths the answers to some doctest in sage.misc.sageinspect changed. I'll see where that comes from, but I guess sageinspect needs a fix concerning temporary Cython code anyway.


---

Comment by SimonKing created at 2013-01-06 12:59:46

See #13916.


---

Comment by Snark created at 2013-01-06 15:37:54

That shell script has a bug where everything before stdsage.pxi might get eaten -- that is the reason why there's a failing doctest. Not ready for review yet :-P


---

Attachment

Shell script which patches 99,99% of the issues


---

Comment by Snark created at 2013-01-07 07:44:31

Ok, the new version of the updirectories-sed shell script passes all doctests: it needs review. It won't fix 100% of the problem, but the rest can be patched by hand, at it concerns only a handful of cases.


---

Comment by Snark created at 2013-01-07 07:44:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-01-12 22:00:35

Please make it clear what should be applied.


---

Comment by Snark created at 2013-01-13 10:06:22

The updirectories-sed.sh shell script needs to be reviewed:
1. read ;
2. run (from the right directory) ;
3. compile ;
4. make ptestlong ;
5. report success (very likely) or failure (very unlikely).


---

Comment by fbissey created at 2013-01-13 10:11:32

I think that's not how we want to proceed hence, Jeroen's question. Having the script is nice for testing but once you have run it you should generate a patch with mercurial and post it here for inclusion. 
The script is nice for stuff that will be included in the future... there is a ticket somewhere where someone is making a similar mess - I didn't have the heart to shoot him early.


---

Comment by Snark created at 2013-01-13 10:22:14

I'll generate an mercurial patch if that is what you want. It will be thousands of lines long, but if you prefer to review that... every taste is in nature.


---

Comment by fbissey created at 2013-01-13 10:32:07

Size of the patch is just a technical problem. It just makes it harder to find a problem if there is any but no more so than with just applying your script.


---

Comment by jdemeyer created at 2013-01-13 10:54:47

Replying to [comment:16 Snark]:
> I'll generate an mercurial patch if that is what you want.
No, that's not needed.  But you should really explain *in the ticket description* which patches should be applied/which scripts should be run.  From the previous ticket description, it was a absolutely totally utterly completely not clear that the script should be run instead of applying any patches.


---

Comment by Snark created at 2013-01-13 11:07:22

I don't like editing the ticket description because that breaks the flow of comments. And notice that running the shell script fixes a huge percentage of the updirectory includes, but doesn't fix them all : I'll still need to hand-edit the remaining ones afterwards.


---

Comment by jdemeyer created at 2013-01-13 11:51:26

Replying to [comment:19 Snark]:
> I don't like editing the ticket description because that breaks the flow of comments.
So you expect the release manager to read *all the comments* in *every* ticket just to know which patches should be applied?  That's not going to happen.

And even from reading the comments, it's not that clear that the shell script replaces the usual patch.


---

Comment by Snark created at 2013-01-13 12:12:15

You rejected the patches, but trac doesn't allow to mark them as rejected as far as I know... so they still sit there, unfortunately.


---

Comment by Snark created at 2013-05-18 11:43:42

Patch created applying the script agains 5.10.beta3


---

Attachment

Ok, I applied the script on sage 5.10.beta3 ; it doesn't make new doctests fail (the quadratic forms code doesn't work correctly on this box anyway).


---

Comment by vbraun created at 2013-05-18 11:59:15

Looks good to me!


---

Comment by vbraun created at 2013-05-18 11:59:22

Changing status from needs_review to positive_review.


---

Comment by leif created at 2013-05-18 13:52:11

You may have made some publicity for it earlier ... ;-)


---

Comment by Snark created at 2013-05-20 14:04:06

If the patch built by my script gets applied for 5.10.beta4, there's even a chance I'll be able to work on the remaining problems for 5.10 :-)


---

Comment by Snark created at 2013-05-21 06:13:51

Hand-crafted finalization of the fix


---

Attachment


---

Comment by jdemeyer created at 2013-05-21 06:59:47

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-05-21 06:59:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-05-21 07:00:19

If [attachment:trac_12728_5.10.beta3_hand.patch] should be applied, it should be reviewed and mentioned in the ticket description.


---

Comment by jdemeyer created at 2013-05-21 07:01:36

I also don't like two ways of applying a patch, because which one is "correct"? Either only mention the script, or only the patch.


---

Comment by vbraun created at 2013-05-21 12:49:46

Can you rediff the first patch for sage-5.10.beta4


---

Comment by jdemeyer created at 2013-05-21 13:59:53

Positive review to [attachment:trac_12728_5.10.beta3_hand.patch]


---

Comment by jdemeyer created at 2013-05-21 13:59:53

Changing status from needs_review to needs_work.


---

Attachment

Patch created applying the script agains 5.10.beta4


---

Attachment

Hand-crafted finalization of the fix


---

Comment by Snark created at 2013-05-21 19:39:47

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-05-22 10:47:36

Looks good. 

Jeroen, can we merge this in beta5?


---

Comment by vbraun created at 2013-05-22 10:47:36

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-23 08:53:00

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-05-23 08:53:00

This causes problems with the HTML documentation:

```
dochtml.log:[rings_sta] /mazur/release/merger/sage-5.10.beta5/devel/sage/doc/en/reference/rings_standard/sage/rings/integer.rst:11: WARNING: error while formatting signature for sage.rings.integer.parent: 'NoneType' object has no attribute 'find'
dochtml.log:[structure] /mazur/release/merger/sage-5.10.beta5/devel/sage/doc/en/reference/structure/sage/sets/disjoint_set.rst:11: WARNING: error while formatting signature for sage.sets.disjoint_set.OP_represent: 'NoneType' object has no attribute 'find'
dochtml.log:[structure] /mazur/release/merger/sage-5.10.beta5/devel/sage/doc/en/reference/structure/sage/sets/disjoint_set.rst:11: WARNING: error while formatting signature for sage.sets.disjoint_set.PS_represent: 'NoneType' object has no attribute 'find'
dochtml.log:[structure] /mazur/release/merger/sage-5.10.beta5/devel/sage/doc/en/reference/structure/sage/sets/disjoint_set.rst:11: WARNING: error while formatting signature for sage.sets.disjoint_set.SC_test_list_perms: 'NoneType' object has no attribute 'find'
```



---

Comment by Snark created at 2013-05-23 09:23:13

Your error message doesn't look at all like it's related to my changes (no error looking like "File not found"), but I'll investigate...


---

Comment by vbraun created at 2013-05-23 10:06:36

This is what broke:

```
sage: sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent)
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
<ipython-input-1-b9940f7f2356> in <module>()
----> 1 sage_getargspec(sage.sets.disjoint_set.OP_represent)

NameError: name 'sage_getargspec' is not defined
sage: sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-2-ee04891bf854> in <module>()
----> 1 sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent)

/home/vbraun/opt/sage-5.10.beta3/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getargspec(obj)
   1332         except TypeError: # arg is not a code object
   1333         # The above "hopefully" was wishful thinking:
-> 1334             return inspect.ArgSpec(*_sage_getargspec_cython(sage_getsource(obj)))
   1335             #return _sage_getargspec_from_ast(sage_getsource(obj))
   1336     try:

/home/vbraun/opt/sage-5.10.beta3/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in _sage_getargspec_cython(source)
    984 
    985     """
--> 986     defpos = source.find('def ')
    987     assert defpos > -1, "The given source does not contain 'def'"
    988     s = source[defpos:].strip()

AttributeError: 'NoneType' object has no attribute 'find'
```

used to be 

```
sage: sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent)
ArgSpec(args=['n', 'merges', 'perm'], varargs=None, keywords=None, defaults=None)
```



---

Comment by Snark created at 2013-05-23 10:19:11

`@`vbraun: thanks ; it still doesn't look like a missing file, but at least it's a place I can start digging.

My plan was the following :
1. freshly unpack a sage-5.10.beta4 tarball ;
2. make build
3. apply the patches
4. ./sage -ba-force
5. make doc-html

now step 5 is to start from this sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent).


---

Comment by Snark created at 2013-05-23 12:26:32

Ok, I determined that sage.misc.sageinspect.sage_getargspec(sage.sets.disjoint_set.OP_represent) gets interpreted in sageinspect.py like this:
1. is it an abstract method, line 1284? No.
2. is it callable, line 1287? Yes.
3. try to read the argspec, line 1290 - AttributeError line 1291, pass (line 1292)!
4. is it a function, line 1293? No.
5. is it a method, line 1295? No.
6. is it a class instance, line 1297? No.
7. is it a class, line 1311? No.
8. does it have some attributes, line 1314? No.
9. fallback to the 'else' of line 1318!
10. let's call sage_getsource, line 1320, and get None.
11. line 1321-1324: since we got None, we set func_obj=obj.
12. try something line 1328 and fail with AttributeError
13. catch this exception and try something else line 1331 and fail with TypeError
14. catch this exception line 1332
15. let's do (no try this time): "return inspect.ArgSpec(*_sage_getargspec_cython(sage_getsource(obj)))", because obviously, the fact that a few lines above sage_getsource got us None already won't be a problem! BOOM!

I interpret those findings as meaning that something with my patches has made sage_getsource(obj) return None, and this then uncovered a nice bug in sageinspect. Does this sound sensible? Should I then file a bug against sageinspect.py? [Of course, I'll now investigate why None gets returned]


---

Comment by Snark created at 2013-05-23 12:29:35

Oh, I forgot to make explicit the remark that sage_getsource returning None could be related to a "File not found" problem -- so now it makes sense that the problem can be related to my patches. Something which wasn't that clear. So now I'm looking for a problem, and I believe in it :-P


---

Comment by Snark created at 2013-05-23 12:50:47

I now determined how sage_getsource(sage.sets.disjoint_set.OP_represent) gets interpreted in sageinspect.py:
1. try to use the _sage_src_ method and raise an AttributeError, line 1552 (gets pass-ed)
2. try to use sage_getsourcelines, line 1556 and get None
3. after a test of the previous value, return None, line 1558

The problems turns into: why does sage_getsourcelines(sage.sets.disjoint_set.OP_represent) return None? Let's follow the trail again:
1. try to use the _sage_src_lines_ method and raise an AttributeError line 1783 (gets pass-ed)
2. is it a class instance, line 1791? No.
3. get a nice-looking doctring line 1802, except that the filename reads 'res_pyx.pxi'
4. try to use _extract_embedded_position on it... get to line 200... where the filename gets obtained by os.path.join(SAGE_SRC, res.group('FILENAME'))
5. from there, the rest is history: we have a wrong filename in a wrong path, so it's no surprise things get messy. 


So now I see two problems there: first, the only file with a name looking like this is sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi, and second, the way the full path is obtained from the filename looks too naive.

How can I debug the first problem?


---

Comment by Snark created at 2013-05-23 13:09:21

"sage.sets.disjoint_set.OP_represent" is defined in sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi, and indeed at line 125 as I see in the docstring.
The line number is correct ; only the filename looks like it has been eaten.


---

Comment by Snark created at 2013-05-23 13:11:30

On the non-patched sage-5.10.beta5 the filename is "sage/sets/../groups/perm_gps/partn_ref/data_structures_pyx.pxi".


---

Comment by vbraun created at 2013-05-23 14:58:01

The filename is already wrong in the Cythonized `disjoint_set.c`:

```
static char __pyx_doc_4sage_4sets_12disjoint_set_OP_represent[] = "File: pyx.pxi (starting at line 125)\n\n    Demonstration and testing.\n    \n    TESTS::\n\n        [...]        Done.\n\n    ";
```

So there is nothing in this ticket that is responsible for it.


---

Comment by vbraun created at 2013-05-23 15:06:58

The bug is in Cython `Nodes.relative_position`, which assumes that you can make the path relative by stripping off `len(os.path.abspath(os.getcwd()))` characters. Thats of course totally wrong when the file was discovered through a search path.


---

Comment by vbraun created at 2013-05-23 15:11:46

See #14634 for the Cython bug


---

Comment by vbraun created at 2013-05-23 15:11:46

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2013-05-23 17:48:59

Initial patch


---

Attachment

I suggest we just revert the two includes that trigger the Cython bug.


---

Comment by Snark created at 2013-05-23 19:00:15

I'm happy with your solution. I rebuilt sagelib adding your patch to my two patches, then built the doc from there : perfect. Positive review!


---

Comment by jdemeyer created at 2013-05-24 09:39:55

Resolution: fixed
