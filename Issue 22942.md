# Issue 22942: Automatically wrap spkg-install scripts with boilerplate

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-06-08 14:49:56

CC:  vbraun

I mentioned this idea in [this ticket](https://trac.sagemath.org/ticket/23160#comment:8), but to summarize the purpose of this is to make the `spkg-install` scripts (as well as `spkg-build` and `spkg-check` when they exist) not directly executable on their own outside of package build directories.  This is to prevent them from being accidentally executed in any other context.  Further, they are wrapped to source the `sage-env` script from the `$SAGE_ROOT` the package is being installed into.  So if one manually enters a package build directory and runs the `spkg-install` it will automatically ensure that the correct Sage environment is loaded.

This obviates the need for the guard boilerplate that checks for `$SAGE_LOCAL`, though it can't hurt to keep, in case `sage-env` itself is broken somehow.

This ticket changes a ton of files, so let me just summarize the changes briefly:

 * Modifies `sage-spkg` to write a wrapper containing the boilerplate around each `sage-build/install/check` script _after_ it is copied into a package build directory.

 * For all existing `sage-build/install/check` scripts, the executable bit is removed from the copies in the source tree in `build/pkgs/`, and the shebang lines are removed.

 * For the handful of scripts that were written in Python, the `spkg-install` becomes just `exec sage-python23 sage-install.py`, where the original Python-based install script is moved to `sage-install.py`.

I think it would be good to do something like this, but it's just an idea and not strictly required for any future work.


---

Comment by embray created at 2017-06-08 14:50:04

Changing status from new to needs_review.


---

Comment by git created at 2017-06-08 14:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-20 12:15:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-06-20 12:16:33

Rebased.


---

Comment by jdemeyer created at 2017-06-20 13:31:38

I don't really like this idea.

1. Having those scripts executable can be useful for debugging.

2. I would still want to keep the check `if [ "$SAGE_LOCAL" = "" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.

3. Too much magic makes the logic harder to understand.


---

Comment by embray created at 2017-06-21 07:50:43

Replying to [comment:5 jdemeyer]:
> I don't really like this idea.
> 
> 1. Having those scripts executable can be useful for debugging.

I'm not aware of any scenario that's impeded by this.  Could you give me an example?

> 2. I would still want to keep the check `if [ "$SAGE_LOCAL" = "" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.

Right, as I wrote in the ticket I would still keep this guard, and the goal is not to remove it.  That said, I don't see why this is a big deal.  I'm not aware of any other packaging system that worries about this.  If the consequences can be "severe" that's maybe a bigger problem.

In any case, checking `$SAGE_LOCAL` isn't always completely sufficient either, to prevent unwanted side-effects.  What I'm proposing I believe is a lot safer because it discourages execution of these scripts outside of the appropriate context.

> 3. Too much magic makes the logic harder to understand.

I've tried giving this some thought, but to be honest I really don't know what you mean by this at all.


---

Comment by jdemeyer created at 2017-06-22 08:33:33

> I'm not aware of any other packaging system that worries about this.

Well, other packaging systems aren't written in a very fragile language like `bash` :-)

Anyway, let me reconsider this ticket. I am starting to understand better why it's useful.


---

Comment by embray created at 2017-06-22 14:44:57

True, but as far as I can tell the problem here is not that what language the packaging system itself, however you define that, is written in.

The way I see it, on most systems, the danger of accidentally installing outside SAGE_LOCAL is mitigated by permissions--you wouldn't be running these scripts with `sudo`.  And if you _are_ doing anything with `sudo` it sort of becomes your responsibility what happens.

I think at the end of the day this makes our scripts _safer_ because they are no executable by default (if you really wanted to you could still run them with `bash <filename>`), and the wrapped scripts will always source the correct sage-env for the Sage that you're installing into.


---

Comment by jdemeyer created at 2017-06-23 13:31:17

1. Instead of this:

```
if [ -f "/usr/local/src/sage-config/src/bin/sage-env" ]; then
    . "/usr/local/src/sage-config/src/bin/sage-env"
else
    echo >&2 "Error: sage-env not found; is /usr/local/src/sage-config the correct SAGE_ROOT?"
    exit 1
fi
```

I would prefer something more like

```
source "/usr/local/src/sage-config/src/bin/sage-env"
if [ $? -ne 0 ]; then
    echo >&2 "Error: failed to source sage-env; is /usr/local/src/sage-config the correct SAGE_ROOT?"
    exit 1
fi
```

At the very least, you need to check for errors when sourcing `sage-env`.

2. If you really want to make the `spkg-install` script be usable outside of a Sage shell, starting with a `cd` statement into the correct directory would be good too. Otherwise you get

```
$ /usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install 
/usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install: line 45: ./configure: No such file or directory
Error configuring GNU patch
```


3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.

4. For readability, assign `".tmp-$script"` to a variable: `tmpscript=".tmp-$script"`.

5. In `sage-spkg`, there is a check for a `spkg-install` implemented in Python. That is obsolete now.


---

Comment by jdemeyer created at 2017-06-23 13:31:27

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-23 13:39:33

6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.


---

Comment by embray created at 2017-06-26 08:56:47

Replying to [comment:11 jdemeyer]:
> 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.

That can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.


---

Comment by embray created at 2017-06-26 09:00:59

Replying to [comment:9 jdemeyer]:
> 3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.

These options are available on BSD grep as well, including on OSX.  If someone can point out a specific implementation where they're not then I can change it.


---

Comment by jdemeyer created at 2017-06-26 09:17:01

Replying to [comment:13 embray]:
> If someone can point out a specific implementation where they're not then I can change it.

Since you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.


---

Comment by embray created at 2017-06-26 09:35:02

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 embray]:
> > If someone can point out a specific implementation where they're not then I can change it.
> 
> Since you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.

Okay, that's fine--obviously all of these alternatives are possible just annoying.


---

Comment by embray created at 2017-06-27 08:04:23

Replying to [comment:12 embray]:
> Replying to [comment:11 jdemeyer]:
> > 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.
> 
> That can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.

Perhaps for Cygwin I could just output a warning, but make it an error everywhere else, where presumably we can rely on permissions being sane.


---

Comment by git created at 2017-06-27 08:56:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-06-27 08:58:28

I think this addresses all your comments so far.  If this needs any further tweaks that's fine, but even if not please set this back to _needs work_ so that I can work on updating the developer documentation, assuming there are no further objections to this in principle.


---

Comment by embray created at 2017-06-27 08:58:28

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-06-27 09:06:16

Sorry, I think there's a bug somewhere.


---

Comment by embray created at 2017-06-27 09:06:16

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-06-27 09:10:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-06-27 09:11:15

Seems fine now; just had a stupid typo.


---

Comment by embray created at 2017-06-27 09:11:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-06-27 09:31:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-06-27 09:38:43

To be clear: I have no further objections to the principle (you convinced me).


---

Comment by embray created at 2017-06-27 11:52:31

Okay, thanks--I'll work on the documentation updates then.


---

Comment by jdemeyer created at 2017-06-28 21:08:05

I just built Sage from scratch with this branch and it worked.


---

Comment by embray created at 2017-06-29 13:43:50

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-06-29 13:43:50

Thanks; I'll work on updating the documentation.


---

Comment by git created at 2017-06-30 08:07:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-06-30 14:28:56

So your plan is to change _only_ the documentation and nothing else?

I am asking because I want to give the final version of the code another round of testing. But that is only meaningful if you are not going to change the code.


---

Comment by embray created at 2017-07-03 09:22:26

I don't plan to make any further updates to the code on this ticket, unless you or someone else comes up with a suggestion.


---

Comment by jdemeyer created at 2017-07-04 09:12:55

`$?` should be quoted otherwise you get
{{{#!/usr/bin/env bash

source "/opt/sage/sage-test/src/bin/sage-env"
if [ 0 -ne 0 ]; then
    echo >&2 "Error: failed to source sage-env; is /opt/sage/sage-test the correct SAGE_ROOT?"
    exit 1
fi

cd "/opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2"
if [ 0 -ne 0 ]; then
    echo >&2 "Error: could not cd to the package build directory /opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2"
    exit 1
fi
```


I wonder why you don't use a here document for this:

```
cat <<EOF
...
EOF
```

That way, there would no need to quote `"`.


---

Comment by embray created at 2017-07-04 09:48:42

Oops, good catch.  I don't know why I didn't use a heredoc either.  Maybe just because it started out shorter.


---

Comment by git created at 2017-07-04 14:17:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-07-05 12:31:51

This breaks old-style packages:

```
$ ./sage -p cluster_seed
Found package cluster_seed in /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
cluster_seed-1.0
====================================================
Extracting package /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
-rw-r--r-- 1 jdemeyer jdemeyer 150910 Jul  5 14:26 /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
Finished extraction
No patch files found in ../patches
************************************************************************
spkg-install should not be marked executable in the                 build/pkgs directory
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /opt/sage/sage-test/logs/pkgs/cluster_seed-1.0.log
Describe your computer, operating system, etc.
************************************************************************
```


Now I see two solutions to this: either you need to bypass the boilerplate stuff from this ticket for old-style packages, or we need to drop support for old-style packages completely.

I will write to sage-devel to ask opinions about the latter.

Minor note: this causes excessive whitespace:

```
            msg="spkg-$script should not be marked executable in the \
                build/pkgs directory"
```

I would just put this on one line.


---

Comment by embray created at 2017-07-05 12:49:02

Ah, you're right about the whitespace. On the REPL it will strip the leading whitespace but not in a script.  Too bad, but okay.

Yeah, I actually wasn't sure what this would do with "old style" packages. I figured if someone cared they would point it out.  I've just never actually _seen_ one of these old-style packages and wouldn't know where to find one.

I'd be all for removing support entirely, but obviously that should be a separate issue.  In the meantime I make exceptions for them.


---

Comment by embray created at 2017-07-06 09:53:18

One idea that came to me while updating the docs, though possibly a bit too surprising: The current docs explicitly state that `spkg-install` can be either a shell script or a Python script (though I don't think there's anything stopping it from being an arbitrary executable).  The Python case, in the very least, could still be supported though.  The way I handled the few existing Python scripts is quite mechanical--simply rename the Python `spkg-install` to `spkg-install.py`, and run `exec sage-python23 spkg-install.py` in the actual `spkg-install`.  This mechanism of wrapping Python scripts could just as easily be automated.  Not sure if it's worth the trouble though--it's probably simpler to just require it to be a bash script, full stop.


---

Comment by embray created at 2017-07-06 10:01:57

Presumably this won't be in Sage 8.0 since it's already in the release candidate stage...


---

Comment by jdemeyer created at 2017-07-06 10:20:32

Replying to [comment:35 embray]:
> it's probably simpler to just require it to be a bash script, full stop.

I agree. I think it suffices to mention in the docs how to support a Python install script using `sage-python23`.


---

Comment by git created at 2017-07-06 10:22:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-07-06 10:22:44

Restored support for old-style packages (still needs to be tested), updated developer docs, and rebased on latest develop branch.


---

Comment by embray created at 2017-07-06 10:23:54

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-07-06 10:25:54

(Ran `./sage -p cluster_seed` and it worked fine--in short, for old-style packages it just uses the unmodified `spkg-install` as before).


---

Comment by git created at 2017-07-12 11:29:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-12 12:29:12

I'm researching open package update tickets with patches that could conflict with this (specifically, those that update `spkg-install`--if they don't then there shouldn't be much conflict).

Tickets with positive review:
* #23023
* #23357

Tickets still needing work/review:
* #13268
* #13426
* #14645
* #15674
* #18197
* #18514
* #19680
* #19719
* #20922
* #21170
* #21525
* #21888
* #22072
* #23024
* #23325
* #23353

The following old tickets conflict with #20136 (or other more recent changes) and will need to be rebased anyways:
* #5310
* #10879
* #15209
* #15813
* #18749
* #19706
* #20670

Since tickets like this one (and #22509 + #22510) that make mass updates to packages are notoriously unwieldy it would be good to get merged quickly if/when it has a positive review.

To that end, I can make this depend on #23023 and #23357 since they already have positive review.  Of the tickets still needing work, it might be nice if some of them added this ticket as a dependency (especially #23325 and #23353 since they were opened later) but if they can be given a positive review quickly, I also have no problem adding them as dependencies to this ticket.  Most of the other tickets on that list either haven't been updated for several months, or are still in development, so I would prefer not to wait on them unless I hear otherwise.


---

Comment by jdemeyer created at 2017-07-12 12:31:30

There is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z "$PKG_OLD_STYLE" ]` by `[ "$USE_LOCAL_SCRIPTS" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.


---

Comment by jdemeyer created at 2017-07-12 12:33:14

Replying to [comment:43 embray]:
> To that end, I can make this depend on #23023 and #23357

As far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).

There _is_ a conflict with #23023 since that actually adds a new package.


---

Comment by embray created at 2017-07-12 12:35:26

Replying to [comment:44 jdemeyer]:
> There is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z "$PKG_OLD_STYLE" ]` by `[ "$USE_LOCAL_SCRIPTS" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.

Note: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.  I thought it would help make clearer which bits to remove upon removing support for old-style packages which I guess will happen soon anyways.


---

Comment by embray created at 2017-07-12 12:36:03

Replying to [comment:45 jdemeyer]:
> Replying to [comment:43 embray]:
> > To that end, I can make this depend on #23023 and #23357
> 
> As far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).

Agreed, and same for a few others on the list, but I wanted to be on the safe side.


---

Comment by jdemeyer created at 2017-07-12 12:39:50

Replying to [comment:46 embray]:
> Note: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.

It's pretty explicit:

```
##################################################################
# Extract the package
##################################################################

if [ "$USE_LOCAL_SCRIPTS" = yes ]; then
    # New-style package
    ...
else
    # Old-style package (deprecated)
    ...
fi
```


I'm -1 on adding a new variable just because you find that an existing variable has a confusing name. If you don't like the name `USE_LOCAL_SCRIPTS`, you can just change the name everywhere.


---

Comment by embray created at 2017-07-12 12:43:28

Yeah, I see your point.  In retrospect I didn't even understand why it was called "USE_LOCAL_SCRIPTS" but I guess that is actually synonymous with "new-style package".

I'll just remove the commit that added the new variable and the rest should fall into place.


---

Comment by jdemeyer created at 2017-07-12 12:45:56

Good! After that, I'll do a (hopefully) final round of testing and then it should be good to go.


---

Comment by jdemeyer created at 2017-07-12 12:46:50

I don't mind to rebase #23023 on top of this ticket, I think that would be better.


---

Comment by git created at 2017-07-12 12:48:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-07-12 12:49:57

Okay, done.

I should say, since I wasn't my best self a couple weeks ago, that I always appreciate your meticulous reviews whether or not we agree on everything.


---

Comment by jdemeyer created at 2017-07-12 12:52:59

Typo: `neecessarily`


---

Comment by jdemeyer created at 2017-07-12 12:53:23

Typo: `enforsed`


---

Comment by git created at 2017-07-12 13:06:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-07-12 23:31:45

For info I have marked #15674 in your list as duplicate since it was superseded by #22817 which was merged.


---

Comment by jdemeyer created at 2017-07-13 09:55:20

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-07-13 10:11:39

Setting to blocker to get the attention of the release manager.

Volker: since this touches a lot of files, it would be best to merge this early in Sage 8.1 to avoid conflicts.


---

Comment by jdemeyer created at 2017-07-13 10:11:39

Changing priority from major to blocker.


---

Comment by vbraun created at 2017-07-21 19:08:22

Changing priority from blocker to major.


---

Comment by vbraun created at 2017-07-23 22:46:31

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-07-23 22:46:31


```
Successfully installed scipy-0.17.1.p0
Running the test suite for scipy-0.17.1.p0...
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/bin/python2: can't open file 'sage-check.py': [Errno 2] No such file or directory
```



---

Comment by jdemeyer created at 2017-07-24 13:46:27

Typo: `sage-check.py` -> `spkg-check.py`


---

Comment by git created at 2017-07-31 12:07:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-07-31 12:08:38

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-07-31 12:08:38

This was just a typo as confirmed by Jeroen so I'll set it back to positive review.


---

Comment by vbraun created at 2017-08-01 22:25:12

Resolution: fixed


---

Comment by fbissey created at 2017-08-01 23:43:54

I just flagged #23498 which was merged at the same time for follow up. Do we have a ticket for mopping up any new/upgrade packages that will trickle in until people are fully aware of the new system? We may have to do a bit of spotting and pre-emptive reviewing for a while.


---

Comment by embray created at 2017-08-07 09:00:07

I mean, I made a big list of tickets that are affected by this: #23179#comment:45  But #23498 slipped through the cracks.


---

Comment by fbissey created at 2017-08-07 09:47:00

Yes the list of "older" ticket is fine. I already warned one upgrade (arb) on rebasing on this ticket before 8.1.beta1 was released. But apart from those one, we need to be careful of new package/upgrade ticket for a while as well.
