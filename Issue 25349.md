# Issue 25349: py3: adding some hash function

Issue created by migration from https://trac.sagemath.org/ticket/25586

Original creator: chapoton

Original creation time: 2018-06-15 18:31:37

CC:  tscrim embray jdemeyer

for congruence groups and fraction fields

+ a few other details


---

Comment by chapoton created at 2018-06-15 18:32:11

New commits:


---

Comment by chapoton created at 2018-06-15 18:32:11

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-06-16 06:15:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-06-16 06:15:52

some failing doctests


---

Comment by git created at 2018-06-16 07:19:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-16 07:19:21

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-06-17 08:23:23

Similar to #25591: the hash of a fraction field should be different from the hash of its underlying ring.

What you did for congruence subgroups is not a very good idea as it will break equality

```
sage: G = Gamma(2)
sage: H = G.as_permutation_group()
sage: G == H
True
```

One (expensive) possibility for now would be

```
def __hash__(self):
    return hash(self.as_permutation_group())
```



---

Comment by vdelecroix created at 2018-06-17 08:23:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-17 08:53:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-17 08:53:26

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-17 08:53:26

Merci. C'est fait aussi.


---

Comment by chapoton created at 2018-06-20 18:11:58

ping ?


---

Comment by vdelecroix created at 2018-06-20 18:18:05

désolé... d'autres sollicitations.


---

Comment by vdelecroix created at 2018-06-20 18:18:05

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-06-20 18:20:44

Je comprends. Merci beaucoup.


---

Comment by vbraun created at 2018-06-22 18:31:57

See patchbot


---

Comment by vbraun created at 2018-06-22 18:31:57

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-06-23 06:32:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-06-23 06:34:28

the case of congruence groups being harder, it is no longer handled here.


---

Comment by chapoton created at 2018-06-23 06:34:28

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-27 07:22:09

ping ? I have removed the controversial part..

EDIT: and this is an important ticket for progress in python3


---

Comment by chapoton created at 2018-06-27 16:49:43

and bot is green


---

Comment by chapoton created at 2018-06-28 07:21:53

please, someone ?


---

Comment by tscrim created at 2018-06-28 09:17:45

LGTM.


---

Comment by tscrim created at 2018-06-28 09:17:45

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-06-28 15:14:08

More `list(map(...))`s that might as well be list comprehensions:


```diff
diff --git a/src/sage/manifolds/differentiable/affine_connection.py b/src/sage/manifolds/differentiable/affine_connection.py
index e1d6601..e307a9c 100644
--- a/src/sage/manifolds/differentiable/affine_connection.py
+++ b/src/sage/manifolds/differentiable/affine_connection.py
@@ -1186,8 +1186,8 @@ class AffineConnection(SageObject):
         if index_labels is None and isinstance(frame, CoordFrame) and \
           coordinate_labels:
             ch = frame.chart()
-            index_labels = map(str, ch[:])
-            index_latex_labels = map(latex, ch[:])
+            index_labels = list(map(str, ch[:]))
+            index_latex_labels = list(map(latex, ch[:]))
         return self.coef(frame=frame).display(symbol,
               latex_symbol=latex_symbol, index_positions='udd',
               index_labels=index_labels, index_latex_labels=index_latex_labels,
```


I think I've mentioned elsewhere (and forgive me if this concern was dismissed and I didn't see it), but I don't like these usesless hash example tests like:


```diff
diff --git a/src/sage/rings/fraction_field.py b/src/sage/rings/fraction_field.py
index 201e132..024d83d 100644
--- a/src/sage/rings/fraction_field.py
+++ b/src/sage/rings/fraction_field.py
@@ -688,6 +688,16 @@ class FractionField_generic(ring.Field):
         """
         return not (self == other)
 
+    def __hash__(self):
+        """
+        Compute the hash of ``self``.
+
+        EXAMPLES::
+
+            sage: h = hash(Frac(ZZ['x']))
+        """
+        return hash(self._R) ^ 147068341996611
+
     def ngens(self):
         """
         This is the same as for the parent object.
```


All this tests is that, at best, it doesn't crash (which is almost completely trivial).  It should instead demonstrate at least a case where two hashes compare the same as expected, and where two hashes differ, as expected.

I agree it's annoying to write these tests which is why I've been pokey about making tickets for `__hash__` implementations in the first place :)


---

Comment by embray created at 2018-06-28 15:14:08

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-06-28 15:57:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-28 15:57:44

done


---

Comment by chapoton created at 2018-06-28 15:57:44

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-06-29 09:21:02

This is a stupid question and I think I might have already answered it in my head but, just for my edification:


```diff
diff --git a/src/sage/rings/fraction_field.py b/src/sage/rings/fraction_field.py
index 201e132..909f10b 100644
--- a/src/sage/rings/fraction_field.py
+++ b/src/sage/rings/fraction_field.py
@@ -688,6 +688,21 @@ class FractionField_generic(ring.Field):
         """
         return not (self == other)
 
+    def __hash__(self):
+        """
+        Compute the hash of ``self``.
+
+        EXAMPLES::
+
+            sage: h0 = hash(Frac(ZZ['x']))
+            sage: h1 = hash(Frac(ZZ['x']))
+            sage: h2 = hash(Frac(QQ['x']))
+            sage: h3 = hash(ZZ['x'])
+            sage: h0 == h1 and h1 != h2 and h1 != h3
+            True
+        """
+        return hash(self._R) ^ 147068341996611
+
     def ngens(self):
         """
         This is the same as for the parent object.
```


Why not just `hash(self._R)`?  Is it possible for instances of these fields to have a parent ring that's equivalent to itself, or something (in which case we'd need this in order for them to have unique hashes)?  And where does the magic number come from?


---

Comment by chapoton created at 2018-06-29 09:22:53

This was modeled after the case of Laurent Polynomial at the request of Vincent, to avoid having trivially the same hash. The number is a random number.


---

Comment by embray created at 2018-06-29 09:27:34

I see, he wrote:

> For Laurent polynomial ring it is not a good idea to give it the same hash as the underlying multi-polynomial ring. You would better xor it with a random number

But why is that?  It doesn't matter if they have the same hash unless they can also compare equal to each other.

In any case, even if there is a good reason, this should probably be noted.  It's not obvious.


---

Comment by embray created at 2018-06-29 09:30:13

My guess is that maybe you can have a polynomial ring over elements of another polynomial ring, so in that case it does make sense to do that.


---

Comment by chapoton created at 2018-06-29 14:04:23

Do you want a note in the doc of the hash method ?


---

Comment by embray created at 2018-06-29 14:31:22

In the doc or just in a comment.  Up to you.


---

Comment by git created at 2018-06-29 17:27:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-29 17:28:00

done


---

Comment by chapoton created at 2018-07-01 06:00:33

ping ?


---

Comment by chapoton created at 2018-07-03 06:06:30

PING ? This is a major hurting point..


---

Comment by vdelecroix created at 2018-07-03 06:29:13

Replying to [comment:23 embray]:
> This is a stupid question and I think I might have already answered it in my head but, just for my edification:
> 
> {{{
> #!diff
> diff --git a/src/sage/rings/fraction_field.py b/src/sage/rings/fraction_field.py
> index 201e132..909f10b 100644
> --- a/src/sage/rings/fraction_field.py
> +++ b/src/sage/rings/fraction_field.py
> `@``@` -688,6 +688,21 `@``@` class FractionField_generic(ring.Field):
>          """
>          return not (self == other)
>  
> +    def __hash__(self):
> +        """
> +        Compute the hash of ``self``.
> +
> +        EXAMPLES::
> +
> +            sage: h0 = hash(Frac(ZZ['x']))
> +            sage: h1 = hash(Frac(ZZ['x']))
> +            sage: h2 = hash(Frac(QQ['x']))
> +            sage: h3 = hash(ZZ['x'])
> +            sage: h0 == h1 and h1 != h2 and h1 != h3
> +            True
> +        """
> +        return hash(self._R) ^ 147068341996611
> +
>      def ngens(self):
>          """
>          This is the same as for the parent object.
> }}}
> 
> Why not just `hash(self._R)`?

To avoid collisions. We do have dictionaries whose keys are parent (e.g. coercions).


---

Comment by vdelecroix created at 2018-07-03 06:32:26

For matter of equality, it is true that the polynomial ring on the zero ring is isomorphic to the base ring. Though, Sage does not know about it.

```
sage: S = Zmod(1)
sage: R = S['x']
sage: S == R
False
```

And even worse

```
sage: f = R.coerce_map_from(S)
sage: f.is_injective()
True
sage: f.is_surjective()
False
```



---

Comment by vdelecroix created at 2018-07-03 06:34:11

([EDITED] see ~~#25586~~ #25753 for the bug about surjectivity)


---

Comment by tscrim created at 2018-07-03 07:27:22

Replying to [comment:35 vdelecroix]:
> (see #25586 for the bug about surjectivity)

See this ticket?

I am going to set this back to positive review as Erik's concerns have been addressed.


---

Comment by tscrim created at 2018-07-03 07:27:22

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-07-03 07:27:22

Changing keywords from "" to "days94".


---

Comment by vdelecroix created at 2018-07-03 07:48:25

Replying to [comment:36 tscrim]:
> Replying to [comment:35 vdelecroix]:
> > (see #25586 for the bug about surjectivity)
> 
> See this ticket?

Oups: #25753

> I am going to set this back to positive review as Erik's concerns have been addressed.


---

Comment by vbraun created at 2018-07-08 13:05:11

Resolution: fixed


---

Comment by embray created at 2018-07-10 12:56:38

Replying to [comment:32 chapoton]:
> PING ? This is a major hurting point..

Please try to show some patience.  I have tickets that I believe are important that haven't been merged or even reviewed in months (a situation I'm not happy with, but there is only so much attention to go around).

If you've already fixed the issue then there's nothing holding you back--this is why I have my private Python 3 branch--everything I fix gets merged into it immediately and then I can carry on (even if that fix is not ultimately the accepted fix; at least it works in the meantime).

The rest of us have vacations, family, sickness, and other tasks to work on and adding "ping" to a ticket does not (at least in my case) make it any more likely that I'll see it sooner.
