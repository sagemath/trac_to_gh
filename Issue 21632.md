# Issue 21632: A framework for discrete valuations in Sage

Issue created by migration from https://trac.sagemath.org/ticket/21869

Original creator: saraedum

Original creation time: 2016-11-12 22:09:06

Keywords: discrete valuations, valuations, p-adics, function fields, number fields, smooth projective curves, Mac Lane algorithm, Montes algorithm

This is a meta-ticket to keep track of the progress of integrating https://github.com/saraedum/sage/releases into Sage.


---

Comment by roed created at 2017-07-17 17:34:49

Changing keywords from "discrete valuations, valuations, p-adics, function fields, number fields, smooth projective curves, Mac Lane algorithm, Montes algorithm" to "discrete valuations, valuations, p-adics, function fields, number fields, smooth projective curves, Mac Lane algorithm, Montes algorithm,sd87".


---

Comment by roed created at 2017-07-17 17:34:49

Last 10 new commits:


---

Comment by git created at 2017-07-19 07:24:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-19 07:26:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-19 07:42:19

New commits:


---

Comment by saraedum created at 2017-07-19 07:51:15

Changing status from new to needs_review.


---

Comment by padma_sk created at 2017-07-19 16:50:21

I was reviewing gauss_valuation.py and tried reducing a polynomial using the Gauss valuation induced by the 2-adic valuation, and got an unexpected error message. I thought it would tell me that the polynomial wasn't integral, and instead it gave me a coercion error.


```
sage: v
Gauss valuation induced by 2-adic valuation
sage: v.domain()
Univariate Polynomial Ring in y over Integer Ring
sage: h
1/2*y^2
sage: v.reduce(h)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-108-4d78566b468b> in <module>()
----> 1 v.reduce(h)
 
/projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/gauss_valuation.py in reduce(self, f, check, degree_bound, coefficients, valuations)
    360
    361         """
--> 362         f = self.domain().coerce(f)
    363
    364         if degree_bound is not None:
 
/usr/local/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (/usr/local/sage/src/build/cythonized/sage/structure/parent.c:11229)()
   1166             return False
   1167
-> 1168     cpdef coerce(self, x):
   1169         """
   1170         Return x as an element of self, if and only if there is a canonical
 
/usr/local/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (/usr/local/sage/src/build/cythonized/sage/structure/parent.c:11158)()
   1193                 except Exception:
   1194                     _record_exception()
-> 1195             raise TypeError("no canonical coercion from %s to %s" % (parent(x), self))
   1196         else:
   1197             return (<map.Map>mor)._call_(x)
 
TypeError: no canonical coercion from Univariate Polynomial Ring in y over Rational Field to Univariate Polynomial Ring in y over Integer Ring


```



---

Comment by padma_sk created at 2017-07-19 19:45:04

equivalence_unit from gauss_valuation.py isn't outputting the results shown in the example input -2 as shown in the file.



```
sage: v
Gauss valuation induced by 2-adic valuation
sage: v.domain()
Univariate Polynomial Ring in y over Integer Ring
sage: v.equivalence_unit(2)
4
sage: v.equivalence_unit(-2)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-128-71aadb857663> in <module>()
----> 1 v.equivalence_unit(-Integer(2))
 
/usr/local/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (/usr/local/sage/src/build/cythonized/sage/misc/cachefunc.c:1079
2)()
   2036                 return cache[k]
   2037         except KeyError:
-> 2038             w = self._instance_call(*args, **kwds)
   2039             cache[k] = w
   2040             return w
 
/usr/local/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (/usr/local/sage/src/build/cythonized/sage/misc/cachefunc.
c:10238)()
   1912             True
   1913         """
-> 1914         return self.f(self._instance, *args, **kwds)
   1915
   1916     cdef fix_args_kwds(self, tuple args, dict kwds):
 
/projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/gauss_valuation.py in equivalence_unit(self, s, reciprocal)
    474             return self.equivalence_reciprocal(self.equivalence_unit(-s))
    475
--> 476         ret = self._base_valuation.element_with_valuation(s)
    477         return self.domain()(ret)
    478
 
/projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/valuation_space.py in element_with_valuation(self, s)
    465             s = QQ.coerce(s)
    466             if s not in self.value_semigroup():
--> 467                 raise ValueError("s must be in the value semigroup of this valuation but %r is not in %r"%(s, self.value_semigroup()))
    468             if s == 0:
    469                 return self.domain().one()
 
ValueError: s must be in the value semigroup of this valuation but -2 is not in Additive Abelian Semigroup generated by 1
```



---

Comment by saraedum created at 2017-07-19 20:05:46

Thanks for reporting this. I think this is ok. The problem here is not that the polynomial is not integral but that the polynomial is not in the domain.

This works:

```
sage: R.<x> = QQ[]
sage: v = valuations.GaussValuation(R, QQ.valuation(2))
sage: v.reduce(x + 1/2)
ValueError: reduction not defined for non-integral elements and x + 1/2 is not integral over Gauss valuation induced by 2-adic valuation
```


This does not:

```
sage: R.<x> = ZZ[]
sage: v = valuations.GaussValuation(R, ZZ.valuation(2))
sage: v.reduce(x + 1/2)
TypeError: no canonical coercion from Univariate Polynomial Ring in x over Rational Field to Univariate Polynomial Ring in x over Integer Ring
```


Replying to [comment:36 padma_sk]:
> I was reviewing gauss_valuation.py and tried reducing a polynomial using the Gauss valuation induced by the 2-adic valuation, and got an unexpected error message. I thought it would tell me that the polynomial wasn't integral, and instead it gave me a coercion error.
> 
> {{{
> sage: v
> Gauss valuation induced by 2-adic valuation
> sage: v.domain()
> Univariate Polynomial Ring in y over Integer Ring
> sage: h
> 1/2*y^2
> sage: v.reduce(h)
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> <ipython-input-108-4d78566b468b> in <module>()
> ----> 1 v.reduce(h)
>  
> /projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/gauss_valuation.py in reduce(self, f, check, degree_bound, coefficients, valuations)
>     360
>     361         """
> --> 362         f = self.domain().coerce(f)
>     363
>     364         if degree_bound is not None:
>  
> /usr/local/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (/usr/local/sage/src/build/cythonized/sage/structure/parent.c:11229)()
>    1166             return False
>    1167
> -> 1168     cpdef coerce(self, x):
>    1169         """
>    1170         Return x as an element of self, if and only if there is a canonical
>  
> /usr/local/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.coerce (/usr/local/sage/src/build/cythonized/sage/structure/parent.c:11158)()
>    1193                 except Exception:
>    1194                     _record_exception()
> -> 1195             raise TypeError("no canonical coercion from %s to %s" % (parent(x), self))
>    1196         else:
>    1197             return (<map.Map>mor)._call_(x)
>  
> TypeError: no canonical coercion from Univariate Polynomial Ring in y over Rational Field to Univariate Polynomial Ring in y over Integer Ring
> 
> 
> }}}
>


---

Comment by saraedum created at 2017-07-19 20:08:49

You are in the wrong domain in this example I think:
This is the error you are seeing because there is no element of valuation -2 in `ZZ[x]`.

```
sage: R.<x> = ZZ[]
sage: v = valuations.GaussValuation(R, ZZ.valuation(2))
sage: v.element_with_valuation(-2)
ValueError: s must be in the value semigroup of this valuation but -2 is not in Additive Abelian Semigroup generated by 1
```


However, this works in `QQ[x]`.

```
sage: sage: R.<x> = QQ[]
sage: v = valuations.GaussValuation(R, QQ.valuation(2))
sage: v.element_with_valuation(-2)
1/4
```


Does that make sense? (Should it be documented more explicitly?)


Replying to [comment:37 padma_sk]:
> equivalence_unit from gauss_valuation.py isn't outputting the results shown in the example input -2 as shown in the file.
> 
> 
> {{{
> sage: v
> Gauss valuation induced by 2-adic valuation
> sage: v.domain()
> Univariate Polynomial Ring in y over Integer Ring
> sage: v.equivalence_unit(2)
> 4
> sage: v.equivalence_unit(-2)
> ---------------------------------------------------------------------------
> ValueError                                Traceback (most recent call last)
> <ipython-input-128-71aadb857663> in <module>()
> ----> 1 v.equivalence_unit(-Integer(2))
>  
> /usr/local/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (/usr/local/sage/src/build/cythonized/sage/misc/cachefunc.c:1079
> 2)()
>    2036                 return cache[k]
>    2037         except KeyError:
> -> 2038             w = self._instance_call(*args, **kwds)
>    2039             cache[k] = w
>    2040             return w
>  
> /usr/local/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (/usr/local/sage/src/build/cythonized/sage/misc/cachefunc.
> c:10238)()
>    1912             True
>    1913         """
> -> 1914         return self.f(self._instance, *args, **kwds)
>    1915
>    1916     cdef fix_args_kwds(self, tuple args, dict kwds):
>  
> /projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/gauss_valuation.py in equivalence_unit(self, s, reciprocal)
>     474             return self.equivalence_reciprocal(self.equivalence_unit(-s))
>     475
> --> 476         ret = self._base_valuation.element_with_valuation(s)
>     477         return self.domain()(ret)
>     478
>  
> /projects/da1818ed-996d-4de6-acc6-361415b7725d/user/padma_sk/mac_lane/valuation_space.py in element_with_valuation(self, s)
>     465             s = QQ.coerce(s)
>     466             if s not in self.value_semigroup():
> --> 467                 raise ValueError("s must be in the value semigroup of this valuation but %r is not in %r"%(s, self.value_semigroup()))
>     468             if s == 0:
>     469                 return self.domain().one()
>  
> ValueError: s must be in the value semigroup of this valuation but -2 is not in Additive Abelian Semigroup generated by 1
> }}}


---

Comment by gpark created at 2017-07-20 15:48:01

Ran the test and found the error:

sage -t src/sage/rings/function_field/function_field.py  # 7 doctests failed


---

Comment by gpark created at 2017-07-20 15:48:01

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2017-07-20 17:25:50

Replying to [comment:45 gpark]:
> Ran the test and found the error:
> 
> sage -t src/sage/rings/function_field/function_field.py  # 7 doctests failed
Did you run the tests with all the dependencies applied? About 50 tests fail for me. That's expected (since the dependencies are not in yet.)


---

Comment by saraedum created at 2017-07-20 17:48:27

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2017-07-20 18:38:41

The following errors are expected. I am working on them.

```
----------------------------------------------------------------------
sage -t --warn-long 39.1 src/sage/rings/valuation/limit_valuation.py  # 52 doctests failed
sage -t --warn-long 39.1 src/sage/rings/valuation/gauss_valuation.py  # 1 doctest failed
sage -t --warn-long 39.1 src/sage/rings/valuation/valuation_space.py  # 2 doctests failed
sage -t --warn-long 39.1 src/sage/rings/valuation/mapped_valuation.py  # 42 doctests failed
sage -t --warn-long 39.1 src/sage/rings/valuation/valuation.py  # 9 doctests failed
sage -t --warn-long 39.1 src/sage/rings/valuation/inductive_valuation.py  # 13 doctests failed
sage -t --warn-long 39.1 src/sage/rings/valuation/augmented_valuation.py  # 16 doctests failed
----------------------------------------------------------------------
```



---

Comment by saraedum created at 2017-07-20 18:51:03

Sorry, I somehow reverted some changes to the ticket description. Not sure how this happened.


---

Comment by swewers created at 2017-07-20 20:46:54

I have had a look at ``function_field_valuation``. I have already worked with the code a lot, and it is working fine, and the documentation is extensive and clear. But I have only tested the latest standalone version.


---

Comment by git created at 2017-07-20 21:59:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 22:01:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 22:07:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 22:33:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 22:41:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-20 22:43:59

New commits:


---

Comment by git created at 2017-07-20 22:54:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 22:56:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-20 22:57:58

New commits:


---

Comment by git created at 2017-07-21 01:47:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-07-21 02:08:19

New commits:


---

Comment by roed created at 2017-07-21 02:10:20

Oops.  Reverting.


---

Comment by git created at 2017-07-21 02:26:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:19:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:25:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-07-22 06:25:54

Changing type from task to enhancement.


---

Comment by roed created at 2017-07-22 06:25:54

New commits:


---

Comment by git created at 2017-07-22 06:33:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:36:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-07-22 06:36:57

New commits:


---

Comment by git created at 2017-07-22 06:50:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:56:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:58:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 06:59:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:01:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:33:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:46:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:48:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 07:57:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 08:15:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 16:03:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 16:43:03

New commits:


---

Comment by git created at 2017-07-22 20:44:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 20:45:11

New commits:


---

Comment by git created at 2017-07-22 21:06:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 21:06:58

New commits:


---

Comment by git created at 2017-07-22 21:41:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 21:42:00

New commits:
----
New commits:


---

Comment by git created at 2017-07-22 21:54:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 21:54:47

New commits:


---

Comment by git created at 2017-07-22 22:04:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:13:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:15:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:22:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:24:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:32:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:38:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:39:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 22:43:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-22 23:09:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-22 23:13:42

Last 10 new commits:


---

Comment by git created at 2017-07-22 23:21:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-23 03:13:56

New commits:


---

Comment by git created at 2017-07-23 03:46:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 03:51:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 03:53:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 03:59:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:02:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:12:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:23:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:26:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:34:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-23 04:36:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2017-07-23 07:05:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-23 07:09:55

New commits:


---

Comment by git created at 2017-07-23 07:40:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-23 07:41:19

New commits:


---

Comment by git created at 2017-07-23 07:46:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-23 07:46:37

New commits:


---

Comment by git created at 2017-07-23 08:02:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-23 08:02:28

New commits:


---

Comment by git created at 2017-07-24 13:48:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-24 13:51:13

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by saraedum created at 2017-07-24 13:55:34

Last 10 new commits:


---

Comment by git created at 2017-07-24 13:56:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-08-04 02:55:32

Doesn't seem "minor"....


---

Comment by roed created at 2017-08-04 02:55:32

Changing priority from minor to major.


---

Comment by git created at 2017-08-04 17:15:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-12 15:21:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-21 04:52:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-21 10:33:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mderickx created at 2017-08-31 04:16:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-20 16:28:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-20 16:38:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2017-09-20 16:47:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-09-20 16:48:25

David: I made a trivial change. I don't think it needs review.


---

Comment by roed created at 2017-09-20 16:51:54

Yeah, that change seems fine.


---

Comment by git created at 2017-09-20 19:34:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-04 05:25:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-04 07:27:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-04 07:31:02

New commits:


---

Comment by git created at 2017-10-05 05:58:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 05:59:19

New commits:
----
New commits:


---

Comment by git created at 2017-10-05 06:21:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 06:21:17

New commits:


---

Comment by git created at 2017-10-05 07:17:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 07:17:23

New commits:
----
New commits:


---

Comment by git created at 2017-10-05 08:08:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 08:25:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 08:40:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 08:49:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 08:55:08

New commits:
----
New commits:


---

Comment by git created at 2017-10-05 08:55:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 11:05:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 11:06:32

New commits:
----
New commits:


---

Comment by saraedum created at 2017-10-05 11:06:32

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-05 11:20:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 12:19:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-05 12:20:12

New commits:
----
New commits:


---

Comment by git created at 2017-10-05 23:54:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-06 00:00:26

New commits:


---

Comment by saraedum created at 2017-10-06 00:00:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-06 00:06:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-06 00:08:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-06 00:10:03

New commits:


---

Comment by git created at 2017-10-06 01:05:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-06 01:05:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-06 01:36:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-06 04:01:51

In `_test_shift` in `valuation_space.py`, you're not actually doing tests, just having lines with boolean statements.


---

Comment by roed created at 2017-10-06 04:43:11

In `index.rst` there are some `\QQ`s that should probably be `\Q`s.  Have you tried building the documentation recently?  I'm surprised this didn't cause problems....

Is there a place I can look at the generated documentation online?  It might be easier to catch some kinds of problems there.


---

Comment by roed created at 2017-10-06 05:10:00

In `function_field.py` there's a typo in `We create a valuation that correspond` (should be plural).


---

Comment by roed created at 2017-10-06 05:33:33

In `padic_valuation.py` you have `self.domain()(~ZpFM(self.p(), ZZ(precision).ceil())(x))`.  This is probably better done with the `inverse_mod` method in integers, since then you don't have to construct a new parent.  Also, if precision isn't integral, won't `ZZ(precision)` fail before you can call `ceil()` on it?


---

Comment by roed created at 2017-10-06 05:36:46

There are a few really long lines.  I don't really mind them, but they might be worth thinking about breaking up.  For example,

```
return self.domain().change_ring(self.domain())([0 if valuations[i] > error else self._base_valuation.simplify(c, error=error-i*self._mu, force=force, phiadic=True) for (i,c) in enumerate(coefficients)])(self.phi())
```



---

Comment by roed created at 2017-10-06 05:46:09

In the `montes_factorization` tests, why do you specify required precision be 0?  Runtime?  Feasibility of printing the result?


---

Comment by roed created at 2017-10-06 05:55:51

You should probably not delete `'reference/tensor_free_modules'` from `sage_setup/docbuild/__init__.py`.


---

Comment by roed created at 2017-10-06 05:56:58

In `index.rst`, where you do say `random output (order may vary)`, why not just use `sorted`?


---

Comment by roed created at 2017-10-06 06:04:13

Tests pass though!  I think we're almost there.


---

Comment by saraedum created at 2017-10-06 06:44:53

Replying to [comment:218 roed]:
> In `_test_shift` in `valuation_space.py`, you're not actually doing tests, just having lines with boolean statements.

Yes, fixed.


---

Comment by saraedum created at 2017-10-06 06:49:39

Replying to [comment:219 roed]:
> In `index.rst` there are some `\QQ`s that should probably be `\Q`s.  Have you tried building the documentation recently?  I'm surprised this didn't cause problems....
It did not seem to cause problems. But I changed it anyway.

> Is there a place I can look at the generated documentation online?  It might be easier to catch some kinds of problems there.
https://drugtestbots.info.tm/reference/valuations/index.html (still uploading)


---

Comment by saraedum created at 2017-10-06 06:50:03

Replying to [comment:220 roed]:
> In `function_field.py` there's a typo in `We create a valuation that correspond` (should be plural).

Ok. Fixed


---

Comment by git created at 2017-10-06 06:57:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-10-06 06:57:58

Replying to [comment:221 roed]:
> In `padic_valuation.py` you have `self.domain()(~ZpFM(self.p(), ZZ(precision).ceil())(x))`.  This is probably better done with the `inverse_mod` method in integers, since then you don't have to construct a new parent.  Also, if precision isn't integral, won't `ZZ(precision)` fail before you can call `ceil()` on it?
Thanks, all fixed.
----
New commits:
----
New commits:


---

Comment by saraedum created at 2017-10-06 07:05:14

Replying to [comment:222 roed]:
> There are a few really long lines.  I don't really mind them, but they might be worth thinking about breaking up.  For example,
> {{{
> return self.domain().change_ring(self.domain())([0 if valuations[i] > error else self._base_valuation.simplify(c, error=error-i*self._mu, force=force, phiadic=True) for (i,c) in enumerate(coefficients)])(self.phi())
> }}}

I tried to fix some of these.


---

Comment by saraedum created at 2017-10-06 07:06:18

Replying to [comment:223 roed]:
> In the `montes_factorization` tests, why do you specify required precision be 0?  Runtime?  Feasibility of printing the result?

Because of speed. It finds an exact factorization without which takes forever (I did not wait for it to terminate) as it is very slowly improving the quality of the approximation. I added a comment.


---

Comment by saraedum created at 2017-10-06 07:06:48

Replying to [comment:224 roed]:
> You should probably not delete `'reference/tensor_free_modules'` from `sage_setup/docbuild/__init__.py`.

Why not? It used to be the last item in this list, now valuations has taken its spot.


---

Comment by saraedum created at 2017-10-06 07:07:39

Replying to [comment:225 roed]:
> In `index.rst`, where you do say `random output (order may vary)`, why not just use `sorted`?

Because I want this to be a readable introduction. I think that sorting would make it much more cryptic to people who are not so fluent in python.


---

Comment by saraedum created at 2017-10-06 07:07:56

I think I addressed all your comments.


---

Comment by git created at 2017-10-06 07:08:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-06 09:00:52

Replying to [comment:234 saraedum]:
> Replying to [comment:224 roed]:
> > You should probably not delete `'reference/tensor_free_modules'` from `sage_setup/docbuild/__init__.py`.
> 
> Why not? It used to be the last item in this list, now valuations has taken its spot.

I was confused; it's okay.


---

Comment by roed created at 2017-10-06 09:04:56

I just merged in the last few dependencies and changed some whitespace in `valuation_space.py`.  Looks good to me!
----
New commits:


---

Comment by roed created at 2017-10-06 09:04:56

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-10-12 19:53:30

Do not implement both `_cmp_` and `_richcmp_`. The second one only please.


---

Comment by saraedum created at 2017-10-13 05:52:00

Ok. I removed the `_cmp_` implementation.
----
New commits:


---

Comment by vbraun created at 2017-10-15 21:21:44

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-15 21:21:44

PDF docs don't build


---

Comment by saraedum created at 2017-10-16 06:32:02

I can not build PDF docs locally (not sure why but it's not related to this ticket.) Can someone else try to fix this?


---

Comment by roed created at 2017-10-16 15:06:01

I'm giving it a shot.


---

Comment by roed created at 2017-10-17 08:05:32

I fixed some problems, but I'm not sure that I got them all since `make doc-clean && sage -docbuild reference pdf` doesn't seem to see my changes (and still complains about the unicode <= symbol).  I'm not sure why....
----
New commits:


---

Comment by git created at 2017-10-20 22:17:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-20 22:18:18

Okay, documentation builds. Julian, can you take a look at my changes?


---

Comment by roed created at 2017-10-20 22:18:18

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2017-10-22 02:05:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-22 05:53:02

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-22 05:53:02

Merge conflict


---

Comment by saraedum created at 2017-10-24 04:16:35

Changing status from needs_work to positive_review.


---

Comment by saraedum created at 2017-10-24 04:16:35

New commits:


---

Comment by vbraun created at 2017-10-27 06:55:39

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-27 06:55:39


```
[docpdf] ! Undefined control sequence.
[docpdf] l.309 induced Gauss valuation on \(\Q
[docpdf]                                      [x]\), i.e., the valuation that assigns...
```



---

Comment by roed created at 2017-10-27 07:14:36

Oops, I thought I had fixed that but it looks like it didn't get pushed.
----
New commits:


---

Comment by roed created at 2017-10-27 07:14:57

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-10-27 07:15:44

Julian, let me know if you're happy with these fixes.  I'm currently building and running `sage -docbuild reference pdf`.


---

Comment by saraedum created at 2017-10-28 07:29:17

Looks good. Positive review if it now actually builds :)


---

Comment by roed created at 2017-10-28 16:52:24

Yep, pdf documentation builds.


---

Comment by roed created at 2017-10-28 16:52:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-29 22:40:02

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-29 22:40:02

On some 32-bit buildbots I get

```
**********************************************************************
File "src/doc/en/reference/valuations/index.rst", line 36, in doc.en.reference.valuations.index
Failed example:
    w(a + 3), ww(a + 3)
Expected:
    (1, 0)
Got:
    (0, 1)
**********************************************************************
File "src/doc/en/reference/valuations/index.rst", line 38, in doc.en.reference.valuations.index
Failed example:
    w(a + 5), ww(a + 5)
Expected:
    (0, 1)
Got:
    (1, 0)
**********************************************************************
1 item had failures:
   2 of  54 in doc.en.reference.valuations.index
    [53 tests, 2 failures, 0.92 s]
```



---

Comment by roed created at 2017-11-01 19:33:54

Is this ready for review again?
----
New commits:


---

Comment by roed created at 2017-11-01 19:41:42

Two comments on

```
try:
    ret = sorted(leafs, key=lambda v: str(v))
except:
    # if for some reason the valuation can not be printed, we leave them unsorted
    ret = list(leafs)
```

You can just use `key=str`, and you shouldn't have a bare `except` (`except Exception` is probably fine).


---

Comment by saraedum created at 2017-11-02 01:35:07

Yes, you are right. I should actually know about both ;)
This is not ready for review. I can't get sage to build from develop locally at all at the moment, so I wanted to see how bad such a change is (by having it be tested by the patchbots).
----
New commits:


---

Comment by roed created at 2017-11-02 01:40:58

If you want, there's a copy in `Src/sage-roed` in the `sd88` project on `k8s`; I've added you to the project so that you can access it.  I'm running doctests there now.


---

Comment by git created at 2017-11-10 07:02:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-11-10 07:02:54

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-11-10 17:07:26

Changing status from needs_review to needs_work.


---

Comment by roed created at 2017-11-10 17:07:26

There's a doctest failure because of output ordering.  I'll try to fix it, but may not have time to do it today....


---

Comment by saraedum created at 2017-11-13 05:33:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-11-13 11:07:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-11-15 18:02:12

There seems to be a nondeterministic failure (it occurred on one of the three patchbot runs for this commit):

```
sage -t --long src/sage/rings/valuation/mapped_valuation.py
**********************************************************************
File "src/sage/rings/valuation/mapped_valuation.py", line 507, in sage.rings.valuation.mapped_valuation.FiniteExtensionFromInfiniteValuation.upper_bound
Failed example:
    u.upper_bound(t + 2)
Expected:
    3
Got:
    2
**********************************************************************
1 item had failures:
   1 of   8 in sage.rings.valuation.mapped_valuation.FiniteExtensionFromInfiniteValuation.upper_bound
```

Any ideas?


---

Comment by saraedum created at 2017-11-18 16:05:04

The upper bound is not non-deterministic itself. I don't remember really but I don't think that there is anything non-deterministic in my code.


---

Comment by saraedum created at 2017-11-18 16:07:13

The upper_bound depends on the precision of the underlying approximation, so the upper_bound can change between calls. As long as the doctests run in a deterministic order, I don't see why this should happen.


---

Comment by saraedum created at 2017-12-21 13:08:53

We now have 13 good patchbot runs and one that failed. Would it be acceptable to ignore this?


---

Comment by saraedum created at 2017-12-21 13:22:43

I started some patchbots on my own and `kick`ed the old results to get some more data here.


---

Comment by git created at 2017-12-21 14:06:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-12-23 11:40:30

Replying to [comment:277 saraedum]:
> We now have 13 good patchbot runs and one that failed. Would it be acceptable to ignore this?

I think that's reasonable.  I'm happy with this ticket, and there are lots of patchbot runs where all tests pass.  Positive review from me.


---

Comment by roed created at 2017-12-23 11:40:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-24 20:53:39

I'm getting a bunch of failures of the form

```
File "src/sage/rings/valuation/valuation_space.py", line 506, in sage.rings.valuation.valuation_space.DiscretePseudoValuationSpace.ElementMethods.residue_ring
Failed example:
    GaussValuation(ZZ['x'], ZZ.valuation(2)).residue_ring()
Expected:
    Univariate Polynomial Ring in x over Finite Field of size 2 (using NTL)
Got:
    Univariate Polynomial Ring in x over Finite Field of size 2 (using GF2X)
**********************************************************************
1 item had failures:
   1 of   6 in sage.rings.valuation.valuation_space.DiscretePseudoValuationSpace.ElementMethods.residue_ring
    [201 tests, 1 failure, 0.56 s]
```



---

Comment by vbraun created at 2017-12-24 20:53:39

Changing status from positive_review to needs_work.


---

Comment by saraedum created at 2017-12-28 17:22:06

Ok. I'll try to reproduce this locally…but I have to rebuild Sage of course…


---

Comment by saraedum created at 2017-12-28 22:20:26

I don't see this problem with the latest develop merged in. Could you tell us more about the machines and base revision where this is failing?


---

Comment by saraedum created at 2017-12-28 22:20:26

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-12-30 10:41:40

Try with the next beta


---

Comment by vbraun created at 2017-12-30 10:41:40

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-01-05 23:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-05 23:54:43

I fixed the trivial doctest errors.

There are also a bunch of doctest errors in the patchbots that do not seem to be related to what we are doing here. I am rebuilding sage locally and report back once I have checked locally.


---

Comment by saraedum created at 2018-01-06 00:06:21

Changing status from needs_work to positive_review.


---

Comment by git created at 2018-01-10 18:26:46

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-01-10 18:26:46

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by roed created at 2018-01-10 18:34:56

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-01-10 18:34:56

Looks good to me.


---

Comment by vbraun created at 2018-01-13 17:25:46


```
[docpdf] ! Missing $ inserted.
[docpdf] <inserted text> 
[docpdf]                 $
[docpdf] l.1203 relation \sphinxcode{P.v ≤ V.v}
[docpdf]                                          (pointwise on the polynomial ring K...
```



---

Comment by vbraun created at 2018-01-13 17:25:46

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-01-14 01:45:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-14 01:46:29

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-01-16 16:40:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-16 17:09:49

The changes could make some outputs gain precision. Let's see what the patchbots think…


---

Comment by roed created at 2018-01-16 17:22:52

There's an extra space in the new commit: `10*x^1 2`.


---

Comment by git created at 2018-01-16 17:24:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-01-16 17:25:53

I'm trying to build the documentation now to check the previous change.
----
New commits:


---

Comment by saraedum created at 2018-01-19 14:20:06

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-01-19 14:20:06


```
File "src/sage/rings/padics/padic_valuation.py", line 726, in sage.rings.padics.padic_valuation.pAdicValuation_base.extensions
Failed example:
    QQ.valuation(2).extensions(L)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: The valuation [ Gauss valuation induced by 2-adic valuation, v(x) = 1/2 ] does not approximate a unique extension of 2-adic valuation with respect to x^4 + 2*x^3 + 2*x^2 + 8
Got:
    [[ 2-adic valuation, v(x + 2) = 3/2 ]-adic valuation,
     [ 2-adic valuation, v(x) = 1/2 ]-adic valuation]
```



---

Comment by git created at 2018-01-19 14:23:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-19 14:24:06

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-01-19 14:24:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-02-08 20:37:15

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-02-08 20:37:15

The failing builds look to be due to some unrelated giac issue, and I don't know what the failed apply is.  I'm happy with the changes and the documentation builds when I test it.  Let's set this back to positive review.


---

Comment by vbraun created at 2018-02-09 23:48:10

Resolution: fixed


---

Comment by jdemeyer created at 2018-12-21 15:20:57

What's the point of these doctests?

```
        Note that this does not affect comparison of valuations which do not
        coerce into a common parent. This is by design in Sage, see
        :meth:`sage.structure.element.Element.__richcmp__`. When the valuations
        do not coerce into a common parent, a rather random comparison of
        ``id`` happens::

            sage: w = valuations.TrivialValuation(GF(2))
            sage: w <= v # random output
            True
            sage: v <= w # random output
            False
```

I plan to remove them in #26934


---

Comment by saraedum created at 2018-12-21 16:26:38

I thought that the docstring is quite technical, so the doctest illustrates what I mean. They don't "test" anything, they are really part of the documentation.


---

Comment by jdemeyer created at 2018-12-22 15:36:06

Replying to [comment:307 saraedum]:
> I thought that the docstring is quite technical, so the doctest illustrates what I mean.

I see your point, but it's not the job of `valuation.py` to document technical details of the coercion model. I ask because I plan to change the behaviour of comparisons in #22029.


---

Comment by saraedum created at 2018-12-22 16:08:42

It's a detail of the coercion model but here the point is just that it does not work the way you would expect it to. Comparisons are important in this context and it's therefore important to document the limitations. If it raises an error, all the better.
