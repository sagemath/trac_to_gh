# Issue 17425: Evenly distributed sets

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-01-22 17:54:53

CC:  ncohen

We introduce evenly distributed sets (EDS) to get more difference families and more BIBD in Sage. More precisely we add

- a database of small EDS
- a naive backtracker (that was actually used to build the database)


---

Comment by vdelecroix created at 2015-01-22 18:16:33

New commits:


---

Comment by vdelecroix created at 2015-01-22 18:16:33

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-01-22 18:16:33

Changing type from PLEASE CHANGE to enhancement.


---

Comment by git created at 2015-04-15 10:40:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-15 10:41:36

Rebased on the latest beta in which the dependency is merged. Needs review!


---

Comment by ncohen created at 2015-04-15 11:12:09

Helloooooooooooo,

For the moment it's only about form, but:

- In the desription of the EDS database that appear as a comment in
  `databases.py`: could you give it a better shape with lists and items?
  Something like:
  At position `[k][q]` there is:
      - False: no such set exists
      - (None, B) -- explanation
      - (polynomial, B) -- explanation
  It is a bit hard to read, as it is.

- can you also call `del` on `R,ZZ` and `a`?

- In the module doc of `database.py`, could you add a link toward a definition
  of `EDS`? From typing this in Google you don't get much.

- `cdef class EvenlyDistributedSets(object):` why do you inherit from
  `object`? What do you earn? `O_o`

- Jeroen's talk at Liege taught us that `check_malloc` existed `:-P`

  http://fossies.org/linux/sage/src/sage/ext/memory.pxd#l_97

- An ÌNPUT section is missing from at least two functions of your new file. In
  particular, it would be cool to know how exactly one is meant to build a
  `EvenlyDistributedSets` instance.

- About the name `EvenlyDistributedSets`... I don't find it overly specific. I
  know that the 's' means 'many', but welll....

Nathann


---

Comment by vdelecroix created at 2015-04-15 11:52:29

Just some questions about some of your questions.

Replying to [comment:4 ncohen]:
> - In the module doc of `database.py`, could you add a link toward a definition
>   of `EDS`? From typing this in Google you don't get much.

It is currently in the class `EvenlyDistributedSets`. What should I do?
 
> - `cdef class EvenlyDistributedSets(object):` why do you inherit from
>   `object`? What do you earn? `O_o`

No idea.

> - An ÌNPUT section is missing from at least two functions of your new file. In
>   particular, it would be cool to know how exactly one is meant to build a
>   `EvenlyDistributedSets` instance.

It is in the class documentation (not in `__init__`)

```
    INPUT:

    - ``K`` -- a finite field of cardinality `q`

    - ``k`` -- a positive integer such that `k(k-1)` divides `q-1`

    - ``check`` -- boolean (default is ``False``). Whether you want to check
      intermediate steps of the iterator. This is mainly intended for debugging
      purpose. Setting it to ``True`` will considerably slow the iteration.
```

Should I move it?

> - About the name `EvenlyDistributedSets`... I don't find it overly specific. I
>   know that the 's' means 'many', but welll....
 
What about `SomeEvenlyDistributedSetsWithSomeProperty`? It is exactly the evenly distributed sets up to isomorphisms (= relabeling by `x -> ax + b`). I will try to find something.

Vincent


---

Comment by vdelecroix created at 2015-04-15 12:01:04

I now remember that I did implement a much better backtracker with a lot of branch cuts... I need to find it! Grrrr!


---

Comment by git created at 2015-04-15 14:25:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-15 14:26:16

Here is the much better backtracker. I implemented the points that I did not discuss in my [comment:5 comment:5].


---

Comment by ncohen created at 2015-04-15 14:28:28

> It is currently in the class `EvenlyDistributedSets`. What should I do?

Well, add a link to it?

> Should I move it?

Sorry, I missed it.

> > - About the name `EvenlyDistributedSets`... I don't find it overly specific. I
> >   know that the 's' means 'many', but welll....
>  
> What about `SomeEvenlyDistributedSetsWithSomeProperty`? It is exactly the evenly distributed sets up to isomorphisms (= relabeling by `x -> ax + b`). I will try to find something.

Well, you could also call it `EvenlyDistributedSetsBacktrack` or something. I mean: okay there is a 's' and your set represents "many evenly distributed sets", but it is not the set of "all evenly distributed sets" either since it is prameterized by `K` and `k`. Well, I don't know exactly what other name it could take, but this one is rather wide.

Nathann


---

Comment by git created at 2015-04-19 14:10:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-19 15:31:14

All right,

I implemented your requests and rebased on sage-6.7.beta1. The backtracker is currently running for `k=11,12,13,14` but I am not sure there is something interesting to find.

Vincent


---

Comment by vdelecroix created at 2015-04-19 18:22:37

As a consequence, some new BIBD

```
sage: designs.balanced_incomplete_block_design(169,7)
(169,7,1)-Balanced Incomplete Block Design
sage: designs.balanced_incomplete_block_design(617,8)
(617,8,1)-Balanced Incomplete Block Design
sage: designs.balanced_incomplete_block_design(433,9)
(433,9,1)-Balanced Incomplete Block Design
sage: designs.balanced_incomplete_block_design(1171,10)
(1171,10,1)-Balanced Incomplete Block Design
```

Isn't it cool?


---

Comment by ncohen created at 2015-04-19 19:35:17

COooooooooooOOOOOOOOOOOoooooooollllllllll!! Perhaps we should think someday of having big tables of the BIBD (or other designs) that we can build. In the doc. A bit like how we do it for the 'database of small designs'. The La Jolla Covering Repository doesn't go that high.


---

Comment by ncohen created at 2015-04-20 08:34:26

While reviewing this code


```
    # PYTHON DATA                                                                                                                                                                                 
    cdef K                       # the underlying field                                                                                                                                           
    cdef list list_K             # the elements of K  (i -> x)                                                                                                                                    
    cdef dict K_to_int           # inverse of list_K  (x -> i)                                                                                                                                    

    # FLAGS                                                                                                                                                                                       
    cdef int count               # do we count or do we iterate                                                                                                                                   
    cdef int check               # do we need to check (debug)                                                                                                                                    
    cdef int up_to_isom          # do we care only about isomorphisms                                                                                                                             

    # STATIC DATA                                                                                                                                                                                 
    cdef unsigned int q          # cardinality of the field                                                                                                                                       
    cdef unsigned int k          # size of the subsets                                                                                                                                            
    cdef unsigned int e          # k(k-1)/2                                                                                                                                                       
    cdef unsigned int ** diff    # qxq array: diff[x][y]  = x - y                                                                                                                                 
    cdef unsigned int ** ratio   # qxq array: ratio[x][y] = x / y                                                                                                                                 

    # DYNAMIC DATA                                                                                                                                                                                
    cdef unsigned int * B        # current stack of elements of {0,...,q-1}                                                                                                                       
    cdef unsigned int * cosets   # cosets of differences of elts in B                                                                                                                             
    cdef unsigned int * t        # temporary variable for updates    
```


Thank you for that. This is the kind of code that is a pleasure to read! `:-PPPPP`

Nathann


---

Comment by ncohen created at 2015-04-20 10:11:59

Hello,

I added a commit with some small modifications. The replacement malloc->calloc is there because the following code triggers a segfault (during `__dealloc__`) when the second malloc fails.


```
self.ratio = <unsigned int **> check_malloc(q*sizeof(unsigned int *))
self.ratio[0] = <unsigned int *> check_malloc(q*q*sizeof(unsigned int))
```


I also have a couple of questions:

Could you explain somewhere why being an EDS is preserved by relabelling?

Also, why an 'if' there?

```
if BB > B:
   relabs.add(tuple(BB))
```


Nathann


---

Comment by ncohen created at 2015-04-20 10:11:59

Changing status from needs_review to needs_info.


---

Comment by git created at 2015-04-20 10:12:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-20 10:21:35

Thanks for the commit.

Replying to [comment:15 ncohen]:
> I also have a couple of questions:
> 
> Could you explain somewhere why being an EDS is preserved by relabelling?

Yes, easy: $(ax+b) - (ax'+b) = a(x-x')$. So the cosets of the differences `x-x'` are just permuted by the multiplication by `a`. Because the condition is "hit each of them twice", it is invariant under permutation.

Will write it.

> Also, why an 'if' there?
> {{{
> if BB > B:
>    relabs.add(tuple(BB))
> }}}

Right, can be safely removed. Will do.

- I have a commit with much cleaner/better branch cut, am I free to add it now?
- I can get rid of `sage.ratio` by reorganizing `self.list_K`  into `[x^i for i in range(self.q-1)]`. That way the ratio would just be `(x-y)%(q-1)`. Do you think it would be better?

Vincent


---

Comment by ncohen created at 2015-04-20 10:29:33

Hello,

> Yes, easy: $(ax+b) - (ax'+b) = a(x-x')$. So the cosets of the differences `x-x'` are just permuted by the multiplication by `a`. Because the condition is "hit each of them twice", it is invariant under permutation.

Oh, of course `XD`

> Will write it.

Thanks

> - I have a commit with much cleaner/better branch cut, am I free to add it now?

If it makes the code simpler and easier, yes. If it makes it more efficient but more complicated, then in another ticket please.

> - I can get rid of `sage.ratio` by reorganizing `self.list_K`  into `[x^i for i in range(self.q-1)]`. That way the ratio would just be `(x-y)%(q-1)`. Do you think it would be better?

In terms of perf I have no idea. If you do this replacement please comment such lines with their meaning in term of groups element like `i-j # x<sup>i/x</sup>j`.

Nathann


---

Comment by git created at 2015-04-20 14:28:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-20 14:31:55

back to needs review (and I set you as a reviewer before forgetting it).

I did not get rid of `.ratio` as it is some work and might be less readable. I might reconsider it later.

Vincent


---

Comment by vdelecroix created at 2015-04-20 14:31:55

Changing status from needs_info to needs_review.


---

Comment by git created at 2015-04-20 16:07:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-20 16:08:30

Oops. I introduced wrong specifications in `._B_automorphisms()`. Now it is ok. I also advertised the BIBD from [comment:12 comment:12].


---

Comment by git created at 2015-04-27 10:24:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-27 10:25:37

Hellooooooooooooooooooo,

- Isn't it weird that all EDS not considered 'up to isomorphism' always begin
  with `0,1`? Perhaps you should say somewhere that they are always normalized?
  {{{
  sage: E = EvenlyDistributedSetsBacktracker(Zmod(13), 4, up_to_isomorphism=False)
  sage: for B in E: print B
  [0, 1, 11, 5]
  [0, 1, 4, 6]
  [0, 1, 9, 3]
  [0, 1, 8, 10]
  }}}

- `to_difference_family` -- could you add a check that this is indeed a
  difference family? Like with the usual `check` argument?

- Same with `an_element`.

- "The value of the other" -- the value of the other what?
  {{{
  # Given one such function, the values of the other are 1/z, 1-z,
  # 1/(1-z), (z-1)/z and z/(z-1).
  }}}

- Why would that map `B[i]` to 1?
  {{{
  # We choose
  #    t -> (x - t)/ (x - B[j])
  #  (that maps x to 0 and B[i] to 1
  }}}

- I do not get this line
  {{{
  # try to append x
  if self._add_element(x,kk):
      # note: the element x is already added to B in ._add_element()
      if kk == k-1:
          ans = self._B_automorphisms()
          if ans is False:
	      continue
  }}}
  Wouldn't it be better to call `_B_automorphisms()` in `self._add_element`, and
  to not add the element if the min property is not satisfied?

- I do not understand why you do the same test twice:
  {{{
            if x == q-2:
                kk -= 1
                x = B[kk]
                self._pop(kk)
                if x == q-2:
                    kk -= 1
                    x = B[kk]
                    self._pop(kk)
                    if x == q-2:
  }}}
  Isn't it better to define x as "the last element in the list+1"? This way you
  couldn't have `x==q-2` when `B[kk-1]=q-2`

I added a small commit containing mostly doc. I also changed a bit the
management of `self.t`. I began by replacing your `if self.t[i]:
self.coset[i]=1` by a `self.coset[i] |= self.t[i]`, then noticed that it was
probably why you had been setting t to zero outside of the `_add_element`
function.

It actually took me some time to understand that `t` was always equal to 0 when
this function was called. Because you initialized it elsewhere, I thought for a
while that it used some values computed in another function.

Nathann


---

Comment by ncohen created at 2015-04-27 10:25:37

Changing status from needs_review to needs_info.


---

Comment by git created at 2015-04-27 10:36:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-27 14:14:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-27 14:17:29

Replying to [comment:24 ncohen]:
Thanks for your commit

I took care of all your comments in my 6 commits. I hope it is clearer now.

It seems also that the previous backtracker forgot some difference families!! Too bad!!

Vincent


---

Comment by vdelecroix created at 2015-04-27 14:17:29

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2015-04-27 14:20:50

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2015-04-27 14:20:50

Could you explain in detail what you did in `d25ced13` and `0a750d9`? Read the diff, you will see how easy it is to figure out what you did.


---

Comment by ncohen created at 2015-04-27 14:25:04

It would also be cool if you could actually answer all points I raised in my review. It's a bit boring to ask question to which nobody ever answers.


---

Comment by vdelecroix created at 2015-04-27 14:32:34

Hello,

## Commits precision

The method `_check_cosets` was just wrong and not tested. I corrected it in `​0a750d9`. It is also optimized to not use Python data. In the end there is a new example which test the `check=True` in the class (and which indirectly uses this method).

In `0a750d9`:
 - as you suggested, now `x = B[kk]`
 - I simplified the `_add_element` and rename it into `_check_last_element` it is also much cleaner and a bit faster
 - I removed `_pop` and copy/paste the corresponding code in two places
 - To choose the next element x in the main loop, there are now some easy check and it results in a great speedup

## Answers

> - Isn't it weird that all EDS not considered 'up to isomorphism' always begin
>   with `0,1`? Perhaps you should say somewhere that they are always normalized?

yes it is, now there is a comment in the `INPUT` section

> - `to_difference_family` -- could you add a check that this is indeed a
>   difference family? Like with the usual `check` argument?
>
> - Same with `an_element`.

done and done
 
> - "The value of the other" -- the value of the other what?
>   {{{
>   # Given one such function, the values of the other are 1/z, 1-z,
>   # 1/(1-z), (z-1)/z and z/(z-1).
>   }}}

it was value of the other functions. It is now clarified.

> - Why would that map `B[i]` to 1?
>   {{{
>   # We choose
>   #    t -> (x - t)/ (x - B[j])
>   #  (that maps x to 0 and B[i] to 1
>   }}}

it was a typo, should be "(x - t) / (x - B[i])". Corrected.

> - I do not get this line
>   ...

it is now very different and I hope, simpler (see commit `0a750d9`)

>   Wouldn't it be better to call `_B_automorphisms()` in `self._add_element`, and
>   to not add the element if the min property is not satisfied?

`_B_automorphisms` (now `_B_relabelled_copies`) is very slow. We should not use that seriously inside the main loop.

> - I do not understand why you do the same test twice:
>   ...
>   Isn't it better to define x as "the last element in the list+1"? This way you
>   couldn't have `x==q-2` when `B[kk-1]=q-2`

this is completely modified in the commit `0a750d9`
 
Vincent


---

Comment by vdelecroix created at 2015-04-27 14:33:14

Changing status from needs_info to needs_review.


---

Comment by git created at 2015-04-27 15:51:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-27 15:51:41

Okayyyyyyy. If you agree with that, it can go!

Nathann


---

Comment by vdelecroix created at 2015-04-27 15:56:20

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-27 15:56:20

Fantastic!

I just restarted the computations for `k=11,12,13`. Now that the backtracker is much better there is a chance to get something...

Vincent


---

Comment by ncohen created at 2015-04-27 16:01:07

Wow. Three patchbot are working on this ticket simultaneously.


---

Comment by vbraun created at 2015-04-28 04:44:40

Resolution: fixed


---

Comment by vdelecroix created at 2015-04-28 05:56:57

Replying to [comment:35 ncohen]:
> Wow. Three patchbot are working on this ticket simultaneously.

The way the patchbots determine tickets is completely not up to date. There is a "secret list" of 80 people that are allowed to work on tickets...

   http://patchbot.sagemath.org/trusted/

Hopefully you are and I am, otherwise this ticket would not have been tested!!
