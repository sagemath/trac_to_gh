# Issue 10536: sage -fixdoctests doesn't work correctly

Issue created by migration from https://trac.sagemath.org/ticket/10589

Original creator: mderickx

Original creation time: 2011-01-11 12:00:50

Assignee: mvngu

To reproduce this remove all but the first test result from the patch at: #10568


```
maarten-derickxs-macbook-pro:sage maarten$ sage -t matrix/matrix_sparse.pyx
sage -t  "devel/sage-main/sage/matrix/matrix_sparse.pyx"    
**********************************************************************
File "/Applications/sage-4.6.rc0/devel/sage-main/sage/matrix/matrix_sparse.pyx", line 301:
    sage: (2/3)*M
Expected nothing
Got:
    [   0  2/3  4/3    2  8/3 10/3]
    [   4 14/3 16/3    6 20/3 22/3]
    [   8 26/3 28/3   10 32/3 34/3]
**********************************************************************
File "/Applications/sage-4.6.rc0/devel/sage-main/sage/matrix/matrix_sparse.pyx", line 302:
    sage: 7*M
Expected nothing
Got:
    [  0   7  14  21  28  35]
    [ 42  49  56  63  70  77]
    [ 84  91  98 105 112 119]
**********************************************************************
File "/Applications/sage-4.6.rc0/devel/sage-main/sage/matrix/matrix_sparse.pyx", line 303:
    sage: (1/4)*M
Expected nothing
Got:
    [   0  1/4  1/2  3/4    1  5/4]
    [ 3/2  7/4    2  9/4  5/2 11/4]
    [   3 13/4  7/2 15/4    4 17/4]
**********************************************************************
File "/Applications/sage-4.6.rc0/devel/sage-main/sage/matrix/matrix_sparse.pyx", line 306:
    sage: m==(97/42)*(42/97*m)
Expected nothing
Got:
    True
**********************************************************************
1 items had failures:
   4 of   9 in __main__.example_6
***Test Failed*** 4 failures.
For whitespace errors, see the file /Users/maarten/.sage//tmp/.doctest_matrix_sparse.py
	 [12.5 s]
 
----------------------------------------------------------------------
The following tests failed:


	sage -t  "devel/sage-main/sage/matrix/matrix_sparse.pyx"
Total time for all tests: 12.6 seconds
maarten-derickxs-macbook-pro:sage maarten$ sage -fixdoctests matrix/matrix_sparse.pyx
```



---

Comment by andrew.mathas created at 2013-02-14 23:21:53

Changing keywords from "" to "sage45".


---

Comment by andrew.mathas created at 2013-02-14 23:21:53

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2013-02-18 02:27:25

To doctest this, you could add some tests to `devel/sage/sage/tests/cmdline.py`


---

Comment by andrew.mathas created at 2013-02-18 02:32:15

Changing keywords from "sage45" to "days45".


---

Comment by andrew.mathas created at 2013-02-18 23:46:32

Replying to [comment:6 jhpalmieri]:
> To doctest this, you could add some tests to `devel/sage/sage/tests/cmdline.py`

Thanks John. I will have a look at this and *add some tests*.


---

Comment by andrew.mathas created at 2013-02-25 04:35:50

Changing status from needs_review to needs_work.


---

Comment by roed created at 2013-03-28 23:18:19

Changing component from doctest to doctest framework.


---

Comment by andrew.mathas created at 2013-05-02 00:41:21

Changing status from needs_work to needs_review.


---

Comment by andrew.mathas created at 2013-05-02 00:41:21

Updated fixdoctests patch so that it works with the new doctest framework in #12415 and added some tests to sage/tests/cmdline.py for the script


---

Comment by roed created at 2013-05-07 01:52:30

Shouldn't that be the scripts repo?


---

Comment by andrew.mathas created at 2013-05-07 01:57:37

Replying to [comment:17 roed]:
> Shouldn't that be the scripts repo?

Yes, thanks. Wasn't sure what the right name was, just knew where to find it...


---

Comment by jdemeyer created at 2013-05-17 13:57:41

Changing component from doctest framework to scripts.


---

Comment by benjaminfjones created at 2013-06-14 06:14:10

I used the patch here to solve problems I was getting with `sage -fixdoctests`. Thanks, hope this can get reviewed and merged soon!


---

Comment by tscrim created at 2013-09-16 15:57:48

Looks good to me minus two minors thing:

- you're missing the `::` on line 405 in `tests/cmdline.py`,
- could you de-indent the `AUTHORS:` block in `sage-fixdoctests` and align the extra text by 2 spaces.

Thanks Andrew.


---

Comment by andrew.mathas created at 2013-09-17 21:17:18

Replying to [comment:23 tscrim]:
> Looks good to me minus two minors thing:
> 
> - you're missing the `::` on line 405 in `tests/cmdline.py`,
> - could you de-indent the `AUTHORS:` block in `sage-fixdoctests` and align the extra text by 2 spaces.
> 

Thanks Travis, I have fixed both of these.

Andrew


---

Comment by tscrim created at 2013-09-17 21:20:54

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2013-09-17 21:20:54

Then it's a positive review. Thanks Andrew.


---

Comment by jdemeyer created at 2013-09-27 10:26:21

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-09-27 10:26:21

The file [attachment:trac_10589--fixdoctest_failures-am.patch] contains garbage at the start, please fix that.


---

Comment by andrew.mathas created at 2013-09-27 11:21:01

Replying to [comment:26 jdemeyer]:
> The file [attachment:trac_10589--fixdoctest_failures-am.patch] contains garbage at the start, please fix that.

Sorry. Fixed.


---

Comment by andrew.mathas created at 2013-09-27 11:21:25

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-09-27 16:15:14

I get

```
sage -t --long devel/sage/sage/tests/cmdline.py
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 414, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    1
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 418, in sage.tests.cmdline.test_executable
Failed example:
    print output[output.find('     SAGE: 1+1'):output.find(' \"\"\"')-1]
Expected:
         SAGE: 1+1              # incorrect output
    -    3
    +    2
         SAGE: m=matrix(ZZ,3)   # output when none is expected
    +    SAGE: (2/3)*m          # no output when it is expected
    +    [0 0 0]
         [0 0 0]
         [0 0 0]
    -    [1 0 0]
    -    SAGE: (2/3)*m          # no output when it is expected
         SAGE: mu=PartitionTuple([[4,4],[3,3,2,1],[1,1]])   # output when none is expected
    -    [4, 4, 3, 3, 2, 1, 1]
         SAGE: mu.pp()          # uneven indentation
    -    ****
    -    ****
    +       ****   ***   *
    +       ****   ***   *
    +              **
    +              *
         SAGE: PartitionTuples.global_options(convention="French")
         SAGE: mu.pp()         # fix doctest with uneven indentation
    +    *
    +    **
    +    ****   ***   *
    +    ****   ***   *
         SAGE: PartitionTuples.global_options.reset()
Got:
    <BLANKLINE>
**********************************************************************
```



---

Comment by jdemeyer created at 2013-09-27 16:15:14

Changing status from positive_review to needs_work.


---

Comment by andrew.mathas created at 2013-09-28 06:38:11

Replying to [comment:29 jdemeyer]:
> I get
> {{{
> sage -t --long devel/sage/sage/tests/cmdline.py
> **********************************************************************
> File "devel/sage/sage/tests/cmdline.py", line 414, in sage.tests.cmdline.test_executable
> Failed example:
>    
>  ...

Hi Jeroen, 

I am fairly sure that this failure is because the patch in the scripts directory has not been applied - at least, I get this error if the patch trac_10589--fixdoctest_failures-am.patch has not been applied to the scripts repository and I do not get it when it is applied.

Can you please confirm that both patches have been applied correctly. I'm putting the status back to positive review as I am not sure if you will read this otherwise.

Andrew


---

Comment by andrew.mathas created at 2013-09-28 06:38:11

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-09-29 16:28:43

I'm pretty sure I did apply both patches, but I'll try again...


---

Comment by jdemeyer created at 2013-09-30 06:22:56

After adding a doctest line

```
sage: print err
```

(which I guess all `cmdline.py` tests _should_ have):

```
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 416, in sage.tests.cmdline.test_executable
Failed example:
    print err
Expected nothing
Got:
    sh: cannot create .tmp: Permission denied
    Traceback (most recent call last):
      File "/scratch/release/merger/sage-5.13.beta0/local/bin/sage-fixdoctests", line 35, in <module>
        doc_out = open(doc_out).read()
    IOError: [Errno 2] No such file or directory: '.tmp'
    <BLANKLINE>
**********************************************************************
```


So the problem is that `sage -fixdoctests` writes to the current working directory, which isn't guaranteed to be writable.

Also: please use `--fixdoctests` everywhere.


---

Comment by jdemeyer created at 2013-09-30 06:22:56

Changing status from positive_review to needs_work.


---

Comment by andrew.mathas created at 2013-09-30 07:03:23

Changing status from needs_work to positive_review.


---

Comment by andrew.mathas created at 2013-09-30 07:03:23

Thanks for identifying the problem Jeroen as I couldn't see this the way I was testing it. I've fixed both of these points.
Andrew


---

Comment by jdemeyer created at 2013-09-30 07:31:52

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-09-30 07:32:16

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-09-30 07:32:16

I think these changes should be reviewed. Travis, can you do that?


---

Comment by andrew.mathas created at 2013-09-30 09:17:53

Replying to [comment:37 jdemeyer]:
> I think these changes should be reviewed. Travis, can you do that?


Hi Travis, 

FYI, the trivial changes made were:
* in `trac_10589--doctests_for_fixdoctests-am.patch​` two instances of ``-fixdoctests`` were changes to ``--fixdoctests`` and and ``print ret`` was changed to ``print err``
* in `trac_10589--fixdoctest_failures-am.patch` the output is sent to ``doc_out=tmp_dir()+'.tmp'`` rather than just ``.tmp``, which required a new import statement (this was an error in the original `sage-fixdoctests` which wasn't picked up when it was first added to sage...).

Andrew


---

Comment by tscrim created at 2013-09-30 16:08:34

Hey Andrew,

Is there some way we could make this behave better when we don't have write permissions to a given directory, such as output query the user or just output to the console?

Hey Jeroen,

Thanks for noticing that, I never would have thought to check write permissions of the current directory.

Best,

Travis


---

Comment by andrew.mathas created at 2013-09-30 16:49:51

Replying to [comment:39 tscrim]:
> Hey Andrew,
> 
> Is there some way we could make this behave better when we don't have write permissions to a given directory, such as output query the user or just output to the console?

Hi Travis,

This already happens. The problem that Jeroen found concerns a tempory file which the sage-fixdoctests script uses to dump the current state of the doc-tests. This file is now written to sage's ``tmp_dir()`` which is always writable.

The only other file that sage-fixdoctests writes is the replacement source file. By default this is put in the same directory as the original source, however, the user can supply an optional argument to have the file written elsewhere:

```
Usage: sage -fixdoctests <source file> [doctest output]
Creates a file <source file>.out that passes the doctests (modulo any raised exceptions)
```


Having said this, I just chcked and this optional argument is not mentioned under ``sage -advanced``, so probably I should add it there. I could also make the script more user friendy and have it remind the user of this when it is unable to write its output file. Is this what you have in mind?

Andrew


---

Comment by tscrim created at 2013-09-30 21:02:16

Replying to [comment:40 andrew.mathas]:
> This already happens. The problem that Jeroen found concerns a tempory file which the sage-fixdoctests script uses to dump the current state of the doc-tests. This file is now written to sage's ``tmp_dir()`` which is always writable.
> 
> The only other file that sage-fixdoctests writes is the replacement source file. By default this is put in the same directory as the original source, however, the user can supply an optional argument to have the file written elsewhere:
> {{{
> Usage: sage -fixdoctests <source file> [doctest output]
> Creates a file <source file>.out that passes the doctests (modulo any raised exceptions)
> }}}
> 
> Having said this, I just chcked and this optional argument is not mentioned under ``sage -advanced``, so probably I should add it there. I could also make the script more user friendy and have it remind the user of this when it is unable to write its output file. Is this what you have in mind?

Hey Andrew,

Yes, that would be good.

Thanks,

Travis


---

Comment by jdemeyer created at 2013-10-02 16:04:21

I confirm that the new patches seem to work (but I haven't looked at the code).


---

Comment by andrew.mathas created at 2013-10-02 17:11:21

Replying to [comment:42 jdemeyer]:
> I confirm that the new patches seem to work (but I haven't looked at the code).
 
Thanks! I haven't yet incororated Travis' suggestions above. Btw, can any one tell me where the sage usage message lives so that I can mention the optional argument to fixdoctests there?


---

Comment by jhpalmieri created at 2013-10-02 17:20:02

It's in `SAGE_ROOT/spkg/bin/sage`. You should also update the documentation at `devel/sage/doc/en/reference/cmd/options.rst`.


---

Comment by andrew.mathas created at 2013-10-03 13:25:22

OK, I have just uploaded a new version of the patch, which now consists of three files for three different repositories (main, scripts and spkg). The new features of the patch are:
* sage-fixdoctests now checks to see if it can write to the specified output directory and if not it prompts the user for a better place to put the file
* the script now takes an optional argument --long so that fixdoctests can also massage --long doctests
* there is an updated usage message for fixdoctests printed by sage --advanced
* there is an updated usage message for fixdoctests in the reference manual

Ready for review...


---

Comment by tscrim created at 2013-10-03 21:52:43

One very minor point, could you put a space after the colon on line 122 in the fixdoctest file? I prefer my prompts like:

```
prompt: foo
```

as opposed to:

```
prompt:foo
```


After that, you can set this to positive review. Thanks.


---

Comment by andrew.mathas created at 2013-10-04 07:05:41

Replying to [comment:46 tscrim]:
> One very minor point, could you put a space after the colon on line 122 in the fixdoctest file? I prefer my prompts like:
> 
> After that, you can set this to positive review. Thanks.

Thanks very much Travis. Both done!

Andrew


---

Comment by andrew.mathas created at 2013-10-04 07:05:41

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-10-04 12:29:32

There is an *obvious doctest failure*, which should have been caught both by the author and reviewer here:

```
sage -t devel/sage/sage/tests/cmdline.py
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 178, in sage.tests.cmdline.test_executable
Failed example:
    err
Expected:
    ''
Got:
    '/scratch/release/merger/sage-5.13.beta0/spkg/bin/sage: line 155: file.py: command not found\n/scratch/release/merger/sage-5.13.beta0/spkg/bin/sage: line 155: outpu
t_file: command not found\n/scratch/release/merger/sage-5.13.beta0/spkg/bin/sage: line 156: file.py.out: command not found\n/scratch/release/merger/sage-5.13.beta0/spkg
/bin/sage: line 157: --long: command not found\n'
**********************************************************************
```



---

Comment by jdemeyer created at 2013-10-04 12:29:32

Changing status from positive_review to needs_work.


---

Attachment

Fixing help strings


---

Comment by andrew.mathas created at 2013-10-04 13:35:30

Replying to [comment:49 jdemeyer]:
> There is an *obvious doctest failure*, which should have been caught both by the author and reviewer here:

Yep, agreed. Sorry. Fixed.

Jeroen, I always get the feeling you don't like me.

A.


---

Comment by jdemeyer created at 2013-10-04 13:47:49

Replying to [comment:50 andrew.mathas]:
> Jeroen, I always get the feeling you don't like me.
It is true that failures like these are annoying to me, because they make me lose time while being completely avoidable. On the other hand, it is nothing personal (usually, I don't even look at ticket's authors). I certainly didn't mean to offend, and I apologize if I did.


---

Comment by andrew.mathas created at 2013-10-04 13:58:14

Replying to [comment:51 jdemeyer]:
> Replying to [comment:50 andrew.mathas]:
> > Jeroen, I always get the feeling you don't like me.
> It is true that failures like these are annoying to me, because they make me lose time while being completely avoidable. On the other hand, it is nothing personal (usually, I don't even look at ticket's authors). I certainly didn't mean to offend, and I apologize if I did.

No, not offended as I completely understand: it annoys me when I do this as well.

Apologies for wasting your time annd Travis' (and mine), as I am sure we all have better thing to do.

A.


---

Comment by tscrim created at 2013-10-04 14:50:29

Sorry about that Jeroen. I'm somewhat surprised that changes to the output of the `--advanced` broke that particular doctest. With Andrew's new patch it is fixed:

```
travis@Kristine-Desktop:~/sage-5.12.beta5/devel/sage-combinat/sage/tests$ sage -t --long ../tests/cmdline.py 
Running doctests with ID 2013-10-04-07-25-10-694770dc.
Doctesting 1 file.
sage -t --long cmdline.py
    [213 tests, 95.98 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 96.4 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 96.0 seconds
```



---

Comment by tscrim created at 2013-10-04 14:50:29

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-10-04 15:00:07

Replying to [comment:53 tscrim]:
> Sorry about that Jeroen. I'm somewhat surprised that changes to the output of the `--advanced` broke that particular doctest.
There reason is that ``` is a special character for the shell.


---

Comment by tscrim created at 2013-10-04 15:04:04

Replying to [comment:54 jdemeyer]:
> Replying to [comment:53 tscrim]:
> > Sorry about that Jeroen. I'm somewhat surprised that changes to the output of the `--advanced` broke that particular doctest.
> There reason is that ``` is a special character for the shell.

Ah. Thanks.


---

Comment by jdemeyer created at 2013-10-12 09:44:14

The `diff` output isn't portable, on Solaris:

```
sage -t --long devel/sage/sage/tests/cmdline.py
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 417, in sage.tests.cmdline.test_executable
Failed example:
    print output[output.find('     SAGE: 1+1'):output.find(' \"\"\"')-1]
Expected:
         SAGE: 1+1              # incorrect output
    -    3
    +    2
         SAGE: m=matrix(ZZ,3)   # output when none is expected
    +    SAGE: (2/3)*m          # no output when it is expected
    +    [0 0 0]
         [0 0 0]
         [0 0 0]
    -    [1 0 0]
    -    SAGE: (2/3)*m          # no output when it is expected
         SAGE: mu=PartitionTuple([[4,4],[3,3,2,1],[1,1]])   # output when none is expected
    -    [4, 4, 3, 3, 2, 1, 1]
         SAGE: mu.pp()          # uneven indentation
    -    ****
    -    ****
    +       ****   ***   *
    +       ****   ***   *
    +              **
    +              *
         SAGE: PartitionTuples.global_options(convention="French")
         SAGE: mu.pp()         # fix doctest with uneven indentation
    +    *
    +    **
    +    ****   ***   *
    +    ****   ***   *
         SAGE: PartitionTuples.global_options.reset()
Got:
         SAGE: 1+1              # incorrect output
    -    3
    +    2
         SAGE: m=matrix(ZZ,3)   # output when none is expected
    +    SAGE: (2/3)*m          # no output when it is expected
         [0 0 0]
         [0 0 0]
    -    [1 0 0]
    -    SAGE: (2/3)*m          # no output when it is expected
    +    [0 0 0]
         SAGE: mu=PartitionTuple([[4,4],[3,3,2,1],[1,1]])   # output when none is expected
    -    [4, 4, 3, 3, 2, 1, 1]
         SAGE: mu.pp()          # uneven indentation
    -    ****
    -    ****
    +       ****   ***   *
    +       ****   ***   *
    +              **
    +              *
         SAGE: PartitionTuples.global_options(convention="French")
         SAGE: mu.pp()         # fix doctest with uneven indentation
    +    *
    +    **
    +    ****   ***   *
    +    ****   ***   *
         SAGE: PartitionTuples.global_options.reset()
**********************************************************************
```



---

Comment by jdemeyer created at 2013-10-12 09:44:14

Changing status from positive_review to needs_work.


---

Comment by andrew.mathas created at 2013-10-14 08:03:20

Replying to [comment:56 jdemeyer]:
> The `diff` output isn't portable, on Solaris:

This is going to be tricky as I don't have access to a solaris machine so I can't test this. The only difference between the two diffs is where the `+    [0 0 0]` appears.

It seems that the problem may be that `-fixdoctests` uses a universal diff:

```python
os.system('diff -u %s %s | more'%(test_file, test_output))
```

Aunty google suggests that a context diff may work better:

```
os.system('diff -c %s %s | more'%(test_file, test_output))
```

Is anyone able to confirm this?

Looking at this there is also an issue because diff may not be installed on the system, or it may not be in the users PATH. The script should try and trap the resulting errors in these cases...although I'll need to find appropriate exceptions to look for. Of course, in all of these cases this test will fail but I don't see a way around this. Having `diff` installed presumably isn't, and shouldn't be, a requirement for sage.

Is there a way to mark tests for the doc-test suite to ignore a test on certain systems?

A.


---

Comment by andrew.mathas created at 2013-10-14 08:14:55

Please ignore my queries: I have just discovered difflib which should fix both issues.
A.


---

Comment by andrew.mathas created at 2013-10-14 09:11:54

Makes fixdoctests use difflib to generate diffs


---

Attachment

OK, the script now uses `difflib` to compare the input and output files so hopefully this will fix the solaris problem and potential issues with other operating systems.

The tests pass me for me on a mac.

```
sage -t ../tests/cmdline.py
    [204 tests, 48.07 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 48.1 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 48.1 seconds
```


A.


---

Comment by andrew.mathas created at 2013-10-14 09:13:23

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2013-10-14 18:57:59

My output on Linux (Ubuntu) matches the output on Solaris. In other words, I also get the doctest failure [comment:56 noted above].


---

Comment by tscrim created at 2013-10-14 19:00:45

Actually, since it does diff properly, should we:

* mark the doctest as `# random`,
* look at the beginning and ending with a `...` inbetween since it matches there?


---

Comment by andrew.mathas created at 2013-10-14 20:12:15

Replying to [comment:61 tscrim]:
> My output on Linux (Ubuntu) matches the output on Solaris. In other words, I also get the doctest failure [comment:56 noted above].

Hi Travis,

Sorry, this is my mistake: previously when you tested the script it worked, so the problem you're seeing is not because ubuntu's diff returns the same output as solaris. Rather that when I tested the the new patch I thought that I had the full patch applied but I was in the wrong branch where the patch was not applied. Sorry.

The new output, I hope, should be independent of the system diff as it uses difflib, which is a python module for generating diffs. In any case the new diff is closer to that returned by solaris than the previous universal diff.

With the patch applied, this time, I get the following:

```
sage -t cmdline.py
    [213 tests, 52.19 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 52.3 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 52.2 seconds
```


The new version of `trac_10589--doctests_for_fixdoctests-am.patch​` is now on trac.

Andrew


---

Attachment

Makes fixdoctests use difflib to generate diffs


---

Comment by tscrim created at 2013-10-15 16:58:34

Okay the new patch works for me on linux. Thanks Andrew.


---

Comment by tscrim created at 2013-10-15 16:58:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-10-19 09:20:33

Resolution: fixed
