# Issue 27400: Equivariant Ehrhart Theory

Issue created by migration from https://trac.sagemath.org/ticket/27637

Original creator: @sophiasage

Original creation time: 2019-04-11 07:44:17

CC:  jipilab




---

Comment by @sophiasage created at 2019-04-11 08:01:46

Changing priority from major to minor.


---

Comment by @sophiasage created at 2019-04-11 08:01:46

Changing component from PLEASE CHANGE to geometry.


---

Comment by @sophiasage created at 2019-04-11 08:01:46

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @sophiasage created at 2019-04-11 08:01:46

Changing keywords from "" to "#Days98".


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by git created at 2020-09-25 09:04:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-28 07:36:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-17 21:17:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-17 21:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-03 20:15:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-31 12:18:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-31 12:42:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-31 12:46:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2021-03-31 13:56:22

Few comments:

- Is there a reason for the H to be capitalized?
- The references should be placed in the references in the doc (see other files in polyhedron folder)
- "The group Z/2Z acts ..." could be math formatted
- Look at the conventions for docstring (example is the function vertex_facet_graph in base.py of the polyhedron folder). Further info here: https://doc.sagemath.org/html/en/developer/coding_basics.html

Then, one has to figure out how to integrate the code to the polyhedron class appropriately. I will address this in another comment.


---

Comment by git created at 2021-04-06 13:26:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-26 14:56:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-26 14:58:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-28 07:59:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-28 09:26:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-28 10:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-28 11:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-29 08:05:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-29 10:03:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-29 12:02:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-01 12:04:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-05 07:34:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-05 09:16:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-05 14:27:03

Hello, Sophia

* In the bib file, use unicode characters and not latex syntax, here:

```
Federico Ardila, Mariel Supina, and Andr\ ́{e}s R. Vindas-Mel\ ́{e}ndez, 
```


* I will now lauch my patchbot on the branch, so that you can also benefit from the patchbot's report.


---

Comment by chapoton created at 2021-05-05 15:36:57

syntax error (missing import)

```
      File "/home/chapoton/sage/local/lib/python3.9/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 2521
        from sage.rings.fraction_field_element is_element_of_base_ring

```



---

Comment by git created at 2021-05-05 16:33:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-05-05 16:52:07

Thank you Frédéric! I'm still trying to figure out the import error (besides just missing the word import)


---

Comment by chapoton created at 2021-05-05 18:08:24

well, "is_element_of_base_ring" is a method in a class, it cannot be imported, but only used


---

Comment by git created at 2021-05-05 18:14:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-06 09:24:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-06 13:59:14

patchbot says that the doc does not build:

```
polyhedron/base_QQ.py:docstring of sage.geometry.polyhedron.base_QQ.Polyhedron_QQ.Hstar_function:17: WARNING: Unexpected indentation.
```

because the lines

```
+           If ``None``, it is set to the full `restricted_automorphism_group`
+           of `self`. The acting group should always use output='permutation'.
```

there are indented by one more space than they should


---

Comment by git created at 2021-05-07 12:21:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-07 15:08:01

Now the doc buils, but doctests fails:

```
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/base_QQ.py  # 5 doctests failed
sage -t --long --random-seed=0 src/sage/rings/fraction_field_element.pyx  # 4 doctests failed
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/backend_normaliz.py  # 2 doctests failed
```


Note also that that the patchbot plugins give some warnings (click on the round status badge, then on the links next to the small red crosses). The first one tells you that you should not remove the r in `r"""` here:

```diff
-r"""
+"""
 Base class for polyhedra over `\QQ`
 """
```



---

Comment by git created at 2021-05-10 14:39:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-12 18:32:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-16 07:53:27

the failing doctests in src/sage/rings/fraction_field_element.pyx are caused by the wrong change made in the existing doc in this file:

```diff
-            sage: from sage.rings.fraction_field_element import FractionFieldElement
+            sage: from sage.rings import fraction_field_element
```



---

Comment by git created at 2021-05-17 08:14:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-17 17:25:34

ok, making progress :)

now when you have a doctest taking several lines like

```
sage: 2+
....: 3
```

then you must tag **both lines** with `# optional - pynormaliz` and not only the first or the second.


---

Comment by selia created at 2021-05-18 07:33:11

Thank you for helping so much :) 
sorry that it is going slowly.


---

Comment by git created at 2021-05-18 08:26:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-18 09:43:14

I am happy to help, one step after another. Not far from being good to go, I think.

Some other comments:

in `/src/sage/rings/fraction_field_element.pyx`, `EXAMPLES:` should take two colons.

in general, `NOTE:` should be `.. NOTE::` and the content indented by 4


---

Comment by git created at 2021-05-19 07:42:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-05-20 07:06:41

I am not sure it is worth introducing "is_element_of_base_ring" to use it only once.

In "_Hstar_is_effective_normaliz", you could avoid using flag and just return False as soon as you meet the condition. Then "return True" at the end.

Otherwise, patchbot is green, so this now needs a more mathematical review. I am afraid I cannot do that. Maybe Jean-Philippe can take the task ?


---

Comment by jipilab created at 2021-06-09 08:08:27

Replying to [comment:46 chapoton]:
> I am not sure it is worth introducing "is_element_of_base_ring" to use it only once.
> 
> In "_Hstar_is_effective_normaliz", you could avoid using flag and just return False as soon as you meet the condition. Then "return True" at the end.
> 
> Otherwise, patchbot is green, so this now needs a more mathematical review. I am afraid I cannot do that. Maybe Jean-Philippe can take the task ?
> 
Salut Frédéric, merci beaucoup pour l'aide, c'est très apprécié!

Yes, I can go over the math for sure.


---

Comment by git created at 2021-06-09 08:25:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-10 17:19:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-13 16:48:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-14 15:13:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 09:40:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2021-07-14 10:01:15

Here are a few comments:

 - Since the GAP import is only used once, I would put it inside the function that uses only to limit global imports.

 - I'm not sure about the function ".is_full_dimensional". This is a bit a colloquial term and it isn't harder than checking if the ambient dim is the same as the dimension of the polytope (think: which is more transparent in the code "full_dimensional" or "ambient dim=dim"). I believe that the former is more transparent. I would delete the new method.

 - You don't need the import of "var". Check how this is done in ehrhart_series in backend_normaliz. "new_result" is going to complain, but you can easily get a list by using the .gens of the ring you create...

 - Could you use "set" instead of "Set"?

 - The docstring of "fixed_subpolytopes" should be revisited. What does it return? I expect polytopes from the fct name, but then the first sentence is super intricated. Then the output should say that "the elements of ..." are the keys. 

 - Within the function Hstar_function_normaliz, you should try to put all the imports at the beginning of the function.

 - I suggest '_express_Hstar_as_rational_fn_in_t' -> "_Hstar_as_rat_fct"


---

Comment by jipilab created at 2021-07-14 10:01:34

Changing status from new to needs_review.


---

Comment by jipilab created at 2021-07-14 10:01:40

Changing status from needs_review to needs_work.


---

Comment by selia created at 2021-07-14 14:47:58

Thank you for the comments Jean-Philippe.
I didn't write the method is_full_dimensional... i don't know why it is showing up in the diff - it wasn't before.
I will work on your other comments


---

Comment by mkoeppe created at 2021-07-14 16:53:33


```
+    def is_full_dimensional(self):
+        """
+        Return whether the polyhedron is full dimensional.
+
+        OUTPUT:
```

This comes from a bad merge, please remove. 

`is_full_dimensional` was moved from `Polyhedron_base` to the new base class `ConvexSet_base` in #31919.


---

Comment by git created at 2021-08-02 13:24:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-08-02 13:37:28

Replying to [comment:53 jipilab]:
> Here are a few comments:
> 
>  - Since the GAP import is only used once, I would put it inside the function that uses only to limit global imports.
Done
>  - I'm not sure about the function ".is_full_dimensional". This is a bit a colloquial term and it isn't harder than checking if the ambient dim is the same as the dimension of the polytope (think: which is more transparent in the code "full_dimensional" or "ambient dim=dim"). I believe that the former is more transparent. I would delete the new method.
Removed method and use of is_full_dimensional
>  - You don't need the import of "var". Check how this is done in ehrhart_series in backend_normaliz. "new_result" is going to complain, but you can easily get a list by using the .gens of the ring you create...
Done
>  - Could you use "set" instead of "Set"?
Tried this but it gave an unhashable error
>  - The docstring of "fixed_subpolytopes" should be revisited. What does it return? I expect polytopes from the fct name, but then the first sentence is super intricated. Then the output should say that "the elements of ..." are the keys. 
Changed
>  - Within the function Hstar_function_normaliz, you should try to put all the imports at the beginning of the function.
Done 
>  - I suggest '_express_Hstar_as_rational_fn_in_t' -> "_Hstar_as_rat_fct"
Done

I was forced to pull and merge before I could commit my changes.. I'm not sure if I did that correctly and/or messed anything up.


---

Comment by mkoeppe created at 2021-08-02 17:41:41

Replying to [comment:59 selia]:
> >  - Could you use "set" instead of "Set"?
> Tried this but it gave an unhashable error

There's also `frozenset`, which is immutable and hashable if its elements are


---

Comment by git created at 2021-08-04 07:17:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-08-04 07:19:04

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2021-08-24 08:19:45

In the function `Hstar_function_normaliz` change


```diff
+        if perm == ident_perm:
+            pass
+        else:
+            raise ValueError("The conjugacy classes don't match with the character table")
```


To an AssertionError using an assert, it is better than ValueError.

I would not use a flag but simply write:


```diff
+        codim = self.ambient_dim() - self.dim()
+        for perm in conj_reps:
+            mat = group_dict[perm]
+            mat = mat.change_ring(Ring)
+            new_matrix = identity - mat*ts_matrix
-            if flag:
-                det = (1-t)**-codim*(new_matrix.determinant())
-            else:
-                det = new_matrix.determinant()
+            det = (1-t)**-codim*(new_matrix.determinant())
+            det_vector.append(det)
```



---

Comment by jipilab created at 2021-08-24 08:19:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-08-24 13:25:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-27 08:07:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-09-27 08:08:25

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-09-29 15:27:32

I am seeing a few details that could be enhanced, but only cosmetics:
* some

```
return(something)
```

that should rather be

```
return something
```

* and some `raise SomeError('message')` where the message starts with a capital letter (it should not)


---

Comment by git created at 2021-10-22 11:03:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-10-22 18:56:11

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-10-22 18:56:11

ok, thanks. Let this enter, then.

Jean-Philippe, c'est bon pour toi ?


---

Comment by vbraun created at 2021-10-24 10:33:11

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-10-24 10:33:11

PDF docs fail

```
[docpdf] ! Missing $ inserted.
[docpdf] <inserted text> 
[docpdf]                 $
[docpdf] l.49818 Here, \(\H^
[docpdf]                    *(t) = \sum\_{m} \chi\_{m\text{\)\}\}t\textasciicircum{}m...
[docpdf] 
[docpdf] ? 
[docpdf] ! Emergency stop.
```



---

Comment by slelievre created at 2021-10-25 14:59:38

In `src/sage/geometry/polyhedron/base_QQ.py`:


```diff
     def Hstar_function(self, acting_group=None, output=None):
         r"""
         Return `H^*` as a rational function in `t` with coefficients in
         the ring of class functions of the ``acting_group``
         of this polytope.

-        Here, `\H^*(t) = \sum\_{m} \chi\_{m\text{``self``}}t^m det(Id-\rho(t))`.
+        Here, `H^*(t) = \sum\_{m} \chi\_{m\text{``self``}}t^m \det(Id-\rho(t))`.
         The irreducible characters of ``acting_group`` form an orthonormal basis
         for the ring of class functions with values in `\mathbb C`.
         The coefficients of `H^*(t)` are expressed in this basis.
```



---

Comment by git created at 2021-10-26 14:14:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-10-26 14:17:19

There were some pyflakes errors:

src/sage/geometry/polyhedron/base.py:4191:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:7354:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:7940:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:10822:13 'sage.graphs.graph' imported but unused

Should I remove these imports or ignore this?


---

Comment by mkoeppe created at 2021-10-26 18:08:20

These warnings are not coming from this ticket. If you find a way to silence them (perhaps there are comments that can control pyflakes?), that's great, but these imports are needed for feature testing.


---

Comment by selia created at 2021-11-02 10:41:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-11-02 10:55:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-11-02 13:37:54

Oops, the comments I added silence the warnings from base.py when I run

```
flake8 base.py 
```

but not 

```
pyflakes base.py
```

So I will remove them again.


---

Comment by git created at 2021-11-02 13:40:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-11-13 08:27:50

noch ein mal ; let's try again


---

Comment by chapoton created at 2021-11-13 08:27:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-11-15 23:08:56

PDF docbuild fails:

```
[sagemath_doc_pdf-none] {\)\}\}t\textasciicircum {}m det(Id\sphinxhyphen {}rho(t))\textasciigrave \ETC.
[sagemath_doc_pdf-none] ! Paragraph ended before \text@ was complete.
[sagemath_doc_pdf-none] <to be read again> 
[sagemath_doc_pdf-none]                    \par 
[sagemath_doc_pdf-none] l.47822 
[sagemath_doc_pdf-none]         
[sagemath_doc_pdf-none] ? 
[sagemath_doc_pdf-none] ! Emergency stop.
[sagemath_doc_pdf-none] <to be read again> 
[sagemath_doc_pdf-none]                    \par 
[sagemath_doc_pdf-none] l.47822 
```



---

Comment by vbraun created at 2021-11-15 23:08:56

Changing status from positive_review to needs_work.


---

Comment by slelievre created at 2021-11-15 23:25:02

This might solve the issue:

```diff
-        Here, `H^*(t) = \sum\_{m} \chi\_{m\text{``self``}}t^m \det(Id-\rho(t))`.
+        Here, `H^*(t) = \sum\_{m} \chi\_{m\text{self}}t^m \det(Id-\rho(t))`.
```



---

Comment by git created at 2021-11-17 14:36:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-11-23 08:50:19

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-11-24 07:43:18

Sophia, would you please check that pdf (and html) documentation builds ? I cannot handle that, and it would be better not to send again the ticket to the release manager without being sure that everything now works.


---

Comment by selia created at 2021-11-24 08:40:44

Changing status from needs_review to needs_work.


---

Comment by selia created at 2021-11-24 08:40:44

Hi Frédéric - yes I'll do that! (Sorry not to have attempted yet) I don't remember how to do it, but I'll ask Jean-Philippe for a pointer to some documentation.


---

Comment by chapoton created at 2021-11-24 09:03:42

This should be just

```
make doc-pdf
```

and

```
make doc-html
```

This may take some time, given the size of the documents.


---

Comment by selia created at 2021-11-25 09:50:54

Thanks! 
They both built this time. However, they could look nicer. I will work on that.


---

Comment by git created at 2021-12-13 15:07:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2021-12-13 15:38:05

I don't understand why the merge failed. Any help?


---

Comment by chapoton created at 2021-12-13 16:01:50

Hello, there a conflict with 9.5.beta8 in the imports header of 

```
CONFLIT (contenu) : Conflit de fusion dans src/sage/geometry/polyhedron/base.py
```

This should be easy to fix.


---

Comment by git created at 2022-02-14 14:11:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-02-15 07:08:45

pyflakes plugin complains about imports


---

Comment by selia created at 2022-02-15 07:28:18

I don't think those errors are from this ticket - earlier mkoeppe said those imports are needed for feature testing


---

Comment by chapoton created at 2022-02-15 07:37:54

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2022-02-15 07:37:54

ok, then let us try to merge this.


---

Comment by mkoeppe created at 2022-02-28 19:52:03

Changing priority from minor to major.


---

Comment by vbraun created at 2022-02-28 22:33:14


```
**********************************************************************
61
File "src/sage/modular/modform/ambient.py", line 791, in sage.modular.modform.ambient.?._compute_hecke_matrix
62
Failed example:
63
    [f[0]%p for p in prime_range(100)] # long time (0s, depends on above)
64
Expected:
65
    [0, 0, 0, 0, 1, 9, 2, 7, 0, 0, 0, 0, 1, 12, 9, 16, 37, 0, 21, 11, 70, 22, 0, 58, 76]
66
Got:
67
    [0,
68
     0,
69
     1,
70
     5,
71
     1,
72
     0,
73
     8,
74
     1,
75
     1,
76
     3,
77
     27,
78
     28,
79
     17,
80
     33,
81
     44,
82
     50,
83
     25,
84
     29,
85
     32,
86
     59,
87
     61,
88
     32,
89
     43,
90
     53,
91
     0]
92
**********************************************************************
93
File "src/sage/modular/modform/ambient.py", line 793, in sage.modular.modform.ambient.?._compute_hecke_matrix
94
Failed example:
95
    [f[42]%p for p in prime_range(100)] # long time (0s, depends on above)
96
Expected:
97
    [0, 0, 4, 0, 10, 4, 4, 8, 12, 1, 23, 13, 10, 27, 20, 13, 16, 59, 53, 41, 11, 13, 12, 6, 82]
98
Got:
99
    [0,
100
     2,
101
     2,
102
     3,
103
     5,
104
     1,
105
     9,
106
     2,
107
     19,
108
     4,
109
     6,
110
     36,
111
     1,
112
     32,
113
     39,
114
     19,
115
     23,
116
     58,
117
     29,
118
     14,
119
     30,
120
     71,
121
     49,
122
     80,
123
     31]
124
**********************************************************************
125
1 item had failures:
126
   2 of  12 in sage.modular.modform.ambient.?._compute_hecke_matrix
127
    [118 tests, 2 failures, 1.66 s]
128
----------------------------------------------------------------------
129
sage -t --long --warn-long 41.1 --random-seed=123 src/sage/modular/modform/ambient.py  # 2 doctests failed
130
----------------------------------------------------------------------
131
```



---

Comment by vbraun created at 2022-02-28 22:33:14

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-02-28 23:01:35

Unlikely that this failure is coming from this ticket


---

Comment by selia created at 2022-03-07 10:05:41

I don't think this error is coming from the ticket either... that example isn't from this ticket.


---

Comment by chapoton created at 2022-03-07 10:10:12

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2022-03-07 10:10:12

indeed, so let us switch back to "positive review"


---

Comment by vbraun created at 2022-03-09 23:38:33

Resolution: fixed
