# Issue 9449: The summary printed after running doctests is inaccurate.

archive/issues_009449.json:
```json
{
    "body": "The following shows a summary of a doctest failures. They were actually observed on a Solaris machine, but that is unlikely to be relevant. After building Sage\n\n```\n$ make ptestlong\n```\n\nwas executed. \n\n* 5 of the 6 doctest failures in the summary have 0 tests failing.\n* BSD.py is the only one of the 6 doctest failures which has a non-zero number of failures. \n\n```\n\nThe following tests failed:\n\n    sage -t     -long devel/sage/doc/fr/tutorial/programming.rst # 0 doctests failed\n    sage -t     -long devel/sage/sage/schemes/plane_curves/constructor.py # 0 doctests failed\n    sage -t     -long devel/sage/sage/schemes/elliptic_curves/BSD.py # 1 doctests failed\n    sage -t     -long devel/sage/sage/parallel/decorate.py # 0 doctests failed\n    sage -t     -long devel/sage/sage/libs/galrep/wrapper.pyx # 0 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 3990.8 seconds \n```\n\nIn the case of one of the tests, it would appear from the log that it actually passed \n\n```\nsage -t     -long devel/sage/sage/parallel/decorate.py\n     [44.0 s] \n```\n\nThis is pretty damn serious, as it means we can not rely on the doctest results. \n\n == Hardware and software used ==\n* sage-4.5.alpha4\n* A Sun T5240\n* 2 x 8 core, 64-thread UltraSPARC T2+ 1167 MHz\n* 32 GB RAM\n* Solaris 10 update 7 (05/09)\n* t2.math.washtington.edu\n* gcc 4.4.1 configured to use both the Sun linker and assembler.\n* 32-bit build (This is the default). The environment variable `SAGE64` was **not** used.\n\n\n\nAssignee: mvngu\n\nCC:  simonking @jhpalmieri @qed777 @nexttime\n\nReviewer: Jeroen Demeyer\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/9449\n\n",
    "closed_at": "2013-02-22T21:37:04Z",
    "created_at": "2010-07-07T19:57:20Z",
    "labels": [
        "component: doctest coverage",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "The summary printed after running doctests is inaccurate.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9449",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```
The following shows a summary of a doctest failures. They were actually observed on a Solaris machine, but that is unlikely to be relevant. After building Sage

```
$ make ptestlong
```

was executed. 

* 5 of the 6 doctest failures in the summary have 0 tests failing.
* BSD.py is the only one of the 6 doctest failures which has a non-zero number of failures. 

```

The following tests failed:

    sage -t     -long devel/sage/doc/fr/tutorial/programming.rst # 0 doctests failed
    sage -t     -long devel/sage/sage/schemes/plane_curves/constructor.py # 0 doctests failed
    sage -t     -long devel/sage/sage/schemes/elliptic_curves/BSD.py # 1 doctests failed
    sage -t     -long devel/sage/sage/parallel/decorate.py # 0 doctests failed
    sage -t     -long devel/sage/sage/libs/galrep/wrapper.pyx # 0 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3990.8 seconds 
```

In the case of one of the tests, it would appear from the log that it actually passed 

```
sage -t     -long devel/sage/sage/parallel/decorate.py
     [44.0 s] 
```

This is pretty damn serious, as it means we can not rely on the doctest results. 

 == Hardware and software used ==
* sage-4.5.alpha4
* A Sun T5240
* 2 x 8 core, 64-thread UltraSPARC T2+ 1167 MHz
* 32 GB RAM
* Solaris 10 update 7 (05/09)
* t2.math.washtington.edu
* gcc 4.4.1 configured to use both the Sun linker and assembler.
* 32-bit build (This is the default). The environment variable `SAGE64` was **not** used.



Assignee: mvngu

CC:  simonking @jhpalmieri @qed777 @nexttime

Reviewer: Jeroen Demeyer

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/9449





---

archive/issue_comments_094214.json:
```json
{
    "body": "Results from long doctests on t2.math.washington.edu (Solaris 10, UltraSPARC CPUs)",
    "created_at": "2010-07-07T19:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94214",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Results from long doctests on t2.math.washington.edu (Solaris 10, UltraSPARC CPUs)



---

archive/issue_comments_094215.json:
```json
{
    "body": "<a id='comment:1'></a>Attachment [ptestlong.log](tarball://root/attachments/some-uuid/ticket9449/ptestlong.log) by @wjp created at 2010-07-07 20:01:44\n\nCould you try with patches #8641, #9243, #9316 to the doctest framework? They clean up and fix parts of the error handling.\n\nIf they don't fix it yet, I can give you a patch which adds some extra debugging info to track this down.",
    "created_at": "2010-07-07T20:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94215",
    "user": "https://github.com/wjp"
}
```

<a id='comment:1'></a>Attachment [ptestlong.log](tarball://root/attachments/some-uuid/ticket9449/ptestlong.log) by @wjp created at 2010-07-07 20:01:44

Could you try with patches #8641, #9243, #9316 to the doctest framework? They clean up and fix parts of the error handling.

If they don't fix it yet, I can give you a patch which adds some extra debugging info to track this down.



---

archive/issue_comments_094216.json:
```json
{
    "body": "<a id='comment:2'></a>I've attached a log. \n\nAlso corrected something which was cut and pasted from another ticket",
    "created_at": "2010-07-07T20:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94216",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:2'></a>I've attached a log. 

Also corrected something which was cut and pasted from another ticket



---

archive/issue_comments_094217.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -39,8 +39,9 @@\n * Solaris 10 update 7 (05/09)\n * t2.math.washtington.edu\n * gcc 4.4.1 configured to use both the Sun linker and assembler.\n-* MD5 checksum of matplotlib-1.0.0.spkg was cb9f3cb0ec3da550d2d67ea7e8b6094f\n * 32-bit build (This is the default). The environment variable `SAGE64` was **not** used.\n+\n+\n \n Priority: critical\n \n```\n",
    "created_at": "2010-07-07T20:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94217",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Description changed:
```diff
--- 
+++ 
@@ -39,8 +39,9 @@
 * Solaris 10 update 7 (05/09)
 * t2.math.washtington.edu
 * gcc 4.4.1 configured to use both the Sun linker and assembler.
-* MD5 checksum of matplotlib-1.0.0.spkg was cb9f3cb0ec3da550d2d67ea7e8b6094f
 * 32-bit build (This is the default). The environment variable `SAGE64` was **not** used.
+
+
 
 Priority: critical
 
```




---

archive/issue_comments_094218.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:1 wjp]:\n> Could you try with patches #8641, #9243, #9316 to the doctest framework? They clean up and fix parts of the error handling.\n\n\nYes. The only problem I have is that these test failures are not always reproducible. Tests which failed when I run \n\n`$ make ptestlong` \n\nactually passed later. There's a report from John H Palmieri on sage-release of `devel/sage/sage/misc/trace.py` failing for him three times on this machine, then working. This makes any sort of testing difficult, and means it will be hard for me to know if s #8641, #9243, #9316 really solve the problem or not. But I will try them and report back later. \n \n> If they don't fix it yet, I can give you a patch which adds some extra debugging info to track this down.\n\n\nOK, thank you. \n\nI know there was a recent patch to the doctesting to remove spurious errors about files not found - #9316. I don't know if these could be related or not. \n\nI've got other strange results from doctests too, but I'll put that on another ticket. \n\nDave",
    "created_at": "2010-07-07T20:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94218",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:3'></a>Replying to [comment:1 wjp]:
> Could you try with patches #8641, #9243, #9316 to the doctest framework? They clean up and fix parts of the error handling.


Yes. The only problem I have is that these test failures are not always reproducible. Tests which failed when I run 

`$ make ptestlong` 

actually passed later. There's a report from John H Palmieri on sage-release of `devel/sage/sage/misc/trace.py` failing for him three times on this machine, then working. This makes any sort of testing difficult, and means it will be hard for me to know if s #8641, #9243, #9316 really solve the problem or not. But I will try them and report back later. 
 
> If they don't fix it yet, I can give you a patch which adds some extra debugging info to track this down.


OK, thank you. 

I know there was a recent patch to the doctesting to remove spurious errors about files not found - #9316. I don't know if these could be related or not. 

I've got other strange results from doctests too, but I'll put that on another ticket. 

Dave



---

archive/issue_comments_094219.json:
```json
{
    "body": "<a id='comment:4'></a>I was unable to apply the last patch cleanly - the first two were ok. \n\n```\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/8641/trac_8641-doctest_exit_codes.3.patch\nadding trac_8641-doctest_exit_codes.3.patch to series file\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush\napplying trac_8641-doctest_exit_codes.3.patch\nnow at: trac_8641-doctest_exit_codes.3.patch\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/9243/trac_9243.patch\nadding trac_9243.patch to series file\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush\napplying trac_9243.patch\nnow at: trac_9243.patch\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/9316/scripts9316_timeout_rebased.patch\nadding scripts9316_timeout_rebased.patch to series file\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush\napplying scripts9316_timeout_rebased.patch\npatching file sage-doctest\nHunk #1 FAILED at 18\n1 out of 2 hunks FAILED -- saving rejects to file sage-doctest.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh scripts9316_timeout_rebased.patch\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg status\nkirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg log | more\nchangeset:   1541:6510dc91cc05\ntag:         scripts9316_timeout_rebased.patch\ntag:         qtip\ntag:         tip\nuser:        Willem Jan Palenstijn <wpalenst@math.leidenuniv.nl>\ndate:        Tue Jul 06 22:58:13 2010 +0200\nsummary:     #9316: Add exit code 64 for time out to doctests\n\nchangeset:   1540:6e69aa36dd4d\ntag:         trac_9243.patch\nuser:        Dan Drake <drake@kaist.edu>\ndate:        Wed Jun 16 13:48:32 2010 +0900\nsummary:     trac 9243: sage-doctest should use powers of 2 for return codes\n\nchangeset:   1539:08d8519d03dc\ntag:         trac_8641-doctest_exit_codes.3.patch\ntag:         qbase\nuser:        Mitesh Patel <qed777@gmail.com>\ndate:        Wed Jun 16 00:06:03 2010 -0700\nsummary:     trac 8641: return nonzero code if tests fail.  Dan Drake, John Palmieri\n```",
    "created_at": "2010-07-07T20:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94219",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:4'></a>I was unable to apply the last patch cleanly - the first two were ok. 

```
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/8641/trac_8641-doctest_exit_codes.3.patch
adding trac_8641-doctest_exit_codes.3.patch to series file
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush
applying trac_8641-doctest_exit_codes.3.patch
now at: trac_8641-doctest_exit_codes.3.patch
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/9243/trac_9243.patch
adding trac_9243.patch to series file
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush
applying trac_9243.patch
now at: trac_9243.patch
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qimport http://trac.sagemath.org/sage_trac/raw-attachment/ticket/9316/scripts9316_timeout_rebased.patch
adding scripts9316_timeout_rebased.patch to series file
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg qpush
applying scripts9316_timeout_rebased.patch
patching file sage-doctest
Hunk #1 FAILED at 18
1 out of 2 hunks FAILED -- saving rejects to file sage-doctest.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh scripts9316_timeout_rebased.patch
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg status
kirkby@t2:[/tmp/kirkby/sage-4.5.alpha4/local/bin] $ hg log | more
changeset:   1541:6510dc91cc05
tag:         scripts9316_timeout_rebased.patch
tag:         qtip
tag:         tip
user:        Willem Jan Palenstijn <wpalenst@math.leidenuniv.nl>
date:        Tue Jul 06 22:58:13 2010 +0200
summary:     #9316: Add exit code 64 for time out to doctests

changeset:   1540:6e69aa36dd4d
tag:         trac_9243.patch
user:        Dan Drake <drake@kaist.edu>
date:        Wed Jun 16 13:48:32 2010 +0900
summary:     trac 9243: sage-doctest should use powers of 2 for return codes

changeset:   1539:08d8519d03dc
tag:         trac_8641-doctest_exit_codes.3.patch
tag:         qbase
user:        Mitesh Patel <qed777@gmail.com>
date:        Wed Jun 16 00:06:03 2010 -0700
summary:     trac 8641: return nonzero code if tests fail.  Dan Drake, John Palmieri
```



---

archive/issue_comments_094220.json:
```json
{
    "body": "<a id='comment:5'></a>You're missing the second patch at #9243.",
    "created_at": "2010-07-07T20:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94220",
    "user": "https://github.com/wjp"
}
```

<a id='comment:5'></a>You're missing the second patch at #9243.



---

archive/issue_comments_094221.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 wjp]:\n> You're missing the second patch at #9243.\n\n\nThank you. I've applied them all now and started the doctests, but I feel tired tonight and are going to sleep now.  So I doubt I'll post the results for a few hours yet. \n \n\nDave",
    "created_at": "2010-07-07T21:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94221",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:6'></a>Replying to [comment:5 wjp]:
> You're missing the second patch at #9243.


Thank you. I've applied them all now and started the doctests, but I feel tired tonight and are going to sleep now.  So I doubt I'll post the results for a few hours yet. 
 

Dave



---

archive/issue_comments_094222.json:
```json
{
    "body": "<a id='comment:7'></a>Here's the results after applying #8641, #9243, #9316. As you can see, there are still tests which fail with 0 doctest failures (These results are again on the Sun T5240 t2.math.washington.edu, which is the same as before). \n\n```\n\nsage -t  -long devel/sage/sage/modular/ssmod/ssmod.py\n         [3001.1 s]\nsage -t  -long devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\n         [3137.3 s]\n \n----------------------------------------------------------------------\n\nThe following tests failed:\n\n        sage -t  -long devel/sage/doc/en/constructions/number_fields.rst # 0 doctests failed\n        sage -t  -long devel/sage/sage/categories/examples/hopf_algebras_with_basis.py # 0 doctests failed\n        sage -t  -long devel/sage/sage/libs/galrep/wrapper.pyx # 0 doctests failed\n        sage -t  -long devel/sage/sage/parallel/decorate.py # 1 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 4264.8 seconds\n```\n\n\n\nHere's the first one, which fails, but with 0 recorded failures. \n\n```\nsage -t  -long devel/sage/doc/en/constructions/number_fields.rst\npython: can't open file '/rootpool2/local/kirkby/.sage//tmp/number_fields.py': [Errno 2] No such file or directory\n\n         [1.9 s]\n```\n\nHere's the second recorded failure \n\n```\nsage -t  -long devel/sage/sage/categories/examples/hopf_algebras_with_basis.py\npython: can't open file '/rootpool2/local/kirkby/.sage//tmp/hopf_algebras_with_basis.py': [Errno 2] No such file or directory\n\n         [1.7 s]\n```\n\nThe third failure is where Sage crashed:\n\n```\nsage -t  -long devel/sage/sage/libs/galrep/wrapper.pyx\n\n\n------------------------------------------------------------\nUnhandled SIGBUS: A bus error occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nor is not properly wrapped with _sig_on, _sig_off.\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n------------------------------------------------------------\n\n\n         [21.5 s]\n```\n\nThis is recorded as 0 failures, despite the fact Sage crashed. \n\nThe only test that is recorded as a failure, with a non-zero number of failures, is the last test\n\n```\nsage -t  -long devel/sage/sage/parallel/decorate.py\n**********************************************************************\nFile \"/tmp/kirkby/sage-4.5.alpha4/devel/sage-testing/sage/parallel/decorate.py\", line 152:\n    sage: v = list(f([1,2,4])); v.sort(); v\nException raised:\n    Traceback (most recent call last):\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_4[9]>\", line 1, in <module>\n        v = list(f([Integer(1),Integer(2),Integer(4)])); v.sort(); v###line 152:\n    sage: v = list(f([1,2,4])); v.sort(); v\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/lib/python/site-packages/sage/parallel/multiprocessing_sage.py\", line 64, in parallel_iter\n        p = Pool(processes)\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/__init__.py\", line 227, in Pool\n        return Pool(processes, initializer, initargs)\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/pool.py\", line 104, in __init__\n        w.start()\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/process.py\", line 104, in start\n        self._popen = Popen(self)\n      File \"/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/forking.py\", line 94, in __init__\n        self.pid = os.fork()\n    OSError: [Errno 12] Not enough space\n**********************************************************************\n1 items had failures:\n   1 of  12 in __main__.example_4\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /rootpool2/local/kirkby/.sage//tmp/.doctest_decorate.py\n         [51.3 s]\n```\n\nDave",
    "created_at": "2010-07-08T08:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94222",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:7'></a>Here's the results after applying #8641, #9243, #9316. As you can see, there are still tests which fail with 0 doctest failures (These results are again on the Sun T5240 t2.math.washington.edu, which is the same as before). 

```

sage -t  -long devel/sage/sage/modular/ssmod/ssmod.py
         [3001.1 s]
sage -t  -long devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py
         [3137.3 s]
 
----------------------------------------------------------------------

The following tests failed:

        sage -t  -long devel/sage/doc/en/constructions/number_fields.rst # 0 doctests failed
        sage -t  -long devel/sage/sage/categories/examples/hopf_algebras_with_basis.py # 0 doctests failed
        sage -t  -long devel/sage/sage/libs/galrep/wrapper.pyx # 0 doctests failed
        sage -t  -long devel/sage/sage/parallel/decorate.py # 1 doctests failed
----------------------------------------------------------------------
Total time for all tests: 4264.8 seconds
```



Here's the first one, which fails, but with 0 recorded failures. 

```
sage -t  -long devel/sage/doc/en/constructions/number_fields.rst
python: can't open file '/rootpool2/local/kirkby/.sage//tmp/number_fields.py': [Errno 2] No such file or directory

         [1.9 s]
```

Here's the second recorded failure 

```
sage -t  -long devel/sage/sage/categories/examples/hopf_algebras_with_basis.py
python: can't open file '/rootpool2/local/kirkby/.sage//tmp/hopf_algebras_with_basis.py': [Errno 2] No such file or directory

         [1.7 s]
```

The third failure is where Sage crashed:

```
sage -t  -long devel/sage/sage/libs/galrep/wrapper.pyx


------------------------------------------------------------
Unhandled SIGBUS: A bus error occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------


         [21.5 s]
```

This is recorded as 0 failures, despite the fact Sage crashed. 

The only test that is recorded as a failure, with a non-zero number of failures, is the last test

```
sage -t  -long devel/sage/sage/parallel/decorate.py
**********************************************************************
File "/tmp/kirkby/sage-4.5.alpha4/devel/sage-testing/sage/parallel/decorate.py", line 152:
    sage: v = list(f([1,2,4])); v.sort(); v
Exception raised:
    Traceback (most recent call last):
      File "/tmp/kirkby/sage-4.5.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/tmp/kirkby/sage-4.5.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/tmp/kirkby/sage-4.5.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_4[9]>", line 1, in <module>
        v = list(f([Integer(1),Integer(2),Integer(4)])); v.sort(); v###line 152:
    sage: v = list(f([1,2,4])); v.sort(); v
      File "/tmp/kirkby/sage-4.5.alpha4/local/lib/python/site-packages/sage/parallel/multiprocessing_sage.py", line 64, in parallel_iter
        p = Pool(processes)
      File "/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/__init__.py", line 227, in Pool
        return Pool(processes, initializer, initargs)
      File "/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/pool.py", line 104, in __init__
        w.start()
      File "/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/process.py", line 104, in start
        self._popen = Popen(self)
      File "/tmp/kirkby/sage-4.5.alpha4/local/lib/python2.6/multiprocessing/forking.py", line 94, in __init__
        self.pid = os.fork()
    OSError: [Errno 12] Not enough space
**********************************************************************
1 items had failures:
   1 of  12 in __main__.example_4
***Test Failed*** 1 failures.
For whitespace errors, see the file /rootpool2/local/kirkby/.sage//tmp/.doctest_decorate.py
         [51.3 s]
```

Dave



---

archive/issue_comments_094223.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2010-07-08T11:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94223",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_094224.json:
```json
{
    "body": "<a id='comment:8'></a>I've marked this as a blocker, as I can't see how we can justify making a release if the summary of the doc tests can't be trusted to be correct. If we can't trust the tests, what can we trust?",
    "created_at": "2010-07-08T11:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94224",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:8'></a>I've marked this as a blocker, as I can't see how we can justify making a release if the summary of the doc tests can't be trusted to be correct. If we can't trust the tests, what can we trust?



---

archive/issue_comments_094225.json:
```json
{
    "body": "The log file 'ptestlong.log' after trac items #8641, #9243- and #9316 had been applied. This is the same build of Sage as before",
    "created_at": "2010-07-08T14:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94225",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

The log file 'ptestlong.log' after trac items #8641, #9243- and #9316 had been applied. This is the same build of Sage as before



---

archive/issue_comments_094226.json:
```json
{
    "body": "<a id='comment:10'></a>Attachment [ptestlong-after-trac-#8641-#9243-#9316.log](tarball://root/attachments/some-uuid/ticket9449/ptestlong-after-trac-#8641-#9243-#9316.log) by @nexttime created at 2010-07-08 15:50:11",
    "created_at": "2010-07-08T15:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94226",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>Attachment [ptestlong-after-trac-#8641-#9243-#9316.log](tarball://root/attachments/some-uuid/ticket9449/ptestlong-after-trac-#8641-#9243-#9316.log) by @nexttime created at 2010-07-08 15:50:11



---

archive/issue_comments_094227.json:
```json
{
    "body": "<a id='comment:11'></a>The \"# failures\" that sage reports is calculated very simply by counting the number of instances of \"Expected:\" \"Expected nothing\" and \"Exception raised:\".\n\nSage correctly detected that things went wrong, as you can tell from the fact that the files causing errors are listed in the summary at the end.\n\nAs far as I can tell, the only thing that's not quite right is the reporting of what exactly went wrong. There's likely a better way of reporting these specific crashes and missing file errors you're getting, but I don't see any reason to believe something is as seriously wrong with the error reporting as you seem to be implying on this ticket and on the mailing list.\n\n(Reverting priority to major.)\n\n\nThe file not found errors (Are you out of disk space?) should probably be caught before the doctesting process is launched in the first place. I'll have to think about the SIGBUS case some more.",
    "created_at": "2010-07-08T15:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94227",
    "user": "https://github.com/wjp"
}
```

<a id='comment:11'></a>The "# failures" that sage reports is calculated very simply by counting the number of instances of "Expected:" "Expected nothing" and "Exception raised:".

Sage correctly detected that things went wrong, as you can tell from the fact that the files causing errors are listed in the summary at the end.

As far as I can tell, the only thing that's not quite right is the reporting of what exactly went wrong. There's likely a better way of reporting these specific crashes and missing file errors you're getting, but I don't see any reason to believe something is as seriously wrong with the error reporting as you seem to be implying on this ticket and on the mailing list.

(Reverting priority to major.)


The file not found errors (Are you out of disk space?) should probably be caught before the doctesting process is launched in the first place. I'll have to think about the SIGBUS case some more.



---

archive/issue_comments_094228.json:
```json
{
    "body": "<a id='comment:13'></a>To reproduce the singal reporting issue:\n\n```\n./sage -tp 1 bus.sage\n```\n\nwith bus.sage containing\n\n```\n\"\"\"\n    sage: import os\n    sage: os.kill(os.getpid(), 7)\n\"\"\"\n```",
    "created_at": "2010-07-08T16:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94228",
    "user": "https://github.com/wjp"
}
```

<a id='comment:13'></a>To reproduce the singal reporting issue:

```
./sage -tp 1 bus.sage
```

with bus.sage containing

```
"""
    sage: import os
    sage: os.kill(os.getpid(), 7)
"""
```



---

archive/issue_comments_094229.json:
```json
{
    "body": "<a id='comment:14'></a>It's not convenient for me to test these now, but take a look at the doctest `sage -t  -long devel/sage/sage/parallel/decorate.py`  on line 4732 of\n\nhttp://trac.sagemath.org/sage_trac/attachment/ticket/9449/ptestlong.log\n\nAs far as I can see, there is absolutely no error message there, so nothing to indicate that this failed, but rather that it passed in 44.0s. But at the end it is listed as failing. \n\nI did 64 tests in parallel. It's possible the file system may have got too full. I will retest with fewer parallel tasks. \n\nDave",
    "created_at": "2010-07-08T17:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94229",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:14'></a>It's not convenient for me to test these now, but take a look at the doctest `sage -t  -long devel/sage/sage/parallel/decorate.py`  on line 4732 of

http://trac.sagemath.org/sage_trac/attachment/ticket/9449/ptestlong.log

As far as I can see, there is absolutely no error message there, so nothing to indicate that this failed, but rather that it passed in 44.0s. But at the end it is listed as failing. 

I did 64 tests in parallel. It's possible the file system may have got too full. I will retest with fewer parallel tasks. 

Dave



---

archive/issue_comments_094230.json:
```json
{
    "body": "<a id='comment:15'></a>I can only tell there are indeed flaws and inconsistencies in the doctest framework (I started examining it a few days ago, made some notes, but haven't finished yet).\n\nE.g. `sage-doctest` exit code 1 can either mean \"file not found\", a command line syntax error or even a keyboard interrupt.\nI don't understand why `sage-test` and `sage-ptest` are separated, though they contain common code that might get (or yet is) out of sync.\nDifferent scripts use different temporary directories...\nSome `make` targets for testing do `./sage -b`, others do not...\n\nJust to name a few; I'll continue to investigate the bunch of involved scripts further, but don't really know how soon.\n\n-Leif",
    "created_at": "2010-07-08T18:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94230",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>I can only tell there are indeed flaws and inconsistencies in the doctest framework (I started examining it a few days ago, made some notes, but haven't finished yet).

E.g. `sage-doctest` exit code 1 can either mean "file not found", a command line syntax error or even a keyboard interrupt.
I don't understand why `sage-test` and `sage-ptest` are separated, though they contain common code that might get (or yet is) out of sync.
Different scripts use different temporary directories...
Some `make` targets for testing do `./sage -b`, others do not...

Just to name a few; I'll continue to investigate the bunch of involved scripts further, but don't really know how soon.

-Leif



---

archive/issue_comments_094231.json:
```json
{
    "body": "<a id='comment:16'></a>Yes, it definitely needs more cleaning up. There are already a number of patches floating around doing part of this, though. (See the aforementioned #8641, #9243, #9316 that should at least take care of the exit code 1, and also #9224, #9225 for some future plans. There may also be more.)",
    "created_at": "2010-07-08T19:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94231",
    "user": "https://github.com/wjp"
}
```

<a id='comment:16'></a>Yes, it definitely needs more cleaning up. There are already a number of patches floating around doing part of this, though. (See the aforementioned #8641, #9243, #9316 that should at least take care of the exit code 1, and also #9224, #9225 for some future plans. There may also be more.)



---

archive/issue_comments_094232.json:
```json
{
    "body": "<a id='comment:17'></a>I don't know if *this* one is the origin, but it's simply **horrible**:\n\n```python\ndef test_file(F):\n    \"\"\"\n    This is the function that actually tests a file\n    \"\"\"\n    outfile = tempfile.NamedTemporaryFile()\n    base, ext = os.path.splitext(F)\n\n    cmd = 'doctest ' + opts\n    if SAGE_SITE in os.path.realpath(F) and not '-force_lib' in cmd:\n        cmd += ' -force_lib'\n\n    filestr = os.path.split(F)[1]\n    for i in range(0,numiteration):\n        os.chdir(os.path.dirname(F))\n        command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)\n        s = 'bash -c \"%s %s > %s\" ' % (command, filestr, outfile.name)\n        try:\n            t = time.time()\n            ret = os.system(s)\n            finished_time = time.time() - t\n            if ret>=256:\n                ret=ret/256\n            ret = -ret\n        except:\n            ol = outfile.read()\n            return (-5, 0, ol)\n        ol = outfile.read()\n        if ret != 0:\n            break\n    return (F, ret, finished_time, ol)\n```\n(Excerpt from `sage-ptest`, note not just the returned tuples...)\n\nBeat me if I've missed something here...",
    "created_at": "2010-07-08T20:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94232",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:17'></a>I don't know if *this* one is the origin, but it's simply **horrible**:

```python
def test_file(F):
    """
    This is the function that actually tests a file
    """
    outfile = tempfile.NamedTemporaryFile()
    base, ext = os.path.splitext(F)

    cmd = 'doctest ' + opts
    if SAGE_SITE in os.path.realpath(F) and not '-force_lib' in cmd:
        cmd += ' -force_lib'

    filestr = os.path.split(F)[1]
    for i in range(0,numiteration):
        os.chdir(os.path.dirname(F))
        command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)
        s = 'bash -c "%s %s > %s" ' % (command, filestr, outfile.name)
        try:
            t = time.time()
            ret = os.system(s)
            finished_time = time.time() - t
            if ret>=256:
                ret=ret/256
            ret = -ret
        except:
            ol = outfile.read()
            return (-5, 0, ol)
        ol = outfile.read()
        if ret != 0:
            break
    return (F, ret, finished_time, ol)
```
(Excerpt from `sage-ptest`, note not just the returned tuples...)

Beat me if I've missed something here...



---

archive/issue_comments_094233.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 leif]:\n> I don't know if *this* one is the origin, but it's simply **horrible**:\n> \n> ```\n> #!python\n> def test_file(F):\n>     \"\"\"\n>     This is the function that actually tests a file\n>     \"\"\"\n>     outfile = tempfile.NamedTemporaryFile()\n>     base, ext = os.path.splitext(F)\n> \n>     cmd = 'doctest ' + opts\n>     if SAGE_SITE in os.path.realpath(F) and not '-force_lib' in cmd:\n>         cmd += ' -force_lib'\n> \n>     filestr = os.path.split(F)[1]\n>     for i in range(0,numiteration):\n>         os.chdir(os.path.dirname(F))\n>         command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)\n>         s = 'bash -c \"%s %s > %s\" ' % (command, filestr, outfile.name)\n>         try:\n>             t = time.time()\n>             ret = os.system(s)\n>             finished_time = time.time() - t\n>             if ret>=256:\n>                 ret=ret/256\n>             ret = -ret\n>         except:\n>             ol = outfile.read()\n>             return (-5, 0, ol)\n>         ol = outfile.read()\n>         if ret != 0:\n>             break\n>     return (F, ret, finished_time, ol)\n> ```\n> (Excerpt from `sage-ptest`, note not just the returned tuples...)\n> \n> Beat me if I've missed something here...\n> \n\nI barely know Python, so there is nothing I can do about this. But if you have a better solution, it would be worth trying it. I feel a bit uneasy about Sage, when we can't trust the mechanism for testing it. \n\nIt's odd why failures on some test is pretty repeatable when running `make ptestlong` but run individually, they pass. I'm pretty sure that is not a memory issue, as I've noticed that on my Sun Blade 2000 SPARC where I'm the only user. That machine has 8 GB RAM and only two processors (its not multi-cored or multi-threaded), so I don't run more than 3 tests in parallel.",
    "created_at": "2010-07-19T10:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94233",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:18'></a>Replying to [comment:17 leif]:
> I don't know if *this* one is the origin, but it's simply **horrible**:
> 
> ```
> #!python
> def test_file(F):
>     """
>     This is the function that actually tests a file
>     """
>     outfile = tempfile.NamedTemporaryFile()
>     base, ext = os.path.splitext(F)
> 
>     cmd = 'doctest ' + opts
>     if SAGE_SITE in os.path.realpath(F) and not '-force_lib' in cmd:
>         cmd += ' -force_lib'
> 
>     filestr = os.path.split(F)[1]
>     for i in range(0,numiteration):
>         os.chdir(os.path.dirname(F))
>         command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)
>         s = 'bash -c "%s %s > %s" ' % (command, filestr, outfile.name)
>         try:
>             t = time.time()
>             ret = os.system(s)
>             finished_time = time.time() - t
>             if ret>=256:
>                 ret=ret/256
>             ret = -ret
>         except:
>             ol = outfile.read()
>             return (-5, 0, ol)
>         ol = outfile.read()
>         if ret != 0:
>             break
>     return (F, ret, finished_time, ol)
> ```
> (Excerpt from `sage-ptest`, note not just the returned tuples...)
> 
> Beat me if I've missed something here...
> 

I barely know Python, so there is nothing I can do about this. But if you have a better solution, it would be worth trying it. I feel a bit uneasy about Sage, when we can't trust the mechanism for testing it. 

It's odd why failures on some test is pretty repeatable when running `make ptestlong` but run individually, they pass. I'm pretty sure that is not a memory issue, as I've noticed that on my Sun Blade 2000 SPARC where I'm the only user. That machine has 8 GB RAM and only two processors (its not multi-cored or multi-threaded), so I don't run more than 3 tests in parallel.



---

archive/issue_comments_094234.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:7 drkirkby]:\n> The only test that is recorded as a failure, with a non-zero number of failures, is the last test\n\n\nI've opened #9895 for the recurring \"Not enough space\" error on Solaris raised by `os.fork` in `sage/parallel/decorate.py`.",
    "created_at": "2010-09-11T00:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94234",
    "user": "https://github.com/qed777"
}
```

<a id='comment:19'></a>Replying to [comment:7 drkirkby]:
> The only test that is recorded as a failure, with a non-zero number of failures, is the last test


I've opened #9895 for the recurring "Not enough space" error on Solaris raised by `os.fork` in `sage/parallel/decorate.py`.



---

archive/issue_comments_094235.json:
```json
{
    "body": "<a id='comment:20'></a>Since #12415 completely rewrites the doctest framework with much better code, I'm assuming this problem is fixed.",
    "created_at": "2013-02-22T21:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94235",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Since #12415 completely rewrites the doctest framework with much better code, I'm assuming this problem is fixed.



---

archive/issue_events_023361.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T21:37:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9449#event-23361"
}
```



---

archive/issue_events_023362.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T21:37:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9449#event-23362"
}
```



---

archive/issue_comments_094236.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2013-02-22T21:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9449#issuecomment-94236",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate
