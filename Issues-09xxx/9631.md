# Issue 9631: Remerge #9501 after resolving NFS and/or doctest problems with @fork

archive/issues_009631.json:
```json
{
    "body": "We merged #9501 in Sage 4.5.2.alpha1 but backed it out entirely in 4.5.2.rc0 (cf. #9616), because a Network File System (NFS) problem on the Sage cluster gives frequent doctest failures.\n\nPlease see #9501 and #9616 for discussion.\n\nApply [attachment:trac_9631-fork_decorator.5.patch]\n\nAssignee: @jasongrout\n\nCC:  @nexttime @jhpalmieri @kcrisman @malb mvngu simonking @williamstein\n\nResolution: fixed\n\nAuthor: William Stein, Mitesh Patel\n\nReviewer: Volker Braun\n\nMerged: sage-4.7.2.alpha2\n\nIssue created by migration from https://trac.sagemath.org/ticket/9631\n\n",
    "closed_at": "2011-08-18T22:01:53Z",
    "created_at": "2010-07-29T05:12:06Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Remerge #9501 after resolving NFS and/or doctest problems with @fork",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9631",
    "user": "https://github.com/qed777"
}
```
We merged #9501 in Sage 4.5.2.alpha1 but backed it out entirely in 4.5.2.rc0 (cf. #9616), because a Network File System (NFS) problem on the Sage cluster gives frequent doctest failures.

Please see #9501 and #9616 for discussion.

Apply [attachment:trac_9631-fork_decorator.5.patch]

Assignee: @jasongrout

CC:  @nexttime @jhpalmieri @kcrisman @malb mvngu simonking @williamstein

Resolution: fixed

Author: William Stein, Mitesh Patel

Reviewer: Volker Braun

Merged: sage-4.7.2.alpha2

Issue created by migration from https://trac.sagemath.org/ticket/9631





---

archive/issue_comments_093166.json:
```json
{
    "body": "<a id='comment:1'></a>After the recent changes on the Sage cluster, I still see failures on sage.math with 4.6.alpha2 + #9501's v2 patch:\n\n```python\nsage-4.6.a2$ env DOT_SAGE=\"$HOME/.sage\" ./sage -t -long devel/sage/sage/parallel/decorate.py\nsage -t -long \"devel/sage/sage/parallel/decorate.py\"        \n\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nor is not properly wrapped with _sig_on, _sig_off.\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n------------------------------------------------------------\n\n**********************************************************************\nFile \"/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py\", line 300:\n    sage: g()\nExpected:\n    '10'\nGot:\n    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_0/.nfs00000000015a0bad0006c177'\n    '10'\n**********************************************************************\nFile \"/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py\", line 311:\n    sage: g()\nExpected:\n    'a'\nGot:\n    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_1/.nfs00000000015a0bad0006c178'\n    'a'\n**********************************************************************\nFile \"/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py\", line 300:\n    sage: g()\nExpected:\n    '10'\nGot:\n    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_0/.nfs00000000015a0bad0006c177'\n    '10'\n**********************************************************************\nFile \"/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py\", line 311:\n    sage: g()\nExpected:\n    'a'\nGot:\n    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_1/.nfs00000000015a0bad0006c178'\n    'a'\n```\nI believe the `Unhandled SIGSEGV` is expected.",
    "created_at": "2010-10-05T05:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93166",
    "user": "https://github.com/qed777"
}
```

<a id='comment:1'></a>After the recent changes on the Sage cluster, I still see failures on sage.math with 4.6.alpha2 + #9501's v2 patch:

```python
sage-4.6.a2$ env DOT_SAGE="$HOME/.sage" ./sage -t -long devel/sage/sage/parallel/decorate.py
sage -t -long "devel/sage/sage/parallel/decorate.py"        


------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------

**********************************************************************
File "/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py", line 300:
    sage: g()
Expected:
    '10'
Got:
    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_0/.nfs00000000015a0bad0006c177'
    '10'
**********************************************************************
File "/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py", line 311:
    sage: g()
Expected:
    'a'
Got:
    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_1/.nfs00000000015a0bad0006c178'
    'a'
**********************************************************************
File "/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py", line 300:
    sage: g()
Expected:
    '10'
Got:
    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_0/.nfs00000000015a0bad0006c177'
    '10'
**********************************************************************
File "/mnt/usb1/scratch/mpatel/apps/sage-4.6.a2/devel/sage/sage/parallel/decorate.py", line 311:
    sage: g()
Expected:
    'a'
Got:
    [Errno 16] Device or resource busy: '/home/mpatel/.sage/temp/sage.math.washington.edu/7514/dir_1/.nfs00000000015a0bad0006c178'
    'a'
```
I believe the `Unhandled SIGSEGV` is expected.



---

archive/issue_comments_093167.json:
```json
{
    "body": "<a id='comment:2'></a>Ticket #10098 is about a similar `[Errno 16] Device or resource busy` error.",
    "created_at": "2010-10-10T09:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93167",
    "user": "https://github.com/qed777"
}
```

<a id='comment:2'></a>Ticket #10098 is about a similar `[Errno 16] Device or resource busy` error.



---

archive/issue_comments_093168.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 mpatel]:\n> Ticket #10098 is about a similar `[Errno 16] Device or resource busy` error.\n\n\nSee #10098's [comment:ticket:10098:9 comment 9ff] for a proposed possible solution.",
    "created_at": "2010-10-10T09:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93168",
    "user": "https://github.com/qed777"
}
```

<a id='comment:3'></a>Replying to [comment:2 mpatel]:
> Ticket #10098 is about a similar `[Errno 16] Device or resource busy` error.


See #10098's [comment:ticket:10098:9 comment 9ff] for a proposed possible solution.



---

archive/issue_comments_093169.json:
```json
{
    "body": "Attachment [trac_9631-fork_decorator.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.patch) by @qed777 created at 2010-10-22 08:00:52\n\nVersion of #9501's v2, rebased for 4.6.rc0.",
    "created_at": "2010-10-22T08:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93169",
    "user": "https://github.com/qed777"
}
```

Attachment [trac_9631-fork_decorator.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.patch) by @qed777 created at 2010-10-22 08:00:52

Version of #9501's v2, rebased for 4.6.rc0.



---

archive/issue_comments_093170.json:
```json
{
    "body": "<a id='comment:4'></a>I've attached a tweaked version of William's patch v2 from #9501.",
    "created_at": "2010-10-22T08:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93170",
    "user": "https://github.com/qed777"
}
```

<a id='comment:4'></a>I've attached a tweaked version of William's patch v2 from #9501.



---

archive/issue_events_024012.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-22T08:04:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9631#event-24012"
}
```



---

archive/issue_comments_093171.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-22T08:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93171",
    "user": "https://github.com/qed777"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_093172.json:
```json
{
    "body": "Attachment [trac_9631-fork_decorator.2.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.2.patch) by @vbraun created at 2011-08-03 09:58:50\n\nRediffed for sage-4.7.1.rc1",
    "created_at": "2011-08-03T09:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93172",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_9631-fork_decorator.2.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.2.patch) by @vbraun created at 2011-08-03 09:58:50

Rediffed for sage-4.7.1.rc1



---

archive/issue_comments_093173.json:
```json
{
    "body": "One more docfix",
    "created_at": "2011-08-03T10:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93173",
    "user": "https://github.com/vbraun"
}
```

One more docfix



---

archive/issue_comments_093174.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-03T10:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93174",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_093175.json:
```json
{
    "body": "<a id='comment:5'></a>Attachment [trac_9631-fork_decorator.3.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.3.patch) by @vbraun created at 2011-08-03 10:53:24\n\nI've updated the patch for Sage-4.7.1, there were some rejects due to changed docstrings. I didn't touch any actual functionality. \n\nThe actual workings of the fork decorator look good. Positive review.",
    "created_at": "2011-08-03T10:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93175",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Attachment [trac_9631-fork_decorator.3.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.3.patch) by @vbraun created at 2011-08-03 10:53:24

I've updated the patch for Sage-4.7.1, there were some rejects due to changed docstrings. I didn't touch any actual functionality. 

The actual workings of the fork decorator look good. Positive review.



---

archive/issue_events_024013.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-03T14:44:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9631#event-24013"
}
```



---

archive/issue_events_024014.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-03T14:44:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9631#event-24014"
}
```



---

archive/issue_comments_093176.json:
```json
{
    "body": "<a id='comment:7'></a>There are still a few typos in the docstrings.\n\nRelated (but *should<sup>TM</sup>* apply independently, haven't tested this yet): #11658",
    "created_at": "2011-08-14T16:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93176",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>There are still a few typos in the docstrings.

Related (but *should<sup>TM</sup>* apply independently, haven't tested this yet): #11658



---

archive/issue_comments_093177.json:
```json
{
    "body": "Attachment [trac_9631-fork_decorator.4.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.4.patch) by @williamstein created at 2011-08-15 02:49:43\n\npolished docstrings fixing some typos.",
    "created_at": "2011-08-15T02:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93177",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_9631-fork_decorator.4.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.4.patch) by @williamstein created at 2011-08-15 02:49:43

polished docstrings fixing some typos.



---

archive/issue_comments_093178.json:
```json
{
    "body": "<a id='comment:8'></a>Hi Leif,  I just attached trac_9631-fork_decorator.4.patch which polished the docstrings fixing some typos.  If there are any remaining typos, please point them out explicitly.",
    "created_at": "2011-08-15T02:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93178",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>Hi Leif,  I just attached trac_9631-fork_decorator.4.patch which polished the docstrings fixing some typos.  If there are any remaining typos, please point them out explicitly.



---

archive/issue_comments_093179.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 was]:\n> Hi Leif,  I just attached trac_9631-fork_decorator.4.patch which polished the docstrings fixing some typos.  If there are any remaining typos, please point them out explicitly.\n\n\n```diff\n--- trac_9631-fork_decorator.4.patch.orig\t2011-08-15 05:19:25.000000000 +0200\n+++ trac_9631-fork_decorator.4.patch\t2011-08-15 06:10:11.000000000 +0200\n@@ -17,7 +17,7 @@\n +++ b/sage/parallel/decorate.py\n @@ -15,19 +15,17 @@\n      r\"\"\"\n-     Convert a to a pair (args, kwds) using some rules:\n+     Convert ``a`` to a pair ``(args, kwds)`` using some rules:\n  \n -        * if already of that form, leave that way.\n -        * if a is a tuple make (a,{})\n@@ -44,7 +44,7 @@\n @@ -53,9 +51,14 @@\n  class Parallel:\n      r\"\"\"\n-     Create parallel decorated function.\n+     Create ``parallel``-decorated function.\n -\n      \"\"\"\n      def __init__(self, p_iter = 'fork', ncpus=None, **kwds):\n@@ -56,7 +56,7 @@\n +        \"\"\"\n          # The default p_iter is currently the reference implementation.\n          # This may change.\n-         self.p_iter = None\n+         self.p_iter = None # ??? = p_iter, which defaults to 'fork', not the sequ. ref. impl.\n @@ -81,19 +84,16 @@\n  \n      def __call__(self, f):\n@@ -67,8 +67,8 @@\n -        in possibly random order. Here x is replaced by its\n +        Create a function that wraps ``f`` and that when called with a\n +        list of inputs returns an iterator over pairs ``(x, f(x))`` in\n-+        possibly random order. Here ``x`` is replaced by its\n-         normalized form (args, kwds) using normalize_inputs.\n++        possibly random order.  Here ``x`` is replaced by its\n+         normalized form ``(args, kwds)`` using ``normalize_inputs()``.\n  \n          INPUT:\n -\n@@ -102,7 +102,7 @@\n +         The parallel subprocesses will not have access to data\n +         created in pexpect interfaces.  This behavior with respect to\n +         pexpect interfaces is very important to keep in mind when\n-+         setting up certain computations. It's the one big limitation\n++         setting up certain computations.  It's the one big limitation\n +         of this decorator.\n +\n      INPUT:\n@@ -114,24 +114,24 @@\n +            - ``fork``            -- (default) use a new forked process for each input\n +            - ``multiprocessing`` -- use multiprocessing library\n +            - ``reference``       -- use a fake serial reference implementation\n-      - ``ncpus`` -- integer, number of cpus\n-      - ``timeout`` -- number of seconds until task is killed (only supported by 'fork')\n+      - ``ncpus`` -- integer, maximal number of subprocesses to use at the same time\n+      - ``timeout`` -- number of seconds until a subprocess is killed (only supported by ``fork``; zero means not at all)\n  \n +    .. warning::\n +\n-+         If you use anything but 'fork' above, then a whole new\n++         If you use anything but ``fork`` above, then a whole new\n +         subprocess is spawned, so none of your local state (variables,\n +         certain functions, etc.) is available.\n +\n      EXAMPLES:\n  \n-     We create a simple decoration for a simple function. The number\n+     We create a simple decoration for a simple function.  The number\n @@ -148,7 +166,6 @@\n          sage: @parallel(2)\n          ... def f(n): return n*n\n  \n -\n-     We create a decorator that uses 3 processes, and times out\n+     We create a decorator that uses three subprocesses, and times out\n      individual processes after 10 seconds::\n  \n @@ -174,3 +191,152 @@\n@@ -144,7 +144,7 @@\n +\n +###################################################################\n +# The @fork decorator -- evaluate a function with no side effects\n-+# in memory, so the only side effects are on disk.\n++# in memory, so the only side effects (if any) are on disk.\n +#\n +# We have both a function and a class below, so that the decorator\n +# can be used with or without options:\n@@ -158,13 +158,13 @@\n +\n +class Fork:\n +    \"\"\"\n-+    A fork decorator class. \n++    A ``fork`` decorator class.\n +    \"\"\"\n +    def __init__(self, timeout=0, verbose=False):\n +        \"\"\"\n +        INPUT:\n-+         - ``timeout`` -- (default: 0) kills subrocess after this many\n-+           seconds, or if timeout=0, do not kill the subprocess.\n++         - ``timeout`` -- (default: 0) kill each subprocess after it has run this many\n++           seconds (wall time), or if ``timeout`` is zero, do not kill any subprocesses.\n +         - ``verbose`` -- (default: ``False``) whether to print\n +           anything about what the decorator does (e.g., killing\n +           subprocesses)\n@@ -182,9 +182,11 @@\n +    def __call__(self, f):\n +        \"\"\"\n +        INPUT:\n+\n +         - ``f`` -- a function\n +\n +        OUTPUT:\n+\n +         - A decorated function.\n +\n +        EXAMPLES::\n@@ -206,30 +208,30 @@\n +    \"\"\"\n +    Decorate a function so that when called it runs in a forked\n +    subprocess.  This means that it won't have any in-memory\n-+    side-effects on the parent Sage process.  The pexpect interfaces\n++    side effects on the parent Sage process.  The pexpect interfaces\n +    are all reset. \n +    \n +    INPUT:\n +      - ``f`` -- a function\n-+      - ``timeout`` -- (default: 0) if positive, kills subrocess after\n-+        this many seconds\n++      - ``timeout`` -- (default: 0) if positive, kill subprocess after\n++        this many seconds (wall time)\n +      - ``verbose`` -- (default: ``False``) whether to print anything\n-+        about what the decorator does (e.g., killing subprocesses)\n++        about what the decorator does (e.g., killing the subprocess)\n +\n +    .. warning::\n +\n-+        The forked subprocesses will not have access to data created\n++        The forked subprocess will not have access to data created\n +        in pexpect interfaces.  This behavior with respect to pexpect\n +        interfaces is very important to keep in mind when setting up\n-+        certain computations. It's the one big limitation of this\n++        certain computations.  It's the one big limitation of this\n +        decorator.\n +\n +    EXAMPLES:\n +\n-+    We create a function and run it with the fork decorator.  Note\n++    We create a function and run it with the ``fork`` decorator.  Note\n +    that it does not have a side effect.  Despite trying to change\n-+    the global variable \"a\" below in g, the variable a does not get\n-+    changed.::\n++    the global variable ``a`` below in ``g``, the variable ``a`` does not get\n++    changed::\n +    \n +        sage: a = 5\n +        sage: @fork\n@@ -242,7 +244,7 @@\n +        sage: a\n +        5\n +\n-+    We use fork to make sure that the function terminates after 1\n++    We use ``fork`` to make sure that the function terminates after one\n +    second, no matter what::\n +    \n +        sage: @fork(timeout=1, verbose=True)\n@@ -253,7 +255,7 @@\n +        Killing subprocess ... with input ((10000000,), {'m': 5}) which took too long\n +        'NO DATA (timed out)'\n +\n-+    We illustrate that pexpect interface state is not affected by\n++    We illustrate that the state of the pexpect interface is not altered by\n +    forked functions (they get their own new pexpect interfaces!)::\n +    \n +        sage: gp.eval('a = 5')\n@@ -305,14 +307,14 @@\n -            - ``timeout`` -- (float) time in seconds until a subprocess is automatically killed\n -            - ``verbose`` -- whether to print anything about what the iterator does (e.g., killing subprocesses)\n +            - ``ncpus`` -- the maximal number of simultaneous\n-+              processes to spawn\n-+            - ``timeout`` -- (float, default: 0) time in seconds until\n++              subprocesses to spawn\n++            - ``timeout`` -- (float, default: 0) wall time in seconds until\n +              a subprocess is automatically killed\n +            - ``verbose`` -- (default: False) whether to print\n +              anything about what the iterator does (e.g., killing\n +              subprocesses)\n +            - ``reset_interfaces`` -- (default: True) whether to reset\n-+              all expect interfaces\n++              all pexpect interfaces\n  \n          EXAMPLES::\n  \n@@ -326,7 +328,7 @@\n          \"\"\"\n @@ -206,7 +213,8 @@\n  \n-             # The expect interfaces (and objects defined in them) are\n+             # The pexpect interfaces (and objects defined in them) are\n              # not valid.\n -            sage.interfaces.quit.invalidate_all()\n +            if self.reset_interfaces:\n```\n\nExplicit, but perhaps a bit inconvenient. Didn't apply it, only looked at the patch.",
    "created_at": "2011-08-15T04:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93179",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>Replying to [comment:8 was]:
> Hi Leif,  I just attached trac_9631-fork_decorator.4.patch which polished the docstrings fixing some typos.  If there are any remaining typos, please point them out explicitly.


```diff
--- trac_9631-fork_decorator.4.patch.orig	2011-08-15 05:19:25.000000000 +0200
+++ trac_9631-fork_decorator.4.patch	2011-08-15 06:10:11.000000000 +0200
@@ -17,7 +17,7 @@
 +++ b/sage/parallel/decorate.py
 @@ -15,19 +15,17 @@
      r"""
-     Convert a to a pair (args, kwds) using some rules:
+     Convert ``a`` to a pair ``(args, kwds)`` using some rules:
  
 -        * if already of that form, leave that way.
 -        * if a is a tuple make (a,{})
@@ -44,7 +44,7 @@
 @@ -53,9 +51,14 @@
  class Parallel:
      r"""
-     Create parallel decorated function.
+     Create ``parallel``-decorated function.
 -
      """
      def __init__(self, p_iter = 'fork', ncpus=None, **kwds):
@@ -56,7 +56,7 @@
 +        """
          # The default p_iter is currently the reference implementation.
          # This may change.
-         self.p_iter = None
+         self.p_iter = None # ??? = p_iter, which defaults to 'fork', not the sequ. ref. impl.
 @@ -81,19 +84,16 @@
  
      def __call__(self, f):
@@ -67,8 +67,8 @@
 -        in possibly random order. Here x is replaced by its
 +        Create a function that wraps ``f`` and that when called with a
 +        list of inputs returns an iterator over pairs ``(x, f(x))`` in
-+        possibly random order. Here ``x`` is replaced by its
-         normalized form (args, kwds) using normalize_inputs.
++        possibly random order.  Here ``x`` is replaced by its
+         normalized form ``(args, kwds)`` using ``normalize_inputs()``.
  
          INPUT:
 -
@@ -102,7 +102,7 @@
 +         The parallel subprocesses will not have access to data
 +         created in pexpect interfaces.  This behavior with respect to
 +         pexpect interfaces is very important to keep in mind when
-+         setting up certain computations. It's the one big limitation
++         setting up certain computations.  It's the one big limitation
 +         of this decorator.
 +
      INPUT:
@@ -114,24 +114,24 @@
 +            - ``fork``            -- (default) use a new forked process for each input
 +            - ``multiprocessing`` -- use multiprocessing library
 +            - ``reference``       -- use a fake serial reference implementation
-      - ``ncpus`` -- integer, number of cpus
-      - ``timeout`` -- number of seconds until task is killed (only supported by 'fork')
+      - ``ncpus`` -- integer, maximal number of subprocesses to use at the same time
+      - ``timeout`` -- number of seconds until a subprocess is killed (only supported by ``fork``; zero means not at all)
  
 +    .. warning::
 +
-+         If you use anything but 'fork' above, then a whole new
++         If you use anything but ``fork`` above, then a whole new
 +         subprocess is spawned, so none of your local state (variables,
 +         certain functions, etc.) is available.
 +
      EXAMPLES:
  
-     We create a simple decoration for a simple function. The number
+     We create a simple decoration for a simple function.  The number
 @@ -148,7 +166,6 @@
          sage: @parallel(2)
          ... def f(n): return n*n
  
 -
-     We create a decorator that uses 3 processes, and times out
+     We create a decorator that uses three subprocesses, and times out
      individual processes after 10 seconds::
  
 @@ -174,3 +191,152 @@
@@ -144,7 +144,7 @@
 +
 +###################################################################
 +# The @fork decorator -- evaluate a function with no side effects
-+# in memory, so the only side effects are on disk.
++# in memory, so the only side effects (if any) are on disk.
 +#
 +# We have both a function and a class below, so that the decorator
 +# can be used with or without options:
@@ -158,13 +158,13 @@
 +
 +class Fork:
 +    """
-+    A fork decorator class. 
++    A ``fork`` decorator class.
 +    """
 +    def __init__(self, timeout=0, verbose=False):
 +        """
 +        INPUT:
-+         - ``timeout`` -- (default: 0) kills subrocess after this many
-+           seconds, or if timeout=0, do not kill the subprocess.
++         - ``timeout`` -- (default: 0) kill each subprocess after it has run this many
++           seconds (wall time), or if ``timeout`` is zero, do not kill any subprocesses.
 +         - ``verbose`` -- (default: ``False``) whether to print
 +           anything about what the decorator does (e.g., killing
 +           subprocesses)
@@ -182,9 +182,11 @@
 +    def __call__(self, f):
 +        """
 +        INPUT:
+
 +         - ``f`` -- a function
 +
 +        OUTPUT:
+
 +         - A decorated function.
 +
 +        EXAMPLES::
@@ -206,30 +208,30 @@
 +    """
 +    Decorate a function so that when called it runs in a forked
 +    subprocess.  This means that it won't have any in-memory
-+    side-effects on the parent Sage process.  The pexpect interfaces
++    side effects on the parent Sage process.  The pexpect interfaces
 +    are all reset. 
 +    
 +    INPUT:
 +      - ``f`` -- a function
-+      - ``timeout`` -- (default: 0) if positive, kills subrocess after
-+        this many seconds
++      - ``timeout`` -- (default: 0) if positive, kill subprocess after
++        this many seconds (wall time)
 +      - ``verbose`` -- (default: ``False``) whether to print anything
-+        about what the decorator does (e.g., killing subprocesses)
++        about what the decorator does (e.g., killing the subprocess)
 +
 +    .. warning::
 +
-+        The forked subprocesses will not have access to data created
++        The forked subprocess will not have access to data created
 +        in pexpect interfaces.  This behavior with respect to pexpect
 +        interfaces is very important to keep in mind when setting up
-+        certain computations. It's the one big limitation of this
++        certain computations.  It's the one big limitation of this
 +        decorator.
 +
 +    EXAMPLES:
 +
-+    We create a function and run it with the fork decorator.  Note
++    We create a function and run it with the ``fork`` decorator.  Note
 +    that it does not have a side effect.  Despite trying to change
-+    the global variable "a" below in g, the variable a does not get
-+    changed.::
++    the global variable ``a`` below in ``g``, the variable ``a`` does not get
++    changed::
 +    
 +        sage: a = 5
 +        sage: @fork
@@ -242,7 +244,7 @@
 +        sage: a
 +        5
 +
-+    We use fork to make sure that the function terminates after 1
++    We use ``fork`` to make sure that the function terminates after one
 +    second, no matter what::
 +    
 +        sage: @fork(timeout=1, verbose=True)
@@ -253,7 +255,7 @@
 +        Killing subprocess ... with input ((10000000,), {'m': 5}) which took too long
 +        'NO DATA (timed out)'
 +
-+    We illustrate that pexpect interface state is not affected by
++    We illustrate that the state of the pexpect interface is not altered by
 +    forked functions (they get their own new pexpect interfaces!)::
 +    
 +        sage: gp.eval('a = 5')
@@ -305,14 +307,14 @@
 -            - ``timeout`` -- (float) time in seconds until a subprocess is automatically killed
 -            - ``verbose`` -- whether to print anything about what the iterator does (e.g., killing subprocesses)
 +            - ``ncpus`` -- the maximal number of simultaneous
-+              processes to spawn
-+            - ``timeout`` -- (float, default: 0) time in seconds until
++              subprocesses to spawn
++            - ``timeout`` -- (float, default: 0) wall time in seconds until
 +              a subprocess is automatically killed
 +            - ``verbose`` -- (default: False) whether to print
 +              anything about what the iterator does (e.g., killing
 +              subprocesses)
 +            - ``reset_interfaces`` -- (default: True) whether to reset
-+              all expect interfaces
++              all pexpect interfaces
  
          EXAMPLES::
  
@@ -326,7 +328,7 @@
          """
 @@ -206,7 +213,8 @@
  
-             # The expect interfaces (and objects defined in them) are
+             # The pexpect interfaces (and objects defined in them) are
              # not valid.
 -            sage.interfaces.quit.invalidate_all()
 +            if self.reset_interfaces:
```

Explicit, but perhaps a bit inconvenient. Didn't apply it, only looked at the patch.



---

archive/issue_comments_093180.json:
```json
{
    "body": "<a id='comment:10'></a>P.S.: The wording w.r.t. `ncpus` and `timeout` could be unified.",
    "created_at": "2011-08-15T04:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93180",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>P.S.: The wording w.r.t. `ncpus` and `timeout` could be unified.



---

archive/issue_comments_093181.json:
```json
{
    "body": "<a id='comment:11'></a>Since you changed the code, you should post a patch, since it seems silly for me to just manually copy your changes in...",
    "created_at": "2011-08-15T04:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93181",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>Since you changed the code, you should post a patch, since it seems silly for me to just manually copy your changes in...



---

archive/issue_comments_093182.json:
```json
{
    "body": "<a id='comment:12'></a>I see -- you literally patched the patch?   I don't know how to get your patch of the patch off of trac.  I can view it, but can't download it...?",
    "created_at": "2011-08-15T04:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93182",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:12'></a>I see -- you literally patched the patch?   I don't know how to get your patch of the patch off of trac.  I can view it, but can't download it...?



---

archive/issue_comments_093183.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 was]:\n> I see -- you literally patched the patch?   I don't know how to get your patch of the patch off of trac.  I can view it, but can't download it...?\n\n\nYep, sorry. (I actually *edited* your patch and then made a diff just for displaying.)\n\nIn principle one can extract inline patches from mail notifications (or \"reply\" to the comment just to copy parts), but since I also changed context lines, the patched patch wouldn't apply anyway.\n\nI was just going to upload a v5 (no code changes btw., just in comments), but somehow managed to totally mess up the patch (and apparently also the files themselves) such that I now have two mixed versions with *both* having some of your and some of my changes... 8/\n\nTrying to fix this, then I'll upload a \"real\" v5 patch; I made more changes than in the comment above.",
    "created_at": "2011-08-15T06:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93183",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>Replying to [comment:12 was]:
> I see -- you literally patched the patch?   I don't know how to get your patch of the patch off of trac.  I can view it, but can't download it...?


Yep, sorry. (I actually *edited* your patch and then made a diff just for displaying.)

In principle one can extract inline patches from mail notifications (or "reply" to the comment just to copy parts), but since I also changed context lines, the patched patch wouldn't apply anyway.

I was just going to upload a v5 (no code changes btw., just in comments), but somehow managed to totally mess up the patch (and apparently also the files themselves) such that I now have two mixed versions with *both* having some of your and some of my changes... 8/

Trying to fix this, then I'll upload a "real" v5 patch; I made more changes than in the comment above.



---

archive/issue_comments_093184.json:
```json
{
    "body": "Diff between v4 (William's) and v5 (Leif's) patch. For reference / review only.",
    "created_at": "2011-08-15T08:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93184",
    "user": "https://github.com/nexttime"
}
```

Diff between v4 (William's) and v5 (Leif's) patch. For reference / review only.



---

archive/issue_comments_093185.json:
```json
{
    "body": "Attachment [trac_9631-fork_decorator.4-5.diff](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.4-5.diff) by @nexttime created at 2011-08-15 08:26:45\n\nSome more docstring fixes.",
    "created_at": "2011-08-15T08:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93185",
    "user": "https://github.com/nexttime"
}
```

Attachment [trac_9631-fork_decorator.4-5.diff](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.4-5.diff) by @nexttime created at 2011-08-15 08:26:45

Some more docstring fixes.



---

archive/issue_comments_093186.json:
```json
{
    "body": "<a id='comment:14'></a>Attachment [trac_9631-fork_decorator.5.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.5.patch) by @nexttime created at 2011-08-15 08:40:32\n\nOk, attached a v5 patch, and a diff between William's v4 and my version.\n\nTake a look at it, haven't updated the description yet.\n\nHope I didn't miss something, as I had to redo almost all from scratch, because some very weird things must have happened. Not only did the editor confuse files, presumably due to renaming and symbolic links, but also my first committed and exported version completely vanished from the Mercurial repository, which must be some weird bug related to cloning  and rebuilding a branch.",
    "created_at": "2011-08-15T08:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93186",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>Attachment [trac_9631-fork_decorator.5.patch](tarball://root/attachments/some-uuid/ticket9631/trac_9631-fork_decorator.5.patch) by @nexttime created at 2011-08-15 08:40:32

Ok, attached a v5 patch, and a diff between William's v4 and my version.

Take a look at it, haven't updated the description yet.

Hope I didn't miss something, as I had to redo almost all from scratch, because some very weird things must have happened. Not only did the editor confuse files, presumably due to renaming and symbolic links, but also my first committed and exported version completely vanished from the Mercurial repository, which must be some weird bug related to cloning  and rebuilding a branch.



---

archive/issue_comments_093187.json:
```json
{
    "body": "<a id='comment:15'></a>Looks good. If you can add a description then we'll be good to go.",
    "created_at": "2011-08-15T13:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93187",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>Looks good. If you can add a description then we'll be good to go.



---

archive/issue_comments_093188.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-08-15T13:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93188",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_093189.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 vbraun]:\n> Looks good. If you can add a description then we'll be good to go.\n\n\n? I just meant I haven't updated *the ticket's* description to refer to the new v5 patch.",
    "created_at": "2011-08-15T16:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93189",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'></a>Replying to [comment:15 vbraun]:
> Looks good. If you can add a description then we'll be good to go.


? I just meant I haven't updated *the ticket's* description to refer to the new v5 patch.



---

archive/issue_comments_093190.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2011-08-15T16:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93190",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_093191.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-08-15T16:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93191",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_093192.json:
```json
{
    "body": "<a id='comment:18'></a>Sorry, I didn't notice that the patch does already include some description; since it starts with a hash-mark its somewhat indistinguishable from the automatic mercurial comments. But should be good enough.",
    "created_at": "2011-08-15T16:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93192",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Sorry, I didn't notice that the patch does already include some description; since it starts with a hash-mark its somewhat indistinguishable from the automatic mercurial comments. But should be good enough.



---

archive/issue_comments_093193.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-15T16:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93193",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_024015.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-18T22:01:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9631#event-24015"
}
```



---

archive/issue_comments_093194.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-08-18T22:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9631#issuecomment-93194",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
