# Issue 9016: make morphisms hashable

archive/issues_009016.json:
```json
{
    "assignees": [
        "https://github.com/aghitza"
    ],
    "body": "Attached patch makes morphisms hashable in a reasonably fast way by defining the following:\n\n```\n    def __hash__(self):\n        return hash((self._domain, self._codomain))\n```\n\nIt also defines specialized methods for `sage.rings.morphism.RingHomomorphism_im_gens` and `sage.rings.morphism.RingHomomorphism_from_quotient`.\n\nWhile testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.\n\nApply: [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)\n\nCC:  @robertwb\n\nComponent: **categories**\n\nAuthor: **Burcin Erocal**\n\nReviewer: **Robert Bradshaw, Travis Scrimshaw**\n\nMerged: **sage-5.6.beta1**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/9016_\n\n",
    "closed_at": "2012-12-21T09:32:03Z",
    "created_at": "2010-05-22T15:36:30Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20categories",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "make morphisms hashable",
    "type": "issue",
    "updated_at": "2012-12-21T09:32:03Z",
    "url": "https://github.com/sagemath/sage/issues/9016",
    "user": "https://github.com/burcin"
}
```
Attached patch makes morphisms hashable in a reasonably fast way by defining the following:

```
    def __hash__(self):
        return hash((self._domain, self._codomain))
```

It also defines specialized methods for `sage.rings.morphism.RingHomomorphism_im_gens` and `sage.rings.morphism.RingHomomorphism_from_quotient`.

While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.

Apply: [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)

CC:  @robertwb

Component: **categories**

Author: **Burcin Erocal**

Reviewer: **Robert Bradshaw, Travis Scrimshaw**

Merged: **sage-5.6.beta1**

_Issue created by migration from https://trac.sagemath.org/ticket/9016_





---

archive/issue_events_113548.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-22T15:36:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113548"
}
```



---

archive/issue_events_113549.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-22T15:36:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113549"
}
```



---

archive/issue_events_113550.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-22T15:36:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113550"
}
```



---

archive/issue_events_113551.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-22T15:36:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113551"
}
```



---

archive/issue_events_113552.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-05-22T15:36:30Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "subject": "https://github.com/burcin",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113552"
}
```



---

archive/issue_comments_074274.json:
```json
{
    "body": "Attachment: **[trac_9016-morphishm_hash.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.patch.gz)**",
    "created_at": "2010-05-22T15:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74274",
    "user": "https://github.com/burcin"
}
```

Attachment: **[trac_9016-morphishm_hash.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.patch.gz)**



---

archive/issue_events_113553.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-22T15:43:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113553"
}
```



---

archive/issue_comments_074275.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThere seems to be a problem with inheriting `__hash__()` methods. The class `sage.categories.morphism.SetMorphism` derives from `sage.categories.morphism.Morphism` which in turn derives from `sage.categories.map.Map`.\n\nEven after adding a `__hash__()` method to `sage.categories.map.Map`, instances of `SetMorphism` are not hashable:\n\n```\nsage: from sage.categories.morphism import SetMorphism\nsage: X.<x> = ZZ[]\nsage: Y = ZZ\nsage: phi = SetMorphism(Hom(X, Y, Rings()), lambda p: p[0])\nsage: hash(phi)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/home/burcin/sage/sage-4.4.1.alpha2-patched/<ipython console> in <module>()\n\nTypeError: unhashable type: 'sage.categories.morphism.SetMorphism'\n```\n\nNote also that `sage.categories.map.Map` derives from `sage.structure.element.Element` which also has a `__hash__()` method.\n\nAny hints?",
    "created_at": "2010-05-22T15:43:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74275",
    "user": "https://github.com/burcin"
}
```

<div id="comment:1" align="right">comment:1</div>

There seems to be a problem with inheriting `__hash__()` methods. The class `sage.categories.morphism.SetMorphism` derives from `sage.categories.morphism.Morphism` which in turn derives from `sage.categories.map.Map`.

Even after adding a `__hash__()` method to `sage.categories.map.Map`, instances of `SetMorphism` are not hashable:

```
sage: from sage.categories.morphism import SetMorphism
sage: X.<x> = ZZ[]
sage: Y = ZZ
sage: phi = SetMorphism(Hom(X, Y, Rings()), lambda p: p[0])
sage: hash(phi)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/burcin/sage/sage-4.4.1.alpha2-patched/<ipython console> in <module>()

TypeError: unhashable type: 'sage.categories.morphism.SetMorphism'
```

Note also that `sage.categories.map.Map` derives from `sage.structure.element.Element` which also has a `__hash__()` method.

Any hints?



---

archive/issue_comments_074276.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\n`__hash__` must be redefined if `__cmp__` or `__richcmp__` is, as it is an all or none thing with their inheritance. Not my design decision, but that's the way it is. \n\nSee http://docs.python.org/c-api/typeobj.html",
    "created_at": "2010-05-22T15:51:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74276",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:2" align="right">comment:2</div>

`__hash__` must be redefined if `__cmp__` or `__richcmp__` is, as it is an all or none thing with their inheritance. Not my design decision, but that's the way it is. 

See http://docs.python.org/c-api/typeobj.html



---

archive/issue_events_113554.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-06-05T09:16:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113554"
}
```



---

archive/issue_events_113555.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-06-05T09:16:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113555"
}
```



---

archive/issue_events_113556.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-06-22T20:49:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113556"
}
```



---

archive/issue_events_113557.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-06-22T20:49:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113557"
}
```



---

archive/issue_comments_074277.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis patch causes a doctest failure on vanilla Sage 4.5.alpha1: \n\n```\nsage -t  \"devel/sage-reviewing/sage/modules/fg_pid/fgp_module.py\"\n**********************************************************************\nFile \"/storage/masiao/sage-4.5.alpha1/devel/sage-reviewing/sage/modules/fg_pid/fgp_module.py\", line 383:\n    sage: Q._coerce_map_from_(V.scale(2))\nException raised:\n    Traceback (most recent call last):\n      File \"/storage/masiao/sage-4.5.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/storage/masiao/sage-4.5.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/storage/masiao/sage-4.5.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_7[11]>\", line 1, in <module>\n        Q._coerce_map_from_(V.scale(Integer(2)))###line 383:\n    sage: Q._coerce_map_from_(V.scale(2))\n      File \"/storage/masiao/sage-4.5.alpha1/local/lib/python/site-packages/sage/modules/fg_pid/fgp_module.py\", line 388, in _coerce_map_from_\n        return bool(self._V._coerce_map_from_(S))\n      File \"element.pyx\", line 741, in sage.structure.element.Element.__nonzero__ (sage/structure/element.c:5731)\n      File \"element.pyx\", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)\n      File \"element.pyx\", line 835, in sage.structure.element.Element._richcmp (sage/structure/element.c:6989)\n      File \"/storage/masiao/sage-4.5.alpha1/local/lib/python/site-packages/sage/modules/matrix_morphism.py\", line 111, in __cmp__\n        return cmp(self.matrix(), other.matrix())\n      File \"element.pyx\", line 306, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:2632)\n      File \"parent.pyx\", line 268, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2835)\n      File \"parent.pyx\", line 170, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2602)\n    AttributeError: 'sage.categories.morphism.CallMorphism' object has no attribute 'matrix'\n**********************************************************************\n1 items had failures:\n   1 of  12 in __main__.example_7\n***Test Failed*** 1 failures.\n```",
    "created_at": "2010-07-01T08:12:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74277",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:5" align="right">comment:5</div>

This patch causes a doctest failure on vanilla Sage 4.5.alpha1: 

```
sage -t  "devel/sage-reviewing/sage/modules/fg_pid/fgp_module.py"
**********************************************************************
File "/storage/masiao/sage-4.5.alpha1/devel/sage-reviewing/sage/modules/fg_pid/fgp_module.py", line 383:
    sage: Q._coerce_map_from_(V.scale(2))
Exception raised:
    Traceback (most recent call last):
      File "/storage/masiao/sage-4.5.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/storage/masiao/sage-4.5.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/storage/masiao/sage-4.5.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_7[11]>", line 1, in <module>
        Q._coerce_map_from_(V.scale(Integer(2)))###line 383:
    sage: Q._coerce_map_from_(V.scale(2))
      File "/storage/masiao/sage-4.5.alpha1/local/lib/python/site-packages/sage/modules/fg_pid/fgp_module.py", line 388, in _coerce_map_from_
        return bool(self._V._coerce_map_from_(S))
      File "element.pyx", line 741, in sage.structure.element.Element.__nonzero__ (sage/structure/element.c:5731)
      File "element.pyx", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)
      File "element.pyx", line 835, in sage.structure.element.Element._richcmp (sage/structure/element.c:6989)
      File "/storage/masiao/sage-4.5.alpha1/local/lib/python/site-packages/sage/modules/matrix_morphism.py", line 111, in __cmp__
        return cmp(self.matrix(), other.matrix())
      File "element.pyx", line 306, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:2632)
      File "parent.pyx", line 268, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2835)
      File "parent.pyx", line 170, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2602)
    AttributeError: 'sage.categories.morphism.CallMorphism' object has no attribute 'matrix'
**********************************************************************
1 items had failures:
   1 of  12 in __main__.example_7
***Test Failed*** 1 failures.
```



---

archive/issue_events_113558.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2010-07-01T08:12:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113558"
}
```



---

archive/issue_events_113559.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2010-07-01T08:12:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113559"
}
```



---

archive/issue_events_113560.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-09-02T10:58:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113560"
}
```



---

archive/issue_events_113561.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-09-02T10:58:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20categories",
    "label_color": "0000ff",
    "label_name": "c: categories",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113561"
}
```



---

archive/issue_comments_074278.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2010-09-13T10:18:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74278",
    "user": "https://github.com/burcin"
}
```

apply only this patch



---

archive/issue_comments_074279.json:
```json
{
    "body": "Reviewer: **Robert Bradshaw**",
    "created_at": "2010-09-13T10:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74279",
    "user": "https://github.com/burcin"
}
```

Reviewer: **Robert Bradshaw**



---

archive/issue_comments_074280.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAttachment: **[trac_9016-morphishm_hash.take2.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take2.patch.gz)**\n\nReplying to [@loefflerd](#comment%3A5):\n> This patch causes a doctest failure on vanilla Sage 4.5.alpha1: \n\nI uploaded a new patch which fixes this.\n\n[attachment: trac_9016-morphishm_hash.take2.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take2.patch.gz) also adds `__hash__()` methods to all the classes defined in `sage/{categories/map.pyx,rings/morphism.pyx}` which also define `__cmp__()` or `__richcmp__()` methods, in line with Robert's remarks in [comment:2](#comment%3A2).\n\nRobert, can you take a look at this again?",
    "created_at": "2010-09-13T10:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74280",
    "user": "https://github.com/burcin"
}
```

<div id="comment:7" align="right">comment:7</div>

Attachment: **[trac_9016-morphishm_hash.take2.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take2.patch.gz)**

Replying to [@loefflerd](#comment%3A5):
> This patch causes a doctest failure on vanilla Sage 4.5.alpha1: 

I uploaded a new patch which fixes this.

[attachment: trac_9016-morphishm_hash.take2.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take2.patch.gz) also adds `__hash__()` methods to all the classes defined in `sage/{categories/map.pyx,rings/morphism.pyx}` which also define `__cmp__()` or `__richcmp__()` methods, in line with Robert's remarks in [comment:2](#comment%3A2).

Robert, can you take a look at this again?



---

archive/issue_events_113562.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-09-13T10:22:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113562"
}
```



---

archive/issue_events_113563.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-09-13T10:22:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113563"
}
```



---

archive/issue_comments_074281.json:
```json
{
    "body": "rebased to 4.7.alpha1",
    "created_at": "2011-03-22T19:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74281",
    "user": "https://github.com/burcin"
}
```

rebased to 4.7.alpha1



---

archive/issue_comments_074282.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAttachment: **[trac_9016-morphishm_hash.take3.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take3.patch.gz)**\n\nApparently someone else fixed the problem in `sage/structure/sequence.py`. I rebased the patch to 4.7.alpha1.\n\nApply trac_9016-morphishm_hash.take3.patch",
    "created_at": "2011-03-22T19:38:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74282",
    "user": "https://github.com/burcin"
}
```

<div id="comment:8" align="right">comment:8</div>

Attachment: **[trac_9016-morphishm_hash.take3.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take3.patch.gz)**

Apparently someone else fixed the problem in `sage/structure/sequence.py`. I rebased the patch to 4.7.alpha1.

Apply trac_9016-morphishm_hash.take3.patch



---

archive/issue_comments_074283.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'm not so sure this is a good generic hash function--it means that all morphism has to the same thing.",
    "created_at": "2011-05-12T19:17:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74283",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:9" align="right">comment:9</div>

I'm not so sure this is a good generic hash function--it means that all morphism has to the same thing.



---

archive/issue_comments_074284.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@robertwb](#comment%3A9):\n> I'm not so sure this is a good generic hash function--it means that all morphism has to the same thing. \n\nI looked over the patch once more. The hash functions defined here use all the information I see in the class. Do you have any specific suggestions for improvement?",
    "created_at": "2011-05-30T20:45:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74284",
    "user": "https://github.com/burcin"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@robertwb](#comment%3A9):
> I'm not so sure this is a good generic hash function--it means that all morphism has to the same thing. 

I looked over the patch once more. The hash functions defined here use all the information I see in the class. Do you have any specific suggestions for improvement?



---

archive/issue_comments_074285.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHashing the string representation is preferable, or the image of the generators of the codomain (caching the result if the performance isn't sufficient). Either that or raising an error and requiring all specific subclasses (that have the information to distinguish between distinct elements) implement this.",
    "created_at": "2011-05-31T04:00:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74285",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:11" align="right">comment:11</div>

Hashing the string representation is preferable, or the image of the generators of the codomain (caching the result if the performance isn't sufficient). Either that or raising an error and requiring all specific subclasses (that have the information to distinguish between distinct elements) implement this.



---

archive/issue_events_113564.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-05-31T04:00:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113564"
}
```



---

archive/issue_events_113565.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-05-31T04:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113565"
}
```



---

archive/issue_comments_074286.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI don't see how the string representation could provide more information than the data stored in the class. I would be happy to add such data to the tuple that is hashed if you point it out.\n\nThe current patch uses the hash of the images of the generators when the morphism class contains this information. See line 1103 of `sage/rings/morphism.pyx` for example. In order to implement your suggestion we would also have to change the comparison functions, which compare the same data this patch hashes.\n\n<rant>\nRobert, even though you chose to mark this as an enhancement in [comment:3](#comment%3A3), it is actually a bug that effects my work. The category framework relies heavily on cached functions, which in turn need the arguments of these to be hashable. For example, I need unique parents that also depend on a morphism/map (difference/differential rings). I opened this ticket when I ran into this problem a year ago. I know I haven't really pushed it through, but it still is a shame that it takes so long for such a small change to get into a release.\n</rant>",
    "created_at": "2011-05-31T09:03:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74286",
    "user": "https://github.com/burcin"
}
```

<div id="comment:12" align="right">comment:12</div>

I don't see how the string representation could provide more information than the data stored in the class. I would be happy to add such data to the tuple that is hashed if you point it out.

The current patch uses the hash of the images of the generators when the morphism class contains this information. See line 1103 of `sage/rings/morphism.pyx` for example. In order to implement your suggestion we would also have to change the comparison functions, which compare the same data this patch hashes.

<rant>
Robert, even though you chose to mark this as an enhancement in [comment:3](#comment%3A3), it is actually a bug that effects my work. The category framework relies heavily on cached functions, which in turn need the arguments of these to be hashable. For example, I need unique parents that also depend on a morphism/map (difference/differential rings). I opened this ticket when I ran into this problem a year ago. I know I haven't really pushed it through, but it still is a shame that it takes so long for such a small change to get into a release.
</rant>



---

archive/issue_comments_074287.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@burcin](#comment%3A12):\n> I don't see how the string representation could provide more information than the data stored in the class. I would be happy to add such data to the tuple that is hashed if you point it out.\n\nThe string representation is more often overridden to be distinct for distinct morphisms \n\n> The current patch uses the hash of the images of the generators when the morphism class contains this information. See line 1103 of `sage/rings/morphism.pyx` for example. In order to implement your suggestion we would also have to change the comparison functions, which compare the same data this patch hashes.\n\nAre you saying that any two morphisms in the same homset compare equal? That is a bug for sure. I'd rather not be able to compare such morphisms. \n\n> <rant>\n> Robert, even though you chose to mark this as an enhancement in [comment:3](#comment%3A3), it is actually a bug that effects my work. The category framework relies heavily on cached functions, which in turn need the arguments of these to be hashable. For example, I need unique parents that also depend on a morphism/map (difference/differential rings). I opened this ticket when I ran into this problem a year ago. \n\nHappy to change it back given the context. \n\n> I know I haven't really pushed it through, but it still is a shame that it takes so long for such a small change to get into a release.\n> </rant>\n\nI know this all to well--too much bureaucracy and churn in the code among other things. That was one of my primary motivations for the patchbot, so hopefully simple changes could get approved quickly.",
    "created_at": "2011-05-31T16:33:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74287",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@burcin](#comment%3A12):
> I don't see how the string representation could provide more information than the data stored in the class. I would be happy to add such data to the tuple that is hashed if you point it out.

The string representation is more often overridden to be distinct for distinct morphisms 

> The current patch uses the hash of the images of the generators when the morphism class contains this information. See line 1103 of `sage/rings/morphism.pyx` for example. In order to implement your suggestion we would also have to change the comparison functions, which compare the same data this patch hashes.

Are you saying that any two morphisms in the same homset compare equal? That is a bug for sure. I'd rather not be able to compare such morphisms. 

> <rant>
> Robert, even though you chose to mark this as an enhancement in [comment:3](#comment%3A3), it is actually a bug that effects my work. The category framework relies heavily on cached functions, which in turn need the arguments of these to be hashable. For example, I need unique parents that also depend on a morphism/map (difference/differential rings). I opened this ticket when I ran into this problem a year ago. 

Happy to change it back given the context. 

> I know I haven't really pushed it through, but it still is a shame that it takes so long for such a small change to get into a release.
> </rant>

I know this all to well--too much bureaucracy and churn in the code among other things. That was one of my primary motivations for the patchbot, so hopefully simple changes could get approved quickly.



---

archive/issue_events_113566.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-05-31T16:33:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113566"
}
```



---

archive/issue_events_113567.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-05-31T16:33:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113567"
}
```



---

archive/issue_comments_074288.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThis looks good for the most part. I think Robert was thinking the `hash((domain, codomaim))` was the hash for the individual morphism, as opposed to that being the hash for the homset (as it currently is). The morphism's hash is from the image of the generators which I believe is sufficient. (This breaks down if you look at a large amount of maps from different domains to the same image in the same codomain and same number of generators, but this seems like something extremely unlikely to occur in practice. We could also hash in the parent to take care of this...)\n\nHowever this does not pass the doctests on my (virtual) machine which runs with 32-bit instead of 64-bit (which the patchbot runs on). Here are my hash values:\n\n```\nrings/morphism.pyx\n line 542: 1975065480\n line 959: 467020541\n line 1147: -664373037\n line 1554: -644670332\n line 1699: 1917770400\n\ncategories/map.pyx\n line 1047: 433071207\n line 1290: -1460497211\n```\nAlso, I don't believe you need `# indirect doctest` for the `hash()`, but this isn't that important.",
    "created_at": "2012-11-18T08:20:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74288",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

This looks good for the most part. I think Robert was thinking the `hash((domain, codomaim))` was the hash for the individual morphism, as opposed to that being the hash for the homset (as it currently is). The morphism's hash is from the image of the generators which I believe is sufficient. (This breaks down if you look at a large amount of maps from different domains to the same image in the same codomain and same number of generators, but this seems like something extremely unlikely to occur in practice. We could also hash in the parent to take care of this...)

However this does not pass the doctests on my (virtual) machine which runs with 32-bit instead of 64-bit (which the patchbot runs on). Here are my hash values:

```
rings/morphism.pyx
 line 542: 1975065480
 line 959: 467020541
 line 1147: -664373037
 line 1554: -644670332
 line 1699: 1917770400

categories/map.pyx
 line 1047: 433071207
 line 1290: -1460497211
```
Also, I don't believe you need `# indirect doctest` for the `hash()`, but this isn't that important.



---

archive/issue_comments_074289.json:
```json
{
    "body": "Attachment: **[trac_9016-morphishm_hash.take4.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)**",
    "created_at": "2012-11-19T03:34:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74289",
    "user": "https://github.com/burcin"
}
```

Attachment: **[trac_9016-morphishm_hash.take4.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)**



---

archive/issue_comments_074290.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThanks for reviewing this ticket!\n\nNew patch up at [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz) with 32-bit hash values. I removed the `# indirect doctest` messages as well. Perhaps the coverage script improved in the mean time to avoid complaints about not using the name of the function in the tests.",
    "created_at": "2012-11-19T03:39:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74290",
    "user": "https://github.com/burcin"
}
```

<div id="comment:15" align="right">comment:15</div>

Thanks for reviewing this ticket!

New patch up at [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz) with 32-bit hash values. I removed the `# indirect doctest` messages as well. Perhaps the coverage script improved in the mean time to avoid complaints about not using the name of the function in the tests.



---

archive/issue_events_113568.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2012-11-19T03:39:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113568"
}
```



---

archive/issue_events_113569.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2012-11-19T03:39:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113569"
}
```



---

archive/issue_comments_074291.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,3 +9,4 @@\n \n While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.\n \n+Apply: [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)\n``````\n",
    "created_at": "2012-11-19T03:39:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74291",
    "user": "https://github.com/burcin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,3 +9,4 @@
 
 While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.
 
+Apply: [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)
``````




---

archive/issue_comments_074292.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nLooks much better now. Two more minor things (sorry for not noticing this earlier):\n\n- Move the `from copy import copy` from the header of `morphism.pyx` to\n\n  ```\n  if not im_gens.is_immutable(): \n      from copy import copy\n      im_gens = copy(im_gens)\n      im_gens.set_immutable() \n  ```\n  (or perhaps a `lazy_import`)\n  This should make the startup plugin happy.\n\n- Could you add a (short) description such as <code>Return the hash of \\`\\`self\\`\\`</code> to each `__hash__()` function.\n\nAfter this, that should be it. Thank you.",
    "created_at": "2012-11-19T04:29:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74292",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:16" align="right">comment:16</div>

Looks much better now. Two more minor things (sorry for not noticing this earlier):

- Move the `from copy import copy` from the header of `morphism.pyx` to

  ```
  if not im_gens.is_immutable(): 
      from copy import copy
      im_gens = copy(im_gens)
      im_gens.set_immutable() 
  ```
  (or perhaps a `lazy_import`)
  This should make the startup plugin happy.

- Could you add a (short) description such as <code>Return the hash of \`\`self\`\`</code> to each `__hash__()` function.

After this, that should be it. Thank you.



---

archive/issue_comments_074293.json:
```json
{
    "body": "Attachment: **[trac_9016-morphishm_hash.take5.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)**\n\napply only this patch",
    "created_at": "2012-11-19T11:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74293",
    "user": "https://github.com/burcin"
}
```

Attachment: **[trac_9016-morphishm_hash.take5.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)**

apply only this patch



---

archive/issue_comments_074294.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tscrim](#comment%3A16):\n> Looks much better now. Two more minor things (sorry for not noticing this earlier):\n\nThanks for the quick feedback. I attached [a new patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz) fixing the two issues mentioned above.\n\nPatchbot, apply trac_9016-morphishm_hash.take5.patch\n\nI guess it's too late to fix the horrific typo in the file name. :)",
    "created_at": "2012-11-19T11:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74294",
    "user": "https://github.com/burcin"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tscrim](#comment%3A16):
> Looks much better now. Two more minor things (sorry for not noticing this earlier):

Thanks for the quick feedback. I attached [a new patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz) fixing the two issues mentioned above.

Patchbot, apply trac_9016-morphishm_hash.take5.patch

I guess it's too late to fix the horrific typo in the file name. :)



---

archive/issue_comments_074295.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,4 +9,4 @@\n \n While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.\n \n-Apply: [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)\n+Apply: [attachment: trac_9016-morphishm_hash.take5.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)\n``````\n",
    "created_at": "2012-11-19T11:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74295",
    "user": "https://github.com/burcin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,4 +9,4 @@
 
 While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.
 
-Apply: [attachment: trac_9016-morphishm_hash.take4.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take4.patch.gz)
+Apply: [attachment: trac_9016-morphishm_hash.take5.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)
``````




---

archive/issue_comments_074296.json:
```json
{
    "body": "Changed reviewer from **Robert Bradshaw** to **Robert Bradshaw, Travis Scrimshaw**",
    "created_at": "2012-11-19T11:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74296",
    "user": "https://github.com/burcin"
}
```

Changed reviewer from **Robert Bradshaw** to **Robert Bradshaw, Travis Scrimshaw**



---

archive/issue_comments_074297.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nNo, its not too late to change the name. However there is a change since the last patch in one of the hash values (line 1050 in `categories/map.pyx`) and it's different than what the patchbot returns (I can't reproduce it since I'm using a 32-bit system). Is that the hash value that you get?",
    "created_at": "2012-11-19T16:09:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74297",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">comment:18</div>

No, its not too late to change the name. However there is a change since the last patch in one of the hash values (line 1050 in `categories/map.pyx`) and it's different than what the patchbot returns (I can't reproduce it since I'm using a 32-bit system). Is that the hash value that you get?



---

archive/issue_comments_074298.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2012-11-19T19:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74298",
    "user": "https://github.com/burcin"
}
```

apply only this patch



---

archive/issue_comments_074299.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nAttachment: **[trac_9016-morphism_hash.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)**\n\nI had some other patches applied. One of them might have changed the hash value. Corrected patch attached. Just to make sure there is no random error, I ran the tests in these two files 100 times. :)\n\nApply trac_9016-morphism_hash.patch",
    "created_at": "2012-11-19T19:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74299",
    "user": "https://github.com/burcin"
}
```

<div id="comment:19" align="right">comment:19</div>

Attachment: **[trac_9016-morphism_hash.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)**

I had some other patches applied. One of them might have changed the hash value. Corrected patch attached. Just to make sure there is no random error, I ran the tests in these two files 100 times. :)

Apply trac_9016-morphism_hash.patch



---

archive/issue_comments_074300.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,4 +9,4 @@\n \n While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.\n \n-Apply: [attachment: trac_9016-morphishm_hash.take5.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)\n+Apply: [attachment: trac_9016-morphism_hash.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)\n``````\n",
    "created_at": "2012-11-19T19:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74300",
    "user": "https://github.com/burcin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,4 +9,4 @@
 
 While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.
 
-Apply: [attachment: trac_9016-morphishm_hash.take5.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphishm_hash.take5.patch.gz)
+Apply: [attachment: trac_9016-morphism_hash.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)
``````




---

archive/issue_comments_074301.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI would argue that in general it's better to avoid having these arbitrary values for hash tested exactly at all (unless they're meaningful, like hash(ZZ(2)) == 2), especially when they vary for 64 and 32-bit values.  Better to test it functionally, like\n\n```\nsage: { phi: 'yes' }[phi]\n'yes'\n```\n\nor even\n\n```\nhash(phi) == hash(phi)\nTrue\nhash(phi) == hash(rho)\nFalse\n```",
    "created_at": "2012-11-19T19:40:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74301",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:20" align="right">comment:20</div>

I would argue that in general it's better to avoid having these arbitrary values for hash tested exactly at all (unless they're meaningful, like hash(ZZ(2)) == 2), especially when they vary for 64 and 32-bit values.  Better to test it functionally, like

```
sage: { phi: 'yes' }[phi]
'yes'
```

or even

```
hash(phi) == hash(phi)
True
hash(phi) == hash(rho)
False
```



---

archive/issue_comments_074302.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nFor the most part, I would almost argue against doing that, in particular, it does not make sure that hash values do not change in different sage sessions and machines (since the tests are run multiple times generally). For example, say we create an object `O` and use it as a key it in a dictionary `D` (e.g. `D[O] = 5`) and then pickle `D`. Then on another session/machine (with the same bit architecture) we unpickle `D` and to do `D[O]` safely; we want to make sure via doctests that the hashes match.\n\nActually on that note, I wonder if we need to (much less how) send a warning to the users when hash values change from one version to another. In that context, I would argue that these tests are how we should do everything and never update a hash value unless the structure of a class changes. Granted, I am making an assumption about python pickles dictionaries: that python does not recreate the object then reinsert it into the hash table but instead creates the object in the desired location. I have a test in mind that I will run tonight. I hope all of the above makes sense.\n\nHowever I do see your point since the underlying hash values can change and makes the doctests of certain classes harder to maintain. Also I do somewhat like the `hash(phi) == hash(phi)` test since the hash is run multiple times and it checks to make sure the object is hashable.",
    "created_at": "2012-11-20T03:32:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74302",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:21" align="right">comment:21</div>

For the most part, I would almost argue against doing that, in particular, it does not make sure that hash values do not change in different sage sessions and machines (since the tests are run multiple times generally). For example, say we create an object `O` and use it as a key it in a dictionary `D` (e.g. `D[O] = 5`) and then pickle `D`. Then on another session/machine (with the same bit architecture) we unpickle `D` and to do `D[O]` safely; we want to make sure via doctests that the hashes match.

Actually on that note, I wonder if we need to (much less how) send a warning to the users when hash values change from one version to another. In that context, I would argue that these tests are how we should do everything and never update a hash value unless the structure of a class changes. Granted, I am making an assumption about python pickles dictionaries: that python does not recreate the object then reinsert it into the hash table but instead creates the object in the desired location. I have a test in mind that I will run tonight. I hope all of the above makes sense.

However I do see your point since the underlying hash values can change and makes the doctests of certain classes harder to maintain. Also I do somewhat like the `hash(phi) == hash(phi)` test since the hash is run multiple times and it checks to make sure the object is hashable.



---

archive/issue_comments_074303.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThis is getting a bit off topic, but if you have pickling that depends on hash values then it's already broken (e.g. 32-bit vs 64-bit). And, no, hashes do not need to be consistent to pickle dictionaries. All that we need is that hashes are consistent within a given Python session. (On that note, the fix of http://bugs.python.org/issue13703 is to make hashes completely unpredictable between sessions, which will break any hard-coded hash we have that (transitively) depends on something that hashes a string.)\n\n<rant>\nAside from this, I've also been bitten several times from changing a hash (to making it faster, e.g. not simply doing `hash(str(self))`) hand having to change random values all over the library, as well as the nuisance of having to find a 32-bit computer to test on to get the new 32-bit value (because the tests pass just fine for me), both of which provide near zero actual value. \n</rant>",
    "created_at": "2012-11-20T04:35:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74303",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:22" align="right">comment:22</div>

This is getting a bit off topic, but if you have pickling that depends on hash values then it's already broken (e.g. 32-bit vs 64-bit). And, no, hashes do not need to be consistent to pickle dictionaries. All that we need is that hashes are consistent within a given Python session. (On that note, the fix of http://bugs.python.org/issue13703 is to make hashes completely unpredictable between sessions, which will break any hard-coded hash we have that (transitively) depends on something that hashes a string.)

<rant>
Aside from this, I've also been bitten several times from changing a hash (to making it faster, e.g. not simply doing `hash(str(self))`) hand having to change random values all over the library, as well as the nuisance of having to find a 32-bit computer to test on to get the new 32-bit value (because the tests pass just fine for me), both of which provide near zero actual value. 
</rant>



---

archive/issue_comments_074304.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nHmm..interesting. Also good to know about the dictionary pickling. I cannot disagree at all with your rant; I use the patchbot to get my 64-bit hash values >_<. So would you agree to hash tests of the form:\n\n```\nsage: hash(phi) == hash(phi)\nTrue\n```\n?\n\nThanks,\n\nTravis",
    "created_at": "2012-11-20T16:13:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74304",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:23" align="right">comment:23</div>

Hmm..interesting. Also good to know about the dictionary pickling. I cannot disagree at all with your rant; I use the patchbot to get my 64-bit hash values >_<. So would you agree to hash tests of the form:

```
sage: hash(phi) == hash(phi)
True
```
?

Thanks,

Travis



---

archive/issue_comments_074305.json:
```json
{
    "body": "Attachment: **[trac_9016-morphism_hash.take7.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)**\n\napply only this patch",
    "created_at": "2012-11-20T16:37:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74305",
    "user": "https://github.com/burcin"
}
```

Attachment: **[trac_9016-morphism_hash.take7.patch.gz](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)**

apply only this patch



---

archive/issue_comments_074306.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI attached a new patch replacing the doctests with `hash(f) == hash(f)` and `{f: 1}[f]` as Robert suggests.\n\nApply [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz).",
    "created_at": "2012-11-20T16:39:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74306",
    "user": "https://github.com/burcin"
}
```

<div id="comment:24" align="right">comment:24</div>

I attached a new patch replacing the doctests with `hash(f) == hash(f)` and `{f: 1}[f]` as Robert suggests.

Apply [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz).



---

archive/issue_comments_074307.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,4 +9,4 @@\n \n While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.\n \n-Apply: [attachment: trac_9016-morphism_hash.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)\n+Apply: [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)\n``````\n",
    "created_at": "2012-11-20T16:39:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74307",
    "user": "https://github.com/burcin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,4 +9,4 @@
 
 While testing the code for `im_gens`, I fixed a confusing error message in `sage.structure.sequence.Sequence.__hash__()` as well.
 
-Apply: [attachment: trac_9016-morphism_hash.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.patch.gz)
+Apply: [attachment: trac_9016-morphism_hash.take7.patch](https://github.com/sagemath/sage/files/ticket9016/trac_9016-morphism_hash.take7.patch.gz)
``````




---

archive/issue_comments_074308.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nLooks good to me. Robert?",
    "created_at": "2012-11-20T20:04:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74308",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:25" align="right">comment:25</div>

Looks good to me. Robert?



---

archive/issue_events_113570.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2012-11-21T05:07:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113570"
}
```



---

archive/issue_events_113571.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2012-11-21T05:07:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113571"
}
```



---

archive/issue_comments_074309.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nLooks good to me too. My only comment would be that perhaps `hash((self._domain, self._codomain))` could be pulled to a higher superclass, but I've got no problems with the way it is now.",
    "created_at": "2012-11-21T05:07:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74309",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:26" align="right">comment:26</div>

Looks good to me too. My only comment would be that perhaps `hash((self._domain, self._codomain))` could be pulled to a higher superclass, but I've got no problems with the way it is now.



---

archive/issue_events_113572.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T09:32:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113572"
}
```



---

archive/issue_events_113573.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T09:32:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9016#event-113573"
}
```



---

archive/issue_comments_074310.json:
```json
{
    "body": "Merged: **sage-5.6.beta1**",
    "created_at": "2012-12-21T09:32:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9016#issuecomment-74310",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.6.beta1**
