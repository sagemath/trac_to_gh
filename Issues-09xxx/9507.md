# Issue 9507: if spkg-install is a Python script, first check that SAGE_LOCAL/bin/python exists.

archive/issues_009507.json:
```json
{
    "body": "See trac #9368. \n\nAssignee: GeorgSWeber\n\nResolution: fixed\n\nAuthor: William Stein\n\nReviewer: Robert Miller\n\nMerged: sage-4.5.1\n\nIssue created by migration from https://trac.sagemath.org/ticket/9507\n\n",
    "closed_at": "2010-07-19T11:20:34Z",
    "created_at": "2010-07-15T13:14:03Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.5.1",
    "title": "if spkg-install is a Python script, first check that SAGE_LOCAL/bin/python exists.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9507",
    "user": "https://github.com/williamstein"
}
```
See trac #9368. 

Assignee: GeorgSWeber

Resolution: fixed

Author: William Stein

Reviewer: Robert Miller

Merged: sage-4.5.1

Issue created by migration from https://trac.sagemath.org/ticket/9507





---

archive/issue_comments_109084.json:
```json
{
    "body": "<a id='comment:1'></a>\nHow do you check if Python exists in a Python script? I would have thought the code to check Python exists would have relied on Python existing - a catch 22. Of course, if you happen to have a system wide Python, then you could use that to check for $SAGE_LOCAL/bin/python. But that's going to be far from reliable, since: \n* A system may have no Python\n* A system Python may be too old. \n* A system Python may not work properly, which is what appears to have happened in your sage_fortran setup. \n\nBut I guess it is more reliable than no test at all, but I can't think of a 100% sure-fire way of doing this. One could make all spkg-install's /bin/sh scripts, and use that to check for Python before calling a Python script. But that's a lot of messing around, and one probably more likely to introduce a bug than detect one. \n\nDave",
    "created_at": "2010-07-15T22:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109084",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:1'></a>
How do you check if Python exists in a Python script? I would have thought the code to check Python exists would have relied on Python existing - a catch 22. Of course, if you happen to have a system wide Python, then you could use that to check for $SAGE_LOCAL/bin/python. But that's going to be far from reliable, since: 
* A system may have no Python
* A system Python may be too old. 
* A system Python may not work properly, which is what appears to have happened in your sage_fortran setup. 

But I guess it is more reliable than no test at all, but I can't think of a 100% sure-fire way of doing this. One could make all spkg-install's /bin/sh scripts, and use that to check for Python before calling a Python script. But that's a lot of messing around, and one probably more likely to introduce a bug than detect one. 

Dave



---

archive/issue_comments_109085.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-07-15T23:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109085",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_109086.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt was easier to just post the solution than...",
    "created_at": "2010-07-15T23:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109086",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
It was easier to just post the solution than...



---

archive/issue_comments_109087.json:
```json
{
    "body": "<a id='comment:3'></a>\nNeat, I like it. \n\nWould it not be worth checking **all** files in the top-level directory, rather than just spkg-install? Several packages have both bash scripts and python scripts in them. I don't know of any packages that have spkg-install which is a bash script, and also a python script, but it would not surprise me if one or two existed.\n\nspkg-install in ATLAS is a small python script, which then calls a large bash script. What's to stop there being any packages with it the other way around, where a bash script calls a python script? \n\nDave",
    "created_at": "2010-07-16T00:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109087",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:3'></a>
Neat, I like it. 

Would it not be worth checking **all** files in the top-level directory, rather than just spkg-install? Several packages have both bash scripts and python scripts in them. I don't know of any packages that have spkg-install which is a bash script, and also a python script, but it would not surprise me if one or two existed.

spkg-install in ATLAS is a small python script, which then calls a large bash script. What's to stop there being any packages with it the other way around, where a bash script calls a python script? 

Dave



---

archive/issue_comments_109088.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-07-16T08:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109088",
    "user": "https://github.com/rlmill"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_109089.json:
```json
{
    "body": "<a id='comment:4'></a>\nLooks good! I tried forcing Fortran to build before Python in 4.5.rc1, and got the following with this patch applied:\n\n```\nfortran-20100629/src/g95/g95_x86_osx.tar.bz2\nFinished extraction\n****************************************************\nHost system\nuname -a:\nLinux geom 2.6.24-24-server #1 SMP Tue Aug 18 16:51:43 UTC 2009 x86_64 GNU/Linux\n****************************************************\n****************************************************\nCC Version\ngcc -v\nUsing built-in specs.\nTarget: x86_64-linux-gnu\nConfigured with: ../src/configure -v --enable-languages=c,c++,fortran,objc,obj-c++,treelang --prefix=/usr --enable-shared --with-system-zlib --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --enable-nls --with-gxx-include-dir=/usr/include/c++/4.2 --program-suffix=-4.2 --enable-clocale=gnu --enable-libstdcxx-debug --enable-objc-gc --enable-mpfr --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu\nThread model: posix\ngcc version 4.2.4 (Ubuntu 4.2.4-1ubuntu4)\n****************************************************\nThe spkg-install script depends on Python, but Python is not\nyet installed.  If this is a standard package, you should\nproperly update the /scratch/rlmill/test/sage-4.5.rc1/spkg/standard/deps script.\n```",
    "created_at": "2010-07-16T08:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109089",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:4'></a>
Looks good! I tried forcing Fortran to build before Python in 4.5.rc1, and got the following with this patch applied:

```
fortran-20100629/src/g95/g95_x86_osx.tar.bz2
Finished extraction
****************************************************
Host system
uname -a:
Linux geom 2.6.24-24-server #1 SMP Tue Aug 18 16:51:43 UTC 2009 x86_64 GNU/Linux
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --enable-languages=c,c++,fortran,objc,obj-c++,treelang --prefix=/usr --enable-shared --with-system-zlib --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --enable-nls --with-gxx-include-dir=/usr/include/c++/4.2 --program-suffix=-4.2 --enable-clocale=gnu --enable-libstdcxx-debug --enable-objc-gc --enable-mpfr --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 4.2.4 (Ubuntu 4.2.4-1ubuntu4)
****************************************************
The spkg-install script depends on Python, but Python is not
yet installed.  If this is a standard package, you should
properly update the /scratch/rlmill/test/sage-4.5.rc1/spkg/standard/deps script.
```



---

archive/issue_comments_109090.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Robert Miller\"",
    "created_at": "2010-07-16T08:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109090",
    "user": "https://github.com/rlmill"
}
```

Changing reviewer from "" to "Robert Miller"



---

archive/issue_comments_109091.json:
```json
{
    "body": "Changing author from \"\" to \"William Stein\"",
    "created_at": "2010-07-16T08:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109091",
    "user": "https://github.com/rlmill"
}
```

Changing author from "" to "William Stein"



---

archive/issue_comments_109092.json:
```json
{
    "body": "<a id='comment:5'></a>\nTo avoid confusion to users, we should perhaps clarify in the error message that ***Sage's** Python* is not yet installed. (Otherwise I expect reports like *\"I have a Python installed, but...\"*.)\n\nThe comment should read `# if not, ...` rather than `# if so, ...` (or `check if ...` should be negated).\n\nI'd prefer `[ -x $SAGE_LOCAL/bin/python]`. Hope this never gets a script (ending up in the scripts repo) that tries to call the binary located elsewhere. On the other hand, we could do just this (making it a bash script), and test for presence of the binary in that script. The advantage would be that `env python` would always find Sage's one (no matter if the binary is already installed), of course assuming `sage-env` has been sourced. But this would also introduce another stage of indirection...",
    "created_at": "2010-07-16T13:08:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109092",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
To avoid confusion to users, we should perhaps clarify in the error message that ***Sage's** Python* is not yet installed. (Otherwise I expect reports like *"I have a Python installed, but..."*.)

The comment should read `# if not, ...` rather than `# if so, ...` (or `check if ...` should be negated).

I'd prefer `[ -x $SAGE_LOCAL/bin/python]`. Hope this never gets a script (ending up in the scripts repo) that tries to call the binary located elsewhere. On the other hand, we could do just this (making it a bash script), and test for presence of the binary in that script. The advantage would be that `env python` would always find Sage's one (no matter if the binary is already installed), of course assuming `sage-env` has been sourced. But this would also introduce another stage of indirection...



---

archive/issue_comments_109093.json:
```json
{
    "body": "<a id='comment:6'></a>\nP.S.: In general, I think it's a bad idea to make Sage packages depend on Python despite the upstream package not depending on it. I.e., IMHO Python install scripts should only be used if the package depends on Python anyway.",
    "created_at": "2010-07-16T13:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109093",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
P.S.: In general, I think it's a bad idea to make Sage packages depend on Python despite the upstream package not depending on it. I.e., IMHO Python install scripts should only be used if the package depends on Python anyway.



---

archive/issue_comments_109094.json:
```json
{
    "body": "<a id='comment:7'></a>\nYet another one:\n\nPerhaps in addition to a slightly modified version of William's patch, put that as `$SAGE_LOCAL/bin/python` into the scripts repo:\n\n```sh\n#!/usr/bin/env bash\n\necho python $@ \":\"\n\necho \"Error: Sage's Python has not yet been installed!\"\necho \"       This is most probably due to incorrect dependencies in the Makefiles.\"\necho \"Please report this to ...\"\n\nexit 1\n```\nand let the Python spkg just overwrite it with the binary. (This avoids unnecessary indirection.)",
    "created_at": "2010-07-16T13:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109094",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>
Yet another one:

Perhaps in addition to a slightly modified version of William's patch, put that as `$SAGE_LOCAL/bin/python` into the scripts repo:

```sh
#!/usr/bin/env bash

echo python $@ ":"

echo "Error: Sage's Python has not yet been installed!"
echo "       This is most probably due to incorrect dependencies in the Makefiles."
echo "Please report this to ..."

exit 1
```
and let the Python spkg just overwrite it with the binary. (This avoids unnecessary indirection.)



---

archive/issue_comments_109095.json:
```json
{
    "body": "<a id='comment:8'></a>\nUnless this ticket gets immediately merged, please also consider [this bug](http://trac.sagemath.org/sage_trac/ticket/9281#comment:15) in `sage-spkg`, which is trivially fixed but not directly related to this ticket, so I'm not sure if I should upload a patch for that *here*.\n\n-Leif",
    "created_at": "2010-07-16T19:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109095",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>
Unless this ticket gets immediately merged, please also consider [this bug](http://trac.sagemath.org/sage_trac/ticket/9281#comment:15) in `sage-spkg`, which is trivially fixed but not directly related to this ticket, so I'm not sure if I should upload a patch for that *here*.

-Leif



---

archive/issue_comments_109096.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [leif](#comment%3A7):\n> Yet another one:\n> \n> Perhaps in addition to a slightly modified version of William's patch, put that \n> as `$SAGE_LOCAL/bin/python` into the scripts repo:\n\n\nI definitely do not like this idea.  Though it seems good at first, it's really bad. \n\n  (1) it's hackish\n\n  (2) It means that once python is installed, the scripts repository is always confused/corrupted/etc.   In particular, it would completely break \"sage -upgrade\", since the scripts repo is upgraded via `hg pull`.",
    "created_at": "2010-07-17T12:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109096",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:9'></a>
Replying to [leif](#comment%3A7):
> Yet another one:
> 
> Perhaps in addition to a slightly modified version of William's patch, put that 
> as `$SAGE_LOCAL/bin/python` into the scripts repo:


I definitely do not like this idea.  Though it seems good at first, it's really bad. 

  (1) it's hackish

  (2) It means that once python is installed, the scripts repository is always confused/corrupted/etc.   In particular, it would completely break "sage -upgrade", since the scripts repo is upgraded via `hg pull`.



---

archive/issue_comments_109097.json:
```json
{
    "body": "new version with better error message, as Lief suggested.",
    "created_at": "2010-07-17T13:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109097",
    "user": "https://github.com/williamstein"
}
```

new version with better error message, as Lief suggested.



---

archive/issue_comments_109098.json:
```json
{
    "body": "<a id='comment:10'></a>\nAttachment [trac_9507.patch](tarball://root/attachments/some-uuid/ticket9507/trac_9507.patch) by @rlmill created at 2010-07-19 11:20:34",
    "created_at": "2010-07-19T11:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109098",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:10'></a>
Attachment [trac_9507.patch](tarball://root/attachments/some-uuid/ticket9507/trac_9507.patch) by @rlmill created at 2010-07-19 11:20:34



---

archive/issue_comments_109099.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-07-19T11:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109099",
    "user": "https://github.com/rlmill"
}
```

Resolution: fixed



---

archive/issue_events_023599.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2010-07-19T11:20:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9507#event-23599"
}
```



---

archive/issue_comments_109100.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.5.1\"",
    "created_at": "2010-07-19T11:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9507#issuecomment-109100",
    "user": "https://github.com/rlmill"
}
```

Changing merged from "" to "sage-4.5.1"
