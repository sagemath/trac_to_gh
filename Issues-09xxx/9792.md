# Issue 9792: kernel and inverse_image of (polynomial) ring homomorphisms

archive/issues_009791.json:
```json
{
    "body": "For polynomial ring homomorphisms, this ticket implements the methods\n\n- `inverse_image` (of both ideals and individual elements)\n- `kernel`\n- `is_injective`\n- `_graph_ideal`\n\n(This also works for homomorphisms of polynomial quotient rings, number fields and Galois fields.)\n\n---\n\nThe implementation is based on the following:\n\nGiven a homomorphism `f: K[x] -> K[y]` of (multivariate) polynomial rings that respects the `K`-algebra structure, we can find preimages of `y` by computing normal forms modulo the graph ideal `(x-f(x))` in `K[y,x]` with respect to an elimination order. More generally, this works for morphisms of quotient rings `K[x]/I -> K[y]/J`, which allows to handle many types of ring homomorphisms in Sage.\n\nReferences: e.g. [BW1993] Propositions 6.44, 7.71; or [Decker-Schreyer](https://www.math.uni-sb.de/ag/schreyer/images/PDFs/teaching/ws1617ag/book.pdf), Proposition 2.5.12 and Exercise 2.5.13.\n\nSee also #29723 (inverses of ring homomorphisms) and related posts on the [mailing list](https://groups.google.com/forum/#!topic/sage-support/aJn0T0jIfwU) and at [Ask-Sagemath](https://ask.sagemath.org/question/51336/implicitization-by-symmetric-polynomials/).\n\n---\n\nExample:\n\n```\nsage: R.<s,t> = PolynomialRing(QQ)\nsage: S.<x,y,z,w> = PolynomialRing(QQ)\nsage: f = S.hom([s^4, s^3*t, s*t^3, t^4],R)\nsage: f.inverse_image(R.ideal(0))\nIdeal (y*z - x*w, z^3 - y*w^2, x*z^2 - y^2*w, y^3 - x^2*z) of Multivariate Polynomial Ring in x, y, z, w over Rational Field\nsage: f.inverse_image(s^3*t^4*(s+t))\nx*w + y*w\n```\n\n---\n\nNote that the inverse image of ideals (but not of elements) could also be computed using Singular as follows:\n\n```\nsage: singular.eval('''\n....:         ring R=0,(s,t),dp;\n....:         ring S=0,(x,y,z,w),dp;\n....:         setring R;\n....:         map f=S,ideal(s^4,s^3*t,s*t^3,t^4);\n....:         setring S;\n....:         ideal ker=kernel(R,f)\n....:       ''');\nsage: singular.get('ker')\n'yz-xw,\\nz3-yw2,\\nxz2-y2w,\\ny3-x2z'\nsage: print(_)\nyz-xw,\nz3-yw2,\nxz2-y2w,\ny3-x2z\n```\n\nCC:  @dimpase\n\nBranch/Commit: fd6dee61ca094c0b34961f41d6ef357def6ead5e\n\nReviewer: Travis Scrimshaw\n\nAuthor: Markus Wageringel\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/9792\n\n",
    "closed_at": "2020-06-22T22:34:42Z",
    "created_at": "2010-08-24T12:04:19Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "kernel and inverse_image of (polynomial) ring homomorphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9792",
    "user": "https://github.com/vbraun"
}
```
For polynomial ring homomorphisms, this ticket implements the methods

- `inverse_image` (of both ideals and individual elements)
- `kernel`
- `is_injective`
- `_graph_ideal`

(This also works for homomorphisms of polynomial quotient rings, number fields and Galois fields.)

---

The implementation is based on the following:

Given a homomorphism `f: K[x] -> K[y]` of (multivariate) polynomial rings that respects the `K`-algebra structure, we can find preimages of `y` by computing normal forms modulo the graph ideal `(x-f(x))` in `K[y,x]` with respect to an elimination order. More generally, this works for morphisms of quotient rings `K[x]/I -> K[y]/J`, which allows to handle many types of ring homomorphisms in Sage.

References: e.g. [BW1993] Propositions 6.44, 7.71; or [Decker-Schreyer](https://www.math.uni-sb.de/ag/schreyer/images/PDFs/teaching/ws1617ag/book.pdf), Proposition 2.5.12 and Exercise 2.5.13.

See also #29723 (inverses of ring homomorphisms) and related posts on the [mailing list](https://groups.google.com/forum/#!topic/sage-support/aJn0T0jIfwU) and at [Ask-Sagemath](https://ask.sagemath.org/question/51336/implicitization-by-symmetric-polynomials/).

---

Example:

```
sage: R.<s,t> = PolynomialRing(QQ)
sage: S.<x,y,z,w> = PolynomialRing(QQ)
sage: f = S.hom([s^4, s^3*t, s*t^3, t^4],R)
sage: f.inverse_image(R.ideal(0))
Ideal (y*z - x*w, z^3 - y*w^2, x*z^2 - y^2*w, y^3 - x^2*z) of Multivariate Polynomial Ring in x, y, z, w over Rational Field
sage: f.inverse_image(s^3*t^4*(s+t))
x*w + y*w
```

---

Note that the inverse image of ideals (but not of elements) could also be computed using Singular as follows:

```
sage: singular.eval('''
....:         ring R=0,(s,t),dp;
....:         ring S=0,(x,y,z,w),dp;
....:         setring R;
....:         map f=S,ideal(s^4,s^3*t,s*t^3,t^4);
....:         setring S;
....:         ideal ker=kernel(R,f)
....:       ''');
sage: singular.get('ker')
'yz-xw,\nz3-yw2,\nxz2-y2w,\ny3-x2z'
sage: print(_)
yz-xw,
z3-yw2,
xz2-y2w,
y3-x2z
```

CC:  @dimpase

Branch/Commit: fd6dee61ca094c0b34961f41d6ef357def6ead5e

Reviewer: Travis Scrimshaw

Author: Markus Wageringel

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/9792





---

archive/issue_events_024559.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-06-01T16:00:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9792#event-24559"
}
```



---

archive/issue_comments_095988.json:
```json
{
    "body": "Remove assignee @aghitza.",
    "created_at": "2020-06-01T16:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95988",
    "user": "https://github.com/mwageringel"
}
```

Remove assignee @aghitza.



---

archive/issue_comments_095989.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-06-01T16:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95989",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_095990.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-01T16:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95990",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_095991.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-01T16:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95991",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_095992.json:
```json
{
    "body": "<a id='comment:5'></a>In `RingHomomorphism_cover._inverse_image_element`, you forgot the `EXAMPLES::` (and indentation).\n\nShould we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?",
    "created_at": "2020-06-02T06:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95992",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>In `RingHomomorphism_cover._inverse_image_element`, you forgot the `EXAMPLES::` (and indentation).

Should we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?



---

archive/issue_comments_095993.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-02T19:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_095994.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-06-02T19:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95994",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_095995.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 tscrim]:\n> Should we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?\n\n\nIt would probably be good to wrap the Singular functions `kernel` and `preimage`, yes. I have not compared it in terms of speed yet, mainly because I thought that I needed to implement the graph ideal in Sage anyway in order to compute inverses of elements. However, I have just noticed that the Singular function [algebra_containment](https://www.singular.uni-kl.de/Manual/4-1-3/sing_1215.htm#SEC1296) can be used for that, which I had overlooked before. I will try to figure out how to call it from Sage and then report back.\n\nPossibly this means that this branch can be refactored such that it only wraps Singular functions, instead of constructing the graph ideal in Sage, unless we want to keep it for more control over the Gr\u00f6bner basis computations.\n\nHere is Singular code for the example from the description:\n\n```\n> LIB \"algebra.lib\";\n> ring S = 0, (s,t), dp;\n> ideal A = ideal(s^4, s^3*t, s*t^3, t^4);\n> poly p = s^3*t^4*(s+t);\n> list L = algebra_containment(p, A, 1);\n> L[1];\n1\n> def T = L[2]; setring T; check;\ny(1)*y(4)+y(2)*y(4)\n```",
    "created_at": "2020-06-02T19:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95995",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>Replying to [comment:5 tscrim]:
> Should we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?


It would probably be good to wrap the Singular functions `kernel` and `preimage`, yes. I have not compared it in terms of speed yet, mainly because I thought that I needed to implement the graph ideal in Sage anyway in order to compute inverses of elements. However, I have just noticed that the Singular function [algebra_containment](https://www.singular.uni-kl.de/Manual/4-1-3/sing_1215.htm#SEC1296) can be used for that, which I had overlooked before. I will try to figure out how to call it from Sage and then report back.

Possibly this means that this branch can be refactored such that it only wraps Singular functions, instead of constructing the graph ideal in Sage, unless we want to keep it for more control over the Gröbner basis computations.

Here is Singular code for the example from the description:

```
> LIB "algebra.lib";
> ring S = 0, (s,t), dp;
> ideal A = ideal(s^4, s^3*t, s*t^3, t^4);
> poly p = s^3*t^4*(s+t);
> list L = algebra_containment(p, A, 1);
> L[1];
1
> def T = L[2]; setring T; check;
y(1)*y(4)+y(2)*y(4)
```



---

archive/issue_comments_095996.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 gh-mwageringel]:\n> Replying to [comment:5 tscrim]:\n> > Should we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?\n\n> \n> It would probably be good to wrap the Singular functions `kernel` and `preimage`, yes. I have not compared it in terms of speed yet, mainly because I thought that I needed to implement the graph ideal in Sage anyway in order to compute inverses of elements. However, I have just noticed that the Singular function [algebra_containment](https://www.singular.uni-kl.de/Manual/4-1-3/sing_1215.htm#SEC1296) can be used for that, which I had overlooked before. I will try to figure out how to call it from Sage and then report back.\n> \n> Possibly this means that this branch can be refactored such that it only wraps Singular functions, instead of constructing the graph ideal in Sage, unless we want to keep it for more control over the Gr\u00f6bner basis computations.\n\n\nWe will probably want to have both so we can have it for both generic polynomials (over more exotic base fields (integral domains?)) and specialized code for those implemented using Singular (and less back-and-forth between Singular and Sage).",
    "created_at": "2020-06-03T04:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95996",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>Replying to [comment:7 gh-mwageringel]:
> Replying to [comment:5 tscrim]:
> > Should we also implement a (lib)singular version of the kernel for ideals? Or did you do this already and saw that it was slower?

> 
> It would probably be good to wrap the Singular functions `kernel` and `preimage`, yes. I have not compared it in terms of speed yet, mainly because I thought that I needed to implement the graph ideal in Sage anyway in order to compute inverses of elements. However, I have just noticed that the Singular function [algebra_containment](https://www.singular.uni-kl.de/Manual/4-1-3/sing_1215.htm#SEC1296) can be used for that, which I had overlooked before. I will try to figure out how to call it from Sage and then report back.
> 
> Possibly this means that this branch can be refactored such that it only wraps Singular functions, instead of constructing the graph ideal in Sage, unless we want to keep it for more control over the Gröbner basis computations.


We will probably want to have both so we can have it for both generic polynomials (over more exotic base fields (integral domains?)) and specialized code for those implemented using Singular (and less back-and-forth between Singular and Sage).



---

archive/issue_comments_095997.json:
```json
{
    "body": "<a id='comment:10'></a>Implementing this via the libsingular interface is a lot more complicated than I anticipated. It is not currently possible to use Sage's `singular_function` with the Singular type `qring`, and quotient rings in Sage are not even backed by `qring`s in Singular. This means it is not currently possible to use the Singular function `algebra_containment` with quotient rings via libsingular, but only with polynomial rings.\n\nThe implementation of [algebra_containment](https://github.com/Singular/Sources/blob/Release-4-1-3p2/Singular/LIB/algebra.lib#L59-L129) is essentially the same as on this branch. The main difference is that `algebra_containment` uses the Singular function `std` for Gr\u00f6bner basis computations whereas Sage uses the general purpose function `groebner`, which does some preprocessing and then calls a suitable implementation. As such, the computation times can be quite different. The Singular version is often a bit faster, but when computing preimages of many elements, the caching in the Sage version seems to be more effective.\n\nThe implementation of the Singular function `preimage` is a bit less transparent to me, so it might be more interesting to wrap this. In this case, by switching to the ambient ring, one can work around the problem that the `qring` type is not supported. However, I still did not manage to call `preimage` via libsingular, as it requires the ideals passed as arguments to have names, which our ideals apparently do not have.\n\nThe other option is to use the Singular pexpect interface to wrap `preimage` and `algebra_containment`. Though, as the current branch is functional, I would prefer to not implement that on this ticket here, so I am setting this back to needs_review.",
    "created_at": "2020-06-13T14:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95997",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:10'></a>Implementing this via the libsingular interface is a lot more complicated than I anticipated. It is not currently possible to use Sage's `singular_function` with the Singular type `qring`, and quotient rings in Sage are not even backed by `qring`s in Singular. This means it is not currently possible to use the Singular function `algebra_containment` with quotient rings via libsingular, but only with polynomial rings.

The implementation of [algebra_containment](https://github.com/Singular/Sources/blob/Release-4-1-3p2/Singular/LIB/algebra.lib#L59-L129) is essentially the same as on this branch. The main difference is that `algebra_containment` uses the Singular function `std` for Gröbner basis computations whereas Sage uses the general purpose function `groebner`, which does some preprocessing and then calls a suitable implementation. As such, the computation times can be quite different. The Singular version is often a bit faster, but when computing preimages of many elements, the caching in the Sage version seems to be more effective.

The implementation of the Singular function `preimage` is a bit less transparent to me, so it might be more interesting to wrap this. In this case, by switching to the ambient ring, one can work around the problem that the `qring` type is not supported. However, I still did not manage to call `preimage` via libsingular, as it requires the ideals passed as arguments to have names, which our ideals apparently do not have.

The other option is to use the Singular pexpect interface to wrap `preimage` and `algebra_containment`. Though, as the current branch is functional, I would prefer to not implement that on this ticket here, so I am setting this back to needs_review.



---

archive/issue_comments_095998.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-13T14:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95998",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_095999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-13T22:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-95999",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_096000.json:
```json
{
    "body": "<a id='comment:11'></a>That is too bad. Thank you for trying. I agree that we should get this into Sage now, and we can revisit using libsingular later.",
    "created_at": "2020-06-13T22:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-96000",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>That is too bad. Thank you for trying. I agree that we should get this into Sage now, and we can revisit using libsingular later.



---

archive/issue_comments_096001.json:
```json
{
    "body": "<a id='comment:12'></a>Thank you.",
    "created_at": "2020-06-13T23:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-96001",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:12'></a>Thank you.



---

archive/issue_events_024560.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-22T22:34:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9792#event-24560"
}
```



---

archive/issue_comments_096002.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-22T22:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9792",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9792#issuecomment-96002",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
