# Issue 9390: is_galois_relative() not always right

archive/issues_009390.json:
```json
{
    "body": "In 4.4.4 the following code produces a number field which is Galois over the rationals but (allegedly) not over an intermediate field.\n\n```\nsage: K.<a>=NumberField(x^2+1)\nsage: Kt.<t> = K[]\nsage: L.<b> = K.extension(t^3-3*t-1)\nsage: L.is_galois_absolute()\nTrue\nsage: L.is_galois_relative()\nFalse\n```\n\n\n**Assignee:** @loefflerd\n\n**CC:**  cturner @mstreng\n\n**Keywords:** galois extension\n\n**Author:** Francis Clarke\n\n**Reviewer:** Marco Streng\n\n**Merged:** sage-4.6.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/9390\n\n",
    "closed_at": "2011-01-19T22:21:17Z",
    "created_at": "2010-06-30T04:33:44Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6.2",
    "title": "is_galois_relative() not always right",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/9390",
    "user": "https://github.com/arminstraub"
}
```
In 4.4.4 the following code produces a number field which is Galois over the rationals but (allegedly) not over an intermediate field.

```
sage: K.<a>=NumberField(x^2+1)
sage: Kt.<t> = K[]
sage: L.<b> = K.extension(t^3-3*t-1)
sage: L.is_galois_absolute()
True
sage: L.is_galois_relative()
False
```


**Assignee:** @loefflerd

**CC:**  cturner @mstreng

**Keywords:** galois extension

**Author:** Francis Clarke

**Reviewer:** Marco Streng

**Merged:** sage-4.6.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/9390





---

archive/issue_comments_082057.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis fails because the present definition for relative number fields:\n\n```\ndef is_galois_relative(self):\n    return self.Hom(self).order() == self.relative_degree()\n```\nis completely wrong.  In the case above\n\n```\nsage: L.Hom(L).order()\n6\n```\nwhile the relative degree is 3.  Clearly the Homset contains all endomorphisms of of L, not just the relative ones.  One obvious possibility would be to count those endomorphisms which fix the base field.  But the following might be better\n\n```\ndef is_galois_relative(self):\n    rel_poly = self.relative_polynomial()\n    return len(rel_poly.base_extend(self).factor()) == self.relative_degree()\n\n```\nI'll do some testing and post a patch later today.",
    "created_at": "2010-06-30T07:39:55Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82057",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:1'></a>
This fails because the present definition for relative number fields:

```
def is_galois_relative(self):
    return self.Hom(self).order() == self.relative_degree()
```
is completely wrong.  In the case above

```
sage: L.Hom(L).order()
6
```
while the relative degree is 3.  Clearly the Homset contains all endomorphisms of of L, not just the relative ones.  One obvious possibility would be to count those endomorphisms which fix the base field.  But the following might be better

```
def is_galois_relative(self):
    rel_poly = self.relative_polynomial()
    return len(rel_poly.base_extend(self).factor()) == self.relative_degree()

```
I'll do some testing and post a patch later today.



---

archive/issue_comments_082058.json:
```json
{
    "body": "<a id='comment:3'></a>\nAfter a rather longer than expected delay, I'm attaching a patch which gives correct results for `is_galois_relative`.  I've also rewritten `is_galois_absolute` using a corresponding algorithm because it is (i) faster than the existing code, and (ii) capable of handling extension of larger degree.",
    "created_at": "2010-12-10T15:07:01Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82058",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:3'></a>
After a rather longer than expected delay, I'm attaching a patch which gives correct results for `is_galois_relative`.  I've also rewritten `is_galois_absolute` using a corresponding algorithm because it is (i) faster than the existing code, and (ii) capable of handling extension of larger degree.



---

archive/issue_events_068851.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-10T15:07:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68851"
}
```



---

archive/attachments_012371.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_9390.patch",
    "asset_url": "tarball://root/attachments/ticket9390/trac_9390.patch",
    "created_at": "2010-12-10T15:07:28Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket9390/trac_9390.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```



---

archive/issue_comments_082059.json:
```json
{
    "body": "**Attachment:** [trac_9390.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390.patch)",
    "created_at": "2010-12-10T15:07:28Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82059",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

**Attachment:** [trac_9390.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390.patch)



---

archive/issue_comments_082060.json:
```json
{
    "body": "<a id='comment:4'></a>\nNice, that is a lot faster, and correct. There is one thing I don't like though: you introduced a difference between `is_galois` of absolute number fields and `is_galois_absolute` of relative number fields:\n\nWith your patch on Sage 4.6.1.alpha2:\n\n```\nsage: M.<c> = NumberField(cyclotomic_polynomial(100))\nsage: M\nNumber Field in c with defining polynomial x^40 - x^30 + x^20 - x^10 + 1\nsage: M.is_galois()\nNotImplementedError\nsage: M.relativize(1, 'd').is_galois_absolute()\nTrue\nsage: M.relativize(1, 'd').is_galois_relative()\nTrue\n```\nWithout your patch, it is NotImplementedError, NotImplementedError, False, so your patch is a definite improvement, but could be better.\n\nI think it would be better to put your new code in `is_galois` of absolute fields instead of `is_galois_absolute` of relative fields. Then `is_galois_absolute()` can simply call `self.absolute_field().is_galois()`\n\nPS grammar: line 1177 of number_field_rel.py after the patch, previous should be previously (or simply replace the line by \"Check that bug #9390 is fixed::\")",
    "created_at": "2010-12-13T12:10:03Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82060",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:4'></a>
Nice, that is a lot faster, and correct. There is one thing I don't like though: you introduced a difference between `is_galois` of absolute number fields and `is_galois_absolute` of relative number fields:

With your patch on Sage 4.6.1.alpha2:

```
sage: M.<c> = NumberField(cyclotomic_polynomial(100))
sage: M
Number Field in c with defining polynomial x^40 - x^30 + x^20 - x^10 + 1
sage: M.is_galois()
NotImplementedError
sage: M.relativize(1, 'd').is_galois_absolute()
True
sage: M.relativize(1, 'd').is_galois_relative()
True
```
Without your patch, it is NotImplementedError, NotImplementedError, False, so your patch is a definite improvement, but could be better.

I think it would be better to put your new code in `is_galois` of absolute fields instead of `is_galois_absolute` of relative fields. Then `is_galois_absolute()` can simply call `self.absolute_field().is_galois()`

PS grammar: line 1177 of number_field_rel.py after the patch, previous should be previously (or simply replace the line by "Check that bug #9390 is fixed::")



---

archive/issue_comments_082061.json:
```json
{
    "body": "**Author:** Francis Clarke",
    "created_at": "2010-12-13T12:10:03Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82061",
    "user": "https://github.com/mstreng"
}
```

**Author:** Francis Clarke



---

archive/issue_events_068852.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-13T12:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68852"
}
```



---

archive/issue_events_068853.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-13T12:10:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68853"
}
```



---

archive/issue_events_068854.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-13T12:10:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68854"
}
```



---

archive/issue_comments_082062.json:
```json
{
    "body": "**Reviewer:** Marco Streng",
    "created_at": "2010-12-13T12:10:03Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82062",
    "user": "https://github.com/mstreng"
}
```

**Reviewer:** Marco Streng



---

archive/issue_events_068855.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-16T08:19:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68855"
}
```



---

archive/issue_events_068856.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-16T08:19:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68856"
}
```



---

archive/issue_comments_082063.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [@mstreng](#comment%3A4):\n\n> I think it would be better to put your new code in `is_galois` of absolute fields instead of `is_galois_absolute` of relative fields. Then `is_galois_absolute()` can simply call `self.absolute_field().is_galois()`\n\nI've done this in a new replacement patch, and dealt with the grammatical point you raised.\n\nIt was also necessary to make a minor change to an unconnected doctest. \u00a0This is because of PARI's inconsistent behaviour when choosing ideal generators.  The same issue arose in #5842.",
    "created_at": "2010-12-16T08:19:18Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82063",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:5'></a>
Replying to [@mstreng](#comment%3A4):

> I think it would be better to put your new code in `is_galois` of absolute fields instead of `is_galois_absolute` of relative fields. Then `is_galois_absolute()` can simply call `self.absolute_field().is_galois()`

I've done this in a new replacement patch, and dealt with the grammatical point you raised.

It was also necessary to make a minor change to an unconnected doctest.  This is because of PARI's inconsistent behaviour when choosing ideal generators.  The same issue arose in #5842.



---

archive/attachments_012372.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_9390-replacement.patch",
    "asset_url": "tarball://root/attachments/ticket9390/trac_9390-replacement.patch",
    "created_at": "2010-12-16T08:37:06Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket9390/trac_9390-replacement.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```



---

archive/issue_comments_082064.json:
```json
{
    "body": "**Attachment:** [trac_9390-replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-replacement.patch)\n\nReplaces previous patch",
    "created_at": "2010-12-16T08:37:06Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82064",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

**Attachment:** [trac_9390-replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-replacement.patch)

Replaces previous patch



---

archive/issue_comments_082065.json:
```json
{
    "body": "<a id='comment:6'></a>\nOn which Sage version is this a speedup for is_galois_absolute?\n\nWith Sage 4.6.1.alpha2 and no patches\n\n```\nsage: K.<a>=NumberField(x^2+1)\nsage: Kt.<t> = K[]\nsage: L.<b> = K.extension(t^3-3*t-1)\nsage: M.<c> = L.absolute_field()\nsage: time L.is_galois_absolute()\nCPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s\nWall time: 0.00 s\nTrue\nsage: time L.is_galois_relative()\nCPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s\nWall time: 0.08 s\nFalse\nsage: time M.is_galois()\nCPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s\nWall time: 0.00 s\nTrue\n```\n\nSame version, but with your patch:\n\n```\nsage: K.<a>=NumberField(x^2+1)\nsage: Kt.<t> = K[]\nsage: L.<b> = K.extension(t^3-3*t-1)\nsage: M.<c> = L.absolute_field()\nsage: time L.is_galois_absolute()\nCPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s\nWall time: 0.04 s\nTrue\nsage: time L.is_galois_relative()\nCPU times: user 0.04 s, sys: 0.01 s, total: 0.05 s\nWall time: 0.05 s\nTrue\nsage: time M.is_galois()\nCPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s\nWall time: 0.03 s\nTrue\n```\nSo you did correct (and apparently speed up) is_galois_relative. However, it seems to slow down is_galois and is_galois_absolute. This gets worse if you use is_galois multiple times for the same field, as the old version uses cached data and your version doesn't:\n\nWithout patch:\n\n```\nsage: K.<b> = NumberField(cyclotomic_polynomial(11))\nsage: time K.is_galois()\nCPU times: user 0.02 s, sys: 0.00 s, total: 0.02 s\nWall time: 0.02 s\nTrue\nsage: time [K.is_galois() for i in range(500)];\nCPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s\nWall time: 0.03 s\n```\nWith patch:\n\n```\nsage: K.<b> = NumberField(cyclotomic_polynomial(11))\nsage: time K.is_galois()\nCPU times: user 0.06 s, sys: 0.00 s, total: 0.06 s\nWall time: 0.06 s\nTrue\nsage: time [K.is_galois() for i in range(500)];\nCPU times: user 11.66 s, sys: 0.05 s, total: 11.71 s\nWall time: 11.72 s\n```\nI'm very sorry for not noticing this earlier and for letting you do make the changes you did after my first review.\n\nOn the other hand, my suggestion allowed for a good test of your code, as is_galois is ubiquitous:\n\n```\nsage -t -long devel/sage/sage/schemes/elliptic_curves/gal_reps.py\n*** *** Error: TIMED OUT! PROCESS KILLED! *** ***\n```\n\nMaybe it is better to stick with the is_galois_relative correction only.\n\nAlso, if you know about cached methods, then perhaps you could make is_galois_relative and is_galois_absolute cached while you're at it.\n\nYou can also make a distinction in is_galois between degree <= 11 (use the old method) and degree > 11 (old method only works if KASH is installed, use your method).\n\nI suppose it is good to still let is_galois_absolute() simply call absolute_field().is_galois().",
    "created_at": "2010-12-16T14:33:28Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82065",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:6'></a>
On which Sage version is this a speedup for is_galois_absolute?

With Sage 4.6.1.alpha2 and no patches

```
sage: K.<a>=NumberField(x^2+1)
sage: Kt.<t> = K[]
sage: L.<b> = K.extension(t^3-3*t-1)
sage: M.<c> = L.absolute_field()
sage: time L.is_galois_absolute()
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.00 s
True
sage: time L.is_galois_relative()
CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s
Wall time: 0.08 s
False
sage: time M.is_galois()
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s
True
```

Same version, but with your patch:

```
sage: K.<a>=NumberField(x^2+1)
sage: Kt.<t> = K[]
sage: L.<b> = K.extension(t^3-3*t-1)
sage: M.<c> = L.absolute_field()
sage: time L.is_galois_absolute()
CPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s
Wall time: 0.04 s
True
sage: time L.is_galois_relative()
CPU times: user 0.04 s, sys: 0.01 s, total: 0.05 s
Wall time: 0.05 s
True
sage: time M.is_galois()
CPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s
Wall time: 0.03 s
True
```
So you did correct (and apparently speed up) is_galois_relative. However, it seems to slow down is_galois and is_galois_absolute. This gets worse if you use is_galois multiple times for the same field, as the old version uses cached data and your version doesn't:

Without patch:

```
sage: K.<b> = NumberField(cyclotomic_polynomial(11))
sage: time K.is_galois()
CPU times: user 0.02 s, sys: 0.00 s, total: 0.02 s
Wall time: 0.02 s
True
sage: time [K.is_galois() for i in range(500)];
CPU times: user 0.03 s, sys: 0.00 s, total: 0.03 s
Wall time: 0.03 s
```
With patch:

```
sage: K.<b> = NumberField(cyclotomic_polynomial(11))
sage: time K.is_galois()
CPU times: user 0.06 s, sys: 0.00 s, total: 0.06 s
Wall time: 0.06 s
True
sage: time [K.is_galois() for i in range(500)];
CPU times: user 11.66 s, sys: 0.05 s, total: 11.71 s
Wall time: 11.72 s
```
I'm very sorry for not noticing this earlier and for letting you do make the changes you did after my first review.

On the other hand, my suggestion allowed for a good test of your code, as is_galois is ubiquitous:

```
sage -t -long devel/sage/sage/schemes/elliptic_curves/gal_reps.py
*** *** Error: TIMED OUT! PROCESS KILLED! *** ***
```

Maybe it is better to stick with the is_galois_relative correction only.

Also, if you know about cached methods, then perhaps you could make is_galois_relative and is_galois_absolute cached while you're at it.

You can also make a distinction in is_galois between degree <= 11 (use the old method) and degree > 11 (old method only works if KASH is installed, use your method).

I suppose it is good to still let is_galois_absolute() simply call absolute_field().is_galois().



---

archive/issue_events_068857.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-16T14:33:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68857"
}
```



---

archive/issue_events_068858.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-16T14:33:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68858"
}
```



---

archive/issue_events_068859.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-16T21:48:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68859"
}
```



---

archive/issue_events_068860.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-16T21:48:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68860"
}
```



---

archive/issue_comments_082066.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@mstreng](#comment%3A6):\n\n> On which Sage version is this a speedup for is_galois_absolute? ...\n\nI'm sorry about this.  I don't know how I convinced myself that the absolute version was faster.\n\n> On the other hand, my suggestion allowed for a good test of your code, as is_galois is ubiquitous:\n\n\n```\nsage -t -long devel/sage/sage/schemes/elliptic_curves/gal_reps.py\n *** *** Error: TIMED OUT! PROCESS KILLED! *** *** \n```\n\nI can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):\n\n```\nsage -grep -l is_galois\n----------------------------------------------------------------------\n| Sage Version 4.6, Release Date: 2010-10-30                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\ncoding/linear_code.py\nrings/number_field/galois_group.py\nrings/number_field/number_field.py\nrings/number_field/number_field_rel.py\nrings/number_field/totallyreal_rel.py\nrings/padics/unramified_extension_generic.py\nrings/number_field/number_field_element.pyx\n```\n> Maybe it is better to stick with the is_galois_relative correction only.  Also, if you know about cached methods, then perhaps you could make is_galois_relative and is_galois_absolute cached while you're at it. You can also make a distinction in is_galois between degree <= 11 (use the old method) and degree > 11 (old method only works if KASH is installed, use your method). I suppose it is good to still let is_galois_absolute() simply call absolute_field().is_galois().\n\nThe new patch implements this, except it doesn't do any caching.  `is_galois_absolute` is already cached in the degree <= 11 cases via `self.absolute_field()`.  In the other cases, I think what really needs caching is the factorisation of the defining polynomial over `self,` since it's also what's needed to compute endomorphisms. But that is for another patch, I think.",
    "created_at": "2010-12-16T21:48:45Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82066",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:7'></a>
Replying to [@mstreng](#comment%3A6):

> On which Sage version is this a speedup for is_galois_absolute? ...

I'm sorry about this.  I don't know how I convinced myself that the absolute version was faster.

> On the other hand, my suggestion allowed for a good test of your code, as is_galois is ubiquitous:


```
sage -t -long devel/sage/sage/schemes/elliptic_curves/gal_reps.py
 *** *** Error: TIMED OUT! PROCESS KILLED! *** *** 
```

I can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):

```
sage -grep -l is_galois
----------------------------------------------------------------------
| Sage Version 4.6, Release Date: 2010-10-30                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
coding/linear_code.py
rings/number_field/galois_group.py
rings/number_field/number_field.py
rings/number_field/number_field_rel.py
rings/number_field/totallyreal_rel.py
rings/padics/unramified_extension_generic.py
rings/number_field/number_field_element.pyx
```
> Maybe it is better to stick with the is_galois_relative correction only.  Also, if you know about cached methods, then perhaps you could make is_galois_relative and is_galois_absolute cached while you're at it. You can also make a distinction in is_galois between degree <= 11 (use the old method) and degree > 11 (old method only works if KASH is installed, use your method). I suppose it is good to still let is_galois_absolute() simply call absolute_field().is_galois().

The new patch implements this, except it doesn't do any caching.  `is_galois_absolute` is already cached in the degree <= 11 cases via `self.absolute_field()`.  In the other cases, I think what really needs caching is the factorisation of the defining polynomial over `self,` since it's also what's needed to compute endomorphisms. But that is for another patch, I think.



---

archive/issue_comments_082067.json:
```json
{
    "body": "Replaces previous two patches",
    "created_at": "2010-12-16T21:49:44Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82067",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

Replaces previous two patches



---

archive/attachments_012373.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_9390-2nd_replacement.patch",
    "asset_url": "tarball://root/attachments/ticket9390/trac_9390-2nd_replacement.patch",
    "created_at": "2010-12-17T11:49:08Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket9390/trac_9390-2nd_replacement.patch",
    "user": "https://github.com/mstreng"
}
```



---

archive/issue_comments_082068.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Attachment:** [trac_9390-2nd_replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-2nd_replacement.patch)\n\nReplying to [fwclarke](#comment%3A7):\n> I can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):\n\nHow could you be so sure about that? The timeout is caused by the long test `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`\nThe image_type() part runs forever on 4.6.1.alpha2 with your second patch, and is quite fast without any patches. That method is a long piece of code, so I didn't read it all, but it does suggest that it uses is_galois somewhere via another function.",
    "created_at": "2010-12-17T11:49:08Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82068",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:8'></a>
**Attachment:** [trac_9390-2nd_replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-2nd_replacement.patch)

Replying to [fwclarke](#comment%3A7):
> I can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):

How could you be so sure about that? The timeout is caused by the long test `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`
The image_type() part runs forever on 4.6.1.alpha2 with your second patch, and is quite fast without any patches. That method is a long piece of code, so I didn't read it all, but it does suggest that it uses is_galois somewhere via another function.



---

archive/issue_comments_082069.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@mstreng](#comment%3A8):\n\n> > I can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):\n\n> How could you be so sure about that?\n\nMy mistake was that I was using 4.6.  The long test in question was introduced in #8451 which was merged in sage-4.6.1.alpha2.  I haven't checked it fully, but it looks like in this case the function `image_type` calls `galois_group`, which calls `is_galois`.  It seem that `is_galois` is much more ubiquitous that I thought as it's used in several functions of the classes `GaloisGroup_v2` and `GaloisGroupElement`.  Sorry for not noticing this before.",
    "created_at": "2010-12-17T12:50:24Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82069",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:9'></a>
Replying to [@mstreng](#comment%3A8):

> > I can't reproduce this.  Actually `is_galois` is not particularly ubiquitous (and certainly does figure in `gal_reps.py`):

> How could you be so sure about that?

My mistake was that I was using 4.6.  The long test in question was introduced in #8451 which was merged in sage-4.6.1.alpha2.  I haven't checked it fully, but it looks like in this case the function `image_type` calls `galois_group`, which calls `is_galois`.  It seem that `is_galois` is much more ubiquitous that I thought as it's used in several functions of the classes `GaloisGroup_v2` and `GaloisGroupElement`.  Sorry for not noticing this before.



---

archive/issue_comments_082070.json:
```json
{
    "body": "<a id='comment:10'></a>\nStrange: I remove all patches, build, and the long gal_reps.py test is fine, then I apply your latest patch, build, and it times out again after 1800 seconds.\n\nThe only thing I could think of is that (somewhere in a function called by `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`) an Error of is_galois with degree > 11 is raised and handled in some way. With your patch, that computation will just go on and on.\n\nOr there is something wrong with my sage installation. Can anyone reproduce this increase in test time? (4.6.1.alpha2 with no other patches applied)\n\nFor [buildbot](http://wiki.sagemath.org/buildbot):\n\nApply trac_9390-2nd_replacement.patch",
    "created_at": "2010-12-18T22:46:27Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82070",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:10'></a>
Strange: I remove all patches, build, and the long gal_reps.py test is fine, then I apply your latest patch, build, and it times out again after 1800 seconds.

The only thing I could think of is that (somewhere in a function called by `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`) an Error of is_galois with degree > 11 is raised and handled in some way. With your patch, that computation will just go on and on.

Or there is something wrong with my sage installation. Can anyone reproduce this increase in test time? (4.6.1.alpha2 with no other patches applied)

For [buildbot](http://wiki.sagemath.org/buildbot):

Apply trac_9390-2nd_replacement.patch



---

archive/issue_events_068861.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-19T21:27:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68861"
}
```



---

archive/issue_events_068862.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-19T21:27:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68862"
}
```



---

archive/issue_comments_082071.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@mstreng](#comment%3A10):\n> The only thing I could think of is that (somewhere in a function called by `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`) an Error of is_galois with degree > 11 is raised and handled in some way. With your patch, that computation will just go on and on.\n\nSame problem with a fresh install.\n\nActually, something fishy happens in image_type(7). Without your patch, it outputs `'The image is a group of order 36.'` quickly. With your patch, it goes on and on, until I press Ctrl+C, in which case it catches my KeyboardInterrupt and outputs `'The image is a group of order 36.'` without showing me any Error! So image_type catches all errors, which is why it stops working with your improvement.\n\nSorry, but that means this patch can't go in the way it is: either fix gal_reps or don't touch is_galois.",
    "created_at": "2010-12-19T21:27:50Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82071",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:11'></a>
Replying to [@mstreng](#comment%3A10):
> The only thing I could think of is that (somewhere in a function called by `EllipticCurve([1,-1,0,-107,-379]).galois_representation().image_type(7)`) an Error of is_galois with degree > 11 is raised and handled in some way. With your patch, that computation will just go on and on.

Same problem with a fresh install.

Actually, something fishy happens in image_type(7). Without your patch, it outputs `'The image is a group of order 36.'` quickly. With your patch, it goes on and on, until I press Ctrl+C, in which case it catches my KeyboardInterrupt and outputs `'The image is a group of order 36.'` without showing me any Error! So image_type catches all errors, which is why it stops working with your improvement.

Sorry, but that means this patch can't go in the way it is: either fix gal_reps or don't touch is_galois.



---

archive/issue_comments_082072.json:
```json
{
    "body": "<a id='comment:12'></a>\nWith the #8451 patch, and with `is_galois` unchanged,  I find\n\n```\nsage: set_verbose(1)\nsage: EllipticCurve([1, -1, 0, -107, -379]).galois_representation().image_type(7)\nverbose 1 (1326: free_module.py, coordinate_module) rational in-place Gauss elimination on 0 x 0 matrix\n...\nverbose 1 (811: gal_reps.py, image_type) field of degree 36.  try to compute galois group (time = 14.321421)\n'The image is a group of order 36.'\n```\nderiving from the following lines in `gal_reps.py` (as patched by #8451):\n\n```\n        if p <= 13:\n            K = _division_field(self.E,p)\n            d = K.absolute_degree()\n\n            misc.verbose(\"field of degree %s.  try to compute galois group\"%(d),2)\n            try:\n                G = K.galois_group()\n            except:\n                self.__image_type[p] = \"The image is a group of order %s.\"%d\n                return self.__image_type[p]\n```\nSo what's happening is that `K.is_galois()` (called via `K.galois_group()`) is taking ages when my patch is implemented.  The unqualified `except:` is then catching the keyboard interrupt.  But with the existing implementation of `is_galois` applied to the degree 36 field in question, a `NotImplementedError` is raised and caught.\n\nAnyway, as you suggest, the way forward is a minimal patch which only changes  `is_galois_relative`.  I'm attaching this.",
    "created_at": "2010-12-20T19:30:56Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82072",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:12'></a>
With the #8451 patch, and with `is_galois` unchanged,  I find

```
sage: set_verbose(1)
sage: EllipticCurve([1, -1, 0, -107, -379]).galois_representation().image_type(7)
verbose 1 (1326: free_module.py, coordinate_module) rational in-place Gauss elimination on 0 x 0 matrix
...
verbose 1 (811: gal_reps.py, image_type) field of degree 36.  try to compute galois group (time = 14.321421)
'The image is a group of order 36.'
```
deriving from the following lines in `gal_reps.py` (as patched by #8451):

```
        if p <= 13:
            K = _division_field(self.E,p)
            d = K.absolute_degree()

            misc.verbose("field of degree %s.  try to compute galois group"%(d),2)
            try:
                G = K.galois_group()
            except:
                self.__image_type[p] = "The image is a group of order %s."%d
                return self.__image_type[p]
```
So what's happening is that `K.is_galois()` (called via `K.galois_group()`) is taking ages when my patch is implemented.  The unqualified `except:` is then catching the keyboard interrupt.  But with the existing implementation of `is_galois` applied to the degree 36 field in question, a `NotImplementedError` is raised and caught.

Anyway, as you suggest, the way forward is a minimal patch which only changes  `is_galois_relative`.  I'm attaching this.



---

archive/issue_events_068863.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-20T19:30:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68863"
}
```



---

archive/issue_events_068864.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/fwclarke",
    "created_at": "2010-12-20T19:30:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68864"
}
```



---

archive/attachments_012374.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_9390-3rd_replacement.patch",
    "asset_url": "tarball://root/attachments/ticket9390/trac_9390-3rd_replacement.patch",
    "created_at": "2010-12-20T19:31:51Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket9390/trac_9390-3rd_replacement.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```



---

archive/issue_comments_082073.json:
```json
{
    "body": "**Attachment:** [trac_9390-3rd_replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-3rd_replacement.patch)\n\nReplaces previous three patches",
    "created_at": "2010-12-20T19:31:51Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82073",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

**Attachment:** [trac_9390-3rd_replacement.patch](https://github.com/sagemath/sage/files/ticket9390/trac_9390-3rd_replacement.patch)

Replaces previous three patches



---

archive/issue_events_068865.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-21T11:36:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68865"
}
```



---

archive/issue_events_068866.json:
```json
{
    "actor": "https://github.com/mstreng",
    "created_at": "2010-12-21T11:36:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68866"
}
```



---

archive/issue_comments_082074.json:
```json
{
    "body": "<a id='comment:13'></a>\nToo bad about the improvements to is_galois. I suppose that code from trac_9390-2nd_replacement.patch can go into a new ticket, if someone wants to revise image_type.\n\nApply trac_9390-3rd_replacement.patch",
    "created_at": "2010-12-21T11:36:19Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82074",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:13'></a>
Too bad about the improvements to is_galois. I suppose that code from trac_9390-2nd_replacement.patch can go into a new ticket, if someone wants to revise image_type.

Apply trac_9390-3rd_replacement.patch



---

archive/issue_events_068867.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-12-24T10:16:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68867"
}
```



---

archive/issue_events_068868.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-12-24T10:16:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68868"
}
```



---

archive/issue_comments_082075.json:
```json
{
    "body": "**Merged:** sage-4.6.2.alpha1",
    "created_at": "2011-01-19T22:21:17Z",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9390#issuecomment-82075",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.6.2.alpha1



---

archive/issue_events_068869.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-19T22:21:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68869"
}
```



---

archive/issue_events_068870.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-19T22:21:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/9390",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9390#event-68870"
}
```
