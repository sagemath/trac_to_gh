# Issue 9954: f_vector outputs an extra top-dimensional cell

archive/issues_009953.json:
```json
{
    "body": "For a polytope whose dimension is less than its ambient dimension, the f_vector outputs an extra top-dimensional cell. For example, a triangle in 3-space:\n\nINPUT\n\n```\nPolyhedron(vertices=[[0,0,0],[1,0,0],[0,1,0]]).f_vector()\n```\n\nOUTPUT\n\n```\n[1, 3, 3, 1, 1]\n```\n\nExpected Output\n\n```\n[1, 3, 3, 1]\n```\n\nNote, this was reported by the \"report a problem\" form.\n\nAssignee: mhampton\n\nCC:  @novoselt\n\nResolution: fixed\n\nAuthor: Volker Braun\n\nReviewer: Andrey Novoseltsev\n\nMerged: sage-4.6.1.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/9954\n\n",
    "closed_at": "2010-11-11T13:02:28Z",
    "created_at": "2010-09-20T18:17:56Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "f_vector outputs an extra top-dimensional cell",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9954",
    "user": "https://github.com/haraldschilly"
}
```
For a polytope whose dimension is less than its ambient dimension, the f_vector outputs an extra top-dimensional cell. For example, a triangle in 3-space:

INPUT

```
Polyhedron(vertices=[[0,0,0],[1,0,0],[0,1,0]]).f_vector()
```

OUTPUT

```
[1, 3, 3, 1, 1]
```

Expected Output

```
[1, 3, 3, 1]
```

Note, this was reported by the "report a problem" form.

Assignee: mhampton

CC:  @novoselt

Resolution: fixed

Author: Volker Braun

Reviewer: Andrey Novoseltsev

Merged: sage-4.6.1.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/9954





---

archive/issue_comments_119053.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe attached patch removes the old `face_lattice()` implementation and replaces it with Andrey's implementation of the same algorithm from `sage/geometry/cone.py` plus a few extensions to deal with general polyhedra. The function `hasse_diagram_from_incidences` is moved from `cone.py` to `polyhedra.py`. It also introduces a new class `PolyhedronFace` to abstract the faces. Now produces sane output on various degenerate polyhedra. \n\nPatch might depend on #9798, #10148, #10024. Should be logically independent, but there will be some fuzz.",
    "created_at": "2010-10-25T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119053",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
The attached patch removes the old `face_lattice()` implementation and replaces it with Andrey's implementation of the same algorithm from `sage/geometry/cone.py` plus a few extensions to deal with general polyhedra. The function `hasse_diagram_from_incidences` is moved from `cone.py` to `polyhedra.py`. It also introduces a new class `PolyhedronFace` to abstract the faces. Now produces sane output on various degenerate polyhedra. 

Patch might depend on #9798, #10148, #10024. Should be logically independent, but there will be some fuzz.



---

archive/issue_comments_119054.json:
```json
{
    "body": "Changing author from \"\" to \"Volker Braun\"",
    "created_at": "2010-10-25T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119054",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Volker Braun"



---

archive/issue_events_025112.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2010-10-25T11:46:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9954#event-25112"
}
```



---

archive/issue_comments_119055.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-25T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119055",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_119056.json:
```json
{
    "body": "<a id='comment:2'></a>\nNote also #8656.\n\nA quick question: why was my function moved?-)",
    "created_at": "2010-10-25T14:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119056",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>
Note also #8656.

A quick question: why was my function moved?-)



---

archive/issue_comments_119057.json:
```json
{
    "body": "<a id='comment:3'></a>\n`cone.py` already imports from `polyhedron.py` and I didn't want to create a cyclic import :-)",
    "created_at": "2010-10-25T14:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119057",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
`cone.py` already imports from `polyhedron.py` and I didn't want to create a cyclic import :-)



---

archive/issue_comments_119058.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Andrey Novoseltsev\"",
    "created_at": "2010-10-30T04:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119058",
    "user": "https://github.com/novoselt"
}
```

Changing reviewer from "" to "Andrey Novoseltsev"



---

archive/issue_comments_119059.json:
```json
{
    "body": "<a id='comment:4'></a>\nShouldn't lines be added to all faces including the \"empty one\"? I am thinking here by analogy with equations that are \"saturated\" for all faces including the \"full face\". I agree that it is a bit weird, but I think this is correct from the point of view of dual representations.\n\nI guess I then also want this \"empty face\" to have the dimension less by one then the dimension of the linear space generated by lines, by analogy to vertex - dimension 0, empty set - dimension -1. This is really weird, perhaps because in both cases \"empty face\" should have dimension -infinity?.. But it seems to me that \"perfect duality\" justifies a strange choice of dimension for a strange/empty face - if one works with such a face, he better know what he is doing. In which case, e.g. -1 is a great choice for the dimension of the empty face of a supporting polytope of a cone.\n\nIn the documentation the sentence \"In the case of a full-dimensional polytope, the faces are pairs (vertices, inequalities) ...\" needs some rewording - it is a bit misleading since faces are now represented by a special class (which is great, by the way!).\n\nI didn't finish reading the patch yet, but hope to do so tomorrow.",
    "created_at": "2010-10-30T04:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119059",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'></a>
Shouldn't lines be added to all faces including the "empty one"? I am thinking here by analogy with equations that are "saturated" for all faces including the "full face". I agree that it is a bit weird, but I think this is correct from the point of view of dual representations.

I guess I then also want this "empty face" to have the dimension less by one then the dimension of the linear space generated by lines, by analogy to vertex - dimension 0, empty set - dimension -1. This is really weird, perhaps because in both cases "empty face" should have dimension -infinity?.. But it seems to me that "perfect duality" justifies a strange choice of dimension for a strange/empty face - if one works with such a face, he better know what he is doing. In which case, e.g. -1 is a great choice for the dimension of the empty face of a supporting polytope of a cone.

In the documentation the sentence "In the case of a full-dimensional polytope, the faces are pairs (vertices, inequalities) ..." needs some rewording - it is a bit misleading since faces are now represented by a special class (which is great, by the way!).

I didn't finish reading the patch yet, but hope to do so tomorrow.



---

archive/issue_comments_119060.json:
```json
{
    "body": "<a id='comment:5'></a>\nI am getting fuzz applying this patch, probably because I have #9972 applied. If you are happy with the current version of that ticket, it would be convenient to have it pushed before this one ;-)",
    "created_at": "2010-10-30T04:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119060",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:5'></a>
I am getting fuzz applying this patch, probably because I have #9972 applied. If you are happy with the current version of that ticket, it would be convenient to have it pushed before this one ;-)



---

archive/issue_comments_119061.json:
```json
{
    "body": "<a id='comment:6'></a>\n1. It seems that you wanted to cache the face lattice but forgot - the output of `hasse_diagram_from_incidences` is directly returned.\n   1. Perhaps we should rename the method to `Hasse...`?\n   2. `PolyhedronFace` constructor does not describe input.\n   3. I think it would be nice to be able to treat polyhedron faces as polyhedrons themselves, in the way how it is done for cones. This is feasible only if creating new polyhedra is very fast, which is not the case now, but maybe it is something to think about in the future. As an easier to implement alternative, I would suggest adding a method `polyhedron` to `PolyhedronFace` that will produce a corresponding `Polyhedron` object. Note that this will clash with my desire to include lines to all faces including the bottom one. I am not sure what is the best option about it. Do you know what is the standard treatment in such situations?\n   4. I think that new argument `faces_at_infinity` should be gone - it seems obscure to me and it is unnecessary. Currently you have replaced my line \n   {{{\nhead.extend(faces[frozenset([atom]), coatoms] \n    for atom, coatoms in enumerate(atom_to_coatoms))\n}}}\n with\n {{{\nfor atom, coatoms in enumerate(atom_to_coatoms): \n    try: \n        head.append(faces[frozenset([atom]), coatoms]) \n    except KeyError, msg: \n        if not faces_at_infinity: \n \t    raise KeyError, msg \n}}}\n but you can get the same result with\n {{{\nhead.extend(faces[frozenset([atom]), coatoms] \n    for atom, coatoms in enumerate(atom_to_coatoms)\n    if atoms_require_one_of is None or atom in atoms_require_one_of)\n}}}\n1. How about renaming `atoms_require_one_of` to `required_atoms`? I agree that your variant is more descriptive, but it sounds a bit weird as a parameter name.",
    "created_at": "2010-10-30T23:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119061",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>
1. It seems that you wanted to cache the face lattice but forgot - the output of `hasse_diagram_from_incidences` is directly returned.
   1. Perhaps we should rename the method to `Hasse...`?
   2. `PolyhedronFace` constructor does not describe input.
   3. I think it would be nice to be able to treat polyhedron faces as polyhedrons themselves, in the way how it is done for cones. This is feasible only if creating new polyhedra is very fast, which is not the case now, but maybe it is something to think about in the future. As an easier to implement alternative, I would suggest adding a method `polyhedron` to `PolyhedronFace` that will produce a corresponding `Polyhedron` object. Note that this will clash with my desire to include lines to all faces including the bottom one. I am not sure what is the best option about it. Do you know what is the standard treatment in such situations?
   4. I think that new argument `faces_at_infinity` should be gone - it seems obscure to me and it is unnecessary. Currently you have replaced my line 
   {{{
head.extend(faces[frozenset([atom]), coatoms] 
    for atom, coatoms in enumerate(atom_to_coatoms))
}}}
 with
 {{{
for atom, coatoms in enumerate(atom_to_coatoms): 
    try: 
        head.append(faces[frozenset([atom]), coatoms]) 
    except KeyError, msg: 
        if not faces_at_infinity: 
 	    raise KeyError, msg 
}}}
 but you can get the same result with
 {{{
head.extend(faces[frozenset([atom]), coatoms] 
    for atom, coatoms in enumerate(atom_to_coatoms)
    if atoms_require_one_of is None or atom in atoms_require_one_of)
}}}
1. How about renaming `atoms_require_one_of` to `required_atoms`? I agree that your variant is more descriptive, but it sounds a bit weird as a parameter name.



---

archive/issue_comments_119062.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-10-30T23:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119062",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_119063.json:
```json
{
    "body": "<a id='comment:7'></a>\nI thought about adding lines to the \"empty face\", but I decided against it. There are certainly arguments for both. But in the end I decided against it because only lines would not be representable by a polyhedron. I don't have any reference, though. \n\nWhen I refactor the `Pohlyhedron` class for ppl then I'll try to make `PolyhedronFace` derive from it. But right now its not feasible.\n\nI'll include your other suggestions and will post a patch in a couple of days.",
    "created_at": "2010-10-31T02:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119063",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>
I thought about adding lines to the "empty face", but I decided against it. There are certainly arguments for both. But in the end I decided against it because only lines would not be representable by a polyhedron. I don't have any reference, though. 

When I refactor the `Pohlyhedron` class for ppl then I'll try to make `PolyhedronFace` derive from it. But right now its not feasible.

I'll include your other suggestions and will post a patch in a couple of days.



---

archive/issue_comments_119064.json:
```json
{
    "body": "<a id='comment:8'></a>\n* capitalized `Hasse_diagram_from_incidences`.\n  * added input documentation to `PolyhedronFace` constructor.\n  * removed `faces_at_infinity` option and renamed `atoms_require_one_of` -> `required_atoms` .\n  * fixed caching in `Polyhedron.face_lattice()`.",
    "created_at": "2010-11-08T19:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119064",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
* capitalized `Hasse_diagram_from_incidences`.
  * added input documentation to `PolyhedronFace` constructor.
  * removed `faces_at_infinity` option and renamed `atoms_require_one_of` -> `required_atoms` .
  * fixed caching in `Polyhedron.face_lattice()`.



---

archive/issue_comments_119065.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-08T19:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119065",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_119066.json:
```json
{
    "body": "<a id='comment:9'></a>\nOne last pick - since `cone` module does not provide `Hasse_diagram` function anymore, it should not be mentioned at all in the beginning. I am fine with just removing the relevant paragraph completely, users should not use `IntegralRayCollection` anyway.",
    "created_at": "2010-11-08T19:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119066",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'></a>
One last pick - since `cone` module does not provide `Hasse_diagram` function anymore, it should not be mentioned at all in the beginning. I am fine with just removing the relevant paragraph completely, users should not use `IntegralRayCollection` anyway.



---

archive/issue_comments_119067.json:
```json
{
    "body": "<a id='comment:10'></a>\n\n```\napplying trac_9954_fix_face_lattice.patch\npatching file sage/geometry/polyhedra.py\nHunk #2 succeeded at 129 with fuzz 2 (offset 0 lines).\n```\n\n(I have #10024 and #10148 applied, since they are already merged.)",
    "created_at": "2010-11-08T20:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119067",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:10'></a>

```
applying trac_9954_fix_face_lattice.patch
patching file sage/geometry/polyhedra.py
Hunk #2 succeeded at 129 with fuzz 2 (offset 0 lines).
```

(I have #10024 and #10148 applied, since they are already merged.)



---

archive/issue_comments_119068.json:
```json
{
    "body": "<a id='comment:11'></a>\nI pulled the patches from #10024 and #10148 in front of this patch and fixed the module documentation.",
    "created_at": "2010-11-08T21:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119068",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
I pulled the patches from #10024 and #10148 in front of this patch and fixed the module documentation.



---

archive/issue_comments_119069.json:
```json
{
    "body": "Updated patch",
    "created_at": "2010-11-08T21:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119069",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_119070.json:
```json
{
    "body": "<a id='comment:12'></a>\nAttachment [trac_9954_fix_face_lattice.patch](tarball://root/attachments/some-uuid/ticket9954/trac_9954_fix_face_lattice.patch) by @novoselt created at 2010-11-08 21:33:17\n\nGreat! Positive review!",
    "created_at": "2010-11-08T21:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119070",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:12'></a>
Attachment [trac_9954_fix_face_lattice.patch](tarball://root/attachments/some-uuid/ticket9954/trac_9954_fix_face_lattice.patch) by @novoselt created at 2010-11-08 21:33:17

Great! Positive review!



---

archive/issue_comments_119071.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-08T21:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119071",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_025113.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-11T13:02:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9954#event-25113"
}
```



---

archive/issue_comments_119072.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.1.alpha1\"",
    "created_at": "2010-11-11T13:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119072",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.1.alpha1"



---

archive/issue_comments_119073.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-11T13:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9954#issuecomment-119073",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
