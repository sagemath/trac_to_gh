# Issue 9224: Unify sage-test and sage-ptest

archive/issues_009224.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mvngu"
    ],
    "body": "We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.\n\nRelated: #2379, #7993, #7995, #8641, #9225, #9243, #9316, #9739.\n\nCC:  @sagetrac-cwitty @dandrake @sagetrac-drkirkby @jhpalmieri @nexttime @wjp\n\nKeywords: **testlong maketest parallel race condition unique doctest directories**\n\nReviewer: **David Roe**\n\nComponent: **doctest coverage**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/9224_\n\n",
    "closed_at": "2013-02-22T21:34:00Z",
    "created_at": "2010-06-12T09:55:23Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Unify sage-test and sage-ptest",
    "type": "issue",
    "updated_at": "2013-02-22T21:34:00Z",
    "url": "https://github.com/sagemath/sage/issues/9224",
    "user": "https://github.com/qed777"
}
```
We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.

Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316, #9739.

CC:  @sagetrac-cwitty @dandrake @sagetrac-drkirkby @jhpalmieri @nexttime @wjp

Keywords: **testlong maketest parallel race condition unique doctest directories**

Reviewer: **David Roe**

Component: **doctest coverage**

_Issue created by migration from https://trac.sagemath.org/ticket/9224_





---

archive/issue_events_116848.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-06-12T09:55:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116848"
}
```



---

archive/issue_events_116849.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-06-12T09:55:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116849"
}
```



---

archive/issue_events_116850.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-06-12T09:55:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116850"
}
```



---

archive/issue_events_116851.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-06-12T09:55:23Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "subject": "https://github.com/qed777",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116851"
}
```



---

archive/issue_comments_077310.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nIt seems the merger is overdue, although I doubt I can work on it in the immediate future, e.g., before #8641 closes.\n\nWhat if we start with mapping `sage -t ...` to `sage -tp 1 ...`?",
    "created_at": "2010-06-12T10:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77310",
    "user": "https://github.com/qed777"
}
```

<div id="comment:1" align="right">comment:1</div>

It seems the merger is overdue, although I doubt I can work on it in the immediate future, e.g., before #8641 closes.

What if we start with mapping `sage -t ...` to `sage -tp 1 ...`?



---

archive/issue_comments_077311.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReplying to [@qed777](#comment:1):\n> What if we start with mapping `sage -t ...` to `sage -tp 1 ...`?\n\nThis sounds great to me. It immediately removes the code duplication and is very easy to implement. Perhaps it's worth asking on sage-devel about this, in case anyone knows of a substantive difference between \"-t\" and \"-tp 1\", but I think this is a good idea.",
    "created_at": "2010-06-15T04:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77311",
    "user": "https://github.com/dandrake"
}
```

<div id="comment:2" align="right">comment:2</div>

Replying to [@qed777](#comment:1):
> What if we start with mapping `sage -t ...` to `sage -tp 1 ...`?

This sounds great to me. It immediately removes the code duplication and is very easy to implement. Perhaps it's worth asking on sage-devel about this, in case anyone knows of a substantive difference between "-t" and "-tp 1", but I think this is a good idea.



---

archive/issue_comments_077312.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI'm looking at this, and it might be a bit trickier than I thought. Doing \"sage -tp 1 ...\" tests to see if Sage starts, which we don't want. That's easy to fix, though. What might be harder is that sage-ptest has some awful code in it. The test_file function, according to comments, is supposed to return a 4-tuple, but sometimes it returns a 3-tuple (line 122); there's a bare \"except\", which is probably not a good idea; the function that processes the tuples just mentioned does this:\n\n```\n  F = result[0]\n  ret = result[1]\n  finished_time = result[2]\n  ol = result[3]\n```\nThe \"result\" usually is a 4-tuple: (filename, return_code, time, some_string). But sometimes it returns a 3-tuple: (-5, 0, some_string). So the code above sometimes gets a filename for F, and sometimes gets the integer -5. Then there's this:\n\n```\n  if ol!=\"\" and (not ol.isspace()):\n        if (ol[len(ol)-1]==\"\\n\"):\n            ol=ol[0:len(ol)-1]\n        print ol\n```\nWhy is that not\n\n```\n  if ol and not ol.isspace():\n    print ol.rstrip()\n```\n? There is some strange stuff in sage-ptest.",
    "created_at": "2010-06-15T08:23:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77312",
    "user": "https://github.com/dandrake"
}
```

<div id="comment:3" align="right">comment:3</div>

I'm looking at this, and it might be a bit trickier than I thought. Doing "sage -tp 1 ..." tests to see if Sage starts, which we don't want. That's easy to fix, though. What might be harder is that sage-ptest has some awful code in it. The test_file function, according to comments, is supposed to return a 4-tuple, but sometimes it returns a 3-tuple (line 122); there's a bare "except", which is probably not a good idea; the function that processes the tuples just mentioned does this:

```
  F = result[0]
  ret = result[1]
  finished_time = result[2]
  ol = result[3]
```
The "result" usually is a 4-tuple: (filename, return_code, time, some_string). But sometimes it returns a 3-tuple: (-5, 0, some_string). So the code above sometimes gets a filename for F, and sometimes gets the integer -5. Then there's this:

```
  if ol!="" and (not ol.isspace()):
        if (ol[len(ol)-1]=="\n"):
            ol=ol[0:len(ol)-1]
        print ol
```
Why is that not

```
  if ol and not ol.isspace():
    print ol.rstrip()
```
? There is some strange stuff in sage-ptest.



---

archive/issue_comments_077313.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSee #9243 for a related ticket -- it feels weird to be or'ing return codes together when the basic return codes are not powers of 2.",
    "created_at": "2010-06-15T09:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77313",
    "user": "https://github.com/dandrake"
}
```

<div id="comment:4" align="right">comment:4</div>

See #9243 for a related ticket -- it feels weird to be or'ing return codes together when the basic return codes are not powers of 2.



---

archive/issue_comments_077314.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.\n \n-Related: #2379, #7993, #7995, #8641.\n+Related: #2379, #7993, #7995, #8641, #9316.\n``````\n",
    "created_at": "2010-06-26T03:17:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77314",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.
 
-Related: #2379, #7993, #7995, #8641.
+Related: #2379, #7993, #7995, #8641, #9316.
``````




---

archive/issue_comments_077315.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.\n \n-Related: #2379, #7993, #7995, #8641, #9316.\n+Related: #2379, #7993, #7995, #8641, #9243, #9316.\n``````\n",
    "created_at": "2010-07-07T03:36:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77315",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.
 
-Related: #2379, #7993, #7995, #8641, #9316.
+Related: #2379, #7993, #7995, #8641, #9243, #9316.
``````




---

archive/issue_comments_077316.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI've opened #9225 for possible new [optional] doctesting features.  Feel free to make suggestions.",
    "created_at": "2010-07-07T03:36:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77316",
    "user": "https://github.com/qed777"
}
```

<div id="comment:6" align="right">comment:6</div>

I've opened #9225 for possible new [optional] doctesting features.  Feel free to make suggestions.



---

archive/issue_comments_077317.json:
```json
{
    "body": "Attachment: **[doctest.py.gz](https://github.com/sagemath/sage/files/ticket9224/doctest.py.gz)**\n\n`Doctester` class pseudo-interface.  Not a patch.",
    "created_at": "2010-07-15T01:49:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77317",
    "user": "https://github.com/qed777"
}
```

Attachment: **[doctest.py.gz](https://github.com/sagemath/sage/files/ticket9224/doctest.py.gz)**

`Doctester` class pseudo-interface.  Not a patch.



---

archive/issue_comments_077318.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI've attached a first take on an interface for a Sage `Doctester` class.  Please see [comment:ticket:9225:4 this comment] at #9225 for possible uses.  I'm not sure whether to put this in the Sage library (under `misc/`) or in `SAGE_LOCAL/bin`.  But I think we'll need to add `sage-doctest` to the unification efforts.\n\nThoughts?",
    "created_at": "2010-07-15T01:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77318",
    "user": "https://github.com/qed777"
}
```

<div id="comment:8" align="right">comment:8</div>

I've attached a first take on an interface for a Sage `Doctester` class.  Please see [comment:ticket:9225:4 this comment] at #9225 for possible uses.  I'm not sure whether to put this in the Sage library (under `misc/`) or in `SAGE_LOCAL/bin`.  But I think we'll need to add `sage-doctest` to the unification efforts.

Thoughts?



---

archive/issue_comments_077319.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIf the interface above (or a variation) is reasonable, we could populate `doctest.py` with most of the non-parsing-related, non-redundant parts of `sage-doctest` and `sage-(p)test`.  To ensure that we test `doctest.py` regularly, I suggest we put it in the sage repository, under `misc/`.  Then we'd put just the command-line parsing code in a `sage-test` in the scripts repository.  This script would `import sage.misc.doctest` and instantiate/call a `Doctester` object to run the tests.\n\nMore keyword arguments for `Doctester`'s constructor: `timeout`, `timeout_long`, `testdir`, and various Valgrind settings.",
    "created_at": "2010-07-15T07:32:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77319",
    "user": "https://github.com/qed777"
}
```

<div id="comment:9" align="right">comment:9</div>

If the interface above (or a variation) is reasonable, we could populate `doctest.py` with most of the non-parsing-related, non-redundant parts of `sage-doctest` and `sage-(p)test`.  To ensure that we test `doctest.py` regularly, I suggest we put it in the sage repository, under `misc/`.  Then we'd put just the command-line parsing code in a `sage-test` in the scripts repository.  This script would `import sage.misc.doctest` and instantiate/call a `Doctester` object to run the tests.

More keyword arguments for `Doctester`'s constructor: `timeout`, `timeout_long`, `testdir`, and various Valgrind settings.



---

archive/issue_comments_077320.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.\n \n-Related: #2379, #7993, #7995, #8641, #9243, #9316.\n+Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316.\n``````\n",
    "created_at": "2010-07-15T07:32:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77320",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.
 
-Related: #2379, #7993, #7995, #8641, #9243, #9316.
+Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316.
``````




---

archive/issue_comments_077321.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nJust requesting feedback on re-{design,writ,refactor}-ing the doctesting system --- but only when it's convenient, as I can't work on this immediately.",
    "created_at": "2010-07-16T21:43:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77321",
    "user": "https://github.com/qed777"
}
```

<div id="comment:10" align="right">comment:10</div>

Just requesting feedback on re-{design,writ,refactor}-ing the doctesting system --- but only when it's convenient, as I can't work on this immediately.



---

archive/issue_comments_077322.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI do like the idea of merging sage-test and sage-ptest.\n\nYour Doctester API seems reasonable at first glance; there might have to be minor changes when it's actually implemented, but it's surely basically sound.  (I mean that it has to be possible to split sage-(p)test into pieces, one of which implements your Doctester API, and one which calls it.)\n\nMerging sage-doctest into the same code seems trickier, especially if you mean it to also run in the same process.\n\nI'm afraid I'm not giving very good feedback... \"sounds like a good idea, but it might be hard\" :)  The problem is that at the moment I don't understand sage-test, sage-ptest, and sage-doctest well enough to give more detailed comments.",
    "created_at": "2010-07-20T20:59:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77322",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:11" align="right">comment:11</div>

I do like the idea of merging sage-test and sage-ptest.

Your Doctester API seems reasonable at first glance; there might have to be minor changes when it's actually implemented, but it's surely basically sound.  (I mean that it has to be possible to split sage-(p)test into pieces, one of which implements your Doctester API, and one which calls it.)

Merging sage-doctest into the same code seems trickier, especially if you mean it to also run in the same process.

I'm afraid I'm not giving very good feedback... "sounds like a good idea, but it might be hard" :)  The problem is that at the moment I don't understand sage-test, sage-ptest, and sage-doctest well enough to give more detailed comments.



---

archive/issue_comments_077323.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nQuite awhile ago, I had some success with using nose ( http://code.google.com/p/python-nose/ ) to test Sage.  I'm not sure if I still have that code.  It might be something to look into since a number of projects use it for testing.",
    "created_at": "2010-08-07T06:18:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77323",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:12" align="right">comment:12</div>

Quite awhile ago, I had some success with using nose ( http://code.google.com/p/python-nose/ ) to test Sage.  I'm not sure if I still have that code.  It might be something to look into since a number of projects use it for testing.



---

archive/issue_comments_077324.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@mwhansen](#comment:12):\n> Quite awhile ago, I had some success with using nose ( http://code.google.com/p/python-nose/ ) to test Sage.  I'm not sure if I still have that code.  It might be something to look into since a number of projects use it for testing.\n\nSqlalchemy (a standard package in Sage) has a set of self-tests which rely on 'nose'. I did ask on sage-devel a few weeks back if that should be included in Sage, but what response I did get was negative. \n\nI'm keen we have more testing of the individual components of Sage. At the minute, few have spkg-check files, and as I say, at least sqlalchemy will not work without nose. \n\n#9281 has a list of all the standard packages and whether they have an spkg-check file. The number is depressing small - about 20% of them. \n\nDave",
    "created_at": "2010-08-07T06:45:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77324",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@mwhansen](#comment:12):
> Quite awhile ago, I had some success with using nose ( http://code.google.com/p/python-nose/ ) to test Sage.  I'm not sure if I still have that code.  It might be something to look into since a number of projects use it for testing.

Sqlalchemy (a standard package in Sage) has a set of self-tests which rely on 'nose'. I did ask on sage-devel a few weeks back if that should be included in Sage, but what response I did get was negative. 

I'm keen we have more testing of the individual components of Sage. At the minute, few have spkg-check files, and as I say, at least sqlalchemy will not work without nose. 

#9281 has a list of all the standard packages and whether they have an spkg-check file. The number is depressing small - about 20% of them. 

Dave



---

archive/issue_comments_077325.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI have some more comments (here just on `sage-ptest`) I'll post inline also here:\n\n```diff\ndiff --git a/sage-ptest b/sage-ptest\n--- a/sage-ptest\n+++ b/sage-ptest\n@@ -81,12 +81,18 @@\n     Returns true if the file should not be tested\n     \"\"\"\n     if not os.path.exists(F):\n+        # XXX IMHO this should never happen; in case it does, it's certainly\n+        #     an error to be reported (either filesystem, or bad name specified\n+        #     on the command line). -leif\n         return True\n     G = abspath(F)\n     i = G.rfind(os.path.sep)\n+    # XXX The following should IMHO be performed in populatefilelist():\n+    #     (Currently, populatefilelist() only looks for \"__nodoctest__\".)\n     if os.path.exists(os.path.join(G[:i], 'nodoctest.py')):\n         printmutex.acquire()\n         print \"%s (skipping) -- nodoctest.py file in directory\"%abs(F)\n+        sys.stdout.flush()\n         printmutex.release()\n         return True\n     filenm = os.path.split(F)[1]\n@@ -95,6 +101,7 @@\n         return True\n     if G.find(os.path.join('doc', 'output')) != -1:\n         return True\n+    # XXX The following is (also/already) handled in populatefilelist():\n     if not (os.path.splitext(F)[1] in ['.py', '.pyx', '.tex', '.pxi', '.sage', '.rst']):\n         return True\n     return False\n@@ -115,6 +122,7 @@\n     for i in range(0,numiteration):\n         os.chdir(os.path.dirname(F))\n         command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)\n+        # FIXME: Why call bash here? (Also, we use 'shell=True' below anyway.)\n         s = 'bash -c \"%s %s > %s\" ' % (command, filestr, outfile.name)\n         try:\n             t = time.time()\n@@ -161,10 +169,12 @@\n         print sage_test_cmd(F[len(CUR)+1:])\n     else:\n         print abs(F)\n+    sys.stdout.flush()\n     if ol!=\"\" and (not ol.isspace()):\n         if (ol[len(ol)-1]==\"\\n\"):\n             ol=ol[0:len(ol)-1]\n         print ol\n+        sys.stdout.flush()\n     time_dict[abs_sage_path(F)] = finished_time\n     if XML_RESULTS:\n         t = finished_time\n@@ -192,6 +202,7 @@\n         \"\"\".strip() % locals())\n         f.close()\n     print \"\\t [%.1f s]\"%(finished_time)\n+    sys.stdout.flush()\n \n def infiles_cmp(a,b):\n     \"\"\"\n@@ -231,7 +242,14 @@\n                 base, ext = os.path.splitext(F)\n                 if not (ext in ['.sage', '.py', '.pyx', '.tex', '.pxi', '.rst']):\n                     continue\n-                elif '__nodoctest__' in files:\n+                elif '__nodoctest__' in files: # XXX Shouldn't this be 'lfiles'?\n+                    # Also, this test should IMHO be in the outer loop (1 level).\n+                    # Furthermore, the current practice is to put \"nodoctest.py\"\n+                    # files in the directories that should be skipped, not\n+                    # \"__nodoctest__\". (I haven't found a single instance of the\n+                    # latter in Sage 4.6.1.alpha3.)\n+                    # \"nodoctest.py\" is handled in skip() (!), to also be fixed.\n+                    # -leif\n                     continue\n                 appendstr = os.path.join(root,F)\n                 if skip(appendstr):\n@@ -252,6 +270,9 @@\n     argv = [X for X in argv if X[0] != '-']\n \n     try: \n+        # FIXME: Nice, but <NUMTHREADS> should immediately follow '-tp' etc.,\n+        #        i.e., be the next argument. We might have file or directory\n+        #        names that properly convert to an int...\n         numthreads = int(argv[1])\n         infiles = argv[2:]\n     except ValueError: # can't convert first arg to an integer: arg was probably omitted\n```\n(This is against Sage 4.6.1.alpha3.)\n\nThe comments all refer to inconsistencies; the only actual change is flushing the output since it currently comes in bursts, which is IMHO odd for watching it. I don't think this measurably slows down doctesting...",
    "created_at": "2010-12-16T02:31:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77325",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

I have some more comments (here just on `sage-ptest`) I'll post inline also here:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -81,12 +81,18 @@
     Returns true if the file should not be tested
     """
     if not os.path.exists(F):
+        # XXX IMHO this should never happen; in case it does, it's certainly
+        #     an error to be reported (either filesystem, or bad name specified
+        #     on the command line). -leif
         return True
     G = abspath(F)
     i = G.rfind(os.path.sep)
+    # XXX The following should IMHO be performed in populatefilelist():
+    #     (Currently, populatefilelist() only looks for "__nodoctest__".)
     if os.path.exists(os.path.join(G[:i], 'nodoctest.py')):
         printmutex.acquire()
         print "%s (skipping) -- nodoctest.py file in directory"%abs(F)
+        sys.stdout.flush()
         printmutex.release()
         return True
     filenm = os.path.split(F)[1]
@@ -95,6 +101,7 @@
         return True
     if G.find(os.path.join('doc', 'output')) != -1:
         return True
+    # XXX The following is (also/already) handled in populatefilelist():
     if not (os.path.splitext(F)[1] in ['.py', '.pyx', '.tex', '.pxi', '.sage', '.rst']):
         return True
     return False
@@ -115,6 +122,7 @@
     for i in range(0,numiteration):
         os.chdir(os.path.dirname(F))
         command = os.path.join(SAGE_ROOT, 'local', 'bin', 'sage-%s' % cmd)
+        # FIXME: Why call bash here? (Also, we use 'shell=True' below anyway.)
         s = 'bash -c "%s %s > %s" ' % (command, filestr, outfile.name)
         try:
             t = time.time()
@@ -161,10 +169,12 @@
         print sage_test_cmd(F[len(CUR)+1:])
     else:
         print abs(F)
+    sys.stdout.flush()
     if ol!="" and (not ol.isspace()):
         if (ol[len(ol)-1]=="\n"):
             ol=ol[0:len(ol)-1]
         print ol
+        sys.stdout.flush()
     time_dict[abs_sage_path(F)] = finished_time
     if XML_RESULTS:
         t = finished_time
@@ -192,6 +202,7 @@
         """.strip() % locals())
         f.close()
     print "\t [%.1f s]"%(finished_time)
+    sys.stdout.flush()
 
 def infiles_cmp(a,b):
     """
@@ -231,7 +242,14 @@
                 base, ext = os.path.splitext(F)
                 if not (ext in ['.sage', '.py', '.pyx', '.tex', '.pxi', '.rst']):
                     continue
-                elif '__nodoctest__' in files:
+                elif '__nodoctest__' in files: # XXX Shouldn't this be 'lfiles'?
+                    # Also, this test should IMHO be in the outer loop (1 level).
+                    # Furthermore, the current practice is to put "nodoctest.py"
+                    # files in the directories that should be skipped, not
+                    # "__nodoctest__". (I haven't found a single instance of the
+                    # latter in Sage 4.6.1.alpha3.)
+                    # "nodoctest.py" is handled in skip() (!), to also be fixed.
+                    # -leif
                     continue
                 appendstr = os.path.join(root,F)
                 if skip(appendstr):
@@ -252,6 +270,9 @@
     argv = [X for X in argv if X[0] != '-']
 
     try: 
+        # FIXME: Nice, but <NUMTHREADS> should immediately follow '-tp' etc.,
+        #        i.e., be the next argument. We might have file or directory
+        #        names that properly convert to an int...
         numthreads = int(argv[1])
         infiles = argv[2:]
     except ValueError: # can't convert first arg to an integer: arg was probably omitted
```
(This is against Sage 4.6.1.alpha3.)

The comments all refer to inconsistencies; the only actual change is flushing the output since it currently comes in bursts, which is IMHO odd for watching it. I don't think this measurably slows down doctesting...



---

archive/issue_comments_077326.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.\n \n-Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316.\n+Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316, #9739.\n``````\n",
    "created_at": "2010-12-16T02:47:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77326",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 We currently have separate single and multi-threaded Sage doctest scripts.  In particular, `sage -t ...` invokes `SAGE_ROOT/local/bin/sage-test` and `sage -tp ...` invokes `sage-ptest`.  These files share many lines of almost functionally identical identical code.  Unifying these scripts should make it easier to maintain and extend the Sage doctest system.
 
-Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316.
+Related: #2379, #7993, #7995, #8641, #9225, #9243, #9316, #9739.
``````




---

archive/issue_comments_077327.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nSome random comments:\n\n1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.\n\n2. Note that the script `sage-test` creates `SAGE_TESTDIR` as `DOT_SAGE/tmp`, and then creates a further subdirectory `tmp` of this.  I don't think there is any reason for this subdirectory to exist.\n\n3. Note also `sage-maketest` which writes files to `SAGE_TESTDIR`.  (It also has a different default setting for this variable.)  This script may not require any modification, but it's another one to keep an eye on.",
    "created_at": "2011-09-11T17:32:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77327",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:16" align="right">comment:16</div>

Some random comments:

1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.

2. Note that the script `sage-test` creates `SAGE_TESTDIR` as `DOT_SAGE/tmp`, and then creates a further subdirectory `tmp` of this.  I don't think there is any reason for this subdirectory to exist.

3. Note also `sage-maketest` which writes files to `SAGE_TESTDIR`.  (It also has a different default setting for this variable.)  This script may not require any modification, but it's another one to keep an eye on.



---

archive/issue_comments_077328.json:
```json
{
    "body": "Changed keywords from none to **testlong maketest parallel race condition unique doctest directories**",
    "created_at": "2011-09-11T18:40:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77328",
    "user": "https://github.com/nexttime"
}
```

Changed keywords from none to **testlong maketest parallel race condition unique doctest directories**



---

archive/issue_comments_077329.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@jhpalmieri](#comment:16):\n> 1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.\n\nAt least for the *temporary* files, I think the name of the subdirectory should also contain the hostname and the PID of the parent process (just like `sage-ptest` now manages this, cf. #9739), to support e.g. running `make testlong` simultaneously from different machines sharing the same filesystem, i.e., sharing the `DOT_SAGE` directory or whatever `SAGE_TESTDIR` might be, and also running different instances of e.g. `make testlong` or `sage -t ...` *on the same machine* at the same time.\n\n(At least Dave requested this feature, cf. [comment:ticket:9739:19 his comment here] and [comment:ticket:9739:21 here], and [comment:ticket:9739:83 my suggestion].)\n\nTimings should perhaps have their own, persistent directory. Either we accept the possibility of race conditions there, or we should add e.g. the hostname and the time (the former reasonable anyway), eventually also the PID, to the filenames.\n\n\n\n\n> 2. Note that the script `sage-test` creates `SAGE_TESTDIR` as `DOT_SAGE/tmp`, and then creates a further subdirectory `tmp` of this.  I don't think there is any reason for this subdirectory to exist.\n\nYep, that's odd. We have a whole bunch of `tmp` / `temp` subdirectories all around.",
    "created_at": "2011-09-11T18:40:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77329",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@jhpalmieri](#comment:16):
> 1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.

At least for the *temporary* files, I think the name of the subdirectory should also contain the hostname and the PID of the parent process (just like `sage-ptest` now manages this, cf. #9739), to support e.g. running `make testlong` simultaneously from different machines sharing the same filesystem, i.e., sharing the `DOT_SAGE` directory or whatever `SAGE_TESTDIR` might be, and also running different instances of e.g. `make testlong` or `sage -t ...` *on the same machine* at the same time.

(At least Dave requested this feature, cf. [comment:ticket:9739:19 his comment here] and [comment:ticket:9739:21 here], and [comment:ticket:9739:83 my suggestion].)

Timings should perhaps have their own, persistent directory. Either we accept the possibility of race conditions there, or we should add e.g. the hostname and the time (the former reasonable anyway), eventually also the PID, to the filenames.




> 2. Note that the script `sage-test` creates `SAGE_TESTDIR` as `DOT_SAGE/tmp`, and then creates a further subdirectory `tmp` of this.  I don't think there is any reason for this subdirectory to exist.

Yep, that's odd. We have a whole bunch of `tmp` / `temp` subdirectories all around.



---

archive/issue_comments_077330.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@nexttime](#comment:17):\n> Replying to [@jhpalmieri](#comment:16):\n> > 1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.\n\n> \n> At least for the *temporary* files, I think the name of the subdirectory should also contain the hostname and the PID of the parent process.\n\nRight, my intention was, by default anyway, to create such a temporary directory inside SAGE_TESTDIR.  Or we can have separate environment variables for the (parent of the) testing directory and the directory containing timing files, etc.",
    "created_at": "2011-09-11T19:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77330",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@nexttime](#comment:17):
> Replying to [@jhpalmieri](#comment:16):
> > 1. If we keep `SAGE_TESTDIR` as a subdirectory of `DOT_SAGE`, we should call it `DOT_SAGE/testing/` instead of `DOT_SAGE/tmp/`.  This describes the directory better, and the directory can contain timing files, for example, which are intended to persist, not be temporary.

> 
> At least for the *temporary* files, I think the name of the subdirectory should also contain the hostname and the PID of the parent process.

Right, my intention was, by default anyway, to create such a temporary directory inside SAGE_TESTDIR.  Or we can have separate environment variables for the (parent of the) testing directory and the directory containing timing files, etc.



---

archive/issue_comments_077331.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nNote that Robert Bradshaw has a bunch of code that I'm working on incorporating into Sage that redoes the doctesting framework (and adds various nice features).  See #12415.",
    "created_at": "2012-02-06T04:46:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77331",
    "user": "https://github.com/roed314"
}
```

<div id="comment:19" align="right">comment:19</div>

Note that Robert Bradshaw has a bunch of code that I'm working on incorporating into Sage that redoes the doctesting framework (and adds various nice features).  See #12415.



---

archive/issue_events_116852.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T21:34:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116852"
}
```



---

archive/issue_events_116853.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T21:34:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116853"
}
```



---

archive/issue_comments_077332.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nSuperseded by #12415.",
    "created_at": "2013-02-22T21:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77332",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Superseded by #12415.



---

archive/issue_comments_077333.json:
```json
{
    "body": "Reviewer: **David Roe**",
    "created_at": "2013-02-22T21:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/9224#issuecomment-77333",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **David Roe**



---

archive/issue_events_116854.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T21:34:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/9224",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/9224#event-116854"
}
```
