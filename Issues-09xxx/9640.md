# Issue 9640: Change PARI error catching mechanism

archive/issues_009640.json:
```json
{
    "body": "Currently, the exceptions thrown by PARI are rather cryptic, like\n\n```\nTraceback (most recent call last):\n...\nPariError:  (15)\n```\n\nThis ticket does the following:\n\n- Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n\n- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.\n\n- Introduce a new function `sig_error()` to callback to the interrupt/signal handling code to handle errors which aren't signals and use that for PARI.\n\nApply: [attachment:9640-pari_error_callbacks_v2.patch]\n\n\nAssignee: @williamstein\n\nCC:  @nexttime @jdemeyer\n\nKeywords: pari error interrupt\n\nReviewer: Jeroen Demeyer, Peter Bruin\n\nAuthor: Peter Bruin, Jeroen Demeyer\n\nMerged: sage-5.13.beta3\n\nDependencies: #14029, #13311\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/9640\n\n",
    "closed_at": "2013-11-06T12:48:56Z",
    "created_at": "2010-07-29T15:47:12Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Change PARI error catching mechanism",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/9640",
    "user": "https://github.com/jdemeyer"
}
```
Currently, the exceptions thrown by PARI are rather cryptic, like

```
Traceback (most recent call last):
...
PariError:  (15)
```

This ticket does the following:

- Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.

- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.

- Introduce a new function `sig_error()` to callback to the interrupt/signal handling code to handle errors which aren't signals and use that for PARI.

Apply: [attachment:9640-pari_error_callbacks_v2.patch]


Assignee: @williamstein

CC:  @nexttime @jdemeyer

Keywords: pari error interrupt

Reviewer: Jeroen Demeyer, Peter Bruin

Author: Peter Bruin, Jeroen Demeyer

Merged: sage-5.13.beta3

Dependencies: #14029, #13311

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/9640





---

archive/issue_comments_111792.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,6 +6,6 @@\n PariError:  (15)\n ```\n \n-Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw PariError.  We should change to using cb_pari_handle_exception() instead of err_catch() to catch PARI exceptions.\n+Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n \n-Dependencies: #9343, #9636\n+Dependencies: #9678\n``````\n",
    "created_at": "2010-09-27T10:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111792",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,6 +6,6 @@
 PariError:  (15)
 ```
 
-Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw PariError.  We should change to using cb_pari_handle_exception() instead of err_catch() to catch PARI exceptions.
+Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.
 
-Dependencies: #9343, #9636
+Dependencies: #9678
``````




---

archive/issue_comments_111793.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2010-09-27T11:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111793",
    "user": "https://github.com/nexttime"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_111794.json:
```json
{
    "body": "Old patch for reference",
    "created_at": "2010-10-17T18:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111794",
    "user": "https://github.com/jdemeyer"
}
```

Old patch for reference



---

archive/issue_comments_111795.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [9640old.patch](tarball://root/attachments/some-uuid/ticket9640/9640old.patch) by @jdemeyer created at 2010-10-17 18:32:31",
    "created_at": "2010-10-17T18:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111795",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Attachment [9640old.patch](tarball://root/attachments/some-uuid/ticket9640/9640old.patch) by @jdemeyer created at 2010-10-17 18:32:31



---

archive/issue_comments_111796.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,4 +8,4 @@\n \n Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n \n-Dependencies: #9678\n+Dependencies: #10115, #9893, #9678\n``````\n",
    "created_at": "2010-10-17T18:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111796",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,4 +8,4 @@
 
 Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.
 
-Dependencies: #9678
+Dependencies: #10115, #9893, #9678
``````




---

archive/issue_comments_111797.json:
```json
{
    "body": "Changing keywords from \"\" to \"pari error interrupt\".",
    "created_at": "2010-10-17T18:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111797",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "pari error interrupt".



---

archive/issue_events_024034.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9640#event-24034"
}
```



---

archive/issue_comments_111798.json:
```json
{
    "body": "<a id='comment:6'></a>I am working on a patch that does the following things suggested by the ticket description:\n- Rewrite `pari_catch_sig_on()` and `pari_catch_sig_off()` to use the callbacks `cb_pari_handle_exception` and `cb_pari_err_recover` (defined by the PARI library) in combination with `sig_on()`/`sig_off()`, as opposed to the additional `setjmp()` of the current implementation.\n- Catch output sent to `pariErr` and store it in a string attribute `pari_instance.error_string` for later use by `PariError`.\n\nIt seems to work quite well; the only doctest failures I've seen so far are a few tests expecting a PARI warning message.  With the patch, these are not printed because they also go to `pariErr`.\n\nTo be done:\n- Make `PariError` aware of the stored string to give a more informative error message.  This should probably simply be extracted from the lines starting with `***` in `pari_instance.error_string`.\n- Minor change in PARI: send any extra newline at the start of the error message to `pariErr` instead of `pariOut` (this happens if the last printed character was not a newline).\n- Distinguish between errors and warnings; the latter should probably be printed to `stderr` as before.  This should be done either by filtering the text sent to `pariErr` or by having `pari_catch_sig_off()` check if `pari_instance.error_string` is non-empty even if no error occurred.\n\nThis may make #14894 redundant, although that ticket could be used for general things to be done for the upgrade to PARI 2.6.",
    "created_at": "2013-09-11T14:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111798",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>I am working on a patch that does the following things suggested by the ticket description:
- Rewrite `pari_catch_sig_on()` and `pari_catch_sig_off()` to use the callbacks `cb_pari_handle_exception` and `cb_pari_err_recover` (defined by the PARI library) in combination with `sig_on()`/`sig_off()`, as opposed to the additional `setjmp()` of the current implementation.
- Catch output sent to `pariErr` and store it in a string attribute `pari_instance.error_string` for later use by `PariError`.

It seems to work quite well; the only doctest failures I've seen so far are a few tests expecting a PARI warning message.  With the patch, these are not printed because they also go to `pariErr`.

To be done:
- Make `PariError` aware of the stored string to give a more informative error message.  This should probably simply be extracted from the lines starting with `***` in `pari_instance.error_string`.
- Minor change in PARI: send any extra newline at the start of the error message to `pariErr` instead of `pariOut` (this happens if the last printed character was not a newline).
- Distinguish between errors and warnings; the latter should probably be printed to `stderr` as before.  This should be done either by filtering the text sent to `pariErr` or by having `pari_catch_sig_off()` check if `pari_instance.error_string` is non-empty even if no error occurred.

This may make #14894 redundant, although that ticket could be used for general things to be done for the upgrade to PARI 2.6.



---

archive/issue_comments_111799.json:
```json
{
    "body": "Attachment [9640-pari_error_handling.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_handling.patch) by @pjbruin created at 2013-09-11 15:22:35\n\nbased on 5.12.beta4 + #15124",
    "created_at": "2013-09-11T15:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111799",
    "user": "https://github.com/pjbruin"
}
```

Attachment [9640-pari_error_handling.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_handling.patch) by @pjbruin created at 2013-09-11 15:22:35

based on 5.12.beta4 + #15124



---

archive/issue_comments_111800.json:
```json
{
    "body": "Changing work_issues from \"\" to \"see comment 6\"",
    "created_at": "2013-09-11T15:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111800",
    "user": "https://github.com/pjbruin"
}
```

Changing work_issues from "" to "see comment 6"



---

archive/issue_comments_111801.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-09-11T15:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111801",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_111802.json:
```json
{
    "body": "<a id='comment:7'></a>The attached patch passes doctests on x86_64 GNU/Linux, except for two tests expecting a PARI warning (see above).",
    "created_at": "2013-09-11T15:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111802",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>The attached patch passes doctests on x86_64 GNU/Linux, except for two tests expecting a PARI warning (see above).



---

archive/issue_comments_111803.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-09-11T15:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111803",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_111804.json:
```json
{
    "body": "<a id='comment:9'></a>It would be better practice to move `_pari_init_err()`, `_pari_handle_exception()` and `_pari_err_recover()` from `pari_err.h` to a C file or to translate them to Cython.  At the moment I don't think it is worth the trouble.",
    "created_at": "2013-09-11T15:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111804",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:9'></a>It would be better practice to move `_pari_init_err()`, `_pari_handle_exception()` and `_pari_err_recover()` from `pari_err.h` to a C file or to translate them to Cython.  At the moment I don't think it is worth the trouble.



---

archive/issue_comments_111805.json:
```json
{
    "body": "Changing author from \"Jeroen Demeyer\" to \"Peter Bruin\"",
    "created_at": "2013-09-11T15:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111805",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "Jeroen Demeyer" to "Peter Bruin"



---

archive/issue_comments_111806.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-09-12T19:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111806",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_111807.json:
```json
{
    "body": "Changing work_issues from \"see comment 6\" to \"\"",
    "created_at": "2013-09-12T19:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111807",
    "user": "https://github.com/pjbruin"
}
```

Changing work_issues from "see comment 6" to ""



---

archive/issue_comments_111808.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,6 +6,11 @@\n PariError:  (15)\n ```\n \n-Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n+This ticket does the following:\n \n-Dependencies: #10115, #9893, #9678\n+- Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n+\n+- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)\n+\n+Apply: [attachment:9640-pari_error_callbacks.patch]\n+\n``````\n",
    "created_at": "2013-09-12T19:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111808",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,6 +6,11 @@
 PariError:  (15)
 ```
 
-Using a mechanism similar to #9636, it should be possible to catch the full text of the exception and use it to throw `PariError`.  We should change to using `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.
+This ticket does the following:
 
-Dependencies: #10115, #9893, #9678
+- Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.
+
+- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)
+
+Apply: [attachment:9640-pari_error_callbacks.patch]
+
``````




---

archive/issue_comments_111809.json:
```json
{
    "body": "<a id='comment:10'></a>The latest patch does everything that I think it should do.  I hope it is reasonably self-explanatory.  A few remarks:\n\n- The error text is now passed to `PariError` and can be accessed using `PariError.errtext()`; is is not printed automatically.  Using this text to improve messages like `PariError:  (15)` will probably have to wait until another ticket.  (Edit: `user` errors are an exception, since they are converted into `RuntimeError`; here we append the error text to the currently used \"PARI user exception\".)\n\n- There is no problem with PARI sending escape sequences for colours in error messages; this is disabled by default.\n\n- The printing of a possible extra newline before the error message is easily avoided using `pari_set_last_newline(1)`.\n\n- The callback functions are now Cython functions in the new file `pari_error.pyx`.  It is important that this does *not* include `pari_err.pxi`; because of the way Cython imports functions, `pari_err.pxi` and `pari_err.h` use function pointers with the same names as the functions defined in `pari_error.pyx`.",
    "created_at": "2013-09-12T19:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111809",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>The latest patch does everything that I think it should do.  I hope it is reasonably self-explanatory.  A few remarks:

- The error text is now passed to `PariError` and can be accessed using `PariError.errtext()`; is is not printed automatically.  Using this text to improve messages like `PariError:  (15)` will probably have to wait until another ticket.  (Edit: `user` errors are an exception, since they are converted into `RuntimeError`; here we append the error text to the currently used "PARI user exception".)

- There is no problem with PARI sending escape sequences for colours in error messages; this is disabled by default.

- The printing of a possible extra newline before the error message is easily avoided using `pari_set_last_newline(1)`.

- The callback functions are now Cython functions in the new file `pari_error.pyx`.  It is important that this does *not* include `pari_err.pxi`; because of the way Cython imports functions, `pari_err.pxi` and `pari_err.h` use function pointers with the same names as the functions defined in `pari_error.pyx`.



---

archive/issue_comments_111810.json:
```json
{
    "body": "<a id='comment:11'></a>Patchbot:\n\n```\napply 9640-pari_error_callbacks.patch\u200b\n```",
    "created_at": "2013-09-23T10:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111810",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:11'></a>Patchbot:

```
apply 9640-pari_error_callbacks.patch​
```



---

archive/issue_comments_111811.json:
```json
{
    "body": "<a id='comment:12'></a>Why not set `cb_pari_handle_exception = _pari_handle_exception` globally and have `pari_catch_sig_on()` simply be **equal** to `sig_on()` (and then of course change `pari_catch_sig_on()` back to `sig_on()`).",
    "created_at": "2013-10-03T09:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111811",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Why not set `cb_pari_handle_exception = _pari_handle_exception` globally and have `pari_catch_sig_on()` simply be **equal** to `sig_on()` (and then of course change `pari_catch_sig_on()` back to `sig_on()`).



---

archive/issue_comments_111812.json:
```json
{
    "body": "<a id='comment:13'></a>Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...",
    "created_at": "2013-10-03T10:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111812",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...



---

archive/issue_comments_111813.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [jdemeyer](#comment%3A12):\n> Why not set `cb_pari_handle_exception = _pari_handle_exception` globally and have `pari_catch_sig_on()` simply be **equal** to `sig_on()` (and then of course change `pari_catch_sig_on()` back to `sig_on()`).\n\nGood question.  That would mean we simply always have PARI exception handling enabled, which would be more efficient and should not make any difference since PARI shouldn't be called outside of `sig_on()/sig_off()` anyway.  I'll try it out.",
    "created_at": "2013-10-03T10:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111813",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:14'></a>Replying to [jdemeyer](#comment%3A12):
> Why not set `cb_pari_handle_exception = _pari_handle_exception` globally and have `pari_catch_sig_on()` simply be **equal** to `sig_on()` (and then of course change `pari_catch_sig_on()` back to `sig_on()`).

Good question.  That would mean we simply always have PARI exception handling enabled, which would be more efficient and should not make any difference since PARI shouldn't be called outside of `sig_on()/sig_off()` anyway.  I'll try it out.



---

archive/issue_comments_111814.json:
```json
{
    "body": "<a id='comment:15'></a>Anyway, I am thinking about a review patch so I will make these changes myself.\n\nPeter, is there any chance you could review #14029 and #13311 because those tickets also make changes to the interrupt code.",
    "created_at": "2013-10-03T10:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111814",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Anyway, I am thinking about a review patch so I will make these changes myself.

Peter, is there any chance you could review #14029 and #13311 because those tickets also make changes to the interrupt code.



---

archive/issue_comments_111815.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [jdemeyer](#comment%3A13):\n> Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...\n\nWhy `abort()` and not `raise(SIGUSR1)` or another signal code?",
    "created_at": "2013-10-03T10:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111815",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'></a>Replying to [jdemeyer](#comment%3A13):
> Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...

Why `abort()` and not `raise(SIGUSR1)` or another signal code?



---

archive/issue_comments_111816.json:
```json
{
    "body": "<a id='comment:17'></a>I am thinking about merging (parts of) #10018 here, especially the doctests.",
    "created_at": "2013-10-03T10:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111816",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>I am thinking about merging (parts of) #10018 here, especially the doctests.



---

archive/issue_comments_111817.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [pbruin](#comment%3A16):\n> Replying to [jdemeyer](#comment%3A13):\n> > Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...\n\n> Why `abort()` and not `raise(SIGUSR1)` or another signal code?\nBecause we already handle `abort()` anyway and because I see no gain of adding an extra signal, with the risk that `SIGUSR1` is used by other Sage packages.",
    "created_at": "2013-10-03T10:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111817",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [pbruin](#comment%3A16):
> Replying to [jdemeyer](#comment%3A13):
> > Instead of using `sage_siglongjmp()`, I think it's safer to call `abort()` and use the normal signal handling mechanism. Otherwise we have to consider race conditions like a `SIGINT` arriving during the `sage_siglongjmp()` call...

> Why `abort()` and not `raise(SIGUSR1)` or another signal code?
Because we already handle `abort()` anyway and because I see no gain of adding an extra signal, with the risk that `SIGUSR1` is used by other Sage packages.



---

archive/issue_comments_111818.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [jdemeyer](#comment%3A18):\n> Replying to [pbruin](#comment%3A16):\n> > Why `abort()` and not `raise(SIGUSR1)` or another signal code?\n\n> Because we already handle `abort()` anyway and because I see no gain of adding an extra signal, with the risk that `SIGUSR1` is used by other Sage packages.\nBut we handle it by raising a new `RuntimeError`, among other things, unless I misunderstand `interrupt.c`.  So wouldn't the `SIGABRT` handler need to have a special case for the case where it is called in this way?  This would be rather inelegant.",
    "created_at": "2013-10-03T10:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111818",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>Replying to [jdemeyer](#comment%3A18):
> Replying to [pbruin](#comment%3A16):
> > Why `abort()` and not `raise(SIGUSR1)` or another signal code?

> Because we already handle `abort()` anyway and because I see no gain of adding an extra signal, with the risk that `SIGUSR1` is used by other Sage packages.
But we handle it by raising a new `RuntimeError`, among other things, unless I misunderstand `interrupt.c`.  So wouldn't the `SIGABRT` handler need to have a special case for the case where it is called in this way?  This would be rather inelegant.



---

archive/issue_comments_111819.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [pbruin](#comment%3A19):\n> This would be rather inelegant.\n\nI personally don't find it inelegant. In any case, we would encapsalate this through some call like `sig_error()`.",
    "created_at": "2013-10-03T10:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111819",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [pbruin](#comment%3A19):
> This would be rather inelegant.

I personally don't find it inelegant. In any case, we would encapsalate this through some call like `sig_error()`.



---

archive/issue_comments_111820.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A15):\n> Peter, is there any chance you could review #14029 and #13311 because those tickets also make changes to the interrupt code.\n\nNot very soon, unfortunately (lots of work at the moment), but I'll put my name in the CC list.",
    "created_at": "2013-10-03T20:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111820",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A15):
> Peter, is there any chance you could review #14029 and #13311 because those tickets also make changes to the interrupt code.

Not very soon, unfortunately (lots of work at the moment), but I'll put my name in the CC list.



---

archive/issue_comments_111821.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#14029, #13311\"",
    "created_at": "2013-11-01T10:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111821",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#14029, #13311"



---

archive/issue_comments_111822.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-11-01T10:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111822",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_111823.json:
```json
{
    "body": "<a id='comment:23'></a>Working/thinking about this...",
    "created_at": "2013-11-01T10:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111823",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Working/thinking about this...



---

archive/issue_comments_111824.json:
```json
{
    "body": "Attachment [9640-pari_error_callbacks.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_callbacks.patch) by @jdemeyer created at 2013-11-01 10:32:30\n\nbased on 5.12.beta4 + #15124",
    "created_at": "2013-11-01T10:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111824",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [9640-pari_error_callbacks.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_callbacks.patch) by @jdemeyer created at 2013-11-01 10:32:30

based on 5.12.beta4 + #15124



---

archive/issue_comments_111825.json:
```json
{
    "body": "Changing author from \"Peter Bruin\" to \"Peter Bruin, Jeroen Demeyer\"",
    "created_at": "2013-11-01T21:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111825",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Peter Bruin" to "Peter Bruin, Jeroen Demeyer"



---

archive/issue_comments_111826.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,5 +12,5 @@\n \n - Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)\n \n-Apply: [attachment:9640-pari_error_callbacks.patch]\n+Apply: [attachment:9640-pari_error_callbacks_v2.patch]\n \n``````\n",
    "created_at": "2013-11-01T21:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111826",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,5 +12,5 @@
 
 - Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)
 
-Apply: [attachment:9640-pari_error_callbacks.patch]
+Apply: [attachment:9640-pari_error_callbacks_v2.patch]
 
``````




---

archive/issue_comments_111827.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,7 +10,7 @@\n \n - Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.\n \n-- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)\n+- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.\n \n Apply: [attachment:9640-pari_error_callbacks_v2.patch]\n \n``````\n",
    "created_at": "2013-11-01T22:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111827",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,7 +10,7 @@
 
 - Use `cb_pari_handle_exception()` instead of `err_catch()` to catch PARI exceptions.
 
-- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.  (It is not printed automatically, but can be accessed via `PariError.errtext()`.)
+- Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.
 
 Apply: [attachment:9640-pari_error_callbacks_v2.patch]
 
``````




---

archive/issue_comments_111828.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,5 +12,7 @@\n \n - Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.\n \n+- Introduce a new function `sig_error()` to callback to the interrupt/signal handling code to handle errors which aren't signals and use that for PARI.\n+\n Apply: [attachment:9640-pari_error_callbacks_v2.patch]\n \n``````\n",
    "created_at": "2013-11-01T22:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111828",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,5 +12,7 @@
 
 - Using a mechanism similar to #9636, catch the full text of the exception and pass it to `PariError`.
 
+- Introduce a new function `sig_error()` to callback to the interrupt/signal handling code to handle errors which aren't signals and use that for PARI.
+
 Apply: [attachment:9640-pari_error_callbacks_v2.patch]
 
``````




---

archive/issue_comments_111829.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-01T22:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111829",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_111830.json:
```json
{
    "body": "<a id='comment:28'></a>What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?",
    "created_at": "2013-11-02T18:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111830",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:28'></a>What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?



---

archive/issue_comments_111831.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [pbruin](#comment%3A28):\n> What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?\n\nFor me, it can be removed. But it existed before (as a function `__errmessage()`) and one possible use would be to check that an error is of a given type without relying on the PARI error codes (for example, in pure Python code). Something like:\n\n```python\ntry:\n    pari.....\nexcept PariError as E:\n    if E.parimessage() == \"division by zero\":\n        raise ZeroDivisionError\n    else:\n        raise\n```\nPerhaps this is never going to happen, but at least the method `parimessage()` doesn't hurt either.",
    "created_at": "2013-11-02T20:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111831",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Replying to [pbruin](#comment%3A28):
> What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?

For me, it can be removed. But it existed before (as a function `__errmessage()`) and one possible use would be to check that an error is of a given type without relying on the PARI error codes (for example, in pure Python code). Something like:

```python
try:
    pari.....
except PariError as E:
    if E.parimessage() == "division by zero":
        raise ZeroDivisionError
    else:
        raise
```
Perhaps this is never going to happen, but at least the method `parimessage()` doesn't hurt either.



---

archive/issue_comments_111832.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [jdemeyer](#comment%3A29):\n> Replying to [pbruin](#comment%3A28):\n> > What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?\n\n> For me, it can be removed. But it existed before (as a function `__errmessage()`) and one possible use would be to check that an error is of a given type without relying on the PARI error codes (for example, in pure Python code).\nThat is a possibility.  On the other hand, the global variable `errmessage` is another thing that has disappeared in PARI 2.6.  It has been replaced by a function `const char *numerr_name(long numerr)` which returns e.g. `\"e_INV\"` for zero division errors.  This means that in the near future your example will probably look like\n\n```python\nif pari.numerr_name(E.errnum()) == \"e_INV\":\n    raise ZeroDivisionError\n```\nOf course, one could then think of a method of `PariError` encapsulating this if necessary, but `parimessage` would no longer be an appropriate name.\n\nFor the time being (at least until we switch to PARI 2.6) or unless someone really wants a method like this, I think it is easiest to just remove it.",
    "created_at": "2013-11-03T00:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111832",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:30'></a>Replying to [jdemeyer](#comment%3A29):
> Replying to [pbruin](#comment%3A28):
> > What is the use of `PariError.parimessage()`?  It doesn't seem to be used, and appears to normally be a substring of `PariError.__str__()`.  Do you have any application for it in mind, or can it be removed?

> For me, it can be removed. But it existed before (as a function `__errmessage()`) and one possible use would be to check that an error is of a given type without relying on the PARI error codes (for example, in pure Python code).
That is a possibility.  On the other hand, the global variable `errmessage` is another thing that has disappeared in PARI 2.6.  It has been replaced by a function `const char *numerr_name(long numerr)` which returns e.g. `"e_INV"` for zero division errors.  This means that in the near future your example will probably look like

```python
if pari.numerr_name(E.errnum()) == "e_INV":
    raise ZeroDivisionError
```
Of course, one could then think of a method of `PariError` encapsulating this if necessary, but `parimessage` would no longer be an appropriate name.

For the time being (at least until we switch to PARI 2.6) or unless someone really wants a method like this, I think it is easiest to just remove it.



---

archive/issue_comments_111833.json:
```json
{
    "body": "<a id='comment:31'></a>Attachment [9640-pari_error_callbacks_v2.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_callbacks_v2.patch) by @jdemeyer created at 2013-11-03 08:11:00\n\nRemoved `PariError.parimessage()` method and moved the `cdef extern from \"misc.h\":` block to the top of `gen.pyx`.",
    "created_at": "2013-11-03T08:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111833",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Attachment [9640-pari_error_callbacks_v2.patch](tarball://root/attachments/some-uuid/ticket9640/9640-pari_error_callbacks_v2.patch) by @jdemeyer created at 2013-11-03 08:11:00

Removed `PariError.parimessage()` method and moved the `cdef extern from "misc.h":` block to the top of `gen.pyx`.



---

archive/issue_comments_111834.json:
```json
{
    "body": "<a id='comment:32'></a>I'm happy with this now.  Hopefully someone wants to review it.",
    "created_at": "2013-11-04T12:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111834",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:32'></a>I'm happy with this now.  Hopefully someone wants to review it.



---

archive/issue_comments_111835.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-04T12:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111835",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_111836.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer, Peter Bruin\"",
    "created_at": "2013-11-04T12:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111836",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer, Peter Bruin"



---

archive/issue_comments_111837.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [pbruin](#comment%3A32):\n> I'm happy with this now.  Hopefully someone wants to review it.\n\nSince we both looked at eachother's work, I guess that counts as positive review.",
    "created_at": "2013-11-04T12:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111837",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [pbruin](#comment%3A32):
> I'm happy with this now.  Hopefully someone wants to review it.

Since we both looked at eachother's work, I guess that counts as positive review.



---

archive/issue_comments_111838.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-11-06T12:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111838",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_111839.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.13.beta3\"",
    "created_at": "2013-11-06T12:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/9640#issuecomment-111839",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.13.beta3"



---

archive/issue_events_024035.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-06T12:48:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/9640",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/9640#event-24035"
}
```
