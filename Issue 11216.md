# Issue 11216: Speed regression in #10548

Issue created by migration from Trac.

Original creator: robertwb

Original creation time: 2011-05-27 08:32:33

Assignee: tbd

In vanilla sage 4.6.2

```
sage: a=Integer(1000)
sage: b=int(1000)
sage: c=[0]
sage: %timeit c*a
625 loops, best of 3: 21.2 µs per loop
sage: %timeit c*b
625 loops, best of 3: 5.21 µs per loop
```


In vanilla sage 4.7.rc4

```
sage: a=Integer(1000)
sage: b=int(1000)
sage: c=[0]
sage: %timeit c*a
625 loops, best of 3: 568 µs per loop
sage: %timeit c*b
625 loops, best of 3: 5.13 µs per loop
```



---

Comment by robertwb created at 2011-05-27 08:35:10

Changing status from new to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2011-05-27 09:17:35

Changing component from performance to coercion.


---

Comment by jdemeyer created at 2011-05-27 15:06:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-05-27 15:06:49

Robert, I get a documentation warning, I would guess the docbuilder gets confused by the "\n" in the doctest:

```
docstring of sage.structure.coerce.CoercionModel_cache_maps.record_exceptions:11: (WARNING/2) Block quote ends without a blank line; unexpected unindent.
```



---

Attachment


---

Comment by robertwb created at 2011-05-27 17:58:41

Changing status from needs_work to needs_review.


---

Comment by robertwb created at 2011-05-27 17:58:41

Patch updated.


---

Comment by lftabera created at 2011-05-27 19:14:00

Changing status from needs_review to needs_info.


---

Comment by lftabera created at 2011-05-27 19:14:00

mmm, I do not get any improvement. I get exactly the same timmings as in the ticket with the patch. I have tried on a fresh sage-4.7

Robert, has the issue dissapeared for you with this patch?


---

Comment by robertwb created at 2011-05-29 05:37:24

OK, that's what comes of trying to add a patch in the middle of the night after a long day... it's missing a line. However, I think the fix at #11389 is better (rather than not record exceptions, we simply avoid them in many more cases).


---

Attachment


---

Comment by lftabera created at 2011-06-07 10:00:55

Ok, let me understand the code. There is a recording of exceptions that are very convenient for debugging. The problem is that it produces an important performance penalty. This is solved with record_exceptions() that controls the attribute _record_exceptions which is the flag that controls.

Just one thing. Each time that record_exceptions is called, the exception stack cached is cleared so:


```
sage: cm = sage.structure.element.get_coercion_model()
sage: cm.record_exceptions()
sage: cm._test_exception_stack()
sage: cm.record_exceptions()
sage: cm.exception_stack()
[]            
```


Is this the intended behavior? It is trivially seen from the code but I think it should be documented.


---

Comment by jdemeyer created at 2011-06-15 15:33:32

Are you continueing with this ticket or should it be closed?


---

Comment by lftabera created at 2011-06-16 10:31:08

No, this code is stull valid. The speed regression is gone, but the functions that control the record of the exceptions is still valid and worthy to include in sage.


---

Attachment

I give a positive review to the patch from Robert,

I just suggest some more verbosity in the documentation, as added in my patch.


---

Comment by lftabera created at 2011-07-20 14:46:13

Changing status from needs_info to needs_review.


---

Comment by lftabera created at 2011-07-20 14:46:13

Changing keywords from "" to "debug, coercion, exceptions".


---

Comment by jhpalmieri created at 2011-07-23 20:34:40

The only thing needing reviewing is the referee patch, right?  Positive review.


---

Comment by jhpalmieri created at 2011-07-23 20:34:40

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-07-24 11:21:23

Changing priority from critical to major.


---

Comment by jdemeyer created at 2011-08-18 22:03:43

Resolution: fixed
