# Issue 21798: Fix do_pickle of cached_in_parent_method

Issue created by migration from https://trac.sagemath.org/ticket/22035

Original creator: saraedum

Original creation time: 2016-12-07 05:10:10

The `do_pickle` parameter was not properly passed on in `CachedInParentMethod` so that parameter actually never worked (the default was used instead which meant no pickling of caches.)
The doctest did not catch it since the parent was not pickled and unpickled because `_parent` of the class had been assigned, not of the instance.


---

Comment by saraedum created at 2016-12-07 05:11:27

Changing status from new to needs_review.


---

Comment by saraedum created at 2016-12-07 05:12:00

New commits:


---

Comment by msaaltink created at 2016-12-17 20:09:41

This seems like an obvious change and looks like the right thing to do.

There is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one

```
SP_parent = MyParent()

class SP_pickle(object):
     def parent(self): return SP_parent
     @cached_in_parent_method(do_pickle=True)
     def f(self, x):
          return x

class SP_no_pickle(object):
     def parent(self): return SP_parent
     @cached_in_parent_method(do_pickle=False)
     def f(self, x):
          return x
```


Here, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.


---

Comment by hivert created at 2017-03-14 18:31:49

Replying to [comment:4 msaaltink]:
> There is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one

> Here, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.

In my opinion, the fact that the cache should be pickled or not is a choice that should be made made by the parent. Due to the way we write the cached_in_parent decorator, it appears syntactically to be a choice of the element, but I think it really belongs to the parent. As a consequence I won't bother taking care of this very corner case. Actually, I would consider it broken. 

Anyway, IHMO the winning argument is that, we don't have that much use cases for cached_in_parent (all of them being related to root systems, by the way...) and even less use cases for parent with two different classes of elements. 

So I'm giving a positive review after fixing the merge.


---

Comment by hivert created at 2017-03-14 19:11:52

New commits:


---

Comment by hivert created at 2017-03-14 19:11:52

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-03-17 09:04:10

Changing keywords from "" to "days85".


---

Comment by vbraun created at 2017-03-25 15:06:27

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-03-25 15:06:27

Reviewer name ends with a comma, is that intended? ;-)


---

Comment by tscrim created at 2017-03-25 16:13:09

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-03-27 20:42:19

Resolution: fixed
