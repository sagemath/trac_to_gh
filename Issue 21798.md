# Issue 21798: Fix do_pickle of cached_in_parent_method

archive/issues_021798.json:
```json
{
    "body": "The `do_pickle` parameter was not properly passed on in `CachedInParentMethod` so that parameter actually never worked (the default was used instead which meant no pickling of caches.)\nThe doctest did not catch it since the parent was not pickled and unpickled because `_parent` of the class had been assigned, not of the instance.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22035\n\n",
    "created_at": "2016-12-07T05:10:10Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Fix do_pickle of cached_in_parent_method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21798",
    "user": "saraedum"
}
```
The `do_pickle` parameter was not properly passed on in `CachedInParentMethod` so that parameter actually never worked (the default was used instead which meant no pickling of caches.)
The doctest did not catch it since the parent was not pickled and unpickled because `_parent` of the class had been assigned, not of the instance.

Issue created by migration from https://trac.sagemath.org/ticket/22035





---

archive/issue_comments_302437.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-12-07T05:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302437",
    "user": "saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302438.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-12-07T05:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302438",
    "user": "saraedum"
}
```

New commits:



---

archive/issue_comments_302439.json:
```json
{
    "body": "This seems like an obvious change and looks like the right thing to do.\n\nThere is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one\n\n```\nSP_parent = MyParent()\n\nclass SP_pickle(object):\n     def parent(self): return SP_parent\n     @cached_in_parent_method(do_pickle=True)\n     def f(self, x):\n          return x\n\nclass SP_no_pickle(object):\n     def parent(self): return SP_parent\n     @cached_in_parent_method(do_pickle=False)\n     def f(self, x):\n          return x\n```\n\n\nHere, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.",
    "created_at": "2016-12-17T20:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302439",
    "user": "msaaltink"
}
```

This seems like an obvious change and looks like the right thing to do.

There is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one

```
SP_parent = MyParent()

class SP_pickle(object):
     def parent(self): return SP_parent
     @cached_in_parent_method(do_pickle=True)
     def f(self, x):
          return x

class SP_no_pickle(object):
     def parent(self): return SP_parent
     @cached_in_parent_method(do_pickle=False)
     def f(self, x):
          return x
```


Here, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.



---

archive/issue_comments_302440.json:
```json
{
    "body": "Replying to [comment:4 msaaltink]:\n> There is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one\n\n> Here, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.\n\nIn my opinion, the fact that the cache should be pickled or not is a choice that should be made made by the parent. Due to the way we write the cached_in_parent decorator, it appears syntactically to be a choice of the element, but I think it really belongs to the parent. As a consequence I won't bother taking care of this very corner case. Actually, I would consider it broken. \n\nAnyway, IHMO the winning argument is that, we don't have that much use cases for cached_in_parent (all of them being related to root systems, by the way...) and even less use cases for parent with two different classes of elements. \n\nSo I'm giving a positive review after fixing the merge.",
    "created_at": "2017-03-14T18:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302440",
    "user": "hivert"
}
```

Replying to [comment:4 msaaltink]:
> There is a small anomaly: because the cache is in the parent, and the parent can be shared my many instances, the do_pickle parameter does not always apply as hoped.  Admittedly this is in corner cases, like this one

> Here, if instances of SP_pickle and of SP_no_pickle are created, whether the cache is pickled or not depends on which instance's f was called first.  I'm not quite sure whether this is a problem, and if so, whether it is bad enough to bother fixing.

In my opinion, the fact that the cache should be pickled or not is a choice that should be made made by the parent. Due to the way we write the cached_in_parent decorator, it appears syntactically to be a choice of the element, but I think it really belongs to the parent. As a consequence I won't bother taking care of this very corner case. Actually, I would consider it broken. 

Anyway, IHMO the winning argument is that, we don't have that much use cases for cached_in_parent (all of them being related to root systems, by the way...) and even less use cases for parent with two different classes of elements. 

So I'm giving a positive review after fixing the merge.



---

archive/issue_comments_302441.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-14T19:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302441",
    "user": "hivert"
}
```

New commits:



---

archive/issue_comments_302442.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-14T19:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302442",
    "user": "hivert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302443.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-17T09:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302443",
    "user": "tscrim"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_302444.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-03-25T15:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302444",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_302445.json:
```json
{
    "body": "Reviewer name ends with a comma, is that intended? ;-)",
    "created_at": "2017-03-25T15:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302445",
    "user": "vbraun"
}
```

Reviewer name ends with a comma, is that intended? ;-)



---

archive/issue_comments_302446.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-03-25T16:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302446",
    "user": "tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_302447.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21798#issuecomment-302447",
    "user": "vbraun"
}
```

Resolution: fixed
