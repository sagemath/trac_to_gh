# Issue 30529: Support Python 3.10

Issue created by migration from https://trac.sagemath.org/ticket/30766

Original creator: slelievre

Original creation time: 2020-10-13 21:33:40

CC:  mkoeppe slelievre fbissey tornaria arojas




---

Comment by slelievre created at 2020-10-13 21:44:34

Changing type from PLEASE CHANGE to task.


---

Comment by slelievre created at 2020-10-13 21:44:34

Changing keywords from "" to "upgrade, python".


---

Comment by slelievre created at 2020-10-13 21:44:34

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by mkoeppe created at 2021-05-24 23:56:14

New commits:


---

Comment by git created at 2021-05-25 00:03:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-25 00:06:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-25 00:20:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-25 00:29:29

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-05-25 00:46:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-15 23:59:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-09-16 00:51:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-16 00:53:00


```
  [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'
```



---

Comment by mkoeppe created at 2021-09-16 00:53:49


```
  [pplpy-0.8.6]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/var/tmp/sage/build/pplpy-0.8.6/inst to /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1
  [pplpy-0.8.6]   Running post-install script for pplpy-0.8.6.
  [pplpy-0.8.6]   Traceback (most recent call last):
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/bin/sphinx-build", line 5, in <module>
  [pplpy-0.8.6]       from sphinx.cmd.build import main
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/cmd/build.py", line 25, in <module>
  [pplpy-0.8.6]       from sphinx.application import Sphinx
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/application.py", line 31, in <module>
  [pplpy-0.8.6]       from sphinx.config import Config
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/config.py", line 21, in <module>
  [pplpy-0.8.6]       from sphinx.util import logging
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/__init__.py", line 41, in <module>
  [pplpy-0.8.6]       from sphinx.util.typing import PathMatcher
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/typing.py", line 37, in <module>
  [pplpy-0.8.6]       from types import Union as types_Union
  [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)
  [pplpy-0.8.6]   make[5]: *** [html] Error 1
  [pplpy-0.8.6]   cp: build/html/*: No such file or directory
```



---

Comment by mkoeppe created at 2021-09-16 01:15:14

Replying to [comment:29 mkoeppe]:
> {{{
>   [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'
> }}}
It does not look like a 1.6.4 is in preparation (https://github.com/scipy/scipy/commits/maintenance/1.6.x)... so I guess we'll have to do the update to 1.7.x in #32105


---

Comment by mkoeppe created at 2021-09-16 01:44:26

Workaround for the `scipy` install problem: `--ignore-requires-python` (new commits in #32492)


---

Comment by mkoeppe created at 2021-09-16 01:45:06

Replying to [comment:30 mkoeppe]:
> {{{
>   [pplpy-0.8.6]       from types import Union as types_Union
>   [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)
>   [pplpy-0.8.6]   make[5]: *** [html] Error 1
>   [pplpy-0.8.6]   cp: build/html/*: No such file or directory
> }}}
Fixed by the sphinx upgrade in #32518


---

Comment by mkoeppe created at 2021-09-16 01:52:41

`cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190


---

Comment by mkoeppe created at 2021-09-16 02:00:53

Replying to [comment:36 mkoeppe]:
> `cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190
That's #32519


---

Comment by mkoeppe created at 2021-09-16 02:29:00

Tests (via #30767) run at https://github.com/mkoeppe/sage/actions/runs/1239984523 -- all `-minimal` builds will use python 3.10.0rc1


---

Comment by mkoeppe created at 2021-09-16 03:34:33

`distutils` deprecation -> #32565:

```
sage -t --long --random-seed=0 src/sage/plot/plot.py
**********************************************************************
File "src/sage/plot/plot.py", line 513, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/features/__init__.py:55: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
      from distutils.errors import CCompilerError
    0
```



---

Comment by mkoeppe created at 2021-09-16 03:36:09

Many failures from improved error messages -> #32520

```
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 214, in sage.geometry.polyhedron.base.Polyhedron_base.__init__
Failed example:
    p = Polyhedron_field(parent, Vrep, 'nonsense',  # py3
                         Vrep_minimal=True, Hrep_minimal=True, pref_rep='Vrep')
Expected:
    Traceback (most recent call last):
    ...
    TypeError: _init_Hrepresentation() takes 3 positional arguments but 9 were given
Got:
    <BLANKLINE>
    Traceback (most recent call last):
...
    TypeError: Polyhedron_field._init_Hrepresentation() takes 3 positional arguments but 9 were given
**********************************************************************
```



---

Comment by mkoeppe created at 2021-09-16 03:40:28

Stricter parser:

```
sage -t --long --random-seed=0 src/sage/schemes/riemann_surfaces/riemann_surface.py
**********************************************************************
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 1393, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.make_zw_interpolator
Failed example:
    all(f(*g(i*0.1)).abs() < 1e-13for i in range(10))
Expected:
    True
Got:
    DeprecationWarning: invalid decimal literal
    True
```



---

Comment by mkoeppe created at 2021-09-16 03:40:58

Sage numbers no longer accepted:

```
sage -t --long --random-seed=0 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 104, in sage.tests.cmdline.test_executable
Failed example:
    (out, err, ret) = test_executable(["sleep", "1"], timeout=0.1)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: timeout in test_executable()
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.cmdline.test_executable[5]>", line 1, in <module>
        (out, err, ret) = test_executable(["sleep", "1"], timeout=RealNumber('0.1'))
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/tests/cmdline.py", line 769, in test_executable
        rlist = select.select(rfd, [], [], timeout)[0]
    TypeError: timeout must be a float or None
```



```
sage -t --long --random-seed=0 src/sage_docbuild/utils.py
**********************************************************************
File "src/sage_docbuild/utils.py", line 91, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    ZeroDivisionError: rational division by zero
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[6]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```



---

Comment by mkoeppe created at 2021-09-16 03:45:22

inspect:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
**********************************************************************
File "src/sage/misc/sageinspect.py", line 1561, in sage.misc.sageinspect.sage_getargspec
Failed example:
    shell.run_cell('f??')
Expected:
    ...the source code string...
Got:
    ---------------------------------------------------------------------------
    OSError                                   Traceback (most recent call last)
```



---

Comment by mkoeppe created at 2021-09-16 03:45:28


```
sage -t --long --random-seed=0 src/sage/categories/loop_crystals.py
**********************************************************************
File "src/sage/categories/loop_crystals.py", line 115, in sage.categories.loop_crystals.LoopCrystals.ParentMethods.digraph
Failed example:
    G.latex_options()  # optional - dot2tex
Expected:
    LaTeX options for Digraph on 29 vertices:
    {...'edge_options': <function ... at ...>...}
Got:
    LaTeX options for Digraph on 29 vertices: {}
```



---

Comment by mkoeppe created at 2021-09-16 05:03:41


```
sage -t --long --random-seed=0 src/sage/cpython/atexit.pyx
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 61, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=True):
        atexit._run_exitfuncs()  # Should be none registered
        atexit.register(handler, 1, 2, c=3)
        with restore_atexit():
            atexit._run_exitfuncs()  # Run just registered handler
        atexit._run_exitfuncs()  # Handler should be run again
Expected:
    <function handler at 0x...>
    ((1, 2), {'c': 3})
    ((1, 2), {'c': 3})
Got:
    <function handler at 0x357023a30>
    ((1, 2), {'c': 3})
```



---

Comment by git created at 2021-09-28 19:15:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-28 19:26:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-28 19:27:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-05 17:33:14

Changing priority from major to critical.


---

Comment by tornaria created at 2021-11-09 13:09:34

I'm testing c73bc97 using system python 3.10 (void linux).

Compilation succeeds. Then running `./sage` gives:

```
/opt/sage/sage-git/local/lib/python3.10/site-packages/prompt_toolkit/application/application.py:882: DeprecationWarning: There is no current event loop
  loop = get_event_loop()
sage: ...
```

Running `./sage -tp 8 --all` gives:
- lots of crashes apparently related to cysignals; stack trace starts with

```
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]
/usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]
/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]
/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]
/usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]
/usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]
...
```

- more deprecation warnings

```
/opt/sage/sage-git/local/bin/cysignals-CSI:44: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
```


All I'm doing is, starting with a clean copy of c73bc97

```
$ ./bootstrap
$ ./configure
$ make build -j12
$ ./sage -tp 8 --all
```


I have logs, let me know if you need more info.

My goal is packaging sage for void linux, but it's already migrated to python 3.10 so this is a blocker.


---

Comment by enriqueartal created at 2021-11-24 22:57:20

After updating the last cysignals (unreleased 1.11.0, needed for Fedora 35) I put below the failed tests. I get some errors as in previous posts (I needed to restart several times due to many cysignal crashes); by the way `make ptestlong` produced many such crashes while `sage -t -a -p8` worked better. 

The prompt_toolkit warning disappears with the 3.0.22 version.



```
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/log.py  # 3 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/other.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/interfaces/fricas.py  # 110 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/external.py  # 13 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/integral.py  # 3 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/tests/cmdline.py  # Timed out
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/calculus.py  # 6 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/desolvers.py  # 13 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/combinat/posets/posets.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/rings/real_mpfr.pyx  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/gamma.py  # 4 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/matrix/matrix1.pyx  # 4 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/error.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/plot/colors.py  # 5 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/geometry/hyperbolic_space/hyperbolic_model.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/expression_conversions.py  # 16 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/generalized.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/pari.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/structure/unique_representation.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage_docbuild/utils.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/libs/giac/__init__.py  # 7 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/lcalc.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/callable.py  # 5 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/cpython/atexit.pyx  # 6 doctests failed
```



---

Comment by arojas created at 2021-12-10 19:13:46

Replying to [comment:58 tornaria]:
> Running `./sage -tp 8 --all` gives:
> - lots of crashes apparently related to cysignals; stack trace starts with
> {{{
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]
> /usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]
> /usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]
> /usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]
> ...
> }}}

Just updated to 3.10 and am also seeing this when running doctests, but not 100% of the times. Any idea where this comes from?


---

Comment by arojas created at 2021-12-10 20:09:22

The crash is happening in the `__Pyx_INCREF` call here


```
    /* "sage/cpython/atexit.pyx":188
 *         else:
 *             kwargs = {}
 *         exithandlers.append((<object>callback.func,             # <<<<<<<<<<<<<<
 *                                 <object>callback.args,
 *                                 kwargs))
 */
    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 188, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_INCREF(((PyObject *)__pyx_v_callback.func));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_callback.func));
    PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_callback.func));
```



---

Comment by arojas created at 2021-12-11 09:57:05

Update: the segfault seems to happen when running tests iff there is another sage-runtests process running. After interrupting the doctests, the `sage-runtests` process takes a long time to get cleaned up, and if you try to run tests again in the meantime you will get the segfault.


---

Comment by arojas created at 2021-12-12 09:13:03

After #33013, the only remaining issues in `sagelib` are

```
sage -t --long /usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/doctest/test.py  # 16 doctests failed
```

which are caused by the spawned `sage-runtests` child processes segfaulting as mentioned above, and

```
sage -t --long /usr/lib/python3.10/site-packages/sage/cpython/atexit.pyx  # 6 doctests failed
```

which are likely related.


---

Comment by tornaria created at 2021-12-14 13:23:35

Indeed, running tests in parallel breaks badly but running them _not_ in parallel goes very far.

This is what I got with `./sage -t --all`:

```
----------------------------------------------------------------------
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/tests/cmdline.py  # 5 doctests failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/quivers/algebra_elements.pxi  # 1 doctest failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/cpython/atexit.pyx  # 6 doctests failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/interfaces/sage0.py  # 1 doctest failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage_docbuild/utils.py  # 2 doctests failed
----------------------------------------------------------------------
```


Maybe I missed some patch, e.g a few failures are distutils deprecation warnings in `.../venv-python3.10/lib/python3.10/site-packages/matplotlib/__init__.py:88`.

What I used is beta8 + #30766 + #33013. What did I miss?


Maybe someone can rebase on top of beta8 so we all work on top of a common point?

----

As for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.

On the positive side, now the structs and some functions are declared in (internal) headers so it might be possible to implement this in a more robust way (formerly everything was in a C file and it seems `sage.python.atexit` copied a bunch of stuff which now may be incorrect).

What are the chances that sagemath 9.5 can support system python 3.10? I've been working to get sagemath into voidlinux but they won't accept a vendored python.


---

Comment by mkoeppe created at 2021-12-17 17:12:08

I would suggest that we defer full support for Python 3.10 to Sage 9.6
but already accept system Python 3.10 with a warning


---

Comment by git created at 2021-12-17 17:38:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-12-17 17:39:42

Changing type from task to enhancement.


---

Comment by mkoeppe created at 2021-12-17 17:39:42

Changing status from new to needs_review.


---

Comment by git created at 2021-12-17 17:42:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-12-17 22:27:40

Replying to [comment:68 tornaria]:
> Maybe someone can rebase [...] so we all work on top of a common point?

Done


---

Comment by mkoeppe created at 2021-12-17 22:28:51

Replying to [comment:68 tornaria]:
> As for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.

There is an unreleased change related to `atexit` mentioned in https://docs.python.org/3.10/whatsnew/changelog.html#core-and-builtins


---

Comment by mkoeppe created at 2021-12-18 00:35:53

I've put this change as a patch on #30767. It looks like it fixes the crashes in `make ptest`


---

Comment by mkoeppe created at 2021-12-18 01:12:50

However, I get these failures:

```
sage -t --random-seed=335595092046712014150830110238612394725 src/sage/cpython/atexit.pyx
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 61, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=True):
        atexit._run_exitfuncs()  # Should be none registered
        atexit.register(handler, 1, 2, c=3)
        with restore_atexit():
            atexit._run_exitfuncs()  # Run just registered handler
        atexit._run_exitfuncs()  # Handler should be run again
Expected:
    <function handler at 0x...>
    ((1, 2), {'c': 3})
    ((1, 2), {'c': 3})
Got:
    <function handler at 0x1727cc940>
    ((1, 2), {'c': 3})
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 77, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=False, run=True):
        # original handlers are run when exiting the context
        pass
Expected:
    ((4, 5), {'d': 6})
    ((1, 2), {'c': 3})
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 85, in sage.cpython.atexit
Failed example:
    atexit._run_exitfuncs()
Expected:
    ((4, 5), {'d': 6})
    ((1, 2), {'c': 3})
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 97, in sage.cpython.atexit
Failed example:
    print("Initial exit handlers:\n{}".format(_get_exithandlers()))
Expected:
    Initial exit handlers:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    Initial exit handlers:
    []
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 104, in sage.cpython.atexit
Failed example:
    print("After restore_atexit:\n{}".format(_get_exithandlers()))
Expected:
    After restore_atexit:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    After restore_atexit:
    []
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 114, in sage.cpython.atexit
Failed example:
    print("After restore_atexit with clear=True:\n{}".format(
          _get_exithandlers()))
Expected:
    After restore_atexit with clear=True:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    After restore_atexit with clear=True:
    []
**********************************************************************
1 item had failures:
   6 of  20 in sage.cpython.atexit
    [19 tests, 6 failures, 0.03 s]
```



---

Comment by arojas created at 2021-12-18 18:39:45

The python patch also fixes the crashes for me. Besides those six failures in `sage.cpython.atexit`, I'm also getting

```
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/doctest/test.py", line 509, in sage.doctest.test
Failed example:
    os.path.isfile(F)  # long time
Expected:
    False
Got:
    True
**********************************************************************
```


Looks like `atexit` integration is totally broken, but it shouldn't affect normal Sage usage.


---

Comment by mkoeppe created at 2021-12-18 18:42:41

I think we should just disable all of `sage.cpython.atexit` on Python 3.10 for Sage 9.5


---

Comment by git created at 2021-12-18 21:35:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-18 21:40:32

This fixes the segfaults for me with (unpatched) Python 3.10 from homebrew.

It looks like doctest timeouts are not correctly reported with this change on Python 3.10

```
sage -t --random-seed=15134756989416810321066706961638592844 src/sage/manifolds/differentiable/integrated_curve.py
    Error in doctesting framework (no result returned)
```


But I think this is good enough for Sage 9.5.


---

Comment by @sheerluck created at 2021-12-19 06:11:37

[atexit.pyx commit](https://git.sagemath.org/sage.git/commit/?id=b5c73996062c71a9326aafddaf465f6a56b40fe0) fixes the segfaults for [tox-docker-gentoo-python3.10-standard](https://github.com/sheerluck/sage/actions/runs/1597115166)


---

Comment by mkoeppe created at 2021-12-19 06:17:54

Thanks for testing!


---

Comment by arojas created at 2021-12-19 09:07:18

The `atexit` patch is causing many test failures in `sage.tests.cmdline` and `sage.doctest.test` for me, with either patched or unpatched python. If you're using patched python (or the upcoming 3.10.2), it makes things notably worse. 

What about just disallowing system 3.10.0 and 3.10.1?


---

Comment by arojas created at 2021-12-19 09:37:13

Actually it is not just those two modules: doctesting is completely broken with the patch. These are the first few lines of `sage -t -l /usr/lib/python3.10/site-packages/sage`

```
too many failed tests, not using stored timings
Running doctests with ID 2021-12-19-10-34-37-4bb8d646.
Using --optional=cvxopt,dochtml,pip,rpy2,sage,sage.geometry.polyhedron,sage.rings.real_double
Doctesting 3480 files.
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:
sage: import gc ## line 13 ##
sage: import inspect ## line 14 ##
sage: from sage import * ## line 15 ##
sage: frames = [x for x in gc.get_objects() if inspect.isframe(x)] ## line 16 ##
sage: allowed = [
    'IPython', 'prompt_toolkit', 'jedi',     # sage dependencies
    'threading', 'multiprocessing',  # doctest dependencies
    '__main__', 'sage.doctest',      # doctesting
    'signal', 'enum', 'types'        # may appear in Python 3
] ## line 21 ##
sage: def is_not_allowed(frame):
    module = inspect.getmodule(frame)
    if module is None: return False
    return not any(module.__name__.startswith(name) for name in allowed) ## line 27 ##
sage: [inspect.getmodule(f).__name__ for f in frames if is_not_allowed(f)] ## line 31 ##
[]
sage: type(interacts) ## line 36 ##
<class 'sage.misc.lazy_import.LazyImport'>
sage: interacts ## line 38 ##
<module 'sage.interacts.all' from '/usr/lib/python3.10/site-packages/sage/interacts/all.py'>
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 40 ##
0
sage: 'log' in sage_globals() ## line 315 ##
True
sage: 'MatrixSpace' in sage_globals() ## line 317 ##
True
sage: 'Permutations' in sage_globals() ## line 319 ##
True
sage: 'TheWholeUniverse' in sage_globals() ## line 321 ##
False
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 323 ##
0

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all_cmdline.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/version.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/env.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:
```



---

Comment by tornaria created at 2021-12-19 17:15:59

Same here: the atexit patch causes a lot of doctest failures, either when running tests in parallel or serially.

Just removing that last commit makes things way better, I can now run tests in parallel with only

```
----------------------------------------------------------------------
sage -t --random-seed=184890811937734492121783958395067560107 src/sage/cpython/atexit.pyx  # 6 doctests failed
sage -t --random-seed=184890811937734492121783958395067560107 src/sage_docbuild/utils.py  # 2 doctests failed
sage -t --random-seed=184890811937734492121783958395067560107 src/sage/tests/cmdline.py  # 7 doctests failed
----------------------------------------------------------------------
```

(I used had trouble all over the place when running tests in parallel, the difference may be due to merging #32930 which I wasn't applying before).

To be precise I'm using beta8 + #30766 (02aa94c) + #33020 (715277c) + #33040 (d865a54).


---

Comment by enriqueartal created at 2021-12-19 17:50:00

Same thing with Fedora 35


---

Comment by git created at 2021-12-19 19:23:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-12-19 19:23:35

Here's a better version, please test


---

Comment by arojas created at 2021-12-19 21:04:55

Replying to [comment:91 mkoeppe]:
> Here's a better version, please test

Running a second `sage-runtests` instance while there is another one running still segfaults. In particular, all tests that spawn a `sage-runtests` subprocess in `sage.doctest.test` segfault. This is with unpatched Python 3.10.1


---

Comment by arojas created at 2021-12-19 21:09:10

Also, I noticed that `sage -t -a` still segfaults with a patched Python (regardless of whether the `atexit` patch is applied or not)


---

Comment by enriqueartal created at 2021-12-19 21:42:19

For me only one failed test (system giac 1.7.0.13):

```
Running doctests with ID 2021-12-19-22-38-22-94239956.
Git branch: t/30766/support_python_3_10
Using --optional=build,dochtml,fedora,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg
Doctesting 1 file.
sage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 18, in sage.libs.giac
Failed example:
    B = gb_giac(I.gens()) # random
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac[3]>", line 1, in <module>
        B = gb_giac(I.gens()) # random
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 353, in groebner_basis
        gb_giac = F.gbasis(list(var_names), giac_order)
      File "sage/libs/giac/auto-methods.pxi", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)
        return GiacMethods['gbasis'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 19, in sage.libs.giac
Failed example:
    B
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac[4]>", line 1, in <module>
        B
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 175, in sage.libs.giac.?
Failed example:
    B=gb_giac(I.gens());B
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[3]>", line 1, in <module>
        B=gb_giac(I.gens());B
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 353, in groebner_basis
        gb_giac = F.gbasis(list(var_names), giac_order)
      File "sage/libs/giac/auto-methods.pxi", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)
        return GiacMethods['gbasis'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 179, in sage.libs.giac.?
Failed example:
    B.is_groebner()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[4]>", line 1, in <module>
        B.is_groebner()
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 186, in sage.libs.giac.?
Failed example:
    B = gb_giac(I.gens(), elim_variables=[P.gen(0), P.gen(2)])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[7]>", line 1, in <module>
        B = gb_giac(I.gens(), elim_variables=[P.gen(Integer(0)), P.gen(Integer(2))])
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 356, in groebner_basis
        gb_giac = F.eliminate(list(elim_variables), 'gbasis')
      File "sage/libs/giac/auto-methods.pxi", line 4884, in sage.libs.giac.giac.GiacMethods_base.eliminate (build/cythonized/sage/libs/giac/giac.cpp:45540)
        return GiacMethods['eliminate'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 189, in sage.libs.giac.?
Failed example:
    B.is_groebner()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[8]>", line 1, in <module>
        B.is_groebner()
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 191, in sage.libs.giac.?
Failed example:
    B.ideal() == I.elimination_ideal([P.gen(0), P.gen(2)])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[9]>", line 1, in <module>
        B.ideal() == I.elimination_ideal([P.gen(Integer(0)), P.gen(Integer(2))])
    NameError: name 'B' is not defined
**********************************************************************
2 items had failures:
   2 of   6 in sage.libs.giac
   5 of  33 in sage.libs.giac.?
    [56 tests, 7 failures, 0.41 s]
----------------------------------------------------------------------
sage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py  # 7 doctests failed
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.4 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

Comment by tornaria created at 2021-12-19 22:10:27

I change the workarounds by an attempt at a "proper" fix.

With this all the doctests in `src/sage/cpython/atexit.pyx` pass, both with bundled python 3.9.7 and with my system python 3.10.

I'm still to run the whole testsuite; I am still getting failures in `src/sage_docbuild/utils.py` but I think they are due to the deprecation warnings caused by matplotlib and should go away when I apply #33040 which I forgot to do.

Should #33040 be merged into this ticket as a dependency? Am I the only one having problems caused by old matplotlib?
----
New commits:


---

Comment by tornaria created at 2021-12-19 22:22:23

Notes on the implementation:

Everything is in the `cdef extern from *` block where I moved the definition of `struct atexit_callback` and a new function `_atexit_callbacks()`.

The C implementation for python 3.9 is short and should be equivalent to what was before. The implementation for 3.10 is even shorter since structs are now defined in (internal) python headers.

The argument to `_atexit_callbacks()` should be the atexit module as in the body of `_get_exithandlers()`. This is not necessary for python 3.10 but it seemed simpler to have the same declaration for both cases so there are no conditionals outside the `cdef extern from *` block.


---

Comment by mkoeppe created at 2021-12-19 22:26:18

Looks good to me but it needs to be tested also on Python < 3.10


---

Comment by tornaria created at 2021-12-19 23:01:47

Replying to [comment:98 mkoeppe]:
> Looks good to me but it needs to be tested also on Python < 3.10

Absolutely! I did one test by passing `--without-system-python3` to configure but more testing would be desirable.

Although I think the changes should really be nil for python < 3.10; would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10? With some luck the first part visibly does nothing, and the second part will only add code conditional to python >= 3.10.


---

Comment by mkoeppe created at 2021-12-19 23:03:07

Replying to [comment:100 tornaria]:
> would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10?

No, it's fine as is


---

Comment by tornaria created at 2021-12-19 23:04:38

My full clean build with python 3.10 finished with the following doctest failure:

```
sage -t --random-seed=262548395979960264449538514011341238171 src/sage_docbuild/utils.py
**********************************************************************
File "src/sage_docbuild/utils.py", line 91, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    ZeroDivisionError: rational division by zero
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[6]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
**********************************************************************
File "src/sage_docbuild/utils.py", line 110, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    WorkerDiedException: worker for 4 died with non-zero exit code -9
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[8]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
**********************************************************************
1 item had failures:
   2 of  10 in sage_docbuild.utils
    [9 tests, 2 failures, 1.43 s]
```



---

Comment by git created at 2021-12-20 01:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tornaria created at 2021-12-20 01:38:51

This seems to be the root cause:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta8, Release Date: 2021-12-12               │
│ Using Python 3.10.1. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import time
sage: time.sleep(0.5)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-b448069dbb3c> in <module>
----> 1 time.sleep(RealNumber('0.5'))

TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```


Now the same thing `--without-system-python`:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta8, Release Date: 2021-12-12               │
│ Using Python 3.9.7. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import time
sage: time.sleep(0.5)
<ipython-input-2-b448069dbb3c>:1: DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python.
  time.sleep(RealNumber('0.5'))
```



---

Comment by tornaria created at 2021-12-20 01:57:31

Everything passes now for me using system python 3.10.1 on void linux:

```
$ ./sage -tp 36 --optional sage,optional,build --all
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 236.9 seconds
    cpu time: 7024.5 seconds
    cumulative wall time: 6565.8 seconds
```



---

Comment by arojas created at 2021-12-20 15:41:26

All tests passing here too, thanks!


---

Comment by arojas created at 2021-12-20 15:41:26

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-20 19:57:04

Thanks!


---

Comment by mkoeppe created at 2021-12-20 19:57:50

The dependency #33040 needs review so that we can get this ticket merged.


---

Comment by vbraun created at 2022-01-01 00:23:38

Resolution: fixed


---

Comment by arojas created at 2022-01-09 13:39:15

Something regressed in 9.5.rc0 which is causing distutils deprecation warnings

```
File "/usr/lib/python3.10/site-packages/sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../include/python...',
    '.../python.../numpy/core/include']
Got:
    doctest:warning
      File "/usr/bin/sage-runtests", line 155, in <module>
        err = DC.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 1256, in run
        self.run_doctests()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 957, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2004, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1899, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2173, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.10/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.10/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2145, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2475, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2527, in _run
        result = runner.run(test)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.env.sage_include_directories[1]>", line 1, in <module>
        sage.env.sage_include_directories()
      File "/usr/lib/python3.10/site-packages/sage/env.py", line 375, in sage_include_directories
        import distutils.sysconfig
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 992, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1006, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 688, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 883, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.10/distutils/__init__.py", line 19, in <module>
        warnings.warn(_DEPRECATION_MESSAGE,
      File "/usr/lib/python3.10/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
    doctest:warning
      File "/usr/bin/sage-runtests", line 155, in <module>
        err = DC.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 1256, in run
        self.run_doctests()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 957, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2004, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1899, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2173, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.10/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.10/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2145, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2475, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2527, in _run
        result = runner.run(test)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.env.sage_include_directories[1]>", line 1, in <module>
        sage.env.sage_include_directories()
      File "/usr/lib/python3.10/site-packages/sage/env.py", line 375, in sage_include_directories
        import distutils.sysconfig
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1006, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 688, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 883, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.10/distutils/sysconfig.py", line 58, in <module>
        warnings.warn(
      File "/usr/lib/python3.10/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: The distutils.sysconfig module is deprecated, use sysconfig instead
    ['/usr/lib/python3.10/site-packages',
     '/usr/include/python3.10',
     '/usr/lib/python3.10/site-packages/numpy/core/include']
**********************************************************************
```

These didn't happen with 9.5.beta9 + this branch.


---

Comment by arojas created at 2022-01-09 15:25:22

Replying to [comment:111 arojas]:
> Something regressed in 9.5.rc0 which is causing distutils deprecation warnings

This comes from #32938, in particular form the removal of

```
from Cython.Build.Dependencies import strip_string_literals as cython_strip_string_literals
```

from `sage.doctest.parsing`. That import used to throw a `distutils` deprecation warning that for some reason was ignored during doctesting, and now that it's gone the warning is printed when doctesting any module that calls `distutils.sysconfig`.


---

Comment by @sheerluck created at 2022-01-09 16:05:03

adding `internet` to `--optional=` shows that all `context=SSLContext()` [should be replaced with](https://docs.python.org/3/library/ssl.html#ssl.create_default_context) `context=ssl.create_default_context()`


---

Comment by tornaria created at 2022-01-09 18:46:50

These three seem to fix all the warnings for me (numpy 1.22 from system via #29665)

```
--- a/src/sage/all.py	2022-01-09 15:34:29.833828362 -0300
+++ b/src/sage/all.py	2022-01-09 15:39:40.150091390 -0300
@@ -96,6 +96,15 @@
 warnings.filterwarnings('ignore', category=DeprecationWarning,
                         module='pythran')
 
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='numpy', message='.*distutils.*')
+
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='sage.env', message='.*distutils.*')
+
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='sage.features', message='.*distutils.*')
+
 ################ end setup warnings ###############################
 
 
```


Edit: fixed paths in the patch.


---

Comment by tornaria created at 2022-01-09 19:54:18

Please see and review #33135.
