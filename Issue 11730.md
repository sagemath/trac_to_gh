# Issue 11730: Fan subdivision should check rays

archive/issues_011730.json:
```json
{
    "body": "Assignee: @aghitza\n\nThe following should raise an error:\n\n```\nsage: fan = toric_varieties.P2().fan()\nsage: fan.subdivide(new_rays=[(0,0)])\nRational polyhedral fan in 2-d lattice N\n```\nRight now, you only fall on your face once you try to do something with this \"subdivided\" fan:\n\n```\nsage: _.cones()\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n\n/home/vbraun/Sage/EllipticFibration/<ipython console> in <module>()\n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in cones(self, dim, codim)\n   1744         if \"_cones\" not in self.__dict__:\n   1745             levels = [(e.element for e in level) # Generators\n-> 1746                       for level in self.cone_lattice().level_sets()]\n   1747             levels.pop() # The very last level is this FAN, not cone.\n   1748             # It seems that there is no reason to believe that the order of\n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in cone_lattice(self)\n   1682         \"\"\"\n   1683         if \"_cone_lattice\" not in self.__dict__:\n-> 1684             self._compute_cone_lattice()\n   1685         return self._cone_lattice\n   1686 \n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in _compute_cone_lattice(self)\n   1099             # Make sure that rays are in the beginning in proper order\n   1100             head = [rays_to_index[()]] # Empty face\n-> 1101             head.extend(rays_to_index[(n,)] for n in range(self.nrays()))\n   1102             new_order = head + [n for n in new_order if n not in head]\n   1103             # \"Invert\" this list to a dictionary\n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in <genexpr>((n,))\n   1099             # Make sure that rays are in the beginning in proper order\n   1100             head = [rays_to_index[()]] # Empty face\n-> 1101             head.extend(rays_to_index[(n,)] for n in range(self.nrays()))\n   1102             new_order = head + [n for n in new_order if n not in head]\n   1103             # \"Invert\" this list to a dictionary\n\nKeyError: (3,)\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/11902\n\n",
    "created_at": "2011-10-06T20:54:25Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Fan subdivision should check rays",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11730",
    "user": "https://github.com/vbraun"
}
```
Assignee: @aghitza

The following should raise an error:

```
sage: fan = toric_varieties.P2().fan()
sage: fan.subdivide(new_rays=[(0,0)])
Rational polyhedral fan in 2-d lattice N
```
Right now, you only fall on your face once you try to do something with this "subdivided" fan:

```
sage: _.cones()
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)

/home/vbraun/Sage/EllipticFibration/<ipython console> in <module>()

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in cones(self, dim, codim)
   1744         if "_cones" not in self.__dict__:
   1745             levels = [(e.element for e in level) # Generators
-> 1746                       for level in self.cone_lattice().level_sets()]
   1747             levels.pop() # The very last level is this FAN, not cone.
   1748             # It seems that there is no reason to believe that the order of

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in cone_lattice(self)
   1682         """
   1683         if "_cone_lattice" not in self.__dict__:
-> 1684             self._compute_cone_lattice()
   1685         return self._cone_lattice
   1686 

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in _compute_cone_lattice(self)
   1099             # Make sure that rays are in the beginning in proper order
   1100             head = [rays_to_index[()]] # Empty face
-> 1101             head.extend(rays_to_index[(n,)] for n in range(self.nrays()))
   1102             new_order = head + [n for n in new_order if n not in head]
   1103             # "Invert" this list to a dictionary

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/geometry/fan.pyc in <genexpr>((n,))
   1099             # Make sure that rays are in the beginning in proper order
   1100             head = [rays_to_index[()]] # Empty face
-> 1101             head.extend(rays_to_index[(n,)] for n in range(self.nrays()))
   1102             new_order = head + [n for n in new_order if n not in head]
   1103             # "Invert" this list to a dictionary

KeyError: (3,)
```

Issue created by migration from https://trac.sagemath.org/ticket/11902





---

archive/issue_comments_133126.json:
```json
{
    "body": "Horrible! Will fix shortly.",
    "created_at": "2011-10-06T21:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133126",
    "user": "https://github.com/novoselt"
}
```

Horrible! Will fix shortly.



---

archive/issue_comments_133127.json:
```json
{
    "body": "Attachment [trac_11902_check_rays_in_fan_subdivision.patch](tarball://root/attachments/some-uuid/ticket11902/trac_11902_check_rays_in_fan_subdivision.patch) by @novoselt created at 2011-10-06 22:43:42",
    "created_at": "2011-10-06T22:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133127",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_11902_check_rays_in_fan_subdivision.patch](tarball://root/attachments/some-uuid/ticket11902/trac_11902_check_rays_in_fan_subdivision.patch) by @novoselt created at 2011-10-06 22:43:42



---

archive/issue_comments_133128.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric\".",
    "created_at": "2011-10-06T22:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133128",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "" to "toric".



---

archive/issue_comments_133129.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-06T22:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133129",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133130.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133130",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_031467.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-12-29T16:41:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11730#event-31467"
}
```



---

archive/issue_comments_133131.json:
```json
{
    "body": "Happy holidays, Volker! Could you please check this one-liner?-)",
    "created_at": "2011-12-29T16:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133131",
    "user": "https://github.com/novoselt"
}
```

Happy holidays, Volker! Could you please check this one-liner?-)



---

archive/issue_comments_133132.json:
```json
{
    "body": "Sorry, forgot! Positive review!",
    "created_at": "2011-12-29T17:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133132",
    "user": "https://github.com/vbraun"
}
```

Sorry, forgot! Positive review!



---

archive/issue_comments_133133.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-12-29T17:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133133",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_133134.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-12-31T10:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11730#issuecomment-133134",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_031468.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-31T10:35:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11730",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11730#event-31468"
}
```
