# Issue 11718: Sage cannot factor polynomials over number fields with unfactorable discriminant

archive/issues_011718.json:
```json
{
    "body": "Assignee: davidloeffler\n\nKeywords: nffactor PARI nfinit pari_nf\n\nLet `K` be a number field with a discriminant which cannot be factored.  Let `f` be a polynomial in `K[x]`.  Then Sage is unable to factor `f` because it calls PARI's `nfinit()` on `K`:\n\n```\nsage: p = next_prime(10^50); q = next_prime(10^51)\nsage: K = QuadraticField(p*q)\nsage: x = polygen(K); factor(x^2+1)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11890\n\n",
    "created_at": "2011-10-03T08:40:43Z",
    "labels": [
        "number fields",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Sage cannot factor polynomials over number fields with unfactorable discriminant",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11718",
    "user": "jdemeyer"
}
```
Assignee: davidloeffler

Keywords: nffactor PARI nfinit pari_nf

Let `K` be a number field with a discriminant which cannot be factored.  Let `f` be a polynomial in `K[x]`.  Then Sage is unable to factor `f` because it calls PARI's `nfinit()` on `K`:

```
sage: p = next_prime(10^50); q = next_prime(10^51)
sage: K = QuadraticField(p*q)
sage: x = polygen(K); factor(x^2+1)
```


Issue created by migration from https://trac.sagemath.org/ticket/11890





---

archive/issue_comments_132865.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-04T16:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132865",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_132866.json:
```json
{
    "body": "Attachment [11890.patch](tarball://root/attachments/some-uuid/ticket11890/11890.patch) by jdemeyer created at 2011-10-04 16:34:36",
    "created_at": "2011-10-04T16:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132866",
    "user": "jdemeyer"
}
```

Attachment [11890.patch](tarball://root/attachments/some-uuid/ticket11890/11890.patch) by jdemeyer created at 2011-10-04 16:34:36



---

archive/issue_comments_132867.json:
```json
{
    "body": "Jeroen,\n\nThis ticket is a duplicate of #10910\n\nIn that ticket I presented another approach. I still use nffactor but do not use nfinit UNLESS nfinit has already been computed and cached. A couple of comments regarding both approaches:\n\n- Now we do not need nfinit for nffactor. So we can use either nffactor or factornf at will.\n- In most cases nffactor will be faster than factornf (I should give numbers to sustain that though).\n- My patch also work for non-integral generators.\n- But my patch fails in your example with a PariError exception: precision too low.\n\nI have to investigate this error. It might be a Pari bug or there are instances where we really need factornf.",
    "created_at": "2011-10-05T13:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132867",
    "user": "lftabera"
}
```

Jeroen,

This ticket is a duplicate of #10910

In that ticket I presented another approach. I still use nffactor but do not use nfinit UNLESS nfinit has already been computed and cached. A couple of comments regarding both approaches:

- Now we do not need nfinit for nffactor. So we can use either nffactor or factornf at will.
- In most cases nffactor will be faster than factornf (I should give numbers to sustain that though).
- My patch also work for non-integral generators.
- But my patch fails in your example with a PariError exception: precision too low.

I have to investigate this error. It might be a Pari bug or there are instances where we really need factornf.



---

archive/issue_comments_132868.json:
```json
{
    "body": "Replying to [comment:5 lftabera]:\n>  - But my patch fails in your example with a PariError exception: precision too low.\n\nThis is exactly the reason why I am using `factornf` instead of `nffactor`: `nffactor` somehow computes a partial `nfinit` structure which does some floating-point stuff.  Apparently, the floating-point precision is not sufficient in the example.",
    "created_at": "2011-10-05T13:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132868",
    "user": "jdemeyer"
}
```

Replying to [comment:5 lftabera]:
>  - But my patch fails in your example with a PariError exception: precision too low.

This is exactly the reason why I am using `factornf` instead of `nffactor`: `nffactor` somehow computes a partial `nfinit` structure which does some floating-point stuff.  Apparently, the floating-point precision is not sufficient in the example.



---

archive/issue_comments_132869.json:
```json
{
    "body": "Then, we need to be smarter. My experience tells that when nffactor is slower than factornf is for a small relative amount while the other way around is false.\n\nDoing a couple of examples suggest that the PariError appears quite soon.\n\n\n```\nsage: K=NumberField(x^20+ZZ[x].random_element(19,10**20),'a')[x]\nsage: f=K.random_element(50)\nsage: g=K.random_element(50)\nsage: F=f*g\n```\n\n\nIn the above exameple, with my patch, the PariError appears after 6 s. I have not yet computed the factorization of the polynomial with factornf but I claim that it will be quite hard to compute. Pari will use Trager's trick, that means that it will perform gcd's of polynomials in K. And Pari is not very good at it, cf. #8558\n\nWe need to figure out which method use, one option is the following:\n\n- If nfinit structure is already known, use (or try) nfffactor(nfinit,f)\n- If nfinit is not computed, try nffactor\n- If the above fails, use factornf.\n\nAnother alternative is to use one algorithm or the other depending on the discriminant of the field if that is the relevant data for the PariError.\n\nWe may even consider implementing our own Trager's ticket (but that should be in another ticket, after #8558 is merged).\n\nI am not yet sure what is the best way to proceed. I also feel that there should be a way for allowing the user to override the algorithm to use. But factor does not allow optional arguments and I do not want to mess the rest of univariate rings.",
    "created_at": "2011-10-05T15:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132869",
    "user": "lftabera"
}
```

Then, we need to be smarter. My experience tells that when nffactor is slower than factornf is for a small relative amount while the other way around is false.

Doing a couple of examples suggest that the PariError appears quite soon.


```
sage: K=NumberField(x^20+ZZ[x].random_element(19,10**20),'a')[x]
sage: f=K.random_element(50)
sage: g=K.random_element(50)
sage: F=f*g
```


In the above exameple, with my patch, the PariError appears after 6 s. I have not yet computed the factorization of the polynomial with factornf but I claim that it will be quite hard to compute. Pari will use Trager's trick, that means that it will perform gcd's of polynomials in K. And Pari is not very good at it, cf. #8558

We need to figure out which method use, one option is the following:

- If nfinit structure is already known, use (or try) nfffactor(nfinit,f)
- If nfinit is not computed, try nffactor
- If the above fails, use factornf.

Another alternative is to use one algorithm or the other depending on the discriminant of the field if that is the relevant data for the PariError.

We may even consider implementing our own Trager's ticket (but that should be in another ticket, after #8558 is merged).

I am not yet sure what is the best way to proceed. I also feel that there should be a way for allowing the user to override the algorithm to use. But factor does not allow optional arguments and I do not want to mess the rest of univariate rings.



---

archive/issue_comments_132870.json:
```json
{
    "body": "Replying to [comment:7 lftabera]:\n> We need to figure out which method use, one option is the following:\n> \n>  - If nfinit structure is already known, use (or try) nfffactor(nfinit,f)\n>  - If nfinit is not computed, try nffactor\n>  - If the above fails, use factornf.\nAgreed.  Except that we really should do `nfinit()` if the discriminant is easy.\n\n> I am not yet sure what is the best way to proceed. I also feel that there should be a way for allowing the user to override the algorithm to use.\nWhy?  If one algorithm is clearly better than another, why complicate things with extra arguments?",
    "created_at": "2011-10-05T17:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132870",
    "user": "jdemeyer"
}
```

Replying to [comment:7 lftabera]:
> We need to figure out which method use, one option is the following:
> 
>  - If nfinit structure is already known, use (or try) nfffactor(nfinit,f)
>  - If nfinit is not computed, try nffactor
>  - If the above fails, use factornf.
Agreed.  Except that we really should do `nfinit()` if the discriminant is easy.

> I am not yet sure what is the best way to proceed. I also feel that there should be a way for allowing the user to override the algorithm to use.
Why?  If one algorithm is clearly better than another, why complicate things with extra arguments?



---

archive/issue_comments_132871.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-05T17:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132871",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_132872.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-05T18:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132872",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_132873.json:
```json
{
    "body": "Attachment [11890_reviewer.patch](tarball://root/attachments/some-uuid/ticket11890/11890_reviewer.patch) by lftabera created at 2011-10-11 07:44:59",
    "created_at": "2011-10-11T07:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132873",
    "user": "lftabera"
}
```

Attachment [11890_reviewer.patch](tarball://root/attachments/some-uuid/ticket11890/11890_reviewer.patch) by lftabera created at 2011-10-11 07:44:59



---

archive/issue_comments_132874.json:
```json
{
    "body": "The solution here to test the use of nffactor is more elegant than in #10910 and with these patches there are no known failing cases. All doctest pases on sage-4.7.2-alpha3 + #11130 + #11891\n\nI give a positive review to Jeroen's patches but I add a patch that needs review with a couple of things:\n\n-On a complicated case we show that the discriminant is not fully factored by trial division.\n\n-The second example is a test case that shows that we really need the new version of Pari in #11130 this case will fail with older versions of Pari (See Pari bug pari bug #1207)",
    "created_at": "2011-10-11T07:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132874",
    "user": "lftabera"
}
```

The solution here to test the use of nffactor is more elegant than in #10910 and with these patches there are no known failing cases. All doctest pases on sage-4.7.2-alpha3 + #11130 + #11891

I give a positive review to Jeroen's patches but I add a patch that needs review with a couple of things:

-On a complicated case we show that the discriminant is not fully factored by trial division.

-The second example is a test case that shows that we really need the new version of Pari in #11130 this case will fail with older versions of Pari (See Pari bug pari bug #1207)



---

archive/issue_comments_132875.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-11T08:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132875",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_132876.json:
```json
{
    "body": "Reviewer patch looks good to me.  Thanks!\n\nFor those interested: the PARI bug is [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1207](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1207)",
    "created_at": "2011-10-11T08:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132876",
    "user": "jdemeyer"
}
```

Reviewer patch looks good to me.  Thanks!

For those interested: the PARI bug is [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1207](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1207)



---

archive/issue_comments_132877.json:
```json
{
    "body": "Attachment [11890_rebased.patch](tarball://root/attachments/some-uuid/ticket11890/11890_rebased.patch) by jdemeyer created at 2011-10-30 20:25:18\n\nTrivial rebase.",
    "created_at": "2011-10-30T20:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132877",
    "user": "jdemeyer"
}
```

Attachment [11890_rebased.patch](tarball://root/attachments/some-uuid/ticket11890/11890_rebased.patch) by jdemeyer created at 2011-10-30 20:25:18

Trivial rebase.



---

archive/issue_comments_132878.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132878",
    "user": "jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_132879.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-11-07T10:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11718#issuecomment-132879",
    "user": "jdemeyer"
}
```

Resolution: fixed
