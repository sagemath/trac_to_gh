# Issue 22909: Upgrade to MPIR 3.0 broke SAGE_FAT_BINARY=yes

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-06-06 08:37:29

CC:  wbhart jpflori

Keywords: mpir fat


```
[mpir-3.0.0] gcc version 5.2.1 20151010 (Ubuntu 5.2.1-22ubuntu2)
[mpir-3.0.0] ****************************************************
[mpir-3.0.0] Machine type (default): x86_64-unknown-linux-gnu
[mpir-3.0.0] Machine type (mpir): sandybridge-unknown-linux-gnu
[mpir-3.0.0] Building a 64-bit version of MPIR.
[mpir-3.0.0] Disable use of assembly because of GNU as < 2.23.
[mpir-3.0.0] Building MPIR with the C++ interface and (also) static libraries.
[mpir-3.0.0] ** Building with "fat binary" support for 64-bit CPUs **
[mpir-3.0.0] ------------------------------------------------------------------------
[mpir-3.0.0] Configuring MPIR with empty CFLAGS to determine the defaults:
[mpir-3.0.0] checking build system type... sandybridge-unknown-linux-gnu
[mpir-3.0.0] checking host system type... sandybridge-unknown-linux-gnu
...
[mpir-3.0.0] configure: error: no version of fat found in path: generic
[mpir-3.0.0] Error configuring MPIR (with CFLAGS unset).
[mpir-3.0.0] Consult /home/embray/src/sagemath/sage/local/var/tmp/sage/build/mpir-3.0.0/src/config.log for for details.
```


Any ideas?


---

Comment by embray created at 2017-06-06 09:05:49

I think I see--the part of Sage's `spkg-install` that outputs "Disable use of assembly because of GNU as < 2.23" is forcing `MPN_PATH=generic` which breaks the fat build.


---

Comment by embray created at 2017-06-06 09:10:37

However,


```
$ as --version
GNU assembler (GNU Binutils for Ubuntu) 2.24
Copyright 2013 Free Software Foundation, Inc.
This program is free software; you may redistribute it under the terms of
the GNU General Public License version 3 or later.
This program has absolutely no warranty.
This assembler was configured for a target of `x86_64-linux-gnu'.
```



---

Comment by jpflori created at 2017-06-06 09:13:24

Hum, but old gnu as do not support recent assembly opcodes...


---

Comment by jpflori created at 2017-06-06 09:14:33

Ah, so there is something wrong with the command line detecting the `as` version!
Can you try it in a shell?


---

Comment by embray created at 2017-06-06 09:37:09

This should fix it.

I also explicitly disabled `SAGE_FAT_BINARY` in this case, and added an additional warning message that it won't work.
----
New commits:


---

Comment by embray created at 2017-06-06 09:37:09

Changing status from new to needs_review.


---

Comment by jpflori created at 2017-06-06 14:15:40

I'd say it would be better to error out when one sets `SAGE_FAT_BINARY` and only provides an old `as`.


---

Comment by jpflori created at 2017-06-06 14:15:40

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-06-06 15:09:35

Yes, I suppose you're right--otherwise the build will still proceed but you'll wind up with a broken FAT_BINARY build and (possibly) have a hard time tracking exactly where it broke.


---

Comment by git created at 2017-06-08 15:21:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2017-06-08 15:23:49

A final minor comment: you check for version 2.24 but the message mentions "< 2.23".


---

Comment by git created at 2017-06-08 15:27:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-06-08 15:28:11

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-06-08 16:02:12

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-06-08 16:09:44

Thanks for the review!


---

Comment by jdemeyer created at 2017-06-08 18:14:35

Replying to [comment:9 embray]:
> Yes, I suppose you're right--otherwise the build will still proceed but you'll wind up with a broken FAT_BINARY build and (possibly) have a hard time tracking exactly where it broke.

Exactly. If the user sets `SAGE_FAT_BINARY=yes`, it is probably for a very good reason which cannot be ignored.


---

Comment by vbraun created at 2017-06-10 11:38:21

Resolution: fixed
