# Issue 28874: Specify a subset of sage command line options that are supported by sagelib - rather than sage-the-distribution

Issue created by migration from https://trac.sagemath.org/ticket/29111

Original creator: mkoeppe

Original creation time: 2020-01-30 16:12:13

CC:  fbissey isuruf dimpase embray saraedum arojas slelievre charpent mjo kcrisman

The `sage` script has a number of options that only make sense for sage-the-distribution, but do not make sense in downstream packaging of sage. Consequently, downstream packagers may install simple custom versions of the script that only provide a subset of the options.

Examples:
- `sage -sqlite` -- as discussed in #29002/#29092 -- because from a downstream packaging point of view, sage is not really responsible for providing sqlite, it's provided by justs another system package
- `sage -upgrade` -- only makes sense with sage-the-distribution built from source

We should specify the subset of sage command line options that must be supported in any deployment/packaging of sage. This is so that user packages can work reliably.

Examples:
- `sage -c SAGECOMMAND` -- obviously
- `sage -python -c COMMAND`
- `sage -t` -- because it is used by user packages for testing sage sources
- `sage -sh` ..... ?

(In addition to specifying this, we might actually want to split `src/bin/sage` into sagelib functionality and sage-the-distribution functionality.)

Context:
- https://groups.google.com/d/msg/sage-packaging/BmkxIBdwbvE/fRMl2sjdBQAJ
- #29060: Meta-ticket: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages


---

Comment by mkoeppe created at 2020-01-30 16:21:00

As I said on #29092, we should also move corresponding sage-the-distribution tests (such as those for `sage -sqlite`) mentioned in #29002) from `src` (which is for sagelib) to somewhere in `build` (which is for sage-the-distribution). Downstream packagers would ignore the sage-the-distribution tests.


---

Comment by mkoeppe created at 2020-01-31 15:00:31

Changing component from PLEASE CHANGE to scripts.


---

Comment by mkoeppe created at 2020-04-14 06:33:01

pushing these forward to 9.2


---

Comment by jhpalmieri created at 2020-06-16 20:15:08

I've asked this question before: if Sage is built with the system's Python, should we still keep `sage --python ...`? What is the difference between `sage --python` and `sage --sqlite3` (and what about `sage --gap`, `sage --singular`, etc.)?


---

Comment by jhpalmieri created at 2020-06-16 20:24:43

Here are some arguments that should always be allowed:

- `sage -t`
- `sage -c`
- `sage -h`
- `sage -n`, `sage --notebook`
- `sage --nodotsage`
- `sage -v`, `sage --version`

"Advanced" arguments:

- `sage --preparse`
- `sage --min`
- `sage -q`
- `sage --dumpversion`
- `sage --startuptime`
- `sage --fixdoctests`
- `sage --coverage`
- `sage --coverageall`
- `sage --grep`, `sage --search_src`, `sage --grepdoc`, `sage --search_doc`
- `sage --rst2ipynb`, `sage --ipynb2rst`

Maybe also `sage --sh`.

(I'm not saying is a complete list, but I would suggest these as a starting point.)


---

Comment by jhpalmieri created at 2020-06-16 20:42:45

By the way, `sage -twistd` doesn't work: there is no `twistd` executable since Sage 9.1. Plus we are removing the twisted package in #29754. See #29878.


---

Comment by fbissey created at 2020-06-16 21:03:19

Hum, this ticket reminds me that I need to clean the version in sage-on-gentoo

```
fbissey@moonloop ~ $ sage -advanced
SageMath version 9.2.beta1, Release Date: 2020-06-13

Running Sage:
  file.[sage|py|spyx] -- run given .sage, .py or .spyx file
  -advanced           -- print this advanced help message
  -c <cmd>            -- Evaluates cmd as sage code
  -h, -?              -- print short help message
  -min [...]          -- do not populate global namespace (must be first
                         option)
  -preparse <file.sage> -- preparse file.sage and produce corresponding file.sage.py
  -q                  -- quiet; start with no banner
  -gthread, -qthread, -q4thread, -wthread, -pylab
                      -- pass the option through to ipython
  -v, -version        -- display Sage version information
  -dumpversion        -- print Sage version

Running the notebook:
  --notebook=[...]    -- start the Sage notebook (valid options are
                         'default', 'sagenb', 'jupyter' and 'export').
                         Current default is 'export' sagenb to jupyter.
                         See the output of sage --notebook --help
                         for more details and examples of how to pass
                         optional arguments
  -inotebook [...]    -- start the *insecure* Sage notebook (deprecated)
  -n, -notebook [...] -- start the default Sage notebook (options are the
                         same as for the notebook command in Sage).  See the
                         output of sage -n -h for more details

Running external programs:
  -cleaner            -- run the Sage cleaner
  -cython [...]       -- run Cython with given arguments
  -ecl [...]          -- run Common Lisp
  -gap [...]          -- run Sage's Gap with given arguments
  -gdb                -- run Sage under the control of gdb
  -gp [...]           -- run Sage's PARI/GP calculator with given arguments
  -ipython [...]      -- run Sage's IPython using the default environment (not
                         Sage), passing additional options to IPython
  -ipython3 [...]     -- same as above, but using Python 3
  -jupyter [...]      -- run Sage's Jupyter with given arguments
  -kash [...]         -- run Sage's Kash with given arguments
                         (not installed currently, run sage -i kash)
  -lisp [...]         -- run Lisp interpreter included with Sage
  -M2 [...]           -- run Sage's Macaulay2 with given arguments
                         (not installed currently, run sage -i macaulay2)
  -maxima [...]       -- run Sage's Maxima with given arguments
  -mwrank [...]       -- run Sage's mwrank with given arguments
  -polymake [...]     -- run Sage's Polymake with given arguments
                         (not installed currently, run sage -i polymake)
  -python [...]       -- run the Python interpreter
  -python2 [...]      -- run the Python 2 interpreter
  -python3 [...]      -- run the Python 3 interpreter
  -R [...]            -- run Sage's R with given arguments
  -sh [...]           -- run $SHELL (/bin/bash) with Sage environment variables
  -singular [...]     -- run Sage's singular with given arguments
  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments
  -twistd [...]       -- run Twisted server

Testing the Sage library:
  -startuptime [module] -- display how long each component of Sage takes to
                         start up; optionally specify a module to get more
                         details about that particular module
  -t [options] <--all|files|dir>
                      -- test examples in .py, .pyx, .sage, .tex or .rst files
                         selected options:
                           --long - include lines with the phrase 'long time'
                           --verbose - print debugging output during the test
                           --all - test all files
                           --sagenb - test all sagenb files
                           --optional - controls which optional tests are run
                           --initial - only show the first failure per block
                           --debug - drop into PDB after an unexpected error
                           --failed - only test files that failed last test
                           --warn-long [timeout] - warning if doctest is slow
                           --only-errors - only output failures, not successes
                           --gc=GC - control garbarge collection (ALWAYS:
                                     collect garbage before every test; NEVER:
                                     disable gc; DEFAULT: Python default)
                           --help - show all testing options
  -tp <N> [...]       -- like -t above, but tests in parallel using N threads
                         with 0 interpreted as a sensible default
  -testall [options]  -- test all source files, docs, and examples.  options
                         like -t

File conversion:
  -rst2ipynb [...]    -- Generates Jupyter notebook (.ipynb) from standalone
                         reStructuredText source.
                         (not installed currently, run sage -i rst2ipynb)
  -ipynb2rst [...]    -- Generates a reStructuredText source file from
                         a Jupyter notebook (.ipynb).

Valgrind memory debugging:
  -cachegrind         -- run Sage using Valgrind's cachegrind tool.  The log
                         files are named sage-cachegrind.PID can be found in
                         
  -callgrind          -- run Sage using Valgrind's callgrind tool.  The log
                         files are named sage-callgrind.PID can be found in
                         
  -massif             -- run Sage using Valgrind's massif tool.  The log
                         files are named sage-massif.PID can be found in
                         
  -memcheck           -- run Sage using Valgrind's memcheck tool.  The log
                         files are named sage-memcheck.PID can be found in
                         
  -omega              -- run Sage using Valgrind's omega tool.  The log
                         files are named sage-omega.PID can be found in
                         
  -valgrind           -- this is an alias for -memcheck

You can also use -- before a long option, e.g., 'sage --optional'.
```

I have to drop the py2/py3 stuff for just defaut python. I dropped `-sh` the day I dropped `sage-env` altogether, the main point of keeping `sage -sh` around was to check or use the environment set by `sage-env`.


---

Comment by mkoeppe created at 2020-06-16 22:17:23

Dropping `sage -sh` is a bad idea. User packages need this


---

Comment by mkoeppe created at 2020-06-16 22:19:01

Replying to [comment:6 jhpalmieri]:
> I've asked this question before: if Sage is built with the system's Python, should we still keep `sage --python ...`? What is the difference between `sage --python` and `sage --sqlite3` (and what about `sage --gap`, `sage --singular`, etc.)?

`sage -python` means: run the python that sage runs in.
In distributions, this could just be plain Python.

Install scripts of user packages need this.


---

Comment by fbissey created at 2020-06-16 22:29:34

Replying to [comment:10 mkoeppe]:
> Dropping `sage -sh` is a bad idea. User packages need this

Certainly, vanilla sage does need it. In sage-on-gentoo at best you would have a normal shell since I dropped sage-env altogether.


---

Comment by mkoeppe created at 2020-06-16 22:32:13

Replying to [comment:13 fbissey]:
> Replying to [comment:10 mkoeppe]:
> > Dropping `sage -sh` is a bad idea. User packages need this
> 
> Certainly, vanilla sage does need it. In sage-on-gentoo at best you would have a normal shell since I dropped sage-env altogether.

Yes, vanilla shell is fine. The point is that user packages need the _interface_.


---

Comment by fbissey created at 2020-06-16 22:36:26

Now, I understand what you mean. User scripts may start with `sage -sh` and what not. I completely forgot about that when I removed it - even though that was one of the reason I was keeping it around. I will re-instate it as a vanilla shell or no-op for compatibility.


---

Comment by mkoeppe created at 2020-06-16 22:39:02

Great!


---

Comment by mkoeppe created at 2020-06-16 23:02:49

Here's a beginning of what I have in mind. 
----
New commits:


---

Comment by jhpalmieri created at 2020-06-16 23:12:47

Okay, I'm fine with keeping `sage --python`. What about `sage --singular` et al.? Should `src/bin/sage` be constructed by `./configure`, adding arguments when the corresponding packages are going to be installed by Sage? Or is that too complicated?


---

Comment by mkoeppe created at 2020-06-16 23:14:17

Replying to [comment:20 jhpalmieri]:
> Okay, I'm fine with keeping `sage --python`. What about `sage --singular` et al.? 

I think those should be moved to `sage-site` as well. (Also the printing of these in the help text...)

> Should `src/bin/sage` be constructed by `./configure`, adding arguments when the corresponding packages are going to be installed by Sage? Or is that too complicated?

I think that's too complicated


---

Comment by mjo created at 2020-06-16 23:40:03

> sage --grep, sage --search_src, sage --grepdoc, sage --search_doc

At the risk of starting another holy war, we shouldn't expect these to work on a distribution because we shouldn't expect the source files to be available after installation. My current sage.git checkout contains 71MiB of *.py files that are entirely redundant after the optimized .opt-2.pyc files are generated. Someone is eventually going to realize that they shouldn't be installed after this gets more popular.


---

Comment by mkoeppe created at 2020-06-16 23:44:32

We could just conditionalize these ones based on whether SAGE_SRC is set or not by sage-env...


---

Comment by git created at 2020-06-16 23:58:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-17 00:13:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-17 00:29:58

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-17 00:29:58

All, please review, or feel free to push more changes to this ticket.


---

Comment by git created at 2020-06-17 16:55:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-17 17:08:04

There are also various options regarding notebooks that may need updating. If someone knows about the details, please push changes to the branch


---

Comment by jhpalmieri created at 2020-06-17 17:23:20

Speaking of holy wars, this has reminded me of #21, which I am thinking of trying to revive. I'll see if I have time to work on that. For this ticket, we could remove `-inotebook`, and `sagenb` is no longer a valid option for `-notebook`.


---

Comment by kcrisman created at 2020-06-17 17:34:54

> Speaking of holy wars, this has reminded me of #21, which I am thinking of trying to revive. I'll see if I have time to work on that. 

Or holy grails!

> For this ticket, we could remove `-inotebook`, and `sagenb` is no longer a valid option for `-notebook`.


I don't remember all the options for `-notebook`, but I think it would be helpful to have some sort of warning message (or page?) that `sagenb` would raise, rather than removing it completely.  For instance, it could just open the export-to-Jupyter page by default, with an extra little warning template that "if you want to use the old sagenb, please use Sage prior to 9.x".  Probably what anyone who tries to use sagenb would want is the export at this point, and this is one way to inform them.

John, what does your branch give for `sage -n -h` or `sage --notebook --help` which is somewhat prominently mentioned in the `sage -advanced` help?  Is any of what comes out of that still valid?
----
New commits:


---

Comment by jhpalmieri created at 2020-06-17 17:37:09

I think that the default for `sage --notebook` should now be `jupyter`. This involves only editing `sage-notebook`, and  belongs on a separate ticket: #29885.
----
New commits:


---

Comment by jhpalmieri created at 2020-06-17 17:38:17

The branch here doesn't change `sage -n -h`. The branch at #29885 removes "sagenb" from this part of the help message:

```
  --notebook [NOTEBOOK], -n [NOTEBOOK], -notebook [NOTEBOOK]
                        The notebook to run [one of: default, sagenb, ipython,
                        jupyter, jupyterlab, export]. Default is export
```



---

Comment by jhpalmieri created at 2020-06-17 17:40:02

Oh, and with the branch at #29885, running `sage -n sagenb` prints

```
CRITICAL:root:cannot use the legacy notebook SageNB with Python 3
The legacy notebook does not work under Python 3; use the Jupyter notebook.
See https://wiki.sagemath.org/Python3-Switch
```

The branch here prints something similar, just a bit less grammatical ;)


---

Comment by jhpalmieri created at 2020-06-17 17:41:56

One more thing:

> it could just open the export-to-Jupyter page by default

this has been the standard behavior for a while. At #29885, I am proposing changing this to make running the Jupyter notebook the default behavior. We should probably continue the notebook discussion at #29885.


---

Comment by kcrisman created at 2020-06-17 17:46:28

> We should probably continue the notebook discussion at #29885.

Sure, it's not a big deal in any case.


---

Comment by jhpalmieri created at 2020-06-17 17:46:52

Should #29884 be a dependency for this ticket, or are we also going to manually fix `src/doc/en/reference/repl/options.rst`?


---

Comment by mkoeppe created at 2020-06-17 18:37:25

Replying to [comment:39 jhpalmieri]:
> Should #29884 be a dependency for this ticket, or are we also going to manually fix `src/doc/en/reference/repl/options.rst`?

I'll work on the automatic generation in #29884 now. 
If you could check if anything from ``options.rst`` should be added to the help text, that would be helpful.


---

Comment by mkoeppe created at 2020-06-17 18:58:23

#29884 is ready now


---

Comment by mkoeppe created at 2020-06-17 19:05:46

New commits:


---

Comment by git created at 2020-06-17 19:08:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-17 19:57:16

Replying to [comment:40 mkoeppe]:
> Replying to [comment:39 jhpalmieri]:
> > Should #29884 be a dependency for this ticket, or are we also going to manually fix `src/doc/en/reference/repl/options.rst`?
> 
> I'll work on the automatic generation in #29884 now. 
> If you could check if anything from `options.rst` should be added to the help text, that would be helpful. 

I tend to like the extra details `options.rst` more than what is printed by `sage --advanced`. Would it be too verbose if we used (more or less) the current `options.rst` for the output to `sage --advanced`?

I would also organize it differently, distinguishing the options that are not available in distros.


---

Comment by mkoeppe created at 2020-06-17 20:09:13

Replying to [comment:45 jhpalmieri]:
> Replying to [comment:40 mkoeppe]:
> > Replying to [comment:39 jhpalmieri]:
> > > Should #29884 be a dependency for this ticket, or are we also going to manually fix `src/doc/en/reference/repl/options.rst`?
> > 
> > I'll work on the automatic generation in #29884 now. 
> > If you could check if anything from `options.rst` should be added to the help text, that would be helpful. 
> 
> I tend to like the extra details `options.rst` more than what is printed by `sage --advanced`. Would it be too verbose if we used (more or less) the current `options.rst` for the output to `sage --advanced`?

Sounds good to me.

> I would also organize it differently, distinguishing the options that are not available in distros.

Right, that would be done by moving these into the `sage-site` function `usage_advanced`. They are printed below the ones from `sage -advanced`.


---

Comment by jhpalmieri created at 2020-06-17 22:52:42

Here are some proposed changes to `sage --advanced`. I have a strong preference for two hyphens in `sage --long-option` over `sage -long-option`. I don't object to Sage parsing the two the same way, but I think we should advertise the two-hyphen version. (If we had a different argument parser, then `sage -info` would be interpreted as `sage -i -n -f -o`, whereas `sage --info` is less ambiguous.)

I wasn't sure how to divide everything between the two files, but it's another draft to work with.
----
New commits:


---

Comment by jhpalmieri created at 2020-06-17 22:56:18

Other comments: `--fix-pkg-checksums` was deprecated, so I removed it from the help string. `--gap3` does not need to be in the basic `sage -h` message: it comes from an experimental package. For me, `sage -?` doesn't work, because the shell tries to parse `?`. So I removed that from the `sage -h` message.


---

Comment by git created at 2020-06-17 22:56:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-18 00:18:37

I agree with these changes.

Some comments on `sage --advanced`:

1) I think `--grep ...--search_doc` should go to `src/bin/sage`, conditionalized on `$SAGE_SRC`

2) I think `--gdb*, `--python*`, --ipython*`, `--pip`, and perhaps `--jupyter*`  should go to `src/bin/sage`

3) Also `--sh` (but NOT `--buildsh`) and `--cleaner` should go to `src/bin/sage`


---

Comment by fbissey created at 2020-06-18 01:30:02

It is very close to something I am willing to ship out of the box in Gentoo. I will mostly echo `@`mkoeppe last comment. (2) and (3) are totally acceptable in distros. I certainly can run under `gdb` for example, in fact it is bizarre that `gdb` is treated differently from `valgrind` et al. (1) in the way suggested is acceptable.

Also, I think you have an alignment problem in `src/bin/sage` right now.

```
+    echo "  --dumpversion        -- print brief Sage version"
+    echo "  --preparse file.sage -- preparse \"file.sage\", and produce"
+    echo "                          the corresponding Python file"
+    echo "                          \"file.sage.py\""
+    echo "  -q                   -- quiet; start with no banner"
+    echo "  --min                -- do not populate global namespace"
+    echo "                          (must be first option)"
+    echo "   --nodotsage          -- run Sage without using the user's"
+    echo "                          .sage directory: create and use a temporary"
+    echo "                          .sage directory instead."
+    echo "   --gthread, --qthread, --q4thread, --wthread, --pylab"
+    echo "                        -- pass the option through to IPython"
```

`--nodotsage` and `--gthread` are one space further to the left than `-q` and `--min`.


---

Comment by jhpalmieri created at 2020-06-18 03:27:27

Is there a reason for this difference in the `sage` script?

```
usage() {
...
        exec "$SAGE_ROOT/build/bin/sage-site" "-h"
...
```

vs

```
usage_advanced() {
...
       "$SAGE_ROOT/build/bin/sage-site" "--advanced"
...
```



---

Comment by git created at 2020-06-18 03:31:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-18 03:31:59

Replying to [comment:54 jhpalmieri]:
> Is there a reason for this difference in the `sage` script?
> {{{
> usage() {
> ...
>         exec "$SAGE_ROOT/build/bin/sage-site" "-h"
> ...
> }}}
> vs
> {{{
> usage_advanced() {
> ...
>        "$SAGE_ROOT/build/bin/sage-site" "--advanced"
> ...
> }}}

FYI: I changed both to use `exec`. Feel free to change back if this is wrong.


---

Comment by git created at 2020-06-18 03:34:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-18 03:34:47

`sage-fix-pkg-checksums` was deprecated four years ago (#19984), so I deleted it.


---

Comment by git created at 2020-06-18 03:38:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2020-06-18 04:10:11

One last thing I should have commented on earlier

```
+    echo "  -bn [...], --build-and-notebook [...]"
+    echo "                      -- build the Sage library (as by running \"sage -b\")"
+    echo "                         and then start the notebook"
```

is currently in `src/bin/sage` but really any `-b` options belong to `sage-site` and nowhere else.


---

Comment by git created at 2020-06-18 04:44:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-18 04:47:20

Replying to [comment:60 fbissey]:
> One last thing I should have commented on earlier
> {{{
> +    echo "  -bn [...], --build-and-notebook [...]"
> +    echo "                      -- build the Sage library (as by running \"sage -b\")"
> +    echo "                         and then start the notebook"
> }}}
> is currently in `src/bin/sage` but really any `-b` options belong to `sage-site` and nowhere else.

Okay, moved, but on the other hand, I think that the `coverage` options belong with doctesting, so I moved those from `sage-site` to `sage`.


---

Comment by mkoeppe created at 2020-06-18 04:50:47

Replying to [comment:58 jhpalmieri]:
> `sage-fix-pkg-checksums` was deprecated four years ago (#19984), so I deleted it.
Excellent!


---

Comment by fbissey created at 2020-06-18 04:56:10

Replying to [comment:62 jhpalmieri]:
> Okay, moved, but on the other hand, I think that the `coverage` options belong with doctesting, so I moved those from `sage-site` to `sage`.

Never shipped them before, they don't look harmful but it is more development focused than a test suite is. A test suite is run by anyone who wants to check that their install has a certain level of "sanity". coverage is really a tool for devs that look for something to do.

In any case that's not super harmful unlike `-b`.


---

Comment by mkoeppe created at 2020-06-18 04:57:50

Replying to [comment:56 jhpalmieri]:
> FYI: I changed both to use `exec`. Feel free to change back if this is wrong.

That's fine. In a previous version, `-advanced` printed a line after returning from `sage-site`. That's no longer needed.


---

Comment by mkoeppe created at 2020-06-18 05:01:46

Replying to [comment:64 fbissey]:
> Replying to [comment:62 jhpalmieri]:
> > Okay, moved, but on the other hand, I think that the `coverage` options belong with doctesting, so I moved those from `sage-site` to `sage`.
> 
> Never shipped them before, they don't look harmful but it is more development focused than a test suite is. A test suite is run by anyone who wants to check that their install has a certain level of "sanity". coverage is really a tool for devs that look for something to do.

Note that like `sage -t`, also `sage -coverage` can be run on user code, not just on Sage sources.


---

Comment by jhpalmieri created at 2020-06-18 05:03:17

Replying to [comment:66 mkoeppe]:
> Replying to [comment:64 fbissey]:
> > Replying to [comment:62 jhpalmieri]:
> > > Okay, moved, but on the other hand, I think that the `coverage` options belong with doctesting, so I moved those from `sage-site` to `sage`.
> > 
> > Never shipped them before, they don't look harmful but it is more development focused than a test suite is. A test suite is run by anyone who wants to check that their install has a certain level of "sanity". coverage is really a tool for devs that look for something to do.
> 
> Note that like `sage -t`, also `sage -coverage` can be run on user code, not just on Sage sources.

Right, that was my thought, too. And then it didn't make sense to separate `coverage` and `coverageall`.


---

Comment by fbissey created at 2020-06-18 05:04:36

It is fine. I will ship those two then. It makes sense.


---

Comment by mkoeppe created at 2020-06-18 06:44:31

Looks great to me. Let's get this in.


---

Comment by jhpalmieri created at 2020-06-18 17:50:01

I have a few more questions:

- I would like to delete the `-rsyncdist` option. Can we also delete `sage-rsyncdist`? The file itself says "NOTE: This script is of little use after the git transition and will be deleted eventually."

- Is it worth moving handling of `-gap` et al. to `sage-site`, which is where they are documented?

- A comment: it would be nice to move `sage --sdist` handling to `sage-site`, but then we have to duplicate `maybe_sage_location`, so it's probably not worth it. Although then we could move `sage -b` handling, too. This can be done later, if someone feels motivated.


---

Comment by mkoeppe created at 2020-06-18 18:20:33

Replying to [comment:70 jhpalmieri]:
> - I would like to delete the `-rsyncdist` option. Can we also delete `sage-rsyncdist`? The file itself says "NOTE: This script is of little use after the git transition and will be deleted eventually."

Sure, let's get rid of it. There are a number of references to what looks like old-style SPKGs in this script. It was updated last in 2013. So it is likely outdated and broken already.

> - Is it worth moving handling of `-gap` et al. to `sage-site`, which is where they are documented?

Yes, good idea, please go ahead.

> - A comment: it would be nice to move `sage --sdist` handling to `sage-site`, but then we have to duplicate `maybe_sage_location`, so it's probably not worth it. Although then we could move `sage -b` handling, too. This can be done later, if someone feels motivated.

I would suggest to do these in a follow-up ticket. Likewise, for the option handling for `sage -i` that would really belong to `sage-site`; this is complicated by the fact that `sage-env` must not be sourced before `sage-spkg` is executed.


---

Comment by jhpalmieri created at 2020-06-18 18:47:56

Here's a problem: I currently have for the `sage --advanced` message

```
    if [ -n "$SAGE_SRC" -a -d "$SAGE_SRC" ]; then
        echo "  --grep [options] <string>"
        ...
```

At this point, `sage-env` hasn't been run. Can I change `$SAGE_SRC` to `$SAGE_ROOT/src`? Failing this, we can move this part of the help message to `sage-site`.


---

Comment by mkoeppe created at 2020-06-18 18:51:36

The intention of using `SAGE_SRC` from `sage-env` here is that packagers would leave it undefined if they do not package a distribution.

How about moving the handling of `-h`, `-advanced` below the sourcing of `sage-env`?


---

Comment by git created at 2020-06-18 18:55:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-06-18 18:56:49

I used `SAGE_ROOT/src`, but of course this can be changed. There were a few failing doctests  in `tests/cmdline.py` (mainly because of rewordings in the documentation), now fixed.


---

Comment by jhpalmieri created at 2020-06-18 19:02:49

And now I'm confused about `sage -p`. This was being actively tested in `tests/cmdline.py`:

```
    Test ``sage --info [packages]`` and the equivalent
    ``sage -p --info --info [packages]`` (the doubling of ``--info``
    is intentional, that option should be idempotent)::
```

Do we indeed remove it?


---

Comment by mkoeppe created at 2020-06-18 19:07:03

Replying to [comment:75 jhpalmieri]:
> I used `SAGE_ROOT/src`

Fine. Note `[ -n "$SAGE_ROOT/src" ]` is always true, so it can be simplified


---

Comment by git created at 2020-06-18 20:13:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2020-06-18 20:16:24

Replying to [comment:77 mkoeppe]:
> Replying to [comment:75 jhpalmieri]:
> > I used `SAGE_ROOT/src`
> 
> Fine. Note `[ -n "$SAGE_ROOT/src" ]` is always true, so it can be simplified

Sorry, I missed this before pushing the branch. I've moved `usage_advanced` to after sourcing sage-env. Now `--grep` et al. show up in the message for me. I've also restored `sage -p`: I don't think this is the ticket to debate whether to remove it, that should be done on another ticket. (Admittedly, now it is no longer listed in `sage -h` or `sage --advanced`, so either it should be listed or it should be removed. But I don't know which way to go with it.)


---

Comment by jhpalmieri created at 2020-06-18 20:18:20

I also did a lot of reorganizing of the `sage` script, trying to group the different options into sensible ways. The patch is a bit of a mess, so the file itself might be easier to browse through for changes.


---

Comment by mkoeppe created at 2020-06-18 21:00:35

Replying to [comment:79 jhpalmieri]:
> I've also restored `sage -p`: I don't think this is the ticket to debate whether to remove it, that should be done on another ticket. 

It was removed in #29289, a dependency of this ticket.


---

Comment by git created at 2020-06-18 21:15:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2020-06-18 21:19:29

I've tried to undo my changes to `sage -p`.


---

Comment by mkoeppe created at 2020-06-18 22:34:25

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-06-19 05:40:16

Rebased on top of the new version of #29289
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-19 05:46:47

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-19 05:48:51

By the way, `sage-site` -- is this a good name for this script?


---

Comment by jhpalmieri created at 2020-06-19 17:55:14

Replying to [comment:88 mkoeppe]:
> By the way, `sage-site` -- is this a good name for this script?

I can't think of anything better.


---

Comment by mkoeppe created at 2020-06-21 00:01:19

`@`fbissey, could you take another look so we can finalize this ticket?


---

Comment by fbissey created at 2020-06-21 00:05:32

Replying to [comment:91 mkoeppe]:
> `@`fbissey, could you take another look so we can finalize this ticket?

I'll have a look after my lunch.


---

Comment by fbissey created at 2020-06-21 01:50:55

OK, so I am having this look over, mainly at `sage` and what is now called `sage-site`. And I have to say splitting the stuff is not easy and subject to controversy so what I say is not going to be the final word on the matter.

This branch version of `sage` still execute numerous options that are not listed in the sage menu but that would be displayed by `sage-site`.
* `--upgrade`
* `--buildsh`
* `-i`
* `-f`
* the function `build_sage` (I would have thought it belonged to `sage-site`)
* same with `maybe_sage_location`
* all `-b` options
I recognise that some of these may have to live there for technical reason. Splitting `--sh` and `--buildsh` for example would lead to code duplication - unless someone also does some refactoring. But as it is now, they could be accidentally called from a sage-on-distro shipping this file. If they have to stay there, we should get a check on `SAGE_ROOT` before executing them and display some error message if it is not defined. Like "not available in this distribution of sagemath".

Conversely I thought calling on sage's version of various packages (`gap`, `singular`, `maxima`, etc...) was to stay in the main `sage` script rather than move to `sage-site`. They usually execute normally with system installed packages and may be required for running some user scripts.


---

Comment by mkoeppe created at 2020-06-21 02:03:32

Replying to [comment:93 fbissey]:
> This branch version of `sage` still execute numerous options that are not listed in the sage menu but that would be displayed by `sage-site`. [...]
> I recognise that some of these may have to live there for technical reason. 

Right, this ticket is certainly not meant as the final word on splitting the script. 
But by splitting the help strings on this ticket, we define the interface, and this is to me the most important part.  The patch is already huge, and it is best to do further refactoring and refinements in narrower follow-up tickets.

> as it is now, they could be accidentally called from a sage-on-distro shipping this file. If they have to stay there, we should get a check on `SAGE_ROOT` before executing them and display some error message if it is not defined. Like "not available in this distribution of sagemath".

This sounds like a good idea, but I would also prefer to do this on a follow-up ticket.

> Conversely I thought calling on sage's version of various packages (`gap`, `singular`, `maxima`, etc...) was to stay in the main `sage` script rather than move to `sage-site`. They usually execute normally with system installed packages and may be required for running some user scripts.

It would be fine with me to move them back to `sage`.


---

Comment by fbissey created at 2020-06-21 02:31:45

Replying to [comment:94 mkoeppe]:
> Replying to [comment:93 fbissey]:
> > This branch version of `sage` still execute numerous options that are not listed in the sage menu but that would be displayed by `sage-site`. [...]
> > I recognise that some of these may have to live there for technical reason. 
> 
> Right, this ticket is certainly not meant as the final word on splitting the script. 
> But by splitting the help strings on this ticket, we define the interface, and this is to me the most important part.  The patch is already huge, and it is best to do further refactoring and refinements in narrower follow-up tickets.
> 

I am OK with that. Let's get the interface where we want it then.

> > as it is now, they could be accidentally called from a sage-on-distro shipping this file. If they have to stay there, we should get a check on `SAGE_ROOT` before executing them and display some error message if it is not defined. Like "not available in this distribution of sagemath".
> 
> This sounds like a good idea, but I would also prefer to do this on a follow-up ticket.
> 

This is acceptable. 9.2 is not getting anywhere very fast :) To put things in perspective I was thinking of having a function rather than writing a very similar piece of code all over the place.

> > Conversely I thought calling on sage's version of various packages (`gap`, `singular`, `maxima`, etc...) was to stay in the main `sage` script rather than move to `sage-site`. They usually execute normally with system installed packages and may be required for running some user scripts.
> 
> It would be fine with me to move them back to `sage`.
> 

Right, since we want to set the interface right we have to decide if this is something that is important for the distribution to support. On one side, it just works like it is, on the other side it is redundant with calling the application directly. The only interesting point is whether there are scripts out there that needs this for compatibility. 

These direct calls to various applications could also be replaced by `sage --sh $app`, `sage --sh` was actually developed some time after those direct calls were put in place (IIRC). So a migration path could be suggested and they could be deprecated. That would be yet another follow up ticket.


---

Comment by mkoeppe created at 2020-06-21 02:59:09

Replying to [comment:95 fbissey]:
> > > Conversely I thought calling on sage's version of various packages (`gap`, `singular`, `maxima`, etc...) was to stay in the main `sage` script rather than move to `sage-site`. They usually execute normally with system installed packages and may be required for running some user scripts.
> > 
> > It would be fine with me to move them back to `sage`.
> > 
> 
> Right, since we want to set the interface right we have to decide if this is something that is important for the distribution to support. On one side, it just works like it is, on the other side it is redundant with calling the application directly. The only interesting point is whether there are scripts out there that needs this for compatibility. 
> 
> These direct calls to various applications could also be replaced by `sage --sh $app`, `sage --sh` was actually developed some time after those direct calls were put in place (IIRC). 

Thanks for the context.

> So a migration path could be suggested and they could be deprecated. That would be yet another follow up ticket.

I agree. We should go in this direction by deprecating these shortcuts `sage -$app` first. That would be a separate ticket.

So for this ticket, I will move them back into the `sage` script unless `@`jhpalmieri objects.


---

Comment by jhpalmieri created at 2020-06-21 05:04:44

Go ahead, I don't have strong feelings about it.

I also like the idea of testing `SAGE_ROOT` before executing `sage -b` etc. But doing it on a followup ticket is fine.


---

Comment by git created at 2020-06-21 05:40:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-21 05:40:50

done, please check if you have a chance


---

Comment by jhpalmieri created at 2020-06-21 22:41:53

What is `sage --axiom` supposed to do? What package installs an `axiom` executable?


---

Comment by fbissey created at 2020-06-21 22:44:50

Did we drop the packaging of `axiom`? http://axiom.axiom-developer.org/


---

Comment by jhpalmieri created at 2020-06-21 23:03:20

Not as a new-style package, and I couldn't find the website with old-style packages. Does it still exist?


---

Comment by fbissey created at 2020-06-21 23:07:19

There is here http://old.files.sagemath.org/spkg/archive/ which I could go from here http://files.sagemath.org/spkg/


---

Comment by jhpalmieri created at 2020-06-21 23:10:14

Oh, so it's from 2007?!


---

Comment by jhpalmieri created at 2020-06-21 23:10:18

See #29930 for a discussion of `sage --gap` and friends.


---

Comment by jhpalmieri created at 2020-06-21 23:15:58

The Sage `axiom` package requires `clisp`. I changed the `spkg-install` file to use `ecl` instead, but it failed. I am going to out on a limb and suggest that no one is using this spkg with a recent version of Sage.


---

Comment by fbissey created at 2020-06-21 23:17:19

You have my full support to remove this piece of cruft.


---

Comment by mkoeppe created at 2020-06-22 05:18:05

Does perhaps `fricas` install itself under the name `axiom`?


---

Comment by jhpalmieri created at 2020-06-22 05:35:33

Good idea. From http://fricas.sourceforge.net/history.html, it looks like FriCAS is a fork of Axiom, but I just installed it, and it doesn't install `axiom` (at least not in `SAGE_ROOT/local/bin`, nor is `axiom` listed in its package manifest). It installs `fricas` and `efricas`, so we could eventually add those, but it's not like anyone's been clamoring for them.


---

Comment by mkoeppe created at 2020-06-22 05:46:51

Then let's just drop `sage --axiom`. Good catch!


---

Comment by dimpase created at 2020-06-22 06:03:31

is axiom package an old-style one?

It's probably very outdated. also, my impression is that fricas fork is the most active of all the forks of the original axiom forks.
The others are http://www.axiom-developer.org/ (axiom) and http://www.open-axiom.org/links.html (OpenAxiom)


---

Comment by mkoeppe created at 2020-06-22 17:42:46

That's right, there is no new-style `axiom` package.


---

Comment by git created at 2020-06-22 17:44:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-22 17:45:10

Done. Needs review


---

Comment by jhpalmieri created at 2020-06-22 18:52:31

I'm happy with everything. Who else would like to weigh in?


---

Comment by fbissey created at 2020-06-23 20:46:53

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-06-23 20:46:53

Sorry, I was busy and forgot about it. We have reached an agreement with what goes in and what's next. I think we have bashed it enough and it is ready to go.


---

Comment by mkoeppe created at 2020-06-23 21:11:38

Thanks!


---

Comment by jhpalmieri created at 2020-06-23 21:44:36

<thumbs up emoji>


---

Comment by mkoeppe created at 2020-06-23 21:50:03

Follow-ups: 
 - #21559: Install `src/bin` scripts by sagelib's `setup.py`, not `make`
 - #29930: Change handling of `sage --APP`


---

Comment by vbraun created at 2020-07-08 22:50:50

Merge confilct


---

Comment by vbraun created at 2020-07-08 22:50:50

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-07-08 22:59:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-08 22:59:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-08 23:00:22

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-07-10 19:34:16

Resolution: fixed


---

Comment by mkoeppe created at 2022-04-25 02:25:50

Follow-up in #33753
