# Issue 10173: relative norm in relative number fields is slow

Issue created by migration from https://trac.sagemath.org/ticket/10174

Original creator: thome

Original creation time: 2010-10-26 12:39:44

Assignee: davidloeffler

There seems to be no relative_norm or absolute_norm method for elements of relative number fields (while there is for ideals). norm() works with an optional base parameter, which can be set to the base field for obtaining the relative norm.

However it's dog slow.

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s
Wall time: 0.45 s

The attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s


---

Comment by thome created at 2010-10-26 12:42:25

proposed patch


---

Comment by lftabera created at 2010-10-26 13:52:25

Changing status from new to needs_work.


---

Attachment

This will also improve the trace in the important case where the field is the base field.

I think I would call self.base_ring() instead of self.parent().base_field()

I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).

Also, you need to add a doctest for the change.


---

Attachment


---

Attachment

Replying to [comment:1 lftabera]:
> This will also improve the trace in the important case where the field is the base field.

yes indeed.
 
> I think I would call self.base_ring() instead of self.parent().base_field()

done

> I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).

indeed. I considered at first it wasn't worth the trouble, but it's so ridiculously expensive that the 1-line additional diff is worth it, I believe.

> Also, you need to add a doctest for the change.

Sure, done. However there's no difference in functionality beyond speed.

E.


---

Attachment

Note that the code you have added for the case base = R is never executed. You are comparing base which is (presumably) a field with self which is a NumberFieldElement.

Also the code for the case *base is self.parent()* is wrong, it will not work in the following case:


```
sage: f = R.random_element()
sage: matrix(1,1,[f]) == f.matrix(R)
False
}}} 

I would also add a doctest for a random element as f above.

One last comment. In the doctest you write
{{{
sage: K.<v>=NumberField(QQ['x']([64321, 0, 514, 0, 1]))
}}}

while correct, it can be confusing for the nonexperienced reader. Would it not be more convenient something like?

{{{
sage: x = QQ['x'].gen()
sage: K.<v>=NumberField(QQ[x](x^4 + 514*x^2 + 64321))
sage: R.<r>=NumberField(K[x](x^2 + 4*v*x + 5*v^2 + 514))
}}}

I could make the changes myself, but I prefer not to change the patch to give later a faster possitive review.


---

Attachment


---

Comment by thome created at 2010-10-27 09:20:14

You are right, sorry for the buggy code. That one should be better.


---

Comment by thome created at 2010-10-27 09:36:15

Changing status from needs_work to needs_review.


---

Comment by lftabera created at 2010-10-27 15:39:43

Changing status from needs_review to positive_review.


---

Attachment

The patch applies cleanly and passes all doctests.

The main advantage is that the result of matrix is cached for the base_field() so you do not have to recompute it. However, when casting directly matrix(self.base_ring()) then caching was not taken into account and the method to compute the matrix is harder. Thome's patch corrects this. The case matrix(self.parent()) is also taken into account separately.

I have added another patch that allows the documentation to build without problems. But, since it is a trivial typo in thome's patch I feel I can give a possitive review.


---

Comment by lftabera created at 2010-10-27 15:39:43

Changing keywords from "" to "Efficiency, number field, matrix".


---

Comment by jdemeyer created at 2010-11-01 10:18:04

Resolution: fixed
