# Issue 10173: relative norm in relative number fields is slow

archive/issues_010173.json:
```json
{
    "body": "Assignee: @loefflerd\n\nThere seems to be no relative_norm or absolute_norm method for elements of relative number fields (while there is for ideals). norm() works with an optional base parameter, which can be set to the base field for obtaining the relative norm.\n\nHowever it's dog slow.\n\nsage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\nsage: L.<w>,e=K.galois_closure(map=True)\nsage: R.<r,v>=L.relativize(e)\nsage: time _=r.norm(K)\nCPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s\nWall time: 0.45 s\n\nThe attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:\n\nsage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\nsage: L.<w>,e=K.galois_closure(map=True)\nsage: R.<r,v>=L.relativize(e)\nsage: time _=r.norm(K)\nCPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s\nWall time: 0.00 s\n\nIssue created by migration from https://trac.sagemath.org/ticket/10174\n\n",
    "created_at": "2010-10-26T12:39:44Z",
    "labels": [
        "component: number fields",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "relative norm in relative number fields is slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10173",
    "user": "https://github.com/emmanuelthome"
}
```
Assignee: @loefflerd

There seems to be no relative_norm or absolute_norm method for elements of relative number fields (while there is for ideals). norm() works with an optional base parameter, which can be set to the base field for obtaining the relative norm.

However it's dog slow.

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s
Wall time: 0.45 s

The attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s

Issue created by migration from https://trac.sagemath.org/ticket/10174





---

archive/issue_comments_102933.json:
```json
{
    "body": "proposed patch",
    "created_at": "2010-10-26T12:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102933",
    "user": "https://github.com/emmanuelthome"
}
```

proposed patch



---

archive/issue_comments_102934.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2010-10-26T13:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102934",
    "user": "https://github.com/lftabera"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_102935.json:
```json
{
    "body": "Attachment [relative_norm.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.patch) by @lftabera created at 2010-10-26 13:52:25\n\nThis will also improve the trace in the important case where the field is the base field.\n\nI think I would call self.base_ring() instead of self.parent().base_field()\n\nI wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).\n\nAlso, you need to add a doctest for the change.",
    "created_at": "2010-10-26T13:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102935",
    "user": "https://github.com/lftabera"
}
```

Attachment [relative_norm.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.patch) by @lftabera created at 2010-10-26 13:52:25

This will also improve the trace in the important case where the field is the base field.

I think I would call self.base_ring() instead of self.parent().base_field()

I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).

Also, you need to add a doctest for the change.



---

archive/issue_comments_102936.json:
```json
{
    "body": "Attachment [relative_norm.2.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.2.patch) by @emmanuelthome created at 2010-10-26 14:28:05",
    "created_at": "2010-10-26T14:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102936",
    "user": "https://github.com/emmanuelthome"
}
```

Attachment [relative_norm.2.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.2.patch) by @emmanuelthome created at 2010-10-26 14:28:05



---

archive/issue_comments_102937.json:
```json
{
    "body": "Attachment [relative_norm.3.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.3.patch) by @emmanuelthome created at 2010-10-26 14:44:17\n\nReplying to [comment:1 lftabera]:\n> This will also improve the trace in the important case where the field is the base field.\n\nyes indeed.\n \n> I think I would call self.base_ring() instead of self.parent().base_field()\n\ndone\n\n> I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).\n\nindeed. I considered at first it wasn't worth the trouble, but it's so ridiculously expensive that the 1-line additional diff is worth it, I believe.\n\n> Also, you need to add a doctest for the change.\n\nSure, done. However there's no difference in functionality beyond speed.\n\nE.",
    "created_at": "2010-10-26T14:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102937",
    "user": "https://github.com/emmanuelthome"
}
```

Attachment [relative_norm.3.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.3.patch) by @emmanuelthome created at 2010-10-26 14:44:17

Replying to [comment:1 lftabera]:
> This will also improve the trace in the important case where the field is the base field.

yes indeed.
 
> I think I would call self.base_ring() instead of self.parent().base_field()

done

> I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).

indeed. I considered at first it wasn't worth the trouble, but it's so ridiculously expensive that the 1-line additional diff is worth it, I believe.

> Also, you need to add a doctest for the change.

Sure, done. However there's no difference in functionality beyond speed.

E.



---

archive/issue_comments_102938.json:
```json
{
    "body": "Attachment [relative_norm.4.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.4.patch) by @lftabera created at 2010-10-27 08:42:00\n\nNote that the code you have added for the case base = R is never executed. You are comparing base which is (presumably) a field with self which is a NumberFieldElement.\n\nAlso the code for the case **base is self.parent()** is wrong, it will not work in the following case:\n\n\n```\nsage: f = R.random_element()\nsage: matrix(1,1,[f]) == f.matrix(R)\nFalse\n```\n \n\nI would also add a doctest for a random element as f above.\n\nOne last comment. In the doctest you write\n\n```\nsage: K.<v>=NumberField(QQ['x']([64321, 0, 514, 0, 1]))\n```\n\n\nwhile correct, it can be confusing for the nonexperienced reader. Would it not be more convenient something like?\n\n\n```\nsage: x = QQ['x'].gen()\nsage: K.<v>=NumberField(QQ[x](x^4 + 514*x^2 + 64321))\nsage: R.<r>=NumberField(K[x](x^2 + 4*v*x + 5*v^2 + 514))\n```\n\n\nI could make the changes myself, but I prefer not to change the patch to give later a faster possitive review.",
    "created_at": "2010-10-27T08:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102938",
    "user": "https://github.com/lftabera"
}
```

Attachment [relative_norm.4.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.4.patch) by @lftabera created at 2010-10-27 08:42:00

Note that the code you have added for the case base = R is never executed. You are comparing base which is (presumably) a field with self which is a NumberFieldElement.

Also the code for the case **base is self.parent()** is wrong, it will not work in the following case:


```
sage: f = R.random_element()
sage: matrix(1,1,[f]) == f.matrix(R)
False
```
 

I would also add a doctest for a random element as f above.

One last comment. In the doctest you write

```
sage: K.<v>=NumberField(QQ['x']([64321, 0, 514, 0, 1]))
```


while correct, it can be confusing for the nonexperienced reader. Would it not be more convenient something like?


```
sage: x = QQ['x'].gen()
sage: K.<v>=NumberField(QQ[x](x^4 + 514*x^2 + 64321))
sage: R.<r>=NumberField(K[x](x^2 + 4*v*x + 5*v^2 + 514))
```


I could make the changes myself, but I prefer not to change the patch to give later a faster possitive review.



---

archive/issue_comments_102939.json:
```json
{
    "body": "Attachment [relative_norm.5.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.5.patch) by @emmanuelthome created at 2010-10-27 09:19:01",
    "created_at": "2010-10-27T09:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102939",
    "user": "https://github.com/emmanuelthome"
}
```

Attachment [relative_norm.5.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.5.patch) by @emmanuelthome created at 2010-10-27 09:19:01



---

archive/issue_comments_102940.json:
```json
{
    "body": "You are right, sorry for the buggy code. That one should be better.",
    "created_at": "2010-10-27T09:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102940",
    "user": "https://github.com/emmanuelthome"
}
```

You are right, sorry for the buggy code. That one should be better.



---

archive/issue_comments_102941.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-10-27T09:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102941",
    "user": "https://github.com/emmanuelthome"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_102942.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102942",
    "user": "https://github.com/lftabera"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102943.json:
```json
{
    "body": "Attachment [correct_doc_typo.patch](tarball://root/attachments/some-uuid/ticket10174/correct_doc_typo.patch) by @lftabera created at 2010-10-27 15:39:43\n\nThe patch applies cleanly and passes all doctests.\n\nThe main advantage is that the result of matrix is cached for the base_field() so you do not have to recompute it. However, when casting directly matrix(self.base_ring()) then caching was not taken into account and the method to compute the matrix is harder. Thome's patch corrects this. The case matrix(self.parent()) is also taken into account separately.\n\nI have added another patch that allows the documentation to build without problems. But, since it is a trivial typo in thome's patch I feel I can give a possitive review.",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102943",
    "user": "https://github.com/lftabera"
}
```

Attachment [correct_doc_typo.patch](tarball://root/attachments/some-uuid/ticket10174/correct_doc_typo.patch) by @lftabera created at 2010-10-27 15:39:43

The patch applies cleanly and passes all doctests.

The main advantage is that the result of matrix is cached for the base_field() so you do not have to recompute it. However, when casting directly matrix(self.base_ring()) then caching was not taken into account and the method to compute the matrix is harder. Thome's patch corrects this. The case matrix(self.parent()) is also taken into account separately.

I have added another patch that allows the documentation to build without problems. But, since it is a trivial typo in thome's patch I feel I can give a possitive review.



---

archive/issue_comments_102944.json:
```json
{
    "body": "Changing keywords from \"\" to \"Efficiency, number field, matrix\".",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102944",
    "user": "https://github.com/lftabera"
}
```

Changing keywords from "" to "Efficiency, number field, matrix".



---

archive/issue_comments_102945.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10173#issuecomment-102945",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_010294.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2010-11-01T10:18:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10173",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10173#event-10294"
}
```
