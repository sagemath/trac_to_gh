# Issue 12663: upgrade fpLLL to newest upstream release

Issue created by migration from Trac.

Original creator: malb

Original creation time: 2012-04-12 16:09:32

Assignee: tbd

CC:  jpflori

Keywords: lll, fplll

Sage still ships fpLLL 3.0.12 (we upgraded to 3.0.12 in May 2009!) but fpLLL 4.0 is out which includes an implementation of BKZ.


---

Comment by Snark created at 2012-06-20 07:56:59

I just checked it won't be painless :
sage/libs/fplll/fplll.cpp:243:24: fatal error: fplll/fast.h: No such file or directory

From what I see in upstream's sources:
* wrapper.h still exists, but isn't installed ;
* fast.h, fast_earlyred.h, heuristic.h, heuristic_early_red.h and proved.h don't exist anymore, but there's a fplllv31.h which provides a compatibility layer to version 3.1 (which is more recent than what sage has... so perhaps even that isn't enough!)


---

Comment by malb created at 2012-06-20 08:58:56

AFAIK fpLLL 4.0 is essentially a new library from an interface point of view, i.e., they switched to a more C++-style interface. I suggest to essentially start over with the interface instead of trying to patch the old interface.


---

Comment by fbissey created at 2012-06-20 09:08:39

I'd agree with that. A long time ago when fplll-3.1 was released we looked at supporting it in sage-on-gentoo [https://github.com/cschwan/sage-on-gentoo/issues/71](https://github.com/cschwan/sage-on-gentoo/issues/71). Funny thing compiling against 3.0.12 and then upgrading to 3.1.1 without rebuilding sage worked fine.


---

Comment by Snark created at 2012-06-20 19:17:53

There are two points to be made here :
* I had a better look, and saw wrapper.h's previous features seem to be in fplllv31.h ; but I can't find the "proved" class anywhere. In fact, choosing which method will be used is now done through an enum instead of different classes as far as I see. So indeed a pure rewrite would be the saner route.
* Apparently, changing the sage-5.1.beta5.spkg and using "sage -f" on it isn't enough : generally sage extracts the spkg in spkg/build/ but really builds sources it copied some previous time in devel/sage/ -- I haven't gotten the logic of it down.

All in all, that makes working on this pretty painful : I'll pass!


---

Comment by pcpa created at 2012-10-21 01:03:12

I made sagemath 5.4.beta1 experimental rpm packages for fedora rawhide, patching both fplll and sagemath.

The only issue I noticed so far was:


```
$ rpm -q sagemath libfplll
sagemath-5.4.beta1-1.fc19.x86_64
libfplll-4.0.1-2.fc19.x86_64
$ sage -t /usr/share/sagemath/devel/sage/sage/libs/fplll/fplll.pyx
sage -t  "devel/sage/sage/libs/fplll/fplll.pyx"             
**********************************************************************
File "/usr/share/sagemath/devel/sage/sage/libs/fplll/fplll.pyx", line 646:
    sage: L = A.LLL(); L
Expected:
    [ 192  264 -152  272   -8  272  -48 -264  104   -8]
    [-128 -176 -240  160 -336  160   32  176  272 -336]
    [ -24 -161  147  350  385  -34  262  161  115  257]
    [ 520   75 -113  -74 -491   54  126  -75  239 -107]
    [-376 -133  255   22  229  150  350  133   95 -411]
    [-168 -103    5  402 -377 -238 -214  103 -219 -249]
    [-352   28  108 -328 -156  184   88  -28  -20  356]
    [ 120 -219  289  298  123  170 -286  219  449 -261]
    [ 160 -292   44   56  164  568  -40  292  -84 -348]
    [ 192  264 -152  272   -8  272  -48  760  104   -8]
Got:
    [ 192  264 -152  272   -8  272  -48 -264  104   -8]
    [-128 -176 -240  160 -336  160   32  176  272 -336]
    [ -24 -161  147  350  385  -34  262  161  115  257]
    [ 520   75 -113  -74 -491   54  126  -75  239 -107]
    [-376 -133  255   22  229  150  350  133   95 -411]
    [-168 -103    5  402 -377 -238 -214  103 -219 -249]
    [-352   28  108 -328 -156  184   88  -28  -20  356]
    [ 120 -219  289  298  123  170 -286  219  449 -261]
    [ 160 -292   44   56  164  568  -40  292  -84 -348]
    [-192  760  152 -272    8 -272   48  264 -104    8]
**********************************************************************
1 items had failures:
   1 of   8 in __main__.example_16
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/pcpa/.sage/tmp/fplll_17597.py
         [17.5 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage/sage/libs/fplll/fplll.pyx"
Total time for all tests: 17.6 seconds

```



---

Attachment

fplll patch


---

Attachment

sage patch


---

Comment by fbissey created at 2012-10-26 10:29:31

I must say I hate when I see that kind of sign flipping. Still we can have something based on something less ancient even if it is in compatibility mode. Now who could check that test before we also up the spkg.


---

Comment by Snark created at 2013-02-20 11:08:24

Is it possible to avoid patching fplll? It it's not possible, did you discuss with upstream for inclusion?


---

Comment by jpflori created at 2013-02-20 11:27:49

I think upstream is more or less actively preparing a new release including fixes for Cygwin under my impulsion, so they should be quite reactive if you ask for the inclusion of such a patch as well.


---

Comment by Snark created at 2013-03-22 07:28:18

Changing status from new to needs_info.


---

Comment by Snark created at 2013-03-22 07:28:18

I would like to see this go through : should I contact upstream myself?


---

Comment by malb created at 2013-03-22 09:05:10

I second that, I haven an interest in seeing this go in because I want to write libs.fplll4 which uses the new interface.


---

Comment by jpflori created at 2013-03-26 21:31:05

Replying to [comment:10 Snark]:
> I would like to see this go through : should I contact upstream myself?
Yup you should.
I was in contact with Damien StelhÃ© around Christmas for #13354 and he included the fix I wanted in a to be released version.
But when testing it I discovered other problems and got no reply so far.
I must admit I did not ping him since the 30th of January...

So if you could also ask him for the last changes which were needed for Cygwin :)


---

Comment by Snark created at 2013-05-13 16:04:53

4.0.3 is out with cygwin changes ; it's already been seven weeks and I haven't written the mail I mentioned...


---

Comment by jpflori created at 2013-05-14 09:11:13

I just mailed Damien to thank him for the Cygwin changes and ask about our patch (from what I saw in the patch it seems not only legitimate, but needed to actually use the compatibility interface (except for the additional function we define of course)), so if you did not, please don't do it now.


---

Comment by Snark created at 2013-05-14 10:06:34

I had a mail discussion yesterday evening ; he is at a conference this week but will look into the matter later. :-P


---

Attachment


---

Attachment

Some doctests changed but they are still LLL-reduced, so nothing is wrong.


---

Comment by jpflori created at 2013-05-28 16:23:23

Changing status from needs_info to needs_review.


---

Comment by malb created at 2013-05-29 10:14:36

Changing status from needs_review to positive_review.


---

Comment by malb created at 2013-05-29 10:14:36

* patches look good
 * doctests pass


---

Comment by jdemeyer created at 2013-05-29 12:31:12

Various files have permission

```
-rwxr--r--
```

which is strange; most likely this should be

```
-rwxr-xr-x
```



---

Comment by jdemeyer created at 2013-05-29 12:31:12

Changing status from positive_review to needs_work.


---

Comment by jpflori created at 2013-05-29 12:40:14

It's so in the upstream tarball (not released yet, but its also the same in the 4.0.3 released one and the 3.1.3 one, though is correct in the really old 3.0.12).
If you are really worried about this, I (or you) can report it upstream.


---

Comment by jdemeyer created at 2013-05-29 12:56:19

Replying to [comment:20 jpflori]:
> If you are really worried about this, I (or you) can report it upstream.

Please do report this upstream, maybe they can still ship a corrected version 4.0.4.


---

Comment by jdemeyer created at 2013-05-29 12:57:26

Another small mistake in `SPKG.txt`: the license is

```
LGPL v2.1+
```

(version 2.1 is not the same as version 2)


---

Comment by jpflori created at 2013-05-29 13:00:22

Reported the permissions thing, I'll correct the LGPL stuff when I get feedback from Damien.


---

Comment by Snark created at 2013-05-29 13:29:38

Ah, I was about to also positively review : I finally finished compiling and doctesting without problem (except that my boxes are all slow :-( )

Yes, I think upstream didn't publicly release 4.0.4 yet : Jean-Pierre, myself then everyone through this ticket got to see a release-candidate.


---

Comment by jdemeyer created at 2013-05-29 13:44:34

Replying to [comment:25 Snark]:
> Yes, I think upstream didn't publicly release 4.0.4 yet : Jean-Pierre, myself then everyone through this ticket got to see a release-candidate.
It is usually better to wait for a public release before making the spkg for Sage. Or at least, if it's a release candidate, make it clear that it is (`libfplll-4.0.4.rc.spkg`)


---

Comment by Snark created at 2013-05-29 13:56:01

`@`jdemeyer: in fact, upstream is waiting for us(this ticket) to say "let go" to release, so Jean-Pierre wasn't that wrong to provide a spkg already :-)


---

Comment by jdemeyer created at 2013-05-29 21:24:55

Replying to [comment:27 Snark]:
> `@`jdemeyer: in fact, upstream is waiting for us(this ticket) to say "let go" to release
Then have upstream release a *public* and *versioned* release candidate for version 4.0.4.


---

Comment by jdemeyer created at 2013-05-29 22:22:44

`latticegen` should be added to `local/bin/.hgignore`.


---

Comment by jdemeyer created at 2013-05-30 07:46:14

Replying to [comment:27 Snark]:
> `@`jdemeyer: in fact, upstream is waiting for us(this ticket) to say "let go" to release, so Jean-Pierre wasn't that wrong to provide a spkg already :-)
It was very right to provide a spkg. I'm just saying that it should have been made clear that this was for a non-released version of `fplll` and hence it wasn't the final spkg.


---

Comment by jpflori created at 2013-05-30 08:22:23

4.0.4 is officially released without the new permissions, I quickly mailed Damien to see if he could not fix that and replace the upped tarball with a fixed one without anyone noticing.


---

Comment by jpflori created at 2013-05-30 08:49:42

In fact Damien responded and it should have fixed permissions, he will reupload a proper tarball later today.


---

Attachment


---

Comment by jpflori created at 2013-05-30 12:51:24

Changing keywords from "lll, fplll" to "lll, fplll, spkg".


---

Comment by jpflori created at 2013-05-30 12:51:24

A proper 4.0.4 is now online on upstream website and packaged here.


---

Comment by jpflori created at 2013-05-30 12:51:24

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-05-30 12:57:10

The spkg diff isn't right....


---

Comment by jpflori created at 2013-05-30 13:02:21

Spkg diff, for review only.


---

Attachment

Fixed hopefully.

A few remarks:
* I've update the website address.
* According to the info there only Damien is in charge now.
* I've added his professional mail address.
* updated the license.
* Fixed the date and author of the previous spkg we distributed which were wrong.


---

Comment by jpflori created at 2013-05-30 13:05:24

And there is an accent in Damien family's name which appears correctly when I look at SPKG.txt and the diff file with a capable reader but not in the diff when displayed on trac.


---

Comment by jdemeyer created at 2013-05-30 13:08:50

Replying to [comment:38 jpflori]:
> And there is an accent in Damien family's name which appears correctly when I look at SPKG.txt and the diff file with a capable reader but not in the diff when displayed on trac.
That's not a problem.


---

Comment by jdemeyer created at 2013-05-30 13:10:21

Looks good on first sight, will set to positive review if build and doctests work.


---

Comment by jdemeyer created at 2013-05-31 09:30:33

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-06-10 08:39:15

Resolution: fixed
