# Issue 23845: Interaction TorsionQuadraticModules vs Genus

Issue created by migration from https://trac.sagemath.org/ticket/24082

Original creator: sbrandhorst

Original creation time: 2017-10-21 12:55:29

CC:  annahaensch tscrim

By results of Nikulin:
The genus of an even integral quadratic form is determined by
`(s_+,s_-,q)`
where `s_+,s_-` is the signature and `q` a torsion quadratic form with values in `QQ/2ZZ`

The genus of an odd integral quadratic form is determined by
`(s_+,s_-,b)`
here `b` is a torsion bilinear form with values in `QQ/ZZ`

We have `TorsionQuadraticModule` and we have
`sage.quadratic_forms.genera.genus.Genus`

This ticket should implement the Theorem of Nikulin.


---

Comment by sbrandhorst created at 2018-01-20 14:14:49

Last 10 new commits:


---

Comment by sbrandhorst created at 2018-01-20 14:15:38

This ticket is now split into several subtasks to keep reviewing easy.


---

Comment by git created at 2018-01-20 16:41:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-28 08:50:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-22 08:55:12

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-02-22 15:44:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-22 16:39:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-03-01 10:07:47

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-03-01 12:44:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2018-03-01 12:45:27

Todo:

- odd genera


---

Comment by sbrandhorst created at 2018-04-11 11:56:40

Changing status from new to needs_review.


---

Comment by git created at 2018-05-10 21:29:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-05-11 22:17:28

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-05-11 22:34:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2018-07-18 14:51:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-07-19 09:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-21 12:23:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-21 16:20:28

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by sbrandhorst created at 2018-10-21 16:57:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-10-21 17:14:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-11 08:30:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-17 08:20:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2019-04-17 12:01:46

Correctness of the code can be checked with the following systematic exhaustion of small examples:

```
from sage.quadratic_forms.genera.genus import genera
for signature in [(1,0), (1,1),(1,2), (4,0), (0,5)]:
    for det in range(1,257):
        det
        for genus in genera(signature,det,even=False):
            assert genus == genus.discriminant_form().genus(signature)
```



---

Comment by tscrim created at 2019-04-17 12:16:01

I think you should add that as a test, although maybe shortening down the values of `det`?

Also, some nitpicks while-you-are-at-it:

- The alignment of the `import` should be at the opening parenthesis level (otherwise it looks strange, and I think this is a PEP8 thing too).
- The closing `]` in `block1` and `block2` IMO looks better at the same level as the `[`.
- The `else` after the `for` loops at the end of `genus` is unnecessary and makes it seem like the code could return a `None` (whereas you really want it to error out if that `if` statement is never satisfied).


---

Comment by git created at 2019-04-17 14:02:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2019-04-17 14:03:36

Thank you. For taking a look at this.


---

Comment by tscrim created at 2019-04-17 14:10:32

You're welcome, it was no problem.

You will need to do the following changes:

```diff
-            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])    # long
-            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)
+            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])  # long time
+            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)  # long time
             True
-            """
+        """
```

Without marking the second test as `# long time`, you will get an error when running only the short doctests as `genera` is undefined. Also, you will want to mark that as `TESTS:`, maybe also

```diff
-        A systematic test of lattices of
-        small ranks and determinants::
+        A systematic test of lattices of small ranks and determinants::
```



---

Comment by git created at 2019-04-17 14:17:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2019-04-17 14:17:34

tests pass


---

Comment by tscrim created at 2019-04-17 14:20:08

Great, thanks. I will just wait for the patchbot to confirm the doc builds.


---

Comment by sbrandhorst created at 2019-04-24 07:43:05

*ping*


---

Comment by tscrim created at 2019-04-24 07:44:59

This is now getting a doctest failure:

```
File "src/sage/modules/torsion_quadratic_module.py", line 575, in sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus
Failed example:
    D.genus((1,0))
Expected:
    Traceback (most recent call last):
    ...
    ValueError: this discriminant form and signature do not define a genus
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus[12]>", line 1, in <module>
        D.genus((Integer(1),Integer(0)))
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modules/torsion_quadratic_module.py", line 630, in genus
        genus = GenusSymbol_global_ring(signature_pair, local_symbols)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/quadratic_forms/genera/genus.py", line 1980, in __init__
        raise TypeError("all local symbols must be of the same dimension")
    TypeError: all local symbols must be of the same dimension
```



---

Comment by git created at 2019-05-03 23:36:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2019-05-03 23:37:18

Tests pass & doc builds on my machine


---

Comment by sbrandhorst created at 2019-05-04 21:18:33

and a green bot


---

Comment by tscrim created at 2019-05-06 05:08:53

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-05-06 05:08:53

Thank you. LGTM.


---

Comment by vbraun created at 2019-05-08 15:51:08

Resolution: fixed
