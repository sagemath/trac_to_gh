# Issue 23845: Interaction TorsionQuadraticModules vs Genus

archive/issues_023845.json:
```json
{
    "body": "CC:  annahaensch tscrim\n\nBy results of Nikulin:\nThe genus of an even integral quadratic form is determined by\n`(s_+,s_-,q)`\nwhere `s_+,s_-` is the signature and `q` a torsion quadratic form with values in `QQ/2ZZ`\n\nThe genus of an odd integral quadratic form is determined by\n`(s_+,s_-,b)`\nhere `b` is a torsion bilinear form with values in `QQ/ZZ`\n\nWe have `TorsionQuadraticModule` and we have\n`sage.quadratic_forms.genera.genus.Genus`\n\nThis ticket should implement the Theorem of Nikulin.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24082\n\n",
    "created_at": "2017-10-21T12:55:29Z",
    "labels": [
        "quadratic forms",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Interaction TorsionQuadraticModules vs Genus",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23845",
    "user": "sbrandhorst"
}
```
CC:  annahaensch tscrim

By results of Nikulin:
The genus of an even integral quadratic form is determined by
`(s_+,s_-,q)`
where `s_+,s_-` is the signature and `q` a torsion quadratic form with values in `QQ/2ZZ`

The genus of an odd integral quadratic form is determined by
`(s_+,s_-,b)`
here `b` is a torsion bilinear form with values in `QQ/ZZ`

We have `TorsionQuadraticModule` and we have
`sage.quadratic_forms.genera.genus.Genus`

This ticket should implement the Theorem of Nikulin.

Issue created by migration from https://trac.sagemath.org/ticket/24082





---

archive/issue_comments_333995.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2018-01-20T14:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-333995",
    "user": "sbrandhorst"
}
```

Last 10 new commits:



---

archive/issue_comments_333996.json:
```json
{
    "body": "This ticket is now split into several subtasks to keep reviewing easy.",
    "created_at": "2018-01-20T14:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-333996",
    "user": "sbrandhorst"
}
```

This ticket is now split into several subtasks to keep reviewing easy.



---

archive/issue_comments_333997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-20T16:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-333997",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_333998.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-28T08:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-333998",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_333999.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-02-22T08:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-333999",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_334000.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-22T15:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334000",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334001.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-22T16:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334001",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334002.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-03-01T10:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334002",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_334003.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-01T12:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334003",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334004.json:
```json
{
    "body": "Todo:\n\n- odd genera",
    "created_at": "2018-03-01T12:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334004",
    "user": "sbrandhorst"
}
```

Todo:

- odd genera



---

archive/issue_comments_334005.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-11T11:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334005",
    "user": "sbrandhorst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334006.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-10T21:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334006",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334007.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-05-11T22:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334007",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_334008.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-11T22:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334008",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334009.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-18T14:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334009",
    "user": "sbrandhorst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_334010.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-19T09:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334010",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334011.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-21T12:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334011",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334012.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-10-21T16:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334012",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_334013.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-10-21T16:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334013",
    "user": "sbrandhorst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_334014.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-21T17:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334014",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334015.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-11T08:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334015",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-17T08:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334016",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334017.json:
```json
{
    "body": "Correctness of the code can be checked with the following systematic exhaustion of small examples:\n\n```\nfrom sage.quadratic_forms.genera.genus import genera\nfor signature in [(1,0), (1,1),(1,2), (4,0), (0,5)]:\n    for det in range(1,257):\n        det\n        for genus in genera(signature,det,even=False):\n            assert genus == genus.discriminant_form().genus(signature)\n```\n",
    "created_at": "2019-04-17T12:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334017",
    "user": "sbrandhorst"
}
```

Correctness of the code can be checked with the following systematic exhaustion of small examples:

```
from sage.quadratic_forms.genera.genus import genera
for signature in [(1,0), (1,1),(1,2), (4,0), (0,5)]:
    for det in range(1,257):
        det
        for genus in genera(signature,det,even=False):
            assert genus == genus.discriminant_form().genus(signature)
```




---

archive/issue_comments_334018.json:
```json
{
    "body": "I think you should add that as a test, although maybe shortening down the values of `det`?\n\nAlso, some nitpicks while-you-are-at-it:\n\n- The alignment of the `import` should be at the opening parenthesis level (otherwise it looks strange, and I think this is a PEP8 thing too).\n- The closing `]` in `block1` and `block2` IMO looks better at the same level as the `[`.\n- The `else` after the `for` loops at the end of `genus` is unnecessary and makes it seem like the code could return a `None` (whereas you really want it to error out if that `if` statement is never satisfied).",
    "created_at": "2019-04-17T12:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334018",
    "user": "tscrim"
}
```

I think you should add that as a test, although maybe shortening down the values of `det`?

Also, some nitpicks while-you-are-at-it:

- The alignment of the `import` should be at the opening parenthesis level (otherwise it looks strange, and I think this is a PEP8 thing too).
- The closing `]` in `block1` and `block2` IMO looks better at the same level as the `[`.
- The `else` after the `for` loops at the end of `genus` is unnecessary and makes it seem like the code could return a `None` (whereas you really want it to error out if that `if` statement is never satisfied).



---

archive/issue_comments_334019.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-17T14:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334019",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334020.json:
```json
{
    "body": "Thank you. For taking a look at this.",
    "created_at": "2019-04-17T14:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334020",
    "user": "sbrandhorst"
}
```

Thank you. For taking a look at this.



---

archive/issue_comments_334021.json:
```json
{
    "body": "You're welcome, it was no problem.\n\nYou will need to do the following changes:\n\n```diff\n-            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])    # long\n-            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)\n+            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])  # long time\n+            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)  # long time\n             True\n-            \"\"\"\n+        \"\"\"\n```\n\nWithout marking the second test as `# long time`, you will get an error when running only the short doctests as `genera` is undefined. Also, you will want to mark that as `TESTS:`, maybe also\n\n```diff\n-        A systematic test of lattices of\n-        small ranks and determinants::\n+        A systematic test of lattices of small ranks and determinants::\n```\n",
    "created_at": "2019-04-17T14:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334021",
    "user": "tscrim"
}
```

You're welcome, it was no problem.

You will need to do the following changes:

```diff
-            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])    # long
-            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)
+            sage: genera = flatten([genera(s, d, even=False) for d in dets for s in signatures])  # long time
+            sage: all(g == g.discriminant_form().genus(g.signature_pair()) for g in genera)  # long time
             True
-            """
+        """
```

Without marking the second test as `# long time`, you will get an error when running only the short doctests as `genera` is undefined. Also, you will want to mark that as `TESTS:`, maybe also

```diff
-        A systematic test of lattices of
-        small ranks and determinants::
+        A systematic test of lattices of small ranks and determinants::
```




---

archive/issue_comments_334022.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-17T14:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334022",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334023.json:
```json
{
    "body": "tests pass",
    "created_at": "2019-04-17T14:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334023",
    "user": "sbrandhorst"
}
```

tests pass



---

archive/issue_comments_334024.json:
```json
{
    "body": "Great, thanks. I will just wait for the patchbot to confirm the doc builds.",
    "created_at": "2019-04-17T14:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334024",
    "user": "tscrim"
}
```

Great, thanks. I will just wait for the patchbot to confirm the doc builds.



---

archive/issue_comments_334025.json:
```json
{
    "body": "*ping*",
    "created_at": "2019-04-24T07:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334025",
    "user": "sbrandhorst"
}
```

*ping*



---

archive/issue_comments_334026.json:
```json
{
    "body": "This is now getting a doctest failure:\n\n```\nFile \"src/sage/modules/torsion_quadratic_module.py\", line 575, in sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus\nFailed example:\n    D.genus((1,0))\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: this discriminant form and signature do not define a genus\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus[12]>\", line 1, in <module>\n        D.genus((Integer(1),Integer(0)))\n      File \"/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modules/torsion_quadratic_module.py\", line 630, in genus\n        genus = GenusSymbol_global_ring(signature_pair, local_symbols)\n      File \"/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/quadratic_forms/genera/genus.py\", line 1980, in __init__\n        raise TypeError(\"all local symbols must be of the same dimension\")\n    TypeError: all local symbols must be of the same dimension\n```\n",
    "created_at": "2019-04-24T07:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334026",
    "user": "tscrim"
}
```

This is now getting a doctest failure:

```
File "src/sage/modules/torsion_quadratic_module.py", line 575, in sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus
Failed example:
    D.genus((1,0))
Expected:
    Traceback (most recent call last):
    ...
    ValueError: this discriminant form and signature do not define a genus
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.torsion_quadratic_module.TorsionQuadraticModule.genus[12]>", line 1, in <module>
        D.genus((Integer(1),Integer(0)))
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modules/torsion_quadratic_module.py", line 630, in genus
        genus = GenusSymbol_global_ring(signature_pair, local_symbols)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/quadratic_forms/genera/genus.py", line 1980, in __init__
        raise TypeError("all local symbols must be of the same dimension")
    TypeError: all local symbols must be of the same dimension
```




---

archive/issue_comments_334027.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-03T23:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334027",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334028.json:
```json
{
    "body": "Tests pass & doc builds on my machine",
    "created_at": "2019-05-03T23:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334028",
    "user": "sbrandhorst"
}
```

Tests pass & doc builds on my machine



---

archive/issue_comments_334029.json:
```json
{
    "body": "and a green bot",
    "created_at": "2019-05-04T21:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334029",
    "user": "sbrandhorst"
}
```

and a green bot



---

archive/issue_comments_334030.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-06T05:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334030",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334031.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2019-05-06T05:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334031",
    "user": "tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_334032.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-08T15:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23845#issuecomment-334032",
    "user": "vbraun"
}
```

Resolution: fixed
