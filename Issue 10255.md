# Issue 10255: make -1 modular symbols from eclib available to elliptic curves

Issue created by migration from https://trac.sagemath.org/ticket/10256

Original creator: wuthrich

Original creation time: 2010-11-13 12:19:07

Assignee: cremona

CC:  cremona

Keywords: modular symbols

This ticket is a follw-up from #10236. In there certain changes from #9476 and #9247 were reverted back. Here is what has to be done to make modular symbols with negative sign available for computations with elliptic curves, e.g. p-adic L-series.

Currently eclib can compute the space of modular symbols of sign = -1, but ECModularSymbol in sage.libs.cremona.newforms.pyx can not use them yet to compute {0,r}-

Once this is there, one can modify sage.schemes.elliptic_curves.ell_modular_symbols.py to allow sign = -1 in ModularSymbolECLIB. (Where one has to think a little bit about the normalization.) This would allow to switch in line 1098 of ell_rational_field.py and in line 131 of padic_lseries.py to make use_eclib=True to be default.


---

Comment by cremona created at 2010-11-18 21:54:14

The current eclib (eclib-20100711.spkg) has normalization problems in the "sign=-1" modular symbols, which I am currently working on fixing.  The Sage interface should perhaps wait until that is done.


---

Comment by wuthrich created at 2016-07-05 13:39:59

Ping ?

I was working on #20864 when I changed the plus symbols to be computed by eclib by default. I wondered if the negative could be added now? Sage normalises the negative ones correctly now. We only need some rational multiple from eclib.


---

Comment by cremona created at 2016-11-02 14:43:32

Implementing this just went up my to-do list, after hearing a lecture by Mazur on his experimental work with Rubin which makes heavy use of this modular symbol functionality.  Karl told me that it would save them a lot of time for minus symbols to be available from eclib.  As soon as I can, I will.


---

Comment by wuthrich created at 2016-11-02 15:26:52

Excellent. I will help of course.

I am curious what Rubin and Mazur are up to, too.


---

Comment by cremona created at 2016-12-19 13:11:29

I will make this ticket dependent on another which will upgrade the eclib version in Sage to one which will be released later today.  Two reasons: (1) I fixed a bug which sometimes caused the plus symbols to all be mutiplied by a factor >1 (in known examples, a factor of 2).  (2) I have added a facility to eclib to base symbols at infinity (oo) instead of 0, i.e. it computes the image of either {0,r} or {oo,r} for a given rational.

Example:

```
sage: E=EllipticCurve("121b1")
sage: M=E.modular_symbol(1)
Warning : Could not normalize the modular symbols, maybe all further results will be multiplied by -1, 2 or -2.
sage: M(1/7)
-2
```

Here the error message is coming from Sage, not eclib.  And the correct value is 1 though the current eclib version returns 2.


---

Comment by cremona created at 2016-12-19 14:02:47

See #22077


---

Comment by cremona created at 2016-12-19 16:21:36

#22077 is now ready for review.  I will base by branch for this ticket on that one, so am now setting that to be a prerequisite to this.


---

Comment by cremona created at 2016-12-30 18:26:59

Changing status from new to needs_review.


---

Comment by cremona created at 2016-12-30 18:26:59

I have set this to Needs Review but note that #22077 (upgrading eclib to version v20161230) is a dependency and is currently also waiting review.


---

Comment by wuthrich created at 2017-01-02 19:32:52

I am working on this. I spotted a few misprints, but more seriously:

* This code also changes the normalization for modular symbols in sage. In particular, the warning for 121b1 is no longer there, despite the function returning the wrong result.

```
sage: E = EllipticCurve("121b1")
sage: m = E.modular_symbol(implementation="sage")
sage: m(1/7)
-1/2
sage: me = E.modular_symbol()
sage: me(1/7)
1/2
```


* The second thing is that there are more places which need to change taking eclib automatically for negative symbols. Like line 219 in padic_lseries.py


---

Comment by wuthrich created at 2017-01-02 19:32:52

Changing status from needs_review to needs_work.


---

Comment by wuthrich created at 2017-01-03 10:17:36

I found that eclib returns incorrect values currently. This is what causes all the test failures in sage.modular.pollack_stevens after my additional changes. Here is the example I am certain about:


```
sage: E = EllipticCurve('11a')
sage: m = E.modular_symbol(-1,implementation="eclib")
sage: ms = E.modular_symbol(-1,implementation="sage")
sage: m(-1/3)
1/2
sage: ms(-1/3)
-1/2
sage: la = sum(E.an(n)/n*exp(2*RR.pi()*I*(-1/3)*n) for n in [1..100000]); la
-0.387171140749021 - 1.47418172900132*I
sage: E.period_lattice().basis()
(1.26920930427955, 0.634604652139777 + 1.45881661693850*I)
```


This shows that sage's normalisation is correct and eclib has missed the sign.
----
New commits:


---

Comment by wuthrich created at 2017-01-03 10:20:53

At this stage, it goes back to John to figure out - if he wants - how to get the correct sign already in eclib.

In the long term, once #21046 is in, I can use the numerical ones to do a very quick and efficient scaling. So one could also wait.

The last modification I did was to highlight the above value in the doctest. There might be others that are wrong.


---

Comment by cremona created at 2017-01-03 10:31:26

I am looking at this right now to see if it is really eclib and not the interface,  Back soon...


---

Comment by cremona created at 2017-01-03 10:40:24

When I run eclib's own program (called ecnf) on this curve [0,-1,1,-10,-20] I find that {oo, 1/3} and {oo, -1/3} both map to (-3/5,-1), meaning that the plus symbol is -3/5 and the minus symbol is in both cases -1.  This must be a bug since (by definition) theminus symbol should have been negated.

Apologies.  This will require yet another fix to eclib, hence to #22077.  I'll work on that right away.


---

Comment by cremona created at 2017-01-03 11:14:59

The previous comment needs correcting since I was testing on the wrong machine and not actually useing the latest eclib version v20161230.  Now eclib's ecnf program maps {oo,-1/3} to (-3/5,+1) as it should for consistency.  But consistency is not correctness, and in fact eclib only normalizes (w.r.t. sign) the plus symbols, and then only when L(E,1) is non-zero.

Hence there is more to be done within eclib to get the signs right.  I have set #22077 back to 'needs work' but it would also be possible for the sign to be checked on the Sage side.


---

Comment by cremona created at 2017-01-04 20:02:03

There's a new version of eclib (v20170104) over at #22077 and my last branch on this ticket (u/cremona/10256) works OK with it.  I have not yet merged and tested u/wuthrich/ticket/10256 but I did test with wuthrich's independent test script.


---

Comment by git created at 2017-01-04 21:16:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wuthrich created at 2017-01-04 21:19:27

With the latest changes to eclib, it looks good. Testing now.


---

Comment by wuthrich created at 2017-01-04 21:19:27

Changing status from needs_work to needs_review.


---

Comment by wuthrich created at 2017-01-05 13:34:52

Changing status from needs_review to needs_work.


---

Comment by wuthrich created at 2017-01-05 13:34:52

missed some doctests.


---

Comment by cremona created at 2017-01-05 14:26:08

Replying to [comment:22 wuthrich]:
> missed some doctests.

Dou mean that some are missing, or that they don't work?


---

Comment by wuthrich created at 2017-01-05 19:46:04

Sorry, I had to go, but now I am back. I meant: I missed updating the doctests in newforms.pyx with all the merging forth and back they got lost. Probably you are right and cleaning up could actually help. So one should take your new branch for #22077 and change the files in 
in elliptic_curves:
* ell_modular_symbols
* ell_rational_field
* padic_lseries
* padics
and in modular.pollack_stevens
* space
There are also three misprints in newforms in libs.eclib which are better corrected in #22077.

Shall I do it? Or have you almost done it already?


---

Comment by wuthrich created at 2017-01-05 21:18:19

John, I fear we are doing parallel work. Upload yours.

I did the changes here, but I ran into a very strange compilation error for newforms.pyx. Cython did not recognise "pair". I added an import, but then I got other compilation errors like 

```
_sp = self.nfs.plus_modular_symbol(_r, 0, int(base_at_infinity))
sage/libs/eclib/newforms.pyx:347:46: Call with wrong number of arguments (expected 1, got 3)
```

Honestly I don't understand. So if yours works, I am happy to ditch what I have done here.


---

Comment by cremona created at 2017-01-05 21:29:40

Sorry I totally messed up on the other ticket, and this one will have to wait until I sort that out, which will have to be Friday.

Correction (next morning): #22077 is fine and back to "needs review" -- see the remarks there.  Nothing was messed up at all.  I'll now finish cleaning up this one.


---

Comment by cremona created at 2017-01-06 10:43:44

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2017-01-06 10:49:35

OK so here's what I did.  Starting from the new branch at #22077, I first used "git cherry-pick" to pick the 4 commits (6f517b3, 6301cc5, 6637227, e81588a) I had originally made here (which had been interspersed with eclib updates); only the first of those had some minor merge conflicts which I fixed.  I then used rebase to sqush thos together into one commit ee879ee.  Second, I did similarly with the 3 reviewer commits (dcacece, 724a205, e101d21), squashing into one (0db2a00).  Lastly I added one more commit after testing revealed one doctest failing (49be7d8).

So I think that the 3 top commits on the new branch u/cremona/10256new contain all previous work while being based on u/cremona/22077new which is itself based on 7.5.rc1.

If there are additional changes needed here, that's fine as long as they are based on this (and don't require more changes to eclib itself...)


---

Comment by wuthrich created at 2017-01-06 20:46:40

Your branch doesn't exist, John. Mine still does not work.


---

Comment by git created at 2017-01-06 21:41:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-01-06 21:42:17

...it does help if you don't forget to actually push the branch to trac....it's there now


---

Comment by wuthrich created at 2017-01-07 09:30:48

All tests passed, the documentation, too. Thanks a lot.


---

Comment by wuthrich created at 2017-01-07 09:30:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-21 21:21:57

Resolution: fixed
