# Issue 8988: Add support for toric varieties

archive/issues_008988.json:
```json
{
    "body": "This patch is a part of the following series adding support for cones/fans and toric varieties to Sage:\n\nPrerequisites:\n\n#8675 - Remove `AmbientSpace._constructor` and fix consequences\n\n#8682 - Improve `AlgebraicScheme_subscheme.__init__` and `AmbientSpace._validate`\n\n#8694 - Improve schemes printing and LaTeXing\n\n#8934 - Trivial bug in computing faces of non-full-dimensional lattice polytopes\n\n#8936 - Expose facet inequalities for lattice polytopes\n\n#8941 - `_latex_` and `origin` for lattice polytopes\n\n#9514 - sage/symbolic/random_tests.py wrongly depends on order of dict.values()\n\nMain patches adding new modules:\n\n#9062 - Add support for toric lattices\n\n#8986 - Add support for convex rational polyhedral cones\n\n#8987 - Add support for rational polyhedral fans\n\n#8988 - Add support for toric varieties\n\n#8989 - Add support for Fano toric varieties\n\nKnown issues:\n\n- The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4\nthis should not be an obstacle to include these patches.\n\n**Assignee:** @aghitza\n\n**CC:**  @vbraun @loefflerd\n\n**Resolution:** fixed\n\n**Author:** Andrey Novoseltsev\n\n**Reviewer:** Volker Braun\n\n**Merged:** sage-4.5.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/8988\n\n",
    "closed_at": "2010-07-20T08:57:02Z",
    "created_at": "2010-05-18T09:07:51Z",
    "labels": [
        "component: algebraic geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.5.2",
    "title": "Add support for toric varieties",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8988",
    "user": "https://github.com/novoselt"
}
```
This patch is a part of the following series adding support for cones/fans and toric varieties to Sage:

Prerequisites:

#8675 - Remove `AmbientSpace._constructor` and fix consequences

#8682 - Improve `AlgebraicScheme_subscheme.__init__` and `AmbientSpace._validate`

#8694 - Improve schemes printing and LaTeXing

#8934 - Trivial bug in computing faces of non-full-dimensional lattice polytopes

#8936 - Expose facet inequalities for lattice polytopes

#8941 - `_latex_` and `origin` for lattice polytopes

#9514 - sage/symbolic/random_tests.py wrongly depends on order of dict.values()

Main patches adding new modules:

#9062 - Add support for toric lattices

#8986 - Add support for convex rational polyhedral cones

#8987 - Add support for rational polyhedral fans

#8988 - Add support for toric varieties

#8989 - Add support for Fano toric varieties

Known issues:

- The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to
http://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4
this should not be an obstacle to include these patches.

**Assignee:** @aghitza

**CC:**  @vbraun @loefflerd

**Resolution:** fixed

**Author:** Andrey Novoseltsev

**Reviewer:** Volker Braun

**Merged:** sage-4.5.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/8988





---

archive/issue_comments_104979.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-05-18T09:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104979",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_104980.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,35 @@\n+This patch is a part of the following series adding support for cones/fans and toric varieties to Sage:\n \n+Prerequisites:\n+\n+#8675 - Remove `AmbientSpace._constructor` and fix consequences\n+\n+#8682 - Improve `AlgebraicScheme_subscheme.__init__` and `AmbientSpace._validate`\n+\n+#8694 - Improve schemes printing and LaTeXing\n+\n+#8934 - Trivial bug in computing faces of non-full-dimensional lattice polytopes\n+\n+#8936 - Expose facet inequalities for lattice polytopes\n+\n+#8941 - `_latex_` and `origin` for lattice polytopes\n+\n+Main patches adding new modules:\n+\n+#8986 - Add support for convex rational polyhedral cones\n+\n+#8987 - Add support for rational polyhedral fans\n+\n+#8988 - Add support for toric varieties\n+\n+#8989 - Add support for Fano toric varieties\n+\n+Everything was tested on sage.math using sage-4.4.2.rc0.\n+\n+Known issues:\n+\n+- Applying patch for toric varieties leads to a doctest error in `sage.symbolic.random_tests`, which I don't quite understand, especially since this patch just adds a new module! The documentation of the failing function says \"This function will often raise an error because it tries to create an erroneous expression.\" I am not sure if this means that its doctest may cause these errors.\n+\n+- The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to\n+http://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4\n+this should not be an obstacle to include these patches.\n``````\n",
    "created_at": "2010-05-18T09:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104980",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,35 @@
+This patch is a part of the following series adding support for cones/fans and toric varieties to Sage:
 
+Prerequisites:
+
+#8675 - Remove `AmbientSpace._constructor` and fix consequences
+
+#8682 - Improve `AlgebraicScheme_subscheme.__init__` and `AmbientSpace._validate`
+
+#8694 - Improve schemes printing and LaTeXing
+
+#8934 - Trivial bug in computing faces of non-full-dimensional lattice polytopes
+
+#8936 - Expose facet inequalities for lattice polytopes
+
+#8941 - `_latex_` and `origin` for lattice polytopes
+
+Main patches adding new modules:
+
+#8986 - Add support for convex rational polyhedral cones
+
+#8987 - Add support for rational polyhedral fans
+
+#8988 - Add support for toric varieties
+
+#8989 - Add support for Fano toric varieties
+
+Everything was tested on sage.math using sage-4.4.2.rc0.
+
+Known issues:
+
+- Applying patch for toric varieties leads to a doctest error in `sage.symbolic.random_tests`, which I don't quite understand, especially since this patch just adds a new module! The documentation of the failing function says "This function will often raise an error because it tries to create an erroneous expression." I am not sure if this means that its doctest may cause these errors.
+
+- The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to
+http://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4
+this should not be an obstacle to include these patches.
``````




---

archive/issue_comments_104981.json:
```json
{
    "body": "**Author:** Andrey Novoseltsev",
    "created_at": "2010-05-18T09:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104981",
    "user": "https://github.com/novoselt"
}
```

**Author:** Andrey Novoseltsev



---

archive/issue_events_027059.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2010-05-18T09:46:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "milestone": "sage-4.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8988#event-27059"
}
```



---

archive/issue_comments_104982.json:
```json
{
    "body": "<a id='comment:2'></a>\nI have marked this ticket as \"needs review\" despite of the broken doctest. Since that doctest seems to be unrelated, please review the ticket and state your opinion independently of it, without actually switching to \"positive review\". If nobody objects, I will shortly post a patch changing that doctest to the new output. As I understand, the purpose of that function is to actually try to \"create some mess\" and so there is no any meaning in a particular output.",
    "created_at": "2010-05-18T10:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104982",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>
I have marked this ticket as "needs review" despite of the broken doctest. Since that doctest seems to be unrelated, please review the ticket and state your opinion independently of it, without actually switching to "positive review". If nobody objects, I will shortly post a patch changing that doctest to the new output. As I understand, the purpose of that function is to actually try to "create some mess" and so there is no any meaning in a particular output.



---

archive/issue_comments_104983.json:
```json
{
    "body": "<a id='comment:3'></a>\nAttachment [trac_8988_add_support_for_toric_varieties.2.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_add_support_for_toric_varieties.2.patch) by @novoselt created at 2010-05-19 03:50:39\n\nOops, forgot to click replace existing file. Only the second patch should be applied. I have added a more formal reference to \"Toric Varieties\" book (and I checked with David Cox that it is OK to put a link to the draft). I have also moved the `kaehler_cone` function from Fano toric varieties to this patch.",
    "created_at": "2010-05-19T03:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104983",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:3'></a>
Attachment [trac_8988_add_support_for_toric_varieties.2.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_add_support_for_toric_varieties.2.patch) by @novoselt created at 2010-05-19 03:50:39

Oops, forgot to click replace existing file. Only the second patch should be applied. I have added a more formal reference to "Toric Varieties" book (and I checked with David Cox that it is OK to put a link to the draft). I have also moved the `kaehler_cone` function from Fano toric varieties to this patch.



---

archive/issue_comments_104984.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2010-05-21T03:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104984",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_104985.json:
```json
{
    "body": "<a id='comment:4'></a>\nI will make some adjustments to modules on which this patch depends, which may cause some changes in this patch as well. See\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/17743e17d67838ae",
    "created_at": "2010-05-21T03:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104985",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'></a>
I will make some adjustments to modules on which this patch depends, which may cause some changes in this patch as well. See
http://groups.google.com/group/sage-devel/browse_thread/thread/17743e17d67838ae



---

archive/issue_comments_104986.json:
```json
{
    "body": "<a id='comment:5'></a>\nA couple little changes to account for changes in previous patches. Plus the fix for the broken doctest in symbolic.",
    "created_at": "2010-05-29T03:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104986",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:5'></a>
A couple little changes to account for changes in previous patches. Plus the fix for the broken doctest in symbolic.



---

archive/issue_comments_104987.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -16,6 +16,8 @@\n \n Main patches adding new modules:\n \n+#9062 - Add support for toric lattices\n+\n #8986 - Add support for convex rational polyhedral cones\n \n #8987 - Add support for rational polyhedral fans\n``````\n",
    "created_at": "2010-05-29T05:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104987",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -16,6 +16,8 @@
 
 Main patches adding new modules:
 
+#9062 - Add support for toric lattices
+
 #8986 - Add support for convex rational polyhedral cones
 
 #8987 - Add support for rational polyhedral fans
``````




---

archive/issue_comments_104988.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-05-29T19:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104988",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_104989.json:
```json
{
    "body": "<a id='comment:8'></a>\nFixed errors caused previously by the code of `affine_patch` of subschemes and removed `NotImplementedError` from the beginning of this function.",
    "created_at": "2010-06-03T03:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104989",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:8'></a>
Fixed errors caused previously by the code of `affine_patch` of subschemes and removed `NotImplementedError` from the beginning of this function.



---

archive/issue_comments_104990.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think the change in the random_test is because the patched sage/schemes/generic/algebraic_scheme now imports latex which imports random which changes the random seed. So it is all right, and fixing the random_test doctest is the right thing to do (TM).",
    "created_at": "2010-06-03T18:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104990",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>
I think the change in the random_test is because the patched sage/schemes/generic/algebraic_scheme now imports latex which imports random which changes the random seed. So it is all right, and fixing the random_test doctest is the right thing to do (TM).



---

archive/issue_comments_104991.json:
```json
{
    "body": "<a id='comment:10'></a>\nI've read through the code and it looks good. \n\nOne minor issue is that the `_repr_()` is not very descriptive. For example\n\n```\nsage: p0 = P1xP1.affine_patch(0)\nsage: p0\nToric variety of dimension 2\nsage: p0.embedding_morphism()\nScheme morphism:\n  From: Toric variety of dimension 2\n  To:   Toric variety of dimension 2\n  Defn: Defined on coordinates by sending [z0 : z3] to\n        [z0 : 1 : 1 : z3]\n```\nMaybe we could return `Toric variety (dim=2, #cones=4)` or so and include the number of generating cones to be able to distinguish the different varieties.\n\nApart from that I'd be happy to review it positively once the rewritten `Fan` is incorporated!",
    "created_at": "2010-06-13T21:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104991",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
I've read through the code and it looks good. 

One minor issue is that the `_repr_()` is not very descriptive. For example

```
sage: p0 = P1xP1.affine_patch(0)
sage: p0
Toric variety of dimension 2
sage: p0.embedding_morphism()
Scheme morphism:
  From: Toric variety of dimension 2
  To:   Toric variety of dimension 2
  Defn: Defined on coordinates by sending [z0 : z3] to
        [z0 : 1 : 1 : z3]
```
Maybe we could return `Toric variety (dim=2, #cones=4)` or so and include the number of generating cones to be able to distinguish the different varieties.

Apart from that I'd be happy to review it positively once the rewritten `Fan` is incorporated!



---

archive/issue_comments_104992.json:
```json
{
    "body": "<a id='comment:11'></a>\nHow about this?\n\n```\nToric variety of dimension 2 with 4 affine patches\n```\nI would like to have a description in \"plain English\" and also patches seem to be more intrinsic to varieties than cones.\n\nIt may be good also to add an option for \"extra\" name, so that varieties from a named database (which is not there yet but I hope to have it eventually based on your code) can print as \n\n```\nToric variety of dimension 2 with 4 affine patches (P1xP1)\n```\nor maybe\n\n```\nP1xP1 (Toric variety of dimension 2 with 4 affine patches)\n```\nwill be better. There is a way to rename anything in Sage, so\n\n```\nP1xP1\n```\nis very easy to do, but seems to be too different from the default one. Which one of three do you prefer?\n\nIt is also possible to print the base field, but I deliberately didn't do it so far because I always think of toric varieties as being defined over complex field. Plus, when the base field is a fraction field of a multivariable polynomial ring (as is the case with ambient spaces of anticanonical hypersurfaces in the next patch), the the description of the field gets really big and distracts from the toric variety itself.",
    "created_at": "2010-06-13T21:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104992",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:11'></a>
How about this?

```
Toric variety of dimension 2 with 4 affine patches
```
I would like to have a description in "plain English" and also patches seem to be more intrinsic to varieties than cones.

It may be good also to add an option for "extra" name, so that varieties from a named database (which is not there yet but I hope to have it eventually based on your code) can print as 

```
Toric variety of dimension 2 with 4 affine patches (P1xP1)
```
or maybe

```
P1xP1 (Toric variety of dimension 2 with 4 affine patches)
```
will be better. There is a way to rename anything in Sage, so

```
P1xP1
```
is very easy to do, but seems to be too different from the default one. Which one of three do you prefer?

It is also possible to print the base field, but I deliberately didn't do it so far because I always think of toric varieties as being defined over complex field. Plus, when the base field is a fraction field of a multivariable polynomial ring (as is the case with ambient spaces of anticanonical hypersurfaces in the next patch), the the description of the field gets really big and distracts from the toric variety itself.



---

archive/issue_comments_104993.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnd in your example the first variety should probably print as\n\n```\nAffine toric variety of dimension 2\n```",
    "created_at": "2010-06-13T21:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104993",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:12'></a>
And in your example the first variety should probably print as

```
Affine toric variety of dimension 2
```



---

archive/issue_comments_104994.json:
```json
{
    "body": "<a id='comment:13'></a>\nSince there you can cover any given space always with more patches I'm a bit hesitant; The notation `Toric variety of dimension 2 with 4 affine patches` only makes sense once you translate it back into toric geometry. But plain English is definitely preferable.\n\nI agree that the base field shouldn't be printed. Usually, it is going to be the same for all varieties the user constructs, so it is not a differentiating feature.",
    "created_at": "2010-06-14T00:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104994",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>
Since there you can cover any given space always with more patches I'm a bit hesitant; The notation `Toric variety of dimension 2 with 4 affine patches` only makes sense once you translate it back into toric geometry. But plain English is definitely preferable.

I agree that the base field shouldn't be printed. Usually, it is going to be the same for all varieties the user constructs, so it is not a differentiating feature.



---

archive/issue_comments_104995.json:
```json
{
    "body": "<a id='comment:14'></a>\nI agree... How about \"Toric variety of dimension 2 covered by 4 affine patches\"? Such a description a little more clearly refers to some particular cover, rather than arbitrary affine patches, and we do have a \"canonical\" one, returned by method `affine_patch(i)`.",
    "created_at": "2010-06-14T00:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104995",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:14'></a>
I agree... How about "Toric variety of dimension 2 covered by 4 affine patches"? Such a description a little more clearly refers to some particular cover, rather than arbitrary affine patches, and we do have a "canonical" one, returned by method `affine_patch(i)`.



---

archive/issue_comments_104996.json:
```json
{
    "body": "**Work_Issues:** Patch will be changed to accomodate changes in #8987",
    "created_at": "2010-06-17T06:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104996",
    "user": "https://github.com/novoselt"
}
```

**Work_Issues:** Patch will be changed to accomodate changes in #8987



---

archive/issue_comments_104997.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2010-06-17T06:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104997",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_104998.json:
```json
{
    "body": "<a id='comment:16'></a>\nIn the spirit of planned changes to cones and fans I propose printing toric varieties as\n\n```\n2-d toric variety covered by 4 affine patches\n```\nand\n\n```\n2-d affine toric variety\n```\nfor those generated by a single cone.",
    "created_at": "2010-06-17T06:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104998",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:16'></a>
In the spirit of planned changes to cones and fans I propose printing toric varieties as

```
2-d toric variety covered by 4 affine patches
```
and

```
2-d affine toric variety
```
for those generated by a single cone.



---

archive/issue_comments_104999.json:
```json
{
    "body": "**Changing work_issues** from \"Patch will be changed to accomodate changes in #8987\" to \"\".",
    "created_at": "2010-06-17T20:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-104999",
    "user": "https://github.com/novoselt"
}
```

**Changing work_issues** from "Patch will be changed to accomodate changes in #8987" to "".



---

archive/issue_comments_105000.json:
```json
{
    "body": "<a id='comment:17'></a>\nI've started a discussion\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/763d9ac5634bf8f3\nas `symbolic/random_tests.py` gives now more grief (I am using 4.4.4.alpha0). Meanwhile I will update the doctest patch with new output...\n\nToric varieties are pretty much unchanged except for renaming fan-related functions and changing the representation.",
    "created_at": "2010-06-17T20:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105000",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:17'></a>
I've started a discussion
http://groups.google.com/group/sage-devel/browse_thread/thread/763d9ac5634bf8f3
as `symbolic/random_tests.py` gives now more grief (I am using 4.4.4.alpha0). Meanwhile I will update the doctest patch with new output...

Toric varieties are pretty much unchanged except for renaming fan-related functions and changing the representation.



---

archive/issue_comments_105001.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-06-17T20:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105001",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_105002.json:
```json
{
    "body": "Apply after the main patch. Broken doctests are fixed by setting random seed.",
    "created_at": "2010-06-17T22:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105002",
    "user": "https://github.com/novoselt"
}
```

Apply after the main patch. Broken doctests are fixed by setting random seed.



---

archive/issue_comments_105003.json:
```json
{
    "body": "<a id='comment:18'></a>\nAttachment [trac_8988_doctest_fix_for_symbolic_random_tests.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_doctest_fix_for_symbolic_random_tests.patch) by @vbraun created at 2010-06-21 16:42:23\n\nLooks good now. One final nitpick is that the Kaehler cone lives in some `ToricLattice` which is somewhat confusing. I propose a `ToricVariety_field.Pic()` method returning a suitable lattice for the Kahler cone to live in. For now thats just `ZZ^k` but in the future we could be more fancy. Also, rename `kaehler_cone` -> `Kaehler_cone` since it is a name. Patch is attached, let me know what you think.",
    "created_at": "2010-06-21T16:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105003",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>
Attachment [trac_8988_doctest_fix_for_symbolic_random_tests.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_doctest_fix_for_symbolic_random_tests.patch) by @vbraun created at 2010-06-21 16:42:23

Looks good now. One final nitpick is that the Kaehler cone lives in some `ToricLattice` which is somewhat confusing. I propose a `ToricVariety_field.Pic()` method returning a suitable lattice for the Kahler cone to live in. For now thats just `ZZ^k` but in the future we could be more fancy. Also, rename `kaehler_cone` -> `Kaehler_cone` since it is a name. Patch is attached, let me know what you think.



---

archive/issue_comments_105004.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2010-06-22T19:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105004",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_105005.json:
```json
{
    "body": "<a id='comment:19'></a>\nIn the singular case the `Kaehler_cone` method actually computes the cone in the rational (Weyl) divisor class group = `A_{n-1}(X) \\otimes_\\ZZ \\QQ`, and not in the Picard group. The updated patch changes the names accordingly.",
    "created_at": "2010-06-22T19:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105005",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
In the singular case the `Kaehler_cone` method actually computes the cone in the rational (Weyl) divisor class group = `A_{n-1}(X) \otimes_\ZZ \QQ`, and not in the Picard group. The updated patch changes the names accordingly.



---

archive/issue_comments_105006.json:
```json
{
    "body": "<a id='comment:20'></a>\nAnother thought: It would be nice if `ToricVariety_field.fan()` would take an optional argument and pass it on to the fan so one could write\n\n```\nX = ToricVariety(...)\nX.fan(dim=1)\n```\ninstead of\n\n```\nX.fan()(dim=1)\n```",
    "created_at": "2010-06-23T14:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105006",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
Another thought: It would be nice if `ToricVariety_field.fan()` would take an optional argument and pass it on to the fan so one could write

```
X = ToricVariety(...)
X.fan(dim=1)
```
instead of

```
X.fan()(dim=1)
```



---

archive/issue_comments_105007.json:
```json
{
    "body": "<a id='comment:21'></a>\nNeat idea! Will do in a few days ;-)",
    "created_at": "2010-06-23T16:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105007",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:21'></a>
Neat idea! Will do in a few days ;-)



---

archive/issue_comments_105008.json:
```json
{
    "body": "<a id='comment:22'></a>\nYet another minor note: we might want to rename `ToricVariety.is_complete` to `ToricVariety.is_compact`. Not a big deal, but probably the better term in that context.",
    "created_at": "2010-06-23T17:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105008",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>
Yet another minor note: we might want to rename `ToricVariety.is_complete` to `ToricVariety.is_compact`. Not a big deal, but probably the better term in that context.



---

archive/issue_comments_105009.json:
```json
{
    "body": "<a id='comment:23'></a>\nI think I used `is_complete` since compact does not quite make sense for arbitrary fields.\n\nRegarding Kaehler cone - maybe the best option for now is just to remove it until divisors are actually implemented? The reason why it is here now is that I had to compute it for several varieties, so I wrote a quick function based on existing code without worrying too much about how well does it fit into the current picture. It seems that not very well...",
    "created_at": "2010-06-23T18:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105009",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:23'></a>
I think I used `is_complete` since compact does not quite make sense for arbitrary fields.

Regarding Kaehler cone - maybe the best option for now is just to remove it until divisors are actually implemented? The reason why it is here now is that I had to compute it for several varieties, so I wrote a quick function based on existing code without worrying too much about how well does it fit into the current picture. It seems that not very well...



---

archive/issue_comments_105010.json:
```json
{
    "body": "<a id='comment:24'></a>\nI think we can't do much better for `Kaehler_cone`. I'll send a patch for divisors soon, maybe that'll help to make a more informed decision. In the meantime, here is a   patch with documentation fixes.",
    "created_at": "2010-06-24T10:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105010",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>
I think we can't do much better for `Kaehler_cone`. I'll send a patch for divisors soon, maybe that'll help to make a more informed decision. In the meantime, here is a   patch with documentation fixes.



---

archive/issue_comments_105011.json:
```json
{
    "body": "Added a Mori_vectors() method while I'm at it.",
    "created_at": "2010-06-25T15:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105011",
    "user": "https://github.com/vbraun"
}
```

Added a Mori_vectors() method while I'm at it.



---

archive/issue_comments_105012.json:
```json
{
    "body": "<a id='comment:25'></a>\nAttachment [trac_8988_Kahlercone_lattice.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_Kahlercone_lattice.patch) by @novoselt created at 2010-06-29 04:44:27\n\nAdded parameters to `fan` method and changed the behaviour of `__call__` for fans in the case of no parameters at all - it seems more natural to return the fan in this case rather than all cones of all dimensions (which is what `cones` does).",
    "created_at": "2010-06-29T04:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105012",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:25'></a>
Attachment [trac_8988_Kahlercone_lattice.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_Kahlercone_lattice.patch) by @novoselt created at 2010-06-29 04:44:27

Added parameters to `fan` method and changed the behaviour of `__call__` for fans in the case of no parameters at all - it seems more natural to return the fan in this case rather than all cones of all dimensions (which is what `cones` does).



---

archive/issue_comments_105013.json:
```json
{
    "body": "Attachment [trac_8988_add_support_for_toric_varieties.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_add_support_for_toric_varieties.patch) by @novoselt created at 2010-06-29 05:46:41\n\nApply this patch and doctest fix.",
    "created_at": "2010-06-29T05:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105013",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_8988_add_support_for_toric_varieties.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_add_support_for_toric_varieties.patch) by @novoselt created at 2010-06-29 05:46:41

Apply this patch and doctest fix.



---

archive/issue_comments_105014.json:
```json
{
    "body": "Attachment [trac_8988_Kaehler_Mori_cones.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_Kaehler_Mori_cones.patch) by @novoselt created at 2010-06-29 05:48:50\n\nCode to be included later.",
    "created_at": "2010-06-29T05:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105014",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_8988_Kaehler_Mori_cones.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_Kaehler_Mori_cones.patch) by @novoselt created at 2010-06-29 05:48:50

Code to be included later.



---

archive/issue_comments_105015.json:
```json
{
    "body": "<a id='comment:26'></a>\nHi Volker,\n\nI have done some work on the documentation from your patch and got completely stuck at `Mori_vectors`. Problems from smaller to bigger ones:\n\n* Are we allowed to use non-standard characters? I mean \"a with dots\" in Kaehler. I vaguely remember some discussion about it, but don't recall the result. Personally I prefer to use only characters that are easy to type and display for everyone. It does mean that some names are not accurately represented, but having one of such names I can vote in favour of it ;-) \n\n* Your doctest uses toric varieties library which depends on this patch. It is a good non-trivial doctest, so I have no desire to remove it.\n\n* Why does it return vectors rather than cone (in the same way as `Kaehler_cone`)?\n\n* Kaehler and Mori cones are supposed to be dual, but they are not. Because Kaehler cone is given in some coordinates on the class group and Mori cone is given embedded into a higher dimensional space without a choice of a basis for its \"real space\". Both representations are probably useful and should be available, but it should be done consistently.\n\nSo:\n\n* I have removed my `kaehler_cone` method from the main patch, hopefully now you can give it a positive review together with symbolic doctest fixes only.\n\n* I have uploaded a new patch which contains your rebased changes and my edits to the documentation. It should NOT be applied here, I just wanted to save this code. As a patch it now just contains three new functions and can be easily moved to other tickets, where the library of toric varieties will be available to use in doctests. We will also need to take care of the last two points above.\n\nLet me know what you think of all this.\n\nAndrey",
    "created_at": "2010-06-29T06:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105015",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:26'></a>
Hi Volker,

I have done some work on the documentation from your patch and got completely stuck at `Mori_vectors`. Problems from smaller to bigger ones:

* Are we allowed to use non-standard characters? I mean "a with dots" in Kaehler. I vaguely remember some discussion about it, but don't recall the result. Personally I prefer to use only characters that are easy to type and display for everyone. It does mean that some names are not accurately represented, but having one of such names I can vote in favour of it ;-) 

* Your doctest uses toric varieties library which depends on this patch. It is a good non-trivial doctest, so I have no desire to remove it.

* Why does it return vectors rather than cone (in the same way as `Kaehler_cone`)?

* Kaehler and Mori cones are supposed to be dual, but they are not. Because Kaehler cone is given in some coordinates on the class group and Mori cone is given embedded into a higher dimensional space without a choice of a basis for its "real space". Both representations are probably useful and should be available, but it should be done consistently.

So:

* I have removed my `kaehler_cone` method from the main patch, hopefully now you can give it a positive review together with symbolic doctest fixes only.

* I have uploaded a new patch which contains your rebased changes and my edits to the documentation. It should NOT be applied here, I just wanted to save this code. As a patch it now just contains three new functions and can be easily moved to other tickets, where the library of toric varieties will be available to use in doctests. We will also need to take care of the last two points above.

Let me know what you think of all this.

Andrey



---

archive/issue_comments_105016.json:
```json
{
    "body": "<a id='comment:27'></a>\n* I searched the sage-devel group but did not find any discussion. I think unicode docstrings are fine, but should be marked as `u\"\"\"documentation\"\"\"` which I did not do. Method names are and should be 7bit only.\n  * For those than can't dualize the Kaehler cone manually I envision a `Mori_cone` method. Note that the `Mori_vectors` are (nrays+1)-component vectors, so this will never match the Kaehler cone. If you think that thats too confusing it could be renamed to `GLsM_charge_vectors()`, for example.\n  * So shall we agree that Kahler/Mori cones should live in `QQ^nrays`? The advantage is that there is a canonical basis given by the rays, as you said.",
    "created_at": "2010-06-29T13:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105016",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'></a>
* I searched the sage-devel group but did not find any discussion. I think unicode docstrings are fine, but should be marked as `u"""documentation"""` which I did not do. Method names are and should be 7bit only.
  * For those than can't dualize the Kaehler cone manually I envision a `Mori_cone` method. Note that the `Mori_vectors` are (nrays+1)-component vectors, so this will never match the Kaehler cone. If you think that thats too confusing it could be renamed to `GLsM_charge_vectors()`, for example.
  * So shall we agree that Kahler/Mori cones should live in `QQ^nrays`? The advantage is that there is a canonical basis given by the rays, as you said.



---

archive/issue_comments_105017.json:
```json
{
    "body": "<a id='comment:28'></a>\nI think (strongly ;-)) that `Kaehler_cone` method should return a cone in the class group in some basis, since such cones with some additions form a complete fan of the GKZ decomposition.\n\nWe should, however, have a clear way of going from divisors associated to rays to this basis and, perhaps, a way to go back. The first is easy, the i-th ray is represented by the i-th column of the Gale transform matrix. However, it may not be obvious and does not feel natural, since one has to involve functions of the fan, rather than toric variety directly.\n\nFor `Mori_cone` I would prefer to get the \"traditional dual\" of the `Kaehler_cone`, i.e. just the cone formed by facet normals, because it is confusing otherwise.\n\nAgain, there should be a clean way to go from any vector in the ambient space of `Mori_cone` to the longer vector with clear interpretation of each entry. I am OK with having a special function for the generators of the Mori cone and your proposed name is fine (although I have always seen this abbreviation as GLSM and would prefer all-capital version).\n\n**Regarding this ticket**, my main point is that these functions require some more work and since they operate with divisors, perhaps we can move them to the ticket implementing divisors? Or, in order to avoid adding more stuff there and therefore potentially delaying it, I can create a new ticket for implementing all of the above (including, finally, `cone.dual` to make `Mori_cone` trivial).",
    "created_at": "2010-06-29T14:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105017",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:28'></a>
I think (strongly ;-)) that `Kaehler_cone` method should return a cone in the class group in some basis, since such cones with some additions form a complete fan of the GKZ decomposition.

We should, however, have a clear way of going from divisors associated to rays to this basis and, perhaps, a way to go back. The first is easy, the i-th ray is represented by the i-th column of the Gale transform matrix. However, it may not be obvious and does not feel natural, since one has to involve functions of the fan, rather than toric variety directly.

For `Mori_cone` I would prefer to get the "traditional dual" of the `Kaehler_cone`, i.e. just the cone formed by facet normals, because it is confusing otherwise.

Again, there should be a clean way to go from any vector in the ambient space of `Mori_cone` to the longer vector with clear interpretation of each entry. I am OK with having a special function for the generators of the Mori cone and your proposed name is fine (although I have always seen this abbreviation as GLSM and would prefer all-capital version).

**Regarding this ticket**, my main point is that these functions require some more work and since they operate with divisors, perhaps we can move them to the ticket implementing divisors? Or, in order to avoid adding more stuff there and therefore potentially delaying it, I can create a new ticket for implementing all of the above (including, finally, `cone.dual` to make `Mori_cone` trivial).



---

archive/issue_comments_105018.json:
```json
{
    "body": "<a id='comment:29'></a>\nIn #9337 I did implement a `divisor.rational_class()` method that returns what you want. But there is no canonical way to go from divisor class -> divisor, so the computation of Kahler cones does not depend on the implementation of toric divisors.\n\nI agree that `Mori_cone()` should return just `Kahler_cone().dual()` and we can implement that later.\n\nGLSM is fine with me, too.\n\nIf you want to split off the Kahler cone computation from this ticket then thats fine with me. But we should then make it an independent ticket and not lump into toric divisors.",
    "created_at": "2010-06-29T15:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105018",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>
In #9337 I did implement a `divisor.rational_class()` method that returns what you want. But there is no canonical way to go from divisor class -> divisor, so the computation of Kahler cones does not depend on the implementation of toric divisors.

I agree that `Mori_cone()` should return just `Kahler_cone().dual()` and we can implement that later.

GLSM is fine with me, too.

If you want to split off the Kahler cone computation from this ticket then thats fine with me. But we should then make it an independent ticket and not lump into toric divisors.



---

archive/issue_comments_105019.json:
```json
{
    "body": "<a id='comment:30'></a>\nMoved cones to #9380. Patches remaining relevant to this ticket:\n\n* trac_8988_add_support_for_toric_varieties.patch (same as before, except that `kaehler_cone` is gone)\n\n* trac_8988_doctest_fix_for_symbolic_random_tests.patch\n\nAny issues you still see with these two?",
    "created_at": "2010-06-29T19:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105019",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:30'></a>
Moved cones to #9380. Patches remaining relevant to this ticket:

* trac_8988_add_support_for_toric_varieties.patch (same as before, except that `kaehler_cone` is gone)

* trac_8988_doctest_fix_for_symbolic_random_tests.patch

Any issues you still see with these two?



---

archive/issue_comments_105020.json:
```json
{
    "body": "<a id='comment:31'></a>\nThe rest is uncontroversial. The two patches apply cleanly to sage 4.4.4. Positive review!",
    "created_at": "2010-06-29T20:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105020",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>
The rest is uncontroversial. The two patches apply cleanly to sage 4.4.4. Positive review!



---

archive/issue_comments_105021.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-06-29T20:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105021",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_105022.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2010-07-01T08:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105022",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_105023.json:
```json
{
    "body": "<a id='comment:32'></a>\nI couldn't get this patch to apply unless I applied #9062, #8986, #9188 and #8987 beforehand. With these installed on top of 4.5.alpha1 (and no others), I got a doctest failure:\n\n```\n> sage -hg qapplied\ntrac_9062_add_support_for_toric_lattices.patch\ntrac_8986_add_support_for_convex_rational_polyhedral_cones.patch\ntrac_9188_fix_facet_normal.patch\ntrac_9188_fix_facet_normal_reviewer.patch\ntrac_8987_add_support_for_rational_polyhedral_fans.patch\ntrac_8987_add_enhanced_cones_and_fans.patch\ntrac_8987_review_changes.patch\ntrac_8987_repr_changes.patch\ntrac_8988_add_support_for_toric_varieties.patch\ntrac_8988_doctest_fix_for_symbolic_random_tests.patch\n> sage -t sage/misc/sageinspect.py\nsage -t  \"devel/sage-reviewing/sage/misc/sageinspect.py\"\n**********************************************************************\nFile \"/storage/masiao/sage-4.5.alpha1/devel/sage-reviewing/sage/misc/sageinspect.py\", line 983:\n    sage: sage_getvariablename(A)\nExpected:\n    ['A', 'B']\nGot:\n    ['B', 'A']\n**********************************************************************\n1 items had failures:\n   1 of   8 in __main__.example_22\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/masiao/.sage//tmp/.doctest_sageinspect.py\n         [2.9 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"devel/sage-reviewing/sage/misc/sageinspect.py\"\nTotal time for all tests: 2.9 seconds\n```\n\nI have not got the foggiest clue why toric varieties can possibly have anything to do with this; it just looks like the doctests for sageinspect are sensitive to exactly what memory addresses things get stored at. I will put this back to \"needs review\" for now, but upload a tiny patch that sorts the variable name list; if you folks agree that it looks harmless, then we can go back to positive review.",
    "created_at": "2010-07-01T08:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105023",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:32'></a>
I couldn't get this patch to apply unless I applied #9062, #8986, #9188 and #8987 beforehand. With these installed on top of 4.5.alpha1 (and no others), I got a doctest failure:

```
> sage -hg qapplied
trac_9062_add_support_for_toric_lattices.patch
trac_8986_add_support_for_convex_rational_polyhedral_cones.patch
trac_9188_fix_facet_normal.patch
trac_9188_fix_facet_normal_reviewer.patch
trac_8987_add_support_for_rational_polyhedral_fans.patch
trac_8987_add_enhanced_cones_and_fans.patch
trac_8987_review_changes.patch
trac_8987_repr_changes.patch
trac_8988_add_support_for_toric_varieties.patch
trac_8988_doctest_fix_for_symbolic_random_tests.patch
> sage -t sage/misc/sageinspect.py
sage -t  "devel/sage-reviewing/sage/misc/sageinspect.py"
**********************************************************************
File "/storage/masiao/sage-4.5.alpha1/devel/sage-reviewing/sage/misc/sageinspect.py", line 983:
    sage: sage_getvariablename(A)
Expected:
    ['A', 'B']
Got:
    ['B', 'A']
**********************************************************************
1 items had failures:
   1 of   8 in __main__.example_22
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/masiao/.sage//tmp/.doctest_sageinspect.py
         [2.9 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage-reviewing/sage/misc/sageinspect.py"
Total time for all tests: 2.9 seconds
```

I have not got the foggiest clue why toric varieties can possibly have anything to do with this; it just looks like the doctests for sageinspect are sensitive to exactly what memory addresses things get stored at. I will put this back to "needs review" for now, but upload a tiny patch that sorts the variable name list; if you folks agree that it looks harmless, then we can go back to positive review.



---

archive/issue_comments_105024.json:
```json
{
    "body": "fix a broken doctest in sageinspect",
    "created_at": "2010-07-01T08:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105024",
    "user": "https://github.com/loefflerd"
}
```

fix a broken doctest in sageinspect



---

archive/issue_comments_105025.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-07-01T08:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105025",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_105026.json:
```json
{
    "body": "<a id='comment:33'></a>\nAttachment [trac_8988-sageinspect_doctest_fix.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988-sageinspect_doctest_fix.patch) by @loefflerd created at 2010-07-01 08:37:38\n\nHere's the fix.",
    "created_at": "2010-07-01T08:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105026",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:33'></a>
Attachment [trac_8988-sageinspect_doctest_fix.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988-sageinspect_doctest_fix.patch) by @loefflerd created at 2010-07-01 08:37:38

Here's the fix.



---

archive/issue_comments_105027.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-07-01T09:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105027",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_105028.json:
```json
{
    "body": "<a id='comment:34'></a>\nThe order of the output of `sage_getvariablename` is in the memory order of some python `dict`, so the doctest had to fail at one point. I grepped through the sage library and the only use of `sage_getvariablename` is in `sage/matrix/matrix0.pyx` where the order of items is actually not used. \n\nSo davidloeffler's fix of sorting the output of `sage_getvariablename` is safe and the right thing to do to return a deterministic output. I give it a positive review.",
    "created_at": "2010-07-01T09:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105028",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>
The order of the output of `sage_getvariablename` is in the memory order of some python `dict`, so the doctest had to fail at one point. I grepped through the sage library and the only use of `sage_getvariablename` is in `sage/matrix/matrix0.pyx` where the order of items is actually not used. 

So davidloeffler's fix of sorting the output of `sage_getvariablename` is safe and the right thing to do to return a deterministic output. I give it a positive review.



---

archive/issue_comments_105029.json:
```json
{
    "body": "<a id='comment:35'></a>\nI made a systematic mistake in doctests of `__cmp__`  methods of all patches, discovered in #9062. So now I am posting these one-line patches to fix them, please review!",
    "created_at": "2010-07-01T16:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105029",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:35'></a>
I made a systematic mistake in doctests of `__cmp__`  methods of all patches, discovered in #9062. So now I am posting these one-line patches to fix them, please review!



---

archive/issue_comments_105030.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2010-07-01T16:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105030",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_105031.json:
```json
{
    "body": "Attachment [trac_8988_cmp_fix.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_cmp_fix.patch) by @novoselt created at 2010-07-01 16:28:46",
    "created_at": "2010-07-01T16:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105031",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_8988_cmp_fix.patch](tarball://root/attachments/some-uuid/ticket8988/trac_8988_cmp_fix.patch) by @novoselt created at 2010-07-01 16:28:46



---

archive/issue_comments_105032.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-07-01T16:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105032",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_105033.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-07-01T16:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105033",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_105034.json:
```json
{
    "body": "<a id='comment:37'></a>\nPositive review of the doctest fix!",
    "created_at": "2010-07-01T16:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105034",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:37'></a>
Positive review of the doctest fix!



---

archive/issue_comments_105035.json:
```json
{
    "body": "<a id='comment:38'></a>\nThese patches won't apply without #8986, which is currently at \"needs work\", so it can't be merged at present.",
    "created_at": "2010-07-01T17:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105035",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:38'></a>
These patches won't apply without #8986, which is currently at "needs work", so it can't be merged at present.



---

archive/issue_comments_105036.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2010-07-01T17:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105036",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_105037.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-07-02T10:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105037",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_105038.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-07-02T10:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105038",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_105039.json:
```json
{
    "body": "<a id='comment:41'></a>\nSee #9514 for a patch that fixes the random_tests doctest issue.",
    "created_at": "2010-07-16T04:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105039",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:41'></a>
See #9514 for a patch that fixes the random_tests doctest issue.



---

archive/issue_comments_105040.json:
```json
{
    "body": "<a id='comment:42'></a>\nIt will be better to pre-merge #9514 instead of the doctest fix from this ticket. Then the following patches must be applied:\n\n* trac_8988_add_support_for_toric_varieties.patch\n* trac_8988-sageinspect_doctest_fix.patch\n* trac_8988_cmp_fix.patch",
    "created_at": "2010-07-16T15:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105040",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:42'></a>
It will be better to pre-merge #9514 instead of the doctest fix from this ticket. Then the following patches must be applied:

* trac_8988_add_support_for_toric_varieties.patch
* trac_8988-sageinspect_doctest_fix.patch
* trac_8988_cmp_fix.patch



---

archive/issue_comments_105041.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,6 +14,8 @@\n \n #8941 - `_latex_` and `origin` for lattice polytopes\n \n+#9514 - sage/symbolic/random_tests.py wrongly depends on order of dict.values()\n+\n Main patches adding new modules:\n \n #9062 - Add support for toric lattices\n@@ -26,11 +28,7 @@\n \n #8989 - Add support for Fano toric varieties\n \n-Everything was tested on sage.math using sage-4.4.2.rc0.\n-\n Known issues:\n-\n-- Applying patch for toric varieties leads to a doctest error in `sage.symbolic.random_tests`, which I don't quite understand, especially since this patch just adds a new module! The documentation of the failing function says \"This function will often raise an error because it tries to create an erroneous expression.\" I am not sure if this means that its doctest may cause these errors.\n \n - The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to\n http://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4\n``````\n",
    "created_at": "2010-07-16T15:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105041",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,6 +14,8 @@
 
 #8941 - `_latex_` and `origin` for lattice polytopes
 
+#9514 - sage/symbolic/random_tests.py wrongly depends on order of dict.values()
+
 Main patches adding new modules:
 
 #9062 - Add support for toric lattices
@@ -26,11 +28,7 @@
 
 #8989 - Add support for Fano toric varieties
 
-Everything was tested on sage.math using sage-4.4.2.rc0.
-
 Known issues:
-
-- Applying patch for toric varieties leads to a doctest error in `sage.symbolic.random_tests`, which I don't quite understand, especially since this patch just adds a new module! The documentation of the failing function says "This function will often raise an error because it tries to create an erroneous expression." I am not sure if this means that its doctest may cause these errors.
 
 - The last two patches show a doctest coverage error about `TestSuite`. This doctest does not work yet for other schemes and therefore should not be expected to work for these derived classes (and indeed - it does not work). According to
 http://groups.google.com/group/sage-devel/browse_thread/thread/a42ace80078373b4
``````




---

archive/issue_comments_105042.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2010-07-20T08:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105042",
    "user": "https://github.com/qed777"
}
```

**Resolution:** fixed



---

archive/issue_comments_105043.json:
```json
{
    "body": "**Merged:** sage-4.5.2.alpha0",
    "created_at": "2010-07-20T08:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105043",
    "user": "https://github.com/qed777"
}
```

**Merged:** sage-4.5.2.alpha0



---

archive/issue_events_027060.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-07-20T08:57:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8988#event-27060"
}
```



---

archive/issue_comments_105044.json:
```json
{
    "body": "<a id='comment:43'></a>\nThere's a doctest failure in SageNB's `sageinspect.py`:\n\n```python\n$ ./sage -t -long  local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py\nsage -t -long \"local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py\"\n**********************************************************************\nFile \"/mnt/usb1/scratch/mpatel/tmp/sage-4.5.1-rm/local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py\", line 997:\n    sage: sage_getvariablename(A)\nExpected:\n    ['A', 'B']\nGot:\n    ['B', 'A']\n**********************************************************************\n1 items had failures:\n   1 of   8 in __main__.example_22\n***Test Failed*** 1 failures.\n```\nI'm closing this ticket as fixed but have opened #9554 as a blocker for 4.5.2.",
    "created_at": "2010-07-20T08:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8988#issuecomment-105044",
    "user": "https://github.com/qed777"
}
```

<a id='comment:43'></a>
There's a doctest failure in SageNB's `sageinspect.py`:

```python
$ ./sage -t -long  local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py
sage -t -long "local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py"
**********************************************************************
File "/mnt/usb1/scratch/mpatel/tmp/sage-4.5.1-rm/local/lib/python2.6/site-packages/sagenb-0.8.1-py2.6.egg/sagenb/misc/sageinspect.py", line 997:
    sage: sage_getvariablename(A)
Expected:
    ['A', 'B']
Got:
    ['B', 'A']
**********************************************************************
1 items had failures:
   1 of   8 in __main__.example_22
***Test Failed*** 1 failures.
```
I'm closing this ticket as fixed but have opened #9554 as a blocker for 4.5.2.
