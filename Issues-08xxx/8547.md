# Issue 8547: implement hidden markov models in Cython from scratch (so can remove the GHMM standard package from Sage)

archive/issues_008547.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mhampton"
    ],
    "body": "NOTE: After applying this patch(es), the following standard spkg can be completely deleted:\n    ghmm-20080813.p0.spkg\n\nThis patch provides a complete reimplementation of Hidden Markov Models from scratch in Sage.  It is now doctested and the tests should pass on all standard Sage platforms.   Note that that HMM code in sage-4.3.4 and earlier is *NOT* tested at all, can easily segfault in all kinds of cases, leaks huge amounts of memory, etc.  The new code shouldn't have those defects.  Plus we get to delete a standard spkg.   Moreover, this new code is much easier to modify and experiment with.  Performance is generally similar, sometimes better, and sometimes worse, than the old code. \n\n\nCC:  @jasongrout @sagetrac-mhampton\n\nComponent: **statistics**\n\nAuthor: **William Stein**\n\nReviewer: **Marshall Hampton, Tom Boothby, Jason Grout**\n\nMerged: **sage-4.4.alpha0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/8547_\n\n",
    "closed_at": "2010-04-16T18:43:45Z",
    "created_at": "2010-03-16T08:08:50Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20statistics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "implement hidden markov models in Cython from scratch (so can remove the GHMM standard package from Sage)",
    "type": "issue",
    "updated_at": "2010-04-16T18:43:45Z",
    "url": "https://github.com/sagemath/sage/issues/8547",
    "user": "https://github.com/williamstein"
}
```
NOTE: After applying this patch(es), the following standard spkg can be completely deleted:
    ghmm-20080813.p0.spkg

This patch provides a complete reimplementation of Hidden Markov Models from scratch in Sage.  It is now doctested and the tests should pass on all standard Sage platforms.   Note that that HMM code in sage-4.3.4 and earlier is *NOT* tested at all, can easily segfault in all kinds of cases, leaks huge amounts of memory, etc.  The new code shouldn't have those defects.  Plus we get to delete a standard spkg.   Moreover, this new code is much easier to modify and experiment with.  Performance is generally similar, sometimes better, and sometimes worse, than the old code. 


CC:  @jasongrout @sagetrac-mhampton

Component: **statistics**

Author: **William Stein**

Reviewer: **Marshall Hampton, Tom Boothby, Jason Grout**

Merged: **sage-4.4.alpha0**

_Issue created by migration from https://trac.sagemath.org/ticket/8547_





---

archive/issue_events_107925.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-03-16T08:08:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "milestone_number": null,
    "milestone_title": "sage-4.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107925"
}
```



---

archive/issue_events_107926.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-03-16T08:08:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20statistics",
    "label_color": "0000ff",
    "label_name": "c: statistics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107926"
}
```



---

archive/issue_events_107927.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-03-16T08:08:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107927"
}
```



---

archive/issue_events_107928.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-03-16T08:08:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107928"
}
```



---

archive/issue_events_107929.json:
```json
{
    "actor": "https://github.com/sagetrac-amhou",
    "created_at": "2010-03-16T08:08:50Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/williamstein",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107929"
}
```



---

archive/issue_comments_068208.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n+NOTE: After applying this patch(es), the following standard spkg can be completely deleted:\n+    ghmm-20080813.p0.spkg\n \n+This patch provides a complete reimplementation of Hidden Markov Models from scratch in Sage.  It is now doctested and the tests should pass on all standard Sage platforms.   Note that that HMM code in sage-4.3.4 and earlier is *NOT* tested at all, can easily segfault in all kinds of cases, leaks huge amounts of memory, etc.  The new code shouldn't have those defects.  Plus we get to delete a standard spkg.   Moreover, this new code is much easier to modify and experiment with.  Performance is generally similar, sometimes better, and sometimes worse, than the old code. \n+\n``````\n",
    "created_at": "2010-03-20T12:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68208",
    "user": "https://github.com/williamstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,5 @@
+NOTE: After applying this patch(es), the following standard spkg can be completely deleted:
+    ghmm-20080813.p0.spkg
 
+This patch provides a complete reimplementation of Hidden Markov Models from scratch in Sage.  It is now doctested and the tests should pass on all standard Sage platforms.   Note that that HMM code in sage-4.3.4 and earlier is *NOT* tested at all, can easily segfault in all kinds of cases, leaks huge amounts of memory, etc.  The new code shouldn't have those defects.  Plus we get to delete a standard spkg.   Moreover, this new code is much easier to modify and experiment with.  Performance is generally similar, sometimes better, and sometimes worse, than the old code. 
+
``````




---

archive/issue_comments_068209.json:
```json
{
    "body": "apply this. Then look at devel/sage/sage/stats/intlist.pyx, devel/sage/sage/stats/hmm (which is entirely new code), and look at the few minor bug fixes to finance/time_series.pyx",
    "created_at": "2010-03-20T12:49:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68209",
    "user": "https://github.com/williamstein"
}
```

apply this. Then look at devel/sage/sage/stats/intlist.pyx, devel/sage/sage/stats/hmm (which is entirely new code), and look at the few minor bug fixes to finance/time_series.pyx



---

archive/issue_comments_068210.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAttachment: **[trac_8547.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547.patch.gz)**",
    "created_at": "2010-03-20T12:49:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68210",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:2" align="right">comment:2</div>

Attachment: **[trac_8547.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547.patch.gz)**



---

archive/issue_events_107930.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-03-20T12:49:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107930"
}
```



---

archive/issue_comments_068211.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis is now ready for review.  Some notes:\n\n1. Don't bother looking at the diff, except for time_series.pyx and module_list.py.  Just look at at the files in stats/hmm, which are all new, and stats/intlist.pyx.\n\n2. There are a number of very small API changes (for the better).   This technically violates our DeprecationPolicy.  However, frankly, the current code was -- upon inspection -- so bad, that there is no way anybody was actually using it for anything serious.  (As was evidenced by the response on sage-devel.)  And the API is only a tiny bit changed now. \n\n3. I do have a long list of possible followup projects. However, I wanted to make a first solid release that at least has enough to replace the existing HMM functionality in Sage, before adding lots of new stuff.",
    "created_at": "2010-03-20T12:53:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68211",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:3" align="right">comment:3</div>

This is now ready for review.  Some notes:

1. Don't bother looking at the diff, except for time_series.pyx and module_list.py.  Just look at at the files in stats/hmm, which are all new, and stats/intlist.pyx.

2. There are a number of very small API changes (for the better).   This technically violates our DeprecationPolicy.  However, frankly, the current code was -- upon inspection -- so bad, that there is no way anybody was actually using it for anything serious.  (As was evidenced by the response on sage-devel.)  And the API is only a tiny bit changed now. 

3. I do have a long list of possible followup projects. However, I wanted to make a first solid release that at least has enough to replace the existing HMM functionality in Sage, before adding lots of new stuff.



---

archive/issue_events_107931.json:
```json
{
    "actor": "https://github.com/sagetrac-amhou",
    "created_at": "2010-03-21T17:04:23Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107931"
}
```



---

archive/issue_events_107932.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2010-03-21T17:04:23Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107932"
}
```



---

archive/issue_events_107933.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2010-03-21T17:05:04Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107933"
}
```



---

archive/issue_events_107934.json:
```json
{
    "actor": "https://github.com/sagetrac-amhou",
    "created_at": "2010-03-21T17:05:04Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107934"
}
```



---

archive/issue_comments_068212.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThis patch touches matrix2.pyx which results in failures of a number of doctests.  Example:\n\n```\nsage -t  devel/sage/sage/matrix/matrix2.pyx\n**********************************************************************\nFile \"/mnt/usb1/scratch/boothby/sage-4.3.4/devel/sage-main/sage/matrix/matrix2.pyx\", line 3142:\n    sage: A.restrict(W2, check=True)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ArithmeticError: subspace is not invariant under matrix\nGot:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_48[10]>\", line 1, in <module>\n        A.restrict(W2, check=True)###line 3142:\n    sage: A.restrict(W2, check=True)\n      File \"matrix2.pyx\", line 3167, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:19470)\n        raise ArithmeticError, \"subspace is not invariant under matrix (%s)\"%msg\n    ArithmeticError: subspace is not invariant under matrix (vector is not in free module)\n**********************************************************************\n```\n\nThat should be easy to fix.",
    "created_at": "2010-03-28T20:25:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68212",
    "user": "https://github.com/boothby"
}
```

<div id="comment:7" align="right">comment:7</div>

This patch touches matrix2.pyx which results in failures of a number of doctests.  Example:

```
sage -t  devel/sage/sage/matrix/matrix2.pyx
**********************************************************************
File "/mnt/usb1/scratch/boothby/sage-4.3.4/devel/sage-main/sage/matrix/matrix2.pyx", line 3142:
    sage: A.restrict(W2, check=True)
Expected:
    Traceback (most recent call last):
    ...
    ArithmeticError: subspace is not invariant under matrix
Got:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/boothby/sage-4.3.4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_48[10]>", line 1, in <module>
        A.restrict(W2, check=True)###line 3142:
    sage: A.restrict(W2, check=True)
      File "matrix2.pyx", line 3167, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:19470)
        raise ArithmeticError, "subspace is not invariant under matrix (%s)"%msg
    ArithmeticError: subspace is not invariant under matrix (vector is not in free module)
**********************************************************************
```

That should be easy to fix.



---

archive/issue_comments_068213.json:
```json
{
    "body": "this completely replaces the previous patch",
    "created_at": "2010-03-28T21:47:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68213",
    "user": "https://github.com/williamstein"
}
```

this completely replaces the previous patch



---

archive/issue_comments_068214.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAttachment: **[trac-8547-take2.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac-8547-take2.patch.gz)**\n\nOk, doctests run clean now.  I've tested the code out and read it over, and it works for me.  I'm a little cautious giving this a positive review because I know very little about this area of math.  However, given that it's replacing something that barely worked and used memory like toilet paper, I'm willing to throw caution to the wind if mhampton or jason are willing to sign off on the idea.",
    "created_at": "2010-03-30T23:47:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68214",
    "user": "https://github.com/boothby"
}
```

<div id="comment:8" align="right">comment:8</div>

Attachment: **[trac-8547-take2.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac-8547-take2.patch.gz)**

Ok, doctests run clean now.  I've tested the code out and read it over, and it works for me.  I'm a little cautious giving this a positive review because I know very little about this area of math.  However, given that it's replacing something that barely worked and used memory like toilet paper, I'm willing to throw caution to the wind if mhampton or jason are willing to sign off on the idea.



---

archive/issue_comments_068215.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI've been wanting to review this but I just haven't had the time.  I might this weekend, but its unclear.",
    "created_at": "2010-03-31T03:06:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68215",
    "user": "https://github.com/sagetrac-mhampton"
}
```

<div id="comment:9" align="right">comment:9</div>

I've been wanting to review this but I just haven't had the time.  I might this weekend, but its unclear.



---

archive/issue_comments_068216.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSome notes from reading through the code looking at stylistic issues.\u00a0 I really wish we had line-by-line commenting like rietveld for this sort of thing.\n\n1. Lots of cdef'd functions do not have doctests.\u00a0 I thought the policy from discussions on sage-devel was that *every* function (including cdef functions) should have doctests (but, of course, these doctests would have to either indirectly test the cdef'd function or would have to test a wrapper of the cdef function).\u00a0 Some functions (_baum_welch_gamma, for example) don't even have docstrings.\n2. I'm curious why IntList.!__getitem!__ does not use the sage.misc.misc_c.normalize_index function to deal with slices.\u00a0 How much of a performance penalty is there?\u00a0 Can this \"python semantics\" part be extracted out to be a more general cdef'd counterpart to normalize_index, so that matrices, vectors, and other types can use it better to implement !__getitem!__?\u00a0 Also, as a future enhancement, it doesn't seem that much harder for !__setitem!__ to also support slices.\u00a0 At the very least, the doctests for normalize_index probably ought to be run on the !__getitem!__ function, as they exercise a number of corner cases for the python semantics.\n3. IntList.sum() does not have a doctest for the overflow case",
    "created_at": "2010-03-31T03:52:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68216",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:10" align="right">comment:10</div>

Some notes from reading through the code looking at stylistic issues.  I really wish we had line-by-line commenting like rietveld for this sort of thing.

1. Lots of cdef'd functions do not have doctests.  I thought the policy from discussions on sage-devel was that *every* function (including cdef functions) should have doctests (but, of course, these doctests would have to either indirectly test the cdef'd function or would have to test a wrapper of the cdef function).  Some functions (_baum_welch_gamma, for example) don't even have docstrings.
2. I'm curious why IntList.!__getitem!__ does not use the sage.misc.misc_c.normalize_index function to deal with slices.  How much of a performance penalty is there?  Can this "python semantics" part be extracted out to be a more general cdef'd counterpart to normalize_index, so that matrices, vectors, and other types can use it better to implement !__getitem!__?  Also, as a future enhancement, it doesn't seem that much harder for !__setitem!__ to also support slices.  At the very least, the doctests for normalize_index probably ought to be run on the !__getitem!__ function, as they exercise a number of corner cases for the python semantics.
3. IntList.sum() does not have a doctest for the overflow case



---

archive/issue_comments_068217.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jasongrout](#comment:10):\n> Some notes from reading through the code looking at stylistic issues.\u00a0 I really wish we had\n>  line-by-line commenting like rietveld for this sort of thing.\n> \n> 1. Lots of cdef'd functions do not have doctests.\u00a0 I thought the policy from discussions on sage-devel \n> was that *every* function (including cdef functions) should have doctests (but, of course, these doctests\n>  would have to either indirectly test the cdef'd function or would have to test a wrapper of the cdef function).\u00a0 \n\nWe definitely do not require doctests for cdef'd methods.   The requirement is that \"sage -coverage\" returns a score of 100%.  This is clearly stated in the patch reviewers guide.    I did seriously consider them in this case, but literally every single one of these doctests would just be a literal *exact* copy of a doctest from elsewhere (!) but with # indirect doctest next to it.  There's just no value in that.   I could also make the methods cpdef, but that does incur a performance penalty -- in this case, it would be huge (which is totally unacceptable). \n\n> Some functions (_baum_welch_gamma, for example) don't even have docstrings.\n\nI do think that all cdef'd methods should have docstrings, and will add docstrings to any that don't have them (in a part 2 patch). \n\n> 1. I'm curious why IntList.!__getitem!__ does not use the sage.misc.misc_c.normalize_index function to deal with slices.\u00a0 \n> How much of a performance penalty is there?\u00a0\n\nI'll switch to using normalize_index, since I'm not concerned with performance for list indexing, since everywhere that performance matters, I'm directly accessing the memory buffer (which is the only way to really compete with tightly coded C libraries).   So my updated patch will change to use normalize_index, unless there is a serious problem with doing so. \n\n>  Can this \"python semantics\" part be extracted out to be a more general \n> cdef'd counterpart to normalize_index, so that matrices, vectors, and other types can use it better to implement \n> !__getitem!__?\u00a0 \n\nPerhaps.  I'm certainly not doing so for this patch. \n\n> Also, as a future enhancement, it doesn't seem that much harder for !__setitem!__ to also \n> support slices.\u00a0 At the very least, the doctests for normalize_index probably ought to be \n> run on the !__getitem!__ function, as they exercise a number of corner cases for the python semantics.\n\nFortunately this won't be necessary since I'm switching to it. \n\n> 1. IntList.sum() does not have a doctest for the overflow case\n\nI can add that.   I like testing all corner cases.\n\nThanks for your helpful review of style...\n\n- William",
    "created_at": "2010-04-03T08:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68217",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jasongrout](#comment:10):
> Some notes from reading through the code looking at stylistic issues.  I really wish we had
>  line-by-line commenting like rietveld for this sort of thing.
> 
> 1. Lots of cdef'd functions do not have doctests.  I thought the policy from discussions on sage-devel 
> was that *every* function (including cdef functions) should have doctests (but, of course, these doctests
>  would have to either indirectly test the cdef'd function or would have to test a wrapper of the cdef function).  

We definitely do not require doctests for cdef'd methods.   The requirement is that "sage -coverage" returns a score of 100%.  This is clearly stated in the patch reviewers guide.    I did seriously consider them in this case, but literally every single one of these doctests would just be a literal *exact* copy of a doctest from elsewhere (!) but with # indirect doctest next to it.  There's just no value in that.   I could also make the methods cpdef, but that does incur a performance penalty -- in this case, it would be huge (which is totally unacceptable). 

> Some functions (_baum_welch_gamma, for example) don't even have docstrings.

I do think that all cdef'd methods should have docstrings, and will add docstrings to any that don't have them (in a part 2 patch). 

> 1. I'm curious why IntList.!__getitem!__ does not use the sage.misc.misc_c.normalize_index function to deal with slices.  
> How much of a performance penalty is there? 

I'll switch to using normalize_index, since I'm not concerned with performance for list indexing, since everywhere that performance matters, I'm directly accessing the memory buffer (which is the only way to really compete with tightly coded C libraries).   So my updated patch will change to use normalize_index, unless there is a serious problem with doing so. 

>  Can this "python semantics" part be extracted out to be a more general 
> cdef'd counterpart to normalize_index, so that matrices, vectors, and other types can use it better to implement 
> !__getitem!__?  

Perhaps.  I'm certainly not doing so for this patch. 

> Also, as a future enhancement, it doesn't seem that much harder for !__setitem!__ to also 
> support slices.  At the very least, the doctests for normalize_index probably ought to be 
> run on the !__getitem!__ function, as they exercise a number of corner cases for the python semantics.

Fortunately this won't be necessary since I'm switching to it. 

> 1. IntList.sum() does not have a doctest for the overflow case

I can add that.   I like testing all corner cases.

Thanks for your helpful review of style...

- William



---

archive/issue_comments_068218.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI got one numerical noise doctest failure on OS X 10.5.8:\n\nsage -t  devel/sage-t2/sage/stats/hmm/util.pyx\n**********************************************************************\nFile \"/Users/mh/sagestuff/sage-4.3.5/devel/sage-t2/sage/stats/hmm/util.pyx\", line 55:\n    sage: T.sum()\nExpected:\n    1.0                   \nGot:\n    0.99999999999999978\n\nI used this code in class yesterday (see http://wiki.sagemath.org/interact/stats#HiddenMarkovModel.3ATheOccasionallyDishonestCasino) and for that limited purpose it seemed fine.\n\nIt would be nice to have the forward and backward algorithms more exposed, but I don't think that needs to go into this ticket unless you feel like it.\n\nApart from the noise issue  I think can give this a positive review.",
    "created_at": "2010-04-03T14:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68218",
    "user": "https://github.com/sagetrac-mhampton"
}
```

<div id="comment:12" align="right">comment:12</div>

I got one numerical noise doctest failure on OS X 10.5.8:

sage -t  devel/sage-t2/sage/stats/hmm/util.pyx
**********************************************************************
File "/Users/mh/sagestuff/sage-4.3.5/devel/sage-t2/sage/stats/hmm/util.pyx", line 55:
    sage: T.sum()
Expected:
    1.0                   
Got:
    0.99999999999999978

I used this code in class yesterday (see http://wiki.sagemath.org/interact/stats#HiddenMarkovModel.3ATheOccasionallyDishonestCasino) and for that limited purpose it seemed fine.

It would be nice to have the forward and backward algorithms more exposed, but I don't think that needs to go into this ticket unless you feel like it.

Apart from the noise issue  I think can give this a positive review.



---

archive/issue_comments_068219.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\n* I've attached a part 2 patch.   I made sure all cdef's methods have docstrings and also that doctests are properly sphinx formated (some weren't since they were copied from the old code). \n\n* Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. \n \n* I read the source code for `sage.misc.misc_c.normalize_index` and cannot bring myself to use that in this situation.  That  function actually returns a Python *list* of Python ints for every single index into the list that is being sliced!  That would easily lead to factor of 50-100 slowdowns on realistic operations:\n\n```\nsage: timeit('z = sage.misc.misc_c.normalize_index(slice(1,10^5),10^5)')   # slow because constructions a big python list\n125 loops, best of 3: 2.17 ms per loop\nsage: a = stats.IntList([1..10^5])\nsage: timeit('a[1:10^5]')                       # slice is just a memcpy\n625 loops, best of 3: 48.4 \u00b5s per loop\nsage: 2.17/0.0484\n44.8347107438017\n```\nHere's an example with a step:\n\n```\nsage: a = stats.IntList([1..10^5])\nsage: timeit('a[1:10^5:2]')\n625 loops, best of 3: 92.2 \u00b5s per loop\nsage: timeit('z = sage.misc.misc_c.normalize_index(slice(1,10^5,2),10^5)')\n625 loops, best of 3: 772 \u00b5s per loop\n```\nand that 772 microseconds is *before* we do the actual iteration through the returned list of python ints, convert them to c ints, copy stuff around in memory, etc. \n\nThis stats code I'm writing is really meant to be industrial strength -- the sort of code maybe somebody would use in \"realtime\" processing of large datastreams.    I don't want slow functions anywhere in there. \n\n -- William",
    "created_at": "2010-04-08T21:47:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68219",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:13" align="right">comment:13</div>

* I've attached a part 2 patch.   I made sure all cdef's methods have docstrings and also that doctests are properly sphinx formated (some weren't since they were copied from the old code). 

* Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. 
 
* I read the source code for `sage.misc.misc_c.normalize_index` and cannot bring myself to use that in this situation.  That  function actually returns a Python *list* of Python ints for every single index into the list that is being sliced!  That would easily lead to factor of 50-100 slowdowns on realistic operations:

```
sage: timeit('z = sage.misc.misc_c.normalize_index(slice(1,10^5),10^5)')   # slow because constructions a big python list
125 loops, best of 3: 2.17 ms per loop
sage: a = stats.IntList([1..10^5])
sage: timeit('a[1:10^5]')                       # slice is just a memcpy
625 loops, best of 3: 48.4 µs per loop
sage: 2.17/0.0484
44.8347107438017
```
Here's an example with a step:

```
sage: a = stats.IntList([1..10^5])
sage: timeit('a[1:10^5:2]')
625 loops, best of 3: 92.2 µs per loop
sage: timeit('z = sage.misc.misc_c.normalize_index(slice(1,10^5,2),10^5)')
625 loops, best of 3: 772 µs per loop
```
and that 772 microseconds is *before* we do the actual iteration through the returned list of python ints, convert them to c ints, copy stuff around in memory, etc. 

This stats code I'm writing is really meant to be industrial strength -- the sort of code maybe somebody would use in "realtime" processing of large datastreams.    I don't want slow functions anywhere in there. 

 -- William



---

archive/issue_comments_068220.json:
```json
{
    "body": "part 2; apply this and the previous patch",
    "created_at": "2010-04-08T21:55:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68220",
    "user": "https://github.com/williamstein"
}
```

part 2; apply this and the previous patch



---

archive/issue_comments_068221.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nAttachment: **[trac_8547-take2-part2.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547-take2-part2.patch.gz)**\n\nReplying to [@williamstein](#comment:13):\n\n\n\n> * Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. \n\n\nI meant that the doctest looks like this:\n\n```\nNote that there can be overflow, since the entries are C ints:: \n    sage: a = stats.IntList([2^30,2^30]); a \n    [1073741824, 1073741824] \n\n```\n\nThat's it.  There's no test there; you're just creating a list, not summing anything.\n\n\n>  \n> * I read the source code for `sage.misc.misc_c.normalize_index` and cannot bring myself to use that in this situation.  That  function actually returns a Python *list* of Python ints for every single index into the list that is being sliced!  That would easily lead to factor of 50-100 slowdowns on realistic operations:\n\n> This stats code I'm writing is really meant to be industrial strength -- the sort of code maybe somebody would use in \"realtime\" processing of large datastreams.    I don't want slow functions anywhere in there. \n\n\nI agree.",
    "created_at": "2010-04-08T22:29:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68221",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:14" align="right">comment:14</div>

Attachment: **[trac_8547-take2-part2.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547-take2-part2.patch.gz)**

Replying to [@williamstein](#comment:13):



> * Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. 


I meant that the doctest looks like this:

```
Note that there can be overflow, since the entries are C ints:: 
    sage: a = stats.IntList([2^30,2^30]); a 
    [1073741824, 1073741824] 

```

That's it.  There's no test there; you're just creating a list, not summing anything.


>  
> * I read the source code for `sage.misc.misc_c.normalize_index` and cannot bring myself to use that in this situation.  That  function actually returns a Python *list* of Python ints for every single index into the list that is being sliced!  That would easily lead to factor of 50-100 slowdowns on realistic operations:

> This stats code I'm writing is really meant to be industrial strength -- the sort of code maybe somebody would use in "realtime" processing of large datastreams.    I don't want slow functions anywhere in there. 


I agree.



---

archive/issue_comments_068222.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jasongrout](#comment:14):\n> Replying to [@williamstein](#comment:13):\n> \n> \n> \n> > * Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. \n\n> \n> \n> I meant that the doctest looks like this:\n> \n> ```\n> Note that there can be overflow, since the entries are C ints:: \n>     sage: a = stats.IntList([2^30,2^30]); a \n>     [1073741824, 1073741824] \n> \n> ```\n> \n> That's it.  There's no test there; you're just creating a list, not summing anything.\n> \n\nThanks for the clarification -- I was being dense; I've put up a part 3 that addresses this. \n\nSo, can I get a positive review now?",
    "created_at": "2010-04-10T19:18:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68222",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jasongrout](#comment:14):
> Replying to [@williamstein](#comment:13):
> 
> 
> 
> > * Jason said above that IntList.sum doesn't have a doctest for the overflow case... but it does, so I don't know what he meant. 

> 
> 
> I meant that the doctest looks like this:
> 
> ```
> Note that there can be overflow, since the entries are C ints:: 
>     sage: a = stats.IntList([2^30,2^30]); a 
>     [1073741824, 1073741824] 
> 
> ```
> 
> That's it.  There's no test there; you're just creating a list, not summing anything.
> 

Thanks for the clarification -- I was being dense; I've put up a part 3 that addresses this. 

So, can I get a positive review now?



---

archive/issue_comments_068223.json:
```json
{
    "body": "Attachment: **[trac_8547-take2-part3.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547-take2-part3.patch.gz)**",
    "created_at": "2010-04-10T19:19:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68223",
    "user": "https://github.com/williamstein"
}
```

Attachment: **[trac_8547-take2-part3.patch.gz](https://github.com/sagemath/sage/files/ticket8547/trac_8547-take2-part3.patch.gz)**



---

archive/issue_comments_068224.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nOK, positive review.  I think this and basic_stats should be added to the reference manual, but that can be another ticket I guess.",
    "created_at": "2010-04-11T21:32:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68224",
    "user": "https://github.com/sagetrac-mhampton"
}
```

<div id="comment:16" align="right">comment:16</div>

OK, positive review.  I think this and basic_stats should be added to the reference manual, but that can be another ticket I guess.



---

archive/issue_events_107935.json:
```json
{
    "actor": "https://github.com/sagetrac-amhou",
    "created_at": "2010-04-11T21:32:11Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107935"
}
```



---

archive/issue_events_107936.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2010-04-11T21:32:11Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "subject": "https://github.com/sagetrac-mhampton",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107936"
}
```



---

archive/issue_events_107937.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2010-04-11T21:32:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107937"
}
```



---

archive/issue_events_107938.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2010-04-11T21:32:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107938"
}
```



---

archive/issue_comments_068225.json:
```json
{
    "body": "Author: **William Stein**",
    "created_at": "2010-04-16T18:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68225",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **William Stein**



---

archive/issue_comments_068226.json:
```json
{
    "body": "Reviewer: **Marshall Hampton, Tom Boothby, Jason Grout**",
    "created_at": "2010-04-16T18:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68226",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **Marshall Hampton, Tom Boothby, Jason Grout**



---

archive/issue_comments_068227.json:
```json
{
    "body": "Merged: **sage-4.4.alpha0**",
    "created_at": "2010-04-16T18:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68227",
    "user": "https://github.com/jhpalmieri"
}
```

Merged: **sage-4.4.alpha0**



---

archive/issue_comments_068228.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nMerged in 4.4.alpha0:\n- trac-8547-take2.patch\n- trac_8547-take2-part2.patch\n- trac_8547-take2-part3.patch",
    "created_at": "2010-04-16T18:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8547#issuecomment-68228",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Merged in 4.4.alpha0:
- trac-8547-take2.patch
- trac_8547-take2-part2.patch
- trac_8547-take2-part3.patch



---

archive/issue_events_107939.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-16T18:43:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107939"
}
```



---

archive/issue_events_107940.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-16T18:43:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/8547",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8547#event-107940"
}
```
