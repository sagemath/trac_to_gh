# Issue 8601: Bug in vector reduction

archive/issues_008601.json:
```json
{
    "assignees": [],
    "body": "From [sage-support](http://groups.google.com/group/sage-support/browse_thread/thread/f18b1f77ea5d529f):\n\n```\nOn Mar 24, 2010, at 10:35 AM, mb wrote:\n\nHi,\n\nThe following seems like strange behavior to me.\n\nIn [1]: V=VectorSpace(GF(2),2)\nIn [2]: V([1,3])\nOut[2]: (1, 1)\nIn [3]: V([1,-3])\nOut[3]: (1, 0)\n\nI would expect the last answer to be (1,1).\n```\n\nAssignee: **@williamstein**\n\nCC:  @rbeezer\n\nAuthor: **Jason Grout**\n\nReviewer: **Minh Van Nguyen**\n\nMerged: **sage-4.4.2.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/8601_\n\n",
    "closed_at": "2010-05-12T22:52:46Z",
    "created_at": "2010-03-24T17:47:43Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.4.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Bug in vector reduction",
    "type": "issue",
    "updated_at": "2010-05-12T22:52:46Z",
    "url": "https://github.com/sagemath/sage/issues/8601",
    "user": "https://github.com/robertwb"
}
```
From [sage-support](http://groups.google.com/group/sage-support/browse_thread/thread/f18b1f77ea5d529f):

```
On Mar 24, 2010, at 10:35 AM, mb wrote:

Hi,

The following seems like strange behavior to me.

In [1]: V=VectorSpace(GF(2),2)
In [2]: V([1,3])
Out[2]: (1, 1)
In [3]: V([1,-3])
Out[3]: (1, 0)

I would expect the last answer to be (1,1).
```

Assignee: **@williamstein**

CC:  @rbeezer

Author: **Jason Grout**

Reviewer: **Minh Van Nguyen**

Merged: **sage-4.4.2.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/8601_





---

archive/issue_events_095596.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-03-24T17:47:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "milestone_number": null,
    "milestone_title": "sage-4.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95596"
}
```



---

archive/issue_events_095597.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-03-24T17:47:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "component: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95597"
}
```



---

archive/issue_events_095598.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-03-24T17:47:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95598"
}
```



---

archive/issue_events_095599.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-03-24T17:47:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95599"
}
```



---

archive/issue_comments_070640.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+From [sage-support](http://groups.google.com/group/sage-support/browse_thread/thread/f18b1f77ea5d529f):\n \n ```\n On Mar 24, 2010, at 10:35 AM, mb wrote:\n``````\n",
    "created_at": "2010-03-24T17:52:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70640",
    "user": "https://github.com/sagetrac-mvngu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
+From [sage-support](http://groups.google.com/group/sage-support/browse_thread/thread/f18b1f77ea5d529f):
 
 ```
 On Mar 24, 2010, at 10:35 AM, mb wrote:
``````




---

archive/issue_comments_070641.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nNarrowing this down:\n\n```\nsage: V=GF(2)^2                                   \nsage: V.coordinate_vector([1,-3])\n(1, 0)\n```",
    "created_at": "2010-03-25T00:19:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70641",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'>Comment 2:</a>
Narrowing this down:

```
sage: V=GF(2)^2                                   
sage: V.coordinate_vector([1,-3])
(1, 0)
```



---

archive/issue_comments_070642.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nAs a workaround:\n\n```\nsage: vector(GF(2),[1,-3])                                                     \n(1, 1)\n```\n\nNote that the category seems autogenerated or something since I can't get the source:\n\n```\nsage: type(GF(2)^2)\n<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>\nsage: sage.modules.free_module.FreeModule_ambient_field_with_category??\nObject `sage.modules.free_module.FreeModule_ambient_field_with_category` not found.\n\n```",
    "created_at": "2010-03-25T00:34:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70642",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:3'>Comment 3:</a>
As a workaround:

```
sage: vector(GF(2),[1,-3])                                                     
(1, 1)
```

Note that the category seems autogenerated or something since I can't get the source:

```
sage: type(GF(2)^2)
<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>
sage: sage.modules.free_module.FreeModule_ambient_field_with_category??
Object `sage.modules.free_module.FreeModule_ambient_field_with_category` not found.

```



---

archive/issue_comments_070643.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIt seems to only affect GF(2), and only when you pass in negative numbers:\n\n```\nsage: (GF(2)^10)(range(-5,5))\n(0, 0, 0, 0, 0, 0, 1, 0, 1, 0)\nsage: (GF(3)^10)(range(-5,5))\n(1, 2, 0, 1, 2, 0, 1, 2, 0, 1)\n```",
    "created_at": "2010-03-25T00:38:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70643",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'>Comment 4:</a>
It seems to only affect GF(2), and only when you pass in negative numbers:

```
sage: (GF(2)^10)(range(-5,5))
(0, 0, 0, 0, 0, 0, 1, 0, 1, 0)
sage: (GF(3)^10)(range(-5,5))
(1, 2, 0, 1, 2, 0, 1, 2, 0, 1)
```



---

archive/issue_comments_070644.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nIf after line 150 of vector_mod2_dense.pyx, you put the line:\n\n```\nprint xi, type(xi), xi%2\n```\nyou see that the problem happens because in the Cython file, -1%2 is -1, not 1.  Apparently the C standard doesn't specify what happens if you mod with a negative number; some compilers return positive numbers, some return negative numbers.\n\nHere is a patch which fixes the issue.  I don't have time to formalize it and upload it right now.\n\n```\ndiff -r c04df7b7f023 sage/modules/vector_mod2_dense.pyx\n--- a/sage/modules/vector_mod2_dense.pyx\tThu Mar 18 01:56:14 2010 -0500\n+++ b/sage/modules/vector_mod2_dense.pyx\tWed Mar 24 20:12:27 2010 -0500\n@@ -137,6 +137,8 @@\n             (0, 0, 1)\n             sage: VS((0,0,GF(2)(1)))\n             (0, 0, 1)\n+            sage: VS((-1,-2,-3))\n+            (1, 0, 1)\n         \"\"\"\n         cdef Py_ssize_t i\n         cdef int xi\n@@ -146,7 +148,8 @@\n             for i from 0 <= i < self._degree:\n                 if PY_TYPE_CHECK(x[i],IntegerMod_int) or PY_TYPE_CHECK(x[i],int) or PY_TYPE_CHECK(x[i],Integer):\n                     xi = x[i]\n-                    mzd_write_bit(self._entries, 0, i, xi%2)\n+                    # the if/else statement is because some in some compilers, (-1)%2 is -1\n+                    mzd_write_bit(self._entries, 0, i, 0 if xi%2==0 else 1)\n                 else:\n                     mzd_write_bit(self._entries, 0, i, x[i]%2)\n             return\n```",
    "created_at": "2010-03-25T01:13:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70644",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:5'>Comment 5:</a>
If after line 150 of vector_mod2_dense.pyx, you put the line:

```
print xi, type(xi), xi%2
```
you see that the problem happens because in the Cython file, -1%2 is -1, not 1.  Apparently the C standard doesn't specify what happens if you mod with a negative number; some compilers return positive numbers, some return negative numbers.

Here is a patch which fixes the issue.  I don't have time to formalize it and upload it right now.

```
diff -r c04df7b7f023 sage/modules/vector_mod2_dense.pyx
--- a/sage/modules/vector_mod2_dense.pyx	Thu Mar 18 01:56:14 2010 -0500
+++ b/sage/modules/vector_mod2_dense.pyx	Wed Mar 24 20:12:27 2010 -0500
@@ -137,6 +137,8 @@
             (0, 0, 1)
             sage: VS((0,0,GF(2)(1)))
             (0, 0, 1)
+            sage: VS((-1,-2,-3))
+            (1, 0, 1)
         """
         cdef Py_ssize_t i
         cdef int xi
@@ -146,7 +148,8 @@
             for i from 0 <= i < self._degree:
                 if PY_TYPE_CHECK(x[i],IntegerMod_int) or PY_TYPE_CHECK(x[i],int) or PY_TYPE_CHECK(x[i],Integer):
                     xi = x[i]
-                    mzd_write_bit(self._entries, 0, i, xi%2)
+                    # the if/else statement is because some in some compilers, (-1)%2 is -1
+                    mzd_write_bit(self._entries, 0, i, 0 if xi%2==0 else 1)
                 else:
                     mzd_write_bit(self._entries, 0, i, x[i]%2)
             return
```



---

archive/issue_events_095600.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-03-25T01:13:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95600"
}
```



---

archive/issue_comments_070645.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nAttachment: **[trac-8601-vector-mod2-negative.patch.gz](https://github.com/sagemath/sage/files/ticket8601/trac-8601-vector-mod2-negative.patch.gz)**\n\nThis patch should be ready for review.  Doctests pass in the modules/*.pyx files.",
    "created_at": "2010-05-01T19:33:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70645",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:7'>Comment 7:</a>
Attachment: **[trac-8601-vector-mod2-negative.patch.gz](https://github.com/sagemath/sage/files/ticket8601/trac-8601-vector-mod2-negative.patch.gz)**

This patch should be ready for review.  Doctests pass in the modules/*.pyx files.



---

archive/issue_events_095601.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-05-01T19:33:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95601"
}
```



---

archive/issue_events_095602.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-05-01T19:33:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95602"
}
```



---

archive/issue_comments_070646.json:
```json
{
    "body": "Author: **Jason Grout**",
    "created_at": "2010-05-11T05:20:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70646",
    "user": "https://github.com/sagetrac-mvngu"
}
```

Author: **Jason Grout**



---

archive/issue_comments_070647.json:
```json
{
    "body": "Reviewer: **Minh Van Nguyen**",
    "created_at": "2010-05-11T05:20:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70647",
    "user": "https://github.com/sagetrac-mvngu"
}
```

Reviewer: **Minh Van Nguyen**



---

archive/issue_comments_070648.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nAttachment: **[trac_8601-reviewer.patch.gz](https://github.com/sagemath/sage/files/ticket8601/trac_8601-reviewer.patch.gz)**\n\nThe patch [trac-8601-vector-mod2-negative.patch](https://github.com/sagemath/sage/files/ticket8601/trac-8601-vector-mod2-negative.patch.gz) is OK by me. But I would prefer referencing the ticket number in a doctest. My reviewer patch does that and it also fixes a typo. Anyone but myself is welcome to give a final sign off on this ticket.",
    "created_at": "2010-05-11T05:20:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70648",
    "user": "https://github.com/sagetrac-mvngu"
}
```

<a id='comment:8'>Comment 8:</a>
Attachment: **[trac_8601-reviewer.patch.gz](https://github.com/sagemath/sage/files/ticket8601/trac_8601-reviewer.patch.gz)**

The patch [trac-8601-vector-mod2-negative.patch](https://github.com/sagemath/sage/files/ticket8601/trac-8601-vector-mod2-negative.patch.gz) is OK by me. But I would prefer referencing the ticket number in a doctest. My reviewer patch does that and it also fixes a typo. Anyone but myself is welcome to give a final sign off on this ticket.



---

archive/issue_events_095603.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-05-11T06:45:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95603"
}
```



---

archive/issue_events_095604.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-05-11T06:45:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95604"
}
```



---

archive/issue_comments_070649.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nYour changes look good to me (and pass doctests).",
    "created_at": "2010-05-11T06:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70649",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:9'>Comment 9:</a>
Your changes look good to me (and pass doctests).



---

archive/issue_events_095605.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-05-12T22:52:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95605"
}
```



---

archive/issue_events_095606.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-05-12T22:52:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8601#event-95606"
}
```



---

archive/issue_comments_070650.json:
```json
{
    "body": "Merged: **sage-4.4.2.rc0**",
    "created_at": "2010-05-12T22:52:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8601#issuecomment-70650",
    "user": "https://github.com/sagetrac-mvngu"
}
```

Merged: **sage-4.4.2.rc0**
