# Issue 8606: floats in exponent do not propagate

archive/issues_008606.json:
```json
{
    "body": "Consider the following (sage 4.3.3, since 4.3.4 does not compile\non my machine):\n\n```\nsage: 2.0^53\n9.00719925474099e15\n```\nThis is what we expect: the float `2.0` propagates to the whole\nexpression.\n\nHowever:\n\n```\nsage: 2^53.0\n9007199254740992\n```\nNote the result is an integer, not a float! Thus the information\nabout the inexact value has been lost. Same thing with\n`2^float(53)` and `2^RR(53)`.\n\n**Assignee:** @zimmermann6\n\n**CC:**  @jasongrout @aghitza @williamstein\n\n**Keywords:** float, RR\n\n**Author:** Paul Zimmermann\n\n**Reviewer:** Burcin Erocal\n\n**Merged:** sage-4.4.4.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/8606\n\n",
    "closed_at": "2010-06-06T08:28:15Z",
    "created_at": "2010-03-25T15:11:24Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.4.4",
    "title": "floats in exponent do not propagate",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8606",
    "user": "https://github.com/zimmermann6"
}
```
Consider the following (sage 4.3.3, since 4.3.4 does not compile
on my machine):

```
sage: 2.0^53
9.00719925474099e15
```
This is what we expect: the float `2.0` propagates to the whole
expression.

However:

```
sage: 2^53.0
9007199254740992
```
Note the result is an integer, not a float! Thus the information
about the inexact value has been lost. Same thing with
`2^float(53)` and `2^RR(53)`.

**Assignee:** @zimmermann6

**CC:**  @jasongrout @aghitza @williamstein

**Keywords:** float, RR

**Author:** Paul Zimmermann

**Reviewer:** Burcin Erocal

**Merged:** sage-4.4.4.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/8606





---

archive/issue_comments_072281.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe problem is in the function `__pow__` in sage/rings/integer.pyx.  There we find:\n\n```\n        try:\n            nn = PyNumber_Index(n)\n        except TypeError:\n            try:\n```\nI think PyNumber_Index(53.0) is the long \"53\".    Thus to change this as you wish, that code must be changed.",
    "created_at": "2010-03-29T05:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72281",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
The problem is in the function `__pow__` in sage/rings/integer.pyx.  There we find:

```
        try:
            nn = PyNumber_Index(n)
        except TypeError:
            try:
```
I think PyNumber_Index(53.0) is the long "53".    Thus to change this as you wish, that code must be changed.



---

archive/issue_comments_072282.json:
```json
{
    "body": "<a id='comment:3'></a>\nWilliam, in fact `nn = PyNumber_Index(n)` raises an error, thus we go to\n\n```\n            try:\n                nn = Integer(n)\n            except TypeError:\n                try:\n                    s = parent_c(n)(self)\n                    return s**n\n```\nwhere `nn = Integer(n)` succeeds for n=53.0, but fails for n=53.1:\n\n```\nsage: Integer(53.0)\n53\nsage: Integer(53.1)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/users/caramel/zimmerma/detached/<ipython console> in <module>()\n\n/usr/local/sage-core2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6449)()\n\n/usr/local/sage-core2/local/lib/python2.6/site-packages/sage/rings/real_mpfr.so in sage.rings.real_mpfr.RealNumber._integer_ (sage/rings/real_mpfr.c:11846)()\n\nTypeError: Attempt to coerce non-integral RealNumber to Integer\n```\nIf `Integer(53.0)` would return an error too, this would fix the problem. However we would\nthen need a specific method to coerce an integral real number to integer...\n\nOn a side note, `int` seems to behave differently:\n\n```\nsage: int(53.0)\n53\nsage: int(53.1)\n53\n```",
    "created_at": "2010-03-29T11:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72282",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:3'></a>
William, in fact `nn = PyNumber_Index(n)` raises an error, thus we go to

```
            try:
                nn = Integer(n)
            except TypeError:
                try:
                    s = parent_c(n)(self)
                    return s**n
```
where `nn = Integer(n)` succeeds for n=53.0, but fails for n=53.1:

```
sage: Integer(53.0)
53
sage: Integer(53.1)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/users/caramel/zimmerma/detached/<ipython console> in <module>()

/usr/local/sage-core2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6449)()

/usr/local/sage-core2/local/lib/python2.6/site-packages/sage/rings/real_mpfr.so in sage.rings.real_mpfr.RealNumber._integer_ (sage/rings/real_mpfr.c:11846)()

TypeError: Attempt to coerce non-integral RealNumber to Integer
```
If `Integer(53.0)` would return an error too, this would fix the problem. However we would
then need a specific method to coerce an integral real number to integer...

On a side note, `int` seems to behave differently:

```
sage: int(53.0)
53
sage: int(53.1)
53
```



---

archive/issue_comments_072283.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt seems like we should fix pow, rather than change Integer(53.0).  In pow, it seems like we shouldn't just try to blindly coerce to an integer, because that is where we are losing information that we don't want to lose.  Why do we have `nn = Integer(n)`?  The previous PyNumber_Index would take care of cases where we really had an integer power, right?  It seems like just deleting the Integer(n) try clause might be the right thing to do.",
    "created_at": "2010-03-29T12:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72283",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'></a>
It seems like we should fix pow, rather than change Integer(53.0).  In pow, it seems like we shouldn't just try to blindly coerce to an integer, because that is where we are losing information that we don't want to lose.  Why do we have `nn = Integer(n)`?  The previous PyNumber_Index would take care of cases where we really had an integer power, right?  It seems like just deleting the Integer(n) try clause might be the right thing to do.



---

archive/attachments_010744.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8606.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8606/trac_8606.patch",
    "created_at": "2010-03-29T13:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/zimmermann6"
}
```



---

archive/issue_comments_072284.json:
```json
{
    "body": "<a id='comment:5'></a>\nJason,\n> It seems like just deleting the Integer(n) try clause might be the right thing to do.\n\n\nthanks, that did the trick! I am attaching a patch to review.",
    "created_at": "2010-03-29T13:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72284",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:5'></a>
Jason,
> It seems like just deleting the Integer(n) try clause might be the right thing to do.


thanks, that did the trick! I am attaching a patch to review.



---

archive/issue_comments_072285.json:
```json
{
    "body": "**Changing assignee** from @aghitza to @zimmermann6.",
    "created_at": "2010-03-29T13:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72285",
    "user": "https://github.com/zimmermann6"
}
```

**Changing assignee** from @aghitza to @zimmermann6.



---

archive/issue_events_062722.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2010-03-29T13:13:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62722"
}
```



---

archive/issue_comments_072286.json:
```json
{
    "body": "**Author:** Paul Zimmermann",
    "created_at": "2010-03-29T13:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72286",
    "user": "https://github.com/zimmermann6"
}
```

**Author:** Paul Zimmermann



---

archive/issue_comments_072287.json:
```json
{
    "body": "<a id='comment:8'></a>\nJason, Alex, William, please can anyone of you review this patch? This should be easy. Thanks.\n\nPaul",
    "created_at": "2010-05-24T07:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72287",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:8'></a>
Jason, Alex, William, please can anyone of you review this patch? This should be easy. Thanks.

Paul



---

archive/issue_events_062723.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-24T14:25:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62723"
}
```



---

archive/issue_events_062724.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-24T14:25:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62724"
}
```



---

archive/issue_comments_072288.json:
```json
{
    "body": "**Reviewer:** Burcin Erocal",
    "created_at": "2010-05-24T14:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72288",
    "user": "https://github.com/burcin"
}
```

**Reviewer:** Burcin Erocal



---

archive/issue_comments_072289.json:
```json
{
    "body": "<a id='comment:9'></a>\nThe changes in attachment:trac_8606.patch look good to me and all the doctests pass. I'm ready to give this a positive review, but I have a minor comment first:\n\nShouldn't we also drop the try/except clause around `parent_c(n)(self)`? The error message returned by the `except` is not very helpful and I can't think of any test case to actually fall in that clause. Note that if the conversion `parent_c(n)(self)` fails, we get a `TypeError` not an `AttributeError`:\n\n```\nsage: 5^('a')\nTraceback (most recent call last):\n...\nTypeError: unsupported operand type(s) for ** or pow(): 'str' and 'str'\n```",
    "created_at": "2010-05-24T14:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72289",
    "user": "https://github.com/burcin"
}
```

<a id='comment:9'></a>
The changes in attachment:trac_8606.patch look good to me and all the doctests pass. I'm ready to give this a positive review, but I have a minor comment first:

Shouldn't we also drop the try/except clause around `parent_c(n)(self)`? The error message returned by the `except` is not very helpful and I can't think of any test case to actually fall in that clause. Note that if the conversion `parent_c(n)(self)` fails, we get a `TypeError` not an `AttributeError`:

```
sage: 5^('a')
Traceback (most recent call last):
...
TypeError: unsupported operand type(s) for ** or pow(): 'str' and 'str'
```



---

archive/issue_comments_072290.json:
```json
{
    "body": "apply only this patch (against 4.4.2)",
    "created_at": "2010-05-24T18:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72290",
    "user": "https://github.com/zimmermann6"
}
```

apply only this patch (against 4.4.2)



---

archive/issue_events_062725.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2010-05-24T18:47:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62725"
}
```



---

archive/issue_events_062726.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2010-05-24T18:47:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62726"
}
```



---

archive/attachments_010745.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8606_2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8606/trac_8606_2.patch",
    "created_at": "2010-05-24T18:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/zimmermann6"
}
```



---

archive/issue_comments_072291.json:
```json
{
    "body": "<a id='comment:10'></a>\nthank you Burcin for your review. I have attached a new patch following your proposal.\nHowever we still get the same (unhelpful) error message for `5^('a')`.\nAll doctests still pass.",
    "created_at": "2010-05-24T18:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72291",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:10'></a>
thank you Burcin for your review. I have attached a new patch following your proposal.
However we still get the same (unhelpful) error message for `5^('a')`.
All doctests still pass.



---

archive/issue_events_062727.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-26T10:54:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62727"
}
```



---

archive/issue_events_062728.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2010-05-26T10:54:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62728"
}
```



---

archive/issue_comments_072292.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [zimmerma](#comment%3A10):\n> thank you Burcin for your review. I have attached a new patch following your proposal.\n> However we still get the same (unhelpful) error message for `5^('a')`.\n> All doctests still pass.\n\n\nI was referring to the message `\"exponent (=%s) must be an integer.\\nCoerce your numbers to real or complex numbers first.\"` as unhelpful. You're right that the message `unsupported operand type(s) for ** or pow(): 'str' and 'str'` can be confusing as well. It just didn't occur to me since I was staring at the code and expected exactly that.\n\nWe could catch the `TypeError` and change the message to \"Cannot find a common domain to perform the operation. Please convert your arguments to the desired types explicitly.\" or something similar.\n\nI'm still changing this to positive review since the patch fixes a bug and a more meaningful error message is just an enhancement.",
    "created_at": "2010-05-26T10:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72292",
    "user": "https://github.com/burcin"
}
```

<a id='comment:11'></a>
Replying to [zimmerma](#comment%3A10):
> thank you Burcin for your review. I have attached a new patch following your proposal.
> However we still get the same (unhelpful) error message for `5^('a')`.
> All doctests still pass.


I was referring to the message `"exponent (=%s) must be an integer.\nCoerce your numbers to real or complex numbers first."` as unhelpful. You're right that the message `unsupported operand type(s) for ** or pow(): 'str' and 'str'` can be confusing as well. It just didn't occur to me since I was staring at the code and expected exactly that.

We could catch the `TypeError` and change the message to "Cannot find a common domain to perform the operation. Please convert your arguments to the desired types explicitly." or something similar.

I'm still changing this to positive review since the patch fixes a bug and a more meaningful error message is just an enhancement.



---

archive/issue_events_062729.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2010-06-06T08:28:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62729"
}
```



---

archive/issue_events_062730.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2010-06-06T08:28:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8606#event-62730"
}
```



---

archive/issue_comments_072293.json:
```json
{
    "body": "**Merged:** sage-4.4.4.alpha0",
    "created_at": "2010-06-06T08:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8606",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8606#issuecomment-72293",
    "user": "https://github.com/mwhansen"
}
```

**Merged:** sage-4.4.4.alpha0
