# Issue 8198: p-adic precision in vector multiplication

archive/issues_008198.json:
```json
{
    "body": "Trying to resolve #4656, I found the following unpleasant bug.\n\nthis looks good :\n\n```\nsage: R = Qp(5,5)\nsage: x = R(5).add_bigoh(1)\nsage: x\nO(5)\nsage: x*R(1)\nO(5)\n```\n\nBut when multiplied with the identity matrix the precision is lost\n\n```\nsage: I = matrix(R, [[1,0],[0,1]])\nsage: v = vector([R(1),x])\nsage: v\n(1 + O(5^5), O(5))\nsage: v*I\n(1 + O(5^5), 0)\nsage: v[0]*I[1,0] + v[1]*I[1,1]\nO(5)\n```\n\nThis causes things like\n\n```\nsage: M = matrix(R,[[1,2],[3,4]])\nsage: M*v\n(1 + O(5^5), 3 + O(5^5))\nsage: v[0]*M[0,0] + v[1]*M[0,1]\n1 + O(5)\nsage: v[0]*M[1,0] + v[1]*M[1,1]\n3 + O(5)\n```\n\nThis is an even worse example, which could be a different bug\n\n```\nsage: vv = vector(x)\nsage: vv\n(0)\nsage: vv[0]\n0\nsage: x\nO(5)\n```\n\nAssignee: @roed314\n\nCC:  @nilesjohnson jpflori\n\nKeywords: padics vector\n\nBranch/Commit: 41cbe4c6b418b2ed9e3e0175ddce0393cc21611e\n\nReviewer: Chris Wuthrich\n\nAuthor: Peter Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/8198\n\n",
    "closed_at": "2014-04-13T19:33:32Z",
    "created_at": "2010-02-05T22:52:30Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "p-adic precision in vector multiplication",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8198",
    "user": "https://github.com/categorie"
}
```
Trying to resolve #4656, I found the following unpleasant bug.

this looks good :

```
sage: R = Qp(5,5)
sage: x = R(5).add_bigoh(1)
sage: x
O(5)
sage: x*R(1)
O(5)
```

But when multiplied with the identity matrix the precision is lost

```
sage: I = matrix(R, [[1,0],[0,1]])
sage: v = vector([R(1),x])
sage: v
(1 + O(5^5), O(5))
sage: v*I
(1 + O(5^5), 0)
sage: v[0]*I[1,0] + v[1]*I[1,1]
O(5)
```

This causes things like

```
sage: M = matrix(R,[[1,2],[3,4]])
sage: M*v
(1 + O(5^5), 3 + O(5^5))
sage: v[0]*M[0,0] + v[1]*M[0,1]
1 + O(5)
sage: v[0]*M[1,0] + v[1]*M[1,1]
3 + O(5)
```

This is an even worse example, which could be a different bug

```
sage: vv = vector(x)
sage: vv
(0)
sage: vv[0]
0
sage: x
O(5)
```

Assignee: @roed314

CC:  @nilesjohnson jpflori

Keywords: padics vector

Branch/Commit: 41cbe4c6b418b2ed9e3e0175ddce0393cc21611e

Reviewer: Chris Wuthrich

Author: Peter Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/8198





---

archive/issue_comments_083209.json:
```json
{
    "body": "<a id='comment:1'></a>\nI must admit that I have not searched through the tracs to see if this is a duplicate. Sorry.\n\nResolving the bug would result in the resolution of #4656, too, I believe.",
    "created_at": "2010-02-05T22:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83209",
    "user": "https://github.com/categorie"
}
```

<a id='comment:1'></a>
I must admit that I have not searched through the tracs to see if this is a duplicate. Sorry.

Resolving the bug would result in the resolution of #4656, too, I believe.



---

archive/issue_comments_083210.json:
```json
{
    "body": "<a id='comment:2'></a>\nI found this bug also, while working on #9457.  After a fair bit of struggling with elliptic curve code, I now think this is a significant part of the problem.\n\nI noticed the following also; I can't tell if it's the same bug or not.\n\n```\nsage: R = QQ.completion(5,5)\nsage: P.<T> = R[]\nsage: Q.<T> = R[[]]\nsage: P(R(0).add_bigoh(-1))\n(O(5^-1))\nsage: Q(R(0).add_bigoh(-1))\n0\nsage: P(R(0).add_bigoh(2))\n(O(5^2))\nsage: Q(R(0).add_bigoh(2))\n0\nsage: Q(R(1).add_bigoh(2))\n1 + O(5^2)\nsage: Q(R(1).add_bigoh(-1))\n0\nsage: Q(R(1/25).add_bigoh(-1))\n5^-2 + O(5^-1)\n```",
    "created_at": "2010-08-03T23:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83210",
    "user": "https://github.com/nilesjohnson"
}
```

<a id='comment:2'></a>
I found this bug also, while working on #9457.  After a fair bit of struggling with elliptic curve code, I now think this is a significant part of the problem.

I noticed the following also; I can't tell if it's the same bug or not.

```
sage: R = QQ.completion(5,5)
sage: P.<T> = R[]
sage: Q.<T> = R[[]]
sage: P(R(0).add_bigoh(-1))
(O(5^-1))
sage: Q(R(0).add_bigoh(-1))
0
sage: P(R(0).add_bigoh(2))
(O(5^2))
sage: Q(R(0).add_bigoh(2))
0
sage: Q(R(1).add_bigoh(2))
1 + O(5^2)
sage: Q(R(1).add_bigoh(-1))
0
sage: Q(R(1/25).add_bigoh(-1))
5^-2 + O(5^-1)
```



---

archive/issue_comments_083211.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [niles](#comment%3A2):\n> I noticed the following also; I can't tell if it's the same bug or not.\n\n\noh, this seems to be the same as #4656",
    "created_at": "2010-08-03T23:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83211",
    "user": "https://github.com/nilesjohnson"
}
```

<a id='comment:3'></a>
Replying to [niles](#comment%3A2):
> I noticed the following also; I can't tell if it's the same bug or not.


oh, this seems to be the same as #4656



---

archive/issue_comments_083212.json:
```json
{
    "body": "<a id='comment:4'></a>\nI narrowed down the last issue above. (vector calls Sequence which calls list):\n\n```\nsage: R = Qp(5,5)\nsage: x = R(5).add_bigoh(1)\nsage: list(x)\n[0]\n```\n\nagain the element is set to zero. The problem here is different than the original case. In fact list(x) should raise an error, just like list(0) does. \n\n```\nsage: list([x,x]) \n[O(5), O(5)]\n```\n\nworks correctly. So this is really about matrix multiplication.",
    "created_at": "2011-01-27T11:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83212",
    "user": "https://github.com/categorie"
}
```

<a id='comment:4'></a>
I narrowed down the last issue above. (vector calls Sequence which calls list):

```
sage: R = Qp(5,5)
sage: x = R(5).add_bigoh(1)
sage: list(x)
[0]
```

again the element is set to zero. The problem here is different than the original case. In fact list(x) should raise an error, just like list(0) does. 

```
sage: list([x,x]) 
[O(5), O(5)]
```

works correctly. So this is really about matrix multiplication.



---

archive/issue_events_032007.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8198#event-32007"
}
```



---

archive/issue_events_032008.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8198#event-32008"
}
```



---

archive/issue_events_032009.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8198#event-32009"
}
```



---

archive/issue_comments_083213.json:
```json
{
    "body": "<a id='comment:7'></a>\nNote the very last bug, is not longer a problem in 6.1 as `vv = vector(x)`\nraises the error\n `TypeError: this local element is not iterable`\nand that should be ok.",
    "created_at": "2014-02-02T15:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83213",
    "user": "https://github.com/categorie"
}
```

<a id='comment:7'></a>
Note the very last bug, is not longer a problem in 6.1 as `vv = vector(x)`
raises the error
 `TypeError: this local element is not iterable`
and that should be ok.



---

archive/issue_comments_083214.json:
```json
{
    "body": "<a id='comment:8'></a>\nI don't even understand where vector * matrix multiplication is implemented...",
    "created_at": "2014-02-02T15:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83214",
    "user": "https://github.com/categorie"
}
```

<a id='comment:8'></a>
I don't even understand where vector * matrix multiplication is implemented...



---

archive/issue_comments_083215.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [wuthrich](#comment%3A8):\n> I don't even understand where vector * matrix multiplication is implemented...\n\nIn `sage/matrix/matrix0.pyx` (I discovered this when working on #804).  It tries to be too smart for its own good and skips entries of the vector that are equal to 0...  I made a patch and am now testing it.",
    "created_at": "2014-04-11T01:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83215",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>
Replying to [wuthrich](#comment%3A8):
> I don't even understand where vector * matrix multiplication is implemented...

In `sage/matrix/matrix0.pyx` (I discovered this when working on #804).  It tries to be too smart for its own good and skips entries of the vector that are equal to 0...  I made a patch and am now testing it.



---

archive/issue_comments_083216.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-11T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83216",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_083217.json:
```json
{
    "body": "Changing author from \"\" to \"Peter Bruin\"",
    "created_at": "2014-04-11T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83217",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "" to "Peter Bruin"



---

archive/issue_comments_083218.json:
```json
{
    "body": "Changing commit from \"\" to \"41cbe4c6b418b2ed9e3e0175ddce0393cc21611e\"",
    "created_at": "2014-04-11T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83218",
    "user": "https://github.com/pjbruin"
}
```

Changing commit from "" to "41cbe4c6b418b2ed9e3e0175ddce0393cc21611e"



---

archive/issue_comments_083219.json:
```json
{
    "body": "Changing branch from \"\" to \"u/pbruin/ticket/8198-matrix_vector_multiplication\"",
    "created_at": "2014-04-11T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83219",
    "user": "https://github.com/pjbruin"
}
```

Changing branch from "" to "u/pbruin/ticket/8198-matrix_vector_multiplication"



---

archive/issue_comments_083220.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-11T16:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83220",
    "user": "https://github.com/categorie"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_083221.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Chris Wuthrich\"",
    "created_at": "2014-04-11T16:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83221",
    "user": "https://github.com/categorie"
}
```

Changing reviewer from "" to "Chris Wuthrich"



---

archive/issue_comments_083222.json:
```json
{
    "body": "<a id='comment:12'></a>\nGood. All tests pass.\n\nI was not certain about the changes as I am not completely fluent in cython. Having read documentations, I think they make sense. I tested the speed in a few very limited cases and it does not seem to me that the new code is slower or faster (except of course when the field is Qp). \n\nThanks for the help.",
    "created_at": "2014-04-11T16:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83222",
    "user": "https://github.com/categorie"
}
```

<a id='comment:12'></a>
Good. All tests pass.

I was not certain about the changes as I am not completely fluent in cython. Having read documentations, I think they make sense. I tested the speed in a few very limited cases and it does not seem to me that the new code is slower or faster (except of course when the field is Qp). 

Thanks for the help.



---

archive/issue_comments_083223.json:
```json
{
    "body": "<a id='comment:13'></a>\nThanks; hopefully this goes some way towards being able to fix the related tickets #4656, #5075 and #9457...",
    "created_at": "2014-04-11T17:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83223",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
Thanks; hopefully this goes some way towards being able to fix the related tickets #4656, #5075 and #9457...



---

archive/issue_comments_083224.json:
```json
{
    "body": "Changing branch from \"u/pbruin/ticket/8198-matrix_vector_multiplication\" to \"41cbe4c6b418b2ed9e3e0175ddce0393cc21611e\"",
    "created_at": "2014-04-13T19:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83224",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/pbruin/ticket/8198-matrix_vector_multiplication" to "41cbe4c6b418b2ed9e3e0175ddce0393cc21611e"



---

archive/issue_comments_083225.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-13T19:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8198#issuecomment-83225",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_032010.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-13T19:33:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8198",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8198#event-32010"
}
```
