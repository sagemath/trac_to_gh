# Issue 8541: Cyclotomic matrix multiplication bug

archive/issues_008541.json:
```json
{
    "body": "Multiplying matrices over cyclotomic fields sometimes returns wrong answers:\n\n```\nsage: K.<zeta4> = CyclotomicField(4)\nsage: m = matrix(K, [186])\nsage: n = matrix(K, [125])\nsage: m * n\n[-23087]\n```\n\nSimilar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.\n\n(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: \n\n```\nsage: f = CuspForms(DirichletGroup(5).0,5).0\nsage: f[15] # Boom!\nArithmeticError: subspace is not invariant under matrix (vector is not in free module)\n``` \n)\n\n\nAssignee: jason, was\n\nResolution: fixed\n\nAuthor: David Loeffler\n\nReviewer: William Stein\n\nMerged: sage-4.4.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/8541\n\n",
    "closed_at": "2010-04-16T18:42:12Z",
    "created_at": "2010-03-15T05:20:37Z",
    "labels": [
        "component: linear algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.4",
    "title": "Cyclotomic matrix multiplication bug",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8541",
    "user": "https://github.com/williamstein"
}
```
Multiplying matrices over cyclotomic fields sometimes returns wrong answers:

```
sage: K.<zeta4> = CyclotomicField(4)
sage: m = matrix(K, [186])
sage: n = matrix(K, [125])
sage: m * n
[-23087]
```

Similar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.

(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: 

```
sage: f = CuspForms(DirichletGroup(5).0,5).0
sage: f[15] # Boom!
ArithmeticError: subspace is not invariant under matrix (vector is not in free module)
``` 
)


Assignee: jason, was

Resolution: fixed

Author: David Loeffler

Reviewer: William Stein

Merged: sage-4.4.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/8541





---

archive/issue_comments_080021.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,12 +1,12 @@\n ```\n-sage: CuspForms(DirichletGroup(5).0,5).0\n+sage: f = CuspForms(DirichletGroup(5).0,5).0\n sage: f[15]\n Boom!\n+\n+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)\n ``` \n \n This was reported by Paul Nelson, a grad student at Caltech.\n-\n-Assignee: @craigcitro\n \n Comment: 1\n \n```\n",
    "created_at": "2010-03-27T06:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80021",
    "user": "https://github.com/williamstein"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,12 +1,12 @@
 ```
-sage: CuspForms(DirichletGroup(5).0,5).0
+sage: f = CuspForms(DirichletGroup(5).0,5).0
 sage: f[15]
 Boom!
+
+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)
 ``` 
 
 This was reported by Paul Nelson, a grad student at Caltech.
-
-Assignee: @craigcitro
 
 Comment: 1
 
```




---

archive/issue_comments_080022.json:
```json
{
    "body": "Changing assignee from @craigcitro to jason, was.",
    "created_at": "2010-04-08T18:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80022",
    "user": "https://github.com/loefflerd"
}
```

Changing assignee from @craigcitro to jason, was.



---

archive/issue_comments_080023.json:
```json
{
    "body": "<a id='comment:2'></a>The problem is in the multimodular algorithm that's used for computing matrix multiplication over cyclotomic fields:\n\n```\nsage: K.<zeta4> = CyclotomicField(4)\nsage: m = matrix(K, 1, 1, [186])\nsage: n = matrix(K, 1, 2, [1, -6/125*zeta4 - 117/125])\nsage: m * n\n[                 -23087/125 -1116/125*zeta4 - 21762/125]\n```\n\nAccording to the output of verbose, it works modulo a single prime (split in K), in this case 46337; and the result is indeed correct modulo this prime. But that's not enough, clearly. I'm very suspicious about the method `sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense.height()`. It returns the maximum absolute value of any entry (in any complex embedding), so n has height 1. Shouldn't it return the maximum absolute value of the numerator or denominator of any element, as with the corresponding method for dense rational matrices? (What does this even mean when K doesn't have class number 1?)",
    "created_at": "2010-04-08T18:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80023",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:2'></a>The problem is in the multimodular algorithm that's used for computing matrix multiplication over cyclotomic fields:

```
sage: K.<zeta4> = CyclotomicField(4)
sage: m = matrix(K, 1, 1, [186])
sage: n = matrix(K, 1, 2, [1, -6/125*zeta4 - 117/125])
sage: m * n
[                 -23087/125 -1116/125*zeta4 - 21762/125]
```

According to the output of verbose, it works modulo a single prime (split in K), in this case 46337; and the result is indeed correct modulo this prime. But that's not enough, clearly. I'm very suspicious about the method `sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense.height()`. It returns the maximum absolute value of any entry (in any complex embedding), so n has height 1. Shouldn't it return the maximum absolute value of the numerator or denominator of any element, as with the corresponding method for dense rational matrices? (What does this even mean when K doesn't have class number 1?)



---

archive/issue_comments_080024.json:
```json
{
    "body": "Changing component from modular forms to linear algebra.",
    "created_at": "2010-04-08T18:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80024",
    "user": "https://github.com/loefflerd"
}
```

Changing component from modular forms to linear algebra.



---

archive/issue_comments_080025.json:
```json
{
    "body": "<a id='comment:3'></a>Hold it, my suspicion was wrong: the height method only gets called after clearing denominators, and the problem is still there if we use the integral matrix `n = matrix(K, [125, -6*zeta4 - 117])`. So maybe the problem is here:\n\n```\n        # conservative but correct estimate\n        bound = A.height() * B.height() * self._ncols\n```\nPerhaps this estimate is wrong in this degenerate case?",
    "created_at": "2010-04-08T18:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80025",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:3'></a>Hold it, my suspicion was wrong: the height method only gets called after clearing denominators, and the problem is still there if we use the integral matrix `n = matrix(K, [125, -6*zeta4 - 117])`. So maybe the problem is here:

```
        # conservative but correct estimate
        bound = A.height() * B.height() * self._ncols
```
Perhaps this estimate is wrong in this degenerate case?



---

archive/issue_comments_080026.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2010-04-09T11:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80026",
    "user": "https://github.com/loefflerd"
}
```

Changing priority from major to critical.



---

archive/issue_comments_080027.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+Multiplying matrices over cyclotomic fields sometimes returns wrong answers:\n+\n+```\n+sage: sage: K.<zeta4> = CyclotomicField(4)\n+sage: sage: m = matrix(K, [186])\n+sage: sage: n = matrix(K, [125])\n+sage: m * n\n+[-23087]\n+```\n+\n+Similar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.\n+\n+(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: \n+\n+```\n+sage: f = CuspForms(DirichletGroup(5).0,5).0\n+sage: f[15] # Boom!\n+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)\n+``` \n+)\n \n \n Comment: 1\n```\n",
    "created_at": "2010-04-09T11:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80027",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+Multiplying matrices over cyclotomic fields sometimes returns wrong answers:
+
+```
+sage: sage: K.<zeta4> = CyclotomicField(4)
+sage: sage: m = matrix(K, [186])
+sage: sage: n = matrix(K, [125])
+sage: m * n
+[-23087]
+```
+
+Similar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.
+
+(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: 
+
+```
+sage: f = CuspForms(DirichletGroup(5).0,5).0
+sage: f[15] # Boom!
+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)
+``` 
+)
 
 
 Comment: 1
```




---

archive/issue_comments_080028.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+Multiplying matrices over cyclotomic fields sometimes returns wrong answers:\n+\n+```\n+sage: K.<zeta4> = CyclotomicField(4)\n+sage: m = matrix(K, [186])\n+sage: n = matrix(K, [125])\n+sage: m * n\n+[-23087]\n+```\n+\n+Similar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.\n+\n+(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: \n+\n+```\n+sage: f = CuspForms(DirichletGroup(5).0,5).0\n+sage: f[15] # Boom!\n+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)\n+``` \n+)\n \n \n Comment: 1\n```\n",
    "created_at": "2010-04-09T21:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80028",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+Multiplying matrices over cyclotomic fields sometimes returns wrong answers:
+
+```
+sage: K.<zeta4> = CyclotomicField(4)
+sage: m = matrix(K, [186])
+sage: n = matrix(K, [125])
+sage: m * n
+[-23087]
+```
+
+Similar errors occur with other cyclotomic fields. Experiments with random 1 x 1 matrices with integer entries up to 10<sup>5</sup>, coerced into the cyclotomic field of order 4, suggest that the answer is wrong about 15-20% of the time. The problem also occurs (less often) for certain examples of multiplying a 2x2 matrix by a 2x2 matrix, and I also found an error in one case of a 1 x 3 multiplied by a 3 x 1.
+
+(This bug first manifested itself in the modular forms code, as was reported by Paul Nelson, a grad student at Caltech: 
+
+```
+sage: f = CuspForms(DirichletGroup(5).0,5).0
+sage: f[15] # Boom!
+ArithmeticError: subspace is not invariant under matrix (vector is not in free module)
+``` 
+)
 
 
 Comment: 1
```




---

archive/issue_comments_080029.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2010-04-09T21:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80029",
    "user": "https://github.com/loefflerd"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_080030.json:
```json
{
    "body": "<a id='comment:6'></a>This seems to be a duplicate of #8666, which already has a positive review.",
    "created_at": "2010-04-11T12:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80030",
    "user": "https://github.com/burcin"
}
```

<a id='comment:6'></a>This seems to be a duplicate of #8666, which already has a positive review.



---

archive/issue_comments_080031.json:
```json
{
    "body": "Changing priority from blocker to minor.",
    "created_at": "2010-04-11T20:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80031",
    "user": "https://github.com/loefflerd"
}
```

Changing priority from blocker to minor.



---

archive/issue_comments_080032.json:
```json
{
    "body": "<a id='comment:7'></a>Arguably, the correct statement is that #8666 is a duplicate of this :-).\n\nJust to be safe, it might be worth adding a doctest to the modular forms code to show that the computation that triggered the problem in the original bug report does now work -- I will write a mini-patch tomorrow morning. When that is reviewed and merged then we can close this ticket, but in any case the ticket \"priority\" flag can safely be reduced.",
    "created_at": "2010-04-11T20:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80032",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:7'></a>Arguably, the correct statement is that #8666 is a duplicate of this :-).

Just to be safe, it might be worth adding a doctest to the modular forms code to show that the computation that triggered the problem in the original bug report does now work -- I will write a mini-patch tomorrow morning. When that is reviewed and merged then we can close this ticket, but in any case the ticket "priority" flag can safely be reduced.



---

archive/issue_comments_080033.json:
```json
{
    "body": "apply after #8666",
    "created_at": "2010-04-12T13:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80033",
    "user": "https://github.com/loefflerd"
}
```

apply after #8666



---

archive/issue_comments_080034.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_8541.patch](tarball://root/attachments/some-uuid/ticket8541/trac_8541.patch) by @loefflerd created at 2010-04-12 13:57:32\n\nAs promised, here's a doctest.",
    "created_at": "2010-04-12T13:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80034",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:8'></a>Attachment [trac_8541.patch](tarball://root/attachments/some-uuid/ticket8541/trac_8541.patch) by @loefflerd created at 2010-04-12 13:57:32

As promised, here's a doctest.



---

archive/issue_comments_080035.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-04-12T13:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80035",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_080036.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-04-14T23:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80036",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_020583.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-16T18:42:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8541#event-20583"
}
```



---

archive/issue_comments_080037.json:
```json
{
    "body": "<a id='comment:10'></a>Merged \"trac_8541.patch\" in 4.4.alpha0.",
    "created_at": "2010-04-16T18:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80037",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Merged "trac_8541.patch" in 4.4.alpha0.



---

archive/issue_comments_080038.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-04-16T18:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8541#issuecomment-80038",
    "user": "https://github.com/jhpalmieri"
}
```

Resolution: fixed
