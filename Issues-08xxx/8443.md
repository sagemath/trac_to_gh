# Issue 8443: Active cell jumps to end of worksheet when evaluating a cell

archive/issues_008443.json:
```json
{
    "body": "The problem seems to be duplicate cell IDs.  The function `Worksheet.edit_save` parses a worksheet's text into a list of cells.  If the worksheet ends with a text cell, the function appends a compute cell.  But the existing code does not update the cell counter, which is the ID of the next new cell, **before** it appends the cell.  The appended cell's ID could match an existing ID.  If two cells have the same ID, the browser can jump to the second one, at the end of the worksheet, after you evaluate the predecessor of the first.\n\nSee [sage-notebook](http://groups.google.com/group/sage-notebook/browse_thread/thread/f28cd98f3623316c).\n\n**Assignee:** @williamstein\n\n**CC:**  @dandrake mhampton\n\n**Resolution:** fixed\n\n**Author:** Mitesh Patel, Dan Drake\n\n**Reviewer:** Dan Drake, Mitesh Patel\n\n**Merged:** sagenb-0.7.5.3\n\nIssue created by migration from https://trac.sagemath.org/ticket/8443\n\n",
    "closed_at": "2010-03-09T04:59:10Z",
    "created_at": "2010-03-05T12:02:34Z",
    "labels": [
        "component: notebook",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.3.4",
    "title": "Active cell jumps to end of worksheet when evaluating a cell",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8443",
    "user": "https://github.com/qed777"
}
```
The problem seems to be duplicate cell IDs.  The function `Worksheet.edit_save` parses a worksheet's text into a list of cells.  If the worksheet ends with a text cell, the function appends a compute cell.  But the existing code does not update the cell counter, which is the ID of the next new cell, **before** it appends the cell.  The appended cell's ID could match an existing ID.  If two cells have the same ID, the browser can jump to the second one, at the end of the worksheet, after you evaluate the predecessor of the first.

See [sage-notebook](http://groups.google.com/group/sage-notebook/browse_thread/thread/f28cd98f3623316c).

**Assignee:** @williamstein

**CC:**  @dandrake mhampton

**Resolution:** fixed

**Author:** Mitesh Patel, Dan Drake

**Reviewer:** Dan Drake, Mitesh Patel

**Merged:** sagenb-0.7.5.3

Issue created by migration from https://trac.sagemath.org/ticket/8443





---

archive/attachments_010519.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8443-cell_focus_jump.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8443/trac_8443-cell_focus_jump.patch",
    "created_at": "2010-03-05T12:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/qed777"
}
```



---

archive/issue_comments_095819.json:
```json
{
    "body": "Avoid possible duplicate cell IDs during an `edit_save` operation.  sagenb repo.",
    "created_at": "2010-03-05T12:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95819",
    "user": "https://github.com/qed777"
}
```

Avoid possible duplicate cell IDs during an `edit_save` operation.  sagenb repo.



---

archive/issue_comments_095820.json:
```json
{
    "body": "<a id='comment:1'></a>\nNote: Evaluating the last compute cell in a worksheet whose last cell is a *text cell* does not result in a new compute cell appended to the end of the sheet.  This is a separate problem that I fixed at #7908, which I'm planning to rebase soon.",
    "created_at": "2010-03-05T12:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95820",
    "user": "https://github.com/qed777"
}
```

<a id='comment:1'></a>
Note: Evaluating the last compute cell in a worksheet whose last cell is a *text cell* does not result in a new compute cell appended to the end of the sheet.  This is a separate problem that I fixed at #7908, which I'm planning to rebase soon.



---

archive/issue_comments_095821.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-03-05T12:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95821",
    "user": "https://github.com/qed777"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_095822.json:
```json
{
    "body": "**Author:** Mitesh Patel",
    "created_at": "2010-03-05T12:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95822",
    "user": "https://github.com/qed777"
}
```

**Author:** Mitesh Patel



---

archive/issue_comments_095823.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2010-03-06T08:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95823",
    "user": "https://github.com/dandrake"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_095824.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis patch looks good. It fixes the problem for me with the worksheet I attached in that sage-notebook thread. I think it could use a doctest, though. Here's my idea:\n\n```\nsage: nb = sagenb.notebook.notebook.Notebook(tmp_dir()+'.sagenb')\nsage: nb.add_user('sage','sage','sage@sagemath.org',force=True)\nsage: W = nb.create_new_worksheet('Test trac #8443', 'sage')\nsage: W.edit_save(\"{{{\\n1+1\\n///\\n}}}\\n\\n<p>a text cell</p>\")\nsage: len(set(W.cell_id_list())) == 3\nTrue\n```\n\nThe idea is that if a duplicate cell id gets added, making a set out of the id list will be shorter than the plain id list. Does this seem like a reasonable test that will prevent a regression on this issue?",
    "created_at": "2010-03-06T08:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95824",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:2'></a>
This patch looks good. It fixes the problem for me with the worksheet I attached in that sage-notebook thread. I think it could use a doctest, though. Here's my idea:

```
sage: nb = sagenb.notebook.notebook.Notebook(tmp_dir()+'.sagenb')
sage: nb.add_user('sage','sage','sage@sagemath.org',force=True)
sage: W = nb.create_new_worksheet('Test trac #8443', 'sage')
sage: W.edit_save("{{{\n1+1\n///\n}}}\n\n<p>a text cell</p>")
sage: len(set(W.cell_id_list())) == 3
True
```

The idea is that if a duplicate cell id gets added, making a set out of the id list will be shorter than the plain id list. Does this seem like a reasonable test that will prevent a regression on this issue?



---

archive/issue_comments_095825.json:
```json
{
    "body": "**Reviewer:** Dan Drake, Mitesh Patel",
    "created_at": "2010-03-06T13:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95825",
    "user": "https://github.com/qed777"
}
```

**Reviewer:** Dan Drake, Mitesh Patel



---

archive/issue_comments_095826.json:
```json
{
    "body": "<a id='comment:3'></a>\nYes, definitely.  I should have written a test.  I've tweaked your example a bit, since it also passes without the patch.  Please see V2.\n\n**Without** the patch, I get\n\n```python\nsage: nb = sagenb.notebook.notebook.Notebook(tmp_dir() + '.sagenb')\nsage: nb.add_user('sage', 'sage', 'sage@sagemath.org', force=True)\nsage: W = nb.create_new_worksheet('Test trac #8443', 'sage')\nsage: W.edit_save('{{{\\n1+1\\n///\\n}}}')\nsage: W.cell_id_list()\n[0]\nsage: W.next_id()\n1\nsage: W.edit_save(\"{{{\\n1+1\\n///\\n}}}\\n\\n<p>a text cell</p>\")\nsage: len(set(W.cell_id_list())) == 3    # oops!\nFalse\nsage: W.cell_id_list()                   # oops!\n[0, 1, 1]\nsage: W.next_id()                        # oops!\n2\n```\nAs far as it goes, my review of the test is positive.",
    "created_at": "2010-03-06T13:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95826",
    "user": "https://github.com/qed777"
}
```

<a id='comment:3'></a>
Yes, definitely.  I should have written a test.  I've tweaked your example a bit, since it also passes without the patch.  Please see V2.

**Without** the patch, I get

```python
sage: nb = sagenb.notebook.notebook.Notebook(tmp_dir() + '.sagenb')
sage: nb.add_user('sage', 'sage', 'sage@sagemath.org', force=True)
sage: W = nb.create_new_worksheet('Test trac #8443', 'sage')
sage: W.edit_save('{{{\n1+1\n///\n}}}')
sage: W.cell_id_list()
[0]
sage: W.next_id()
1
sage: W.edit_save("{{{\n1+1\n///\n}}}\n\n<p>a text cell</p>")
sage: len(set(W.cell_id_list())) == 3    # oops!
False
sage: W.cell_id_list()                   # oops!
[0, 1, 1]
sage: W.next_id()                        # oops!
2
```
As far as it goes, my review of the test is positive.



---

archive/issue_comments_095827.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-03-06T13:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95827",
    "user": "https://github.com/qed777"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_095828.json:
```json
{
    "body": "**Changing author** from \"Mitesh Patel\" to \"Mitesh Patel, Dan Drake\".",
    "created_at": "2010-03-06T13:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95828",
    "user": "https://github.com/qed777"
}
```

**Changing author** from "Mitesh Patel" to "Mitesh Patel, Dan Drake".



---

archive/attachments_010520.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8443-cell_focus_jump.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8443/trac_8443-cell_focus_jump.2.patch",
    "created_at": "2010-03-06T13:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/qed777"
}
```



---

archive/issue_comments_095829.json:
```json
{
    "body": "Added doctest.  Apply only this patch.",
    "created_at": "2010-03-06T13:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95829",
    "user": "https://github.com/qed777"
}
```

Added doctest.  Apply only this patch.



---

archive/issue_comments_095830.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-03-07T05:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95830",
    "user": "https://github.com/dandrake"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_095831.json:
```json
{
    "body": "<a id='comment:4'></a>\nYour doctest fails without the patch, and succeeds with it. It has some nice ReST formatting. The patch fixes the problem. Positive review here!",
    "created_at": "2010-03-07T05:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95831",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:4'></a>
Your doctest fails without the patch, and succeeds with it. It has some nice ReST formatting. The patch fixes the problem. Positive review here!



---

archive/issue_comments_095832.json:
```json
{
    "body": "<a id='comment:5'></a>\nRelease manager: apply only attachment:trac_8443-cell_focus_jump.2.patch to sagenb repo.",
    "created_at": "2010-03-07T07:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95832",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:5'></a>
Release manager: apply only attachment:trac_8443-cell_focus_jump.2.patch to sagenb repo.



---

archive/issue_comments_095833.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2010-03-09T04:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95833",
    "user": "https://github.com/qed777"
}
```

**Resolution:** fixed



---

archive/issue_events_025188.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-03-09T04:59:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8443#event-25188"
}
```



---

archive/issue_comments_095834.json:
```json
{
    "body": "**Merged:** sagenb-0.7.5.3",
    "created_at": "2010-03-09T04:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8443",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8443#issuecomment-95834",
    "user": "https://github.com/qed777"
}
```

**Merged:** sagenb-0.7.5.3
