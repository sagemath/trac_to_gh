# Issue 8820: elliptic_exponential broken for curves over number fields

archive/issues_008820.json:
```json
{
    "assignees": [
        "https://github.com/JohnCremona"
    ],
    "body": "\n```\nsage: E = EllipticCurve('37a')\nsage: K.<a> = QuadraticField(-5)\nsage: L = E.change_ring(K).period_lattice(K.places()[0])\nsage: L.elliptic_exponential(CDF(.1,.1))\nTraceback (most recent call last):\n  File \"<ipython console>\", line 1, in <module>\n  File \"/usr/local/sage/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.py\", line 1390, in elliptic_exponential\n    pxy = E.pari_curve(prec+5).ellztopoint(w)\n  File \"gen.pyx\", line 9234, in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:44342)\nPariError: bad argument for an elliptic curve related function (43)\n```\n\nPerhaps Pari doesn't support curve not over Q? \n\nCC:  @jdemeyer @robertwb\n\nComponent: **elliptic curves**\n\nAuthor: **John Cremona**\n\nReviewer: **Chris Wuthrich, Jeroen Demeyer**\n\nMerged: **sage-4.6.alpha3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/8820_\n\n",
    "closed_at": "2010-10-06T03:17:56Z",
    "created_at": "2010-04-29T09:03:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "elliptic_exponential broken for curves over number fields",
    "type": "issue",
    "updated_at": "2023-01-08T16:06:24Z",
    "url": "https://github.com/sagemath/sage/issues/8820",
    "user": "https://github.com/robertwb"
}
```

```
sage: E = EllipticCurve('37a')
sage: K.<a> = QuadraticField(-5)
sage: L = E.change_ring(K).period_lattice(K.places()[0])
sage: L.elliptic_exponential(CDF(.1,.1))
Traceback (most recent call last):
  File "<ipython console>", line 1, in <module>
  File "/usr/local/sage/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.py", line 1390, in elliptic_exponential
    pxy = E.pari_curve(prec+5).ellztopoint(w)
  File "gen.pyx", line 9234, in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:44342)
PariError: bad argument for an elliptic curve related function (43)
```

Perhaps Pari doesn't support curve not over Q? 

CC:  @jdemeyer @robertwb

Component: **elliptic curves**

Author: **John Cremona**

Reviewer: **Chris Wuthrich, Jeroen Demeyer**

Merged: **sage-4.6.alpha3**

_Issue created by migration from https://trac.sagemath.org/ticket/8820_





---

archive/issue_events_110643.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:03:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "milestone_number": null,
    "milestone_title": "sage-4.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110643"
}
```



---

archive/issue_events_110644.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:03:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "c: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110644"
}
```



---

archive/issue_events_110645.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:03:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110645"
}
```



---

archive/issue_events_110646.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:03:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110646"
}
```



---

archive/issue_events_110647.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-04-29T09:03:18Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "subject": "https://github.com/robertwb",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110647"
}
```



---

archive/issue_events_110648.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:13:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110648"
}
```



---

archive/issue_events_110649.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-04-29T09:13:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110649"
}
```



---

archive/issue_comments_071934.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nActually, this makes sense because I'm not giving Pari the embedding to use.",
    "created_at": "2010-04-29T09:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71934",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:1" align="right">comment:1</div>

Actually, this makes sense because I'm not giving Pari the embedding to use.



---

archive/issue_comments_071935.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nRats, I thought I had implemented this properly.  The elliptic log does have examples over number fields with complex embeddings!  This should be a lot easier...\n\nThe period lattice has an embedding into CC (or RR) stored with it.  That should be used to create a pari elliptic curve defined over RR or CC, there the pari function would work.\n\nI would much prefer to have our own Weierstrass functions implemented, but that's the situation right now.\n\nNote that this will involve some of the same code as #8815.",
    "created_at": "2010-04-29T09:35:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71935",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:2" align="right">comment:2</div>

Rats, I thought I had implemented this properly.  The elliptic log does have examples over number fields with complex embeddings!  This should be a lot easier...

The period lattice has an embedding into CC (or RR) stored with it.  That should be used to create a pari elliptic curve defined over RR or CC, there the pari function would work.

I would much prefer to have our own Weierstrass functions implemented, but that's the situation right now.

Note that this will involve some of the same code as #8815.



---

archive/issue_comments_071936.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI am working on this right now.",
    "created_at": "2010-08-27T09:47:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71936",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:3" align="right">comment:3</div>

I am working on this right now.



---

archive/issue_comments_071937.json:
```json
{
    "body": "applies to 4.5.3.alpha2",
    "created_at": "2010-08-29T14:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71937",
    "user": "https://github.com/JohnCremona"
}
```

applies to 4.5.3.alpha2



---

archive/issue_events_110650.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-08-29T14:38:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110650"
}
```



---

archive/issue_comments_071938.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAttachment: **[trac_8820-elliptic-exp.patch.gz](https://github.com/sagemath/sage/files/ticket8820/trac_8820-elliptic-exp.patch.gz)**\n\nThe patch implements this.  I left the old code (using ellztopoint) for curves over QQ though the new code (using ellwp) works fine too, since the the output of many doctests would have changed (in insignificant bits), especially in heegner.py.\n\nI also documented a couple of functions in period_lattice.py which were not, so that file now has 100% coverage.",
    "created_at": "2010-08-29T14:38:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71938",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:4" align="right">comment:4</div>

Attachment: **[trac_8820-elliptic-exp.patch.gz](https://github.com/sagemath/sage/files/ticket8820/trac_8820-elliptic-exp.patch.gz)**

The patch implements this.  I left the old code (using ellztopoint) for curves over QQ though the new code (using ellwp) works fine too, since the the output of many doctests would have changed (in insignificant bits), especially in heegner.py.

I also documented a couple of functions in period_lattice.py which were not, so that file now has 100% coverage.



---

archive/issue_comments_071939.json:
```json
{
    "body": "Author: **John Cremona**",
    "created_at": "2010-08-29T14:38:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71939",
    "user": "https://github.com/JohnCremona"
}
```

Author: **John Cremona**



---

archive/issue_comments_071940.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI get doctest failures, like the typical case below. It should be considered numerical noise, but somehow it is not a very good example then. I think a point (1,1) would give a more convincing example.\n\n```\nFile \"/local/pmzcw/prog/sage-4.5/devel/sage-test/sage/schemes/elliptic_curves/period_lattice.py\", line 1424:\n    sage: Li[0].elliptic_exponential(zi[0])\nExpected:\n    (2.17701177381006e-16 + 2.21973923391111e-16*I : 1.11022302462516e-16 - 2.21990394816407e-16*I : 1.00000000000000)\nGot:\n    (2.17818031662168e-16 + 2.22022549601564e-16*I : 1.11022302462516e-16 - 2.22044604925031e-16*I : 1.00000000000000)\n```\n\nThe lines that fail are 1424, 1426, 1428, 1440, 1450, 1452.",
    "created_at": "2010-09-23T19:14:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71940",
    "user": "https://github.com/categorie"
}
```

<div id="comment:5" align="right">comment:5</div>

I get doctest failures, like the typical case below. It should be considered numerical noise, but somehow it is not a very good example then. I think a point (1,1) would give a more convincing example.

```
File "/local/pmzcw/prog/sage-4.5/devel/sage-test/sage/schemes/elliptic_curves/period_lattice.py", line 1424:
    sage: Li[0].elliptic_exponential(zi[0])
Expected:
    (2.17701177381006e-16 + 2.21973923391111e-16*I : 1.11022302462516e-16 - 2.21990394816407e-16*I : 1.00000000000000)
Got:
    (2.17818031662168e-16 + 2.22022549601564e-16*I : 1.11022302462516e-16 - 2.22044604925031e-16*I : 1.00000000000000)
```

The lines that fail are 1424, 1426, 1428, 1440, 1450, 1452.



---

archive/issue_events_110651.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2010-09-23T19:14:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110651"
}
```



---

archive/issue_events_110652.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2010-09-23T19:14:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110652"
}
```



---

archive/issue_comments_071941.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@categorie](#comment%3A5):\n> I get doctest failures, like the typical case below. It should be considered numerical noise, but somehow it is not a very good example then. I think a point (1,1) would give a more convincing example.\n> \n> ```\n> File \"/local/pmzcw/prog/sage-4.5/devel/sage-test/sage/schemes/elliptic_curves/period_lattice.py\", line 1424:\n>     sage: Li[0].elliptic_exponential(zi[0])\n> Expected:\n>     (2.17701177381006e-16 + 2.21973923391111e-16*I : 1.11022302462516e-16 - 2.21990394816407e-16*I : 1.00000000000000)\n> Got:\n>     (2.17818031662168e-16 + 2.22022549601564e-16*I : 1.11022302462516e-16 - 2.22044604925031e-16*I : 1.00000000000000)\n> ```\n> \n> The lines that fail are 1424, 1426, 1428, 1440, 1450, 1452.\n\nWhich version is that?  The patch says 4.5!",
    "created_at": "2010-09-23T21:06:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71941",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@categorie](#comment%3A5):
> I get doctest failures, like the typical case below. It should be considered numerical noise, but somehow it is not a very good example then. I think a point (1,1) would give a more convincing example.
> 
> ```
> File "/local/pmzcw/prog/sage-4.5/devel/sage-test/sage/schemes/elliptic_curves/period_lattice.py", line 1424:
>     sage: Li[0].elliptic_exponential(zi[0])
> Expected:
>     (2.17701177381006e-16 + 2.21973923391111e-16*I : 1.11022302462516e-16 - 2.21990394816407e-16*I : 1.00000000000000)
> Got:
>     (2.17818031662168e-16 + 2.22022549601564e-16*I : 1.11022302462516e-16 - 2.22044604925031e-16*I : 1.00000000000000)
> ```
> 
> The lines that fail are 1424, 1426, 1428, 1440, 1450, 1452.

Which version is that?  The patch says 4.5!



---

archive/issue_comments_071942.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@JohnCremona](#comment%3A6):\n\n\n> Which version is that?  The patch says 4.5!\n\nSorry, I meant \"path\".",
    "created_at": "2010-09-23T21:07:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71942",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@JohnCremona](#comment%3A6):


> Which version is that?  The patch says 4.5!

Sorry, I meant "path".



---

archive/issue_comments_071943.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIt is 4.5.3 on my office computer. \n\nNot that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.\n\nAm I too picky ?\n\nChris.",
    "created_at": "2010-09-24T18:16:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71943",
    "user": "https://github.com/categorie"
}
```

<div id="comment:8" align="right">comment:8</div>

It is 4.5.3 on my office computer. 

Not that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.

Am I too picky ?

Chris.



---

archive/issue_comments_071944.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@categorie](#comment%3A8):\n> It is 4.5.3 on my office computer. \n> \n> Not that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.\n> \n> Am I too picky ?\n\nNo, not at all -- using points which do not have 0 as a coordinate is a good idea!  But I was confused since the test which fails does not appear to exist on my 4.6.alpha1.\n\n> \n> Chris.",
    "created_at": "2010-09-24T19:28:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71944",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@categorie](#comment%3A8):
> It is 4.5.3 on my office computer. 
> 
> Not that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.
> 
> Am I too picky ?

No, not at all -- using points which do not have 0 as a coordinate is a good idea!  But I was confused since the test which fails does not appear to exist on my 4.6.alpha1.

> 
> Chris.



---

archive/issue_comments_071945.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@JohnCremona](#comment%3A9):\n> Replying to [@categorie](#comment%3A8):\n> > It is 4.5.3 on my office computer. \n> > \n> > Not that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.\n> > \n> > Am I too picky ?\n\n> \n> No, not at all -- using points which do not have 0 as a coordinate is a good idea!  But I was confused since the test which fails does not appear to exist on my 4.6.alpha1.\n\nSorry, I am being completely stupid -- of course the failing test is in the patch and I was looking at unpatched files!  But now I find that the patch does not apply to 4.6.alpha1 so I will have to rebase it.  When I do that I will try to use better examples.\n\n> \n> > \n> > Chris.",
    "created_at": "2010-09-24T19:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71945",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@JohnCremona](#comment%3A9):
> Replying to [@categorie](#comment%3A8):
> > It is 4.5.3 on my office computer. 
> > 
> > Not that I believe that it matters. It is just numerical noise. Both results are correct with an error 2.e-16. My question is whether we should change it to 2.2.... e-16, while we could take as an example a point (1,1) where 1.000000... would be a better illustration of the computations.
> > 
> > Am I too picky ?

> 
> No, not at all -- using points which do not have 0 as a coordinate is a good idea!  But I was confused since the test which fails does not appear to exist on my 4.6.alpha1.

Sorry, I am being completely stupid -- of course the failing test is in the patch and I was looking at unpatched files!  But now I find that the patch does not apply to 4.6.alpha1 so I will have to rebase it.  When I do that I will try to use better examples.

> 
> > 
> > Chris.



---

archive/issue_comments_071946.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nPlease try the rebased patch.  I changes the point (0,0) to (-1,-1) in the bad example, but that was enough since the approximate imaginary parts were not exactly 0 -- which I got around by taking real parts where necessary.  A little crude, but it avoids the fuzz.",
    "created_at": "2010-09-24T20:04:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71946",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:11" align="right">comment:11</div>

Please try the rebased patch.  I changes the point (0,0) to (-1,-1) in the bad example, but that was enough since the approximate imaginary parts were not exactly 0 -- which I got around by taking real parts where necessary.  A little crude, but it avoids the fuzz.



---

archive/issue_events_110653.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-24T20:04:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110653"
}
```



---

archive/issue_events_110654.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-24T20:04:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110654"
}
```



---

archive/issue_comments_071947.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nJohn: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)\n\nAlso: you should use \"PARI\" instead of \"Pari\".",
    "created_at": "2010-09-25T17:20:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71947",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

John: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)

Also: you should use "PARI" instead of "Pari".



---

archive/issue_comments_071948.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment%3A12):\n> John: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)\n> \n> Also: you should use \"PARI\" instead of \"Pari\".\n\nyes, alpha1",
    "created_at": "2010-09-25T17:43:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71948",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment%3A12):
> John: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)
> 
> Also: you should use "PARI" instead of "Pari".

yes, alpha1



---

archive/issue_comments_071949.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@JohnCremona](#comment%3A13):\n> Replying to [@jdemeyer](#comment%3A12):\n> > John: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)\n> > \n> > Also: you should use \"PARI\" instead of \"Pari\".\n\n> \n> yes, alpha1\n\nI have now fixed all the offending \"Pari\" and \"pari\" in the patch, and all the files in  elliptic_curves!",
    "created_at": "2010-09-26T16:46:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71949",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@JohnCremona](#comment%3A13):
> Replying to [@jdemeyer](#comment%3A12):
> > John: I suppose you mean rebased to 4.6.alpha1 unless you have some super-secret pre-release version of sage-4.6.alpha2 :-)
> > 
> > Also: you should use "PARI" instead of "Pari".

> 
> yes, alpha1

I have now fixed all the offending "Pari" and "pari" in the patch, and all the files in  elliptic_curves!



---

archive/issue_comments_071950.json:
```json
{
    "body": "applies to 4.6.alpha1",
    "created_at": "2010-09-26T16:46:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71950",
    "user": "https://github.com/JohnCremona"
}
```

applies to 4.6.alpha1



---

archive/issue_comments_071951.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAttachment: **[trac_8820-elliptic-exp-rebase.patch.gz](https://github.com/sagemath/sage/files/ticket8820/trac_8820-elliptic-exp-rebase.patch.gz)**\n\nJohn, I have rebased your patch such that it can be applied after the positively-reviewed #9931 (there were several conflicts).  I also made some very small changes to the docstring of the `cardinality` function in `ell_finite_field.py`",
    "created_at": "2010-09-26T18:04:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71951",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Attachment: **[trac_8820-elliptic-exp-rebase.patch.gz](https://github.com/sagemath/sage/files/ticket8820/trac_8820-elliptic-exp-rebase.patch.gz)**

John, I have rebased your patch such that it can be applied after the positively-reviewed #9931 (there were several conflicts).  I also made some very small changes to the docstring of the `cardinality` function in `ell_finite_field.py`



---

archive/issue_comments_071952.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jdemeyer](#comment%3A15):\n> John, I have rebased your patch such that it can be applied after the positively-reviewed #9931 (there were several conflicts).  I also made some very small changes to the docstring of the `cardinality` function in `ell_finite_field.py`\n\nOK, I'm not sure what the issues were there but the new patch applies fine after #9931;  I am currently testing it.  Meanwhile:  the latest patch's header is\n\n```\n...\n# User Jeroen Demeyer <jdemeyer@cage.ugent.be>\n...\n[mq]: 8820_rebase_after_9931\n```\nand I think protocol would leave me as author (and have a better one-line description) ;)",
    "created_at": "2010-09-26T20:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71952",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jdemeyer](#comment%3A15):
> John, I have rebased your patch such that it can be applied after the positively-reviewed #9931 (there were several conflicts).  I also made some very small changes to the docstring of the `cardinality` function in `ell_finite_field.py`

OK, I'm not sure what the issues were there but the new patch applies fine after #9931;  I am currently testing it.  Meanwhile:  the latest patch's header is

```
...
# User Jeroen Demeyer <jdemeyer@cage.ugent.be>
...
[mq]: 8820_rebase_after_9931
```
and I think protocol would leave me as author (and have a better one-line description) ;)



---

archive/issue_events_110655.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-26T20:56:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110655"
}
```



---

archive/issue_events_110656.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-26T20:56:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110656"
}
```



---

archive/issue_comments_071953.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@JohnCremona](#comment%3A16):\n> \\# User Jeroen Demeyer <jdemeyer@cage.ugent.be>\n> ...\n> [mq]: 8820_rebase_after_9931\n> }}}\n> and I think protocol would leave me as author (and have a better one-line description) ;)\n\nOK, I just copy-pasted the header from your patch.",
    "created_at": "2010-09-26T21:12:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71953",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@JohnCremona](#comment%3A16):
> \# User Jeroen Demeyer <jdemeyer@cage.ugent.be>
> ...
> [mq]: 8820_rebase_after_9931
> }}}
> and I think protocol would leave me as author (and have a better one-line description) ;)

OK, I just copy-pasted the header from your patch.



---

archive/issue_comments_071954.json:
```json
{
    "body": "John's patch rebased to be applied on top of #9931 (and some small additional changes)",
    "created_at": "2010-09-26T21:12:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71954",
    "user": "https://github.com/jdemeyer"
}
```

John's patch rebased to be applied on top of #9931 (and some small additional changes)



---

archive/issue_comments_071955.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2010-09-26T21:42:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71955",
    "user": "https://github.com/JohnCremona"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_110657.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-26T21:42:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110657"
}
```



---

archive/issue_events_110658.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-09-26T21:42:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110658"
}
```



---

archive/issue_comments_071956.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAttachment: **[8820_rebase_after_9931.patch.gz](https://github.com/sagemath/sage/files/ticket8820/8820_rebase_after_9931.patch.gz)**\n\nReplying to [@jdemeyer](#comment%3A17):\n> Replying to [@JohnCremona](#comment%3A16):\n> > \\# User Jeroen Demeyer <jdemeyer@cage.ugent.be>\n> > ...\n> > [mq]: 8820_rebase_after_9931\n> > }}}\n> > and I think protocol would leave me as author (and have a better one-line description) ;)\n\n> \n> OK, I just copy-pasted the header from your patch.\n\nThanks -- I added your name as reviewer and marked the ticket Positive Review.  If you want, you can add your name as author (and mine as reviewer) -- I appreciate your attention to detail.\n\nRelease manager:  apply only the last patch 8820_rebase_after_9931.patch, after the patch at #9931.",
    "created_at": "2010-09-26T21:42:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71956",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:18" align="right">comment:18</div>

Attachment: **[8820_rebase_after_9931.patch.gz](https://github.com/sagemath/sage/files/ticket8820/8820_rebase_after_9931.patch.gz)**

Replying to [@jdemeyer](#comment%3A17):
> Replying to [@JohnCremona](#comment%3A16):
> > \# User Jeroen Demeyer <jdemeyer@cage.ugent.be>
> > ...
> > [mq]: 8820_rebase_after_9931
> > }}}
> > and I think protocol would leave me as author (and have a better one-line description) ;)

> 
> OK, I just copy-pasted the header from your patch.

Thanks -- I added your name as reviewer and marked the ticket Positive Review.  If you want, you can add your name as author (and mine as reviewer) -- I appreciate your attention to detail.

Release manager:  apply only the last patch 8820_rebase_after_9931.patch, after the patch at #9931.



---

archive/issue_events_110659.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-26T22:05:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110659"
}
```



---

archive/issue_events_110660.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-26T22:05:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110660"
}
```



---

archive/issue_comments_071957.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI'm sorry John, but I did not review your patch, I just made a few small comments.  In any case, I think it is strange for the author of a patch to set his ticket to positive_review (no offense though).  I can probably review your patch later (not tonight).",
    "created_at": "2010-09-26T22:05:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71957",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

I'm sorry John, but I did not review your patch, I just made a few small comments.  In any case, I think it is strange for the author of a patch to set his ticket to positive_review (no offense though).  I can probably review your patch later (not tonight).



---

archive/issue_events_110661.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-26T22:05:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110661"
}
```



---

archive/issue_events_110662.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-26T22:05:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110662"
}
```



---

archive/issue_comments_071958.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Chris Wuthrich, Jeroen Demeyer**",
    "created_at": "2010-09-26T22:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71958",
    "user": "https://github.com/JohnCremona"
}
```

Changed reviewer from **Jeroen Demeyer** to **Chris Wuthrich, Jeroen Demeyer**



---

archive/issue_comments_071959.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@jdemeyer](#comment%3A19):\n> I'm sorry John, but I did not review your patch, I just made a few small comments.  In any case, I think it is strange for the author of a patch to set his ticket to positive_review (no offense though).  I can probably review your patch later (not tonight).\n\nNo problem -- I misunderstood, and also forgot that the original doctest failures were not from you but from Chris Wuthrich.\n\nOf course I would not positively review my own work!  I have now added Chris to the list of reviewers, and hope that he'll be able to take another look at it.  Needs review!",
    "created_at": "2010-09-26T22:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71959",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@jdemeyer](#comment%3A19):
> I'm sorry John, but I did not review your patch, I just made a few small comments.  In any case, I think it is strange for the author of a patch to set his ticket to positive_review (no offense though).  I can probably review your patch later (not tonight).

No problem -- I misunderstood, and also forgot that the original doctest failures were not from you but from Chris Wuthrich.

Of course I would not positively review my own work!  I have now added Chris to the list of reviewers, and hope that he'll be able to take another look at it.  Needs review!



---

archive/issue_comments_071960.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nA few comments:\n\n* I think the help for `elliptic_exponential` (lines 1379--1385) is not so well written.  I would write something like\n\n```\nOUTPUT:\n\n- If ``to_curve`` is False, a 2-tuple of real or complex numbers\nrepresenting the point `(x,y) = (\\wp(z),\\wp'(z))` where `\\wp` denotes the Weierstrass\n`\\wp`-function with respect to this lattice.\n\n- If ``to_curve`` is True, the point `(x-b_2/12,y-(a_1(x-b_2/12)-a_3)/2)`\nas a point in `E(\\RR)` or `E(\\CC)`, with `(x,y) = (\\wp(z),\\wp'(z))` as above.\n\nIf the lattice is real...\n```\n\n* The comment\n\n```\n       # the next lines compute [P(w), P'(w)] when flag=1\n       # or [x:y:1] in E(C) when flag=2\n```\n seems to refer to old code.\n\n* Is there a good reason to distinguish between QQ and general number fields?  The number-field code seems simpler, so you could consider removing the special-case code for QQ.\n\n* lines 1503 and 1530: `C(t.real().python(),t.imag().python())` can be simplified as `C(t)`.\n\n* it doesn't work for the point at infinity (and there should be a doctest for that case anyway):\n\n```\nsage: E = EllipticCurve([1,1,1,-8,6])\nsage: L = E.period_lattice()\nsage: L.elliptic_exponential(0)\n---------------------------------------------------------------------------\nUnboundLocalError                         Traceback (most recent call last)\n\n/usr/local/src/pari/src/<ipython console> in <module>()\n\n/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.pyc in elliptic_exponential(self, z, to_curve)\n   1476         if self.coordinates(z) == self.coordinates(z, rounding='round'):\n   1477             if to_curve:\n-> 1478                 return E.change_ring(C)(0)\n   1479             return (C('+infinity'),C('+infinity'))\n   1480\n\nUnboundLocalError: local variable 'E' referenced before assignment\n```",
    "created_at": "2010-09-30T09:18:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71960",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

A few comments:

* I think the help for `elliptic_exponential` (lines 1379--1385) is not so well written.  I would write something like

```
OUTPUT:

- If ``to_curve`` is False, a 2-tuple of real or complex numbers
representing the point `(x,y) = (\wp(z),\wp'(z))` where `\wp` denotes the Weierstrass
`\wp`-function with respect to this lattice.

- If ``to_curve`` is True, the point `(x-b_2/12,y-(a_1(x-b_2/12)-a_3)/2)`
as a point in `E(\RR)` or `E(\CC)`, with `(x,y) = (\wp(z),\wp'(z))` as above.

If the lattice is real...
```

* The comment

```
       # the next lines compute [P(w), P'(w)] when flag=1
       # or [x:y:1] in E(C) when flag=2
```
 seems to refer to old code.

* Is there a good reason to distinguish between QQ and general number fields?  The number-field code seems simpler, so you could consider removing the special-case code for QQ.

* lines 1503 and 1530: `C(t.real().python(),t.imag().python())` can be simplified as `C(t)`.

* it doesn't work for the point at infinity (and there should be a doctest for that case anyway):

```
sage: E = EllipticCurve([1,1,1,-8,6])
sage: L = E.period_lattice()
sage: L.elliptic_exponential(0)
---------------------------------------------------------------------------
UnboundLocalError                         Traceback (most recent call last)

/usr/local/src/pari/src/<ipython console> in <module>()

/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.pyc in elliptic_exponential(self, z, to_curve)
   1476         if self.coordinates(z) == self.coordinates(z, rounding='round'):
   1477             if to_curve:
-> 1478                 return E.change_ring(C)(0)
   1479             return (C('+infinity'),C('+infinity'))
   1480

UnboundLocalError: local variable 'E' referenced before assignment
```



---

archive/issue_events_110663.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-30T09:18:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110663"
}
```



---

archive/issue_events_110664.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-09-30T09:18:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110664"
}
```



---

archive/issue_comments_071961.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAlso, there is trouble with points which are very close to the point af infinity:\n\n```\nsage: K.<a> = QuadraticField(-1)\nsage: E = EllipticCurve([0,0,0,a,0])\nsage: L = E.period_lattice(K.complex_embeddings()[0])\nsage: L.elliptic_exponential(1e-100)\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n\n/home/jdemeyer/<ipython console> in <module>()\n\n/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.pyc in elliptic_exponential(self, z, to_curve)\n   1527         # the same precision as the input.\n   1528\n-> 1529         x,y = pari(self.basis(prec=prec)).ellwp(w,flag=1)\n   1530         x,y = [C(t) for t in (x,y)]\n   1531\n\n/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:45047)()\n\nPariError: division by zero (27)\n```",
    "created_at": "2010-09-30T09:35:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71961",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Also, there is trouble with points which are very close to the point af infinity:

```
sage: K.<a> = QuadraticField(-1)
sage: E = EllipticCurve([0,0,0,a,0])
sage: L = E.period_lattice(K.complex_embeddings()[0])
sage: L.elliptic_exponential(1e-100)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)

/home/jdemeyer/<ipython console> in <module>()

/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/period_lattice.pyc in elliptic_exponential(self, z, to_curve)
   1527         # the same precision as the input.
   1528
-> 1529         x,y = pari(self.basis(prec=prec)).ellwp(w,flag=1)
   1530         x,y = [C(t) for t in (x,y)]
   1531

/usr/local/src/sage-4.6.alpha1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:45047)()

PariError: division by zero (27)
```



---

archive/issue_comments_071962.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThanks for the comments, I will revise the patch accordingly.  The very last point (evaluation when z is very small but not zero) will not be easy though.  I think that I left in the special code for QQ since it was faster, but I may be mixing this up with the (harder!) elliptic logarithm.",
    "created_at": "2010-09-30T10:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71962",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:25" align="right">comment:25</div>

Thanks for the comments, I will revise the patch accordingly.  The very last point (evaluation when z is very small but not zero) will not be easy though.  I think that I left in the special code for QQ since it was faster, but I may be mixing this up with the (harder!) elliptic logarithm.



---

archive/issue_comments_071963.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@JohnCremona](#comment%3A25):\n> Thanks for the comments, I will revise the patch accordingly.  The very last point (evaluation when z is very small but not zero) will not be easy though.\n\nYou could use `try:`/`except PariError:` for this.  The only problem is that currently, you cannot easily check in Python whether a PariError is a division by zero or something else.",
    "created_at": "2010-09-30T15:06:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71963",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@JohnCremona](#comment%3A25):
> Thanks for the comments, I will revise the patch accordingly.  The very last point (evaluation when z is very small but not zero) will not be easy though.

You could use `try:`/`except PariError:` for this.  The only problem is that currently, you cannot easily check in Python whether a PariError is a division by zero or something else.



---

archive/issue_comments_071964.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nIt's ok, I have fixed it and the only reason I have not yet upadted the patch is that I am getting lots of failures in heegner.py -- not for the first time.  Several of the doctests there are not very well designed, so I may complain to Robert Bradshaw if I cannot fix them all!",
    "created_at": "2010-09-30T16:43:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71964",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:27" align="right">comment:27</div>

It's ok, I have fixed it and the only reason I have not yet upadted the patch is that I am getting lots of failures in heegner.py -- not for the first time.  Several of the doctests there are not very well designed, so I may complain to Robert Bradshaw if I cannot fix them all!



---

archive/issue_comments_071965.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\n8820_rebase_after_9931-new.patch adresses the doctest failures in heegner.py.  I did this quite carefully (even refining a little the code which does the modular parametrization).  I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero;  but when the output is an approximate integral Heegner point one cannot easily change the point.  I hope reviewer(s) do not object to the various ways I found  around this -- with very little use of ... and none (I think) of #random.\n\nNote that these Heegner examples are often going to be problematical since in many cases the point computed is approximately (0:1:0), i.e. the z in CC is approximately a period.  In such examples it might be better just to output E.period_lattice().coordinates(z) rather than E.elliptic_exponential(z).  However, I have adjusted the test for being integral (i.e. for z to b in the period lattice) in a way that I hope is a reasonable compromise:   namely that the coordinates w.r.t. the lattice basis should be approximately integral in the sense that their fractional part is at most `2^(0.8*prec)`.",
    "created_at": "2010-10-03T12:15:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71965",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:28" align="right">comment:28</div>

8820_rebase_after_9931-new.patch adresses the doctest failures in heegner.py.  I did this quite carefully (even refining a little the code which does the modular parametrization).  I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero;  but when the output is an approximate integral Heegner point one cannot easily change the point.  I hope reviewer(s) do not object to the various ways I found  around this -- with very little use of ... and none (I think) of #random.

Note that these Heegner examples are often going to be problematical since in many cases the point computed is approximately (0:1:0), i.e. the z in CC is approximately a period.  In such examples it might be better just to output E.period_lattice().coordinates(z) rather than E.elliptic_exponential(z).  However, I have adjusted the test for being integral (i.e. for z to b in the period lattice) in a way that I hope is a reasonable compromise:   namely that the coordinates w.r.t. the lattice basis should be approximately integral in the sense that their fractional part is at most `2^(0.8*prec)`.



---

archive/issue_events_110665.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-10-03T12:15:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110665"
}
```



---

archive/issue_events_110666.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2010-10-03T12:15:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110666"
}
```



---

archive/issue_comments_071966.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@JohnCremona](#comment%3A28):\n> However, I have adjusted the test for being integral (i.e. for z to b in the period lattice) in a way that I hope is a reasonable compromise:   namely that the coordinates w.r.t. the lattice basis should be approximately integral in the sense that their fractional part is at most `2^(0.8*prec)`.\n\nI like this solution. The `elliptic_exponential()` code looks fine to me.  However, I would like somebody else to review the heegner stuff.\n\nOne small suggestion: the doctest for `elliptic_exponential()` is quite long, so I would separate it in an `EXAMPLES` part and a `TESTS` part.",
    "created_at": "2010-10-03T15:57:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71966",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@JohnCremona](#comment%3A28):
> However, I have adjusted the test for being integral (i.e. for z to b in the period lattice) in a way that I hope is a reasonable compromise:   namely that the coordinates w.r.t. the lattice basis should be approximately integral in the sense that their fractional part is at most `2^(0.8*prec)`.

I like this solution. The `elliptic_exponential()` code looks fine to me.  However, I would like somebody else to review the heegner stuff.

One small suggestion: the doctest for `elliptic_exponential()` is quite long, so I would separate it in an `EXAMPLES` part and a `TESTS` part.



---

archive/issue_comments_071967.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@JohnCremona](#comment%3A28):\n> I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero\n\nWell, my **personal opinion** on this differs a bit.  I think we should remember that doctests not only serve as tests, but also as documentation.  I think it is always a difficult excercise to balance these two.  For me personally, the balance always goes in favour of documentation.  When needed, one can still add true tests in a `TESTS` section of a doctest.",
    "created_at": "2010-10-03T16:02:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71967",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@JohnCremona](#comment%3A28):
> I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero

Well, my **personal opinion** on this differs a bit.  I think we should remember that doctests not only serve as tests, but also as documentation.  I think it is always a difficult excercise to balance these two.  For me personally, the balance always goes in favour of documentation.  When needed, one can still add true tests in a `TESTS` section of a doctest.



---

archive/issue_comments_071968.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@jdemeyer](#comment%3A30):\n> Replying to [@JohnCremona](#comment%3A28):\n> > I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero\n\n> \n> Well, my **personal opinion** on this differs a bit.  I think we should remember that doctests not only serve as tests, but also as documentation.  I think it is always a difficult excercise to balance these two.  For me personally, the balance always goes in favour of documentation.  When needed, one can still add true tests in a `TESTS` section of a doctest.\n\nFair enough.  In the heegner file, which I did not write any of, I did not want to re-think documentation/tests from scratch, although that might be a good idea;  I just wanted to get things to work!  (And I would not have had to do anything, I think, if I had not followed the suggestion to eliminate the specific QQ code from elliptic_exponential.)",
    "created_at": "2010-10-03T16:19:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71968",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@jdemeyer](#comment%3A30):
> Replying to [@JohnCremona](#comment%3A28):
> > I took account where sensible of Chris's remark that it is better in approximate doctests not to have numbers which are approximately zero

> 
> Well, my **personal opinion** on this differs a bit.  I think we should remember that doctests not only serve as tests, but also as documentation.  I think it is always a difficult excercise to balance these two.  For me personally, the balance always goes in favour of documentation.  When needed, one can still add true tests in a `TESTS` section of a doctest.

Fair enough.  In the heegner file, which I did not write any of, I did not want to re-think documentation/tests from scratch, although that might be a good idea;  I just wanted to get things to work!  (And I would not have had to do anything, I think, if I had not followed the suggestion to eliminate the specific QQ code from elliptic_exponential.)



---

archive/issue_comments_071969.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI give all the changes to heegner.py in the patch \"8820_rebase_after_9931-new.patch\" a positive review.",
    "created_at": "2010-10-04T23:56:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71969",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:32" align="right">comment:32</div>

I give all the changes to heegner.py in the patch "8820_rebase_after_9931-new.patch" a positive review.



---

archive/issue_comments_071970.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nYou beat me to it :). Looks fine by me too.",
    "created_at": "2010-10-05T04:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71970",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:33" align="right">comment:33</div>

You beat me to it :). Looks fine by me too.



---

archive/issue_comments_071971.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nThere is a doctest failure on a 32-bit machine:\n\n```\nsage -t -long \"devel/sage/sage/schemes/elliptic_curves/heegner.py\"\n**********************************************************************\nFile \"/Users/jdemeyer/sage-4.6.alpha2/devel/sage/sage/schemes/elliptic_curves/heegner.py\", line 3048:\n    sage: P = E.heegner_point(-19); y = P._trace_numerical_conductor_1(); [c.real() for c in y]\nExpected:\n    [-1.26165722088693e-16, -1.00000000000000, 1.00000000000000]\nGot:\n    [-1.26126537554300e-16, -1.00000000000000, 1.00000000000000]\n**********************************************************************\n```\n\nWhen this is fixed (just write -1.261...), this ticket can finally gets its positive_review.",
    "created_at": "2010-10-05T07:23:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71971",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

There is a doctest failure on a 32-bit machine:

```
sage -t -long "devel/sage/sage/schemes/elliptic_curves/heegner.py"
**********************************************************************
File "/Users/jdemeyer/sage-4.6.alpha2/devel/sage/sage/schemes/elliptic_curves/heegner.py", line 3048:
    sage: P = E.heegner_point(-19); y = P._trace_numerical_conductor_1(); [c.real() for c in y]
Expected:
    [-1.26165722088693e-16, -1.00000000000000, 1.00000000000000]
Got:
    [-1.26126537554300e-16, -1.00000000000000, 1.00000000000000]
**********************************************************************
```

When this is fixed (just write -1.261...), this ticket can finally gets its positive_review.



---

archive/issue_comments_071972.json:
```json
{
    "body": "replaces previous",
    "created_at": "2010-10-05T08:26:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71972",
    "user": "https://github.com/JohnCremona"
}
```

replaces previous



---

archive/issue_comments_071973.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nAttachment: **[8820_rebase_after_9931-new.patch.gz](https://github.com/sagemath/sage/files/ticket8820/8820_rebase_after_9931-new.patch.gz)**\n\nThanks to all, and apologies for missing that one.  I have changed the patch as suggested and just tested it on a 32-bit machine as well as a 64-bit.\n\nThat failing test is exactly the kind of thing it would be nice to avoid altogether in doctests, since the \"true\" value of the x-coordinate is 0, so all nonzero digits, and the sign, are completely spurious.\n\nJeroen, if you are happy with this now could you mark it as \"positive review\"?  Thanks.\n\nRelease manager: only the last patch is to be applied.",
    "created_at": "2010-10-05T08:30:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71973",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:35" align="right">comment:35</div>

Attachment: **[8820_rebase_after_9931-new.patch.gz](https://github.com/sagemath/sage/files/ticket8820/8820_rebase_after_9931-new.patch.gz)**

Thanks to all, and apologies for missing that one.  I have changed the patch as suggested and just tested it on a 32-bit machine as well as a 64-bit.

That failing test is exactly the kind of thing it would be nice to avoid altogether in doctests, since the "true" value of the x-coordinate is 0, so all nonzero digits, and the sign, are completely spurious.

Jeroen, if you are happy with this now could you mark it as "positive review"?  Thanks.

Release manager: only the last patch is to be applied.



---

archive/issue_events_110667.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-10-05T20:41:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110667"
}
```



---

archive/issue_events_110668.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-10-05T20:41:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110668"
}
```



---

archive/issue_comments_071974.json:
```json
{
    "body": "Merged: **sage-4.6.alpha3**",
    "created_at": "2010-10-06T03:17:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8820#issuecomment-71974",
    "user": "https://github.com/qed777"
}
```

Merged: **sage-4.6.alpha3**



---

archive/issue_events_110669.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-06T03:17:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110669"
}
```



---

archive/issue_events_110670.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-06T03:17:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/8820",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8820#event-110670"
}
```
