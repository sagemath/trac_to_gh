# Issue 8003: EllipticCurve('522j1').sha().an_padic(13) fails

archive/issues_008003.json:
```json
{
    "body": "This is because the quadratic twist parameter `D` needs to be cast to an integer, but after [attachment:trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch) it still fails:\n\n```\nsage: EllipticCurve('522j1').sha().an_padic(13)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/Users/rlmill/sage-4.3.1.rc1/devel/sage-main/<ipython console> in <module>()\n\n/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/sha_tate.pyc in an_padic(self, p, prec, use_twists)\n    504             not_yet_enough_prec = True    \n    505             while not_yet_enough_prec:     \n--> 506                 lps = lp.Dp_valued_series(n,quadratic_twist=D,prec=r+1)\n    507                 lstar = [lps[0][r],lps[1][r]]\n    508                 verbose(\"the leading terms : %s\"%lstar)\n\n/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padic_lseries.pyc in Dp_valued_series(self, n, quadratic_twist, prec)\n   1038         E = self._E\n   1039         p = self._p\n-> 1040         lps = self.series(n, quadratic_twist=quadratic_twist, prec=prec)\n   1041     \n   1042         # now split up the series in two lps = G + H * alpha\n\n/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padic_lseries.pyc in series(self, n, quadratic_twist, prec)\n    934                     raise ValueError, \"quadratic_twist (=%s) must be a fundamental discriminant of a quadratic field\"%D\n    935             if gcd(D,self._p*self._E.conductor()) != 1:\n--> 936                 raise ValueError, \"quadratic twist (=%s) must be coprime to p (=%s) and the conductor of the curve (%s) \"%(D,self._p,self._E.conductor())\n    937 \n    938         p = self._p\n\nValueError: quadratic twist (=-3) must be coprime to p (=13) and the conductor of the curve (174)\n```\n\n**Assignee:** @JohnCremona\n\n**CC:**  @williamstein @categorie @JohnCremona\n\n**Reviewer:** Robert Miller\n\n**Author:** Chris Wuthrich\n\n**Merged:** sage-4.3.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/8003\n\n",
    "closed_at": "2010-01-23T20:51:56Z",
    "created_at": "2010-01-19T21:10:47Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.3.2",
    "title": "EllipticCurve('522j1').sha().an_padic(13) fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/8003",
    "user": "https://github.com/rlmill"
}
```
This is because the quadratic twist parameter `D` needs to be cast to an integer, but after [attachment:trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch) it still fails:

```
sage: EllipticCurve('522j1').sha().an_padic(13)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/Users/rlmill/sage-4.3.1.rc1/devel/sage-main/<ipython console> in <module>()

/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/sha_tate.pyc in an_padic(self, p, prec, use_twists)
    504             not_yet_enough_prec = True    
    505             while not_yet_enough_prec:     
--> 506                 lps = lp.Dp_valued_series(n,quadratic_twist=D,prec=r+1)
    507                 lstar = [lps[0][r],lps[1][r]]
    508                 verbose("the leading terms : %s"%lstar)

/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padic_lseries.pyc in Dp_valued_series(self, n, quadratic_twist, prec)
   1038         E = self._E
   1039         p = self._p
-> 1040         lps = self.series(n, quadratic_twist=quadratic_twist, prec=prec)
   1041     
   1042         # now split up the series in two lps = G + H * alpha

/Users/rlmill/sage-4.3.1.rc1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padic_lseries.pyc in series(self, n, quadratic_twist, prec)
    934                     raise ValueError, "quadratic_twist (=%s) must be a fundamental discriminant of a quadratic field"%D
    935             if gcd(D,self._p*self._E.conductor()) != 1:
--> 936                 raise ValueError, "quadratic twist (=%s) must be coprime to p (=%s) and the conductor of the curve (%s) "%(D,self._p,self._E.conductor())
    937 
    938         p = self._p

ValueError: quadratic twist (=-3) must be coprime to p (=13) and the conductor of the curve (174)
```

**Assignee:** @JohnCremona

**CC:**  @williamstein @categorie @JohnCremona

**Reviewer:** Robert Miller

**Author:** Chris Wuthrich

**Merged:** sage-4.3.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/8003





---

archive/attachments_010219.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8003-make_D_in_ZZ_only.patch",
    "asset_url": "tarball://root/attachments/ticket8003/trac_8003-make_D_in_ZZ_only.patch",
    "created_at": "2010-01-19T21:12:33Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch",
    "user": "https://github.com/rlmill"
}
```



---

archive/issue_comments_062998.json:
```json
{
    "body": "**Attachment:** [trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch)\n\nfor reference",
    "created_at": "2010-01-19T21:12:33Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-62998",
    "user": "https://github.com/rlmill"
}
```

**Attachment:** [trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch)

for reference



---

archive/issue_comments_062999.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,20 +1,4 @@\n-This is because the quadratic twist parameter `D` needs to be cast to an integer, but after the following patch it still fails.\n-\n-```\n-diff -r 0133676998bd sage/schemes/elliptic_curves/sha_tate.py\n---- a/sage/schemes/elliptic_curves/sha_tate.py\tTue Jan 19 10:28:48 2010 -0800\n-+++ b/sage/schemes/elliptic_curves/sha_tate.py\tTue Jan 19 13:05:47 2010 -0800\n-@@ -424,7 +424,7 @@\n-                 if Et.conductor() < Nmin and valuation(Et.conductor(),2) <= valuation(DD,2):\n-                     Nmin = Et.conductor()\n-                     Dmax = DD\n--            D = Dmax\n-+            D = ZZ(Dmax)\n-             Et = self.E.quadratic_twist(D)\n-             lp = Et.padic_lseries(p)\n-         else :\n-```\n-This time the failure is:\n+This is because the quadratic twist parameter `D` needs to be cast to an integer, but after [attachment:trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch) it still fails:\n \n ```\n sage: EllipticCurve('522j1').sha().an_padic(13)\n``````\n",
    "created_at": "2010-01-19T21:13:12Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-62999",
    "user": "https://github.com/rlmill"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,20 +1,4 @@
-This is because the quadratic twist parameter `D` needs to be cast to an integer, but after the following patch it still fails.
-
-```
-diff -r 0133676998bd sage/schemes/elliptic_curves/sha_tate.py
---- a/sage/schemes/elliptic_curves/sha_tate.py	Tue Jan 19 10:28:48 2010 -0800
-+++ b/sage/schemes/elliptic_curves/sha_tate.py	Tue Jan 19 13:05:47 2010 -0800
-@@ -424,7 +424,7 @@
-                 if Et.conductor() < Nmin and valuation(Et.conductor(),2) <= valuation(DD,2):
-                     Nmin = Et.conductor()
-                     Dmax = DD
--            D = Dmax
-+            D = ZZ(Dmax)
-             Et = self.E.quadratic_twist(D)
-             lp = Et.padic_lseries(p)
-         else :
-```
-This time the failure is:
+This is because the quadratic twist parameter `D` needs to be cast to an integer, but after [attachment:trac_8003-make_D_in_ZZ_only.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003-make_D_in_ZZ_only.patch) it still fails:
 
 ```
 sage: EllipticCurve('522j1').sha().an_padic(13)
``````




---

archive/issue_comments_063000.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis is a bug that I corrected earlier for the ordinary case and I forgot to adjust the supersingular case. But while I am at it, I am improving a bit an_padic.",
    "created_at": "2010-01-22T23:15:05Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63000",
    "user": "https://github.com/categorie"
}
```

<a id='comment:2'></a>
This is a bug that I corrected earlier for the ordinary case and I forgot to adjust the supersingular case. But while I am at it, I am improving a bit an_padic.



---

archive/attachments_010220.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8003.patch",
    "asset_url": "tarball://root/attachments/ticket8003/trac_8003.patch",
    "created_at": "2010-01-23T18:32:40Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket8003/trac_8003.patch",
    "user": "https://github.com/categorie"
}
```



---

archive/issue_comments_063001.json:
```json
{
    "body": "**Attachment:** [trac_8003.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003.patch)\n\nexported against 4.3.1.",
    "created_at": "2010-01-23T18:32:40Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63001",
    "user": "https://github.com/categorie"
}
```

**Attachment:** [trac_8003.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003.patch)

exported against 4.3.1.



---

archive/issue_events_055688.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2010-01-23T18:37:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8003#event-55688"
}
```



---

archive/issue_comments_063002.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis patch solves the issues above.\n\nI have also worked a bit on an_padic. I made a short-cut for rank 0 curves. In this case the leading term of the p-adic series is known to be L_ratio, so there is no need to compute the p-adic L-series, the modular symbol at 0 suffices. This speeds up the computation.\n\nThe -long doctest decreased to a half of the length, without -long it is a little bit faster. Most of the time for -long is taken up by one example. But it needs to be there as it is the fastest example of a positive rank supersingular case.\n\nAlso. I did NOT include a doctest that tests this particular bug here. This is against the rules I know, but I believe that the shortest case in which it can be reproduced would take longer than what is allowed for a doctest. In particular the above axample is not adequate.",
    "created_at": "2010-01-23T18:37:50Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63002",
    "user": "https://github.com/categorie"
}
```

<a id='comment:3'></a>
This patch solves the issues above.

I have also worked a bit on an_padic. I made a short-cut for rank 0 curves. In this case the leading term of the p-adic series is known to be L_ratio, so there is no need to compute the p-adic L-series, the modular symbol at 0 suffices. This speeds up the computation.

The -long doctest decreased to a half of the length, without -long it is a little bit faster. Most of the time for -long is taken up by one example. But it needs to be there as it is the fastest example of a positive rank supersingular case.

Also. I did NOT include a doctest that tests this particular bug here. This is against the rules I know, but I believe that the shortest case in which it can be reproduced would take longer than what is allowed for a doctest. In particular the above axample is not adequate.



---

archive/issue_comments_063003.json:
```json
{
    "body": "**Author:** Christian Wuthrich",
    "created_at": "2010-01-23T19:31:27Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63003",
    "user": "https://github.com/rlmill"
}
```

**Author:** Christian Wuthrich



---

archive/issue_comments_063004.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [wuthrich](#comment%3A3):\n> This patch solves the issues above.\n\nI have verified this.\n\n> Also. I did NOT include a doctest that tests this particular bug here. This is against the rules I know, but I believe that the shortest case in which it can be reproduced would take longer than what is allowed for a doctest. In particular the above axample is not adequate.\n\nI completely agree.\n\n```\nsage: time EllipticCurve('522j1').sha().an_padic(13)\nCPU times: user 1557.39 s, sys: 50.77 s, total: 1608.16 s\nWall time: 1615.05 s\n1 + O(13)\n```\n\nAlmost half an hour!",
    "created_at": "2010-01-23T19:31:27Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63004",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:4'></a>
Replying to [wuthrich](#comment%3A3):
> This patch solves the issues above.

I have verified this.

> Also. I did NOT include a doctest that tests this particular bug here. This is against the rules I know, but I believe that the shortest case in which it can be reproduced would take longer than what is allowed for a doctest. In particular the above axample is not adequate.

I completely agree.

```
sage: time EllipticCurve('522j1').sha().an_padic(13)
CPU times: user 1557.39 s, sys: 50.77 s, total: 1608.16 s
Wall time: 1615.05 s
1 + O(13)
```

Almost half an hour!



---

archive/issue_comments_063005.json:
```json
{
    "body": "**Reviewer:** Robert Miller",
    "created_at": "2010-01-23T19:33:21Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63005",
    "user": "https://github.com/rlmill"
}
```

**Reviewer:** Robert Miller



---

archive/issue_comments_063006.json:
```json
{
    "body": "<a id='comment:5'></a>\nLGTM",
    "created_at": "2010-01-23T19:33:21Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63006",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:5'></a>
LGTM



---

archive/issue_events_055689.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2010-01-23T19:33:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8003#event-55689"
}
```



---

archive/issue_events_055690.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2010-01-23T19:33:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8003#event-55690"
}
```



---

archive/issue_comments_063007.json:
```json
{
    "body": "**Merged:** sage-4.3.2.alpha0",
    "created_at": "2010-01-23T20:51:56Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63007",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Merged:** sage-4.3.2.alpha0



---

archive/issue_comments_063008.json:
```json
{
    "body": "<a id='comment:6'></a>\nMerged [trac_8003.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003.patch).",
    "created_at": "2010-01-23T20:51:56Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63008",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:6'></a>
Merged [trac_8003.patch](https://github.com/sagemath/sage/files/ticket8003/trac_8003.patch).



---

archive/issue_events_055691.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2010-01-23T20:51:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8003#event-55691"
}
```



---

archive/issue_events_055692.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2010-01-23T20:51:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/8003#event-55692"
}
```



---

archive/issue_comments_063009.json:
```json
{
    "body": "**Changing author** from \"Christian Wuthrich\" to \"Chris Wuthrich\".",
    "created_at": "2016-10-31T16:54:25Z",
    "issue": "https://github.com/sagemath/sage/issues/8003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/8003#issuecomment-63009",
    "user": "https://github.com/fchapoton"
}
```

**Changing author** from "Christian Wuthrich" to "Chris Wuthrich".
