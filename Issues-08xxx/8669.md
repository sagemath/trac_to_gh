# Issue 8669: interrupting download in sage-spkg should delete the spkg file

archive/issues_008669.json:
```json
{
    "body": "If you run `sage-spkg PKG_NAME` and hit ctrl-c during downloading, you end up with a partial spkg file.  Then if you run `sage-spkg PKG_NAME` again, it just opens up that file and then crashes because the file is incomplete.\n\nThe attached patch attempts to fix this.  It seems to work, deleting the partially downloaded file, but for reasons I don't understand, it's not printing any of the accompanying messages.\n\n\n**CC:**  @nexttime\n\n**Author:** John Palmieri\n\n**Reviewer:** Tim Dumol\n\n**Merged:** sage-4.4.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/8669\n\n",
    "closed_at": "2010-04-19T05:20:51Z",
    "created_at": "2010-04-10T18:56:51Z",
    "labels": [
        "component: packages: optional",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.4",
    "title": "interrupting download in sage-spkg should delete the spkg file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8669",
    "user": "https://github.com/jhpalmieri"
}
```
If you run `sage-spkg PKG_NAME` and hit ctrl-c during downloading, you end up with a partial spkg file.  Then if you run `sage-spkg PKG_NAME` again, it just opens up that file and then crashes because the file is incomplete.

The attached patch attempts to fix this.  It seems to work, deleting the partially downloaded file, but for reasons I don't understand, it's not printing any of the accompanying messages.


**CC:**  @nexttime

**Author:** John Palmieri

**Reviewer:** Tim Dumol

**Merged:** sage-4.4.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/8669





---

archive/issue_events_063358.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-10T18:57:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8669#event-63358"
}
```



---

archive/issue_comments_073159.json:
```json
{
    "body": "<a id='comment:1'></a>\nI'm marking this as \"needs review\", but if anyone can fix the printing problem mentioned in the summary, that would be great.",
    "created_at": "2010-04-10T18:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73159",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
I'm marking this as "needs review", but if anyone can fix the printing problem mentioned in the summary, that would be great.



---

archive/issue_comments_073160.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe reason for the \"non-printing\" is simple:\n\nIn `local/bin/sage-sage`, the output of `sage-spkg` is piped to `tee`, which is run from the same subshell and so gets the same signal.\n\n(`sage-spkg` *does* print the messages, but `tee` *does not* \"wait\" for the *post-*`Ctrl-C` output.)",
    "created_at": "2010-04-10T20:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73160",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>
The reason for the "non-printing" is simple:

In `local/bin/sage-sage`, the output of `sage-spkg` is piped to `tee`, which is run from the same subshell and so gets the same signal.

(`sage-spkg` *does* print the messages, but `tee` *does not* "wait" for the *post-*`Ctrl-C` output.)



---

archive/issue_comments_073161.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [leif](#comment%3A2):\n> The reason for the \"non-printing\" is simple:\n> \n> In `local/bin/sage-sage`, the output of `sage-spkg` is piped to `tee`, which is run from the same subshell and so gets the same signal.\n\n\nAny ideas how to fix this?  I tried using \"pipestatus\" from #8306, but it doesn't seem to help: when I hit ctrl-C, it prints \n\n```\n[..^Cclose failed in file object destructor:\nError in sys.excepthook:\n\nOriginal exception was:\n```",
    "created_at": "2010-04-10T22:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73161",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
Replying to [leif](#comment%3A2):
> The reason for the "non-printing" is simple:
> 
> In `local/bin/sage-sage`, the output of `sage-spkg` is piped to `tee`, which is run from the same subshell and so gets the same signal.


Any ideas how to fix this?  I tried using "pipestatus" from #8306, but it doesn't seem to help: when I hit ctrl-C, it prints 

```
[..^Cclose failed in file object destructor:
Error in sys.excepthook:

Original exception was:
```



---

archive/issue_comments_073162.json:
```json
{
    "body": "<a id='comment:4'></a>\nOkay, here's a new patch without any printing problems.",
    "created_at": "2010-04-10T23:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73162",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
Okay, here's a new patch without any printing problems.



---

archive/issue_comments_073163.json:
```json
{
    "body": "scripts repo",
    "created_at": "2010-04-10T23:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73163",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo



---

archive/attachments_010835.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8669-download.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8669/trac_8669-download.2.patch",
    "created_at": "2010-04-10T23:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jhpalmieri"
}
```



---

archive/issue_comments_073164.json:
```json
{
    "body": "scripts repo",
    "created_at": "2010-04-10T23:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73164",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo



---

archive/attachments_010836.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8669-download.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8669/trac_8669-download.patch",
    "created_at": "2010-04-10T23:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jhpalmieri"
}
```



---

archive/issue_comments_073165.json:
```json
{
    "body": "scripts repo (same as other patch)",
    "created_at": "2010-04-10T23:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73165",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo (same as other patch)



---

archive/attachments_010837.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_8669-download.3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket8669/trac_8669-download.3.patch",
    "created_at": "2010-04-10T23:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jhpalmieri"
}
```



---

archive/issue_comments_073166.json:
```json
{
    "body": "<a id='comment:5'></a>\nTo the release manager: please delete all but \"trac_8669-download.patch\".",
    "created_at": "2010-04-10T23:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73166",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
To the release manager: please delete all but "trac_8669-download.patch".



---

archive/issue_comments_073167.json:
```json
{
    "body": "<a id='comment:6'></a>\nWorks as advertised. Positive review.",
    "created_at": "2010-04-18T08:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73167",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:6'></a>
Works as advertised. Positive review.



---

archive/issue_events_063359.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-18T08:28:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8669#event-63359"
}
```



---

archive/issue_events_063360.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-18T08:28:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8669#event-63360"
}
```



---

archive/issue_comments_073168.json:
```json
{
    "body": "**Reviewer:** Tim Dumol",
    "created_at": "2010-04-18T08:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73168",
    "user": "https://github.com/TimDumol"
}
```

**Reviewer:** Tim Dumol



---

archive/issue_comments_073169.json:
```json
{
    "body": "<a id='comment:7'></a>\nMerged \"trac_8669-download.patch\" into 4.4.alpha1.",
    "created_at": "2010-04-19T05:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73169",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
Merged "trac_8669-download.patch" into 4.4.alpha1.



---

archive/issue_comments_073170.json:
```json
{
    "body": "**Merged:** sage-4.4.alpha1",
    "created_at": "2010-04-19T05:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8669#issuecomment-73170",
    "user": "https://github.com/jhpalmieri"
}
```

**Merged:** sage-4.4.alpha1



---

archive/issue_events_063361.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-19T05:20:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8669#event-63361"
}
```



---

archive/issue_events_063362.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2010-04-19T05:20:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/8669",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/8669#event-63362"
}
```
