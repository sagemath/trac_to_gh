# Issue 20962: do not relink python to python3

Issue created by migration from https://trac.sagemath.org/ticket/21199

Original creator: dimpase

Original creation time: 2016-08-10 08:40:00

CC:  jdemeyer embray chapoton

Installing optional package `python3` currently breaks sage, as it relinks `python` to `python3` in `SAGE_LOCAL/bin`. It should not do this.

See also this sage-devel [thread](https://groups.google.com/d/msg/sage-support/Xecajaxz1rA/6yVdH-ZkAwAJ).


---

Comment by embray created at 2016-08-10 09:07:52

Agreed.  Though I know work is also being done to make it possible to use python3 as the main Python for sage, in which case you would want to link `python3 -> python`.  Is there some way when installing a Python in Sage to distinguish between it being installed as the "main" Python or as an optional package?

In the latter case then yes, it should not change the `python` link.


---

Comment by leif created at 2016-08-10 09:46:03

I've replied on [sage-support](http://permalink.gmane.org/gmane.comp.mathematics.sage.support/39691)...

(We should IMHO just make sure that Python3 -- just like GMP -- never gets installed when Sage is already built with the alternative, i.e., Python2 or MPIR.  Changing the package _currently_ requires rebuilding almost everything, i.e., from scratch.)


---

Comment by leif created at 2016-08-10 09:50:45

If having both Python2 and Python3 at the same time (modulo the link) _really works_ (which I doubt), then we could of course just prevent symlinking `local/bin/python` to `python{2,3}` in the `spkg-install` files, in case the other Python is already installed.


---

Comment by dimpase created at 2016-08-10 10:08:20

On Linux systems it's perfectly possible to have Pythons 2 and 3 alongside. On the other hand  I must say I don't know in all details what the installation of python3 package may break in Sage.


---

Comment by leif created at 2016-08-10 10:18:20

Just for the record, we also have a symlink `local/lib/python`.

\\

I bet people doing `./sage -i python3` will expect Sage to suddenly work with Python3, which is not the case.  So I'd simply disable that option (for the time being).

I'm not entirely sure, but I think Cython extension modules compiled for/with Python2 won't work with Python3 (and vice versa), so we'd at least have to rebuild all of these.

Just having another Python interpreter inside Sage you cannot use with Sage IMHO doesn't make sense.


---

Comment by leif created at 2016-08-10 10:28:03

Replying to [comment:5 dimpase]:
> On Linux systems it's perfectly possible to have Pythons 2 and 3 alongside. On the other hand  I must say I don't know in all details what the installation of python3 package may break in Sage.

There's `update-alternatives` (on Debian at least), but while you can otherwise of course have both `python2` and `python3` at the same time, you'd have to install any additional package into *both*, since these are _separate_, independent installations.

That's similar to having _two instances of Sage_, one configured to use Python2 (the default), the other with `SAGE_PYTHON3=yes` (IIRC).


---

Comment by embray created at 2016-08-10 11:45:03

+1 there's no reason you shouldn't be able to have both simultaneously, and that would be especially good for development of Python 3 in Sage.  Installing one just shouldn't break the other.  Clearly that's not currently the case.


---

Comment by leif created at 2016-08-10 12:37:24

Replying to [comment:8 embray]:
> +1 there's no reason you shouldn't be able to have both simultaneously

You mean in the *same* Sage installation?

Exactly that IMHO doesn't make sense, and would just cause lots of trouble (or needless additional work in order to support that, presumably just for a while anyway, since in the long run Sage will always and only build and use its own _Python3_).

\\

> and that would be especially good for development of Python 3 in Sage.

For developing migration, you should have a _separate_ Sage installation configured with `SAGE_PYTHON3=yes`.

\\

> Installing one just shouldn't break the other.  Clearly that's not currently the case.

Sure.  Disable that, with an appropriate message if someone tries to... ;-)


---

Comment by dimpase created at 2016-08-10 14:11:04

In fact, it turned out that to completely fix my Sage installation, I also needed to rebuild python2 package, and then run make.
Otherwise ipython, doctesting, and some stuff related to dictionaries didn't quite work.
So this is not that trivial, apparently, and needs further investigation.


---

Comment by leif created at 2016-08-10 14:17:10

Replying to [comment:10 dimpase]:
> In fact, it turned out that to completely fix my Sage installation, I also needed to rebuild python2 package, and then run make.
> Otherwise ipython, doctesting, and some stuff related to dictionaries didn't quite work.
> So this is not that trivial, apparently, and needs further investigation.

I told you so... ;-)


---

Comment by dimpase created at 2016-08-10 15:50:45

Replying to [comment:11 leif]:
> Replying to [comment:10 dimpase]:
> > In fact, it turned out that to completely fix my Sage installation, I also needed to rebuild python2 package, and then run make.
> > Otherwise ipython, doctesting, and some stuff related to dictionaries didn't quite work.
> > So this is not that trivial, apparently, and needs further investigation.
> 
> I told you so... ;-)
Well, this points out to more bugs, IMHO...
On the other hand it could be the damage from setting the symbolic link the way it is done now, and if it did not happen then things work.


---

Comment by leif created at 2016-08-10 16:36:15

By the way, `python3` doesn't even have an `SPKG.txt`, so it's not a valid spkg anyway. ;-)

\\

W.r.t. having to reinstall `python2`:

The `spkg-install` files currently also wipe out `$SAGE_LOCAL/lib/libpython*` before installing the new version.


---

Comment by dimpase created at 2016-08-10 16:41:49

no-no-no, `SPKG.txt` is obsolete...


---

Comment by leif created at 2016-08-10 16:46:54

The by far easiest solution would be to change its type to `experimental` (which is pretty true at the moment), then the user would get prompted with a warning upon attempting to install it.

But we've just released 7.3...


---

Comment by leif created at 2016-08-10 16:51:07

Replying to [comment:14 dimpase]:
> no-no-no, `SPKG.txt` is obsolete...

Nope:

```
$ ./sage --info python3
Found local metadata for python3-3.5.1
cat: .../build/pkgs/python3/SPKG.txt: No such file or directory
```



---

Comment by dimpase created at 2016-08-10 17:00:24

Replying to [comment:16 leif]:
> Replying to [comment:14 dimpase]:
> > no-no-no, `SPKG.txt` is obsolete...
> 
> Nope:
> {{{
> $ ./sage --info python3
> Found local metadata for python3-3.5.1
> cat: .../build/pkgs/python3/SPKG.txt: No such file or directory
> }}}

ah, OK, it's only the changelog part that is obsolete...


---

Comment by embray created at 2016-08-11 10:32:10

Replying to [comment:9 leif]:
> Replying to [comment:8 embray]:
> > +1 there's no reason you shouldn't be able to have both simultaneously
> 
> You mean in the *same* Sage installation?
> 
> Exactly that IMHO doesn't make sense, and would just cause lots of trouble (or needless additional work in order to support that, presumably just for a while anyway, since in the long run Sage will always and only build and use its own _Python3_).

What do you mean exactly by "Sage installation"?  You mean the filesystem in `$SAGE_LOCAL`?  What's the big deal?  I usually have like a dozen Pythons installed at the same time.  This is no problem.

> > and that would be especially good for development of Python 3 in Sage.
> 
> For developing migration, you should have a _separate_ Sage installation configured with `SAGE_PYTHON3=yes`.

That's a lot of duplicated software just to have two different Pythons installed.  No, that doesn't make any sense.  Currently you may have to do that--I'm just saying `./sage` itself should know which Python it's using, and be able to switch that as needed.


---

Comment by mkoeppe created at 2016-10-13 22:23:51

Replying to [comment:15 leif]:
> The by far easiest solution would be to change its type to `experimental` (which is pretty true at the moment), then the user would get prompted with a warning upon attempting to install it.
> 
> But we've just released 7.3...

Changing it to experimental is now #21698. Please let's get this into 7.4.


---

Comment by mkoeppe created at 2017-01-04 18:58:33

Changing component from packages: optional to packages: experimental.


---

Comment by mkoeppe created at 2017-01-04 18:58:33

Changing priority from critical to major.


---

Comment by vbraun created at 2017-04-08 22:27:56

This is implemented in #22582, proposing to close as duplicate


---

Comment by jhpalmieri created at 2017-04-08 23:09:56

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-04-08 23:11:15

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2017-04-08 23:11:15

I'm not sure I agree that we should not link python to python3 some of the time, but we can resolve it at #22582. A lot of the discussion here is not directly relevant anymore, since `python3` is now standard.


---

Comment by embray created at 2017-07-13 07:54:31

Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).


---

Comment by embray created at 2017-07-13 07:54:31

Resolution: wontfix
