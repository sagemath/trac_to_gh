# Issue 28766: Install Sage-specific .pc files when running make, not configure

Issue created by migration from https://trac.sagemath.org/ticket/29003

Original creator: embray

Original creation time: 2020-01-13 16:49:51

CC:  dimpase mkoeppe

As noted in [this comment](https://trac.sagemath.org/ticket/27870#comment:81), if we generate any .pc files at configure time, rather than write them directly to `$SAGE_LOCAL` it would be preferable to write them somewhere in the sage source tree instead, then copy them into the relevant install target (i.e. `$SAGE_LOCAL`) only when running `make`.

One tricky aspect to this is at least some SPGKs require our generated .pc files to be installed in `$SAGE_LOCAL` to build properly.  Currently, one way around that is to add `$(PCFILES)` to the package's dependencies.  This is needed at the very least for numpy.

A different workaround might be to modify `PKG_CONFIG_PATH` to include .pc files in the source tree.  I have not tried that yet.


---

Comment by embray created at 2020-01-13 16:52:42

First attempt at this seems to work.

I chose `src/lib/pkgconfig` as the path for .pc files to install from the source tree, as it has a nice congruence with `src/bin`.  But that was just a minor preference--this path could be anywhere in the source tree, or even outside it (e.g. for VPATH builds, should we ever get that working...)
----
New commits:


---

Comment by git created at 2020-01-13 16:53:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-13 17:03:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2020-01-13 17:05:11

Changing status from new to needs_review.


---

Comment by embray created at 2020-01-13 17:05:11

Replying to [comment:3 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[854c899](https://git.sagemath.org/sage.git/commit/?id=854c8990d99a88aac87b06bf385943d4382d0c2f)||`Trac #29003: Create generated .pc files in the source tree and install them later instead of creating them directly in SAGE_LOCAL`||
> ||[62ac3cc](https://git.sagemath.org/sage.git/commit/?id=62ac3cc3bef11cdfdde88cfad9b5e594c94cfc78)||`Trac #29003: Also output generated gsl.pc to SAGE_SRC`||
> ||[e59f991](https://git.sagemath.org/sage.git/commit/?id=e59f9912f91f0033d0f4a73d165212b4a373311f)||`Trac #29003: Instead of making individual packages responsible for .pc files being installed, just include them as part of the standard 'toolchain'`||

I think the approach in this version might be simplest, and is closer to the existing behavior.  The major difference now is that actually copying `.pc` files into `$SAGE_LOCAL` is deferred until `make` is run, rather than writing to `$SAGE_LOCAL` directly when running `configure`.


---

Comment by git created at 2020-01-14 11:11:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-01-14 12:39:49

testing


---

Comment by dimpase created at 2020-01-14 14:37:04

OK, good, thanks!


---

Comment by dimpase created at 2020-01-14 14:37:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-20 21:18:07

Resolution: fixed


---

Comment by dimpase created at 2020-01-24 12:45:56

there is sometimes a permission problem, shouldn't that `cp -P` used to install these things be replaced by something more robust. 

see e.g. #29071#comment:8


---

Comment by dimpase created at 2020-01-24 12:50:24

by right, these *.pc files are package data, so they ought to be treated as such, no?


---

Comment by dimpase created at 2020-01-26 12:28:34

$(PCFILES) must be cleanable, by `make clean` I guess.
Pleadse confirm. It caused a lot of pain on #29071


---

Comment by dimpase created at 2020-01-26 12:53:52

the followup (cleaning of *.pc files) is on #29082


---

Comment by mkoeppe created at 2020-01-31 16:15:00

... hotfix in #29121
