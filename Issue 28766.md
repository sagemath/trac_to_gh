# Issue 28766: Install Sage-specific .pc files when running make, not configure

archive/issues_028766.json:
```json
{
    "body": "CC:  @dimpase @mkoeppe\n\nAs noted in [this comment](https://trac.sagemath.org/ticket/27870#comment:81), if we generate any .pc files at configure time, rather than write them directly to `$SAGE_LOCAL` it would be preferable to write them somewhere in the sage source tree instead, then copy them into the relevant install target (i.e. `$SAGE_LOCAL`) only when running `make`.\n\nOne tricky aspect to this is at least some SPGKs require our generated .pc files to be installed in `$SAGE_LOCAL` to build properly.  Currently, one way around that is to add `$(PCFILES)` to the package's dependencies.  This is needed at the very least for numpy.\n\nA different workaround might be to modify `PKG_CONFIG_PATH` to include .pc files in the source tree.  I have not tried that yet.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29003\n\n",
    "created_at": "2020-01-13T16:49:51Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Install Sage-specific .pc files when running make, not configure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28766",
    "user": "https://github.com/embray"
}
```
CC:  @dimpase @mkoeppe

As noted in [this comment](https://trac.sagemath.org/ticket/27870#comment:81), if we generate any .pc files at configure time, rather than write them directly to `$SAGE_LOCAL` it would be preferable to write them somewhere in the sage source tree instead, then copy them into the relevant install target (i.e. `$SAGE_LOCAL`) only when running `make`.

One tricky aspect to this is at least some SPGKs require our generated .pc files to be installed in `$SAGE_LOCAL` to build properly.  Currently, one way around that is to add `$(PCFILES)` to the package's dependencies.  This is needed at the very least for numpy.

A different workaround might be to modify `PKG_CONFIG_PATH` to include .pc files in the source tree.  I have not tried that yet.

Issue created by migration from https://trac.sagemath.org/ticket/29003





---

archive/issue_comments_405855.json:
```json
{
    "body": "First attempt at this seems to work.\n\nI chose `src/lib/pkgconfig` as the path for .pc files to install from the source tree, as it has a nice congruence with `src/bin`.  But that was just a minor preference--this path could be anywhere in the source tree, or even outside it (e.g. for VPATH builds, should we ever get that working...)\n----\nNew commits:",
    "created_at": "2020-01-13T16:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405855",
    "user": "https://github.com/embray"
}
```

First attempt at this seems to work.

I chose `src/lib/pkgconfig` as the path for .pc files to install from the source tree, as it has a nice congruence with `src/bin`.  But that was just a minor preference--this path could be anywhere in the source tree, or even outside it (e.g. for VPATH builds, should we ever get that working...)
----
New commits:



---

archive/issue_comments_405856.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-13T16:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405856",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-13T17:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405857",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405858.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-13T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405858",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405859.json:
```json
{
    "body": "Replying to [comment:3 git]:\n> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n> ||[854c899](https://git.sagemath.org/sage.git/commit/?id=854c8990d99a88aac87b06bf385943d4382d0c2f)||`Trac #29003: Create generated .pc files in the source tree and install them later instead of creating them directly in SAGE_LOCAL`||\n> ||[62ac3cc](https://git.sagemath.org/sage.git/commit/?id=62ac3cc3bef11cdfdde88cfad9b5e594c94cfc78)||`Trac #29003: Also output generated gsl.pc to SAGE_SRC`||\n> ||[e59f991](https://git.sagemath.org/sage.git/commit/?id=e59f9912f91f0033d0f4a73d165212b4a373311f)||`Trac #29003: Instead of making individual packages responsible for .pc files being installed, just include them as part of the standard 'toolchain'`||\n\nI think the approach in this version might be simplest, and is closer to the existing behavior.  The major difference now is that actually copying `.pc` files into `$SAGE_LOCAL` is deferred until `make` is run, rather than writing to `$SAGE_LOCAL` directly when running `configure`.",
    "created_at": "2020-01-13T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405859",
    "user": "https://github.com/embray"
}
```

Replying to [comment:3 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[854c899](https://git.sagemath.org/sage.git/commit/?id=854c8990d99a88aac87b06bf385943d4382d0c2f)||`Trac #29003: Create generated .pc files in the source tree and install them later instead of creating them directly in SAGE_LOCAL`||
> ||[62ac3cc](https://git.sagemath.org/sage.git/commit/?id=62ac3cc3bef11cdfdde88cfad9b5e594c94cfc78)||`Trac #29003: Also output generated gsl.pc to SAGE_SRC`||
> ||[e59f991](https://git.sagemath.org/sage.git/commit/?id=e59f9912f91f0033d0f4a73d165212b4a373311f)||`Trac #29003: Instead of making individual packages responsible for .pc files being installed, just include them as part of the standard 'toolchain'`||

I think the approach in this version might be simplest, and is closer to the existing behavior.  The major difference now is that actually copying `.pc` files into `$SAGE_LOCAL` is deferred until `make` is run, rather than writing to `$SAGE_LOCAL` directly when running `configure`.



---

archive/issue_comments_405860.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-14T11:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405860",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405861.json:
```json
{
    "body": "testing",
    "created_at": "2020-01-14T12:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405861",
    "user": "https://github.com/dimpase"
}
```

testing



---

archive/issue_comments_405862.json:
```json
{
    "body": "OK, good, thanks!",
    "created_at": "2020-01-14T14:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405862",
    "user": "https://github.com/dimpase"
}
```

OK, good, thanks!



---

archive/issue_comments_405863.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-14T14:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405863",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405864.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-20T21:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405864",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_405865.json:
```json
{
    "body": "there is sometimes a permission problem, shouldn't that `cp -P` used to install these things be replaced by something more robust. \n\nsee e.g. #29071#comment:8",
    "created_at": "2020-01-24T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405865",
    "user": "https://github.com/dimpase"
}
```

there is sometimes a permission problem, shouldn't that `cp -P` used to install these things be replaced by something more robust. 

see e.g. #29071#comment:8



---

archive/issue_comments_405866.json:
```json
{
    "body": "by right, these *.pc files are package data, so they ought to be treated as such, no?",
    "created_at": "2020-01-24T12:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405866",
    "user": "https://github.com/dimpase"
}
```

by right, these *.pc files are package data, so they ought to be treated as such, no?



---

archive/issue_comments_405867.json:
```json
{
    "body": "$(PCFILES) must be cleanable, by `make clean` I guess.\nPleadse confirm. It caused a lot of pain on #29071",
    "created_at": "2020-01-26T12:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405867",
    "user": "https://github.com/dimpase"
}
```

$(PCFILES) must be cleanable, by `make clean` I guess.
Pleadse confirm. It caused a lot of pain on #29071



---

archive/issue_comments_405868.json:
```json
{
    "body": "the followup (cleaning of *.pc files) is on #29082",
    "created_at": "2020-01-26T12:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405868",
    "user": "https://github.com/dimpase"
}
```

the followup (cleaning of *.pc files) is on #29082



---

archive/issue_comments_405869.json:
```json
{
    "body": "... hotfix in #29121",
    "created_at": "2020-01-31T16:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28766#issuecomment-405869",
    "user": "https://github.com/mkoeppe"
}
```

... hotfix in #29121
