# Issue 27526: Perl packages for polymake

Issue created by migration from https://trac.sagemath.org/ticket/27763

Original creator: mkoeppe

Original creation time: 2019-05-03 09:47:53

CC:  dimpase jipilab lorenz@math.tu-berlin.de kastner@math.tu-berlin.de paffenholz@mathematik.tu-darmstadt.de

To simplify installation of polymake, we add some required CPAN packages.


---

Comment by dimpase created at 2019-05-07 11:10:51

I'd suggest to have appropriate `spkg-configure.m4`, to avoid installing extra...

By the way, could you provide  `spkg-configure.m4` for `perl_term_readline_gnu`, and other already present as packages `polymake` deps (perl or not)?


---

Comment by mkoeppe created at 2019-05-07 11:13:37

Do you have a suggestion how to install these CPAN packages if they are not available?
There seems to be a large number of dependencies that each of the listed packages pulls in -- but probably many are "standard" on any system that has perl installed.


---

Comment by dimpase created at 2019-05-07 11:26:22

I don't know much about perl. Does it have anything analogous to Python's pip, which allows direct installation from the net (from CPAN, I guess) ?


---

Comment by mkoeppe created at 2019-05-07 11:30:21

Yes, the `cpan` program does the equivalent of `pip`.


---

Comment by dimpase created at 2019-05-07 11:33:23

I tried something like `perl -MCPAN -e 'install XML::Writer'` but it seems to want to install stuff into `/usr/local` rather than `$SAGE_LOCAL`.
Do you know how to set all this up properly?


---

Comment by mkoeppe created at 2019-05-07 11:56:06

I have only used  `cpan -i`, which asks whether to install system wide or in the user's home directory.
Here's some info: https://stackoverflow.com/questions/540640/how-can-i-install-a-cpan-module-into-a-local-directory

I used something like this for `perl_term_readline_gnu`, but this is not going through cpan.


---

Comment by dimpase created at 2019-05-07 12:59:40

I don't know, it seems one needs to setup some `local::lib` magic, otherwise I keep getting errors trying to to install into `/usr/local`.

`local::lib` is a Perl module that apparently allows one to use non-standard directories for module installation, it might not be in by default (e.g. it's not in Gentoo, one needs to install it).

Anyhow - for checking in autoconf which perl modules are installed, one can use [AX_PROG_PERL_MODULES](https://www.gnu.org/software/autoconf-archive/ax_prog_perl_modules.html)


---

Comment by dimpase created at 2019-05-07 16:10:38

I also had to install `File::Slurp` perl module. Fortunately on Gentoo there seems to be an (almost?) 1-to-1 correspondence between perl packages named `X::Y` and Gentoo packages named `X-Y`.

I also see

```
File "src/sage/interfaces/polymake.py", line 884, in sage.interfaces.polymake.Polymake._eval_line
Failed example:
    c                                 # optional - polymake
Expected:
    cube of dimension 15
Got:
    1
    print ref(@SAGE590);
    print reftype(@SAGE590);
**********************************************************************
File "src/sage/interfaces/polymake.py", line 886, in sage.interfaces.polymake.Polymake._eval_line
Failed example:
    c.N_VERTICES                      # optional - polymake
Expected:
    32768
Got:
    Member function 'N_VERTICES' of  object
```



---

Comment by mkoeppe created at 2019-05-07 16:14:09

Replying to [comment:9 dimpase]:
> I also had to install `File::Slurp` perl module.

Yes, this is already mentioned in `polymake/SPKG.txt`

>  Fortunately on Gentoo there seems to be an (almost?) 1-to-1 correspondence between perl packages named `X::Y` and Gentoo packages named `X-Y`.
> 
> I also see
> {{{
> File "src/sage/interfaces/polymake.py", line 884, in sage.interfaces.polymake.Polymake._eval_line
> Failed example:
>     c                                 # optional - polymake
> Expected:
>     cube of dimension 15
> Got:
>     1
>     print ref(`@`SAGE590);
>     print reftype(`@`SAGE590);
> **********************************************************************
> File "src/sage/interfaces/polymake.py", line 886, in sage.interfaces.polymake.Polymake._eval_line
> Failed example:
>     c.N_VERTICES                      # optional - polymake
> Expected:
>     32768
> Got:
>     Member function 'N_VERTICES' of  object
> }}}
With which version of polymake is this? The 3.4 upgrade ticket has fixes for something like this.


---

Comment by dimpase created at 2019-05-07 16:17:52

If I do

```
--- a/src/sage/interfaces/polymake.py
+++ b/src/sage/interfaces/polymake.py
@@ -874,10 +874,6 @@ class Polymake(ExtraTabCompletion, Expect):
         sometimes it hangs, and therefore we remove it from the tests, for now::
 
             sage: c = polymake.cube(15)             # optional - polymake
-            sage: polymake.eval('print {}->F_VECTOR;'.format(c.name()), timeout=1) # optional - polymake # not tested
-            Traceback (most recent call last):
-            ...
-            RuntimeError: Polymake fails to respond timely
 
         We verify that after the timeout, polymake is still able to give answers::
 
```

then the tests pass, so the timeout thing seems to be doing more harm than good.


---

Comment by dimpase created at 2019-05-07 16:18:54

I am testing this branch, so 3.4.


---

Comment by dimpase created at 2019-05-07 16:21:58

oops, sorry, wrong ticket. This is meant to be about polymake update to 3.4


---

Comment by mkoeppe created at 2019-05-07 16:22:27

yes, #24905.


---

Comment by dimpase created at 2019-05-07 18:42:18

Please see #27795 for using system's perm package `Term::ReadLine::Gnu`


---

Comment by dimpase created at 2019-05-11 10:48:27

How about adding checks for all the needed perl packages in the style of #27795 to polymake itself?
Actually, it would be easier (per package), as `Term::ReadLine::Gnu` is non-standard in the sense one cannot just `use` it.

As usual, they pay a usability price by not using autotools :-)


---

Comment by mkoeppe created at 2019-05-11 11:36:14

Replying to [comment:17 dimpase]:
> How about adding checks for all the needed perl packages in the style of #27795 to polymake itself?

polymake itself does check for the packages needed at build time in its configure script.
The MongoDB package is checked at run time of polymake for the optional polyDB feature.


---

Comment by mkoeppe created at 2019-05-11 11:57:15

The challenge in this ticket is to make the installation of missing Perl packages not depend on internet access.
Here's a possible approach.

First install `App::cpanminus`. 
Then 

```
cpanm --local-lib-contained $PERL_LOCAL_LIB_ROOT --exclude-vendor --save-dists $PARTIAL_CPAN_MIRROR XML::Writer XML::LibXML XML::LibXSLT File::Slurp Term::ReadLine::Gnu JSON SVG MongoDB
```

will (1) download and install these prerequisites in $PERL_LOCAL_LIB_ROOT,
(2) save the source packages in a directory tree $PARTIAL_CPAN_MIRROR.

These are 58 packages, a total of 5 MB of source archives, which we can pack up as the source tar ball of the new spkg `perl_cpan_polymake_prereq`. 

Then figure out how to install with plain `cpan` (not `cpanm`, which is not available out of the box on macOS) using this local partial CPAN mirror.


---

Comment by git created at 2019-05-11 13:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-13 20:38:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-13 20:43:42

Changing status from new to needs_review.


---

Comment by git created at 2019-05-13 21:50:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Attachment

Curious install log -> perl_term_readline_gnu


---

Comment by jipilab created at 2019-05-14 14:59:59

After I did install successfully polymake, the interface was broken (compile error of some sort). And tab completion did not work. Then I saw that `perm_term_readline_gnu` experimental package was not installed (although it seems like the configure step of the installation detected the local package but seemed like it can not use the local package).

Does that make sense? Unfortunately, I can not offer more traceback, I reached the end of my terminal buffer.

If needed, I could try to proceed similarly on a twin computer to see if I can reproduce this.


---

Comment by dimpase created at 2019-05-14 15:54:24

By `local package` you mean `system package`, right?

Can you uninstall Sage's `perm_term_readline_gnu` and then in terminal run

```
perl -e "use Term::ReadLine; Term::ReadLine->get_all_function_names" 
```

 - there should be no output if `perm_term_readline_gnu` is installed, and an error message otherwise.


---

Comment by dimpase created at 2019-05-14 15:56:53

Also, run ./configure and see whether you have

```
    perl_term_readline_gnu-1.35 will not be installed (configure check)
```

in the output


---

Comment by mkoeppe created at 2019-05-14 21:51:02

I think it's possible that the system's `Term::ReadLine::Gnu` becomes unusable in the sage environment if sage installs its own libreadline. If for some reason we install our own libreadline, then we should probably also install `Term::ReadLine::Gnu`.


---

Comment by mkoeppe created at 2019-05-14 21:54:29

Or we could just revert #27795.


---

Comment by dimpase created at 2019-05-15 06:40:53

when I wrote #27795 I was under impression that perl is isolated from sage's "vendored madness" libraries, as it is an independent executable, just like, say, bash.

if the problem is indeed as you described then the right way forward is to get #27277 reviewed and merged.then readline wont get built if it is available.


---

Comment by git created at 2019-05-15 09:16:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-15 09:16:53

Adding #27803 dependency to prevent merge conflict.


---

Comment by mkoeppe created at 2019-05-15 09:21:15

Replying to [comment:32 dimpase]:
> when I wrote #27795 I was under impression that perl is isolated from sage's "vendored madness" libraries, as it is an independent executable, just like, say, bash.

Yes, the Perl executable is fine, but the myriad of CPAN packages link to lots of libraries.

> if the problem is indeed as you described then the right way forward is to get #27277 reviewed and merged.then readline wont get built if it is available.

OK.


---

Comment by dimpase created at 2019-05-15 09:29:03

Replying to [comment:35 mkoeppe]:
> Replying to [comment:32 dimpase]:
> > when I wrote #27795 I was under impression that perl is isolated from sage's "vendored madness" libraries, as it is an independent executable, just like, say, bash.
> 
> Yes, the Perl executable is fine, but the myriad of CPAN packages link to lots of libraries.

yes, I understand this, but I imagine the only conflicts of this sort are possible if you run polymake as a python extension, that loads a wrong dll at runtime.

As I don't know how the polymake interface works, I can't tell whether this is the case.

In any case, could you explain where these *.so parts of perl packages may be found, so that I can look at them with ldd/otool ?


---

Comment by dimpase created at 2019-05-15 09:57:41

If there is indeed a possible problem like this, build/pkgs/perl_term_readline_gnu/spkg-configure.m4 needs to be modified to include a check for readline.

I would actually be more worried about a potential conflict between an incompatible readline library, say, on OSX, and the one built by Sage (or provided by Homebrew/MacPorts)...


---

Comment by jipilab created at 2019-05-16 08:19:50

Replying to [comment:29 dimpase]:
> Also, run ./configure and see whether you have
> {{{
>     perl_term_readline_gnu-1.35 will not be installed (configure check)
> }}}
> in the output

Yes, I met `system package`.

Ok, so here is the outcome.

I ran the command 

`perl -e "use Term::ReadLine; Term::ReadLine->get_all_function_names"`

before uninstalling `perl_term_readline_gnu`: No output.

After uninstalling (inside of sage shell using the `sage-spkg-uninstall` command) I still get no output.

Things now seems to work flawlessly using the interface though.

Running `./configure`, I do check the `(configure check)`.

Ok, so now it seems to catch the system `Term ReadLine`. I believe I know how it happened: I did install the perl libraries using `cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp JSON SVG` as the `sage -info polymake` suggested, but then, the installation of the polymake package was not preceeded by a rerun of `./configure` to catch the libraries that are now meanwhile to be found in my PATH? Somehow Sage still relied on its own `perl_term_readline_gnu` although the system one was found so it did not install the dependency. Weird.

If I run it on a clean computer, without the spkg `perl_term_readline_gnu` (and without any installation of the required perl libraries) I do get the error message (that now looks quite familiar to the one I was getting in Sage originally).

Ok, so in the end, I do not think there is an issue: I'll test it on fresh untouched debian machines to have a clean feedback.


---

Comment by dimpase created at 2019-05-16 08:52:33

Isn't the presence of `local::lib` module a pre-req for all these package installations to function?


---

Comment by dimpase created at 2019-05-16 09:11:12

Replying to [comment:38 jipilab]:
> Replying to [comment:29 dimpase]:
> > Also, run ./configure and see whether you have
> > {{{
> >     perl_term_readline_gnu-1.35 will not be installed (configure check)
> > }}}
> > in the output
> 
> Yes, I met `system package`.
> 
> Ok, so here is the outcome.
> 
> I ran the command 
> 
> `perl -e "use Term::ReadLine; Term::ReadLine->get_all_function_names"`
> 
> before uninstalling `perl_term_readline_gnu`: No output.
> 
> After uninstalling (inside of sage shell using the `sage-spkg-uninstall` command) I still get no output.
> 
> Things now seems to work flawlessly using the interface though.
> 
> Running `./configure`, I do check the `(configure check)`.
> 
> Ok, so now it seems to catch the system `Term ReadLine`. I believe I know how it happened: I did install the perl libraries using `cpan -i XML::Writer XML::LibXML XML::LibXSLT File::Slurp JSON SVG` as the `sage -info polymake` suggested, but then, the installation of the polymake package was not preceeded by a rerun of `./configure` to catch the libraries that are now meanwhile to be found in my PATH? Somehow Sage still relied on its own `perl_term_readline_gnu` although the system one was found so it did not install the dependency. Weird.

well, this is by (somewhat unfortunate) design. Once you updated ./configure by installing/updating a `spkg-configure.m4` file in build/pkgs/foo/
and you have foo installed in Sage and as a system package, the only way to switch from Sage-installed to system foo is to manually uninstall Sage's foo, and then re-run configure (othewise configure would check, and succeed in this, for Sage's foo first).

The main reason for that that some people do not want to retire the old `sage -f foo` as a way to install/update a package, see e.g. #27373...


---

Comment by jipilab created at 2019-05-16 09:48:32

> well, this is by (somewhat unfortunate) design. Once you updated ./configure by installing/updating a `spkg-configure.m4` file in build/pkgs/foo/
> and you have foo installed in Sage and as a system package, the only way to switch from Sage-installed to system foo is to manually uninstall Sage's foo, and then re-run configure (othewise configure would check, and succeed in this, for Sage's foo first).
> 
> The main reason for that that some people do not want to retire the old `sage -f foo` as a way to install/update a package, see e.g. #27373...
> 
Oh I see now. Got it! Good to know.


---

Comment by mkoeppe created at 2019-05-16 13:44:23

Replying to [comment:39 dimpase]:
> Isn't the presence of `local::lib` module a pre-req for all these package installations to function?

For installing the modules, yes. But the `cpanm` script is fatpacked with all its prerequisite libraries, including `local::lib`.

For using the modules, no. We just modify the environment variable `PERL5LIB`.


---

Comment by dimpase created at 2019-05-16 14:16:21

surely, `local::lib` is an installation tool, but can you install it into system wide perl without root access?


---

Comment by mkoeppe created at 2019-05-16 14:30:15

Replying to [comment:43 dimpase]:
> surely, `local::lib` is an installation tool, but can you install it into system wide perl without root access?

A user would install local::lib into their local library by "bootstrapping" https://metacpan.org/pod/local::lib#The-bootstrapping-technique

But this is not relevant for us.


---

Comment by dimpase created at 2019-05-16 16:21:12

I don't see how the `local::lib` thing is not relevant - one either has to say that it is a pre-req, or do that bootstrapping here.


---

Attachment

failed install of cpan perl packages on mac


---

Comment by @sophiasage created at 2019-05-16 17:16:38

I have attached a log of the failed installation of the cpan perl packages after doing the following steps:

 - pulled the branch on this ticket
 - downloaded the tarball from this ticket and placed it in upstream folder 
 - typed `make build`
 - typed `./sage -i polymake`

Should I have followed a different procedure to test the installation on mac os mojave?


---

Comment by mkoeppe created at 2019-05-17 04:11:06

Replying to [comment:45 dimpase]:
> I don't see how the `local::lib` thing is not relevant - one either has to say that it is a pre-req, or do that bootstrapping here. 
It's already solved on this ticket by shipping the self contained cpanm script. 
It is not needed as a prerequisite.


---

Attachment

The file `perl_packages.log` describes a similar failure on debian stretch when getting to MongoDB.


---

Attachment

Failure on debian stretch


---

Comment by jipilab created at 2019-05-17 09:28:28

It seems that there are still some dependencies missing.


---

Comment by mkoeppe created at 2019-05-17 11:19:10

Replying to [comment:46 gh-sophiasage]:
> I have attached a log of the failed installation of the cpan perl packages after doing the following steps:
> 
>  - pulled the branch on this ticket
>  - downloaded the tarball from this ticket and placed it in upstream folder 
>  - typed `make build`
>  - typed `./sage -i polymake`
> 
> Should I have followed a different procedure to test the installation on mac os mojave? 

Thanks for testing! This is the correct procedure. 

The relevant failure from your test on Mac is this one:

```
225	Building and testing Type-Tiny-1.004004 ... ! Installing Types::Standard failed. See /Users/sophiaelia/.cpanm/work/1558026103.94179/build.log for details. Retry with --force to force install it.
226	FAIL
```

I have seen something similar on Mac as well. Could you send the build log mentioned above?


---

Comment by mkoeppe created at 2019-05-17 11:21:45

Replying to [comment:49 jipilab]:
> It seems that there are still some dependencies missing.

The relevant failure on the Debian installs is this one:

```
40	Configuring MongoDB-v2.0.3 ... ! Finding BSON::XS (0.006000) on mirror file:///home/jplabbe/sage/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-13/src/sagepan failed.
41	! Couldn't find module or a distribution BSON::XS (0.006000)
```



---

Attachment

build.log file from failed installation of cpan perl packages on mac


---

Comment by mkoeppe created at 2019-05-17 11:58:45

Thank you!
The problem on macOS seems to come from a well known problem with `Module::Runtime`. https://www.perlmonks.org/?node_id=1083777


---

Comment by git created at 2019-05-17 18:01:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-17 18:02:30

I have made a more robust version of the `spkg-src` script, which (hopefully!) makes sure to pack up all dependencies (instead of picking some up from the local installation) and also addresses the `Module::Runtime` version problem on macOS.

To test, first get rid of the Perl library installation in $SAGE_LOCAL and then reinstall the packages:

```
  rm -rf local/lib/perl5
  ./sage -f  perl_cpan_polymake_prereq perl_term_readline_gnu
```



---

Attachment


---

Comment by git created at 2019-05-17 18:53:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-19 11:11:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-19 21:02:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by git created at 2019-05-19 21:24:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-19 22:25:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-19 23:04:04

Ready for another round of testing. Works for me on macOS Mojave and on a CentOS Linux release 7.6.1810 with almost no Perl stuff installed.


---

Comment by @sophiasage created at 2019-05-21 12:26:52

failed installation of polymake on mac


---

Attachment

I have attached a log of a failed installation of polymake on macOS Mojave after pulling this ticket and doing the following steps.

  - pulled the branch on this ticket
  - downloaded the tarball perl_cpan_polymake_prereq-2019-05-19.tar.gz and put it in the upstream folder
  - in upstream folder typed `rm perl_cpan_polymake_prereq_2019_05_13.tar.gz`
  - in my sage directory typed `make build`
  - typed `./sage -f perl_term_readline_gnu`
  - typed `./sage -i polymake`

perl_cpan_polymake_prereq-2019-05-19 installed successfully.


---

Comment by dimpase created at 2019-05-21 12:53:50

Replying to [comment:63 gh-sophiasage]:
> I have attached a log of a failed installation of polymake on macOS Mojave after pulling this ticket and doing the following steps.
> 
>   - pulled the branch on this ticket
>   - downloaded the tarball perl_cpan_polymake_prereq-2019-05-19.tar.gz and put it in the upstream folder
>   - in upstream folder typed `rm perl_cpan_polymake_prereq_2019_05_13.tar.gz`

why would you download the file, and then delete it? A typo?

>   - in my sage directory typed `make build`
>   - typed `./sage -f perl_term_readline_gnu`
>   - typed `./sage -i polymake`
> 
> perl_cpan_polymake_prereq-2019-05-19 installed successfully.

I wonder why you have C++14 in your CXXFLAGS.
Do you by any chance have CXXFLAGS environment variable set to something non-empty?

>


---

Comment by mkoeppe created at 2019-05-21 13:15:48

Try deleting the installed polymake headers in local/include first.
Looks like they are taking precedence in the compilation - this looks like a bug in the polymake build scripts


---

Comment by mkoeppe created at 2019-05-21 13:17:21

Replying to [comment:64 dimpase]:
> Replying to [comment:63 gh-sophiasage]:
> > I have attached a log of a failed installation of polymake on macOS Mojave after pulling this ticket and doing the following steps.
> > 
> >   - pulled the branch on this ticket
> >   - downloaded the tarball perl_cpan_polymake_prereq-2019-05-19.tar.gz and put it in the upstream folder
> >   - in upstream folder typed `rm perl_cpan_polymake_prereq_2019_05_13.tar.gz`
> 
> why would you download the file, and then delete it? A typo?

Old version deleted


---

Comment by @sophiasage created at 2019-05-21 15:29:16

Replying to [comment:65 mkoeppe]:
> Try deleting the installed polymake headers in local/include first.
> Looks like they are taking precedence in the compilation - this looks like a bug in the polymake build scripts
It worked!!


---

Comment by mkoeppe created at 2019-05-21 17:44:37

Thanks for testing!
I have updated the install scripts to take care of uninstallation in #27855.


---

Comment by mkoeppe created at 2019-05-30 00:56:03

Any takers for the review of this ticket?


---

Comment by dimpase created at 2019-05-30 06:32:53

I am on vacation until 4 June, can’t possibly do it before.


---

Comment by mkoeppe created at 2019-06-03 18:46:42

Perhaps `Term::ReadKey` should be added as well.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by jipilab created at 2019-09-03 18:53:28

Replying to [comment:70 mkoeppe]:
> Any takers for the review of this ticket?

We'll resume our Friday morning's sage session soon. We'll be able to test it on a few virgin machines to test the robustness of installation...


---

Comment by jhpalmieri created at 2019-11-01 17:58:01

First, I'm getting a merge conflict with the latest version of Sage.

Second, the build is failing for me with OS X 10.14.6. The log file (with some boring lines snipped):

```
Found local metadata for perl_cpan_polymake_prereq-2019-05-19
Using cached file /Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/upstream/perl_cpan_polymake_prereq-2019-05-19.tar.gz
perl_cpan_polymake_prereq-2019-05-19
====================================================
Setting up build directory for perl_cpan_polymake_prereq-2019-05-19
Finished extraction
No patch files found in ../patches
****************************************************
Host system:
Darwin jpalmieri138.local 18.7.0 Darwin Kernel Version 18.7.0: Tue Aug 20 16:57:14 PDT 2019; root:xnu-4903.271.2~2/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Configured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 11.0.0 (clang-1100.0.33.12)
Target: x86_64-apple-darwin18.7.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
****************************************************
Package 'perl_cpan_polymake_prereq' is currently not installed
No legacy uninstaller found for 'perl_cpan_polymake_prereq'; nothing to do
cpanm (App::cpanminus) 1.7044 on perl 5.018004 built for darwin-thread-multi-2level
Work directory is /Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/src/cpanm_home/work/1572630684.99164
You have make /usr/bin/make
You have LWP 6.05
You have /usr/bin/tar: bsdtar 2.8.3 - libarchive 2.8.3
You have /usr/bin/unzip
Entering /Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/stage1
Running Makefile.PL
--> Working on .
Configuring /Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/stage1 ... Warning: prerequisite Moose 2.2 not found. We have 2.1202.
Writing Makefile for PolymakeStage1
Writing MYMETA.yml and MYMETA.json
Checking dependencies from MYMETA.json ...
Checking if you have ExtUtils::MakeMaker 0 ... Yes (6.66)
Checking if you have Moose 2.2 ... No (2.1202 < 2.2)
Searching Moose on mirror file:///Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/src/sagepan ...
Downloading index file file:///Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/src/sagepan/modules/02packages.details.txt.gz ...
Uncompressing index file...
Unpacking Moose-2.2011.tar.gz
OK
==> Found dependencies: Moose
--> Working on Moose
Fetching file:///Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/src/sagepan/authors/id/E/ET/ETHER/Moose-2.2011.tar.gz ... OK
x Moose-2.2011/
x Moose-2.2011/author/
...
  [snip]
...
x Moose-2.2011/author/doc-generator
x Moose-2.2011/author/extract-inline-tests
x Moose-2.2011/author/find-dupe-test-numbers
Entering Moose-2.2011
Checking configure dependencies from META.json
Checking if you have ExtUtils::MakeMaker 6.58 ... Yes (6.66)
Checking if you have Dist::CheckConflicts 0.02 ... Yes (0.10)
Running Makefile.PL
Configuring Moose-2.2011 ... HASCOMPILERJXuX/TESTGBHw.c:2:10: fatal error: 'EXTERN.h' file not found
#include "EXTERN.h"
         ^~~~~~~~~~
1 error generated.
Couldn't execute gcc  -g -pipe -fno-common -DPERL_DARWIN -fno-strict-aliasing -fstack-protector -Os "-I/System/Library/Perl/5.18/darwin-thread-multi-2level/CORE"   -c HASCOMPILERJXuX/TESTGBHw.c -o HASCOMPILERJXuX/TESTGBHw.o: Inappropriate ioctl for device at Makefile.PL line 12.
This distribution requires a working compiler at Makefile.PL line 12.
! Configure failed for Moose-2.2011. See /Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-9.0.beta3/local/var/tmp/sage/build/perl_cpan_polymake_prereq-2019-05-19/src/cpanm_home/work/1572630684.99164/build.log for details.
! Installing the dependencies failed: Installed version (2.1202) of Moose is not in range '2.2'
! Bailing out the installation for PolymakeStage1-0.
N/A

real	0m0.905s
user	0m0.561s
sys	0m0.291s
************************************************************************
Error installing package perl_cpan_polymake_prereq-2019-05-19
************************************************************************
```



---

Comment by git created at 2019-11-18 15:27:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-11-19 01:48:53

Replying to [comment:76 jhpalmieri]:
> the build is failing for me with OS X 10.14.6. 
> {{{
> Configuring Moose-2.2011 ... HASCOMPILERJXuX/TESTGBHw.c:2:10: fatal error: 'EXTERN.h' file not found
> #include "EXTERN.h"
>          ^~~~~~~~~~
> 1 error generated.
> }}}

From `sage -info polymake`:

```
On Mac OS X, to build Term::Readline::Gnu, on macOS 10.14 (Mojave), one
needs to do the following:

 sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg -target /

or a "fatal error: 'EXTERN.h' file not found" will be signalled.
```



---

Comment by jhpalmieri created at 2019-11-19 03:50:58

I think that you shouldn't have the build fail; you should instead test for the headers and provide a helpful error message if they're not present. I doubt that most users will know to use `sage -info polymake`.

Also, the error message is out-of-date: the current version of OS X is 10.15, and there is no directory `Packages` in `/Library/Developer/CommandLineTools/`.


---

Comment by mkoeppe created at 2019-11-19 04:02:32

Yes, I agree, this needs a better solution.


---

Comment by mkoeppe created at 2019-11-22 18:24:45

Some references for the EXTERN.h problem on macOS Mojave and newer:
- MAC Perl `EXTERN.H` Make Issues
  https://www.perlmonks.org/?node_id=1224716

- json - `Fatal error: 'EXTERN.h' file not found` while installing Perl modules - Stack Overflow
  https://stackoverflow.com/questions/52682304/fatal-error-extern-h-file-not-found-while-installing-perl-modules

- Bug #127028 for `ExtUtils-MakeMaker`: Unable to build on OSX Mojave
  https://rt.cpan.org/Public/Bug/Display.html?id=127028

-  gist:a322f420b1ad92fec70d88144885fa49
  https://gist.github.com/skaji/a322f420b1ad92fec70d88144885fa49


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by jipilab created at 2020-02-04 15:57:08

After a clean installation of 9.1.beta2, running `sage -i polymake` finishes with success and installs both

 - perl_cpan_polymake_prereq...............2019-05-19 (2019-05-19)
 - perl_term_readline_gnu..................1.35 (1.35)

Now, trying out polymake in sage essentially does not work...

 - Tab completion on `polymake.` does not work (which is an improvement, before it used to kill sage)
 - If I type `c = polytopes.cube(backend='polymake')` it simply never finishes. Thought I can kill it succesfully with ctrl+c.

Starting sage anew and trying:
 - `p = Polyhedron(vertices= [[0],[1]],backend='polymake')` also simply never gives back the prompt.

Without starting sage anew, if I simply repeat the previous operation, I get directly:


```
Traceback (most recent call last):
TypeError: argument should be integer or bytes-like object, not 'str'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
...

/home/jplabbe/sage/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    718                 self._name = parent._create(value, name=name)
    719             except (TypeError, RuntimeError, ValueError) as x:
--> 720                 raise TypeError(x)
    721 
    722     def _latex_(self):

TypeError: error evaluating "@SAGE1=("Rational");":
argument should be integer or bytes-like object, not 'str'
```



...

*That said*, I have to mention that I do not have jupymake installed which is an optional package:

jupymake................................0.9 (not_installed)

I wanted to try a simple "sage -i polymake" from a virgin install to see how it would perform...

My os is debian-buster. As far as the installation goes, it seems that polymake runs fine under `sage -polymake`...


---

Comment by jipilab created at 2020-02-04 16:07:16

On another debian-buster I get an error in the installation. Relevant log attached.


---

Comment by jipilab created at 2020-02-04 16:09:07

polymake installation failing on debian-buster


---

Attachment

Replying to [comment:85 jipilab]:
> On another debian-buster I get an error in the installation. Relevant log attached.

Turns out the same failure happens on current develop. So it's not related to this ticket necessarily. (This machine is from the department, we just got a new os update, so we are less aware of the default installations)


---

Comment by git created at 2020-03-17 00:25:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-17 00:25:47

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2020-03-17 09:31:02

Let me know when this is good to be tested: turns out, I might have more time now for testing(!)...


---

Comment by mkoeppe created at 2020-04-14 06:38:06

pushing these forward to 9.2


---

Comment by git created at 2020-04-25 20:56:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-25 21:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-25 22:51:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-25 22:52:28

NOT ready for new tests.


---

Comment by jipilab created at 2020-05-11 14:25:22

Replying to [comment:95 mkoeppe]:
> NOT ready for new tests.

Ok, just I'll wait until you change the flag to needs review and then I could run some installation tests.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
