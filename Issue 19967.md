# Issue 19967: problems with constructing or converting to SymPy expressions

archive/issues_019967.json:
```json
{
    "body": "CC:  @mforets @man74cio\n\nIn the Sympy-1.0 upgrade the `UndefinedFunction._sage_` method is patched away to enable the important upgrade. This function was planned to resolve part of #14723 but uncovers missing functionality in the coercion system, and probably with symbolics. The following doctest in french_book fails if `UndefinedFunction._sage_` is defined:\n\n```\n  sage: from sympy import Function, Symbol\n  sage: u = Function('u'); n = Symbol('n', integer=True)\n  sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\nNotimplementedError\n```\n\n\ntscrim found the minimal cases:\n> {{{\n> sage: f = function('f')\n> sage: x = var('x')\n> sage: sympy.sympify(f(x), evaluate=False)\n> f(x)\n> sage: sympy.sympify(3*f(x), evaluate=False)\n> AttributeError: 'Call' object has no attribute 'id'\n> }}}\n> However, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:\n> {{{\n> sage: f._sympy_()\n> sage: f(x)._sympy_()\n> sage: (f(x)+3)._sympy_()\n> }}}\n\nThis means that Sympy-1.0 probably only uncovered already existing problems in expression conversion. This ticket should remove the patch in `build/pkgs/sympy` and resolve all mentioned problems.\n\nSee #20185 for all previous discussion on this.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20204\n\n",
    "created_at": "2016-03-14T07:50:14Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "problems with constructing or converting to SymPy expressions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19967",
    "user": "https://github.com/rwst"
}
```
CC:  @mforets @man74cio

In the Sympy-1.0 upgrade the `UndefinedFunction._sage_` method is patched away to enable the important upgrade. This function was planned to resolve part of #14723 but uncovers missing functionality in the coercion system, and probably with symbolics. The following doctest in french_book fails if `UndefinedFunction._sage_` is defined:

```
  sage: from sympy import Function, Symbol
  sage: u = Function('u'); n = Symbol('n', integer=True)
  sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
NotimplementedError
```


tscrim found the minimal cases:
> {{{
> sage: f = function('f')
> sage: x = var('x')
> sage: sympy.sympify(f(x), evaluate=False)
> f(x)
> sage: sympy.sympify(3*f(x), evaluate=False)
> AttributeError: 'Call' object has no attribute 'id'
> }}}
> However, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:
> {{{
> sage: f._sympy_()
> sage: f(x)._sympy_()
> sage: (f(x)+3)._sympy_()
> }}}

This means that Sympy-1.0 probably only uncovered already existing problems in expression conversion. This ticket should remove the patch in `build/pkgs/sympy` and resolve all mentioned problems.

See #20185 for all previous discussion on this.

Issue created by migration from https://trac.sagemath.org/ticket/20204





---

archive/issue_comments_274518.json:
```json
{
    "body": "Hi, any progress on this? We are currently NOT carrying Sage's sympy patch in Debian, so our Sage is running *without* this patch (and a few french book doctests break but we just ignore this).\n\nIn fact applying the patch, breaks some of sympy's own tests relating to Sage integration: https://github.com/sympy/sympy/pull/11858#issuecomment-308207891\n\nBTW you do not need to rebuild Sympy to apply or unapply this patch, just edit /usr/lib/python2.7/dist-packages/sympy/core/function.py or wherever the file is installed to. Then restart sage (if you're testing Sage) or python (if you're testing sympy).",
    "created_at": "2017-06-13T19:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274518",
    "user": "https://github.com/infinity0"
}
```

Hi, any progress on this? We are currently NOT carrying Sage's sympy patch in Debian, so our Sage is running *without* this patch (and a few french book doctests break but we just ignore this).

In fact applying the patch, breaks some of sympy's own tests relating to Sage integration: https://github.com/sympy/sympy/pull/11858#issuecomment-308207891

BTW you do not need to rebuild Sympy to apply or unapply this patch, just edit /usr/lib/python2.7/dist-packages/sympy/core/function.py or wherever the file is installed to. Then restart sage (if you're testing Sage) or python (if you're testing sympy).



---

archive/issue_comments_274519.json:
```json
{
    "body": "hi, i've experimented adding a fragment of #14723:\n\n\n```\n@@ -764,6 +764,9 @@ class SympyConverter(Converter):\n         if f_sympy:\n             return f_sympy(*sympy.sympify(g, evaluate=False))\n         else:\n\n+            from sage.symbolic.function_factory import SymbolicFunction\n+            if isinstance(ex.operator(), SymbolicFunction):\n+                return sympy.Function(str(f))(*g, evaluate=False)\n             raise NotImplementedError(\"SymPy function '%s' doesn't exist\" % f)\n```\n \n\nand adding the `_sympy_` method to the NewSymbolicFunction class:\n\n\n```\n@@ -67,6 +67,10 @@ def function_factory(name, nargs=0, latex_name=None, conversions=None,\n             \"\"\"\n             return \"'%s\"%self.name()\n\n+        def _sympy_(self):\n+            from sympy import Function\n+            return Function(self.name())\n```\n\n\nwith these changes, the conversions in this ticket's description work. does this go in the good direction or not? \n\nhowever, the round trip back to sage is broken:\n\n\n```\nsage: f = function('f')\nsage: type(f)\n<class 'sage.symbolic.function_factory.NewSymbolicFunction'>\nsage: fs = f._sympy_()\nsage: type(fs)\n<class 'sympy.core.function.UndefinedFunction'>\nsage: fs._sage_()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-9fb5fbad3003> in <module>()\n----> 1 fs._sage_()\n\nTypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)\n```\n\n\nand with a different error for a function with arguments:\n\n\n```\nsage: f = function('f')(x)\nsage: type(f)\n<type 'sage.symbolic.expression.Expression'>\nsage: fs = f._sympy_()\nsage: type(fs)\nf\nsage: fs._sage_()\n\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-5-9fb5fbad3003> in <module>()\n----> 1 fs._sage_()\n\n/Users/forets/sage-src/sage/local/lib/python2.7/site-packages/sympy/core/function.pyc in _sage_(self)\n    705         import sage.all as sage\n    706         fname = self.func.__name__\n--> 707         func = getattr(sage, fname)\n    708         args = [arg._sage_() for arg in self.args]\n    709         return func(*args)\n\nAttributeError: 'module' object has no attribute 'f'\n```\n",
    "created_at": "2017-06-23T09:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274519",
    "user": "https://github.com/mforets"
}
```

hi, i've experimented adding a fragment of #14723:


```
@@ -764,6 +764,9 @@ class SympyConverter(Converter):
         if f_sympy:
             return f_sympy(*sympy.sympify(g, evaluate=False))
         else:

+            from sage.symbolic.function_factory import SymbolicFunction
+            if isinstance(ex.operator(), SymbolicFunction):
+                return sympy.Function(str(f))(*g, evaluate=False)
             raise NotImplementedError("SymPy function '%s' doesn't exist" % f)
```
 

and adding the `_sympy_` method to the NewSymbolicFunction class:


```
@@ -67,6 +67,10 @@ def function_factory(name, nargs=0, latex_name=None, conversions=None,
             """
             return "'%s"%self.name()

+        def _sympy_(self):
+            from sympy import Function
+            return Function(self.name())
```


with these changes, the conversions in this ticket's description work. does this go in the good direction or not? 

however, the round trip back to sage is broken:


```
sage: f = function('f')
sage: type(f)
<class 'sage.symbolic.function_factory.NewSymbolicFunction'>
sage: fs = f._sympy_()
sage: type(fs)
<class 'sympy.core.function.UndefinedFunction'>
sage: fs._sage_()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-9fb5fbad3003> in <module>()
----> 1 fs._sage_()

TypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)
```


and with a different error for a function with arguments:


```
sage: f = function('f')(x)
sage: type(f)
<type 'sage.symbolic.expression.Expression'>
sage: fs = f._sympy_()
sage: type(fs)
f
sage: fs._sage_()

---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-5-9fb5fbad3003> in <module>()
----> 1 fs._sage_()

/Users/forets/sage-src/sage/local/lib/python2.7/site-packages/sympy/core/function.pyc in _sage_(self)
    705         import sage.all as sage
    706         fname = self.func.__name__
--> 707         func = getattr(sage, fname)
    708         args = [arg._sage_() for arg in self.args]
    709         return func(*args)

AttributeError: 'module' object has no attribute 'f'
```




---

archive/issue_comments_274520.json:
```json
{
    "body": "Replying to [comment:5 mforets]:\n> with these changes, the conversions in this ticket's description work. does this go in the good direction or not? \n\nLooks good.",
    "created_at": "2017-06-23T12:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274520",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:5 mforets]:
> with these changes, the conversions in this ticket's description work. does this go in the good direction or not? 

Looks good.



---

archive/issue_comments_274521.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-24T09:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274521",
    "user": "https://github.com/mforets"
}
```

New commits:



---

archive/issue_comments_274522.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-24T09:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274523.json:
```json
{
    "body": "for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.",
    "created_at": "2017-06-25T14:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274523",
    "user": "https://github.com/mforets"
}
```

for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.



---

archive/issue_comments_274524.json:
```json
{
    "body": "Replying to [comment:9 mforets]:\n> for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.\n\nYou mean how to delete a file from a git branch? use `git rm`.",
    "created_at": "2017-07-01T07:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274524",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:9 mforets]:
> for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.

You mean how to delete a file from a git branch? use `git rm`.



---

archive/issue_comments_274525.json:
```json
{
    "body": "Replying to [comment:10 rws]:\n> Replying to [comment:9 mforets]:\n> > for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.\n> \n> You mean how to delete a file from a git branch? use `git rm`.\n\nno; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage.. Anyway, I'll `git rm 01_undeffun_sage.patch` later today!",
    "created_at": "2017-07-01T08:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274525",
    "user": "https://github.com/mforets"
}
```

Replying to [comment:10 rws]:
> Replying to [comment:9 mforets]:
> > for the remaining part, this is supposed to be solved here? (*This ticket should remove the patch..* => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.
> 
> You mean how to delete a file from a git branch? use `git rm`.

no; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage.. Anyway, I'll `git rm 01_undeffun_sage.patch` later today!



---

archive/issue_comments_274526.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-01T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274526",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274527.json:
```json
{
    "body": "Replying to [comment:11 mforets]:\n> no; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage..\n\nYou get them with any git branch by piping the output of `git diff` into a file. OTOH you don't even need `git diff`. For example the SymPy PR patch mentioned in #22802 can be had by downloading `https://patch-diff.githubusercontent.com/raw/sympy/sympy/pull/12826.diff`, i.e. the PR link with `.diff` appended. That should work with any github commit.",
    "created_at": "2017-07-01T09:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274527",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:11 mforets]:
> no; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage..

You get them with any git branch by piping the output of `git diff` into a file. OTOH you don't even need `git diff`. For example the SymPy PR patch mentioned in #22802 can be had by downloading `https://patch-diff.githubusercontent.com/raw/sympy/sympy/pull/12826.diff`, i.e. the PR link with `.diff` appended. That should work with any github commit.



---

archive/issue_comments_274528.json:
```json
{
    "body": "OK and those patches get automatically applied into `/local/lib/...` upon rebuilding.\n\nI've tested the patch in question. It solves one out of the two cases from comment:5 :\n\n\n```\nsage: function('f')(x)._sympy_()._sage_()  # ok\nf(x)\nsage: function('f')._sympy_()._sage_()  # problem\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-7d5000a51aaa> in <module>()\n----> 1 function('f')._sympy_()._sage_()\n\nTypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)\n```\n\n\nIf we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?",
    "created_at": "2017-07-01T10:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274528",
    "user": "https://github.com/mforets"
}
```

OK and those patches get automatically applied into `/local/lib/...` upon rebuilding.

I've tested the patch in question. It solves one out of the two cases from comment:5 :


```
sage: function('f')(x)._sympy_()._sage_()  # ok
f(x)
sage: function('f')._sympy_()._sage_()  # problem
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-7d5000a51aaa> in <module>()
----> 1 function('f')._sympy_()._sage_()

TypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)
```


If we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?



---

archive/issue_comments_274529.json:
```json
{
    "body": "Replying to [comment:14 mforets]:\n> If we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?\n\nYes, conversion of SymPy objects is usually done by their member function `_sage_()`. That means SymPy source change.",
    "created_at": "2017-07-01T12:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274529",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:14 mforets]:
> If we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?

Yes, conversion of SymPy objects is usually done by their member function `_sage_()`. That means SymPy source change.



---

archive/issue_comments_274530.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-08-30T08:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274530",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_274531.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-30T08:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274531",
    "user": "https://github.com/mforets"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_274532.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2017-08-30T08:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274532",
    "user": "https://github.com/mforets"
}
```

Last 10 new commits:



---

archive/issue_comments_274533.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-03T12:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274533",
    "user": "https://github.com/mforets"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_274534.json:
```json
{
    "body": "essentially there is this problem:\n\n\n```\nsage: from sympy import Function, Symbol\nsage:  u = Function('u') ; n = Symbol('n', integer=True);\nsage: type(2+u(2))  # wrong\n<type 'sage.symbolic.expression.Expression'>\nsage: type(u(2)+2)\n<class 'sympy.core.add.Add'>\n```\n\n\nit gets fixed with the code in this comment: #23496#comment:65\n\ndo you agree?",
    "created_at": "2017-09-03T12:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274534",
    "user": "https://github.com/mforets"
}
```

essentially there is this problem:


```
sage: from sympy import Function, Symbol
sage:  u = Function('u') ; n = Symbol('n', integer=True);
sage: type(2+u(2))  # wrong
<type 'sage.symbolic.expression.Expression'>
sage: type(u(2)+2)
<class 'sympy.core.add.Add'>
```


it gets fixed with the code in this comment: #23496#comment:65

do you agree?



---

archive/issue_comments_274535.json:
```json
{
    "body": "After #24006 there is need for a rewrite which makes it all much simpler. I'll try that now.",
    "created_at": "2017-10-17T06:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274535",
    "user": "https://github.com/rwst"
}
```

After #24006 there is need for a rewrite which makes it all much simpler. I'll try that now.



---

archive/issue_comments_274536.json:
```json
{
    "body": "awesome. i started to read your code today, so i don't get too outdated :)",
    "created_at": "2017-10-17T06:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274536",
    "user": "https://github.com/mforets"
}
```

awesome. i started to read your code today, so i don't get too outdated :)



---

archive/issue_comments_274537.json:
```json
{
    "body": "I think the problem with `Function('f')` is that it returns a class not an object, and I'm not sure if we can put a `_sage_` method onto that.",
    "created_at": "2017-10-17T07:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274537",
    "user": "https://github.com/rwst"
}
```

I think the problem with `Function('f')` is that it returns a class not an object, and I'm not sure if we can put a `_sage_` method onto that.



---

archive/issue_comments_274538.json:
```json
{
    "body": "To document what happens in SymPy:\n\nWhen `F=Function('abc')` is called the constructor of `Function` uses the metaclass `UndefFunction` to create a new class with parent `AppliedUndef` named `abc`. Calling `F._sage_()` will NOT call the `_sage_()` member of `AppliedUndef` but tries to call `abc._sage_()` which does not exist at installation time. This, however, is not a problem because we can dynamically add a `_sage_()` method to `abc` on creation of `abc` inside `UndefFunction.__new__`. So converting abstract functions works.\n\nThe problem is that now `F(x)._sage_()` will call the same `abc._sage_()` while previously it was referred to the superclass, i.e. `AppliedUndef._sage_()`. But `_sage_` as class method does not know about the specific instance and its argument `x`.",
    "created_at": "2017-10-17T15:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274538",
    "user": "https://github.com/rwst"
}
```

To document what happens in SymPy:

When `F=Function('abc')` is called the constructor of `Function` uses the metaclass `UndefFunction` to create a new class with parent `AppliedUndef` named `abc`. Calling `F._sage_()` will NOT call the `_sage_()` member of `AppliedUndef` but tries to call `abc._sage_()` which does not exist at installation time. This, however, is not a problem because we can dynamically add a `_sage_()` method to `abc` on creation of `abc` inside `UndefFunction.__new__`. So converting abstract functions works.

The problem is that now `F(x)._sage_()` will call the same `abc._sage_()` while previously it was referred to the superclass, i.e. `AppliedUndef._sage_()`. But `_sage_` as class method does not know about the specific instance and its argument `x`.



---

archive/issue_comments_274539.json:
```json
{
    "body": "For the solution we will have to patch SymPy, not possible otherwise.",
    "created_at": "2017-10-17T15:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274539",
    "user": "https://github.com/rwst"
}
```

For the solution we will have to patch SymPy, not possible otherwise.



---

archive/issue_comments_274540.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-17T16:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274540",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274541.json:
```json
{
    "body": "The original examples all work now. I'll add them as doctests tomorrow.",
    "created_at": "2017-10-17T16:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274541",
    "user": "https://github.com/rwst"
}
```

The original examples all work now. I'll add them as doctests tomorrow.



---

archive/issue_comments_274542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-18T06:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274542",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274543.json:
```json
{
    "body": "Next, we'll work on the SymPy update, based on this ticket.",
    "created_at": "2017-10-18T06:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274543",
    "user": "https://github.com/rwst"
}
```

Next, we'll work on the SymPy update, based on this ticket.



---

archive/issue_comments_274544.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-18T06:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274544",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274545.json:
```json
{
    "body": "looks good to me. doctests in `src/sage/interfaces/sympy.py` pass and all (yes, all!) the issues in this ticket's description are solved. htmldoc is ok. let's wait that the patchbot changes the status..\n\nthe only oddity that i get (but maybe we shouldn't care?) is:\n\n\n```\nsage: from sympy import Function, Symbol\nsage: u = Function('u'); n = Symbol('n', integer=True)\nsage: type(u(2)+2)\n<class 'sympy.core.add.Add'>\nsage: type(2+u(2))\n<type 'sage.symbolic.expression.Expression'>\n```\n",
    "created_at": "2017-10-18T08:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274545",
    "user": "https://github.com/mforets"
}
```

looks good to me. doctests in `src/sage/interfaces/sympy.py` pass and all (yes, all!) the issues in this ticket's description are solved. htmldoc is ok. let's wait that the patchbot changes the status..

the only oddity that i get (but maybe we shouldn't care?) is:


```
sage: from sympy import Function, Symbol
sage: u = Function('u'); n = Symbol('n', integer=True)
sage: type(u(2)+2)
<class 'sympy.core.add.Add'>
sage: type(2+u(2))
<type 'sage.symbolic.expression.Expression'>
```




---

archive/issue_comments_274546.json:
```json
{
    "body": "I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use.\n\nAs to the patchbots they are unreliable at the moment. That segfault in matrix is curious but I can't reproduce it.",
    "created_at": "2017-10-18T15:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274546",
    "user": "https://github.com/rwst"
}
```

I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use.

As to the patchbots they are unreliable at the moment. That segfault in matrix is curious but I can't reproduce it.



---

archive/issue_comments_274547.json:
```json
{
    "body": "> I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use. \n\nOk.\n\nsince i cannot reproduce failures in my machine, let me set to positive review.. and thanks for fixing everything!!",
    "created_at": "2017-10-18T17:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274547",
    "user": "https://github.com/mforets"
}
```

> I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use. 

Ok.

since i cannot reproduce failures in my machine, let me set to positive review.. and thanks for fixing everything!!



---

archive/issue_comments_274548.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-18T17:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274548",
    "user": "https://github.com/mforets"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274549.json:
```json
{
    "body": "Thanks for the review.",
    "created_at": "2017-10-19T05:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274549",
    "user": "https://github.com/rwst"
}
```

Thanks for the review.



---

archive/issue_comments_274550.json:
```json
{
    "body": "(Fixing formatting in ticket description.)",
    "created_at": "2017-10-29T00:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274550",
    "user": "https://github.com/slel"
}
```

(Fixing formatting in ticket description.)



---

archive/issue_comments_274551.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2017-11-01T23:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274551",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_274552.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-11-01T23:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274552",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_274553.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-02T06:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274554.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-11-02T06:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274554",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_274555.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-11-02T06:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274555",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_274556.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-11-04T23:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19967",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19967#issuecomment-274556",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
