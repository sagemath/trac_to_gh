# Issue 19967: problems with constructing or converting to SymPy expressions

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2016-03-14 07:50:14

CC:  mforets mmancini

In the Sympy-1.0 upgrade the `UndefinedFunction._sage_` method is patched away to enable the important upgrade. This function was planned to resolve part of #14723 but uncovers missing functionality in the coercion system, and probably with symbolics. The following doctest in french_book fails if `UndefinedFunction._sage_` is defined:

```
  sage: from sympy import Function, Symbol
  sage: u = Function('u'); n = Symbol('n', integer=True)
  sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
NotimplementedError
```


tscrim found the minimal cases:
> {{{
> sage: f = function('f')
> sage: x = var('x')
> sage: sympy.sympify(f(x), evaluate=False)
> f(x)
> sage: sympy.sympify(3*f(x), evaluate=False)
> AttributeError: 'Call' object has no attribute 'id'
> }}}
> However, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:
> {{{
> sage: f._sympy_()
> sage: f(x)._sympy_()
> sage: (f(x)+3)._sympy_()
> }}}

This means that Sympy-1.0 probably only uncovered already existing problems in expression conversion. This ticket should remove the patch in `build/pkgs/sympy` and resolve all mentioned problems.

See #20185 for all previous discussion on this.


---

Comment by infinity0 created at 2017-06-13 19:23:06

Hi, any progress on this? We are currently NOT carrying Sage's sympy patch in Debian, so our Sage is running _without_ this patch (and a few french book doctests break but we just ignore this).

In fact applying the patch, breaks some of sympy's own tests relating to Sage integration: https://github.com/sympy/sympy/pull/11858#issuecomment-308207891

BTW you do not need to rebuild Sympy to apply or unapply this patch, just edit /usr/lib/python2.7/dist-packages/sympy/core/function.py or wherever the file is installed to. Then restart sage (if you're testing Sage) or python (if you're testing sympy).


---

Comment by mforets created at 2017-06-23 09:51:49

hi, i've experimented adding a fragment of #14723:


```
`@``@` -764,6 +764,9 `@``@` class SympyConverter(Converter):
         if f_sympy:
             return f_sympy(*sympy.sympify(g, evaluate=False))
         else:

+            from sage.symbolic.function_factory import SymbolicFunction
+            if isinstance(ex.operator(), SymbolicFunction):
+                return sympy.Function(str(f))(*g, evaluate=False)
             raise NotImplementedError("SymPy function '%s' doesn't exist" % f)
}}} 

and adding the `_sympy_` method to the NewSymbolicFunction class:

{{{
`@``@` -67,6 +67,10 `@``@` def function_factory(name, nargs=0, latex_name=None, conversions=None,
             """
             return "'%s"%self.name()

+        def _sympy_(self):
+            from sympy import Function
+            return Function(self.name())
}}}

with these changes, the conversions in this ticket's description work. does this go in the good direction or not? 

however, the round trip back to sage is broken:

{{{
sage: f = function('f')
sage: type(f)
<class 'sage.symbolic.function_factory.NewSymbolicFunction'>
sage: fs = f._sympy_()
sage: type(fs)
<class 'sympy.core.function.UndefinedFunction'>
sage: fs._sage_()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-9fb5fbad3003> in <module>()
----> 1 fs._sage_()

TypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)
}}}

and with a different error for a function with arguments:

{{{
sage: f = function('f')(x)
sage: type(f)
<type 'sage.symbolic.expression.Expression'>
sage: fs = f._sympy_()
sage: type(fs)
f
sage: fs._sage_()

---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-5-9fb5fbad3003> in <module>()
----> 1 fs._sage_()

/Users/forets/sage-src/sage/local/lib/python2.7/site-packages/sympy/core/function.pyc in _sage_(self)
    705         import sage.all as sage
    706         fname = self.func.__name__
--> 707         func = getattr(sage, fname)
    708         args = [arg._sage_() for arg in self.args]
    709         return func(*args)

AttributeError: 'module' object has no attribute 'f'
}}}


---

Comment by rws created at 2017-06-23 12:54:05

Replying to [comment:5 mforets]:
> with these changes, the conversions in this ticket's description work. does this go in the good direction or not? 

Looks good.


---

Comment by mforets created at 2017-06-24 09:08:06

New commits:


---

Comment by git created at 2017-06-24 09:09:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-06-25 14:06:47

for the remaining part, this is supposed to be solved here? (_This ticket should remove the patch.._ => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.


---

Comment by rws created at 2017-07-01 07:04:27

Replying to [comment:9 mforets]:
> for the remaining part, this is supposed to be solved here? (_This ticket should remove the patch.._ => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.

You mean how to delete a file from a git branch? use `git rm`.


---

Comment by mforets created at 2017-07-01 08:20:15

Replying to [comment:10 rws]:
> Replying to [comment:9 mforets]:
> > for the remaining part, this is supposed to be solved here? (_This ticket should remove the patch.._ => to delete the file `build/pkgs/sympy/patches/01_undeffun_sage.patch` ??). i've played around, but i don't quite understand how it's supposed to work.. thanks.
> 
> You mean how to delete a file from a git branch? use `git rm`.

no; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage.. Anyway, I'll `git rm 01_undeffun_sage.patch` later today!


---

Comment by git created at 2017-07-01 08:52:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-07-01 09:00:09

Replying to [comment:11 mforets]:
> no; i didn't know what are these `*.patch` files, how they are generated, how they are incorporated into sage..

You get them with any git branch by piping the output of `git diff` into a file. OTOH you don't even need `git diff`. For example the SymPy PR patch mentioned in #22802 can be had by downloading `https://patch-diff.githubusercontent.com/raw/sympy/sympy/pull/12826.diff`, i.e. the PR link with `.diff` appended. That should work with any github commit.


---

Comment by mforets created at 2017-07-01 10:58:09

OK and those patches get automatically applied into `/local/lib/...` upon rebuilding.

I've tested the patch in question. It solves one out of the two cases from comment:5 :


```
sage: function('f')(x)._sympy_()._sage_()  # ok
f(x)
sage: function('f')._sympy_()._sage_()  # problem
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-7d5000a51aaa> in <module>()
----> 1 function('f')._sympy_()._sage_()

TypeError: unbound method _sage_() must be called with f instance as first argument (got nothing instead)
```


If we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?


---

Comment by rws created at 2017-07-01 12:48:09

Replying to [comment:14 mforets]:
> If we also want to transform from `UndefinedFunction` back to `NewSymbolicFunction`, then, that case should be addressed upstream in [sympy to sage conversion : Abstract function](https://github.com/sympy/sympy/pull/12826) too?

Yes, conversion of SymPy objects is usually done by their member function `_sage_()`. That means SymPy source change.


---

Comment by git created at 2017-08-30 08:21:27

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mforets created at 2017-08-30 08:22:50

Changing status from new to needs_review.


---

Comment by mforets created at 2017-08-30 08:22:50

Last 10 new commits:


---

Comment by mforets created at 2017-09-03 12:35:04

Changing status from needs_review to needs_work.


---

Comment by mforets created at 2017-09-03 12:35:04

essentially there is this problem:


```
sage: from sympy import Function, Symbol
sage:  u = Function('u') ; n = Symbol('n', integer=True);
sage: type(2+u(2))  # wrong
<type 'sage.symbolic.expression.Expression'>
sage: type(u(2)+2)
<class 'sympy.core.add.Add'>
```


it gets fixed with the code in this comment: #23496#comment:65

do you agree?


---

Comment by rws created at 2017-10-17 06:48:19

After #24006 there is need for a rewrite which makes it all much simpler. I'll try that now.


---

Comment by mforets created at 2017-10-17 06:54:36

awesome. i started to read your code today, so i don't get too outdated :)


---

Comment by rws created at 2017-10-17 07:53:29

I think the problem with `Function('f')` is that it returns a class not an object, and I'm not sure if we can put a `_sage_` method onto that.


---

Comment by rws created at 2017-10-17 15:15:14

To document what happens in SymPy:

When `F=Function('abc')` is called the constructor of `Function` uses the metaclass `UndefFunction` to create a new class with parent `AppliedUndef` named `abc`. Calling `F._sage_()` will NOT call the `_sage_()` member of `AppliedUndef` but tries to call `abc._sage_()` which does not exist at installation time. This, however, is not a problem because we can dynamically add a `_sage_()` method to `abc` on creation of `abc` inside `UndefFunction.__new__`. So converting abstract functions works.

The problem is that now `F(x)._sage_()` will call the same `abc._sage_()` while previously it was referred to the superclass, i.e. `AppliedUndef._sage_()`. But `_sage_` as class method does not know about the specific instance and its argument `x`.


---

Comment by rws created at 2017-10-17 15:59:34

For the solution we will have to patch SymPy, not possible otherwise.


---

Comment by git created at 2017-10-17 16:11:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-17 16:18:53

The original examples all work now. I'll add them as doctests tomorrow.


---

Comment by git created at 2017-10-18 06:53:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-18 06:56:37

Next, we'll work on the SymPy update, based on this ticket.


---

Comment by rws created at 2017-10-18 06:56:37

Changing status from needs_work to needs_review.


---

Comment by mforets created at 2017-10-18 08:01:45

looks good to me. doctests in `src/sage/interfaces/sympy.py` pass and all (yes, all!) the issues in this ticket's description are solved. htmldoc is ok. let's wait that the patchbot changes the status..

the only oddity that i get (but maybe we shouldn't care?) is:


```
sage: from sympy import Function, Symbol
sage: u = Function('u'); n = Symbol('n', integer=True)
sage: type(u(2)+2)
<class 'sympy.core.add.Add'>
sage: type(2+u(2))
<type 'sage.symbolic.expression.Expression'>
```



---

Comment by rws created at 2017-10-18 15:35:14

I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use.

As to the patchbots they are unreliable at the moment. That segfault in matrix is curious but I can't reproduce it.


---

Comment by mforets created at 2017-10-18 17:07:11

> I think there is nothing wrong. In the second case it's probably coercion that makes the choice, and it doesn't know that SymPy implements addition for their objects to use. 

Ok.

since i cannot reproduce failures in my machine, let me set to positive review.. and thanks for fixing everything!!


---

Comment by mforets created at 2017-10-18 17:07:11

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-10-19 05:50:22

Thanks for the review.


---

Comment by slelievre created at 2017-10-29 00:29:32

(Fixing formatting in ticket description.)


---

Comment by vbraun created at 2017-11-01 23:06:43

Merge conflict


---

Comment by vbraun created at 2017-11-01 23:06:43

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-11-02 06:50:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-11-02 06:51:09

New commits:


---

Comment by rws created at 2017-11-02 06:51:09

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-11-04 23:24:42

Resolution: fixed
