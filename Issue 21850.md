# Issue 21850: Rethink richcmp_not_equal

Issue created by migration from https://trac.sagemath.org/ticket/22087

Original creator: jdemeyer

Original creation time: 2016-12-21 09:29:11

CC:  chapoton mmezzarobba

The usage of `richcmp_not_equal` makes too many assumptions. For example, it assumes that `x != y` is equivalent to `not x == y`. We should think of a better way to solve the problem that `richcmp_not_equal` solves.


---

Comment by jdemeyer created at 2017-05-31 10:12:02

It's hard to say what should be done instead. At least, the current code is consistent with what Python does when comparing tuples: comparisons between tuples `a` and `b` always start by comparing `a[0] == b[0]`.


---

Comment by git created at 2017-06-01 09:21:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-06-01 09:29:52

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2017-06-02 13:57:31

My brain hurts a bit, but this looks reasonable to me. `:-)` Please feel free to set the ticket to positive review on my behalf if all tests pass.

You may have meant to write `(x {op} y)` in:

```
return res # (x {op} > x) --> True
```

Also, the comment:

```
....: return rich_to_bool(op, 0) # Lists are equal
```

may be misleading, because the lists actually don't have to be equal when the operator is not `==`.


---

Comment by jdemeyer created at 2017-06-02 14:01:02

Replying to [comment:9 mmezzarobba]:
> My brain hurts a bit, but this looks reasonable to me. `:-)`

It's understandable. It took me a while to come up with these semantics, but I think they are correct.

I'll fix the minor issues that you mentioned.


---

Comment by git created at 2017-06-02 14:17:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-18 09:29:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-11-27 11:29:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-27 11:30:18

Rebased to 8.1.rc3


---

Comment by jdemeyer created at 2017-11-27 12:42:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-11-27 14:07:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-27 14:10:21

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-27 14:10:21

I changed the implementation compared to 6 months ago by being closer to what Python does and being more efficient in the typical case that `(x <= y)` is equivalent to `(x < y or x == y)`.


---

Comment by jdemeyer created at 2017-11-28 10:57:13

I do have some small hope that these changes might be accepted by Python upstream to change the comparison of standard Python types like `list`.


---

Comment by git created at 2017-11-28 11:42:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-28 11:45:49

Improved doctests.


---

Comment by git created at 2017-11-28 11:47:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-11-28 13:11:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-12-09 17:06:41

Could you please review this again? It is functionally almost identical to the previous version, I mainly reorganized the implementation.


---

Comment by mmezzarobba created at 2017-12-09 19:50:57

Replying to [comment:23 jdemeyer]:
> Could you please review this again?

Yes, but probably not before some time.


---

Comment by jdemeyer created at 2018-01-08 14:23:26

Ping?


---

Comment by vdelecroix created at 2018-01-12 19:51:06

The ticket description is not reflecting what is in the branch.


---

Comment by jdemeyer created at 2018-01-13 10:22:54

Replying to [comment:26 vdelecroix]:
> The ticket description is not reflecting what is in the branch.

I think it is, but I'll try to clarify.


---

Comment by vdelecroix created at 2018-01-13 10:34:51

What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).


---

Comment by jdemeyer created at 2018-01-13 10:37:01

Replying to [comment:29 vdelecroix]:
> What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).

No, it cannot because those are legitimate return values of rich comparisons. For example, I could write

```
def __eq__(self, other):
    return None
```

and then `a == b` could return `None`.

But this is not the case for `NotImplemented`: that is special-cased by Python so it is not possible that `a == b` returns `NotImplemented`.


---

Comment by vdelecroix created at 2018-01-13 10:39:58

I wanted to say "`NotImplemented` as return value of your `richcmp_item`".


---

Comment by vdelecroix created at 2018-01-13 10:41:45

There somehow to ways to write the same thing

```
if something:
    return "hey"
else:
    do something else
```

or

```
if something:
    return "hey"
do something else
```

You are mixing the two ways in your code which makes it harder to read.


---

Comment by vdelecroix created at 2018-01-13 10:44:04

Would be good to comment on `op & 1` and `op ^ 1` (in the code).


---

Comment by git created at 2018-01-13 19:58:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-13 19:58:47

OK, I tried to improve the documentation.


---

Comment by jdemeyer created at 2018-01-13 20:02:43

Replying to [comment:32 vdelecroix]:
> I wanted to say "`NotImplemented` as return value of your `richcmp_item`".

Yes and I tried to explain that. The point is that `richcmp_item(x, y, op)` returns either

1. `PyObject_RichCompare(x, y, op)`

2. `NotImplemented`

Since 1. can return anything _except_ `NotImplemented`, the value in 2. must be `NotImplemented` if we want those cases to be disjoint.


---

Comment by git created at 2018-01-14 08:15:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-01-14 14:07:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-14 14:10:24

OK, I added some further explanations in the docstring and code comments. This function is now about 300 lines in total, of which only 20 are code...


---

Comment by vdelecroix created at 2018-01-15 17:55:49

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-01-15 17:55:49

Subtle code needs explanations :-)


---

Comment by mmezzarobba created at 2018-01-15 19:01:37

Replying to [comment:25 jdemeyer]:
> Ping?

Sorry, I was a bit too busy... And thanks a lot Vincent for taking over the review!


---

Comment by vbraun created at 2018-01-18 18:09:34

Resolution: fixed
