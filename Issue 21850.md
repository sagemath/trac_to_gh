# Issue 21850: Rethink richcmp_not_equal

archive/issues_021850.json:
```json
{
    "body": "CC:  chapoton mmezzarobba\n\nThe usage of `richcmp_not_equal` makes too many assumptions. For example, it assumes that `x != y` is equivalent to `not x == y`. We should think of a better way to solve the problem that `richcmp_not_equal` solves.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22087\n\n",
    "created_at": "2016-12-21T09:29:11Z",
    "labels": [
        "basic arithmetic",
        "major",
        "enhancement"
    ],
    "title": "Rethink richcmp_not_equal",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21850",
    "user": "jdemeyer"
}
```
CC:  chapoton mmezzarobba

The usage of `richcmp_not_equal` makes too many assumptions. For example, it assumes that `x != y` is equivalent to `not x == y`. We should think of a better way to solve the problem that `richcmp_not_equal` solves.

Issue created by migration from https://trac.sagemath.org/ticket/22087





---

archive/issue_comments_303370.json:
```json
{
    "body": "It's hard to say what should be done instead. At least, the current code is consistent with what Python does when comparing tuples: comparisons between tuples `a` and `b` always start by comparing `a[0] == b[0]`.",
    "created_at": "2017-05-31T10:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303370",
    "user": "jdemeyer"
}
```

It's hard to say what should be done instead. At least, the current code is consistent with what Python does when comparing tuples: comparisons between tuples `a` and `b` always start by comparing `a[0] == b[0]`.



---

archive/issue_comments_303371.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-06-01T09:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303371",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303372.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-01T09:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303372",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_303373.json:
```json
{
    "body": "My brain hurts a bit, but this looks reasonable to me. `:-)` Please feel free to set the ticket to positive review on my behalf if all tests pass.\n\nYou may have meant to write `(x {op} y)` in:\n\n```\nreturn res # (x {op} > x) --> True\n```\n\nAlso, the comment:\n\n```\n....: return rich_to_bool(op, 0) # Lists are equal\n```\n\nmay be misleading, because the lists actually don't have to be equal when the operator is not `==`.",
    "created_at": "2017-06-02T13:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303373",
    "user": "mmezzarobba"
}
```

My brain hurts a bit, but this looks reasonable to me. `:-)` Please feel free to set the ticket to positive review on my behalf if all tests pass.

You may have meant to write `(x {op} y)` in:

```
return res # (x {op} > x) --> True
```

Also, the comment:

```
....: return rich_to_bool(op, 0) # Lists are equal
```

may be misleading, because the lists actually don't have to be equal when the operator is not `==`.



---

archive/issue_comments_303374.json:
```json
{
    "body": "Replying to [comment:9 mmezzarobba]:\n> My brain hurts a bit, but this looks reasonable to me. `:-)`\n\nIt's understandable. It took me a while to come up with these semantics, but I think they are correct.\n\nI'll fix the minor issues that you mentioned.",
    "created_at": "2017-06-02T14:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303374",
    "user": "jdemeyer"
}
```

Replying to [comment:9 mmezzarobba]:
> My brain hurts a bit, but this looks reasonable to me. `:-)`

It's understandable. It took me a while to come up with these semantics, but I think they are correct.

I'll fix the minor issues that you mentioned.



---

archive/issue_comments_303375.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-02T14:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303375",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-06-18T09:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303377.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-27T11:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303377",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303378.json:
```json
{
    "body": "Rebased to 8.1.rc3",
    "created_at": "2017-11-27T11:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303378",
    "user": "jdemeyer"
}
```

Rebased to 8.1.rc3



---

archive/issue_comments_303379.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-27T12:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303379",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_303380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-27T14:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303380",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303381.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-27T14:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303381",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_303382.json:
```json
{
    "body": "I changed the implementation compared to 6 months ago by being closer to what Python does and being more efficient in the typical case that `(x <= y)` is equivalent to `(x < y or x == y)`.",
    "created_at": "2017-11-27T14:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303382",
    "user": "jdemeyer"
}
```

I changed the implementation compared to 6 months ago by being closer to what Python does and being more efficient in the typical case that `(x <= y)` is equivalent to `(x < y or x == y)`.



---

archive/issue_comments_303383.json:
```json
{
    "body": "I do have some small hope that these changes might be accepted by Python upstream to change the comparison of standard Python types like `list`.",
    "created_at": "2017-11-28T10:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303383",
    "user": "jdemeyer"
}
```

I do have some small hope that these changes might be accepted by Python upstream to change the comparison of standard Python types like `list`.



---

archive/issue_comments_303384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T11:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303384",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303385.json:
```json
{
    "body": "Improved doctests.",
    "created_at": "2017-11-28T11:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303385",
    "user": "jdemeyer"
}
```

Improved doctests.



---

archive/issue_comments_303386.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T11:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303386",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303387.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T13:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303387",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303388.json:
```json
{
    "body": "Could you please review this again? It is functionally almost identical to the previous version, I mainly reorganized the implementation.",
    "created_at": "2017-12-09T17:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303388",
    "user": "jdemeyer"
}
```

Could you please review this again? It is functionally almost identical to the previous version, I mainly reorganized the implementation.



---

archive/issue_comments_303389.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Could you please review this again?\n\nYes, but probably not before some time.",
    "created_at": "2017-12-09T19:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303389",
    "user": "mmezzarobba"
}
```

Replying to [comment:23 jdemeyer]:
> Could you please review this again?

Yes, but probably not before some time.



---

archive/issue_comments_303390.json:
```json
{
    "body": "Ping?",
    "created_at": "2018-01-08T14:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303390",
    "user": "jdemeyer"
}
```

Ping?



---

archive/issue_comments_303391.json:
```json
{
    "body": "The ticket description is not reflecting what is in the branch.",
    "created_at": "2018-01-12T19:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303391",
    "user": "vdelecroix"
}
```

The ticket description is not reflecting what is in the branch.



---

archive/issue_comments_303392.json:
```json
{
    "body": "Replying to [comment:26 vdelecroix]:\n> The ticket description is not reflecting what is in the branch.\n\nI think it is, but I'll try to clarify.",
    "created_at": "2018-01-13T10:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303392",
    "user": "jdemeyer"
}
```

Replying to [comment:26 vdelecroix]:
> The ticket description is not reflecting what is in the branch.

I think it is, but I'll try to clarify.



---

archive/issue_comments_303393.json:
```json
{
    "body": "What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).",
    "created_at": "2018-01-13T10:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303393",
    "user": "vdelecroix"
}
```

What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).



---

archive/issue_comments_303394.json:
```json
{
    "body": "Replying to [comment:29 vdelecroix]:\n> What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).\n\nNo, it cannot because those are legitimate return values of rich comparisons. For example, I could write\n\n```\ndef __eq__(self, other):\n    return None\n```\n\nand then `a == b` could return `None`.\n\nBut this is not the case for `NotImplemented`: that is special-cased by Python so it is not possible that `a == b` returns `NotImplemented`.",
    "created_at": "2018-01-13T10:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303394",
    "user": "jdemeyer"
}
```

Replying to [comment:29 vdelecroix]:
> What is the rationale for using `NotImplemented`? It could have been `None`. Or something on ints: `-1` (not decided yet), `0` (False) and `1` (True).

No, it cannot because those are legitimate return values of rich comparisons. For example, I could write

```
def __eq__(self, other):
    return None
```

and then `a == b` could return `None`.

But this is not the case for `NotImplemented`: that is special-cased by Python so it is not possible that `a == b` returns `NotImplemented`.



---

archive/issue_comments_303395.json:
```json
{
    "body": "I wanted to say \"`NotImplemented` as return value of your `richcmp_item`\".",
    "created_at": "2018-01-13T10:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303395",
    "user": "vdelecroix"
}
```

I wanted to say "`NotImplemented` as return value of your `richcmp_item`".



---

archive/issue_comments_303396.json:
```json
{
    "body": "There somehow to ways to write the same thing\n\n```\nif something:\n    return \"hey\"\nelse:\n    do something else\n```\n\nor\n\n```\nif something:\n    return \"hey\"\ndo something else\n```\n\nYou are mixing the two ways in your code which makes it harder to read.",
    "created_at": "2018-01-13T10:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303396",
    "user": "vdelecroix"
}
```

There somehow to ways to write the same thing

```
if something:
    return "hey"
else:
    do something else
```

or

```
if something:
    return "hey"
do something else
```

You are mixing the two ways in your code which makes it harder to read.



---

archive/issue_comments_303397.json:
```json
{
    "body": "Would be good to comment on `op & 1` and `op ^ 1` (in the code).",
    "created_at": "2018-01-13T10:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303397",
    "user": "vdelecroix"
}
```

Would be good to comment on `op & 1` and `op ^ 1` (in the code).



---

archive/issue_comments_303398.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-13T19:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303398",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303399.json:
```json
{
    "body": "OK, I tried to improve the documentation.",
    "created_at": "2018-01-13T19:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303399",
    "user": "jdemeyer"
}
```

OK, I tried to improve the documentation.



---

archive/issue_comments_303400.json:
```json
{
    "body": "Replying to [comment:32 vdelecroix]:\n> I wanted to say \"`NotImplemented` as return value of your `richcmp_item`\".\n\nYes and I tried to explain that. The point is that `richcmp_item(x, y, op)` returns either\n\n1. `PyObject_RichCompare(x, y, op)`\n\n2. `NotImplemented`\n\nSince 1. can return anything *except* `NotImplemented`, the value in 2. must be `NotImplemented` if we want those cases to be disjoint.",
    "created_at": "2018-01-13T20:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303400",
    "user": "jdemeyer"
}
```

Replying to [comment:32 vdelecroix]:
> I wanted to say "`NotImplemented` as return value of your `richcmp_item`".

Yes and I tried to explain that. The point is that `richcmp_item(x, y, op)` returns either

1. `PyObject_RichCompare(x, y, op)`

2. `NotImplemented`

Since 1. can return anything *except* `NotImplemented`, the value in 2. must be `NotImplemented` if we want those cases to be disjoint.



---

archive/issue_comments_303401.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-14T08:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303401",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303402.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-14T14:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303402",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303403.json:
```json
{
    "body": "OK, I added some further explanations in the docstring and code comments. This function is now about 300 lines in total, of which only 20 are code...",
    "created_at": "2018-01-14T14:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303403",
    "user": "jdemeyer"
}
```

OK, I added some further explanations in the docstring and code comments. This function is now about 300 lines in total, of which only 20 are code...



---

archive/issue_comments_303404.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-15T17:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303404",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_303405.json:
```json
{
    "body": "Subtle code needs explanations :-)",
    "created_at": "2018-01-15T17:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303405",
    "user": "vdelecroix"
}
```

Subtle code needs explanations :-)



---

archive/issue_comments_303406.json:
```json
{
    "body": "Replying to [comment:25 jdemeyer]:\n> Ping?\n\nSorry, I was a bit too busy... And thanks a lot Vincent for taking over the review!",
    "created_at": "2018-01-15T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303406",
    "user": "mmezzarobba"
}
```

Replying to [comment:25 jdemeyer]:
> Ping?

Sorry, I was a bit too busy... And thanks a lot Vincent for taking over the review!



---

archive/issue_comments_303407.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-18T18:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21850#issuecomment-303407",
    "user": "vbraun"
}
```

Resolution: fixed
