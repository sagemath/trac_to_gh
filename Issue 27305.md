# Issue 27305: FindStat and unicode

Issue created by migration from https://trac.sagemath.org/ticket/27542

Original creator: mantepse

Original creation time: 2019-03-23 22:09:12

CC:  chapoton

Keywords: FindStat

As it turns out, #27346 actually broke the FindStat interface.  We now have:

```
sage: findstat(914)                                          # optional -- internet
<repr(<__main__.FindStatStatistic at 0x7fbc3dc1ec10>) failed: UnicodeEncodeError: 'ascii' codec can't encode character u'\xf6' in position 30: ordinal not in range(128)>
```



The reason is the following change, which was made for py3 compatibility.

```diff
@ -966,9 +967,9 @@ class FindStatStatistic(SageObject):
             else:
                 raise
 
-        self._description           = self._raw[FINDSTAT_STATISTIC_DESCRIPTION].encode("utf-8")
-        self._name                  = self._raw[FINDSTAT_STATISTIC_NAME].encode("utf-8")
-        self._references            = self._raw[FINDSTAT_STATISTIC_REFERENCES].encode("utf-8")
+        self._description           = self._raw[FINDSTAT_STATISTIC_DESCRIPTION]
+        self._name                  = self._raw[FINDSTAT_STATISTIC_NAME]
+        self._references            = self._raw[FINDSTAT_STATISTIC_REFERENCES]
         self._collection            = FindStatCollection(self._raw[FINDSTAT_STATISTIC_COLLECTION])
         self._code                  = self._raw[FINDSTAT_STATISTIC_CODE]
         self._sage_code             = self._raw[FINDSTAT_STATISTIC_SAGE_CODE]
@@ -1044,7 +1045,7 @@ class FindStatStatistic(SageObject):
         stat_str = "\n".join(["\n".join(keys) + "\n====> " + values for (keys, values) in stat])
         verbose("Sending the following data to FindStat\r\n %s" % stat_str, caller_name='FindStat')
 
-        values = urlencode({"freedata": stat_str, "depth": str(self._depth), "caller": "Sage"})
+        values = urlencode({"freedata": stat_str, "depth": str(self._depth), "caller": "Sage"}).encode("utf-8")
         verbose("Fetching URL %s with encoded data %s" % (url, values), caller_name='FindStat')
```


It went unnoticed, because the doctests were marked `# random`...


---

Comment by git created at 2019-03-24 20:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-24 20:21:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2019-03-24 20:22:43

Changing status from new to needs_review.


---

Comment by mantepse created at 2019-03-24 20:22:43

I realise that it is not optimal, but I haven't got a clue how to do it properly.


---

Comment by mantepse created at 2019-03-26 07:56:46

Making this a blocker because it turns out that the interface is almost unusable for serious work on python2 now, and there is a fix.


---

Comment by mantepse created at 2019-03-26 07:56:46

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2019-03-26 10:06:07

1. I'm wondering how stable the findstat output is. My impression is that it's not and that's the reason why they were marked `# random` in the first place. If you remove `# random`, then you might get failures in the future whenever the output from findstat changes.

2. Wouldn't it make sense to move the encoding to `__repr__`? In other words, use `unicode` everywhere except at the very end when you're returning from `__repr__`.


---

Comment by mantepse created at 2019-03-26 10:17:28

Replying to [comment:6 jdemeyer]:
> 1. I'm wondering how stable the findstat output is. My impression is that it's not and that's the reason why they were marked `# random` in the first place. If you remove `# random`, then you might get failures in the future whenever the output from findstat changes.

This is correct.  However, unfortunately, adding `# random` also led to the current situation, where I have a completely disfunctional interface in a release.  Since I plan to work a fair bit on the interface in the coming three months, I think it is better to have failing doctests which I can make pass using judicious use of `...`, rather than having all doctests pass because they are not really tested.

> 2. Wouldn't it make sense to move the encoding to `__repr__`? In other words, use `unicode` everywhere except at the very end when you're returning from `__repr__`.

I have no idea.  I'll try, thank you for the suggestion!


---

Comment by jdemeyer created at 2019-03-26 10:25:07

Alternatively, if you just want to test that `repr()` works, it suffices to add a doctest

```
x = repr(findstat(...))  # check that repr() doesn't raise an exception
```



---

Comment by mantepse created at 2019-03-26 13:29:16

Replying to [comment:7 mantepse]:

> > 2. Wouldn't it make sense to move the encoding to `__repr__`? In other words, use `unicode` everywhere except at the very end when you're returning from `__repr__`.
> 
> I have no idea.  I'll try, thank you for the suggestion!

I just tried.  This does work for `FindStatStatistic.__repr__`.  However, I then have to put an addtional check into `FindStatStatistic.references`, because this returns a `FancyTuple`, whose `__repr__` doesn't like unicode either.

It seems to me that having the check in multiple places makes it more brittle, but I am easy to convince.

(apparently, encoding `FindStatStatistic._description` is unnecessary, though)


---

Comment by git created at 2019-03-26 13:31:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2019-03-26 13:35:11

Replying to [comment:8 jdemeyer]:
> Alternatively, if you just want to test that `repr()` works, it suffices to add a doctest
> {{{
> x = repr(findstat(...))  # check that repr() doesn't raise an exception
> }}}

OK.  I'll keep this in mind.  For the moment, I think I prefer to keep the doctests, and make them sufficiently stable.


---

Comment by git created at 2019-04-02 11:54:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2019-04-04 08:44:19

Changing status from needs_review to positive_review.


---

Comment by stumpc5 created at 2019-04-04 08:44:19

Lgtm, everything seems to work and bot is green.


---

Comment by vbraun created at 2019-04-05 20:51:41

Resolution: fixed
