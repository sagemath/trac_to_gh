# Issue 34415: Import NN directly rather than lazily throughout the Sage library

archive/issues_034415.json:
```json
{
    "body": "CC:  @nbruin @mkoeppe\n\nThis is extracted from #16522.\n\nOne issue raised on that ticket is that it is problematic to use lazy imports on things other than a function (stated in #16522#comment:20). It appears that using honest imports rather than lazy ones for `NN` should not cause too much of a slowdown, but this needs to be tested.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34652\n\n",
    "closed_at": "2022-11-15T23:43:06Z",
    "created_at": "2022-10-12T22:21:50Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Import NN directly rather than lazily throughout the Sage library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34415",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @nbruin @mkoeppe

This is extracted from #16522.

One issue raised on that ticket is that it is problematic to use lazy imports on things other than a function (stated in #16522#comment:20). It appears that using honest imports rather than lazy ones for `NN` should not cause too much of a slowdown, but this needs to be tested.


Issue created by migration from https://trac.sagemath.org/ticket/34652





---

archive/issue_comments_487005.json:
```json
{
    "body": "See #16522#comment:34 for some imports that should be changed.",
    "created_at": "2022-10-12T22:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487005",
    "user": "https://github.com/jhpalmieri"
}
```

See #16522#comment:34 for some imports that should be changed.



---

archive/issue_comments_487006.json:
```json
{
    "body": "Something strange is going on. If I make just the change\n\n```diff\ndiff --git a/src/sage/rings/semirings/all.py b/src/sage/rings/semirings/all.py\nindex 9159407408..b150b55ebc 100644\n--- a/src/sage/rings/semirings/all.py\n+++ b/src/sage/rings/semirings/all.py\n@@ -1,6 +1,3 @@\n-\n-from sage.misc.lazy_import import lazy_import\n-lazy_import('sage.rings.semirings.non_negative_integer_semiring',\n-            ['NonNegativeIntegerSemiring', 'NN'])\n+from .non_negative_integer_semiring import NN\n \n from .tropical_semiring import TropicalSemiring\n```\nthen I get a warning upon starting Sage:\n\n```\n/Users/jpalmier/Desktop/Sage/git/sage/src/sage/sets/non_negative_integers.py:83: UserWarning: Resolving lazy import FacadeSets during startup\n  Parent.__init__(self, facade = ZZ, category = InfiniteEnumeratedSets().or_subcategory(category) )\n```\nMathematically there is an obvious connection between `sage/sets/non_negative_integers.py` and `sage/rings/semirings/non_negative_integer_semiring.py`, but from the code point of view, I don't see why this change causes this warning.",
    "created_at": "2022-10-26T22:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487006",
    "user": "https://github.com/jhpalmieri"
}
```

Something strange is going on. If I make just the change

```diff
diff --git a/src/sage/rings/semirings/all.py b/src/sage/rings/semirings/all.py
index 9159407408..b150b55ebc 100644
--- a/src/sage/rings/semirings/all.py
+++ b/src/sage/rings/semirings/all.py
@@ -1,6 +1,3 @@
-
-from sage.misc.lazy_import import lazy_import
-lazy_import('sage.rings.semirings.non_negative_integer_semiring',
-            ['NonNegativeIntegerSemiring', 'NN'])
+from .non_negative_integer_semiring import NN
 
 from .tropical_semiring import TropicalSemiring
```
then I get a warning upon starting Sage:

```
/Users/jpalmier/Desktop/Sage/git/sage/src/sage/sets/non_negative_integers.py:83: UserWarning: Resolving lazy import FacadeSets during startup
  Parent.__init__(self, facade = ZZ, category = InfiniteEnumeratedSets().or_subcategory(category) )
```
Mathematically there is an obvious connection between `sage/sets/non_negative_integers.py` and `sage/rings/semirings/non_negative_integer_semiring.py`, but from the code point of view, I don't see why this change causes this warning.



---

archive/issue_comments_487007.json:
```json
{
    "body": "With the change above and some other changes (changing imports of NN from sage.rings.semirings.all to the sage.rings.semirings.non_negative_integer_semiring), the startup time may have gone up slightly. I ran `./sage --startuptime` about half a dozen times without the change and then with the change. The average before was 949.5ms, the average after was 957.5ms. So an increase of 8ms. In my opinion that's okay.",
    "created_at": "2022-10-26T23:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487007",
    "user": "https://github.com/jhpalmieri"
}
```

With the change above and some other changes (changing imports of NN from sage.rings.semirings.all to the sage.rings.semirings.non_negative_integer_semiring), the startup time may have gone up slightly. I ran `./sage --startuptime` about half a dozen times without the change and then with the change. The average before was 949.5ms, the average after was 957.5ms. So an increase of 8ms. In my opinion that's okay.



---

archive/issue_comments_487008.json:
```json
{
    "body": "I agree, we should not worry about that increase",
    "created_at": "2022-10-26T23:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487008",
    "user": "https://github.com/mkoeppe"
}
```

I agree, we should not worry about that increase



---

archive/issue_comments_487009.json:
```json
{
    "body": "Replying to [comment:2 John Palmieri]:\n> Mathematically there is an obvious connection between `sage/sets/non_negative_integers.py` and `sage/rings/semirings/non_negative_integer_semiring.py`, but from the code point of view, I don't see why this change causes this warning.\n\n\nThe line in `non_negative_integer_semiring.py`:\n\n```\nfrom sage.sets.non_negative_integers import NonNegativeIntegers\n```\nprobably explains the link.\n\nThe semiring class inherits from it and the `__init__` chains to it. So that's a programmatic link. Apparently, something in the category framework for `FacadeSets` lazy-imports these and the initialization of `NN` triggers the resolution; now prior to conclusion of start-up. So that suggests there's a further lazy import that should be scuttled, because it now gets resolved upon startup anyway. I think that was the costly bit before, but by the looks of it the cost may not be so high anymore. Python's import framework has improved over the years, if I'm not mistaken and/or you've tested on a filesystem that has very little overhead when warmed up.\n\nin fact, as far as I can find, it happens in `sets_cat.py` in `class Sets(Category_singleton)`; line 1882. There's a whole bunch of class-namespace-level `LazyImport`s there; some of them marked `at_startup`, which should silence the warning. You might want to double-check why those are lazy: is it to solve some otherwise circular import problem?\n\nI suspect the trigger that actually resolves the lazy shim here is `self._with_axiom('Facade')`, which is probably executed somewhere in creating the category for `NN` or the semiring. If I recall correctly, this is one of the points where the category framework really ceases to by Python and instead is some other kind of programming language bolted onto Python infrastructure. It's certainly the kind of shenanigans that makes me never want to get near it.",
    "created_at": "2022-10-27T00:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487009",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:2 John Palmieri]:
> Mathematically there is an obvious connection between `sage/sets/non_negative_integers.py` and `sage/rings/semirings/non_negative_integer_semiring.py`, but from the code point of view, I don't see why this change causes this warning.


The line in `non_negative_integer_semiring.py`:

```
from sage.sets.non_negative_integers import NonNegativeIntegers
```
probably explains the link.

The semiring class inherits from it and the `__init__` chains to it. So that's a programmatic link. Apparently, something in the category framework for `FacadeSets` lazy-imports these and the initialization of `NN` triggers the resolution; now prior to conclusion of start-up. So that suggests there's a further lazy import that should be scuttled, because it now gets resolved upon startup anyway. I think that was the costly bit before, but by the looks of it the cost may not be so high anymore. Python's import framework has improved over the years, if I'm not mistaken and/or you've tested on a filesystem that has very little overhead when warmed up.

in fact, as far as I can find, it happens in `sets_cat.py` in `class Sets(Category_singleton)`; line 1882. There's a whole bunch of class-namespace-level `LazyImport`s there; some of them marked `at_startup`, which should silence the warning. You might want to double-check why those are lazy: is it to solve some otherwise circular import problem?

I suspect the trigger that actually resolves the lazy shim here is `self._with_axiom('Facade')`, which is probably executed somewhere in creating the category for `NN` or the semiring. If I recall correctly, this is one of the points where the category framework really ceases to by Python and instead is some other kind of programming language bolted onto Python infrastructure. It's certainly the kind of shenanigans that makes me never want to get near it.



---

archive/issue_comments_487010.json:
```json
{
    "body": "Nils, thanks for the pointer to the lines in `sets_cat.py`. Changing those fixed the problem.\n\nHere's a branch. I'm at home working on a slower machine, and I don't see any differences in startup time between this and my `develop` branch. I made limited changes here, focusing almost completely on `NN`. Other lazy import issues should be handled on other tickets.\n\nTests might pass, although I just upgraded to the latest MacOS so I am seeing failures. They should be unrelated to these changes. Please test it.\n\n---\nNew commits:",
    "created_at": "2022-10-27T03:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487010",
    "user": "https://github.com/jhpalmieri"
}
```

Nils, thanks for the pointer to the lines in `sets_cat.py`. Changing those fixed the problem.

Here's a branch. I'm at home working on a slower machine, and I don't see any differences in startup time between this and my `develop` branch. I made limited changes here, focusing almost completely on `NN`. Other lazy import issues should be handled on other tickets.

Tests might pass, although I just upgraded to the latest MacOS so I am seeing failures. They should be unrelated to these changes. Please test it.

---
New commits:



---

archive/issue_comments_487011.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-10-27T03:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487011",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_487012.json:
```json
{
    "body": "Okay, if I suppress the warning messages \"ld: warning: dylib ... was built for newer macOS version (...) than being linked (...)\", then all doctests pass.",
    "created_at": "2022-10-27T20:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487012",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, if I suppress the warning messages "ld: warning: dylib ... was built for newer macOS version (...) than being linked (...)", then all doctests pass.



---

archive/issue_comments_487013.json:
```json
{
    "body": "The changes from lazy to eager ...\n\n```\n--- a/src/sage/categories/sets_cat.py\n+++ b/src/sage/categories/sets_cat.py\n@@ -1878,13 +1878,13 @@ \n                 cls = ImageSubobject\n             return cls(self, domain_subset)\n \n-    Facade = LazyImport('sage.categories.facade_sets', 'FacadeSets')\n+    from sage.categories.facade_sets import FacadeSets as Facade\n```\n... break a modularization test (sagemath-objects) - see \nhttps://github.com/sagemath/sagetrac-mirror/actions/runs/3334274863/jobs/5517058687",
    "created_at": "2022-11-12T23:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487013",
    "user": "https://github.com/mkoeppe"
}
```

The changes from lazy to eager ...

```
--- a/src/sage/categories/sets_cat.py
+++ b/src/sage/categories/sets_cat.py
@@ -1878,13 +1878,13 @@ 
                 cls = ImageSubobject
             return cls(self, domain_subset)
 
-    Facade = LazyImport('sage.categories.facade_sets', 'FacadeSets')
+    from sage.categories.facade_sets import FacadeSets as Facade
```
... break a modularization test (sagemath-objects) - see 
https://github.com/sagemath/sagetrac-mirror/actions/runs/3334274863/jobs/5517058687



---

archive/issue_comments_487014.json:
```json
{
    "body": "(sagemath-objects does not ship facade_sets; that could be changed in pkgs/sagemath-objects/MANIFEST.in, pkgs/sagemath-categories/MANIFEST.in.m4 if necessary.)",
    "created_at": "2022-11-12T23:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487014",
    "user": "https://github.com/mkoeppe"
}
```

(sagemath-objects does not ship facade_sets; that could be changed in pkgs/sagemath-objects/MANIFEST.in, pkgs/sagemath-categories/MANIFEST.in.m4 if necessary.)



---

archive/issue_comments_487015.json:
```json
{
    "body": "We could also try the import and `except ModuleNotFoundError:` do a lazy import instead. I don't know the right approach.",
    "created_at": "2022-11-12T23:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487015",
    "user": "https://github.com/jhpalmieri"
}
```

We could also try the import and `except ModuleNotFoundError:` do a lazy import instead. I don't know the right approach.



---

archive/issue_comments_487016.json:
```json
{
    "body": "I think adding facade_sets to sagemath-objects is well motivated; facade parents are an aspect of the parent/element framework.\n\nHowever, I wouldn't like to do the same change with metric_spaces.",
    "created_at": "2022-11-13T01:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487016",
    "user": "https://github.com/mkoeppe"
}
```

I think adding facade_sets to sagemath-objects is well motivated; facade parents are an aspect of the parent/element framework.

However, I wouldn't like to do the same change with metric_spaces.



---

archive/issue_comments_487017.json:
```json
{
    "body": "I don't mind changing the `metric_spaces` import back to being lazy. That shouldn't affect `NN`, it was just something that was convenient to change at the same time.",
    "created_at": "2022-11-13T01:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487017",
    "user": "https://github.com/jhpalmieri"
}
```

I don't mind changing the `metric_spaces` import back to being lazy. That shouldn't affect `NN`, it was just something that was convenient to change at the same time.



---

archive/issue_comments_487018.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-11-13T01:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_487019.json:
```json
{
    "body": "(Not sure if I made the right changes to the manifests.)",
    "created_at": "2022-11-13T01:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487019",
    "user": "https://github.com/jhpalmieri"
}
```

(Not sure if I made the right changes to the manifests.)



---

archive/issue_comments_487020.json:
```json
{
    "body": "LGTM, let's wait for the Build&Test action",
    "created_at": "2022-11-13T01:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487020",
    "user": "https://github.com/mkoeppe"
}
```

LGTM, let's wait for the Build&Test action



---

archive/issue_comments_487021.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-13T05:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487021",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_487022.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-11-13T18:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487022",
    "user": "https://github.com/jhpalmieri"
}
```

Thanks!



---

archive/issue_comments_487023.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-11-15T23:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34415#issuecomment-487023",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_089717.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-11-15T23:43:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34415",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34415#event-89717"
}
```
