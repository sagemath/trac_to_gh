# Issue 34156: add method "components" to tensor products

Issue created by migration from https://trac.sagemath.org/ticket/34393

Original creator: chapoton

Original creation time: 2022-08-20 10:05:47

CC:  tscrim

so that one can easily access them


---

Comment by chapoton created at 2022-08-20 10:06:15

Changing status from new to needs_review.


---

Comment by chapoton created at 2022-08-20 15:11:17

meeting an unexpected issue with Schur algebras.. to be investigated


---

Comment by mkoeppe created at 2022-08-20 15:51:14


```
+            def construction(self):
...
+                return [tensor, *self._reduction[1]]
```


This can't possibly be correct code to be included in the category. `_reduction` is set by `UniqueRepresentation`, so it's under control of implementation classes, not the category


---

Comment by chapoton created at 2022-08-21 07:04:04

Replying to [comment:3 mkoeppe]:
> {{{
> +            def construction(self):
> ...
> +                return [tensor, *self._reduction[1]]
> }}}
> 
> This can't possibly be correct code to be included in the category. `_reduction` is set by `UniqueRepresentation`, so it's under control of implementation classes, not the category

ok, right. Any better idea ? My final aim would be to have tensor products of morphisms..


---

Comment by mkoeppe created at 2022-08-21 07:45:32

No better idea than having `CombinatorialFreeModule_Tensor.__init__` (or other implementation classes) save the info that you need


---

Comment by git created at 2022-08-21 15:30:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-08-21 15:31:46

The information seems to be stored in `_sets`. Let us try.


---

Comment by mkoeppe created at 2022-08-21 16:13:00

That's an implementation detail, so I think the method `components` should be ``@`abstract_method(optional=True)` in the category, and the implementation should go to `CombinatorialFreeModule_Tensor`


---

Comment by mkoeppe created at 2022-08-21 16:14:13

Also the method name is not specific enough. How about `tensor_factors` (this mirrors `cartesian_factors`, which is already in use?


---

Comment by mkoeppe created at 2022-08-21 16:18:51

And this can be moved to a larger category - at least to `FreeModules`, where it would apply to `sage.tensor.modules.tensor_free_module.TensorFreeModule`


---

Comment by git created at 2022-08-21 16:35:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-21 17:05:29

Replying to [comment:10 mkoeppe]:
> And this can be moved to a larger category - at least to `FreeModules`, where it would apply to `sage.tensor.modules.tensor_free_module.TensorFreeModule`

Make that `Modules`. (The category `FreeModules` only exists on my wishlist - #30164 - not in code.)


---

Comment by git created at 2022-08-21 17:53:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-21 18:29:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2022-08-22 00:05:38

Replying to [comment:8 mkoeppe]:
> That's an implementation detail, so I think the method `components` should be ``@`abstract_method(optional=True)` in the category, and the implementation should go to `CombinatorialFreeModule_Tensor`

I would actually go one step further and make it explicitly an ``@`abstract_method` like `Sets().CartesianProducts()` does with `cartesian_factors()`. Then you could implement

```python
def construction(self):
   return (TensorProductFunctor(self.category()), self.tensor_factors())
```

again following `Sets().CartesianProducts()`.


---

Comment by git created at 2022-08-22 06:36:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 11:52:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 16:28:06


```
+                sage: F = CombinatorialFreeModule(ZZ, [1,2])
+                sage: F.__custom_name = "F"
+                sage: G = CombinatorialFreeModule(ZZ, [3,4])
+                sage: G.__custom_name = "G"
```

Is there a reason why you don't use `F.rename("F")` here?


---

Comment by git created at 2022-08-22 16:53:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 22:23:28

Replying to [comment:16 tscrim]:
> I would actually go one step further and make it explicitly an ``@`abstract_method`

Does adding a required method to the category not have the potential of breaking user code?


---

Comment by mkoeppe created at 2022-08-22 22:46:05

I would suggest some `try... except NotImplementError: deprecation(...)`


---

Comment by tscrim created at 2022-08-23 01:12:27

Replying to [comment:21 mkoeppe]:
> Replying to [comment:16 tscrim]:
> > I would actually go one step further and make it explicitly an ``@`abstract_method`
> 
> Does adding a required method to the category not have the potential of breaking user code?

It won't break any user code. Only one of the `TestSuite` tests will fail.


---

Comment by mkoeppe created at 2022-08-23 01:17:33

Care to explain why errors raised by `construction` would not matter?


---

Comment by tscrim created at 2022-08-23 01:27:39

Replying to [comment:24 mkoeppe]:
> Care to explain why errors raised by `construction` would not matter?

It was just using the default previously, so it was a no-op. However, you should still get failures where you had failures before (such as trying to do a coercion via a pushout) unless someone was explicitly calling `construction()` and checking against `None`. It is possible someone is doing this with a custom class in the tensor product category, so they will have to fix their code. However, the error message will be clear about what needs to be done to fix it. Their could would break in a different way when using Sage's classes (e.g., `CFM_tensor`).

Additionally, you would still get errors whether or not it was `optional=True` or not.

I think by putting a `try`-`except` block around it with a deprecation message (which nothing is being deprecated), you are increasing Sage's technical debt for people who are doing something fairly advanced and likely should know better than to do this.


---

Comment by mkoeppe created at 2022-08-23 01:29:59

Of course something is getting deprecated, namely implementation classes in this category that do not define the `tensor_factors` method.


---

Comment by mkoeppe created at 2022-08-23 01:30:36

Replying to [comment:25 tscrim]:
> Additionally, you would still get errors whether or not it was `optional=True` or not.

comment:22 has a solution


---

Comment by tscrim created at 2022-08-23 02:02:44

Replying to [comment:26 mkoeppe]:
> Of course something is getting deprecated, namely implementation classes in this category that do not define the `tensor_factors` method.

No, they are not, as a deprecation (in software) means something that is going to be removed. They simply need to be patched.


---

Comment by mkoeppe created at 2022-08-23 02:05:23

Yes, and that "something" is the support for such user-defined implementation classes.


---

Comment by tscrim created at 2022-08-23 02:47:53

Fine. The nomenclature isn't a hill I am willing to die on.

However, I still am not completely convinced not breaking backwards compatibility is worth the technical debt in this case. (I originally wanted to use the pun "we should bend over backwards for backwards compatibility" but that is just a bit too dramatic.) Since the solution here is relatively simple, I can let it pass. (If I wanted to be really nit-picky, I would also insist on consistency/equality and require letting people know about the behavior change for `CFM_tensor` as that could break people's code is much more subtle ways. Both things are basically [spacebars](https://xkcd.com/1172/) to me.)

Side note: comment:22 is not a solution for ``@`abstract_method(optional=True)` simply becomes a `NotImplemented`:

```
sage: class Foo():
....:     @abstract_method(optional=True)
....:     def bar(self):
....:         """
....:         doc
....:         """
....:         
sage: F = Foo()
sage: F.bar
NotImplemented
```



---

Comment by mkoeppe created at 2022-08-23 02:54:01

(untested)
----
New commits:


---

Comment by mkoeppe created at 2022-08-23 03:00:58

Replying to [comment:25 tscrim]:
> I think by putting a `try`-`except` block around it with a deprecation message (which nothing is being deprecated), you are increasing Sage's technical debt [...]

"Technical debt" is a big scary word. But no, doing proper deprecation does not add to the debt.


---

Comment by git created at 2022-08-23 03:55:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-08-23 03:56:47

Am I missing something or should this go to `Modules.TensorProducts`, not `Modules.FiniteDimensional.TensorProducts`?


---

Comment by mkoeppe created at 2022-08-23 07:38:43

Also, maybe instead of just requiring the method `tensor_factors`, how about specifying a method just like `CombinatorialFreeModule.tensor_constructor`?

From its domain, the tensor factors can be read off.


---

Comment by chapoton created at 2022-08-23 09:28:01

trying to move code around to Modules.TensorProducts
----
New commits:


---

Comment by git created at 2022-08-23 13:50:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-08-23 13:52:02

there remains an issue in `sage.algebras.schur_algebra.SchurTensorModule`

EDIT:

which is strangely inheriting directly

```
class SchurTensorModule(CombinatorialFreeModule_Tensor):
```

and is the unique such place in sage code

maybe it should rather inherit just from `CombinatorialFreeModule` ?


---

Comment by tscrim created at 2022-08-25 00:56:30

Replying to [comment:39 chapoton]:
> there remains an issue in `sage.algebras.schur_algebra.SchurTensorModule`
> 
> EDIT:
> 
> which is strangely inheriting directly
> {{{
> class SchurTensorModule(CombinatorialFreeModule_Tensor):
> }}}
> and is the unique such place in sage code
> 
> maybe it should rather inherit just from `CombinatorialFreeModule` ?

No, we shouldn't, at least without also removing `TensorProducts()` from its category (thereby completely stripping the fact it knows and carries a tensor product of `R`-modules structure).

The problem is exactly what the test is failing for: The construction is not giving the parent back. The underlying issue is that we do not have a Schur algebra representation on the individual factors. So it needs its own `construction()` method. The simple fix is just to have it return `None` to match the previous behavior. The more complicated one is to implement a `ConstructorFunctor` for it, but I don't think that will be useful here.


---

Comment by git created at 2022-08-25 06:54:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-08-25 10:24:24

all green lights. Ready to go ?


---

Comment by mkoeppe created at 2022-08-25 11:12:35

any thoughts on comment:36?


---

Comment by chapoton created at 2022-08-25 11:14:28

using tensor_factors seems to be consistent with cartesian_factors


---

Comment by mkoeppe created at 2022-08-25 15:52:36

Yes... this is why I suggested this name in comment:9.

But Cartesian products also have a method `cartesian_projection` that provides the morphisms that connect the product to the factors.


---

Comment by chapoton created at 2022-08-25 17:12:15

but there are no canonical morphisms from a tensor product to its factors


---

Comment by mkoeppe created at 2022-08-25 17:13:15

I suggested a different morphism in comment:36


---

Comment by chapoton created at 2022-08-25 17:41:05

please let us keep that possibility for another ticket


---

Comment by tscrim created at 2022-08-26 02:34:31

I agree that we should have another ticket for possible generic morphisms as that is likely fraught with cases that could appear in general (like we had with `construction()` and Schur algebra modules).


---

Comment by chapoton created at 2022-08-26 15:05:45

so, good to go ?


---

Comment by mkoeppe created at 2022-08-26 19:10:18

No objections here


---

Comment by tscrim created at 2022-08-27 01:21:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-30 19:02:40


```
sage -t --long --warn-long 49.3 --random-seed=123 src/sage/categories/modules.py
**********************************************************************
File "src/sage/categories/modules.py", line 942, in sage.categories.modules.Modules.TensorProducts.ParentMethods.t
ensor_factors
Failed example:
    M.construction()
Expected:
    doctest:warning...
    DeprecationWarning: implementations of Modules().TensorProducts() now must define the method tensor_factors
    See https://trac.sagemath.org/34393 for details.
Got:
    doctest:warning
      File "/home/release/Sage/src/bin/sage-runtests", line 154, in <module>
        err = DC.run()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1384, in run
        self.run_doctests()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1059, in run_doctests
        self.dispatcher.dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2021, in dispatch
        self.parallel_dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 1916, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2190, in start
        super().start()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/process.py", li
ne 121, in start
        self._popen = self._Popen(self)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/context.py", li
ne 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/context.py", li
ne 277, in _Popen
        return Popen(process_obj)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/popen_fork.py",
 line 19, in __init__
        self._launch(process_obj)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/popen_fork.py",
 line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2162, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2492, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2544, in _run
        result = runner.run(test)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 866, in run
        return self._run(test, compileflags, out)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.modules.Modules.TensorProducts.ParentMethods.tensor_factors[7]>", line 1, in <module>
        M.construction()
      File "/home/release/Sage/src/sage/combinat/free_module.py", line 475, in construction
        c = super().construction()
      File "/home/release/Sage/src/sage/categories/modules.py", line 917, in construction
        deprecation(34393, "implementations of Modules().TensorProducts() now must define the method tensor_factors")
      File "/home/release/Sage/src/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/home/release/Sage/src/sage/misc/superseded.py", line 180, in warning
        warn(message, warning_class, stacklevel)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.5/lib/python3.10/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: implementations of Modules().TensorProducts() now must define the method tensor_factors
    See https://trac.sagemath.org/34393 for details.
    (VectorFunctor, Integer Ring)
**********************************************************************
```



---

Comment by vbraun created at 2022-08-30 19:02:40

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-08-31 18:54:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-08-31 18:54:35

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2022-08-31 18:54:35

doctest fixed, back to needs review


---

Comment by tscrim created at 2022-08-31 23:15:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-09-22 22:35:31

Resolution: fixed


---

Comment by mkoeppe created at 2022-10-02 19:08:45

Replying to [comment:36 Matthias Köppe]:
> Also, maybe instead of just requiring the method `tensor_factors`, how about specifying a method just like `CombinatorialFreeModule.tensor_constructor`?
> 
> From its domain, the tensor factors can be read off.

I've opened #34628 for this
