# Issue 22449: Curl testsuite fails on OSX

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2017-03-26 20:03:41

CC:  charpent jpflori jdemeyer fbissey


```
[curl-7.53.1] test 2054...OK (1062 out of 1063, remaining: 00:00)
[curl-7.53.1] test 2055...OK (1063 out of 1063, remaining: 00:00)
[curl-7.53.1] TESTDONE: 825 tests out of 828 reported OK: 99%
[curl-7.53.1] TESTFAIL: These test cases failed: 1086 1901 1903 
[curl-7.53.1] TESTDONE: 1073 tests were considered during 612 seconds.
[curl-7.53.1] make[4]: *** [quiet-test] Error 1
[curl-7.53.1] make[3]: *** [test] Error 2
[curl-7.53.1] make[3]: Target `check' not remade because of errors.
[curl-7.53.1] 
[curl-7.53.1] real	10m49.372s
[curl-7.53.1] user	1m46.413s
[curl-7.53.1] sys	0m53.801s
[curl-7.53.1] ************************************************************************
[curl-7.53.1] Error testing package curl-7.53.1
[curl-7.53.1] ************************************************************************
```



---

Comment by dimpase created at 2017-04-09 22:50:25

Perhaps it will look better if built with clang? That's likely that it wasn't tested with gcc on a recent OSX.


---

Comment by fbissey created at 2017-04-09 23:03:17

Investigating....


---

Comment by fbissey created at 2017-04-10 02:27:45

Better but not perfect

```
[curl-7.53.1] TESTDONE: 827 tests out of 828 reported OK: 99%
[curl-7.53.1] TESTFAIL: These test cases failed: 1119 
[curl-7.53.1] TESTDONE: 1073 tests were considered during 333 seconds.
```

Only one failure against three previously but it is a completely different one. Trying to get a grip on the failure.


---

Comment by fbissey created at 2017-04-10 02:47:11

Ugly

```
(sage-sh) fbissey`@`Mirage:tests$ more log/stderr1119 
In file included from ./../include/curl/curl.h:38:
In file included from ../include/curl/curlbuild.h:152:
In file included from /usr/include/sys/socket.h:81:
In file included from /usr/include/Availability.h:190:
/usr/include/AvailabilityInternal.h:22938:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_12
         ^
/usr/include/AvailabilityInternal.h:22867:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_11_4
         ^
/usr/include/AvailabilityInternal.h:22800:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_11_3
         ^
/usr/include/AvailabilityInternal.h:22737:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_11_2
         ^
/usr/include/AvailabilityInternal.h:22678:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_11
         ^
/usr/include/AvailabilityInternal.h:22623:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_10_3
         ^
/usr/include/AvailabilityInternal.h:22572:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_10_2
         ^
/usr/include/AvailabilityInternal.h:22525:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_10
         ^
/usr/include/AvailabilityInternal.h:22482:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_9
         ^
/usr/include/AvailabilityInternal.h:22443:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_8
         ^
/usr/include/AvailabilityInternal.h:22408:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_7
         ^
/usr/include/AvailabilityInternal.h:22377:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_6
         ^
/usr/include/AvailabilityInternal.h:22350:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_5
         ^
/usr/include/AvailabilityInternal.h:22327:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_4
         ^
/usr/include/AvailabilityInternal.h:22308:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_3
         ^
/usr/include/AvailabilityInternal.h:22293:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_2
         ^
/usr/include/AvailabilityInternal.h:22282:10: error: unterminated conditional directive
        #if __MAC_OS_X_VERSION_MIN_REQUIRED >= __MAC_10_1
         ^
/usr/include/AvailabilityInternal.h:30:2: error: unterminated conditional directive
#ifndef __AVAILABILITY_INTERNAL__
 ^
In file included from ./../include/curl/curl.h:38:
In file included from ../include/curl/curlbuild.h:152:
In file included from /usr/include/sys/socket.h:81:
/usr/include/Availability.h:239:2: error: #else without #if
#else
 ^
fatal error: too many errors emitted, stopping now [-ferror-limit=]
20 errors generated.
Error preprocessing curl.h at ./symbol-scan.pl line 75.
```



---

Comment by fbissey created at 2017-04-10 23:30:27

The `cpp` coming with clang on OS X seems to be the sensitive kind. I replaced calls to `/usr/bin/cpp` set up in `tests/configurehelp.pm` by `clang -E` and now the test is passing. All the tests are passing with `clang` and the change for CPP.

```
TESTDONE: 828 tests out of 828 reported OK: 100%
TESTDONE: 1073 tests were considered during 339 seconds.
TESTINFO: 245 tests were skipped due to these restraints:
TESTINFO: "configured as DISABLED" 10 times (594, 836, 882, 938, 1209, 1211, 1316, 1510, 1512 and 1 more)
TESTINFO: "curl lacks http/2 server support" 3 times (1700, 1701, 1702)
TESTINFO: "curl lacks PSL support" 1 times (1136)
TESTINFO: "curl lacks Metalink support" 16 times (2005, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015 and 7 more)
TESTINFO: "curl lacks unittest support" 22 times (1300, 1301, 1302, 1303, 1304, 1305, 1306, 1307, 1308 and 13 more)
TESTINFO: "curl lacks TLS-SRP support" 5 times (320, 321, 322, 323, 324)
TESTINFO: "curl lacks debug support" 78 times (67, 68, 69, 81, 89, 90, 91, 150, 155 and 69 more)
TESTINFO: "curl lacks SSLpinning support" 7 times (2034, 2035, 2037, 2038, 2041, 2042, 2048)
TESTINFO: "curl lacks OpenSSL support" 2 times (307, 308)
TESTINFO: "curl lacks WinSSL support" 1 times (2043)
TESTINFO: "curl lacks sftp server support" 33 times (582, 583, 600, 602, 604, 606, 608, 609, 610 and 24 more)
TESTINFO: "curl lacks idn support" 5 times (165, 1034, 1035, 2046, 2047)
TESTINFO: "curl lacks scp server support" 11 times (601, 603, 605, 607, 617, 619, 621, 623, 629 and 2 more)
TESTINFO: "rlimit problem: select limit is FD_SETSIZE 1024" 2 times (518, 537)
TESTINFO: "curl lacks TrackMemory support" 2 times (96, 558)
TESTINFO: "curl lacks GSS-API support" 1 times (1282)
TESTINFO: "Resolving IPv6 'ip6-localhost' didn't work" 2 times (241, 1083)
TESTINFO: "curl lacks http/2 support" 1 times (1800)
TESTINFO: "no stunnel" 25 times (300, 301, 302, 303, 304, 305, 306, 309, 310 and 16 more)
TESTINFO: "curl lacks sftp support" 1 times (632)
TESTINFO: "got unexpected host name back, LD_PRELOAD failed" 17 times (831, 834, 877, 880, 933, 936, 2023, 2024, 2025 and 8 more)
```



---

Comment by fbissey created at 2017-04-11 00:40:30

OK, I now see that on recent OS X `curl` is actually build with `clang` anyway. And if I undo my hack that sets `CPP` to `/usr/bin/cpp` in `sage-env` (which means it is set to gcc's installed cpp) the test suite is also successful. I think we need more details on the machines where it fails.


---

Comment by fbissey created at 2017-04-18 22:04:37

I just tried again on top of #12426 as it is now and I get 0 failures.


---

Comment by fbissey created at 2017-04-25 07:24:04

I am coming back to this and I think more generally this bit of `sage-env` is not helpful:

```
if [ -x "$SAGE_LOCAL/bin/cpp" ]; then
    CPP=cpp
fi
```

This will overrides what autotools default to, which is `$CC -E` (or `$CXX -E` if the current language is C++) and only if that's not working `cpp`. This can have a slightly different behavior especially if include folder and macros are passed with `CFLAGS` rather than `CPPFLAGS`, which is very very common.

Ultimately when I first ran the test my set up would pick some `cpp` instead of `clang -E` and that lead me to the observed failure. I would need some more of the log before inferring why you get 3 failures without #12426. Since `curl` has no dependencies we cannot blame another package not being built using `clang`. I am loath to start a sage build which will build a full `gcc` on my laptop. It is just too painful.


---

Comment by jhpalmieri created at 2017-04-25 15:53:59

I just ran the curl testsuite on Sage 8.0.beta3, and all tests passed. Maybe this depends on which version of OS X? I'm using 10.12.


---

Comment by dimpase created at 2017-04-25 15:59:53

Did you update your xcode meanwhile? (this could also be the reason it passes now)


---

Comment by jhpalmieri created at 2017-04-25 16:22:40

Yes, my Xcode was updated recently, the command line tools were updated yesterday.


---

Comment by slelievre created at 2018-02-14 03:37:00

Given access to computers running various versions of macOS,
how would one investigate whether this issue still exists?

(The ticket description contains a portion of output revealing errors,
but not the command that was run that triggered that output.)


---

Comment by fbissey created at 2018-02-14 03:43:27

This is actually fixed as a side effect of the work I have done in support of clang. Normally `./sage -f -c $pkg_name` would rebuild and trigger the spkg test suite if it exists.

But this ticket is now a duplicate I believe. That's the best way to describe it.


---

Comment by dimpase created at 2018-02-15 12:31:41

Well, it is certainly worth reporting upstream. Perhaps they have not been testing on clang much.


---

Comment by fbissey created at 2018-02-15 19:08:01

Replying to [comment:14 dimpase]:
> Well, it is certainly worth reporting upstream. Perhaps they have not been testing on clang much.

It was not a clang problem per see. It was sage-env insisting on defining CPP instead of letting `configure` use `$CC -E` all by itself.


---

Comment by fbissey created at 2018-02-18 21:17:21

If no one comes back saying they can still get the failure in the next couple of days I will mark this "duplicate" and close it.


---

Comment by fbissey created at 2018-02-25 23:07:05

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-02-25 23:07:05

A bit later than promised...


---

Comment by fbissey created at 2018-02-26 00:10:01

Does it needs an author since there is nothing?


---

Comment by fbissey created at 2018-02-26 00:10:01

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-05-18 17:16:26

Resolution: wontfix


---

Comment by vdelecroix created at 2018-05-18 17:16:26

closing positively reviewed duplicates
