# Issue 27517: Upgrade: Python 3.8.x

Issue created by migration from https://trac.sagemath.org/ticket/27754

Original creator: slelievre

Original creation time: 2019-05-01 01:46:00

CC:  chapoton embray fbissey jdemeyer mkoeppe slelievre @timokau isuruf @kliem tscrim heluani @sheerluck

This is to upgrade to Python 3.8.x.

- [PEP569 -- Python 3.8 Release Schedule](https://www.python.org/dev/peps/pep-0569/)
- [What's new in Python 3.8](https://docs.python.org/3.8/whatsnew/3.8.html)


---

Comment by slelievre created at 2019-05-01 01:46:48

If people want to start testing, Python 3.8.0a3 is out:
- [Python 3.8.0a3](https://www.python.org/downloads/release/python-380a3/)


---

Comment by jdemeyer created at 2019-05-01 09:36:47

I think it's a bit early for testing. I'd rather wait for the first beta, which is supposed to be released later this month.


---

Comment by slelievre created at 2019-06-10 16:39:41

Python 3.8.0b1 is out:

- [Python 3.8.0b1](https://www.python.org/downloads/release/python-380b1/)


---

Comment by jdemeyer created at 2019-06-11 10:09:32

Note: this requires a Cython upgrade.


---

Comment by slelievre created at 2019-06-11 20:23:29

Cython upgrade needs review at #27886.


---

Comment by slelievre created at 2019-06-19 00:30:10

Changing keywords from "" to "days101".


---

Comment by jdemeyer created at 2019-06-19 05:37:39

I'll have a look at this today.


---

Comment by jdemeyer created at 2019-06-19 12:45:00

Changing type from task to enhancement.


---

Comment by git created at 2019-06-19 14:50:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-06-19 14:52:12

Actually, thanks to two patches which are likely going to be accepted upstream, it no longer depends on the Cython upgrade.


---

Comment by jdemeyer created at 2019-06-19 15:57:56

There is a mysterious build failure of matplotlib:

```
Processing /home/jdemeyer/sage-python3/local/var/tmp/sage/build/matplotlib-2.2.3.p0/src
  Created temporary directory: /tmp/pip-req-build-vq4okaxf
  Added file:///home/jdemeyer/sage-python3/local/var/tmp/sage/build/matplotlib-2.2.3.p0/src to build tracker '/tmp/pip-req-tracker-xcv165b_'
  Running setup.py (path:/tmp/pip-req-build-vq4okaxf/setup.py) egg_info for package from file:///home/jdemeyer/sage-python3/local/var/tmp/sage/build/matplotlib-2.2.3.p0/src
    Running command python setup.py egg_info
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/tmp/pip-req-build-vq4okaxf/setup.py", line 172, in <module>
        result = package.check()
      File "/tmp/pip-req-build-vq4okaxf/setupext.py", line 963, in check
        import numpy
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/__init__.py", line 142, in <module>
        from . import core
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/core/__init__.py", line 16, in <module>
        from . import multiarray
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/core/multiarray.py", line 12, in <module>
        from . import overrides
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/core/overrides.py", line 8, in <module>
        from numpy.compat._inspect import getargspec
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/compat/__init__.py", line 14, in <module>
        from . import py3k
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/site-packages/numpy/compat/py3k.py", line 15, in <module>
        from pathlib import Path, PurePath
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/pathlib.py", line 391, in <module>
        class _NormalAccessor(_Accessor):
      File "/home/jdemeyer/sage-python3/local/lib/python3.8/pathlib.py", line 415, in _NormalAccessor
        link_to = os.link
    AttributeError: module 'os' has no attribute 'link'
```


But when running Python normally, `os.link` does exist:

```
jdemeyer@sage4:~/sage-python3$ ./sage --python3
Python 3.8.0b1 (default, Jun 19 2019, 16:54:26) 
[GCC 4.9.3] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import os
>>> os.link
<built-in function link>
```


I have no clue how this could happen.


---

Comment by jhpalmieri created at 2019-06-19 18:31:29

I tried this with OS X and ran into a problem with Pillow:

```
  File "setup.py", line 316, in build_extensions
    _add_directory(library_dirs, sysroot+"/usr/lib")
TypeError: unsupported operand type(s) for +: 'NoneType' and 'str'
```

Here is the problem code from Pillow's setup.py:

```
sysroot = sysconfig.get_config_var('Py_MACOS_SYSROOT')
_add_directory(library_dirs, sysroot+"/usr/lib")
```

Python 3.7.3 does this:

```
Python 3.7.3 (default, Jun 17 2019, 15:38:22) 
[Clang 10.0.1 (clang-1001.0.46.4)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sysconfig
>>> sysconfig.get_config_var('Py_MACOS_SYSROOT')
'/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk'
>>>
```

The new Python does this:

```
Python 3.8.0b1 (default, Jun 19 2019, 11:09:54) 
[Clang 10.0.1 (clang-1001.0.46.4)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sysconfig
>>> sysconfig.get_config_var('Py_MACOS_SYSROOT')
>>>
```



---

Comment by jhpalmieri created at 2019-06-19 18:48:49

I see the same problem with matplotlib. For laughs, I put a `print(dir(os))` command right before the line `link_to = os.link`. The output is identical to what I get when I do `import os; dir(os)` from `sage --python3`, except it is missing `link`.

If I run `make -k`, I also see problems building the Sage library, by the way: lots of errors of the form

```
RuntimeError: 
        An attempt has been made to start a new process before the
        current process has finished its bootstrapping phase.

        This probably means that you are not using fork to start your
        child processes and you have forgotten to use the proper idiom
        in the main module:

            if __name__ == '__main__':
                freeze_support()
                ...

        The "freeze_support()" line can be omitted if the program
        is not going to be frozen to produce an executable.
```



---

Comment by jdemeyer created at 2019-06-19 19:16:56

Replying to [comment:16 jhpalmieri]:
> I see the same problem with matplotlib. For laughs, I put a `print(dir(os))` command right before the line `link_to = os.link`. The output is identical to what I get when I do `import os; dir(os)` from `sage --python3`, except it is missing `link`.

That makes no sense. Somebody is fooling with us...

Could you try also `print(os)`? Maybe there is a different `os` module shadowing the standard one or something...

Just in case, I checked that the problem unfortunately persists after `make distclean`.

And a Google search for this error doesn't find anything.


---

Comment by jhpalmieri created at 2019-06-19 19:31:30

I'm guessing the problem is coming from `matplotlib`'s setup.py:

```
import os
try:
    del os.link
except AttributeError:
    pass
```



---

Comment by jhpalmieri created at 2019-06-19 19:34:56

My question is why it worked with Python 3.7.3 but not 3.8.0.


---

Comment by jdemeyer created at 2019-06-19 19:52:00

Replying to [comment:19 jhpalmieri]:
> My question is why it worked with Python 3.7.3 but not 3.8.0.

A different implementation of `pathlib`: https://bugs.python.org/issue26978


---

Comment by jdemeyer created at 2019-06-19 20:06:23

I reported this to matplotlib: https://github.com/matplotlib/matplotlib/issues/14580


---

Comment by git created at 2019-06-20 11:59:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-06-20 12:11:04

With matplotlib fixes, I'm getting these errors at runtime:

```
Exception ignored in: <sage.misc.weak_dict.WeakValueDictEraser object at 0x7f1bf60b5460>
Traceback (most recent call last):
  File "sage/misc/weak_dict.pyx", line 219, in sage.misc.weak_dict.WeakValueDictEraser.__call__ (build/cythonized/sage/misc/weak_dict.c:1968)
  File "sage/cpython/dict_del_by_value.pyx", line 375, in sage.cpython.dict_del_by_value.del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2311)
  File "sage/cpython/dict_del_by_value.pyx", line 294, in sage.cpython.dict_del_by_value.ensure_allows_deletions (build/cythonized/sage/cpython/dict_del_by_value.c:2025)
AssertionError: 
```



---

Comment by jdemeyer created at 2019-06-20 14:33:06

Also getargspec is completely broken, causing docbuild errors.


---

Comment by chapoton created at 2019-06-20 14:35:09

see #27971 for getargspec ?


---

Comment by jdemeyer created at 2019-06-20 15:01:31

Replying to [comment:27 chapoton]:
> see #27971 for getargspec ?

I'll have to look at that. In any case, these seem to be new failures that did not exist on Python 3.7.


---

Comment by jhpalmieri created at 2019-06-20 17:42:41

Replying to [comment:15 jhpalmieri]:
> I tried this with OS X and ran into a problem with Pillow:
> Here is the problem code from Pillow's setup.py:
> {{{
> sysroot = sysconfig.get_config_var('Py_MACOS_SYSROOT')
> _add_directory(library_dirs, sysroot+"/usr/lib")
> }}}

This is actually added in a Sage patch. It's failing because of the removal of `macos_no_include.patch`, which was added in #27631. I'll have to see if that patch is necessary anymore. If not, we need to unpatch Pillow.


---

Comment by jhpalmieri created at 2019-06-20 19:29:17

I still gets lots of errors as in comment:16. The build process for `sagelib` seems to go into an infinite loop. I just hit ctrl-C, and there are about 2400 instances of

```
************************************************************************
Error building the Sage library
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the relevant part of the log file
  /Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/logs/pkgs/sagelib-8.8.rc2.log
Describe your computer, operating system, etc.
```

in the log file, all connected with the same error message.


---

Comment by jdemeyer created at 2019-06-20 19:30:26

On which system are you seeing that? The build of the Sage library worked for me on Linux.


---

Comment by jhpalmieri created at 2019-06-20 22:05:17

Replying to [comment:31 jdemeyer]:
> On which system are you seeing that? The build of the Sage library worked for me on Linux.

OS X, both 10.13 and 10.14.


---

Comment by jhpalmieri created at 2019-06-20 22:07:33

Replying to [comment:29 jhpalmieri]:
> Replying to [comment:15 jhpalmieri]:
> > I tried this with OS X and ran into a problem with Pillow:
> > Here is the problem code from Pillow's setup.py:
> > {{{
> > sysroot = sysconfig.get_config_var('Py_MACOS_SYSROOT')
> > _add_directory(library_dirs, sysroot+"/usr/lib")
> > }}}
> 
> This is actually added in a Sage patch. It's failing because of the removal of `macos_no_include.patch`, which was added in #27631. I'll have to see if that patch is necessary anymore. If not, we need to unpatch Pillow.

On an OS X 10.14 machine, one affected by #27631 (no `/usr/include`), `pip` builds just fine, so I think Python and pip are finding zlib, but Pillow does not. 

If I keep the Pillow patch, it fails to build at all, with the error mentioned above. If I delete the Pillow patch and build, I see in its log file "The headers and library files could not be found for zlib".


---

Attachment

Here is the start of the log file. I've deleted more than 2000 repeated tracebacks.


---

Comment by jhpalmieri created at 2019-06-22 02:19:54

I think the problem is this (from the [3.8 changelog](https://www.python.org/downloads/release/python-380b1/)):

```
on macOS, the spawn start method is now used by default in multiprocessing
```

The documentation for `multiprocessing` then points to a [bug report](https://bugs.python.org/issue33725) which discusses our old friend `OBJC_DISABLE_INITIALIZE_FORK_SAFETY` (#25921). So if we get multiprocessing to work properly on OS X, maybe we can remove the line

```
    export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
```

from sage-env.

In the meantime, I don't know how to get it working properly; using `fork` instead of `spawn` in `src/setup.py` is the only way I've found to proceed so far. I don't understand the distinctions in the [multiprocessing documentation](https://docs.python.org/3.8/library/multiprocessing.html#contexts-and-start-methods) between `fork` and `spawn` to know what should be set differently to use `spawn` correctly.


---

Comment by jhpalmieri created at 2019-06-22 02:41:00

Using `fork` instead of `spawn` lets me build the Sage library:

```diff
diff --git a/src/setup.py b/src/setup.py
index 42ba3a63da..5e2d65f9cc 100755
--- a/src/setup.py
+++ b/src/setup.py
@@ -493,11 +493,12 @@ def execute_list_of_commands_in_parallel(command_list, nthreads):
         progress = progress_fmt.format(i+1, N)
         command_list[i] = command_list[i] + (progress,)
 
-    from multiprocessing import Pool
+    import multiprocessing as mp
+    mp.set_start_method('fork')
     # map_async handles KeyboardInterrupt correctly if an argument is
     # given to get().  Plain map() and apply_async() do not work
     # correctly, see Trac #16113.
-    pool = Pool(nthreads)
+    pool = mp.Pool(nthreads)
     result = pool.map_async(apply_func_progress, command_list, 1).get(99999)
     pool.close()
     pool.join()
```

I made a similar change to allow docbuilding to work. Now I get failures with docbuilding. First, lots of warnings:

```
..../local/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:531: DeprecationWarning: PY_SSIZE_T_CLEAN will be required for '#' formats
```

Then an error:

```
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/runpy.py", line 192, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 1731, in main
    builder()
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 352, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 548, in _wrapper
    build_many(build_ref_doc, L)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 289, in build_many
    ret = x.get(99999)
  File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2/local/lib/python3.8/multiprocessing/pool.py", line 768, in get
    raise self._value
OSError: WARNING: error while formatting arguments for sage.calculus.riemann.Riemann_Map.get_szego: bad operand type for unary -: 'NoneType'
```



---

Comment by jhpalmieri created at 2019-06-22 02:52:14

And of course I can't run any doctests because they use `multiprocessing`, and I haven't figured out how to tell doctesting (forker.py in particular) to use `fork` instead of `spawn`. Sage starts and some basic things work. The Jupyter notebook is giving me problems.


---

Comment by jdemeyer created at 2019-06-24 13:55:41

I also didn't manage to build the docs because the same error. I know it's a problem with `sage_getargspec` but I haven't checked further.


---

Comment by jhpalmieri created at 2019-06-24 20:07:27

I don't have a good solution for the problem with Pillow (comment:33). I have been deleting the patch and force installing `zlib`, which works for now.


---

Comment by jhpalmieri created at 2019-06-24 20:26:51

For the record: for the `spawn` vs. `fork` issue with OS X, I have had to make changes in three files: `src/setup.py`, `src/sage_setup/docbuild/__init__.py`, and `Cython/Build/Dependencies.py`. The changes are all pretty much the same; for example in `docbuild/__init__.py`:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index 0f2700168a..6d1ff4e377 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -279,8 +279,9 @@ if not (CYGWIN_VERSION and CYGWIN_VERSION[0] < 3):
         # serialize this by taking the pool (and thus the call to fork()) out
         # completely: The call to Sphinx leaks memory, so we need to build each
         # document in its own process to control the RAM usage.
-        from multiprocessing import Pool
-        pool = Pool(NUM_THREADS, maxtasksperchild=1)
+        import multiprocessing
+        ctx = multiprocessing.get_context('fork')
+        pool = ctx.Pool(NUM_THREADS, maxtasksperchild=1)
         # map_async handles KeyboardInterrupt correctly. Plain map and
         # apply_async does not, so don't use it.
         x = pool.map_async(target, args, 1)
```



---

Comment by jhpalmieri created at 2019-06-24 20:44:03

I am also seeing the error "ImportError: cannot import name 'clock' from 'time' (unknown location)". I don't think this is coming from the Sage library, but rather from other packages, and in particular brial and sympy may need to be changed.

```
$ grep -R "from time import clock" local/lib/python3.8/
local/lib/python3.8//site-packages/sympy/plotting/pygletplot/plot_window.py:from time import clock
local/lib/python3.8//site-packages/brial/interpolate.py:from time import clock
local/lib/python3.8//site-packages/future/backports/test/pystone.py:from time import clock
local/lib/python3.8//site-packages/zmq/backend/cffi/_poll.py:    from time import clock as monotonic
local/lib/python3.8//site-packages/sage/coding/information_set_decoder.py:            from time import clock as process_time
```

Changing the import to something like

```
try:
    from time import perf_counter as clock # or process_time instead of perf_counter?
except ImportError:
    from time import clock
```

might work.


---

Comment by chapoton created at 2019-06-25 08:27:06

Replying to [comment:41 jhpalmieri]:
> I am also seeing the error "ImportError: cannot import name 'clock' from 'time' (unknown location)". I don't think this is coming from the Sage library, but rather from other packages, and in particular brial and sympy may need to be changed.
> {{{
> $ grep -R "from time import clock" local/lib/python3.8/
> local/lib/python3.8//site-packages/sympy/plotting/pygletplot/plot_window.py:from time import clock
> local/lib/python3.8//site-packages/brial/interpolate.py:from time import clock
> local/lib/python3.8//site-packages/future/backports/test/pystone.py:from time import clock
> local/lib/python3.8//site-packages/zmq/backend/cffi/_poll.py:    from time import clock as monotonic
> local/lib/python3.8//site-packages/sage/coding/information_set_decoder.py:            from time import clock as process_time
> }}}
> Changing the import to something like
> {{{
> try:
>     from time import perf_counter as clock # or process_time instead of perf_counter?
> except ImportError:
>     from time import clock
> }}}
> might work.

* The sympy issue has been fixed 16 days ago.
* I have just made a pull request for brial
* The zmq issue is already fixed in https://github.com/zeromq/pyzmq/blob/master/zmq/backend/cffi/_poll.py
* The last line (our own information_set_decoder.py) is already correctly using a try/except for this import.


---

Comment by jdemeyer created at 2019-08-30 09:32:18

Python 3.8 is getting closer, it would be great if somebody could review the dependency #28025.


---

Comment by slelievre created at 2019-10-15 14:01:43

Python 3.8.0 is out. Added tarball link to ticket description.


---

Comment by chapoton created at 2019-10-28 15:25:50

New commits:


---

Comment by chapoton created at 2019-10-28 15:33:07

apparently some patches do no longer apply..


---

Comment by jhpalmieri created at 2019-10-28 23:03:56

It looks to me as though the two new patches were actually merged into the release, and so they are no longer needed. I'm not positive, though.


---

Comment by jhpalmieri created at 2019-10-29 16:34:18

On OS X, the Pillow problem is still there. I tried upgrading to the most recent version of Pillow, but it did not help. I'm going to force installation of `zlib` and proceed from there.


---

Comment by jhpalmieri created at 2019-10-29 17:36:09

There is still a problem with a `from time import clock` statement. I don't know which one is causing the problem, but I'm guessing either brial or sympy. Neither package has fixed it in a release, as far as I can tell, but I think it's been fixed upstream in both.


---

Comment by jhpalmieri created at 2019-10-29 17:48:30

I am also, not surprisingly, having the same `multiprocessing` problems on OS X as before. I can get the Sage library and the documentation to build, but I don't know how to get doctesting to work.


---

Comment by arojas created at 2019-11-14 07:58:38

FWIW after updating to python 3.8 on Arch I'm getting test failures on 223 modules, so things don't look good. Most of them seem to stem from the same 3-4 issues though.


---

Comment by arojas created at 2019-11-22 18:25:54

After taking a closer look, besides some string changes, most of the failures fall into one of the following categories:

(1) Hash changes - all hashes have changed in 3.8. This requires updating many tests, making them conditional on the python version. Not sure if it makes sense to fork so many tests at this point rather than just drop python2 support or at least not run those tests.

(2) Sorting changes - many lists are now output in a different order. Same comment as in (1) about the solution.

(3) "DeprecationWarning: In future, it will be an error for 'np.bool_' scalars to be interpreted as an index" from numpy. These are fixed with https://github.com/matplotlib/matplotlib/commit/4651a125

(4) "DeprecationWarning: PY_SSIZE_T_CLEAN will be required for '#' formats" - this happens mostly when pickling/unpickling functions. No idea where the actual code that throws the warning is.

(5) "DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python." when calling time.sleep with a Sage (sage.rings.real_mpfr.RealLiteral) float. Coercing to float first fixes the issue.

(6) "SyntaxWarning: "is" with a literal. Did you mean "=="?" when comparing strings with 'is'

(7) Use of the removed cgi.escape in sage/interacts/debugger.py. Should be changed to html.escape.

(8) The signature of code() (used in sage/misc/fpickle.pyx) has changed and now requires a 'posonlyargcount' argument.

(9) Mismatch after pickling/unpickling for some objects:

```
sage: A = Poset()._hasse_diagram.antichains()
sage: A == loads(dumps(A))
False
```



For packagers that don't care about python2 compatibility (or 32 bit hashes) a WIP patch that fixes or works around most of these issues is at https://aur.archlinux.org/cgit/aur.git/tree/sagemath-python-3.8.patch?h=sagemath-git. A backport of https://github.com/BRiAl/BRiAl/commit/74d86170 is also needed.


---

Comment by slelievre created at 2019-12-10 17:44:41

Python 3.8.1rc1 was released. See python-announce post:

- https://mail.python.org/archives/list/python-announce-list`@`python.org/thread/IGJ6ZOAOT2WFY5ZIPRQNTHOSUMPUAO2H/


---

Comment by jhpalmieri created at 2019-12-10 18:48:49

It would be great if someone with access to OS X could look at this. I don't know how to solve all of the problems mentioned above. In particular:

- multiprocessing on OS X has a different default behavior than on linux (comment:35). As a result, the Sage library doesn't build and the docs don't build without some modification, and I don't know how to get doctesting to work.

- Pillow does not find the system `zlib`. Is there a better solution than force-installing Sage's `zlib`?


---

Comment by slelievre created at 2020-01-04 23:59:13

I have access to macOS but I would need to be told what to try.


---

Comment by slelievre created at 2020-01-05 00:00:00

Reports of issues with [SageMath](SageMath) and Python 3.8:

- Sage error from module `typing` and python 3.8
  https://ask.sagemath.org/question/49326

- Sage crash report: Manjaro, Python 3.8.1
  #28946


---

Comment by arojas created at 2020-01-05 07:01:29

Replying to [comment:60 slelievre]:
> Reports of issues with [SageMath](SageMath) and Python 3.8:
> 
> - Sage error from module `typing` and python 3.8
>   https://ask.sagemath.org/question/49326
> 
> - Sage crash report: Manjaro, Python 3.8.1
>   #28946

None of these is a Sage issue: the first one is caused by the user mixing up distro and pip packages, the second one is a ntl soversion mismatch in Manjaro. The errors that still need to be figured out (besides the macOS problems) are (4), (5) and (9) in comment:55 above.


---

Comment by embray created at 2020-01-06 14:08:14

Sage 9.0 is out.  I think this should wait until after 9.1 to give Sage with Python 3.7 a little more time to breathe, but of course this is debatable.


---

Comment by mkoeppe created at 2020-01-15 18:42:22

Replying to [comment:58 jhpalmieri]:
> - Pillow does not find the system `zlib`. Is there a better solution than force-installing Sage's `zlib`?

I have created #29019 for the problems with Pillow because they also affect #27824.


---

Comment by mkoeppe created at 2020-01-15 18:44:54

Replying to [comment:15 jhpalmieri]:
> I tried this with OS X and ran into a problem with Pillow:
> {{{
>   File "setup.py", line 316, in build_extensions
>     _add_directory(library_dirs, sysroot+"/usr/lib")
> TypeError: unsupported operand type(s) for +: 'NoneType' and 'str'
> }}}
> Here is the problem code from Pillow's setup.py:
> {{{
> sysroot = sysconfig.get_config_var('Py_MACOS_SYSROOT')
> _add_directory(library_dirs, sysroot+"/usr/lib")
> }}}
> Python 3.7.3 does this:
> {{{
> Python 3.7.3 (default, Jun 17 2019, 15:38:22) 
> [Clang 10.0.1 (clang-1001.0.46.4)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import sysconfig
> >>> sysconfig.get_config_var('Py_MACOS_SYSROOT')
> '/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk'
> >>>
> }}}
> The new Python does this:
> {{{
> Python 3.8.0b1 (default, Jun 19 2019, 11:09:54) 
> [Clang 10.0.1 (clang-1001.0.46.4)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import sysconfig
> >>> sysconfig.get_config_var('Py_MACOS_SYSROOT')
> >>>
> }}}

As far as I can see, this config variable was invented in #27631 and is not available on any other Python than our patched Python.


---

Comment by dimpase created at 2020-01-15 19:49:54

indeed, `Py_MACOS_SYSROOT`  comes from  #27631.
Note that #27631 followed a cpython patch we proposed on 
https://bugs.python.org/issue36231
which was rejected in favour of 
https://github.com/python/cpython/commit/c421c66a58a6caae30f0679d7e61411418e67cec

and so in 3.7.x with x>3 and in 3.y with y>7 the problem apparently is fixed, but I don't quite know how.
I don't have any access to a modern MacOS box with Xcode without sane `/usr/incude` etc, so it's hard to experiment for me (I guess the patch for pillow in #27631 needs to be replaced with whatever hack they came up with for MacOS.


---

Comment by jhpalmieri created at 2020-01-15 20:06:48

See comment:33 — I could not build Pillow (after removing Sage's patch) with Python 3.8. So I don't know if I believe that the problem has been fixed.


---

Comment by mkoeppe created at 2020-01-15 20:36:26

Replying to [comment:66 jhpalmieri]:
> See comment:33 — I could not build Pillow (after removing Sage's patch) with Python 3.8. So I don't know if I believe that the problem has been fixed.
Please try again with the latest commit in #29019.


---

Comment by git created at 2020-01-15 21:29:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2020-01-15 22:34:09

Replying to [comment:67 mkoeppe]:
> Replying to [comment:66 jhpalmieri]:
> > See comment:33 — I could not build Pillow (after removing Sage's patch) with Python 3.8. So I don't know if I believe that the problem has been fixed.
> Please try again with the latest commit in #29019.

That works for me. With this branch plus #29019, the build succeeds until I get to the Sage library, at which point the changes to multiprocessing start causing problems (as in comment:16, comment:35, comment:36).


---

Comment by jhpalmieri created at 2020-01-15 23:31:03

See https://github.com/cython/cython/issues/3262 and https://github.com/conda-forge/cython-feedstock/pull/59 (?) for multiprocessing issues with Cython + Python 3.8 + OS X. One proposed solution there is to disable parallel processing on OS X (or more generally if `multiprocessing.get_start_method() == 'spawn'`). Do we want to do that, or are we willing to use a patch like the proposal in comment:40, applied to `Cython/Build/Dependencies.py`?


---

Comment by jhpalmieri created at 2020-01-16 00:11:29

And by the way, even with the patches as in comment:40, I still can't get the documentation to build. It ends with

```
[dochtml]     ForkingPickler(file, protocol).dump(obj)
[dochtml] AttributeError: Can't pickle local object 'build_many.<locals>.run_worker'
```



---

Comment by @timokau created at 2020-03-18 00:05:50

Replying to [comment:55 arojas]:
[...]
> For packagers that don't care about python2 compatibility (or 32 bit hashes) a WIP patch that fixes or works around most of these issues is at https://aur.archlinux.org/cgit/aur.git/tree/sagemath-python-3.8.patch?h=sagemath-git. A backport of https://github.com/BRiAl/BRiAl/commit/74d86170 is also needed.

`@`arojas, I'm trying to update sage on nix to 9.0 with python 3.8. I'm using your 3.8 patch in the 9.0 version [1]. I'm still seeing some test failures caused by the python update though:


```
sage -t --long src/sage/categories/homset.py  # 3 doctests failed
sage -t --long src/sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py  # 1 doctest failed
sage -t --long src/sage/combinat/finite_state_machine.py  # 1 doctest failed
sage -t --long src/sage/combinat/posets/hasse_diagram.py  # 2 doctests failed
sage -t --long src/sage/groups/cubic_braid.py  # 1 doctest failed
sage -t --long src/sage/homology/simplicial_complex_morphism.py  # 1 doctest failed
sage -t --long src/sage/structure/sequence.py  # 2 doctests failed
```


Here[2] is the full log. You said that your patch fixes "most" failures, so is that to be expected? Do you have the same failures on arch?

[1] https://aur.archlinux.org/cgit/aur.git/plain/sagemath-python-3.8.patch?h=sagemath-git&id=138b3db82d8d13f9c66bf8d7515aa37671710e0a
[2] https://gist.github.com/timokau/13c97bf8f45162f3d4155999fc5bec13


---

Comment by arojas created at 2020-03-18 07:36:10

Replying to [comment:72 gh-timokau]:
> Here[2] is the full log. You said that your patch fixes "most" failures, so is that to be expected? Do you have the same failures on arch?

Yes, I have the same failures (the one in cubic_braid no longer happens in the latest beta). They are mostly related to pickling, which I don't understand.


---

Comment by @timokau created at 2020-03-18 13:37:38

Thanks!

I had a look at the python 3.8 changelog, the most obvious change seemed to be the change of the default pickle protocol (3 -> 4). But I have patched python to revert that change and that did not fix the issue.

I'll look into git-bisect'ing the cpython update, though that is of course not exactly trivial. Maybe it will help.


---

Comment by @jaliste created at 2020-03-31 13:06:48

there is a change of API in the ast, so this breaks old versions of ipython with python 3.8. In particular, it breaks ipython 5.8 so you cannot run sage under jupyter in python 3.8 so far.


---

Comment by mkoeppe created at 2020-03-31 14:38:02

I've added as a dependency: #28197 - upgrade to ipython 7


---

Comment by thansen created at 2020-04-05 13:06:31

Replying to [comment:55 arojas]:
> For packagers that don't care about python2 compatibility (or 32 bit hashes) a WIP patch that fixes or works around most of these issues is at https://aur.archlinux.org/cgit/aur.git/tree/sagemath-python-3.8.patch?h=sagemath-git.

Thanks for the patch. A version of this patch including the 32 bit hashes can now be found at https://salsa.debian.org/science-team/sagemath/-/blob/master/debian/patches/u0-version-python-3.8.patch.

Unfortunately many of the ordering issues addressed in this patch also depend on 32/64 bit now. See 32-bit build log at https://buildd.debian.org/status/fetch.php?pkg=sagemath&arch=i386&ver=9.0-3&stamp=1586083972&raw=0.


---

Comment by mkoeppe created at 2020-07-11 22:46:07

Can we get this ticket unstuck please?


---

Comment by jhpalmieri created at 2020-07-14 23:32:05

I am seeing negative progress: I can't even get the Sage library to build on OS X anymore: I just see errors as in comment:16. I assume the problem is parallel building with `spawn` instead of `fork`, but I can't figure out where to change things to get it to work.

For the record, I tried this with Python 3.8.4, not 3.8.0. I'll try with 3.8.0, but I don't expect any difference. I tried this but it didn't help:

```diff
diff --git a/src/sage_setup/run_parallel.py b/src/sage_setup/run_parallel.py
index 7a9b787b4e..a4cf73801d 100644
--- a/src/sage_setup/run_parallel.py
+++ b/src/sage_setup/run_parallel.py
@@ -73,11 +73,12 @@ def execute_list_of_commands_in_parallel(command_list, nthreads):
         progress = progress_fmt.format(i+1, N)
         command_list[i] = command_list[i] + (progress,)
 
-    from multiprocessing import Pool
+    import multiprocessing
+    ctx = multiprocessing.get_context('fork')
     # map_async handles KeyboardInterrupt correctly if an argument is
     # given to get().  Plain map() and apply_async() do not work
     # correctly, see Trac #16113.
-    pool = Pool(nthreads)
+    pool = ctx.Pool(nthreads, maxtasksperchild=1)
     result = pool.map_async(apply_func_progress, command_list, 1).get(99999)
     pool.close()
     pool.join()
```



---

Comment by git created at 2020-07-15 00:37:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-15 00:43:22

I'll try to fix / work around the build problem


---

Comment by mkoeppe created at 2020-07-15 01:19:21

https://github.com/cython/cython/issues/3262


---

Comment by git created at 2020-07-15 01:30:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-15 01:37:01

Not sure if the Cython update (from #29861) was necessary. But 0.29.21 does have a change specifically for 3.8.


---

Comment by mkoeppe created at 2020-07-15 01:39:03

sagelib builds now on my Mac. Haven't tested anything else yet.


---

Comment by jhpalmieri created at 2020-07-15 05:12:38

Right, thanks, I forgot to deal with Cython. I can now build sagelib. Also the docs, with the following changes:

```diff
diff --git a/src/sage_setup/docbuild/utils.py b/src/sage_setup/docbuild/utils.py
index 272f7e2d0f..2691339ea6 100644
--- a/src/sage_setup/docbuild/utils.py
+++ b/src/sage_setup/docbuild/utils.py
@@ -112,11 +112,14 @@ def build_many(target, args, processes=None):
         ...
         WorkerDiedException: worker for 4 died with non-zero exit code -9
     """
-    from multiprocessing import Process, Queue, cpu_count
+    import multiprocessing
+    ctx = multiprocessing.get_context('fork')
+    Process = ctx.Process
+    Queue = ctx.Queue
     from six.moves.queue import Empty
 
     if processes is None:
-        processes = cpu_count()
+        processes = multiprocessing.cpu_count()
 
     workers = [None] * processes
     tasks = enumerate(args)
```

Doctesting doesn't work, though; first, it failed completely, and then I tried to patch a few files in `src/sage/doctest`, but I was not successful. (I got some tests to run, but there were doctest failures, and then the process just quit.)


---

Comment by mkoeppe created at 2020-07-15 05:18:03

According to https://docs.python.org/3/library/multiprocessing.html#multiprocessing.get_context, 
`get_context` is available for python >= 3.4. We support python >= 3.6, so I would guess it is safe to make this change to `utils.py`. Could you push it to the branch please?


---

Comment by git created at 2020-07-15 20:25:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-07-15 21:21:28

This builds `sagelib` plus the documentation for me on, either using the system Python or Python 3.8.4.


---

Comment by mkoeppe created at 2020-07-15 22:15:43

Thanks. Do we know if the problem with doctesting is specific to macOS?


---

Comment by jhpalmieri created at 2020-07-16 00:59:37

With this branch, everything builds on an Ubuntu virtual machine. I didn't run doctests.

I also didn't know about the

```
multiprocessing.set_start_method('fork', force=True)
```

command. With this change, doctests on OS X run, although there are a lot of failures:

```diff
diff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py
index b0db07b47a..af49ca29e5 100644
--- a/src/sage/doctest/external.py
+++ b/src/sage/doctest/external.py
@@ -25,7 +25,11 @@ AUTHORS:
 #                  http://www.gnu.org/licenses/
 #*****************************************************************************
 
-from multiprocessing import Array
+import multiprocessing
+import os
+if os.uname().sysname == 'Darwin':
+    multiprocessing.set_start_method('fork', force=True)
+Array = multiprocessing.Array
 
 import urllib.error
 from urllib.request import Request, urlopen
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 75559667d1..8f5f2bff2b 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -63,6 +63,8 @@ from sage.repl.user_globals import set_globals
 from sage.cpython.atexit import restore_atexit
 from sage.cpython.string import bytes_to_str, str_to_bytes
 
+if os.uname().sysname == 'Darwin':
+    multiprocessing.set_start_method('fork', force=True)
 
 # All doctests run as if the following future imports are present
 import __future__
```



---

Comment by mkoeppe created at 2020-07-16 02:47:22

Could you push it on the branch?


---

Comment by mkoeppe created at 2020-07-16 02:48:27

Without the changes from comment 95, I get the following error:

```
$ ./sage -t src/sage/geometry/polyhedron/base.py
too many failed tests, not using stored timings
Running doctests with ID 2020-07-15-19-42-59-9c236f91.
Git branch: big-update
Using --optional=build,cryptominisat,dochtml,sage
Doctesting 1 file.
----------------------------------------------------------------------
Doctests interrupted: 0/1 files tested
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/bin/sage-runtests", line 177, in <module>
    err = DC.run()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/control.py", line 1207, in run
    self.run_doctests()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/control.py", line 908, in run_doctests
    self.dispatcher.dispatch()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 2039, in dispatch
    self.parallel_dispatch()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1934, in parallel_dispatch
    w.start()  # This might take some time
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 2206, in start
    super(DocTestWorker, self).start()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/process.py", line 121, in start
    self._popen = self._Popen(self)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/context.py", line 224, in _Popen
    return _default_context.get_context().Process._Popen(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/context.py", line 284, in _Popen
    return Popen(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/popen_spawn_posix.py", line 32, in __init__
    super().__init__(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/popen_fork.py", line 19, in __init__
    self._launch(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/popen_spawn_posix.py", line 47, in _launch
    reduction.dump(process_obj, fp)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/reduction.py", line 60, in dump
    ForkingPickler(file, protocol).dump(obj)
AttributeError: Can't pickle local object 'DocTestDispatcher.parallel_dispatch.<locals>.sel_exit'
```


Is this the same error that you were getting?


---

Comment by git created at 2020-07-16 03:00:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-07-16 03:02:12

Yes, that's the error I was getting. Now I'm getting the same doctest failures on OS X as on the Ubuntu virtual machine (approximately: I think I get 113 files with failures on OS X, 114 with failures on Ubuntu).


---

Comment by mkoeppe created at 2020-07-16 05:25:59

I tried `make ptest`, and it ended with:

```
sage -t src/sage/calculus/riemann.pyx  # 18 doctests failed
sage -t src/sage/functions/log.py  # 2 doctests failed
sage -t src/sage/graphs/graph_plot.py  # 4 doctests failed
Doctests interrupted: 344/4127 files tested
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/bin/sage-runtests", line 177, in <module>
    err = DC.run()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/control.py", line 1207, in run
    self.run_doctests()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/control.py", line 908, in run_doctests
    self.dispatcher.dispatch()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 2044, in dispatch
    self.parallel_dispatch()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1939, in parallel_dispatch
    w.start()  # This might take some time
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 2211, in start
    super(DocTestWorker, self).start()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/process.py", line 121, in start
    self._popen = self._Popen(self)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/context.py", line 224, in _Popen
    return _default_context.get_context().Process._Popen(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/context.py", line 277, in _Popen
    return Popen(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/popen_fork.py", line 19, in __init__
    self._launch(process_obj)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.8/multiprocessing/popen_fork.py", line 69, in _launch
    child_r, parent_w = os.pipe()
OSError: [Errno 24] Too many open files
make: *** [ptest] Error 1
```



---

Comment by jhpalmieri created at 2020-07-17 01:48:34

`make ptestlong` completed for me (with `make -j6`). I see several types of failures:

- sorting issues:

```
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 3148, in sage.dynamics.arithmetic_dynamics.projective_ds.?.automorphism_group
Failed example:
    D6.automorphism_group()
Expected:
    [
    [1 0]  [0 w]  [0 1]  [w 0]  [-w - 1      0]  [     0 -w - 1]
    [0 1], [1 0], [1 0], [0 1], [     0      1], [     1      0]
    ]
Got:
    [
    [1 0]  [0 1]  [     0 -w - 1]  [w 0]  [-w - 1      0]  [0 w]
    [0 1], [1 0], [     1      0], [0 1], [     0      1], [1 0]
    ]
```

- hashes have changed:

```
File "src/sage/combinat/similarity_class_type.py", line 411, in sage.combinat.similarity_class_type.?.__hash__
Failed example:
    hash(PT1)
Expected:
    5050909583595644741 
Got:
    -925386691174542829
```

- pickling?

```
File "src/sage/manifolds/differentiable/affine_connection.py", line 1785, in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann
Failed example:
    for i in M.irange():
        for j in M.irange():
            for k in M.irange():
                nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()
Exception raised:
    multiprocessing.pool.RemoteTraceback: 
    """
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/multiprocessing/pool.py", line 125, in worker
        result = (True, func(*args, **kwds))
      File "sage/misc/fpickle.pyx", line 99, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2279)
        f = eval("unpickle_function(fp)", sage.all.__dict__, {'fp':fp})
      File "<string>", line 1, in <module>
      File "sage/misc/fpickle.pyx", line 90, in sage.misc.fpickle.unpickle_function (build/cythonized/sage/misc/fpickle.c:1975)
        recovered = pickle.loads(pickled)
      File "sage/misc/fpickle.pyx", line 26, in sage.misc.fpickle.code_ctor (build/cythonized/sage/misc/fpickle.c:1536)
        return types.CodeType(*args)
    TypeError: code() takes at least 14 arguments (13 given)
    """

    The above exception was the direct cause of the following exception:

    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 709, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.differentiable.affine_connection.AffineConnection.riemann[30]>", line 4, in <module>
        nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/manifolds/differentiable/affine_connection.py", line 663, in coef
        nab_evi = self(ev[i])
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/manifolds/differentiable/affine_connection.py", line 1386, in __call__
        return self._derive_paral(tensor_r)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/manifolds/differentiable/affine_connection.py", line 1508, in _derive_paral
        for ii,val in make_CovDerivative(listParalInput):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/site-packages/sage/parallel/multiprocessing_sage.py", line 77, in parallel_iter
        for res in result:
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta5/local/lib/python3.8/multiprocessing/pool.py", line 868, in next
        raise value
    TypeError: code() takes at least 14 arguments (13 given)
```

- a deprecation warning:

```
File "src/sage/plot/plot3d/base.pyx", line 1560, in sage.plot.plot3d.base.Graphics3d.save_image
Failed example:
    G.save_image(gif)
Expected nothing
Got:
    doctest:warning
    ...
    DeprecationWarning: PY_SSIZE_T_CLEAN will be required for '#' formats
```

- another one:

```
File "src/sage/doctest/forker.py", line 2351, in sage.doctest.forker.DocTestWorker.kill
Failed example:
    time.sleep(0.2)  # Worker doesn't die
Expected nothing
Got:
    doctest:warning
    ...
    DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python.
```

I haven't gone through all of the failures yet, nor have I pored over the Python 3.8 changelog to try to figure any of these out. The first few types are easy to fix, I hope.


---

Comment by mkoeppe created at 2020-07-17 01:53:02

comment 77 above already mentions the hashing/ordering issues. I haven't looked at these patches


---

Comment by mkoeppe created at 2020-07-17 01:57:15

If doctests need patching because of sorting order changes, I hope we can do better than what I see in https://salsa.debian.org/science-team/sagemath/-/blob/master/debian/patches/u0-version-python-3.8.patch

Many of such tests should in my opinion be fixed by using explicitly `sorted` when comparing lists whose order has no mathematical meaning


---

Comment by mkoeppe created at 2020-07-17 02:00:45

In this one from the Debian patch, I'm wondering whether printing of `Set` in doctests should be modified similar to what was done in #29042 for `dict`

```diff
--- a/sage/src/sage/schemes/elliptic_curves/ell_point.py
+++ b/sage/src/sage/schemes/elliptic_curves/ell_point.py
@@ -822,9 +822,9 @@
             sage: all(T.is_divisible_by(3) for T in tor)
             True
             sage: Set([T for T in tor if T.is_divisible_by(2)])
-            {(0 : 1 : 0), (1 : 0 : 1)}
+            {(1 : 0 : 1), (0 : 1 : 0)}
             sage: Set([2*T for T in tor])
-            {(0 : 1 : 0), (1 : 0 : 1)}
+            {(1 : 0 : 1), (0 : 1 : 0)}

```



---

Comment by mkoeppe created at 2020-07-17 02:07:57

For these ones from the Debian patch I have created #30162:

```
--- a/sage/src/sage/symbolic/callable.py
+++ b/sage/src/sage/symbolic/callable.py
@@ -38,27 +38,27 @@
     sage: f(1)=2
     Traceback (most recent call last):
     ...
-    SyntaxError: can't assign to function call
+    SyntaxError: cannot assign to function call

```



---

Comment by mkoeppe created at 2020-07-17 02:36:05

For this one from the Debian patch, I also wonder whether some methods should be changed so that they return generators rather than lists - for better py3 style. 

```
--- a/sage/src/sage/categories/coxeter_groups.py
+++ b/sage/src/sage/categories/coxeter_groups.py
@@ -283,7 +283,7 @@
                 [[0, 1, 2, 1], [0, 2, 1, 2], [2, 0, 1, 2]]
 
                 sage: W.braid_orbit([2,1,1,2,1])
-                [[2, 2, 1, 2, 2], [2, 1, 1, 2, 1], [1, 2, 1, 1, 2], [2, 1, 2, 1, 2]]
+                [[2, 1, 1, 2, 1], [1, 2, 1, 1, 2], [2, 2, 1, 2, 2], [2, 1, 2, 1, 2]]
 
                 sage: W = ReflectionGroup(['A',3], index_set=["AA","BB",5])  # optional - gap3
                 sage: w = W.long_element()                                   # optional - gap3

```



---

Comment by tscrim created at 2020-07-17 03:03:52

That is a big Sage-wide issue/question: should things be iterators/generators or lists. Some places we do both (e.g., in graphs), in others we only have the lists, and even still some places only do iterators.

The simple fix here to make everything consistent is just to sort the output (as was done in the test before) as this should be considered more as a set than an enumerated list IIRC.


---

Comment by mkoeppe created at 2020-07-17 03:14:25

Replying to [comment:108 tscrim]:
> The simple fix here to make everything consistent is just to sort the output (as was done in the test before) as this should be considered more as a set than an enumerated list IIRC.

Sure, this is what we should do for this ticket.


---

Comment by jhpalmieri created at 2020-07-17 21:09:56

I don't understand the point of checking specific hash values. For example, in `src/sage/combinat/similarity_class_type.py`, the hashes depend on how Python determines `hash(tuple([3,2,1]))`, for example. Since I think that is an implementation detail of Python, not Sage, doctesting for a specific value is the opposite of robust.


---

Comment by mkoeppe created at 2020-07-17 21:15:12

Replying to [comment:112 jhpalmieri]:
> I don't understand the point of checking specific hash values. For example, in `src/sage/combinat/similarity_class_type.py`, the hashes depend on how Python determines `hash(tuple([3,2,1]))`, for example. Since I think that is an implementation detail of Python, not Sage, doctesting for a specific value is the opposite of robust.

My guess is that these tests are there to guard against thoughtless or accidental changes to hash functions. 

I could imagine that we may want to change these tests to something like this:

```
    sage: hash(x) in (5050909583595644741, -925386691174542829, 234567876545678)
    True
```



---

Comment by git created at 2020-07-17 23:58:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-07-17 23:59:19

Here are "fixes" for some doctests. Some are probably not ideal. This is also far from complete: I didn't have the energy to do more, and I don't know how to handle some of the failures. But maybe this is a start.


---

Comment by tscrim created at 2020-07-18 00:10:23

For `similarity_class_type.py`, back when this was written IIRC, there was less decided about how to test a `__hash__` method and less concern about how changes in Python would affect this. So I think the changed tests here are good.


---

Comment by slelievre created at 2020-07-20 23:21:50

Python 3.8.5 was released as a security hotfix.

See #30184 for Python 3.9.x.


---

Comment by jhpalmieri created at 2020-07-21 01:51:25

I'm not going to be able to work on this for a few days. If someone else wants to work on doctests, please feel free. Do we have a Pillow-upgrade ticket? I wonder if that would help with some of the tests. And #30176 (matplotlib upgrade) might help, too.

Should this be delayed to Sage 9.3, ideally early in the release cycle?


---

Comment by mkoeppe created at 2020-07-21 02:01:04

Replying to [comment:119 jhpalmieri]:
> Do we have a Pillow-upgrade ticket? 

Yes, it's on #30103


---

Comment by git created at 2020-07-22 02:11:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-25 18:38:38

Replying to [comment:119 jhpalmieri]:
> Should this be delayed to Sage 9.3, ideally early in the release cycle?

Yes, I think so. Let's do #30210 (Upgrade Python to 3.7.8) for 9.2


---

Comment by arojas created at 2020-07-26 18:10:15

There are lots of failures caused by deprecation warnings on unpickling

```
DeprecationWarning: PY_SSIZE_T_CLEAN will be required for '#' formats
```

that come from pynac. These are fixed with https://github.com/pynac/pynac/pull/354, but pynac development seems stalled unfortunately


---

Comment by mkoeppe created at 2020-07-26 18:18:58

Could you please create a sage ticket for this pynac patch?


---

Comment by git created at 2020-07-26 18:39:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-26 18:54:35

Replying to [comment:128 mkoeppe]:
> Could you please create a sage ticket for this pynac patch? 

Done: #30225


---

Comment by git created at 2020-07-26 19:30:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 19:44:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 19:51:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 22:30:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-27 11:00:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-27 11:12:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-27 11:32:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-27 19:39:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 07:30:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 10:27:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 13:20:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 16:56:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 21:41:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-28 22:22:57

Just a handful of issues left, mostly pickling related

```
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/matroids/linear_matroid.pyx", line 3674, in sage.matroids.linear_matroid.BinaryMatroid._projection_partition
Failed example:
    N._projection_partition()
Expected:
    2 x 12 BinaryMatrix
    [110011001100]
    [001100110011]
Got:
    2 x 12 BinaryMatrix
    [001100110011]
    [110011001100]
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/structure/sequence.py", line 824, in sage.structure.sequence.Sequence_generic.__copy__
Failed example:
    t.is_immutable == s.is_immutable
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/structure/sequence.py", line 826, in sage.structure.sequence.Sequence_generic.__copy__
Failed example:
    t.is_mutable == s.is_mutable
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/combinat/posets/hasse_diagram.py", line 2185, in sage.combinat.posets.hasse_diagram.HasseDiagram.antichains
Failed example:
    TestSuite(A).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 296, in run
        test_method(tester=tester)
      File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
        tester.assertEqual(loads(dumps(self)), self)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: An enumerated set with a forest structure != An enumerated set with a forest structure
    ------------------------------------------------------------
    The following tests failed: _test_pickling
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/combinat/posets/hasse_diagram.py", line 2190, in sage.combinat.posets.hasse_diagram.HasseDiagram.antichains
Failed example:
    TestSuite(A).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 296, in run
        test_method(tester=tester)
      File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
        tester.assertEqual(loads(dumps(self)), self)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: An enumerated set with a forest structure != An enumerated set with a forest structure
    ------------------------------------------------------------
    The following tests failed: _test_pickling
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py", line 2171, in sage.combinat.cluster_algebra_quiver.quiver_mutation_type._construct_exceptional_mutation_classes
Failed example:
    for mut_class in sorted(rank_3_exceptional.keys(), key=str): # long time
      print("{} {}".format(mut_class, rank_3_exceptional[mut_class]))
Expected:
    ('G', 2, -1) [('BH?', (((1, 2), (1, -3)),)),
    ('BGO', (((2, 1), (3, -1)),)), ('BW?', (((0, 1), (3, -1)),)),
    ('BP?', (((0, 1), (1, -3)),)),
    ('BP_', (((0, 1), (1, -3)), ((2, 0), (3, -1)))),
    ('BP_', (((0, 1), (3, -1)), ((1, 2), (1, -3)), ((2, 0), (2, -2))))]
    ('G', 2, 1) [('BH?', (((1, 2), (3, -1)),)),
    ('BGO', (((2, 1), (1, -3)),)), ('BW?', (((0, 1), (1, -3)),)),
    ('BP?', (((0, 1), (3, -1)),)),
    ('BKO', (((1, 0), (3, -1)), ((2, 1), (1, -3)))),
    ('BP_', (((0, 1), (2, -2)), ((1, 2), (1, -3)), ((2, 0), (3, -1))))]
Got:
    ('G', 2, -1) [('BH?', (((1, 2), (1, -3)),)), ('BGO', (((2, 1), (3, -1)),)), ('BW?', (((0, 1), (3, -1)),)), ('BP?', (((0, 1), (1, -3)),)), ('BP_', (((0, 1), (1, -3)), ((2, 0), (3, -1)))), ('BP_', (((0, 1), (1, -3)), ((1, 2), (2, -2)), ((2, 0), (3, -1))))]
    ('G', 2, 1) [('BH?', (((1, 2), (3, -1)),)), ('BGO', (((2, 1), (1, -3)),)), ('BW?', (((0, 1), (1, -3)),)), ('BP?', (((0, 1), (3, -1)),)), ('BKO', (((1, 0), (3, -1)), ((2, 1), (1, -3)))), ('BP_', (((0, 1), (3, -1)), ((1, 2), (2, -2)), ((2, 0), (1, -3)))), ('BP_', (((0, 1), (2, -2)), ((1, 2), (1, -3)), ((2, 0), (3, -1))))]
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/combinat/cluster_algebra_quiver/mutation_type.py", line 1348, in sage.combinat.cluster_algebra_quiver.mutation_type._mutation_type_test
Failed example:
    _mutation_type_test(3) # long time
Expected:
    True ('A', (2, 1), 1)
    True ('A', 3)
    True ('B', 3)
    True ('BB', 2, 1)
    True ('BC', 2, 1)
    True ('C', 3)
    True ('CC', 2, 1)
    True ('G', 2, -1)
    True ('G', 2, 1)
Got:
    True ('A', (2, 1), 1)
    True ('A', 3)
    True ('B', 3)
    True ('BB', 2, 1)
    True ('BC', 2, 1)
    True ('C', 3)
    True ('CC', 2, 1)
    False ('G', 2, -1)
    False ('G', 2, 1)
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 355, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface
Failed example:
    S.riemann_matrix() #abs tol 0.00000001
Expected:
    [0.500000000000000000000000... + 0.866025403784438646763723...*I]
Got:
    [-0.50000000000000000000000000000 + 0.86602540378443864676372317075*I]
Tolerance exceeded in 1 of 2:
    0.500000000000000000000000 vs -0.50000000000000000000000000000, tolerance 1e0 > 1e-8
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/homology/simplicial_complex_morphism.py", line 82, in sage.homology.simplicial_complex_morphism
Failed example:
    z                                     # this is the mapping path space
Expected:
    Simplicial complex morphism:
      From: Simplicial complex with 6 vertices and 4 facets
      To:   Minimal triangulation of the 2-sphere
      Defn: ['L0R(0, 0)', 'L0R(0, 1)', 'L1R(1, 0)', 'L1R(1, 1)', 'L2R(2, 0)', 'L2R(2, 1)'] --> [0, 0, 1, 1, 2, 2]
Got:
    Simplicial complex morphism:
      From: Simplicial complex with 6 vertices and 5 facets
      To:   Minimal triangulation of the 2-sphere
      Defn: ['L0R(0, 0)', 'L0R(0, 1)', 'L1R(1, 0)', 'L1R(1, 1)', 'L2R(2, 0)', 'L2R(2, 1)'] --> [0, 0, 1, 1, 2, 2]
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/categories/homset.py", line 598, in sage.categories.homset.Homset.__init__
Failed example:
    TestSuite(H).run()
Expected nothing
Got:
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "/usr/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 296, in run
          test_method(tester=tester)
        File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
          tester.assertEqual(loads(dumps(self)), self)
        File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
          assertion_func(first, second, msg=msg)
        File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
          raise self.failureException(msg)
      AssertionError: Generic morphism:
        From: X
        To:   Y != Generic morphism:
        From: X
        To:   Y
      ------------------------------------------------------------
      The following tests failed: _test_pickling
    Failure in _test_elements
    The following tests failed: _test_elements
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/categories/homset.py", line 607, in sage.categories.homset.Homset.__init__
Failed example:
    TestSuite(H).run()
Expected nothing
Got:
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "/usr/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 296, in run
          test_method(tester=tester)
        File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
          tester.assertEqual(loads(dumps(self)), self)
        File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
          assertion_func(first, second, msg=msg)
        File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
          raise self.failureException(msg)
      AssertionError: Generic morphism:
        From: X
        To:   Y != Generic morphism:
        From: X
        To:   Y
      ------------------------------------------------------------
      The following tests failed: _test_pickling
    Failure in _test_elements
    The following tests failed: _test_elements
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/categories/homset.py", line 1253, in sage.categories.homset.HomsetWithBase.__init__
Failed example:
    TestSuite(H).run()
Expected nothing
Got:
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "/usr/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 296, in run
          test_method(tester=tester)
        File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
          tester.assertEqual(loads(dumps(self)), self)
        File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
          assertion_func(first, second, msg=msg)
        File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
          raise self.failureException(msg)
      AssertionError: Generic morphism:
        From: X
        To:   Y != Generic morphism:
        From: X
        To:   Y
      ------------------------------------------------------------
      The following tests failed: _test_pickling
    Failure in _test_elements
    The following tests failed: _test_elements
```



---

Comment by git created at 2020-07-30 17:36:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-30 19:40:03

The remaining issues are caused by this commit https://github.com/python/cpython/commit/ac20e0f98d6727ba97a9575bfa2a11b2f6247c35

In particular, if `B=loads(dumps(A))`, then `A.method` and `B.method` have different hashes, so `A.method==B.method` is always false.


---

Comment by jhpalmieri created at 2020-07-30 20:17:36

Note that the issue of sorting vertices in simplicial complexes was discussed at length in #26966. I may propose a different solution to this problem, but give me a few days.


---

Comment by git created at 2020-07-30 22:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-30 23:02:26

Replying to [comment:148 jhpalmieri]:
> Note that the issue of sorting vertices in simplicial complexes was discussed at length in #26966. I may propose a different solution to this problem, but give me a few days.

Oh, I see now that you proposed the same fix there but reverted it.


---

Comment by arojas created at 2020-07-30 23:04:52

With the current branch all tests are passing for me. There may be room for some improvements (besides the simplicial complex vertex ordering issue), but I hope there's still a chance that this can make it in 9.2. It would be quite unfortunate to not support python 3.8 one year after its release.


---

Comment by jhpalmieri created at 2020-07-31 18:11:15

I wrote a long post about simplicial complexes with various solutions, but now I realize there is a simpler solution.

There are a few problems here: first, if you want consistency when dealing with products of simplicial complexes, some sorting is needed: if you triangulate a square, for example, you have two choices for how to add the diagonal, and different sortings will result in different choices. Second, Python 3.7 and 3.8 are handling some data differently from each other, and that's where the doctest failure in `simplicial_complex_morphism.py` is coming from: different sortings yielding different triangulations of a product. Third, I think that this really means that the doctest in `simplicial_complex_morphishm.py` is a bad one, because it is essentially relying on how intrinsically unsorted data is converted to an ordered object (a tuple). I tried putting in various ways of sorting, and I got at least three different results, all of which are mathematically valid, and I don't see any reason to force one sorting option over another.

As a result, we should make this change: get rid of the new sorting in `simplicial_complex.py` and make the doctest more robust:

```diff
diff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py
index 8ee9a4f84c..1c9dd8da8e 100644
--- a/src/sage/homology/simplicial_complex.py
+++ b/src/sage/homology/simplicial_complex.py
@@ -1045,10 +1045,7 @@ class SimplicialComplex(Parent, GenericCellComplex):
         else:
             vertex_set = range(n + 1)
 
-        try:               # use natural order if vertices are integers
-            vertices = tuple(sorted(vertex_set))
-        except TypeError:  # incomparable vertices
-            vertices = tuple(sorted(vertex_set, key=str))
+        vertices = tuple(vertex_set)
 
         gen_dict = {}
         for v in vertices:
diff --git a/src/sage/homology/simplicial_complex_morphism.py b/src/sage/homology/simplicial_complex_morphism.py
index d954dd90b4..8db933b9fe 100644
--- a/src/sage/homology/simplicial_complex_morphism.py
+++ b/src/sage/homology/simplicial_complex_morphism.py
@@ -81,7 +81,7 @@ EXAMPLES::
     sage: z = y.fiber_product(x)
     sage: z                                     # this is the mapping path space
     Simplicial complex morphism:
-      From: Simplicial complex with 6 vertices and 6 facets
+      From: Simplicial complex with 6 vertices and ... facets
       To:   Minimal triangulation of the 2-sphere
       Defn: ['L0R(0, 0)', 'L0R(0, 1)', 'L1R(1, 0)', 'L1R(1, 1)', 'L2R(2, 0)', 'L2R(2, 1)'] --> [0, 0, 1, 1, 2, 2]
 """
```

By the way, see ticket:26966#comment:25 for the an example of the evils of sorting using `key=str`.


---

Comment by git created at 2020-07-31 18:14:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-01 12:40:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-02 19:27:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-08-02 19:31:52

Setting to needs review for wider testing. Needs testing especially with system python<3.8, also with optional packages


---

Comment by arojas created at 2020-08-02 19:31:52

Changing status from new to needs_review.


---

Comment by git created at 2020-08-03 10:12:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-03 10:13:45

Tests run at https://github.com/mkoeppe/sage/actions/runs/193151775


---

Comment by git created at 2020-08-04 17:32:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-08-07 09:20:45

Replying to [comment:158 mkoeppe]:
> Tests run at https://github.com/mkoeppe/sage/actions/runs/193151775

What's the outcome of this? I see many failed jobs but I can't see any logs.


---

Comment by mkoeppe created at 2020-08-07 17:00:42

Looks like GH Action was having trouble. I have started another run at https://github.com/mkoeppe/sage/actions/runs/199465086


---

Comment by mkoeppe created at 2020-08-10 02:08:10

Clean on `ubuntu-trusty-standard` (with python3 from SPKG, https://github.com/mkoeppe/sage/runs/962936559), except for

```
sage -t --random-seed=0 src/sage/doctest/test.py  # Timed out
```


Clean on `centos-7-standard` (with python3 from SPKG, https://github.com/mkoeppe/sage/runs/962936782), except for

```
sage -t --random-seed=0 src/sage/interfaces/sagespawn.pyx
File "src/sage/interfaces/sagespawn.pyx", line 96, in sage.interfaces.sagespawn.SageSpawn.__repr__
Failed example:
    while s.isalive():  # Wait until the process finishes
        sleep(0.1)
Expected nothing
Got:
    doctest:warning
    DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python.
```


Clean on `gentoo-standard` (using `/usr/bin/python3.8`, https://github.com/mkoeppe/sage/runs/962936791) except for:

```
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_modular_symbols.py  # Timed out
```

Clean on `gentoo-standard-python3.7` (using `/usr/bin/python3.7`) except for:

```
sage -t --random-seed=0 src/sage/categories/finite_enumerated_sets.py
File "src/sage/categories/finite_enumerated_sets.py", line 290, in sage.categories.finite_enumerated_sets.FiniteEnumeratedSets.ParentMethods._list_from_iterator
Failed example:
    list(C)
Expected:
    hello!
    hello!
    ...
    [1, 2, 3]
Got:
    hello!
    hello!
    [1, 2, 3]
```


Lots of doctest failures because of `LC_ALL: cannot change locale` messages (#30053) on `linuxmint-17-minimal` (https://github.com/mkoeppe/sage/runs/962936711) and `-standard`

Unfortunately most builds failed again because of unrelated technical problems on GH Actions


---

Comment by git created at 2020-08-10 06:22:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-12 22:55:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-13 22:40:05

`debian-jessie-minimal`, `debian-stretch-standard`, `centos-7-standard` (with python3 from SPKG) clean

`ubuntu-bionic-standard`, `debian-buster-standard`, `linuxmint-19.3-standard`, `fedora-30-standard`, `fedora-31-standard`, `gentoo-python3.7-standard` (with `/usr/bin/python3.7`) clean

`gentoo-standard` (with `/usr/bin/python3.8`) clean

`ubuntu-eoan-standard` (with `/usr/bin/python3.7`, https://github.com/mkoeppe/sage/runs/978617270) clean except for

```
sage -t --random-seed=0 src/sage/libs/eclib/interface.py  # 2 doctests failed
sage -t --random-seed=0 src/sage/schemes/cyclic_covers/charpoly_frobenius.py  # 1 doctest failed
```

(seem unrelated to this ticket (mwrank; #28951?))

`debian-bullseye-standard` (with `/usr/bin/python3.7`) clean except for doctest errors because of newer flint or arb from the system

`linuxmint-17-standard` .... lots of doctest failures because of "setlocale" messages

`fedora-27-standard` (with `/usr/bin/python3.6`):

```
sage -t --random-seed=0 src/sage/lfunctions/sympow.py  # 3 doctests failed
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_rational_field.py  # 2 doctests failed
```

(seems unrelated)

`fedora-29-standard` (with `/usr/bin/python3.7`): likewise

`fedora-28-standard` (with `/usr/bin/python3.6`) additionally:

```
sage -t --random-seed=0 src/sage/rings/polynomial/groebner_fan.py  # 3 doctests failed
```

(seems unrelated)

`conda-forge-standard` (with `/opt/conda/bin/python3.7`):

```
sage -t --random-seed=0 src/doc/en/constructions/algebraic_geometry.rst  # 1 doctest failed
sage -t --random-seed=0 src/doc/en/developer/coding_in_other.rst  # 1 doctest failed
sage -t --random-seed=0 src/sage/misc/cython.py  # 3 doctests failed
sage -t --random-seed=0 src/sage/modules/fg_pid/fgp_module.py  # 3 doctests failed
sage -t --random-seed=0 src/sage/modules/free_module_morphism.py  # 3 doctests failed
sage -t --random-seed=0 src/sage/rings/complex_arb.pyx  # 6 doctests failed
sage -t --random-seed=0 src/sage/parallel/map_reduce.py  # Timed out
sage -t --random-seed=0 src/sage/rings/real_arb.pyx  # 2 doctests failed
sage -t --random-seed=0 src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py  # Killed due to abort
```


`conda-forge-minimal` (https://github.com/mkoeppe/sage/runs/978620286): 

```
  [python3-3.8.5]   ImportError: The required _crypt module was not built as part of CPython
  [python3-3.8.5]   crypt module failed to import
  [python3-3.8.5]   ModuleNotFoundError: No module named 'zlib'
  [python3-3.8.5]   zlib module failed to import
  [python3-3.8.5]   ModuleNotFoundError: No module named '_sqlite3'
  [python3-3.8.5]   sqlite3 module failed to import
  [python3-3.8.5]   Error: One or more modules failed to import.
```

(but we had similar errors also before the update, on this platform)


`ubuntu-focal-standard` (https://github.com/mkoeppe/sage/runs/978617297)

```
hecking whether SageMath should install SPKG python3...
checking whether any of sqlite libpng bzip2 xz libffi is installed as or will be installed as SPKG... no
checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... 
checking ... whether /usr/bin/python3.8 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
checking ... whether /usr/bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
checking ... whether /bin/python3.8 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
checking ... whether /bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension

configure: no suitable system package found for SPKG python3
```

likewise on `debian-sid-standard` (https://github.com/mkoeppe/sage/runs/978620025)


---

Comment by mkoeppe created at 2020-08-13 22:46:40

`homebrew-macos-minimal` (using python3 SPKG): Clean except for various timeouts

```
sage -t --random-seed=0 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t --random-seed=0 src/sage/interfaces/gap.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t --random-seed=0 src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t --random-seed=0 src/sage/plot/graphics.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/base.pyx  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/shapes2.py  # Timed out
sage -t --random-seed=0 src/sage/rings/function_field/function_field.py  # Timed out
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/gp_simon.py  
```


`homebrew-macos-python3_xcode-standard` (using `/usr/bin/python3`) -- build times out during docbuild --- perhaps the same problem as reported on sage-release


`conda-forge-macos-minimal` (https://github.com/mkoeppe/sage/runs/978617180):

```
  [python3-3.8.5]   checking build system type... x86_64-apple-darwin19.6.0
  [python3-3.8.5]   checking host system type... x86_64-apple-darwin13.4.0
  [python3-3.8.5]   checking for python3.8... no
  [python3-3.8.5]   checking for python3... python3
  [python3-3.8.5]   configure: error: Cross compiling required --host=HOST-TUPLE and --build=ARCH
  [python3-3.8.5]   configure: WARNING: unrecognized options: --disable-toolbox-glue
  [python3-3.8.5]   checking build system type... x86_64-apple-darwin19.6.0
  [python3-3.8.5]   checking host system type... x86_64-apple-darwin13.4.0
  [python3-3.8.5]   checking for python3.8... no
  [python3-3.8.5]   checking for python3... python3
  [python3-3.8.5]   configure: error: Cross compiling required --host=HOST-TUPLE and --build=ARCH
```

???? But this platform also failed before the update


---

Comment by mkoeppe created at 2020-08-13 22:47:06

Looks like we have a good chance of getting this ready for 9.2!


---

Comment by mkoeppe created at 2020-08-13 22:56:39

(deleted)


---

Comment by git created at 2020-08-13 23:21:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-08-14 05:00:55

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-14 12:11:30

`ubuntu-focal-standard` now accepts system python 3.8, clean doctests.



But:

`debian-bullseye-standard` (https://github.com/mkoeppe/sage/runs/982720084), now using `/usr/bin/python3.8` (3.8.5), fails to build `matplotlib`:

```
  x86_64-linux-gnu-gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -g -fwrapv -O2 -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -g -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.8/src/qhull_wrap.o build/temp.linux-x86_64-3.8/extern/libqhull/geom.o build/temp.linux-x86_64-3.8/extern/libqhull/geom2.o build/temp.linux-x86_64-3.8/extern/libqhull/global.o build/temp.linux-x86_64-3.8/extern/libqhull/io.o build/temp.linux-x86_64-3.8/extern/libqhull/libqhull.o build/temp.linux-x86_64-3.8/extern/libqhull/mem.o build/temp.linux-x86_64-3.8/extern/libqhull/merge.o build/temp.linux-x86_64-3.8/extern/libqhull/poly.o build/temp.linux-x86_64-3.8/extern/libqhull/poly2.o build/temp.linux-x86_64-3.8/extern/libqhull/qset.o build/temp.linux-x86_64-3.8/extern/libqhull/random.o build/temp.linux-x86_64-3.8/extern/libqhull/rboxlib.o build/temp.linux-x86_64-3.8/extern/libqhull/stat.o build/temp.linux-x86_64-3.8/extern/libqhull/user.o build/temp.linux-x86_64-3.8/extern/libqhull/usermem.o build/temp.linux-x86_64-3.8/extern/libqhull/userprintf.o build/temp.linux-x86_64-3.8/extern/libqhull/userprintf_rbox.o -lm -o build/lib.linux-x86_64-3.8/matplotlib/_qhull.cpython-38-x86_64-linux-gnu.so
  lto1: fatal error: bytecode stream in file ‘build/temp.linux-x86_64-3.8/src/qhull_wrap.o’ generated with GCC compiler older than 10.0
  compilation terminated.
  lto-wrapper: fatal error: x86_64-linux-gnu-gcc returned 1 exit status
  compilation terminated.
  /usr/bin/ld: error: lto-wrapper failed
  collect2: error: ld returned 1 exit status
```

Likewise on `debian-sid-standard` and `ubuntu-groovy-standard`


---

Comment by mkoeppe created at 2020-08-14 12:37:55

Getting rid of `-flto` would work around this problem. Not sure where it is coming from


---

Comment by mkoeppe created at 2020-08-14 21:05:30

(As expected, upgrading matplotlib to latest (3.3.1, #30358) does not solve this problem.)


---

Comment by fbissey created at 2020-08-15 00:47:29

I haven't experienced anything like that in Gentoo. But looking at build log for matplotlib 3.3.0 suggests reviving an idea: using an external `qhull` install for matplotlib.


---

Comment by mkoeppe created at 2020-08-15 00:51:31

Replying to [comment:179 mkoeppe]:
> Getting rid of `-flto` would work around this problem. Not sure where it is coming from
The flag is coming directly from matplotlib's `setup.py`, I'll just disable it


---

Comment by git created at 2020-08-15 01:05:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-15 01:07:45

Replying to [comment:181 fbissey]:
> I haven't experienced anything like that in Gentoo. But looking at build log for matplotlib 3.3.0 suggests reviving an idea: using an external `qhull` install for matplotlib.
I would support this in general, but not for 9.2; and as discussed in #30176, we would need to make cmake standard.


---

Comment by mkoeppe created at 2020-08-15 01:08:49

I think this ticket is now ready for review.


---

Comment by fbissey created at 2020-08-18 23:04:24

Now is a good time to tests things on a bigger scale.


---

Comment by fbissey created at 2020-08-18 23:04:24

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-19 00:02:17

Thanks


---

Comment by git created at 2020-08-19 01:59:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-08-19 01:59:50

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-08-19 02:00:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-19 22:18:43

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-08-19 22:18:43


```
    STDOUT: CONFLICT (content): Merge conflict in src/sage/graphs/generic_graph.py
```



---

Comment by git created at 2020-08-19 23:10:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-19 23:24:27

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-08-19 23:25:02

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-08-23 16:27:03

I'm getting various failures on 32-bit apparently due to different iterator order:

```
**********************************************************************
File "src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py", line 333, in sage.combinat.rigged_configurations.tensor_product_kr_tableaux.TensorProductOfKirillovReshetikhinTableaux.__iter__
Failed example:
    next(g)
Expected:
    [[2], [4]] (X) [[1]]
Got:
    [[1], [2]] (X) [[1]]
**********************************************************************
1 item had failures:
   1 of   5 in sage.combinat.rigged_configurations.tensor_product_kr_tableaux.TensorProductOfKirillovReshetikhinTableaux.__iter__
    [95 tests, 1 failure, 21.93 s]
**********************************************************************
File "src/sage/geometry/cone.py", line 4059, in sage.geometry.cone.?.semigroup_generators
Failed example:
    halfplane.semigroup_generators()
Expected:
    (N(0, 1), N(1, 0), N(-1, 0))
Got:
    (N(-1, 0), N(1, 0), N(0, 1))
**********************************************************************
1 item had failures:
   1 of  23 in sage.geometry.cone.?.semigroup_generators
    [1241 tests, 1 failure, 18.70 s]
**********************************************************************
File "src/sage/geometry/fan_isomorphism.py", line 124, in sage.geometry.fan_isomorphism.fan_isomorphism_generator
Failed example:
    tuple(fan_isomorphism_generator(fan1, fan2))
Expected:
    (
    [18  1 -5]  [ 6 -3  7]
    [ 4  0 -1]  [ 1 -1  2]
    [ 5  0 -1], [ 2 -1  2]
    )
Got:
    (
    [ 6 -3  7]  [18  1 -5]
    [ 1 -1  2]  [ 4  0 -1]
    [ 2 -1  2], [ 5  0 -1]
    )
**********************************************************************
File "src/sage/geometry/fan_isomorphism.py", line 130, in sage.geometry.fan_isomorphism.fan_isomorphism_generator
Failed example:
    tuple(fan_isomorphism_generator(fan2, fan1))
Expected:
    (
    [ 0 -1  1]  [ 0 -1  1]
    [ 1 -7  2]  [ 2 -2 -5]
    [ 0 -5  4], [ 1  0 -3]
    )
Got:
    (
    [ 0 -1  1]  [ 0 -1  1]
    [ 2 -2 -5]  [ 1 -7  2]
    [ 1  0 -3], [ 0 -5  4]
    )
**********************************************************************
1 item had failures:
   2 of  21 in sage.geometry.fan_isomorphism.fan_isomorphism_generator
    [65 tests, 2 failures, 1.07 s]
**********************************************************************
File "src/sage/geometry/polyhedron/library.py", line 2639, in sage.geometry.polyhedron.library.Polytopes.generalized_permutahedron
Failed example:
    sorted(perm_a2_reg.vertices())
Expected:
    [A vertex at (-1, 0),
     A vertex at (-1/2, -0.866025403784439?),
     A vertex at (-1/2, 0.866025403784439?),
     A vertex at (1/2, -0.866025403784439?),
     A vertex at (1/2, 0.866025403784439?),
     A vertex at (1.000000000000000?, 0.?e-18)]
Got:
    [A vertex at (-1.000000000000000?, 0.?e-18),
     A vertex at (-1/2, -0.866025403784439?),
     A vertex at (-1/2, 0.866025403784439?),
     A vertex at (1/2, -0.866025403784439?),
     A vertex at (1/2, 0.866025403784439?),
     A vertex at (1, 0)]
**********************************************************************
1 item had failures:
   1 of  21 in sage.geometry.polyhedron.library.Polytopes.generalized_permutahedron
    [305 tests, 1 failure, 97.96 s]
**********************************************************************
File "src/sage/geometry/triangulation/point_configuration.py", line 1401, in sage.geometry.triangulation.point_configuration.PointConfiguration.circuits_support
Failed example:
    list( p.circuits_support() )
Expected:
    [(0, 3, 4), (0, 1, 2), (1, 2, 3, 4)]
Got:
    [(0, 1, 2), (0, 3, 4), (1, 2, 3, 4)]
**********************************************************************
File "src/sage/geometry/triangulation/point_configuration.py", line 1471, in sage.geometry.triangulation.point_configuration.PointConfiguration.circuits
Failed example:
    p.circuits()
Expected:
    (((0,), (1, 2), (3, 4)), ((0,), (3, 4), (1, 2)), ((1, 2), (0,), (3, 4)))
Got:
    (((0,), (3, 4), (1, 2)), ((0,), (1, 2), (3, 4)), ((1, 2), (0,), (3, 4)))
**********************************************************************
2 items had failures:
   1 of   6 in sage.geometry.triangulation.point_configuration.PointConfiguration.circuits
   1 of   3 in sage.geometry.triangulation.point_configuration.PointConfiguration.circuits_support
    [214 tests, 2 failures, 19.74 s]
**********************************************************************
File "src/sage/graphs/graph.py", line 7342, in sage.graphs.graph.Graph.cliques_containing_vertex
Failed example:
    sorted(d[(0, 1)])
Expected:
    [[(0, 1), (0, 0)], [(0, 1), (0, 2)], [(0, 1), (1, 1)]]
Got:
    [[(0, 0), (0, 1)], [(0, 2), (0, 1)], [(1, 1), (0, 1)]]
**********************************************************************
1 item had failures:
   1 of  15 in sage.graphs.graph.Graph.cliques_containing_vertex
    [1190 tests, 1 failure, 20.84 s]
**********************************************************************
File "src/sage/homology/homology_vector_space_with_basis.py", line 113, in sage.homology.homology_vector_space_with_basis.HomologyVectorSpaceWithBasis
Failed example:
    x.cup_product(x)
Expected:
    0
Got:
    h^{2,0}
**********************************************************************
File "src/sage/homology/homology_vector_space_with_basis.py", line 115, in sage.homology.homology_vector_space_with_basis.HomologyVectorSpaceWithBasis
Failed example:
    x.cup_product(y)
Expected:
    h^{2,0}
Got:
    0
**********************************************************************
1 item had failures:
   2 of  45 in sage.homology.homology_vector_space_with_basis.HomologyVectorSpaceWithBasis
    [194 tests, 2 failures, 16.93 s]
R[write to console]: Warning messages:
R[write to console]: 1: 
R[write to console]: In sage10 + sage6 :
R[write to console]: 
 
R[write to console]:  longer object length is not a multiple of shorter object length
R[write to console]: 2: 
R[write to console]: In sqrt(sage10) :
R[write to console]:  NaNs produced
R[write to console]: 3: 
R[write to console]: In sqrt(sage4) :
R[write to console]:  NaNs produced
**********************************************************************
File "src/sage/matroids/graphic_matroid.py", line 1659, in sage.matroids.graphic_matroid.GraphicMatroid.graphic_coextensions
Failed example:
    for N1 in I:
        N1.graph().edges(sort=True)
Expected:
    [(0, 1, 0), (0, 3, 1), (0, 4, 'a'), (1, 2, 2), (2, 3, 3)]
    [(0, 1, 0), (0, 3, 1), (1, 4, 2), (2, 3, 3), (2, 4, 'a')]
Got:
    [(0, 1, 0), (0, 3, 1), (0, 4, 'a'), (1, 2, 2), (2, 3, 3)]
    [(0, 3, 1), (0, 4, 0), (1, 2, 2), (1, 4, 'a'), (2, 3, 3)]
**********************************************************************
1 item had failures:
   1 of  27 in sage.matroids.graphic_matroid.GraphicMatroid.graphic_coextensions
    [358 tests, 1 failure, 0.75 s]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1099, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.class_representatives
Failed example:
    R
Expected:
    [[V(2)*V(3)], [V(1)*V(2)]]
Got:
    [[V(1)*V(2)], [V(2)*V(3)]]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1101, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.class_representatives
Failed example:
    [v.continued_fraction()[1] for v in R]
Expected:
    [(1, 2, 2), (3,)]
Got:
    [(3,), (1, 2, 2)]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1318, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.reduced_elements
Failed example:
    R
Expected:
    [
    [ 5*lam     -3]  [ 5*lam     -7]  [4*lam    -3]  [3*lam    -1]
    [     7 -2*lam], [     3 -2*lam], [    3  -lam], [    1     0]
    ]
Got:
    [
    [3*lam    -1]  [ 5*lam     -3]  [ 5*lam     -7]  [4*lam    -3]
    [    1     0], [     7 -2*lam], [     3 -2*lam], [    3  -lam]
    ]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1323, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.reduced_elements
Failed example:
    [v.continued_fraction() for v in R]
Expected:
    [((), (1, 2, 2)), ((), (2, 2, 1)), ((), (2, 1, 2)), ((), (3,))]
Got:
    [((), (3,)), ((), (1, 2, 2)), ((), (2, 2, 1)), ((), (2, 1, 2))]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1350, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.simple_elements
Failed example:
    G.simple_elements(D=14)
Expected:
    [
    [2*lam     1]  [  lam     1]  [2*lam     3]  [  lam     3]
    [    3   lam], [    3 2*lam], [    1   lam], [    1 2*lam]
    ]
Got:
    [
    [2*lam     3]  [  lam     3]  [2*lam     1]  [  lam     1]
    [    1   lam], [    1 2*lam], [    3   lam], [    3 2*lam]
    ]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py", line 1387, in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.rational_period_functions
Failed example:
    G.rational_period_functions(k=-4, D=14)
Expected:
    [-z^4 + 1, 16*z^4 - 16, -16*z^4 + 16]
Got:
    [-z^4 + 1, -16*z^4 + 16, 16*z^4 - 16]
**********************************************************************
4 items had failures:
   2 of  27 in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.class_representatives
   1 of   7 in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.rational_period_functions
   2 of   9 in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.reduced_elements
   1 of   5 in sage.modular.modform_hecketriangle.hecke_triangle_groups.?.simple_elements
    [228 tests, 6 failures, 4.90 s]
**********************************************************************
File "src/sage/modular/modform_hecketriangle/readme.py", line 549, in sage.modular.modform_hecketriangle.readme
Failed example:
    G.class_representatives(9*G.lam() + 5)
Expected:
    [S*T^(-2)*S*T^(-1)*S, T*S*T^2]
Got:
    [T*S*T^2, S*T^(-2)*S*T^(-1)*S]
**********************************************************************
1 item had failures:
   1 of 383 in sage.modular.modform_hecketriangle.readme
    [382 tests, 1 failure, 19.56 s]
**********************************************************************
File "src/sage/monoids/trace_monoid.py", line 959, in sage.monoids.trace_monoid.TraceMonoid._repr_
Failed example:
    M.<a,b,c,d> = TraceMonoid(I=I); M
Expected:
    Trace monoid on 4 generators ([a], [b], [c], [d])
     with independence relation {{a, d}, {b, c}}
Got:
    Trace monoid on 4 generators ([a], [b], [c], [d]) with independence relation {{b, c}, {d, a}}
**********************************************************************
File "src/sage/monoids/trace_monoid.py", line 976, in sage.monoids.trace_monoid.TraceMonoid._latex_
Failed example:
    M.<a,b,c,d> = TraceMonoid(I=I); latex(M)
Expected:
    \langle a, b, c, d \mid ad=da,bc=cb \rangle
Got:
    \langle a, b, c, d \mid bc=cb,da=ad \rangle
**********************************************************************
2 items had failures:
   1 of   4 in sage.monoids.trace_monoid.TraceMonoid._latex_
   1 of   4 in sage.monoids.trace_monoid.TraceMonoid._repr_
    [186 tests, 2 failures, 4.63 s]
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 4166, in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
Failed example:
    f
Expected:
    1/2*y^2*z^7 - 1/4*y*z^8 + 2*x*z^5 + 95*z^6 + 1/2*y^5 - 1/4*y^4*z + x^2*y^2 + 3/2*x^2*y*z + 95*x*y*z^2
Got:
    1/2*y^2*z^7 - 1/4*y*z^8 + 95*x*z^5 + 2*z^6 + 1/2*y^5 - 1/4*y^4*z + x^2*y^2 + 189/2*x^2*y*z + 2*x*y*z^2
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 4168, in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
Failed example:
    f.lift(I.gens())
Expected:
    [2*x + 95*z, 1/2*y^2 - 1/4*y*z, 0]
Got:
    [95*x + 2*z, 1/2*y^2 - 1/4*y*z, 0]
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 4170, in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
Failed example:
    l = f.lift(J.gens()); l
Expected:
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1/2*y^2 + 1/4*y*z, 1/2*y^2*z^2 - 1/4*y*z^3 + 2*x + 95*z]
Got:
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1/2*y^2 + 1/4*y*z, 1/2*y^2*z^2 - 1/4*y*z^3 + 95*x + 2*z]
**********************************************************************
1 item had failures:
   3 of 111 in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
    [917 tests, 3 failures, 10.04 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/cone.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/fan_isomorphism.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/library.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/triangulation/point_configuration.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/graphs/graph.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/homology/homology_vector_space_with_basis.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/matroids/graphic_matroid.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py  # 6 doctests failed
sage -t --long --random-seed=0 src/sage/modular/modform_hecketriangle/readme.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/monoids/trace_monoid.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/rings/polynomial/multi_polynomial_ideal.py  # 3 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2020-08-23 16:27:03

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-08-24 15:37:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 16:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-24 16:52:09

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-25 01:21:46

This fixes all failures except for the following two:

```
sage -t --random-seed=0 src/sage/homology/homology_vector_space_with_basis.py  # 2 doctests failed
sage -t --random-seed=0 src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py  # 1 doctest failed
```

Help with these would be welcome


---

Comment by jhpalmieri created at 2020-08-25 03:33:49

There must be some way for me to run a 32-bit machine via Docker so I can look into these, but I can't figure out how.


---

Comment by mkoeppe created at 2020-08-25 03:57:03

Yes, for example `EXTRA_CONFIGURE_ARGS="--without-system-suitesparse" tox -e docker-ubuntu-eoan-i386-standard-python3_spkg`


---

Comment by jhpalmieri created at 2020-08-26 03:32:33

Replying to [comment:202 mkoeppe]:
> Yes, for example `EXTRA_CONFIGURE_ARGS="--without-system-suitesparse" tox -e docker-ubuntu-eoan-i386-standard-python3_spkg`

Well, that didn't work for me (with `EXTRA_CONFIGURE_ARGS="--with-system-suitesparse=no"`): the build failed for `cypari` and `giac`. But I used VirtualBox to install a 32-bit Debian machine, and I see the doctest failures. I actually haven't looked at the hecke_triangle_groups.py failure — not my area of expertise — but I understand what's happening with the homology failure. There are some unsorted pieces of data lying around, and when they get converted to lists or tuples, how they get converted affects the answer. Both answers (32-bit and 64-bit) are mathematically correct, it's just that you get a different choice of bases in the two cases.

I propose changing to a case where the sorting won't affect the answer.


---

Comment by git created at 2020-08-26 03:48:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-08-26 03:49:03

For the hecke_triangle_groups.py problem, this seems to fix it, but I don't know the mathematics of what's going on, nor have I looked at the code:

```diff
diff --git a/src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py b/src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py
index 47ba82eb8e..cb336f64c4 100644
--- a/src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py
+++ b/src/sage/modular/modform_hecketriangle/hecke_triangle_groups.py
@@ -1096,7 +1096,7 @@ class HeckeTriangleGroup(FinitelyGeneratedMatrixGroup_generic,
             [[U], [U^(-1)]]
 
             sage: R = G.class_representatives(14)
-            sage: R
+            sage: sorted(R)
             [[V(2)*V(3)], [V(1)*V(2)]]
             sage: sorted(v.continued_fraction()[1] for v in R)
             [(1, 2, 2), (3,)]
```



---

Comment by dimpase created at 2020-08-26 10:14:09

Replying to [comment:205 jhpalmieri]:
> For the hecke_triangle_groups.py problem, this seems to fix it, but I don't know the mathematics of what's going on, nor have I looked at the code:

[docs](https://doc.sagemath.org/html/en/reference/modfrm_hecketriangle/sage/modular/modform_hecketriangle/hecke_triangle_groups.html) say that it's a list of representatives, with no  meaning attached to the order, so your fix is OK.


---

Comment by jhpalmieri created at 2020-08-26 17:52:38

Replying to [comment:206 dimpase]:
> Replying to [comment:205 jhpalmieri]:
> > For the hecke_triangle_groups.py problem, this seems to fix it, but I don't know the mathematics of what's going on, nor have I looked at the code:
> 
> [docs](https://doc.sagemath.org/html/en/reference/modfrm_hecketriangle/sage/modular/modform_hecketriangle/hecke_triangle_groups.html) say that it's a list of representatives, with no  meaning attached to the order, so your fix is OK.

I'll push a branch after I do a bit more testing, unless someone beats me to it. (One question is how the elements in the list R are sorted. I can't tell after looking at the code for a few minutes. But this does seem to work.)


---

Comment by git created at 2020-08-26 23:46:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-08-26 23:47:27

Okay, this works for me on OS X with the system Python and Sage's Python 3.8, and the same on a virtual Debian 32-bit machine.


---

Comment by mkoeppe created at 2020-08-27 01:27:04

Great!


---

Comment by mkoeppe created at 2020-08-27 01:27:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-30 21:22:40

Merge conflict


---

Comment by vbraun created at 2020-08-30 21:22:40

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-08-30 21:31:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-30 21:31:45

Changing status from needs_work to positive_review.


---

Comment by git created at 2020-08-30 22:37:48

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-08-30 22:37:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2020-08-30 22:38:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-03 02:51:02

Changing priority from critical to blocker.


---

Comment by charpent created at 2020-09-04 09:15:09

FWIW, worked for MeToo(TM) :

Rebuilding `2.9.beta11`+#27754 on Debian sesting running on core i7 + 16 GB RAM gives results identical to those obtained on the same machine without #27754 (see [sage-release](https://groups.google.com/d/msg/sage-release/IiGznoPMATI/fjEYi0IaCQAJ)). And `$sSAGE_LOCAL\bin\python*` are symlinks to `\usr\bin\`...


---

Comment by dimpase created at 2020-09-04 09:26:32

it even works on Rasberry Pi 4 (armv7l).


---

Comment by vbraun created at 2020-09-06 21:52:04

Resolution: fixed


---

Comment by slelievre created at 2020-09-11 00:48:53

Wonderful to have this in Sage 9.2.

Next episode:

- #30184: Support Python 3.9

(Python 3.9.rc2 is expected on 2020-09-14
and Python 3.9 final on 2020-10-05.)
