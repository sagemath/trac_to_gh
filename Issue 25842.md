# Issue 25842: Quotients of finite dimensional Lie algebras

archive/issues_025842.json:
```json
{
    "body": "CC:  @tscrim\n\nKeywords: Lie algebras, ideals, quotients\n\nAn implementation of quotients of finite dimensional Lie algebras with basis. As with ideals, in the finite dimensional case a naive (and probably inefficient) to compute quotients is available by reducing a basis of the Lie algebra modulo the ideal and computing structural coefficients in terms of the reduced basis. Part of a part of #16824\n\nIssue created by migration from https://trac.sagemath.org/ticket/26079\n\n",
    "closed_at": "2018-09-22T10:22:36Z",
    "created_at": "2018-08-17T07:13:43Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Quotients of finite dimensional Lie algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25842",
    "user": "https://github.com/ehaka"
}
```
CC:  @tscrim

Keywords: Lie algebras, ideals, quotients

An implementation of quotients of finite dimensional Lie algebras with basis. As with ideals, in the finite dimensional case a naive (and probably inefficient) to compute quotients is available by reducing a basis of the Lie algebra modulo the ideal and computing structural coefficients in terms of the reduced basis. Part of a part of #16824

Issue created by migration from https://trac.sagemath.org/ticket/26079





---

archive/issue_comments_364334.json:
```json
{
    "body": "Some implementation already exists in a codebase that I need to clean up and import into Sage.",
    "created_at": "2018-08-17T07:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364334",
    "user": "https://github.com/ehaka"
}
```

Some implementation already exists in a codebase that I need to clean up and import into Sage.



---

archive/issue_comments_364335.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-02T14:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364335",
    "user": "https://github.com/ehaka"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_364336.json:
```json
{
    "body": "An initial implementation in the commits. The Lie algebra that the quotient was created from is stored  for internal use in the `__ambient` attribute instead of `_ambient` as the latter is being used in `product_space` in `sage.categories.algebras.finite_dimensional_lie_algebras_with_basis`, which caused issues with e.g. lower central series computations for quotient Lie algebras.\n\n---\nLast 10 new commits:",
    "created_at": "2018-09-02T14:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364336",
    "user": "https://github.com/ehaka"
}
```

An initial implementation in the commits. The Lie algebra that the quotient was created from is stored  for internal use in the `__ambient` attribute instead of `_ambient` as the latter is being used in `product_space` in `sage.categories.algebras.finite_dimensional_lie_algebras_with_basis`, which caused issues with e.g. lower central series computations for quotient Lie algebras.

---
Last 10 new commits:



---

archive/issue_comments_364337.json:
```json
{
    "body": "So having `_ambient` and `__ambient` being different objects will be horribly confusing and prone to causing errors. So what we probably need is a better test in `product_space` (or anything else that needs to check if something is constructed as a subalgebra. I haven't thought about this yet, but will try to do so today. Do you have any ideas?",
    "created_at": "2018-09-03T02:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364337",
    "user": "https://github.com/tscrim"
}
```

So having `_ambient` and `__ambient` being different objects will be horribly confusing and prone to causing errors. So what we probably need is a better test in `product_space` (or anything else that needs to check if something is constructed as a subalgebra. I haven't thought about this yet, but will try to do so today. Do you have any ideas?



---

archive/issue_comments_364338.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-09-03T02:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364338",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_364339.json:
```json
{
    "body": "One option could be to replicate the `is_ideal` approach and to add a `is_subalgebra` method, leaving the particular implementation to the classes themselves. In the current implementation the subalgebras are already overriding `is_ideal` since `module` currently refers to the intrinsic basis of the subalgebra. This is possibly something that I should refactor in #26078, since the mix between the intrinsic and ambient bases is a bit confusing as well. Perhaps for subalgebras anything referring to vectors is best done only in the ambient basis?\n\nAnother possibility would be to make use of the `Subobjects` category. Ideals and subalgebras are in the `Subobjects` category and quotients in the `Subquotients` category instead. So subalgebras are distinguished from quotients by containment in `LieAlgebras(R).Subobjects()`. Although I am not sure how this would fit together with other Lie algebra implementations that use `_ambient` (nor do I know what are all the places where this is used).",
    "created_at": "2018-09-03T06:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364339",
    "user": "https://github.com/ehaka"
}
```

One option could be to replicate the `is_ideal` approach and to add a `is_subalgebra` method, leaving the particular implementation to the classes themselves. In the current implementation the subalgebras are already overriding `is_ideal` since `module` currently refers to the intrinsic basis of the subalgebra. This is possibly something that I should refactor in #26078, since the mix between the intrinsic and ambient bases is a bit confusing as well. Perhaps for subalgebras anything referring to vectors is best done only in the ambient basis?

Another possibility would be to make use of the `Subobjects` category. Ideals and subalgebras are in the `Subobjects` category and quotients in the `Subquotients` category instead. So subalgebras are distinguished from quotients by containment in `LieAlgebras(R).Subobjects()`. Although I am not sure how this would fit together with other Lie algebra implementations that use `_ambient` (nor do I know what are all the places where this is used).



---

archive/issue_comments_364340.json:
```json
{
    "body": "Replying to [comment:4 gh-ehaka]:\n> One option could be to replicate the `is_ideal` approach and to add a `is_subalgebra` method, leaving the particular implementation to the classes themselves. In the current implementation the subalgebras are already overriding `is_ideal` since `module` currently refers to the intrinsic basis of the subalgebra. This is possibly something that I should refactor in #26078, since the mix between the intrinsic and ambient bases is a bit confusing as well. Perhaps for subalgebras anything referring to vectors is best done only in the ambient basis?\n\n\nI think in terms of computations, it would be better to do keep it in terms of the local basis. This will be much faster and structure coefficients can be computed lazily (i.e., on demand) because you keep track of the lift to the ambient (which should basically be stored in a list or some other fast data structure).\n\n> Another possibility would be to make use of the `Subobjects` category. Ideals and subalgebras are in the `Subobjects` category and quotients in the `Subquotients` category instead. So subalgebras are distinguished from quotients by containment in `LieAlgebras(R).Subobjects()`. Although I am not sure how this would fit together with other Lie algebra implementations that use `_ambient` (nor do I know what are all the places where this is used).\n\n\nThis should not be heavily (or maybe even at all other than some toy examples) used currently because I never got around to really implementing subalgebras. I think this would be a better strategy (I don't think categories were implemented in Sage when I first did this). The only other thing that seems reasonable to me is doing an `is_subalgebra`, but that seems kind of dumb and would be better suited to doing things like `L.is_subalgebra(M)`.\n\nI guess also nobody thought about having subobjects of quotients. Although this lift to the ambient is really just an optimization because the ambient will already have the structure coeffs, but the submodule may not. However, I think it is generally a useful optimization (as it allows you to work only with the submodules).",
    "created_at": "2018-09-03T09:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364340",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:4 gh-ehaka]:
> One option could be to replicate the `is_ideal` approach and to add a `is_subalgebra` method, leaving the particular implementation to the classes themselves. In the current implementation the subalgebras are already overriding `is_ideal` since `module` currently refers to the intrinsic basis of the subalgebra. This is possibly something that I should refactor in #26078, since the mix between the intrinsic and ambient bases is a bit confusing as well. Perhaps for subalgebras anything referring to vectors is best done only in the ambient basis?


I think in terms of computations, it would be better to do keep it in terms of the local basis. This will be much faster and structure coefficients can be computed lazily (i.e., on demand) because you keep track of the lift to the ambient (which should basically be stored in a list or some other fast data structure).

> Another possibility would be to make use of the `Subobjects` category. Ideals and subalgebras are in the `Subobjects` category and quotients in the `Subquotients` category instead. So subalgebras are distinguished from quotients by containment in `LieAlgebras(R).Subobjects()`. Although I am not sure how this would fit together with other Lie algebra implementations that use `_ambient` (nor do I know what are all the places where this is used).


This should not be heavily (or maybe even at all other than some toy examples) used currently because I never got around to really implementing subalgebras. I think this would be a better strategy (I don't think categories were implemented in Sage when I first did this). The only other thing that seems reasonable to me is doing an `is_subalgebra`, but that seems kind of dumb and would be better suited to doing things like `L.is_subalgebra(M)`.

I guess also nobody thought about having subobjects of quotients. Although this lift to the ambient is really just an optimization because the ambient will already have the structure coeffs, but the submodule may not. However, I think it is generally a useful optimization (as it allows you to work only with the submodules).



---

archive/issue_comments_364341.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-20T18:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364342.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> This should not be heavily (or maybe even at all other than some toy examples) used currently because I never got around to really implementing subalgebras. I think this would be a better strategy (I don't think categories were implemented in Sage when I first did this).\n\n\nTrying to find all uses of `_ambient` with `search_src` under the category and algebra modules only turned up a commented out piece of code in `sage.algebras.lie_algebras.lie_algebra.py` and the Lie algebra example in `sage.categories.examples.finite_dimensional_lie_algebras_with_basis.py`, which conveniently enough already uses the `Subobjects` category.\n\nBased on the above search, I replaced the use of the `_ambient` attribute in the `product_space` method of `FiniteDimensionalLieAlgebrasWithBasis` to test for containment in the `Subobjects` subcategory instead. All the doctests still worked, so at least on the surface the change did not break anything.",
    "created_at": "2018-09-20T19:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364342",
    "user": "https://github.com/ehaka"
}
```

Replying to [comment:5 tscrim]:
> This should not be heavily (or maybe even at all other than some toy examples) used currently because I never got around to really implementing subalgebras. I think this would be a better strategy (I don't think categories were implemented in Sage when I first did this).


Trying to find all uses of `_ambient` with `search_src` under the category and algebra modules only turned up a commented out piece of code in `sage.algebras.lie_algebras.lie_algebra.py` and the Lie algebra example in `sage.categories.examples.finite_dimensional_lie_algebras_with_basis.py`, which conveniently enough already uses the `Subobjects` category.

Based on the above search, I replaced the use of the `_ambient` attribute in the `product_space` method of `FiniteDimensionalLieAlgebrasWithBasis` to test for containment in the `Subobjects` subcategory instead. All the doctests still worked, so at least on the surface the change did not break anything.



---

archive/issue_comments_364343.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-09-20T19:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364343",
    "user": "https://github.com/ehaka"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_364344.json:
```json
{
    "body": "Thank you. There are a few more things, but it is almost ready.\n\nYou should have a method\n\n```python\ndef defining_ideal(self):\n    return self._I\n```\n(This is what is done for, e.g., quotients of the `FreeAlgebra`.)\n\nThese changes limit a little bit the number of function calls. While they are not likely to give a significant/noticeable speedup, they do help limit the overhead a bit more:\n\n```diff\n-        sorted_indices = [ambient.basis().inverse_family()[X]\n-                          for X in ambient.basis()]\n+        inv = ambient.basis().inverse_family()\n+        sorted_indices = [iv[X] for X in ambient.basis()]\n```\n\n```diff\n-        sm = L.module().submodule_with_basis([I.reduce(L.basis()[i]).to_vector()\n+        B = L.basis()\n+        sm = L.module().submodule_with_basis([I.reduce(B[i]).to_vector()\n                                               for i in index_set])\n```\n\n```diff\n-        Xdict = X.monomial_coefficients().items()\n-        return L.sum(ck * L.basis()[ik] for ik, ck in Xdict)\n+        B = L.basis()\n+        return L.sum(ck * B[ik] for ik, ck in X)\n```\n(This also reduced the memory overhead.) Lastly, pull the `sm.basis()` call outside of the for loop.",
    "created_at": "2018-09-21T01:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364344",
    "user": "https://github.com/tscrim"
}
```

Thank you. There are a few more things, but it is almost ready.

You should have a method

```python
def defining_ideal(self):
    return self._I
```
(This is what is done for, e.g., quotients of the `FreeAlgebra`.)

These changes limit a little bit the number of function calls. While they are not likely to give a significant/noticeable speedup, they do help limit the overhead a bit more:

```diff
-        sorted_indices = [ambient.basis().inverse_family()[X]
-                          for X in ambient.basis()]
+        inv = ambient.basis().inverse_family()
+        sorted_indices = [iv[X] for X in ambient.basis()]
```

```diff
-        sm = L.module().submodule_with_basis([I.reduce(L.basis()[i]).to_vector()
+        B = L.basis()
+        sm = L.module().submodule_with_basis([I.reduce(B[i]).to_vector()
                                               for i in index_set])
```

```diff
-        Xdict = X.monomial_coefficients().items()
-        return L.sum(ck * L.basis()[ik] for ik, ck in Xdict)
+        B = L.basis()
+        return L.sum(ck * B[ik] for ik, ck in X)
```
(This also reduced the memory overhead.) Lastly, pull the `sm.basis()` call outside of the for loop.



---

archive/issue_comments_364345.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-21T05:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364345",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364346.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-21T05:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364346",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_364347.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-21T11:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364347",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364348.json:
```json
{
    "body": "Thank you again for doing such a fine job implementing this. LGTM.",
    "created_at": "2018-09-21T11:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364348",
    "user": "https://github.com/tscrim"
}
```

Thank you again for doing such a fine job implementing this. LGTM.



---

archive/issue_comments_364349.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-22T10:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25842#issuecomment-364349",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065095.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-22T10:22:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25842",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25842#event-65095"
}
```
