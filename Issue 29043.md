# Issue 29043: expression parser should support unicode

archive/issues_029043.json:
```json
{
    "body": "CC:  rburing nbruin tscrim\n\nThis ticket fixes the `Tokenizer` in `sage.misc.parser` to handle unicode strings.\n\nFor example, this fixes these issues:\n\n```\nsage: SR('\u03bb + 2\u03bb')\n...\nSyntaxError: Malformed expression\n...\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: unexpected end of data\n\nsage: QQ['\u03bb']('\u03bb^2')\n...\nSyntaxError: Malformed expression\n```\n\n\nThis is solved by changing the tokenizer to work with Python strings instead of C-strings. This is also what Cython [recommends to do](http://docs.cython.org/en/latest/src/tutorial/strings.html#general-notes-about-c-strings). The C-strings were only used internally in the tokenizer, so this change should be unproblematic.\n\nNote that this is strictly about tokenizing/parsing of expressions, but not about validating input, even though some interfaces (like Maxima) might not support unicode. It is already possible to construct these expressions by different means, so the parser should support that as well.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29280\n\n",
    "created_at": "2020-03-04T20:15:32Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "expression parser should support unicode",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29043",
    "user": "@mwageringel"
}
```
CC:  rburing nbruin tscrim

This ticket fixes the `Tokenizer` in `sage.misc.parser` to handle unicode strings.

For example, this fixes these issues:

```
sage: SR('位 + 2位')
...
SyntaxError: Malformed expression
...
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: unexpected end of data

sage: QQ['位']('位^2')
...
SyntaxError: Malformed expression
```


This is solved by changing the tokenizer to work with Python strings instead of C-strings. This is also what Cython [recommends to do](http://docs.cython.org/en/latest/src/tutorial/strings.html#general-notes-about-c-strings). The C-strings were only used internally in the tokenizer, so this change should be unproblematic.

Note that this is strictly about tokenizing/parsing of expressions, but not about validating input, even though some interfaces (like Maxima) might not support unicode. It is already possible to construct these expressions by different means, so the parser should support that as well.


Issue created by migration from https://trac.sagemath.org/ticket/29280





---

archive/issue_comments_411058.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411058",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411059.json:
```json
{
    "body": "This passes the tests with both Python 2 and 3.\n----\nNew commits:",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411059",
    "user": "@mwageringel"
}
```

This passes the tests with both Python 2 and 3.
----
New commits:



---

archive/issue_comments_411060.json:
```json
{
    "body": "The Python 3 issue which the patchbot found looks like a false positive, caused by the occurence of `<>` in a string.",
    "created_at": "2020-03-06T18:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411060",
    "user": "@mwageringel"
}
```

The Python 3 issue which the patchbot found looks like a false positive, caused by the occurence of `<>` in a string.



---

archive/issue_comments_411061.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411061",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_411062.json:
```json
{
    "body": "Do you want to make `s` known as a `str` object in the preparser?\n\nAlso, you don't need to mark the tests a `# py3` since we are Python3 only now.",
    "created_at": "2020-07-04T21:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411062",
    "user": "tscrim"
}
```

Do you want to make `s` known as a `str` object in the preparser?

Also, you don't need to mark the tests a `# py3` since we are Python3 only now.



---

archive/issue_comments_411063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-05T13:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411063",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_411064.json:
```json
{
    "body": "Thanks for the suggestions. I have updated the branch accordingly.",
    "created_at": "2020-07-05T13:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411064",
    "user": "@mwageringel"
}
```

Thanks for the suggestions. I have updated the branch accordingly.



---

archive/issue_comments_411065.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-05T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411065",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411066.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-07-05T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411066",
    "user": "tscrim"
}
```

Thank you.



---

archive/issue_comments_411067.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-10T19:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29043#issuecomment-411067",
    "user": "vbraun"
}
```

Resolution: fixed
