# Issue 29043: expression parser should support unicode

Issue created by migration from https://trac.sagemath.org/ticket/29280

Original creator: @mwageringel

Original creation time: 2020-03-04 20:15:32

CC:  rburing nbruin tscrim

This ticket fixes the `Tokenizer` in `sage.misc.parser` to handle unicode strings.

For example, this fixes these issues:

```
sage: SR('位 + 2位')
...
SyntaxError: Malformed expression
...
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: unexpected end of data

sage: QQ['位']('位^2')
...
SyntaxError: Malformed expression
```


This is solved by changing the tokenizer to work with Python strings instead of C-strings. This is also what Cython [recommends to do](http://docs.cython.org/en/latest/src/tutorial/strings.html#general-notes-about-c-strings). The C-strings were only used internally in the tokenizer, so this change should be unproblematic.

Note that this is strictly about tokenizing/parsing of expressions, but not about validating input, even though some interfaces (like Maxima) might not support unicode. It is already possible to construct these expressions by different means, so the parser should support that as well.



---

Comment by @mwageringel created at 2020-03-04 20:28:08

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-03-04 20:28:08

This passes the tests with both Python 2 and 3.
----
New commits:


---

Comment by @mwageringel created at 2020-03-06 18:46:20

The Python 3 issue which the patchbot found looks like a false positive, caused by the occurence of `<>` in a string.


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by tscrim created at 2020-07-04 21:56:52

Do you want to make `s` known as a `str` object in the preparser?

Also, you don't need to mark the tests a `# py3` since we are Python3 only now.


---

Comment by git created at 2020-07-05 13:22:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-07-05 13:36:52

Thanks for the suggestions. I have updated the branch accordingly.


---

Comment by tscrim created at 2020-07-05 23:51:28

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-07-05 23:51:28

Thank you.


---

Comment by vbraun created at 2020-07-10 19:34:23

Resolution: fixed
