# Issue 18950: Add rules for installing packages with pip

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-09-11 08:45:49

With the infrastructure of #19101, we can make it such that

```
sage -i pyopenssl
```

actually runs `pip`.


---

Comment by jdemeyer created at 2015-09-11 09:16:56

New commits:


---

Comment by jdemeyer created at 2015-09-11 09:16:56

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-09-11 09:36:19

Changing priority from major to critical.


---

Comment by kcrisman created at 2015-09-11 12:21:50

Can we do that for all packages that are installable that way (brian, biopython, etc.) then?  (I tried to look at the commit to see if it did that but my internet is very flaky until I get to work.)


---

Comment by jdemeyer created at 2015-09-11 12:24:09

Replying to [comment:4 kcrisman]:
> Can we do that for all packages that are installable that way?

The current branch deals with

```
beautifulsoup
biopython
brian
guppy
mpi4py
nibabel
pybtex
pyflakes
pyopenssl
trac
```



---

Comment by kcrisman created at 2015-09-11 13:00:04

Thanks - I actually saw that just before my internet cut out on the train :-( so I couldn't edit my post - but I appreciate the quick followup :-) and good thinking to do this, of course, we should have long ago.


---

Comment by git created at 2015-09-11 21:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-09-12 00:52:19

(You know, this could be very helpful for disentangling the many packages in sagenb.)


---

Comment by jdemeyer created at 2015-09-12 07:31:47

Replying to [comment:8 kcrisman]:
> (You know, this could be very helpful for disentangling the many packages in sagenb.)
Actually not, because these special `pip` rules are not standard packages.


---

Comment by vdelecroix created at 2015-09-13 12:56:30

Hi Jeroen,,

Do you consider your solution as temporary? I am afraid that it would become an open door to have thousands of packages in `piprules`. Shouldn't we reorient users toward `sage -pip install X`?

Vincent


---

Comment by tscrim created at 2015-09-13 16:57:16

Could this also be modified to work for `nzmath` and `pyx`?


---

Comment by kcrisman created at 2015-09-14 01:02:31

> Do you consider your solution as temporary? I am afraid that it would become an open door to have thousands of packages in `piprules`. 


That could be regarded as a feature.  After all, we'd still want to have some test with respect to doctests or something.  If people just want to add a pip package, whatever.  If they want to add a documentation file with interactions with standard Sage, why not?  Or is it just a flood waiting to get in?


---

Comment by jdemeyer created at 2015-09-14 07:32:22

Replying to [comment:10 vdelecroix]:
> Do you consider your solution as temporary?
No.

> I am afraid that it would become an open door to have thousands of packages in `piprules`.
which is problem because...? Besides, we didn't have "thousands" of optional/experimental packages before, so I don't see why this would suddenly become thousands now.

> Shouldn't we reorient users toward `sage -pip install X`?
I don't think so, because how is the user supposed to know if he should use `sage -i PKG` or `sage --pip install PKG`? With my patch here, the user just needs to know `sage -i PKG`.


---

Comment by jdemeyer created at 2015-09-14 07:35:44

Replying to [comment:11 tscrim]:
> Could this also be modified to work for `nzmath` and `pyx`?
If you successfully installed any of those two using `pip`, please tell me how. The obvious `sage --pip install pyx` or `sage --pip install nzmath` does not work.


---

Comment by tscrim created at 2015-09-14 12:59:26

Vincent was able to install them, although you need to pass additional arguments to `pip`. See [this thread](https://groups.google.com/forum/#!searchin/sage-devel/install$20pip/sage-devel/c9joE12sqDg/JJzhG7h4ZNQJ). I will try later today to see if I can get those to work.

However, perhaps nzmath should (continue to) be a spkg as the latest version is 1.2 and pip would install 1.1?


---

Comment by vdelecroix created at 2015-09-14 13:08:56

Seems to not work anymore:


```
sage -pip install --allow-external pyx --allow-unverified pyx pyx
```

ended up with

```
No files/directories in /tmp/pip-build-d6xYvF/pyx/pip-egg-info (from PKG-INFO)
```


and

```
sage -pip install --allow-external nzmath --allow-unverified nzmath nzmath
```

ended up with some timeout


---

Comment by vdelecroix created at 2015-09-14 18:11:04

I just tested all the list of packages provied in [comment:5 comment:5] and everything worked fine.

Replying to [comment:13 jdemeyer]:
> Replying to [comment:10 vdelecroix]:
> > Do you consider your solution as temporary?
> No.

Then it should be complient with `sage --optional` which lists the packages. Right now (after installing all the packages supported) I got:

```
$ sage --optional
beautifulsoup........................... 3.2.1 (not_installed)
biopython............................... 1.61 (not_installed)
brian................................... 1.4.1.p0 (not_installed)
mpi4py.................................. 1.2.2 (not_installed)
trac.................................... 0.11.5.p0 (not_installed)
etc
```


And also with `sage -t` that uses optional packages.

```
$ sage -t whatever
...
Using --optional=cbc,mpir,python2,sage,scons
...
```


> > I am afraid that it would become an open door to have thousands of packages in `piprules`.
> which is problem because...? Besides, we didn't have "thousands" of optional/experimental packages before, so I don't see why this would suddenly become thousands now.

Because it becomes now very easy. But you might be right.

> > Shouldn't we reorient users toward `sage -pip install X`?
> I don't think so, because how is the user supposed to know if he should use `sage -i PKG` or `sage --pip install PKG`? With my patch here, the user just needs to know `sage -i PKG`.

No. And as Karl-Dieter said it would be good to add tests for them `# optional - biopython`.

Vincent


---

Comment by vdelecroix created at 2015-09-14 18:11:04

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-09-14 18:54:05

Sorry Vincent, but that's currently too much to ask. It's hard to make these "real" packages without major changes to the package system.

So either this ticket get accepted as-is (potentially with minor modifications) or closed as "wontfix".


---

Comment by jdemeyer created at 2015-09-14 18:59:15

Think of these packages as forming a new category: we have standard packages, optional packages, experimental packages and pip packages. They are not optional packages and cannot be listed by some `sage --whatever` command.


---

Comment by jhpalmieri created at 2015-09-14 19:21:37

Although we can check existing optional packages to see if they've been installed by pip:

```diff
diff --git a/src/bin/sage-list-packages b/src/bin/sage-list-packages
index e809e40..9162a30 100755
--- a/src/bin/sage-list-packages
+++ b/src/bin/sage-list-packages
`@``@` -5,7 +5,7 `@``@`
 
 from __future__ import print_function
 
-import os, sys, argparse, re
+import os, argparse, re, subprocess
 from string import join
 
 if "SAGE_ROOT" not in os.environ:
`@``@` -98,13 +98,26 `@``@` if args['category'] == 'installed':
 # Any other categories
 else:
     if args['version']:
+        try:
+            pip_output = subprocess.check_output(['pip', 'list'], stderr=subprocess.STDOUT)
+        except CalledProcessError:
+            pip_output = ''
+
         # Display the columns' name
         if not args['dump']:
             print("{:.<40} {} ({})\n".format("[package] ", "[latest version]",
                                              "[installed version]"))
         for p in sorted(set(local).union(remote)):
+            if p in installed:
+                installed_version = installed[p]
+            else:
+                s = re.search('\n{}.*\((.*)\)\n'.format(p), pip_output)
+                if s:
+                    installed_version = s.groups(0)[0]
+                else:
+                    installed_version = 'not_installed'
             line = [p, local.get(p, remote.get(p, 'not_found')),
-                    installed.get(p, 'not_installed')]
+                    installed_version]
             if args['dump']:
                 print(join(line, ' '))
             else:
```

(This is not a complete patch, just an idea.)


---

Comment by jhpalmieri created at 2015-09-14 19:21:59

And if we think this sort of patch is a good idea, it can go on a later ticket, not this one.


---

Comment by jhpalmieri created at 2015-09-14 21:27:35

See #19213.


---

Comment by vdelecroix created at 2015-09-14 23:01:51

Replying to [comment:19 jdemeyer]:
> Think of these packages as forming a new category: we have standard packages, optional packages, experimental packages and pip packages. They are not optional packages and cannot be listed by some `sage --whatever` command.

What is this piprules file then!? It is possible to check the last version of a package with their json api

```
import urllib2
import json
def pip_versions(package_name):
    url = "https://pypi.python.org/pypi/{}/json".format(package_name)
    try:
        data = json.load(urllib2.urlopen(urllib2.Request(url)))
    except urllib2.HTTPError:
        return []
    else:
        versions = data["releases"].keys()
        return versions
```



---

Comment by vdelecroix created at 2015-09-14 23:03:56

Replying to [comment:18 jdemeyer]:
> Sorry Vincent, but that's currently too much to ask. It's hard to make these "real" packages without major changes to the package system.
> 
> So either this ticket get accepted as-is (potentially with minor modifications) or closed as "wontfix".

I think this ticket is good, but it lacks integration. I would be also happy if all of `brian`, `trac`, ... would *not* appear in `sage --optional`.

Vincent


---

Comment by vdelecroix created at 2015-09-14 23:07:29

In other words, we could:
 - remove all of `brian`, `trac`, ... from the list of optional packages
 - postponed the pip listing and test support to #19213

what do you think?


---

Comment by jdemeyer created at 2015-09-16 08:04:32

Replying to [comment:25 vdelecroix]:
> In other words, we could:
>  - remove all of `brian`, `trac`, ... from the list of optional packages
>  - postponed the pip listing and test support to #19213
> 
> what do you think?

Fine for me. Do you give positive to this ticket then?


---

Comment by vdelecroix created at 2015-09-16 13:31:55

Should we explicit ask on sage-devel for removing them from the server?

Vincent


---

Comment by vdelecroix created at 2015-09-16 13:31:55

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-09-16 14:34:06

Replying to [comment:27 vdelecroix]:
> Should we explicit ask on sage-devel for removing them from the server?
See #19220.


---

Comment by vbraun created at 2015-09-16 19:10:20

Doesn't work

```
$ sage -f brian
[... endless noise ...]
sage --pip uninstall -y brian
You are using pip version 6.1.1, however version 7.1.2 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
Cannot uninstall requirement brian, not installed
Makefile:2244: recipe for target 'brian-clean' failed
```

Also breaks the buildbot script that assumes that `build/pkgs/*` has a corresponding log file etc. IMHO one dirent for one package is IMHO a better organization, stuffing multiple packages into lines of a single file doesn't scale (merge conflicts if its too popular).


---

Comment by vbraun created at 2015-09-16 19:10:20

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2015-09-16 20:56:45

This might be a little ugly:

```diff
diff --git a/build/make/install b/build/make/install
index 7469661..a164fc4 100755
--- a/build/make/install
+++ b/build/make/install
`@``@` -473,7 +473,7 `@``@` while read PKG_NAME; do
 
     # Add a target to remove the "installed" file for "sage -f"
     echo >&5 "$PKG_NAME-clean:"
-    echo >&5 " sage --pip uninstall -y $PKG_NAME"
+    echo >&5 " sage --pip list | grep $PKG_NAME && sage --pip uninstall -y $PKG_NAME || :"
     echo >&5
 done <"$SAGE_ROOT/build/pkgs/piprules"
 
```

Or the same but omitting `sage --pip list | grep $PKG_NAME &&`.


---

Comment by jhpalmieri created at 2015-09-16 21:03:20

Replying to [comment:29 vbraun]:
> Also breaks the buildbot script that assumes that `build/pkgs/*` has a corresponding log file etc. IMHO one dirent for one package is IMHO a better organization, stuffing multiple packages into lines of a single file doesn't scale (merge conflicts if its too popular).

An alternate version could introduce a new package type ("pip"?), with one directory for each of these packages, just containing `type` and `SPKG.txt`.


---

Comment by vbraun created at 2015-09-16 21:04:31

Another benefit of making a file-per-package is that we could use them as requirements.txt files to pin versions if necessary. Or perhaps with directories as name/requirements.txt file.


---

Comment by vbraun created at 2015-09-16 21:08:30

Less fugly solution

```
sage --pip install --upgrade --force-reinstall <packagename>
```



---

Comment by vdelecroix created at 2015-09-16 22:07:50

Replying to [comment:30 jhpalmieri]:
> This might be a little ugly:
> {{{
> #!diff
> diff --git a/build/make/install b/build/make/install
> index 7469661..a164fc4 100755
> --- a/build/make/install
> +++ b/build/make/install
> `@``@` -473,7 +473,7 `@``@` while read PKG_NAME; do
>  
>      # Add a target to remove the "installed" file for "sage -f"
>      echo >&5 "$PKG_NAME-clean:"
> -    echo >&5 " sage --pip uninstall -y $PKG_NAME"
> +    echo >&5 " sage --pip list | grep $PKG_NAME && sage --pip uninstall -y $PKG_NAME || :"
>      echo >&5
>  done <"$SAGE_ROOT/build/pkgs/piprules"
>  
> }}}
> Or the same but omitting `sage --pip list | grep $PKG_NAME &&`.

You need to omit it since `pip list` does list `BeautifulSoup` and our package name is `beautifulsoup` (unless you grep without case sensitivity).


---

Comment by jdemeyer created at 2015-09-17 06:10:11

Replying to [comment:29 vbraun]:
> Also breaks the buildbot script that assumes that `build/pkgs/*` has a corresponding log file
Didn't you agree in #18993 that ordinary files in `build/pkgs` should be ignored?


---

Comment by git created at 2015-09-19 09:37:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-09-19 09:45:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-09-19 11:05:58

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-09-20 00:43:23

This is good for me. Volker?


---

Comment by vbraun created at 2015-09-20 08:25:21

Whats the point of whitelisting only specific packages? Including _trac_, which has no mathematical relevance nor any utility to non-developers (and for those only barely). Having special entries in the Sage package list only makes sense if there is a need for it, e.g. because they are dependencies of non-pip (optional) packages.

IMHO if the user runs `sage -f packagename` and `packagename` is not a Sage package then either
* always try to `pip install packagename`, or 
* finish with `pip search packagename` and, if it finds something, tell the user that it can be installed via `sage --pip`

We can merge the current to appease the cargo cultists and finally get rid of some of the broken packages, but its not entirely satisfactory.


---

Comment by vbraun created at 2015-09-20 08:25:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-20 17:03:53

Resolution: fixed
