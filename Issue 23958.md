# Issue 23958: Construction of an extension of a finite field should also create a coercion map.

archive/issues_023958.json:
```json
{
    "body": "CC:  @defeo\n\nIn Sage, finite fields automatically form a lattice of subfields of an algebraic closure except those constructed with explicit generator names. However, the following is counter-intuitive.\n\n\n```\nsage: k=GF(4)\nsage: K=k.extension(3, name='a')\nsage: k.is_subring(K)\nFalse\nsage: L=k.extension(3)\nsage: k.is_subring(L)\nTrue\n```\n\n\nThis is because K is explicitly constructed as an extension of the finite field k, thus it is expected that k is regarded as a subfield of K. That is, there should be a coercion map of k into K.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24195\n\n",
    "created_at": "2017-11-10T19:49:11Z",
    "labels": [
        "component: finite rings",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Construction of an extension of a finite field should also create a coercion map.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23958",
    "user": "https://github.com/kwankyu"
}
```
CC:  @defeo

In Sage, finite fields automatically form a lattice of subfields of an algebraic closure except those constructed with explicit generator names. However, the following is counter-intuitive.


```
sage: k=GF(4)
sage: K=k.extension(3, name='a')
sage: k.is_subring(K)
False
sage: L=k.extension(3)
sage: k.is_subring(L)
True
```


This is because K is explicitly constructed as an extension of the finite field k, thus it is expected that k is regarded as a subfield of K. That is, there should be a coercion map of k into K.



Issue created by migration from https://trac.sagemath.org/ticket/24195





---

archive/issue_comments_335279.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-10T21:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_335280.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-10T21:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335280",
    "user": "https://github.com/kwankyu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_335281.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-11T10:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335281",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_335282.json:
```json
{
    "body": "A little bit further in the code you can see\n\n```\n        # Use the canonical map if it exists.\n        f = E.coerce_map_from(self)\n        if f is None:\n            from sage.categories.homset import Hom\n            f = Hom(self, E).an_element()\n        return (E, f)\n```\n\nIt would make more sense to factor it with what you have done.\n\nMoreover, with your changes I believe that the conditional statement above is not used anymore.",
    "created_at": "2017-11-11T10:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335282",
    "user": "https://github.com/videlec"
}
```

A little bit further in the code you can see

```
        # Use the canonical map if it exists.
        f = E.coerce_map_from(self)
        if f is None:
            from sage.categories.homset import Hom
            f = Hom(self, E).an_element()
        return (E, f)
```

It would make more sense to factor it with what you have done.

Moreover, with your changes I believe that the conditional statement above is not used anymore.



---

archive/issue_comments_335283.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-12T10:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335283",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_335284.json:
```json
{
    "body": "Now let's see if patchbots complain. Meanwhile, Vincent, you might be interested in a companion ticket:\n\nhttps://trac.sagemath.org/ticket/24170",
    "created_at": "2017-11-12T10:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335284",
    "user": "https://github.com/kwankyu"
}
```

Now let's see if patchbots complain. Meanwhile, Vincent, you might be interested in a companion ticket:

https://trac.sagemath.org/ticket/24170



---

archive/issue_comments_335285.json:
```json
{
    "body": "Instead of a try/except as you did, don't you prefer first checking if there is an embedding as it used to be the case?\n\nThis is very hackish condition `not (hasattr(E, '_prefix') and hasattr(self, '_prefix'))`. What are you exactly testing with it?",
    "created_at": "2017-11-12T11:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335285",
    "user": "https://github.com/videlec"
}
```

Instead of a try/except as you did, don't you prefer first checking if there is an embedding as it used to be the case?

This is very hackish condition `not (hasattr(E, '_prefix') and hasattr(self, '_prefix'))`. What are you exactly testing with it?



---

archive/issue_comments_335286.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> Instead of a try/except as you did, don't you prefer first checking if there is an embedding as it used to be the case?\n\nHow is it possible? As far as I know, trying to know if there is an embedding closes the possibility to add new coercion map...\n\n> This is very hackish condition `not (hasattr(E, '_prefix') and hasattr(self, '_prefix'))`. What are you exactly testing with it?\n\nYou can find similar condition in other parts of the file. So it is \"standard\" in the file. The condition is to test whether the finite field is part of the lattice of subfields of an algebraic closure. Thus if the condition is true, an automatic coercion is provided by the ecosystem of finite fields, and so there is no need to provide one intentionally.",
    "created_at": "2017-11-12T12:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335286",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:9 vdelecroix]:
> Instead of a try/except as you did, don't you prefer first checking if there is an embedding as it used to be the case?

How is it possible? As far as I know, trying to know if there is an embedding closes the possibility to add new coercion map...

> This is very hackish condition `not (hasattr(E, '_prefix') and hasattr(self, '_prefix'))`. What are you exactly testing with it?

You can find similar condition in other parts of the file. So it is "standard" in the file. The condition is to test whether the finite field is part of the lattice of subfields of an algebraic closure. Thus if the condition is true, an automatic coercion is provided by the ecosystem of finite fields, and so there is no need to provide one intentionally.



---

archive/issue_comments_335287.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-13T08:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_335288.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-13T08:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335288",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_335289.json:
```json
{
    "body": "Could you move\n\n```\nif self.is_conway(): # and E is Conway\n    alpha = E.gen()**((E.order()-1)//(self.order()-1))\nelse:\n    alpha = self.modulus().roots(E)[0][0]\n```\n\nout of the `try/except` block?",
    "created_at": "2017-11-13T11:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335289",
    "user": "https://github.com/videlec"
}
```

Could you move

```
if self.is_conway(): # and E is Conway
    alpha = E.gen()**((E.order()-1)//(self.order()-1))
else:
    alpha = self.modulus().roots(E)[0][0]
```

out of the `try/except` block?



---

archive/issue_comments_335290.json:
```json
{
    "body": "Replying to [comment:13 vdelecroix]:\n> Could you move\n> {{{\n> if self.is_conway(): # and E is Conway\n>     alpha = E.gen()**((E.order()-1)//(self.order()-1))\n> else:\n>     alpha = self.modulus().roots(E)[0][0]\n> }}}\n> out of the `try/except` block?\n\nNo. Without the `try/except` block, you will get an exception when you want to get the same extension again. Do you have an alternative way to avoid this?",
    "created_at": "2017-11-13T11:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335290",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:13 vdelecroix]:
> Could you move
> {{{
> if self.is_conway(): # and E is Conway
>     alpha = E.gen()**((E.order()-1)//(self.order()-1))
> else:
>     alpha = self.modulus().roots(E)[0][0]
> }}}
> out of the `try/except` block?

No. Without the `try/except` block, you will get an exception when you want to get the same extension again. Do you have an alternative way to avoid this?



---

archive/issue_comments_335291.json:
```json
{
    "body": "Replying to [comment:13 vdelecroix]:\n> Could you move\n> {{{\n> if self.is_conway(): # and E is Conway\n>     alpha = E.gen()**((E.order()-1)//(self.order()-1))\n> else:\n>     alpha = self.modulus().roots(E)[0][0]\n> }}}\n> out of the `try/except` block?\n\nAh, I misunderstood your suggestion! Ok. That is possible :-)",
    "created_at": "2017-11-13T11:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335291",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:13 vdelecroix]:
> Could you move
> {{{
> if self.is_conway(): # and E is Conway
>     alpha = E.gen()**((E.order()-1)//(self.order()-1))
> else:
>     alpha = self.modulus().roots(E)[0][0]
> }}}
> out of the `try/except` block?

Ah, I misunderstood your suggestion! Ok. That is possible :-)



---

archive/issue_comments_335292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-13T11:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_335293.json:
```json
{
    "body": "Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?",
    "created_at": "2017-11-14T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335293",
    "user": "https://github.com/videlec"
}
```

Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?



---

archive/issue_comments_335294.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?\n\nI didn't know that `f = Hom(self, E).an_element()` does (almost) the same thing with my code using `roots`.\n\nAnyway the `an_element()` method does a few additional condition checkings, which are redundant for our case. But these additional checkings would take negligible time, perhaps a few micro seconds.\n\nThe `an_element()` method eventually resolves to `any_root()` method for the modulus polynomial. Comparing `any_root()` and `roots()`, I got these interesting timings:\n\n```\nsage: F=GF(16)\nsage: E=F.extension(2)\nsage: timeit('f.any_root(E,assume_squarefree=True)')\n125 loops, best of 3: 2.85 ms per loop\nsage: timeit('f.roots(E)[0][0]')\n125 loops, best of 3: 2.77 ms per loop\nsage: F=GF(16)\nsage: E=F.extension(2)\nsage: f=F.modulus()\nsage: timeit('f.roots(E)[0][0]')\n125 loops, best of 3: 2.78 ms per loop\nsage: timeit('f.any_root(E,assume_squarefree=True)')\n125 loops, best of 3: 2.87 ms per loop\nsage: F=GF(81)\nsage: E=F.extension(3)\nsage: f=F.modulus()\nsage: timeit('f.any_root(E,assume_squarefree=True)')\n125 loops, best of 3: 7.46 ms per loop\nsage: timeit('f.roots(E)[0][0]')\n125 loops, best of 3: 7.42 ms per loop\nsage: E=F.extension(5)\nsage: f=F.modulus()\nsage: timeit('f.any_root(E,assume_squarefree=True)')\n125 loops, best of 3: 6.17 ms per loop\nsage: timeit('f.roots(E)[0][0]')\n125 loops, best of 3: 6.13 ms per loop\n```\n\n\nThis seems to indicate that finding all roots actually takes less time than finding any one root! \n\nMy conclusion is that it is slightly better to construct the homomorphism directly using either `roots()` or `any_root()` as in my code than to use `Hom(self, E).an_element()`.  But I don't have any preference either to `roots()` or `any_root()`.",
    "created_at": "2017-11-17T08:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335294",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:17 vdelecroix]:
> Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?

I didn't know that `f = Hom(self, E).an_element()` does (almost) the same thing with my code using `roots`.

Anyway the `an_element()` method does a few additional condition checkings, which are redundant for our case. But these additional checkings would take negligible time, perhaps a few micro seconds.

The `an_element()` method eventually resolves to `any_root()` method for the modulus polynomial. Comparing `any_root()` and `roots()`, I got these interesting timings:

```
sage: F=GF(16)
sage: E=F.extension(2)
sage: timeit('f.any_root(E,assume_squarefree=True)')
125 loops, best of 3: 2.85 ms per loop
sage: timeit('f.roots(E)[0][0]')
125 loops, best of 3: 2.77 ms per loop
sage: F=GF(16)
sage: E=F.extension(2)
sage: f=F.modulus()
sage: timeit('f.roots(E)[0][0]')
125 loops, best of 3: 2.78 ms per loop
sage: timeit('f.any_root(E,assume_squarefree=True)')
125 loops, best of 3: 2.87 ms per loop
sage: F=GF(81)
sage: E=F.extension(3)
sage: f=F.modulus()
sage: timeit('f.any_root(E,assume_squarefree=True)')
125 loops, best of 3: 7.46 ms per loop
sage: timeit('f.roots(E)[0][0]')
125 loops, best of 3: 7.42 ms per loop
sage: E=F.extension(5)
sage: f=F.modulus()
sage: timeit('f.any_root(E,assume_squarefree=True)')
125 loops, best of 3: 6.17 ms per loop
sage: timeit('f.roots(E)[0][0]')
125 loops, best of 3: 6.13 ms per loop
```


This seems to indicate that finding all roots actually takes less time than finding any one root! 

My conclusion is that it is slightly better to construct the homomorphism directly using either `roots()` or `any_root()` as in my code than to use `Hom(self, E).an_element()`.  But I don't have any preference either to `roots()` or `any_root()`.



---

archive/issue_comments_335295.json:
```json
{
    "body": "Replying to [comment:18 klee]:\n> Replying to [comment:17 vdelecroix]:\n> > Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?\n> \n> I didn't know that `f = Hom(self, E).an_element()` does (almost) the same thing with my code using `roots`.\n> \n> Anyway the `an_element()` method does a few additional condition checkings, which are redundant for our case. But these additional checkings would take negligible time, perhaps a few micro seconds.\n> \n> The `an_element()` method eventually resolves to `any_root()` method for the modulus polynomial. Comparing `any_root()` and `roots()`, I got these interesting timings:\n> {{{\n> SNIP\n> }}}\n> \n> This seems to indicate that finding all roots actually takes less time than finding any one root! \n> \n> My conclusion is that it is slightly better to construct the homomorphism directly using either `roots()` or `any_root()` as in my code than to use `Hom(self, E).an_element()`.  But I don't have any preference either to `roots()` or `any_root()`.\n\nJust for clearer code I would advocate for `any_root`. In the future, there is a hope for this method to be faster than `all_roots`. If `any_root` is slower, its implementation should just be `return self.all_roots()[0]`.",
    "created_at": "2017-11-17T08:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335295",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:18 klee]:
> Replying to [comment:17 vdelecroix]:
> > Why calling `root` instead of `f = Hom(self, E).an_element()` as it used to be the case? Is your version better or faster?
> 
> I didn't know that `f = Hom(self, E).an_element()` does (almost) the same thing with my code using `roots`.
> 
> Anyway the `an_element()` method does a few additional condition checkings, which are redundant for our case. But these additional checkings would take negligible time, perhaps a few micro seconds.
> 
> The `an_element()` method eventually resolves to `any_root()` method for the modulus polynomial. Comparing `any_root()` and `roots()`, I got these interesting timings:
> {{{
> SNIP
> }}}
> 
> This seems to indicate that finding all roots actually takes less time than finding any one root! 
> 
> My conclusion is that it is slightly better to construct the homomorphism directly using either `roots()` or `any_root()` as in my code than to use `Hom(self, E).an_element()`.  But I don't have any preference either to `roots()` or `any_root()`.

Just for clearer code I would advocate for `any_root`. In the future, there is a hope for this method to be faster than `all_roots`. If `any_root` is slower, its implementation should just be `return self.all_roots()[0]`.



---

archive/issue_comments_335296.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-17T14:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_335297.json:
```json
{
    "body": "Thanks!",
    "created_at": "2017-11-18T17:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335297",
    "user": "https://github.com/videlec"
}
```

Thanks!



---

archive/issue_comments_335298.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-18T17:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335298",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_335299.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-14T12:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23958#issuecomment-335299",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_022412.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2017-12-14T12:39:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23958",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23958#event-22412"
}
```
