# Issue 26197: Do not require installed_packages() to work for three.js inclusion

archive/issues_026197.json:
```json
{
    "body": "CC:  @timokau fbissey arojas egourgoulhon\n\nKeywords: threejs, conda, installed_packages\n\nOn conda, we are seeing failing doctests because installed_packages() is used:\n\n```\nFile \"src/sage/plot/plot3d/base.pyx\", line 361, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs\nFailed example:\n    sphere(online=True)._rich_repr_threejs()\nException raised:\n    Traceback (most recent call last):\n      File \"/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 573, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 983, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.plot.plot3d.base.Graphics3d._rich_repr_threejs[0]>\", line 1, in <module>\n        sphere(online=True)._rich_repr_threejs()\n      File \"sage/plot/plot3d/base.pyx\", line 377, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:9311)\n        scripts = get_display_manager().threejs_scripts(options['online'])\n      File \"/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 749, in threejs_scripts\n        version = installed_packages()['threejs'].split('.')[0]\n    KeyError: 'threejs'\n```\n\n\nThis ticket aims to make installed_packages() here optional but also to simplify the threejs inclusion code that appears to have been duplicated and has since diverged.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26434\n\n",
    "created_at": "2018-10-08T22:23:21Z",
    "labels": [
        "distribution",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Do not require installed_packages() to work for three.js inclusion",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26197",
    "user": "saraedum"
}
```
CC:  @timokau fbissey arojas egourgoulhon

Keywords: threejs, conda, installed_packages

On conda, we are seeing failing doctests because installed_packages() is used:

```
File "src/sage/plot/plot3d/base.pyx", line 361, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs
Failed example:
    sphere(online=True)._rich_repr_threejs()
Exception raised:
    Traceback (most recent call last):
      File "/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.base.Graphics3d._rich_repr_threejs[0]>", line 1, in <module>
        sphere(online=True)._rich_repr_threejs()
      File "sage/plot/plot3d/base.pyx", line 377, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:9311)
        scripts = get_display_manager().threejs_scripts(options['online'])
      File "/builds/saraedum/conda-sagelib-tests/sagemath/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 749, in threejs_scripts
        version = installed_packages()['threejs'].split('.')[0]
    KeyError: 'threejs'
```


This ticket aims to make installed_packages() here optional but also to simplify the threejs inclusion code that appears to have been duplicated and has since diverged.

Issue created by migration from https://trac.sagemath.org/ticket/26434





---

archive/issue_comments_369128.json:
```json
{
    "body": "I CCed the usual packaging suspects; I have not tested this at all (Sage is rebuilding\u2026)\n----\nNew commits:",
    "created_at": "2018-10-08T22:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369128",
    "user": "saraedum"
}
```

I CCed the usual packaging suspects; I have not tested this at all (Sage is rebuildingâ€¦)
----
New commits:



---

archive/issue_comments_369129.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-08T22:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369129",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369130.json:
```json
{
    "body": "Ideally we would have a threejs config helper reporting its own version. That's the pipedream.",
    "created_at": "2018-10-08T22:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369130",
    "user": "fbissey"
}
```

Ideally we would have a threejs config helper reporting its own version. That's the pipedream.



---

archive/issue_comments_369131.json:
```json
{
    "body": "I looked into making threejs a feature and reporting the version there. But it appears that threejs has no version information readily available. Even if it had that information I am not sure what we would do with it. Requiring `r80` seems to be wrong as we are using a very small subset of threejs so I suspect that almost any version of threejs would work.",
    "created_at": "2018-10-08T22:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369131",
    "user": "saraedum"
}
```

I looked into making threejs a feature and reporting the version there. But it appears that threejs has no version information readily available. Even if it had that information I am not sure what we would do with it. Requiring `r80` seems to be wrong as we are using a very small subset of threejs so I suspect that almost any version of threejs would work.



---

archive/issue_comments_369132.json:
```json
{
    "body": "I agree, I think `master` is the one that give you the latest online. But the idea that you should use exactly the same version on and offline is not unsensible in itself.",
    "created_at": "2018-10-08T22:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369132",
    "user": "fbissey"
}
```

I agree, I think `master` is the one that give you the latest online. But the idea that you should use exactly the same version on and offline is not unsensible in itself.



---

archive/issue_comments_369133.json:
```json
{
    "body": "Why doesn't the example\n\n\n```\nget_display_manager().threejs_scripts(from_cdn=True)\n```\n\n\nrequire an `# optional - internet` tag? Apparently it doesn't becasue it didn't have one before either, but it seems like it should?\n\n> But it appears that threejs has no version information readily available.\n\nGrep shows that at least on nix the version is present in `package.json` and `package-lock.json`. Not sure if that is build system specific or anything.\n\nWhy would anyone want to use the CDN version anyways?",
    "created_at": "2018-10-09T15:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369133",
    "user": "@timokau"
}
```

Why doesn't the example


```
get_display_manager().threejs_scripts(from_cdn=True)
```


require an `# optional - internet` tag? Apparently it doesn't becasue it didn't have one before either, but it seems like it should?

> But it appears that threejs has no version information readily available.

Grep shows that at least on nix the version is present in `package.json` and `package-lock.json`. Not sure if that is build system specific or anything.

Why would anyone want to use the CDN version anyways?



---

archive/issue_comments_369134.json:
```json
{
    "body": "Replying to [comment:7 gh-timokau]:\n> Why doesn't the example\n> \n> {{{\n> get_display_manager().threejs_scripts(from_cdn=True)\n> }}}\n> \n> require an `# optional - internet` tag? Apparently it doesn't becasue it didn't have one before either, but it seems like it should?\nThis just generates `<script>` tags. It doesn't download the scripts that these tags refer to.\n\n\n> > But it appears that threejs has no version information readily available.\n> Grep shows that at least on nix the version is present in `package.json` and `package-lock.json`. Not sure if that is build system specific or anything.\nThese files are npm metadata. I don't think that all disrtibutions include them.\n\n> Why would anyone want to use the CDN version anyways?\nWe could remove the CDN option but it's probably there for a reason.\nWhy would you want to use it? Well \"it feels right\" from a web-dev perspective...maybe you don't have threejs installed (in a compatible version)? Or you want to publish this somewhere online and don't want to serve all these script tags yourself?",
    "created_at": "2018-10-09T15:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369134",
    "user": "saraedum"
}
```

Replying to [comment:7 gh-timokau]:
> Why doesn't the example
> 
> {{{
> get_display_manager().threejs_scripts(from_cdn=True)
> }}}
> 
> require an `# optional - internet` tag? Apparently it doesn't becasue it didn't have one before either, but it seems like it should?
This just generates `<script>` tags. It doesn't download the scripts that these tags refer to.


> > But it appears that threejs has no version information readily available.
> Grep shows that at least on nix the version is present in `package.json` and `package-lock.json`. Not sure if that is build system specific or anything.
These files are npm metadata. I don't think that all disrtibutions include them.

> Why would anyone want to use the CDN version anyways?
We could remove the CDN option but it's probably there for a reason.
Why would you want to use it? Well "it feels right" from a web-dev perspective...maybe you don't have threejs installed (in a compatible version)? Or you want to publish this somewhere online and don't want to serve all these script tags yourself?



---

archive/issue_comments_369135.json:
```json
{
    "body": "Makes sense. These changes look good to me, if the doctests pass. Definite improvement, thank you!",
    "created_at": "2018-10-09T15:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369135",
    "user": "@timokau"
}
```

Makes sense. These changes look good to me, if the doctests pass. Definite improvement, thank you!



---

archive/issue_comments_369136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-10T11:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369136",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369137.json:
```json
{
    "body": "I checked that this still works in jupyter and in sagenb. Let's see what the patchbots think about it.\n----\nNew commits:",
    "created_at": "2018-10-10T11:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369137",
    "user": "saraedum"
}
```

I checked that this still works in jupyter and in sagenb. Let's see what the patchbots think about it.
----
New commits:



---

archive/issue_comments_369138.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-16T14:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369138",
    "user": "saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369139.json:
```json
{
    "body": "gh-timokau, does this mean that we can set this to positive review now?",
    "created_at": "2019-02-16T14:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369139",
    "user": "saraedum"
}
```

gh-timokau, does this mean that we can set this to positive review now?



---

archive/issue_comments_369140.json:
```json
{
    "body": "Hm\u2026now I am confused with the current discussion on sage-devel whether this would change the `online` keyword of `show()` to `from_cdn`\u2026",
    "created_at": "2019-02-16T14:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369140",
    "user": "saraedum"
}
```

Hmâ€¦now I am confused with the current discussion on sage-devel whether this would change the `online` keyword of `show()` to `from_cdn`â€¦



---

archive/issue_comments_369141.json:
```json
{
    "body": "I don't know enough about three.js usages to give it a proper review myself, but I don't have any objections.",
    "created_at": "2019-02-16T14:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369141",
    "user": "@timokau"
}
```

I don't know enough about three.js usages to give it a proper review myself, but I don't have any objections.



---

archive/issue_comments_369142.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-16T15:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369142",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369143.json:
```json
{
    "body": "Fells like we lost the original goal of the ticket there. `install_package()` is needed if you don't want sage to break.",
    "created_at": "2019-02-16T18:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369143",
    "user": "fbissey"
}
```

Fells like we lost the original goal of the ticket there. `install_package()` is needed if you don't want sage to break.



---

archive/issue_comments_369144.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-16T19:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369144",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369145.json:
```json
{
    "body": "So the way to deal with locally served scripts is not to serve them at all but rather dump the whole script into the output??? And if there are multiple plots, then this code will be repeated and executed again and again and scripts won't be cached? Maybe all of this does not matter in practice because computers are so fast etc., but it surely seems wrong to me. I liked the old approach much better even if it required each backend to specify where to find these scripts.\n----\nNew commits:",
    "created_at": "2019-02-16T19:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369145",
    "user": "novoselt"
}
```

So the way to deal with locally served scripts is not to serve them at all but rather dump the whole script into the output??? And if there are multiple plots, then this code will be repeated and executed again and again and scripts won't be cached? Maybe all of this does not matter in practice because computers are so fast etc., but it surely seems wrong to me. I liked the old approach much better even if it required each backend to specify where to find these scripts.
----
New commits:



---

archive/issue_comments_369146.json:
```json
{
    "body": "And now remove functionality to load sensible scripts completely?!",
    "created_at": "2019-02-16T19:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369146",
    "user": "novoselt"
}
```

And now remove functionality to load sensible scripts completely?!



---

archive/issue_comments_369147.json:
```json
{
    "body": "But there does not seem to be an easy way to do this without dumping it all into the output. It's 500K per plot. That's annoying, sure, but at least it works (last time I checked at least) and nobody is going to complain about privacy.\n\nAt the meeting in Luminy last week we had virtually everybody who tried Sage stumble upon this one.\n\nSince three.js is a standard package this should also be acceptable for packagers. They need to set the THREEJS environment variable and then the right scripts should be included.",
    "created_at": "2019-02-16T19:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369147",
    "user": "saraedum"
}
```

But there does not seem to be an easy way to do this without dumping it all into the output. It's 500K per plot. That's annoying, sure, but at least it works (last time I checked at least) and nobody is going to complain about privacy.

At the meeting in Luminy last week we had virtually everybody who tried Sage stumble upon this one.

Since three.js is a standard package this should also be acceptable for packagers. They need to set the THREEJS environment variable and then the right scripts should be included.



---

archive/issue_comments_369148.json:
```json
{
    "body": "I agree that it's not pretty. But it fixes a bug and reduces the code base, that seems like a sensible solution for me until somebody sits down to find out how to do this properly in Jupyter & CoCalc.",
    "created_at": "2019-02-16T19:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369148",
    "user": "saraedum"
}
```

I agree that it's not pretty. But it fixes a bug and reduces the code base, that seems like a sensible solution for me until somebody sits down to find out how to do this properly in Jupyter & CoCalc.



---

archive/issue_comments_369149.json:
```json
{
    "body": "Replying to [comment:20 novoselt]:\n> And if there are multiple plots, then this code will be repeated and executed again and again and scripts won't be cached?\n\nAs I understand this, only the \"caching\" part of the script is different. The script would have been executed for every plot anyway as it was included in every plot with a `<script src=\"\u2026\">` tag.",
    "created_at": "2019-02-16T19:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369149",
    "user": "saraedum"
}
```

Replying to [comment:20 novoselt]:
> And if there are multiple plots, then this code will be repeated and executed again and again and scripts won't be cached?

As I understand this, only the "caching" part of the script is different. The script would have been executed for every plot anyway as it was included in every plot with a `<script src="â€¦">` tag.



---

archive/issue_comments_369150.json:
```json
{
    "body": "The current situation is:\n- by default scripts are served offline and it works in some cases\n- there is an option to easily get output with scripts served online from CDN which also has its use cases and works everywhere, as I understand, but should not be made the default\n- there are cases (important ones) where offline does not work\n\nHow about:\n- keep the existing functionality of serving \"offline\" scripts\n- keep the existing functionality of serving \"online/CDN\" scripts\n- add your new option to inject the whole code instead of script tags\n\nThe default should be then \"use offline scripts if possible, but inject the code if it does not work\". Is this realizable? If not, then at least please keep the option to use CDN on request, what harm comes from that?!",
    "created_at": "2019-02-16T19:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369150",
    "user": "novoselt"
}
```

The current situation is:
- by default scripts are served offline and it works in some cases
- there is an option to easily get output with scripts served online from CDN which also has its use cases and works everywhere, as I understand, but should not be made the default
- there are cases (important ones) where offline does not work

How about:
- keep the existing functionality of serving "offline" scripts
- keep the existing functionality of serving "online/CDN" scripts
- add your new option to inject the whole code instead of script tags

The default should be then "use offline scripts if possible, but inject the code if it does not work". Is this realizable? If not, then at least please keep the option to use CDN on request, what harm comes from that?!



---

archive/issue_comments_369151.json:
```json
{
    "body": "Replying to [comment:5 saraedum]:\n> I looked into making threejs a feature and reporting the version there. But it appears that threejs has no version information readily available. Even if it had that information I am not sure what we would do with it. Requiring `r80` seems to be wrong as we are using a very small subset of threejs so I suspect that almost any version of threejs would work.\nPlease be careful regarding versions: any version will generally not work. Three.js is almost never backward compatible. That\u2019s just how Mr.doob works, and if we want to use his code we need to be aware of that.",
    "created_at": "2019-03-29T19:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369151",
    "user": "paulmasson"
}
```

Replying to [comment:5 saraedum]:
> I looked into making threejs a feature and reporting the version there. But it appears that threejs has no version information readily available. Even if it had that information I am not sure what we would do with it. Requiring `r80` seems to be wrong as we are using a very small subset of threejs so I suspect that almost any version of threejs would work.
Please be careful regarding versions: any version will generally not work. Three.js is almost never backward compatible. Thatâ€™s just how Mr.doob works, and if we want to use his code we need to be aware of that.



---

archive/issue_comments_369152.json:
```json
{
    "body": "Please note that the proposed change always adds the locally installed version. That version should be compatible (the packager should make sure of that.)",
    "created_at": "2019-03-31T15:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369152",
    "user": "saraedum"
}
```

Please note that the proposed change always adds the locally installed version. That version should be compatible (the packager should make sure of that.)



---

archive/issue_comments_369153.json:
```json
{
    "body": "Replying to [comment:26 novoselt]:\n> The current situation is:\n> - by default scripts are served offline and it works in some cases\n> - there is an option to easily get output with scripts served online from CDN which also has its use cases and works everywhere, as I understand, but should not be made the default\n> - there are cases (important ones) where offline does not work\n> \n> How about:\n> - keep the existing functionality of serving \"offline\" scripts\n> - keep the existing functionality of serving \"online/CDN\" scripts\n> - add your new option to inject the whole code instead of script tags\n> \n> The default should be then \"use offline scripts if possible, but inject the code if it does not work\". Is this realizable? If not, then at least please keep the option to use CDN on request, what harm comes from that?!\n\nThe only harm that comes with this is that it creates more code to maintain. As opposed to only supporting one of these options.\n\nThe current situation is that this is broken for lots of users and they don't understand what's going on. (It was the most frequent issue people had with Sage at a recent introductory session of Sage.) I don't care at all how we fix this but we should just make it work by default everywhere. This here is one proposal to fix it. If it cannot be agreed upon, I am fine with anything else that works out of the box really. But I would really like to see this finally fixed. We can still improve upon this in a followup :)",
    "created_at": "2019-03-31T15:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369153",
    "user": "saraedum"
}
```

Replying to [comment:26 novoselt]:
> The current situation is:
> - by default scripts are served offline and it works in some cases
> - there is an option to easily get output with scripts served online from CDN which also has its use cases and works everywhere, as I understand, but should not be made the default
> - there are cases (important ones) where offline does not work
> 
> How about:
> - keep the existing functionality of serving "offline" scripts
> - keep the existing functionality of serving "online/CDN" scripts
> - add your new option to inject the whole code instead of script tags
> 
> The default should be then "use offline scripts if possible, but inject the code if it does not work". Is this realizable? If not, then at least please keep the option to use CDN on request, what harm comes from that?!

The only harm that comes with this is that it creates more code to maintain. As opposed to only supporting one of these options.

The current situation is that this is broken for lots of users and they don't understand what's going on. (It was the most frequent issue people had with Sage at a recent introductory session of Sage.) I don't care at all how we fix this but we should just make it work by default everywhere. This here is one proposal to fix it. If it cannot be agreed upon, I am fine with anything else that works out of the box really. But I would really like to see this finally fixed. We can still improve upon this in a followup :)



---

archive/issue_comments_369154.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-18T21:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369154",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369155.json:
```json
{
    "body": "I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.",
    "created_at": "2019-06-18T22:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369155",
    "user": "saraedum"
}
```

I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.



---

archive/issue_comments_369156.json:
```json
{
    "body": "Replying to [comment:31 saraedum]:\n> I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.\nI'm sure I don't fully understand the problems created by `installed_packages()`, but the CDN option is important for sharing notebooks and/or stand-alone graphics. Please do not just remove it completely!",
    "created_at": "2019-06-18T22:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369156",
    "user": "paulmasson"
}
```

Replying to [comment:31 saraedum]:
> I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.
I'm sure I don't fully understand the problems created by `installed_packages()`, but the CDN option is important for sharing notebooks and/or stand-alone graphics. Please do not just remove it completely!



---

archive/issue_comments_369157.json:
```json
{
    "body": "Replying to [comment:32 paulmasson]:\n> Replying to [comment:31 saraedum]:\n> > I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.\n> I'm sure I don't fully understand the problems created by `installed_packages()`, but the CDN option is important for sharing notebooks and/or stand-alone graphics. Please do not just remove it completely!\n\nIt is a bit like you hardcoding a call to `rpm` in your application to figure something out. Forget about `apt` or anything else.",
    "created_at": "2019-06-18T22:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369157",
    "user": "fbissey"
}
```

Replying to [comment:32 paulmasson]:
> Replying to [comment:31 saraedum]:
> > I hope that this approach is an improvement at least. The CDN option is broken imho as it relies on `installed_packages()`.
> I'm sure I don't fully understand the problems created by `installed_packages()`, but the CDN option is important for sharing notebooks and/or stand-alone graphics. Please do not just remove it completely!

It is a bit like you hardcoding a call to `rpm` in your application to figure something out. Forget about `apt` or anything else.



---

archive/issue_comments_369158.json:
```json
{
    "body": "Adding Eric Gourgoulhon for input on sharing notebooks",
    "created_at": "2019-06-18T22:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369158",
    "user": "paulmasson"
}
```

Adding Eric Gourgoulhon for input on sharing notebooks



---

archive/issue_comments_369159.json:
```json
{
    "body": "Another option is to hard-code the version of Three.js each time an upgrade is done. I think that's what I originally did but was persuaded to use `installed_packages()` to make upgrades easier. If there is a `THREEJSDIR` variable why not add a `THREEJSVER` variable as well? Then a note can be added to `spkg-src` to remind the upgrader to change that variable as well.\n\nI'm a web-oriented person: a big part of the reason I wrote the Three.js backend was to encourage sharing of interactive graphics over the web. I would hate to see all that functionality just disappear.",
    "created_at": "2019-06-18T23:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369159",
    "user": "paulmasson"
}
```

Another option is to hard-code the version of Three.js each time an upgrade is done. I think that's what I originally did but was persuaded to use `installed_packages()` to make upgrades easier. If there is a `THREEJSDIR` variable why not add a `THREEJSVER` variable as well? Then a note can be added to `spkg-src` to remind the upgrader to change that variable as well.

I'm a web-oriented person: a big part of the reason I wrote the Three.js backend was to encourage sharing of interactive graphics over the web. I would hate to see all that functionality just disappear.



---

archive/issue_comments_369160.json:
```json
{
    "body": "I can see the point of the advice you were given. However it ignored the push to package on distro. Ideally the information should be queryable from the installed stuff - without requiring a package manager. Hard coding is OK for me but I would favor something I can ask from the package itself somehow. Even if it is just manually parsing a file to find a version string.",
    "created_at": "2019-06-18T23:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369160",
    "user": "fbissey"
}
```

I can see the point of the advice you were given. However it ignored the push to package on distro. Ideally the information should be queryable from the installed stuff - without requiring a package manager. Hard coding is OK for me but I would favor something I can ask from the package itself somehow. Even if it is just manually parsing a file to find a version string.



---

archive/issue_comments_369161.json:
```json
{
    "body": "Replying to [comment:36 fbissey]:\n> I can see the point of the advice you were given. However it ignored the push to package on distro. Ideally the information should be queryable from the installed stuff - without requiring a package manager. Hard coding is OK for me but I would favor something I can ask from the package itself somehow. Even if it is just manually parsing a file to find a version string.\nThe main `three.min.js` file has a string of the form `REVISION=\"100\"` so that the version is available in the browser. How about parsing the file for that when Sage loads?",
    "created_at": "2019-06-18T23:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369161",
    "user": "paulmasson"
}
```

Replying to [comment:36 fbissey]:
> I can see the point of the advice you were given. However it ignored the push to package on distro. Ideally the information should be queryable from the installed stuff - without requiring a package manager. Hard coding is OK for me but I would favor something I can ask from the package itself somehow. Even if it is just manually parsing a file to find a version string.
The main `three.min.js` file has a string of the form `REVISION="100"` so that the version is available in the browser. How about parsing the file for that when Sage loads?



---

archive/issue_comments_369162.json:
```json
{
    "body": "Works for me. You will understand that it is hard to figure something like that exists from just looking at the file :) I am glad we had this chat with you as the author to figure it out.",
    "created_at": "2019-06-18T23:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369162",
    "user": "fbissey"
}
```

Works for me. You will understand that it is hard to figure something like that exists from just looking at the file :) I am glad we had this chat with you as the author to figure it out.



---

archive/issue_comments_369163.json:
```json
{
    "body": "Replying to [comment:35 paulmasson]:\n> I'm a web-oriented person: a big part of the reason I wrote the Three.js backend was to encourage sharing of interactive graphics over the web. I would hate to see all that functionality just disappear.\n\nThe functionality does not appear. The plots just get much bigger because they contain the inline three.js. I am not proud of this, but at runtime it does not make that much of a difference to load three.js several times, I suppose.",
    "created_at": "2019-06-18T23:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369163",
    "user": "saraedum"
}
```

Replying to [comment:35 paulmasson]:
> I'm a web-oriented person: a big part of the reason I wrote the Three.js backend was to encourage sharing of interactive graphics over the web. I would hate to see all that functionality just disappear.

The functionality does not appear. The plots just get much bigger because they contain the inline three.js. I am not proud of this, but at runtime it does not make that much of a difference to load three.js several times, I suppose.



---

archive/issue_comments_369164.json:
```json
{
    "body": "Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)",
    "created_at": "2019-06-18T23:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369164",
    "user": "saraedum"
}
```

Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)



---

archive/issue_comments_369165.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-06-18T23:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369165",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_369166.json:
```json
{
    "body": "Replying to [comment:40 saraedum]:\n> Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)\n\nI am happy with that.",
    "created_at": "2019-06-18T23:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369166",
    "user": "fbissey"
}
```

Replying to [comment:40 saraedum]:
> Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)

I am happy with that.



---

archive/issue_comments_369167.json:
```json
{
    "body": "Replying to [comment:40 saraedum]:\n> Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)\nThe original purpose of distinguishing between offline/online scripts was to use local files by default. One could then choose to set `online=True` to use the CDN for files that were meant to be shared. The Three.js template also has the silent fallback to the CDN that was fixed in #27575, so that even a notebook generated with the default of local files would work when shared on the web.\n\nI would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?\n\nHow about if this ticket just parses `three.min.js` for the version number to get rid of `installed_packages()` and doesn't change anything else yet? Then see what other issues arise in practice. Although you'll want to use `THREEJSDIR` in the local script tags.",
    "created_at": "2019-06-19T00:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369167",
    "user": "paulmasson"
}
```

Replying to [comment:40 saraedum]:
> Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)
The original purpose of distinguishing between offline/online scripts was to use local files by default. One could then choose to set `online=True` to use the CDN for files that were meant to be shared. The Three.js template also has the silent fallback to the CDN that was fixed in #27575, so that even a notebook generated with the default of local files would work when shared on the web.

I would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?

How about if this ticket just parses `three.min.js` for the version number to get rid of `installed_packages()` and doesn't change anything else yet? Then see what other issues arise in practice. Although you'll want to use `THREEJSDIR` in the local script tags.



---

archive/issue_comments_369168.json:
```json
{
    "body": "Replying to [comment:43 paulmasson]:\n> Replying to [comment:40 saraedum]:\n> > Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)\n> The original purpose of distinguishing between offline/online scripts was to use local files by default. One could then choose to set `online=True` to use the CDN for files that were meant to be shared. The Three.js template also has the silent fallback to the CDN that was fixed in #27575, so that even a notebook generated with the default of local files would work when shared on the web.\n> \n> I would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?\n> \n> How about if this ticket just parses `three.min.js` for the version number to get rid of `installed_packages()` and doesn't change anything else yet? Then see what other issues arise in practice. Although you'll want to use `THREEJSDIR` in the local script tags.\n> \n\nThat also works for me. I had forgotten about #27575 in the meantime.",
    "created_at": "2019-06-19T00:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369168",
    "user": "saraedum"
}
```

Replying to [comment:43 paulmasson]:
> Replying to [comment:40 saraedum]:
> > Ok. So I can parse the REVISION to keep the CDN option alive. But the default would be to include all of three.js so things just work? (We could improve upon this further in a followup, e.g., add three.js to the sage kernel so it's only loaded once when in a Jupyter context.)
> The original purpose of distinguishing between offline/online scripts was to use local files by default. One could then choose to set `online=True` to use the CDN for files that were meant to be shared. The Three.js template also has the silent fallback to the CDN that was fixed in #27575, so that even a notebook generated with the default of local files would work when shared on the web.
> 
> I would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?
> 
> How about if this ticket just parses `three.min.js` for the version number to get rid of `installed_packages()` and doesn't change anything else yet? Then see what other issues arise in practice. Although you'll want to use `THREEJSDIR` in the local script tags.
> 

That also works for me. I had forgotten about #27575 in the meantime.



---

archive/issue_comments_369169.json:
```json
{
    "body": "Replying to [comment:43 paulmasson]:\n> \n> I would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?\n> \n\n+1",
    "created_at": "2019-06-20T12:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369169",
    "user": "egourgoulhon"
}
```

Replying to [comment:43 paulmasson]:
> 
> I would like to see the original idea kept alive: first use local files, then fall back to the CDN as necessary or by choice. The only time you would want to dump all of Three.js into a file is when there is no Internet connectivity at all, but how often does that happen nowadays?
> 

+1



---

archive/issue_comments_369170.json:
```json
{
    "body": "The intent of this ticket is addressed in #28086 so this one can be closed",
    "created_at": "2019-06-30T22:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369170",
    "user": "paulmasson"
}
```

The intent of this ticket is addressed in #28086 so this one can be closed



---

archive/issue_comments_369171.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2020-03-21T20:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369171",
    "user": "paulmasson"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_369172.json:
```json
{
    "body": "Closing as no longer needed. Reopen if you disagree.",
    "created_at": "2020-03-21T20:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369172",
    "user": "paulmasson"
}
```

Closing as no longer needed. Reopen if you disagree.



---

archive/issue_comments_369173.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2020-06-23T06:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26197#issuecomment-369173",
    "user": "chapoton"
}
```

Resolution: duplicate
