# Issue 12419: same color shows up different in graphics_array

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2012-02-26 13:23:17

Assignee: jason, was

CC:  kcrisman mkoeppe

Keywords: graphics_array, color

The code

```
g = circle((0,0),1,rgbcolor='red',fill=True, alpha=0.5)
graphics_array([g,g,g]).show()
```

produces three circles, the first two with color 0xFF7F7F (html-color-code), the third one with color 0xFF3F3F (html-color-code). But all three should have the same color.

This was reported on [the public bug reports from the notebook interface](https://spreadsheets.google.com/pub?key=pCwvGVwSMxTzT6E2xNdo5fA)


---

Comment by kcrisman created at 2012-02-27 15:57:14

Huh, that's interesting.   Apparently the `alpha` is not propogated to the last one.

Related tickets: #10657 and friends.


---

Comment by kcrisman created at 2012-02-27 15:58:57

In fact, there is another manifestation of this there.

```

Replying to [comment:3 eviatarbach]:
> This is also a problem with other options, such as tick_formatter, ticks, and axes_labels. They are only applied to the last graphic; see attached image produced by the following code:
> graphics_array([plot(sin(B*x), xmin=-2*pi, xmax=2*pi, tick_formatter=pi, ticks=pi/2, axes_labels=('', '%s'%B)) for B in [-2,-1,-1/2,1/2,1,2]], 3, 2)
```



---

Comment by chapoton created at 2014-11-02 20:34:36

It seems that the last one is just duplicated (which looks the same as doubling alpha).

```
sage: g = circle((0,0),1,rgbcolor='red',fill=True, alpha=0.1)
sage: graphics_array([g,g,g]).show()
```



---

Comment by chapoton created at 2014-11-03 20:51:04

More serious proof of duplication of the last object of the group:

```
sage: g = circle((0,0),1,rgbcolor='red',fill=True, alpha=0.1, legend_label='pink')
sage: graphics_array([g,g,g]).show()
```

But where on earth does this duplication come from ?


---

Comment by chapoton created at 2014-11-04 13:28:29

Changing status from new to needs_review.


---

Comment by chapoton created at 2014-11-04 13:28:29

The culprit was the line


```
        g.save(filename, dpi=dpi, figure=figure, sub=subplot,
               verify=do_verify, axes=axes, **kwds)
```


in sage/plot/graphics.py. Here g was defined inside the previous loop, so after the loop it gets once again the last value.

I have just extracted the last object by stopping the loop one step before.
----
New commits:


---

Comment by kcrisman created at 2014-11-04 14:41:22

Huh, nice find!  Do you think this would go toward fixing #10657 or #11160?


---

Comment by chapoton created at 2014-11-04 19:30:19

Probably all this happens at the very same place, but I do not understand this matplotlib business, so I am not able to do better than what I did.


---

Comment by chapoton created at 2014-11-04 19:33:04

Note that the legend in the third picture is no longer duplicated, but does not look the same:

```
sage: g = circle((0,0),1,rgbcolor='red',fill=True, alpha=0.1, legend_label='pink')
sage: graphics_array([g,g,g]).show()
```



---

Comment by kcrisman created at 2014-11-05 17:17:24

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-11-05 17:17:24

> Note that the legend in the third picture is no longer duplicated, but does not look the same:
> {{{
> sage: g = circle((0,0),1,rgbcolor='red',fill=True, alpha=0.1, legend_label='pink')
> sage: graphics_array([g,g,g]).show()
> }}}
Noted.  I tried getting rid of that last call to `save` and instead doing all in the loop, but that didn't work.  Probably we'll need to directly import stuff like

```
            from matplotlib.backends.backend_agg import FigureCanvasAgg
            figure.set_canvas(FigureCanvasAgg(figure))
            # this messes up the aspect ratio!
            #figure.canvas.mpl_connect('draw_event', pad_for_tick_labels)

            # tight_layout adjusts the *subplot* parameters so ticks aren't cut off, etc.
            figure.tight_layout()

            opts = dict(dpi=dpi, transparent=transparent)
            if fig_tight is True:
                opts['bbox_inches'] = 'tight'
            if self._bbox_extra_artists:
                opts['bbox_extra_artists'] = self._bbox_extra_artists

            figure.savefig(filename, **opts)
```

from the singular graphics object save code.


---

Comment by kcrisman created at 2014-11-05 17:24:03

> Noted.  I tried getting rid of that last call to `save` and instead doing all in the loop, but that didn't work.  Probably we'll need to directly import stuff like <snip>
> from the singular graphics object save code.
Yes, this works, though one has to (for now) get rid of the transparent and I just got rid of the last two if clauses since they didn't seem relevant to the array case for now.


---

Comment by kcrisman created at 2014-11-05 17:34:29

But there is a problem...
> In fact, there is another manifestation of this there.
> {{{
> > graphics_array([plot(sin(B*x), xmin=-2*pi, xmax=2*pi, tick_formatter=pi, ticks=pi/2, axes_labels=('', '%s'%B)) for B in [-2,-1,-1/2,1/2,1,2]], 3, 2)
> }}}
Actually, it turns out that fixing this ticket makes that issue even worse.  It's only in that save command which I just removed that all these extra options get used at all!  So the "right" fix for this would fix both; the current fix would leave that the same but still have the problem mentioned.

Your current fix, though, as far as I can tell, doesn't really make things _worse_, because for me in vanilla Sage I get for the command you mention in this comment
> Note that the legend in the third picture is no longer duplicated, but does not look the same:
that it just has two of the weird legends, so one weird legend is better than duplicated weird legends, right?

Let me know what you think; properly doctested (well, mentioned in a tests section, though perhaps we could extract the last element of a graphics array and check that it just has one figure), this change is a step in the right direction, I think.


---

Comment by git created at 2017-09-14 12:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-05-24 12:43:24

The issues described here are fixed in #27865.


---

Comment by chapoton created at 2019-06-28 12:57:54

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2019-06-28 16:14:08

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-30 11:59:07

Resolution: duplicate
