# Issue 27394: patch pythons to allow MacOS builds without /usr/include

archive/issues_027394.json:
```json
{
    "body": "CC:  embray vbraun jhpalmieri\n\nthis is a followup to #26899, where a stop-gap was implemented to let Sage build on a `/usr/include`-less OSX.\n\nIt turns out it is pretty easy to provide such a fix, see attachments for patches to be applied to Pythons (and then `autoreconf -ivf` has to be run to create proper configure and header). So the the remaining task here is to craft patches of acceptable size, which don't need autotools...\n\nIssue created by migration from https://trac.sagemath.org/ticket/27631\n\n",
    "created_at": "2019-04-09T17:25:09Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "patch pythons to allow MacOS builds without /usr/include",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27394",
    "user": "dimpase"
}
```
CC:  embray vbraun jhpalmieri

this is a followup to #26899, where a stop-gap was implemented to let Sage build on a `/usr/include`-less OSX.

It turns out it is pretty easy to provide such a fix, see attachments for patches to be applied to Pythons (and then `autoreconf -ivf` has to be run to create proper configure and header). So the the remaining task here is to craft patches of acceptable size, which don't need autotools...

Issue created by migration from https://trac.sagemath.org/ticket/27631





---

archive/issue_comments_386068.json:
```json
{
    "body": "Attachment [py2.patch](tarball://root/attachments/some-uuid/ticket27631/py2.patch) by dimpase created at 2019-04-09 17:26:59",
    "created_at": "2019-04-09T17:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386068",
    "user": "dimpase"
}
```

Attachment [py2.patch](tarball://root/attachments/some-uuid/ticket27631/py2.patch) by dimpase created at 2019-04-09 17:26:59



---

archive/issue_comments_386069.json:
```json
{
    "body": "Attachment [py3.patch](tarball://root/attachments/some-uuid/ticket27631/py3.patch) by dimpase created at 2019-04-09 17:30:04\n\nOne also has to do something to pillow:\n\n```\nThe headers or library files could not be found for zlib,\na required dependency when compiling Pillow from source.\n\n```\n",
    "created_at": "2019-04-09T17:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386069",
    "user": "dimpase"
}
```

Attachment [py3.patch](tarball://root/attachments/some-uuid/ticket27631/py3.patch) by dimpase created at 2019-04-09 17:30:04

One also has to do something to pillow:

```
The headers or library files could not be found for zlib,
a required dependency when compiling Pillow from source.

```




---

archive/issue_comments_386070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-10T07:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386070",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386071.json:
```json
{
    "body": "This looks excellent, thank you.  Positive review from me in principle, but we should also get some feedback from people who are better situated to actually test it.\n\nOne thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).",
    "created_at": "2019-04-10T11:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386071",
    "user": "embray"
}
```

This looks excellent, thank you.  Positive review from me in principle, but we should also get some feedback from people who are better situated to actually test it.

One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).



---

archive/issue_comments_386072.json:
```json
{
    "body": "I tested this on an OSX 10.14 with command-line tools-only installation of Xcode.\nIt would be great to have this tested on OSX with full-blown Xcode.",
    "created_at": "2019-04-10T11:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386072",
    "user": "dimpase"
}
```

I tested this on an OSX 10.14 with command-line tools-only installation of Xcode.
It would be great to have this tested on OSX with full-blown Xcode.



---

archive/issue_comments_386073.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).\n\nAnd this?",
    "created_at": "2019-04-10T12:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386073",
    "user": "embray"
}
```

Replying to [comment:4 embray]:
> One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).

And this?



---

archive/issue_comments_386074.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> Replying to [comment:4 embray]:\n> > One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).\n\nRight, I forgot that it\u2019s a normal Python call.\nI will change this as soon as I am back to the keyboard\n> \n> And this?",
    "created_at": "2019-04-10T14:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386074",
    "user": "dimpase"
}
```

Replying to [comment:6 embray]:
> Replying to [comment:4 embray]:
> > One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).

Right, I forgot that itâ€™s a normal Python call.
I will change this as soon as I am back to the keyboard
> 
> And this?



---

archive/issue_comments_386075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-10T19:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386075",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386076.json:
```json
{
    "body": "Replying to [comment:8 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[461d82c](https://git.sagemath.org/sage.git/commit/?id=461d82ca69387491419166421c89829f9edb59e4)||`use already configured location of OSX headers`||\n\nthis addresses comment:6",
    "created_at": "2019-04-10T19:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386076",
    "user": "dimpase"
}
```

Replying to [comment:8 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[461d82c](https://git.sagemath.org/sage.git/commit/?id=461d82ca69387491419166421c89829f9edb59e4)||`use already configured location of OSX headers`||

this addresses comment:6



---

archive/issue_comments_386077.json:
```json
{
    "body": "This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.\n\nWhat are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?",
    "created_at": "2019-04-10T23:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386077",
    "user": "jhpalmieri"
}
```

This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.

What are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?



---

archive/issue_comments_386078.json:
```json
{
    "body": "I guess one last thing to add would be to bump the patch level in the pillow package-version.txt.\n\nAlthough rebuilding python might force a rebuild of pillow, it would still be good to be explicit.  Then you can set to positive review as far as I'm concerned.",
    "created_at": "2019-04-11T11:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386078",
    "user": "embray"
}
```

I guess one last thing to add would be to bump the patch level in the pillow package-version.txt.

Although rebuilding python might force a rebuild of pillow, it would still be good to be explicit.  Then you can set to positive review as far as I'm concerned.



---

archive/issue_comments_386079.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.\n> \n> What are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?\n\nI haven't noticed any action on this upstream, but I (or Dima) should make a PR for his patch.  I think it's quite good and has a chance of being accepted; or at the very least making a PR might help spur action upstream.\n\nIn the meantime I don't think we should wait.  This is a problem for us *now*, and I have no problem with patching build system stuff.",
    "created_at": "2019-04-11T11:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386079",
    "user": "embray"
}
```

Replying to [comment:10 jhpalmieri]:
> This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.
> 
> What are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?

I haven't noticed any action on this upstream, but I (or Dima) should make a PR for his patch.  I think it's quite good and has a chance of being accepted; or at the very least making a PR might help spur action upstream.

In the meantime I don't think we should wait.  This is a problem for us *now*, and I have no problem with patching build system stuff.



---

archive/issue_comments_386080.json:
```json
{
    "body": "I'll make an upstream PR, no problem.",
    "created_at": "2019-04-11T12:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386080",
    "user": "dimpase"
}
```

I'll make an upstream PR, no problem.



---

archive/issue_comments_386081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-11T12:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386082.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-11T12:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386082",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386083.json:
```json
{
    "body": "Replying to [comment:13 dimpase]:\n> I'll make an upstream PR, no problem.\n\nThere is a new fun OSX bug, breaking testsuite on 10.14.4: https://bugs.python.org/issue36432\n\n(I also got it after trying to make a PR for upstream: https://github.com/dimpase/cpython/commit/41617bd6cd957995ec9e1f89558fbdce5f78bc79)",
    "created_at": "2019-04-11T20:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386083",
    "user": "dimpase"
}
```

Replying to [comment:13 dimpase]:
> I'll make an upstream PR, no problem.

There is a new fun OSX bug, breaking testsuite on 10.14.4: https://bugs.python.org/issue36432

(I also got it after trying to make a PR for upstream: https://github.com/dimpase/cpython/commit/41617bd6cd957995ec9e1f89558fbdce5f78bc79)



---

archive/issue_comments_386084.json:
```json
{
    "body": "Joke's on them. We haven't run the Python test suite in years because it always fails.",
    "created_at": "2019-04-11T20:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386084",
    "user": "jhpalmieri"
}
```

Joke's on them. We haven't run the Python test suite in years because it always fails.



---

archive/issue_comments_386085.json:
```json
{
    "body": "Replying to [comment:13 dimpase]:\n> I'll make an upstream PR, no problem.\n\nsee https://github.com/python/cpython/pull/12825",
    "created_at": "2019-04-14T10:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386085",
    "user": "dimpase"
}
```

Replying to [comment:13 dimpase]:
> I'll make an upstream PR, no problem.

see https://github.com/python/cpython/pull/12825



---

archive/issue_comments_386086.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-14T18:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386086",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_386087.json:
```json
{
    "body": "Follow-up: #29019",
    "created_at": "2020-01-15T18:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27394#issuecomment-386087",
    "user": "mkoeppe"
}
```

Follow-up: #29019
