# Issue 27394: patch pythons to allow MacOS builds without /usr/include

Issue created by migration from https://trac.sagemath.org/ticket/27631

Original creator: dimpase

Original creation time: 2019-04-09 17:25:09

CC:  embray vbraun jhpalmieri

this is a followup to #26899, where a stop-gap was implemented to let Sage build on a `/usr/include`-less OSX.

It turns out it is pretty easy to provide such a fix, see attachments for patches to be applied to Pythons (and then `autoreconf -ivf` has to be run to create proper configure and header). So the the remaining task here is to craft patches of acceptable size, which don't need autotools...


---

Attachment


---

Attachment

One also has to do something to pillow:

```
The headers or library files could not be found for zlib,
a required dependency when compiling Pillow from source.

```



---

Comment by dimpase created at 2019-04-10 07:23:22

Changing status from new to needs_review.


---

Comment by embray created at 2019-04-10 11:00:11

This looks excellent, thank you.  Positive review from me in principle, but we should also get some feedback from people who are better situated to actually test it.

One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).


---

Comment by dimpase created at 2019-04-10 11:02:27

I tested this on an OSX 10.14 with command-line tools-only installation of Xcode.
It would be great to have this tested on OSX with full-blown Xcode.


---

Comment by embray created at 2019-04-10 12:16:49

Replying to [comment:4 embray]:
> One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).

And this?


---

Comment by dimpase created at 2019-04-10 14:27:05

Replying to [comment:6 embray]:
> Replying to [comment:4 embray]:
> > One thing you might consider (and maybe you did and I'm missing something), in the [patch to pillow](https://git.sagemath.org/sage.git/tree/build/pkgs/pillow/patches/setup.py.patch?id=7dbd59b9a41d096e3f91e269925a80817eb641bc), rather than use `subprocess` to call `xcrun` again, given that this is a Python package why not just use `sysconfig.get_config_var('Py_MACOS_SYSROOT')` as is done in the `setup.py` for Python itself?  That way you ensure it's using the same MACOS_SYSROOT as the Python you're installing it on (in case for some odd reason it since changed).

Right, I forgot that itâ€™s a normal Python call.
I will change this as soon as I am back to the keyboard
> 
> And this?


---

Comment by git created at 2019-04-10 19:26:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-04-10 19:32:44

Replying to [comment:8 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[461d82c](https://git.sagemath.org/sage.git/commit/?id=461d82ca69387491419166421c89829f9edb59e4)||`use already configured location of OSX headers`||

this addresses comment:6


---

Comment by jhpalmieri created at 2019-04-10 23:19:18

This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.

What are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?


---

Comment by embray created at 2019-04-11 11:24:09

I guess one last thing to add would be to bump the patch level in the pillow package-version.txt.

Although rebuilding python might force a rebuild of pillow, it would still be good to be explicit.  Then you can set to positive review as far as I'm concerned.


---

Comment by embray created at 2019-04-11 11:25:57

Replying to [comment:10 jhpalmieri]:
> This works for me on an OS X 10.14.4 system for which the change at #26899 is otherwise necessary. I have a full Xcode installation plus my own copy of `gfortran`. With the branch here, all tests pass with a Python 2 build, and `make ptest-python3` passes its tests also.
> 
> What are the chances that the Python 3.x patch will be accepted? Is there any reason to wait for progress on https://bugs.python.org/issue36231?

I haven't noticed any action on this upstream, but I (or Dima) should make a PR for his patch.  I think it's quite good and has a chance of being accepted; or at the very least making a PR might help spur action upstream.

In the meantime I don't think we should wait.  This is a problem for us _now_, and I have no problem with patching build system stuff.


---

Comment by dimpase created at 2019-04-11 12:18:18

I'll make an upstream PR, no problem.


---

Comment by git created at 2019-04-11 12:26:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-04-11 12:26:53

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-04-11 20:05:14

Replying to [comment:13 dimpase]:
> I'll make an upstream PR, no problem.

There is a new fun OSX bug, breaking testsuite on 10.14.4: https://bugs.python.org/issue36432

(I also got it after trying to make a PR for upstream: https://github.com/dimpase/cpython/commit/41617bd6cd957995ec9e1f89558fbdce5f78bc79)


---

Comment by jhpalmieri created at 2019-04-11 20:59:07

Joke's on them. We haven't run the Python test suite in years because it always fails.


---

Comment by dimpase created at 2019-04-14 10:18:11

Replying to [comment:13 dimpase]:
> I'll make an upstream PR, no problem.

see https://github.com/python/cpython/pull/12825


---

Comment by vbraun created at 2019-04-14 18:04:42

Resolution: fixed


---

Comment by mkoeppe created at 2020-01-15 18:39:09

Follow-up: #29019
