# Issue 16444: Random doctest failures in sage/rings/algebraic_closure_finite_field.py

Issue created by migration from https://trac.sagemath.org/ticket/16681

Original creator: vbraun

Original creation time: 2014-07-19 04:54:37

CC:  pbruin defeo vdelecroix mmarco jpflori

This is caused by #15390. 

First of all, you should use a form of assert that gives some minimal information when it can fail, e.g. in the form below.

The following fails occasionally on OSX 10.9 (cf. algebraic_closure_finite_field.py line 910)

```
sage: K = GF(3).algebraic_closure()
sage: R = PolynomialRing(K, 'T')
sage: T = R.gen()
sage: for d in xrange(1000):
....:         p = R.random_element(degree=8)
....:         assert p.factor().prod() == p, p.factor()
....:     
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-22-f31a401fb53b> in <module>()
      1 for d in xrange(Integer(1000)):
      2         p = R.random_element(degree=Integer(8))
----> 3         assert p.factor().prod() == p, p.factor()
      4 

AssertionError: T * (T + 1) * (T + z5 + 1) * (T + z5^3 + 1) * (T + 2*z5^4 + z5) * (T + 2*z5^4 + 2*z5^2) * (T + 2*z5^4 + 2*z5^3 + z5^2 + z5)
```


On a related note, a random element can be zero:

```
sage: K = GF(3).algebraic_closure()
sage: R = PolynomialRing(K, 'T')
sage: T = R.gen()
sage: for d in xrange(1000):
....:         p = R.random_element(degree=randint(2,8))
....:         assert p.factor().prod() == p, p
....:     
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-15-db4aacba08d5> in <module>()
      1 for d in xrange(Integer(1000)):
      2         p = R.random_element(degree=randint(Integer(2),Integer(8)))
----> 3         assert p.factor().prod() == p, p
      4 

/home/release/Sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.so in sage.rings.polynomial.polynomial_element.Polynomial.factor (build/cythonized/sage/rings/polynomial/polynomial_element.c:23530)()

ValueError: factorization of 0 not defined
```



---

Comment by vdelecroix created at 2014-07-19 10:00:47

Hi,

Nice catch! I am on it.

For the "related note", if a polynomial with degree between 2 and 8 can be zero there is definitely a bug but not caused by #15390.

Vincent


---

Comment by vdelecroix created at 2014-07-19 10:49:25

I do not understand...

```
sage: K = GF(5).algebraic_closure()
sage: R = PolynomialRing(K, 'T')
sage: while True:
....:     p = R.random_element(degree=(2,10))
....:     fac = p.factor()
....:     assert fac.prod() == p, (p,fac)
Traceback (most recent call last):
...
AssertionError: (2*T^6 + 2*T^5 + 4*T^4 + 2*T^2 + 2*T + 2, (2) * (T + 3) * (T + 3*z5^3 + 2*z5^2 + 1) * (T + 2*z5^4 + 3*z5^2 + 4*z5 + 1) * (T + 2*z5^4 + z5^3 + z5^2 + 3) * (T + 2*z5^4 + 2*z5^3 + 2) * (T + 2*z5^4 + 4*z5^3 + z5^2 + 3*z5 + 2))
sage: p == fac.prod()          # fine
False
sage: p.factor() == fac        # What!?
False
sage: p.factor().prod() == p   # What again!?
True
```



---

Comment by vbraun created at 2014-07-19 15:09:44

The factorization is not cached but recomputed every time. Sometimes, it is wrong.


---

Comment by vbraun created at 2014-07-25 05:01:46

Changing keywords from "" to "random_fail".


---

Comment by vdelecroix created at 2014-08-13 10:27:07

All right. The root finding algorithm from #15390 was wrong.

Vincent
----
New commits:


---

Comment by vdelecroix created at 2014-08-13 10:27:07

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-08-24 16:01:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-08-24 16:01:19

lgtm


---

Comment by vbraun created at 2014-08-24 20:07:16

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-08-24 20:07:16


```
sage -t src/sage/matrix/matrix2.pyx
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 5349, in sage.matrix.matrix2.Matrix.diagonal.eigenvalues
Failed example:
    ev = M.eigenvalues(); ev
Expected:
    [2*z3, 2*z3 + 2, 2*z3 + 1]
Got:
    [2*z3 + 1, 2*z3 + 2, 2*z3]
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 5359, in sage.matrix.matrix2.Matrix.diagonal.eigenvalues
Failed example:
    e.as_finite_field_element()
Expected:
    (Finite Field in z3 of size 3^3, 2*z3, Ring morphism:
      From: Finite Field in z3 of size 3^3
      To:   Algebraic closure of Finite Field of size 3
      Defn: z3 |--> z3)
Got:
    (Finite Field in z3 of size 3^3, 2*z3 + 1, Ring morphism:
      From: Finite Field in z3 of size 3^3
      To:   Algebraic closure of Finite Field of size 3
      Defn: z3 |--> z3)
**********************************************************************
1 item had failures:
   2 of  19 in sage.matrix.matrix2.Matrix.diagonal.eigenvalues
    [2116 tests, 2 failures, 8.52 s]
----------------------------------------------------------------------
sage -t src/sage/matrix/matrix2.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 9.1 seconds
    cpu time: 8.4 seconds
    cumulative wall time: 8.5 seconds
```



---

Comment by git created at 2014-08-24 20:15:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-08-24 20:15:57

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-08-24 20:15:57

Might be a good idea to sort the eigenvalues in `.eigenvalues()`...

Vincent


---

Comment by vbraun created at 2014-08-25 10:27:50

Resolution: fixed


---

Comment by vbraun created at 2014-08-25 20:48:15

Got another random failure with this ticket merged:

```
sage -t src/sage/rings/algebraic_closure_finite_field.py
**********************************************************************
File "src/sage/rings/algebraic_closure_finite_field.py", line 942, in sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._factor_univariate_polynomial
Failed example:
    for d in xrange(10):
        p = R.random_element(degree=randint(2,8))
        assert p.factor().prod() == p, "error in the factorization of p={}".format(p)
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._factor_univariate_polynomial[4]>", line 3, in <module>
        assert p.factor().prod() == p, "error in the factorization of p={}".format(p)
    AssertionError: error in the factorization of p=T^7 + T^6 + T^5 + 2*T^4 + 2*T^3 + 2*T^2 + T + 2
**********************************************************************
1 item had failures:
   1 of   6 in sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._factor_univariate_polynomial
    [175 tests, 1 failure, 5.03 s]
```



---

Comment by vbraun created at 2014-08-25 20:48:15

Resolution changed from fixed to 


---

Comment by vbraun created at 2014-08-25 20:48:15

Changing status from closed to new.


---

Comment by vdelecroix created at 2014-08-26 22:36:47

Hello,

As said on [this thread on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c) the bug has nothing to do with algebraic closure of finite fields.

Nevertheless, the algorithm which I implemented at a first glance was wrong so:
 - either I move the branch to another ticket
 - or I open a new ticket for the bug about factorization of polynomials over finite fields

Vincent


---

Comment by vbraun created at 2014-08-27 10:18:26

Either way is fine with me. However you decide to split the ticket, feel free to set this branch back to positive review.


---

Comment by vdelecroix created at 2014-08-27 10:29:33

The new ticket to track the bug is #16885. It is in critical, I am not sure this is right.

For the current branch, what about the random failure? Should I tag the test with a `#bug`?

Vincent


---

Comment by vbraun created at 2014-08-27 10:36:26

Let's keep the test as it is for now, hopefully you can figure out what is wrong ;-)


---

Comment by vbraun created at 2014-08-27 10:36:34

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-08-27 10:36:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-08-27 10:37:29

New commits:


---

Comment by vbraun created at 2014-08-28 18:42:03

Resolution: fixed


---

Comment by nthiery created at 2014-09-03 12:37:14

For the record, I just got this error once, with 6.4.beta 2:

```
sage -t src/sage/rings/algebraic_closure_finite_field.py
**********************************************************************
File "src/sage/rings/algebraic_closure_finite_field.py", line 890, in sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._roots_univariate_polynomi
al
Failed example:
    for _ in xrange(10):
        p = R.random_element(degree=randint(2,8))
        for r in p.roots(K, multiplicities=False):
            assert p(r).is_zero(), "r={} is not a root of p={}".format(r,p)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._roots_univariate_polynomial[4]>", line 4, in <module>
        assert p(r).is_zero(), "r={} is not a root of p={}".format(r,p)
    AssertionError: r=4*t6^3 + 2*t6^2 + 1 is not a root of p=4*x^7 + 2*x^6 + 2*x^5 + 3*x^4 + 2*x^3 + 4*x^2 + 4*x
**********************************************************************
1 item had failures:
   1 of   6 in sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_generic._roots_univariate_polynomial
    [175 tests, 1 failure, 5.58 s]
```



---

Comment by jpflori created at 2014-09-03 12:51:37

Did you try with the fix from #16885?


---

Comment by nthiery created at 2014-09-03 12:59:34

No. But also I only got biten by this once, so even if I tried a couple times with #16885, this would not necessarily mean much. But if you think that's useful, I can go for it.


---

Comment by jpflori created at 2014-09-03 13:08:27

Don't really know, it somehow looks related...
#16885 should fix a very insidious and rarely occurring bug messing with the current characteristic and polynomial defining a finite field which might cause your error.


---

Comment by nthiery created at 2014-09-03 13:19:59

Ok. Ping me if you need more data point. Right now, I'll reserve the power for testing other tickets of mine. I forgot to mention: my machine is a standard Ubuntu box.
