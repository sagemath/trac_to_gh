# Issue 14352: The maxima spkg has cruft dating back to days of clisp use

Issue created by migration from Trac.

Original creator: Snark

Original creation time: 2013-05-08 18:57:37

Assignee: jdemeyer

CC:  fbissey

The maxima spkg creates a maxima-noreadline executable, which is an old hack. This should go away.

I might work on it myself, but first I must ask on which maxima spkg I should base my work on (a question which will disappear with the git transition...)


---

Comment by jdemeyer created at 2013-05-08 21:52:36

Replying to [ticket:14556 Snark]:
> I might work on it myself, but first I must ask on which maxima spkg I should base my work on
[http://boxen.math.washington.edu/home/release/sage-5.10.beta2/sage-5.10.beta2/spkg/standard/maxima-5.29.1.p1.spkg](http://boxen.math.washington.edu/home/release/sage-5.10.beta2/sage-5.10.beta2/spkg/standard/maxima-5.29.1.p1.spkg)


---

Comment by Snark created at 2013-05-09 12:59:59

Patch to the sage library


---

Attachment

The two attached patches should fix this ticket.


---

Comment by Snark created at 2013-05-09 13:01:51

Changing status from new to needs_review.


---

Comment by leif created at 2013-05-11 12:58:09

Changing keywords from "" to "noreadline".


---

Comment by leif created at 2013-05-11 12:58:09

You should also provide a "pre-patched" new spkg, with `SPKG.txt` updated as well.


---

Comment by Snark created at 2013-05-11 14:07:17

Patch to the maxima spkg


---

Attachment

I updated the patch, and the patched spkg can be found [here](http://boxen.math.washington.edu/home/jpuydt/maxima-5.29.1.p2.spkg)


---

Attachment

Positive review to your changes.

However, I added some more small changes to the maxima spkg, please review.


---

Comment by Snark created at 2013-05-25 06:58:05

Reviewed, with nothing bad to say.


---

Comment by Snark created at 2013-05-25 06:58:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-26 19:49:02

Resolution: fixed


---

Comment by kcrisman created at 2013-05-28 02:03:55

Did anyone actually try upgrading with this?  From beta4 - and don't try to tell me that was just a beta ;-)

```
test -d binary-ecl || mkdir binary-ecl
ecl -norc -eval '(progn (load "../lisp-utils/defsystem.lisp") (funcall (intern (symbol-name :operate-on-system) :mk) "maxima" :compile :verbose t) (build-maxima-lib))' -$
;;; Loading "/Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/../lisp-utils/defsystem.lisp"
;;; Loading #P"/Users/.../sage-5.10.beta3/local/lib/ecl/cmp.fas"
;;; Loading "/Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima.system"

;  - Compiling defsystem "maxima"
;    - Compiling module "package"
;      - Compiling source file
;        "/Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima-package.lisp"
;;;
;;; Compiling /Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima-package.lisp.
;;; OPTIMIZE levels: Safety=2, Space=0, Speed=3, Debug=2
;;;
;;; End of Pass 1.
;;; Internal error:
;;;   ** Unable to find include directory
;      - Binary file binary-ecl/maxima-package.fas is old or does not exist.
;        Compile (and load) source file /Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima-package.lisp instead? y
;      - Should I bother you if this happens again? y
;      - Compiling source file
;        "/Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima-package.lisp"
;;;
;;; Compiling /Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/maxima-package.lisp.
;;; OPTIMIZE levels: Safety=2, Space=0, Speed=3, Debug=2
;;;
;;; End of Pass 1.
;;; Internal error:
;;;   ** Unable to find include directory
;      - Loading binary file "binary-ecl/maxima-package.fas" An error occurred during initialization:
Filesystem error with pathname #P"/Users/.../sage-5.10.beta3/spkg/build/maxima-5.29.1.p3/src/src/binary-ecl/maxima-package.fas".
Either
 1) the file does not exist, or
 2) we are not allowed to access the file, or
 3) the pathname points to a broken symbolic link..
make[3]: *** [binary-ecl/maxima] Error 1
make[2]: *** [all-recursive] Error 1
***********************************************************
Error: Failed to build Maxima.
***********************************************************
```



---

Comment by kcrisman created at 2013-05-28 02:07:28

I'd also be skeptical of removing the OS X workaround unless we're sure that really doesn't cause problems on any Mac platforms.  Though I wouldn't be surprised if it turned out to be unnecessary with the latest ECL - I think that message dates to clisp, maybe that was part of the issue.


---

Comment by fbissey created at 2013-05-28 02:10:38

I don't think that was a clisp workaround but I could be wrong. So building from scratch on OS X works but upgrading doesn't?


---

Comment by kcrisman created at 2013-05-28 02:18:25

> So building from scratch on OS X works but upgrading doesn't?
I don't know.  I only just now got back online after the US holiday weekend and tried upgrading.  I assume Jeroen built from scratch before merging, however, but he probably only tests upgrades from major to major release on every platform... anyway, it's quite reproducible with this setup on my 10.7 Intel machine.


---

Comment by fbissey created at 2013-05-28 02:39:25

It is quite weird. But I assume this is material for a new ticket now, is it the full log for maxima? If you have more before that I think we should inspect it.


---

Comment by leif created at 2013-05-28 03:14:19

Well, unless something else got (unintentionally) messed up in the spkg , the only relevant change _is_ the removal of redirecting `stdout` and `stderr` to files on MacOS X, in Jeroen's `.p3`.


---

Comment by jdemeyer created at 2013-05-28 06:49:05

Replying to [comment:13 kcrisman]:
> I'd also be skeptical of removing the OS X workaround
Fair enough, but partially the reason for removal was that it was an undocumented fix. I really dislike "workarounds" without any reference to a ticket or clues what the problem is. And I even looked on the ticket numbers from the spkg, but couldn't find any reference to this problem on any Trac ticket.


---

Comment by fbissey created at 2013-05-28 09:48:28

I spent some time with hgview to scan the hg repo of the maxima spkg. This is in the initial commit on 23/07/2007 by wstein

```
if [ `uname` = "Darwin" ]; then
   echo "Now building maxima; this takes a few minutes"
   echo "Since we're using OS X and there is a very weird"
   echo "bug with buffered output while building maxima,"
   echo "you will not be able to see the output of the build"
   echo "as it occurs.  Don't worry, the build process did"
   echo "not hang."
   make > output.log
else
   make
fi
```

And the second commit of the repo has the following change, also by wstein on 2/11/2007

```
`@``@` -31,8 +39,10 `@``@`
    echo "you will not be able to see the output of the build"
    echo "as it occurs.  Don't worry, the build process did"
    echo "not hang."
-   make > output.log
+   make >> "$CUR"/output.log  2>> "$CUR"/error.log
 else
+
+
    make
 fi
 check_error "Failed to make Maxima." 
```

neither have trac tickets. trac tickets are vaguely mentioned in the commit message on occasion in 2008 and 2009, they are regulary in commit message in 2010 and the first time SPKG.txt quote a trac ticket is 13/02/2011. When did Jeroen become the release manager already???

That was some archeology. The work around has been in the spkg since 2007. maxima on a gentoo prefix on OS X doesn't have any buffering problems at build time.


---

Comment by kcrisman created at 2013-05-28 12:57:33

> It is quite weird. But I assume this is material for a new ticket now, is it the full log for maxima? If you have more before that I think we should inspect it.
The rest of the log is completely ordinary, same as always.  At this point I'm just asking for someone else to test upgrading for this spkg.

Indeed,

```
$ ls spkg/build/maxima-5.29.1.p3/src/src/binary-ecl/
maxima-package.c	maxima-package.data	maxima-package.eclh
```


As to the removal of the buffering fix thingie, I'm not worried about it as long as Jeroen has indeed tested it on a variety of machines, which sounds like it is the case.  I agree that commits from 2007 made by William are likely to be suspect and undocumented ;-)


---

Comment by kcrisman created at 2013-05-28 13:23:05

Replying to [comment:20 kcrisman]:
> > It is quite weird. But I assume this is material for a new ticket now, is it the full log for maxima? If you have more before that I think we should inspect it.
> The rest of the log is completely ordinary, same as always.  At this point I'm just asking for someone else to test upgrading for this spkg.
> 
> Indeed,
> {{{
> $ ls spkg/build/maxima-5.29.1.p3/src/src/binary-ecl/
> maxima-package.c	maxima-package.data	maxima-package.eclh
> }}}

Weirdly, now as I try to reinstall the p1 spkg, I get the same problem! Of course, it doesn't show up on the screen, but in error.log it's there, and the `binary-ecl` folder has the same three files.

Is it possible we have to touch ecl first so that it upgrades when upgrading this?  I don't see why, but I'll try that next.


---

Comment by kcrisman created at 2013-05-28 13:58:55

> Weirdly, now as I try to reinstall the p1 spkg, I get the same problem! Of course, it doesn't show up on the screen, but in error.log it's there, and the `binary-ecl` folder has the same three files.
> 
> Is it possible we have to touch ecl first so that it upgrades when upgrading this?  I don't see why, but I'll try that next.
Apparently this (reinstalling ecl) solves the problem.  I strongly suggest that someone else verify this before Sage 5.10 is released.


---

Comment by fbissey created at 2013-05-29 00:16:11

The ecl/maxima building problem again. ecl has been updated in beta2 so it shouldn't have been a problem updating from beta4. Did you move sage at some point before upgrading?


---

Comment by kcrisman created at 2013-05-29 00:46:27

Yes, because I had upgraded several times in a row and then renamed the folder.

I'll be mostly offline for a few days now, so I won't be able to reproduce this, but I am pretty certain that somehow this was the issue.


---

Comment by jdemeyer created at 2013-05-30 09:54:19

ecl/maxima build issue confirmed. It seems that the following doesn't work:

 1. build `ecl`
 2. move Sage tree
 3. build `maxima`


---

Comment by fbissey created at 2013-05-30 10:48:57

Again... we already dealt with that in the past. In any case it shouldn't be related to this ticket. It is really an ecl issue not a maxima one. The maxima bump just made it apparent.


---

Comment by jdemeyer created at 2013-05-30 10:49:59

Follow-up: #11359.
