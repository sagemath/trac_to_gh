# Issue 11846: sage-location will fail if user can't write to SAGE_ROOT

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-11-13 00:46:36

Assignee: leif

As the summary says.  The script sage-list-packages writes a temporary file to

```
file = "%s/tmp/list"%SAGE_ROOT
```

This should use a temporary file instead.


---

Attachment


---

Comment by jhpalmieri created at 2011-11-13 00:48:27

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-11-14 18:18:19

I should point out that sage-list-packages is used by the commands "sage --standard", "sage --optional", and "sage --experimental".


---

Comment by ohanar created at 2012-02-28 22:11:40

I've added a patch that avoids the use of a tempfile and cleans up the script (`os.path` should be used instead of string arithmetic).


---

Comment by jhpalmieri created at 2012-02-28 22:21:17

In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.


---

Comment by ohanar created at 2012-02-28 22:26:12

Replying to [comment:4 jhpalmieri]:
> In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.

Good point, it seems like the `urlparse` library is what I should have used. I'll update my patch.


---

Comment by ohanar created at 2012-02-28 23:01:51

ok, patch updated


---

Comment by jhpalmieri created at 2012-02-29 04:54:52

I'm happy to use your approach and not to create a file.  Some more comments: I think using urlparse.urljoin will clean some things up:

```diff
diff --git a/sage-list-packages b/sage-list-packages
--- a/sage-list-packages
+++ b/sage-list-packages
`@``@` -11,16 +11,11 `@``@` if not os.environ.has_key("SAGE_SERVER")
      print "The environment variable SAGE_SERVER must be set"
      sys.exit(1)
 
-url_list = list(urlparse.urlsplit(os.environ['SAGE_SERVER']))
-url_path = os.path.join(url_list[2], 'packages')
-url_list[2] = urllib.pathname2url(url_path)
-
-PKG_SERVER = urlparse.urlunsplit(url_list)
+PKG_SERVER = urlparse.urljoin(os.environ['SAGE_SERVER'], 'packages')
 print "Using SAGE Server %s"%PKG_SERVER
 
-url_path = os.path.join(url_path, sys.argv[1], 'list')
-url_list[2] = urllib.pathname2url(url_path)
-url = urlparse.urlunsplit(url_list)
+url_path = os.path.join('packages', sys.argv[1], 'list')
+url = urlparse.urljoin(PKG_SERVER, urllib.pathname2url(url_path))
 
 try:
      installed = set(os.listdir(os.path.join(SPKG_ROOT, 'installed')))
```

Also, according to the [Python documentation](http://docs.python.org/library/urllib.html#urllib.urlopen), urllib.urlopen is deprecated in favor of urllib2.urlopen.  Maybe we should use that instead?


---

Comment by jhpalmieri created at 2012-03-18 23:14:42

Any updates on this?


---

Comment by ohanar created at 2012-03-18 23:23:40

I think we should do what you suggest, sorry, got caught up in other stuff.


---

Comment by ohanar created at 2012-03-18 23:43:24

patch that avoids the use of a tempfile (and uses os.path instead of string arithmetic)


---

Attachment

ok, updated


---

Comment by jhpalmieri created at 2012-03-19 17:58:57

Looks good to me.


---

Comment by jhpalmieri created at 2012-03-19 17:58:57

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-23 15:20:47

Resolution: fixed
