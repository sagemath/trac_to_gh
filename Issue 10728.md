# Issue 10728: FanMorphism defined by matrices are dangerous

Issue created by migration from https://trac.sagemath.org/ticket/10793

Original creator: vbraun

Original creation time: 2011-02-17 11:52:58

Assignee: AlexGhitza

CC:  rbeezer kcrisman

Here I use a projection matrix to map a 3d cone to a 2d cone:

```
sage: projection = matrix(ZZ,[[1,0,0],[0,1,0]])
sage: projection
[1 0 0]
[0 1 0]
sage: cone3d = Cone([(1,0,0),(0,1,0)])
sage: cone2d = Cone([ projection*r for r in cone3d.rays() ])
sage: cone2d.rays()
(N(0, 1), N(1, 0))
```

If you use the same matrix in `FanMorphism`, you get an unexpected result:

```
sage: FanMorphism( projection, Fan([cone3d]), Fan([cone2d]) )
Fan morphism defined by the matrix
[1 0]
[0 0]
[1 0]
Domain fan: Rational polyhedral fan in 3-d lattice N
Codomain fan: Rational polyhedral fan in 2-d lattice N
```

Sharp eyes reveal that the matrix is not the one I wanted; I understand that Sage expects a left matrix action.  But having gotten a matrix of the wrong shape, no error is produced. Only a nonsensical output? Expected behavior would be an error, stating that the matrix dimensions do not match.

For reference, the correct way to construct the morphism is with the transposed matrix.

```
sage: FanMorphism( projection.transpose(), Fan([cone3d]), Fan([cone2d]) )
Fan morphism defined by the matrix
[1 0]
[0 1]
[0 0]
Domain fan: Rational polyhedral fan in 3-d lattice N
Codomain fan: Rational polyhedral fan in 2-d lattice N
```



---

Comment by novoselt created at 2011-02-17 15:43:08

Changing priority from major to critical.


---

Comment by novoselt created at 2011-02-17 15:43:08

Changing type from PLEASE CHANGE to defect.


---

Comment by novoselt created at 2011-02-17 15:43:08

Changing assignee from AlexGhitza to jason, was.


---

Comment by novoselt created at 2011-02-17 15:43:08

I have completely replaced the original Volker's description since the problem is unrelated to fan morphisms themselves.

Also I think that this is an extremely dangerous bug and will take the liberty to elevate its priority...


---

Comment by novoselt created at 2011-02-17 15:43:08

Changing component from algebraic geometry to linear algebra.


---

Comment by jason created at 2011-02-17 16:00:43

So it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:


```
sage: M
Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
sage: M([[1,2,3],[4,5,6]])
[1 2]
[3 4]
[5 6]
```


So I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?


---

Comment by jason created at 2011-02-17 16:05:04

Around line 361 in `matrix/matrix_space.py`, we see:


```
        if isinstance(entries, (list, tuple)) and len(entries) > 0 and \
           sage.modules.free_module_element.is_FreeModuleElement(entries[0]):
            #Try to determine whether or not the entries should
            #be rows or columns
            if rows is None:
                #If the matrix is square, default to rows
                if self.__ncols == self.__nrows:
                    rows = True
                elif len(entries[0]) == self.__ncols:
                    rows = True
                elif len(entries[0]) == self.__nrows:
                    rows = False
                else:
                    raise ValueError, "incorrect dimensions"
            
            if self.__is_sparse:
                e = {}
                zero = self.base_ring()(0)
                for i in xrange(len(entries)):
                    for j, x in entries[i].iteritems():
                        if x != zero:
                            if rows:
                                e[(i,j)] = x
                            else:
                                e[(j,i)] = x
                entries = e
            else:
                entries = sum([v.list() for v in entries],[])
```


So:

1. I think it tries to be too intelligent about guessing whether you have rows or columns.  That leads to inconsistent behavior when you have code dealing with different matrix spaces with different dimensions.

2. It indeed does flatten the list if all else fails (that's the sum([v.list()... line).  I agree that that looks dangerous as well.


---

Comment by novoselt created at 2011-02-17 16:08:20

Replying to [comment:2 jason]:
> So it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:
> 
> {{{
> sage: M
> Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
> sage: M([[1,2,3],[4,5,6]])
> [1 2]
> [3 4]
> [5 6]
> }}}
> 
> So I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?

Absolutely! I see no reason why such flattening can make sense, so even if there some - I think they should do it explicitly.

I find it a bit confusing that Sage uses right matrix action, so in the description I tend to think that `projection` itself is the matrix of the morphism, not its transpose. I suspect I am not the only one who can fall into this trap: it is accepted as an input, but some other not-very-related matrix is then used in the morphism.


---

Comment by novoselt created at 2011-06-14 16:52:32

Hi Rob, this is the ticket I was talking about!


---

Attachment


---

Comment by novoselt created at 2011-06-16 22:55:57

Changing status from new to needs_review.


---

Comment by novoselt created at 2011-06-16 22:56:13

Changing keywords from "" to "sd31".


---

Comment by novoselt created at 2011-06-16 23:04:53

There are doctest failures that have to be addressed. I suspect that all places that are affected were just kind of wrong. For Nx1 and 1xN matrices nothing too horrible is going on, hopefully there are no other cases.


---

Comment by novoselt created at 2011-06-16 23:04:53

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2011-06-17 00:02:59

Here is the list of offenders:

```
	sage -t -long devel/sage-main/sage/crypto/mq/sr.py # 15 doctests failed
	sage -t -long devel/sage-main/sage/interfaces/sage0.py # 2 doctests failed
	sage -t -long devel/sage-main/sage/crypto/mq/mpolynomialsystem.py # 50 doctests failed
	sage -t -long devel/sage-main/sage/geometry/fan_morphism.py # 4 doctests failed
	sage -t -long devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py # 33 doctests failed
	sage -t -long devel/sage-main/sage/categories/map.pyx # 16 doctests failed
	sage -t -long devel/sage-main/sage/interfaces/magma.py # 2 doctests failed
	sage -t -long devel/sage-main/sage/modules/matrix_morphism.py # 9 doctests failed
```


IMHO, all these files are full of bugs!


---

Comment by novoselt created at 2011-06-17 00:34:48

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2011-06-17 00:34:48

OK, it turned out to be not as scary as it seemed to me originally. Most of the errors were due to forgetting that matrices act from the right. In crypto I have added explicit conversion of matrices to lists since it seems that they wanted it. I don't understand that code to make sure that this is indeed correct, but at the very least I didn't introduce a new bug ;-)


---

Comment by novoselt created at 2011-07-06 00:15:15

Patches should apply fine on top of sage-4.7.1.alpha4, as #11200 (and other patches modifying fan morphisms) was merged.


---

Comment by vbraun created at 2011-08-14 02:58:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2011-08-14 02:58:55

I totally forgot that we haven't merged this ticket yet. Applies fine on Sage-4.7.1.rc2. Positive review.


---

Comment by jdemeyer created at 2011-08-17 20:34:25

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-08-17 20:34:25

This patch conflicts with #11552.  Since the latter is older, I propose that this patch is rebased to #11552.


---

Comment by novoselt created at 2011-08-17 21:41:13

Changing status from needs_work to needs_review.


---

Attachment

Rebased on top of #11552, needs review.


---

Comment by rbeezer created at 2011-08-17 23:46:06

I think that if a rebase is straightforward (ie there is no real change to code), then it does not need to be reviewed.  I can't tell here, since the rebased patch replaced the old patch.

No matter - I've applied it and done minimal tests.  All looks good.  I'm running all tests right now and then will flip to positive review.

I'm glad this got fixed.  While doing work on free module morphisms I ran into this frequently, where domains and codomains got confused, and so on.  I'm surprised it survived this long.  Thanks Volker and Andrey for the fix!

Rob


---

Comment by novoselt created at 2011-08-18 00:01:43

It was straightforward, your patch added spaces after commas in two lines that I have altered...


---

Comment by rbeezer created at 2011-08-18 00:05:41

Changing status from needs_review to positive_review.


---

Comment by rbeezer created at 2011-08-18 00:05:41

Sorry.  ;-)  Thanks for the rebase.  Passes all tests.

Rob


---

Comment by jdemeyer created at 2011-08-18 22:02:18

Resolution: fixed
