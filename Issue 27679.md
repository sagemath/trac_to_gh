# Issue 27679: using more lazy imports

archive/issues_027679.json:
```json
{
    "body": "CC:  @embray @jdemeyer @kiwifb @tscrim @jhpalmieri @vinklein\n\nin order to avoid importing urllib at startup\n\nIssue created by migration from https://trac.sagemath.org/ticket/27916\n\n",
    "created_at": "2019-06-01T13:00:26Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "using more lazy imports",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27679",
    "user": "https://github.com/fchapoton"
}
```
CC:  @embray @jdemeyer @kiwifb @tscrim @jhpalmieri @vinklein

in order to avoid importing urllib at startup

Issue created by migration from https://trac.sagemath.org/ticket/27916





---

archive/issue_comments_390320.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-06-01T13:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390320",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_390321.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-01T13:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390321",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_390322.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-01T15:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390322",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_390323.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-01T15:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390323",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_390324.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-01T15:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390324",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_390325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-01T18:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_390326.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-01T18:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390326",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_390327.json:
```json
{
    "body": "green bot, please review",
    "created_at": "2019-06-02T06:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390327",
    "user": "https://github.com/fchapoton"
}
```

green bot, please review



---

archive/issue_comments_390328.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-06-02T16:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390328",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_390329.json:
```json
{
    "body": "Please review, somebody ? This cuts off slightly sage startup time.",
    "created_at": "2019-06-05T18:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390329",
    "user": "https://github.com/fchapoton"
}
```

Please review, somebody ? This cuts off slightly sage startup time.



---

archive/issue_comments_390330.json:
```json
{
    "body": "I am a little worried about multiple lazy_import resolutions of the designs stuff. I am wondering if it might be better to lazily import the whole catalog instead. Or do you think I am being paranoid or that we should take the more granular approach?",
    "created_at": "2019-06-05T23:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390330",
    "user": "https://github.com/tscrim"
}
```

I am a little worried about multiple lazy_import resolutions of the designs stuff. I am wondering if it might be better to lazily import the whole catalog instead. Or do you think I am being paranoid or that we should take the more granular approach?



---

archive/issue_comments_390331.json:
```json
{
    "body": "I think that I tried that first, and was forced to the current solution. I suspect that the line\n\n```\nfrom . import design_catalog as designs\n```\n\nmay be preventing the lazy import. Let me try again.",
    "created_at": "2019-06-06T09:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390331",
    "user": "https://github.com/fchapoton"
}
```

I think that I tried that first, and was forced to the current solution. I suspect that the line

```
from . import design_catalog as designs
```

may be preventing the lazy import. Let me try again.



---

archive/issue_comments_390332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-06T09:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_390333.json:
```json
{
    "body": "This seems to work, let us see if the patchbot turns green.",
    "created_at": "2019-06-06T09:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390333",
    "user": "https://github.com/fchapoton"
}
```

This seems to work, let us see if the patchbot turns green.



---

archive/issue_comments_390334.json:
```json
{
    "body": "That seems to cause massive breakage on one of the patchbots. `:/`",
    "created_at": "2019-06-06T10:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390334",
    "user": "https://github.com/tscrim"
}
```

That seems to cause massive breakage on one of the patchbots. `:/`



---

archive/issue_comments_390335.json:
```json
{
    "body": "ok, this was the reason for not doing it. Let me put back my previous branch..\n----\nNew commits:",
    "created_at": "2019-06-06T12:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390335",
    "user": "https://github.com/fchapoton"
}
```

ok, this was the reason for not doing it. Let me put back my previous branch..
----
New commits:



---

archive/issue_comments_390336.json:
```json
{
    "body": "Then so be it.",
    "created_at": "2019-06-07T12:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390336",
    "user": "https://github.com/tscrim"
}
```

Then so be it.



---

archive/issue_comments_390337.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-07T12:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390337",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_390338.json:
```json
{
    "body": "You write that this is all to avoid importing `urllib`.  But is `urllib` a major contributor to start-up time?  `lazy_import` has its own overhead.  Less directly than actually importing one module in many cases.  But is adding *more* `lazy_imports` actually better in this case than avoiding just one import (urllib)?\n\nNote, I'm all for more lazy_import in general so I'm not changing the ticket status, but I don't understand the motivation here or if it's justified.",
    "created_at": "2019-06-07T14:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390338",
    "user": "https://github.com/embray"
}
```

You write that this is all to avoid importing `urllib`.  But is `urllib` a major contributor to start-up time?  `lazy_import` has its own overhead.  Less directly than actually importing one module in many cases.  But is adding *more* `lazy_imports` actually better in this case than avoiding just one import (urllib)?

Note, I'm all for more lazy_import in general so I'm not changing the ticket status, but I don't understand the motivation here or if it's justified.



---

archive/issue_comments_390339.json:
```json
{
    "body": "I used `sage -startuptime` to see what imported modules could be avoided without too much work. I have seen in the list `email` and `http`. Tracking who imported them lead to `urllib`.",
    "created_at": "2019-06-07T14:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390339",
    "user": "https://github.com/fchapoton"
}
```

I used `sage -startuptime` to see what imported modules could be avoided without too much work. I have seen in the list `email` and `http`. Tracking who imported them lead to `urllib`.



---

archive/issue_comments_390340.json:
```json
{
    "body": "Seems like a bit overkill.  Just loading plain `IPython` causes both the `email` and `urllib` modules to be loaded (but not `urllib.requests` which is showing up in `./sage -startuptime`).  Running the Jupyter notebook is almost certain to ultimately use the others.\n\nDoes this definitely shave anything noticeable off the startup time (again, all for it if it does)?",
    "created_at": "2019-06-07T14:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390340",
    "user": "https://github.com/embray"
}
```

Seems like a bit overkill.  Just loading plain `IPython` causes both the `email` and `urllib` modules to be loaded (but not `urllib.requests` which is showing up in `./sage -startuptime`).  Running the Jupyter notebook is almost certain to ultimately use the others.

Does this definitely shave anything noticeable off the startup time (again, all for it if it does)?



---

archive/issue_comments_390341.json:
```json
{
    "body": "Answering my own question, I noticed an improvement with this patch of ~100-150ms over without it, pretty consistently.  In this game every bit counts, so, +1.",
    "created_at": "2019-06-07T17:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390341",
    "user": "https://github.com/embray"
}
```

Answering my own question, I noticed an improvement with this patch of ~100-150ms over without it, pretty consistently.  In this game every bit counts, so, +1.



---

archive/issue_comments_390342.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-27T20:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390342",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_025682.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-06-27T20:13:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27679#event-25682"
}
```



---

archive/issue_comments_390343.json:
```json
{
    "body": "Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.",
    "created_at": "2019-07-03T11:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27679",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27679#issuecomment-390343",
    "user": "https://github.com/embray"
}
```

Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.
