# Issue 29841: Check for duplicate hyperplanes in arrangements over any base ring

archive/issues_029841.json:
```json
{
    "body": "CC:  @jplab\n\nKeywords: HyperplaneArrangements\n\nA hyperplane arrangement is supposed to be checked for duplicate hyperplanes.\nThis works well in `QQ`:\n\n\n```\nsage: H1.<x,y> = HyperplaneArrangements(base_ring=QQ)\nsage: A = H1([1,1,0],[2,2,0], warn_duplicates=True)\n/usr/local/sagemath/dev/local/lib/python3.7/site-packages/sage/geometry/hyperplane_arrangement/arrangement.py:3352: UserWarning: Input contained 2 hyperplanes, but only 1 are distinct.\n  warn('Input contained {0} hyperplanes, but only {1} are distinct.'.format(n, len(hyperplanes)))\nsage: A\nArrangement <x + 1>\n\nsage: A.n_regions()\n2\n```\n\n\nIn other base rings, this check can fail, resulting in false statements about the arrangement:\n\n\n```\nsage: R = QQ[sqrt(2)]\nsage: H2.<x,y> = HyperplaneArrangements(base_ring=R)\nsage: B = H2([1,1,0],[2,2,0], warn_duplicates=True)\nsage: B\nArrangement <x + 1 | 2*x + 2>\n\nsage: B.n_regions()\n3\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30078\n\n",
    "created_at": "2020-07-06T13:51:08Z",
    "labels": [
        "geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Check for duplicate hyperplanes in arrangements over any base ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29841",
    "user": "nailuj"
}
```
CC:  @jplab

Keywords: HyperplaneArrangements

A hyperplane arrangement is supposed to be checked for duplicate hyperplanes.
This works well in `QQ`:


```
sage: H1.<x,y> = HyperplaneArrangements(base_ring=QQ)
sage: A = H1([1,1,0],[2,2,0], warn_duplicates=True)
/usr/local/sagemath/dev/local/lib/python3.7/site-packages/sage/geometry/hyperplane_arrangement/arrangement.py:3352: UserWarning: Input contained 2 hyperplanes, but only 1 are distinct.
  warn('Input contained {0} hyperplanes, but only {1} are distinct.'.format(n, len(hyperplanes)))
sage: A
Arrangement <x + 1>

sage: A.n_regions()
2
```


In other base rings, this check can fail, resulting in false statements about the arrangement:


```
sage: R = QQ[sqrt(2)]
sage: H2.<x,y> = HyperplaneArrangements(base_ring=R)
sage: B = H2([1,1,0],[2,2,0], warn_duplicates=True)
sage: B
Arrangement <x + 1 | 2*x + 2>

sage: B.n_regions()
3
```


Issue created by migration from https://trac.sagemath.org/ticket/30078





---

archive/issue_comments_423886.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-07-06T13:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423886",
    "user": "nailuj"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_423887.json:
```json
{
    "body": "The error can be tracked down to the `primitive` method for hyperplanes:\nIt is supposed to rescale linear multiples of hyperplane directions to a canonical \"primitive\" one.\nThis is currently not properly implied for every `base_ring`, as it uses `gcd` and `lcm` which for some base rings are just one regardless of the arguments.\n\nFurthermore, the method currently uses `x.denom()` and `x.numer()` instead of `x.denominator()` and `x.numerator()`, two aliases which are only defined for `QQ`.\n\nOne solution would be to normalize the hyperplane equations instead of working with `gcd` and `lcm`. But this gives \"ugly\" equations, contrary to what the `primitive` method is meant to provide.",
    "created_at": "2020-07-06T13:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423887",
    "user": "nailuj"
}
```

The error can be tracked down to the `primitive` method for hyperplanes:
It is supposed to rescale linear multiples of hyperplane directions to a canonical "primitive" one.
This is currently not properly implied for every `base_ring`, as it uses `gcd` and `lcm` which for some base rings are just one regardless of the arguments.

Furthermore, the method currently uses `x.denom()` and `x.numer()` instead of `x.denominator()` and `x.numerator()`, two aliases which are only defined for `QQ`.

One solution would be to normalize the hyperplane equations instead of working with `gcd` and `lcm`. But this gives "ugly" equations, contrary to what the `primitive` method is meant to provide.



---

archive/issue_comments_423888.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-06T19:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423888",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_423889.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423889",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_423890.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423890",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_423891.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423891",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_423892.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-16T17:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423892",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423893.json:
```json
{
    "body": "I kept the existing procedure of `primitive()` for `QQ` (using `numerator`, `denominator`, `gcd` and `lcm`) and introduced a new one for other base rings: The linear expression is scaled such that the first nonzero entry of the normal vector is one or negative one (as before, depending on the original sign and whether the option `signed` is set).\n\nThis seems to be compatible with all examples provided in the classes concerned, pass all the existing doctests in the hyperplane_arrangements folder and solve the problem of this ticket. It should also solve ticket #30749. I included suitable tests in the code.\n\nNote however that this does change the coefficients by which hyperplanes are stored in an arrangement not based on `QQ`. This could break user code whenever it relies on a specific scaling of the linear expression. I would argue that fixing the mathematically incorrect statements yielded by the current implementation outweighs this inconvenience.",
    "created_at": "2022-03-16T17:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423893",
    "user": "nailuj"
}
```

I kept the existing procedure of `primitive()` for `QQ` (using `numerator`, `denominator`, `gcd` and `lcm`) and introduced a new one for other base rings: The linear expression is scaled such that the first nonzero entry of the normal vector is one or negative one (as before, depending on the original sign and whether the option `signed` is set).

This seems to be compatible with all examples provided in the classes concerned, pass all the existing doctests in the hyperplane_arrangements folder and solve the problem of this ticket. It should also solve ticket #30749. I included suitable tests in the code.

Note however that this does change the coefficients by which hyperplanes are stored in an arrangement not based on `QQ`. This could break user code whenever it relies on a specific scaling of the linear expression. I would argue that fixing the mathematically incorrect statements yielded by the current implementation outweighs this inconvenience.



---

archive/issue_comments_423894.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-03-16T17:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423894",
    "user": "nailuj"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_423895.json:
```json
{
    "body": "\n```\n+        from sage.rings.all import QQ\n```\n\nPlease use a more specific import, see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies",
    "created_at": "2022-03-17T16:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423895",
    "user": "@mkoeppe"
}
```


```
+        from sage.rings.all import QQ
```

Please use a more specific import, see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies



---

archive/issue_comments_423896.json:
```json
{
    "body": "Likewise here:\n\n```\n+            from sage.arith.all import lcm, gcd\n```\n",
    "created_at": "2022-03-17T16:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423896",
    "user": "@mkoeppe"
}
```

Likewise here:

```
+            from sage.arith.all import lcm, gcd
```




---

archive/issue_comments_423897.json:
```json
{
    "body": "Also, it would be good if you could rewrite these doctests so that they do not go through `SR`.\n\n```\n+        Check that :trac:`30078` is fixed::\n+\n+            sage: R = QQ[sqrt(2)]\n```\n",
    "created_at": "2022-03-17T16:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423897",
    "user": "@mkoeppe"
}
```

Also, it would be good if you could rewrite these doctests so that they do not go through `SR`.

```
+        Check that :trac:`30078` is fixed::
+
+            sage: R = QQ[sqrt(2)]
```




---

archive/issue_comments_423898.json:
```json
{
    "body": "(This is for modularization purposes, see #32432)",
    "created_at": "2022-03-17T16:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423898",
    "user": "@mkoeppe"
}
```

(This is for modularization purposes, see #32432)



---

archive/issue_comments_423899.json:
```json
{
    "body": "Also the list brackets can be omitted here:\n\n```\n+            d = lcm([x.denominator() for x in coeffs])\n+            n = gcd([x.numerator() for x in coeffs])\n```\n",
    "created_at": "2022-03-17T16:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423899",
    "user": "@mkoeppe"
}
```

Also the list brackets can be omitted here:

```
+            d = lcm([x.denominator() for x in coeffs])
+            n = gcd([x.numerator() for x in coeffs])
```




---

archive/issue_comments_423900.json:
```json
{
    "body": "Also `./sage -tox -e pycodestyle src/sage/geometry/hyperplane_arrangement/hyperplane.py` complains about style, some of the warnings are on the code changed in the ticket",
    "created_at": "2022-03-17T16:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423900",
    "user": "@mkoeppe"
}
```

Also `./sage -tox -e pycodestyle src/sage/geometry/hyperplane_arrangement/hyperplane.py` complains about style, some of the warnings are on the code changed in the ticket



---

archive/issue_comments_423901.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-03-17T16:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423901",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_423902.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-18T19:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423902",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423903.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-18T19:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423903",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423904.json:
```json
{
    "body": "Thanks for the helpful suggestions!\n\n\nReplying to [comment:12 mkoeppe]:\n> Also, it would be good if you could rewrite these doctests so that they do not go through `SR`.\n> {{{\n> +        Check that :trac:`30078` is fixed::\n> +\n> +            sage: R = QQ[sqrt(2)]\n> }}}\n\nI am not really sure about what goes through `SR` and what doesn\u2019t. For the tests to be meaningful, the base ring would have to contain some non-rationals. I replaced `QQ[sqrt(2)]` by `AA`. Is that fine?",
    "created_at": "2022-03-18T19:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423904",
    "user": "nailuj"
}
```

Thanks for the helpful suggestions!


Replying to [comment:12 mkoeppe]:
> Also, it would be good if you could rewrite these doctests so that they do not go through `SR`.
> {{{
> +        Check that :trac:`30078` is fixed::
> +
> +            sage: R = QQ[sqrt(2)]
> }}}

I am not really sure about what goes through `SR` and what doesn’t. For the tests to be meaningful, the base ring would have to contain some non-rationals. I replaced `QQ[sqrt(2)]` by `AA`. Is that fine?



---

archive/issue_comments_423905.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-18T19:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423905",
    "user": "nailuj"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423906.json:
```json
{
    "body": "\n```\nsage: ((1+sqrt(5))/2).parent()\nSymbolic Ring\nsage: ((1+AA(5).sqrt())/2).parent()\nAlgebraic Real Field\n```\n",
    "created_at": "2022-03-18T20:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423906",
    "user": "@mkoeppe"
}
```


```
sage: ((1+sqrt(5))/2).parent()
Symbolic Ring
sage: ((1+AA(5).sqrt())/2).parent()
Algebraic Real Field
```




---

archive/issue_comments_423907.json:
```json
{
    "body": "and instead of `QQ[sqrt(2)]` you can write \n\n```\nsage: QuadraticField(2)\nNumber Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?\n```\n",
    "created_at": "2022-03-18T20:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423907",
    "user": "@mkoeppe"
}
```

and instead of `QQ[sqrt(2)]` you can write 

```
sage: QuadraticField(2)
Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?
```




---

archive/issue_comments_423908.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-18T20:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423908",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423909.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> and instead of `QQ[sqrt(2)]` you can write \n> {{{\n> sage: QuadraticField(2)\n> Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?\n> }}}\n\nThanks, I didn\u2019t know that!",
    "created_at": "2022-03-18T20:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423909",
    "user": "nailuj"
}
```

Replying to [comment:21 mkoeppe]:
> and instead of `QQ[sqrt(2)]` you can write 
> {{{
> sage: QuadraticField(2)
> Number Field in a with defining polynomial x^2 - 2 with a = 1.414213562373095?
> }}}

Thanks, I didn’t know that!



---

archive/issue_comments_423910.json:
```json
{
    "body": "\n```\n+            sage: R = QuadraticField(2)\n+            sage: H.<x,y> = HyperplaneArrangements(base_ring=R)\n+            sage: B = H([1,1,0], [2,2,0], [sqrt(2),sqrt(2),0])\n```\n\nMake that `R.<sqrt2> = QuadraticField(2)` and use `sqrt2` instead of `sqrt(2)`",
    "created_at": "2022-03-18T20:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423910",
    "user": "@mkoeppe"
}
```


```
+            sage: R = QuadraticField(2)
+            sage: H.<x,y> = HyperplaneArrangements(base_ring=R)
+            sage: B = H([1,1,0], [2,2,0], [sqrt(2),sqrt(2),0])
```

Make that `R.<sqrt2> = QuadraticField(2)` and use `sqrt2` instead of `sqrt(2)`



---

archive/issue_comments_423911.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-18T20:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423911",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423912.json:
```json
{
    "body": "Replying to [comment:24 mkoeppe]:\n> {{{\n> +            sage: R = QuadraticField(2)\n> +            sage: H.<x,y> = HyperplaneArrangements(base_ring=R)\n> +            sage: B = H([1,1,0], [2,2,0], [sqrt(2),sqrt(2),0])\n> }}}\n> Make that `R.<sqrt2> = QuadraticField(2)` and use `sqrt2` instead of `sqrt(2)`\n\nOh, I see. When sqrt(2) is used, it will initially be a symbolic expression and turned into an element of `R` later, which can be avoided by explicitly using the element of the quadratic field, correct?",
    "created_at": "2022-03-18T20:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423912",
    "user": "nailuj"
}
```

Replying to [comment:24 mkoeppe]:
> {{{
> +            sage: R = QuadraticField(2)
> +            sage: H.<x,y> = HyperplaneArrangements(base_ring=R)
> +            sage: B = H([1,1,0], [2,2,0], [sqrt(2),sqrt(2),0])
> }}}
> Make that `R.<sqrt2> = QuadraticField(2)` and use `sqrt2` instead of `sqrt(2)`

Oh, I see. When sqrt(2) is used, it will initially be a symbolic expression and turned into an element of `R` later, which can be avoided by explicitly using the element of the quadratic field, correct?



---

archive/issue_comments_423913.json:
```json
{
    "body": "That's right.",
    "created_at": "2022-03-18T20:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423913",
    "user": "@mkoeppe"
}
```

That's right.



---

archive/issue_comments_423914.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-18T22:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423914",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423915.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-21T23:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29841",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29841#issuecomment-423915",
    "user": "@vbraun"
}
```

Resolution: fixed
