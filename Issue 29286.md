# Issue 29286: Sample points exponentially when plotting log-scale graphs

archive/issues_029286.json:
```json
{
    "body": "This patch modifies src/plot/plot.py so that when scale='semilogx' or 'loglog' is specified generate_plot_points() will sample exponentially.  This decreases the number of points necessary for an accurate plot (and also increases the chance that the default number of points will produce an acceptable plot).\n\nDoctests pass on Debian x86-64\n\nSee: https://groups.google.com/d/msgid/sage-devel/7164f726-788d-4718-8ddc-90eba8e858ce%40googlegroups.com?utm_medium=email&utm_source=footer\n\nIssue created by migration from https://trac.sagemath.org/ticket/29523\n\n",
    "created_at": "2020-04-17T17:35:08Z",
    "labels": [
        "component: graphics",
        "trivial"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Sample points exponentially when plotting log-scale graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29286",
    "user": "https://github.com/rbmj"
}
```
This patch modifies src/plot/plot.py so that when scale='semilogx' or 'loglog' is specified generate_plot_points() will sample exponentially.  This decreases the number of points necessary for an accurate plot (and also increases the chance that the default number of points will produce an acceptable plot).

Doctests pass on Debian x86-64

See: https://groups.google.com/d/msgid/sage-devel/7164f726-788d-4718-8ddc-90eba8e858ce%40googlegroups.com?utm_medium=email&utm_source=footer

Issue created by migration from https://trac.sagemath.org/ticket/29523





---

archive/issue_comments_414667.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-17T17:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414667",
    "user": "https://github.com/rbmj"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_414668.json:
```json
{
    "body": "Attachment [0001-Add-logarithmic-point-selection-to-generate_plot_poi.patch](tarball://root/attachments/some-uuid/ticket29523/0001-Add-logarithmic-point-selection-to-generate_plot_poi.patch) by @rbmj created at 2020-04-17 17:40:37",
    "created_at": "2020-04-17T17:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414668",
    "user": "https://github.com/rbmj"
}
```

Attachment [0001-Add-logarithmic-point-selection-to-generate_plot_poi.patch](tarball://root/attachments/some-uuid/ticket29523/0001-Add-logarithmic-point-selection-to-generate_plot_poi.patch) by @rbmj created at 2020-04-17 17:40:37



---

archive/issue_comments_414669.json:
```json
{
    "body": "Possibly related: #15320.\n----\nNew commits:",
    "created_at": "2020-04-18T21:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414669",
    "user": "https://github.com/slel"
}
```

Possibly related: #15320.
----
New commits:



---

archive/issue_comments_414670.json:
```json
{
    "body": "Thanks for working on this issue. I have few comments after reading the branch.\n\n1. I do not agree to change the inside of `generate_plot_points`. I believe it would be cleaner to do the change of variables:\n\n```\n        f = lambda x: f_actual(exp(x))\n        xrange = (log(xrange[0]), log(xrange[1]))\n```\n\nbefore the call to `generate_plot_point` and then do `generate_plot_point(f,xrange,...)` on the new `f` and `xrange`. Also, the part\n\n```\n    if exp_dist:\n        for i in range(len(data)):\n            data[i] = (exp(data[i][0]), data[i][1])\n```\n\nwould go outside of the function but after the call to that function. \n\n2. Also, I would use the following for the name of new variables to be more explicit on what they are:\n\n```\n        f_exp = lambda x: f_actual(exp(x))\n        log_xrange = (log(xrange[0]), log(xrange[1]))\n```\n\n\n3. I suggest to use `is_log_scale` or `log_scale` for the name of the boolean variable and avoid the `if` to define it:\n\n```diff\n-    #check to see if this is a log scale graph on the x axis\n-    exp_points = False\n-    if ('scale' in options.keys() and not parametric and\n-            (options['scale'] == 'loglog' or options['scale'] == 'semilogx')):\n-        exp_points = True\n+    #check to see if this is a log scale graph on the x axis\n+    log_scale = ('scale' in options.keys() and\n+                  not parametric and\n+                  (options['scale'] == 'loglog' or\n+                   options['scale'] == 'semilogx'))\n```\n\n\n4. I would avoid `exp_dist=exp_points` by using the same name for the variable as for the keyword.\n\n5. You need to add some new doctest showing that the bug is fixed (maybe with a picture). You can look at recent branch from Travis to see how he did to include picture in the doc here: #25796",
    "created_at": "2020-04-24T12:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414670",
    "user": "https://github.com/seblabbe"
}
```

Thanks for working on this issue. I have few comments after reading the branch.

1. I do not agree to change the inside of `generate_plot_points`. I believe it would be cleaner to do the change of variables:

```
        f = lambda x: f_actual(exp(x))
        xrange = (log(xrange[0]), log(xrange[1]))
```

before the call to `generate_plot_point` and then do `generate_plot_point(f,xrange,...)` on the new `f` and `xrange`. Also, the part

```
    if exp_dist:
        for i in range(len(data)):
            data[i] = (exp(data[i][0]), data[i][1])
```

would go outside of the function but after the call to that function. 

2. Also, I would use the following for the name of new variables to be more explicit on what they are:

```
        f_exp = lambda x: f_actual(exp(x))
        log_xrange = (log(xrange[0]), log(xrange[1]))
```


3. I suggest to use `is_log_scale` or `log_scale` for the name of the boolean variable and avoid the `if` to define it:

```diff
-    #check to see if this is a log scale graph on the x axis
-    exp_points = False
-    if ('scale' in options.keys() and not parametric and
-            (options['scale'] == 'loglog' or options['scale'] == 'semilogx')):
-        exp_points = True
+    #check to see if this is a log scale graph on the x axis
+    log_scale = ('scale' in options.keys() and
+                  not parametric and
+                  (options['scale'] == 'loglog' or
+                   options['scale'] == 'semilogx'))
```


4. I would avoid `exp_dist=exp_points` by using the same name for the variable as for the keyword.

5. You need to add some new doctest showing that the bug is fixed (maybe with a picture). You can look at recent branch from Travis to see how he did to include picture in the doc here: #25796



---

archive/issue_comments_414671.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-24T12:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414671",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_414672.json:
```json
{
    "body": "The Author field is missing (necessary for the release manager to merge the ticket).",
    "created_at": "2020-04-24T12:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414672",
    "user": "https://github.com/seblabbe"
}
```

The Author field is missing (necessary for the release manager to merge the ticket).



---

archive/issue_comments_414673.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-03T16:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414673",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414674.json:
```json
{
    "body": "Incorporated your suggestions - tests pass and docs build.\n\nAdded one doctest to plot_semilogx() which does not render properly on previous versions of sage - hopefully that is sufficient.  A decent amount of the diff in the last commit is just me reverting my previous changes.\n\nApologize for the delay in updating this!",
    "created_at": "2020-05-03T16:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414674",
    "user": "https://github.com/rbmj"
}
```

Incorporated your suggestions - tests pass and docs build.

Added one doctest to plot_semilogx() which does not render properly on previous versions of sage - hopefully that is sufficient.  A decent amount of the diff in the last commit is just me reverting my previous changes.

Apologize for the delay in updating this!



---

archive/issue_comments_414675.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-03T16:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414675",
    "user": "https://github.com/rbmj"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_414676.json:
```json
{
    "body": "Thanks for the changes. No problem for the delay. Same for me, apologize for my delay in answering.\n\nSo, I looked at the code. There were still some modifications I wanted to be made. I allowed myself to make a commit on top of yours.\n----\nNew commits:",
    "created_at": "2020-05-07T08:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414676",
    "user": "https://github.com/seblabbe"
}
```

Thanks for the changes. No problem for the delay. Same for me, apologize for my delay in answering.

So, I looked at the code. There were still some modifications I wanted to be made. I allowed myself to make a commit on top of yours.
----
New commits:



---

archive/issue_comments_414677.json:
```json
{
    "body": "I confirm that #15320 is fixed by this ticket.",
    "created_at": "2020-05-07T08:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414677",
    "user": "https://github.com/seblabbe"
}
```

I confirm that #15320 is fixed by this ticket.



---

archive/issue_comments_414678.json:
```json
{
    "body": "Documentation builds fine on my side. Issues are fixed. Doctests pass in `src/sage/plot` directory. If you agree with my changes, I let you change the status of ticket to positive review.",
    "created_at": "2020-05-07T09:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414678",
    "user": "https://github.com/seblabbe"
}
```

Documentation builds fine on my side. Issues are fixed. Doctests pass in `src/sage/plot` directory. If you agree with my changes, I let you change the status of ticket to positive review.



---

archive/issue_comments_414679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-07T12:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414679",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414680.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-07T14:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414680",
    "user": "https://github.com/rbmj"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_414681.json:
```json
{
    "body": "Looks good to me, thanks for the review!",
    "created_at": "2020-05-07T14:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414681",
    "user": "https://github.com/rbmj"
}
```

Looks good to me, thanks for the review!



---

archive/issue_comments_414682.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2020-05-08T14:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414682",
    "user": "https://github.com/kcrisman"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_414683.json:
```json
{
    "body": "What about the related `show` command on [graphics](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/graphics.html)?  E.g. \n\n```\nsage: G = plot(exp, 1, 10)\nsage: G.show(scale='semiology')\n```\n\n\nDoes this problem show up there (because if I recall correctly, the `plot` object already has the points computed before `show` is called) after this ticket is applied?\n\n* If not, ignore this and set back to positive review.\n* If so, I see two options, either of which is fine:\n  * Open a new ticket for that (default)\n  * Put this ticket back to needs work and fix it (if there is some pretty easy fix)\n\nThanks so much for fixing this.  We spent a lot of time on edge cases like this back in the day, but there were so many ... and then one has other duties.  It's so great to have lots of people still working on not just cutting-edge stuff, but more generally useful things like this.",
    "created_at": "2020-05-08T14:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414683",
    "user": "https://github.com/kcrisman"
}
```

What about the related `show` command on [graphics](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/graphics.html)?  E.g. 

```
sage: G = plot(exp, 1, 10)
sage: G.show(scale='semiology')
```


Does this problem show up there (because if I recall correctly, the `plot` object already has the points computed before `show` is called) after this ticket is applied?

* If not, ignore this and set back to positive review.
* If so, I see two options, either of which is fine:
  * Open a new ticket for that (default)
  * Put this ticket back to needs work and fix it (if there is some pretty easy fix)

Thanks so much for fixing this.  We spent a lot of time on edge cases like this back in the day, but there were so many ... and then one has other duties.  It's so great to have lots of people still working on not just cutting-edge stuff, but more generally useful things like this.



---

archive/issue_comments_414684.json:
```json
{
    "body": "This patch will not work when the scale is passed to `show` rather than `plot`.  All `plot` does is create a `line` from the points it generates and add that to the `graphics` object.\n\nThe only way I could see to work as expected in that case would be to make `plot` lazy and not generate any points until the actual graphics object gets rendered.  One would need to capture all of the arguments (deep copy?) into an object which would then implement `_render_on_subplot` by calling `_plot`, then calling `_render_on_subplot` to the resulting line.\n\nI'm not sure how much work that would be to do - I'm a C++ person mostly so I'm not as familiar with the python memory model (incidentally one of the reasons S\u00e9bastien had to fix my non-pythonic code; I'm not used to the scoping flexibility!).  I'm not sure if there's a way for the user to mess with variables in a way that is observable to someone who has taken a copy of the expression.\n\nThe other option (which I don't like) is to add a note in the documentation saying there's a gotcha, of course.  I don't know if anyone for whatever reason would rely on the old behavior, but then passing the scale to `show` only could be a backdoor way to re-enable it.",
    "created_at": "2020-05-08T15:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414684",
    "user": "https://github.com/rbmj"
}
```

This patch will not work when the scale is passed to `show` rather than `plot`.  All `plot` does is create a `line` from the points it generates and add that to the `graphics` object.

The only way I could see to work as expected in that case would be to make `plot` lazy and not generate any points until the actual graphics object gets rendered.  One would need to capture all of the arguments (deep copy?) into an object which would then implement `_render_on_subplot` by calling `_plot`, then calling `_render_on_subplot` to the resulting line.

I'm not sure how much work that would be to do - I'm a C++ person mostly so I'm not as familiar with the python memory model (incidentally one of the reasons Sébastien had to fix my non-pythonic code; I'm not used to the scoping flexibility!).  I'm not sure if there's a way for the user to mess with variables in a way that is observable to someone who has taken a copy of the expression.

The other option (which I don't like) is to add a note in the documentation saying there's a gotcha, of course.  I don't know if anyone for whatever reason would rely on the old behavior, but then passing the scale to `show` only could be a backdoor way to re-enable it.



---

archive/issue_comments_414685.json:
```json
{
    "body": "That is what I figured.  Could you open a new ticket for at least documenting this problem for that case?  One could then point people to the need to use the option in the `plot` command rather than `show` for situations of this type.  I think that is better than trying to do the lazy plot, it is too likely to give us new bugs.",
    "created_at": "2020-05-08T16:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414685",
    "user": "https://github.com/kcrisman"
}
```

That is what I figured.  Could you open a new ticket for at least documenting this problem for that case?  One could then point people to the need to use the option in the `plot` command rather than `show` for situations of this type.  I think that is better than trying to do the lazy plot, it is too likely to give us new bugs.



---

archive/issue_comments_414686.json:
```json
{
    "body": "Created #29667",
    "created_at": "2020-05-08T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414686",
    "user": "https://github.com/rbmj"
}
```

Created #29667



---

archive/issue_comments_414687.json:
```json
{
    "body": "Great, thanks.",
    "created_at": "2020-05-08T20:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414687",
    "user": "https://github.com/kcrisman"
}
```

Great, thanks.



---

archive/issue_comments_414688.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2020-05-08T20:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414688",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_414689.json:
```json
{
    "body": "I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.\n\nShould we deprecate the scale in the show?",
    "created_at": "2020-05-08T21:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414689",
    "user": "https://github.com/seblabbe"
}
```

I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.

Should we deprecate the scale in the show?



---

archive/issue_comments_414690.json:
```json
{
    "body": "> I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.\n\nIdeally.  But that is a big big job.  Ideally it wouldn't be so tied to matplotlib either, as William said long ago.  But I think for most people they wouldn't think it is worth the bother.\n\n> Should we deprecate the scale in the show?\n\nNo.  I think that people may often want to show the same plot in several different scales, and that is the beauty of separating the semantics of the graphics object and how it is shown.  If anything, it would be the other way around - but unfortunately in this case the problem here arises.",
    "created_at": "2020-05-08T22:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414690",
    "user": "https://github.com/kcrisman"
}
```

> I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.

Ideally.  But that is a big big job.  Ideally it wouldn't be so tied to matplotlib either, as William said long ago.  But I think for most people they wouldn't think it is worth the bother.

> Should we deprecate the scale in the show?

No.  I think that people may often want to show the same plot in several different scales, and that is the beauty of separating the semantics of the graphics object and how it is shown.  If anything, it would be the other way around - but unfortunately in this case the problem here arises.



---

archive/issue_comments_414691.json:
```json
{
    "body": "Maybe this can make it into Sage 9.1. Otherwise it will be for Sage 9.2.",
    "created_at": "2020-05-11T00:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414691",
    "user": "https://github.com/slel"
}
```

Maybe this can make it into Sage 9.1. Otherwise it will be for Sage 9.2.



---

archive/issue_comments_414692.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-03T22:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29286#issuecomment-414692",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
