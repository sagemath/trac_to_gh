# Issue 29286: Sample points exponentially when plotting log-scale graphs

Issue created by migration from https://trac.sagemath.org/ticket/29523

Original creator: @rbmj

Original creation time: 2020-04-17 17:35:08

This patch modifies src/plot/plot.py so that when scale='semilogx' or 'loglog' is specified generate_plot_points() will sample exponentially.  This decreases the number of points necessary for an accurate plot (and also increases the chance that the default number of points will produce an acceptable plot).

Doctests pass on Debian x86-64

See: https://groups.google.com/d/msgid/sage-devel/7164f726-788d-4718-8ddc-90eba8e858ce%40googlegroups.com?utm_medium=email&utm_source=footer


---

Comment by @rbmj created at 2020-04-17 17:40:37

Changing status from new to needs_review.


---

Attachment


---

Comment by slelievre created at 2020-04-18 21:10:20

Possibly related: #15320.
----
New commits:


---

Comment by slabbe created at 2020-04-24 12:05:12

Thanks for working on this issue. I have few comments after reading the branch.

1. I do not agree to change the inside of `generate_plot_points`. I believe it would be cleaner to do the change of variables:

```
        f = lambda x: f_actual(exp(x))
        xrange = (log(xrange[0]), log(xrange[1]))
```

before the call to `generate_plot_point` and then do `generate_plot_point(f,xrange,...)` on the new `f` and `xrange`. Also, the part

```
    if exp_dist:
        for i in range(len(data)):
            data[i] = (exp(data[i][0]), data[i][1])
```

would go outside of the function but after the call to that function. 

2. Also, I would use the following for the name of new variables to be more explicit on what they are:

```
        f_exp = lambda x: f_actual(exp(x))
        log_xrange = (log(xrange[0]), log(xrange[1]))
```


3. I suggest to use `is_log_scale` or `log_scale` for the name of the boolean variable and avoid the `if` to define it:

```diff
-    #check to see if this is a log scale graph on the x axis
-    exp_points = False
-    if ('scale' in options.keys() and not parametric and
-            (options['scale'] == 'loglog' or options['scale'] == 'semilogx')):
-        exp_points = True
+    #check to see if this is a log scale graph on the x axis
+    log_scale = ('scale' in options.keys() and
+                  not parametric and
+                  (options['scale'] == 'loglog' or
+                   options['scale'] == 'semilogx'))
```


4. I would avoid `exp_dist=exp_points` by using the same name for the variable as for the keyword.

5. You need to add some new doctest showing that the bug is fixed (maybe with a picture). You can look at recent branch from Travis to see how he did to include picture in the doc here: #25796


---

Comment by slabbe created at 2020-04-24 12:05:24

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-04-24 12:08:16

The Author field is missing (necessary for the release manager to merge the ticket).


---

Comment by git created at 2020-05-03 16:12:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rbmj created at 2020-05-03 16:18:24

Incorporated your suggestions - tests pass and docs build.

Added one doctest to plot_semilogx() which does not render properly on previous versions of sage - hopefully that is sufficient.  A decent amount of the diff in the last commit is just me reverting my previous changes.

Apologize for the delay in updating this!


---

Comment by @rbmj created at 2020-05-03 16:18:24

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-05-07 08:18:30

Thanks for the changes. No problem for the delay. Same for me, apologize for my delay in answering.

So, I looked at the code. There were still some modifications I wanted to be made. I allowed myself to make a commit on top of yours.
----
New commits:


---

Comment by slabbe created at 2020-05-07 08:28:08

I confirm that #15320 is fixed by this ticket.


---

Comment by slabbe created at 2020-05-07 09:44:09

Documentation builds fine on my side. Issues are fixed. Doctests pass in `src/sage/plot` directory. If you agree with my changes, I let you change the status of ticket to positive review.


---

Comment by git created at 2020-05-07 12:10:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rbmj created at 2020-05-07 14:44:02

Changing status from needs_review to positive_review.


---

Comment by @rbmj created at 2020-05-07 14:44:02

Looks good to me, thanks for the review!


---

Comment by kcrisman created at 2020-05-08 14:47:19

Changing status from positive_review to needs_info.


---

Comment by kcrisman created at 2020-05-08 14:47:19

What about the related `show` command on [graphics](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/graphics.html)?  E.g. 

```
sage: G = plot(exp, 1, 10)
sage: G.show(scale='semiology')
```


Does this problem show up there (because if I recall correctly, the `plot` object already has the points computed before `show` is called) after this ticket is applied?

* If not, ignore this and set back to positive review.
* If so, I see two options, either of which is fine:
  * Open a new ticket for that (default)
  * Put this ticket back to needs work and fix it (if there is some pretty easy fix)

Thanks so much for fixing this.  We spent a lot of time on edge cases like this back in the day, but there were so many ... and then one has other duties.  It's so great to have lots of people still working on not just cutting-edge stuff, but more generally useful things like this.


---

Comment by @rbmj created at 2020-05-08 15:27:14

This patch will not work when the scale is passed to `show` rather than `plot`.  All `plot` does is create a `line` from the points it generates and add that to the `graphics` object.

The only way I could see to work as expected in that case would be to make `plot` lazy and not generate any points until the actual graphics object gets rendered.  One would need to capture all of the arguments (deep copy?) into an object which would then implement `_render_on_subplot` by calling `_plot`, then calling `_render_on_subplot` to the resulting line.

I'm not sure how much work that would be to do - I'm a C++ person mostly so I'm not as familiar with the python memory model (incidentally one of the reasons SÃ©bastien had to fix my non-pythonic code; I'm not used to the scoping flexibility!).  I'm not sure if there's a way for the user to mess with variables in a way that is observable to someone who has taken a copy of the expression.

The other option (which I don't like) is to add a note in the documentation saying there's a gotcha, of course.  I don't know if anyone for whatever reason would rely on the old behavior, but then passing the scale to `show` only could be a backdoor way to re-enable it.


---

Comment by kcrisman created at 2020-05-08 16:31:14

That is what I figured.  Could you open a new ticket for at least documenting this problem for that case?  One could then point people to the need to use the option in the `plot` command rather than `show` for situations of this type.  I think that is better than trying to do the lazy plot, it is too likely to give us new bugs.


---

Comment by @rbmj created at 2020-05-08 17:47:59

Created #29667


---

Comment by kcrisman created at 2020-05-08 20:27:40

Great, thanks.


---

Comment by kcrisman created at 2020-05-08 20:27:40

Changing status from needs_info to positive_review.


---

Comment by slabbe created at 2020-05-08 21:05:24

I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.

Should we deprecate the scale in the show?


---

Comment by kcrisman created at 2020-05-08 22:21:48

> I do not like that `_plot` function which is just too long and too complicated and leads to bug of this kind. It would need to be broken up into pieces.

Ideally.  But that is a big big job.  Ideally it wouldn't be so tied to matplotlib either, as William said long ago.  But I think for most people they wouldn't think it is worth the bother.

> Should we deprecate the scale in the show?

No.  I think that people may often want to show the same plot in several different scales, and that is the beauty of separating the semantics of the graphics object and how it is shown.  If anything, it would be the other way around - but unfortunately in this case the problem here arises.


---

Comment by slelievre created at 2020-05-11 00:37:24

Maybe this can make it into Sage 9.1. Otherwise it will be for Sage 9.2.


---

Comment by vbraun created at 2020-06-03 22:28:58

Resolution: fixed
