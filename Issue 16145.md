# Issue 16145: make sage_getsourcelines and sage_getfile consistent

archive/issues_016145.json:
```json
{
    "body": "CC:  simonking nthierry roed\n\nWe presently have:\n\n```\nsage: sage_getsource(hyperbolic_triangle) in open(sage_getfile(hyperbolic_triangle),'r').read()\nFalse\n```\n\nThe problem is that `hyperbolic_triangle` is wrapped and its source is provided by a `_sage_src_lines_()` method, but on the `getfile` front, there is no analogue, so the file isn't found. That means `edit` doesn't work properly.\n\nOne solution is to provide a parallel method `_sage_src_file_()`. Another, which requires more editing, is to change `sage_getsourcelines` to return a triple `([lines],lineno,filename)` instead of `([lines],lineno)` as it does now (it's a little strange to return a line number without the file into which this indexes anyway). Note that `filename` could end up being something that doesn't actually open, because interactively defined classes get funny \"filenames\" that, via the `inspect` linecache, actually can used to index source lines without having a file correspond to them.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16382\n\n",
    "created_at": "2014-05-20T19:45:52Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "make sage_getsourcelines and sage_getfile consistent",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16145",
    "user": "nbruin"
}
```
CC:  simonking nthierry roed

We presently have:

```
sage: sage_getsource(hyperbolic_triangle) in open(sage_getfile(hyperbolic_triangle),'r').read()
False
```

The problem is that `hyperbolic_triangle` is wrapped and its source is provided by a `_sage_src_lines_()` method, but on the `getfile` front, there is no analogue, so the file isn't found. That means `edit` doesn't work properly.

One solution is to provide a parallel method `_sage_src_file_()`. Another, which requires more editing, is to change `sage_getsourcelines` to return a triple `([lines],lineno,filename)` instead of `([lines],lineno)` as it does now (it's a little strange to return a line number without the file into which this indexes anyway). Note that `filename` could end up being something that doesn't actually open, because interactively defined classes get funny "filenames" that, via the `inspect` linecache, actually can used to index source lines without having a file correspond to them.

Issue created by migration from https://trac.sagemath.org/ticket/16382





---

archive/issue_comments_210781.json:
```json
{
    "body": "OK, first try for implementing a `_sage_src_file_` helper protocol. Note that I have made its presence a requirement for now if `_sage_src_lines_` is present, because the other source file heuristics don't have much of a chance if they don't work.",
    "created_at": "2014-05-20T19:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210781",
    "user": "nbruin"
}
```

OK, first try for implementing a `_sage_src_file_` helper protocol. Note that I have made its presence a requirement for now if `_sage_src_lines_` is present, because the other source file heuristics don't have much of a chance if they don't work.



---

archive/issue_comments_210782.json:
```json
{
    "body": "Also, note:\n\n```\nsage: P.<x,y> = QQ[]\nsage: P._sage_src_lines_()\nTypeError: _sage_src_lines() takes no arguments (1 given)\n```\n\nwhich is currently relied on to detect a dynamic class instance. The method in question tries to make a static method, but the subsequent inclusion into a dynamic class dictionary seems to break this (hence, the method binds anyway and the call receives an unexpected `self` argument).\n\nIf one fixes `_sage_src_lines` (by for instance accepting an optional self argument), source retrieval gets broken! So I think the current implementation of `_sage_src_lines` is actually wrong. It should either be removed (and the rest of the infrastructure adapted to detect dynamic classes in a different way--which is possible, because its current desired behaviour is apparently to raise a `TypeError` on instances of dynamic classes, which could be refactored), or it should be implemented to return the correct contents. Of course `_sage_src_file` could then be corrected similarly.\n\nAttempt to show that `_sage_src_lines_` doesn't return something useful:\n\n```\nsage: P._sage_src_lines_\n<bound method JoinCategory.parent_class._sage_src_lines of Multivariate Polynomial Ring in x, y over Rational Field>\nsage: P.__dict__['_sage_src_lines_']\n<staticmethod at 0x3dec9b8>\nsage: P.__dict__['_sage_src_lines_'].__func__()\n(['    class ParentMethods:\\n',\n  '        \"\"\"\\n',\n  '        Put methods for parents here.\\n',\n  '        \"\"\"\\n',\n  '        pass\\n'],\n 1096)\n```\n\nAs you can see:\n- a static method in an instance dictionary binds anyway\n- the source returned is not of the object we're interested in\n\n----\nNew commits:",
    "created_at": "2014-05-20T19:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210782",
    "user": "nbruin"
}
```

Also, note:

```
sage: P.<x,y> = QQ[]
sage: P._sage_src_lines_()
TypeError: _sage_src_lines() takes no arguments (1 given)
```

which is currently relied on to detect a dynamic class instance. The method in question tries to make a static method, but the subsequent inclusion into a dynamic class dictionary seems to break this (hence, the method binds anyway and the call receives an unexpected `self` argument).

If one fixes `_sage_src_lines` (by for instance accepting an optional self argument), source retrieval gets broken! So I think the current implementation of `_sage_src_lines` is actually wrong. It should either be removed (and the rest of the infrastructure adapted to detect dynamic classes in a different way--which is possible, because its current desired behaviour is apparently to raise a `TypeError` on instances of dynamic classes, which could be refactored), or it should be implemented to return the correct contents. Of course `_sage_src_file` could then be corrected similarly.

Attempt to show that `_sage_src_lines_` doesn't return something useful:

```
sage: P._sage_src_lines_
<bound method JoinCategory.parent_class._sage_src_lines of Multivariate Polynomial Ring in x, y over Rational Field>
sage: P.__dict__['_sage_src_lines_']
<staticmethod at 0x3dec9b8>
sage: P.__dict__['_sage_src_lines_'].__func__()
(['    class ParentMethods:\n',
  '        """\n',
  '        Put methods for parents here.\n',
  '        """\n',
  '        pass\n'],
 1096)
```

As you can see:
- a static method in an instance dictionary binds anyway
- the source returned is not of the object we're interested in

----
New commits:



---

archive/issue_comments_210783.json:
```json
{
    "body": "The implementation of `_sage_src_lines` was introduced in #5991, so I'm CC-ing nthierry and roed as author/reviewer of that change. They may be able to comment on how the routine should be implemented and where that routine should be finding its source.",
    "created_at": "2014-05-20T20:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210783",
    "user": "nbruin"
}
```

The implementation of `_sage_src_lines` was introduced in #5991, so I'm CC-ing nthierry and roed as author/reviewer of that change. They may be able to comment on how the routine should be implemented and where that routine should be finding its source.



---

archive/issue_comments_210784.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-23T23:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210784",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210785.json:
```json
{
    "body": "This commit should fix the problem for dynamic classes derived from cdef classes. For those, the `_sage_src_lines_` methods end up in the `__dict__` and they get bound! (probably due to a custom getattr that doesn't distinguish between methods and `staticmethod`). In fact, since the `doccls` value that is available at the time the closure of the relevant method is constructed doesn't have a useful value anyway, this behaviour is even somewhat useful: we can then look up the source on `self.__class__` (which then does have a useful value).",
    "created_at": "2014-05-23T23:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210785",
    "user": "nbruin"
}
```

This commit should fix the problem for dynamic classes derived from cdef classes. For those, the `_sage_src_lines_` methods end up in the `__dict__` and they get bound! (probably due to a custom getattr that doesn't distinguish between methods and `staticmethod`). In fact, since the `doccls` value that is available at the time the closure of the relevant method is constructed doesn't have a useful value anyway, this behaviour is even somewhat useful: we can then look up the source on `self.__class__` (which then does have a useful value).



---

archive/issue_comments_210786.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-23T23:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210786",
    "user": "nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_210787.json:
```json
{
    "body": "In case someone wants to fix the fact that staticmethods on dynamicclasses end up binding anyway: I suspect the problem occurs somewhere in `getattr_from_other_class`, and it's probably an issue that the \"getter\" gets used twice. To illustrate:\n\n```\nsage: class T(object):\n    @staticmethod\n    def stat():\n        pass\n....:     \nsage: t=T()\nsage: t.stat\n<function __main__.stat>\nsage: T.__dict__['stat']\n<staticmethod at 0x7009210>\nsage: T.__dict__['stat'].__get__(t)\n<function __main__.stat>\nsage: T.__dict__['stat'].__get__(t).__get__(t)\n<bound method ?.stat of <__main__.T object at 0x6ff0510>>\n```\n\nAs you can see, the standard staticmethod getter returns the wrapped function object. However, functions ALWAYS have a getter method that binds them. So if an staticmethod attribute inadvertently is \"got\" twice (first retrieved from the \"other\" class, and then passed through its own getter another time), one would end up binding a static method. Fixing this is not within the scope of this ticket, though.",
    "created_at": "2014-05-24T04:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210787",
    "user": "nbruin"
}
```

In case someone wants to fix the fact that staticmethods on dynamicclasses end up binding anyway: I suspect the problem occurs somewhere in `getattr_from_other_class`, and it's probably an issue that the "getter" gets used twice. To illustrate:

```
sage: class T(object):
    @staticmethod
    def stat():
        pass
....:     
sage: t=T()
sage: t.stat
<function __main__.stat>
sage: T.__dict__['stat']
<staticmethod at 0x7009210>
sage: T.__dict__['stat'].__get__(t)
<function __main__.stat>
sage: T.__dict__['stat'].__get__(t).__get__(t)
<bound method ?.stat of <__main__.T object at 0x6ff0510>>
```

As you can see, the standard staticmethod getter returns the wrapped function object. However, functions ALWAYS have a getter method that binds them. So if an staticmethod attribute inadvertently is "got" twice (first retrieved from the "other" class, and then passed through its own getter another time), one would end up binding a static method. Fixing this is not within the scope of this ticket, though.



---

archive/issue_comments_210788.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-08T06:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210788",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_210789.json:
```json
{
    "body": "failing doctest, see patchbot report",
    "created_at": "2015-04-08T06:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16145#issuecomment-210789",
    "user": "chapoton"
}
```

failing doctest, see patchbot report
