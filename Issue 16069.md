# Issue 16069: Replace =0 by is_zero() in test for matrix being alternating

Issue created by migration from Trac.

Original creator: darij

Original creation time: 2014-05-07 23:08:10

CC:  nbruin stumpc5

Just a couple small fixes, the one in the summary being the main one. (Not all rings R have their zero element equal to R(0).)


---

Comment by darij created at 2014-05-07 23:08:18

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2014-05-08 21:36:58

Hi Darij,

1) Could you provide examples of rings for which the test fails? It is not clear to me why we need this and if you do not want that such bug reproduces you need to test it. More precisely, in the documentation write something along the lines of

```
In the following example, we show that we solve the issue in :trac:`16306` is solved::

    sage: a_nice_example()
    Hey!
```


2) why not

```
-            if self.get_unsafe(i,i) != 0:
+            if self.get_unsafe(i,i):
```

Do we know that `__nonzero__` always does what we expect?

Vincent


---

Comment by darij created at 2014-05-08 22:44:04

1) I don't have good examples. We have semirings where 0 is not the zero in Sage (try `TropicalSemiring(ZZ)`), but this particular method doesn't make much sense for these. This is more an issue of principle: We might eventually get rings like Grothendieck's lambda-rings (the ring of power series over a given ring K, with multiplication of power series as addition, and a weirder multiplication -- and, before you ask, there are finite-dimensional quotients of this, so it's not all lazy power series, so testing for zeroness does make sense), on which there will suddenly be a lot of failing code due to the fact that the coerce of 1 (not the coerce of 0) is the zero element. Better to fix as many of these issues as we can right now.

However, in most examples I've tried, `is_zero` is faster than `== 0` due to the coercion that has to be resolved for the latter.

2) I don't know. I wouldn't make an assumption on the boolean coerce of a ring element. But maybe I could...


---

Comment by vdelecroix created at 2014-05-09 06:57:35

Replying to [comment:4 darij]:
> 1) I don't have good examples. We have semirings where 0 is not the zero in Sage (try `TropicalSemiring(ZZ)`), but this particular method doesn't make much sense for these. This is more an issue of principle: We might eventually get rings like Grothendieck's lambda-rings (the ring of power series over a given ring K, with multiplication of power series as addition, and a weirder multiplication -- and, before you ask, there are finite-dimensional quotients of this, so it's not all lazy power series, so testing for zeroness does make sense), on which there will suddenly be a lot of failing code due to the fact that the coerce of 1 (not the coerce of 0) is the zero element. Better to fix as many of these issues as we can right now.

So, I do not understand the description of the ticket. You wrote `Not all rings R have their zero element equal to R(0)`. But now that I asked for an example, you say that no such ring exists.

> However, in most examples I've tried, `is_zero` is faster than `== 0` due to the coercion that has to be resolved for the latter.

Ok. Looks like a better argument than claiming that there are other rings. Could you provide timings then?

> 2) I don't know. I wouldn't make an assumption on the boolean coerce of a ring element. But maybe I could...

No. I was just asking. Because, if you care about speed, this is by far the fastest.

Vincent


---

Comment by darij created at 2014-05-09 20:36:51

I hope you will agree that "all rings" and "all rings in Sage" are two rather different things... :)

Some timings on zero elements:


```
sage: %timeit ZZ(1) == 0
1000000 loops, best of 3: 419 ns per loop
sage: %timeit ZZ(1).is_zero()
1000000 loops, best of 3: 389 ns per loop
sage: %timeit QQ(1) == 0
100000 loops, best of 3: 2.15 µs per loop
sage: %timeit QQ(1).is_zero()
1000000 loops, best of 3: 853 ns per loop
sage: P.<x> = PolynomialRing(QQ)
sage: %timeit x == 0
100000 loops, best of 3: 2.76 µs per loop
sage: %timeit x.is_zero()
1000000 loops, best of 3: 223 ns per loop
sage: Sym = SymmetricFunctions(QQ); e = Sym.e(); ez = e.zero()
sage: %timeit ez == 0
10000 loops, best of 3: 27.9 µs per loop
sage: %timeit ez.is_zero()
100000 loops, best of 3: 4.45 µs per loop
```

and on nonzero elements:

```
sage: %timeit ZZ(2) == 0     
1000000 loops, best of 3: 416 ns per loop
sage: %timeit ZZ(2).is_zero()
1000000 loops, best of 3: 383 ns per loop
sage: %timeit QQ(2) == 0
100000 loops, best of 3: 2.15 µs per loop
sage: %timeit QQ(2).is_zero()
1000000 loops, best of 3: 877 ns per loop
sage: e2 = e[2]
sage: %timeit e2 == 0
10000 loops, best of 3: 27.8 µs per loop
sage: %timeit e2.is_zero()
100000 loops, best of 3: 5.91 µs per loop
sage: %timeit Integer(2) == 0     
1000000 loops, best of 3: 417 ns per loop
sage: %timeit Integer(2).is_zero()
1000000 loops, best of 3: 360 ns per loop
```


I don't know how much of the coercion overhead can be removed by improving the coercion system, but for now it looks like `is_zero` wins against coercion.


---

Comment by darij created at 2014-05-09 20:38:31

Actually, checking equality with parent.zero() is even faster than checking is_zero(). I'll push this once I am back home.


---

Comment by git created at 2014-05-14 01:04:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-05-14 01:05:09

Fixed. Sorry for it taking such a while!


---

Comment by vdelecroix created at 2014-05-14 05:46:19

Replying to [comment:7 darij]:
> Actually, checking equality with parent.zero() is even faster than checking is_zero(). I'll push this once I am back home.

I see, the following tests are more appropriate

```
sage: n = 12
sage: %timeit n.is_zero()
1000000 loops, best of 3: 204 ns per loop
sage: zero = n.parent().zero()
sage: %timeit n == zero
10000000 loops, best of 3: 149 ns per loop
```



---

Comment by vdelecroix created at 2014-05-14 06:02:17

Hi Darij,

What is the point of `if not self.get_unsafe(i,i) == zero:` instead of `if self.get_unsafe(i,i) != zero:`? Could you write an appropriate title and an appropriate description for the ticket?

I agree that it is a small ticket. But it is not a reason to not do it cleanly!

Thanks,
Vincent


---

Comment by git created at 2014-05-14 06:54:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-05-14 06:57:25

Oops, the use of "not" was a relic of the old version.

Part of the reason why comparison with parent().zero() takes so long is that parent() and zero() have to be computed. This can be done once per call of the method, and so the time amortizes quite well.
----
New commits:


---

Comment by vdelecroix created at 2014-05-14 13:21:48

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2014-05-14 13:21:48

Hi Darij,

I still do not understand the motivation for the ticket: the function is not time critical and as you confirmed there is nowhere in Sage a ring whose zero is not 0. The code is better with the branch applied so I set to positive review.

Vincent


---

Comment by darij created at 2014-05-14 16:58:32

Thank you!

This is a really minor change I wouldn't have done if the code in question wasn't my code from an older ticket.


---

Comment by vbraun created at 2014-05-15 15:46:00

reviewer name


---

Comment by tscrim created at 2014-05-15 16:22:56

FTR, there is one:

```
sage: T = TropicalSemiring(QQ)
sage: T(0)
0
sage: T.zero()
+infinity
```

(which we have to do because `TestSuite` uses `zero` as the additive identity, so we might want a separate categories for tropical stuff, but that's an issue for a different ticket).


---

Comment by vbraun created at 2014-05-19 10:25:08

Resolution: fixed
