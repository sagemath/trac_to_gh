# Issue 28847: Make fflas_ffpack detect and use system openblas on Arch

Issue created by migration from https://trac.sagemath.org/ticket/29084

Original creator: arojas

Original creation time: 2020-01-26 18:18:10

CC:  dimpase vdelecroix




---

Comment by arojas created at 2020-01-26 18:25:26

Changing status from new to needs_review.


---

Comment by arojas created at 2020-01-26 18:25:26

Changing type from PLEASE CHANGE to defect.


---

Comment by arojas created at 2020-01-26 18:25:26

New commits:


---

Comment by arojas created at 2020-01-26 18:25:26

Changing component from PLEASE CHANGE to build.


---

Comment by dimpase created at 2020-01-28 09:52:11

looks good to me.


---

Comment by dimpase created at 2020-01-28 09:52:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-01-28 10:02:57

plesase also see #29088#comment:13 - it might be relevant to Arch in particular.


---

Comment by mkoeppe created at 2020-01-28 16:26:43

Changing status from positive_review to needs_info.


---

Comment by mkoeppe created at 2020-01-28 16:26:43

Is this ticket needed? Also the current branch on #29071 seems to do the job for Arch Linux.


---

Comment by arojas created at 2020-01-28 16:35:41

Changing status from needs_info to positive_review.


---

Comment by arojas created at 2020-01-28 16:35:41

Replying to [comment:5 mkoeppe]:
> Is this ticket needed? Also the current branch on #29071 seems to do the job for Arch Linux.

Yes, this is a different issue. #29071 fixes fflas-ffpack building when using system openblas, but fflas-ffpack configure script still doesn't detect openblas being used (so the generic blas code is compiled, without specific openblas optimizations). This is what this ticket fixes.


---

Comment by mkoeppe created at 2020-01-28 21:51:05

Replying to [comment:7 arojas]:
> Replying to [comment:5 mkoeppe]:
> > Is this ticket needed? Also the current branch on #29071 seems to do the job for Arch Linux.
> 
> Yes, this is a different issue. #29071 fixes fflas-ffpack building when using system openblas, but fflas-ffpack configure script still doesn't detect openblas being used (so the generic blas code is compiled, without specific openblas optimizations). This is what this ticket fixes.

Thanks for the explanation. How does one recognize this situation in the logs? 

In https://github.com/mkoeppe/sage/actions/runs/32186055 I ran the branch of #29071. See archlinux logs at https://github.com/mkoeppe/sage/suites/424292952/artifacts/1395949

Part of the fflas configure log:

```
-----------------------------------------------
     START  FFLAS-FFPACK CONFIG                
-----------------------------------------------
checking for OpenMP... yes
Detecting SIMD instruction set
SSE enabled
SSE2 enabled
SSE3 enabled
SSSE3 enabled
SSE4.1 enabled
SSE4.2 enabled
AVX enabled
AVX2 enabled
AVX512F enabled
AVX512VL enabled
AVX512DQ enabled
FMA3 enabled
FMA4 disabled
-----------------------------------------------
...
checking for GIVARO usability... yes
checking for use of MKL... no 
checking for BLAS... found CBLAS
checking for USER LAPACK... yes (lapack)
checking if this is OpenBLAS... yes
checking for OPENBLAS numthreads... none specified (using default value 1)
```



---

Comment by arojas created at 2020-01-28 22:02:06

Replying to [comment:8 mkoeppe]:

> In https://github.com/mkoeppe/sage/actions/runs/32186055 I ran the branch of #29071. See archlinux logs at https://github.com/mkoeppe/sage/suites/424292952/artifacts/1395949

That build is not using system openblas, because you don't have the Arch cblas package installed - so Sage's openblas is being compiled, in which case this patch doesn't make any difference.

If you have Arch openblas, lapack and cblas packages installed, without this patch fflas-ffpack configure should print

`checking if this is OpenBLAS... no`

and with this patch it should print

`checking if this is OpenBLAS... yes`


---

Comment by mkoeppe created at 2020-01-28 23:12:44

Thank you!


---

Comment by mkoeppe created at 2020-01-29 02:40:13

Replying to [comment:9 arojas]:
> Replying to [comment:8 mkoeppe]:
> 
> > In https://github.com/mkoeppe/sage/actions/runs/32186055 I ran the branch of #29071. See archlinux logs at https://github.com/mkoeppe/sage/suites/424292952/artifacts/1395949
> 
> That build is not using system openblas, because you don't have the Arch cblas package installed - so Sage's openblas is being compiled, in which case this patch doesn't make any difference.
> 
> If you have Arch openblas, lapack and cblas packages installed, ...

Thanks. I have added these packages now to the "standard" configuration by https://git.sagemath.org/sage.git/commit/?id=23c6334cf2927a4d917a27b3963471e8242d86a3 in #29053/#29087. Running my GH Actions test runner
on the branch of this ticket (on top of #29051, #29071): https://github.com/mkoeppe/sage/actions/runs/32381825, 
`archlinux-latest-standard` no longer decides to build openblas.

Now I see in `fflas-ffpack` config:

```
checking for use of MKL... no 
checking for BLAS... found CBLAS
checking for USER LAPACK... no 
checking if this is OpenBLAS... yes
```


Without the branch of this ticket, i.e., only using #29051, #29071, I indeed see (at https://github.com/mkoeppe/sage/actions/runs/32381466)

```
checking for BLAS... found CBLAS
checking for USER LAPACK... no 
checking if this is OpenBLAS... no
```

-- like you said. Great!


---

Comment by mkoeppe created at 2020-01-29 02:46:49

Changing status from positive_review to needs_info.


---

Comment by mkoeppe created at 2020-01-29 02:46:49

However, there's some trouble with `ubuntu-trusty-minimal` in fflas_ffpack. It installs correctly in the run without this ticket, but has a build error with this ticket.


---

Comment by dimpase created at 2020-01-29 07:46:50

Which run are you referring to?


---

Comment by arojas created at 2020-01-29 07:50:43

Replying to [comment:12 mkoeppe]:
> However, there's some trouble with `ubuntu-trusty-minimal` in fflas_ffpack. It installs correctly in the run without this ticket, but has a build error with this ticket. 

The error is caused by having a too old GCC, I don't see how those could be related to this ticket. Where can I see the fflas-ffpack log of the successful build?


---

Comment by mkoeppe created at 2020-01-29 14:22:18

Without the ticket: https://github.com/mkoeppe/sage/actions/runs/32381466, 
  - ubuntu-trusty-minimal` run at https://github.com/mkoeppe/sage/runs/414019480?check_suite_focus=true 

With the ticket: https://github.com/mkoeppe/sage/actions/runs/32381825, 
  - `ubuntu-trusty-minimal` run at https://github.com/mkoeppe/sage/runs/414021553?check_suite_focus=true


---

Comment by mkoeppe created at 2020-01-29 14:31:39

My guess is that `pkg-config --cflags` is injecting the compiler flags that the system gcc does not understand.
Would using `pkg-config --cflags-only-I ` be enough to take care of archlinux?


---

Comment by arojas created at 2020-01-29 14:48:15

Replying to [comment:16 mkoeppe]:
> My guess is that `pkg-config --cflags` is injecting the compiler flags that the system gcc does not understand.
> Would using `pkg-config --cflags-only-I ` be enough to take care of archlinux?

That's not the case, the output of pkg-config --cflags can be seen in the logs:


```
Using --with-blas-libs='-L/sage/local/lib -lopenblas  ' '--with-blas-cflags=-I/sage/local/include  '
```


That being said, the --cflags change is not needed at all, that change was made simply to be consistent with the --libs line.


---

Comment by dimpase created at 2020-01-29 14:56:31

I think 

```
2020-01-29T01:30:39.8971740Z g++: error: unrecognized command line option '-mavx512f'
2020-01-29T01:30:39.8972021Z g++: error: unrecognized command line option '-mavx512vl'
2020-01-29T01:30:39.8972319Z g++: error: unrecognized command line option '-mavx512dq'
```

in the log is an indication that fflas_ffpack's configure emits these flags, but compiler, gcc 4.8.4, does not understand them, it's too old. So that's a bug in fflas_ffpack - or, if you prefer, a case to bump up the minimal compiler version for Sage


---

Comment by mkoeppe created at 2020-01-29 14:58:27

It's conceivable that this error only shows up depending on what specific processor it gets to run. This can probably vary from run to run on the cloud.


---

Comment by dimpase created at 2020-01-29 15:00:14

Replying to [comment:19 mkoeppe]:
> It's conceivable that this error only shows up depending on what specific processor it gets to run. This can probably vary from run to run on the cloud. 

absolutely.


---

Comment by mkoeppe created at 2020-01-29 15:04:09

I'm setting this ticket back to "positive review" and will open a separate issue for this.


---

Comment by mkoeppe created at 2020-01-29 15:04:09

Changing status from needs_info to positive_review.


---

Comment by mkoeppe created at 2020-01-29 15:04:20

Thanks everyone for your patience!


---

Comment by mkoeppe created at 2020-01-29 15:19:16

Replying to [comment:21 mkoeppe]:
> I'm setting this ticket back to "positive review" and will open a separate issue for this.
This is now #29102: fflas_ffpack installation error on new CPUs with old compilers


---

Comment by vbraun created at 2020-01-31 23:49:27

Resolution: fixed
