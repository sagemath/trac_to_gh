# Issue 32449: points_of_bounded_height for projective space is incorrect

Issue created by migration from https://trac.sagemath.org/ticket/32686

Original creator: bhutz

Original creation time: 2021-10-13 23:47:42

CC:  pfili @enderwannabe bhutz

The method for number fields iterates over the points of bounded height for each coordinate. This includes all the appropriate points, but includes some other points that are larger than the specified bound.


```
B=3
K.<v>=QuadraticField(3)
P.<x,y,z>=ProjectiveSpace(K,2)
for Q in P.points_of_bounded_height(bound=B):
    if exp(Q.global_height()) > B+0.001:
        print(Q,exp(Q.global_height()))
```


See also #31400


---

Comment by bhutz created at 2021-10-13 23:53:30

The simplest fix here is probably to check the height before yielding the point. This is not efficient, but would yield correct results, since every correct point does occur in this method.

If I don't hear another suggestion before I have time to fix this, I'll implement that (hopefully in the next week or two).


---

Comment by bhutz created at 2021-10-13 23:53:30

Set assignee to bhutz.


---

Comment by @EnderWannabe created at 2021-11-03 18:36:42

There is a paper on by David Krumm on the topic (https://arxiv.org/pdf/1403.6501.pdf). He says in Section 7 that he implemented his algorithm in Sage for demonstration purposes. I'll write to him to ask for the code, and then perhaps we can fit his algorithm into Sage.

It might be worth it to implement a temporary fix in the mean time.


---

Comment by bhutz created at 2021-11-04 14:32:18

The Doyle-Krumm algorithm for points of bounded height in number fields *is* what is implemented in Sage for number field elements. The issue here is that the points of bounded height in projective space is simply taking the bound for each coordinate and that returns some points with too large a height. I don't think Doyle-Krumm address points in projective space in their paper.


---

Comment by @EnderWannabe created at 2021-11-04 16:36:07

The above paper isn't Doyle Krumm 2011, it's a follow up paper - Krumm 2014.  It seems to be about projective space specifically, as it is titled "Computing Points of Bounded Height in Projective Space over a Number Field."


---

Comment by bhutz created at 2021-11-04 19:31:30

Sorry, you're right, I had the wrong paper. Taking a quick look, I think we should fix the "wrong" output problem with the simple fix here and then make an enhancement ticket to run the faster algorithm from David.


---

Comment by @EnderWannabe created at 2021-11-04 20:28:05

I agree, the algorithm from Krumm will take some time. He sent me his code - which at first glance works beautifully - so the majority of the work will be to write documentation and review the changes.

I've pushed a branch with the quick fix.
----
New commits:


---

Comment by @EnderWannabe created at 2021-11-04 20:28:23

Changing status from new to needs_review.


---

Comment by bhutz created at 2021-11-05 15:20:08

Shouldn't this be `<=` in the check?

btw, can you send me the Krumm code (off-line).


---

Comment by git created at 2021-11-05 16:48:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-11-05 17:02:25

This looks fine. Let's let the patchbot pick it up for the full library test.


---

Comment by bhutz created at 2021-11-05 17:51:52

There are at least a couple doc test errors. Here is one.


```
File "src/sage/schemes/projective/projective_rational_point.py", line 190, in sage.schemes.projective.projective_rational_point.enum_projective_number_field
Failed example:
    enum_projective_number_field(X(K), bound=RR(5^(1/3)), prec=2^10)
Expected:
    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (-1/5*v^2 : -1/5*v^2 : 1), (-v : -v : 1),
    (1/5*v^2 : 1/5*v^2 : 1), (v : v : 1), (1 : 1 : 0)]
Got:
    [(0 : 0 : 1),
     (-1 : -1 : 1),
     (1 : 1 : 1),
     (-1/5*v^2 : -1/5*v^2 : 1),
     (1/5*v^2 : 1/5*v^2 : 1),
     (1 : 1 : 0)]
```


I think the new result is the one that is wrong with those two points having height exactly equal to the bound. Please double check.


---

Comment by bhutz created at 2021-11-05 17:52:36

Do you need to pass `prec` to the global_height call as this is probably a numerical issue somewhere...


---

Comment by git created at 2021-11-07 01:42:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-11-07 01:42:47

I think you are right. Taking a look at the point `(v : v : 1)`, we have

``` 
sage: X(P([v,v,1])).global_height() - log((RR(5^(1/3))))
1.11022302462516e-16
```

I think the right fix here is not to just check inequality, but to also check that the difference between the bounds is less than `tolerance`? Taking a look at the documentation for the points of bounded height function on number fields, it seems to yield all points that are within the tolerance, so maybe we should too.

I think the error in `projective_homset.py` isn't actually an error - before the fix we were yielding points with height above the bound.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by @guojing0 created at 2022-04-14 06:20:31

Has the Krumm code been integrated into the Sage code?


---

Comment by @guojing0 created at 2022-07-10 15:23:18

Changing keywords from "" to "gsoc2022".


---

Comment by @guojing0 created at 2022-07-15 04:22:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-07-15 06:01:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-22 02:45:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @guojing0 created at 2022-08-28 10:04:34

New commits:


---

Comment by git created at 2022-08-28 10:09:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-29 03:17:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 03:29:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 04:11:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-29 05:41:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-30 12:34:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-31 06:06:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-31 13:33:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @guojing0 created at 2022-08-31 15:05:30

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-09-01 05:06:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 07:40:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-09-03 04:55:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-03 06:18:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-03 07:09:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-04 04:24:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-04 05:02:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-04 05:21:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-06 02:38:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-09 15:17:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-09 16:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-10 04:40:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-10 04:54:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-14 03:36:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-14 03:53:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-14 04:04:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-14 04:12:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-14 04:17:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2022-09-21 19:35:47

Changing status from needs_review to needs_work.


---

Comment by @EnderWannabe created at 2022-09-21 19:35:47

Everything seems to be working well. The only remaining issues are with the docs. The input block for points_of_bounded_height says that bound needs to be an integer, but bound can be a positive real number. You should also add an example where bound isn't an integer.


---

Comment by git created at 2022-09-22 06:38:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 07:19:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @guojing0 created at 2022-09-22 07:20:11

Changing status from needs_work to needs_review.


---

Comment by @EnderWannabe created at 2022-09-22 20:10:24

Changing status from needs_review to positive_review.


---

Comment by @EnderWannabe created at 2022-09-22 20:10:24

Looks good!


---

Comment by chapoton created at 2022-09-25 06:58:36

reviewer full name is missing


---

Comment by vbraun created at 2022-10-05 22:50:34

See patchbot for failures


---

Comment by vbraun created at 2022-10-05 22:50:34

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-10-06 04:15:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @guojing0 created at 2022-10-06 08:38:28

Let the patch bot run.


---

Comment by @guojing0 created at 2022-10-06 08:38:28

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-10-07 06:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-07 10:42:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @guojing0 created at 2022-10-08 05:23:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-10-16 22:16:02

Resolution: fixed
