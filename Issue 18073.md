# Issue 18073: Finite dimensional modules with basis: improved conversions to vectors and matrices

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2015-04-27 10:21:30

CC:  hivert saliola virmaux sage-combinat tscrim darij

This ticket:

- Implements the option `sparse` for `CombinatorialFreeModule.Element._vector_`
- Implements `Modules.WithBasis.FiniteDimensional.ParentMethods.matrix` for building a matrix from a list of elements
- Refactors `Modules.WithBasis.FiniteDimensional.MorphismMethods.matrix` to use the latter and accept the option `sparse`


---

Comment by nthiery created at 2015-04-27 15:45:38

Last 10 new commits:


---

Comment by git created at 2015-04-27 16:56:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2015-04-27 16:58:48

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-05-16 22:22:46

Looks good overall; I made some minor doc formatting tweaks. This was something Darij and I wondered about when looking at Lie algebras (something I will need to change on that ticket). However I have a question about the `column` attribute in `FDModWithBasis.ParentMethods.matrix`. You currently have `assert not columns` in the method. Did you want that to be a `NotImplementedError`, or did you want to have that do something in this ticket?
----
New commits:


---

Comment by git created at 2015-05-17 20:25:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2015-05-17 20:30:08

Replying to [comment:7 tscrim]:
> Looks good overall; I made some minor doc formatting tweaks.

I am happy with them; thanks! Isn't triple quoting of strings kind of
overkill? Not that I really mind, but it's kind of heavy handed and
really Sphinx should do that for us ...

> However I have a question about the `column` attribute in `FDModWithBasis.ParentMethods.matrix`. You currently have `assert not columns` in the method. Did you want that to be a `NotImplementedError`, or did you want to have that do something in this ticket?

Oops; just a marker I had left for myself and I later forgot. There is
a basic implementation now! Back to needs review.

Cheers,


---

Comment by tscrim created at 2015-05-18 04:46:42

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-05-18 04:46:42

Replying to [comment:9 nthiery]:
> Replying to [comment:7 tscrim]:
> > Looks good overall; I made some minor doc formatting tweaks.
> 
> I am happy with them; thanks! Isn't triple quoting of strings kind of
> overkill? Not that I really mind, but it's kind of heavy handed and
> really Sphinx should do that for us ...

It's 2 backticks and then a quote, so it gives it that nice code look in the (non-interactive) doc (I prefer this because it is meant to reflect exact user input).

> > However I have a question about the `column` attribute in `FDModWithBasis.ParentMethods.matrix`. You currently have `assert not columns` in the method. Did you want that to be a `NotImplementedError`, or did you want to have that do something in this ticket?
> 
> Oops; just a marker I had left for myself and I later forgot. There is
> a basic implementation now! Back to needs review.

Thanks. Positive review.


---

Comment by jdemeyer created at 2015-05-18 07:28:30

The `base_ring` argument of `matrix()` is not documented in the `INPUT` block.

IMHO, this belongs in the discussion on Trac, not in the docstring, especially the reference to a future hypothetical fix for #18312:

```
Constructing a sparse matrix with this method is currently
really much faster than building it from sparse vectors;
see :trac:`18312`::

    sage: n = 10^3; F = CombinatorialFreeModule(QQ, range(n)); vectors = [F.zero()]*n
    sage: %timeit m = F.matrix(vectors, sparse=True) # not tested
    The slowest run ...
    1000 loops, best of 3: 466 Âµs per loop
    sage: %timeit m = matrix(QQ, [v._vector_(sparse=True) for v in vectors], sparse=True) # not tested
    1 loops, best of 3: 1.19 s per loop

When :trac:`18312` will be fixed, using this method is
likely to still save some constant time factor.
```


And finally a question: is this new code relevant only for combinatorial free modules or also "normal" free modules?


---

Comment by jdemeyer created at 2015-05-18 07:28:30

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-05-18 09:35:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-18 09:42:06

Replying to [comment:11 jdemeyer]:
> And finally a question: is this new code relevant only for combinatorial free modules or also "normal" free modules?

Answering my own question: for normal free modules, it seems that `matrix()` just returns `basis_matrix()`. That's an annoying inconsistency. I actually see no reason to have this `matrix()` alias for `basis_matrix()`.

Proposal: define `matrix(*args, **kwds)` in free modules which calls `basis_matrix()` if no arguments are given (this should be deprecated) and calls the modified(*) categories implementation if any argument is supplied.

(*) The `base_ring` of the resulting matrix should be the `coordinate_ring`, not the `base_ring` of the free module.


---

Comment by nthiery created at 2015-05-18 09:45:51

Replying to [comment:11 jdemeyer]:
> The `base_ring` argument of `matrix()` is not documented in the `INPUT` block.

Oops, fixed. Thanks!

> IMHO, this belongs in the discussion on Trac, not in the docstring, especially the reference to a future hypothetical fix for #18312:

I don't agree. This is not a discussion about how to implement this
ticket, but an information for the user, indicating the relevance of
this method in the short and long term. She has little chance to find
this information if it's only on trac.

> And finally a question: is this new code relevant only for
> combinatorial free modules or also "normal" free modules?

It's meant for any FiniteDimensionalModulesWithBasis. When "normal"
free modules will finally be in this category, they will benefit from
this code; one of the thing to settle for this is the syntax to
iterate through the terms. Up to this syntax detail, I believe this
generic code from this ticket should work properly.

Ah, this raises a good point: FreeModule already defines a `matrix`
method, so we have a name conflict. Any good alternative name
suggestion?

Cheers,
                             Nicolas


---

Comment by jdemeyer created at 2015-05-18 09:49:55

Replying to [comment:14 nthiery]:
> but an information for the user, indicating the relevance of
> this method in the short and long term. She has little chance to find
> this information if it's only on trac.

Compromise: at least remove the sentence `When :trac:`18312` will be fixed, using this method is likely to still save some constant time factor.`


---

Comment by nthiery created at 2015-05-18 11:51:53

Hi Jeroen!

Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 nthiery]:
> > but an information for the user, indicating the relevance of
> > this method in the short and long term. She has little chance to find
> > this information if it's only on trac.
> 
> Compromise: at least remove the sentence `When :trac:`18312` will be fixed, using this method is likely to still save some constant time factor.`

With the idea that we will update the comment when `18312` will be fixed? That sounds very reasonable indeed. I am just slightly hesitant, because I would not want the user to believe that this method is just a workaround, when it's actually a way to better express a typical intention, to give a chance to the system to better optimize it. If you think it does not read that way I am happy to remove this sentence.


---

Comment by nthiery created at 2015-05-18 12:02:30

Replying to [comment:13 jdemeyer]:
> Answering my own question: for normal free modules, it seems that `matrix()` just returns `basis_matrix()`. That's an annoying inconsistency. I actually see no reason to have this `matrix()` alias for `basis_matrix()`.
> 
> Proposal: define `matrix(*args, **kwds)` in free modules which calls `basis_matrix()` if no arguments are given (this should be deprecated) and calls the modified(*) categories implementation if any argument is supplied.

+1.

Do you agree that this should go in #10672 rather than here? It would
be weird to have matrix call a method that is not yet available from
the categories. As a first step, we could just deprecate
`FreeModule.matrix` for now. What do you think?

> (*) The `base_ring` of the resulting matrix should be the `coordinate_ring`, not the `base_ring` of the free module.

Gasp, another inconsistency: most other modules in Sage (polynomial
rings, matrix space, ...) don't define coordinate_ring: there it's
assumed that the coefficients of elements live in `base_ring`.  Ok,
clarifying this is for #10672 since it's not about this specific
method, but about all uses of `base_ring`.

Thanks for the thoughts

Cheers,
                               Nicolas


---

Comment by jdemeyer created at 2015-05-18 13:06:11

Replying to [comment:17 nthiery]:
> Gasp, another inconsistency: most other modules in Sage (polynomial
> rings, matrix space, ...) don't define coordinate_ring: there it's
> assumed that the coefficients of elements live in `base_ring`.
That's easily worked around by defining `coordinate_ring` as an alias of `base_ring` in the category code. Then it can be overridden in specific cases where needed.


---

Comment by nthiery created at 2015-05-18 14:09:46

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 nthiery]:
> > Gasp, another inconsistency: most other modules in Sage (polynomial
> > rings, matrix space, ...) don't define coordinate_ring: there it's
> > assumed that the coefficients of elements live in `base_ring`.
> That's easily worked around by defining `coordinate_ring` as an alias of `base_ring` in the category code. Then it can be overridden in specific cases where needed.

Yes. And making sure all the category (and users) code calls `coordinate_ring` instead of `base_ring` whenever appropriate. That's certainly doable, but we want to make sure we want this feature generally before adding this little additional layer of complexity.
Anyway, that's for #10672.


---

Comment by git created at 2017-10-26 05:15:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-10-26 05:17:40

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-26 05:17:40

I rebased this over 8.1.beta9, but I'm not sure if there is anything that needs to be addressed from the conversion above. Jeroen, do you happen to remember or can recreate?


---

Comment by git created at 2018-07-29 22:21:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-04 05:16:57

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-07-04 05:16:57

Is this ticket still relevant? It would need rebasing


---

Comment by tscrim created at 2020-07-04 07:30:58

I am pretty sure it is still relevant as this adds extra features like the ability to specify sparseness.


---

Comment by git created at 2020-07-05 23:23:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-05 23:24:44

Squashed. Still on top of 8.3.rc3


---

Comment by mkoeppe created at 2020-07-05 23:31:13

Merging 9.2.beta3 creates some merge conflicts that look like they will be easy to resolve ... for people who know this code well


---

Comment by mkoeppe created at 2020-07-05 23:31:37

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
