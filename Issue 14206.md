# Issue 14206: Let ATLAS build shared libraries on Cygwin and install static libraries

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2013-04-04 07:52:07

Assignee: tbd

CC:  kcrisman dimpase vbraun

Keywords: atlas spkg cygwin

Currently ATLAS build static libraries without problems on Cygwin, but the autotools build system crafted by Volker which uses libtool fail to repackage them into shared one.
Indeed:
* on usual platforms libtool already rants that it should not pack non-libtool objects (extracted from the static libs) together.
* on Cygwin it just refuses to do so, and I could not find a flag to get the usual behavior (i.e. "rant but do it").
The solution is to replace the libtool invokations by direct invocations to gcc and gfortran (or even ld if you feel adventurous).
See http://trac.sagemath.org/sage_trac/ticket/10508#comment:392


---

Comment by jpflori created at 2013-11-07 16:24:04

Changing status from new to needs_review.


---

Comment by jpflori created at 2013-11-07 16:25:43

More or less tested on debian/ubuntu and cygwin(32).


---

Comment by jpflori created at 2013-11-07 16:35:45

Spkg diff, for review only.


---

Attachment

SAGE_ATLAS_LIB should be ok on Cygwin as well now...


---

Comment by vbraun created at 2013-11-18 16:06:33

Why are you moving the build dir into src? The whole point of a separate build dir is to keep it separate from the sources.

If you really want to build ATLAS by default on Cygwin then get rid of the "if False". Don't leave crap lying around after you are finished ;-)


---

Comment by jpflori created at 2013-11-18 16:15:20

Replying to [comment:9 vbraun]:
> Why are you moving the build dir into src? The whole point of a separate build dir is to keep it separate from the sources.
Hum, don't really know.
I wanted to get something consistent with how the ATLAS-lib dir is treated so I made a choice between:
* moving ATLAS-build to the (first level of) src,
* making a copy of ATLAS-lib below src before building the autotools project,
* making something more sensible and more complicated.
> 
> If you really want to build ATLAS by default on Cygwin then get rid of the "if False". Don't leave crap lying around after you are finished ;-)
I also hesitated, but I think keeping it in the spkg-install script, either as dead code or as a comment, cannot hurt.
You can argue that it is saved into the hg history anyway.


---

Comment by vbraun created at 2013-11-20 01:58:24

Replying to [comment:10 jpflori]:
> I also hesitated, but I think keeping it in the spkg-install script, either as dead code or as a comment, cannot hurt.

It can, e.g. the next person might think that you really wanted to enable that but could not at that time for some unknown reason...


---

Comment by jpflori created at 2013-11-20 13:56:39

Spkg updated at the same address.


---

Comment by vbraun created at 2013-11-21 03:26:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-11-21 03:26:41

Thanks. But "therefore" means "for that reason; consequently" and not "before that".

On a practical level, I don't think Jeroen is going to merge this before the git switch. Spkg changes might need to be manually converted to git branches...


---

Comment by jdemeyer created at 2013-11-22 14:47:39

`spkg-check` doesn't work:

```
...
Successfully installed atlas-3.10.1.p6
Running the test suite for atlas-3.10.1.p6...
./spkg-check: line 38: cd: ATLAS-build: No such file or directory
```



---

Comment by jdemeyer created at 2013-11-22 14:47:39

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-11-22 20:26:14

Also, the spkg needs to be rebased to #15270.


---

Comment by jpflori created at 2013-11-25 14:05:14

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-11-25 14:05:14

Rebased on top of #15270 and revamped spkg-check.


---

Comment by jpflori created at 2013-11-25 15:02:07

For the record this should only:
* fix a bug in spkg-install which thought that the serial shared libraries were built even when not and so left the sage install without any ATLAS libraries,
* let ATLAS build on Cygwin without any impact on other systems,
* clean spkg-check.
So this is not so intrusive for usual systems and I wouldn't mind that Jeroen includes it in 5.13 if it's not too late (as the two other easy and (hopefully) Cygwin-only spkg fixes at #15365 and #15366).


---

Comment by vbraun created at 2013-11-25 15:27:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-11-25 15:27:34

I think the general policy is not to merge new spkgs late in the beta cycle, but I'll let Jeroen decide on that ;-)


---

Comment by jdemeyer created at 2013-11-26 11:02:11

The Changelog inside `SPKG.txt` is wrong:

```
### atlas-3.10.1.p6, lapack-3.4.2 (Volker Braun, 11 October 2013)
 * Trac #15270: Do not give up if the upstream shared library build
   fails
 * Solaris / ZFS fixes

### atlas-3.10.1.p6, lapack-3.4.2 (Jean-Pierre Flori, 7 November 2013)
 * Trac #14410: Let ATLAS build and install shared libraries on Cygwin.
 * Bunch of modifications to the autotools project generating shared libraries
   so that it does not invoke libtool on Cygwin.
 * Fix a bug in spkg-install.
```


These two entries should be switched and the version number (atlas-3.10.1.*p7*) corrected.


---

Comment by jdemeyer created at 2013-11-26 11:02:11

Changing status from positive_review to needs_work.


---

Comment by jpflori created at 2013-11-26 13:33:22

Yup, I'm quite sure I did it, but as I screwed up later on and had to reapply other changes i guess I forgot to correct that again.


---

Comment by jpflori created at 2013-11-26 13:38:45

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-11-26 13:38:45

Should be ok now...


---

Comment by jpflori created at 2013-11-26 16:46:03

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-11-26 16:46:03

make check does not work.


---

Comment by jpflori created at 2013-11-26 17:26:46

Ok, fixed and tested this time.


---

Comment by jpflori created at 2013-11-26 17:26:46

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-11-28 09:32:06

Tested (SPKG_CHECK=yes) with success on Solaris as well.


---

Comment by jdemeyer created at 2013-12-05 08:05:49

Resolution: fixed
