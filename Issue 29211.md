# Issue 29211: configure finds libpng but matplotlib does not

Issue created by migration from https://trac.sagemath.org/ticket/29448

Original creator: mkoeppe

Original creation time: 2020-04-01 22:03:44

CC:  jhpalmieri dimpase mjo




---

Comment by mkoeppe created at 2020-04-01 23:58:58

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-04-02 00:00:12

Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?


---

Comment by mjo created at 2020-04-02 00:08:58

What exactly failed?


---

Comment by jhpalmieri created at 2020-04-02 00:30:03

Replying to [comment:5 mkoeppe]:
> Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?

I will, but I ran into #29449 first.

Replying to [comment:6 mjo]:
> What exactly failed?

I see this in the matplotlib log file:

```
                            * The following required packages can not be built:
                            * png
                            * Try installing png with `brew install libpng` and
                            * pkg-config with `brew install pkg-config`
```

and then the build fails.


---

Comment by jhpalmieri created at 2020-04-02 00:37:47

Same problem with the upgrade to 2.2.5.


---

Comment by jhpalmieri created at 2020-04-02 01:10:39

Note that installing Sage's `pkgconf` package does not fix this.


---

Comment by dimpase created at 2020-04-02 01:33:08

This looks to me like an issue with Homebrew installing packages in a non-standard location, and then they get mixed up with system packages.

It should be totally indifferent whether it is using Sage's pkgconf (providing pkg-config), or system's pkg-config, they both do exactly the same thing (if not, it's a bug in our management of its PKG_CONFIG_PATH).


---

Comment by mkoeppe created at 2020-04-02 01:46:50

libpng.pc is unusual in that it `Requires: zlib` but there are two versions of `zlib.pc` on homebrew. By default, the one representing the system zlib is used; if one uses `. .homebrew-build-env`, which adds to `PKG_CONFIG_PATH`, the one for homebrew's zlib is used.


---

Comment by mkoeppe created at 2020-04-09 03:45:19

Possibly related: build error of sagelib, 

```
[sagelib-9.1.beta9]     raise PackageNotFoundError(package)
[sagelib-9.1.beta9] pkgconfig.pkgconfig.PackageNotFoundError: libpng not found
```

reported at https://groups.google.com/d/msg/sage-support/Oh3ev_wrjyo/od4R2FCNDQAJ


---

Comment by mkoeppe created at 2020-04-09 04:00:33

It's likely the same thing: spkg-configure.m4 has a sneaky way of finding libpng but does not tell any of the other packages - matplotlib and now sagelib.


---

Comment by mkoeppe created at 2020-04-15 03:24:46

Changing priority from critical to blocker.


---

Comment by dimpase created at 2020-05-01 08:30:29

if we use Homebrew, can we just bail out if pkg-config is not installed?


---

Comment by mkoeppe created at 2020-05-01 15:37:12

No, that's not the correct solution.

If an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.


---

Comment by dimpase created at 2020-05-01 16:08:37

Replying to [comment:16 mkoeppe]:
> No, that's not the correct solution.
> 
> If an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.

you say that reinventing the wheel is the correct solution...

Writing tricky autoconf code, where the user can simply do `brew install pkg-config`, seems to be a waste of time to me.


---

Comment by mkoeppe created at 2020-05-01 16:35:23

No, the problem is that the autoconf code is already too tricky and finds more libpng than the spkgs that it is guarding.


---

Comment by dimpase created at 2020-05-01 16:41:08

The code I wrote there assumed that users are sane, and install a meaningful set of tools. You propose to make it dumber to make it work in pathological cases, I don't get why this is needed, sorry.


---

Comment by mkoeppe created at 2020-05-01 16:43:28

It was a great initiative to get these spkg-configure files started, and now we are refining them so that they do their job correctly --- by testing on many platforms.
----
New commits:


---

Comment by mkoeppe created at 2020-05-01 16:43:53

See code comments for better explanation.


---

Comment by dimpase created at 2020-05-01 16:50:39

ok, this will do, sorry for noise.


---

Comment by dimpase created at 2020-05-01 16:50:39

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-05-01 16:51:04

is it ready?


---

Comment by mkoeppe created at 2020-05-01 17:08:51

Ready for review


---

Comment by dimpase created at 2020-05-01 17:32:07

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-05-01 17:32:07

LGTM


---

Comment by mkoeppe created at 2020-05-01 17:33:43

Thanks!


---

Comment by vbraun created at 2020-05-04 06:41:31

Resolution: fixed


---

Comment by mkoeppe created at 2020-07-10 16:48:14

Same for zlib->pillow in #30103
