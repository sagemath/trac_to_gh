# Issue 29211: configure finds libpng but matplotlib does not

archive/issues_029211.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @orlitzky\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29448\n\n",
    "created_at": "2020-04-01T22:03:44Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "configure finds libpng but matplotlib does not",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29211",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @dimpase @orlitzky



Issue created by migration from https://trac.sagemath.org/ticket/29448





---

archive/issue_comments_413519.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-04-01T23:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413519",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_413520.json:
```json
{
    "body": "Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?",
    "created_at": "2020-04-02T00:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413520",
    "user": "https://github.com/mkoeppe"
}
```

Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?



---

archive/issue_comments_413521.json:
```json
{
    "body": "What exactly failed?",
    "created_at": "2020-04-02T00:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413521",
    "user": "https://github.com/orlitzky"
}
```

What exactly failed?



---

archive/issue_comments_413522.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?\n\nI will, but I ran into #29449 first.\n\nReplying to [comment:6 mjo]:\n> What exactly failed?\n\nI see this in the matplotlib log file:\n\n```\n                            * The following required packages can not be built:\n                            * png\n                            * Try installing png with `brew install libpng` and\n                            * pkg-config with `brew install pkg-config`\n```\n\nand then the build fails.",
    "created_at": "2020-04-02T00:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413522",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:5 mkoeppe]:
> Could you try if #29444 (Upgrade matplotlib to 2.2.5) fixes it?

I will, but I ran into #29449 first.

Replying to [comment:6 mjo]:
> What exactly failed?

I see this in the matplotlib log file:

```
                            * The following required packages can not be built:
                            * png
                            * Try installing png with `brew install libpng` and
                            * pkg-config with `brew install pkg-config`
```

and then the build fails.



---

archive/issue_comments_413523.json:
```json
{
    "body": "Same problem with the upgrade to 2.2.5.",
    "created_at": "2020-04-02T00:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413523",
    "user": "https://github.com/jhpalmieri"
}
```

Same problem with the upgrade to 2.2.5.



---

archive/issue_comments_413524.json:
```json
{
    "body": "Note that installing Sage's `pkgconf` package does not fix this.",
    "created_at": "2020-04-02T01:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413524",
    "user": "https://github.com/jhpalmieri"
}
```

Note that installing Sage's `pkgconf` package does not fix this.



---

archive/issue_comments_413525.json:
```json
{
    "body": "This looks to me like an issue with Homebrew installing packages in a non-standard location, and then they get mixed up with system packages.\n\nIt should be totally indifferent whether it is using Sage's pkgconf (providing pkg-config), or system's pkg-config, they both do exactly the same thing (if not, it's a bug in our management of its PKG_CONFIG_PATH).",
    "created_at": "2020-04-02T01:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413525",
    "user": "https://github.com/dimpase"
}
```

This looks to me like an issue with Homebrew installing packages in a non-standard location, and then they get mixed up with system packages.

It should be totally indifferent whether it is using Sage's pkgconf (providing pkg-config), or system's pkg-config, they both do exactly the same thing (if not, it's a bug in our management of its PKG_CONFIG_PATH).



---

archive/issue_comments_413526.json:
```json
{
    "body": "libpng.pc is unusual in that it `Requires: zlib` but there are two versions of `zlib.pc` on homebrew. By default, the one representing the system zlib is used; if one uses `. .homebrew-build-env`, which adds to `PKG_CONFIG_PATH`, the one for homebrew's zlib is used.",
    "created_at": "2020-04-02T01:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413526",
    "user": "https://github.com/mkoeppe"
}
```

libpng.pc is unusual in that it `Requires: zlib` but there are two versions of `zlib.pc` on homebrew. By default, the one representing the system zlib is used; if one uses `. .homebrew-build-env`, which adds to `PKG_CONFIG_PATH`, the one for homebrew's zlib is used.



---

archive/issue_comments_413527.json:
```json
{
    "body": "Possibly related: build error of sagelib, \n\n```\n[sagelib-9.1.beta9]     raise PackageNotFoundError(package)\n[sagelib-9.1.beta9] pkgconfig.pkgconfig.PackageNotFoundError: libpng not found\n```\n\nreported at https://groups.google.com/d/msg/sage-support/Oh3ev_wrjyo/od4R2FCNDQAJ",
    "created_at": "2020-04-09T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413527",
    "user": "https://github.com/mkoeppe"
}
```

Possibly related: build error of sagelib, 

```
[sagelib-9.1.beta9]     raise PackageNotFoundError(package)
[sagelib-9.1.beta9] pkgconfig.pkgconfig.PackageNotFoundError: libpng not found
```

reported at https://groups.google.com/d/msg/sage-support/Oh3ev_wrjyo/od4R2FCNDQAJ



---

archive/issue_comments_413528.json:
```json
{
    "body": "It's likely the same thing: spkg-configure.m4 has a sneaky way of finding libpng but does not tell any of the other packages - matplotlib and now sagelib.",
    "created_at": "2020-04-09T04:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413528",
    "user": "https://github.com/mkoeppe"
}
```

It's likely the same thing: spkg-configure.m4 has a sneaky way of finding libpng but does not tell any of the other packages - matplotlib and now sagelib.



---

archive/issue_comments_413529.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-04-15T03:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413529",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_413530.json:
```json
{
    "body": "if we use Homebrew, can we just bail out if pkg-config is not installed?",
    "created_at": "2020-05-01T08:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413530",
    "user": "https://github.com/dimpase"
}
```

if we use Homebrew, can we just bail out if pkg-config is not installed?



---

archive/issue_comments_413531.json:
```json
{
    "body": "No, that's not the correct solution.\n\nIf an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.",
    "created_at": "2020-05-01T15:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413531",
    "user": "https://github.com/mkoeppe"
}
```

No, that's not the correct solution.

If an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.



---

archive/issue_comments_413532.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> No, that's not the correct solution.\n> \n> If an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.\n\nyou say that reinventing the wheel is the correct solution...\n\nWriting tricky autoconf code, where the user can simply do `brew install pkg-config`, seems to be a waste of time to me.",
    "created_at": "2020-05-01T16:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413532",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:16 mkoeppe]:
> No, that's not the correct solution.
> 
> If an spkg-configure has more general ways of finding a library than one of the spkgs depending on it, then spkg-configure needs to communicate the install information to that spkg.

you say that reinventing the wheel is the correct solution...

Writing tricky autoconf code, where the user can simply do `brew install pkg-config`, seems to be a waste of time to me.



---

archive/issue_comments_413533.json:
```json
{
    "body": "No, the problem is that the autoconf code is already too tricky and finds more libpng than the spkgs that it is guarding.",
    "created_at": "2020-05-01T16:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413533",
    "user": "https://github.com/mkoeppe"
}
```

No, the problem is that the autoconf code is already too tricky and finds more libpng than the spkgs that it is guarding.



---

archive/issue_comments_413534.json:
```json
{
    "body": "The code I wrote there assumed that users are sane, and install a meaningful set of tools. You propose to make it dumber to make it work in pathological cases, I don't get why this is needed, sorry.",
    "created_at": "2020-05-01T16:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413534",
    "user": "https://github.com/dimpase"
}
```

The code I wrote there assumed that users are sane, and install a meaningful set of tools. You propose to make it dumber to make it work in pathological cases, I don't get why this is needed, sorry.



---

archive/issue_comments_413535.json:
```json
{
    "body": "It was a great initiative to get these spkg-configure files started, and now we are refining them so that they do their job correctly --- by testing on many platforms.\n----\nNew commits:",
    "created_at": "2020-05-01T16:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413535",
    "user": "https://github.com/mkoeppe"
}
```

It was a great initiative to get these spkg-configure files started, and now we are refining them so that they do their job correctly --- by testing on many platforms.
----
New commits:



---

archive/issue_comments_413536.json:
```json
{
    "body": "See code comments for better explanation.",
    "created_at": "2020-05-01T16:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413536",
    "user": "https://github.com/mkoeppe"
}
```

See code comments for better explanation.



---

archive/issue_comments_413537.json:
```json
{
    "body": "ok, this will do, sorry for noise.",
    "created_at": "2020-05-01T16:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413537",
    "user": "https://github.com/dimpase"
}
```

ok, this will do, sorry for noise.



---

archive/issue_comments_413538.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-01T16:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413538",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_413539.json:
```json
{
    "body": "is it ready?",
    "created_at": "2020-05-01T16:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413539",
    "user": "https://github.com/dimpase"
}
```

is it ready?



---

archive/issue_comments_413540.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-05-01T17:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413540",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review



---

archive/issue_comments_413541.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-01T17:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413541",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_413542.json:
```json
{
    "body": "LGTM",
    "created_at": "2020-05-01T17:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413542",
    "user": "https://github.com/dimpase"
}
```

LGTM



---

archive/issue_comments_413543.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-05-01T17:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413543",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_413544.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-04T06:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413544",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_026993.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-05-04T06:41:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29211#event-26993"
}
```



---

archive/issue_comments_413545.json:
```json
{
    "body": "Same for zlib->pillow in #30103",
    "created_at": "2020-07-10T16:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29211#issuecomment-413545",
    "user": "https://github.com/mkoeppe"
}
```

Same for zlib->pillow in #30103
