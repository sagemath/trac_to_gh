# Issue 29102: Fix NTL spkg-configure.m4 so it rejects NTLs built with NTL_THREADS, without NTL_GMP_LIP, without NTL_GF2X_LIB

Issue created by migration from https://trac.sagemath.org/ticket/29339

Original creator: mkoeppe

Original creation time: 2020-03-15 16:25:38

CC:  dimpase fbissey @mwageringel jhpalmieri jpflori

... such as homebrew's NTL (#29104).

Builds with NTL_THREADS breaks Singular (as observed in #29104).

The other checks are about performance degradation that we should not accept.


---

Comment by dimpase created at 2020-03-15 16:40:23

the wise thing is to enable TLS as much as possible, IMHO. The configuration with enabled TLS on NTL, pari, and flint used to work, IIRC.


---

Comment by dimpase created at 2020-03-15 16:43:06

I also don't think gf2x should be a hard requirement. It is entirely optional for NTL.


---

Comment by mkoeppe created at 2020-03-15 17:50:39

Do you mean NTL_TLS_HACK?


---

Comment by mkoeppe created at 2020-03-15 17:55:15

homebrew's NTL is configured with `NTL_TLS_HACK` and `NTL_THREADS`, and I am getting the reported error with Singular.
What do you suggest?


---

Comment by mkoeppe created at 2020-03-15 17:56:01

Tests run at https://github.com/mkoeppe/sage/actions/runs/56215147


---

Comment by dimpase created at 2020-03-15 18:13:14

see #27764


---

Comment by mkoeppe created at 2020-03-15 22:53:12

New commits:


---

Comment by mkoeppe created at 2020-03-15 22:53:12

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-03-16 06:32:41

once again - some distros build NTL without gf2x support, and it results in some deterioration of performance, but this is not something Sage should worry too much. Print a warning if you must.

After all, it is by far not the only place where the performance is suboptimal on pre-build installs, untuned for the hardware, say.


---

Comment by mkoeppe created at 2020-03-16 14:54:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-03-16 14:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-16 14:55:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-17 17:01:02

Replying to [comment:10 dimpase]:
> once again - some distros build NTL without gf2x support, and it results in some deterioration of performance, but this is not something Sage should worry too much. Print a warning if you must.
OK, I have removed the tests


---

Comment by dimpase created at 2020-03-17 17:33:53

IMHO also pari/gp is typically built with threads on by distros.
This means that TLS is enabled for pari/gp.

We may end up with having to build all the libs...


---

Comment by mkoeppe created at 2020-03-17 17:50:50

I don't see such problems in my tests


---

Comment by dimpase created at 2020-03-17 18:10:31

do you test with options **forcing** the use of system packages?


---

Comment by mkoeppe created at 2020-03-17 18:24:44

Not recently, will do


---

Comment by mkoeppe created at 2020-03-17 18:46:00

However, you can look for the new messages `configure: Hint: The following SPKGs did not find equivalent system packages`
such as (https://github.com/mkoeppe/sage/runs/512242876) for `ubuntu-focal-standard`:

```
configure: Hint: The following SPKGs did not find equivalent system packages:
configure:   arb cbc cmake eclib fflas_ffpack flint fplll isl libatomic_ops libsemigroups ninja_build ntl perl_term_readline_gnu
checking for the package system in use... debian
configure: Hint: Installing the following system packages is recommended and may avoid building some of the above SPKGs from source:
configure:   $ sudo apt-get install libflint-arb-dev coinor-cbc coinor-libcbc-dev cmake libec-dev libflint-dev libisl-dev ninja-build libntl-dev libterm-readline-gnu-perl
configure: After installation, re-run configure using:
configure:   $ ./config.status --recheck && ./config.status
```



---

Comment by dimpase created at 2020-03-18 01:59:39

I think that the threads issue should be handled on per platform basis. If threads are not working on MacOS it does not mean that Sage on Linux should be made single-thread.


---

Comment by mkoeppe created at 2020-03-18 02:03:58

Do you know a platform that actually builds NTL with threads?


---

Comment by fbissey created at 2020-03-18 02:05:09

Replying to [comment:21 mkoeppe]:
> Do you know a platform that actually builds NTL with threads?

Gentoo.


---

Comment by mkoeppe created at 2020-03-18 02:10:17

Well, does sage-the-distribution work with Gentoo's NTL?


---

Comment by dimpase created at 2020-03-18 02:14:12

yes it does, I think.


---

Comment by mkoeppe created at 2020-03-18 02:22:58

Shouldn't there be a ticket that enables NTL threads for Sage-the-distribution then?
The NTL upgrade ticket #20590 disabled threads explicitly.
So I assume there was a difficulty -- and there is no evidence that it has been resolved.


---

Comment by dimpase created at 2020-03-18 02:27:51

4 years ago the Python's single-thread religion still had many followers :-)


---

Comment by mkoeppe created at 2020-03-18 02:42:21

No, seriously, when our own installation scripts avoid NTL's threads, then I think it is quite appropriate that the spkg-configure checks for that.


---

Comment by dimpase created at 2020-03-18 07:38:22

by the way, Fedora 30 (and on newer Fedoras too) also provides multithreaded NTL, and Sage happily uses it, tests pass.

```
$ uname -a
Linux clpc171.cs.ox.ac.uk 5.2.18-200.fc30.x86_64 #1 SMP Tue Oct 1 13:14:07 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
$ ldd /lib64/libntl.so
        linux-vdso.so.1 (0x00007ffe9affd000)
        libgmp.so.10 => /lib64/libgmp.so.10 (0x00007fabe7899000)
        libgf2x.so.1 => /lib64/libgf2x.so.1 (0x00007fabe7888000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fabe7867000)
        libstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007fabe766d000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fabe7527000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fabe7361000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fabe7c33000)
        libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fabe7345000)
```



---

Comment by dimpase created at 2020-03-18 07:43:22

Replying to [comment:27 mkoeppe]:
> No, seriously, when our own installation scripts avoid NTL's threads, then I think it is quite appropriate that the spkg-configure checks for that.

I don't see why. Anyhow, this problem (inability to use multithreaded NTL) seems to be MacOS-only, and probably related to #27764


---

Comment by fbissey created at 2020-03-18 07:50:50

We historically had an issue before defaulting to C++11 but we should be able to move ahead in my opinion. I am expecting distros to all be threaded at this stage. It is just a matter of testing the insane number of corner cases.


---

Comment by dimpase created at 2020-03-18 08:08:47

Replying to [comment:30 fbissey]:
> We historically had an issue before defaulting to C++11 but we should be able to move ahead in my opinion. I am expecting distros to all be threaded at this stage. It is just a matter of testing the insane number of corner cases.

it seems to be that Debian is not providing multithreaded NTL (and the related libs, such as Flint, are single-threaded too).


---

Comment by @mwageringel created at 2020-03-18 08:10:23

For what it is worth, on macOS 10.13.6, Homebrew's NTL works for me without any problems. I last checked with a clean build of 9.1.beta4 and ptestlong passed.


---

Comment by mkoeppe created at 2020-03-18 16:39:23

Replying to [comment:30 fbissey]:
> We historically had an issue before defaulting to C++11 but we should be able to move ahead in my opinion. I am expecting distros to all be threaded at this stage. It is just a matter of testing the insane number of corner cases.
I have created ticket #29340 (Enable threads in NTL) for that, in case someone would like to work on it.


---

Comment by mkoeppe created at 2020-03-18 16:40:45

Replying to [comment:29 dimpase]:
> Replying to [comment:27 mkoeppe]:
> > No, seriously, when our own installation scripts avoid NTL's threads, then I think it is quite appropriate that the spkg-configure checks for that.
> 
> I don't see why. Anyhow, this problem (inability to use multithreaded NTL) seems to be MacOS-only, and probably related to #27764

#27764 does not fix the problem on macOS, I've already tested that


---

Comment by mkoeppe created at 2020-03-19 16:12:00

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-03-19 16:12:00

See #29366 (arch)


---

Comment by mkoeppe created at 2021-02-03 02:07:43

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2021-02-03 02:07:43

I think this is no longer needed


---

Comment by dimpase created at 2021-02-04 10:01:09

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-02-04 10:01:09

ok


---

Comment by mkoeppe created at 2021-06-13 06:40:58

Resolution: invalid
