# Issue 26999: Memory leak when factoring polynomials through pari

archive/issues_026999.json:
```json
{
    "body": "Keywords: factor, pari\n\nWhen trying to factor some polynomials of degree 32, I observed a PariError, that seems to indicate that some pointers were lost.\nFurther, given that when can workaround this error by forcing `pari` to do something naive beforehand, I believe that is a memory leak. \nHowever, I'm not sure if the memory leak is in `pari` or `SAGE`'s integration.\n\nBelow follows the code how to recreate, and the work around mentioned above.\n\nPS: Why the hell we raise a NotImplementedError in this situation?!? At least we should pass the original message!\n\n\n```\nola = [[1, 0, 0, 0, 2312, 0, 0, 0, 2338588, 0, 0, 0, 1351703864, 0, 0, 0, 488303020870, 0, 0, 0, 112895658425144, 0, 0, 0, 16313422642433308, 0, 0, 0, 1347022612475207432, 0, 0, 0, 48661191875666868481L],\n[1, 0, 304, 0, 43320, 0, 3841040, 0, 237184220, 0, 10815600432, 0, 376743415048, 0, 10225892694160, 0, 218578456337670, 0, 3691547262591760, 0, 49097578592470408, 0, 508829450867420592, 0, 4028233152700413020, 0, 23549670738863953040L, 0, 95880802293946094520L, 0, 242898032477996772784L, 0, 288441413567621167681L],\n[1, 0, 0, 0, 4232, 0, 0, 0, 7835548, 0, 0, 0, 8290009784, 0, 0, 0, 5481768969670, 0, 0, 0, 2319884627964344, 0, 0, 0, 613609484096568988, 0, 0, 0, 92742690596309998472L, 0, 0, 0, 6132610415680998648961L],\n[1, 0, 464, 0, 100920, 0, 13657840, 0, 1287251420, 0, 89592698832, 0, 4763345154568, 0, 197338584974960, 0, 6438171334808070, 0, 165961749963941360, 0, 3369023524268009608, 0, 53291826656603061072L, 0, 643942905433953654620L, 0, 5745952079256817225840L, 0, 35706987921095935617720L, 0, 138067019961570951055184L, 0, 250246473680347348787521L],\n[1, 0, -496, 0, 115320, 0, -16682960, 0, 1680808220, 0, -125052131568, 0, 7107129477448, 0, -314744305429840, 0, 10976707651865670, 0, -302469277518076240, 0, 6563583322142254408, 0, -110984227083496301808L, 0, 1433546266495160565020L, 0, -13673825926569223850960L, 0, 90833272226495558438520L, 0, -375444191869514974879216L, 0, 727423121747185263828481L]];\nfor k in range(2):\n    for i, v  in enumerate(ola):\n        print i\n        try:\n            if k == 1:\n                foo = PolynomialRing(ZZ, 'T')([1] + [0]*(len(ola[0]) - 2) + [1])._pari_with_name().factor()\n            print PolynomialRing(ZZ, 'T')(v).factor()\n        except NotImplementedError:\n            # this goes down to pari\n            try:\n                PolynomialRing(ZZ, 'T')(v)._pari_with_name().factor()\n            except PariError, err:\n                print \"PariError:\", err\n                irred_check = True\n    else:\n        if k == 0:\n            print \"\\nNow doing something naive along the way to clear the stack\"\n\nOutput: \n0\n(289*T^4 + 1)^8\n1\nPariError: bug in gerepile, significant pointers lost, please report\n2\n(529*T^4 + 1)^8\n3\nPariError: bug in gerepile, significant pointers lost, please report\n4\nPariError: bug in gerepile, significant pointers lost, please report\n\nNow doing something naive along the way to clear the stack\n0\n(289*T^4 + 1)^8\n1\n(19*T^2 + 1)^16\n2\n(529*T^4 + 1)^8\n3\n(29*T^2 + 1)^16\n4\n(31*T^2 - 1)^16\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27236\n\n",
    "created_at": "2019-02-08T11:27:42Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Memory leak when factoring polynomials through pari",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26999",
    "user": "https://github.com/edgarcosta"
}
```
Keywords: factor, pari

When trying to factor some polynomials of degree 32, I observed a PariError, that seems to indicate that some pointers were lost.
Further, given that when can workaround this error by forcing `pari` to do something naive beforehand, I believe that is a memory leak. 
However, I'm not sure if the memory leak is in `pari` or `SAGE`'s integration.

Below follows the code how to recreate, and the work around mentioned above.

PS: Why the hell we raise a NotImplementedError in this situation?!? At least we should pass the original message!


```
ola = [[1, 0, 0, 0, 2312, 0, 0, 0, 2338588, 0, 0, 0, 1351703864, 0, 0, 0, 488303020870, 0, 0, 0, 112895658425144, 0, 0, 0, 16313422642433308, 0, 0, 0, 1347022612475207432, 0, 0, 0, 48661191875666868481L],
[1, 0, 304, 0, 43320, 0, 3841040, 0, 237184220, 0, 10815600432, 0, 376743415048, 0, 10225892694160, 0, 218578456337670, 0, 3691547262591760, 0, 49097578592470408, 0, 508829450867420592, 0, 4028233152700413020, 0, 23549670738863953040L, 0, 95880802293946094520L, 0, 242898032477996772784L, 0, 288441413567621167681L],
[1, 0, 0, 0, 4232, 0, 0, 0, 7835548, 0, 0, 0, 8290009784, 0, 0, 0, 5481768969670, 0, 0, 0, 2319884627964344, 0, 0, 0, 613609484096568988, 0, 0, 0, 92742690596309998472L, 0, 0, 0, 6132610415680998648961L],
[1, 0, 464, 0, 100920, 0, 13657840, 0, 1287251420, 0, 89592698832, 0, 4763345154568, 0, 197338584974960, 0, 6438171334808070, 0, 165961749963941360, 0, 3369023524268009608, 0, 53291826656603061072L, 0, 643942905433953654620L, 0, 5745952079256817225840L, 0, 35706987921095935617720L, 0, 138067019961570951055184L, 0, 250246473680347348787521L],
[1, 0, -496, 0, 115320, 0, -16682960, 0, 1680808220, 0, -125052131568, 0, 7107129477448, 0, -314744305429840, 0, 10976707651865670, 0, -302469277518076240, 0, 6563583322142254408, 0, -110984227083496301808L, 0, 1433546266495160565020L, 0, -13673825926569223850960L, 0, 90833272226495558438520L, 0, -375444191869514974879216L, 0, 727423121747185263828481L]];
for k in range(2):
    for i, v  in enumerate(ola):
        print i
        try:
            if k == 1:
                foo = PolynomialRing(ZZ, 'T')([1] + [0]*(len(ola[0]) - 2) + [1])._pari_with_name().factor()
            print PolynomialRing(ZZ, 'T')(v).factor()
        except NotImplementedError:
            # this goes down to pari
            try:
                PolynomialRing(ZZ, 'T')(v)._pari_with_name().factor()
            except PariError, err:
                print "PariError:", err
                irred_check = True
    else:
        if k == 0:
            print "\nNow doing something naive along the way to clear the stack"

Output: 
0
(289*T^4 + 1)^8
1
PariError: bug in gerepile, significant pointers lost, please report
2
(529*T^4 + 1)^8
3
PariError: bug in gerepile, significant pointers lost, please report
4
PariError: bug in gerepile, significant pointers lost, please report

Now doing something naive along the way to clear the stack
0
(289*T^4 + 1)^8
1
(19*T^2 + 1)^16
2
(529*T^4 + 1)^8
3
(29*T^2 + 1)^16
4
(31*T^2 - 1)^16
```


Issue created by migration from https://trac.sagemath.org/ticket/27236





---

archive/issue_comments_379706.json:
```json
{
    "body": "Which version of Sage is this?",
    "created_at": "2019-02-08T13:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379706",
    "user": "https://github.com/jdemeyer"
}
```

Which version of Sage is this?



---

archive/issue_comments_379707.json:
```json
{
    "body": "Never mind, confirmed with 8.7.beta2",
    "created_at": "2019-02-08T13:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379707",
    "user": "https://github.com/jdemeyer"
}
```

Never mind, confirmed with 8.7.beta2



---

archive/issue_comments_379708.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2019-02-08T13:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379708",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_379709.json:
```json
{
    "body": "I reproduced this in 8.3 through 8.6.\n\nThank for updating my description.\nI would like to still point out that if you insert the line\n\n```\nR([1] + [0]*14 + [1])._pari_with_name().factor() \n```\n\nbefore the other factor, then everything works fine.",
    "created_at": "2019-02-08T13:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379709",
    "user": "https://github.com/edgarcosta"
}
```

I reproduced this in 8.3 through 8.6.

Thank for updating my description.
I would like to still point out that if you insert the line

```
R([1] + [0]*14 + [1])._pari_with_name().factor() 
```

before the other factor, then everything works fine.



---

archive/issue_comments_379710.json:
```json
{
    "body": "Replying to [comment:6 edgarcosta]:\n> I reproduced this in 8.3 through 8.6.\n\nThanks for the info.\n\nMy feeling is that the method `_pari_with_name()` might be the problem, but I can't tell for sure.",
    "created_at": "2019-02-08T15:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379710",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 edgarcosta]:
> I reproduced this in 8.3 through 8.6.

Thanks for the info.

My feeling is that the method `_pari_with_name()` might be the problem, but I can't tell for sure.



---

archive/issue_comments_379711.json:
```json
{
    "body": "I can no longer reproduce this issue. I don't know what fixed it.",
    "created_at": "2019-03-04T07:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379711",
    "user": "https://github.com/jdemeyer"
}
```

I can no longer reproduce this issue. I don't know what fixed it.



---

archive/issue_comments_379712.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-03-04T11:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379712",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: worksforme



---

archive/issue_events_025065.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T11:24:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26999#event-25065"
}
```



---

archive/issue_comments_379713.json:
```json
{
    "body": "Set assignee to @edgarcosta.",
    "created_at": "2019-03-04T20:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379713",
    "user": "https://github.com/edgarcosta"
}
```

Set assignee to @edgarcosta.



---

archive/issue_comments_379714.json:
```json
{
    "body": "there is still a bug, in  version 8.7.beta6, release date: 2019-03-02.\n\nIf you try to take a list of the factors:\n\n```\nsage: ola = [[1, 0, 0, 0, 2312, 0, 0, 0, 2338588, 0, 0, 0, 1351703864, 0, 0, 0, 488303020870, 0, 0, 0, 112895658425144, 0, 0, 0, 16313422642433308, 0, 0, 0, 1347022612475207432, 0, 0, 0, 486611918756668\n....: 68481L],\n....: [1, 0, 304, 0, 43320, 0, 3841040, 0, 237184220, 0, 10815600432, 0, 376743415048, 0, 10225892694160, 0, 218578456337670, 0, 3691547262591760, 0, 49097578592470408, 0, 508829450867420592, 0, 4028233\n....: 152700413020, 0, 23549670738863953040L, 0, 95880802293946094520L, 0, 242898032477996772784L, 0, 288441413567621167681L]]\n....: R.<T> = ZZ[]\n....: for i, v  in enumerate(ola):\n....:     print(i)\n....:     list(R(v)._pari_with_name().factor())\n....:\n....:\n0\n[[289*x^4 + 1]~, [8]~]\n1\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n<ipython-input-5-0188888c9837> in <module>()\n      4 for i, v  in enumerate(ola):\n      5     print(i)\n----> 6     list(R(v)._pari_with_name().factor())\n      7\n      8\n\ncypari2/gen.pyx in cypari2.gen.Gen.factor()\n\ncypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()\n\nPariError: bug in gerepile, significant pointers lost, please report\n```\n",
    "created_at": "2019-03-04T20:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379714",
    "user": "https://github.com/edgarcosta"
}
```

there is still a bug, in  version 8.7.beta6, release date: 2019-03-02.

If you try to take a list of the factors:

```
sage: ola = [[1, 0, 0, 0, 2312, 0, 0, 0, 2338588, 0, 0, 0, 1351703864, 0, 0, 0, 488303020870, 0, 0, 0, 112895658425144, 0, 0, 0, 16313422642433308, 0, 0, 0, 1347022612475207432, 0, 0, 0, 486611918756668
....: 68481L],
....: [1, 0, 304, 0, 43320, 0, 3841040, 0, 237184220, 0, 10815600432, 0, 376743415048, 0, 10225892694160, 0, 218578456337670, 0, 3691547262591760, 0, 49097578592470408, 0, 508829450867420592, 0, 4028233
....: 152700413020, 0, 23549670738863953040L, 0, 95880802293946094520L, 0, 242898032477996772784L, 0, 288441413567621167681L]]
....: R.<T> = ZZ[]
....: for i, v  in enumerate(ola):
....:     print(i)
....:     list(R(v)._pari_with_name().factor())
....:
....:
0
[[289*x^4 + 1]~, [8]~]
1
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-5-0188888c9837> in <module>()
      4 for i, v  in enumerate(ola):
      5     print(i)
----> 6     list(R(v)._pari_with_name().factor())
      7
      8

cypari2/gen.pyx in cypari2.gen.Gen.factor()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: bug in gerepile, significant pointers lost, please report
```




---

archive/issue_comments_379715.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-03-05T09:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379715",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_events_025066.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-05T09:55:59Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26999#event-25066"
}
```



---

archive/issue_comments_379716.json:
```json
{
    "body": "Resolution changed from worksforme to ",
    "created_at": "2019-03-05T09:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379716",
    "user": "https://github.com/jdemeyer"
}
```

Resolution changed from worksforme to 



---

archive/issue_comments_379717.json:
```json
{
    "body": "Moving all blocker/critical issues from 8.7 to 8.8.",
    "created_at": "2019-03-25T10:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379717",
    "user": "https://github.com/embray"
}
```

Moving all blocker/critical issues from 8.7 to 8.8.



---

archive/issue_comments_379718.json:
```json
{
    "body": "OK, this fixes the problem on ##27778. Ready for review?\n----\nNew commits:",
    "created_at": "2019-05-06T11:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379718",
    "user": "https://github.com/dimpase"
}
```

OK, this fixes the problem on ##27778. Ready for review?
----
New commits:



---

archive/issue_comments_379719.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-06T11:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379719",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379720.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-06T13:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379720",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379721.json:
```json
{
    "body": "OK, thanks!",
    "created_at": "2019-05-06T13:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379721",
    "user": "https://github.com/dimpase"
}
```

OK, thanks!



---

archive/issue_events_025067.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-08T15:51:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26999#event-25067"
}
```



---

archive/issue_comments_379722.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-08T15:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26999#issuecomment-379722",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
