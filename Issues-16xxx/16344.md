# Issue 16344: Virtual rays of fans in non-saturated lattices

archive/issues_016107.json:
```json
{
    "body": "One can currently not compute the virtual rays of fans in non-saturated lattices:\n\n```\nsage: N = ToricLattice(1) \nsage: B = N.submodule([(2,)]).basis()\nsage: f = Fan([Cone([B[0]])])\nsage: f.virtual_rays()\nTraceback (most recent call last):\n...\nArithmeticError: cannot interpret [(1)] as a sublattice of Sublattice <N(2)>!\n```\n\nLastly, why should one even worry about this? Since `ToricDivisorGroup` inherits from `UniqueRepresentation`, it compares fans of newly created toric varieties with all fans in the cache. If one therefore has one malfunctioning fans, creating divisors in 'good' toric varieties will fail, too:\n\n```\nsage: N = ToricLattice(2) \nsage: B = N.submodule([(2,1), (1,2)]).basis()\nsage: f = Fan([Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])])\nsage: X = ToricVariety(f)\nsage: aK = -X.K()\n\nsage: B = N.submodule([(1,0), (1,1)]).basis()\nsage: B[0].parent() is B[0].parent().saturation()\nTrue\nsage: f2 = Fan([Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])])\nsage: X2 = ToricVariety(f2)\nsage: from sage.schemes.toric.divisor import ToricDivisorGroup\nsage: aK2 = -X2.K()\nArithmeticError: cannot interpret [(1, 2), (-1, -3)] as a sublattice of Sublattice <N(1, 2), N(0, 3)>!\n```\n\nCC:  @novoselt @vbraun\n\nKeywords: toric\n\nBranch/Commit: f567a24c9c9a6137f7e6274f54a0713e706c8e48\n\nReviewer: Andrey Novoseltsev\n\nAuthor: Jan Keitel\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16344\n\n",
    "closed_at": "2014-05-15T17:18:20Z",
    "created_at": "2014-05-13T09:10:01Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Virtual rays of fans in non-saturated lattices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16344",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```
One can currently not compute the virtual rays of fans in non-saturated lattices:

```
sage: N = ToricLattice(1) 
sage: B = N.submodule([(2,)]).basis()
sage: f = Fan([Cone([B[0]])])
sage: f.virtual_rays()
Traceback (most recent call last):
...
ArithmeticError: cannot interpret [(1)] as a sublattice of Sublattice <N(2)>!
```

Lastly, why should one even worry about this? Since `ToricDivisorGroup` inherits from `UniqueRepresentation`, it compares fans of newly created toric varieties with all fans in the cache. If one therefore has one malfunctioning fans, creating divisors in 'good' toric varieties will fail, too:

```
sage: N = ToricLattice(2) 
sage: B = N.submodule([(2,1), (1,2)]).basis()
sage: f = Fan([Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])])
sage: X = ToricVariety(f)
sage: aK = -X.K()

sage: B = N.submodule([(1,0), (1,1)]).basis()
sage: B[0].parent() is B[0].parent().saturation()
True
sage: f2 = Fan([Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])])
sage: X2 = ToricVariety(f2)
sage: from sage.schemes.toric.divisor import ToricDivisorGroup
sage: aK2 = -X2.K()
ArithmeticError: cannot interpret [(1, 2), (-1, -3)] as a sublattice of Sublattice <N(1, 2), N(0, 3)>!
```

CC:  @novoselt @vbraun

Keywords: toric

Branch/Commit: f567a24c9c9a6137f7e6274f54a0713e706c8e48

Reviewer: Andrey Novoseltsev

Author: Jan Keitel

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16344





---

archive/issue_comments_268319.json:
```json
{
    "body": "Changing commit from \"\" to \"3d68c50d064fc8cb32b12a4b6b3c744da49145a4\"",
    "created_at": "2014-05-13T09:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268319",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "3d68c50d064fc8cb32b12a4b6b3c744da49145a4"



---

archive/issue_comments_268320.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-13T09:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268321.json:
```json
{
    "body": "<a id='comment:2'></a>Here's the quick fix. Doctests in /geometry and in /schemes pass.",
    "created_at": "2014-05-13T09:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268321",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

<a id='comment:2'></a>Here's the quick fix. Doctests in /geometry and in /schemes pass.



---

archive/issue_comments_268322.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-13T09:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268322",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_268323.json:
```json
{
    "body": "<a id='comment:3'></a>Virtual rays should always work, so let's try to fix them! And fan in non-saturated lattices also should work, although it is technically trickier to construct a proper dual lattice (which should be a superlattice of the dual of saturation...)",
    "created_at": "2014-05-13T18:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268323",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:3'></a>Virtual rays should always work, so let's try to fix them! And fan in non-saturated lattices also should work, although it is technically trickier to construct a proper dual lattice (which should be a superlattice of the dual of saturation...)



---

archive/issue_comments_268324.json:
```json
{
    "body": "<a id='comment:4'></a>Hi Andrey,\n\nthanks again for taking a look. Well, fixing virtual rays would of course be better.  The line throwing an exception is\n\n```\nquotient = N.quotient(self.rays().matrix().saturation().rows())\n```\nsince there may be rows that aren't elements of N. A (dirty) possible solution that comes to mind is to instead take to quotient of the ambient module of N wrt to these elements and then take the submodule of that quotient lattice, i.e. something like this:\n\n```\nqp = N.ambient_module().quotient(self.rays().matrix().saturation().rows())\nquotient = qp.submodule(N.gens())\n```\nI'm afraid that that's probably something too naive/stupid and I'd be happy to hear why. :)\n\nBest,\nJan",
    "created_at": "2014-05-13T21:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268324",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

<a id='comment:4'></a>Hi Andrey,

thanks again for taking a look. Well, fixing virtual rays would of course be better.  The line throwing an exception is

```
quotient = N.quotient(self.rays().matrix().saturation().rows())
```
since there may be rows that aren't elements of N. A (dirty) possible solution that comes to mind is to instead take to quotient of the ambient module of N wrt to these elements and then take the submodule of that quotient lattice, i.e. something like this:

```
qp = N.ambient_module().quotient(self.rays().matrix().saturation().rows())
quotient = qp.submodule(N.gens())
```
I'm afraid that that's probably something too naive/stupid and I'd be happy to hear why. :)

Best,
Jan



---

archive/issue_comments_268325.json:
```json
{
    "body": "<a id='comment:5'></a>I think that's a fine solution - we really want to take the quotient of N by the vector space span of rays and then lift its generators to N.",
    "created_at": "2014-05-13T23:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268325",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:5'></a>I think that's a fine solution - we really want to take the quotient of N by the vector space span of rays and then lift its generators to N.



---

archive/issue_comments_268326.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-05-14T06:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268326",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_268327.json:
```json
{
    "body": "Changing commit from \"3d68c50d064fc8cb32b12a4b6b3c744da49145a4\" to \"f567a24c9c9a6137f7e6274f54a0713e706c8e48\"",
    "created_at": "2014-05-14T06:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268327",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3d68c50d064fc8cb32b12a4b6b3c744da49145a4" to "f567a24c9c9a6137f7e6274f54a0713e706c8e48"



---

archive/issue_comments_268328.json:
```json
{
    "body": "<a id='comment:7'></a>I've taken the liberty to force push the new changes, since we cannot do much with the old ones and I suppose it's very unlikely that anybody will have based their branch on them. The new branch does exactly what written above and I've changed the description of the ticket accordingly.\n\nThanks Andrey!",
    "created_at": "2014-05-14T06:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268328",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

<a id='comment:7'></a>I've taken the liberty to force push the new changes, since we cannot do much with the old ones and I suppose it's very unlikely that anybody will have based their branch on them. The new branch does exactly what written above and I've changed the description of the ticket accordingly.

Thanks Andrey!



---

archive/issue_comments_268329.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,23 +1,14 @@\n-Fan comparison does not work if one fan lives in a non-saturated sublattice (I hope that's the right term):\n+One can currently not compute the virtual rays of fans in non-saturated lattices:\n \n ```\n sage: N = ToricLattice(1) \n sage: B = N.submodule([(2,)]).basis()\n sage: f = Fan([Cone([B[0]])])\n-sage: B = N.submodule([(1,)]).basis()\n-sage: f2 = Fan([Cone([B[0]])])\n-sage: f == f2\n+sage: f.virtual_rays()\n Traceback (most recent call last):\n ...\n ArithmeticError: cannot interpret [(1)] as a sublattice of Sublattice <N(2)>!\n ```\n-\n-The reason is simply that\n-\n-```\n-sage: f.virtual_rays()\n-```\n-throws this exception. I don't know enough about fans to understand whether they can be made to work in such lattices, too, but it is also required in other places that the lattices for toric varieties be saturated anyway. Therefore I'am attaching a branch that catches this exception and does not compare the virtual rays of fans in such lattices, which seems to fix the problem.\n \n Lastly, why should one even worry about this? Since `ToricDivisorGroup` inherits from `UniqueRepresentation`, it compares fans of newly created toric varieties with all fans in the cache. If one therefore has one malfunctioning fans, creating divisors in 'good' toric varieties will fail, too:\n \n``````\n",
    "created_at": "2014-05-14T06:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268329",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkeitel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,23 +1,14 @@
-Fan comparison does not work if one fan lives in a non-saturated sublattice (I hope that's the right term):
+One can currently not compute the virtual rays of fans in non-saturated lattices:
 
 ```
 sage: N = ToricLattice(1) 
 sage: B = N.submodule([(2,)]).basis()
 sage: f = Fan([Cone([B[0]])])
-sage: B = N.submodule([(1,)]).basis()
-sage: f2 = Fan([Cone([B[0]])])
-sage: f == f2
+sage: f.virtual_rays()
 Traceback (most recent call last):
 ...
 ArithmeticError: cannot interpret [(1)] as a sublattice of Sublattice <N(2)>!
 ```
-
-The reason is simply that
-
-```
-sage: f.virtual_rays()
-```
-throws this exception. I don't know enough about fans to understand whether they can be made to work in such lattices, too, but it is also required in other places that the lattices for toric varieties be saturated anyway. Therefore I'am attaching a branch that catches this exception and does not compare the virtual rays of fans in such lattices, which seems to fix the problem.
 
 Lastly, why should one even worry about this? Since `ToricDivisorGroup` inherits from `UniqueRepresentation`, it compares fans of newly created toric varieties with all fans in the cache. If one therefore has one malfunctioning fans, creating divisors in 'good' toric varieties will fail, too:
 
``````




---

archive/issue_comments_268330.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Andrey Novoseltsev\"",
    "created_at": "2014-05-14T22:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268330",
    "user": "https://github.com/novoselt"
}
```

Changing reviewer from "" to "Andrey Novoseltsev"



---

archive/issue_comments_268331.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-14T22:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268331",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_268332.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-15T17:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268332",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048169.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-15T17:18:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16344#event-48169"
}
```



---

archive/issue_comments_268333.json:
```json
{
    "body": "Changing branch from \"u/jkeitel/fan_comparison_sublattice\" to \"f567a24c9c9a6137f7e6274f54a0713e706c8e48\"",
    "created_at": "2014-05-15T17:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-268333",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jkeitel/fan_comparison_sublattice" to "f567a24c9c9a6137f7e6274f54a0713e706c8e48"
