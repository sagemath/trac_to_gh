# Issue 16885: random failure with factorization of polynomials over finite fields

archive/issues_016648.json:
```json
{
    "assignees": [],
    "body": "Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below\n\n```\nsage: R = PolynomialRing(GF(3),'T')\nsage: for _ in xrange(5000):\n....:    p = R.random_element(degree=(2,8))\n....:    d = p.degree()\n....:    if d <= 2: continue\n....:    q = p.change_ring(GF(3**d, 'z'))\n....:    assert q.factor().prod() == q, \"problem with p={}\".format(p)\nTraceback (most recent call last):\n...\nAssertionError: problem with p=T^4 + T^2\n```\n\nYou can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains more precise output for the same tests.\n\nSee also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n\nCC:  @jpflori @vbraun\n\nKeywords: **random_fail**\n\nBranch/Commit: **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**\n\nReviewer: **Volker Braun**\n\nAuthor: **Jean-Pierre Flori**\n\nComponent: **commutative algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/16885_\n\n",
    "closed_at": "2014-09-16T18:47:20Z",
    "created_at": "2014-08-27T10:26:38Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "random failure with factorization of polynomials over finite fields",
    "type": "issue",
    "updated_at": "2014-09-16T18:47:20Z",
    "url": "https://github.com/sagemath/sage/issues/16885",
    "user": "https://github.com/videlec"
}
```
Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below

```
sage: R = PolynomialRing(GF(3),'T')
sage: for _ in xrange(5000):
....:    p = R.random_element(degree=(2,8))
....:    d = p.degree()
....:    if d <= 2: continue
....:    q = p.change_ring(GF(3**d, 'z'))
....:    assert q.factor().prod() == q, "problem with p={}".format(p)
Traceback (most recent call last):
...
AssertionError: problem with p=T^4 + T^2
```

You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains more precise output for the same tests.

See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).

CC:  @jpflori @vbraun

Keywords: **random_fail**

Branch/Commit: **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**

Reviewer: **Volker Braun**

Author: **Jean-Pierre Flori**

Component: **commutative algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/16885_





---

archive/issue_events_239212.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-08-27T10:26:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239212"
}
```



---

archive/issue_events_239213.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-08-27T10:26:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
    "label_color": "0000ff",
    "label_name": "c: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239213"
}
```



---

archive/issue_events_239214.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-08-27T10:26:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239214"
}
```



---

archive/issue_events_239215.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-08-27T10:26:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239215"
}
```



---

archive/issue_comments_222354.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[test_polynomials.py.gz](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz)**",
    "created_at": "2014-08-27T10:28:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222354",
    "user": "https://github.com/videlec"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[test_polynomials.py.gz](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz)**



---

archive/issue_comments_222355.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random in that field. See the attached test file for a precise function that realizes the bug.\n+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](http://trac.sagemath.org/raw-attachment/ticket/16885/test_polynomials.py) for a precise function in which the bug occurs.\n \n See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n``````\n",
    "created_at": "2014-08-27T10:28:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222355",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random in that field. See the attached test file for a precise function that realizes the bug.
+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](http://trac.sagemath.org/raw-attachment/ticket/16885/test_polynomials.py) for a precise function in which the bug occurs.
 
 See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).
``````




---

archive/issue_comments_222356.json:
```json
{
    "body": "Changed keywords from none to **random_fail**",
    "created_at": "2014-08-27T10:35:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222356",
    "user": "https://github.com/vbraun"
}
```

Changed keywords from none to **random_fail**



---

archive/issue_comments_222357.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](http://trac.sagemath.org/raw-attachment/ticket/16885/test_polynomials.py) for a precise function in which the bug occurs.\n+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) for a precise function in which the bug occurs.\n \n See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n``````\n",
    "created_at": "2014-08-27T10:45:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222357",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](http://trac.sagemath.org/raw-attachment/ticket/16885/test_polynomials.py) for a precise function in which the bug occurs.
+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) for a precise function in which the bug occurs.
 
 See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).
``````




---

archive/issue_comments_222358.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nCould you please describe the actual problem in the ticket description, preferably with a minimal example showing the bug.",
    "created_at": "2014-08-27T10:46:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222358",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Could you please describe the actual problem in the ticket description, preferably with a minimal example showing the bug.



---

archive/issue_comments_222359.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) for a precise function in which the bug occurs.\n+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below\n+\n+```\n+sage: for _ in xrange(5000):\n+....:    p = R.random_element(degree=(2,8))\n+....:    d = p.degree()\n+....:    if d <= 2: continue\n+....:    q = p.change_ring(GF(3**d, 'z'))\n+....:    assert q.factor().prod() == q, \"problem with p={}\".format(p)\n+Traceback (most recent call last):\n+...\n+AssertionError: problem with p=T^4 + T^2\n+```\n+\n+You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains some other tests.\n \n See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n``````\n",
    "created_at": "2014-08-27T10:57:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222359",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,17 @@
-Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field. See the attached [test file](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) for a precise function in which the bug occurs.
+Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below
+
+```
+sage: for _ in xrange(5000):
+....:    p = R.random_element(degree=(2,8))
+....:    d = p.degree()
+....:    if d <= 2: continue
+....:    q = p.change_ring(GF(3**d, 'z'))
+....:    assert q.factor().prod() == q, "problem with p={}".format(p)
+Traceback (most recent call last):
+...
+AssertionError: problem with p=T^4 + T^2
+```
+
+You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains some other tests.
 
 See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).
``````




---

archive/issue_comments_222360.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,7 @@\n Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below\n \n ```\n+sage: R = PolynomialRing(GF(3),'T')\n sage: for _ in xrange(5000):\n ....:    p = R.random_element(degree=(2,8))\n ....:    d = p.degree()\n@@ -12,6 +13,6 @@\n AssertionError: problem with p=T^4 + T^2\n ```\n \n-You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains some other tests.\n+You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains more precise output for the same tests.\n \n See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).\n``````\n",
    "created_at": "2014-08-27T11:07:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222360",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,7 @@
 Ticket #16681 pops up a strange error when doing factorization of polynomials over finite fields. The problem occurs when we repeatedly create finite fields of different degree and ask for factorization of some random polynomial in that field as in the example below
 
 ```
+sage: R = PolynomialRing(GF(3),'T')
 sage: for _ in xrange(5000):
 ....:    p = R.random_element(degree=(2,8))
 ....:    d = p.degree()
@@ -12,6 +13,6 @@
 AssertionError: problem with p=T^4 + T^2
 ```
 
-You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains some other tests.
+You can also have a look at the file [test_polynomials.py](https://github.com/sagemath/sage/files/ticket16885/test_polynomials.py.gz) which contains more precise output for the same tests.
 
 See also this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/pk36tDZIo0c).
``````




---

archive/issue_comments_222361.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHere is a little more detailed failure output:\n\n```\n<type 'list'> [0, Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 0, Mod(Mod(2, 3), Mod(1, 3)*\na^4 + Mod(2, 3)*a^3 + Mod(2, 3))]\n<type 'sage.libs.pari.gen.gen'> Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(\nMod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x\n<type 'sage.libs.pari.gen.gen'> [Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod\n(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + \nMod(2, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3\n))*x + Mod(Mod(2, 3)*a^3 + Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1]\n<type 'list'> [[Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^\n4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(\n1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +\n Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]~, [1, 1, 1, 1]~]\n<type 'sage.libs.pari.gen.gen'> Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^3 + Mod(\nMod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a\n^3 + Mod(2, 3))\nERROR (after 761 iterations):\n polynomial   : 2*T^4 + 2*T^2 + T\n polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2\n factorization: <class 'sage.structure.factorization.Factorization'>, (2) * T * (T + 1) * (T + 2*z^2 + 2*z + 1) * (T + z^3 + z^2 + 2)\n product      : <type 'sage.rings.polynomial.polynomial_zz_pex.Polynomial_ZZ_pEX'>, 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T\n product parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2\n product      : 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T\n```\nbasically printing what happens when PARI is called before the slightly modified Vincent output.\n\nAs you might see, the factorization at the end of the call to factor() in polynomial element is correct.\nMore precisely, the first two factors in the PARI factorization are the same as what we get back in Vincent's file in the Factorization object, but the third one Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +\n Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)) = T + 2*z<sup>3+z</sup>2 does not appear there and the fourth one becomes the third one.\nThe fourth one (T + 2*z^2 + 2*z + 1) in Sage's Factorizaiton object is mysterious (and different from the one which disappeared from PARI fac object.",
    "created_at": "2014-08-28T15:18:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222361",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:7" align="right">comment:7</div>

Here is a little more detailed failure output:

```
<type 'list'> [0, Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 0, Mod(Mod(2, 3), Mod(1, 3)*
a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]
<type 'sage.libs.pari.gen.gen'> Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(
Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x
<type 'sage.libs.pari.gen.gen'> [Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod
(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + 
Mod(2, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1; Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3
))*x + Mod(Mod(2, 3)*a^3 + Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), 1]
<type 'list'> [[Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^
4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(
1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)), Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +
 Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))]~, [1, 1, 1, 1]~]
<type 'sage.libs.pari.gen.gen'> Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^4 + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^3 + Mod(
Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x^2 + Mod(Mod(2, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(0, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a
^3 + Mod(2, 3))
ERROR (after 761 iterations):
 polynomial   : 2*T^4 + 2*T^2 + T
 polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2
 factorization: <class 'sage.structure.factorization.Factorization'>, (2) * T * (T + 1) * (T + 2*z^2 + 2*z + 1) * (T + z^3 + z^2 + 2)
 product      : <type 'sage.rings.polynomial.polynomial_zz_pex.Polynomial_ZZ_pEX'>, 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T
 product parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^4 + 2*x^3 + 2
 product      : 2*T^4 + (2*z^3 + z + 2)*T^3 + (2*z^3 + z^2 + z + 1)*T^2 + (z^2 + 1)*T
```
basically printing what happens when PARI is called before the slightly modified Vincent output.

As you might see, the factorization at the end of the call to factor() in polynomial element is correct.
More precisely, the first two factors in the PARI factorization are the same as what we get back in Vincent's file in the Factorization object, but the third one Mod(Mod(1, 3), Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3))*x + Mod(Mod(2, 3)*a^3 +
 Mod(2, 3)*a^2, Mod(1, 3)*a^4 + Mod(2, 3)*a^3 + Mod(2, 3)) = T + 2*z<sup>3+z</sup>2 does not appear there and the fourth one becomes the third one.
The fourth one (T + 2*z^2 + 2*z + 1) in Sage's Factorizaiton object is mysterious (and different from the one which disappeared from PARI fac object.



---

archive/issue_comments_222362.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nSomething wrong happens in:\n\n```\nF = [(R(f), int(e)) for f, e in zip(pols, exps)]\n```\nWith further debugging, it seems doing that without R and int is fine, and putting R and int breaks some values in the list.",
    "created_at": "2014-08-28T15:27:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222362",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:8" align="right">comment:8</div>

Something wrong happens in:

```
F = [(R(f), int(e)) for f, e in zip(pols, exps)]
```
With further debugging, it seems doing that without R and int is fine, and putting R and int breaks some values in the list.



---

archive/issue_comments_222363.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHere is one quite smallish example:\n\n```\n[(Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(2, 3)*a^2 + Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(2, 3)*a^2 + Mod(2, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(1, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1)]\n<type 'list'> [(T + z^3 + 2*z^2 + 1, 1), (T + z^3, 1), (T + z^4 + z^3 + z^2 + 2, 1), (T + 2*z^4 + 2*z^2 + 2*z, 1), (T + 2*z^4 + z^3 + z^2 + z, 1)]\n```\nand the ring/pol were:\n\n```\npolynomial   : T^5 + 2*T^4 + 1\n polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^5 + 2*x + 1\n factorization: <class 'sage.structure.factorization.Factorization'>, (T + z^3) * (T + z^3 + 2*z^2 + 1) * (T + z^4 + z^3 + z^2 + 2) * (T + 2*z^4 + 2*z^2 + 2*z) * (T + 2*z^4 + z^3 + z^2 + z)\n```\n}}}",
    "created_at": "2014-08-28T15:29:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222363",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:9" align="right">comment:9</div>

Here is one quite smallish example:

```
[(Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^3 + Mod(2, 3)*a^2 + Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(1, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(2, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(2, 3)*a^2 + Mod(2, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1), (Mod(Mod(1, 3), Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3))*x + Mod(Mod(2, 3)*a^4 + Mod(1, 3)*a^3 + Mod(1, 3)*a^2 + Mod(1, 3)*a, Mod(1, 3)*a^5 + Mod(2, 3)*a + Mod(1, 3)), 1)]
<type 'list'> [(T + z^3 + 2*z^2 + 1, 1), (T + z^3, 1), (T + z^4 + z^3 + z^2 + 2, 1), (T + 2*z^4 + 2*z^2 + 2*z, 1), (T + 2*z^4 + z^3 + z^2 + z, 1)]
```
and the ring/pol were:

```
polynomial   : T^5 + 2*T^4 + 1
 polynomial parent   : <class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>, x^5 + 2*x + 1
 factorization: <class 'sage.structure.factorization.Factorization'>, (T + z^3) * (T + z^3 + 2*z^2 + 1) * (T + z^4 + z^3 + z^2 + 2) * (T + 2*z^4 + 2*z^2 + 2*z) * (T + 2*z^4 + z^3 + z^2 + z)
```
}}}



---

archive/issue_comments_222364.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSimpler test without factor stuff:\n\n```\nwhile True:\n    d = ZZ.random_element(2,10)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    for i in xrange(10**4):\n        f = R.random_element()\n        if f != pari([c._pari_(\"a\") for c in R(pari(f))]).Polrev():\n            print f, pari(f), R(pari(f)), i\n            raise ValueError\n```\nDoes someone confirm failures with that one?",
    "created_at": "2014-08-28T16:21:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222364",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:10" align="right">comment:10</div>

Simpler test without factor stuff:

```
while True:
    d = ZZ.random_element(2,10)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    for i in xrange(10**4):
        f = R.random_element()
        if f != pari([c._pari_("a") for c in R(pari(f))]).Polrev():
            print f, pari(f), R(pari(f)), i
            raise ValueError
```
Does someone confirm failures with that one?



---

archive/issue_comments_222365.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jpflori](#comment%3A10):\n> Does someone confirm failures with that one?\n\nYes, got a failure as well. You might update the description of the ticket.\n\nVincent",
    "created_at": "2014-08-28T16:35:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222365",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jpflori](#comment%3A10):
> Does someone confirm failures with that one?

Yes, got a failure as well. You might update the description of the ticket.

Vincent



---

archive/issue_comments_222366.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI am also getting failures with the following variant:\n\n```python\nwhile True:\n    d = ZZ.random_element(2, 8)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    f = R.random_element()\n    pf = pari(f)\n    pfl = pf.list()\n    Kpfl = [K(c) for c in pfl]\n    Rf = R(Kpfl)\n    if f != Rf:\n        print f, pf, pfl, Kpfl, Rf\n        raise ValueError\n```\nThe values in one particularly simple case are as follows (applied `lift(lift(...))` to PARI objects to make them readable):\n\n```\nf = a^3*x^2 + (a^3 + 2*a^2 + a)*x\npf = a^3*x^2 + (a^3 + 2*a^2 + a)*x\npfl = [0, a^3 + 2*a^2 + a, a^3]\nKpfl = [0, a^3 + 2*a^2 + a, a^3]\nRf = a^3*x^2 + (2*a^2 + 2*a + 2)*x\n```\nEverything is consistent up to the conversion of `Kpfl` (the list of coefficients) to a polynomial, where the coefficient `a^3 + 2*a^2 + a` changes into `2*a^2 + 2*a + 2`.",
    "created_at": "2014-08-28T18:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222366",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:12" align="right">comment:12</div>

I am also getting failures with the following variant:

```python
while True:
    d = ZZ.random_element(2, 8)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    f = R.random_element()
    pf = pari(f)
    pfl = pf.list()
    Kpfl = [K(c) for c in pfl]
    Rf = R(Kpfl)
    if f != Rf:
        print f, pf, pfl, Kpfl, Rf
        raise ValueError
```
The values in one particularly simple case are as follows (applied `lift(lift(...))` to PARI objects to make them readable):

```
f = a^3*x^2 + (a^3 + 2*a^2 + a)*x
pf = a^3*x^2 + (a^3 + 2*a^2 + a)*x
pfl = [0, a^3 + 2*a^2 + a, a^3]
Kpfl = [0, a^3 + 2*a^2 + a, a^3]
Rf = a^3*x^2 + (2*a^2 + 2*a + 2)*x
```
Everything is consistent up to the conversion of `Kpfl` (the list of coefficients) to a polynomial, where the coefficient `a^3 + 2*a^2 + a` changes into `2*a^2 + 2*a + 2`.



---

archive/issue_comments_222367.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nHi Peter,\n\nJust to mention, using your code, we also get the fact that it works the second time\n\n```\nsage: while True:\n....:         d = ZZ.random_element(2, 8)\n....:         K = GF(3**d, 'a')\n....:         R = PolynomialRing(K, 'x')\n....:         f = R.random_element()\n....:         pf = pari(f)\n....:         pfl = pf.list()\n....:         Kpfl = [K(c) for c in pfl]\n....:         Rf = R(Kpfl)\n....:         if f != Rf:\n....:                 print f, pf, pfl, Kpfl, Rf\n....:                 raise ValueError\n<BOOM>\nsage: R(Kpfl) == f\nTrue\n```",
    "created_at": "2014-08-30T16:45:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222367",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>

Hi Peter,

Just to mention, using your code, we also get the fact that it works the second time

```
sage: while True:
....:         d = ZZ.random_element(2, 8)
....:         K = GF(3**d, 'a')
....:         R = PolynomialRing(K, 'x')
....:         f = R.random_element()
....:         pf = pari(f)
....:         pfl = pf.list()
....:         Kpfl = [K(c) for c in pfl]
....:         Rf = R(Kpfl)
....:         if f != Rf:
....:                 print f, pf, pfl, Kpfl, Rf
....:                 raise ValueError
<BOOM>
sage: R(Kpfl) == f
True
```



---

archive/issue_comments_222368.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe error occurs more precisely in the initialization of ` Polynomial_ZZ_pEX`. It can be tracked with the following modifications\n\n```\n--- a/src/sage/rings/polynomial/polynomial_zz_pex.pyx\n+++ b/src/sage/rings/polynomial/polynomial_zz_pex.pyx\n@@ -132,6 +132,7 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):\n             x = x.list()\n \n         if PY_TYPE_CHECK(x, list) or PY_TYPE_CHECK(x, tuple):\n+            y = x[:]\n             Polynomial.__init__(self, parent, is_gen=is_gen)\n             (<Polynomial_template>self)._cparent = get_cparent(parent)\n             celement_construct(&self.x, (<Polynomial_template>self)._cparent)\n@@ -143,6 +144,19 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):\n                 e = K(e)\n                 d = parent._modulus.ZZ_pE(list(e.polynomial()))\n                 ZZ_pEX_SetCoeff(self.x, i, d.x)\n+            while y and y[-1] == 0:\n+                y.pop(-1)\n+            if list(self) != y:\n+                print \"ERROR in Polynomial_ZZ_pEX constructor\"\n+                print \"call with args:\"\n+                print \"  x = {}\".format(x)\n+                print \"  check = {}\".format(check)\n+                print \"  is_gen = {}\".format(is_gen)\n+                print \"  construct = {}\".format(construct)\n+                print \"but got the result {}\".format(self)\n+                print \"variables\"\n+                print \"  K = {}\".format(K)\n+                raise RuntimeError\n             return\n```\nand running\n\n```\nwhile True:\n    d = ZZ.random_element(2, 8)\n    K = GF(3**d, 'a')\n    R = PolynomialRing(K, 'x')\n    f = R.random_element()\n    l = [K(c) for c in f._pari_().list()]\n    g = R(l)\n```\nI got the following kind of error\n\n```\nERROR in Polynomial_ZZ_pEX constructor\ncall with args:\n  x = [a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + a^4 + a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2]\n  check = True\n  is_gen = False\n  construct = False\nbut got the result (a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2)*x^2 + (2*a^5 + 2*a^4 + a^3 + a^2 + 2)*x + a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1\nvariables\n  K = Finite Field in a of size 3^7\n```\n\nMight be related or not:\n- if I replace `f._pari_().list()` with `list(f._pari_())` in the code above then the RAM just fill in few seconds\n- if I replace `f._pari_().list()` with `f.list()` then I do not see error anymore\n\nVincent",
    "created_at": "2014-08-30T18:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222368",
    "user": "https://github.com/videlec"
}
```

<div id="comment:14" align="right">comment:14</div>

The error occurs more precisely in the initialization of ` Polynomial_ZZ_pEX`. It can be tracked with the following modifications

```
--- a/src/sage/rings/polynomial/polynomial_zz_pex.pyx
+++ b/src/sage/rings/polynomial/polynomial_zz_pex.pyx
@@ -132,6 +132,7 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):
             x = x.list()
 
         if PY_TYPE_CHECK(x, list) or PY_TYPE_CHECK(x, tuple):
+            y = x[:]
             Polynomial.__init__(self, parent, is_gen=is_gen)
             (<Polynomial_template>self)._cparent = get_cparent(parent)
             celement_construct(&self.x, (<Polynomial_template>self)._cparent)
@@ -143,6 +144,19 @@ cdef class Polynomial_ZZ_pEX(Polynomial_template):
                 e = K(e)
                 d = parent._modulus.ZZ_pE(list(e.polynomial()))
                 ZZ_pEX_SetCoeff(self.x, i, d.x)
+            while y and y[-1] == 0:
+                y.pop(-1)
+            if list(self) != y:
+                print "ERROR in Polynomial_ZZ_pEX constructor"
+                print "call with args:"
+                print "  x = {}".format(x)
+                print "  check = {}".format(check)
+                print "  is_gen = {}".format(is_gen)
+                print "  construct = {}".format(construct)
+                print "but got the result {}".format(self)
+                print "variables"
+                print "  K = {}".format(K)
+                raise RuntimeError
             return
```
and running

```
while True:
    d = ZZ.random_element(2, 8)
    K = GF(3**d, 'a')
    R = PolynomialRing(K, 'x')
    f = R.random_element()
    l = [K(c) for c in f._pari_().list()]
    g = R(l)
```
I got the following kind of error

```
ERROR in Polynomial_ZZ_pEX constructor
call with args:
  x = [a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + a^4 + a^3 + 2*a^2 + 2*a + 1, a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2]
  check = True
  is_gen = False
  construct = False
but got the result (a^6 + 2*a^5 + 2*a^4 + 2*a^3 + a^2 + 2)*x^2 + (2*a^5 + 2*a^4 + a^3 + a^2 + 2)*x + a^5 + a^4 + 2*a^3 + 2*a^2 + 2*a + 1
variables
  K = Finite Field in a of size 3^7
```

Might be related or not:
- if I replace `f._pari_().list()` with `list(f._pari_())` in the code above then the RAM just fill in few seconds
- if I replace `f._pari_().list()` with `f.list()` then I do not see error anymore

Vincent



---

archive/issue_comments_222369.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI go a bit further and seems that the trouble comes from the initialization in the Sage NTL wrapper. More precisely, in the constructor of `Polynomial_ZZ_pEX` there is a problem in the following loop\n\n```\nfor i,e in enumerate(x):\n    # self(x) is supposed to be a conversion,\n    # not necessarily a coercion. So, we must\n    # not do K.coerce(e) but K(e).\n    e = K(e)\n    d = parent._modulus.ZZ_pE(list(e.polynomial()))\n    ZZ_pEX_SetCoeff(self.x, i, d.x)\n```\nWhen an error occurs the coefficient `list(e.polynomial())` is right but `d` is wrong. The mysterious `parent._modulus` is of class `ntl_ZZ_pEContext_class` in `libs/ntl/ntl_ZZ_pEContext.pyx`. The file is poorly documented and I do not know NTL enough to dig further.\n\nVincent",
    "created_at": "2014-08-31T10:20:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222369",
    "user": "https://github.com/videlec"
}
```

<div id="comment:15" align="right">comment:15</div>

I go a bit further and seems that the trouble comes from the initialization in the Sage NTL wrapper. More precisely, in the constructor of `Polynomial_ZZ_pEX` there is a problem in the following loop

```
for i,e in enumerate(x):
    # self(x) is supposed to be a conversion,
    # not necessarily a coercion. So, we must
    # not do K.coerce(e) but K(e).
    e = K(e)
    d = parent._modulus.ZZ_pE(list(e.polynomial()))
    ZZ_pEX_SetCoeff(self.x, i, d.x)
```
When an error occurs the coefficient `list(e.polynomial())` is right but `d` is wrong. The mysterious `parent._modulus` is of class `ntl_ZZ_pEContext_class` in `libs/ntl/ntl_ZZ_pEContext.pyx`. The file is poorly documented and I do not know NTL enough to dig further.

Vincent



---

archive/issue_comments_222370.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI suspected something with NTL and contexts wrongly restored at some point but did not investigate far enough and thought \"well it doesn't seem NTL is used that much in the problematic code, just PARI and factorization\".\nBut with your info it seems it might indeed be some problem with NTL contexts restoration (at the C++ level).\nI'll try to track it down.",
    "created_at": "2014-09-01T13:26:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222370",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:16" align="right">comment:16</div>

I suspected something with NTL and contexts wrongly restored at some point but did not investigate far enough and thought "well it doesn't seem NTL is used that much in the problematic code, just PARI and factorization".
But with your info it seems it might indeed be some problem with NTL contexts restoration (at the C++ level).
I'll try to track it down.



---

archive/issue_comments_222371.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nMight be something like #9524.\nThere we found out that the NTL context stuff for the polynomial defining the finite field was restored, but the context for the integer giving the characteristic was not.",
    "created_at": "2014-09-01T13:33:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222371",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:17" align="right">comment:17</div>

Might be something like #9524.
There we found out that the NTL context stuff for the polynomial defining the finite field was restored, but the context for the integer giving the characteristic was not.



---

archive/issue_events_239216.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2014-09-01T15:41:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239216"
}
```



---

archive/issue_comments_222372.json:
```json
{
    "body": "Branch: **[u/jpflori/ticket/16885](https://github.com/sagemath/sagetrac-mirror/tree/u/jpflori/ticket/16885)**",
    "created_at": "2014-09-01T15:41:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222372",
    "user": "https://github.com/jpflori"
}
```

Branch: **[u/jpflori/ticket/16885](https://github.com/sagemath/sagetrac-mirror/tree/u/jpflori/ticket/16885)**



---

archive/issue_comments_222373.json:
```json
{
    "body": "Commit: **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**",
    "created_at": "2014-09-01T15:41:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222373",
    "user": "https://github.com/jpflori"
}
```

Commit: **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**



---

archive/issue_comments_222374.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nIt seems adding a little contexts restoration helps solves this.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf\"><code>7a1c115</code></a></td><td><code>Perform additional contexts restoration for NTL.</code></td></tr></table>\n",
    "created_at": "2014-09-01T15:41:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222374",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:18" align="right">comment:18</div>

It seems adding a little contexts restoration helps solves this.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf"><code>7a1c115</code></a></td><td><code>Perform additional contexts restoration for NTL.</code></td></tr></table>




---

archive/issue_comments_222375.json:
```json
{
    "body": "Author: **Jean-Pierre Flori**",
    "created_at": "2014-09-01T15:41:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222375",
    "user": "https://github.com/jpflori"
}
```

Author: **Jean-Pierre Flori**



---

archive/issue_comments_222376.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nMaybe we should add a test, but it implies finding an easily and quickly reproducible test...\n\nFixing the typos I did would be nice as well :)",
    "created_at": "2014-09-01T15:53:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222376",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:19" align="right">comment:19</div>

Maybe we should add a test, but it implies finding an easily and quickly reproducible test...

Fixing the typos I did would be nice as well :)



---

archive/issue_comments_222377.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI don't think you need the `<ntl_ZZ_pX>` cast.",
    "created_at": "2014-09-01T16:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222377",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

I don't think you need the `<ntl_ZZ_pX>` cast.



---

archive/issue_comments_222378.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nYep, that's highly probable.\nI just got it from the previous snippet of code.",
    "created_at": "2014-09-01T18:37:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222378",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:21" align="right">comment:21</div>

Yep, that's highly probable.
I just got it from the previous snippet of code.



---

archive/issue_comments_222379.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2014-09-12T21:01:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222379",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_events_239217.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-12T21:01:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239217"
}
```



---

archive/issue_events_239218.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-12T21:01:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239218"
}
```



---

archive/issue_events_239219.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-16T18:47:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239219"
}
```



---

archive/issue_events_239220.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d947d40e9f820d12ccd381bb76213afcbe373bf8",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-09-16T18:47:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16885#event-239220"
}
```



---

archive/issue_comments_222380.json:
```json
{
    "body": "Changed branch from **[u/jpflori/ticket/16885](https://github.com/sagemath/sagetrac-mirror/tree/u/jpflori/ticket/16885)** to **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**",
    "created_at": "2014-09-16T18:47:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16885#issuecomment-222380",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jpflori/ticket/16885](https://github.com/sagemath/sagetrac-mirror/tree/u/jpflori/ticket/16885)** to **[`7a1c115`](https://github.com/sagemath/sagetrac-mirror/commit/7a1c11575b725d703557c3c285ab0a3754a3f8bf)**
