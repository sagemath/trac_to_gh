# Issue 16274: include system pkgconfig path

archive/issues_016037.json:
```json
{
    "body": "Here we actually use the system-wide `pkg-config` if present to query both Sage's as well as the system's package-config (`*.pc`) files.\n\nIf only Sage's `pkgconf` is available, `.pc` files (and hence the packages they belong to) installed outside of Sage still won't be seen by Sage's `pkg-config` wrapper script.\n\nIt is therefore still recommended to have a system-wide `pkg-config`, despite Sage now having its own, e.g. to let R use graphics packages Sage doesn't ship.\n\n\nKeywords: R cairo pango X11 graphics pkg-config\n\nBranch: [e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)\n\nReviewer: Leif Leonhardy\n\nAuthor: Volker Braun\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16274\n\n",
    "closed_at": "2014-05-04T13:56:17Z",
    "created_at": "2014-05-01T20:20:01Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "include system pkgconfig path",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16274",
    "user": "https://github.com/vbraun"
}
```
Here we actually use the system-wide `pkg-config` if present to query both Sage's as well as the system's package-config (`*.pc`) files.

If only Sage's `pkgconf` is available, `.pc` files (and hence the packages they belong to) installed outside of Sage still won't be seen by Sage's `pkg-config` wrapper script.

It is therefore still recommended to have a system-wide `pkg-config`, despite Sage now having its own, e.g. to let R use graphics packages Sage doesn't ship.


Keywords: R cairo pango X11 graphics pkg-config

Branch: [e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)

Reviewer: Leif Leonhardy

Author: Volker Braun

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16274





---

archive/issue_comments_270678.json:
```json
{
    "body": "Branch: [u/vbraun/include_system_pkgconfig_path](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/include_system_pkgconfig_path)",
    "created_at": "2014-05-01T21:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270678",
    "user": "https://github.com/vbraun"
}
```

Branch: [u/vbraun/include_system_pkgconfig_path](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/include_system_pkgconfig_path)



---

archive/issue_comments_270679.json:
```json
{
    "body": "Commit: [5e17a6e0b3e23bbc228a70437f2bb74dab58b63e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)",
    "created_at": "2014-05-01T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270679",
    "user": "https://github.com/vbraun"
}
```

Commit: [5e17a6e0b3e23bbc228a70437f2bb74dab58b63e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)



---

archive/issue_comments_270680.json:
```json
{
    "body": "Author: Volker Braun",
    "created_at": "2014-05-01T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270680",
    "user": "https://github.com/vbraun"
}
```

Author: Volker Braun



---

archive/issue_comments_270681.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-01T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270681",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270682.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|\n|[5e17a6e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)|`append system pgk-config search path`|",
    "created_at": "2014-05-01T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270682",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
|[5e17a6e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)|`append system pgk-config search path`|



---

archive/issue_comments_270683.json:
```json
{
    "body": "Changing commit from \"[5e17a6e0b3e23bbc228a70437f2bb74dab58b63e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)\" to \"[afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)\"",
    "created_at": "2014-05-01T22:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[5e17a6e0b3e23bbc228a70437f2bb74dab58b63e](https://github.com/sagemath/sagetrac-mirror/commit/5e17a6e0b3e23bbc228a70437f2bb74dab58b63e)" to "[afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)"



---

archive/issue_comments_270684.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|\n|[afcbfaf](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)|`reorder so we catch the right error`|",
    "created_at": "2014-05-01T22:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|
|[afcbfaf](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)|`reorder so we catch the right error`|



---

archive/issue_comments_270685.json:
```json
{
    "body": "<a id='comment:4'></a>\nWell, as mentioned on sage-devel,\n\n```sh\npkg-config --variable pc_path pkg-config\n```\ndoesn't work with all versions.\n\nI'd also try to grep the output of `pkg-config --debug` for `Scanning ...`.",
    "created_at": "2014-05-01T23:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270685",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:4'></a>
Well, as mentioned on sage-devel,

```sh
pkg-config --variable pc_path pkg-config
```
doesn't work with all versions.

I'd also try to grep the output of `pkg-config --debug` for `Scanning ...`.



---

archive/issue_comments_270686.json:
```json
{
    "body": "<a id='comment:5'></a>\n\n```sh\n$ pkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) printf(\"%s%s\",path[j],(j==i-1)?\"\\n\":\":\") }'\n/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig\n```\n\n:-)\n\nBut `awk` may be `gawk` or whatever...",
    "created_at": "2014-05-01T23:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270686",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>

```sh
$ pkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) printf("%s%s",path[j],(j==i-1)?"\n":":") }'
/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
```

:-)

But `awk` may be `gawk` or whatever...



---

archive/issue_comments_270687.json:
```json
{
    "body": "<a id='comment:6'></a>\nI think at this stage we should check if it works with other implementations of pkg-config. So far we are relying on it being a particular implementation if not version. As soon as my new build on power7 finishes I'll test the one currently shipping with sage.",
    "created_at": "2014-05-01T23:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270687",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>
I think at this stage we should check if it works with other implementations of pkg-config. So far we are relying on it being a particular implementation if not version. As soon as my new build on power7 finishes I'll test the one currently shipping with sage.



---

archive/issue_comments_270688.json:
```json
{
    "body": "<a id='comment:7'></a>\nMore portable `awk` version:\n\n```sh\npkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) if(j==i-1) printf(\"%s\\n\",path[j]); else printf(\"%s:\",path[j]) }'\n```",
    "created_at": "2014-05-02T00:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270688",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>
More portable `awk` version:

```sh
pkg-config --debug 2>&1 | awk '/^Scanning /{ path[i++]=substr($3,2,length($3)-2) } END{ for(j=0;j<i;j++) if(j==i-1) printf("%s\n",path[j]); else printf("%s:",path[j]) }'
```



---

archive/issue_comments_270689.json:
```json
{
    "body": "<a id='comment:8'></a>\nVersion we ship in sage doesn't have \"--debug\" so our best effort so far relies on any pkg-config out there being the freedesktop version which to fair is not a bad assumption. Do we know any distro not defaulting to that?",
    "created_at": "2014-05-02T00:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270689",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>
Version we ship in sage doesn't have "--debug" so our best effort so far relies on any pkg-config out there being the freedesktop version which to fair is not a bad assumption. Do we know any distro not defaulting to that?



---

archive/issue_comments_270690.json:
```json
{
    "body": "<a id='comment:9'></a>\nOf course after saying that I realised that in Gentoo I can switch to the BSD one if I want (but freedesktop is the default). I would imagine debian would be similar, freedesktop is the default but you have an alternative.\n\nThen again anyone savvy enough to use an alternative should be able to deal with the fall out.",
    "created_at": "2014-05-02T00:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270690",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:9'></a>
Of course after saying that I realised that in Gentoo I can switch to the BSD one if I want (but freedesktop is the default). I would imagine debian would be similar, freedesktop is the default but you have an alternative.

Then again anyone savvy enough to use an alternative should be able to deal with the fall out.



---

archive/issue_comments_270691.json:
```json
{
    "body": "<a id='comment:10'></a>\nOne issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.\n\n(Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)\n\nOr we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.",
    "created_at": "2014-05-02T00:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270691",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>
One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.

(Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)

Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.



---

archive/issue_comments_270692.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [leif](#comment%3A10):\n> One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.\n> \n> (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)\n> \n> Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.\n>  \n\nHave you read Volker's patch? One of the first thing he does is removing any pkg-config already installed in sage. \nSince we are interested in hardcoded path in the application doing \n\n```\nPKG_CONFIG_PATH=\"\" pkg-config .....\n```\nwould work.",
    "created_at": "2014-05-02T00:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270692",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>
Replying to [leif](#comment%3A10):
> One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.
> 
> (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)
> 
> Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.
>  

Have you read Volker's patch? One of the first thing he does is removing any pkg-config already installed in sage. 
Since we are interested in hardcoded path in the application doing 

```
PKG_CONFIG_PATH="" pkg-config .....
```
would work.



---

archive/issue_comments_270693.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [fbissey](#comment%3A11):\n> Replying to [leif](#comment%3A10):\n> > One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.\n> > \n> > (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)\n> > \n> > Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.\n> >  \n\n> Have you read Volker's patch?\n\nYes, a while ago though... m)\n\n> One of the first thing he does is removing any pkg-config already installed in sage.\n\n\nWell, \"the\" `pkg-config` if present.\n\n> Since we are interested in hardcoded path in the application doing \n> \n> ```\n> PKG_CONFIG_PATH=\"\" pkg-config .....\n> ```\n> would work.\n\n\nYep.  Or go with `(unset PKG_CONFIG_PATH; ...)`.",
    "created_at": "2014-05-02T00:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270693",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:12'></a>
Replying to [fbissey](#comment%3A11):
> Replying to [leif](#comment%3A10):
> > One issue still is that we have to call the system-wide `pkg-config` (if present) in `spkg-install`; I'd suggest to modify `sage-env` to save the original `PATH` in `SAGE_ORIG_PATH`, say.
> > 
> > (Otherwise we'd presumably at least accumulate folders upon reinstallation of Sage's `pkgconf`.)
> > 
> > Or we could first try to delete Sage's symlink from `pkg-config` to `pkgconf`.
> >  

> Have you read Volker's patch?

Yes, a while ago though... m)

> One of the first thing he does is removing any pkg-config already installed in sage.


Well, "the" `pkg-config` if present.

> Since we are interested in hardcoded path in the application doing 
> 
> ```
> PKG_CONFIG_PATH="" pkg-config .....
> ```
> would work.


Yep.  Or go with `(unset PKG_CONFIG_PATH; ...)`.



---

archive/issue_comments_270694.json:
```json
{
    "body": "<a id='comment:13'></a>\nFWIW, here's the `--debug` version with just `sed` (one line per folder):\n\n```sh\n$ pkg-config --debug 2>&1 | sed -n '/^Scanning /s/.*'\\''\\([^'\\'']*\\)'\\''/\\1/p'\n/usr/local/lib/pkgconfig\n/usr/lib/pkgconfig\n/usr/share/pkgconfig\n```",
    "created_at": "2014-05-02T01:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270694",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>
FWIW, here's the `--debug` version with just `sed` (one line per folder):

```sh
$ pkg-config --debug 2>&1 | sed -n '/^Scanning /s/.*'\''\([^'\'']*\)'\''/\1/p'
/usr/local/lib/pkgconfig
/usr/lib/pkgconfig
/usr/share/pkgconfig
```



---

archive/issue_comments_270695.json:
```json
{
    "body": "<a id='comment:14'></a>\nOne small problem:\n\nWhile older versions of `pkg-config` (such as 0.15.0) exit with a *non-zero* status when called with\n\n```sh\npkg-config --variable pc_path pkg-config\n```\nsome \"newer\" versions (still not supporting `pc_path`, such as 0.22) return 0 (and print a blank line).\n\nSo we cannot just check the exit code.",
    "created_at": "2014-05-02T10:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270695",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>
One small problem:

While older versions of `pkg-config` (such as 0.15.0) exit with a *non-zero* status when called with

```sh
pkg-config --variable pc_path pkg-config
```
some "newer" versions (still not supporting `pc_path`, such as 0.22) return 0 (and print a blank line).

So we cannot just check the exit code.



---

archive/issue_comments_270696.json:
```json
{
    "body": "Changing commit from \"[afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)\" to \"[ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)\"",
    "created_at": "2014-05-02T19:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270696",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d](https://github.com/sagemath/sagetrac-mirror/commit/afcbfaf2ebadbc81eec58cdc9060c1ae2be6c94d)" to "[ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)"



---

archive/issue_comments_270697.json:
```json
{
    "body": "<a id='comment:15'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[ef9b2fb](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)|`fallback to system pkg-config if necessary`|",
    "created_at": "2014-05-02T19:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270697",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[ef9b2fb](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)|`fallback to system pkg-config if necessary`|



---

archive/issue_comments_270698.json:
```json
{
    "body": "<a id='comment:16'></a>\nOk different approach. Instead of just creating a symlink \"pkg-config\", use a shell script that calls the system pkg-config if there is one.",
    "created_at": "2014-05-02T19:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270698",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
Ok different approach. Instead of just creating a symlink "pkg-config", use a shell script that calls the system pkg-config if there is one.



---

archive/issue_comments_270699.json:
```json
{
    "body": "<a id='comment:17'></a>\nHmmm, that way broken `pkg-config` installations (seen on Darwin) aren't (or can't be) cured.\n\nAnyway, why `/bin/sh`?\n\ns/`\"pkg-config\" binary`/`\"pkg-config\" script`/\n\nYou'd have to change the error message (in case `m4` failed) accordingly.",
    "created_at": "2014-05-02T19:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270699",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:17'></a>
Hmmm, that way broken `pkg-config` installations (seen on Darwin) aren't (or can't be) cured.

Anyway, why `/bin/sh`?

s/`"pkg-config" binary`/`"pkg-config" script`/

You'd have to change the error message (in case `m4` failed) accordingly.



---

archive/issue_comments_270700.json:
```json
{
    "body": "<a id='comment:18'></a>\nAlso, `PKG_CONFIG_PATH` gets *overwritten*.  (We already treat it correctly in `sage-env`, *pre*pending Sage's folders in case it's already set/non-empty.)",
    "created_at": "2014-05-02T19:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270700",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:18'></a>
Also, `PKG_CONFIG_PATH` gets *overwritten*.  (We already treat it correctly in `sage-env`, *pre*pending Sage's folders in case it's already set/non-empty.)



---

archive/issue_comments_270701.json:
```json
{
    "body": "<a id='comment:19'></a>\nIt's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.\n\n(I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)",
    "created_at": "2014-05-02T19:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270701",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:19'></a>
It's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.

(I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)



---

archive/issue_comments_270702.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [leif](#comment%3A19):\n> It's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.\n> \n> (I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)\n\n\nHmmm, the only difference I see on a MacOS X system without a system-wide `pkg-config` is:\n\n```\n92c92\n< checking for pkg-config... no\n---\n> checking for pkg-config... /Users/leif/Sage/sage-6.2.beta7/local/bin/pkg-config\n497c497,498\n< configure: not checking for cairo as pkg-config is not present\n---\n> checking whether pkg-config knows about cairo and pango... no\n> checking whether pkg-config knows about cairo... no\n```\n\nSo apparently R does rely on `pkg-config`, and *doesn't* try to find libraries / packages by other means if there's no `pkg-config` at all.\n\nStill, it would be best to tell `pkgconf` also which *system folders* to search (in case there's no system-wide `pkg-config`), but that's even more kind of reinventing the wheel; the by far easiest (and IMHO most straight-forward) solution is to just make `pkg-config` a Sage prerequisite.  (IIRC there are pre-built binaries available for MacOS X as well; Linux and SunOS aren't a problem either.)",
    "created_at": "2014-05-02T21:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270702",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>
Replying to [leif](#comment%3A19):
> It's also unclear to me whether that solves problems with R (?) on systems where there isn't a system-wide `pkg-config`.
> 
> (I guess if R sees there's a `pkg-config`, it relies on it, and only otherwise tries to find libraries by itself.  But that's just a guess, and it's probably up to the Darwinist reviewers to check that...)


Hmmm, the only difference I see on a MacOS X system without a system-wide `pkg-config` is:

```
92c92
< checking for pkg-config... no
---
> checking for pkg-config... /Users/leif/Sage/sage-6.2.beta7/local/bin/pkg-config
497c497,498
< configure: not checking for cairo as pkg-config is not present
---
> checking whether pkg-config knows about cairo and pango... no
> checking whether pkg-config knows about cairo... no
```

So apparently R does rely on `pkg-config`, and *doesn't* try to find libraries / packages by other means if there's no `pkg-config` at all.

Still, it would be best to tell `pkgconf` also which *system folders* to search (in case there's no system-wide `pkg-config`), but that's even more kind of reinventing the wheel; the by far easiest (and IMHO most straight-forward) solution is to just make `pkg-config` a Sage prerequisite.  (IIRC there are pre-built binaries available for MacOS X as well; Linux and SunOS aren't a problem either.)



---

archive/issue_comments_270703.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[46451c7](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)|`fix permisions, reviewer patches`|",
    "created_at": "2014-05-02T22:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[46451c7](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)|`fix permisions, reviewer patches`|



---

archive/issue_comments_270704.json:
```json
{
    "body": "Changing commit from \"[ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)\" to \"[46451c79837606eb6a4e01249c751c3be20426cb](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)\"",
    "created_at": "2014-05-02T22:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270704",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3](https://github.com/sagemath/sagetrac-mirror/commit/ef9b2fb4529b6ce007f3b1d96dd8ecb968ae2ee3)" to "[46451c79837606eb6a4e01249c751c3be20426cb](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)"



---

archive/issue_comments_270705.json:
```json
{
    "body": "Reviewer: Leif Leonhardy",
    "created_at": "2014-05-02T22:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270705",
    "user": "https://github.com/nexttime"
}
```

Reviewer: Leif Leonhardy



---

archive/issue_comments_270706.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [git](#comment%3A21):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                          |                                  |\n> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n> |[46451c7](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)|`fix permisions, reviewer patches`|\n\n\nIn the generated script, we have to export the env vars.",
    "created_at": "2014-05-02T22:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270706",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:22'></a>
Replying to [git](#comment%3A21):
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                          |                                  |
> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
> |[46451c7](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)|`fix permisions, reviewer patches`|


In the generated script, we have to export the env vars.



---

archive/issue_comments_270707.json:
```json
{
    "body": "<a id='comment:23'></a>\nI still wonder whether we should install our `pkg-config` at all if a system-wide one is already present (as William suggested, i.e., don't install it in that case), unless perhaps `SAGE_INSTALL_PKGCONFIG=yes`.  (I know you do like such environment variables very much.)\n\nIn the latter (hopefully rarely used or hardly necessary) case, we might even run something like\n\n```sh\npc_folders_to_search=`find / -name \\*.pc -exec dirname {} \\; 2>/dev/null | sort -u`\n```\n(probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).",
    "created_at": "2014-05-02T22:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270707",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:23'></a>
I still wonder whether we should install our `pkg-config` at all if a system-wide one is already present (as William suggested, i.e., don't install it in that case), unless perhaps `SAGE_INSTALL_PKGCONFIG=yes`.  (I know you do like such environment variables very much.)

In the latter (hopefully rarely used or hardly necessary) case, we might even run something like

```sh
pc_folders_to_search=`find / -name \*.pc -exec dirname {} \; 2>/dev/null | sort -u`
```
(probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).



---

archive/issue_comments_270708.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [leif](#comment%3A23):\n> In the latter (hopefully rarely used or hardly necessary) case, we might even run something like\n> \n> ```\n> #!sh\n> pc_folders_to_search=`find / -name \\*.pc -exec dirname {} \\; 2>/dev/null | sort -u`\n> ```\n> (probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).\n\n\n**Once**, upon installation, of course; putting the result somewhere into `local/var/lib/...`.",
    "created_at": "2014-05-02T22:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270708",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:24'></a>
Replying to [leif](#comment%3A23):
> In the latter (hopefully rarely used or hardly necessary) case, we might even run something like
> 
> ```
> #!sh
> pc_folders_to_search=`find / -name \*.pc -exec dirname {} \; 2>/dev/null | sort -u`
> ```
> (probably limiting the root folder(s) to the usual suspectives, depending on the OS, and excluding [unrelated] Sage folders).


**Once**, upon installation, of course; putting the result somewhere into `local/var/lib/...`.



---

archive/issue_comments_270709.json:
```json
{
    "body": "<a id='comment:25'></a>\nIMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.\n\nJust searching all directories is wrong, this would find cross-compile toolchains etc.",
    "created_at": "2014-05-02T22:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270709",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>
IMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.

Just searching all directories is wrong, this would find cross-compile toolchains etc.



---

archive/issue_comments_270710.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------|\n|[afe001f](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)|`export variables`|",
    "created_at": "2014-05-02T22:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270710",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                  |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------|
|[afe001f](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)|`export variables`|



---

archive/issue_comments_270711.json:
```json
{
    "body": "Changing commit from \"[46451c79837606eb6a4e01249c751c3be20426cb](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)\" to \"[afe001f27290963db4fffd47d4dbd83a46247a13](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)\"",
    "created_at": "2014-05-02T22:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[46451c79837606eb6a4e01249c751c3be20426cb](https://github.com/sagemath/sagetrac-mirror/commit/46451c79837606eb6a4e01249c751c3be20426cb)" to "[afe001f27290963db4fffd47d4dbd83a46247a13](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)"



---

archive/issue_comments_270712.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [vbraun](#comment%3A25):\n> IMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.\n> \n> Just searching all directories is wrong, this would find cross-compile toolchains etc.\n\n\nSure, but we should recommend to install a system-wide version, and probably document `PKG_CONFIG_PATH` even for those who don't have one.  (But that IMHO doesn't have to happen here and now.)\n\n(I think unfortunately nobody reads the output of Sage's `configure` unless it bails out, so we'd have to document that elsewhere, or use `sleep`... ;-) )",
    "created_at": "2014-05-02T23:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270712",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:27'></a>
Replying to [vbraun](#comment%3A25):
> IMHO its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.
> 
> Just searching all directories is wrong, this would find cross-compile toolchains etc.


Sure, but we should recommend to install a system-wide version, and probably document `PKG_CONFIG_PATH` even for those who don't have one.  (But that IMHO doesn't have to happen here and now.)

(I think unfortunately nobody reads the output of Sage's `configure` unless it bails out, so we'd have to document that elsewhere, or use `sleep`... ;-) )



---

archive/issue_comments_270713.json:
```json
{
    "body": "<a id='comment:28'></a>\nI like the fact that you ended up moving a bit of sage-env in the script. As for the configure script, it should bail out if a hard requirement is not met that's part of its function. \n\nI agree with Volker that scanning for .pc is a bad idea, apart from his reasons it can take ages, especially if you have nfs share mounted. I certainly would not want to try that on my power7 cluster which has 170TB of space on a remote file system.\n\nI thought we could have gone gcc (spkg that is) style on this one, William's idea really. But I am fine with the proposed solution.",
    "created_at": "2014-05-03T01:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270713",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:28'></a>
I like the fact that you ended up moving a bit of sage-env in the script. As for the configure script, it should bail out if a hard requirement is not met that's part of its function. 

I agree with Volker that scanning for .pc is a bad idea, apart from his reasons it can take ages, especially if you have nfs share mounted. I certainly would not want to try that on my power7 cluster which has 170TB of space on a remote file system.

I thought we could have gone gcc (spkg that is) style on this one, William's idea really. But I am fine with the proposed solution.



---

archive/issue_comments_270714.json:
```json
{
    "body": "<a id='comment:29'></a>\nHmm `PKG_CONFIG_LIBDIR` also has the effect of not searching the compiled-in default path any more, removed.\n\nI've added a `spkg-check` that will try to find the system pc files if we can guess their location.",
    "created_at": "2014-05-03T08:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270714",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>
Hmm `PKG_CONFIG_LIBDIR` also has the effect of not searching the compiled-in default path any more, removed.

I've added a `spkg-check` that will try to find the system pc files if we can guess their location.



---

archive/issue_comments_270715.json:
```json
{
    "body": "Changing commit from \"[afe001f27290963db4fffd47d4dbd83a46247a13](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)\" to \"[0afd5c5aaaf349c4314c5067800924c24a9e2713](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)\"",
    "created_at": "2014-05-03T08:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[afe001f27290963db4fffd47d4dbd83a46247a13](https://github.com/sagemath/sagetrac-mirror/commit/afe001f27290963db4fffd47d4dbd83a46247a13)" to "[0afd5c5aaaf349c4314c5067800924c24a9e2713](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)"



---

archive/issue_comments_270716.json:
```json
{
    "body": "<a id='comment:30'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[0afd5c5](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)|`fix search path, add tests`|",
    "created_at": "2014-05-03T08:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270716",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[0afd5c5](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)|`fix search path, add tests`|



---

archive/issue_comments_270717.json:
```json
{
    "body": "<a id='comment:31'></a>\nHmmm, for whatever reason (shell caching I presume), I end up in an infinite loop.\n\nAlthough `$SAGE_LOCAL/bin/pkg-config` gets deleted right before `m4` is called, `command -v pkg-config` apparently still gives `$SAGE_LOCAL/bin/pkg-config`, such that the script finally calls itself...\n\nFWIW,\n\n```sh\n$ bash --version\nGNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)\nCopyright (C) 2009 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\n```\n\n(I've run into similar a couple of times; the shell doesn't \"see\" freshly installed programs immediately.)\n\nSo it'd probably be better to call `PATH=\"$SAGE_ORIG_PATH\" command -v pkg-config` (modifying `sage-env` accordingly, i.e., saving the original `PATH`).",
    "created_at": "2014-05-03T14:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270717",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:31'></a>
Hmmm, for whatever reason (shell caching I presume), I end up in an infinite loop.

Although `$SAGE_LOCAL/bin/pkg-config` gets deleted right before `m4` is called, `command -v pkg-config` apparently still gives `$SAGE_LOCAL/bin/pkg-config`, such that the script finally calls itself...

FWIW,

```sh
$ bash --version
GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
```

(I've run into similar a couple of times; the shell doesn't "see" freshly installed programs immediately.)

So it'd probably be better to call `PATH="$SAGE_ORIG_PATH" command -v pkg-config` (modifying `sage-env` accordingly, i.e., saving the original `PATH`).



---

archive/issue_comments_270718.json:
```json
{
    "body": "<a id='comment:32'></a>\nAh, yes:\n\n```\n       If  the name is neither a shell function nor a builtin, and contains no\n       slashes, bash searches each element of the PATH for  a  directory  con\u2010\n       taining  an  executable  file  by that name.  Bash uses a hash table to\n       remember the full pathnames of executable files (see hash  under  SHELL\n       BUILTIN  COMMANDS  below).  A full search of the directories in PATH is\n       performed only if the command is not found in the hash table. [...]\n```\n(And subshells inherit the cache.)\n\n\n\n\n```diff\ndiff --git a/build/pkgs/pkgconf/spkg-install b/build/pkgs/pkgconf/spkg-install\nindex e31009b..166008e 100755\n--- a/build/pkgs/pkgconf/spkg-install\n+++ b/build/pkgs/pkgconf/spkg-install\n@@ -38,8 +38,17 @@ if [ $? -ne 0 ]; then\n fi\n \n # pkgconf is an alternative to the \"official\" pkg-config, and does not\n-# automatically install a \"pkg-config\" binary.\n-rm -f \"$SAGE_LOCAL/bin/pkg-config\"   # delete old version\n+# automatically install a \"pkg-config\" binary, so we used to install\n+# a symbolic link (now replaced by a wrapper script).\n+rm -f \"$SAGE_LOCAL/bin/pkg-config\"   # delete old version (script or symlink)\n+\n+# Let bash forget where it previously saw 'pkg-config', otherwise we might\n+# end up in an infinite loop if 'command -v pkg-config' gives Sage's script,\n+# such that the below generated script finally calls itself:\n+builtin hash -d pkg-config 2>/dev/null\n+\n+# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-\n+# wide 'pkg-config' if present (hardcoding its location at creation time):\n m4 ../patches/pkg-config.in > \"$SAGE_LOCAL/bin/pkg-config\"\n if [ $? -ne 0 ]; then\n     echo >&2 \"Error creating the pkg-config script.\"\n```\ndoesn't yet work for me...",
    "created_at": "2014-05-03T15:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270718",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:32'></a>
Ah, yes:

```
       If  the name is neither a shell function nor a builtin, and contains no
       slashes, bash searches each element of the PATH for  a  directory  con
       taining  an  executable  file  by that name.  Bash uses a hash table to
       remember the full pathnames of executable files (see hash  under  SHELL
       BUILTIN  COMMANDS  below).  A full search of the directories in PATH is
       performed only if the command is not found in the hash table. [...]
```
(And subshells inherit the cache.)




```diff
diff --git a/build/pkgs/pkgconf/spkg-install b/build/pkgs/pkgconf/spkg-install
index e31009b..166008e 100755
--- a/build/pkgs/pkgconf/spkg-install
+++ b/build/pkgs/pkgconf/spkg-install
@@ -38,8 +38,17 @@ if [ $? -ne 0 ]; then
 fi
 
 # pkgconf is an alternative to the "official" pkg-config, and does not
-# automatically install a "pkg-config" binary.
-rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version
+# automatically install a "pkg-config" binary, so we used to install
+# a symbolic link (now replaced by a wrapper script).
+rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version (script or symlink)
+
+# Let bash forget where it previously saw 'pkg-config', otherwise we might
+# end up in an infinite loop if 'command -v pkg-config' gives Sage's script,
+# such that the below generated script finally calls itself:
+builtin hash -d pkg-config 2>/dev/null
+
+# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-
+# wide 'pkg-config' if present (hardcoding its location at creation time):
 m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
 if [ $? -ne 0 ]; then
     echo >&2 "Error creating the pkg-config script."
```
doesn't yet work for me...



---

archive/issue_comments_270719.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-03T15:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270719",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_270720.json:
```json
{
    "body": "<a id='comment:33'></a>\nAh, no, it's even weirder...  Take a *close* look at\n\n```sh\nm4 ../patches/pkg-config.in > \"$SAGE_LOCAL/bin/pkg-config\"\n```\n\nGuess what happens...",
    "created_at": "2014-05-03T15:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270720",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:33'></a>
Ah, no, it's even weirder...  Take a *close* look at

```sh
m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
```

Guess what happens...



---

archive/issue_comments_270721.json:
```json
{
    "body": "<a id='comment:34'></a>\n... although it shouldn't be executable yet (but that also depends on the umask).",
    "created_at": "2014-05-03T15:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270721",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:34'></a>
... although it shouldn't be executable yet (but that also depends on the umask).



---

archive/issue_comments_270722.json:
```json
{
    "body": "<a id='comment:35'></a>\nHmmm, now works for me with\n\n```diff\ndiff --git a/build/pkgs/pkgconf/patches/pkg-config.in b/build/pkgs/pkgconf/patches/pkg-config.in\nindex ccda223..4a00741 100644\n--- a/build/pkgs/pkgconf/patches/pkg-config.in\n+++ b/build/pkgs/pkgconf/patches/pkg-config.in\n@@ -14,5 +14,5 @@ fi\n dnl Launch system pkg-config or our own pkgconf\n define(NEWLINE,`\n ')\n-define(PKG_CONFIG_COMMAND, translit(esyscmd(`command -v pkg-config'), NEWLINE))\n+define(PKG_CONFIG_COMMAND, translit(esyscmd(`bash -c \"command -v pkg-config\"'), NEWLINE))\n exec ifelse(sysval, `0', PKG_CONFIG_COMMAND, `\"$SAGE_LOCAL/bin/pkgconf\"') \"$@\"\n```\n(and the \"forget\" as before).",
    "created_at": "2014-05-03T15:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270722",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:35'></a>
Hmmm, now works for me with

```diff
diff --git a/build/pkgs/pkgconf/patches/pkg-config.in b/build/pkgs/pkgconf/patches/pkg-config.in
index ccda223..4a00741 100644
--- a/build/pkgs/pkgconf/patches/pkg-config.in
+++ b/build/pkgs/pkgconf/patches/pkg-config.in
@@ -14,5 +14,5 @@ fi
 dnl Launch system pkg-config or our own pkgconf
 define(NEWLINE,`
 ')
-define(PKG_CONFIG_COMMAND, translit(esyscmd(`command -v pkg-config'), NEWLINE))
+define(PKG_CONFIG_COMMAND, translit(esyscmd(`bash -c "command -v pkg-config"'), NEWLINE))
 exec ifelse(sysval, `0', PKG_CONFIG_COMMAND, `"$SAGE_LOCAL/bin/pkgconf"') "$@"
```
(and the "forget" as before).



---

archive/issue_comments_270723.json:
```json
{
    "body": "<a id='comment:36'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[4067e95](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)|`avoid potential race when creating pkg-config`|",
    "created_at": "2014-05-03T16:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[4067e95](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)|`avoid potential race when creating pkg-config`|



---

archive/issue_comments_270724.json:
```json
{
    "body": "Changing commit from \"[0afd5c5aaaf349c4314c5067800924c24a9e2713](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)\" to \"[4067e95b238af02153264658e848ef8f630e0932](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)\"",
    "created_at": "2014-05-03T16:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270724",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[0afd5c5aaaf349c4314c5067800924c24a9e2713](https://github.com/sagemath/sagetrac-mirror/commit/0afd5c5aaaf349c4314c5067800924c24a9e2713)" to "[4067e95b238af02153264658e848ef8f630e0932](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)"



---

archive/issue_comments_270725.json:
```json
{
    "body": "<a id='comment:37'></a>\nI have no idea what's going on here; with\n\n```sh\n# pkgconf is an alternative to the \"official\" pkg-config, and does not\n# automatically install a \"pkg-config\" binary, so we used to install\n# a symbolic link (now replaced by a wrapper script).\nrm -f \"$SAGE_LOCAL/bin/pkg-config\"   # delete old version (script or symlink)\n\necho M4, shell\\:\nm4 <<\"EOF\"\ntranslit(esyscmd(`command -v pkg-config'),`')\nEOF\necho M4, bash\\:\nm4 <<\"EOF\"\ntranslit(esyscmd(`bash -c \"command -v pkg-config\"'),`')\nEOF\n\n# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-\n# wide 'pkg-config' if present (hardcoding its location at creation time):\nm4 ../patches/pkg-config.in > \"$SAGE_LOCAL/bin/pkg-config\"\nif [ $? -ne 0 ]; then\n    echo >&2 \"Error creating the pkg-config script.\"\n    exit 1\nfi\n\necho Generated script:\necho =================\ncat \"$SAGE_LOCAL/bin/pkg-config\"\necho =================\n\nchmod 755 \"$SAGE_LOCAL/bin/pkg-config\"\n```\n(and without `bash -c ...` in `pkg-config.in`), I'm always getting:\n\n```\n...\n/usr/bin/install -c -m 644 ./pkgconf.1 /foo/local/share/man/man1/pkgconf.1\nM4, shell:\n/usr/bin/pkg-config\n\nM4, bash:\n/usr/bin/pkg-config\n\nGenerated script:\n=================\n#!/usr/bin/env bash\n\nif [ -z \"$SAGE_LOCAL\" ]; then\n    echo >&2 \"This script requires that SAGE_LOCAL is set.\"\n    exit 1\nfi  \n\nif [ -z \"$PKG_CONFIG_PATH\" ]; then\n    export PKG_CONFIG_PATH=\"$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig\"\nelse\n    export PKG_CONFIG_PATH=\"$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH\"\nfi\n\n\n\nexec /foo/local/bin/pkg-config \"$@\"\n=================\n\nreal\t0m14.221s\nuser\t0m1.716s\nsys\t0m0.572s\nSuccessfully installed pkgconf-0.9.4\nRunning the test suite for pkgconf-0.9.4...\n+-- /usr/lib/pkgconfig found, using it for the pkg-config test.\n    +-- fontconfig found, using it for the pkg-config test.\n/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Argument list too long\n/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Success\nOur pkg-config script failed to pick up fontconfig\n\nreal\t0m8.012s\nuser\t0m3.568s\nsys\t0m1.916s\n************************************************************************\nError testing package pkgconf-0.9.4\n************************************************************************\n...\n```",
    "created_at": "2014-05-03T16:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270725",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:37'></a>
I have no idea what's going on here; with

```sh
# pkgconf is an alternative to the "official" pkg-config, and does not
# automatically install a "pkg-config" binary, so we used to install
# a symbolic link (now replaced by a wrapper script).
rm -f "$SAGE_LOCAL/bin/pkg-config"   # delete old version (script or symlink)

echo M4, shell\:
m4 <<"EOF"
translit(esyscmd(`command -v pkg-config'),`')
EOF
echo M4, bash\:
m4 <<"EOF"
translit(esyscmd(`bash -c "command -v pkg-config"'),`')
EOF

# Generate a wrapper script which either calls Sage's 'pkgconf' or a system-
# wide 'pkg-config' if present (hardcoding its location at creation time):
m4 ../patches/pkg-config.in > "$SAGE_LOCAL/bin/pkg-config"
if [ $? -ne 0 ]; then
    echo >&2 "Error creating the pkg-config script."
    exit 1
fi

echo Generated script:
echo =================
cat "$SAGE_LOCAL/bin/pkg-config"
echo =================

chmod 755 "$SAGE_LOCAL/bin/pkg-config"
```
(and without `bash -c ...` in `pkg-config.in`), I'm always getting:

```
...
/usr/bin/install -c -m 644 ./pkgconf.1 /foo/local/share/man/man1/pkgconf.1
M4, shell:
/usr/bin/pkg-config

M4, bash:
/usr/bin/pkg-config

Generated script:
=================
#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "This script requires that SAGE_LOCAL is set."
    exit 1
fi  

if [ -z "$PKG_CONFIG_PATH" ]; then
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig"
else
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH"
fi



exec /foo/local/bin/pkg-config "$@"
=================

real	0m14.221s
user	0m1.716s
sys	0m0.572s
Successfully installed pkgconf-0.9.4
Running the test suite for pkgconf-0.9.4...
+-- /usr/lib/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Argument list too long
/foo/local/bin/pkg-config: line 16: /foo/local/bin/pkg-config: Success
Our pkg-config script failed to pick up fontconfig

real	0m8.012s
user	0m3.568s
sys	0m1.916s
************************************************************************
Error testing package pkgconf-0.9.4
************************************************************************
...
```



---

archive/issue_comments_270726.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-05-03T16:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270726",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_270727.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [git](#comment%3A36):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                          |                                               |\n> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n> |[4067e95](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)|`avoid potential race when creating pkg-config`|\n\n\nWorks for me:\n\n```\n...\nM4, shell:\n/usr/bin/pkg-config\n\nM4, bash:\n/usr/bin/pkg-config\n\nGenerated script:\n=================\n#!/usr/bin/env bash\n\nif [ -z \"$SAGE_LOCAL\" ]; then\n    echo >&2 \"This script requires that SAGE_LOCAL is set.\"\n    exit 1\nfi  \n\nif [ -z \"$PKG_CONFIG_PATH\" ]; then\n    export PKG_CONFIG_PATH=\"$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig\"\nelse\n    export PKG_CONFIG_PATH=\"$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH\"\nfi\n\n\n\nexec /usr/bin/pkg-config \"$@\"\n=================\n\nreal\t0m3.969s\nuser\t0m1.660s\nsys\t0m0.572s\nSuccessfully installed pkgconf-0.9.4\nRunning the test suite for pkgconf-0.9.4...\n+-- /usr/lib/pkgconfig found, using it for the pkg-config test.\n    +-- fontconfig found, using it for the pkg-config test.\n   +-- gtk+-3.0 not found, ignoring.\n   +-- harfbuzz not found, ignoring.\n    +-- x11 found, using it for the pkg-config test.\n+-- /usr/lib64/pkgconfig found, using it for the pkg-config test.\n    +-- fontconfig found, using it for the pkg-config test.\n   +-- gtk+-3.0 not found, ignoring.\n   +-- harfbuzz not found, ignoring.\n    +-- x11 found, using it for the pkg-config test.\n+-- /usr/share/pkgconfig found, using it for the pkg-config test.\n   +-- fontconfig not found, ignoring.\n   +-- gtk+-3.0 not found, ignoring.\n   +-- harfbuzz not found, ignoring.\n   +-- x11 not found, ignoring.\n\nreal\t0m0.018s\nuser\t0m0.000s\nsys\t0m0.000s\n```\n\n\n\n\nI still don't get what goes wrong or who's to blame otherwise.\n\n\n\n\nVarying indentation of found vs. ignored `.pc` files is presumably not intentional... ;-)",
    "created_at": "2014-05-03T16:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270727",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:38'></a>
Replying to [git](#comment%3A36):
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                          |                                               |
> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
> |[4067e95](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)|`avoid potential race when creating pkg-config`|


Works for me:

```
...
M4, shell:
/usr/bin/pkg-config

M4, bash:
/usr/bin/pkg-config

Generated script:
=================
#!/usr/bin/env bash

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "This script requires that SAGE_LOCAL is set."
    exit 1
fi  

if [ -z "$PKG_CONFIG_PATH" ]; then
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig"
else
    export PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$SAGE_LOCAL/share/pkgconfig:$PKG_CONFIG_PATH"
fi



exec /usr/bin/pkg-config "$@"
=================

real	0m3.969s
user	0m1.660s
sys	0m0.572s
Successfully installed pkgconf-0.9.4
Running the test suite for pkgconf-0.9.4...
+-- /usr/lib/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
    +-- x11 found, using it for the pkg-config test.
+-- /usr/lib64/pkgconfig found, using it for the pkg-config test.
    +-- fontconfig found, using it for the pkg-config test.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
    +-- x11 found, using it for the pkg-config test.
+-- /usr/share/pkgconfig found, using it for the pkg-config test.
   +-- fontconfig not found, ignoring.
   +-- gtk+-3.0 not found, ignoring.
   +-- harfbuzz not found, ignoring.
   +-- x11 not found, ignoring.

real	0m0.018s
user	0m0.000s
sys	0m0.000s
```




I still don't get what goes wrong or who's to blame otherwise.




Varying indentation of found vs. ignored `.pc` files is presumably not intentional... ;-)



---

archive/issue_comments_270728.json:
```json
{
    "body": "<a id='comment:39'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------|\n|[1d3284e](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)|`fix indentation`|",
    "created_at": "2014-05-03T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270728",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------|
|[1d3284e](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)|`fix indentation`|



---

archive/issue_comments_270729.json:
```json
{
    "body": "Changing commit from \"[4067e95b238af02153264658e848ef8f630e0932](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)\" to \"[1d3284e0e1b4512347b9293ed7ebf070bfd37041](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)\"",
    "created_at": "2014-05-03T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270729",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[4067e95b238af02153264658e848ef8f630e0932](https://github.com/sagemath/sagetrac-mirror/commit/4067e95b238af02153264658e848ef8f630e0932)" to "[1d3284e0e1b4512347b9293ed7ebf070bfd37041](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)"



---

archive/issue_comments_270730.json:
```json
{
    "body": "<a id='comment:40'></a>\n[still testing...]\n\nIs it intentional that the test suite fails if no system-wide `pkg-config` is installed?\n\n(I mean, of course it should \"fail\", but shouldn't we skip the test in that case?)\n\nImagine having set `SAGE_CHECK=yes`...  (while having `sage -f -c pkgconf` fail would probably be ok)",
    "created_at": "2014-05-03T17:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270730",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:40'></a>
[still testing...]

Is it intentional that the test suite fails if no system-wide `pkg-config` is installed?

(I mean, of course it should "fail", but shouldn't we skip the test in that case?)

Imagine having set `SAGE_CHECK=yes`...  (while having `sage -f -c pkgconf` fail would probably be ok)



---

archive/issue_comments_270731.json:
```json
{
    "body": "<a id='comment:41'></a>\nAt least something along these lines:\n\n```diff\ndiff --git a/build/pkgs/pkgconf/spkg-check b/build/pkgs/pkgconf/spkg-check\nindex 843f6a0..9a0ecf7 100755\n--- a/build/pkgs/pkgconf/spkg-check\n+++ b/build/pkgs/pkgconf/spkg-check\n@@ -1,5 +1,13 @@\n #!/usr/bin/env bash\n \n+if grep '$SAGE_LOCAL/bin/pkgconf' \"$SAGE_LOCAL\"/bin/pkg-config >/dev/null; then\n+    echo \"Skipping the tests, since no system-wide 'pkg-config' was present\"\n+    echo \"when 'pkgconf' got installed.\"\n+    echo \"Remember to afterwards reinstall Sage's 'pkgconf' if you later decide\"\n+    echo \"to install a system-wide version of 'pkg-config'.\"\n+    exit 0\n+fi\n+\n # PC files that we do not ship but are likely available (mostly GUI stuff)\n pc_files=\"fontconfig gtk+-3.0 harfbuzz x11\"\n \n```\n\nAlthough we could of course also really test our `pkgconf` with some (Sage-local) `.pc` files, not just the script we created.",
    "created_at": "2014-05-03T17:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270731",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:41'></a>
At least something along these lines:

```diff
diff --git a/build/pkgs/pkgconf/spkg-check b/build/pkgs/pkgconf/spkg-check
index 843f6a0..9a0ecf7 100755
--- a/build/pkgs/pkgconf/spkg-check
+++ b/build/pkgs/pkgconf/spkg-check
@@ -1,5 +1,13 @@
 #!/usr/bin/env bash
 
+if grep '$SAGE_LOCAL/bin/pkgconf' "$SAGE_LOCAL"/bin/pkg-config >/dev/null; then
+    echo "Skipping the tests, since no system-wide 'pkg-config' was present"
+    echo "when 'pkgconf' got installed."
+    echo "Remember to afterwards reinstall Sage's 'pkgconf' if you later decide"
+    echo "to install a system-wide version of 'pkg-config'."
+    exit 0
+fi
+
 # PC files that we do not ship but are likely available (mostly GUI stuff)
 pc_files="fontconfig gtk+-3.0 harfbuzz x11"
 
```

Although we could of course also really test our `pkgconf` with some (Sage-local) `.pc` files, not just the script we created.



---

archive/issue_comments_270732.json:
```json
{
    "body": "<a id='comment:42'></a>\n... but actually a similar message should get printed by `spkg-install`; as is, with our current wrapper script, IMHO installing `pkgconf` at all if a system-wide `pkg-config` is present doesn't make much sense (unless we introduce e.g. `SAGE_INSTALL_PKGCONFIG`... ;-) ).",
    "created_at": "2014-05-03T18:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270732",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:42'></a>
... but actually a similar message should get printed by `spkg-install`; as is, with our current wrapper script, IMHO installing `pkgconf` at all if a system-wide `pkg-config` is present doesn't make much sense (unless we introduce e.g. `SAGE_INSTALL_PKGCONFIG`... ;-) ).



---

archive/issue_comments_270733.json:
```json
{
    "body": "<a id='comment:43'></a>\nIMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.",
    "created_at": "2014-05-03T18:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270733",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:43'></a>
IMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.



---

archive/issue_comments_270734.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [vbraun](#comment%3A43):\n> IMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.\n\n\nWell, I meant building and installing the `pkgconf` binary, not our script.",
    "created_at": "2014-05-03T19:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270734",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:44'></a>
Replying to [vbraun](#comment%3A43):
> IMHO it still makes sense, its better to have a definitive behavior when calling `$SAGE_LOCAL/bin/pkg-config` than hoping that the environment variables have been correctly set up.


Well, I meant building and installing the `pkgconf` binary, not our script.



---

archive/issue_comments_270735.json:
```json
{
    "body": "<a id='comment:45'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|\n|[f30bf95](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)|`skip checks if we do not use the system pkg-config`|",
    "created_at": "2014-05-03T19:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|
|[f30bf95](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)|`skip checks if we do not use the system pkg-config`|



---

archive/issue_comments_270736.json:
```json
{
    "body": "Changing commit from \"[1d3284e0e1b4512347b9293ed7ebf070bfd37041](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)\" to \"[f30bf954c5c83ec1802eb66f0134b9420b8f73af](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)\"",
    "created_at": "2014-05-03T19:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[1d3284e0e1b4512347b9293ed7ebf070bfd37041](https://github.com/sagemath/sagetrac-mirror/commit/1d3284e0e1b4512347b9293ed7ebf070bfd37041)" to "[f30bf954c5c83ec1802eb66f0134b9420b8f73af](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)"



---

archive/issue_comments_270737.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [git](#comment%3A45):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                          |                                                    |\n> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|\n> |[f30bf95](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)|`skip checks if we do not use the system pkg-config`|\n\n\nAhem,\n\n```\ngrep 'exec pkgconf ' ...\n```\ndoesn't match\n\n```\nexec \"$SAGE_LOCAL/bin/pkgconf\" \"$@\"\n```",
    "created_at": "2014-05-03T20:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270737",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:46'></a>
Replying to [git](#comment%3A45):
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                          |                                                    |
> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|
> |[f30bf95](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)|`skip checks if we do not use the system pkg-config`|


Ahem,

```
grep 'exec pkgconf ' ...
```
doesn't match

```
exec "$SAGE_LOCAL/bin/pkgconf" "$@"
```



---

archive/issue_comments_270738.json:
```json
{
    "body": "Changing commit from \"[f30bf954c5c83ec1802eb66f0134b9420b8f73af](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)\" to \"[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)\"",
    "created_at": "2014-05-03T20:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[f30bf954c5c83ec1802eb66f0134b9420b8f73af](https://github.com/sagemath/sagetrac-mirror/commit/f30bf954c5c83ec1802eb66f0134b9420b8f73af)" to "[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)"



---

archive/issue_comments_270739.json:
```json
{
    "body": "<a id='comment:47'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |          |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------|\n|[e9b4a60](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)|`fix grep`|",
    "created_at": "2014-05-03T20:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |          |
|------------------------------------------------------------------------------------------------------------------------------------------|----------|
|[e9b4a60](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)|`fix grep`|



---

archive/issue_comments_270740.json:
```json
{
    "body": "<a id='comment:48'></a>\nthanks, fixed!",
    "created_at": "2014-05-03T20:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270740",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:48'></a>
thanks, fixed!



---

archive/issue_comments_270741.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-03T20:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270741",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_270742.json:
```json
{
    "body": "<a id='comment:49'></a>\nRelief!\n\nAlthough I don't like the approach taken; works as advertised, i.e., fixes the regression introduced by #15742.\n\nAnd if it makes kiwifb happy...",
    "created_at": "2014-05-03T20:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270742",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:49'></a>
Relief!

Although I don't like the approach taken; works as advertised, i.e., fixes the regression introduced by #15742.

And if it makes kiwifb happy...



---

archive/issue_comments_270743.json:
```json
{
    "body": "Changing keywords from \"\" to \"R cairo pango X11 graphics pkg-config\".",
    "created_at": "2014-05-03T20:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270743",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "" to "R cairo pango X11 graphics pkg-config".



---

archive/issue_comments_270744.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,6 @@\n+Here we actually use the system-wide `pkg-config` if present to query both Sage's as well as the system's package-config (`*.pc`) files.\n \n+If only Sage's `pkgconf` is available, `.pc` files (and hence the packages they belong to) installed outside of Sage still won't be seen by Sage's `pkg-config` wrapper script.\n+\n+It is therefore still recommended to have a system-wide `pkg-config`, despite Sage now having its own, e.g. to let R use graphics packages Sage doesn't ship.\n+\n``````\n",
    "created_at": "2014-05-03T21:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270744",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,6 @@
+Here we actually use the system-wide `pkg-config` if present to query both Sage's as well as the system's package-config (`*.pc`) files.
 
+If only Sage's `pkgconf` is available, `.pc` files (and hence the packages they belong to) installed outside of Sage still won't be seen by Sage's `pkg-config` wrapper script.
+
+It is therefore still recommended to have a system-wide `pkg-config`, despite Sage now having its own, e.g. to let R use graphics packages Sage doesn't ship.
+
``````




---

archive/issue_comments_270745.json:
```json
{
    "body": "<a id='comment:51'></a>\nI confirm that I am happy with this.",
    "created_at": "2014-05-03T22:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270745",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:51'></a>
I confirm that I am happy with this.



---

archive/issue_comments_270746.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [leif](#comment%3A38):\n> I still don't get what goes wrong or who's to blame otherwise.\n\n\nApparently some GNUish non-POSIX interpretation of how `command -v` is supposed to work.\n\nUnder \"normal\"(?) circumstances, bash (even when invoked as `/bin/sh`) returns the path of **any existing** (not necessarily executable or even readable) file \"foo\" found along `PATH` as the result of `command -v foo`.\n\nIn contrast, `bash --posix -c \"command -v foo\"` acts as expected.\n\n\n\n\nThat still doesn't explain why `esyscmd(`bash -c \"command -v pkg-config\"')` worked for me (without using a temporary file), whereas `esyscmd(`command -v pkg-config')` did not.\n\nDigging through `strace`s, the former calls both `stat()` and `access()`, while the latter only calls `stat()` and seems to be happy with that.",
    "created_at": "2014-05-03T23:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270746",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:52'></a>
Replying to [leif](#comment%3A38):
> I still don't get what goes wrong or who's to blame otherwise.


Apparently some GNUish non-POSIX interpretation of how `command -v` is supposed to work.

Under "normal"(?) circumstances, bash (even when invoked as `/bin/sh`) returns the path of **any existing** (not necessarily executable or even readable) file "foo" found along `PATH` as the result of `command -v foo`.

In contrast, `bash --posix -c "command -v foo"` acts as expected.




That still doesn't explain why `esyscmd(`bash -c "command -v pkg-config"')` worked for me (without using a temporary file), whereas `esyscmd(`command -v pkg-config')` did not.

Digging through `strace`s, the former calls both `stat()` and `access()`, while the latter only calls `stat()` and seems to be happy with that.



---

archive/issue_comments_270747.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-04T13:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270747",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054598.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-04T13:56:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16274#event-54598"
}
```



---

archive/issue_comments_270748.json:
```json
{
    "body": "Changing branch from \"[u/vbraun/include_system_pkgconfig_path](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/include_system_pkgconfig_path)\" to \"[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)\"",
    "created_at": "2014-05-04T13:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270748",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "[u/vbraun/include_system_pkgconfig_path](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/include_system_pkgconfig_path)" to "[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)"



---

archive/issue_comments_270749.json:
```json
{
    "body": "<a id='comment:54'></a>\nSince we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.\n\nOr we reenable setting it in `sage-env`... (which I'd personally prefer)",
    "created_at": "2014-05-16T23:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270749",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:54'></a>
Since we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.

Or we reenable setting it in `sage-env`... (which I'd personally prefer)



---

archive/issue_comments_270750.json:
```json
{
    "body": "Changing commit from \"[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)\" to \"\"",
    "created_at": "2014-05-16T23:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270750",
    "user": "https://github.com/nexttime"
}
```

Changing commit from "[e9b4a60563f815c99dd37014c639f94b126d1018](https://github.com/sagemath/sagetrac-mirror/commit/e9b4a60563f815c99dd37014c639f94b126d1018)" to ""



---

archive/issue_comments_270751.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [leif](#comment%3A54):\n> Since we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.\n> \n> Or we reenable setting it in `sage-env`... (which I'd personally prefer)\n\n\n(Potential) follow-up: #16368",
    "created_at": "2014-05-16T23:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16274#issuecomment-270751",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:55'></a>
Replying to [leif](#comment%3A54):
> Since we now no longer set `PKG_CONFIG_PATH` in `sage-env`, and the wrapper script setting it gets only installed with `pkgconf`, we have to fix our deps such that other packages ([currently] built before `pkgconf`) see Sage's `pkgconfig` folder at all.
> 
> Or we reenable setting it in `sage-env`... (which I'd personally prefer)


(Potential) follow-up: #16368
