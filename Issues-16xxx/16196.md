# Issue 16196: dedent pasted sage prompts

archive/issues_015959.json:
```json
{
    "body": "Sage prompts with leading whitespace are not removed correctly:\n\n```\nsage:    1+1     # works\n2\nsage: sage: 1+1     # works\n2\nsage:    sage: 1+1     # indent + prompt = fail\n  File \"<ipython-input-34-360e106e9b2f>\", line 1\n    sage: Integer(1)+Integer(1)     # indent + prompt = fail\n        ^\nSyntaxError: invalid syntax\n```\nPossibly due to #16050\n\nCC:  @ohanar\n\nReviewer: John Palmieri\n\nAuthor: R. Andrew Ohana\n\nBranch: 101a6beaae0109dffad9a8d93f8ebd44843794e5\n\nCommit: 101a6beaae0109dffad9a8d93f8ebd44843794e5\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16196\n\n",
    "closed_at": "2014-05-04T13:56:38Z",
    "created_at": "2014-04-21T12:32:52Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "dedent pasted sage prompts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16196",
    "user": "https://github.com/vbraun"
}
```
Sage prompts with leading whitespace are not removed correctly:

```
sage:    1+1     # works
2
sage: sage: 1+1     # works
2
sage:    sage: 1+1     # indent + prompt = fail
  File "<ipython-input-34-360e106e9b2f>", line 1
    sage: Integer(1)+Integer(1)     # indent + prompt = fail
        ^
SyntaxError: invalid syntax
```
Possibly due to #16050

CC:  @ohanar

Reviewer: John Palmieri

Author: R. Andrew Ohana

Branch: 101a6beaae0109dffad9a8d93f8ebd44843794e5

Commit: 101a6beaae0109dffad9a8d93f8ebd44843794e5

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16196





---

archive/issue_comments_206833.json:
```json
{
    "body": "<a id='comment:2'></a>It looks like the change from #16154 broke this (ipython's leading indent stripper is now being run after our prompt stripper). I can look into this sometime later this week.",
    "created_at": "2014-04-21T18:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206833",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:2'></a>It looks like the change from #16154 broke this (ipython's leading indent stripper is now being run after our prompt stripper). I can look into this sometime later this week.



---

archive/issue_comments_206834.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-24T22:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206834",
    "user": "https://github.com/ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_206835.json:
```json
{
    "body": "<a id='comment:4'></a>This should work for now, although I looked a bit into the upstream code, and that should probably be changed to be more configurable (since after all the prompt is configurable).\n\n---\nNew commits:",
    "created_at": "2014-04-24T22:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206835",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:4'></a>This should work for now, although I looked a bit into the upstream code, and that should probably be changed to be more configurable (since after all the prompt is configurable).

---
New commits:



---

archive/issue_comments_206836.json:
```json
{
    "body": "<a id='comment:5'></a>Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)\n\n- Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?\n\n- What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.",
    "created_at": "2014-04-24T22:46:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206836",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)

- Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?

- What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.



---

archive/issue_comments_206837.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:\n> Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)\n> \n> - Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?\n\n\nIs there sage code that is being written with sage (duplicate) prompts? Really duplicate prompts should only come about by copying something into a terminal session, and then copying that pasted content again -- this seems like a complete edge case that wouldn't (and certainly shouldn't) show up in some code that is meant to be used for a long period of time.\n\n> \n> - What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.\n\n\nIPython already has a dedenter, and it is smart (it strips an equal amount from each line), so all we need to do is strip our prompts after ipython dedents, and for the moment, that means insert after position 0 (and before position 1, so as to not re-break #16154).",
    "created_at": "2014-04-24T22:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206837",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:
> Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)
> 
> - Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?


Is there sage code that is being written with sage (duplicate) prompts? Really duplicate prompts should only come about by copying something into a terminal session, and then copying that pasted content again -- this seems like a complete edge case that wouldn't (and certainly shouldn't) show up in some code that is meant to be used for a long period of time.

> 
> - What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.


IPython already has a dedenter, and it is smart (it strips an equal amount from each line), so all we need to do is strip our prompts after ipython dedents, and for the moment, that means insert after position 0 (and before position 1, so as to not re-break #16154).



---

archive/issue_comments_206838.json:
```json
{
    "body": "<a id='comment:7'></a>Like I mentioned, this should just be configurable with IPython itself -- we shouldn't have to be pulling this internal `_strip_prompts` function in the first place. I'll make a patch if I ever find the time to fix this upstream, but I'm much to busy at the moment.",
    "created_at": "2014-04-24T23:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206838",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:7'></a>Like I mentioned, this should just be configurable with IPython itself -- we shouldn't have to be pulling this internal `_strip_prompts` function in the first place. I'll make a patch if I ever find the time to fix this upstream, but I'm much to busy at the moment.



---

archive/issue_comments_206839.json:
```json
{
    "body": "<a id='comment:8'></a>Rebased (w.r.t. #16232).",
    "created_at": "2014-04-30T22:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206839",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Rebased (w.r.t. #16232).



---

archive/issue_comments_206840.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-30T22:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206840",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_206841.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-04-30T22:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206841",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_206842.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2014-04-30T22:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206842",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_206843.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-30T22:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206843",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_206844.json:
```json
{
    "body": "<a id='comment:11'></a>Ah, ok... :-)",
    "created_at": "2014-04-30T23:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206844",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>Ah, ok... :-)



---

archive/issue_comments_206845.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-04T13:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16196#issuecomment-206845",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_047713.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-04T13:56:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16196",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16196#event-47713"
}
```
