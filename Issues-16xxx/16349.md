# Issue 16349: Make UniqueFactory unpickling more flexible

archive/issues_016112.json:
```json
{
    "body": "Currently `UniqueFactory`'s unpickling protocol is to call `generic_factory_unpickle()`, whose first argument *must* be an instance of `UniqueFactory`. However we might want to change the object in the global namespace, let's say to a function, and then we will not be able to unpickle any  thing beforehand (`register_unpickle_override` can not help here because the pickle info is `(UniqueFactory`, `generic_factory_unpickle)`). Came up in #15289.\n\nAssignee: @tscrim\n\nCC:  simonking @nthiery\n\nKeywords: UniqueFactory pickle\n\nBranch/Commit: c7646c1a28493f94a5362212cf8bd089ffce3279\n\nReviewer: Travis Scrimshaw, Simon King\n\nAuthor: Simon King, Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16349\n\n",
    "closed_at": "2014-05-19T12:53:23Z",
    "created_at": "2014-05-13T15:42:28Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Make UniqueFactory unpickling more flexible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16349",
    "user": "https://github.com/tscrim"
}
```
Currently `UniqueFactory`'s unpickling protocol is to call `generic_factory_unpickle()`, whose first argument *must* be an instance of `UniqueFactory`. However we might want to change the object in the global namespace, let's say to a function, and then we will not be able to unpickle any  thing beforehand (`register_unpickle_override` can not help here because the pickle info is `(UniqueFactory`, `generic_factory_unpickle)`). Came up in #15289.

Assignee: @tscrim

CC:  simonking @nthiery

Keywords: UniqueFactory pickle

Branch/Commit: c7646c1a28493f94a5362212cf8bd089ffce3279

Reviewer: Travis Scrimshaw, Simon King

Author: Simon King, Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16349





---

archive/issue_comments_272961.json:
```json
{
    "body": "Changing branch from \"\" to \"u/SimonKing/ticket/16349\"",
    "created_at": "2014-05-14T11:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272961",
    "user": "https://github.com/simon-king-jena"
}
```

Changing branch from "" to "u/SimonKing/ticket/16349"



---

archive/issue_comments_272962.json:
```json
{
    "body": "Changing commit from \"\" to \"321a9e407ef260269f4d66159a787316440082e3\"",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272962",
    "user": "https://github.com/simon-king-jena"
}
```

Changing commit from "" to "321a9e407ef260269f4d66159a787316440082e3"



---

archive/issue_comments_272963.json:
```json
{
    "body": "<a id='comment:2'></a>\nTravis, you have been inserted as \"Author\", but I think you did not provide code. So, I took the liberty to replace your name by mine, and attach a branch. The new doctest demonstrates how to replace a unique factory by unique representation and correctly unpickle.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|\n|[321a9e4](https://github.com/sagemath/sagetrac-mirror/commit/321a9e407ef260269f4d66159a787316440082e3)|`Unpickling when replacing an old UniqueFactory by something new`|",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272963",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
Travis, you have been inserted as "Author", but I think you did not provide code. So, I took the liberty to replace your name by mine, and attach a branch. The new doctest demonstrates how to replace a unique factory by unique representation and correctly unpickle.

---
New commits:
|                                                                                                                                          |                                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
|[321a9e4](https://github.com/sagemath/sagetrac-mirror/commit/321a9e407ef260269f4d66159a787316440082e3)|`Unpickling when replacing an old UniqueFactory by something new`|



---

archive/issue_comments_272964.json:
```json
{
    "body": "Changing author from \"Travis Scrimshaw\" to \"Simon King\"",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272964",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "Travis Scrimshaw" to "Simon King"



---

archive/issue_comments_272965.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272965",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_272966.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|\n|[187d1aa](https://github.com/sagemath/sagetrac-mirror/commit/187d1aa8d95cf2b64ab2c45224844a709412127b)|`Fix arguments passed to the constructor that replaces an old UniqueFactory`|",
    "created_at": "2014-05-14T12:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272966",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
|[187d1aa](https://github.com/sagemath/sagetrac-mirror/commit/187d1aa8d95cf2b64ab2c45224844a709412127b)|`Fix arguments passed to the constructor that replaces an old UniqueFactory`|



---

archive/issue_comments_272967.json:
```json
{
    "body": "Changing commit from \"321a9e407ef260269f4d66159a787316440082e3\" to \"187d1aa8d95cf2b64ab2c45224844a709412127b\"",
    "created_at": "2014-05-14T12:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272967",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "321a9e407ef260269f4d66159a787316440082e3" to "187d1aa8d95cf2b64ab2c45224844a709412127b"



---

archive/issue_comments_272968.json:
```json
{
    "body": "<a id='comment:4'></a>\nI had to fix one detail (I made a wrong assumption on the format of `_factory_data`.",
    "created_at": "2014-05-14T12:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272968",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
I had to fix one detail (I made a wrong assumption on the format of `_factory_data`.



---

archive/issue_comments_272969.json:
```json
{
    "body": "<a id='comment:5'></a>\nHey Simon, I didn't have a chance to finish it yesterday. I will finish up what I was working on today as an alternative proposal.",
    "created_at": "2014-05-14T16:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272969",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Hey Simon, I didn't have a chance to finish it yesterday. I will finish up what I was working on today as an alternative proposal.



---

archive/issue_comments_272970.json:
```json
{
    "body": "<a id='comment:6'></a>\nOkay I've just put in both versions. I've implemented something similar to `register_unpickle_override()` (which I've called `register_factory_unpickle()`). This way we can handle when the factory is removed from the global namespace (such as for name change). If you could check that and agree, then we can set this to positive review. Thanks.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|\n|[83c79ef](https://github.com/sagemath/sagetrac-mirror/commit/83c79ef5bfb02795e0c00cfd7ef39fc81b538fe6)|`Merge branch 'u/SimonKing/ticket/16349' of trac.sagemath.org:sage into public/pickling/unique_factories-16349`|\n|[2df09ed](https://github.com/sagemath/sagetrac-mirror/commit/2df09ed29ab772d4cca01d3c832140780536e0b9)|`Implemented an unpickle override for UniqueFactory.`|\n|[c7646c1](https://github.com/sagemath/sagetrac-mirror/commit/c7646c1a28493f94a5362212cf8bd089ffce3279)|`Fixed doctest caused by me forgetting the registration is global.`|",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272970",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
Okay I've just put in both versions. I've implemented something similar to `register_unpickle_override()` (which I've called `register_factory_unpickle()`). This way we can handle when the factory is removed from the global namespace (such as for name change). If you could check that and agree, then we can set this to positive review. Thanks.

---
New commits:
|                                                                                                                                          |                                                                                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
|[83c79ef](https://github.com/sagemath/sagetrac-mirror/commit/83c79ef5bfb02795e0c00cfd7ef39fc81b538fe6)|`Merge branch 'u/SimonKing/ticket/16349' of trac.sagemath.org:sage into public/pickling/unique_factories-16349`|
|[2df09ed](https://github.com/sagemath/sagetrac-mirror/commit/2df09ed29ab772d4cca01d3c832140780536e0b9)|`Implemented an unpickle override for UniqueFactory.`|
|[c7646c1](https://github.com/sagemath/sagetrac-mirror/commit/c7646c1a28493f94a5362212cf8bd089ffce3279)|`Fixed doctest caused by me forgetting the registration is global.`|



---

archive/issue_comments_272971.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw, Simon King\"",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272971",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw, Simon King"



---

archive/issue_comments_272972.json:
```json
{
    "body": "Changing author from \"Simon King\" to \"Simon King, Travis Scrimshaw\"",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272972",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Simon King" to "Simon King, Travis Scrimshaw"



---

archive/issue_comments_272973.json:
```json
{
    "body": "Changing branch from \"u/SimonKing/ticket/16349\" to \"public/pickling/unique_factories-16349\"",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272973",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "u/SimonKing/ticket/16349" to "public/pickling/unique_factories-16349"



---

archive/issue_comments_272974.json:
```json
{
    "body": "Changing commit from \"187d1aa8d95cf2b64ab2c45224844a709412127b\" to \"c7646c1a28493f94a5362212cf8bd089ffce3279\"",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272974",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "187d1aa8d95cf2b64ab2c45224844a709412127b" to "c7646c1a28493f94a5362212cf8bd089ffce3279"



---

archive/issue_comments_272975.json:
```json
{
    "body": "<a id='comment:7'></a>\nWith the current branch, we provide two ways to deal with old pickles of `UniqueFactory`: If we replace the old factory by something new that has the same name, is in the same module and can process the same input as the `UniqueFactory`, then nothing more needs to be done (that's my contribution). Moreover, it is possible to override unpickling so that a new callable is used for unpickling *even if the old factory is still there* (that's your contribution). I think both possibilities make sense. Hence, I complete the positive review.",
    "created_at": "2014-05-16T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272975",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
With the current branch, we provide two ways to deal with old pickles of `UniqueFactory`: If we replace the old factory by something new that has the same name, is in the same module and can process the same input as the `UniqueFactory`, then nothing more needs to be done (that's my contribution). Moreover, it is possible to override unpickling so that a new callable is used for unpickling *even if the old factory is still there* (that's your contribution). I think both possibilities make sense. Hence, I complete the positive review.



---

archive/issue_comments_272976.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-16T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272976",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_272977.json:
```json
{
    "body": "<a id='comment:8'></a>\nThank you Simon.",
    "created_at": "2014-05-16T14:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272977",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
Thank you Simon.



---

archive/issue_comments_272978.json:
```json
{
    "body": "Changing branch from \"public/pickling/unique_factories-16349\" to \"c7646c1a28493f94a5362212cf8bd089ffce3279\"",
    "created_at": "2014-05-19T12:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272978",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/pickling/unique_factories-16349" to "c7646c1a28493f94a5362212cf8bd089ffce3279"



---

archive/issue_comments_272979.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-19T12:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16349#issuecomment-272979",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054802.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-19T12:53:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16349",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16349#event-54802"
}
```
