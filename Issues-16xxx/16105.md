# Issue 16105: Stop linking everything to libntl

archive/issues_015868.json:
```json
{
    "body": "CC:  @vbraun\n\nKeywords: ntl, crash\n\nAfter upgrading to Sage 6.2.beta7:\n\n```\n(sage-sh) jdemeyer@tamiyo:sage-config$ ldd local/lib/python2.7/site-packages/sage/misc/readline_extra_commands.so\n        linux-vdso.so.1 (0x00007fffdfffa000)\n        libcsage.so => /usr/local/src/sage-config/local/lib/libcsage.so (0x00007f403d747000)\n        libreadline.so.6 => /usr/local/src/sage-config/local/lib/libreadline.so.6 (0x00007f403d500000)\n        libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.6.3/libstdc++.so.6 (0x00007f403d1c4000)\n        libntl.so.2 => not found\n        libpython2.7.so.1.0 => /usr/local/src/sage-config/local/lib/libpython2.7.so.1.0 (0x00007f403cde5000)\n        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f403cbc8000)\n        libc.so.6 => /lib64/libc.so.6 (0x00007f403c820000)\n        libntl.so.3 => /usr/local/src/sage-config/local/lib/libntl.so.3 (0x00007f403c459000)\n        libpari-gmp.so.4 => /usr/local/src/sage-config/local/lib/libpari-gmp.so.4 (0x00007f403bce9000)\n        libgmp.so.11 => /usr/local/src/sage-config/local/lib/libgmp.so.11 (0x00007f403ba7a000)\n        libm.so.6 => /lib64/libm.so.6 (0x00007f403b78b000)\n        libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.6.3/libgcc_s.so.1 (0x00007f403b575000)\n        libtinfo.so.5 => /usr/local/src/sage-config/local/lib/libtinfo.so.5 (0x00007f403b340000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007f403db66000)\n        libdl.so.2 => /lib64/libdl.so.2 (0x00007f403b13b000)\n        libutil.so.1 => /lib64/libutil.so.1 (0x00007f403af38000)\n        libgf2x.so.1 => /usr/local/src/sage-config/local/lib/libgf2x.so.1 (0x00007f403ad22000)\n```\nNote the missing `libntl.so.2` causing various kinds of problems.\n\nThe reason is that *every* Cython extension is compiled with `-lntl` (see `src/setup.py`), this should be fixed. This `-lntl` was added in\n\n```diff\ncommit 707bac8c37de8e320630c94d67d7154dd14e91da\nAuthor: William Stein <wstein@gmail.com>\nDate:   Mon Apr 9 18:43:36 2007 -0700\n\n    add -lntl to the build line for building SAGE extension modules; this avoids a warning on OS X.\n\ndiff --git a/src/setup.py b/src/setup.py\nindex 38c8ed4..b7e88fe 100644\n--- a/src/setup.py\n+++ b/src/setup.py\n@@ -573,7 +573,7 @@ if DEVEL:\n     #ext_modules.append(mpc)\n \n for m in ext_modules:\n-    m.libraries = ['csage'] + m.libraries + ['stdc++']\n+    m.libraries = ['csage'] + m.libraries + ['stdc++', 'ntl']\n     m.library_dirs += ['%s/lib' % SAGE_LOCAL]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/16105\n\n",
    "closed_at": "2014-04-11T19:41:30Z",
    "created_at": "2014-04-09T05:43:06Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Stop linking everything to libntl",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16105",
    "user": "https://github.com/darijgr"
}
```
CC:  @vbraun

Keywords: ntl, crash

After upgrading to Sage 6.2.beta7:

```
(sage-sh) jdemeyer@tamiyo:sage-config$ ldd local/lib/python2.7/site-packages/sage/misc/readline_extra_commands.so
        linux-vdso.so.1 (0x00007fffdfffa000)
        libcsage.so => /usr/local/src/sage-config/local/lib/libcsage.so (0x00007f403d747000)
        libreadline.so.6 => /usr/local/src/sage-config/local/lib/libreadline.so.6 (0x00007f403d500000)
        libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.6.3/libstdc++.so.6 (0x00007f403d1c4000)
        libntl.so.2 => not found
        libpython2.7.so.1.0 => /usr/local/src/sage-config/local/lib/libpython2.7.so.1.0 (0x00007f403cde5000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f403cbc8000)
        libc.so.6 => /lib64/libc.so.6 (0x00007f403c820000)
        libntl.so.3 => /usr/local/src/sage-config/local/lib/libntl.so.3 (0x00007f403c459000)
        libpari-gmp.so.4 => /usr/local/src/sage-config/local/lib/libpari-gmp.so.4 (0x00007f403bce9000)
        libgmp.so.11 => /usr/local/src/sage-config/local/lib/libgmp.so.11 (0x00007f403ba7a000)
        libm.so.6 => /lib64/libm.so.6 (0x00007f403b78b000)
        libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.6.3/libgcc_s.so.1 (0x00007f403b575000)
        libtinfo.so.5 => /usr/local/src/sage-config/local/lib/libtinfo.so.5 (0x00007f403b340000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f403db66000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007f403b13b000)
        libutil.so.1 => /lib64/libutil.so.1 (0x00007f403af38000)
        libgf2x.so.1 => /usr/local/src/sage-config/local/lib/libgf2x.so.1 (0x00007f403ad22000)
```
Note the missing `libntl.so.2` causing various kinds of problems.

The reason is that *every* Cython extension is compiled with `-lntl` (see `src/setup.py`), this should be fixed. This `-lntl` was added in

```diff
commit 707bac8c37de8e320630c94d67d7154dd14e91da
Author: William Stein <wstein@gmail.com>
Date:   Mon Apr 9 18:43:36 2007 -0700

    add -lntl to the build line for building SAGE extension modules; this avoids a warning on OS X.

diff --git a/src/setup.py b/src/setup.py
index 38c8ed4..b7e88fe 100644
--- a/src/setup.py
+++ b/src/setup.py
@@ -573,7 +573,7 @@ if DEVEL:
     #ext_modules.append(mpc)
 
 for m in ext_modules:
-    m.libraries = ['csage'] + m.libraries + ['stdc++']
+    m.libraries = ['csage'] + m.libraries + ['stdc++', 'ntl']
     m.library_dirs += ['%s/lib' % SAGE_LOCAL]
```

Issue created by migration from https://trac.sagemath.org/ticket/16105





---

archive/issue_comments_205714.json:
```json
{
    "body": "Solution in https://groups.google.com/forum/?hl=en#!topic/sage-release/zxlHERyLUVU",
    "created_at": "2014-04-09T09:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205714",
    "user": "https://github.com/rwst"
}
```

Solution in https://groups.google.com/forum/?hl=en#!topic/sage-release/zxlHERyLUVU



---

archive/issue_events_047437.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-04-09T09:03:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16105#event-47437"
}
```



---

archive/issue_comments_205715.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-09T09:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205715",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_205716.json:
```json
{
    "body": "```\nmake distclean && make\n```",
    "created_at": "2014-04-09T09:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205716",
    "user": "https://github.com/vbraun"
}
```

```
make distclean && make
```



---

archive/issue_comments_205717.json:
```json
{
    "body": "Ah, thank you!\n\nHmm... any chance things like this could appear in the release notes? Or is it a system-dependent heisenbug?",
    "created_at": "2014-04-09T13:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205717",
    "user": "https://github.com/darijgr"
}
```

Ah, thank you!

Hmm... any chance things like this could appear in the release notes? Or is it a system-dependent heisenbug?



---

archive/issue_events_047438.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-04-11T09:40:37Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16105#event-47438"
}
```



---

archive/issue_events_047439.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-04-11T09:40:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16105#event-47439"
}
```



---

archive/issue_comments_205718.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-04-11T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205718",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_205719.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2014-04-11T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205719",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_205720.json:
```json
{
    "body": "Changing component from number theory to build.",
    "created_at": "2014-04-11T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205720",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from number theory to build.



---

archive/issue_comments_205721.json:
```json
{
    "body": "I disagree with the \"solution\", this is a bug in the dependency checking.",
    "created_at": "2014-04-11T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205721",
    "user": "https://github.com/jdemeyer"
}
```

I disagree with the "solution", this is a bug in the dependency checking.



---

archive/issue_comments_205722.json:
```json
{
    "body": "It seems that all Cython extensions are compiled against NTL for no clear reason:\n\n```\n$ ./sage -b\n[...]\ngcc -pthread -shared -L/usr/local/src/sage-config/local/lib build/temp.linux-x86_64-2.7/sage/misc/parser.o -L/usr/local/src/sage-config/local/lib -L/usr/local/src/sage-config/local/lib -lcsage -lstdc++ -lntl -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/misc/parser.so\n```\n\nThis `-lntl` is hardcoded in `src/setup.py`.",
    "created_at": "2014-04-11T09:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205722",
    "user": "https://github.com/jdemeyer"
}
```

It seems that all Cython extensions are compiled against NTL for no clear reason:

```
$ ./sage -b
[...]
gcc -pthread -shared -L/usr/local/src/sage-config/local/lib build/temp.linux-x86_64-2.7/sage/misc/parser.o -L/usr/local/src/sage-config/local/lib -L/usr/local/src/sage-config/local/lib -lcsage -lstdc++ -lntl -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/misc/parser.so
```

This `-lntl` is hardcoded in `src/setup.py`.



---

archive/issue_comments_205723.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-04-11T12:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205723",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_205724.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-11T12:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205724",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_205725.json:
```json
{
    "body": "Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.",
    "created_at": "2014-04-11T13:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205725",
    "user": "https://github.com/jdemeyer"
}
```

Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.



---

archive/issue_comments_205726.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.\n\nWhy is it dangerous?",
    "created_at": "2014-04-11T13:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205726",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:12 jdemeyer]:
> Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.

Why is it dangerous?



---

archive/issue_comments_205727.json:
```json
{
    "body": "Okay, \"dangerous\" isn't the right word.\n\nThe problem is the following:\n\n```\nsage: mylist = [\"hello\"]\nsage: a = mylist\nsage: a.append(\"world\")\nsage: a\n['hello', 'world']\nsage: mylist\n['hello', 'world']\n```\n\nAs you can see, `a` and `mylist` remain the same object. The same if you use `+=`. That is also the reason why some Sage command lines look like\n\n```\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/usr/local/src/sage-config/local/include/singular -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include/python2.7 -c sage/rings/polynomial/plural.cpp -o build/temp.linux-x86_64-2.7/sage/rings/polynomial/plural.o -D__STDC_LIMIT_MACROS -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w\n```\nso I plan to fix this also here.",
    "created_at": "2014-04-11T13:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205727",
    "user": "https://github.com/jdemeyer"
}
```

Okay, "dangerous" isn't the right word.

The problem is the following:

```
sage: mylist = ["hello"]
sage: a = mylist
sage: a.append("world")
sage: a
['hello', 'world']
sage: mylist
['hello', 'world']
```

As you can see, `a` and `mylist` remain the same object. The same if you use `+=`. That is also the reason why some Sage command lines look like

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/usr/local/src/sage-config/local/include/singular -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include/python2.7 -c sage/rings/polynomial/plural.cpp -o build/temp.linux-x86_64-2.7/sage/rings/polynomial/plural.o -D__STDC_LIMIT_MACROS -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w
```
so I plan to fix this also here.



---

archive/issue_comments_205728.json:
```json
{
    "body": "Nice.  (After the FIXME has been in for more than `\\pi` years... ;-) )\n\nThe order of the libraries is still wrong in many places (e.g. `\"gmp\", \"gmpxx\"`; and `\"m\"` should almost always be the *last*), but that's not really the point of the ticket; the following is:\n\nI'd also add NTL here:\n\n```python\nlib_headers = { \"gmp\":     [ os.path.join(SAGE_INC,'gmp.h') ],   # cf. #8664, #9896\n                \"gmpxx\":   [ os.path.join(SAGE_INC,'gmpxx.h') ],\n                \"ntl\":     [ os.path.join(SAGE_INC,'NTL','config.h') ]\n              }\n```\n(That way, all modules using NTL, i.e., [directly] linking to it, will automatically depend on an NTL header that gets modified upon every NTL reinstallation.)\n\n\n\n\nNot sure why you want all extension modules to depend on `setup.py` (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library); we should then also let all of them depend on `module_list.py` (which is IMHO probably more important).\n\n\n\n\nAnd there are of course still many libraries not really needed, because they're just indirectly used, but that's another issue, cf. [this comment on #16017](http://trac.sagemath.org/ticket/16017#comment:10).",
    "created_at": "2014-04-11T13:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205728",
    "user": "https://github.com/nexttime"
}
```

Nice.  (After the FIXME has been in for more than `\pi` years... ;-) )

The order of the libraries is still wrong in many places (e.g. `"gmp", "gmpxx"`; and `"m"` should almost always be the *last*), but that's not really the point of the ticket; the following is:

I'd also add NTL here:

```python
lib_headers = { "gmp":     [ os.path.join(SAGE_INC,'gmp.h') ],   # cf. #8664, #9896
                "gmpxx":   [ os.path.join(SAGE_INC,'gmpxx.h') ],
                "ntl":     [ os.path.join(SAGE_INC,'NTL','config.h') ]
              }
```
(That way, all modules using NTL, i.e., [directly] linking to it, will automatically depend on an NTL header that gets modified upon every NTL reinstallation.)




Not sure why you want all extension modules to depend on `setup.py` (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library); we should then also let all of them depend on `module_list.py` (which is IMHO probably more important).




And there are of course still many libraries not really needed, because they're just indirectly used, but that's another issue, cf. [this comment on #16017](http://trac.sagemath.org/ticket/16017#comment:10).



---

archive/issue_comments_205729.json:
```json
{
    "body": "Replying to [comment:15 leif]:\n> Not sure why you want all extension modules to depend on `setup.py`\n\nWell, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.\n\n> (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library);\n\nI doubt it, that file isn't changed so frequently.",
    "created_at": "2014-04-11T13:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205729",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 leif]:
> Not sure why you want all extension modules to depend on `setup.py`

Well, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.

> (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library);

I doubt it, that file isn't changed so frequently.



---

archive/issue_comments_205730.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> Replying to [comment:15 leif]:\n> > Not sure why you want all extension modules to depend on `setup.py`\n\n> Well, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.\n\nHaha, a one-time dependency.  So you're going to remove it again in some of the next betas? \n\n> > (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library);\n\n> I doubt it, that file isn't changed so frequently.\n\nSo you're not going to let them depend on `module_list.py` also?\n\n(I frequently hate myself for making all targets depend on the Makefile; similar issue.)\n\n\n\n\nProbably Volker should mention `env SAGE_UPGRADING=yes make build` in the release announcements for a while.  (Doing `./sage -ba-force` afterwards should no longer be necessary once this ticket is merged, hopefully...)\n\nWould save him a couple of `make distclean && make` replies, too.",
    "created_at": "2014-04-11T14:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205730",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 leif]:
> > Not sure why you want all extension modules to depend on `setup.py`

> Well, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.

Haha, a one-time dependency.  So you're going to remove it again in some of the next betas? 

> > (makes sense of course, but will also trigger frequent rebuilds of the *whole* Sage library);

> I doubt it, that file isn't changed so frequently.

So you're not going to let them depend on `module_list.py` also?

(I frequently hate myself for making all targets depend on the Makefile; similar issue.)




Probably Volker should mention `env SAGE_UPGRADING=yes make build` in the release announcements for a while.  (Doing `./sage -ba-force` afterwards should no longer be necessary once this ticket is merged, hopefully...)

Would save him a couple of `make distclean && make` replies, too.



---

archive/issue_comments_205731.json:
```json
{
    "body": "Replying to [comment:17 leif]:\n> Haha, a one-time dependency.  So you're going to remove it again in some of the next betas? \n\nOf course not. I am saying it is needed *now* and it doesn't really hurt to keep it.\n\n> So you're not going to let them depend on `module_list.py` also?\n\nI would say no.\nI think it is quite unlikely that `module_list.py` gets edited\n- without a change to the corresponding `.pyx` files (if the `.pyx` file is changed, the module is recompiled anyway)\n- without considering changes which are only cosmetic or only for portability (those don't need rebuilds).",
    "created_at": "2014-04-11T14:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205731",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 leif]:
> Haha, a one-time dependency.  So you're going to remove it again in some of the next betas? 

Of course not. I am saying it is needed *now* and it doesn't really hurt to keep it.

> So you're not going to let them depend on `module_list.py` also?

I would say no.
I think it is quite unlikely that `module_list.py` gets edited
- without a change to the corresponding `.pyx` files (if the `.pyx` file is changed, the module is recompiled anyway)
- without considering changes which are only cosmetic or only for portability (those don't need rebuilds).



---

archive/issue_comments_205732.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:17 leif]:\n> > So you're going to remove it again in some of the next betas? \n\n> Of course not. I am saying it is needed *now* and it doesn't really hurt to keep it.\n> \n> > So you're not going to let them depend on `module_list.py` also?\n\n> I would say no.\n\nOk.  Then we can at least \"touch\" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a *full* rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).\n\nAnd simply adding an extension module (or changing *one's* deps etc.) will *not* trigger the rebuild of the whole Sage library, which presumably is more important to many.",
    "created_at": "2014-04-11T15:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205732",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 leif]:
> > So you're going to remove it again in some of the next betas? 

> Of course not. I am saying it is needed *now* and it doesn't really hurt to keep it.
> 
> > So you're not going to let them depend on `module_list.py` also?

> I would say no.

Ok.  Then we can at least "touch" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a *full* rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).

And simply adding an extension module (or changing *one's* deps etc.) will *not* trigger the rebuild of the whole Sage library, which presumably is more important to many.



---

archive/issue_comments_205733.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-11T15:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205733",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_205734.json:
```json
{
    "body": "New version for review.",
    "created_at": "2014-04-11T15:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205734",
    "user": "https://github.com/jdemeyer"
}
```

New version for review.



---

archive/issue_comments_205735.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> New version for review.\n\n\nLooks sane, but I can't test this right now.  (Others will presumably be faster.)\n\nJust wonder whether we'd need the absolute path of `setup.py` (`__file__` may just be the latter, or have a relative path).",
    "created_at": "2014-04-11T15:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205735",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:21 jdemeyer]:
> New version for review.


Looks sane, but I can't test this right now.  (Others will presumably be faster.)

Just wonder whether we'd need the absolute path of `setup.py` (`__file__` may just be the latter, or have a relative path).



---

archive/issue_comments_205736.json:
```json
{
    "body": "Replying to [comment:19 leif]:\n> Replying to [comment:18 jdemeyer]:\n> > Replying to [comment:17 leif]:\n> > > So you're going to remove it again in some of the next betas? \n\n> > Of course not. I am saying it is needed *now* and it doesn't really hurt to keep it.\n> Ok.  Then we can at least \"touch\" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a *full* rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).\n\n\nThinking a bit more about it, this can be quite annoying *during development*, so we may add some way to bypass the dependency on `setup.py`.  (There's already a `DEVEL` variable in it, but it's also unconditionally set to `False`, rather than derived from some environment variable, say.)",
    "created_at": "2014-04-11T16:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205736",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:19 leif]:
> Replying to [comment:18 jdemeyer]:
> > Replying to [comment:17 leif]:
> > > So you're going to remove it again in some of the next betas? 

> > Of course not. I am saying it is needed *now* and it doesn't really hurt to keep it.
> Ok.  Then we can at least "touch" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a *full* rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).


Thinking a bit more about it, this can be quite annoying *during development*, so we may add some way to bypass the dependency on `setup.py`.  (There's already a `DEVEL` variable in it, but it's also unconditionally set to `False`, rather than derived from some environment variable, say.)



---

archive/issue_comments_205737.json:
```json
{
    "body": "Instead of introducing yet another environment variable (here, at least), we could (ab|re)use `SAGE_UPGRADING`, and bypass the dependency on `setup.py` iff `SAGE_UPGRADING = \"no\"`, which would also be compatible to having `SAGE_UPGRADING=yes` the default (in future releases).",
    "created_at": "2014-04-11T16:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205737",
    "user": "https://github.com/nexttime"
}
```

Instead of introducing yet another environment variable (here, at least), we could (ab|re)use `SAGE_UPGRADING`, and bypass the dependency on `setup.py` iff `SAGE_UPGRADING = "no"`, which would also be compatible to having `SAGE_UPGRADING=yes` the default (in future releases).



---

archive/issue_comments_205738.json:
```json
{
    "body": "will test it on the bulidbot",
    "created_at": "2014-04-11T17:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205738",
    "user": "https://github.com/vbraun"
}
```

will test it on the bulidbot



---

archive/issue_comments_205739.json:
```json
{
    "body": "IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested. And `sage -ba` takes 11 seconds on my laptop with warm caches.",
    "created_at": "2014-04-11T17:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205739",
    "user": "https://github.com/vbraun"
}
```

IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested. And `sage -ba` takes 11 seconds on my laptop with warm caches.



---

archive/issue_comments_205740.json:
```json
{
    "body": "Replying to [comment:26 vbraun]:\n> IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested.\n\n\nBuilding is not doctested at all, unfortunately not even upgrading is tested -- at least not on a regular basis (otherwise the ticket upgrading NTL would have dealt with what we do here).  `SAGE_UPGRADING` isn't new, and the default behaviour of (just issuing) `make` (or `sage-spkg`) regularly causes failures.\n\n\n\n\n> And `sage -ba` takes 11 seconds on my laptop with warm caches.\n\n\n[File system and ccache I guess.]\n\nWell, if every Sage user|developer (at your choice) in the world gets such for free...\n\nOtherwise we could just update the minimal hardware requirements (for building or developing with Sage).",
    "created_at": "2014-04-11T18:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205740",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:26 vbraun]:
> IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested.


Building is not doctested at all, unfortunately not even upgrading is tested -- at least not on a regular basis (otherwise the ticket upgrading NTL would have dealt with what we do here).  `SAGE_UPGRADING` isn't new, and the default behaviour of (just issuing) `make` (or `sage-spkg`) regularly causes failures.




> And `sage -ba` takes 11 seconds on my laptop with warm caches.


[File system and ccache I guess.]

Well, if every Sage user|developer (at your choice) in the world gets such for free...

Otherwise we could just update the minimal hardware requirements (for building or developing with Sage).



---

archive/issue_comments_205741.json:
```json
{
    "body": "IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades. Of course feel free to volunteer to test and debug upgrades. As long as \"make distclean && make\" works I don't consider it a blocker.",
    "created_at": "2014-04-11T19:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205741",
    "user": "https://github.com/vbraun"
}
```

IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades. Of course feel free to volunteer to test and debug upgrades. As long as "make distclean && make" works I don't consider it a blocker.



---

archive/issue_events_047440.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-11T19:41:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16105#event-47440"
}
```



---

archive/issue_comments_205742.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-11T19:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205742",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_205743.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.\n\n\n*We worked hard<sup>TM</sup>* to make upgrading work (again), without much hassle such as having to artificially bump spkg patch levels to trigger a \"rebuild\", but people tend to create new pitfalls or refuse to remove the existing ones, and apparently don't care much about whether upgrading will work with their changes, so testing the latter is (or had been) mostly up to the release manager.\n\nAnd the \"disabling\" of upgrades *from* betas (or alphas to that time, IIRC) for a while presumably didn't encourage people to test upgrading either.\n\n\n\n\n> Of course feel free to volunteer to test and debug upgrades. As long as \"make distclean && make\" works I don't consider it a blocker.\n\n\n[http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist](http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist) B)\n\n(Once upon a time...)\n\n\nBuildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.",
    "created_at": "2014-04-11T20:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205743",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:28 vbraun]:
> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.


*We worked hard<sup>TM</sup>* to make upgrading work (again), without much hassle such as having to artificially bump spkg patch levels to trigger a "rebuild", but people tend to create new pitfalls or refuse to remove the existing ones, and apparently don't care much about whether upgrading will work with their changes, so testing the latter is (or had been) mostly up to the release manager.

And the "disabling" of upgrades *from* betas (or alphas to that time, IIRC) for a while presumably didn't encourage people to test upgrading either.




> Of course feel free to volunteer to test and debug upgrades. As long as "make distclean && make" works I don't consider it a blocker.


[http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist](http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist) B)

(Once upon a time...)


Buildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.



---

archive/issue_comments_205744.json:
```json
{
    "body": "Argh, trac...",
    "created_at": "2014-04-11T20:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205744",
    "user": "https://github.com/nexttime"
}
```

Argh, trac...



---

archive/issue_comments_205745.json:
```json
{
    "body": "Replying to [comment:30 leif]:\n> Buildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.\nAgreed. `env SAGE_UPGRADING=yes $MAKE` should always work.",
    "created_at": "2014-04-12T11:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205745",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:30 leif]:
> Buildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.
Agreed. `env SAGE_UPGRADING=yes $MAKE` should always work.



---

archive/issue_comments_205746.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.\n\nWell, if we would make `SAGE_UPGRADING=yes` the default, it should work. In the light of `ccache`, that's not such a stupid idea either.",
    "created_at": "2014-04-12T11:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205746",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 vbraun]:
> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.

Well, if we would make `SAGE_UPGRADING=yes` the default, it should work. In the light of `ccache`, that's not such a stupid idea either.



---

archive/issue_comments_205747.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> Agreed. `env SAGE_UPGRADING=yes $MAKE` should always work.\n\n\nI disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without \"make distclean\" will be guaranteed to work when the build system can reliably support them.",
    "created_at": "2014-04-12T23:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205747",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:32 jdemeyer]:
> Agreed. `env SAGE_UPGRADING=yes $MAKE` should always work.


I disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without "make distclean" will be guaranteed to work when the build system can reliably support them.



---

archive/issue_comments_205748.json:
```json
{
    "body": "Replying to [comment:34 vbraun]:\n> I disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without \"make distclean\" will be guaranteed to work when the build system can reliably support them.\n\nUpgrades worked fine up to Sage 5.13 (I always tested that) and that was with a much worse build system than we have now. And I guess this ticket here is maybe the first time since Sage 6.0 that upgrades break but it's also clearly a genuine bug which should be fixed.",
    "created_at": "2014-04-13T08:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205748",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:34 vbraun]:
> I disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without "make distclean" will be guaranteed to work when the build system can reliably support them.

Upgrades worked fine up to Sage 5.13 (I always tested that) and that was with a much worse build system than we have now. And I guess this ticket here is maybe the first time since Sage 6.0 that upgrades break but it's also clearly a genuine bug which should be fixed.



---

archive/issue_comments_205749.json:
```json
{
    "body": "I of course agree that this ticket was a genuine bug, and I'm happy that you fixed it. Still, we are not at a point where upgrading is guaranteed to work. Making that happen is a higher priority to me than checking whether or not it works right now.",
    "created_at": "2014-04-13T10:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205749",
    "user": "https://github.com/vbraun"
}
```

I of course agree that this ticket was a genuine bug, and I'm happy that you fixed it. Still, we are not at a point where upgrading is guaranteed to work. Making that happen is a higher priority to me than checking whether or not it works right now.



---

archive/issue_comments_205750.json:
```json
{
    "body": "I almost feel like I am watching on the side while eating popcorn :) ... But that will probably create me a bit of work in sage-on-gentoo by breaking patches :P\n\nSo I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked \"language = c++\". I am presuming that stdc++ is always brought in by the c++ compiler. So, in the patch I would expect it to be removed from: \n* sage.algebras.quatalg.quaternion_algebra_element\n* sage.algebras.quatalg.quaternion_algebra_cython\n* sage.numerical.backends.glpk_graph_backend\n\nNow I will try to work through the libs on my sage-on-gentoo install which is all compiled with --as-needed and see if you got the minimal set of library. I already have an answer for the top one in your patch, gmpxx is not needed:\n\n```\nldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so\n\tlinux-vdso.so.1 (0x00007fffe372b000)\n\tlibcsage.so => /usr/lib64/libcsage.so (0x00007f6d4cb06000)\n\tlibflint.so.2.4.3 => /usr/lib64/libflint.so.2.4.3 (0x00007f6d4c778000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f6d4c507000)\n\tlibstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007f6d4c1ff000)\n\tlibpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007f6d4be4e000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f6d4baa0000)\n\tlibntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007f6d4b6fe000)\n\tlibpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007f6d4b0bd000)\n\tlibgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007f6d4aea5000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f6d4ac88000)\n\tlibmpfr.so.4 => /usr/lib64/libmpfr.so.4 (0x00007f6d4aa2d000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f6d4a730000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f6d4cf88000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f6d4a52c000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007f6d4a329000)\n\tlibgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007f6d4a113000)\n```\nAnd readelf is even more minimalist:\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so\n\nDynamic section at offset 0x26c90 contains 30 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0x5938\n```\nlibpari probably comes through libcsage, all the rest, indirect linking...",
    "created_at": "2014-04-13T10:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205750",
    "user": "https://github.com/kiwifb"
}
```

I almost feel like I am watching on the side while eating popcorn :) ... But that will probably create me a bit of work in sage-on-gentoo by breaking patches :P

So I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked "language = c++". I am presuming that stdc++ is always brought in by the c++ compiler. So, in the patch I would expect it to be removed from: 
* sage.algebras.quatalg.quaternion_algebra_element
* sage.algebras.quatalg.quaternion_algebra_cython
* sage.numerical.backends.glpk_graph_backend

Now I will try to work through the libs on my sage-on-gentoo install which is all compiled with --as-needed and see if you got the minimal set of library. I already have an answer for the top one in your patch, gmpxx is not needed:

```
ldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so
	linux-vdso.so.1 (0x00007fffe372b000)
	libcsage.so => /usr/lib64/libcsage.so (0x00007f6d4cb06000)
	libflint.so.2.4.3 => /usr/lib64/libflint.so.2.4.3 (0x00007f6d4c778000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f6d4c507000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007f6d4c1ff000)
	libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007f6d4be4e000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f6d4baa0000)
	libntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007f6d4b6fe000)
	libpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007f6d4b0bd000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007f6d4aea5000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f6d4ac88000)
	libmpfr.so.4 => /usr/lib64/libmpfr.so.4 (0x00007f6d4aa2d000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f6d4a730000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f6d4cf88000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f6d4a52c000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007f6d4a329000)
	libgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007f6d4a113000)
```
And readelf is even more minimalist:

```
readelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so

Dynamic section at offset 0x26c90 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x5938
```
libpari probably comes through libcsage, all the rest, indirect linking...



---

archive/issue_comments_205751.json:
```json
{
    "body": "Next\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so\n\nDynamic section at offset 0xcd18 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0x29e0\n```\nand \n\n```\nldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so\n\tlinux-vdso.so.1 (0x00007fffbb1ff000)\n\tlibcsage.so => /usr/lib64/libcsage.so (0x00007ff74c655000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007ff74c3e5000)\n\tlibstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007ff74c0dc000)\n\tlibpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007ff74bd2b000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007ff74b97e000)\n\tlibntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007ff74b5db000)\n\tlibpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007ff74af9a000)\n\tlibgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007ff74ad83000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007ff74aa86000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007ff74cab4000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007ff74a869000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007ff74a665000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007ff74a461000)\n\tlibgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007ff74a24c000)\n```\nflint and gmpxx are absent.\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/groups/perm_gps/partn_ref2/refinement_generic.so\n\nDynamic section at offset 0x32cd8 contains 30 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0x5ec8\n```\ngmpxx not there and in consequence stdc++ is not there either. It is brought in indirectly by ntl through flint and csage from the ldd output.\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/libs/flint/flint.so\n\nDynamic section at offset 0x1da8 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0xf98\n```\n\nAt this stage I did a little research and found that the only extension linking directly to gmpxx is\n\n```\nFile: /usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so\n\nDynamic section at offset 0x42be8 contains 32 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmpxx.so.4]\n 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0xbd28\n```",
    "created_at": "2014-04-13T11:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205751",
    "user": "https://github.com/kiwifb"
}
```

Next

```
readelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so

Dynamic section at offset 0xcd18 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x29e0
```
and 

```
ldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so
	linux-vdso.so.1 (0x00007fffbb1ff000)
	libcsage.so => /usr/lib64/libcsage.so (0x00007ff74c655000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007ff74c3e5000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007ff74c0dc000)
	libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007ff74bd2b000)
	libc.so.6 => /lib64/libc.so.6 (0x00007ff74b97e000)
	libntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007ff74b5db000)
	libpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007ff74af9a000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007ff74ad83000)
	libm.so.6 => /lib64/libm.so.6 (0x00007ff74aa86000)
	/lib64/ld-linux-x86-64.so.2 (0x00007ff74cab4000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007ff74a869000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007ff74a665000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007ff74a461000)
	libgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007ff74a24c000)
```
flint and gmpxx are absent.

```
readelf -d /usr/lib64/python2.7/site-packages/sage/groups/perm_gps/partn_ref2/refinement_generic.so

Dynamic section at offset 0x32cd8 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x5ec8
```
gmpxx not there and in consequence stdc++ is not there either. It is brought in indirectly by ntl through flint and csage from the ldd output.

```
readelf -d /usr/lib64/python2.7/site-packages/sage/libs/flint/flint.so

Dynamic section at offset 0x1da8 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0xf98
```

At this stage I did a little research and found that the only extension linking directly to gmpxx is

```
File: /usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so

Dynamic section at offset 0x42be8 contains 32 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libgmpxx.so.4]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0xbd28
```



---

archive/issue_comments_205752.json:
```json
{
    "body": "Replying to [comment:37 fbissey]:\n> So I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked \"language = c++\".\n\nI am consistent, but just in a different way: I only removed `stdc++` if it appears at the end of the list of libraries, because the order matters. In theory, it could be that a build breaks by changing `-lstdc++ -lmylib -lstdc++` to `-lmylib -lstdc++`, but changing `-lmylib -lstdc++ -lstdc++` to `-lmylib -lstdc++` is always safe.\n\n> I am presuming that stdc++ is always brought in by the c++ compiler.\n\nYes, if `g++` is used instead of `gcc`. I'm not entirely sure this is always the case.",
    "created_at": "2014-04-13T11:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205752",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 fbissey]:
> So I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked "language = c++".

I am consistent, but just in a different way: I only removed `stdc++` if it appears at the end of the list of libraries, because the order matters. In theory, it could be that a build breaks by changing `-lstdc++ -lmylib -lstdc++` to `-lmylib -lstdc++`, but changing `-lmylib -lstdc++ -lstdc++` to `-lmylib -lstdc++` is always safe.

> I am presuming that stdc++ is always brought in by the c++ compiler.

Yes, if `g++` is used instead of `gcc`. I'm not entirely sure this is always the case.



---

archive/issue_comments_205753.json:
```json
{
    "body": "Replying to [comment:37 fbissey]:\n> libpari probably comes through libcsage, all the rest, indirect linking...\n\nPlease keep in mind that linking is a very system-dependent thing. If it works on Linux doesn't mean that it will work on OS X or Cygwin.",
    "created_at": "2014-04-13T11:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205753",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 fbissey]:
> libpari probably comes through libcsage, all the rest, indirect linking...

Please keep in mind that linking is a very system-dependent thing. If it works on Linux doesn't mean that it will work on OS X or Cygwin.



---

archive/issue_comments_205754.json:
```json
{
    "body": "I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand. As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked \"language=c++\". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).",
    "created_at": "2014-04-13T11:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205754",
    "user": "https://github.com/kiwifb"
}
```

I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand. As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked "language=c++". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).



---

archive/issue_comments_205755.json:
```json
{
    "body": "As an empirical fact linking works on the buildbot...",
    "created_at": "2014-04-13T12:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205755",
    "user": "https://github.com/vbraun"
}
```

As an empirical fact linking works on the buildbot...



---

archive/issue_comments_205756.json:
```json
{
    "body": "Replying to [comment:41 fbissey]:\n> I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand.\n\n\nWell, for MacOS X 10.4 at least, *provided the `install_name`s are correct*, as you know...\n\n\n\n\n> As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked \"language=c++\". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).\n\n\nThere at least used to be times where that was not the case (years ago, I admit).  Another problem is (or was) that the sources of a module may consist of both C and C++ files (although you'd actually just need `g++` *for linking* unless you explicitly specify `-lstdc++`, modulo probably different include paths), but there's just one `language` tag per extension module.  Compiling C99 sources as if they were C++ with a C++98 compiler also caused a lot of trouble in the past. \n\n\n\n\n(Also `--as-needed` didn't work when I tried about four years ago, IIRC due to some implicit assumptions on the import order.  I wasted a few weeks removing and adding libraries in `module_list.py`, when Robert B. told me the mechanism was subject to change on the Cython side anyway, so I didn't pursue that further.)",
    "created_at": "2014-04-13T15:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205756",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:41 fbissey]:
> I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand.


Well, for MacOS X 10.4 at least, *provided the `install_name`s are correct*, as you know...




> As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked "language=c++". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).


There at least used to be times where that was not the case (years ago, I admit).  Another problem is (or was) that the sources of a module may consist of both C and C++ files (although you'd actually just need `g++` *for linking* unless you explicitly specify `-lstdc++`, modulo probably different include paths), but there's just one `language` tag per extension module.  Compiling C99 sources as if they were C++ with a C++98 compiler also caused a lot of trouble in the past. 




(Also `--as-needed` didn't work when I tried about four years ago, IIRC due to some implicit assumptions on the import order.  I wasted a few weeks removing and adding libraries in `module_list.py`, when Robert B. told me the mechanism was subject to change on the Cython side anyway, so I didn't pursue that further.)



---

archive/issue_comments_205757.json:
```json
{
    "body": "For stdc++ I only named the one tagged with \"language=c++\". Yes there are other that include it but they have plain c sources and will be compiled with the c compiler so the extra stdc++ is necessary for them. I explicitly didn't mention them.\n\nMy comment is for those that are compiled with g++ remove it and that's the three I listed. For the other you leave them alone.\n\nI cannot tell when we started to have --as-needed working. I remember a time where it wasn't but now it definitely does.",
    "created_at": "2014-04-13T18:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205757",
    "user": "https://github.com/kiwifb"
}
```

For stdc++ I only named the one tagged with "language=c++". Yes there are other that include it but they have plain c sources and will be compiled with the c compiler so the extra stdc++ is necessary for them. I explicitly didn't mention them.

My comment is for those that are compiled with g++ remove it and that's the three I listed. For the other you leave them alone.

I cannot tell when we started to have --as-needed working. I remember a time where it wasn't but now it definitely does.



---

archive/issue_comments_205758.json:
```json
{
    "body": "John C. just reported for 6.2.beta8 (where this ticket got merged):\n\n```\nThis is a different problem to the one I reported on the other\nsage-release thread.  On my laptop (ubuntu 12.04) I had a working\nbuild of a previous beta, I think beta6.  I pulled from trac/develop\nand ran a make.  Here's the error message:\n\n\n[ -f local/etc/sage-started.txt ] || local/bin/sage-starts\nbuild/pipestatus \"./sage --docbuild --no-pdf-links all html  2>&1\"\n\"tee -a logs/dochtml.log\"\nTraceback (most recent call last):\n  File \"/home/john/sagegit/src/doc/common/builder.py\", line 1467, in <module>\n    import sage.all\n(...)\n  File \"/home/john/sagegit/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\",\nline 48, in <module>\n    import matrix_mpolynomial_dense\nImportError: libntl.so.2: cannot open shared object file: No such file\nor directory\n```\n\nWonder what went wrong, since due to the dependency of *every* extension module on `setup.py` the *whole* Sage library should have gotten rebuilt.",
    "created_at": "2014-04-17T12:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16105#issuecomment-205758",
    "user": "https://github.com/nexttime"
}
```

John C. just reported for 6.2.beta8 (where this ticket got merged):

```
This is a different problem to the one I reported on the other
sage-release thread.  On my laptop (ubuntu 12.04) I had a working
build of a previous beta, I think beta6.  I pulled from trac/develop
and ran a make.  Here's the error message:


[ -f local/etc/sage-started.txt ] || local/bin/sage-starts
build/pipestatus "./sage --docbuild --no-pdf-links all html  2>&1"
"tee -a logs/dochtml.log"
Traceback (most recent call last):
  File "/home/john/sagegit/src/doc/common/builder.py", line 1467, in <module>
    import sage.all
(...)
  File "/home/john/sagegit/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py",
line 48, in <module>
    import matrix_mpolynomial_dense
ImportError: libntl.so.2: cannot open shared object file: No such file
or directory
```

Wonder what went wrong, since due to the dependency of *every* extension module on `setup.py` the *whole* Sage library should have gotten rebuilt.
