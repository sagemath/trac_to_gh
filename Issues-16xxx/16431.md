# Issue 16431: sync-build is broken

archive/issues_016194.json:
```json
{
    "body": "`sage -sync-build` doesn't understand wildcards, so it deletes a bunch of correctly-installed `sage.symbolic` modules.\n\nReally, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.\n\nThere is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a `sage_setup` package that is installed with Sage and can be doctested in the usual manner.\n\nAlso:\n* Having `SAGE_LIB` point to `SAGE_SRC` is actually never useful, removed.\n* re-enable out-of-tree cythonize\n\nCC:  @nexttime\n\nBranch/Commit: e9ad95891f2a2292f7b67bd1f3bc1fa2ceb10d3b\n\nReviewer: R. Andrew Ohana\n\nAuthor: Volker Braun\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16431\n\n",
    "closed_at": "2014-06-08T12:09:02Z",
    "created_at": "2014-06-03T11:09:57Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "sync-build is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16431",
    "user": "https://github.com/vbraun"
}
```
`sage -sync-build` doesn't understand wildcards, so it deletes a bunch of correctly-installed `sage.symbolic` modules.

Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.

There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a `sage_setup` package that is installed with Sage and can be doctested in the usual manner.

Also:
* Having `SAGE_LIB` point to `SAGE_SRC` is actually never useful, removed.
* re-enable out-of-tree cythonize

CC:  @nexttime

Branch/Commit: e9ad95891f2a2292f7b67bd1f3bc1fa2ceb10d3b

Reviewer: R. Andrew Ohana

Author: Volker Braun

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16431





---

archive/issue_comments_225237.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2014-06-03T12:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225237",
    "user": "https://github.com/vbraun"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_225238.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+\\`sage -sync-build\\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \\`sage.symbolic\\` modules.\n \n+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process (assuming it doesn't take much time).\n+\n+While we are at it, we should probably re-enable out of tree cythonization.\n \n Summary: Run sync-build before docbuild\n \n```\n",
    "created_at": "2014-06-03T12:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225238",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
+\`sage -sync-build\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \`sage.symbolic\` modules.
 
+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process (assuming it doesn't take much time).
+
+While we are at it, we should probably re-enable out of tree cythonization.
 
 Summary: Run sync-build before docbuild
 
```




---

archive/issue_comments_225239.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2014-06-03T12:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225239",
    "user": "https://github.com/vbraun"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_225240.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+\\`sage -sync-build\\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \\`sage.symbolic\\` modules.\n+\n+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process (assuming it doesn't take much time).\n+\n+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \\`sage_setup\\` package that is installed with Sage and can be doctested in the usual manner.\n+\n+Also:\n+* Having \\`SAGE_LIB\\` point to \\`SAGE_SRC\\` is actually never useful, removed.\n \n \n Summary: Run sync-build before docbuild\n```\n",
    "created_at": "2014-06-04T10:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225240",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,11 @@
+\`sage -sync-build\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \`sage.symbolic\` modules.
+
+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process (assuming it doesn't take much time).
+
+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \`sage_setup\` package that is installed with Sage and can be doctested in the usual manner.
+
+Also:
+* Having \`SAGE_LIB\` point to \`SAGE_SRC\` is actually never useful, removed.
 
 
 Summary: Run sync-build before docbuild
```




---

archive/issue_comments_225241.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2014-06-04T14:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225241",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_225242.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-04T14:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225242",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_225243.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+\\`sage -sync-build\\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \\`sage.symbolic\\` modules.\n+\n+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.\n+\n+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \\`sage_setup\\` package that is installed with Sage and can be doctested in the usual manner.\n+\n+Also:\n+* Having \\`SAGE_LIB\\` point to \\`SAGE_SRC\\` is actually never useful, removed.\n \n \n Summary: Run sync-build before docbuild\n```\n",
    "created_at": "2014-06-04T14:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225243",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,11 @@
+\`sage -sync-build\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \`sage.symbolic\` modules.
+
+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.
+
+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \`sage_setup\` package that is installed with Sage and can be doctested in the usual manner.
+
+Also:
+* Having \`SAGE_LIB\` point to \`SAGE_SRC\` is actually never useful, removed.
 
 
 Summary: Run sync-build before docbuild
```




---

archive/issue_comments_225244.json:
```json
{
    "body": "<a id='comment:6'></a>I'm not up to review this, but I do have two questions:\n1. Why not remove `-ba-force` if it is exactly the same as `-ba`? At least its description should be updated.\n2. In `find_python_sources` and `installed_files_by_module` the use `os.chdir` seems uneeded. Can we just use a different argument to `os.walk`?",
    "created_at": "2014-06-04T14:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225244",
    "user": "https://github.com/mathzeta"
}
```

<a id='comment:6'></a>I'm not up to review this, but I do have two questions:
1. Why not remove `-ba-force` if it is exactly the same as `-ba`? At least its description should be updated.
2. In `find_python_sources` and `installed_files_by_module` the use `os.chdir` seems uneeded. Can we just use a different argument to `os.walk`?



---

archive/issue_comments_225245.json:
```json
{
    "body": "<a id='comment:7'></a>1. removal needs deprecation etc. Really it doesn't hurt to keep that alias around.\n2. its faster to construct the right relative path from the get-go than having to strip off a leading component.",
    "created_at": "2014-06-04T15:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225245",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>1. removal needs deprecation etc. Really it doesn't hurt to keep that alias around.
2. its faster to construct the right relative path from the get-go than having to strip off a leading component.



---

archive/issue_comments_225246.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-04T15:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225246",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_225247.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+\\`sage -sync-build\\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \\`sage.symbolic\\` modules.\n \n+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.\n+\n+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \\`sage_setup\\` package that is installed with Sage and can be doctested in the usual manner.\n+\n+Also:\n+* Having \\`SAGE_LIB\\` point to \\`SAGE_SRC\\` is actually never useful, removed.\n+* re-enable out-of-tree cythonize\n \n Summary: Run sync-build before docbuild\n \n```\n",
    "created_at": "2014-06-04T15:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225247",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+\`sage -sync-build\` doesn't understand wildcards, so it deletes a bunch of correctly-installed \`sage.symbolic\` modules.
 
+Really, the whole concept is broken. We should at the very least record what is being installed instead of trying to guess it in sync-build. Even better, make it part of the build process.
+
+There is quite a lot of setup code, none of which is doctested. And, therefore, broken. As this ticket shows. I've started to move setup code into a \`sage_setup\` package that is installed with Sage and can be doctested in the usual manner.
+
+Also:
+* Having \`SAGE_LIB\` point to \`SAGE_SRC\` is actually never useful, removed.
+* re-enable out-of-tree cythonize
 
 Summary: Run sync-build before docbuild
 
```




---

archive/issue_comments_225248.json:
```json
{
    "body": "<a id='comment:11'></a>I think you can remove the `sdist` variable entirely from `setup.py`, i.e., also\n\n```python\nif len(sys.argv) > 1 and sys.argv[1] == \"sdist\":\n    sdist = True\nelse:\n    sdist = False\n```",
    "created_at": "2014-06-04T16:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225248",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>I think you can remove the `sdist` variable entirely from `setup.py`, i.e., also

```python
if len(sys.argv) > 1 and sys.argv[1] == "sdist":
    sdist = True
else:
    sdist = False
```



---

archive/issue_comments_225249.json:
```json
{
    "body": "<a id='comment:12'></a>Yes, the setup.py should be broken up and doctested. And we need to decide whether we want to support sdist or not (in which case the Manifest.in can probably go, too). But thats for another ticket.",
    "created_at": "2014-06-04T17:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225249",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Yes, the setup.py should be broken up and doctested. And we need to decide whether we want to support sdist or not (in which case the Manifest.in can probably go, too). But thats for another ticket.



---

archive/issue_comments_225250.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 vbraun]:\n> And we need to decide whether we want to support sdist or not (in which case the Manifest.in can probably go, too).\n\n\nIs that (still) used anywhere in Sage?  (I mean calling *Sage's* `setup.py` with `sdist`.)",
    "created_at": "2014-06-04T18:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225250",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>Replying to [comment:12 vbraun]:
> And we need to decide whether we want to support sdist or not (in which case the Manifest.in can probably go, too).


Is that (still) used anywhere in Sage?  (I mean calling *Sage's* `setup.py` with `sdist`.)



---

archive/issue_comments_225251.json:
```json
{
    "body": "<a id='comment:14'></a>Off-topic, but as far as I know we don't currently use distutils `sdist` anywhere.",
    "created_at": "2014-06-04T18:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225251",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>Off-topic, but as far as I know we don't currently use distutils `sdist` anywhere.



---

archive/issue_comments_225252.json:
```json
{
    "body": "<a id='comment:15'></a>Just for the record:  This doesn't fix my docbuild-broken upgraded Sage version (but I didn't really expect it to either; I think it's rather some Sphinx-brokenness w.r.t. Python's multiprocessing).",
    "created_at": "2014-06-04T18:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225252",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>Just for the record:  This doesn't fix my docbuild-broken upgraded Sage version (but I didn't really expect it to either; I think it's rather some Sphinx-brokenness w.r.t. Python's multiprocessing).



---

archive/issue_comments_225253.json:
```json
{
    "body": "<a id='comment:16'></a>No, thats fixed in #16440",
    "created_at": "2014-06-04T19:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225253",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>No, thats fixed in #16440



---

archive/issue_comments_225254.json:
```json
{
    "body": "<a id='comment:17'></a>Mostly looks good, I haven't checked cython modules, but it doesn't seem like it really handles them at the moment (which would agree with some TODO I think I read in the documentation of some function). Are you planning on adding support for them at the moment, or on a future ticket?\n\nI added a few minor reviewer changes.\n\n---\nNew commits:",
    "created_at": "2014-06-06T04:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225254",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:17'></a>Mostly looks good, I haven't checked cython modules, but it doesn't seem like it really handles them at the moment (which would agree with some TODO I think I read in the documentation of some function). Are you planning on adding support for them at the moment, or on a future ticket?

I added a few minor reviewer changes.

---
New commits:



---

archive/issue_comments_225255.json:
```json
{
    "body": "<a id='comment:18'></a>Just to clarify: Building / cleaning of Cython modules works. Only the doctest that no cython files are being cleaned after a successful build needs work. In particular, the `module_list.py` would need to be importable **after** building. Could be done with a sys.path hack, but I'd rather do it properly later on.",
    "created_at": "2014-06-06T10:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225255",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Just to clarify: Building / cleaning of Cython modules works. Only the doctest that no cython files are being cleaned after a successful build needs work. In particular, the `module_list.py` would need to be importable **after** building. Could be done with a sys.path hack, but I'd rather do it properly later on.



---

archive/issue_comments_225256.json:
```json
{
    "body": "<a id='comment:19'></a>PS: any further functionality should go to a future ticket.",
    "created_at": "2014-06-06T10:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225256",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>PS: any further functionality should go to a future ticket.



---

archive/issue_comments_225257.json:
```json
{
    "body": "<a id='comment:20'></a>Ah, yes. Looking at it again, seems fine. Everything works as expected.",
    "created_at": "2014-06-07T06:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225257",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:20'></a>Ah, yes. Looking at it again, seems fine. Everything works as expected.



---

archive/issue_comments_225258.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-07T06:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225258",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_048344.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-08T12:09:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16431#event-48344"
}
```



---

archive/issue_comments_225259.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-08T12:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16431",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16431#issuecomment-225259",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
