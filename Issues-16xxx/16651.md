# Issue 16651: Buggy to_poly_solve option

archive/issues_016414.json:
```json
{
    "assignees": [],
    "body": "The `SR.solve(..., to_poly_solve=True)` option does weird things:\n\n```\nsage: (x^7-x-1).solve(x, to_poly_solve=True)\n[x == 1.11277569705, x == (0.617093477784 - 0.900864951949*I), x == (-0.809857800594 + 0.262869645851*I), x == (-0.363623519329 + 0.952561195261*I), x == (-240/913*I - 4157/5133), x == (-3775/3963*I - 2573/7076), x == (1354/1503*I + 2000/3241)]\n```\nNote that none of the solutions are actually Gaussian rationals. Maxima gives correct output:\n\n```\nmaxima: load(to_poly_solve)$\nLoadingmaxima-grobner$Revision:1.6$$Date:2009-06-0207:49:49$\nmaxima: to_poly_solve(x^7-x-1 = 0, x);    \n%union([x=1.11277569704536],[x=-0.9525611952610316*%i-0.36362351932918313],[x=0.6170934777839656-0.9008649519489099*%i],[x=-0.2628696458512362*%i-0.8098578005941353],[x=0.2628696458512362*%i-0.8098578005941353],[x=0.9008649519489099*%i+0.6170934777839656],[x=0.9525611952610316*%i-0.36362351932918313])\n```\nBut our parsing of the output is totally off, starting at an iteration over the output list while modifying the output list.\n\n\nCC:  @kcrisman\n\nBranch/Commit: **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**\n\nReviewer: **Ralf Stephan**\n\nAuthor: **Volker Braun**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/16651_\n\n",
    "closed_at": "2014-09-06T11:02:58Z",
    "created_at": "2014-07-12T22:15:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Buggy to_poly_solve option",
    "type": "issue",
    "updated_at": "2014-09-06T11:02:58Z",
    "url": "https://github.com/sagemath/sage/issues/16651",
    "user": "https://github.com/gagern"
}
```
The `SR.solve(..., to_poly_solve=True)` option does weird things:

```
sage: (x^7-x-1).solve(x, to_poly_solve=True)
[x == 1.11277569705, x == (0.617093477784 - 0.900864951949*I), x == (-0.809857800594 + 0.262869645851*I), x == (-0.363623519329 + 0.952561195261*I), x == (-240/913*I - 4157/5133), x == (-3775/3963*I - 2573/7076), x == (1354/1503*I + 2000/3241)]
```
Note that none of the solutions are actually Gaussian rationals. Maxima gives correct output:

```
maxima: load(to_poly_solve)$
Loadingmaxima-grobner$Revision:1.6$$Date:2009-06-0207:49:49$
maxima: to_poly_solve(x^7-x-1 = 0, x);    
%union([x=1.11277569704536],[x=-0.9525611952610316*%i-0.36362351932918313],[x=0.6170934777839656-0.9008649519489099*%i],[x=-0.2628696458512362*%i-0.8098578005941353],[x=0.2628696458512362*%i-0.8098578005941353],[x=0.9008649519489099*%i+0.6170934777839656],[x=0.9525611952610316*%i-0.36362351932918313])
```
But our parsing of the output is totally off, starting at an iteration over the output list while modifying the output list.


CC:  @kcrisman

Branch/Commit: **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**

Reviewer: **Ralf Stephan**

Author: **Volker Braun**

_Issue created by migration from https://trac.sagemath.org/ticket/16651_





---

archive/issue_events_212563.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2014-07-12T22:15:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212563"
}
```



---

archive/issue_events_212564.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2014-07-12T22:15:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20fields",
    "label_color": "0000ff",
    "label_name": "component: number fields",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212564"
}
```



---

archive/issue_events_212565.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2014-07-12T22:15:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212565"
}
```



---

archive/issue_events_212566.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2014-07-12T22:15:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212566"
}
```



---

archive/issue_comments_219765.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nCc-ing kcrisman since his commit [3278794](https://github.com/sagemath/sagetrac-mirror/commit/3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?\n\nI've written code for #14239 to suite my perceived needs there. Including a fallback from `to_poly_solve=False` to `to_poly_solve=True` for which I don't have a test case either. It might turn out that we went very similar things in both these places, and we want to factor them out into some common function. For the moment I felt that having separate code might increase chances that my code gets a positive review, since new code is less likely to break expectations than tinkering with existing code.",
    "created_at": "2014-07-13T01:55:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219765",
    "user": "https://github.com/gagern"
}
```

<a id='comment:1'>Comment 1:</a>
Cc-ing kcrisman since his commit [3278794](https://github.com/sagemath/sagetrac-mirror/commit/3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?

I've written code for #14239 to suite my perceived needs there. Including a fallback from `to_poly_solve=False` to `to_poly_solve=True` for which I don't have a test case either. It might turn out that we went very similar things in both these places, and we want to factor them out into some common function. For the moment I felt that having separate code might increase chances that my code gets a positive review, since new code is less likely to break expectations than tinkering with existing code.



---

archive/issue_events_212567.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-14T15:32:16Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "title_is": "Buggy to_poly_solve option",
    "title_was": "NumberField to SymbolicRing: rational but still approximate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212567"
}
```



---

archive/issue_comments_219766.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,15 +1,16 @@\n-I noticed this in [#14239 comment:18](https://github.com/sagemath/sage/issues/14239#comment:18).\n+The `SR.solve(..., to_poly_solve=True)` option does weird things:\n \n ```\n-sage: poly = QQ[x](x^7 - x - 1)\n-sage: root = sorted(poly.roots(QQbar, False), key=imag)[0]\n-sage: root\n--0.3636235193291805? - 0.9525611952610331?*I\n-sage: nf = NumberField(poly, \"y\", embedding=CC(root))\n-sage: z = SR(nf.gen()); z\n--3775/3963*I - 2573/7076\n-sage: poly(QQbar(z)).is_zero()\n-False\n+sage: (x^7-x-1).solve(x, to_poly_solve=True)\n+[x == 1.11277569705, x == (0.617093477784 - 0.900864951949*I), x == (-0.809857800594 + 0.262869645851*I), x == (-0.363623519329 + 0.952561195261*I), x == (-240/913*I - 4157/5133), x == (-3775/3963*I - 2573/7076), x == (1354/1503*I + 2000/3241)]\n ```\n+Note that none of the solutions are actually Gaussian rationals. Maxima gives correct output:\n \n-The problem here for me as a user is the fact that when I see rational numbers in some expression, I expect them to be accurate. But the conversion to SR here uses `solve(to_poly_solve=True)`, which according to its documentation may yield approximate solutions. I'm still surprised that these approximate solutions may take the form of elements from \u211a[I]. I guess some code further down the line might get confused as well, since these conversions look as if they were exact.\n+```\n+maxima: load(to_poly_solve)$\n+Loadingmaxima-grobner$Revision:1.6$$Date:2009-06-0207:49:49$\n+maxima: to_poly_solve(x^7-x-1 = 0, x);    \n+%union([x=1.11277569704536],[x=-0.9525611952610316*%i-0.36362351932918313],[x=0.6170934777839656-0.9008649519489099*%i],[x=-0.2628696458512362*%i-0.8098578005941353],[x=0.2628696458512362*%i-0.8098578005941353],[x=0.9008649519489099*%i+0.6170934777839656],[x=0.9525611952610316*%i-0.36362351932918313])\n+```\n+But our parsing of the output is totally off, starting at an iteration over the output list while modifying the output list.\n+\n``````\n",
    "created_at": "2014-07-14T15:32:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219766",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,15 +1,16 @@
-I noticed this in [#14239 comment:18](https://github.com/sagemath/sage/issues/14239#comment:18).
+The `SR.solve(..., to_poly_solve=True)` option does weird things:
 
 ```
-sage: poly = QQ[x](x^7 - x - 1)
-sage: root = sorted(poly.roots(QQbar, False), key=imag)[0]
-sage: root
--0.3636235193291805? - 0.9525611952610331?*I
-sage: nf = NumberField(poly, "y", embedding=CC(root))
-sage: z = SR(nf.gen()); z
--3775/3963*I - 2573/7076
-sage: poly(QQbar(z)).is_zero()
-False
+sage: (x^7-x-1).solve(x, to_poly_solve=True)
+[x == 1.11277569705, x == (0.617093477784 - 0.900864951949*I), x == (-0.809857800594 + 0.262869645851*I), x == (-0.363623519329 + 0.952561195261*I), x == (-240/913*I - 4157/5133), x == (-3775/3963*I - 2573/7076), x == (1354/1503*I + 2000/3241)]
 ```
+Note that none of the solutions are actually Gaussian rationals. Maxima gives correct output:
 
-The problem here for me as a user is the fact that when I see rational numbers in some expression, I expect them to be accurate. But the conversion to SR here uses `solve(to_poly_solve=True)`, which according to its documentation may yield approximate solutions. I'm still surprised that these approximate solutions may take the form of elements from ℚ[I]. I guess some code further down the line might get confused as well, since these conversions look as if they were exact.
+```
+maxima: load(to_poly_solve)$
+Loadingmaxima-grobner$Revision:1.6$$Date:2009-06-0207:49:49$
+maxima: to_poly_solve(x^7-x-1 = 0, x);    
+%union([x=1.11277569704536],[x=-0.9525611952610316*%i-0.36362351932918313],[x=0.6170934777839656-0.9008649519489099*%i],[x=-0.2628696458512362*%i-0.8098578005941353],[x=0.2628696458512362*%i-0.8098578005941353],[x=0.9008649519489099*%i+0.6170934777839656],[x=0.9525611952610316*%i-0.36362351932918313])
+```
+But our parsing of the output is totally off, starting at an iteration over the output list while modifying the output list.
+
``````




---

archive/issue_comments_219767.json:
```json
{
    "body": "Branch: **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)**",
    "created_at": "2014-07-15T02:50:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219767",
    "user": "https://github.com/vbraun"
}
```

Branch: **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)**



---

archive/issue_comments_219768.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2014-07-15T02:52:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219768",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_comments_219769.json:
```json
{
    "body": "Commit: **[38a52cf](https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf)**",
    "created_at": "2014-07-15T02:52:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219769",
    "user": "https://github.com/vbraun"
}
```

Commit: **[38a52cf](https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf)**



---

archive/issue_comments_219770.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf\">38a52cf</a></td><td><code>Make the to_poly_solve option work</code></td></tr></table>\n",
    "created_at": "2014-07-15T02:52:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219770",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'>Comment 4:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf">38a52cf</a></td><td><code>Make the to_poly_solve option work</code></td></tr></table>




---

archive/issue_events_212568.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-15T02:52:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20fields",
    "label_color": "0000ff",
    "label_name": "component: number fields",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212568"
}
```



---

archive/issue_events_212569.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-15T02:52:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "component: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212569"
}
```



---

archive/issue_events_212570.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-15T03:00:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212570"
}
```



---

archive/issue_comments_219771.json:
```json
{
    "body": "Changed commit from **[38a52cf](https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf)** to **[2573b80](https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569)**",
    "created_at": "2014-07-15T04:01:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219771",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[38a52cf](https://github.com/sagemath/sagetrac-mirror/commit/38a52cfb78fbe0ebd5221b5d52bb511210084aaf)** to **[2573b80](https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569)**



---

archive/issue_comments_219772.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569\">2573b80</a></td><td><code>fix two trivial doctest failures</code></td></tr></table>\n",
    "created_at": "2014-07-15T04:01:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219772",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:6'>Comment 6:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569">2573b80</a></td><td><code>fix two trivial doctest failures</code></td></tr></table>




---

archive/issue_comments_219773.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nDoctests all pass now...",
    "created_at": "2014-07-15T04:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219773",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'>Comment 7:</a>
Doctests all pass now...



---

archive/issue_comments_219774.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI guess it might be next week before I find the time to have a closer look at this. And I don't know the code in this area, and have little experience with Maxima itself either. In any case, would I be correct to assume that `options='algexact:true'` is the critical point here?\n\nNotes to self or any other reviewer:\n* Omitting `multiplicities` in the condition makes sense, since `to_poly_solve=True, multiplicities=True` would already raise a `NotImplementedException` earlier on.\n* Not messing around with `repr(x) in \u2026` is certainly a good thing.\n* The move from `Y = \u2026.sage()` to `T = string_to_list_of_solutions(repr(s))` I don't understand yet. Need a closer look.\n* The rationale behind `ignore_exceptions` I don't understand either yet.\n\nA lot of this appears to be drive-by-fixes which make sense but are not immediately related to this bug here. Is that correct? Can you come up with doctests for the things these fix, if it's more than code simplification? For example I suppose that having one variable name as a substring of another might confuse this `repr(x)` hackery.\n\nI would prefer changing the `while todo: ex = todo.pop()` back to `for eq in todo:`. As it stands now, the idiom suggests that you might be adding stuff to the list within the loop. This even had me concerned about infinite loops for a moment. But you don't do that, you simply iterate over the list.",
    "created_at": "2014-07-15T08:47:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219774",
    "user": "https://github.com/gagern"
}
```

<a id='comment:8'>Comment 8:</a>
I guess it might be next week before I find the time to have a closer look at this. And I don't know the code in this area, and have little experience with Maxima itself either. In any case, would I be correct to assume that `options='algexact:true'` is the critical point here?

Notes to self or any other reviewer:
* Omitting `multiplicities` in the condition makes sense, since `to_poly_solve=True, multiplicities=True` would already raise a `NotImplementedException` earlier on.
* Not messing around with `repr(x) in …` is certainly a good thing.
* The move from `Y = ….sage()` to `T = string_to_list_of_solutions(repr(s))` I don't understand yet. Need a closer look.
* The rationale behind `ignore_exceptions` I don't understand either yet.

A lot of this appears to be drive-by-fixes which make sense but are not immediately related to this bug here. Is that correct? Can you come up with doctests for the things these fix, if it's more than code simplification? For example I suppose that having one variable name as a substring of another might confuse this `repr(x)` hackery.

I would prefer changing the `while todo: ex = todo.pop()` back to `for eq in todo:`. As it stands now, the idiom suggests that you might be adding stuff to the list within the loop. This even had me concerned about infinite loops for a moment. But you don't do that, you simply iterate over the list.



---

archive/issue_comments_219775.json:
```json
{
    "body": "Changed commit from **[2573b80](https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569)** to **[6fb6bee](https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1)**",
    "created_at": "2014-07-15T12:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219775",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2573b80](https://github.com/sagemath/sagetrac-mirror/commit/2573b80af24cf5938c089758dff7304ca53c9569)** to **[6fb6bee](https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1)**



---

archive/issue_comments_219776.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1\">6fb6bee</a></td><td><code>Use for loop instead of while</code></td></tr></table>\n",
    "created_at": "2014-07-15T12:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219776",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:9'>Comment 9:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1">6fb6bee</a></td><td><code>Use for loop instead of while</code></td></tr></table>




---

archive/issue_comments_219777.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nThanks, I switched to the while because the original code did add/remove stuff. But that was all wrong, and I forgot to switch it back. \n\nThe main bug of the entire logic was that `X` was being iterated over and modified at the same time, so some solutions were skipped while other solutions were ran twice through Maxima. The first call to Maxima yielded a floating-point answer, and in the subsequent call Maxima converted the floating-point number to a rational.\n\nThere was a similar bug when solve originally found no solution, causing maxima `to_poly_solve` to be called twice. I fixed that, too.\n\nThe main doctest is the one you gave where some numerical solutions were incorrectly returned as rational.",
    "created_at": "2014-07-15T12:55:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219777",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'>Comment 10:</a>
Thanks, I switched to the while because the original code did add/remove stuff. But that was all wrong, and I forgot to switch it back. 

The main bug of the entire logic was that `X` was being iterated over and modified at the same time, so some solutions were skipped while other solutions were ran twice through Maxima. The first call to Maxima yielded a floating-point answer, and in the subsequent call Maxima converted the floating-point number to a rational.

There was a similar bug when solve originally found no solution, causing maxima `to_poly_solve` to be called twice. I fixed that, too.

The main doctest is the one you gave where some numerical solutions were incorrectly returned as rational.



---

archive/issue_comments_219778.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nBtw the `options='algexact:true'` is suggested by the maximal manual. It makes it more likely to find an exact solution.",
    "created_at": "2014-07-15T19:06:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219778",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'>Comment 11:</a>
Btw the `options='algexact:true'` is suggested by the maximal manual. It makes it more likely to find an exact solution.



---

archive/issue_comments_219779.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\n> Cc-ing kcrisman since his commit [3278794](https://github.com/sagemath/sagetrac-mirror/commit/3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?\n\nThis was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n\nBut I'm very happy if someone cleans up whatever code I contributed so long ago - I wrangled over that in various ways to make sure that if somebody really wanted a solution they would get one, but it was certainly just to get things done.  Thanks for looking into it!",
    "created_at": "2014-07-17T02:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219779",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'>Comment 12:</a>
> Cc-ing kcrisman since his commit [3278794](https://github.com/sagemath/sagetrac-mirror/commit/3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?

This was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.

But I'm very happy if someone cleans up whatever code I contributed so long ago - I wrangled over that in various ways to make sure that if somebody really wanted a solution they would get one, but it was certainly just to get things done.  Thanks for looking into it!



---

archive/issue_comments_219780.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@kcrisman](#comment%3A12):\n> This was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n\nMust have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?\n\nIn that case, I might as well remove the whole `to_poly_solve=True` stuff from my commit for #14239, since I'd filter out inexact solutions in any case.\n\n(Sorry, had to edit this comment; I hadn't realized we were not talking on #14239 already.)",
    "created_at": "2014-07-17T07:16:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219780",
    "user": "https://github.com/gagern"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@kcrisman](#comment%3A12):
> This was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.

Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?

In that case, I might as well remove the whole `to_poly_solve=True` stuff from my commit for #14239, since I'd filter out inexact solutions in any case.

(Sorry, had to edit this comment; I hadn't realized we were not talking on #14239 already.)



---

archive/issue_comments_219781.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nFor `NumberFieldElement` I wonder whether it would be better to not use an approximate solution, but instead convert to `QQbar` and then embed that into `SR`. Only if there exists no radical solution, to be sure. Visually it would look the same: numbers get printed as an approximation. Mathematically, though, things would be exact.\n\nThere might be downsides, of course. Some computations might fail because they aren't defined for algebraic numbers. Some others might take considerably longer. And there would be no reasonable way to deprecate current behavior, because we have to return one or the other, there seems to be no reasonable way in between. How would one go about discussing a possible change like this?\n\nIn any case, that would be a different ticket, since this one here is about the incorrect rationals, which I'll try to review this weekend. Converting to `QQbar` would also require #5355 to be addressed first.",
    "created_at": "2014-07-17T07:32:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219781",
    "user": "https://github.com/gagern"
}
```

<a id='comment:14'>Comment 14:</a>
For `NumberFieldElement` I wonder whether it would be better to not use an approximate solution, but instead convert to `QQbar` and then embed that into `SR`. Only if there exists no radical solution, to be sure. Visually it would look the same: numbers get printed as an approximation. Mathematically, though, things would be exact.

There might be downsides, of course. Some computations might fail because they aren't defined for algebraic numbers. Some others might take considerably longer. And there would be no reasonable way to deprecate current behavior, because we have to return one or the other, there seems to be no reasonable way in between. How would one go about discussing a possible change like this?

In any case, that would be a different ticket, since this one here is about the incorrect rationals, which I'll try to review this weekend. Converting to `QQbar` would also require #5355 to be addressed first.



---

archive/issue_comments_219782.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nConsidering that there is only so much that you can do for a univariate polyonomial, I guess its true that you don't benefit from `to_poly_solve=True` in #14239.\n\nIf you have fundamental questions about `NumberFieldElement` you should post to sage-devel. None of its original authors will read this ticket.",
    "created_at": "2014-07-17T14:22:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219782",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'>Comment 15:</a>
Considering that there is only so much that you can do for a univariate polyonomial, I guess its true that you don't benefit from `to_poly_solve=True` in #14239.

If you have fundamental questions about `NumberFieldElement` you should post to sage-devel. None of its original authors will read this ticket.



---

archive/issue_comments_219783.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\n> > This was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n\n> \n> Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?\n\nAbsolutely not.  `to_poly_solve` was added to get lots more exact solution.  As a byproduct of that, occasionally inexact solutions are returned.  See the documentation for `solve?` or `x.solve?` for lots of examples.",
    "created_at": "2014-07-18T14:05:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219783",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:16'>Comment 16:</a>
> > This was because of [#6642 comment:7](https://github.com/sagemath/sage/issues/6642#comment:7).  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.

> 
> Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?

Absolutely not.  `to_poly_solve` was added to get lots more exact solution.  As a byproduct of that, occasionally inexact solutions are returned.  See the documentation for `solve?` or `x.solve?` for lots of examples.



---

archive/issue_comments_219784.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@kcrisman](#comment%3A16):\n> Absolutely not.  `to_poly_solve` was added to get lots more exact solution. \n\nBut the cases where you do get more exact solutions are not univariate polynomials.",
    "created_at": "2014-07-18T14:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219784",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@kcrisman](#comment%3A16):
> Absolutely not.  `to_poly_solve` was added to get lots more exact solution. 

But the cases where you do get more exact solutions are not univariate polynomials.



---

archive/issue_events_212571.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212571"
}
```



---

archive/issue_events_212572.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212572"
}
```



---

archive/issue_comments_219785.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\n> > Absolutely not.  `to_poly_solve` was added to get lots more exact solution. \n\n> \n> But the cases where you do get more exact solutions are not univariate polynomials.\n\nHmm, that is most likely true, since the point is to solve things that are not polynomials (you convert them to polys), though I'm not 100% sure - I would want to confirm that with Barton.",
    "created_at": "2014-08-15T11:14:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219785",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:19'>Comment 19:</a>
> > Absolutely not.  `to_poly_solve` was added to get lots more exact solution. 

> 
> But the cases where you do get more exact solutions are not univariate polynomials.

Hmm, that is most likely true, since the point is to solve things that are not polynomials (you convert them to polys), though I'm not 100% sure - I would want to confirm that with Barton.



---

archive/issue_comments_219786.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nThe only thing like that I could find in the documentation was\n\n```\nto_poly_solve(x^(2*a) + x^a + 1,x);\n```\nbut that's for a generic variable `a`.",
    "created_at": "2014-08-27T16:47:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219786",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:20'>Comment 20:</a>
The only thing like that I could find in the documentation was

```
to_poly_solve(x^(2*a) + x^a + 1,x);
```
but that's for a generic variable `a`.



---

archive/issue_comments_219787.json:
```json
{
    "body": "Changed branch from **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)** to **[u/rws/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/buggy_to_poly_solve)**",
    "created_at": "2014-09-01T08:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219787",
    "user": "https://github.com/rwst"
}
```

Changed branch from **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)** to **[u/rws/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/buggy_to_poly_solve)**



---

archive/issue_events_212573.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-09-01T08:47:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212573"
}
```



---

archive/issue_events_212574.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-09-01T08:47:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212574"
}
```



---

archive/issue_comments_219788.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nThe buildbot error is unrelated, the changes look good. I just removed some pidgin fom the text.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c534e55a3cdc0f2dc13262aea91d8a0afd553492\">c534e55</a></td><td><code>Merge branch 'develop' into t/16651/buggy_to_poly_solve</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5\">a801e64</a></td><td><code>16651: reviewer's patch: language refinements</code></td></tr></table>\n",
    "created_at": "2014-09-01T08:47:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219788",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'>Comment 22:</a>
The buildbot error is unrelated, the changes look good. I just removed some pidgin fom the text.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c534e55a3cdc0f2dc13262aea91d8a0afd553492">c534e55</a></td><td><code>Merge branch 'develop' into t/16651/buggy_to_poly_solve</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5">a801e64</a></td><td><code>16651: reviewer's patch: language refinements</code></td></tr></table>




---

archive/issue_comments_219789.json:
```json
{
    "body": "Changed commit from **[6fb6bee](https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1)** to **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**",
    "created_at": "2014-09-01T08:47:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219789",
    "user": "https://github.com/rwst"
}
```

Changed commit from **[6fb6bee](https://github.com/sagemath/sagetrac-mirror/commit/6fb6bee3a7ef1f692656f615f9361c9e52afeec1)** to **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**



---

archive/issue_comments_219790.json:
```json
{
    "body": "Reviewer: **Ralf Stephan**",
    "created_at": "2014-09-01T08:47:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219790",
    "user": "https://github.com/rwst"
}
```

Reviewer: **Ralf Stephan**



---

archive/issue_comments_219791.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nIf you're going to fix language that didn't need fixing (\"the use\" isn't necessary, imo, but the fix is fine too), then one should fix\n* \n\n```\n``force``\n``'force'``\n```\n* \n\n```\nan univariate\na univariate\n```",
    "created_at": "2014-09-02T12:26:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219791",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:23'>Comment 23:</a>
If you're going to fix language that didn't need fixing ("the use" isn't necessary, imo, but the fix is fine too), then one should fix
* 

```
``force``
``'force'``
```
* 

```
an univariate
a univariate
```



---

archive/issue_comments_219792.json:
```json
{
    "body": "Changed branch from **[u/rws/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/buggy_to_poly_solve)** to **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)**",
    "created_at": "2014-09-02T15:06:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219792",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/rws/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/buggy_to_poly_solve)** to **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)**



---

archive/issue_events_212575.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-06T11:02:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212575"
}
```



---

archive/issue_events_212576.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-06T11:02:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16651#event-212576"
}
```



---

archive/issue_comments_219793.json:
```json
{
    "body": "Changed branch from **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)** to **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**",
    "created_at": "2014-09-06T11:02:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16651",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16651#issuecomment-219793",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/vbraun/buggy_to_poly_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/buggy_to_poly_solve)** to **[a801e64](https://github.com/sagemath/sagetrac-mirror/commit/a801e64f1802c2133c2f362ab84aa122c54530b5)**
