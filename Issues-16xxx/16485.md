# Issue 16485: "TypeError: keys do not match self's parent" computing variety of MPolynomialIdeal_singular_repr

archive/issues_016248.json:
```json
{
    "body": "Trying to compute a variety, I get an error instead. The code snippets are from [multi_polynomial_ideal as of Sage version 6.3.beta3](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/multi_polynomial_ideal.py?h=develop&id=6.3.beta3#n2384).\n\n```\nsage: Qabc.<a,b,c> = PolynomialRing(QQ, order='lex')\nsage: ideal(c^2-2, b-c, a).variety(QQbar)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-\u2026> in <module>()\n----> 1 ideal(c**Integer(2)-Integer(2), b-c, a).variety(QQbar)\n\nsage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)\n    602         if not R.base_ring().is_field():\n    603             raise ValueError(\"Coefficient ring must be a field for function '%s'.\"%(self.f.__name__))\n--> 604         return self.f(self._instance, *args, **kwds)\n    605 \n    606 require_field = RequireField\n\nsage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in variety(self, ring)\n   2647         V = []\n   2648         for t in T:\n-> 2649             Vbar = _variety(list(t),[])\n   2650             #Vbar = _variety(list(t.gens()),[])\n   2651 \n\nsage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in _variety(T, V, v)\n   2620                 vbar[variable] = root\n   2621                 Tbar = [ f.subs({variable:root}) for f in T ]\n-> 2622                 _variety(Tbar,V,vbar)\n   2623 \n   2624             return V\n\nsage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in _variety(T, V, v)\n   2619                 vbar = v.copy()\n   2620                 vbar[variable] = root\n-> 2621                 Tbar = [ f.subs({variable:root}) for f in T ]\n   2622                 _variety(Tbar,V,vbar)\n   2623 \n\nsage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22728)()\n\nTypeError: keys do not match self's parent\n```\n\n\nKeywords: sd59\n\nReviewer: Martin Albrecht\n\nAuthor: Martin von Gagern\n\nBranch: 96fefd52852a8559f9af0942fe32312ad6609c9d\n\nCommit: 96fefd52852a8559f9af0942fe32312ad6609c9d\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16485\n\n",
    "closed_at": "2014-06-26T01:50:36Z",
    "created_at": "2014-06-16T15:29:02Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "\"TypeError: keys do not match self's parent\" computing variety of MPolynomialIdeal_singular_repr",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16485",
    "user": "https://github.com/gagern"
}
```
Trying to compute a variety, I get an error instead. The code snippets are from [multi_polynomial_ideal as of Sage version 6.3.beta3](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/multi_polynomial_ideal.py?h=develop&id=6.3.beta3#n2384).

```
sage: Qabc.<a,b,c> = PolynomialRing(QQ, order='lex')
sage: ideal(c^2-2, b-c, a).variety(QQbar)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-â€¦> in <module>()
----> 1 ideal(c**Integer(2)-Integer(2), b-c, a).variety(QQbar)

sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)
    602         if not R.base_ring().is_field():
    603             raise ValueError("Coefficient ring must be a field for function '%s'."%(self.f.__name__))
--> 604         return self.f(self._instance, *args, **kwds)
    605 
    606 require_field = RequireField

sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in variety(self, ring)
   2647         V = []
   2648         for t in T:
-> 2649             Vbar = _variety(list(t),[])
   2650             #Vbar = _variety(list(t.gens()),[])
   2651 

sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in _variety(T, V, v)
   2620                 vbar[variable] = root
   2621                 Tbar = [ f.subs({variable:root}) for f in T ]
-> 2622                 _variety(Tbar,V,vbar)
   2623 
   2624             return V

sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in _variety(T, V, v)
   2619                 vbar = v.copy()
   2620                 vbar[variable] = root
-> 2621                 Tbar = [ f.subs({variable:root}) for f in T ]
   2622                 _variety(Tbar,V,vbar)
   2623 

sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22728)()

TypeError: keys do not match self's parent
```


Keywords: sd59

Reviewer: Martin Albrecht

Author: Martin von Gagern

Branch: 96fefd52852a8559f9af0942fe32312ad6609c9d

Commit: 96fefd52852a8559f9af0942fe32312ad6609c9d

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16485





---

archive/issue_comments_212229.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2014-06-16T15:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212229",
    "user": "https://github.com/gagern"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_212230.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2014-06-16T15:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212230",
    "user": "https://github.com/gagern"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_212231.json:
```json
{
    "body": "<a id='comment:2'></a>I found a shorter reproducing example.",
    "created_at": "2014-06-16T16:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212231",
    "user": "https://github.com/gagern"
}
```

<a id='comment:2'></a>I found a shorter reproducing example.



---

archive/issue_comments_212232.json:
```json
{
    "body": "<a id='comment:3'></a>I guess I have an idea as to what's going on here now. The first generator causes `c` to assume a non-rational value. As a consequence, the second generator will change its base ring from `QQ` to `QQbar`. The third generator does not contain `c`, so its base ring remains `QQ`. Now `b` is chosen as the next variable. Its parent is the ring over `QQbar`, since it got chosen from the second generator. However, it can't be substituted into the third generator since the parent for that doesn't match.\n\nI guess one solution would be changing all polynomials to the target ring up front. I'll try to write a fix for this.",
    "created_at": "2014-06-16T21:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212232",
    "user": "https://github.com/gagern"
}
```

<a id='comment:3'></a>I guess I have an idea as to what's going on here now. The first generator causes `c` to assume a non-rational value. As a consequence, the second generator will change its base ring from `QQ` to `QQbar`. The third generator does not contain `c`, so its base ring remains `QQ`. Now `b` is chosen as the next variable. Its parent is the ring over `QQbar`, since it got chosen from the second generator. However, it can't be substituted into the third generator since the parent for that doesn't match.

I guess one solution would be changing all polynomials to the target ring up front. I'll try to write a fix for this.



---

archive/issue_comments_212233.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-16T21:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212233",
    "user": "https://github.com/gagern"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_212234.json:
```json
{
    "body": "<a id='comment:5'></a>OK, here is my suggested solution. There might be some performance penalty for converting polynomials that don't need it, but I consider this a rare scenario and not worth the hassle we'd get from dealing with mixed polynomial rings.\n\n---\nNew commits:",
    "created_at": "2014-06-16T21:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212234",
    "user": "https://github.com/gagern"
}
```

<a id='comment:5'></a>OK, here is my suggested solution. There might be some performance penalty for converting polynomials that don't need it, but I consider this a rare scenario and not worth the hassle we'd get from dealing with mixed polynomial rings.

---
New commits:



---

archive/issue_comments_212235.json:
```json
{
    "body": "<a id='comment:6'></a>looks fine to me",
    "created_at": "2014-06-25T01:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212235",
    "user": "https://github.com/malb"
}
```

<a id='comment:6'></a>looks fine to me



---

archive/issue_comments_212236.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-25T01:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212236",
    "user": "https://github.com/malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_212237.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd59\".",
    "created_at": "2014-06-25T04:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212237",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "sd59".



---

archive/issue_comments_212238.json:
```json
{
    "body": "<a id='comment:7'></a>Forgotten author name.",
    "created_at": "2014-06-25T04:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212238",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Forgotten author name.



---

archive/issue_comments_212239.json:
```json
{
    "body": "<a id='comment:8'></a>I see no contribution from Julian here, and since the code changes are mine, I guess I should be the author here. Let me know if I misunderstood something.",
    "created_at": "2014-06-25T05:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212239",
    "user": "https://github.com/gagern"
}
```

<a id='comment:8'></a>I see no contribution from Julian here, and since the code changes are mine, I guess I should be the author here. Let me know if I misunderstood something.



---

archive/issue_comments_212240.json:
```json
{
    "body": "<a id='comment:9'></a>Sorry Martin von Gagem, I got my tickets crossed.",
    "created_at": "2014-06-25T12:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212240",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Sorry Martin von Gagem, I got my tickets crossed.



---

archive/issue_comments_212241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-26T01:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16485#issuecomment-212241",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048449.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-26T01:50:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16485",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16485#event-48449"
}
```
