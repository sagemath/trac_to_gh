# Issue 16051: fast_callable can return ipow with exponents in the base ring

archive/issues_015814.json:
```json
{
    "body": "fast_callable returns a string of operations. However, due to how caching\nof constants is done, the integer power function (ipow) can have constants\nin the base ring. This is because it checks the list of constants by comparing\nwith == without taking into consideration the parent/type.\n\nAssignee: @bhutz\n\nBranch/Commit: 9eb0789bf99a2d976cb57f8104f33bc6e7c5deea\n\nReviewer: Dillon Rose\n\nAuthor: Ben Hutz\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16051\n\n",
    "closed_at": "2014-05-07T08:30:57Z",
    "created_at": "2014-04-03T11:45:12Z",
    "labels": [
        "component: misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "fast_callable can return ipow with exponents in the base ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16051",
    "user": "https://github.com/bhutz"
}
```
fast_callable returns a string of operations. However, due to how caching
of constants is done, the integer power function (ipow) can have constants
in the base ring. This is because it checks the list of constants by comparing
with == without taking into consideration the parent/type.

Assignee: @bhutz

Branch/Commit: 9eb0789bf99a2d976cb57f8104f33bc6e7c5deea

Reviewer: Dillon Rose

Author: Ben Hutz

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16051





---

archive/issue_comments_260817.json:
```json
{
    "body": "Changing branch from \"\" to \"u/bhutz/ticket/16051\"",
    "created_at": "2014-04-03T11:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260817",
    "user": "https://github.com/bhutz"
}
```

Changing branch from "" to "u/bhutz/ticket/16051"



---

archive/issue_comments_260818.json:
```json
{
    "body": "Set assignee to @bhutz.",
    "created_at": "2014-04-03T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260818",
    "user": "https://github.com/bhutz"
}
```

Set assignee to @bhutz.



---

archive/issue_comments_260819.json:
```json
{
    "body": "Changing author from \"\" to \"Ben Hutz\"",
    "created_at": "2014-04-03T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260819",
    "user": "https://github.com/bhutz"
}
```

Changing author from "" to "Ben Hutz"



---

archive/issue_comments_260820.json:
```json
{
    "body": "Changing commit from \"\" to \"27663feffb8cf5325b6ea4c8c2f2dd793775ce23\"",
    "created_at": "2014-04-03T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260820",
    "user": "https://github.com/bhutz"
}
```

Changing commit from "" to "27663feffb8cf5325b6ea4c8c2f2dd793775ce23"



---

archive/issue_comments_260821.json:
```json
{
    "body": "<a id='comment:2'></a>Made the comparison to be by type and value instead of just value\n\n---\nNew commits:",
    "created_at": "2014-04-03T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260821",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:2'></a>Made the comparison to be by type and value instead of just value

---
New commits:



---

archive/issue_comments_260822.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-03T11:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260822",
    "user": "https://github.com/bhutz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_260823.json:
```json
{
    "body": "<a id='comment:4'></a>I think parent, when it is available, is a more reliable attribute to determine the mathematical identity of an element (and hence with what constants it can be folded). I think `sage.structure.parent` is the right routine to use, because it will fall back on `type` if `parent` is not available:\n\n```\nsage: parent(1)\nInteger Ring\nsage: parent(int(1))\n<type 'int'>\nsage: parent(ZZ)\n<type 'sage.rings.integer_ring.IntegerRing_class'>\n```\nOne example where going by `parent` is ostensibly better than going by `type` is:\n\n```\nsage: a=RealField(1000)(1)\nsage: b=RealField(200)(1)\nsage: a==b\nTrue\nsage: (type(a),a)==(type(b),b)\nTrue\nsage: (parent(a),a)==(parent(b),b)\nFalse\n```\nWe shouldn't be folding constants that have different precision.\n\nI don't have examples available, but it's certainly not ruled out that elements of different types could have the same parent (to allow for different representation methods in the same parent, for instance). I don't know if we should be folding constants in those cases.\n\nIn any of the cases where this matters other than to distinguish integer powers from from other constants one is really stretching the application domain of `fast_callable` anyway.",
    "created_at": "2014-04-03T15:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260823",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>I think parent, when it is available, is a more reliable attribute to determine the mathematical identity of an element (and hence with what constants it can be folded). I think `sage.structure.parent` is the right routine to use, because it will fall back on `type` if `parent` is not available:

```
sage: parent(1)
Integer Ring
sage: parent(int(1))
<type 'int'>
sage: parent(ZZ)
<type 'sage.rings.integer_ring.IntegerRing_class'>
```
One example where going by `parent` is ostensibly better than going by `type` is:

```
sage: a=RealField(1000)(1)
sage: b=RealField(200)(1)
sage: a==b
True
sage: (type(a),a)==(type(b),b)
True
sage: (parent(a),a)==(parent(b),b)
False
```
We shouldn't be folding constants that have different precision.

I don't have examples available, but it's certainly not ruled out that elements of different types could have the same parent (to allow for different representation methods in the same parent, for instance). I don't know if we should be folding constants in those cases.

In any of the cases where this matters other than to distinguish integer powers from from other constants one is really stretching the application domain of `fast_callable` anyway.



---

archive/issue_comments_260824.json:
```json
{
    "body": "Changing commit from \"27663feffb8cf5325b6ea4c8c2f2dd793775ce23\" to \"9eb0789bf99a2d976cb57f8104f33bc6e7c5deea\"",
    "created_at": "2014-04-03T16:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260824",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "27663feffb8cf5325b6ea4c8c2f2dd793775ce23" to "9eb0789bf99a2d976cb57f8104f33bc6e7c5deea"



---

archive/issue_comments_260825.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-03T16:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260825",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260826.json:
```json
{
    "body": "<a id='comment:6'></a>I wasn't aware of the instance of parent. That is definitely better, so I've changed it.\n\nThe instances I'm looking at is evaluating polynomials where the base ring can be something interesting like a powerseries ring, i.e. morphisms of projective space where base of projective space is something interesting. Mostly, when we implement fast evaluation for morphisms of projective space in #15920, we just don't want to break anything that currently works.",
    "created_at": "2014-04-03T16:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260826",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:6'></a>I wasn't aware of the instance of parent. That is definitely better, so I've changed it.

The instances I'm looking at is evaluating polynomials where the base ring can be something interesting like a powerseries ring, i.e. morphisms of projective space where base of projective space is something interesting. Mostly, when we implement fast evaluation for morphisms of projective space in #15920, we just don't want to break anything that currently works.



---

archive/issue_comments_260827.json:
```json
{
    "body": "<a id='comment:7'></a>opps. I meant #15780.",
    "created_at": "2014-04-03T16:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260827",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:7'></a>opps. I meant #15780.



---

archive/issue_comments_260828.json:
```json
{
    "body": "<a id='comment:8'></a>I have run the complete doctest against this ticket. \u00a0Everything is good.",
    "created_at": "2014-05-01T14:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260828",
    "user": "https://github.com/dillonmrose"
}
```

<a id='comment:8'></a>I have run the complete doctest against this ticket.  Everything is good.



---

archive/issue_comments_260829.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-01T14:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260829",
    "user": "https://github.com/dillonmrose"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_260830.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dillon Rose\"",
    "created_at": "2014-05-01T14:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260830",
    "user": "https://github.com/dillonmrose"
}
```

Changing reviewer from "" to "Dillon Rose"



---

archive/issue_events_047185.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16051#event-47185"
}
```



---

archive/issue_comments_260831.json:
```json
{
    "body": "Changing branch from \"u/bhutz/ticket/16051\" to \"9eb0789bf99a2d976cb57f8104f33bc6e7c5deea\"",
    "created_at": "2014-05-07T08:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260831",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/bhutz/ticket/16051" to "9eb0789bf99a2d976cb57f8104f33bc6e7c5deea"



---

archive/issue_events_047186.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-07T08:30:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16051#event-47186"
}
```



---

archive/issue_comments_260832.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-07T08:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16051#issuecomment-260832",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
