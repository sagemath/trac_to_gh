# Issue 16880: previous_prime, previous_prime_power, next_prime_power

archive/issues_016643.json:
```json
{
    "body": "In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.\n\nTimings on the current version (sage-6.7.beta2)\n\n```\nsage: timeit(\"for i in range(200): next_prime_power(i)\", number=5000, repeat=10)\n5000 loops, best of 10: 311 \u00b5s per loop\nsage: a = 33622489\nsage: timeit(\"next_prime_power(a)\", number=5000, repeat=10)\n5000 loops, best of 10: 53.6 \u00b5s per loop\n```\n\nTimings with the branch applied\n\n```\nsage: timeit(\"for i in range(200): next_prime_power(i)\", number=5000, repeat=10)\n5000 loops, best of 10: 184 \u00b5s per loop\nsage: a = 33622489\nsage: timeit(\"next_prime_power(a)\", number=5000, repeat=10)\n5000 loops, best of 10: 16.9 \u00b5s per loop\n```\n\nFollow up: #18298 and #18299\n\nCC:  @nathanncohen @jdemeyer\n\nReviewer: Jeroen Demeyer\n\nAuthor: Vincent Delecroix\n\nBranch: 35c0211766537e6769cd060ed528ad9d77e60068\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16880\n\n",
    "closed_at": "2015-04-29T03:13:45Z",
    "created_at": "2014-08-26T11:09:37Z",
    "labels": [
        "component: number theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "previous_prime, previous_prime_power, next_prime_power",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16880",
    "user": "https://github.com/videlec"
}
```
In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.

Timings on the current version (sage-6.7.beta2)

```
sage: timeit("for i in range(200): next_prime_power(i)", number=5000, repeat=10)
5000 loops, best of 10: 311 µs per loop
sage: a = 33622489
sage: timeit("next_prime_power(a)", number=5000, repeat=10)
5000 loops, best of 10: 53.6 µs per loop
```

Timings with the branch applied

```
sage: timeit("for i in range(200): next_prime_power(i)", number=5000, repeat=10)
5000 loops, best of 10: 184 µs per loop
sage: a = 33622489
sage: timeit("next_prime_power(a)", number=5000, repeat=10)
5000 loops, best of 10: 16.9 µs per loop
```

Follow up: #18298 and #18299

CC:  @nathanncohen @jdemeyer

Reviewer: Jeroen Demeyer

Author: Vincent Delecroix

Branch: 35c0211766537e6769cd060ed528ad9d77e60068

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16880





---

archive/issue_comments_233664.json:
```json
{
    "body": "<a id='comment:1'></a>+1 for \"primes\"",
    "created_at": "2014-08-26T11:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233664",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:1'></a>+1 for "primes"



---

archive/issue_comments_233665.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,10 @@\n-The cythonization of `prime_powers` is much faster (around x4 in the timings). We also introduce the keyword `py_ints` as in `prime_range` in order to be able to use Python int instead of Sage integers.\n+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` (that also has a keyword `py_ints` as `prime_range`).\n \n-Note: I do not like the convention that the name are different `prime_powers` vs `prime_range`... why not using `primes` or `prime_power_range`?\n+Note: naming conventions are crazy... right now there are:\n+- `primes`: iterator over prime numbers\n+- `prime_range`: return the list of the first prime (fast implementation in Cython but only handles integer up to `LONG_MAX` and require memory)\n+- `prime_powers`: return the list of prime powers!\n+It seems to me that in Sage we tend to have `X_iterator` for iterator and `Xs` for the list of objects...\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2014-08-26T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233665",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,10 @@
-The cythonization of `prime_powers` is much faster (around x4 in the timings). We also introduce the keyword `py_ints` as in `prime_range` in order to be able to use Python int instead of Sage integers.
+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` (that also has a keyword `py_ints` as `prime_range`).
 
-Note: I do not like the convention that the name are different `prime_powers` vs `prime_range`... why not using `primes` or `prime_power_range`?
+Note: naming conventions are crazy... right now there are:
+- `primes`: iterator over prime numbers
+- `prime_range`: return the list of the first prime (fast implementation in Cython but only handles integer up to `LONG_MAX` and require memory)
+- `prime_powers`: return the list of prime powers!
+It seems to me that in Sage we tend to have `X_iterator` for iterator and `Xs` for the list of objects...
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233666.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-26T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233666",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_233667.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-08-26T12:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_233668.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-28T20:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_233669.json:
```json
{
    "body": "<a id='comment:5'></a>Rebased on 6.4.beta2, no dependency anymore...\n\nVincent",
    "created_at": "2014-08-28T20:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233669",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Rebased on 6.4.beta2, no dependency anymore...

Vincent



---

archive/issue_comments_233670.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` (that also has a keyword `py_ints` as `prime_range`).\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2014-08-28T20:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233670",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` (that also has a keyword `py_ints` as `prime_range`).
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233671.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-30T16:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233671",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_233672.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` that is similar to `prime_range`.\n \n+Since #16878, 1 is not a prime power anymore! So we fix `prime_powers` to never return 1 in its output.\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2014-08-30T16:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233672",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The cythonization of `prime_powers` is much faster (around x4 in the timings). We introduce in a new function `prime_power_range` in `fast_arith.pyx` that is similar to `prime_range`.
 
+Since #16878, 1 is not a prime power anymore! So we fix `prime_powers` to never return 1 in its output.
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233673.json:
```json
{
    "body": "<a id='comment:7'></a>And with timings\n\nusing `prime_powers` (EDIT: only for commit at a3195f7 and not at e3be1ce)\n\n```\nsage: timeit(\"prime_powers(1000)\", number=4000)\n4000 loops, best of 3: 86.7 \u00b5s per loop\nsage: timeit(\"prime_powers(5000)\", number=2000)\n2000 loops, best of 3: 314 \u00b5s per loop\n```\n\nusing `prime_power_range` instead\n\n```\nsage: timeit(\"prime_power_range(1000)\", number=4000)\n4000 loops, best of 3: 17.6 \u00b5s per loop\nsage:  timeit(\"prime_power_range(5000)\", number=2000)\n2000 loops, best of 3: 72.3 \u00b5s per loop\n```\n\nusing `prime_power_range` with `py_ints=True`\n\n```\nsage: timeit(\"prime_power_range(1000,py_ints=True)\", number=4000)\n4000 loops, best of 3: 14.6 \u00b5s per loop\nsage:  timeit(\"prime_power_range(5000,py_ints=True)\", number=2000)\n2000 loops, best of 3: 33.9 \u00b5s per loop\n```",
    "created_at": "2014-08-30T16:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233673",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>And with timings

using `prime_powers` (EDIT: only for commit at a3195f7 and not at e3be1ce)

```
sage: timeit("prime_powers(1000)", number=4000)
4000 loops, best of 3: 86.7 µs per loop
sage: timeit("prime_powers(5000)", number=2000)
2000 loops, best of 3: 314 µs per loop
```

using `prime_power_range` instead

```
sage: timeit("prime_power_range(1000)", number=4000)
4000 loops, best of 3: 17.6 µs per loop
sage:  timeit("prime_power_range(5000)", number=2000)
2000 loops, best of 3: 72.3 µs per loop
```

using `prime_power_range` with `py_ints=True`

```
sage: timeit("prime_power_range(1000,py_ints=True)", number=4000)
4000 loops, best of 3: 14.6 µs per loop
sage:  timeit("prime_power_range(5000,py_ints=True)", number=2000)
2000 loops, best of 3: 33.9 µs per loop
```



---

archive/issue_comments_233674.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This ticket introduces several changes:\n+- introduce a method `next_prime_power` for integers\n+- make `prime_powers` an iterator (using `next_prime_power`) so that it can be used for large integers as well\n+- create a much faster cythonized `prime_power_range`\n \n+We get a little speed down for the iteration over `prime_powers` but we can now do\n+\n+```\n+sage: for p in prime_powers(2**100, 2**100+500):\n+....:     print p\n+1267650600228229401496703205376\n+1267650600228229401496703205653\n+1267650600228229401496703205707\n+1267650600228229401496703205823\n+```\n+The cython function `prime_power_range` is much faster than the previous `prime_powers` (around x4 in the timings).\n+\n+Since #16878, 1 is not a prime power anymore! So we fix `prime_powers` to never return 1 in its output.\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2014-08-31T09:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233674",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This ticket introduces several changes:
+- introduce a method `next_prime_power` for integers
+- make `prime_powers` an iterator (using `next_prime_power`) so that it can be used for large integers as well
+- create a much faster cythonized `prime_power_range`
 
+We get a little speed down for the iteration over `prime_powers` but we can now do
+
+```
+sage: for p in prime_powers(2**100, 2**100+500):
+....:     print p
+1267650600228229401496703205376
+1267650600228229401496703205653
+1267650600228229401496703205707
+1267650600228229401496703205823
+```
+The cython function `prime_power_range` is much faster than the previous `prime_powers` (around x4 in the timings).
+
+Since #16878, 1 is not a prime power anymore! So we fix `prime_powers` to never return 1 in its output.
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233675.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-31T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233675",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_233676.json:
```json
{
    "body": "<a id='comment:10'></a>It looks more natural to me to follow what `primes` and `prime_range` do... this is what I did in e3be1ce.\n\nVincent",
    "created_at": "2014-08-31T09:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233676",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>It looks more natural to me to follow what `primes` and `prime_range` do... this is what I did in e3be1ce.

Vincent



---

archive/issue_comments_233677.json:
```json
{
    "body": "<a id='comment:11'></a>Needs rebase.",
    "created_at": "2015-03-09T09:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233677",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Needs rebase.



---

archive/issue_events_049338.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-03-09T09:30:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16880#event-49338"
}
```



---

archive/issue_comments_233678.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-09T09:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233678",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233679.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-03-21T17:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233679",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_233680.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n-\n+In this ticket we:\n+- introduce methods `previous_prime`, `next_prime_power`, `previous_prime_power` for integers\n+- split `prime_range` in `rings/fast_arith.pyx` into two subfunctions and optimize them\n+- create a faster cythonized `prime_power_range` and propose two implementations for `arith.prime_powers`\n+- add `rings/fast_arith.pyx` to the documentation\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-03-21T17:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233680",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
-
+In this ticket we:
+- introduce methods `previous_prime`, `next_prime_power`, `previous_prime_power` for integers
+- split `prime_range` in `rings/fast_arith.pyx` into two subfunctions and optimize them
+- create a faster cythonized `prime_power_range` and propose two implementations for `arith.prime_powers`
+- add `rings/fast_arith.pyx` to the documentation
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233681.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-21T17:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233681",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233682.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-21T18:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233682",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_049339.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-25T10:50:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16880#event-49339"
}
```



---

archive/issue_events_049340.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-25T10:50:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16880#event-49340"
}
```



---

archive/issue_comments_233683.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-04-25T10:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233683",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233684.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-25T10:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_233685.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.\n \n+Follow up: #18298 and #18299\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-04-25T11:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233685",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.
 
+Follow up: #18298 and #18299
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233686.json:
```json
{
    "body": "<a id='comment:18'></a>I split the other parts to different tickets: #18298 and #18299.",
    "created_at": "2015-04-25T11:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233686",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>I split the other parts to different tickets: #18298 and #18299.



---

archive/issue_comments_233687.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,26 @@\n+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.\n \n+Timings on the current version (sage-6.7.beta2)\n+\n+```\n+sage: timeit(\"for i in range(200): next_prime_power(i)\", number=5000, repeat=10)\n+5000 loops, best of 10: 311 \u00b5s per loop\n+sage: a = 33622489\n+sage: timeit(\"next_prime_power(a)\", number=5000, repeat=10)\n+5000 loops, best of 10: 53.6 \u00b5s per loop\n+```\n+\n+Timings with the branch applied\n+\n+```\n+sage: timeit(\"for i in range(200): next_prime_power(i)\", number=5000, repeat=10)\n+5000 loops, best of 10: 184 \u00b5s per loop\n+sage: a = 33622489\n+sage: timeit(\"next_prime_power(a)\", number=5000, repeat=10)\n+5000 loops, best of 10: 16.9 \u00b5s per loop\n+```\n+\n+Follow up: #18298 and #18299\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-04-25T13:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233687",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,26 @@
+In this ticket we add three methods to integers: `previous_prime` (calling pari `precprime`), `next_prime_power` and `previous_prime_power`. We also make changes in `sage.rings.arith` to call these (faster) methods.
 
+Timings on the current version (sage-6.7.beta2)
+
+```
+sage: timeit("for i in range(200): next_prime_power(i)", number=5000, repeat=10)
+5000 loops, best of 10: 311 µs per loop
+sage: a = 33622489
+sage: timeit("next_prime_power(a)", number=5000, repeat=10)
+5000 loops, best of 10: 53.6 µs per loop
+```
+
+Timings with the branch applied
+
+```
+sage: timeit("for i in range(200): next_prime_power(i)", number=5000, repeat=10)
+5000 loops, best of 10: 184 µs per loop
+sage: a = 33622489
+sage: timeit("next_prime_power(a)", number=5000, repeat=10)
+5000 loops, best of 10: 16.9 µs per loop
+```
+
+Follow up: #18298 and #18299
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_233688.json:
```json
{
    "body": "<a id='comment:20'></a>1. I don't know if `lesser or equal than` is proper English. How about `less than or equal to`?\n\n2. `PARI` instead of `Pari`.\n\n3. In `next_prime_power` and `previous_prime_power`, a small optimization is possible: you can replace\n\n```\nmpz_set(n.value, self.value)\nmpz_add_ui(n.value, n.value, 1)\n```\nby\n\n```\nmpz_add_ui(n.value, self.value, 1)\n```\n\nand in `next_prime_power`, replace\n\n```\nif mpz_cmp_ui(n.value, 2) < 0:\n    mpz_set_ui(n.value, 2)\n    return n\n```\nby\n\n```\nif mpz_cmp_ui(self.value, 2) < 0:\n    return smallInteger(2)\n```\n\n4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing\n\n```\nwhile mpz_cmp(m.value, n.value) == 1:\n```\nI would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.",
    "created_at": "2015-04-28T09:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233688",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>1. I don't know if `lesser or equal than` is proper English. How about `less than or equal to`?

2. `PARI` instead of `Pari`.

3. In `next_prime_power` and `previous_prime_power`, a small optimization is possible: you can replace

```
mpz_set(n.value, self.value)
mpz_add_ui(n.value, n.value, 1)
```
by

```
mpz_add_ui(n.value, self.value, 1)
```

and in `next_prime_power`, replace

```
if mpz_cmp_ui(n.value, 2) < 0:
    mpz_set_ui(n.value, 2)
    return n
```
by

```
if mpz_cmp_ui(self.value, 2) < 0:
    return smallInteger(2)
```

4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing

```
while mpz_cmp(m.value, n.value) == 1:
```
I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.



---

archive/issue_comments_233689.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-28T09:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233689",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233690.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T10:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233690",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233691.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:20 jdemeyer]:\n \n> 4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing\n> \n> ```\n> while mpz_cmp(m.value, n.value) == 1:\n> ```\n> I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.\n\n\nI used `mpz_tstbit` instead. Should be the fastest.\n\nPotential micro optimization that would need to use `mpn_*` functions\n- the call to `mpz_sizeinbase` can be replaced by `mpn_count_leading_zeros` and some arithmetic\n- we can avoid a useless bit shift in `mpz_tstbit` by only considering the `&` with the most significant limb. Moreover, the allocation of the limbs will not change inside the loop. So we can already use the good pointer to the concerned limb.\n\nI think this is too much for a naive algorithm...",
    "created_at": "2015-04-28T10:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233691",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>Replying to [comment:20 jdemeyer]:
 
> 4. Another algorithmic comment for `next_prime_power` (an analogous comment holds for `previous_prime_power`): instead of computing the next power of 2 and doing
> 
> ```
> while mpz_cmp(m.value, n.value) == 1:
> ```
> I would instead check if `mpz_sizeinbase(n.value, 2)` increases during the loop. In that case, we know that we skipped a power of 2.


I used `mpz_tstbit` instead. Should be the fastest.

Potential micro optimization that would need to use `mpn_*` functions
- the call to `mpz_sizeinbase` can be replaced by `mpn_count_leading_zeros` and some arithmetic
- we can avoid a useless bit shift in `mpz_tstbit` by only considering the `&` with the most significant limb. Moreover, the allocation of the limbs will not change inside the loop. So we can already use the good pointer to the concerned limb.

I think this is too much for a naive algorithm...



---

archive/issue_comments_233692.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-28T10:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233692",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233693.json:
```json
{
    "body": "<a id='comment:24'></a>`skept` -> `skipped`\n\nThis should be moved *after* the comparison with 2 (and `self` should be compared with 2):\n\n```\ncdef Integer n = PY_NEW(Integer)\n```\n\nAnother simplification that I missed: you can skip the block\n\n```\n    if mpz_even_p(n.value):\n    if n.is_prime_power(proof=proof):\n    return n\n    mpz_add_ui(n.value, n.value, 1)\n```\nif you instead just add 2 if `self` was odd:\n\n```\nmpz_add_ui(n.value, self.value, 1 if mpz_even_p(self.value) else 2)\n```\n\nThen the `bit_index` should be based on the value of `self`, such that the check works correctly if `self` was `2^n - 1`.",
    "created_at": "2015-04-28T11:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233693",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>`skept` -> `skipped`

This should be moved *after* the comparison with 2 (and `self` should be compared with 2):

```
cdef Integer n = PY_NEW(Integer)
```

Another simplification that I missed: you can skip the block

```
    if mpz_even_p(n.value):
    if n.is_prime_power(proof=proof):
    return n
    mpz_add_ui(n.value, n.value, 1)
```
if you instead just add 2 if `self` was odd:

```
mpz_add_ui(n.value, self.value, 1 if mpz_even_p(self.value) else 2)
```

Then the `bit_index` should be based on the value of `self`, such that the check works correctly if `self` was `2^n - 1`.



---

archive/issue_comments_233694.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-28T11:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233694",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233695.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T11:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233696.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-28T11:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233696",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233697.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-28T15:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233697",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049341.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-29T03:13:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16880#event-49341"
}
```



---

archive/issue_comments_233698.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-29T03:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233698",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_233699.json:
```json
{
    "body": "<a id='comment:29'></a>Some copy/paste accidents (could probably be corrected on the follow-ups):\n\n```\n+    def previous_prime(self, proof=None):\n+        r\"\"\"\n+        Returns the previous prime before self.\n+\n+        This method calls the PARI ``precprime`` function.\n+\n+        INPUT:\n+\n+        - ``proof`` - if ``True`` ensure that the returned value is the next\n+          prime power and if set to ``False`` uses probabilistic methods\n+          (i.e. the result is not guaranteed). By default it uses global\n+          configuration variables to determine which alternative to use (see\n+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).\n```\n\n```\n+    def previous_prime_power(self, proof=None):\n+        r\"\"\"\n+        Return the previous prime power before self.\n+\n+        INPUT:\n+\n+        - ``proof`` - if ``True`` ensure that the returned value is the next\n+          prime power and if set to ``False`` uses probabilistic methods\n+          (i.e. the result is not guaranteed). By default it uses global\n+          configuration variables to determine which alternative to use (see\n+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).\n```",
    "created_at": "2015-05-06T07:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233699",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:29'></a>Some copy/paste accidents (could probably be corrected on the follow-ups):

```
+    def previous_prime(self, proof=None):
+        r"""
+        Returns the previous prime before self.
+
+        This method calls the PARI ``precprime`` function.
+
+        INPUT:
+
+        - ``proof`` - if ``True`` ensure that the returned value is the next
+          prime power and if set to ``False`` uses probabilistic methods
+          (i.e. the result is not guaranteed). By default it uses global
+          configuration variables to determine which alternative to use (see
+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).
```

```
+    def previous_prime_power(self, proof=None):
+        r"""
+        Return the previous prime power before self.
+
+        INPUT:
+
+        - ``proof`` - if ``True`` ensure that the returned value is the next
+          prime power and if set to ``False`` uses probabilistic methods
+          (i.e. the result is not guaranteed). By default it uses global
+          configuration variables to determine which alternative to use (see
+          :mod:`proof.arithmetic` or :mod:`sage.structure.proof`).
```



---

archive/issue_comments_233700.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 leif]:\n> Some copy/paste accidents (could probably be corrected on the follow-ups):\n\n\nHa right.",
    "created_at": "2015-05-06T07:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16880#issuecomment-233700",
    "user": "https://github.com/videlec"
}
```

<a id='comment:30'></a>Replying to [comment:29 leif]:
> Some copy/paste accidents (could probably be corrected on the follow-ups):


Ha right.
