# Issue 16742: Reimplementation of weak_popov_form for matrices

archive/issues_016505.json:
```json
{
    "body": "The target of this ticket is to enhance the function weak_popov of the matrix interface.  The function should transform the matrix in weak popov form, it will use mulders-storjohann algorithm and should be much faster than the current implementation but will not work for polynomials over a fraction field only for polynomial rings over finite fields.\n\nThis ticket is independent from but connected to #16739.\n\nShort description of weak popov form: Let R be an ordered Ring and Amxn a matrix over R. The leading position of a row is called the position i in [1,m) such that the order of A[i,_] is maximal within the row. If there are multiple entries with the maximum order, the highest i is the leading position (the furthest to the right in the matrix). A is in weak popov form if all leading positions are different (zero lines ignored).\n\nThe function will implement this only for polynomial rings, the order function is the degree of the polynomial. Example:\n\n[x2+1, x]\n\n[x, x+1]\n\nis in weak popov form: Row 1 has the degrees 2 and 1, the leading position is for i=0, row 2 has two times degree 1 so the higher i is chosen with i=1.\n\n[x2+1, x]\n\n[x,0]\n\nis NOT in weak popov form, row 1 has now degrees 1 and -1, so the leading position is i=0 as in row 1.\n\nSee: [MS] Mulders, Storjohann, On Lattice Reduction for Polynomial Matrices, ftp://ftp.inf.ethz.ch/pub/publications/tech-reports/3xx/356.pdf\n\nCC:  @johanrosenkilde dlucas @ClementPernet\n\nKeywords: matrix weak-popov-form #16739 sd75\n\nAuthor: David M\u00f6dinger\n\nBranch: u/ketzu/overload_for_faster_weak_popov_form\n\nDependencies: #16888,#16896\n\nCommit: e464be9e38cd84c8d52d9c117724e4a9f0ce01e7\n\nResolution: wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/16742\n\n",
    "closed_at": "2017-07-13T07:54:31Z",
    "created_at": "2014-07-30T13:00:06Z",
    "labels": [
        "component: performance",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Reimplementation of weak_popov_form for matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16742",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```
The target of this ticket is to enhance the function weak_popov of the matrix interface.  The function should transform the matrix in weak popov form, it will use mulders-storjohann algorithm and should be much faster than the current implementation but will not work for polynomials over a fraction field only for polynomial rings over finite fields.

This ticket is independent from but connected to #16739.

Short description of weak popov form: Let R be an ordered Ring and Amxn a matrix over R. The leading position of a row is called the position i in [1,m) such that the order of A[i,_] is maximal within the row. If there are multiple entries with the maximum order, the highest i is the leading position (the furthest to the right in the matrix). A is in weak popov form if all leading positions are different (zero lines ignored).

The function will implement this only for polynomial rings, the order function is the degree of the polynomial. Example:

[x2+1, x]

[x, x+1]

is in weak popov form: Row 1 has the degrees 2 and 1, the leading position is for i=0, row 2 has two times degree 1 so the higher i is chosen with i=1.

[x2+1, x]

[x,0]

is NOT in weak popov form, row 1 has now degrees 1 and -1, so the leading position is i=0 as in row 1.

See: [MS] Mulders, Storjohann, On Lattice Reduction for Polynomial Matrices, ftp://ftp.inf.ethz.ch/pub/publications/tech-reports/3xx/356.pdf

CC:  @johanrosenkilde dlucas @ClementPernet

Keywords: matrix weak-popov-form #16739 sd75

Author: David MÃ¶dinger

Branch: u/ketzu/overload_for_faster_weak_popov_form

Dependencies: #16888,#16896

Commit: e464be9e38cd84c8d52d9c117724e4a9f0ce01e7

Resolution: wontfix

Issue created by migration from https://trac.sagemath.org/ticket/16742





---

archive/issue_events_049039.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49039"
}
```



---

archive/issue_comments_216828.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to performance.",
    "created_at": "2014-08-19T11:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216828",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

Changing component from PLEASE CHANGE to performance.



---

archive/issue_comments_216829.json:
```json
{
    "body": "Changing keywords from \"\" to \"matrix weak-popov-form\".",
    "created_at": "2014-08-19T11:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216829",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

Changing keywords from "" to "matrix weak-popov-form".



---

archive/issue_comments_216830.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2014-08-19T11:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216830",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

Changing priority from major to minor.



---

archive/issue_comments_216831.json:
```json
{
    "body": "Changing keywords from \"matrix weak-popov-form\" to \"matrix weak-popov-form #16739\".",
    "created_at": "2014-08-19T11:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216831",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

Changing keywords from "matrix weak-popov-form" to "matrix weak-popov-form #16739".



---

archive/issue_comments_216832.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2014-08-19T12:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216832",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_216833.json:
```json
{
    "body": "<a id='comment:9'></a>Note to passers-by: ketzu is in the process of writing a patch for this.",
    "created_at": "2014-08-20T09:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216833",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:9'></a>Note to passers-by: ketzu is in the process of writing a patch for this.



---

archive/issue_comments_216834.json:
```json
{
    "body": "<a id='comment:11'></a>Doctests / Examples are still missing\n\n---\nNew commits:\n",
    "created_at": "2014-08-21T15:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216834",
    "user": "https://trac.sagemath.org/admin/accounts/users/ketzu"
}
```

<a id='comment:11'></a>Doctests / Examples are still missing

---
New commits:




---

archive/issue_comments_216835.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-25T13:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216835",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_216836.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-25T13:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216836",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_216837.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-25T13:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_216838.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-26T11:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_216839.json:
```json
{
    "body": "<a id='comment:19'></a>Hello,\n\nI'm working on the review for tickets related to the weal Popov form problem. Even if this one was not on `needs_review` state, I considered that it was quite old, and did not change for a while, so I took the liberty to review it.\n\n## General comments\n\ng1) Several conflicts arise if merge with latest Sage beta. They need to be fixed.\n\ng2) There are some trailing whitespaces in the files you modified. It will be nice to remove them.\n\ng3) There are errors while building the documentation. To check if the documentation builds as it should, and check if the html output looks good or not, you can use `sage --docbuild reference/myFolder html`, replacing my folder by the part of Sage you were working on. Here, it will be `reference/matrices`.\n\n## Documentation-related comments\n\nd1) While writing documentation, you can use double backticks to have a nice formatting for variables. If you use simple backticks, it will format it as LaTeX test, which will just be italic if used on simple text. It is advised in [Sage documentation](http://www.sagemath.org/doc/developer/coding_basics.html#documentation-strings) to use double backticks around variables in the output block. Besides, it looks better for variables, or Python-related keyworkds (like `True`, or `None`) to use this syntax.\n\nd2) The title of the file `weak_popov.pyx` is splitted on the html documentation. Write the title in one line, or use an underscore to avoid this.\n\nd3) After the merge with latest beta, especially with the content of #16888, doctests of `weak_popov.pyx` are broken as `weak_popov_form` method throws a deprecation warning.\n\nd4) I think it's better to call directly the method you're doctesting. In `mulders_storjohann`'s doctests, call `mulders_storjohann` instead of `weak_popov`.\n\nd5) On line 152 (examples for `mulders_storjohann`) in `weak_popov`, you say \"Generally matrices in weak popov form will just be returned\". I think they will always be returned. In that case, can you remove \"generally\"? If I'm wrong, can you add an example in which we input a matrix in wPf which is not returned as is?\n\nd6) You can get a nice formatting on the `ALGORITHM` block (`weak_popov.py:102`) if you use only one colon instead of two after the `ALGORITHM` keyword.\n\nd7) On both helper methods you wrote in `weak_popov.pyx`, you have this block:\n\n```\n  .. note::\n    \n        This method is used in the mulders-storjohann algorithm.\n```\n\nI think it will be more explicit for the user to say something like \"This is a helper function for Mulders-Storjohann algorithm and should only be used internally\".\n\nd8) At the beginning of each function, you write something like \"Function to do something\". You can go straight to the point, and write directly \"Returns this\" or \"Computes that\".\n\nd9) In `simmple_transformation`'s doc, input parameter `U` is not documented.\n\n## Code and design related comments\n\nc1) `mulders-storjohann` method takes a matrix `M` as an input, then modifies it in place, and outputs the modified matrix. I think it's not an intuitive behaviour. It should either modify the input in place, and output nothing or copy the input and output the modified copy.\n\nc2) With the merge of #16888, old `weak_popov_form` method will be deprecated and renamed `row_reduced_form`. Which means that, without any changes, one will need to call `M.row_reduced_form(implementation=\"cython\")` to get the weak Popov form of `M`... Which is not intuitive at all. What I suggest here is to reinstate the method `weak_popov_form` (as it will compute the wPf, we can de-deprecate it) which will do the transformations to get the wPf of the input using `mulders-storjohann` method. By doing that, we keep the `row_reduced_form` method for users who absolutely want the row reduced form of their matrices, and have a real weak Popov form computation with methods explicitely named.\n\nc3) As #16896 changes the calling conventions of `row_reduced_from`, I think one the two tickets should depend on the other one to be sure we get what we want in the end, namely a wPf method and a rrf method with simplfied calling conventions.",
    "created_at": "2015-05-06T13:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216839",
    "user": "https://trac.sagemath.org/admin/accounts/users/dlucas"
}
```

<a id='comment:19'></a>Hello,

I'm working on the review for tickets related to the weal Popov form problem. Even if this one was not on `needs_review` state, I considered that it was quite old, and did not change for a while, so I took the liberty to review it.

## General comments

g1) Several conflicts arise if merge with latest Sage beta. They need to be fixed.

g2) There are some trailing whitespaces in the files you modified. It will be nice to remove them.

g3) There are errors while building the documentation. To check if the documentation builds as it should, and check if the html output looks good or not, you can use `sage --docbuild reference/myFolder html`, replacing my folder by the part of Sage you were working on. Here, it will be `reference/matrices`.

## Documentation-related comments

d1) While writing documentation, you can use double backticks to have a nice formatting for variables. If you use simple backticks, it will format it as LaTeX test, which will just be italic if used on simple text. It is advised in [Sage documentation](http://www.sagemath.org/doc/developer/coding_basics.html#documentation-strings) to use double backticks around variables in the output block. Besides, it looks better for variables, or Python-related keyworkds (like `True`, or `None`) to use this syntax.

d2) The title of the file `weak_popov.pyx` is splitted on the html documentation. Write the title in one line, or use an underscore to avoid this.

d3) After the merge with latest beta, especially with the content of #16888, doctests of `weak_popov.pyx` are broken as `weak_popov_form` method throws a deprecation warning.

d4) I think it's better to call directly the method you're doctesting. In `mulders_storjohann`'s doctests, call `mulders_storjohann` instead of `weak_popov`.

d5) On line 152 (examples for `mulders_storjohann`) in `weak_popov`, you say "Generally matrices in weak popov form will just be returned". I think they will always be returned. In that case, can you remove "generally"? If I'm wrong, can you add an example in which we input a matrix in wPf which is not returned as is?

d6) You can get a nice formatting on the `ALGORITHM` block (`weak_popov.py:102`) if you use only one colon instead of two after the `ALGORITHM` keyword.

d7) On both helper methods you wrote in `weak_popov.pyx`, you have this block:

```
  .. note::
    
        This method is used in the mulders-storjohann algorithm.
```

I think it will be more explicit for the user to say something like "This is a helper function for Mulders-Storjohann algorithm and should only be used internally".

d8) At the beginning of each function, you write something like "Function to do something". You can go straight to the point, and write directly "Returns this" or "Computes that".

d9) In `simmple_transformation`'s doc, input parameter `U` is not documented.

## Code and design related comments

c1) `mulders-storjohann` method takes a matrix `M` as an input, then modifies it in place, and outputs the modified matrix. I think it's not an intuitive behaviour. It should either modify the input in place, and output nothing or copy the input and output the modified copy.

c2) With the merge of #16888, old `weak_popov_form` method will be deprecated and renamed `row_reduced_form`. Which means that, without any changes, one will need to call `M.row_reduced_form(implementation="cython")` to get the weak Popov form of `M`... Which is not intuitive at all. What I suggest here is to reinstate the method `weak_popov_form` (as it will compute the wPf, we can de-deprecate it) which will do the transformations to get the wPf of the input using `mulders-storjohann` method. By doing that, we keep the `row_reduced_form` method for users who absolutely want the row reduced form of their matrices, and have a real weak Popov form computation with methods explicitely named.

c3) As #16896 changes the calling conventions of `row_reduced_from`, I think one the two tickets should depend on the other one to be sure we get what we want in the end, namely a wPf method and a rrf method with simplfied calling conventions.



---

archive/issue_events_049040.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/dlucas",
    "created_at": "2015-05-06T13:15:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49040"
}
```



---

archive/issue_events_049041.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/dlucas",
    "created_at": "2015-05-06T13:15:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49041"
}
```



---

archive/issue_comments_216840.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-06T13:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216840",
    "user": "https://trac.sagemath.org/admin/accounts/users/dlucas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_216841.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-06T13:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216841",
    "user": "https://trac.sagemath.org/admin/accounts/users/dlucas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_216842.json:
```json
{
    "body": "Changing keywords from \"matrix weak-popov-form #16739\" to \"matrix weak-popov-form #16739 sd75\".",
    "created_at": "2016-08-22T14:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216842",
    "user": "https://github.com/ClementPernet"
}
```

Changing keywords from "matrix weak-popov-form #16739" to "matrix weak-popov-form #16739 sd75".



---

archive/issue_comments_216843.json:
```json
{
    "body": "<a id='comment:23'></a>In #21024, I reimplemented this \"reimplementation of weak popov form\" in the `_weak_popov_form` in a newly added `matrix_polynomial_dense.pyx` file. I did timing comparisons between my implementation of MS algorithm with the implementation in this ticket.  The result is that the implementation in `_weak_popov_form` is much faster than the latter. So if #21024 is merged, then this ticket can be safely discarded.",
    "created_at": "2016-12-15T15:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216843",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:23'></a>In #21024, I reimplemented this "reimplementation of weak popov form" in the `_weak_popov_form` in a newly added `matrix_polynomial_dense.pyx` file. I did timing comparisons between my implementation of MS algorithm with the implementation in this ticket.  The result is that the implementation in `_weak_popov_form` is much faster than the latter. So if #21024 is merged, then this ticket can be safely discarded.



---

archive/issue_comments_216844.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-02-07T16:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216844",
    "user": "https://github.com/johanrosenkilde"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_049042.json:
```json
{
    "actor": "https://github.com/johanrosenkilde",
    "created_at": "2017-02-07T16:14:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49042"
}
```



---

archive/issue_events_049043.json:
```json
{
    "actor": "https://github.com/johanrosenkilde",
    "created_at": "2017-02-07T16:14:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49043"
}
```



---

archive/issue_comments_216845.json:
```json
{
    "body": "<a id='comment:24'></a>Closing as wontfix cf #21024.",
    "created_at": "2017-02-07T16:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216845",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:24'></a>Closing as wontfix cf #21024.



---

archive/issue_comments_216846.json:
```json
{
    "body": "<a id='comment:25'></a>Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216846",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).



---

archive/issue_comments_216847.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16742#issuecomment-216847",
    "user": "https://github.com/embray"
}
```

Resolution: wontfix



---

archive/issue_events_049044.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-07-13T07:54:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16742",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16742#event-49044"
}
```
