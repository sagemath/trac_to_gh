# Issue 16074: Metaclass syntax changed in Python 3

archive/issues_015837.json:
```json
{
    "body": "The tool 2to3 changes the code to the new Py3 syntax. \n\n\nBut the code has to depend on the Python version!\n\nThere are 30 affected modules. \n\nThis ticket is tracked as a dependency of meta-ticket ticket:16052.\n\nREFERENCE: http://stackoverflow.com/questions/18513821/python-metaclass-understanding-the-with-metaclass\n\nCC:  @tscrim @jdemeyer\n\nKeywords: python3\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nBranch: f1ca05f39db7d8ca8afc379808858c568619b9eb\n\nCommit: f1ca05f39db7d8ca8afc379808858c568619b9eb\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16074\n\n",
    "closed_at": "2017-04-14T19:56:17Z",
    "created_at": "2014-04-07T08:50:31Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Metaclass syntax changed in Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16074",
    "user": "https://github.com/wluebbe"
}
```
The tool 2to3 changes the code to the new Py3 syntax. 


But the code has to depend on the Python version!

There are 30 affected modules. 

This ticket is tracked as a dependency of meta-ticket ticket:16052.

REFERENCE: http://stackoverflow.com/questions/18513821/python-metaclass-understanding-the-with-metaclass

CC:  @tscrim @jdemeyer

Keywords: python3

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Branch: f1ca05f39db7d8ca8afc379808858c568619b9eb

Commit: f1ca05f39db7d8ca8afc379808858c568619b9eb

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16074





---

archive/issue_events_047288.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47288"
}
```



---

archive/issue_events_047289.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47289"
}
```



---

archive/issue_events_047290.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47290"
}
```



---

archive/issue_comments_205273.json:
```json
{
    "body": "Changing component from distribution to python3.",
    "created_at": "2016-05-02T13:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205273",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from distribution to python3.



---

archive/issue_events_047291.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-02-28T19:44:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47291"
}
```



---

archive/issue_events_047292.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-02-28T19:44:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47292"
}
```



---

archive/issue_comments_205274.json:
```json
{
    "body": "<a id='comment:5'></a>first half in #22474 (combinat folder)",
    "created_at": "2017-02-28T21:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205274",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>first half in #22474 (combinat folder)



---

archive/issue_comments_205275.json:
```json
{
    "body": "<a id='comment:6'></a>another easy step in #22479\n\nthen there remains more difficult cases",
    "created_at": "2017-03-01T08:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205275",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>another easy step in #22479

then there remains more difficult cases



---

archive/issue_comments_205276.json:
```json
{
    "body": "<a id='comment:7'></a>Cython files: #22537",
    "created_at": "2017-03-07T10:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205276",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Cython files: #22537



---

archive/issue_comments_205277.json:
```json
{
    "body": "<a id='comment:8'></a>`@`tscrim: I have not been able to fix the use of metaclass in \n\n```\n* src/sage/algebras/clifford_algebra.py\n* src/sage/algebras/commutative_dga.py\n* src/sage/modular/modform_hecketriangle/graded_ring_element.py\n```\nThe expected python3 replacement is\n\n```\nfrom six import add_metaclass\n\n@add_metaclass(name_of_metaclass)\nclass something\n```\nBut this does not work for the three mentioned files.",
    "created_at": "2017-04-06T11:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205277",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>`@`tscrim: I have not been able to fix the use of metaclass in 

```
* src/sage/algebras/clifford_algebra.py
* src/sage/algebras/commutative_dga.py
* src/sage/modular/modform_hecketriangle/graded_ring_element.py
```
The expected python3 replacement is

```
from six import add_metaclass

@add_metaclass(name_of_metaclass)
class something
```
But this does not work for the three mentioned files.



---

archive/issue_comments_205278.json:
```json
{
    "body": "<a id='comment:9'></a>For reference, can you at least push the non-working branch?",
    "created_at": "2017-04-06T11:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205278",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>For reference, can you at least push the non-working branch?



---

archive/issue_events_047293.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-04-06T12:02:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47293"
}
```



---

archive/issue_events_047294.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-04-06T12:02:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47294"
}
```



---

archive/issue_comments_205279.json:
```json
{
    "body": "<a id='comment:10'></a>here it is\n\n---\nNew commits:",
    "created_at": "2017-04-06T12:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205279",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>here it is

---
New commits:



---

archive/issue_comments_205280.json:
```json
{
    "body": "<a id='comment:11'></a>failing as follows\n\n```\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/clifford_algebra.py\", line 2163, in <module>\n    class ExteriorAlgebraDifferential(ModuleMorphismByLinearity, UniqueRepresentation):\nTypeError: Error when calling the metaclass bases\n    metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases\n```",
    "created_at": "2017-04-06T12:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205280",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>failing as follows

```
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/clifford_algebra.py", line 2163, in <module>
    class ExteriorAlgebraDifferential(ModuleMorphismByLinearity, UniqueRepresentation):
TypeError: Error when calling the metaclass bases
    metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
```



---

archive/issue_comments_205281.json:
```json
{
    "body": "<a id='comment:12'></a>``@`add_metaclass` probably does something with the metaclass. Unless it is because of our heirarchy of metaclass...but I doubt it is that. It might be a decorator that needs to be added to the subclasses as well.",
    "created_at": "2017-04-06T22:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205281",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>``@`add_metaclass` probably does something with the metaclass. Unless it is because of our heirarchy of metaclass...but I doubt it is that. It might be a decorator that needs to be added to the subclasses as well.



---

archive/issue_comments_205282.json:
```json
{
    "body": "<a id='comment:13'></a>The problem is the decorator, because it works in 2 steps:\n\n1. The class is created the usual way.\n\n2. The decorator modifies the class to have a new metaclass.\n\nThe problem is that step 1. already fails, so the decorator cannot do anything.",
    "created_at": "2017-04-07T07:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205282",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>The problem is the decorator, because it works in 2 steps:

1. The class is created the usual way.

2. The decorator modifies the class to have a new metaclass.

The problem is that step 1. already fails, so the decorator cannot do anything.



---

archive/issue_comments_205283.json:
```json
{
    "body": "<a id='comment:14'></a>I'll look into this.",
    "created_at": "2017-04-07T08:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205283",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>I'll look into this.



---

archive/issue_comments_205284.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:8 chapoton]:\n> `@`tscrim: I have not been able to fix the use of metaclass in \n> \n> ```\n> * src/sage/algebras/clifford_algebra.py\n> * src/sage/algebras/commutative_dga.py\n> * src/sage/modular/modform_hecketriangle/graded_ring_element.py\n> ```\n\n\nThere are some other files with `__metaclass__`, such as `src/sage/structure/unique_representation.py`. Should I try to fix these on this ticket too or is there a different ticket?",
    "created_at": "2017-04-07T08:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205284",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:8 chapoton]:
> `@`tscrim: I have not been able to fix the use of metaclass in 
> 
> ```
> * src/sage/algebras/clifford_algebra.py
> * src/sage/algebras/commutative_dga.py
> * src/sage/modular/modform_hecketriangle/graded_ring_element.py
> ```


There are some other files with `__metaclass__`, such as `src/sage/structure/unique_representation.py`. Should I try to fix these on this ticket too or is there a different ticket?



---

archive/issue_comments_205285.json:
```json
{
    "body": "<a id='comment:16'></a>Please fix the metaclass issue in all places where you can. There is no other ticket. I only listed the algebraic use cases. The rest is more like \"sage infrastructure\".",
    "created_at": "2017-04-07T08:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205285",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>Please fix the metaclass issue in all places where you can. There is no other ticket. I only listed the algebraic use cases. The rest is more like "sage infrastructure".



---

archive/issue_comments_205286.json:
```json
{
    "body": "<a id='comment:17'></a>Hmm, I agree that it's not easy :-) I'm making some progress, but I'm not quite there yet.",
    "created_at": "2017-04-07T09:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205286",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Hmm, I agree that it's not easy :-) I'm making some progress, but I'm not quite there yet.



---

archive/issue_comments_205287.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-07T09:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_205288.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-11T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_205289.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-11T11:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205289",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_205290.json:
```json
{
    "body": "<a id='comment:21'></a>Done. The main effort here is fixing `sage.misc.six.with_metaclass` (the first of 3 commits).\n\nAfter this ticket, there is no remaining Sage code using `__metaclass__`. Some doctests still use `__metaclass__`, but I suggest to fix that later.",
    "created_at": "2017-04-11T11:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205290",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Done. The main effort here is fixing `sage.misc.six.with_metaclass` (the first of 3 commits).

After this ticket, there is no remaining Sage code using `__metaclass__`. Some doctests still use `__metaclass__`, but I suggest to fix that later.



---

archive/issue_comments_205291.json:
```json
{
    "body": "<a id='comment:22'></a>I don't agree with this change (and subsequent changes from this):\n\n```diff\ndiff --git a/src/sage/misc/six.py b/src/sage/misc/six.py\nindex 8273d91..5f03a96 100644\n--- a/src/sage/misc/six.py\n+++ b/src/sage/misc/six.py\n@@ -8,7 +8,7 @@ from __future__ import absolute_import\n from six import *\n \n \n-def with_metaclass(meta, *bases):\n+def with_metaclass(*args):\n     \"\"\"\n     Create a base class with a metaclass.\n \n```\nas later we require the first argument to be the meta class. So if someone happened to pass nothing, it would get an error message starting much later in the code. IMO, it also obfuscates the code a little bit too.",
    "created_at": "2017-04-11T15:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205291",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>I don't agree with this change (and subsequent changes from this):

```diff
diff --git a/src/sage/misc/six.py b/src/sage/misc/six.py
index 8273d91..5f03a96 100644
--- a/src/sage/misc/six.py
+++ b/src/sage/misc/six.py
@@ -8,7 +8,7 @@ from __future__ import absolute_import
 from six import *
 
 
-def with_metaclass(meta, *bases):
+def with_metaclass(*args):
     """
     Create a base class with a metaclass.
 
```
as later we require the first argument to be the meta class. So if someone happened to pass nothing, it would get an error message starting much later in the code. IMO, it also obfuscates the code a little bit too.



---

archive/issue_comments_205292.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-12T07:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_205293.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 tscrim]:\n> I don't agree with this change\n\n\nFixed.",
    "created_at": "2017-04-12T07:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205293",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:22 tscrim]:
> I don't agree with this change


Fixed.



---

archive/issue_comments_205294.json:
```json
{
    "body": "<a id='comment:25'></a>I wanted to submit these fixes to `with_metaclass` upstream to `six`. However, when looking at the original `six` code, I understood what was going wrong and it is really simple.\n\nI also realized that it was #18503 which is the cause for the metaclass breakage. In other words, #18503 did the wrong thing and actually made everything more complicated.\n\nIt turns out that #18503 can be fixed in a much simpler way, see https://github.com/benjaminp/six/pull/191 and then this issue (#16074) simply does not occur.",
    "created_at": "2017-04-13T08:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205294",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>I wanted to submit these fixes to `with_metaclass` upstream to `six`. However, when looking at the original `six` code, I understood what was going wrong and it is really simple.

I also realized that it was #18503 which is the cause for the metaclass breakage. In other words, #18503 did the wrong thing and actually made everything more complicated.

It turns out that #18503 can be fixed in a much simpler way, see https://github.com/benjaminp/six/pull/191 and then this issue (#16074) simply does not occur.



---

archive/issue_comments_205295.json:
```json
{
    "body": "<a id='comment:26'></a>That being said, I think the current solution on this ticket is structurally better than upstream's `with_metaclass`: upstream is overriding `__new__` with `__call__` which is a bit fishy. Instead, I am overriding `__call__` with `__call__` which makes more sense.",
    "created_at": "2017-04-13T08:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205295",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>That being said, I think the current solution on this ticket is structurally better than upstream's `with_metaclass`: upstream is overriding `__new__` with `__call__` which is a bit fishy. Instead, I am overriding `__call__` with `__call__` which makes more sense.



---

archive/issue_comments_205296.json:
```json
{
    "body": "<a id='comment:27'></a>Makes sense to me. It's somewhat less pretty than the decorator, but this works for now and gets us closer to Python3.",
    "created_at": "2017-04-14T05:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205296",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:27'></a>Makes sense to me. It's somewhat less pretty than the decorator, but this works for now and gets us closer to Python3.



---

archive/issue_comments_205297.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-14T05:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205297",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_047295.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-14T19:56:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16074#event-47295"
}
```



---

archive/issue_comments_205298.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-14T19:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16074#issuecomment-205298",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
