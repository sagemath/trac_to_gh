# Issue 16988: Degrees of looped *immutable* graphs are wrong

archive/issues_016988.json:
```json
{
    "body": "See [this SO question](http://stackoverflow.com/questions/26566823/sage-python-bug-in-looped-graph-degree-computation).\n\n```\nq=graphs.CompleteGraph(2)\nq.allow_loops(True)\nq.allow_multiple_edges(True)\nq.add_edge([1,1])\na=q.copy(immutable=True)\nb=q.copy(immutable=False)\n\nsage: a==b\nTrue\nsage: a.degree()\n[1, 2]\nsage: b.degree()\n[1, 3]\n```\n\nBasically, the problem is that the usual backend has a case for this\n\n```\n    if self._loops and self.has_edge(v, v, None):\n        if self._multiple_edges:\n            d += len(self.get_edge_label(v, v))\n        else:\n            d += 1\n```\nbut the \"static\" one doesn't.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17225\n\n",
    "closed_at": "2014-11-15T16:22:23Z",
    "created_at": "2014-10-26T03:59:16Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Degrees of looped *immutable* graphs are wrong",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16988",
    "user": "https://github.com/kcrisman"
}
```
See [this SO question](http://stackoverflow.com/questions/26566823/sage-python-bug-in-looped-graph-degree-computation).

```
q=graphs.CompleteGraph(2)
q.allow_loops(True)
q.allow_multiple_edges(True)
q.add_edge([1,1])
a=q.copy(immutable=True)
b=q.copy(immutable=False)

sage: a==b
True
sage: a.degree()
[1, 2]
sage: b.degree()
[1, 3]
```

Basically, the problem is that the usual backend has a case for this

```
    if self._loops and self.has_edge(v, v, None):
        if self._multiple_edges:
            d += len(self.get_edge_label(v, v))
        else:
            d += 1
```
but the "static" one doesn't.

Issue created by migration from https://trac.sagemath.org/ticket/17225





---

archive/issue_comments_224975.json:
```json
{
    "body": "HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.\n\nIf you want the number of edges to be twice the sum of degrees, then it is wrong.\n\nNathann",
    "created_at": "2014-10-26T11:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224975",
    "user": "https://github.com/nathanncohen"
}
```

HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.

If you want the number of edges to be twice the sum of degrees, then it is wrong.

Nathann



---

archive/issue_comments_224976.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-26T14:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224976",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_224977.json:
```json
{
    "body": "Not sure that I ever mentionned it, but I hate loops, I hate labels and I hate multiple edges.\n\nNathann",
    "created_at": "2014-10-26T14:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224977",
    "user": "https://github.com/nathanncohen"
}
```

Not sure that I ever mentionned it, but I hate loops, I hate labels and I hate multiple edges.

Nathann



---

archive/issue_comments_224978.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-26T14:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_224979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-10-26T14:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_224980.json:
```json
{
    "body": "> HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.\n> \n> If you want the number of edges to be twice the sum of degrees, then it is wrong.\n\n\nI mostly want immutable and mutable graphs to have the same behavior.",
    "created_at": "2014-10-26T20:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224980",
    "user": "https://github.com/kcrisman"
}
```

> HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.
> 
> If you want the number of edges to be twice the sum of degrees, then it is wrong.


I mostly want immutable and mutable graphs to have the same behavior.



---

archive/issue_comments_224981.json:
```json
{
    "body": "> I mostly want immutable and mutable graphs to have the same behavior.\n\n\nYesyes I understand. Well, I was rather happy to find a way to fix that without changing the internal data structure. I really did not want to add an \"if\" there, in a function that was just a substraction `:-)`\n\nThe only difference will be at Python level, so it does not matter much.\n\nNathann",
    "created_at": "2014-10-26T21:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224981",
    "user": "https://github.com/nathanncohen"
}
```

> I mostly want immutable and mutable graphs to have the same behavior.


Yesyes I understand. Well, I was rather happy to find a way to fix that without changing the internal data structure. I really did not want to add an "if" there, in a function that was just a substraction `:-)`

The only difference will be at Python level, so it does not matter much.

Nathann



---

archive/issue_comments_224982.json:
```json
{
    "body": "> Yesyes I understand. Well, I was rather happy to find a way to fix that without changing the internal data structure. I really did not want to add an \"if\" there, in a function that was just a substraction `:-)`\n> \n> The only difference will be at Python level, so it does not matter much.\n\n\nHmm, I see what you mean though, keeping track of all this extra data could be expensive when people are searching through really large sets of relatively large graphs (which is when this was implemented in the first place).  I wonder if that will impact efficiency or speed.",
    "created_at": "2014-10-27T12:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224982",
    "user": "https://github.com/kcrisman"
}
```

> Yesyes I understand. Well, I was rather happy to find a way to fix that without changing the internal data structure. I really did not want to add an "if" there, in a function that was just a substraction `:-)`
> 
> The only difference will be at Python level, so it does not matter much.


Hmm, I see what you mean though, keeping track of all this extra data could be expensive when people are searching through really large sets of relatively large graphs (which is when this was implemented in the first place).  I wonder if that will impact efficiency or speed.



---

archive/issue_comments_224983.json:
```json
{
    "body": "Hello !\n\n> Hmm, I see what you mean though, keeping track of all this extra data could be expensive when people are searching through really large sets of relatively large graphs (which is when this was implemented in the first place).  I wonder if that will impact efficiency or speed.\n\n\nYou should not worry too much about that. Performance is wasted in other places, so this probably will not become a problem anytime soon.\n\nThe additional caching is only an array of ints of size n (no Python involved, just real integers). You waste MUCH more ressources if your graph carries a layout for its vertices, for instance ! `:-)`\n\nBesides, it is indeed good that static graphs are MUCH lighter in memory than Sage's usual graphs, but it is not why they were implemented: the low-level data structure was implemented mostly for speed, because at this level you can work on the graph directly without calling any function, everything is as fast as it should be. They were later turned into an immutable Python object because the algebraists wanted graphs as dictionary keys.\n\nThe \"main\" problem though, is that immutable graphs are immutable, and consequently you can only build an immutable graph from a mutable graph (and the mutable graph is MUCH heavier in memory).\n\nThis, to say that this caching is not really a problem. What I wanted to avoid was to add a useless \"if\" in the 'degree' function of the low-level data structure. Fortunately, there is no such function for those graphs are implemented to actually be ... digraphs ! And there we only have an `out_degree` method, which is perfectly defined and only returns a difference of pointers. In particular, no ugly 'if' there `:-P`\n\nNathann",
    "created_at": "2014-10-27T12:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224983",
    "user": "https://github.com/nathanncohen"
}
```

Hello !

> Hmm, I see what you mean though, keeping track of all this extra data could be expensive when people are searching through really large sets of relatively large graphs (which is when this was implemented in the first place).  I wonder if that will impact efficiency or speed.


You should not worry too much about that. Performance is wasted in other places, so this probably will not become a problem anytime soon.

The additional caching is only an array of ints of size n (no Python involved, just real integers). You waste MUCH more ressources if your graph carries a layout for its vertices, for instance ! `:-)`

Besides, it is indeed good that static graphs are MUCH lighter in memory than Sage's usual graphs, but it is not why they were implemented: the low-level data structure was implemented mostly for speed, because at this level you can work on the graph directly without calling any function, everything is as fast as it should be. They were later turned into an immutable Python object because the algebraists wanted graphs as dictionary keys.

The "main" problem though, is that immutable graphs are immutable, and consequently you can only build an immutable graph from a mutable graph (and the mutable graph is MUCH heavier in memory).

This, to say that this caching is not really a problem. What I wanted to avoid was to add a useless "if" in the 'degree' function of the low-level data structure. Fortunately, there is no such function for those graphs are implemented to actually be ... digraphs ! And there we only have an `out_degree` method, which is perfectly defined and only returns a difference of pointers. In particular, no ugly 'if' there `:-P`

Nathann



---

archive/issue_comments_224984.json:
```json
{
    "body": "> HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.\n> > \n> > If you want the number of edges to be twice the sum of degrees, then it is wrong.\n\n\nSee [here](http://en.wikipedia.org/wiki/Loop_(graph_theory)) and [here](http://en.wikipedia.org/wiki/Degree_(graph_theory)#cite_note-1), which *claim* that this is a standard convention.  I don't recall ever hearing a different convention for loops either, and for directed situations we should still be correct, right?   Let me know if I'm missing a controversy on this - sometimes there are mutually incompatible definitions, most notoriously in my own classes for $\\mathbb{N}$.",
    "created_at": "2014-10-28T15:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224984",
    "user": "https://github.com/kcrisman"
}
```

> HMmmmmm... Well, the thing is that it depends on what you want the degree to be. If you want the degree of a vertex to be equal to the number of edges incident to it, then it is correct.
> > 
> > If you want the number of edges to be twice the sum of degrees, then it is wrong.


See [here](http://en.wikipedia.org/wiki/Loop_(graph_theory)) and [here](http://en.wikipedia.org/wiki/Degree_(graph_theory)#cite_note-1), which *claim* that this is a standard convention.  I don't recall ever hearing a different convention for loops either, and for directed situations we should still be correct, right?   Let me know if I'm missing a controversy on this - sometimes there are mutually incompatible definitions, most notoriously in my own classes for $\mathbb{N}$.



---

archive/issue_comments_224985.json:
```json
{
    "body": "Hello !\n\nI assume that what this patch implements is the convention, as it is also what is contained in Wikipedia and books. I just hate conventions that cost running time and make dirty code.\n\nAlso, I am old enough to understand that people make the conventions that are the easiest for them, so I don't like to pay the price of other person's conventions.\n\nBut well, this one was cheap in terms of running time, so let's not complain `:-P`\n\nNathann",
    "created_at": "2014-10-28T17:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224985",
    "user": "https://github.com/nathanncohen"
}
```

Hello !

I assume that what this patch implements is the convention, as it is also what is contained in Wikipedia and books. I just hate conventions that cost running time and make dirty code.

Also, I am old enough to understand that people make the conventions that are the easiest for them, so I don't like to pay the price of other person's conventions.

But well, this one was cheap in terms of running time, so let's not complain `:-P`

Nathann



---

archive/issue_comments_224986.json:
```json
{
    "body": "For some reason this isn't merging properly.   And I was going to look at it this afternoon, too...",
    "created_at": "2014-11-07T17:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224986",
    "user": "https://github.com/kcrisman"
}
```

For some reason this isn't merging properly.   And I was going to look at it this afternoon, too...



---

archive/issue_comments_224987.json:
```json
{
    "body": "Hello !\n\nThat was because the line that imports bitsets changed in #17196. Now, 'for simplicity reasons', we have data structures in structures/, data_structures/ and misc/.\n\nRebased !\n\nNathann",
    "created_at": "2014-11-08T11:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224987",
    "user": "https://github.com/nathanncohen"
}
```

Hello !

That was because the line that imports bitsets changed in #17196. Now, 'for simplicity reasons', we have data structures in structures/, data_structures/ and misc/.

Rebased !

Nathann



---

archive/issue_comments_224988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-08T11:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_224989.json:
```json
{
    "body": "Should\n\n```\n+        cdef int i, tmp\n```\nbe\n\n```\n+        cdef int i, j, tmp\n```\nor is that not helpful?\n\nOtherwise this seems good and behaves correctly.\n\nHowever, I found #17340 while reviewing this... sigh.",
    "created_at": "2014-11-13T19:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224989",
    "user": "https://github.com/kcrisman"
}
```

Should

```
+        cdef int i, tmp
```
be

```
+        cdef int i, j, tmp
```
or is that not helpful?

Otherwise this seems good and behaves correctly.

However, I found #17340 while reviewing this... sigh.



---

archive/issue_comments_224990.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-13T19:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224990",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_224991.json:
```json
{
    "body": "Hello !\n\nRight right, this 'j' should appear too.\n\nCould you add a commit, or fix it in #17340 ? I am backpacking in Mumbai right now `:-)`\n\nNathann",
    "created_at": "2014-11-14T04:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224991",
    "user": "https://github.com/nathanncohen"
}
```

Hello !

Right right, this 'j' should appear too.

Could you add a commit, or fix it in #17340 ? I am backpacking in Mumbai right now `:-)`

Nathann



---

archive/issue_comments_224992.json:
```json
{
    "body": "I don't know how to fix #17340, so I can't do that.  I can try to add this here, though.\n\nAre you visiting Tata?  Lucky you!",
    "created_at": "2014-11-14T13:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224992",
    "user": "https://github.com/kcrisman"
}
```

I don't know how to fix #17340, so I can't do that.  I can try to add this here, though.

Are you visiting Tata?  Lucky you!



---

archive/issue_comments_224993.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-11-14T13:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224993",
    "user": "https://github.com/kcrisman"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_224994.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-11-14T13:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224994",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_224995.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-11-14T13:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224995",
    "user": "https://github.com/kcrisman"
}
```

New commits:



---

archive/issue_comments_224996.json:
```json
{
    "body": "Yo !\n\n> I don't know how to fix #17340, so I can't do that.\n\n\nCome ooooooon. I am sure it takes something like one line to fix.\n\n> I can try to add this here, though.\n\n\nThanks !\n\n> Are you visiting Tata?  Lucky you!\n\n\nI visited some Tata museum, but that's all `:-P`\n\nNathann",
    "created_at": "2014-11-14T14:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224996",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> I don't know how to fix #17340, so I can't do that.


Come ooooooon. I am sure it takes something like one line to fix.

> I can try to add this here, though.


Thanks !

> Are you visiting Tata?  Lucky you!


I visited some Tata museum, but that's all `:-P`

Nathann



---

archive/issue_comments_224997.json:
```json
{
    "body": "Actually I was wrong. Looks like #17340 has lready bee fixed in the latest release. Must be one of the 1000 one-line fixes I made about the same problem.\n\nNathann",
    "created_at": "2014-11-14T14:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224997",
    "user": "https://github.com/nathanncohen"
}
```

Actually I was wrong. Looks like #17340 has lready bee fixed in the latest release. Must be one of the 1000 one-line fixes I made about the same problem.

Nathann



---

archive/issue_comments_224998.json:
```json
{
    "body": "> Actually I was wrong. Looks like #17340 has lready bee fixed in the latest release. Must be one of the 1000 one-line fixes I made about the same problem.\n\n\nNo, it was a typo in the description, my bad.",
    "created_at": "2014-11-14T15:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224998",
    "user": "https://github.com/kcrisman"
}
```

> Actually I was wrong. Looks like #17340 has lready bee fixed in the latest release. Must be one of the 1000 one-line fixes I made about the same problem.


No, it was a typo in the description, my bad.



---

archive/issue_comments_224999.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-15T16:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16988#issuecomment-224999",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_049869.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-11-15T16:22:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16988",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16988#event-49869"
}
```
