# Issue 16836: __neg__ fails in CartesianProduct of CombinatorialFreeModule

archive/issues_016599.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage: X=CombinatorialFreeModule(ZZ,ZZ)\nsage: Y=cartesian_product((X,X))\nsage: -Y.an_element()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-189fa298bf84> in <module>()\n----> 1 -Y.an_element()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __neg__(self)\n    920                     \"\"\"\n    921                     return self.parent()(\n--> 922                         -x for x in self.cartesian_factors())\n    923 \n    924         class Algebras(AlgebrasCategory):\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:8902)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4203)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4110)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in _element_constructor_(self, x)\n   1527                 except TypeError:\n   1528                     pass\n-> 1529             raise TypeError(\"do not know how to make x (= %s) an element of self (=%s)\"%(x,self))\n   1530 \n   1531     def _an_element_impl(self):\n\nTypeError: do not know how to make x (= <generator object <genexpr> at 0x7fd385148050>) an element of self (=Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring)\n```\n\nCC:  @nthiery\n\nBranch: **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**\n\nReviewer: **Vincent Delecroix**\n\nAuthor: **Christian Nassau**\n\nComponent: **categories**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/16836_\n\n",
    "closed_at": "2015-04-21T00:10:59Z",
    "created_at": "2014-08-16T05:47:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20categories",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "__neg__ fails in CartesianProduct of CombinatorialFreeModule",
    "type": "issue",
    "updated_at": "2015-04-21T10:34:28Z",
    "url": "https://github.com/sagemath/sage/issues/16836",
    "user": "https://github.com/cnassau"
}
```

```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: Y=cartesian_product((X,X))
sage: -Y.an_element()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-189fa298bf84> in <module>()
----> 1 -Y.an_element()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __neg__(self)
    920                     """
    921                     return self.parent()(
--> 922                         -x for x in self.cartesian_factors())
    923 
    924         class Algebras(AlgebrasCategory):

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:8902)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4203)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4110)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in _element_constructor_(self, x)
   1527                 except TypeError:
   1528                     pass
-> 1529             raise TypeError("do not know how to make x (= %s) an element of self (=%s)"%(x,self))
   1530 
   1531     def _an_element_impl(self):

TypeError: do not know how to make x (= <generator object <genexpr> at 0x7fd385148050>) an element of self (=Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring)
```

CC:  @nthiery

Branch: **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**

Reviewer: **Vincent Delecroix**

Author: **Christian Nassau**

Component: **categories**

_Issue created by migration from https://trac.sagemath.org/ticket/16836_





---

archive/issue_events_240747.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-08-16T05:47:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240747"
}
```



---

archive/issue_events_240748.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-08-16T05:47:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20categories",
    "label_color": "0000ff",
    "label_name": "c: categories",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240748"
}
```



---

archive/issue_events_240749.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-08-16T05:47:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240749"
}
```



---

archive/issue_events_240750.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-08-16T05:47:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240750"
}
```



---

archive/issue_comments_221327.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe fix appears to be quite simple:\n\n```diff\n--- a/src/sage/categories/additive_magmas.py\n+++ b/src/sage/categories/additive_magmas.py\n@@ -918,8 +918,8 @@ class AdditiveMagmas(Category_singleton):\n                             ...\n                             AssertionError\n                     \"\"\"\n-                    return self.parent()(\n-                        -x for x in self.cartesian_factors())\n+                    return self.parent()._cartesian_product_of_elements(\n+                       [-x for x in self.cartesian_factors()])\n```\n\nThis breaks a doctest, however:\n\n```\nFile \"src/sage/categories/additive_magmas.py\", line 903, in sage.categories.additive_magmas.AdditiveMagmas.AdditiveUnital.CartesianProducts.ElementMethods.__neg__\nFailed example:\n    -c\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: Value -42 in not in Non negative integers.\nGot:\n    (-1, -42, -1.00000000000000)\n```\n\nThe fix for that doctest would be to move a sanity check from `_neg_` to `CartesianProduct._cartesian_product_of_elements`. That then breaks a design-comment in the latter routine about being optimized for speed. \n\nAlternatively, the doctest could be removed (my choice). We don't want an implicit sanity-check whenever we negate an element of a cartesian product.\n\nThis is therefore the sort of code/bug that only the original author can fix.",
    "created_at": "2014-08-16T06:34:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221327",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:1" align="right">comment:1</div>

The fix appears to be quite simple:

```diff
--- a/src/sage/categories/additive_magmas.py
+++ b/src/sage/categories/additive_magmas.py
@@ -918,8 +918,8 @@ class AdditiveMagmas(Category_singleton):
                             ...
                             AssertionError
                     """
-                    return self.parent()(
-                        -x for x in self.cartesian_factors())
+                    return self.parent()._cartesian_product_of_elements(
+                       [-x for x in self.cartesian_factors()])
```

This breaks a doctest, however:

```
File "src/sage/categories/additive_magmas.py", line 903, in sage.categories.additive_magmas.AdditiveMagmas.AdditiveUnital.CartesianProducts.ElementMethods.__neg__
Failed example:
    -c
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Value -42 in not in Non negative integers.
Got:
    (-1, -42, -1.00000000000000)
```

The fix for that doctest would be to move a sanity check from `_neg_` to `CartesianProduct._cartesian_product_of_elements`. That then breaks a design-comment in the latter routine about being optimized for speed. 

Alternatively, the doctest could be removed (my choice). We don't want an implicit sanity-check whenever we negate an element of a cartesian product.

This is therefore the sort of code/bug that only the original author can fix.



---

archive/issue_comments_221328.json:
```json
{
    "body": "Branch: **[u/cnassau/16836](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836)**",
    "created_at": "2014-08-16T19:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221328",
    "user": "https://github.com/cnassau"
}
```

Branch: **[u/cnassau/16836](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836)**



---

archive/issue_comments_221329.json:
```json
{
    "body": "Commit: **[`756c053`](https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0)**",
    "created_at": "2014-08-16T19:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221329",
    "user": "https://github.com/cnassau"
}
```

Commit: **[`756c053`](https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0)**



---

archive/issue_comments_221330.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nthe attached patch fixes the problem in the indicated way: the offending doctest has been removed.\n\nafter all, the offendig behaviour (x in N, but -x not in N) is well known from the natural numbers, and not much of a problem.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11ba5af6a7c53bf58c6ea2dad080333e87cfbd26\"><code>11ba5af</code></a></td><td><code>Ticket 16836: inversion was broken for cartesian products of CombinatorialFreeModules</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0\"><code>756c053</code></a></td><td><code>Ticket 16836: add doctest that negates an element of a cartesian product of CombinatorialFreeModules</code></td></tr></table>\n",
    "created_at": "2014-08-16T19:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221330",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:2" align="right">comment:2</div>

the attached patch fixes the problem in the indicated way: the offending doctest has been removed.

after all, the offendig behaviour (x in N, but -x not in N) is well known from the natural numbers, and not much of a problem.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11ba5af6a7c53bf58c6ea2dad080333e87cfbd26"><code>11ba5af</code></a></td><td><code>Ticket 16836: inversion was broken for cartesian products of CombinatorialFreeModules</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0"><code>756c053</code></a></td><td><code>Ticket 16836: add doctest that negates an element of a cartesian product of CombinatorialFreeModules</code></td></tr></table>




---

archive/issue_comments_221331.json:
```json
{
    "body": "Author: **Christian Nassau**",
    "created_at": "2014-08-16T19:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221331",
    "user": "https://github.com/cnassau"
}
```

Author: **Christian Nassau**



---

archive/issue_events_240751.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-08-16T19:03:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240751"
}
```



---

archive/issue_comments_221332.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI've changed the priority to make sure this issue gets addressed in the next release.",
    "created_at": "2014-09-10T07:12:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221332",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:3" align="right">comment:3</div>

I've changed the priority to make sure this issue gets addressed in the next release.



---

archive/issue_events_240752.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-09-10T07:12:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240752"
}
```



---

archive/issue_events_240753.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2014-09-10T07:12:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240753"
}
```



---

archive/issue_comments_221333.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nNot a blocker, but this has been on my todo list. I hope to get to this next week.",
    "created_at": "2014-09-10T07:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221333",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

Not a blocker, but this has been on my todo list. I hope to get to this next week.



---

archive/issue_events_240754.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-09-10T07:53:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240754"
}
```



---

archive/issue_events_240755.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-09-10T07:53:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240755"
}
```



---

archive/issue_events_240756.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-18T12:42:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240756"
}
```



---

archive/issue_events_240757.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-18T12:42:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240757"
}
```



---

archive/issue_comments_221334.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nHello,\n\nCould you change\n\n```\nsage: F = CombinatorialFreeModule(ZZ, ['a','b'])\nsage: FF = cartesian_product((F,F))\nsage: -FF.an_element() # random - only test that negative can be taken\n```\nto something explicit like\n\n```\nsage: F = CombinatorialFreeModule(ZZ, ['a','b'])\nsage: a,b = F.gens()\nsage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])\nsage: c\n2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]\nsage: FF = cartesian_product((F,F))\nsage: c.parent() == FF\nTrue\nsage: -c\n-2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]\n```\n\nIMHO, the following fails but should work\n\n```\nsage: FF([a,b])\nTraceback (most recent call last)\n...\n\nTypeError: do not know how to make x (= [B['a'], B['b']])\nan element of self (=Free module generated by {'a', 'b'} over Integer Ring\n(+) Free module generated by {'a', 'b'} over Integer Ring)\n```\n\nVincent",
    "created_at": "2015-04-18T12:42:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221334",
    "user": "https://github.com/videlec"
}
```

<div id="comment:5" align="right">comment:5</div>

Hello,

Could you change

```
sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
sage: FF = cartesian_product((F,F))
sage: -FF.an_element() # random - only test that negative can be taken
```
to something explicit like

```
sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
sage: a,b = F.gens()
sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])
sage: c
2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]
sage: FF = cartesian_product((F,F))
sage: c.parent() == FF
True
sage: -c
-2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]
```

IMHO, the following fails but should work

```
sage: FF([a,b])
Traceback (most recent call last)
...

TypeError: do not know how to make x (= [B['a'], B['b']])
an element of self (=Free module generated by {'a', 'b'} over Integer Ring
(+) Free module generated by {'a', 'b'} over Integer Ring)
```

Vincent



---

archive/issue_comments_221335.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/db9104986b4a96b277296e52c380ae28f06fe12b\"><code>db91049</code></a></td><td><code>Ticket 16836: inversion was broken for cartesian products of CombinatorialFreeModules</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d48925315e116dfa0903059148aabf644069969c\"><code>d489253</code></a></td><td><code>Ticket 16836: add doctest that negates an element of a cartesian product of CombinatorialFreeModules</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698\"><code>2786114</code></a></td><td><code>Ticket #16836 - doctest improvements.</code></td></tr></table>\n",
    "created_at": "2015-04-19T09:43:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221335",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:6"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/db9104986b4a96b277296e52c380ae28f06fe12b"><code>db91049</code></a></td><td><code>Ticket 16836: inversion was broken for cartesian products of CombinatorialFreeModules</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d48925315e116dfa0903059148aabf644069969c"><code>d489253</code></a></td><td><code>Ticket 16836: add doctest that negates an element of a cartesian product of CombinatorialFreeModules</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698"><code>2786114</code></a></td><td><code>Ticket #16836 - doctest improvements.</code></td></tr></table>




---

archive/issue_comments_221336.json:
```json
{
    "body": "Changed commit from **[`756c053`](https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0)** to **[`2786114`](https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698)**",
    "created_at": "2015-04-19T09:43:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221336",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[`756c053`](https://github.com/sagemath/sagetrac-mirror/commit/756c053d4779fa90485b528c930d7e4538456cc0)** to **[`2786114`](https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698)**



---

archive/issue_comments_221337.json:
```json
{
    "body": "Changed branch from **[u/cnassau/16836](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836)** to **[u/cnassau/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836.2)**",
    "created_at": "2015-04-19T09:43:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221337",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[u/cnassau/16836](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836)** to **[u/cnassau/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836.2)**



---

archive/issue_comments_221338.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@videlec](#comment:5):\n> Could you change\n> \n> ```\n> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])\n> sage: FF = cartesian_product((F,F))\n> sage: -FF.an_element() # random - only test that negative can be taken\n> ```\n> to something explicit like\n> \n> ```\n> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])\n> sage: a,b = F.gens()\n> sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])\n> sage: c\n> 2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]\n> sage: FF = cartesian_product((F,F))\n> sage: c.parent() == FF\n> True\n> sage: -c\n> -2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]\n> ```\n\nI have followed these suggestions; the doctest is now more explicit.\n \n> IMHO, the following fails but should work\n> \n> ```\n> sage: FF([a,b])\n> Traceback (most recent call last)\n> ...\n> \n> TypeError: do not know how to make x (= [B['a'], B['b']])\n> an element of self (=Free module generated by {'a', 'b'} over Integer Ring\n> (+) Free module generated by {'a', 'b'} over Integer Ring)\n> ```\n\nI agree that this looks like a reasonable expectation, but I'm afraid that this might be a bit contentious since it would involve changes in the combinatorial heartland. I'd prefer to keep such matters out of this ticket which is essentially just a simple bugfix.\n\nThanks for taking the time to look into this ticket!\n\nCheers,\nChristian",
    "created_at": "2015-04-19T09:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221338",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@videlec](#comment:5):
> Could you change
> 
> ```
> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
> sage: FF = cartesian_product((F,F))
> sage: -FF.an_element() # random - only test that negative can be taken
> ```
> to something explicit like
> 
> ```
> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
> sage: a,b = F.gens()
> sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])
> sage: c
> 2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]
> sage: FF = cartesian_product((F,F))
> sage: c.parent() == FF
> True
> sage: -c
> -2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]
> ```

I have followed these suggestions; the doctest is now more explicit.
 
> IMHO, the following fails but should work
> 
> ```
> sage: FF([a,b])
> Traceback (most recent call last)
> ...
> 
> TypeError: do not know how to make x (= [B['a'], B['b']])
> an element of self (=Free module generated by {'a', 'b'} over Integer Ring
> (+) Free module generated by {'a', 'b'} over Integer Ring)
> ```

I agree that this looks like a reasonable expectation, but I'm afraid that this might be a bit contentious since it would involve changes in the combinatorial heartland. I'd prefer to keep such matters out of this ticket which is essentially just a simple bugfix.

Thanks for taking the time to look into this ticket!

Cheers,
Christian



---

archive/issue_events_240758.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2015-04-19T09:50:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240758"
}
```



---

archive/issue_events_240759.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2015-04-19T09:50:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240759"
}
```



---

archive/issue_comments_221339.json:
```json
{
    "body": "Changed branch from **[u/cnassau/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836.2)** to **[public/16836](https://github.com/sagemath/sagetrac-mirror/tree/public/16836)**",
    "created_at": "2015-04-19T10:25:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221339",
    "user": "https://github.com/videlec"
}
```

Changed branch from **[u/cnassau/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/16836.2)** to **[public/16836](https://github.com/sagemath/sagetrac-mirror/tree/public/16836)**



---

archive/issue_comments_221340.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHello Christian,\n\nI made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?\n\nBest,\nVincent\n\nPS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2\"><code>ae2a8c3</code></a></td><td><code>Trac 16836: cast each factor explicitely</code></td></tr></table>\n",
    "created_at": "2015-04-19T10:25:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221340",
    "user": "https://github.com/videlec"
}
```

<div id="comment:9" align="right">comment:9</div>

Hello Christian,

I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?

Best,
Vincent

PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2"><code>ae2a8c3</code></a></td><td><code>Trac 16836: cast each factor explicitely</code></td></tr></table>




---

archive/issue_comments_221341.json:
```json
{
    "body": "Changed commit from **[`2786114`](https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698)** to **[`ae2a8c3`](https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2)**",
    "created_at": "2015-04-19T10:25:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221341",
    "user": "https://github.com/videlec"
}
```

Changed commit from **[`2786114`](https://github.com/sagemath/sagetrac-mirror/commit/27861148fe1ec16070603023e9a9fb643f9d6698)** to **[`ae2a8c3`](https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2)**



---

archive/issue_comments_221342.json:
```json
{
    "body": "Changed commit from **[`ae2a8c3`](https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2)** to **[`b8f8879`](https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c)**",
    "created_at": "2015-04-19T15:40:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221342",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ae2a8c3`](https://github.com/sagemath/sagetrac-mirror/commit/ae2a8c32b5071250a03c623832041292e77652d2)** to **[`b8f8879`](https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c)**



---

archive/issue_comments_221343.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/879da9228de09c4abb94193a9ff63a64a9231cfc\"><code>879da92</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into develop</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c\"><code>b8f8879</code></a></td><td><code>Ticket 16836: choose the correct parent for additive inverses in __neg__.</code></td></tr></table>\n",
    "created_at": "2015-04-19T15:40:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221343",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/879da9228de09c4abb94193a9ff63a64a9231cfc"><code>879da92</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into develop</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c"><code>b8f8879</code></a></td><td><code>Ticket 16836: choose the correct parent for additive inverses in __neg__.</code></td></tr></table>




---

archive/issue_comments_221344.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHi Vincent,\n\n> I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?\n\nI think getting an error when using `-42` or `-(42,whatever)` would definitely be misguided - these days that level of \"rigor\" is only appreciated by a small and diminishing group of mostly white-bearded Bourbakistas... \n\nChanging the parent, OTOH, might be a good idea. I have now changed the line again to choose the parent automatically. I'm not sure whether there's an impact on performance, though. For that reason I have also added a new `__neg__` for elements of the cartesian product of semigroups with guaranteed inverses; here the parent is clear and the old code seems appropriate. \n\n> PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.\n\nYour warning came to late, I was already in the process of changing branches, athough not entirely deliberately. The new patch is now based on 6.7.beta1 ...  it seems.",
    "created_at": "2015-04-19T15:45:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221344",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:11" align="right">comment:11</div>

Hi Vincent,

> I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?

I think getting an error when using `-42` or `-(42,whatever)` would definitely be misguided - these days that level of "rigor" is only appreciated by a small and diminishing group of mostly white-bearded Bourbakistas... 

Changing the parent, OTOH, might be a good idea. I have now changed the line again to choose the parent automatically. I'm not sure whether there's an impact on performance, though. For that reason I have also added a new `__neg__` for elements of the cartesian product of semigroups with guaranteed inverses; here the parent is clear and the old code seems appropriate. 

> PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.

Your warning came to late, I was already in the process of changing branches, athough not entirely deliberately. The new patch is now based on 6.7.beta1 ...  it seems.



---

archive/issue_comments_221345.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nNot sure the old code is appropriate:\n\n```\nsage: NNSemiring = NonNegativeIntegerSemiring()\nsage: C = cartesian_product([ZZ,NNSemiring,RR])\nsage: -C([2,0,.4])\n(-2, 0, -0.400000000000000)\nsage: parent(_)\nThe cartesian product of (Integer Ring, Integer Ring,\n Real Field with 53 bits of precision)\n```\nThe problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!\n\nThe good way to do it is to implement a `negation_parent` in the coercion model similar to the `division_parent` that we have right now. This does choose for you the right parent when you do `x / y`.\n\n```\nsage: from sage.structure.element import get_coercion_model\nsage: cm = get_coercion_model()\nsage: cm.division_parent(ZZ)\nRational Field\nsage: cm.division_parent(QQ)\nRational Field\nsage: cm.division_parent(Zmod(14))\nRing of integers modulo 14\n```\nBut it is out of the scope of this ticket I guess.\n\nVincent",
    "created_at": "2015-04-19T16:00:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221345",
    "user": "https://github.com/videlec"
}
```

<div id="comment:12" align="right">comment:12</div>

Not sure the old code is appropriate:

```
sage: NNSemiring = NonNegativeIntegerSemiring()
sage: C = cartesian_product([ZZ,NNSemiring,RR])
sage: -C([2,0,.4])
(-2, 0, -0.400000000000000)
sage: parent(_)
The cartesian product of (Integer Ring, Integer Ring,
 Real Field with 53 bits of precision)
```
The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!

The good way to do it is to implement a `negation_parent` in the coercion model similar to the `division_parent` that we have right now. This does choose for you the right parent when you do `x / y`.

```
sage: from sage.structure.element import get_coercion_model
sage: cm = get_coercion_model()
sage: cm.division_parent(ZZ)
Rational Field
sage: cm.division_parent(QQ)
Rational Field
sage: cm.division_parent(Zmod(14))
Ring of integers modulo 14
```
But it is out of the scope of this ticket I guess.

Vincent



---

archive/issue_comments_221346.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8\"><code>4c7a1c9</code></a></td><td><code>Ticket 16836: remove `__neg__` for cartesian products if factors have no additive inverse</code></td></tr></table>\n",
    "created_at": "2015-04-19T16:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221346",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8"><code>4c7a1c9</code></a></td><td><code>Ticket 16836: remove `__neg__` for cartesian products if factors have no additive inverse</code></td></tr></table>




---

archive/issue_comments_221347.json:
```json
{
    "body": "Changed commit from **[`b8f8879`](https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c)** to **[`4c7a1c9`](https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8)**",
    "created_at": "2015-04-19T16:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221347",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b8f8879`](https://github.com/sagemath/sagetrac-mirror/commit/b8f88790e6fa4143906f1120a0270321b4139e2c)** to **[`4c7a1c9`](https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8)**



---

archive/issue_comments_221348.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@videlec](#comment:12):\n> Not sure the old code is appropriate:\n> \n> ```\n> sage: NNSemiring = NonNegativeIntegerSemiring()\n> sage: C = cartesian_product([ZZ,NNSemiring,RR])\n> sage: -C([2,0,.4])\n> (-2, 0, -0.400000000000000)\n> sage: parent(_)\n> The cartesian product of (Integer Ring, Integer Ring,\n>  Real Field with 53 bits of precision)\n> ```\n> The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!\n\nGetting rid of it sounds like a clean solution. The latest commit now only implements a `__neg__` if all factors are guaranteed to have inverses.\n\nCheers,\nChristian",
    "created_at": "2015-04-19T16:23:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221348",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@videlec](#comment:12):
> Not sure the old code is appropriate:
> 
> ```
> sage: NNSemiring = NonNegativeIntegerSemiring()
> sage: C = cartesian_product([ZZ,NNSemiring,RR])
> sage: -C([2,0,.4])
> (-2, 0, -0.400000000000000)
> sage: parent(_)
> The cartesian product of (Integer Ring, Integer Ring,
>  Real Field with 53 bits of precision)
> ```
> The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!

Getting rid of it sounds like a clean solution. The latest commit now only implements a `__neg__` if all factors are guaranteed to have inverses.

Cheers,
Christian



---

archive/issue_comments_221349.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nLooks good. Could you get rid of this line\n\n```\n+from sage.categories.cartesian_product import cartesian_product\n```\n\nAnd if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.\n\nThen it should be ok.\n\nVincent",
    "created_at": "2015-04-19T16:25:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221349",
    "user": "https://github.com/videlec"
}
```

<div id="comment:15" align="right">comment:15</div>

Looks good. Could you get rid of this line

```
+from sage.categories.cartesian_product import cartesian_product
```

And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.

Then it should be ok.

Vincent



---

archive/issue_comments_221350.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@videlec](#comment:15):\n> Looks good. Could you get rid of this line\n> \n> ```\n> +from sage.categories.cartesian_product import cartesian_product\n> ```\n> \n> And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.\n\nAlright, I've cleaned up the branch and removed that line. \n\nThanks for your time & Cheers,\nChristian",
    "created_at": "2015-04-19T16:51:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221350",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@videlec](#comment:15):
> Looks good. Could you get rid of this line
> 
> ```
> +from sage.categories.cartesian_product import cartesian_product
> ```
> 
> And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.

Alright, I've cleaned up the branch and removed that line. 

Thanks for your time & Cheers,
Christian



---

archive/issue_comments_221351.json:
```json
{
    "body": "Changed commit from **[`4c7a1c9`](https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8)** to **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**",
    "created_at": "2015-04-19T16:52:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221351",
    "user": "https://github.com/cnassau"
}
```

Changed commit from **[`4c7a1c9`](https://github.com/sagemath/sagetrac-mirror/commit/4c7a1c9cd9edfc9ea455918a56917ce873cec2e8)** to **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**



---

archive/issue_comments_221352.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009\"><code>6e9cf9e</code></a></td><td><code>Ticket 16836 fix `__neg__` for cartesian products</code></td></tr></table>\n",
    "created_at": "2015-04-19T16:52:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221352",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:17"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009"><code>6e9cf9e</code></a></td><td><code>Ticket 16836 fix `__neg__` for cartesian products</code></td></tr></table>




---

archive/issue_comments_221353.json:
```json
{
    "body": "Changed branch from **[public/16836](https://github.com/sagemath/sagetrac-mirror/tree/public/16836)** to **[public/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/public/16836.2)**",
    "created_at": "2015-04-19T16:52:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221353",
    "user": "https://github.com/cnassau"
}
```

Changed branch from **[public/16836](https://github.com/sagemath/sagetrac-mirror/tree/public/16836)** to **[public/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/public/16836.2)**



---

archive/issue_comments_221354.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nLet it go!",
    "created_at": "2015-04-19T18:00:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221354",
    "user": "https://github.com/videlec"
}
```

<div id="comment:18" align="right">comment:18</div>

Let it go!



---

archive/issue_events_240760.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-19T18:00:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240760"
}
```



---

archive/issue_events_240761.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-19T18:00:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240761"
}
```



---

archive/issue_comments_221355.json:
```json
{
    "body": "Reviewer: **Vincent Delecroix**",
    "created_at": "2015-04-19T18:00:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221355",
    "user": "https://github.com/videlec"
}
```

Reviewer: **Vincent Delecroix**



---

archive/issue_comments_221356.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHi!\n\nSorry for dropping in so late; this issue dropped out of my mailbox.\n\nThanks for the fix and for the type-checking-free version for\ncartesian products of inverse additive magmas.\n\nThat being said, I'd like to keep the previous implementation (with\nthe fix) for unital magmas. There are cases where this feature can be\nuseful! This ticket is about a fix, not an API change.\n\nAlso, whenever possible:\n\n- Please keep existing doctests.\n- Please keep existing TODO's.\n\nGiven that it's late in the process, reinstating those can be in a\nfollow up ticket if you prefer. But before next release.\n\nTwo notes:\n\n- `an_element` is *not* random. I don't know why the test was marked\n  as such. But in any cases, using `an_element` is usually a nice\n  concise idiom to construct an element on which to do tests.\n\n- I am usually not a big fan of \"coercing silently to a larger\n  universe\". But don't have a strong opinion either. Anyway, this is\n  not directly related to this ticket.\n\n- About `F((xxx,xxx))`: converting from indices of the basis is a nice\n  syntactic sugar indeed. It can't be defined in full generality,\n  because in certain cases there can be ambiguity with coercion from\n  the base ring. For cartesian products, I guess there is no such\n  risk, so that's ok. In any cases that's for user interaction only;\n  in code, one should always use F.term((...)) for genericity and\n  speed.\n\nThanks again!\n                             Nicolas",
    "created_at": "2015-04-20T19:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221356",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:20" align="right">comment:20</div>

Hi!

Sorry for dropping in so late; this issue dropped out of my mailbox.

Thanks for the fix and for the type-checking-free version for
cartesian products of inverse additive magmas.

That being said, I'd like to keep the previous implementation (with
the fix) for unital magmas. There are cases where this feature can be
useful! This ticket is about a fix, not an API change.

Also, whenever possible:

- Please keep existing doctests.
- Please keep existing TODO's.

Given that it's late in the process, reinstating those can be in a
follow up ticket if you prefer. But before next release.

Two notes:

- `an_element` is *not* random. I don't know why the test was marked
  as such. But in any cases, using `an_element` is usually a nice
  concise idiom to construct an element on which to do tests.

- I am usually not a big fan of "coercing silently to a larger
  universe". But don't have a strong opinion either. Anyway, this is
  not directly related to this ticket.

- About `F((xxx,xxx))`: converting from indices of the basis is a nice
  syntactic sugar indeed. It can't be defined in full generality,
  because in certain cases there can be ambiguity with coercion from
  the base ring. For cartesian products, I guess there is no such
  risk, so that's ok. In any cases that's for user interaction only;
  in code, one should always use F.term((...)) for genericity and
  speed.

Thanks again!
                             Nicolas



---

archive/issue_comments_221357.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nHi,\n\nReplying to [@nthiery](#comment:20):\n> That being said, I'd like to keep the previous implementation (with\n> the fix) for unital magmas. There are cases where this feature can be\n> useful! This ticket is about a fix, not an API change.\n\nIt was completely wrong with several respects that were discussed here... (the least being not working).\n\n> Also, whenever possible:\n> \n> - Please keep existing doctests.\n> - Please keep existing TODO's.\n\nTrue. I was a bit fast on that #18263.\n\n> Two notes:\n> \n> - `an_element` is *not* random. I don't know why the test was marked\n>   as such. But in any cases, using `an_element` is usually a nice\n>   concise idiom to construct an element on which to do tests.\n\nIt is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n\n> - About `F((xxx,xxx))`: converting from indices of the basis is a nice\n>   syntactic sugar indeed. It can't be defined in full generality,\n>   because in certain cases there can be ambiguity with coercion from\n>   the base ring. For cartesian products, I guess there is no such\n>   risk, so that's ok. In any cases that's for user interaction only;\n>   in code, one should always use F.term((...)) for genericity and\n>   speed.\n\nWhat is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?\n\nVincent",
    "created_at": "2015-04-20T20:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221357",
    "user": "https://github.com/videlec"
}
```

<div id="comment:21" align="right">comment:21</div>

Hi,

Replying to [@nthiery](#comment:20):
> That being said, I'd like to keep the previous implementation (with
> the fix) for unital magmas. There are cases where this feature can be
> useful! This ticket is about a fix, not an API change.

It was completely wrong with several respects that were discussed here... (the least being not working).

> Also, whenever possible:
> 
> - Please keep existing doctests.
> - Please keep existing TODO's.

True. I was a bit fast on that #18263.

> Two notes:
> 
> - `an_element` is *not* random. I don't know why the test was marked
>   as such. But in any cases, using `an_element` is usually a nice
>   concise idiom to construct an element on which to do tests.

It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.

> - About `F((xxx,xxx))`: converting from indices of the basis is a nice
>   syntactic sugar indeed. It can't be defined in full generality,
>   because in certain cases there can be ambiguity with coercion from
>   the base ring. For cartesian products, I guess there is no such
>   risk, so that's ok. In any cases that's for user interaction only;
>   in code, one should always use F.term((...)) for genericity and
>   speed.

What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?

Vincent



---

archive/issue_comments_221358.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@videlec](#comment:21):\n> It was completely wrong with several respects that were discussed here... (the least being not working).\n\nIt was indeed broken for cartesian products of free modules, but\nworking smoothly and with a well defined behaviour for the other\ncartesian products.\n\nNote by the way that `_neg_` was working smoothly:\n\n```\n    sage: X=CombinatorialFreeModule(ZZ,ZZ)\n    sage: sage: Y=cartesian_product((X,X))\n    sage: x = Y.an_element()\n    sage: x._neg_()\n    -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]\n```\n\nProbably we should be consistent, and either use `__neg__` in all\ncases or `_neg_` (which one does not really matter since anyway there\nis no real reason to involve coercion here).\n\n\n> It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n\nSo, apparently `an_element` was not implemented properly in\n`PermutationGroup`. By not random, I mean that the result of\n`an_element` is supposed to be reasonably stable over time, in\nparticular so that we can use it in tests. Maybe this should be made\nmore explicit in the specs of `an_element`. And progressively fixed\nwhere it not stable enough.\n\n> > - About `F((xxx,xxx))`: converting from indices of the basis is a nice\n> >   syntactic sugar indeed. It can't be defined in full generality,\n> >   because in certain cases there can be ambiguity with coercion from\n> >   the base ring. For cartesian products, I guess there is no such\n> >   risk, so that's ok. In any cases that's for user interaction only;\n> >   in code, one should always use F.term((...)) for genericity and\n> >   speed.\n\n> \n> What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?\n\nSorry, I should have been specific: I was speaking about [comment:7],\nwith `F` being a free module, not the cartesian product indexing its\nbasis.\n\nAmiti\u00e9s,\n                             Nicolas",
    "created_at": "2015-04-20T20:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221358",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@videlec](#comment:21):
> It was completely wrong with several respects that were discussed here... (the least being not working).

It was indeed broken for cartesian products of free modules, but
working smoothly and with a well defined behaviour for the other
cartesian products.

Note by the way that `_neg_` was working smoothly:

```
    sage: X=CombinatorialFreeModule(ZZ,ZZ)
    sage: sage: Y=cartesian_product((X,X))
    sage: x = Y.an_element()
    sage: x._neg_()
    -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]
```

Probably we should be consistent, and either use `__neg__` in all
cases or `_neg_` (which one does not really matter since anyway there
is no real reason to involve coercion here).


> It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.

So, apparently `an_element` was not implemented properly in
`PermutationGroup`. By not random, I mean that the result of
`an_element` is supposed to be reasonably stable over time, in
particular so that we can use it in tests. Maybe this should be made
more explicit in the specs of `an_element`. And progressively fixed
where it not stable enough.

> > - About `F((xxx,xxx))`: converting from indices of the basis is a nice
> >   syntactic sugar indeed. It can't be defined in full generality,
> >   because in certain cases there can be ambiguity with coercion from
> >   the base ring. For cartesian products, I guess there is no such
> >   risk, so that's ok. In any cases that's for user interaction only;
> >   in code, one should always use F.term((...)) for genericity and
> >   speed.

> 
> What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?

Sorry, I should have been specific: I was speaking about [comment:7],
with `F` being a free module, not the cartesian product indexing its
basis.

Amitiés,
                             Nicolas



---

archive/issue_events_240762.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-21T00:10:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240762"
}
```



---

archive/issue_events_240763.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5795d6eddf7957a94f0f0dfd8ffacc5960f23593",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-04-21T00:10:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16836#event-240763"
}
```



---

archive/issue_comments_221359.json:
```json
{
    "body": "Changed branch from **[public/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/public/16836.2)** to **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**",
    "created_at": "2015-04-21T00:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221359",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/16836.2](https://github.com/sagemath/sagetrac-mirror/tree/public/16836.2)** to **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)**



---

archive/issue_comments_221360.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nSalut Nicolas,\n\nReplying to [@nthiery](#comment:22):\n> Replying to [@videlec](#comment:21):\n> > It was completely wrong with several respects that were discussed here... (the least being not working).\n\n> \n> It was indeed broken for cartesian products of free modules, but\n> working smoothly and with a well defined behaviour for the other\n> cartesian products.\n> \n> Note by the way that `_neg_` was working smoothly:\n> \n> ```\n>     sage: X=CombinatorialFreeModule(ZZ,ZZ)\n>     sage: Y=cartesian_product((X,X))\n>     sage: x = Y.an_element()\n>     sage: x._neg_()\n>     -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]\n> ```\n\nThis is indeed a bug! `_neg_` should be called but it wasn't!\n\n> Probably we should be consistent, and either use `__neg__` in all\n> cases or `_neg_` (which one does not really matter since anyway there\n> is no real reason to involve coercion here).\n\nI would just use `__neg__` everywhere. It is faster and consistent with Python.\n\n> > It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n\n> \n> So, apparently `an_element` was not implemented properly in\n> `PermutationGroup`.\n\nIt was. The problems were in `modules_with_basis`, `group_algebras`, etc\n\n> By not random, I mean that the result of\n> `an_element` is supposed to be reasonably stable over time, in\n> particular so that we can use it in tests. Maybe this should be made\n> more explicit in the specs of `an_element`. And progressively fixed\n> where it not stable enough.\n\nI am not sure I like example looking like\n\n```\nsage: F = MyBeautifulParent()\nsage: e = F.an_element()\nsage: ... play with e ...\n```\nIt is much more useful to document how to create elements! Nobody want to play with `.an_element`. It is useful in doctests but I would say only in the section `TESTS`.\n\nVincent",
    "created_at": "2015-04-21T10:34:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221360",
    "user": "https://github.com/videlec"
}
```

<div id="comment:24" align="right">comment:24</div>

Salut Nicolas,

Replying to [@nthiery](#comment:22):
> Replying to [@videlec](#comment:21):
> > It was completely wrong with several respects that were discussed here... (the least being not working).

> 
> It was indeed broken for cartesian products of free modules, but
> working smoothly and with a well defined behaviour for the other
> cartesian products.
> 
> Note by the way that `_neg_` was working smoothly:
> 
> ```
>     sage: X=CombinatorialFreeModule(ZZ,ZZ)
>     sage: Y=cartesian_product((X,X))
>     sage: x = Y.an_element()
>     sage: x._neg_()
>     -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]
> ```

This is indeed a bug! `_neg_` should be called but it wasn't!

> Probably we should be consistent, and either use `__neg__` in all
> cases or `_neg_` (which one does not really matter since anyway there
> is no real reason to involve coercion here).

I would just use `__neg__` everywhere. It is faster and consistent with Python.

> > It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.

> 
> So, apparently `an_element` was not implemented properly in
> `PermutationGroup`.

It was. The problems were in `modules_with_basis`, `group_algebras`, etc

> By not random, I mean that the result of
> `an_element` is supposed to be reasonably stable over time, in
> particular so that we can use it in tests. Maybe this should be made
> more explicit in the specs of `an_element`. And progressively fixed
> where it not stable enough.

I am not sure I like example looking like

```
sage: F = MyBeautifulParent()
sage: e = F.an_element()
sage: ... play with e ...
```
It is much more useful to document how to create elements! Nobody want to play with `.an_element`. It is useful in doctests but I would say only in the section `TESTS`.

Vincent



---

archive/issue_comments_221361.json:
```json
{
    "body": "Changed commit from **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)** to none",
    "created_at": "2015-04-21T10:34:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16836#issuecomment-221361",
    "user": "https://github.com/videlec"
}
```

Changed commit from **[`6e9cf9e`](https://github.com/sagemath/sagetrac-mirror/commit/6e9cf9e72ced0969fd920eca5437f2e3c1d33009)** to none
