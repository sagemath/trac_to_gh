# Issue 16764: Add CM detection for elliptic curves over number fields

archive/issues_016527.json:
```json
{
    "body": "Elliptic curves over the rationals have mathods ``has_cm()`` and ``cm_discriminant()``.  We extend these to curves over number fields, and add a function ``has_rational_cm()`` to indicate the the curve has CM which is defined over its base field (i.e. the CM discriminant is a square in that field), which is always False over QQ.\n\nKeywords: complex multiplication\n\nReviewer: Marco Streng, Chris Wuthrich\n\nAuthor: John Cremona\n\nBranch: 4aea367970e8f902845ed4837a6dd9697619a35e\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16764\n\n",
    "closed_at": "2014-09-25T12:05:42Z",
    "created_at": "2014-08-05T13:17:45Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Add CM detection for elliptic curves over number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16764",
    "user": "https://github.com/JohnCremona"
}
```
Elliptic curves over the rationals have mathods ``has_cm()`` and ``cm_discriminant()``.  We extend these to curves over number fields, and add a function ``has_rational_cm()`` to indicate the the curve has CM which is defined over its base field (i.e. the CM discriminant is a square in that field), which is always False over QQ.

Keywords: complex multiplication

Reviewer: Marco Streng, Chris Wuthrich

Author: John Cremona

Branch: 4aea367970e8f902845ed4837a6dd9697619a35e

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16764





---

archive/issue_comments_217195.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2014-08-05T13:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217195",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_217196.json:
```json
{
    "body": "<a id='comment:2'></a>The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.",
    "created_at": "2014-08-05T13:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217196",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:2'></a>The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.



---

archive/issue_comments_217197.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-05T13:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217198.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-05T13:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217198",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_217199.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:2 cremona]:\n> The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.\n\n\nDone.  This probably counts as rewriting history, too bad.  #16743 will depend on this anyway.",
    "created_at": "2014-08-05T13:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217199",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>Replying to [comment:2 cremona]:
> The changes in isogeny_class.py belong to #16743, not here, and should be ignored.  I'll fix this.


Done.  This probably counts as rewriting history, too bad.  #16743 will depend on this anyway.



---

archive/issue_comments_217200.json:
```json
{
    "body": "<a id='comment:5'></a>Hello,\n\nLines after a `.. NOTE::` should be indented by 4 spaces (not 3).",
    "created_at": "2014-08-06T16:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217200",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>Hello,

Lines after a `.. NOTE::` should be indented by 4 spaces (not 3).



---

archive/issue_comments_217201.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 chapoton]:\n> Hello,\n> \n> Lines after a `.. NOTE::` should be indented by 4 spaces (not 3).\n\n\nAre you sure?  See http://sphinx-doc.org/markup/para.html.  I was aligning the following text under the n of \"note\".",
    "created_at": "2014-08-06T18:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217201",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>Replying to [comment:5 chapoton]:
> Hello,
> 
> Lines after a `.. NOTE::` should be indented by 4 spaces (not 3).


Are you sure?  See http://sphinx-doc.org/markup/para.html.  I was aligning the following text under the n of "note".



---

archive/issue_comments_217202.json:
```json
{
    "body": "<a id='comment:7'></a>Oh, well. I was trusting\n\nhttp://www.sagemath.org/doc/developer/coding_basics.html\n\nbut I wonder now who is right.",
    "created_at": "2014-08-06T18:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217202",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>Oh, well. I was trusting

http://www.sagemath.org/doc/developer/coding_basics.html

but I wonder now who is right.



---

archive/issue_comments_217203.json:
```json
{
    "body": "<a id='comment:8'></a>While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?\n\nI've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so \"Returns True iff this elliptic curve has Complex Multiplication.\" is ambiguous. It could be \"Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure.\" or \"Returns True iff this elliptic curve has a CM j-invariant.\" as in the number field case.",
    "created_at": "2014-08-08T08:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217203",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:8'></a>While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?

I've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so "Returns True iff this elliptic curve has Complex Multiplication." is ambiguous. It could be "Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure." or "Returns True iff this elliptic curve has a CM j-invariant." as in the number field case.



---

archive/issue_comments_217204.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 mstreng]:\n> While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?\n> \n> I've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so \"Returns True iff this elliptic curve has Complex Multiplication.\" is ambiguous. It could be \"Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure.\" or \"Returns True iff this elliptic curve has a CM j-invariant.\" as in the number field case.\n\n\nGood point!  Thanks.  A suitable change for a reviewer's patch (as they used to be called)?",
    "created_at": "2014-08-08T08:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217204",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>Replying to [comment:8 mstreng]:
> While you're at it, could you change the wording in the first line of the documentation of has_cm for elliptic curves over the rationals to be less ambiguous?
> 
> I've seen Complex Multiplication to mean over the base field and to mean over the algebraic closure, so "Returns True iff this elliptic curve has Complex Multiplication." is ambiguous. It could be "Returns True iff this elliptic curve has Complex Multiplication over the algebraic closure." or "Returns True iff this elliptic curve has a CM j-invariant." as in the number field case.


Good point!  Thanks.  A suitable change for a reviewer's patch (as they used to be called)?



---

archive/issue_comments_217205.json:
```json
{
    "body": "<a id='comment:10'></a>I will follow Marco's suggestion about the documentation for has_cm, and also add a field parameter to has_rational_cm (defaulting to the base_field) as William had suggested.",
    "created_at": "2014-08-10T10:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217205",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>I will follow Marco's suggestion about the documentation for has_cm, and also add a field parameter to has_rational_cm (defaulting to the base_field) as William had suggested.



---

archive/issue_comments_217206.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-10T11:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217206",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217207.json:
```json
{
    "body": "<a id='comment:12'></a>Done as above;  also merged 6.3.rc1 into the branch.",
    "created_at": "2014-08-10T11:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217207",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>Done as above;  also merged 6.3.rc1 into the branch.



---

archive/issue_events_049093.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16764#event-49093"
}
```



---

archive/issue_comments_217208.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-27T12:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217208",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217209.json:
```json
{
    "body": "<a id='comment:15'></a>I hope that merging in the develop branch (as at version 6.4.beta1) will make this easier to review and not harder!",
    "created_at": "2014-08-27T12:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217209",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>I hope that merging in the develop branch (as at version 6.4.beta1) will make this easier to review and not harder!



---

archive/issue_comments_217210.json:
```json
{
    "body": "<a id='comment:17'></a>The documentation has three references to \"the `j`-invariant of an immaginary quadratic order\",\nwhich is either a whole Galois orbit or one specific complex number. In all those places it\nshould be \"a `j`-invariant of an imaginary quadratic order\". I'm writing a reviewer patch\nthat corrects this.",
    "created_at": "2014-08-29T12:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217210",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:17'></a>The documentation has three references to "the `j`-invariant of an immaginary quadratic order",
which is either a whole Galois orbit or one specific complex number. In all those places it
should be "a `j`-invariant of an imaginary quadratic order". I'm writing a reviewer patch
that corrects this.



---

archive/issue_comments_217211.json:
```json
{
    "body": "<a id='comment:19'></a>Thanks, Marco.  If that's the only thing you found I am delighted!\n\nAt some point a better implementation of the basic function (detecting whether an algebraic integer is a CM j-invariant) would be good, but the one there is fine for small degrees which is likely to be all that is needed most of the time.\n\n---\nNew commits:",
    "created_at": "2014-08-29T13:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217211",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:19'></a>Thanks, Marco.  If that's the only thing you found I am delighted!

At some point a better implementation of the basic function (detecting whether an algebraic integer is a CM j-invariant) would be good, but the one there is fine for small degrees which is likely to be all that is needed most of the time.

---
New commits:



---

archive/issue_comments_217212.json:
```json
{
    "body": "<a id='comment:20'></a>Hi John. If you agree with my reviewer patch, you can set the ticket to postive_review.\n\n---\nNew commits:",
    "created_at": "2014-08-29T13:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217212",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:20'></a>Hi John. If you agree with my reviewer patch, you can set the ticket to postive_review.

---
New commits:



---

archive/issue_comments_217213.json:
```json
{
    "body": "<a id='comment:21'></a>Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...",
    "created_at": "2014-08-29T13:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217213",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:21'></a>Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...



---

archive/issue_comments_217214.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 mstreng]:\n> Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...\n\n\nNever mind, the tab character is in some kind of xcode temp file, not in the actual source code.",
    "created_at": "2014-08-29T13:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217214",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:22'></a>Replying to [comment:21 mstreng]:
> Oops, I haven't set up my editor properly on this machine. Let me remove the tab character first...


Never mind, the tab character is in some kind of xcode temp file, not in the actual source code.



---

archive/issue_comments_217215.json:
```json
{
    "body": "<a id='comment:23'></a>All tests pass for me, the documentation builds nicely (I can see a tab character). So this all looks fine to me.",
    "created_at": "2014-09-22T10:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217215",
    "user": "https://github.com/categorie"
}
```

<a id='comment:23'></a>All tests pass for me, the documentation builds nicely (I can see a tab character). So this all looks fine to me.



---

archive/issue_comments_217216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-22T10:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217216",
    "user": "https://github.com/categorie"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049094.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-25T12:05:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16764#event-49094"
}
```



---

archive/issue_comments_217217.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-25T12:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217217",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_217218.json:
```json
{
    "body": "<a id='comment:25'></a>What's the intention of the code\n\n```\ntry:\n    D = self._CMD\n    if D:\n        return D\n    else:\n        raise ValueError(\"%s does not have CM\"%self)\nexcept:\n    pass\n```\n\nwhich is obviously equivalent to\n\n```\ntry:\n    D = self._CMD\n    if D:\n        return D\nexcept:\n    pass\n```\n\nI assume you meant something like\n\n```\ntry:\n    D = self._CMD\nexcept AttributeError:\n    pass\nelse:\n    if D:\n        return D\n    else:\n        raise ValueError(\"%s does not have CM\"%self)\n```\n\nApart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.",
    "created_at": "2014-09-30T20:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217218",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>What's the intention of the code

```
try:
    D = self._CMD
    if D:
        return D
    else:
        raise ValueError("%s does not have CM"%self)
except:
    pass
```

which is obviously equivalent to

```
try:
    D = self._CMD
    if D:
        return D
except:
    pass
```

I assume you meant something like

```
try:
    D = self._CMD
except AttributeError:
    pass
else:
    if D:
        return D
    else:
        raise ValueError("%s does not have CM"%self)
```

Apart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.



---

archive/issue_comments_217219.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:\n> Apart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.\n\n\nYou are right. Could you reopen this ticket? This should not be merged into a stable version without fixing that code.",
    "created_at": "2014-10-01T07:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217219",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:
> Apart from this issue, you really should never use `except:` since that catches also `KeyboardInterrupt`.


You are right. Could you reopen this ticket? This should not be merged into a stable version without fixing that code.



---

archive/issue_comments_217220.json:
```json
{
    "body": "<a id='comment:27'></a>I will fix it in #17076.",
    "created_at": "2014-10-01T07:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>I will fix it in #17076.



---

archive/issue_comments_217221.json:
```json
{
    "body": "<a id='comment:28'></a>Apologies, of course I meant to write \"except AttributeError\".  I do know the rules.\n\nTo make absolutely sure:  the field _CMD stores 0 if it has already been determined that E does not have CM, and in this case the method cm_discriminant raises an error -- not my choice but for compatibility with curves over Q.  (I would have preferred to return 0 which is easy for other coed to check).\n\nI'll be happy to review #17076 (though I seem to have forfeited my right to give any code a trustworthy review with this lapse).",
    "created_at": "2014-10-01T08:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16764#issuecomment-217221",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:28'></a>Apologies, of course I meant to write "except AttributeError".  I do know the rules.

To make absolutely sure:  the field _CMD stores 0 if it has already been determined that E does not have CM, and in this case the method cm_discriminant raises an error -- not my choice but for compatibility with curves over Q.  (I would have preferred to return 0 which is easy for other coed to check).

I'll be happy to review #17076 (though I seem to have forfeited my right to give any code a trustworthy review with this lapse).
