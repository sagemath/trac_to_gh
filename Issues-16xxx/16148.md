# Issue 16148: Really enable cython caching

archive/issues_015911.json:
```json
{
    "body": "In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.\n\nBesides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` buffering such that Cython's messages actually appear in the right order.\n\nCC:  @robertwb @vbraun\n\nReviewer: Volker Braun\n\nAuthor: Jeroen Demeyer\n\nBranch: dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16148\n\n",
    "closed_at": "2014-04-15T23:19:42Z",
    "created_at": "2014-04-12T11:19:28Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Really enable cython caching",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16148",
    "user": "https://github.com/jdemeyer"
}
```
In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.

Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` buffering such that Cython's messages actually appear in the right order.

CC:  @robertwb @vbraun

Reviewer: Volker Braun

Author: Jeroen Demeyer

Branch: dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16148





---

archive/issue_comments_267782.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/16148\"",
    "created_at": "2014-04-12T11:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267782",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/16148"



---

archive/issue_comments_267783.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[dfc4bf9](https://github.com/sagemath/sagetrac-mirror/commit/dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f)|`Enable Cython caching by default`|",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267783",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[dfc4bf9](https://github.com/sagemath/sagetrac-mirror/commit/dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f)|`Enable Cython caching by default`|



---

archive/issue_comments_267784.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.\n+\n+Besides this, this ticket also fixes the silly precision in timing output and disables `stdout` flushing such that Cython's messages actually appear in the right order.\n``````\n",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267784",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.
+
+Besides this, this ticket also fixes the silly precision in timing output and disables `stdout` flushing such that Cython's messages actually appear in the right order.
``````




---

archive/issue_comments_267785.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267785",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_267786.json:
```json
{
    "body": "Changing commit from \"\" to \"dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f\"",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267786",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f"



---

archive/issue_comments_267787.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe cycache fix looks good to me.\n\nI don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order. If they are printed to stderr then unbuffered stdout is wrong, it should be line buffered to avoid half-written lines.",
    "created_at": "2014-04-13T13:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267787",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
The cycache fix looks good to me.

I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order. If they are printed to stderr then unbuffered stdout is wrong, it should be line buffered to avoid half-written lines.



---

archive/issue_comments_267788.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2014-04-13T13:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267788",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_267789.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [vbraun](#comment%3A3):\n> I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order.\n\nCython mixes print statements with shell commands. Usually, if you do\n\n```\nprint \"Python message\"\nos.system(\"echo hello\")\n```\nthen the \"hello\" will usually be output before the \"Python message\" if output is not to a terminal (output to a terminal is unbuffered by default).",
    "created_at": "2014-04-13T15:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267789",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [vbraun](#comment%3A3):
> I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order.

Cython mixes print statements with shell commands. Usually, if you do

```
print "Python message"
os.system("echo hello")
```
then the "hello" will usually be output before the "Python message" if output is not to a terminal (output to a terminal is unbuffered by default).



---

archive/issue_comments_267790.json:
```json
{
    "body": "<a id='comment:6'></a>\nOk, I see we are using `os.system` to launch. Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level. Though the lower-level libc buffering is line buffered by default and that probably saves us.",
    "created_at": "2014-04-13T19:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267790",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>
Ok, I see we are using `os.system` to launch. Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level. Though the lower-level libc buffering is line buffered by default and that probably saves us.



---

archive/issue_comments_267791.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [vbraun](#comment%3A6):\n> Ok, I see we are using `os.system` to launch.\n\nWhere \"we\" is also Cython, not just Sage.\n\n> Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level.\n\nHow could unbuffered mode lead to truncated lines?\n\n> Though the lower-level libc buffering is line buffered by default and that probably saves us.\n\nI think it's the same level, Python doesn't do it own buffering.",
    "created_at": "2014-04-14T06:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267791",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [vbraun](#comment%3A6):
> Ok, I see we are using `os.system` to launch.

Where "we" is also Cython, not just Sage.

> Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level.

How could unbuffered mode lead to truncated lines?

> Though the lower-level libc buffering is line buffered by default and that probably saves us.

I think it's the same level, Python doesn't do it own buffering.



---

archive/issue_comments_267792.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to jdemeyer:\n\n> How could unbuffered mode lead to truncated lines?\n\nNot truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\\n222\\n` vs. `111111111\\n2222222\\n`\n\n> Python doesn't do it own buffering.\n\nTo be precise, it did until your patch turned it off. But `os.fdopen(,,0)` does not call libc setvbuf.",
    "created_at": "2014-04-14T08:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267792",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
Replying to jdemeyer:

> How could unbuffered mode lead to truncated lines?

Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`

> Python doesn't do it own buffering.

To be precise, it did until your patch turned it off. But `os.fdopen(,,0)` does not call libc setvbuf.



---

archive/issue_comments_267793.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [vbraun](#comment%3A8):\n> But `os.fdopen(,,0)` does not call libc setvbuf.\n\nI admit I have not read Python's sources, but why do you think so?",
    "created_at": "2014-04-14T12:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267793",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [vbraun](#comment%3A8):
> But `os.fdopen(,,0)` does not call libc setvbuf.

I admit I have not read Python's sources, but why do you think so?



---

archive/issue_comments_267794.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [vbraun](#comment%3A8):\n> Replying to jdemeyer:\n> \n> > How could unbuffered mode lead to truncated lines?\n\n> Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\\n222\\n` vs. `111111111\\n2222222\\n`\nThat can happen with or without buffering. This is an OS-level issue, which libc's buffering doesn't solve.",
    "created_at": "2014-04-14T12:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267794",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [vbraun](#comment%3A8):
> Replying to jdemeyer:
> 
> > How could unbuffered mode lead to truncated lines?

> Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`
That can happen with or without buffering. This is an OS-level issue, which libc's buffering doesn't solve.



---

archive/issue_comments_267795.json:
```json
{
    "body": "<a id='comment:11'></a>\nOk, `os.fdopen` does call `setvbuf`. Cool.",
    "created_at": "2014-04-14T13:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267795",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
Ok, `os.fdopen` does call `setvbuf`. Cool.



---

archive/issue_comments_267796.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [vbraun](#comment%3A11):\n> Ok, `os.fdopen` does call `setvbuf`. Cool.\n\nSide comment: this is something which changed in Python 3, where the libc FILE I/O is no longer used.",
    "created_at": "2014-04-15T09:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267796",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [vbraun](#comment%3A11):
> Ok, `os.fdopen` does call `setvbuf`. Cool.

Side comment: this is something which changed in Python 3, where the libc FILE I/O is no longer used.



---

archive/issue_comments_267797.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.\n \n-Besides this, this ticket also fixes the silly precision in timing output and disables `stdout` flushing such that Cython's messages actually appear in the right order.\n+Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` flushing such that Cython's messages actually appear in the right order.\n``````\n",
    "created_at": "2014-04-15T09:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267797",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.
 
-Besides this, this ticket also fixes the silly precision in timing output and disables `stdout` flushing such that Cython's messages actually appear in the right order.
+Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` flushing such that Cython's messages actually appear in the right order.
``````




---

archive/issue_comments_267798.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.\n \n-Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` flushing such that Cython's messages actually appear in the right order.\n+Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` buffering such that Cython's messages actually appear in the right order.\n``````\n",
    "created_at": "2014-04-15T09:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267798",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.
 
-Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` flushing such that Cython's messages actually appear in the right order.
+Besides this, this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`) and disables `stdout` buffering such that Cython's messages actually appear in the right order.
``````




---

archive/issue_comments_267799.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/16148\" to \"dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f\"",
    "created_at": "2014-04-15T23:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267799",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/ticket/16148" to "dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f"



---

archive/issue_comments_267800.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-15T23:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267800",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054160.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-15T23:19:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16148#event-54160"
}
```



---

archive/issue_comments_267801.json:
```json
{
    "body": "Replying to [ticket:16148 jdemeyer]:\n> this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`)\n\n\n\\o/  Thank you very much, it has been annoying me for years.",
    "created_at": "2014-04-27T09:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267801",
    "user": "https://github.com/nexttime"
}
```

Replying to [ticket:16148 jdemeyer]:
> this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`)


\o/  Thank you very much, it has been annoying me for years.



---

archive/issue_comments_267802.json:
```json
{
    "body": "Changing commit from \"dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f\" to \"\"",
    "created_at": "2014-04-27T09:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267802",
    "user": "https://github.com/nexttime"
}
```

Changing commit from "dfc4bf95f2aa6ee5e69d6754a594d3332a11e35f" to ""



---

archive/issue_comments_267803.json:
```json
{
    "body": "<a id='comment:17'></a>\n\n```\nCython.Compiler.Main.default_options['cache'] = True\n```\nis probably the wrong thing; it should be passed in `options` to `cythonize()`.\n\nBut essentially `cythonize()` appears to be broken w.r.t. this, since it does:\n\n```python\n    ...\n    c_options = CompilationOptions(**options)\n    ...\n    options = c_options    \n    ...\n    if hasattr(options, 'cache'):\n        if not os.path.exists(options.cache):\n            os.makedirs(options.cache)\n```\nand one may end up with\n\n```\nFile \"/scratch/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py\", line 739, in cythonize\nif not os.path.exists(options.cache):\nFile \"/scratch/sage/local/lib/python/genericpath.py\", line 18, in exists\nos.stat(path)\nTypeError: coercing to Unicode: need string or buffer, bool found\n```\nas reported on sage-devel.",
    "created_at": "2014-05-02T14:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267803",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:17'></a>

```
Cython.Compiler.Main.default_options['cache'] = True
```
is probably the wrong thing; it should be passed in `options` to `cythonize()`.

But essentially `cythonize()` appears to be broken w.r.t. this, since it does:

```python
    ...
    c_options = CompilationOptions(**options)
    ...
    options = c_options    
    ...
    if hasattr(options, 'cache'):
        if not os.path.exists(options.cache):
            os.makedirs(options.cache)
```
and one may end up with

```
File "/scratch/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 739, in cythonize
if not os.path.exists(options.cache):
File "/scratch/sage/local/lib/python/genericpath.py", line 18, in exists
os.stat(path)
TypeError: coercing to Unicode: need string or buffer, bool found
```
as reported on sage-devel.



---

archive/issue_comments_267804.json:
```json
{
    "body": "<a id='comment:18'></a>\nIs it possible that cython caching is broken again? At least it does not work for me anymore (i.e., when switching back and forth between branches I do not see a speedup.) Do I have to do anything (create cache directories?) to make it work or should it work out of the box?",
    "created_at": "2015-08-15T18:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267804",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:18'></a>
Is it possible that cython caching is broken again? At least it does not work for me anymore (i.e., when switching back and forth between branches I do not see a speedup.) Do I have to do anything (create cache directories?) to make it work or should it work out of the box?



---

archive/issue_comments_267805.json:
```json
{
    "body": "<a id='comment:19'></a>\nSee #17851",
    "created_at": "2015-08-15T18:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16148",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16148#issuecomment-267805",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
See #17851
