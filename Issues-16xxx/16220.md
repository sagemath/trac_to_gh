# Issue 16220: Waste of time in iterator_edges 3

archive/issues_015983.json:
```json
{
    "assignees": [],
    "body": "Further optimizations for graph iterations following #16005.\n\nThe sparse graph backend (i.e. `sage.graphs.base.sparse_graph.SparseGraph` and `sage.graphs.base.sparse_graph.SparseGraphBackend`) lacks optimization especially for edge iteration. We need to see what is the best we can do and work on it!\n\nAssignee: **@videlec**\n\nCC:  @nathanncohen\n\nKeywords: **graphs, datastructure**\n\nReviewer: **David Coudert**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/16220_\n\n",
    "closed_at": "2020-10-11T17:16:57Z",
    "created_at": "2014-04-23T13:32:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Waste of time in iterator_edges 3",
    "type": "issue",
    "updated_at": "2020-10-11T17:16:57Z",
    "url": "https://github.com/sagemath/sage/issues/16220",
    "user": "https://github.com/videlec"
}
```
Further optimizations for graph iterations following #16005.

The sparse graph backend (i.e. `sage.graphs.base.sparse_graph.SparseGraph` and `sage.graphs.base.sparse_graph.SparseGraphBackend`) lacks optimization especially for edge iteration. We need to see what is the best we can do and work on it!

Assignee: **@videlec**

CC:  @nathanncohen

Keywords: **graphs, datastructure**

Reviewer: **David Coudert**

_Issue created by migration from https://trac.sagemath.org/ticket/16220_





---

archive/issue_events_214015.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-04-23T13:32:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214015"
}
```



---

archive/issue_events_214016.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-04-23T13:32:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "component: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214016"
}
```



---

archive/issue_events_214017.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-04-23T13:32:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214017"
}
```



---

archive/issue_comments_209826.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Further optimizations for graph iterations following #16005\n+Further optimizations for graph iterations following #16005.\n+\n+The sparse graph backend (i.e. `sage.graphs.base.sparse_graph.SparseGraph` and `sage.graphs.base.sparse_graph.SparseGraphBackend`) lacks optimization especially for edge iteration. We need to see what is the best we can do and work on it!\n``````\n",
    "created_at": "2014-04-23T13:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209826",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Further optimizations for graph iterations following #16005
+Further optimizations for graph iterations following #16005.
+
+The sparse graph backend (i.e. `sage.graphs.base.sparse_graph.SparseGraph` and `sage.graphs.base.sparse_graph.SparseGraphBackend`) lacks optimization especially for edge iteration. We need to see what is the best we can do and work on it!
``````




---

archive/issue_comments_209827.json:
```json
{
    "body": "Branch: **[public/16220](https://github.com/sagemath/sagetrac-mirror/tree/public/16220)**",
    "created_at": "2014-04-23T13:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209827",
    "user": "https://github.com/videlec"
}
```

Branch: **[public/16220](https://github.com/sagemath/sagetrac-mirror/tree/public/16220)**



---

archive/issue_comments_209828.json:
```json
{
    "body": "Commit: **[98286f4](https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad)**",
    "created_at": "2014-04-23T13:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209828",
    "user": "https://github.com/videlec"
}
```

Commit: **[98286f4](https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad)**



---

archive/issue_comments_209829.json:
```json
{
    "body": "Changed keywords from none to **graphs, datastructure**",
    "created_at": "2014-04-23T13:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209829",
    "user": "https://github.com/videlec"
}
```

Changed keywords from none to **graphs, datastructure**



---

archive/issue_comments_209830.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56ec117271ec89184091d9bda49b48e0c72d65ab\">56ec117</a></td><td><code>trac 16005: Waste of time in iterator_edges 2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/567600b943c81837a5bc525136b55c6f7878327b\">567600b</a></td><td><code>trac #16005: merge into 6.2.beta8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9623fd75605972cbc177193a16c81b64d9fc26fc\">9623fd7</a></td><td><code>Merge branch 'u/ncohen/16005' of trac.sagemath.org:sage into 16005-waste_of_times_graph2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad\">98286f4</a></td><td><code>optimization of edge_iteration in SparseGraphBackend + documentation</code></td></tr></table>\n",
    "created_at": "2014-04-23T13:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209830",
    "user": "https://github.com/videlec"
}
```

<div id="comment:1" align="right">Comment 1</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56ec117271ec89184091d9bda49b48e0c72d65ab">56ec117</a></td><td><code>trac 16005: Waste of time in iterator_edges 2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/567600b943c81837a5bc525136b55c6f7878327b">567600b</a></td><td><code>trac #16005: merge into 6.2.beta8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9623fd75605972cbc177193a16c81b64d9fc26fc">9623fd7</a></td><td><code>Merge branch 'u/ncohen/16005' of trac.sagemath.org:sage into 16005-waste_of_times_graph2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad">98286f4</a></td><td><code>optimization of edge_iteration in SparseGraphBackend + documentation</code></td></tr></table>




---

archive/issue_events_214018.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2014-04-23T13:39:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214018"
}
```



---

archive/issue_comments_209831.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nIsn't there a problem if you want to iterate over the edges but stop midway ? Isn't it the case that the array is never deallocated ?\n\nNathann",
    "created_at": "2014-04-23T15:09:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209831",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:2" align="right">Comment 2</div>

Isn't there a problem if you want to iterate over the edges but stop midway ? Isn't it the case that the array is never deallocated ?

Nathann



---

archive/issue_comments_209832.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nReplying to [@nathanncohen](#comment%3A2):\n> Isn't there a problem if you want to iterate over the edges but stop midway ? Isn't it the case that the array is never deallocated ?\n\nYou are right, with a code like\n\n```\nsage: it = build_me_an_edge_iterator()\nsage: it.next()\nsage: del it\n```\nwe keep an array never deallocated. But what happens for alloc/dealloc inside cdef functions?\n\nA solution would be to implement an iterator in Cython with direct access to the `SparseGraph` (doing all proper deallocation in `__dealloc__`). Is it worth it?",
    "created_at": "2014-04-23T15:18:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209832",
    "user": "https://github.com/videlec"
}
```

<div id="comment:3" align="right">Comment 3</div>

Replying to [@nathanncohen](#comment%3A2):
> Isn't there a problem if you want to iterate over the edges but stop midway ? Isn't it the case that the array is never deallocated ?

You are right, with a code like

```
sage: it = build_me_an_edge_iterator()
sage: it.next()
sage: del it
```
we keep an array never deallocated. But what happens for alloc/dealloc inside cdef functions?

A solution would be to implement an iterator in Cython with direct access to the `SparseGraph` (doing all proper deallocation in `__dealloc__`). Is it worth it?



---

archive/issue_comments_209833.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\n> we keep an array never deallocated. But what happens for alloc/dealloc inside cdef functions?\n\nI would say that it never happens, and that the only way is to create a class with a constructor/destructor. Which is a lot of code.\n\n> A solution would be to implement an iterator in Cython with direct access to the `SparseGraph` (doing all proper deallocation in `__dealloc__`). Is it worth it?\n\nWell, the question is whether an iterator is cheaper than a malloc.\n\nNathann",
    "created_at": "2014-04-23T15:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209833",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:4" align="right">Comment 4</div>

> we keep an array never deallocated. But what happens for alloc/dealloc inside cdef functions?

I would say that it never happens, and that the only way is to create a class with a constructor/destructor. Which is a lot of code.

> A solution would be to implement an iterator in Cython with direct access to the `SparseGraph` (doing all proper deallocation in `__dealloc__`). Is it worth it?

Well, the question is whether an iterator is cheaper than a malloc.

Nathann



---

archive/issue_events_214019.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214019"
}
```



---

archive/issue_events_214020.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214020"
}
```



---

archive/issue_events_214021.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214021"
}
```



---

archive/issue_events_214022.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214022"
}
```



---

archive/issue_comments_209834.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\n#30665 does some improvements to the edge iterator. It is surely not optimized out. Not sure, if we want to close this ticket here. Or keep it for further improvements.",
    "created_at": "2020-09-29T03:49:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209834",
    "user": "https://github.com/kliem"
}
```

<div id="comment:7" align="right">Comment 7</div>

#30665 does some improvements to the edge iterator. It is surely not optimized out. Not sure, if we want to close this ticket here. Or keep it for further improvements.



---

archive/issue_comments_209835.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nWe can certainly close it.",
    "created_at": "2020-10-02T15:47:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209835",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:8" align="right">Comment 8</div>

We can certainly close it.



---

archive/issue_events_214023.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-02T18:08:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214023"
}
```



---

archive/issue_events_214024.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-02T18:08:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214024"
}
```



---

archive/issue_events_214025.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-02T18:08:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214025"
}
```



---

archive/issue_events_214026.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-02T18:08:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214026"
}
```



---

archive/issue_comments_209836.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nWith #30665, I think this can be closed. The branch certainly doesn't work anymore after redesign.",
    "created_at": "2020-10-02T18:08:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209836",
    "user": "https://github.com/kliem"
}
```

<div id="comment:9" align="right">Comment 9</div>

With #30665, I think this can be closed. The branch certainly doesn't work anymore after redesign.



---

archive/issue_events_214027.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-03T17:35:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214027"
}
```



---

archive/issue_events_214028.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-03T17:35:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214028"
}
```



---

archive/issue_comments_209837.json:
```json
{
    "body": "Reviewer: **David Coudert**",
    "created_at": "2020-10-03T17:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209837",
    "user": "https://github.com/dcoudert"
}
```

Reviewer: **David Coudert**



---

archive/issue_comments_209838.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nAgreed.",
    "created_at": "2020-10-03T17:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209838",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:10" align="right">Comment 10</div>

Agreed.



---

archive/issue_events_214029.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T17:16:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214029"
}
```



---

archive/issue_events_214030.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T17:16:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214030"
}
```



---

archive/issue_events_214031.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T17:16:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16220#event-214031"
}
```



---

archive/issue_comments_209839.json:
```json
{
    "body": "Changed branch from **[public/16220](https://github.com/sagemath/sagetrac-mirror/tree/public/16220)** to none",
    "created_at": "2020-10-11T17:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209839",
    "user": "https://github.com/slel"
}
```

Changed branch from **[public/16220](https://github.com/sagemath/sagetrac-mirror/tree/public/16220)** to none



---

archive/issue_comments_209840.json:
```json
{
    "body": "Changed author from **Vincent Delecroix** to none",
    "created_at": "2020-10-11T17:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209840",
    "user": "https://github.com/slel"
}
```

Changed author from **Vincent Delecroix** to none



---

archive/issue_comments_209841.json:
```json
{
    "body": "Changed commit from **[98286f4](https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad)** to none",
    "created_at": "2020-10-11T17:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16220#issuecomment-209841",
    "user": "https://github.com/slel"
}
```

Changed commit from **[98286f4](https://github.com/sagemath/sagetrac-mirror/commit/98286f45fc077f9778708ca3f064a2f5a13853ad)** to none
