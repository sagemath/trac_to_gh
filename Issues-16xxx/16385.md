# Issue 16385: Fix rounding ZZ -> Python float

archive/issues_016148.json:
```json
{
    "body": "Consider the following conversions:\nA. Sage `Integer` -> Python `float` (or Sage `RDF`)\nB. Python `int`/`long` -> Python `float`\nC. Sage `Integer` -> Sage `RR`\nD. C `unsigned long` -> C `double`\n\nConversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest:\n\n```\nsage: int(float(ZZ(10^17-1)))\n99999999999999984\nsage: int(float(int(10^17-1)))\n100000000000000000\nsage: int(RR(10^17-1))\n100000000000000000\nsage: cython(\"\"\"print <unsigned long>(<double> (%sUL))\"\"\" % (10^17-1))\n100000000000000000\n```\n\nCurrently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. We should fix this, similar to #14416.\n\nCC:  @zimmermann6\n\nBranch/Commit: 04138f3d9118767c4062f4a7166b89b591846e3a\n\nReviewer: Christoph Lauter, Marc Mezzarobba\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16385\n\n",
    "closed_at": "2014-05-29T14:51:24Z",
    "created_at": "2014-05-21T15:44:49Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Fix rounding ZZ -> Python float",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16385",
    "user": "https://github.com/jdemeyer"
}
```
Consider the following conversions:
A. Sage `Integer` -> Python `float` (or Sage `RDF`)
B. Python `int`/`long` -> Python `float`
C. Sage `Integer` -> Sage `RR`
D. C `unsigned long` -> C `double`

Conversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest:

```
sage: int(float(ZZ(10^17-1)))
99999999999999984
sage: int(float(int(10^17-1)))
100000000000000000
sage: int(RR(10^17-1))
100000000000000000
sage: cython("""print <unsigned long>(<double> (%sUL))""" % (10^17-1))
100000000000000000
```

Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. We should fix this, similar to #14416.

CC:  @zimmermann6

Branch/Commit: 04138f3d9118767c4062f4a7166b89b591846e3a

Reviewer: Christoph Lauter, Marc Mezzarobba

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16385





---

archive/issue_comments_265682.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Consider the following conversions:\n A. Sage `Integer` -> Python `float` (or Sage `RDF`)\n-B. Python `int` -> Python `float`\n+B. Python `int`/`long` -> Python `float`\n C. Sage `Integer` -> Sage `RR`\n D. C `unsigned long` -> C `double`\n \n``````\n",
    "created_at": "2014-05-21T15:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265682",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Consider the following conversions:
 A. Sage `Integer` -> Python `float` (or Sage `RDF`)
-B. Python `int` -> Python `float`
+B. Python `int`/`long` -> Python `float`
 C. Sage `Integer` -> Sage `RR`
 D. C `unsigned long` -> C `double`
 
``````




---

archive/issue_comments_265683.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,17 @@\n C. Sage `Integer` -> Sage `RR`\n D. C `unsigned long` -> C `double`\n \n-Conversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest.\n+Conversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest:\n+\n+```\n+sage: int(float(ZZ(10^17-1)))\n+99999999999999984\n+sage: int(float(int(10^17-1)))\n+100000000000000000\n+sage: int(RR(10^17-1))\n+100000000000000000\n+sage: cython(\"\"\"print <unsigned long>(<double> (%sUL))\"\"\" % (10^17-1))\n+100000000000000000\n+```\n \n Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. Doing the conversion via `mpfr` should fix this.\n``````\n",
    "created_at": "2014-05-21T15:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265683",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,17 @@
 C. Sage `Integer` -> Sage `RR`
 D. C `unsigned long` -> C `double`
 
-Conversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest.
+Conversion A rounds to zero, while the others round to nearest (by default). We should make A consistent with the rest:
+
+```
+sage: int(float(ZZ(10^17-1)))
+99999999999999984
+sage: int(float(int(10^17-1)))
+100000000000000000
+sage: int(RR(10^17-1))
+100000000000000000
+sage: cython("""print <unsigned long>(<double> (%sUL))""" % (10^17-1))
+100000000000000000
+```
 
 Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. Doing the conversion via `mpfr` should fix this.
``````




---

archive/issue_comments_265684.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,4 +17,4 @@\n 100000000000000000\n ```\n \n-Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. Doing the conversion via `mpfr` should fix this.\n+Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. We should fix this, similar to #14416.\n``````\n",
    "created_at": "2014-05-22T12:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265684",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,4 +17,4 @@
 100000000000000000
 ```
 
-Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. Doing the conversion via `mpfr` should fix this.
+Currently, `Integer` -> `float` uses `mpz_get_d()` which rounds to zero. We should fix this, similar to #14416.
``````




---

archive/issue_comments_265685.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/16385\"",
    "created_at": "2014-05-22T14:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265685",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/16385"



---

archive/issue_comments_265686.json:
```json
{
    "body": "Changing commit from \"\" to \"04138f3d9118767c4062f4a7166b89b591846e3a\"",
    "created_at": "2014-05-22T14:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265686",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "04138f3d9118767c4062f4a7166b89b591846e3a"



---

archive/issue_comments_265687.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-22T14:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265687",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_265688.json:
```json
{
    "body": "<a id='comment:5'></a>\nNew commits:\n|                                                                                                                                          |                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[04138f3](https://github.com/sagemath/sagetrac-mirror/commit/04138f3d9118767c4062f4a7166b89b591846e3a)|`Correct rounding in ZZ -> float conversion`|",
    "created_at": "2014-05-22T14:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265688",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
New commits:
|                                                                                                                                          |                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[04138f3](https://github.com/sagemath/sagetrac-mirror/commit/04138f3d9118767c4062f4a7166b89b591846e3a)|`Correct rounding in ZZ -> float conversion`|



---

archive/issue_comments_265689.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Christoph Lauter, Marc Mezzarobba\"",
    "created_at": "2014-05-27T13:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265689",
    "user": "https://github.com/mezzarobba"
}
```

Changing reviewer from "" to "Christoph Lauter, Marc Mezzarobba"



---

archive/issue_comments_265690.json:
```json
{
    "body": "<a id='comment:6'></a>\nLooks good to me. But Christoph Lauter sitting next to me noticed that expressions like `1.0/0.0` raise the *Division by zero* FP exception, while IEEE-754 conversions are supposed to raise *Overflow* when the result is too large to be represented in the target format.\n\nAnother minor issue is that your `mpz_get_d_nearest` actually assumes that the current hardware rounding mode is round-to-nearest, because the final call to `ldexp` can overflow:\n\n```\nsage: b = 2^1024-1\nsage: float(b)\ninf\nsage: from ctypes import cdll                                                                 \nsage: from ctypes.util import find_library                                                    \nsage: libm = cdll.LoadLibrary(find_library('m'))                                              \nsage: FE_TOWARDZERO = int(0xc00)                                                              \nsage: libm.fesetround(FE_TOWARDZERO)\n0\nsage: float(b)\n1.7976931348623157e+308\n```\n\nBut I don't know if we really want to go into this kind of business in sage, and your patch clearly improves the previous implementation. So I'll give it positive review and let you decide if you want to support FP flags and non-default rounding modes.\n\nChristoph also suggests to simplify the code a bit by remplacing the part that rounds from 64 to 63 bits by something like\n\n```\nd = <double> ((q64 << 1 ) | !remainder_is_zero)\n```\n(Of course, this version also assumes that the FPU rounds to nearest.)",
    "created_at": "2014-05-27T13:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265690",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:6'></a>
Looks good to me. But Christoph Lauter sitting next to me noticed that expressions like `1.0/0.0` raise the *Division by zero* FP exception, while IEEE-754 conversions are supposed to raise *Overflow* when the result is too large to be represented in the target format.

Another minor issue is that your `mpz_get_d_nearest` actually assumes that the current hardware rounding mode is round-to-nearest, because the final call to `ldexp` can overflow:

```
sage: b = 2^1024-1
sage: float(b)
inf
sage: from ctypes import cdll                                                                 
sage: from ctypes.util import find_library                                                    
sage: libm = cdll.LoadLibrary(find_library('m'))                                              
sage: FE_TOWARDZERO = int(0xc00)                                                              
sage: libm.fesetround(FE_TOWARDZERO)
0
sage: float(b)
1.7976931348623157e+308
```

But I don't know if we really want to go into this kind of business in sage, and your patch clearly improves the previous implementation. So I'll give it positive review and let you decide if you want to support FP flags and non-default rounding modes.

Christoph also suggests to simplify the code a bit by remplacing the part that rounds from 64 to 63 bits by something like

```
d = <double> ((q64 << 1 ) | !remainder_is_zero)
```
(Of course, this version also assumes that the FPU rounds to nearest.)



---

archive/issue_comments_265691.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-27T13:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265691",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_265692.json:
```json
{
    "body": "<a id='comment:7'></a>\nAnother minor point in case you decide to further improve the implementation: why test it with `ZZ((2^53 - 3/4) * 2^971)` rather than `ZZ((2^53 - 1/2) * 2^971) - 1`?",
    "created_at": "2014-05-27T13:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265692",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Another minor point in case you decide to further improve the implementation: why test it with `ZZ((2^53 - 3/4) * 2^971)` rather than `ZZ((2^53 - 1/2) * 2^971) - 1`?



---

archive/issue_comments_265693.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-29T14:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265693",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_265694.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/16385\" to \"04138f3d9118767c4062f4a7166b89b591846e3a\"",
    "created_at": "2014-05-29T14:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16385#issuecomment-265694",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/ticket/16385" to "04138f3d9118767c4062f4a7166b89b591846e3a"



---

archive/issue_events_062635.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-29T14:51:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16385",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16385#event-62635"
}
```
