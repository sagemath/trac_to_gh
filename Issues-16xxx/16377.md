# Issue 16377: back up environment on sage startup

archive/issues_016140.json:
```json
{
    "body": "The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.\n\nFor the motivation see https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw\n\n**Keywords:** shell, start, sandbox\n\n**Branch:** [u/rws/back_up_environment_on_sage_startup](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/back_up_environment_on_sage_startup)\n\n**Commit:** [c611382d5e0f71bb2d3adfc056bc390c3f136ef2](https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2)\n\n**Author:** Ralf Stephan\n\n**Resolution:** invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/16377\n\n",
    "closed_at": "2014-05-23T11:34:14Z",
    "created_at": "2014-05-19T15:37:20Z",
    "labels": [
        "component: scripts"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "back up environment on sage startup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16377",
    "user": "https://github.com/rwst"
}
```
The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.

For the motivation see https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw

**Keywords:** shell, start, sandbox

**Branch:** [u/rws/back_up_environment_on_sage_startup](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/back_up_environment_on_sage_startup)

**Commit:** [c611382d5e0f71bb2d3adfc056bc390c3f136ef2](https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2)

**Author:** Ralf Stephan

**Resolution:** invalid

Issue created by migration from https://trac.sagemath.org/ticket/16377





---

archive/issue_comments_273683.json:
```json
{
    "body": "**Branch:** [u/rws/back_up_environment_on_sage_startup](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/back_up_environment_on_sage_startup)",
    "created_at": "2014-05-19T16:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273683",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/back_up_environment_on_sage_startup](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/back_up_environment_on_sage_startup)



---

archive/issue_comments_273684.json:
```json
{
    "body": "**Author:** Ralf Stephan",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273684",
    "user": "https://github.com/rwst"
}
```

**Author:** Ralf Stephan



---

archive/issue_comments_273685.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273685",
    "user": "https://github.com/rwst"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_273686.json:
```json
{
    "body": "**Commit:** [88410325cedd73c5a0e631250839913699711219](https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219)",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273686",
    "user": "https://github.com/rwst"
}
```

**Commit:** [88410325cedd73c5a0e631250839913699711219](https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219)



---

archive/issue_comments_273687.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219\">8841032</a></td><td><code>16377: back up env to SAGE_ROOT/.orig-env</code></td></tr></table>\n",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273687",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219">8841032</a></td><td><code>16377: back up env to SAGE_ROOT/.orig-env</code></td></tr></table>




---

archive/issue_comments_273688.json:
```json
{
    "body": "<a id='comment:3'></a>\nYou should never assume that the user can write to `SAGE_ROOT`.",
    "created_at": "2014-05-19T16:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273688",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
You should never assume that the user can write to `SAGE_ROOT`.



---

archive/issue_comments_273689.json:
```json
{
    "body": "<a id='comment:4'></a>\nAh thanks, DOT_SAGE would be indeed better.",
    "created_at": "2014-05-19T16:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273689",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>
Ah thanks, DOT_SAGE would be indeed better.



---

archive/issue_comments_273690.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6b65eea1b5c459eaa6eb0045737cd775c773a465\">6b65eea</a></td><td><code>copy helper functions from sage-env to sage; backup env to DOT_SAGE</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2\">c611382</a></td><td><code>Merge branch 't/16377/back_up_environment_on_sage_startup' into tmp</code></td></tr></table>\n",
    "created_at": "2014-05-20T08:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273690",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6b65eea1b5c459eaa6eb0045737cd775c773a465">6b65eea</a></td><td><code>copy helper functions from sage-env to sage; backup env to DOT_SAGE</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2">c611382</a></td><td><code>Merge branch 't/16377/back_up_environment_on_sage_startup' into tmp</code></td></tr></table>




---

archive/issue_comments_273691.json:
```json
{
    "body": "**Changing commit** from \"[88410325cedd73c5a0e631250839913699711219](https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219)\" to \"[c611382d5e0f71bb2d3adfc056bc390c3f136ef2](https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2)\".",
    "created_at": "2014-05-20T08:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[88410325cedd73c5a0e631250839913699711219](https://github.com/sagemath/sagetrac-mirror/commit/88410325cedd73c5a0e631250839913699711219)" to "[c611382d5e0f71bb2d3adfc056bc390c3f136ef2](https://github.com/sagemath/sagetrac-mirror/commit/c611382d5e0f71bb2d3adfc056bc390c3f136ef2)".



---

archive/issue_comments_273692.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2014-05-22T14:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273692",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_273693.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere are several issues:\n1. Re-entrancy: when running different Sage processes, the environment of only 1 will be kept.\n2. Quoting: The textual output of `env` is not suitable, since `\\n` characters in environment variables cannot be reconstructed correctly. Assuming you need this for Python, why not use Python to store the environment in a Python pickle for example?\n3. Why did you copy the `DOT_SAGE` stuff to `src/bin/sage`? Why not simply store the environment inside `sage-env`?\n4. Your code does not support `--nodotsage`.\n\nAnd could you please state more precisely which problem this solves?",
    "created_at": "2014-05-22T14:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273693",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
There are several issues:
1. Re-entrancy: when running different Sage processes, the environment of only 1 will be kept.
2. Quoting: The textual output of `env` is not suitable, since `\n` characters in environment variables cannot be reconstructed correctly. Assuming you need this for Python, why not use Python to store the environment in a Python pickle for example?
3. Why did you copy the `DOT_SAGE` stuff to `src/bin/sage`? Why not simply store the environment inside `sage-env`?
4. Your code does not support `--nodotsage`.

And could you please state more precisely which problem this solves?



---

archive/issue_comments_273694.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.\n+\n+For the motivation see https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw\n``````\n",
    "created_at": "2014-05-22T15:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273694",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.
+
+For the motivation see https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw
``````




---

archive/issue_comments_273695.json:
```json
{
    "body": "<a id='comment:8'></a>\nI can't say I understand completely what [https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw](https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw) talks about, but this ticket looks like the wrong solution for that problem.\n\nThe patchbot simply should not run/compile Sage in a different source tree from what the `SAGE_*` environment variables point to.\n\nI don't want to say that this ticket is pointless, but it should not be used to fix the patchbot issue you're having.",
    "created_at": "2014-05-22T20:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273695",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I can't say I understand completely what [https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw](https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw) talks about, but this ticket looks like the wrong solution for that problem.

The patchbot simply should not run/compile Sage in a different source tree from what the `SAGE_*` environment variables point to.

I don't want to say that this ticket is pointless, but it should not be used to fix the patchbot issue you're having.



---

archive/issue_comments_273696.json:
```json
{
    "body": "<a id='comment:9'></a>\nTo fix the patchbot issue, why not run the patchbot outside of the Sage environment, as an ordinary Python program?",
    "created_at": "2014-05-22T20:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273696",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
To fix the patchbot issue, why not run the patchbot outside of the Sage environment, as an ordinary Python program?



---

archive/issue_comments_273697.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks for the insight. That appears indeed to be the right solution. So the documentation on http://patchbot.sagemath.org/ that wants the user to use `sage -patchbot` should be changed.",
    "created_at": "2014-05-23T08:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273697",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>
Thanks for the insight. That appears indeed to be the right solution. So the documentation on http://patchbot.sagemath.org/ that wants the user to use `sage -patchbot` should be changed.



---

archive/issue_events_054866.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-05-23T08:35:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16377#event-54866"
}
```



---

archive/issue_comments_273698.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2014-05-23T08:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273698",
    "user": "https://github.com/rwst"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_comments_273699.json:
```json
{
    "body": "<a id='comment:11'></a>\nConsequently, a ticket is needed to remove the `-patchbot` argument to Sage.",
    "created_at": "2014-05-23T08:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273699",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
Consequently, a ticket is needed to remove the `-patchbot` argument to Sage.



---

archive/issue_comments_273700.json:
```json
{
    "body": "<a id='comment:12'></a>\nThe handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the \"Source sage-env\" step, so it is done before the environment is changed. In another ticket, please ;-)",
    "created_at": "2014-05-23T11:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273700",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>
The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)



---

archive/issue_comments_273701.json:
```json
{
    "body": "**Resolution:** invalid",
    "created_at": "2014-05-23T11:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273701",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** invalid



---

archive/issue_events_054867.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-23T11:34:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16377#event-54867"
}
```



---

archive/issue_comments_273702.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [vbraun](#comment%3A12):\n> The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the \"Source sage-env\" step, so it is done before the environment is changed. In another ticket, please ;-)\n\n\nThis is now #16390",
    "created_at": "2014-05-24T07:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16377#issuecomment-273702",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>
Replying to [vbraun](#comment%3A12):
> The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)


This is now #16390
