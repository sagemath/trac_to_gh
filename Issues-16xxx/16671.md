# Issue 16671: implement harmonic number function H(n,m)

archive/issues_016434.json:
```json
{
    "body": "H(n,m) belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number\n\nThis is actually a defect because we leave a Maxima result undefined:\n\n```\nsage: sum(1/k^3,k,1,n)\ngen_harmonic_number(3, n)\nsage: gen_harmonic_number?\nObject `gen_harmonic_number` not found.\n```\n\n\nCC:  @eviatarbach @dkrenn\n\nKeywords: special, log\n\nBranch/Commit: 9042104196f2d3b9822b3827aa2bbd70097f7b95\n\nReviewer: Ralf Stephan, Armin Straub\n\nAuthor: Ralf Stephan, Armin Straub\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16671\n\n",
    "closed_at": "2016-08-21T13:14:00Z",
    "created_at": "2014-07-17T16:03:35Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "implement harmonic number function H(n,m)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16671",
    "user": "https://github.com/rwst"
}
```
H(n,m) belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number

This is actually a defect because we leave a Maxima result undefined:

```
sage: sum(1/k^3,k,1,n)
gen_harmonic_number(3, n)
sage: gen_harmonic_number?
Object `gen_harmonic_number` not found.
```


CC:  @eviatarbach @dkrenn

Keywords: special, log

Branch/Commit: 9042104196f2d3b9822b3827aa2bbd70097f7b95

Reviewer: Ralf Stephan, Armin Straub

Author: Ralf Stephan, Armin Straub

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16671





---

archive/issue_comments_276987.json:
```json
{
    "body": "<a id='comment:1'></a>For exact values, FLINT has arith_harmonic_number()",
    "created_at": "2014-07-17T16:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276987",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:1'></a>For exact values, FLINT has arith_harmonic_number()



---

archive/issue_comments_276988.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 fredrik.johansson]:\n> For exact values, FLINT has arith_harmonic_number()\n\nUnfortunately, neither FLINT nor mpmath implements the generalized H(m,n) returned by Maxima in the code example.",
    "created_at": "2014-07-26T13:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276988",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>Replying to [comment:1 fredrik.johansson]:
> For exact values, FLINT has arith_harmonic_number()

Unfortunately, neither FLINT nor mpmath implements the generalized H(m,n) returned by Maxima in the code example.



---

archive/issue_comments_276989.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,11 @@\n H_n belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number\n+\n+This is actually a defect because we leave a Maxima result undefined:\n+\n+```\n+sage: sum(1/k^3,k,1,n)\n+gen_harmonic_number(3, n)\n+sage: gen_harmonic_number?\n+Object `gen_harmonic_number` not found.\n+```\n+\n``````\n",
    "created_at": "2014-07-26T13:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276989",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,11 @@
 H_n belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number
+
+This is actually a defect because we leave a Maxima result undefined:
+
+```
+sage: sum(1/k^3,k,1,n)
+gen_harmonic_number(3, n)
+sage: gen_harmonic_number?
+Object `gen_harmonic_number` not found.
+```
+
``````




---

archive/issue_comments_276990.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-H_n belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number\n+H(n,m) belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number\n \n This is actually a defect because we leave a Maxima result undefined:\n \n``````\n",
    "created_at": "2014-07-26T13:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276990",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-H_n belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number
+H(n,m) belongs to the holonomic repertoir and should be available in Sage, both numerically and symbolically. For some info, see https://groups.google.com/forum/#!topic/sage-devel/uaA0yU7dZHU and https://en.wikipedia.org/wiki/Harmonic_number
 
 This is actually a defect because we leave a Maxima result undefined:
 
``````




---

archive/issue_comments_276991.json:
```json
{
    "body": "Changing type from enhancement to defect.",
    "created_at": "2014-07-26T13:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276991",
    "user": "https://github.com/rwst"
}
```

Changing type from enhancement to defect.



---

archive/issue_comments_276992.json:
```json
{
    "body": "Changing branch from \"\" to \"u/rws/implement_harmonic_number_function_h_n_m_\"",
    "created_at": "2014-07-27T16:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276992",
    "user": "https://github.com/rwst"
}
```

Changing branch from "" to "u/rws/implement_harmonic_number_function_h_n_m_"



---

archive/issue_comments_276993.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2014-07-27T16:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276993",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_276994.json:
```json
{
    "body": "Changing commit from \"\" to \"5310ca10a440c2536da3f043deba80f5c35d041a\"",
    "created_at": "2014-07-27T16:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276994",
    "user": "https://github.com/rwst"
}
```

Changing commit from "" to "5310ca10a440c2536da3f043deba80f5c35d041a"



---

archive/issue_comments_276995.json:
```json
{
    "body": "Changing author from \"\" to \"Ralf Stephan\"",
    "created_at": "2014-07-27T16:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276995",
    "user": "https://github.com/rwst"
}
```

Changing author from "" to "Ralf Stephan"



---

archive/issue_comments_276996.json:
```json
{
    "body": "<a id='comment:5'></a>It is already implemented, I'm just waiting for https://groups.google.com/forum/?hl=en#!topic/sage-devel/SM_FLL33t2g as to argument order of the generalized version.\n\n---\nNew commits:",
    "created_at": "2014-07-27T16:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276996",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>It is already implemented, I'm just waiting for https://groups.google.com/forum/?hl=en#!topic/sage-devel/SM_FLL33t2g as to argument order of the generalized version.

---
New commits:



---

archive/issue_comments_276997.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 rws]:\n> It is already implemented, I'm just waiting for https://groups.google.com/forum/?hl=en#!topic/sage-devel/SM_FLL33t2g as to argument order of the generalized version.\n> \n> ---\n> New commits:\n> |                                                                                                                                          |                                                                          |\n> |------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|\n> |[5310ca1](http://git.sagemath.org/sage.git/commit/?id=5310ca10a440c2536da3f043deba80f5c35d041a)|`16671: implement harmonic number function H(n,m) (modulo argument order)`|\n\n\nFor `maxima_lib` you definitely have to implement a special conversion rule (in both `special_max_to_sage` and `special_sage_to_max`). It'll be a very simple conversion rule, though, so it should be quick to write. There are plenty of examples of entries there already that have to do more complicated manipulations, so just swapping arguments will be easy to figure out.\n\nFor conversions to other maxima interfaces a good start may the special examples in `maxima_lib`. It seems that implementing `_maxima_init_evaled_` might do the trick for conversion to maxima.\n\nThe workhorse for the other direction is `sage.calculus.calculus.symbolic_expression_from_maxima_string` which defines regexes for `polylog` etc., so it seems that any special conversion rules would need to be added there.\n\nYour conversion is not *that* strange though. You just need to swap arguments, which means no special conversion at all as long as you can get it converted to a sage function that expects the arguments in the required order and produces the desired symbolic expression.\n\nIt seems that as long as you can get an entry into `sage.symbolic.pynac.symbol_table.get('maxima', {})` that has a argument-swapping function associated with it, you might be good to go. `sage.symbolic.pynac.register_symbol` might do the trick for that.",
    "created_at": "2014-07-27T18:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276997",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>Replying to [comment:5 rws]:
> It is already implemented, I'm just waiting for https://groups.google.com/forum/?hl=en#!topic/sage-devel/SM_FLL33t2g as to argument order of the generalized version.
> 
> ---
> New commits:
> |                                                                                                                                          |                                                                          |
> |------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
> |[5310ca1](http://git.sagemath.org/sage.git/commit/?id=5310ca10a440c2536da3f043deba80f5c35d041a)|`16671: implement harmonic number function H(n,m) (modulo argument order)`|


For `maxima_lib` you definitely have to implement a special conversion rule (in both `special_max_to_sage` and `special_sage_to_max`). It'll be a very simple conversion rule, though, so it should be quick to write. There are plenty of examples of entries there already that have to do more complicated manipulations, so just swapping arguments will be easy to figure out.

For conversions to other maxima interfaces a good start may the special examples in `maxima_lib`. It seems that implementing `_maxima_init_evaled_` might do the trick for conversion to maxima.

The workhorse for the other direction is `sage.calculus.calculus.symbolic_expression_from_maxima_string` which defines regexes for `polylog` etc., so it seems that any special conversion rules would need to be added there.

Your conversion is not *that* strange though. You just need to swap arguments, which means no special conversion at all as long as you can get it converted to a sage function that expects the arguments in the required order and produces the desired symbolic expression.

It seems that as long as you can get an entry into `sage.symbolic.pynac.symbol_table.get('maxima', {})` that has a argument-swapping function associated with it, you might be good to go. `sage.symbolic.pynac.register_symbol` might do the trick for that.



---

archive/issue_comments_276998.json:
```json
{
    "body": "Changing commit from \"5310ca10a440c2536da3f043deba80f5c35d041a\" to \"ebc93ecacf652b5b83077ba20c22b37f8178ca78\"",
    "created_at": "2014-07-28T09:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276998",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5310ca10a440c2536da3f043deba80f5c35d041a" to "ebc93ecacf652b5b83077ba20c22b37f8178ca78"



---

archive/issue_comments_276999.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-28T09:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-276999",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277000.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks, that was absolutely helpful. I'll put a link on the symbolics wiki page.\n\nPlease review.",
    "created_at": "2014-07-28T09:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277000",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>Thanks, that was absolutely helpful. I'll put a link on the symbolics wiki page.

Please review.



---

archive/issue_comments_277001.json:
```json
{
    "body": "Changing keywords from \"\" to \"special, log\".",
    "created_at": "2014-07-28T09:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277001",
    "user": "https://github.com/rwst"
}
```

Changing keywords from "" to "special, log".



---

archive/issue_comments_277002.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-07-28T09:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277002",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_277003.json:
```json
{
    "body": "<a id='comment:9'></a>A few remarks.\n- in the `maxima_harmonic` regular expression you seem to be trying to find the argument by matching subexpressions. I'm afraid that won't work reliably. If you put in arguments that use parentheses and commas itself and you'll find the regex gets it wrong. Indeed, the example you've taken it from is equally broken:\n\n```\nsage: maxima_calculus(psi(psi(x,x),x))._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[psi(x,x)](x)' in Sage\n```\n(never mind that this is a ValueError and not a TypeError). The maxima_lib specific translator does not have trouble with this:\n\n```\nsage: max_to_sr(maxima_calculus(psi(psi(x,x),x)).ecl())\npsi(psi(x, x), x)\n```\nRegular languages are not sufficient to describe expression languages (the nested parentheses can't be expressed in a regular language--they need a stack or something similar). Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`? then you get to use the parentheses parser that is already in place.\n\n- for this line, you took a way too complicated example.\n\n```\nsage.functions.log.harmonic_number : lambda N,X : [[mqapply],[[max_harmo, max_array],X],N],\n```\nfrom\n\n```\nsage: maxima_calculus(\"gen_harmonic_number(a,b)\").ecl()\n<ECL: (($GEN_HARMONIC_NUMBER SIMP) $A $B)>\n```\nyou see that this should simply be\n\n```\nsage.functions.log.harmonic_number : lambda N,X : [[max_harmo],X,N],\n```\nWith your version one gets:\n\n```\nsage: maxima_calculus(EclObject([[\"mqapply\"],[[\"$gen_harmonic_number\",\"array\"],10],20]))\ngen_harmonic_number[10](20)\n```\nwhich is not the desired form, and you'll find this form can't be converted back either.",
    "created_at": "2014-07-28T16:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277003",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>A few remarks.
- in the `maxima_harmonic` regular expression you seem to be trying to find the argument by matching subexpressions. I'm afraid that won't work reliably. If you put in arguments that use parentheses and commas itself and you'll find the regex gets it wrong. Indeed, the example you've taken it from is equally broken:

```
sage: maxima_calculus(psi(psi(x,x),x))._sage_()
TypeError: unable to make sense of Maxima expression 'psi[psi(x,x)](x)' in Sage
```
(never mind that this is a ValueError and not a TypeError). The maxima_lib specific translator does not have trouble with this:

```
sage: max_to_sr(maxima_calculus(psi(psi(x,x),x)).ecl())
psi(psi(x, x), x)
```
Regular languages are not sufficient to describe expression languages (the nested parentheses can't be expressed in a regular language--they need a stack or something similar). Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`? then you get to use the parentheses parser that is already in place.

- for this line, you took a way too complicated example.

```
sage.functions.log.harmonic_number : lambda N,X : [[mqapply],[[max_harmo, max_array],X],N],
```
from

```
sage: maxima_calculus("gen_harmonic_number(a,b)").ecl()
<ECL: (($GEN_HARMONIC_NUMBER SIMP) $A $B)>
```
you see that this should simply be

```
sage.functions.log.harmonic_number : lambda N,X : [[max_harmo],X,N],
```
With your version one gets:

```
sage: maxima_calculus(EclObject([["mqapply"],[["$gen_harmonic_number","array"],10],20]))
gen_harmonic_number[10](20)
```
which is not the desired form, and you'll find this form can't be converted back either.



---

archive/issue_comments_277004.json:
```json
{
    "body": "<a id='comment:10'></a>By the way, what's your most convincing argument to use an argument order opposite to that of maxima? I think your ordering agrees with what maple and mathematica have chosen, so it may well be that that is indeed the ordering that has most consensus. The wikipedia page is ambiguous since it lists `H_{n,m}=H_n^m=H_m(n)`. Referencing explicitly which convention we follow will make for a better motivated and more stable interface.",
    "created_at": "2014-07-28T19:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277004",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>By the way, what's your most convincing argument to use an argument order opposite to that of maxima? I think your ordering agrees with what maple and mathematica have chosen, so it may well be that that is indeed the ordering that has most consensus. The wikipedia page is ambiguous since it lists `H_{n,m}=H_n^m=H_m(n)`. Referencing explicitly which convention we follow will make for a better motivated and more stable interface.



---

archive/issue_comments_277005.json:
```json
{
    "body": "<a id='comment:11'></a>The paper I looked at had H_n<sup>(m)</sup>, and Wikipedia has mostly H_n,m and H_n<sup>(m)</sup>, but the paper would not be relevant. WP is, and it's listed as reference.",
    "created_at": "2014-07-28T20:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277005",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>The paper I looked at had H_n<sup>(m)</sup>, and Wikipedia has mostly H_n,m and H_n<sup>(m)</sup>, but the paper would not be relevant. WP is, and it's listed as reference.



---

archive/issue_comments_277006.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-29T14:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277007.json:
```json
{
    "body": "Changing commit from \"ebc93ecacf652b5b83077ba20c22b37f8178ca78\" to \"0c93bfe4da1bd2b3a77865ae0a6878007726fff8\"",
    "created_at": "2014-07-29T14:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277007",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ebc93ecacf652b5b83077ba20c22b37f8178ca78" to "0c93bfe4da1bd2b3a77865ae0a6878007726fff8"



---

archive/issue_comments_277008.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:9 nbruin]:\n> Regular languages are not sufficient to describe expression languages (the nested parentheses can't be expressed in a regular language--they need a stack or something similar). Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`? then you get to use the parentheses parser that is already in place.\n\nIs there ready mechanics for this? I can't find one. Do you expect me to implement it?\n> you see that this should simply be\n> \n> ```\n> sage.functions.log.harmonic_number : lambda N,X : [[max_harmo],X,N],\n> ```\n\nThanks, included.",
    "created_at": "2014-07-29T14:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277008",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>Replying to [comment:9 nbruin]:
> Regular languages are not sufficient to describe expression languages (the nested parentheses can't be expressed in a regular language--they need a stack or something similar). Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`? then you get to use the parentheses parser that is already in place.

Is there ready mechanics for this? I can't find one. Do you expect me to implement it?
> you see that this should simply be
> 
> ```
> sage.functions.log.harmonic_number : lambda N,X : [[max_harmo],X,N],
> ```

Thanks, included.



---

archive/issue_comments_277009.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 rws]:\n> Replying to [comment:9 nbruin]:\n> > Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`?\n\n> Is there ready mechanics for this? I can't find one. Do you expect me to implement it?\nNo, just use it. If you do `search_src(\"register_symbol\")` you get a few hits on its use. The following seems to basically work without your patch so I hope you can adjust it for your purposes:\n\n```\nsage: var('x,t,s')\n(x, t, s)\nsage: function('g')\ng\nsage: def swap(a,b): return g(b,a)\nsage: sage.symbolic.pynac.register_symbol(swap,{'maxima':'gen_harmonic_number'})\nsage: sum(1/t^2,t,1,s)\ng(s, 2)\n```\nThat way, the parsing won't be more broken than for other functions (and it seems we're doing fine for most expressions nowadays). The regex for `psi` isn't really wrong, because it specifies there should be only digits between the square brackets. It is perhaps a little overly restrictive, though:\n\n```\nsage: psi(x,s)\npsi(x, s)\nsage: maxima_calculus(psi(x,s))\npsi[x](s)\nsage: maxima_calculus(psi(x,s))._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[x](s)' in Sage\nsage: from sage.interfaces.maxima_lib import max_to_sr\nsage: max_to_sr(maxima_calculus(psi(x,s)).ecl()) #this doesn't rely on parsing or regexes\npsi(x, s)\n```\nI think \"parsing\" psi via regex was just a quick fix around the fact that the expression parser doesn't know what to do with square brackets (and since they're rare, you can get away with not really parsing them properly). In your case, round brackets are so common that you'll quickly get caught if you don't deal with them properly. Luckily, the parser knows how to deal with them, you just have to swap the arguments.",
    "created_at": "2014-07-29T15:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277009",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'></a>Replying to [comment:13 rws]:
> Replying to [comment:9 nbruin]:
> > Can't you get that conversion by giving an appropriate `sage.symbolic.pynac.register_symbol`?

> Is there ready mechanics for this? I can't find one. Do you expect me to implement it?
No, just use it. If you do `search_src("register_symbol")` you get a few hits on its use. The following seems to basically work without your patch so I hope you can adjust it for your purposes:

```
sage: var('x,t,s')
(x, t, s)
sage: function('g')
g
sage: def swap(a,b): return g(b,a)
sage: sage.symbolic.pynac.register_symbol(swap,{'maxima':'gen_harmonic_number'})
sage: sum(1/t^2,t,1,s)
g(s, 2)
```
That way, the parsing won't be more broken than for other functions (and it seems we're doing fine for most expressions nowadays). The regex for `psi` isn't really wrong, because it specifies there should be only digits between the square brackets. It is perhaps a little overly restrictive, though:

```
sage: psi(x,s)
psi(x, s)
sage: maxima_calculus(psi(x,s))
psi[x](s)
sage: maxima_calculus(psi(x,s))._sage_()
TypeError: unable to make sense of Maxima expression 'psi[x](s)' in Sage
sage: from sage.interfaces.maxima_lib import max_to_sr
sage: max_to_sr(maxima_calculus(psi(x,s)).ecl()) #this doesn't rely on parsing or regexes
psi(x, s)
```
I think "parsing" psi via regex was just a quick fix around the fact that the expression parser doesn't know what to do with square brackets (and since they're rare, you can get away with not really parsing them properly). In your case, round brackets are so common that you'll quickly get caught if you don't deal with them properly. Luckily, the parser knows how to deal with them, you just have to swap the arguments.



---

archive/issue_comments_277010.json:
```json
{
    "body": "Changing commit from \"0c93bfe4da1bd2b3a77865ae0a6878007726fff8\" to \"fd0ccd6ea2e7f6a0abf92ee85207c011250b9496\"",
    "created_at": "2014-07-29T15:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277010",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0c93bfe4da1bd2b3a77865ae0a6878007726fff8" to "fd0ccd6ea2e7f6a0abf92ee85207c011250b9496"



---

archive/issue_comments_277011.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-29T15:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277011",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277012.json:
```json
{
    "body": "<a id='comment:16'></a>Thanks again. I completely missed this trick, although I already created a dummy function there.",
    "created_at": "2014-07-29T15:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277012",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>Thanks again. I completely missed this trick, although I already created a dummy function there.



---

archive/issue_comments_277013.json:
```json
{
    "body": "<a id='comment:17'></a>Sorry, this isn't really your fault, but as it turns out the whole `_maxima_init_evaled_` mechanism gets used in a way that's broken: parameters do not get processed recursively. See #16732. As an illustration:\n\n```\nsage:sage: maxima_calculus(polylog(3,polylog(3,x)))\nli[3](polylog(3,x))\n```\nNote that the second argument doesn't get appropriately processed. Your implementation suffers from the same problem.\n\nEither we change the way that `_maxima_init_evaled_` gets called (i.e., we pass it arguments that are processed by the maxima translator itself) or we must change all the `_maxima_init_evaled_` implementations to do that properly (at least a bunch presently don't). An argument against giving `_maxima_init_evaled_` preprocessed arguments is that in principle it's conceivable that a function has an argument that needs special treatment. So letting `_maxima_init_evaled_` do the recursive argument processing under its own control is the more flexible (but more onerous) scheme.",
    "created_at": "2014-07-29T20:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277013",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:17'></a>Sorry, this isn't really your fault, but as it turns out the whole `_maxima_init_evaled_` mechanism gets used in a way that's broken: parameters do not get processed recursively. See #16732. As an illustration:

```
sage:sage: maxima_calculus(polylog(3,polylog(3,x)))
li[3](polylog(3,x))
```
Note that the second argument doesn't get appropriately processed. Your implementation suffers from the same problem.

Either we change the way that `_maxima_init_evaled_` gets called (i.e., we pass it arguments that are processed by the maxima translator itself) or we must change all the `_maxima_init_evaled_` implementations to do that properly (at least a bunch presently don't). An argument against giving `_maxima_init_evaled_` preprocessed arguments is that in principle it's conceivable that a function has an argument that needs special treatment. So letting `_maxima_init_evaled_` do the recursive argument processing under its own control is the more flexible (but more onerous) scheme.



---

archive/issue_comments_277014.json:
```json
{
    "body": "Changing commit from \"fd0ccd6ea2e7f6a0abf92ee85207c011250b9496\" to \"4fa8dd871063de9d658a11135861d3564d215b4c\"",
    "created_at": "2014-07-30T07:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fd0ccd6ea2e7f6a0abf92ee85207c011250b9496" to "4fa8dd871063de9d658a11135861d3564d215b4c"



---

archive/issue_comments_277015.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-30T07:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277016.json:
```json
{
    "body": "<a id='comment:19'></a>Done. I'm not sure if Maxima does the right thing here by expanding the sum. This can get messy for big integers:\n\n```\nsage: maxima_calculus(harmonic_number(3,harmonic_number(x,3),hold=True)).sage()\n1/3^harmonic_number(x, 3) + 1/2^harmonic_number(x, 3) + 1\n```\n\nI also removed the restriction on the second argument.",
    "created_at": "2014-07-30T07:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277016",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>Done. I'm not sure if Maxima does the right thing here by expanding the sum. This can get messy for big integers:

```
sage: maxima_calculus(harmonic_number(3,harmonic_number(x,3),hold=True)).sage()
1/3^harmonic_number(x, 3) + 1/2^harmonic_number(x, 3) + 1
```

I also removed the restriction on the second argument.



---

archive/issue_comments_277017.json:
```json
{
    "body": "Changing commit from \"4fa8dd871063de9d658a11135861d3564d215b4c\" to \"e263ac41caa14a9ba4b537f0f5091cf012d64c3b\"",
    "created_at": "2014-08-05T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4fa8dd871063de9d658a11135861d3564d215b4c" to "e263ac41caa14a9ba4b537f0f5091cf012d64c3b"



---

archive/issue_comments_277018.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-05T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277019.json:
```json
{
    "body": "<a id='comment:21'></a>Ouch, given what we've just run into on #16697 with derivatives, our `_maxima_init_evaled_` hack for swapping arguments would fail in the presence of derivatives:\n\n```\nmaxima_calculus(harmonic_number(x,y).diff(x))\n```\nShould we disallow differentiating harmonic numbers? Otherwise I think we need to rewrite how differential operators get translated. Currently, given:\n\n```\nD[0,1,2](f)(u,v,w)\n```\ngets translated basically to\n\n```\n\"diff(\"+\"f\"+\"(u,v,w)\"+\",u,1,v,1,w,1)\"\n```\nInstead, we could make the *expression* f(u,v,w) and convert that to a maxima string *as a whole* and compose that with the rest. Then we WOULD be going through `_maxima_init_evaled_` etc. There are situations where this is a little more complicated: when \"u,v,w\" are not pure, distinct, variables, then sage needs to substitute temporary place holder variables in order to express the `D[0,1,2]` operator in Leibnitz notation. (and then, after differentiation, substitute the values). Example:\n\n```\nsage: function('f')\nsage: diff( f(x+1),x)._maxima_init_()\n\"at(diff(''f(t0), t0, 1), [t0 = x + 1])\"\nsage: maxima_calculus(diff( f(x+1),x))\n?%at('diff(f(t0),t0,1),[t0=x+1])\n```\nPresently, those temporary variables `t0` do not live in Sage at all. With this change, we would have to instantiate them as symbolic variables in sage to get them converted. (I have checked before, and the `at` substitutions in maxima happen simultaneously, so symbol clashes shouldn't be an issue, other than the possibility of assumptions interfering)",
    "created_at": "2014-08-08T19:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277019",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:21'></a>Ouch, given what we've just run into on #16697 with derivatives, our `_maxima_init_evaled_` hack for swapping arguments would fail in the presence of derivatives:

```
maxima_calculus(harmonic_number(x,y).diff(x))
```
Should we disallow differentiating harmonic numbers? Otherwise I think we need to rewrite how differential operators get translated. Currently, given:

```
D[0,1,2](f)(u,v,w)
```
gets translated basically to

```
"diff("+"f"+"(u,v,w)"+",u,1,v,1,w,1)"
```
Instead, we could make the *expression* f(u,v,w) and convert that to a maxima string *as a whole* and compose that with the rest. Then we WOULD be going through `_maxima_init_evaled_` etc. There are situations where this is a little more complicated: when "u,v,w" are not pure, distinct, variables, then sage needs to substitute temporary place holder variables in order to express the `D[0,1,2]` operator in Leibnitz notation. (and then, after differentiation, substitute the values). Example:

```
sage: function('f')
sage: diff( f(x+1),x)._maxima_init_()
"at(diff(''f(t0), t0, 1), [t0 = x + 1])"
sage: maxima_calculus(diff( f(x+1),x))
?%at('diff(f(t0),t0,1),[t0=x+1])
```
Presently, those temporary variables `t0` do not live in Sage at all. With this change, we would have to instantiate them as symbolic variables in sage to get them converted. (I have checked before, and the `at` substitutions in maxima happen simultaneously, so symbol clashes shouldn't be an issue, other than the possibility of assumptions interfering)



---

archive/issue_comments_277020.json:
```json
{
    "body": "<a id='comment:22'></a>Ouch, this actually shows a missed conversion:\n\n```\nsage: maxima_calculus(f(x).diff(x))\n'diff(f(_SAGE_VAR_x),_SAGE_VAR_x,1)\nsage: maxima_calculus(f(x+1).diff(x)) #this is bad!\n?%at('diff(f(t0),t0,1),[t0=x+1])\n```\nand to compare:\n\n```\nsage: from sage.interfaces.maxima_lib import sr_to_max\nsage: maxima_calculus(sr_to_max(f(x+1).diff(x)))\n?%at('diff(f(_SAGE_VAR_t0),_SAGE_VAR_t0,1),[_SAGE_VAR_t0=_SAGE_VAR_x+1])\nsage: maxima_calculus(sr_to_max(f(x).diff(x)))\n'diff(f(_SAGE_VAR_x),_SAGE_VAR_x,1)\n```\nHow the temporary variable t0 gets represented doesn't matter, but `x` should absolutely be converted to `_SAGE_VAR_x`, in all cases.\n\nThe problem is in [line 505](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/expression_conversions.py#n505). Changing it like this:\n\n```diff\n-            subs = [\"%s = %s\"%(t,a) for t,a in zip(temp_args,args)]\n+            subs = [\"%s = %s\"%(t._maxima_init_(),a._maxima_init_()) for t,a in zip(temp_args,args)]\n```\nand some more changes of the same nature should do the trick.\n\nThis code also shows that the temporary variables are instantiated in sage anyway, so changing the conversion wouldn't be so bad.",
    "created_at": "2014-08-08T21:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277020",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:22'></a>Ouch, this actually shows a missed conversion:

```
sage: maxima_calculus(f(x).diff(x))
'diff(f(_SAGE_VAR_x),_SAGE_VAR_x,1)
sage: maxima_calculus(f(x+1).diff(x)) #this is bad!
?%at('diff(f(t0),t0,1),[t0=x+1])
```
and to compare:

```
sage: from sage.interfaces.maxima_lib import sr_to_max
sage: maxima_calculus(sr_to_max(f(x+1).diff(x)))
?%at('diff(f(_SAGE_VAR_t0),_SAGE_VAR_t0,1),[_SAGE_VAR_t0=_SAGE_VAR_x+1])
sage: maxima_calculus(sr_to_max(f(x).diff(x)))
'diff(f(_SAGE_VAR_x),_SAGE_VAR_x,1)
```
How the temporary variable t0 gets represented doesn't matter, but `x` should absolutely be converted to `_SAGE_VAR_x`, in all cases.

The problem is in [line 505](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/expression_conversions.py#n505). Changing it like this:

```diff
-            subs = ["%s = %s"%(t,a) for t,a in zip(temp_args,args)]
+            subs = ["%s = %s"%(t._maxima_init_(),a._maxima_init_()) for t,a in zip(temp_args,args)]
```
and some more changes of the same nature should do the trick.

This code also shows that the temporary variables are instantiated in sage anyway, so changing the conversion wouldn't be so bad.



---

archive/issue_comments_277021.json:
```json
{
    "body": "<a id='comment:23'></a>See #16785 for differential operator translation fix.",
    "created_at": "2014-08-08T22:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277021",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:23'></a>See #16785 for differential operator translation fix.



---

archive/issue_comments_277022.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:21 nbruin]:\n> Ouch, given what we've just run into on #16697 with derivatives, our `_maxima_init_evaled_` hack for swapping arguments would fail in the presence of derivatives:\n> \n> ```\n> maxima_calculus(harmonic_number(x,y).diff(x))\n> ```\n> Should we disallow differentiating harmonic numbers?\n\nI think so, there's really no need for it.",
    "created_at": "2014-08-09T15:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277022",
    "user": "https://github.com/rwst"
}
```

<a id='comment:24'></a>Replying to [comment:21 nbruin]:
> Ouch, given what we've just run into on #16697 with derivatives, our `_maxima_init_evaled_` hack for swapping arguments would fail in the presence of derivatives:
> 
> ```
> maxima_calculus(harmonic_number(x,y).diff(x))
> ```
> Should we disallow differentiating harmonic numbers?

I think so, there's really no need for it.



---

archive/issue_comments_277023.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 rws]:\n> > Should we disallow differentiating harmonic numbers?\n\n> I think so, there's really no need for it.\nWith #16785 (which needs to be merged anyway) the urgency is reduced. Given the complex continuations that exist for the harmonic number function, perhaps we shouldn't go out of our way prohibiting it, even if we don't have any functionality for it (yet).",
    "created_at": "2014-08-09T18:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277023",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:25'></a>Replying to [comment:24 rws]:
> > Should we disallow differentiating harmonic numbers?

> I think so, there's really no need for it.
With #16785 (which needs to be merged anyway) the urgency is reduced. Given the complex continuations that exist for the harmonic number function, perhaps we shouldn't go out of our way prohibiting it, even if we don't have any functionality for it (yet).



---

archive/issue_events_048865.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48865"
}
```



---

archive/issue_comments_277024.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-12T07:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277025.json:
```json
{
    "body": "Changing commit from \"e263ac41caa14a9ba4b537f0f5091cf012d64c3b\" to \"860820fd5d454bfd4e2e8f40af82e724537f45dc\"",
    "created_at": "2014-08-12T07:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277025",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e263ac41caa14a9ba4b537f0f5091cf012d64c3b" to "860820fd5d454bfd4e2e8f40af82e724537f45dc"



---

archive/issue_comments_277026.json:
```json
{
    "body": "<a id='comment:28'></a>This looks good with #16785:\n\n```\nsage: maxima_calculus(harmonic_number(x,y).diff(x))\n'diff(gen_harmonic_number(_SAGE_VAR_y,_SAGE_VAR_x),_SAGE_VAR_x,1)\n```\nSo, thanks for your review so far. Is there anything missing?",
    "created_at": "2014-08-12T07:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277026",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>This looks good with #16785:

```
sage: maxima_calculus(harmonic_number(x,y).diff(x))
'diff(gen_harmonic_number(_SAGE_VAR_y,_SAGE_VAR_x),_SAGE_VAR_x,1)
```
So, thanks for your review so far. Is there anything missing?



---

archive/issue_comments_277027.json:
```json
{
    "body": "<a id='comment:29'></a>Patchbot complains about a failing doctest\n\n```\nFile \"src/sage/interfaces/maxima_lib.py\", line 1458, in sage.interfaces.maxima_lib.max_harmonic_to_sage\nFailed example:\n    c.ecl()\nExpected:\n    <ECL: (($GEN_HARMONIC_NUMBER SIMP) 2 $X)>\nGot:\n    <ECL: (($GEN_HARMONIC_NUMBER SIMP) 2 |$_SAGE_VAR_x|)>\n```",
    "created_at": "2014-08-12T15:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277027",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:29'></a>Patchbot complains about a failing doctest

```
File "src/sage/interfaces/maxima_lib.py", line 1458, in sage.interfaces.maxima_lib.max_harmonic_to_sage
Failed example:
    c.ecl()
Expected:
    <ECL: (($GEN_HARMONIC_NUMBER SIMP) 2 $X)>
Got:
    <ECL: (($GEN_HARMONIC_NUMBER SIMP) 2 |$_SAGE_VAR_x|)>
```



---

archive/issue_comments_277028.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-12T16:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277028",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277029.json:
```json
{
    "body": "Changing commit from \"860820fd5d454bfd4e2e8f40af82e724537f45dc\" to \"26652819bf557f1daed5e01d892d7ad982e09d29\"",
    "created_at": "2014-08-12T16:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277029",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "860820fd5d454bfd4e2e8f40af82e724537f45dc" to "26652819bf557f1daed5e01d892d7ad982e09d29"



---

archive/issue_comments_277030.json:
```json
{
    "body": "<a id='comment:31'></a>Ah thanks, the `$X` should have rung a bell much earlier.",
    "created_at": "2014-08-12T16:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277030",
    "user": "https://github.com/rwst"
}
```

<a id='comment:31'></a>Ah thanks, the `$X` should have rung a bell much earlier.



---

archive/issue_comments_277031.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-20T14:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277032.json:
```json
{
    "body": "Changing commit from \"26652819bf557f1daed5e01d892d7ad982e09d29\" to \"fd8c09c4be9334f4fd9af3225aa3a2898dd8366d\"",
    "created_at": "2014-08-20T14:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277032",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "26652819bf557f1daed5e01d892d7ad982e09d29" to "fd8c09c4be9334f4fd9af3225aa3a2898dd8366d"



---

archive/issue_comments_277033.json:
```json
{
    "body": "Changing commit from \"fd8c09c4be9334f4fd9af3225aa3a2898dd8366d\" to \"87597bde4c041766a26674a3a8be1d4b076180d5\"",
    "created_at": "2014-12-20T08:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277033",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fd8c09c4be9334f4fd9af3225aa3a2898dd8366d" to "87597bde4c041766a26674a3a8be1d4b076180d5"



---

archive/issue_comments_277034.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-20T08:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277034",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277035.json:
```json
{
    "body": "<a id='comment:35'></a>You don't need this:\n\n```diff\ndiff --git a/src/sage/libs/flint/arith.pyx b/src/sage/libs/flint/arith.pyx\nindex 7280536..91caf32 100644\n--- a/src/sage/libs/flint/arith.pyx\n+++ b/src/sage/libs/flint/arith.pyx\n@@ -10,10 +10,23 @@ FLINT Arithmetic Functions\ninclude \"sage/ext/interrupt.pxi\"\n+cdef extern from \"flint/fmpq.h\":\n+ ctypedef void * fmpq_t\n+ void fmpq_init(fmpq_t)\n+ void fmpq_clear(fmpq_t)\n+ void fmpq_get_mpq(mpq_t, fmpq_t)\n+ void fmpq_set_mpq(fmpq_t, mpq_t)\n+\n+cdef extern from \"flint/arith.h\":\n+ void arith_number_of_partitions(fmpz_t x, unsigned long n)\n+ void arith_dedekind_sum(fmpq_t, fmpz_t, fmpz_t)\n+ void arith_harmonic_number(fmpq_t, unsigned long n)\n+\nfrom fmpz cimport *\nfrom fmpq cimport *\nfrom arith cimport *\n+\nfrom sage.rings.integer cimport Integer\nfrom sage.rings.rational cimport Rational\n```\n\nAdd the functions you need (only `arith_harmonic_number` in this case) to `src/sage/libs/flint/arith.pxd` instead.",
    "created_at": "2015-02-14T15:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277035",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>You don't need this:

```diff
diff --git a/src/sage/libs/flint/arith.pyx b/src/sage/libs/flint/arith.pyx
index 7280536..91caf32 100644
--- a/src/sage/libs/flint/arith.pyx
+++ b/src/sage/libs/flint/arith.pyx
@@ -10,10 +10,23 @@ FLINT Arithmetic Functions
include "sage/ext/interrupt.pxi"
+cdef extern from "flint/fmpq.h":
+ ctypedef void * fmpq_t
+ void fmpq_init(fmpq_t)
+ void fmpq_clear(fmpq_t)
+ void fmpq_get_mpq(mpq_t, fmpq_t)
+ void fmpq_set_mpq(fmpq_t, mpq_t)
+
+cdef extern from "flint/arith.h":
+ void arith_number_of_partitions(fmpz_t x, unsigned long n)
+ void arith_dedekind_sum(fmpq_t, fmpz_t, fmpz_t)
+ void arith_harmonic_number(fmpq_t, unsigned long n)
+
from fmpz cimport *
from fmpq cimport *
from arith cimport *
+
from sage.rings.integer cimport Integer
from sage.rings.rational cimport Rational
```

Add the functions you need (only `arith_harmonic_number` in this case) to `src/sage/libs/flint/arith.pxd` instead.



---

archive/issue_comments_277036.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-14T15:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277036",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277037.json:
```json
{
    "body": "Changing branch from \"u/rws/implement_harmonic_number_function_h_n_m_\" to \"u/rws/16671\"",
    "created_at": "2015-02-15T08:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277037",
    "user": "https://github.com/rwst"
}
```

Changing branch from "u/rws/implement_harmonic_number_function_h_n_m_" to "u/rws/16671"



---

archive/issue_comments_277038.json:
```json
{
    "body": "Changing commit from \"87597bde4c041766a26674a3a8be1d4b076180d5\" to \"c26cd0b047aef2446737587bd784e38851277ed4\"",
    "created_at": "2015-02-15T08:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277038",
    "user": "https://github.com/rwst"
}
```

Changing commit from "87597bde4c041766a26674a3a8be1d4b076180d5" to "c26cd0b047aef2446737587bd784e38851277ed4"



---

archive/issue_comments_277039.json:
```json
{
    "body": "<a id='comment:37'></a>Done. Squashed it all into one commit.\n  \n---\nNew commits:",
    "created_at": "2015-02-15T08:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277039",
    "user": "https://github.com/rwst"
}
```

<a id='comment:37'></a>Done. Squashed it all into one commit.
  
---
New commits:



---

archive/issue_comments_277040.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-15T08:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277040",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277041.json:
```json
{
    "body": "<a id='comment:38'></a>In `flint/arith.pyx`, you're missing actual examples.",
    "created_at": "2015-02-15T12:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277041",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>In `flint/arith.pyx`, you're missing actual examples.



---

archive/issue_comments_277042.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-15T12:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277042",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277043.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-15T13:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277044.json:
```json
{
    "body": "Changing commit from \"c26cd0b047aef2446737587bd784e38851277ed4\" to \"3ec7fbba6b2c095ef2aa38cec5ffc47c9ba0cae6\"",
    "created_at": "2015-02-15T13:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277044",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c26cd0b047aef2446737587bd784e38851277ed4" to "3ec7fbba6b2c095ef2aa38cec5ffc47c9ba0cae6"



---

archive/issue_comments_277045.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-15T13:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277045",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277046.json:
```json
{
    "body": "<a id='comment:40'></a>Indeed.",
    "created_at": "2015-02-15T13:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277046",
    "user": "https://github.com/rwst"
}
```

<a id='comment:40'></a>Indeed.



---

archive/issue_comments_277047.json:
```json
{
    "body": "<a id='comment:41'></a>In `__call__`, why mess with `len(args)`? Why not simply something like\n\n```\ndef __call__(self, z, m=1, **kwds):\n    return BuiltinFunction.__call__(self, z, m, **kwds)\n```",
    "created_at": "2015-02-16T09:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277047",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>In `__call__`, why mess with `len(args)`? Why not simply something like

```
def __call__(self, z, m=1, **kwds):
    return BuiltinFunction.__call__(self, z, m, **kwds)
```



---

archive/issue_comments_277048.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-16T09:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277049.json:
```json
{
    "body": "Changing commit from \"3ec7fbba6b2c095ef2aa38cec5ffc47c9ba0cae6\" to \"fabf86397adf8c07ce9b63b64c64e5f724702d21\"",
    "created_at": "2015-02-16T09:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277049",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3ec7fbba6b2c095ef2aa38cec5ffc47c9ba0cae6" to "fabf86397adf8c07ce9b63b64c64e5f724702d21"



---

archive/issue_comments_277050.json:
```json
{
    "body": "<a id='comment:43'></a>What's with the condition `elif z < 2**20:`??",
    "created_at": "2015-02-16T09:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277050",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>What's with the condition `elif z < 2**20:`??



---

archive/issue_comments_277051.json:
```json
{
    "body": "<a id='comment:44'></a>In `flint/arith.pyx`, you should add\n\n```diff\n+sig_on()\n arith_harmonic_number(s_fmpq, n)\n\n fmpq_get_mpq((<Rational>s).value, s_fmpq)\n+sig_off()\n```",
    "created_at": "2015-02-16T09:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277051",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>In `flint/arith.pyx`, you should add

```diff
+sig_on()
 arith_harmonic_number(s_fmpq, n)

 fmpq_get_mpq((<Rational>s).value, s_fmpq)
+sig_off()
```



---

archive/issue_comments_277052.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-16T09:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277052",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277053.json:
```json
{
    "body": "<a id='comment:46'></a>Why doesn't this work?\n\n```\nsage: harmonic_number(x).diff(x)\nD[0]harmonic_number(x)\n```",
    "created_at": "2015-02-16T09:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277053",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>Why doesn't this work?

```
sage: harmonic_number(x).diff(x)
D[0]harmonic_number(x)
```



---

archive/issue_comments_277054.json:
```json
{
    "body": "<a id='comment:47'></a>I don't agree with `sum(QQ(1)/(k**m) for k in range(1,z+1))` since the result is always in `QQ`. I would use `srange` to respect the input type (`foo in ZZ` does not imply that the type of `foo` is `ZZ`):\n\n```\nsum(1/(k**m) for k in srange(1,z+1))\n```\n\nArtificial example (this could be a doctest):\n\n```\nsage: harmonic_number._eval_(10, Qp(5)(1))\n7381/2520\n```\nbut the answer should be\n\n```\nsage: Qp(5)(harmonic_number(10))\n4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + 4*5^5 + 4*5^6 + 5^7 + 4*5^8 + 3*5^9 + 5^10 + 4*5^11 + 4*5^12 + 5^13 + 4*5^14 + 3*5^15 + 5^16 + 4*5^17 + 4*5^18 + O(5^19)\n```",
    "created_at": "2015-02-16T09:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277054",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>I don't agree with `sum(QQ(1)/(k**m) for k in range(1,z+1))` since the result is always in `QQ`. I would use `srange` to respect the input type (`foo in ZZ` does not imply that the type of `foo` is `ZZ`):

```
sum(1/(k**m) for k in srange(1,z+1))
```

Artificial example (this could be a doctest):

```
sage: harmonic_number._eval_(10, Qp(5)(1))
7381/2520
```
but the answer should be

```
sage: Qp(5)(harmonic_number(10))
4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + 4*5^5 + 4*5^6 + 5^7 + 4*5^8 + 3*5^9 + 5^10 + 4*5^11 + 4*5^12 + 5^13 + 4*5^14 + 3*5^15 + 5^16 + 4*5^17 + 4*5^18 + O(5^19)
```



---

archive/issue_comments_277055.json:
```json
{
    "body": "<a id='comment:48'></a>Also please fix `\\ No newline at end of file`",
    "created_at": "2015-02-16T09:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277055",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>Also please fix `\ No newline at end of file`



---

archive/issue_comments_277056.json:
```json
{
    "body": "<a id='comment:49'></a>I don't know what `SR('x')` does, but I think it's better to use `SR.var('x')` instead.",
    "created_at": "2015-02-16T09:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277056",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:49'></a>I don't know what `SR('x')` does, but I think it's better to use `SR.var('x')` instead.



---

archive/issue_comments_277057.json:
```json
{
    "body": "<a id='comment:50'></a>Same comment as above: are you sure you want `elif z in QQ:` and not `elif isinstance(z, Rational)`?",
    "created_at": "2015-02-16T09:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277057",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>Same comment as above: are you sure you want `elif z in QQ:` and not `elif isinstance(z, Rational)`?



---

archive/issue_comments_277058.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:50 jdemeyer]:\n> Same comment as above: are you sure you want `elif z in QQ:` and not `elif isinstance(z, Rational)`?\n\nBTW I would think this `if var in ZZ/QQ` appears more often throughout the Sage code. Is there a manual page that deals with this?",
    "created_at": "2015-02-16T10:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277058",
    "user": "https://github.com/rwst"
}
```

<a id='comment:51'></a>Replying to [comment:50 jdemeyer]:
> Same comment as above: are you sure you want `elif z in QQ:` and not `elif isinstance(z, Rational)`?

BTW I would think this `if var in ZZ/QQ` appears more often throughout the Sage code. Is there a manual page that deals with this?



---

archive/issue_comments_277059.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:51 rws]:\n> BTW I would think this `if var in ZZ/QQ` appears more often throughout the Sage code.\n\nPerhaps, but it's not always wrong. It just depends on what you want to do with it.",
    "created_at": "2015-02-16T10:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277059",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>Replying to [comment:51 rws]:
> BTW I would think this `if var in ZZ/QQ` appears more often throughout the Sage code.

Perhaps, but it's not always wrong. It just depends on what you want to do with it.



---

archive/issue_comments_277060.json:
```json
{
    "body": "<a id='comment:53'></a>The general rule for functions should be: whenever the answer is non-symbolic, the answer should have a parent which \"matches\" the parent of the input.",
    "created_at": "2015-02-16T11:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277060",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>The general rule for functions should be: whenever the answer is non-symbolic, the answer should have a parent which "matches" the parent of the input.



---

archive/issue_comments_277061.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:47 jdemeyer]:\n> Artificial example (this could be a doctest):\n> \n> ```\n> sage: harmonic_number._eval_(10, Qp(5)(1))\n> 7381/2520\n> ```\n> but the answer should be\n> \n> ```\n> sage: Qp(5)(harmonic_number(10))\n> 4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + 4*5^5 + 4*5^6 + 5^7 + 4*5^8 + 3*5^9 + 5^10 + 4*5^11 + 4*5^12 + 5^13 + 4*5^14 + 3*5^15 + 5^16 + 4*5^17 + 4*5^18 + O(5^19)\n> ```\n\nI think this is the only example where `H(n,m)` would have a useful meaning, and it can be computed, as you show, by staying in the rationals and converting the result. Trying to support this case however will fail in `BuiltinFunction.__call__`:\n\n```\nsage: harmonic_number(5,Qp(5)(8))\nTraceback (most recent call last):\n  File \"<ipython-input-9-03dbaa59749c>\", line 1, in <module>\n    harmonic_number(Integer(5),Qp(Integer(5))(Integer(8)))\n  File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/log.py\", line 886, in __call__\n    return BuiltinFunction.__call__(self, z, m, **kwds)\n  File \"sage/symbolic/function.pyx\", line 993, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:10572)\n    res = super(BuiltinFunction, self).__call__(\n  File \"sage/symbolic/function.pyx\", line 487, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6301)\n    raise TypeError, \"cannot coerce arguments: %s\"%(err)\nTypeError: cannot coerce arguments: no canonical coercion from 5-adic Field with capped relative precision 20 to Symbolic Ring\n```",
    "created_at": "2015-02-16T14:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277061",
    "user": "https://github.com/rwst"
}
```

<a id='comment:54'></a>Replying to [comment:47 jdemeyer]:
> Artificial example (this could be a doctest):
> 
> ```
> sage: harmonic_number._eval_(10, Qp(5)(1))
> 7381/2520
> ```
> but the answer should be
> 
> ```
> sage: Qp(5)(harmonic_number(10))
> 4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + 4*5^5 + 4*5^6 + 5^7 + 4*5^8 + 3*5^9 + 5^10 + 4*5^11 + 4*5^12 + 5^13 + 4*5^14 + 3*5^15 + 5^16 + 4*5^17 + 4*5^18 + O(5^19)
> ```

I think this is the only example where `H(n,m)` would have a useful meaning, and it can be computed, as you show, by staying in the rationals and converting the result. Trying to support this case however will fail in `BuiltinFunction.__call__`:

```
sage: harmonic_number(5,Qp(5)(8))
Traceback (most recent call last):
  File "<ipython-input-9-03dbaa59749c>", line 1, in <module>
    harmonic_number(Integer(5),Qp(Integer(5))(Integer(8)))
  File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/log.py", line 886, in __call__
    return BuiltinFunction.__call__(self, z, m, **kwds)
  File "sage/symbolic/function.pyx", line 993, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:10572)
    res = super(BuiltinFunction, self).__call__(
  File "sage/symbolic/function.pyx", line 487, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6301)
    raise TypeError, "cannot coerce arguments: %s"%(err)
TypeError: cannot coerce arguments: no canonical coercion from 5-adic Field with capped relative precision 20 to Symbolic Ring
```



---

archive/issue_comments_277062.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:54 rws]:\n> it can be computed, as you show, by staying in the rationals and converting the result.\n\nBut that wouldn't be the optimal way to compute it. I think it's easy to make the formula work for arbitrary types.\n\n> Trying to support this case however will fail in `BuiltinFunction.__call__`:\n\nI know, but that doesn't mean we shouldn't adapt `_eval_`.",
    "created_at": "2015-02-16T15:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277062",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>Replying to [comment:54 rws]:
> it can be computed, as you show, by staying in the rationals and converting the result.

But that wouldn't be the optimal way to compute it. I think it's easy to make the formula work for arbitrary types.

> Trying to support this case however will fail in `BuiltinFunction.__call__`:

I know, but that doesn't mean we shouldn't adapt `_eval_`.



---

archive/issue_comments_277063.json:
```json
{
    "body": "Changing commit from \"fabf86397adf8c07ce9b63b64c64e5f724702d21\" to \"309660a11c0929f223087f5f208a2ea8f14e7625\"",
    "created_at": "2015-02-16T16:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fabf86397adf8c07ce9b63b64c64e5f724702d21" to "309660a11c0929f223087f5f208a2ea8f14e7625"



---

archive/issue_comments_277064.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-16T16:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277065.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-16T16:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277065",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277066.json:
```json
{
    "body": "<a id='comment:57'></a>> > Trying to support this case however will fail in `BuiltinFunction.__call__`:\n\n> I know, but that doesn't mean we shouldn't adapt `_eval_`.\nThat means it will be fixed elsewhere?",
    "created_at": "2015-02-16T16:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277066",
    "user": "https://github.com/rwst"
}
```

<a id='comment:57'></a>> > Trying to support this case however will fail in `BuiltinFunction.__call__`:

> I know, but that doesn't mean we shouldn't adapt `_eval_`.
That means it will be fixed elsewhere?



---

archive/issue_comments_277067.json:
```json
{
    "body": "<a id='comment:58'></a>I still don't understand the point of this:\n\n```\nIf the argument is an integer greater than `2^20` no rational\nevaluation is done, in order to allow for high-precision floating\npoint computation using `.n()`\n```",
    "created_at": "2015-02-16T17:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277067",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>I still don't understand the point of this:

```
If the argument is an integer greater than `2^20` no rational
evaluation is done, in order to allow for high-precision floating
point computation using `.n()`
```



---

archive/issue_comments_277068.json:
```json
{
    "body": "<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-17T06:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277069.json:
```json
{
    "body": "Changing commit from \"309660a11c0929f223087f5f208a2ea8f14e7625\" to \"ca696281c6d2425b72d72b6408e4a787b32d637a\"",
    "created_at": "2015-02-17T06:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "309660a11c0929f223087f5f208a2ea8f14e7625" to "ca696281c6d2425b72d72b6408e4a787b32d637a"



---

archive/issue_comments_277070.json:
```json
{
    "body": "<a id='comment:60'></a>Replying to [comment:58 jdemeyer]:\n> I still don't understand the point of this:\n\nOK, me neither. Presumably I had a memory error at the time ...",
    "created_at": "2015-02-17T06:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277070",
    "user": "https://github.com/rwst"
}
```

<a id='comment:60'></a>Replying to [comment:58 jdemeyer]:
> I still don't understand the point of this:

OK, me neither. Presumably I had a memory error at the time ...



---

archive/issue_comments_277071.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#17790\"",
    "created_at": "2015-02-17T06:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277071",
    "user": "https://github.com/rwst"
}
```

Changing dependencies from "" to "#17790"



---

archive/issue_comments_277072.json:
```json
{
    "body": "<a id='comment:61'></a>Replying to [comment:57 rws]:\n> > > Trying to support this case however will fail in `BuiltinFunction.__call__`:\n\n> > I know, but that doesn't mean we shouldn't adapt `_eval_`.\n> That means it will be fixed elsewhere?\n\nSee #17790",
    "created_at": "2015-02-17T06:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277072",
    "user": "https://github.com/rwst"
}
```

<a id='comment:61'></a>Replying to [comment:57 rws]:
> > > Trying to support this case however will fail in `BuiltinFunction.__call__`:

> > I know, but that doesn't mean we shouldn't adapt `_eval_`.
> That means it will be fixed elsewhere?

See #17790



---

archive/issue_comments_277073.json:
```json
{
    "body": "Changing work_issues from \"\" to \"merge fix for #17790\"",
    "created_at": "2015-03-05T08:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277073",
    "user": "https://github.com/rwst"
}
```

Changing work_issues from "" to "merge fix for #17790"



---

archive/issue_comments_277074.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-05T08:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277074",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277075.json:
```json
{
    "body": "<a id='comment:63'></a>Let's document here that both forms for the generalized harmonic numbers\n\n```\nH(q/p,m) = zeta(m) - p^m * sum(1/(q+p*k)^m, k, 1, oo)   (Wikipedia 2015-Mar-07)\n\nH(k,n) = binomial(n+k-1,k-1)*(harmonic_number(n+k-1)-harmonic_number(k-1))\n         (http://mathworld.wolfram.com/HarmonicNumber.html eq. 55)\n```\nare both wrong, with the counterexamples `H(5/2,3)=1/27*sqrt(3) + 1/8*sqrt(2) + 1` and `H(5,3)=256103/216000`.\n\nEDIT. no, the first is right, my implementation was wrong.",
    "created_at": "2015-03-07T08:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277075",
    "user": "https://github.com/rwst"
}
```

<a id='comment:63'></a>Let's document here that both forms for the generalized harmonic numbers

```
H(q/p,m) = zeta(m) - p^m * sum(1/(q+p*k)^m, k, 1, oo)   (Wikipedia 2015-Mar-07)

H(k,n) = binomial(n+k-1,k-1)*(harmonic_number(n+k-1)-harmonic_number(k-1))
         (http://mathworld.wolfram.com/HarmonicNumber.html eq. 55)
```
are both wrong, with the counterexamples `H(5/2,3)=1/27*sqrt(3) + 1/8*sqrt(2) + 1` and `H(5,3)=256103/216000`.

EDIT. no, the first is right, my implementation was wrong.



---

archive/issue_comments_277076.json:
```json
{
    "body": "<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-07T09:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277077.json:
```json
{
    "body": "Changing commit from \"ca696281c6d2425b72d72b6408e4a787b32d637a\" to \"d60311eda7cce822b74480550498da09b34b7a63\"",
    "created_at": "2015-03-07T09:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277077",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ca696281c6d2425b72d72b6408e4a787b32d637a" to "d60311eda7cce822b74480550498da09b34b7a63"



---

archive/issue_comments_277078.json:
```json
{
    "body": "<a id='comment:65'></a>Replying to [comment:47 jdemeyer]:\n> {{{\n> sage: harmonic_number._eval_(10, Qp(5)(1))\n> 7381/2520\n> }}}\n> but the answer should be\n> \n> ```\n> sage: Qp(5)(harmonic_number(10))\n> ```\nDisagree. That should be the result of `harmonic_number._eval_(Qp(5)(10), 1)`. Anything else than a rational as second argument makes no sense.\n\nI have now adapted the code so it gives back the same type as the input, but wrapped as `Expression`. Also, you can expect that only if it can be converted back, which is not the case for `H(p/q)` or `H(anything, p/q)` as the result is not rational.",
    "created_at": "2015-03-07T09:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277078",
    "user": "https://github.com/rwst"
}
```

<a id='comment:65'></a>Replying to [comment:47 jdemeyer]:
> {{{
> sage: harmonic_number._eval_(10, Qp(5)(1))
> 7381/2520
> }}}
> but the answer should be
> 
> ```
> sage: Qp(5)(harmonic_number(10))
> ```
Disagree. That should be the result of `harmonic_number._eval_(Qp(5)(10), 1)`. Anything else than a rational as second argument makes no sense.

I have now adapted the code so it gives back the same type as the input, but wrapped as `Expression`. Also, you can expect that only if it can be converted back, which is not the case for `H(p/q)` or `H(anything, p/q)` as the result is not rational.



---

archive/issue_comments_277079.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-07T09:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277079",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277080.json:
```json
{
    "body": "Changing work_issues from \"merge fix for #17790\" to \"\"",
    "created_at": "2015-03-07T09:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277080",
    "user": "https://github.com/rwst"
}
```

Changing work_issues from "merge fix for #17790" to ""



---

archive/issue_events_048866.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-03-07T09:31:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48866"
}
```



---

archive/issue_events_048867.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-03-07T09:31:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48867"
}
```



---

archive/issue_events_048868.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-06-11T07:32:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48868"
}
```



---

archive/issue_events_048869.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-06-11T07:32:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48869"
}
```



---

archive/issue_comments_277081.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-29T11:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277081",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277082.json:
```json
{
    "body": "<a id='comment:68'></a>\n```\nsage -t src/sage/symbolic/function.pyx\n**********************************************************************\nFile \"src/sage/symbolic/function.pyx\", line 394, in sage.symbolic.function.Function.__call__\nFailed example:\n    binomial(Qp(2)(9),5)\nException raised:\n    Traceback (most recent call last):\n      File \"/local/dakrenn/sage/6.9/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/local/dakrenn/sage/6.9/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.function.Function.__call__[20]>\", line 1, in <module>\n        binomial(Qp(Integer(2))(Integer(9)),Integer(5))\n      File \"sage/symbolic/function.pyx\", line 851, in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9858)\n        res = super(GinacFunction, self).__call__(*args, **kwds)\n      File \"sage/symbolic/function.pyx\", line 998, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:11421)\n        res = super(BuiltinFunction, self).__call__(\n      File \"sage/symbolic/function.pyx\", line 511, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7288)\n        res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,\n      File \"sage/symbolic/pynac.pyx\", line 187, in sage.symbolic.pynac.pyExpression_to_ex (build/cythonized/sage/symbolic/pynac.cpp:4108)\n        raise TypeError(\"function did not return a symbolic expression or an element that can be coerced into a symbolic expression\")\n    TypeError: function did not return a symbolic expression or an element that can be coerced into a symbolic expression\n```",
    "created_at": "2015-11-29T11:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277082",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:68'></a>
```
sage -t src/sage/symbolic/function.pyx
**********************************************************************
File "src/sage/symbolic/function.pyx", line 394, in sage.symbolic.function.Function.__call__
Failed example:
    binomial(Qp(2)(9),5)
Exception raised:
    Traceback (most recent call last):
      File "/local/dakrenn/sage/6.9/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/dakrenn/sage/6.9/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.function.Function.__call__[20]>", line 1, in <module>
        binomial(Qp(Integer(2))(Integer(9)),Integer(5))
      File "sage/symbolic/function.pyx", line 851, in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9858)
        res = super(GinacFunction, self).__call__(*args, **kwds)
      File "sage/symbolic/function.pyx", line 998, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:11421)
        res = super(BuiltinFunction, self).__call__(
      File "sage/symbolic/function.pyx", line 511, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7288)
        res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
      File "sage/symbolic/pynac.pyx", line 187, in sage.symbolic.pynac.pyExpression_to_ex (build/cythonized/sage/symbolic/pynac.cpp:4108)
        raise TypeError("function did not return a symbolic expression or an element that can be coerced into a symbolic expression")
    TypeError: function did not return a symbolic expression or an element that can be coerced into a symbolic expression
```



---

archive/issue_comments_277083.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-29T13:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277083",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277084.json:
```json
{
    "body": "<a id='comment:69'></a>Yes, this is because of #17790, and for that reason this ticket is pending (but needs review for everything else).",
    "created_at": "2015-11-29T13:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277084",
    "user": "https://github.com/rwst"
}
```

<a id='comment:69'></a>Yes, this is because of #17790, and for that reason this ticket is pending (but needs review for everything else).



---

archive/issue_comments_277085.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-14T05:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277085",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277086.json:
```json
{
    "body": "Changing branch from \"u/rws/16671\" to \"u/arminstraub/ticket/16671/harmonic_numbers\"",
    "created_at": "2016-08-17T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277086",
    "user": "https://github.com/arminstraub"
}
```

Changing branch from "u/rws/16671" to "u/arminstraub/ticket/16671/harmonic_numbers"



---

archive/issue_comments_277087.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-17T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277087",
    "user": "https://github.com/arminstraub"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_048870.json:
```json
{
    "actor": "https://github.com/arminstraub",
    "created_at": "2016-08-17T22:33:37Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48870"
}
```



---

archive/issue_events_048871.json:
```json
{
    "actor": "https://github.com/arminstraub",
    "created_at": "2016-08-17T22:33:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48871"
}
```



---

archive/issue_comments_277088.json:
```json
{
    "body": "<a id='comment:71'></a>I have merged the code with the current codebase and simplified `Function_harmonic_number_generalized._eval_` and ` Function_harmonic_number._eval_` (please check that I didn't oversimplify).\n\nWhen merging the code into the current codebase, there was the following conflict in `symbolic/function.pyx`:\n\n```\n<<<<<<< HEAD\n=======\n                # There is no natural coercion from QQbar to the symbolic ring\n                # in order to support\n                #     sage: QQbar(sqrt(2)) + sqrt(3)\n                #     3.146264369941973?\n                # to work around this limitation, we manually convert\n                # elements of QQbar to symbolic expressions here\n                from sage.rings.qqbar import QQbar, AA\n                from sage.rings.padics.padic_generic_element import pAdicGenericElement\n                nargs = [None]*len(args)\n                for i in range(len(args)):\n                    carg = args[i]\n                    if (isinstance(carg, Element) and\n                            ((<Element>carg)._parent is QQbar or\n                            (<Element>carg)._parent is AA or\n                            isinstance(carg, pAdicGenericElement))):\n                        nargs[i] = SR(carg)\n                    else:\n                        try:\n                            nargs[i] = SR.coerce(carg)\n                        except Exception:\n                            raise TypeError, \"cannot coerce arguments: %s\"%(err)\n                args = nargs\n>>>>>>> FETCH_HEAD\n```\nIt was unclear to me to which degree the underlying code had changed, which is why this code for working with `QQbar` over the symbolic ring is not merged into the branch I posted.\n\nIn any case, it seems to me that any such change might be better suited for a separate ticket because it is not specific to harmonic numbers.  Consequently, I also removed from `symbolic/function.pyx` the doctest\n\n```\n            sage: binomial(Qp(2)(9),5)\n            126\n```\nas well as from `functions/log.py` the doctests:\n\n```\n            sage: harmonic_number(Qp(5)(10),1)\n            4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + ...\n            sage: harmonic_number(Qp(5)(10),2)\n            4*5^-1 + 3 + 5 + 3*5^2 + 2*5^3 + 3*5^5 + ...\n...\n            sage: harmonic_number(Qp(5)(3))\n            1 + 5 + 4*5^2 + 4*5^4 + 4*5^6 + ...\n```\nI think that a separate ticket should be used for uniformly fixing the coercion/conversion of p-adics to the symbolic ring.  Since the present code doesn't touch these issues, I have removed the dependency on #17790.\n\nBy the way, I liked the symbolic sum you were using for computing `harmonic_number(n)` when `n` is a rational number.  While testing this, I noticed that `sum(1/x/(1/5+x),x,1,infinity)` results in an error.  On the other hand, using the present code, we have:\n\n```\nsage: harmonic_number(1/5)\neuler_gamma + psi(6/5)\nsage: _.full_simplify()\n-1/4*(sqrt(5) + 1)*log(1/2*sqrt(5) + 5/2) + 1/4*(sqrt(5) - 1)*log(-1/2*sqrt(5) + 5/2) - 1/10*pi*sqrt(10*sqrt(5) + 25) - log(5) + 5\n```\n\nThe only other changes I made were small touches to the doc strings.  A quick `sage -t src/sage/functions` did not reveal any troubles.\n\nThank you for the nice work!  It would be great to finally have harmonic numbers in Sage.",
    "created_at": "2016-08-17T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277088",
    "user": "https://github.com/arminstraub"
}
```

<a id='comment:71'></a>I have merged the code with the current codebase and simplified `Function_harmonic_number_generalized._eval_` and ` Function_harmonic_number._eval_` (please check that I didn't oversimplify).

When merging the code into the current codebase, there was the following conflict in `symbolic/function.pyx`:

```
<<<<<<< HEAD
=======
                # There is no natural coercion from QQbar to the symbolic ring
                # in order to support
                #     sage: QQbar(sqrt(2)) + sqrt(3)
                #     3.146264369941973?
                # to work around this limitation, we manually convert
                # elements of QQbar to symbolic expressions here
                from sage.rings.qqbar import QQbar, AA
                from sage.rings.padics.padic_generic_element import pAdicGenericElement
                nargs = [None]*len(args)
                for i in range(len(args)):
                    carg = args[i]
                    if (isinstance(carg, Element) and
                            ((<Element>carg)._parent is QQbar or
                            (<Element>carg)._parent is AA or
                            isinstance(carg, pAdicGenericElement))):
                        nargs[i] = SR(carg)
                    else:
                        try:
                            nargs[i] = SR.coerce(carg)
                        except Exception:
                            raise TypeError, "cannot coerce arguments: %s"%(err)
                args = nargs
>>>>>>> FETCH_HEAD
```
It was unclear to me to which degree the underlying code had changed, which is why this code for working with `QQbar` over the symbolic ring is not merged into the branch I posted.

In any case, it seems to me that any such change might be better suited for a separate ticket because it is not specific to harmonic numbers.  Consequently, I also removed from `symbolic/function.pyx` the doctest

```
            sage: binomial(Qp(2)(9),5)
            126
```
as well as from `functions/log.py` the doctests:

```
            sage: harmonic_number(Qp(5)(10),1)
            4*5^-1 + 2 + 2*5 + 4*5^2 + 3*5^3 + 5^4 + ...
            sage: harmonic_number(Qp(5)(10),2)
            4*5^-1 + 3 + 5 + 3*5^2 + 2*5^3 + 3*5^5 + ...
...
            sage: harmonic_number(Qp(5)(3))
            1 + 5 + 4*5^2 + 4*5^4 + 4*5^6 + ...
```
I think that a separate ticket should be used for uniformly fixing the coercion/conversion of p-adics to the symbolic ring.  Since the present code doesn't touch these issues, I have removed the dependency on #17790.

By the way, I liked the symbolic sum you were using for computing `harmonic_number(n)` when `n` is a rational number.  While testing this, I noticed that `sum(1/x/(1/5+x),x,1,infinity)` results in an error.  On the other hand, using the present code, we have:

```
sage: harmonic_number(1/5)
euler_gamma + psi(6/5)
sage: _.full_simplify()
-1/4*(sqrt(5) + 1)*log(1/2*sqrt(5) + 5/2) + 1/4*(sqrt(5) - 1)*log(-1/2*sqrt(5) + 5/2) - 1/10*pi*sqrt(10*sqrt(5) + 25) - log(5) + 5
```

The only other changes I made were small touches to the doc strings.  A quick `sage -t src/sage/functions` did not reveal any troubles.

Thank you for the nice work!  It would be great to finally have harmonic numbers in Sage.



---

archive/issue_comments_277089.json:
```json
{
    "body": "Changing commit from \"d60311eda7cce822b74480550498da09b34b7a63\" to \"9042104196f2d3b9822b3827aa2bbd70097f7b95\"",
    "created_at": "2016-08-17T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277089",
    "user": "https://github.com/arminstraub"
}
```

Changing commit from "d60311eda7cce822b74480550498da09b34b7a63" to "9042104196f2d3b9822b3827aa2bbd70097f7b95"



---

archive/issue_comments_277090.json:
```json
{
    "body": "Changing dependencies from \"#17790\" to \"\"",
    "created_at": "2016-08-17T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277090",
    "user": "https://github.com/arminstraub"
}
```

Changing dependencies from "#17790" to ""



---

archive/issue_comments_277091.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ralf Stephan\"",
    "created_at": "2016-08-18T06:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277091",
    "user": "https://github.com/rwst"
}
```

Changing reviewer from "" to "Ralf Stephan"



---

archive/issue_comments_277092.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-18T06:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277092",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_277093.json:
```json
{
    "body": "<a id='comment:72'></a>I agree with your changes, especially the removal of the dependency on #17790, this specialty is stuff for another ticket. I'm assuming you reviewed my code, so I set positive now, after more extensive tests pass here.\n\nPlease add your name in the Author and Reviewer fields. Thanks.",
    "created_at": "2016-08-18T06:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277093",
    "user": "https://github.com/rwst"
}
```

<a id='comment:72'></a>I agree with your changes, especially the removal of the dependency on #17790, this specialty is stuff for another ticket. I'm assuming you reviewed my code, so I set positive now, after more extensive tests pass here.

Please add your name in the Author and Reviewer fields. Thanks.



---

archive/issue_comments_277094.json:
```json
{
    "body": "Changing author from \"Ralf Stephan\" to \"Ralf Stephan, Armin Straub\"",
    "created_at": "2016-08-18T10:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277094",
    "user": "https://github.com/arminstraub"
}
```

Changing author from "Ralf Stephan" to "Ralf Stephan, Armin Straub"



---

archive/issue_comments_277095.json:
```json
{
    "body": "<a id='comment:73'></a>Thanks for checking!\n\nYes, I did also review your code.  I don't know enough about maxima and the intricacies of interfacing it, but it is my understanding that that part of the code was checked by you and Nils, and I didn't run into any additional trouble.",
    "created_at": "2016-08-18T10:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277095",
    "user": "https://github.com/arminstraub"
}
```

<a id='comment:73'></a>Thanks for checking!

Yes, I did also review your code.  I don't know enough about maxima and the intricacies of interfacing it, but it is my understanding that that part of the code was checked by you and Nils, and I didn't run into any additional trouble.



---

archive/issue_comments_277096.json:
```json
{
    "body": "Changing reviewer from \"Ralf Stephan\" to \"Ralf Stephan, Armin Straub\"",
    "created_at": "2016-08-18T10:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277096",
    "user": "https://github.com/arminstraub"
}
```

Changing reviewer from "Ralf Stephan" to "Ralf Stephan, Armin Straub"



---

archive/issue_comments_277097.json:
```json
{
    "body": "<a id='comment:74'></a>The patchbot complains about `_swap_harmonic` not having a doctest.  Do we need to add one despite the underscore in the name?\n\nAlso, the bot indicates an issue with startup_modules, but I couldn't make sense of it...",
    "created_at": "2016-08-19T21:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277097",
    "user": "https://github.com/arminstraub"
}
```

<a id='comment:74'></a>The patchbot complains about `_swap_harmonic` not having a doctest.  Do we need to add one despite the underscore in the name?

Also, the bot indicates an issue with startup_modules, but I couldn't make sense of it...



---

archive/issue_comments_277098.json:
```json
{
    "body": "<a id='comment:75'></a>I would ignore both but let's wait for the release manager.",
    "created_at": "2016-08-20T06:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277098",
    "user": "https://github.com/rwst"
}
```

<a id='comment:75'></a>I would ignore both but let's wait for the release manager.



---

archive/issue_comments_277099.json:
```json
{
    "body": "Changing branch from \"u/arminstraub/ticket/16671/harmonic_numbers\" to \"9042104196f2d3b9822b3827aa2bbd70097f7b95\"",
    "created_at": "2016-08-21T13:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277099",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/arminstraub/ticket/16671/harmonic_numbers" to "9042104196f2d3b9822b3827aa2bbd70097f7b95"



---

archive/issue_events_048872.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-21T13:14:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16671#event-48872"
}
```



---

archive/issue_comments_277100.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-21T13:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16671#issuecomment-277100",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
