# Issue 16879: OA caching in C

archive/issues_016642.json:
```json
{
    "body": "CC:  @videlec\n\nCaching of OA constructions in C. Less space, and a bit faster.\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/16879\n\n",
    "closed_at": "2014-09-06T11:02:27Z",
    "created_at": "2014-08-25T15:17:32Z",
    "labels": [
        "component: combinatorial designs"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "OA caching in C",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16879",
    "user": "https://github.com/nathanncohen"
}
```
CC:  @videlec

Caching of OA constructions in C. Less space, and a bit faster.

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/16879





---

archive/issue_comments_219190.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-25T15:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219190",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_219191.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-08-25T15:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_219192.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-08-25T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219192",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_219193.json:
```json
{
    "body": "Hello,\n\nThe cache part is cool!\n\nI am not confident of having everything switched into Cython. It is much harder to debug and can also makes things slower. Especially with functions like `wilson_construction`, `OA_n_times_2_pow_c_from_matrix`... Why not only switch to C for the cache part? The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.\n\nIn the function `orthogonal_array`, I do not remember what was the point of the variable `may_be_availale` in `orthogonal_arrays`... And I am confused by the way it is used: if it is `False` then there is no need to go further (but it concerns only the case when `existence=False`).\n\nVincent",
    "created_at": "2014-08-25T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219193",
    "user": "https://github.com/videlec"
}
```

Hello,

The cache part is cool!

I am not confident of having everything switched into Cython. It is much harder to debug and can also makes things slower. Especially with functions like `wilson_construction`, `OA_n_times_2_pow_c_from_matrix`... Why not only switch to C for the cache part? The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.

In the function `orthogonal_array`, I do not remember what was the point of the variable `may_be_availale` in `orthogonal_arrays`... And I am confused by the way it is used: if it is `False` then there is no need to go further (but it concerns only the case when `existence=False`).

Vincent



---

archive/issue_comments_219194.json:
```json
{
    "body": "Yo !\n\n> The cache part is cool!\n\n\nYep.\n\n> I am not confident of having everything switched into Cython.\n\n\nI don't like it either. And it takes a lifetime to compile.\n\n> It is much harder to debug and can also makes things slower.\n\n\nReally ? Do you have an example ? `O_o`\n\n> Why not only switch to C for the cache part?\n\n\nWell, I can't cimport a cdef function in a .py file, but perhaps that does not matter. I will move th caching code to designs_pyx.\n\n> The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.\n\n\nI am thinking about that. What is the difference between this `orthogonal_array_available` and the current `orthogonal_array` ? I don't talk about the user interface, just about speed. When the answer is cached (most frequent case), what is it that `orthogonal_array_is_available` does that `orthogonal_array` does not ? Only check that `k is not None` ?\n\n> In the function `orthogonal_array`, I do not remember what was the point of the variable `may_be_availale` in `orthogonal_arrays`... And I am confused by the way it is used: if it is `False` then there is no need to go further (but it concerns only the case when `existence=False`).\n\n\nNo need to go further to test constructions. But there may be non-existence proofs implemented. That was the logic.\n\nNathann",
    "created_at": "2014-08-25T15:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219194",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> The cache part is cool!


Yep.

> I am not confident of having everything switched into Cython.


I don't like it either. And it takes a lifetime to compile.

> It is much harder to debug and can also makes things slower.


Really ? Do you have an example ? `O_o`

> Why not only switch to C for the cache part?


Well, I can't cimport a cdef function in a .py file, but perhaps that does not matter. I will move th caching code to designs_pyx.

> The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.


I am thinking about that. What is the difference between this `orthogonal_array_available` and the current `orthogonal_array` ? I don't talk about the user interface, just about speed. When the answer is cached (most frequent case), what is it that `orthogonal_array_is_available` does that `orthogonal_array` does not ? Only check that `k is not None` ?

> In the function `orthogonal_array`, I do not remember what was the point of the variable `may_be_availale` in `orthogonal_arrays`... And I am confused by the way it is used: if it is `False` then there is no need to go further (but it concerns only the case when `existence=False`).


No need to go further to test constructions. But there may be non-existence proofs implemented. That was the logic.

Nathann



---

archive/issue_comments_219195.json:
```json
{
    "body": "I just uploaded another branch at public/16879b. It moves the caching functions to designs_pyx instead.\n\nNathann",
    "created_at": "2014-08-25T16:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219195",
    "user": "https://github.com/nathanncohen"
}
```

I just uploaded another branch at public/16879b. It moves the caching functions to designs_pyx instead.

Nathann



---

archive/issue_comments_219196.json:
```json
{
    "body": "Replying to [comment:4 ncohen]:\n> Yo !\n> \n> > I am not confident of having everything switched into Cython.\n\n> \n> I don't like it either. And it takes a lifetime to compile.\n> \n> > It is much harder to debug and can also makes things slower.\n\n> \n> Really ? Do you have an example ? `O_o`\n\n\nAlmost anything:\n\n```\ndef f():\n    from sage.rings.arith import is_prime\n    from sage.quadratic_forms.extras import is_triangular_number\n\n    for i in range(2,1000):\n        is_prime(i)\n        is_triangular_number(i)\n```\nthen I got\n\n```\nsage: timeit(\"f_python()\", number=100)\n100 loops, best of 3: 12.7 ms per loop\nsage: timeit(\"f_cython()\", number=100)\n100 loops, best of 3: 12.9 ms per loop\n```\nNot very significant, but still.\n\n> > Why not only switch to C for the cache part?\n\n> \n> Well, I can't cimport a cdef function in a .py file, but perhaps that does not matter. I will move th caching code to designs_pyx.\n\n\nThat's why we can move `orthogonal_array` as well.\n\n> > The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.\n\n> \n> I am thinking about that. What is the difference between this `orthogonal_array_available` and the current `orthogonal_array` ? I don't talk about the user interface, just about speed. When the answer is cached (most frequent case), what is it that `orthogonal_array_is_available` does that `orthogonal_array` does not ? Only check that `k is not None` ?\n\n\nIf `orthogonal_array` is cythonized... not much. Otherwise, function calls.\n\nVincent",
    "created_at": "2014-08-25T16:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219196",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:4 ncohen]:
> Yo !
> 
> > I am not confident of having everything switched into Cython.

> 
> I don't like it either. And it takes a lifetime to compile.
> 
> > It is much harder to debug and can also makes things slower.

> 
> Really ? Do you have an example ? `O_o`


Almost anything:

```
def f():
    from sage.rings.arith import is_prime
    from sage.quadratic_forms.extras import is_triangular_number

    for i in range(2,1000):
        is_prime(i)
        is_triangular_number(i)
```
then I got

```
sage: timeit("f_python()", number=100)
100 loops, best of 3: 12.7 ms per loop
sage: timeit("f_cython()", number=100)
100 loops, best of 3: 12.9 ms per loop
```
Not very significant, but still.

> > Why not only switch to C for the cache part?

> 
> Well, I can't cimport a cdef function in a .py file, but perhaps that does not matter. I will move th caching code to designs_pyx.


That's why we can move `orthogonal_array` as well.

> > The function `orthogonal_array` might also move and we might also recreate the `orthogonal_array_available` from #16875.

> 
> I am thinking about that. What is the difference between this `orthogonal_array_available` and the current `orthogonal_array` ? I don't talk about the user interface, just about speed. When the answer is cached (most frequent case), what is it that `orthogonal_array_is_available` does that `orthogonal_array` does not ? Only check that `k is not None` ?


If `orthogonal_array` is cythonized... not much. Otherwise, function calls.

Vincent



---

archive/issue_comments_219197.json:
```json
{
    "body": "with `public/16879b`\n\n```\nError compiling Cython file:\n------------------------------------------------------------\n_OA_cache = <cache_entry *> sage_malloc(2*sizeof(cache_entry))\n            ^\n------------------------------------------------------------\n\nsage/combinat/designs/designs_pyx.pyx:509:13: 'cache_entry' is not a type identifier\n```\n\nI guess you forgot a `git add` or something.\n\nVincent",
    "created_at": "2014-08-25T16:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219197",
    "user": "https://github.com/videlec"
}
```

with `public/16879b`

```
Error compiling Cython file:
------------------------------------------------------------
_OA_cache = <cache_entry *> sage_malloc(2*sizeof(cache_entry))
            ^
------------------------------------------------------------

sage/combinat/designs/designs_pyx.pyx:509:13: 'cache_entry' is not a type identifier
```

I guess you forgot a `git add` or something.

Vincent



---

archive/issue_comments_219198.json:
```json
{
    "body": "Right ! I just updated the branch.\n\nNathann",
    "created_at": "2014-08-25T16:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219198",
    "user": "https://github.com/nathanncohen"
}
```

Right ! I just updated the branch.

Nathann



---

archive/issue_comments_219199.json:
```json
{
    "body": "I think that the `-g` option is the default, because when you compile with your version you got it twice\n\n```\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g ...\n```",
    "created_at": "2014-08-25T16:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219199",
    "user": "https://github.com/videlec"
}
```

I think that the `-g` option is the default, because when you compile with your version you got it twice

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g ...
```



---

archive/issue_comments_219200.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> I think that the `-g` option is the default, because when you compile with your version you got it twice\n> \n> ```\n> gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g ...\n> ```\n\n\nEDIT: sorry three times!",
    "created_at": "2014-08-25T16:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219200",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 vdelecroix]:
> I think that the `-g` option is the default, because when you compile with your version you got it twice
> 
> ```
> gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g ...
> ```


EDIT: sorry three times!



---

archive/issue_comments_219201.json:
```json
{
    "body": "And I do not know which optimization is chosen between `-O2` and `-O3`\n\n```\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 ...\n```",
    "created_at": "2014-08-25T16:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219201",
    "user": "https://github.com/videlec"
}
```

And I do not know which optimization is chosen between `-O2` and `-O3`

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 ...
```



---

archive/issue_comments_219202.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-25T16:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219202",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219203.json:
```json
{
    "body": "How is this for you ? I plan on modifying `orthogonal_array_recursive` now, and turn it into a .pyx file. The only time-consuming operations that occur there are the `find_*` functions which may benefit from C integer variables.\n\nPlus I plan on writing a small function `cdef bint _is_available(k,n)` there that will 1) check the cache 2) call orthogonal_array(k,n,existence=1) if needed: the point is that because this function is a cdef one,  for most calls no Python will be involved at all.\n\nTell me what you think of this patch, for I cannot begin that if I am not sure that the cache function stay in designs_pyx.\n\nHave fuuuuuun !\n\nNathann",
    "created_at": "2014-08-25T16:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219203",
    "user": "https://github.com/nathanncohen"
}
```

How is this for you ? I plan on modifying `orthogonal_array_recursive` now, and turn it into a .pyx file. The only time-consuming operations that occur there are the `find_*` functions which may benefit from C integer variables.

Plus I plan on writing a small function `cdef bint _is_available(k,n)` there that will 1) check the cache 2) call orthogonal_array(k,n,existence=1) if needed: the point is that because this function is a cdef one,  for most calls no Python will be involved at all.

Tell me what you think of this patch, for I cannot begin that if I am not sure that the cache function stay in designs_pyx.

Have fuuuuuun !

Nathann



---

archive/issue_comments_219204.json:
```json
{
    "body": "After:\n- moving `orthogonal_array` to `designs_pyx`\n- setting `_OA_cache*` to `cdef` functions\n- creating a `orthogonal_array_available`\nI got 1sec on the first 1200 MOLS.\n\n(I am running the tests right now)",
    "created_at": "2014-08-25T16:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219204",
    "user": "https://github.com/videlec"
}
```

After:
- moving `orthogonal_array` to `designs_pyx`
- setting `_OA_cache*` to `cdef` functions
- creating a `orthogonal_array_available`
I got 1sec on the first 1200 MOLS.

(I am running the tests right now)



---

archive/issue_comments_219205.json:
```json
{
    "body": "Conclusion:\n- it is definitely good to switch to C for the cache\n- for that ticket, it would be better to switch the `_OA_cache*` to `cdef` and move at the same time `orthogonal_array` into `designs_pyx` (I can push my commit without the `orthogonal_array_available`)\n- to go further it might be a good idea to try the cythonization of the find-part of `orthogonal_array_recursive`\n\nVincent",
    "created_at": "2014-08-25T16:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219205",
    "user": "https://github.com/videlec"
}
```

Conclusion:
- it is definitely good to switch to C for the cache
- for that ticket, it would be better to switch the `_OA_cache*` to `cdef` and move at the same time `orthogonal_array` into `designs_pyx` (I can push my commit without the `orthogonal_array_available`)
- to go further it might be a good idea to try the cythonization of the find-part of `orthogonal_array_recursive`

Vincent



---

archive/issue_comments_219206.json:
```json
{
    "body": "....\n\nWell.. That's kind of what I told you I would do when you will tell me that this patch is okay ?...\n\nThough I wanted to leave orthogonal array in its file. As the `is_available` c function I want to write in the recursive file makes it useless.\n\nNathann",
    "created_at": "2014-08-25T17:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219206",
    "user": "https://github.com/nathanncohen"
}
```

....

Well.. That's kind of what I told you I would do when you will tell me that this patch is okay ?...

Though I wanted to leave orthogonal array in its file. As the `is_available` c function I want to write in the recursive file makes it useless.

Nathann



---

archive/issue_comments_219207.json:
```json
{
    "body": "Replying to [comment:16 ncohen]:\n> ....\n> \n> Well.. That's kind of what I told you I would do when you will tell me that this patch is okay ?...\n> \n> Though I wanted to leave orthogonal array in its file. As the `is_available` c function I want to write in the recursive file makes it useless.\n\n\nRight now, the branch `public/16879b` looks good except that you should remove\n\n```\n+              extra_compile_args = ['-g'],\n```\n\nThe diff is not that big, why not doing everything here (i.e. switching to cython for the find-part of `orthogonal_array_recursive`)?\n\nVincent",
    "created_at": "2014-08-25T17:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219207",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:16 ncohen]:
> ....
> 
> Well.. That's kind of what I told you I would do when you will tell me that this patch is okay ?...
> 
> Though I wanted to leave orthogonal array in its file. As the `is_available` c function I want to write in the recursive file makes it useless.


Right now, the branch `public/16879b` looks good except that you should remove

```
+              extra_compile_args = ['-g'],
```

The diff is not that big, why not doing everything here (i.e. switching to cython for the find-part of `orthogonal_array_recursive`)?

Vincent



---

archive/issue_comments_219208.json:
```json
{
    "body": "> Right now, the branch `public/16879b` looks good except that you should remove\n> \n> ```\n> +              extra_compile_args = ['-g'],\n> ```\n\n\nI pused that to this ticket's branch earlier.\n\n> The diff is not that big, why not doing everything here (i.e. switching to cython for the find-part of `orthogonal_array_recursive`)?\n\n\nI don't mind, I just split stuff to make it easier for you to review. I'll do that now.\n\nNathann",
    "created_at": "2014-08-25T17:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219208",
    "user": "https://github.com/nathanncohen"
}
```

> Right now, the branch `public/16879b` looks good except that you should remove
> 
> ```
> +              extra_compile_args = ['-g'],
> ```


I pused that to this ticket's branch earlier.

> The diff is not that big, why not doing everything here (i.e. switching to cython for the find-part of `orthogonal_array_recursive`)?


I don't mind, I just split stuff to make it easier for you to review. I'll do that now.

Nathann



---

archive/issue_comments_219209.json:
```json
{
    "body": "Not as impressive as I had hoped. Without the branch it takes 13s to go to n=1000. With the branch it takes 9.65s.\n\nOf course with your prime power improvement it takes 3.4s to go to 1000. and 1.3s for 600.\n\nOkay, let's say that it is a win `:-P`\n\nNathann",
    "created_at": "2014-08-25T17:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219209",
    "user": "https://github.com/nathanncohen"
}
```

Not as impressive as I had hoped. Without the branch it takes 13s to go to n=1000. With the branch it takes 9.65s.

Of course with your prime power improvement it takes 3.4s to go to 1000. and 1.3s for 600.

Okay, let's say that it is a win `:-P`

Nathann



---

archive/issue_comments_219210.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-25T17:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219210",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219211.json:
```json
{
    "body": "Hello,\n\nMore speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.\n\nWhat do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).\n\nVincent",
    "created_at": "2014-08-26T10:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219211",
    "user": "https://github.com/videlec"
}
```

Hello,

More speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.

What do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).

Vincent



---

archive/issue_comments_219212.json:
```json
{
    "body": "Yooooooooooo !\n\n> More speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.\n\n\nCool ! By the way wouldn't `is_available(q+1,q)` be faster than `is_prime_power` at some point ? `:-PPPPPPPPPPPPP`\n\nAnyway, if this `is_prime_power` stuff keeps on slowing us down we will just cache the first 10 000 values and get rid of the problem.\n\n> What do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).\n\n\nI agree that it would be better to keep this code in Python for the moment, and I began to implement it by moving the functions to `orthogonal_arrays.py`, but I would prefer to keep this file for user-exposed functions if possible. And things like \"construction_3_3\" does not exactly answer that. Aaaaaaand there would be a `orthogonal_arrays_recursive.pyx` which would contain no constructions at all, sooo...\n\nWhat would you think of:\n\n1) Creating a file `orthogonal_arrays_find_recursive.pyx` that contains all the find functions.\n\n2) Rename orthogonal_arrays_recursive to a .py file and keep the constructions there.\n\nNathann",
    "created_at": "2014-08-26T11:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219212",
    "user": "https://github.com/nathanncohen"
}
```

Yooooooooooo !

> More speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.


Cool ! By the way wouldn't `is_available(q+1,q)` be faster than `is_prime_power` at some point ? `:-PPPPPPPPPPPPP`

Anyway, if this `is_prime_power` stuff keeps on slowing us down we will just cache the first 10 000 values and get rid of the problem.

> What do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).


I agree that it would be better to keep this code in Python for the moment, and I began to implement it by moving the functions to `orthogonal_arrays.py`, but I would prefer to keep this file for user-exposed functions if possible. And things like "construction_3_3" does not exactly answer that. Aaaaaaand there would be a `orthogonal_arrays_recursive.pyx` which would contain no constructions at all, sooo...

What would you think of:

1) Creating a file `orthogonal_arrays_find_recursive.pyx` that contains all the find functions.

2) Rename orthogonal_arrays_recursive to a .py file and keep the constructions there.

Nathann



---

archive/issue_comments_219213.json:
```json
{
    "body": "Replying to [comment:22 ncohen]:\n> Yooooooooooo !\n> \n> > More speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.\n\n> \n> Cool ! By the way wouldn't `is_available(q+1,q)` be faster than `is_prime_power` at some point ? `:-PPPPPPPPPPPPP`\n> \n> Anyway, if this `is_prime_power` stuff keeps on slowing us down we will just cache the first 10 000 values and get rid of the problem.\n\n\nIt's not the job of `sage.combinat.design`... and note that I work hard to make `is_prime`, `is_prime_power`, `prime_range` and `prime_power_range` faster.\n\n> > What do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).\n\n> \n> I agree that it would be better to keep this code in Python for the moment, and I began to implement it by moving the functions to `orthogonal_arrays.py`, but I would prefer to keep this file for user-exposed functions if possible. And things like \"construction_3_3\" does not exactly answer that. Aaaaaaand there would be a `orthogonal_arrays_recursive.pyx` which would contain no constructions at all, sooo...\n> \n> What would you think of:\n> \n> 1) Creating a file `orthogonal_arrays_find_recursive.pyx` that contains all the find functions.\n> \n> 2) Rename orthogonal_arrays_recursive to a .py file and keep the constructions there.\n\n\nPerfect... why not `orthogonal_arrays_build_recursive.py` it would be even clearer.\n\nVincent",
    "created_at": "2014-08-26T11:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219213",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:22 ncohen]:
> Yooooooooooo !
> 
> > More speed up at `public/16879c` (pass from 14.2sec to 13.6sec for the first 1200 MOLS). Now that `is_available` is a cdef, it is the fastest to call so we should always try this one first.

> 
> Cool ! By the way wouldn't `is_available(q+1,q)` be faster than `is_prime_power` at some point ? `:-PPPPPPPPPPPPP`
> 
> Anyway, if this `is_prime_power` stuff keeps on slowing us down we will just cache the first 10 000 values and get rid of the problem.


It's not the job of `sage.combinat.design`... and note that I work hard to make `is_prime`, `is_prime_power`, `prime_range` and `prime_power_range` faster.

> > What do you think about moving the actual constructions in `orthogonal_arrays.py` and globally import them in `orthogonal_array_recursive.py`? I do not like to have them in Cython (it takes lifetime to compile, you get ugly backtrace, ...).

> 
> I agree that it would be better to keep this code in Python for the moment, and I began to implement it by moving the functions to `orthogonal_arrays.py`, but I would prefer to keep this file for user-exposed functions if possible. And things like "construction_3_3" does not exactly answer that. Aaaaaaand there would be a `orthogonal_arrays_recursive.pyx` which would contain no constructions at all, sooo...
> 
> What would you think of:
> 
> 1) Creating a file `orthogonal_arrays_find_recursive.pyx` that contains all the find functions.
> 
> 2) Rename orthogonal_arrays_recursive to a .py file and keep the constructions there.


Perfect... why not `orthogonal_arrays_build_recursive.py` it would be even clearer.

Vincent



---

archive/issue_comments_219214.json:
```json
{
    "body": "Yoooooooo !\n\n> It's not the job of `sage.combinat.design`... and note that I work hard to make `is_prime`, `is_prime_power`, `prime_range` and `prime_power_range` faster.\n\n\nI wonder about that: guys who work on number theory may work differently, or work on very large numbers for which it makes no difference. Or use the heuristics directly. What you do is useful for everybody indeed (and clearly for us too), but if we can save some new seconds with a small cache, why not ?\n\n> Perfect... why not `orthogonal_arrays_build_recursive.py` it would be even clearer.\n\n\nBecause the file already exists like that... But yes, why not ? I will upload a commit for that.\n\nNathann",
    "created_at": "2014-08-26T11:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219214",
    "user": "https://github.com/nathanncohen"
}
```

Yoooooooo !

> It's not the job of `sage.combinat.design`... and note that I work hard to make `is_prime`, `is_prime_power`, `prime_range` and `prime_power_range` faster.


I wonder about that: guys who work on number theory may work differently, or work on very large numbers for which it makes no difference. Or use the heuristics directly. What you do is useful for everybody indeed (and clearly for us too), but if we can save some new seconds with a small cache, why not ?

> Perfect... why not `orthogonal_arrays_build_recursive.py` it would be even clearer.


Because the file already exists like that... But yes, why not ? I will upload a commit for that.

Nathann



---

archive/issue_comments_219215.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-08-26T14:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219215",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_219216.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-26T14:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219216",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219217.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-08-26T16:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219217",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_219218.json:
```json
{
    "body": "Hello,\n\nWhy `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.\n\nOne commit at `public/16879c`... it appears that:\n- `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)\n- the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized\n- after a `%crun`, we still have to work on `find_wilson_decomposition_with_two_truncated_groups` and `find_recursive_find_construction_3_3`\n\nVincent",
    "created_at": "2014-08-26T16:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219218",
    "user": "https://github.com/videlec"
}
```

Hello,

Why `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.

One commit at `public/16879c`... it appears that:
- `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)
- the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized
- after a `%crun`, we still have to work on `find_wilson_decomposition_with_two_truncated_groups` and `find_recursive_find_construction_3_3`

Vincent



---

archive/issue_comments_219219.json:
```json
{
    "body": "Yo !\n\n> Why `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.\n\n\nI don't know if it will be inlined in this case. Probably we don't care.\n\n> One commit at `public/16879c`... it appears that:\n> - `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)\n\n\nOkay.\n\n>  - the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized\n\n\nPerhaps, but your fix is ugly.\n\n>  - after a `%crun`, we still have to work on `find_wilson_decomposition_with_two_truncated_groups` and `find_recursive_find_construction_3_3`\n\n\nYep.\n\nWhat's the problem with only importing the functions when you need them ?\n\nNathann",
    "created_at": "2014-08-26T22:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219219",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> Why `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.


I don't know if it will be inlined in this case. Probably we don't care.

> One commit at `public/16879c`... it appears that:
> - `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)


Okay.

>  - the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized


Perhaps, but your fix is ugly.

>  - after a `%crun`, we still have to work on `find_wilson_decomposition_with_two_truncated_groups` and `find_recursive_find_construction_3_3`


Yep.

What's the problem with only importing the functions when you need them ?

Nathann



---

archive/issue_comments_219220.json:
```json
{
    "body": "Replying to [comment:28 ncohen]:\n> Yo !\n> \n> > Why `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.\n\n> \n> I don't know if it will be inlined in this case. Probably we don't care.\n\n\nLet's keep it where it is right now. But I am not sure at that point that we care a C function call.\n\n> > One commit at `public/16879c`... it appears that:\n> > - `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)\n\n> \n> Okay.\n> \n> >  - the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized\n \n> \n> Perhaps, but your fix is ugly.\n\n\nIt depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?\n\n> What's the problem with only importing the functions when you need them ?\n\n\nIt is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!\n\nVincent",
    "created_at": "2014-08-26T22:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219220",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:28 ncohen]:
> Yo !
> 
> > Why `is_available` is in `orthogonal_arrays_find_recursive` instead of `designs_pyx`? Even if it is `cdef` you can cimport it.

> 
> I don't know if it will be inlined in this case. Probably we don't care.


Let's keep it where it is right now. But I am not sure at that point that we care a C function call.

> > One commit at `public/16879c`... it appears that:
> > - `divisors` is really slow and it is better to do a stupid loop and check divisibility (might not be True for integer > 1000)

> 
> Okay.
> 
> >  - the kind of loop `for m in [1]+range(min(k,19), 122):` is very badly cythonized
 
> 
> Perhaps, but your fix is ugly.


It depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?

> What's the problem with only importing the functions when you need them ?


It is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!

Vincent



---

archive/issue_comments_219221.json:
```json
{
    "body": "Yo !\n\n> Let's keep it where it is right now. But I am not sure at that point that we care a C function call.\n\n\nI don't think we do either.\n\n> It depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?\n\n\nI look at the code I work with. I agree that it may be nice to improve it, but not at that cost, this is ugly.\n\n> > What's the problem with only importing the functions when you need them ?\n\n> \n> It is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!\n\n\nShow me the cost of those or leave the code as it is.\n\nNathann",
    "created_at": "2014-08-26T22:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219221",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> Let's keep it where it is right now. But I am not sure at that point that we care a C function call.


I don't think we do either.

> It depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?


I look at the code I work with. I agree that it may be nice to improve it, but not at that cost, this is ugly.

> > What's the problem with only importing the functions when you need them ?

> 
> It is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!


Show me the cost of those or leave the code as it is.

Nathann



---

archive/issue_comments_219222.json:
```json
{
    "body": "Replying to [comment:30 ncohen]:\n> > It depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?\n\n> \n> I look at the code I work with. I agree that it may be nice to improve it, but not at that cost, this is ugly.\n\n\nI understand, but there is really something to improve here... no problem to remove my modifications but then what?\n\n> > > What's the problem with only importing the functions when you need them ?\n\n> > \n> > It is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!\n\n> \n> Show me the cost of those or leave the code as it is.\n\n\nA very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)\n- with the head at 093ace3 (with the imports as you did): 12.9 s\n- with the head at 680d22b (with the import on top): 12.7 s\n\nVincent",
    "created_at": "2014-08-26T23:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219222",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:30 ncohen]:
> > It depends where you look at! The C code of the first version was definitely ugly! Do you have a better idea to make it work?

> 
> I look at the code I work with. I agree that it may be nice to improve it, but not at that cost, this is ugly.


I understand, but there is really something to improve here... no problem to remove my modifications but then what?

> > > What's the problem with only importing the functions when you need them ?

> > 
> > It is slower. An import of an already imported library cost (as you saw with the move imports from #16875). Not a lot, but repeated it does!

> 
> Show me the cost of those or leave the code as it is.


A very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)
- with the head at 093ace3 (with the imports as you did): 12.9 s
- with the head at 680d22b (with the import on top): 12.7 s

Vincent



---

archive/issue_comments_219223.json:
```json
{
    "body": "Helloooooo !!!\n\n> I understand, but there is really something to improve here... no problem to remove my modifications but then what?\n\n\nWhat about forgetting the lower bound ? This trick was there to save calls to `orthogonal_array(existence=True)` but now that we have this cdef function it's fine and it does not cost very much to check whether there exists a `OA(q+15,q)`. And it will become the the usual for loop afterward, with the 'range' replaced by C code.\n\n> A very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)\n> - with the head at 093ace3 (with the imports as you did): 12.9 s\n> - with the head at 680d22b (with the import on top): 12.7 s\n\n\nGod. It can actually be detected ? `O_o`\n\nCrazy. Okay, so we keep that. Damn imports.\n\nBy the way, the `%` and `/` and `//` operators are not translated into pure Cython code as they should. There is still some Python code about handling the /0 and %0 cases. There is a workaround though:\n\nhttps://github.com/cython/cython/wiki/enhancements-division\n\nNathann",
    "created_at": "2014-08-27T08:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219223",
    "user": "https://github.com/nathanncohen"
}
```

Helloooooo !!!

> I understand, but there is really something to improve here... no problem to remove my modifications but then what?


What about forgetting the lower bound ? This trick was there to save calls to `orthogonal_array(existence=True)` but now that we have this cdef function it's fine and it does not cost very much to check whether there exists a `OA(q+15,q)`. And it will become the the usual for loop afterward, with the 'range' replaced by C code.

> A very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)
> - with the head at 093ace3 (with the imports as you did): 12.9 s
> - with the head at 680d22b (with the import on top): 12.7 s


God. It can actually be detected ? `O_o`

Crazy. Okay, so we keep that. Damn imports.

By the way, the `%` and `/` and `//` operators are not translated into pure Cython code as they should. There is still some Python code about handling the /0 and %0 cases. There is a workaround though:

https://github.com/cython/cython/wiki/enhancements-division

Nathann



---

archive/issue_comments_219224.json:
```json
{
    "body": "Replying to [comment:32 ncohen]:\n> Helloooooo !!!\n> \n> > I understand, but there is really something to improve here... no problem to remove my modifications but then what?\n\n> \n> What about forgetting the lower bound ? This trick was there to save calls to `orthogonal_array(existence=True)` but now that we have this cdef function it's fine and it does not cost very much to check whether there exists a `OA(q+15,q)`. And it will become the the usual for loop afterward, with the 'range' replaced by C code.\n\n\nNope. I made a mistake the first time I tried and just set the lower bound to k+1 instead of 1. And guess what... you win like 2 secs (and all tests pass)! There are three level of loops and adding one test case to the first one costs. I can redo the timings if you wish.\n\nIt would be a good thing to see if corner cases (like m=1 or t=1 in Wilson constructions with one or two truncated blocks) are not handled by other constructions. These corner cases seem to be really expansive.\n\nAn other idea would be to have only one find function for product + wilson one truncated + wilson two truncated.\n\n> > A very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)\n> > - with the head at 093ace3 (with the imports as you did): 12.9 s\n> > - with the head at 680d22b (with the import on top): 12.7 s\n \n> \n> God. It can actually be detected ? `O_o`\n\n\nNot really. I would have said that 0.02 seconds is not significant (see the timings below). But still you have strange conventions: sometimes you put the import as the first line of the function and sometimes you put the import just before the return. I would prefer to have everything standardized (and I guess just before return is faster).\n\n> By the way, the `%` and `/` and `//` operators are not translated into pure Cython code as they should. There is still some Python code about handling the /0 and %0 cases. There is a workaround though:\n> \n> https://github.com/cython/cython/wiki/enhancements-division\n> \n\n\nWTF. With pure C variable we still get some crazy Python translations! Cython is sometimes very nice but sometimes really annoying. I dream of a special flag that allows you to say \"do not translate this block to anything, this is pure C and I known what I am doing\".\n\nTimings:\n\n```\ncommit 3db376f043c01b5ff58e46a845bb69e704c1eacf (yours)\nMOLS_table(30)    4.66 s\nMOLS_table(60)   13.4  s\nMOLS_table(90)   26.3  s\n\ncommit 093ace30591e1beed6296c9e5bd16afa37188e4b (my first set of optim)\nMOLS_table(30)    4.4  s\nMOLS_table(60)   12.7  s\nMOLS_table(90)   24.6  s\n\ncommit 680d22b2d7dba0c39a0953be1532590ec6bd7113 (the imports)\nMOLS_table(30)    4.42 s\nMOLS_table(60)   12.7  s\nMOLS_table(90)   24.2  s\n```\n\nconclusion: the win of moving the imports part is small. Depending on what you think for this ticket I will split my first commit to see what matters.\n\nVincent",
    "created_at": "2014-08-27T08:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219224",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:32 ncohen]:
> Helloooooo !!!
> 
> > I understand, but there is really something to improve here... no problem to remove my modifications but then what?

> 
> What about forgetting the lower bound ? This trick was there to save calls to `orthogonal_array(existence=True)` but now that we have this cdef function it's fine and it does not cost very much to check whether there exists a `OA(q+15,q)`. And it will become the the usual for loop afterward, with the 'range' replaced by C code.


Nope. I made a mistake the first time I tried and just set the lower bound to k+1 instead of 1. And guess what... you win like 2 secs (and all tests pass)! There are three level of loops and adding one test case to the first one costs. I can redo the timings if you wish.

It would be a good thing to see if corner cases (like m=1 or t=1 in Wilson constructions with one or two truncated blocks) are not handled by other constructions. These corner cases seem to be really expansive.

An other idea would be to have only one find function for product + wilson one truncated + wilson two truncated.

> > A very big cost, indeed!! I split the commits into two. The second one is about imports. The following timings refer to %time MOLS_table(60)
> > - with the head at 093ace3 (with the imports as you did): 12.9 s
> > - with the head at 680d22b (with the import on top): 12.7 s
 
> 
> God. It can actually be detected ? `O_o`


Not really. I would have said that 0.02 seconds is not significant (see the timings below). But still you have strange conventions: sometimes you put the import as the first line of the function and sometimes you put the import just before the return. I would prefer to have everything standardized (and I guess just before return is faster).

> By the way, the `%` and `/` and `//` operators are not translated into pure Cython code as they should. There is still some Python code about handling the /0 and %0 cases. There is a workaround though:
> 
> https://github.com/cython/cython/wiki/enhancements-division
> 


WTF. With pure C variable we still get some crazy Python translations! Cython is sometimes very nice but sometimes really annoying. I dream of a special flag that allows you to say "do not translate this block to anything, this is pure C and I known what I am doing".

Timings:

```
commit 3db376f043c01b5ff58e46a845bb69e704c1eacf (yours)
MOLS_table(30)    4.66 s
MOLS_table(60)   13.4  s
MOLS_table(90)   26.3  s

commit 093ace30591e1beed6296c9e5bd16afa37188e4b (my first set of optim)
MOLS_table(30)    4.4  s
MOLS_table(60)   12.7  s
MOLS_table(90)   24.6  s

commit 680d22b2d7dba0c39a0953be1532590ec6bd7113 (the imports)
MOLS_table(30)    4.42 s
MOLS_table(60)   12.7  s
MOLS_table(90)   24.2  s
```

conclusion: the win of moving the imports part is small. Depending on what you think for this ticket I will split my first commit to see what matters.

Vincent



---

archive/issue_comments_219225.json:
```json
{
    "body": "Yo !\n\n> It would be a good thing to see if corner cases (like m=1 or t=1 in Wilson constructions with one or two truncated blocks) are not handled by other constructions. These corner cases seem to be really expansive.\n\n\nHmmm.. I thought I had a way but it turned out to be wrong. 2sc seems a lot though `O_o`\n\n> An other idea would be to have only one find function for product + wilson one truncated + wilson two truncated.\n\n\nWe would only save the time it takes to run the product+wilson constructions. Either way let's do this on another ticket.\n\n> Not really. I would have said that 0.02 seconds is not significant (see the timings below). But still you have strange conventions: sometimes you put the import as the first line of the function and sometimes you put the import just before the return. I would prefer to have everything standardized (and I guess just before return is faster).\n\n\nI did it this way for the brouwer function because I would have had to add 4 different imports in the same function otherwise.\n\n> WTF. With pure C variable we still get some crazy Python translations! Cython is sometimes very nice but sometimes really annoying. I dream of a special flag that allows you to say \"do not translate this block to anything, this is pure C and I known what I am doing\".\n\n\nWe can actually add this at the top of the file (before the module's doc)\n\n```\n# cython: cdivision=True\n```\n\nOther flags are listed there if you are interested:\nhttps://github.com/cython/cython/wiki/enhancements-compilerdirectives\n\n> conclusion: the win of moving the imports part is small. Depending on what you think for this ticket I will split my first commit to see what matters.\n\n\nI don't mind the imports, if it can be detected then no problem. I just don't want reviews to become \"coding style fights\"..... I do mind the 10 lines in exchange for the bad \"for', though `:-P`\n\nCan we keep this as it is until we find a proper way to avoid it ?\n\nNathann\n\nP.S. : Sorry for the delay, I am kind of on \"holidays\" this week. But seeing how this goes I feel that I may escape and go back to work much sooner than expected.",
    "created_at": "2014-08-27T11:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219225",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> It would be a good thing to see if corner cases (like m=1 or t=1 in Wilson constructions with one or two truncated blocks) are not handled by other constructions. These corner cases seem to be really expansive.


Hmmm.. I thought I had a way but it turned out to be wrong. 2sc seems a lot though `O_o`

> An other idea would be to have only one find function for product + wilson one truncated + wilson two truncated.


We would only save the time it takes to run the product+wilson constructions. Either way let's do this on another ticket.

> Not really. I would have said that 0.02 seconds is not significant (see the timings below). But still you have strange conventions: sometimes you put the import as the first line of the function and sometimes you put the import just before the return. I would prefer to have everything standardized (and I guess just before return is faster).


I did it this way for the brouwer function because I would have had to add 4 different imports in the same function otherwise.

> WTF. With pure C variable we still get some crazy Python translations! Cython is sometimes very nice but sometimes really annoying. I dream of a special flag that allows you to say "do not translate this block to anything, this is pure C and I known what I am doing".


We can actually add this at the top of the file (before the module's doc)

```
# cython: cdivision=True
```

Other flags are listed there if you are interested:
https://github.com/cython/cython/wiki/enhancements-compilerdirectives

> conclusion: the win of moving the imports part is small. Depending on what you think for this ticket I will split my first commit to see what matters.


I don't mind the imports, if it can be detected then no problem. I just don't want reviews to become "coding style fights"..... I do mind the 10 lines in exchange for the bad "for', though `:-P`

Can we keep this as it is until we find a proper way to avoid it ?

Nathann

P.S. : Sorry for the delay, I am kind of on "holidays" this week. But seeing how this goes I feel that I may escape and go back to work much sooner than expected.



---

archive/issue_comments_219226.json:
```json
{
    "body": "New review commit at `public/16879c` where\n- all functions have declaration `cpdef find_XXX(int k, int n):`\n- get rid of the `IntegerListsLex`\n- `//` replaced with `/`\n- one occurrence of divisors replaced by a very naive looping\n(but neither ugly loops anymore nor moved import)\n\nIt is essentially a clean up but I win a bit on the current timings\n\n```\nMOLS_table(30)    4.44 s\nMOLS_table(60)   12.9 s\nMOLS_table(90)   25   s\n```\n\nIf you like the review commit at `public/16879c` you can set to positive review.\n\nVincent",
    "created_at": "2014-08-27T12:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219226",
    "user": "https://github.com/videlec"
}
```

New review commit at `public/16879c` where
- all functions have declaration `cpdef find_XXX(int k, int n):`
- get rid of the `IntegerListsLex`
- `//` replaced with `/`
- one occurrence of divisors replaced by a very naive looping
(but neither ugly loops anymore nor moved import)

It is essentially a clean up but I win a bit on the current timings

```
MOLS_table(30)    4.44 s
MOLS_table(60)   12.9 s
MOLS_table(90)   25   s
```

If you like the review commit at `public/16879c` you can set to positive review.

Vincent



---

archive/issue_comments_219227.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-08-27T12:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219227",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_219228.json:
```json
{
    "body": "Yo !\n\n> New review commit at `public/16879c` where\n> - all functions have declaration `cpdef find_XXX(int k, int n):`\n\n\nOkay. But they are still called \"python-style\" by `find_recursive_construction` it seems, for they are stored in a list and everything.\n\n> - get rid of the `IntegerListsLex`\n\n\nCool ! I added a comment to \"remember\" what this part of the code does.\n\n> - `//` replaced with `/`\n\n\nOkay. It produces the very same C code though.\n\n> - one occurrence of divisors replaced by a very naive looping\n> (but neither ugly loops anymore nor moved import)\n\n\nOkayyyyy !\n\n> If you like the review commit at `public/16879c` you can set to positive review.\n\n\nI added a small commit on top. I have to write an `is_quasi_difference_matrix` function but I don't enjoy it very much `T_T`\n\nNathann",
    "created_at": "2014-08-27T12:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219228",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> New review commit at `public/16879c` where
> - all functions have declaration `cpdef find_XXX(int k, int n):`


Okay. But they are still called "python-style" by `find_recursive_construction` it seems, for they are stored in a list and everything.

> - get rid of the `IntegerListsLex`


Cool ! I added a comment to "remember" what this part of the code does.

> - `//` replaced with `/`


Okay. It produces the very same C code though.

> - one occurrence of divisors replaced by a very naive looping
> (but neither ugly loops anymore nor moved import)


Okayyyyy !

> If you like the review commit at `public/16879c` you can set to positive review.


I added a small commit on top. I have to write an `is_quasi_difference_matrix` function but I don't enjoy it very much `T_T`

Nathann



---

archive/issue_comments_219229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-27T12:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219229",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219230.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-08-27T12:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219230",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_219231.json:
```json
{
    "body": "Replying to [comment:36 ncohen]:\n> Yo !\n> \n> > New review commit at `public/16879c` where\n> > - all functions have declaration `cpdef find_XXX(int k, int n):`\n \n> \n> Okay. But they are still called \"python-style\" by `find_recursive_construction` it seems, for they are stored in a list and everything.\n\n\nRight. Unwraping the loop makes it faster... but I am sure you will not like that ;-)\n\n> > - get rid of the `IntegerListsLex`\n \n> \n> Cool ! I added a comment to \"remember\" what this part of the code does.\n> \n> > - `//` replaced with `/`\n \n> \n> Okay. It produces the very same C code though.\n\n\nBut I put the flag at the top! The problem is that we do not see the cythonization command.\n\n> > - one occurrence of divisors replaced by a very naive looping\n> > (but neither ugly loops anymore nor moved import)\n\n> \n> Okayyyyy !\n> \n> > If you like the review commit at `public/16879c` you can set to positive review.\n\n> \n\nLet us go and play with something else. We will come back to that kind of optimization later when we will care about `MOLS_table(200)`...\n\nVincent",
    "created_at": "2014-08-27T12:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219231",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:36 ncohen]:
> Yo !
> 
> > New review commit at `public/16879c` where
> > - all functions have declaration `cpdef find_XXX(int k, int n):`
 
> 
> Okay. But they are still called "python-style" by `find_recursive_construction` it seems, for they are stored in a list and everything.


Right. Unwraping the loop makes it faster... but I am sure you will not like that ;-)

> > - get rid of the `IntegerListsLex`
 
> 
> Cool ! I added a comment to "remember" what this part of the code does.
> 
> > - `//` replaced with `/`
 
> 
> Okay. It produces the very same C code though.


But I put the flag at the top! The problem is that we do not see the cythonization command.

> > - one occurrence of divisors replaced by a very naive looping
> > (but neither ugly loops anymore nor moved import)

> 
> Okayyyyy !
> 
> > If you like the review commit at `public/16879c` you can set to positive review.

> 

Let us go and play with something else. We will come back to that kind of optimization later when we will care about `MOLS_table(200)`...

Vincent



---

archive/issue_comments_219232.json:
```json
{
    "body": "Yo !\n\n> Right. Unwraping the loop makes it faster... but I am sure you will not like that ;-)\n\n\nI rather doubt that it would produce any significant improvement.\n\n> But I put the flag at the top! The problem is that we do not see the cythonization command.\n\n\nNononono, the flag works ! And you can see the C code that it produces with 'sage -cython -a file.pyx' (produces a.html file). What I mean is that with this flag, having '//' or '/' is the very same and that changing them all in the code is useless as far as the C code is concerned.\n\n> Let us go and play with something else. We will come back to that kind of optimization later when we will care about `MOLS_table(200)`...\n\n\n+1\n\nNathann",
    "created_at": "2014-08-27T12:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219232",
    "user": "https://github.com/nathanncohen"
}
```

Yo !

> Right. Unwraping the loop makes it faster... but I am sure you will not like that ;-)


I rather doubt that it would produce any significant improvement.

> But I put the flag at the top! The problem is that we do not see the cythonization command.


Nononono, the flag works ! And you can see the C code that it produces with 'sage -cython -a file.pyx' (produces a.html file). What I mean is that with this flag, having '//' or '/' is the very same and that changing them all in the code is useless as far as the C code is concerned.

> Let us go and play with something else. We will come back to that kind of optimization later when we will care about `MOLS_table(200)`...


+1

Nathann



---

archive/issue_comments_219233.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-08-27T17:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219233",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_219234.json:
```json
{
    "body": "Merge failure in src/sage/combinat/designs/database.py",
    "created_at": "2014-08-27T17:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219234",
    "user": "https://github.com/vbraun"
}
```

Merge failure in src/sage/combinat/designs/database.py



---

archive/issue_comments_219235.json:
```json
{
    "body": "Volker, you work on a version of Sage that exist only on your computer. Can you say where the conflict comes from ?\n\nNathann",
    "created_at": "2014-08-27T18:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219235",
    "user": "https://github.com/nathanncohen"
}
```

Volker, you work on a version of Sage that exist only on your computer. Can you say where the conflict comes from ?

Nathann



---

archive/issue_comments_219236.json:
```json
{
    "body": "If you don't know then just wait for beta2",
    "created_at": "2014-08-27T18:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219236",
    "user": "https://github.com/vbraun"
}
```

If you don't know then just wait for beta2



---

archive/issue_comments_219237.json:
```json
{
    "body": "> If you don't know then just wait for beta2\n\n\nThen please release this beta2, beacuse you do not achieve anything by setting this patch in `needs_work` while not giving me any way to fix it. As you can see by clicking on the \"commits\" link, this patch has an history of around ~50 commits that are only linked together on your own computer. And it is rather hard to work with this amount of dependencies \"in the dark\".\n\nNathann",
    "created_at": "2014-08-28T18:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219237",
    "user": "https://github.com/nathanncohen"
}
```

> If you don't know then just wait for beta2


Then please release this beta2, beacuse you do not achieve anything by setting this patch in `needs_work` while not giving me any way to fix it. As you can see by clicking on the "commits" link, this patch has an history of around ~50 commits that are only linked together on your own computer. And it is rather hard to work with this amount of dependencies "in the dark".

Nathann



---

archive/issue_comments_219238.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-08-28T22:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219238",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_219239.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-08-28T22:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219239",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_219240.json:
```json
{
    "body": "Rebased !\n\nNathann",
    "created_at": "2014-08-28T22:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219240",
    "user": "https://github.com/nathanncohen"
}
```

Rebased !

Nathann



---

archive/issue_comments_219241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-06T11:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16879#issuecomment-219241",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_049337.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-06T11:02:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16879",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16879#event-49337"
}
```
