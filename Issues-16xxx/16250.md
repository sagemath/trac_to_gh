# Issue 16250: Monoids._test_one() incorrect for unhashable one elements

archive/issues_016013.json:
```json
{
    "assignees": [],
    "body": "In `categories.Monoids._test_one()` the hash value of a monoid's one is tested.\n\n```\ntester.assertEqual(type(one.__hash__()), int) \ntester.assertEqual(one.__hash__(), one.__hash__())\n```\nFor unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11895. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: \u200bhttp://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.\n\nThe same problem exists for `CommutativeAdditiveMonoids._test_zero()`.\n\n**CC:**  @nthiery\n\n**Keywords:** hash\n\n**Branch:** [u/saraedum/ticket/16250](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/16250)\n\n**Commit:** [a40d04ffaae4c807b2e2132b49155ce23bc38931](https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931)\n\n**Author:** Julian R\u00fcth\n\nIssue created by migration from https://trac.sagemath.org/ticket/16250\n\n",
    "closed_at": "2015-11-22T20:58:31Z",
    "created_at": "2014-04-27T13:26:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20categories",
        "https://github.com/sagemath/sage/labels/trivial",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Monoids._test_one() incorrect for unhashable one elements",
    "type": "issue",
    "updated_at": "2015-11-22T20:58:31Z",
    "url": "https://github.com/sagemath/sage/issues/16250",
    "user": "https://github.com/saraedum"
}
```
In `categories.Monoids._test_one()` the hash value of a monoid's one is tested.

```
tester.assertEqual(type(one.__hash__()), int) 
tester.assertEqual(one.__hash__(), one.__hash__())
```
For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11895. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: ​http://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.

The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.

**CC:**  @nthiery

**Keywords:** hash

**Branch:** [u/saraedum/ticket/16250](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/16250)

**Commit:** [a40d04ffaae4c807b2e2132b49155ce23bc38931](https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931)

**Author:** Julian Rüth

Issue created by migration from https://trac.sagemath.org/ticket/16250





---

archive/issue_comments_210348.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,4 +6,4 @@\n ```\n For unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.\n \n-The same problem exists for `AdditiveMonoids._test_zero()`.\n+The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.\n``````\n",
    "created_at": "2014-04-27T13:33:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210348",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,4 +6,4 @@
 ```
 For unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.
 
-The same problem exists for `AdditiveMonoids._test_zero()`.
+The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.
``````




---

archive/issue_comments_210349.json:
```json
{
    "body": "**Branch:** [u/saraedum/ticket/16250](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/16250)",
    "created_at": "2014-04-27T13:36:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210349",
    "user": "https://github.com/saraedum"
}
```

**Branch:** [u/saraedum/ticket/16250](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/16250)



---

archive/issue_comments_210350.json:
```json
{
    "body": "**Author:** Julian R\u00fcth",
    "created_at": "2014-04-27T13:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210350",
    "user": "https://github.com/saraedum"
}
```

**Author:** Julian Rüth



---

archive/issue_comments_210351.json:
```json
{
    "body": "<a id='comment:3'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141\">7b35c8a</a></td><td><code>Monoids._test_one() and CommutativeAdditiveMonoid._test_zero() should not check the hash value for unhashable elements</code></td></tr></table>\n",
    "created_at": "2014-04-27T13:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210351",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141">7b35c8a</a></td><td><code>Monoids._test_one() and CommutativeAdditiveMonoid._test_zero() should not check the hash value for unhashable elements</code></td></tr></table>




---

archive/issue_events_144924.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-04-27T13:36:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144924"
}
```



---

archive/issue_comments_210352.json:
```json
{
    "body": "**Commit:** [7b35c8a32ea67041665dddd8f1d98c7b8cfb6141](https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141)",
    "created_at": "2014-04-27T13:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210352",
    "user": "https://github.com/saraedum"
}
```

**Commit:** [7b35c8a32ea67041665dddd8f1d98c7b8cfb6141](https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141)



---

archive/issue_events_144925.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144925"
}
```



---

archive/issue_events_144926.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144926"
}
```



---

archive/issue_comments_210353.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi!\n\nThanks for shaking the generic tests with one more use case :-)\n\nI agree that it makes sense to disable the test if the object is not\nhashable. On the other hand, I would much prefer to have an explicit\ntest like:\n\n```\n    isinstance(..., collections.Hashable)\n```\n\nThis better expresses the intention and also avoids the risk of false\npositives in case a TypeError failure would be raised for some other\nreasons and be silently caught.\n\nOf course the above isinstance test fails if there is a `__hash__`\nmethod defined. But this can be conveniently fixed by setting\n`__hash__` to `None` in the element class. In fact this sounds like a\nnatural thing to do anyway: having `__hash__` defined and return\nsomething, and worst something that could change over time, is nothing\nbut a potential source of issues, isn't it?\n\nWith `__hash__` set to `None`, we have as desired:\n\n```\n    sage: import collections\n    sage: K.<a> = Qq(9)\n    sage: K.zero\n    sage: isinstance(K.zero(), collections.Hashable)\n    False\n```\n\nAgreed, the right fix (tm) would probably be to remove the infamous\n`SageObject.__hash__` method in the first place. Not all SageObjects\nare hashable, and anyway computing the hash in term of `_repr_` is\njust a continuous source of bugs. But this fix could take some work\nsince one would need to implement `__hash__` properly in a bunch of\nplaces; so let's say that this is for a separate ticket.\n\nCheers,\n                          Nicolas",
    "created_at": "2014-05-10T21:51:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210353",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Hi!

Thanks for shaking the generic tests with one more use case :-)

I agree that it makes sense to disable the test if the object is not
hashable. On the other hand, I would much prefer to have an explicit
test like:

```
    isinstance(..., collections.Hashable)
```

This better expresses the intention and also avoids the risk of false
positives in case a TypeError failure would be raised for some other
reasons and be silently caught.

Of course the above isinstance test fails if there is a `__hash__`
method defined. But this can be conveniently fixed by setting
`__hash__` to `None` in the element class. In fact this sounds like a
natural thing to do anyway: having `__hash__` defined and return
something, and worst something that could change over time, is nothing
but a potential source of issues, isn't it?

With `__hash__` set to `None`, we have as desired:

```
    sage: import collections
    sage: K.<a> = Qq(9)
    sage: K.zero
    sage: isinstance(K.zero(), collections.Hashable)
    False
```

Agreed, the right fix (tm) would probably be to remove the infamous
`SageObject.__hash__` method in the first place. Not all SageObjects
are hashable, and anyway computing the hash in term of `_repr_` is
just a continuous source of bugs. But this fix could take some work
since one would need to implement `__hash__` properly in a bunch of
places; so let's say that this is for a separate ticket.

Cheers,
                          Nicolas



---

archive/issue_comments_210354.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@nthiery](#comment%3A6):\n> I agree that it makes sense to disable the test if the object is not\n> hashable. On the other hand, I would much prefer to have an explicit\n> test like:\n> \n> ```\n>     isinstance(..., collections.Hashable)\n> ```\n\nI thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n\n> Agreed, the right fix (tm) would probably be to remove the infamous\n> `SageObject.__hash__` method in the first place. Not all SageObjects\n> are hashable, and anyway computing the hash in term of `_repr_` is\n> just a continuous source of bugs. But this fix could take some work\n> since one would need to implement `__hash__` properly in a bunch of\n> places; so let's say that this is for a separate ticket.\n\nI agree. At first it seems that basing this on `_repr_` is exactly what one wants. But the little work you save is just not worth all the trouble it causes.",
    "created_at": "2014-05-10T22:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210354",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'></a>
Replying to [@nthiery](#comment%3A6):
> I agree that it makes sense to disable the test if the object is not
> hashable. On the other hand, I would much prefer to have an explicit
> test like:
> 
> ```
>     isinstance(..., collections.Hashable)
> ```

I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.

> Agreed, the right fix (tm) would probably be to remove the infamous
> `SageObject.__hash__` method in the first place. Not all SageObjects
> are hashable, and anyway computing the hash in term of `_repr_` is
> just a continuous source of bugs. But this fix could take some work
> since one would need to implement `__hash__` properly in a bunch of
> places; so let's say that this is for a separate ticket.

I agree. At first it seems that basing this on `_repr_` is exactly what one wants. But the little work you save is just not worth all the trouble it causes.



---

archive/issue_comments_210355.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [@saraedum](#comment%3A7):\n> I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n\n- The methods one and zero should return immutable objects whenever\n  possible, because more often than not the result is cached.  If the\n  result is a matrix this is no issue: it's enough to make it\n  immutable. And then it becomes hashable. Part of the rationale of\n  this test is precisely to check for this!\n\n- Having a method `__hash__` that raises an error is bad advertising in\n  the first place. In some cases it might be simpler to do it this way\n  (e.g. for objects that can be immutable or not). But I would not\n  want to particularly support this.\n\nCheers,\n                                  Nicolas",
    "created_at": "2014-05-11T07:56:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210355",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:8'></a>
Replying to [@saraedum](#comment%3A7):
> I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.

- The methods one and zero should return immutable objects whenever
  possible, because more often than not the result is cached.  If the
  result is a matrix this is no issue: it's enough to make it
  immutable. And then it becomes hashable. Part of the rationale of
  this test is precisely to check for this!

- Having a method `__hash__` that raises an error is bad advertising in
  the first place. In some cases it might be simpler to do it this way
  (e.g. for objects that can be immutable or not). But I would not
  want to particularly support this.

Cheers,
                                  Nicolas



---

archive/issue_comments_210356.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@nthiery](#comment%3A8):\n> Replying to [@saraedum](#comment%3A7):\n> > I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n\n> - The methods one and zero should return immutable objects whenever\n>   possible, because more often than not the result is cached.  If the\n>   result is a matrix this is no issue: it's enough to make it\n>   immutable. And then it becomes hashable. Part of the rationale of\n>   this test is precisely to check for this!\n> \n> - Having a method `__hash__` that raises an error is bad advertising in\n>   the first place. In some cases it might be simpler to do it this way\n>   (e.g. for objects that can be immutable or not). But I would not\n>   want to particularly support this.\n\nRight. But what about any type for which equality depends on a p-adic number? (Say, a polynomial with p-adic coefficients.) If we don't want to have special classes for all these, then `__hash__` will have to raise a `TypeError` when computing the hash of its coefficients (see #11895).",
    "created_at": "2014-06-26T07:15:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210356",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:9'></a>
Replying to [@nthiery](#comment%3A8):
> Replying to [@saraedum](#comment%3A7):
> > I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.

> - The methods one and zero should return immutable objects whenever
>   possible, because more often than not the result is cached.  If the
>   result is a matrix this is no issue: it's enough to make it
>   immutable. And then it becomes hashable. Part of the rationale of
>   this test is precisely to check for this!
> 
> - Having a method `__hash__` that raises an error is bad advertising in
>   the first place. In some cases it might be simpler to do it this way
>   (e.g. for objects that can be immutable or not). But I would not
>   want to particularly support this.

Right. But what about any type for which equality depends on a p-adic number? (Say, a polynomial with p-adic coefficients.) If we don't want to have special classes for all these, then `__hash__` will have to raise a `TypeError` when computing the hash of its coefficients (see #11895).



---

archive/issue_comments_210357.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a\">c4f8c62</a></td><td><code>AdditiveMagmas.test_zero() and Magmas.test_one() allow unhashable elements</code></td></tr></table>\n",
    "created_at": "2014-06-26T07:27:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210357",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a">c4f8c62</a></td><td><code>AdditiveMagmas.test_zero() and Magmas.test_one() allow unhashable elements</code></td></tr></table>




---

archive/issue_comments_210358.json:
```json
{
    "body": "**Changing commit** from \"[7b35c8a32ea67041665dddd8f1d98c7b8cfb6141](https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141)\" to \"[c4f8c62f8da90c776a32a86dd768c490fc50836a](https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a)\".",
    "created_at": "2014-06-26T07:27:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210358",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[7b35c8a32ea67041665dddd8f1d98c7b8cfb6141](https://github.com/sagemath/sagetrac-mirror/commit/7b35c8a32ea67041665dddd8f1d98c7b8cfb6141)" to "[c4f8c62f8da90c776a32a86dd768c490fc50836a](https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a)".



---

archive/issue_comments_210359.json:
```json
{
    "body": "<a id='comment:11'></a>\nHi Julian,\n\nReplying to [@saraedum](#comment%3A9):\n> Right. But what about any type for which equality depends on a\n> p-adic number? (Say, a polynomial with p-adic coefficients.) If we\n> don't want to have special classes for all these, then `__hash__` will\n> have to raise a `TypeError` when computing the hash of its\n> coefficients (see #11895).\n\nInteresting example. Well, we are in the situation of class that\ndeclares itself as hashable by providing a hash function, and then\nlater refutes this contract by throwing errors. I see this as a bug.\n\nAlright, a minor enough bug that we may well not want to introduce\ncomplicated infrastructure to fix it.\n\nHowever changing test_one and test_zero for this is just hiding this\nbug, and might hide other more important bugs in the future. I find\npreferable to explicitly skip `_test_one()` in the doctests: this will\ndo what we mean: there is a known bug, and it's deemed minor enough to\nignore it.\n\nNow, if we would want a real fix we could have polynomial rings check\nwhether there base ring elements can be hashed, and insert `__hash__ = None`\nin their custom element class. This could get tricky for a\nCython class though. But this states quite explicitly: I am hashable if my\nbase ring elements are.\n\nCheers,\n                                 Nicolas",
    "created_at": "2014-06-28T00:15:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210359",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:11'></a>
Hi Julian,

Replying to [@saraedum](#comment%3A9):
> Right. But what about any type for which equality depends on a
> p-adic number? (Say, a polynomial with p-adic coefficients.) If we
> don't want to have special classes for all these, then `__hash__` will
> have to raise a `TypeError` when computing the hash of its
> coefficients (see #11895).

Interesting example. Well, we are in the situation of class that
declares itself as hashable by providing a hash function, and then
later refutes this contract by throwing errors. I see this as a bug.

Alright, a minor enough bug that we may well not want to introduce
complicated infrastructure to fix it.

However changing test_one and test_zero for this is just hiding this
bug, and might hide other more important bugs in the future. I find
preferable to explicitly skip `_test_one()` in the doctests: this will
do what we mean: there is a known bug, and it's deemed minor enough to
ignore it.

Now, if we would want a real fix we could have polynomial rings check
whether there base ring elements can be hashed, and insert `__hash__ = None`
in their custom element class. This could get tricky for a
Cython class though. But this states quite explicitly: I am hashable if my
base ring elements are.

Cheers,
                                 Nicolas



---

archive/issue_events_144927.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-28T00:53:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144927"
}
```



---

archive/issue_events_144928.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-28T00:53:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144928"
}
```



---

archive/issue_comments_210360.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [@nthiery](#comment%3A11):\n> Replying to [@saraedum](#comment%3A9):\n> However changing test_one and test_zero for this is just hiding this\n> bug, and might hide other more important bugs in the future. I find\n> preferable to explicitly skip `_test_one()` in the doctests: this will\n> do what we mean: there is a known bug, and it's deemed minor enough to\n> ignore it.\n\nOk. I'll change it.",
    "created_at": "2014-07-26T19:53:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210360",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:13'></a>
Replying to [@nthiery](#comment%3A11):
> Replying to [@saraedum](#comment%3A9):
> However changing test_one and test_zero for this is just hiding this
> bug, and might hide other more important bugs in the future. I find
> preferable to explicitly skip `_test_one()` in the doctests: this will
> do what we mean: there is a known bug, and it's deemed minor enough to
> ignore it.

Ok. I'll change it.



---

archive/issue_comments_210361.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@nthiery](#comment%3A11):\n> Replying to [@saraedum](#comment%3A9):\n> Now, if we would want a real fix we could have polynomial rings check\n> whether there base ring elements can be hashed, and insert `__hash__ = None`\n> in their custom element class. This could get tricky for a\n> Cython class though. But this states quite explicitly: I am hashable if my\n> base ring elements are.\n\nDo you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by \"This could get tricky for a Cython class though.\"?)\n\nBtw., setting `tp_hash` does not work either:\n\n```\nsage: cython('''\ncdef extern from \"Python.h\":\n    long PyObject_HashNotImplemented(object)\n    ctypedef struct PyTypeObject:\n        long tp_hash(object)\n\ncdef class A(object):\n   pass\n\n(<PyTypeObject *> A).tp_hash = PyObject_HashNotImplemented\n\n''')\nsage: hash(A())\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-83-c87e237c4d02> in <module>()\n----> 1 hash(A())\n\nTypeError: unhashable type: '_dev_shm_dot_sage_temp_cslogin02_10081_tmp_o8x_Zq_spyx_0.A'\nsage: isinstance(A(),collections.Hashable)\nTrue\n```\n\nI posted this as a question on cython-user: http://permalink.gmane.org/gmane.comp.python.cython.user/11569",
    "created_at": "2014-07-27T23:22:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210361",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:14'></a>
Replying to [@nthiery](#comment%3A11):
> Replying to [@saraedum](#comment%3A9):
> Now, if we would want a real fix we could have polynomial rings check
> whether there base ring elements can be hashed, and insert `__hash__ = None`
> in their custom element class. This could get tricky for a
> Cython class though. But this states quite explicitly: I am hashable if my
> base ring elements are.

Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by "This could get tricky for a Cython class though."?)

Btw., setting `tp_hash` does not work either:

```
sage: cython('''
cdef extern from "Python.h":
    long PyObject_HashNotImplemented(object)
    ctypedef struct PyTypeObject:
        long tp_hash(object)

cdef class A(object):
   pass

(<PyTypeObject *> A).tp_hash = PyObject_HashNotImplemented

''')
sage: hash(A())
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-83-c87e237c4d02> in <module>()
----> 1 hash(A())

TypeError: unhashable type: '_dev_shm_dot_sage_temp_cslogin02_10081_tmp_o8x_Zq_spyx_0.A'
sage: isinstance(A(),collections.Hashable)
True
```

I posted this as a question on cython-user: http://permalink.gmane.org/gmane.comp.python.cython.user/11569



---

archive/issue_comments_210362.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@saraedum](#comment%3A14):\n> Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by \"This could get tricky for a Cython class though.\"?)\n\nI don't know. That's indeed typically the kind of difficulties I\nmeant. Also that a parent can't have is own \"copy\" of the class to\nmark it as unhashable when other parent sharing the same class will\nwant to have its elements hashable.\n\nThanks for investigating!",
    "created_at": "2014-07-30T07:03:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210362",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:15'></a>
Replying to [@saraedum](#comment%3A14):
> Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by "This could get tricky for a Cython class though."?)

I don't know. That's indeed typically the kind of difficulties I
meant. Also that a parent can't have is own "copy" of the class to
mark it as unhashable when other parent sharing the same class will
want to have its elements hashable.

Thanks for investigating!



---

archive/issue_comments_210363.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,6 +4,6 @@\n tester.assertEqual(type(one.__hash__()), int) \n tester.assertEqual(one.__hash__(), one.__hash__())\n ```\n-For unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.\n+For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11598. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: \u200bhttp://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.\n \n The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.\n``````\n",
    "created_at": "2014-08-04T07:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210363",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,6 +4,6 @@
 tester.assertEqual(type(one.__hash__()), int) 
 tester.assertEqual(one.__hash__(), one.__hash__())
 ```
-For unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.
+For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11598. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: ​http://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.
 
 The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.
``````




---

archive/issue_comments_210364.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,6 +4,6 @@\n tester.assertEqual(type(one.__hash__()), int) \n tester.assertEqual(one.__hash__(), one.__hash__())\n ```\n-For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11598. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: \u200bhttp://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.\n+For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11895. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: \u200bhttp://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.\n \n The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.\n``````\n",
    "created_at": "2014-08-04T07:44:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210364",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,6 +4,6 @@
 tester.assertEqual(type(one.__hash__()), int) 
 tester.assertEqual(one.__hash__(), one.__hash__())
 ```
-For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11598. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: ​http://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.
+For unhashable objects, such as a p-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. Eventually, `__hash__` will be dropped #11895. In this ticket, the behaviour is changed, so that `_test_one()` does not check the hash if the element does not inherit from `collections.Hashable`. However, this does not work for Cython extension classes: ​http://permalink.gmane.org/gmane.comp.python.cython.user/11569. For those, this check has to be skipped explicitly.
 
 The same problem exists for `CommutativeAdditiveMonoids._test_zero()`.
``````




---

archive/issue_comments_210365.json:
```json
{
    "body": "**Changing commit** from \"[c4f8c62f8da90c776a32a86dd768c490fc50836a](https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a)\" to \"[27e5599b7d3114f111750910cd36ecf5cc7467f3](https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3)\".",
    "created_at": "2014-08-04T07:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210365",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[c4f8c62f8da90c776a32a86dd768c490fc50836a](https://github.com/sagemath/sagetrac-mirror/commit/c4f8c62f8da90c776a32a86dd768c490fc50836a)" to "[27e5599b7d3114f111750910cd36ecf5cc7467f3](https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3)".



---

archive/issue_comments_210366.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/65ffe6065c8198a6ab4073a16b67c056d1c1b829\">65ffe60</a></td><td><code>Merge branch 'develop' into ticket/16250</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3\">27e5599</a></td><td><code>Skip checks for hash in _test_one()/test_zero() for unhashable elements</code></td></tr></table>\n",
    "created_at": "2014-08-04T07:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210366",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/65ffe6065c8198a6ab4073a16b67c056d1c1b829">65ffe60</a></td><td><code>Merge branch 'develop' into ticket/16250</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3">27e5599</a></td><td><code>Skip checks for hash in _test_one()/test_zero() for unhashable elements</code></td></tr></table>




---

archive/issue_events_144929.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-08-04T07:50:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144929"
}
```



---

archive/issue_events_144930.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-08-04T07:50:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144930"
}
```



---

archive/issue_events_144931.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144931"
}
```



---

archive/issue_events_144932.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144932"
}
```



---

archive/issue_comments_210367.json:
```json
{
    "body": "**Work Issues:** merge conflict",
    "created_at": "2015-02-05T13:34:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210367",
    "user": "https://github.com/mezzarobba"
}
```

**Work Issues:** merge conflict



---

archive/issue_events_144933.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-02-05T13:34:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144933"
}
```



---

archive/issue_events_144934.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-02-05T13:34:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144934"
}
```



---

archive/issue_comments_210368.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931\">a40d04f</a></td><td><code>Merge branch 'develop' into t/16250/ticket/16250</code></td></tr></table>\n",
    "created_at": "2015-10-10T02:58:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210368",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931">a40d04f</a></td><td><code>Merge branch 'develop' into t/16250/ticket/16250</code></td></tr></table>




---

archive/issue_comments_210369.json:
```json
{
    "body": "**Changing commit** from \"[27e5599b7d3114f111750910cd36ecf5cc7467f3](https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3)\" to \"[a40d04ffaae4c807b2e2132b49155ce23bc38931](https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931)\".",
    "created_at": "2015-10-10T02:58:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210369",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[27e5599b7d3114f111750910cd36ecf5cc7467f3](https://github.com/sagemath/sagetrac-mirror/commit/27e5599b7d3114f111750910cd36ecf5cc7467f3)" to "[a40d04ffaae4c807b2e2132b49155ce23bc38931](https://github.com/sagemath/sagetrac-mirror/commit/a40d04ffaae4c807b2e2132b49155ce23bc38931)".



---

archive/issue_comments_210370.json:
```json
{
    "body": "**Changing work issues** from \"merge conflict\" to \"\".",
    "created_at": "2015-10-10T02:58:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210370",
    "user": "https://github.com/saraedum"
}
```

**Changing work issues** from "merge conflict" to "".



---

archive/issue_events_144935.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2015-10-10T02:58:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144935"
}
```



---

archive/issue_events_144936.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2015-10-10T02:58:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144936"
}
```



---

archive/issue_events_144937.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2015-11-19T19:25:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144937"
}
```



---

archive/issue_events_144938.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2015-11-19T19:25:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144938"
}
```



---

archive/issue_comments_210371.json:
```json
{
    "body": "<a id='comment:24'></a>\nfixed in #19016.",
    "created_at": "2015-11-19T19:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16250#issuecomment-210371",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:24'></a>
fixed in #19016.



---

archive/issue_events_144939.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2015-11-19T19:25:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144939"
}
```



---

archive/issue_events_144940.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-22T20:58:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144940"
}
```



---

archive/issue_events_144941.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-22T20:58:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16250",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16250#event-144941"
}
```
