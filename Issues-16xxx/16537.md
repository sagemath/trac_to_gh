# Issue 16537: Python 3 preparation: Use "rich comparison" - std function  cmp() is gone, method __cmp__ is ignored

archive/issues_016300.json:
```json
{
    "body": "CC:  jpflori\n\nKeywords: python3, richcmp\n\nSince Py2.1 there are the //rich comparison// special methods (`__eq__, __ne__, __lt__, __le__, __gt__, __ge__`) to implement comparison operators (`==, !=, <, <=, >, >=` respectively) for custom classes.\n\nThis is more flexible (but somewhat more tedious) than defining the special method `__cmp__`.\n\nIn Py3 the special method `__cmp__` is ignored. The standard function `cmp()` (which is mostly used to implement `__cmp__` methods) is gone.\n\nOne may define a replacement function like\n\n```\ndef cmp(a, b):\n    return (a > b) - (a < b)\n```\n\nBut this does not improved performance. And it does not seem forward looking ...\n\nUnfortunately `__cmp__` and `cmp()` are used a LOT in Sage. And the migration to rich comparison can not be done purely mechanical :-(\n\nSince Py2.7 there is a class decorator [functools.total_ordering](https://docs.python.org/2/library/functools.html?highlight=total_ordering#functools.total_ordering) to help to create the full set of special method `__lt__, __le__, __gt__, __ge__` when given one of those.\n\n\nSee Lennart Regebro's [Chapter: Use rich comparison operators](http://python3porting.com/preparing.html) for a more detailed discussion.\n\nUseful tool to see the size of the remaining problem:\n\n```\ngit grep -c \"^[^#]*[^a-z\\._]cmp(\" *.py\ngit grep -c \"^[^#]*[^a-z\\._]cmp(\" *.pyx\n```\n\nThis ticket is tracked as a dependency of meta-ticket ticket:15980.\n\n---\n\n## Progress\n\nSeveral tickets have already been submitted and merged for fixing `__cmp__` -> `__richcmp__` issues in Python 3.  The remaining issues will be tracked here:\n\n### Open\n\n[This is the Trac macro *TicketQuery* that was inherited from the migration called with arguments (keywords~=richcmp&status=new))](https://trac.sagemath.org/wiki/WikiMacros#TicketQuery-macro)\n\n### In Progress\n[This is the Trac macro *TicketQuery* that was inherited from the migration called with arguments (keywords~=richcmp&status!=new&status!=closed))](https://trac.sagemath.org/wiki/WikiMacros#TicketQuery-macro)\n\n### Modules needing work\nThe following modules still contain `__cmp__` either in user-visible classes or in tests that may need to be addressed for Python 3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16537\n\n",
    "closed_at": "2020-09-11T12:17:06Z",
    "created_at": "2014-06-25T13:58:48Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Python 3 preparation: Use \"rich comparison\" - std function  cmp() is gone, method __cmp__ is ignored",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16537",
    "user": "https://github.com/wluebbe"
}
```
CC:  jpflori

Keywords: python3, richcmp

Since Py2.1 there are the //rich comparison// special methods (`__eq__, __ne__, __lt__, __le__, __gt__, __ge__`) to implement comparison operators (`==, !=, <, <=, >, >=` respectively) for custom classes.

This is more flexible (but somewhat more tedious) than defining the special method `__cmp__`.

In Py3 the special method `__cmp__` is ignored. The standard function `cmp()` (which is mostly used to implement `__cmp__` methods) is gone.

One may define a replacement function like

```
def cmp(a, b):
    return (a > b) - (a < b)
```

But this does not improved performance. And it does not seem forward looking ...

Unfortunately `__cmp__` and `cmp()` are used a LOT in Sage. And the migration to rich comparison can not be done purely mechanical :-(

Since Py2.7 there is a class decorator [functools.total_ordering](https://docs.python.org/2/library/functools.html?highlight=total_ordering#functools.total_ordering) to help to create the full set of special method `__lt__, __le__, __gt__, __ge__` when given one of those.


See Lennart Regebro's [Chapter: Use rich comparison operators](http://python3porting.com/preparing.html) for a more detailed discussion.

Useful tool to see the size of the remaining problem:

```
git grep -c "^[^#]*[^a-z\._]cmp(" *.py
git grep -c "^[^#]*[^a-z\._]cmp(" *.pyx
```

This ticket is tracked as a dependency of meta-ticket ticket:15980.

---

## Progress

Several tickets have already been submitted and merged for fixing `__cmp__` -> `__richcmp__` issues in Python 3.  The remaining issues will be tracked here:

### Open

[This is the Trac macro *TicketQuery* that was inherited from the migration called with arguments (keywords~=richcmp&status=new))](https://trac.sagemath.org/wiki/WikiMacros#TicketQuery-macro)

### In Progress
[This is the Trac macro *TicketQuery* that was inherited from the migration called with arguments (keywords~=richcmp&status!=new&status!=closed))](https://trac.sagemath.org/wiki/WikiMacros#TicketQuery-macro)

### Modules needing work
The following modules still contain `__cmp__` either in user-visible classes or in tests that may need to be addressed for Python 3.

Issue created by migration from https://trac.sagemath.org/ticket/16537





---

archive/issue_comments_213115.json:
```json
{
    "body": "I did some grepping to get a first impression of the amount of work required:\n|                                     |   |\n|-------------------------------------|---|\n|`git grep -P \"def\\s+__cmp__\" |wc -l` |377|\n| | |\n|`git grep -P \"def\\s+__eq__\"  |wc -l` |170|\n|`git grep -P \"def\\s+__ne__\"  |wc -l` |70|\n|`git grep -P \"def\\s+__lt__\"  |wc -l` |29|\n|`git grep -P \"def\\s+__le__\"  |wc -l` |18|\n|`git grep -P \"def\\s+__gt__\"  |wc -l` |21|\n|`git grep -P \"def\\s+__ge__\"  |wc -l` |18|\n| | |\n|`git grep -P \"\\bcmp\\s*\\(\" |wc -l` |1042|\nThe conclusion seems that we have to implement //rich comparison// (i.e. define `__eq__` with `__ne__` and `__gt__` with the class decorator `functools.total_ordering`) for about 350 classes!\n\nAnd then there are those 1000+ calls to `cmp`.\n\nAnd unfortunately the changes are mostly not syntactical but they require insight into the code!",
    "created_at": "2014-06-27T15:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213115",
    "user": "https://github.com/wluebbe"
}
```

I did some grepping to get a first impression of the amount of work required:
|                                     |   |
|-------------------------------------|---|
|`git grep -P "def\s+__cmp__" |wc -l` |377|
| | |
|`git grep -P "def\s+__eq__"  |wc -l` |170|
|`git grep -P "def\s+__ne__"  |wc -l` |70|
|`git grep -P "def\s+__lt__"  |wc -l` |29|
|`git grep -P "def\s+__le__"  |wc -l` |18|
|`git grep -P "def\s+__gt__"  |wc -l` |21|
|`git grep -P "def\s+__ge__"  |wc -l` |18|
| | |
|`git grep -P "\bcmp\s*\(" |wc -l` |1042|
The conclusion seems that we have to implement //rich comparison// (i.e. define `__eq__` with `__ne__` and `__gt__` with the class decorator `functools.total_ordering`) for about 350 classes!

And then there are those 1000+ calls to `cmp`.

And unfortunately the changes are mostly not syntactical but they require insight into the code!



---

archive/issue_comments_213116.json:
```json
{
    "body": "Attachment [experiments-with-rich-comparison.py](tarball://root/attachments/some-uuid/ticket16537/experiments-with-rich-comparison.py) by @wluebbe created at 2014-06-27 15:27:25\n\nPython script to demonstrate some \"features\" of rich comparison.",
    "created_at": "2014-06-27T15:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213116",
    "user": "https://github.com/wluebbe"
}
```

Attachment [experiments-with-rich-comparison.py](tarball://root/attachments/some-uuid/ticket16537/experiments-with-rich-comparison.py) by @wluebbe created at 2014-06-27 15:27:25

Python script to demonstrate some "features" of rich comparison.



---

archive/issue_comments_213117.json:
```json
{
    "body": "Attachment [test-rich-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/test-rich-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:38:57",
    "created_at": "2014-06-27T15:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213117",
    "user": "https://github.com/wluebbe"
}
```

Attachment [test-rich-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/test-rich-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:38:57



---

archive/issue_comments_213118.json:
```json
{
    "body": "Attachment [test-rich-comparison-python-3.4.0.txt](tarball://root/attachments/some-uuid/ticket16537/test-rich-comparison-python-3.4.0.txt) by @wluebbe created at 2014-06-27 15:40:05",
    "created_at": "2014-06-27T15:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213118",
    "user": "https://github.com/wluebbe"
}
```

Attachment [test-rich-comparison-python-3.4.0.txt](tarball://root/attachments/some-uuid/ticket16537/test-rich-comparison-python-3.4.0.txt) by @wluebbe created at 2014-06-27 15:40:05



---

archive/issue_comments_213119.json:
```json
{
    "body": "Attachment [cmp-comparison-1.py](tarball://root/attachments/some-uuid/ticket16537/cmp-comparison-1.py) by @wluebbe created at 2014-06-27 15:40:37",
    "created_at": "2014-06-27T15:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213119",
    "user": "https://github.com/wluebbe"
}
```

Attachment [cmp-comparison-1.py](tarball://root/attachments/some-uuid/ticket16537/cmp-comparison-1.py) by @wluebbe created at 2014-06-27 15:40:37



---

archive/issue_comments_213120.json:
```json
{
    "body": "Attachment [cmp-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/cmp-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:40:57",
    "created_at": "2014-06-27T15:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213120",
    "user": "https://github.com/wluebbe"
}
```

Attachment [cmp-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/cmp-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:40:57



---

archive/issue_comments_213121.json:
```json
{
    "body": "Attachment [rich-cmp-comparison-1.py](tarball://root/attachments/some-uuid/ticket16537/rich-cmp-comparison-1.py) by @wluebbe created at 2014-06-27 15:41:34",
    "created_at": "2014-06-27T15:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213121",
    "user": "https://github.com/wluebbe"
}
```

Attachment [rich-cmp-comparison-1.py](tarball://root/attachments/some-uuid/ticket16537/rich-cmp-comparison-1.py) by @wluebbe created at 2014-06-27 15:41:34



---

archive/issue_comments_213122.json:
```json
{
    "body": "Attachment [rich-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/rich-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:41:56",
    "created_at": "2014-06-27T15:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213122",
    "user": "https://github.com/wluebbe"
}
```

Attachment [rich-comparison-python-2.7.6.txt](tarball://root/attachments/some-uuid/ticket16537/rich-comparison-python-2.7.6.txt) by @wluebbe created at 2014-06-27 15:41:56



---

archive/issue_comments_213123.json:
```json
{
    "body": "Attachment [rich-comparison-python-3.4.0.txt](tarball://root/attachments/some-uuid/ticket16537/rich-comparison-python-3.4.0.txt) by @wluebbe created at 2014-06-27 16:24:42\n\nSome remarks on the attached files:\n* The 1st script shows the effects of varying which of the special methods `__eq__, __ne__, __lt__` and ``@`total_ordering` are defined. The 2nd and 3rd files show the results for Py2 and Py3 respectively.\n  * In Py2 all of (\"eq\", \"ne\", \"lt\", \"total\") must be used to always obtain correct results.\n  * In Py3 it appears that \"ne\" is implied (be \"eq\").\n  * For correct behavior in Py2 and Py3 all of \"eq\", \"ne\", \"lt\", \"total\" should be used.\n* The 4th script shows the results of the comparison operators when defining no `__cmp_` or using a self defined `cmp` or using the standard library `cmp`. The 5th and 6th files show the results for Py2 and Py3 respectively.\n  * In Py2 \"no_cmp\" gives often wrong results, but always correct results when `__cmp__` is defined.\n  * In Py3 there are always type errors for \"lt\", \"le\", \"gt\"and \"ge\". For \"eq\" and \"ne\" some wrong and some correct.\n  * `__cmp__` does not work in Py3! Rich comparison must be implemented!\n* The 7th script shows whether it possible to define the rich comparison special methods  using `cmp`. The 8nd and 9th files show the results for Py2 and Py3 respectively.\n  * In Py2 it is possible.\n  * In Py3 one needs a user defined `cmp` function that is based on `<` and `>`.\n  * Both in Py2 and Py3 ``@`total_ordering` is required.",
    "created_at": "2014-06-27T16:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213123",
    "user": "https://github.com/wluebbe"
}
```

Attachment [rich-comparison-python-3.4.0.txt](tarball://root/attachments/some-uuid/ticket16537/rich-comparison-python-3.4.0.txt) by @wluebbe created at 2014-06-27 16:24:42

Some remarks on the attached files:
* The 1st script shows the effects of varying which of the special methods `__eq__, __ne__, __lt__` and ``@`total_ordering` are defined. The 2nd and 3rd files show the results for Py2 and Py3 respectively.
  * In Py2 all of ("eq", "ne", "lt", "total") must be used to always obtain correct results.
  * In Py3 it appears that "ne" is implied (be "eq").
  * For correct behavior in Py2 and Py3 all of "eq", "ne", "lt", "total" should be used.
* The 4th script shows the results of the comparison operators when defining no `__cmp_` or using a self defined `cmp` or using the standard library `cmp`. The 5th and 6th files show the results for Py2 and Py3 respectively.
  * In Py2 "no_cmp" gives often wrong results, but always correct results when `__cmp__` is defined.
  * In Py3 there are always type errors for "lt", "le", "gt"and "ge". For "eq" and "ne" some wrong and some correct.
  * `__cmp__` does not work in Py3! Rich comparison must be implemented!
* The 7th script shows whether it possible to define the rich comparison special methods  using `cmp`. The 8nd and 9th files show the results for Py2 and Py3 respectively.
  * In Py2 it is possible.
  * In Py3 one needs a user defined `cmp` function that is based on `<` and `>`.
  * Both in Py2 and Py3 ``@`total_ordering` is required.



---

archive/issue_events_048555.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48555"
}
```



---

archive/issue_comments_213124.json:
```json
{
    "body": "Can the work be reduced by including the code in http://www.voidspace.org.uk/python/articles/comparison.shtml into the `SageObject` class?",
    "created_at": "2015-02-17T17:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213124",
    "user": "https://github.com/rwst"
}
```

Can the work be reduced by including the code in http://www.voidspace.org.uk/python/articles/comparison.shtml into the `SageObject` class?



---

archive/issue_comments_213125.json:
```json
{
    "body": "Replying to [comment:5 rws]:\n> Can the work be reduced by including the code in http://www.voidspace.org.uk/python/articles/comparison.shtml into the `SageObject` class?\n\n\nI suspect that `sage.structure.element.Element` is a better location for it, since `SageObject` doesn't have any comparison infrastructure, and `Element` has.\n\nIn any case, the quoted code cannot be used verbatim, since these classes are cdef cython, where the interface is via the `__richcmp__` special method, not the various `__eq__` etc. \n\nElement already has a `__richcmp__`, as well as a `__cmp__`. Precedence rules for comparison lookup in Python 2 imply that `__cmp__` should never be triggered. The implementation there in some branches will try to look up `__cmp__`. This would be a good place to start looking into how much we really depend on `__cmp__`.",
    "created_at": "2015-02-17T19:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213125",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:5 rws]:
> Can the work be reduced by including the code in http://www.voidspace.org.uk/python/articles/comparison.shtml into the `SageObject` class?


I suspect that `sage.structure.element.Element` is a better location for it, since `SageObject` doesn't have any comparison infrastructure, and `Element` has.

In any case, the quoted code cannot be used verbatim, since these classes are cdef cython, where the interface is via the `__richcmp__` special method, not the various `__eq__` etc. 

Element already has a `__richcmp__`, as well as a `__cmp__`. Precedence rules for comparison lookup in Python 2 imply that `__cmp__` should never be triggered. The implementation there in some branches will try to look up `__cmp__`. This would be a good place to start looking into how much we really depend on `__cmp__`.



---

archive/issue_comments_213126.json:
```json
{
    "body": "Currently, a Sage `Element` already implements rich comparison using `__cmp__`/`_cmp_`/`_cmp_c_impl` (for simplification of this, see #17890). In my opinion, there is nothing wrong with keeping that behaviour even in Python 3.\n\nMy conclusion from this is that the problem really is `cmp()` and not `__cmp__`.",
    "created_at": "2015-03-06T08:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213126",
    "user": "https://github.com/jdemeyer"
}
```

Currently, a Sage `Element` already implements rich comparison using `__cmp__`/`_cmp_`/`_cmp_c_impl` (for simplification of this, see #17890). In my opinion, there is nothing wrong with keeping that behaviour even in Python 3.

My conclusion from this is that the problem really is `cmp()` and not `__cmp__`.



---

archive/issue_comments_213127.json:
```json
{
    "body": "Changing component from distribution to python3.",
    "created_at": "2016-05-02T13:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213127",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from distribution to python3.



---

archive/issue_comments_213128.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-09-23T06:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213128",
    "user": "https://github.com/fchapoton"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_events_048556.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-09-23T06:08:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48556"
}
```



---

archive/issue_events_048557.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-09-23T06:08:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48557"
}
```



---

archive/issue_events_048558.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-01-12T18:05:11Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48558"
}
```



---

archive/issue_events_048559.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-01-12T18:05:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48559"
}
```



---

archive/issue_events_048560.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-01T12:52:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48560"
}
```



---

archive/issue_events_048561.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-01T12:52:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48561"
}
```



---

archive/issue_events_048562.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-10-12T12:08:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48562"
}
```



---

archive/issue_events_048563.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-10-12T12:08:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48563"
}
```



---

archive/issue_comments_213129.json:
```json
{
    "body": "There is no longer any call of cmp() in the code. There remains a few in the doc.\n\nAnd probably we still need to convert a few `__cmp__` to `__richcmp__`.",
    "created_at": "2017-11-16T19:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213129",
    "user": "https://github.com/fchapoton"
}
```

There is no longer any call of cmp() in the code. There remains a few in the doc.

And probably we still need to convert a few `__cmp__` to `__richcmp__`.



---

archive/issue_comments_213130.json:
```json
{
    "body": "As a word of warning, it seems that ``@`total_ordering` does not work with pure Python classes that have a Cython base class that implements `__richcmp__`, as it will inherit all the generated slots from the base class.  For `Element` classes they can implement `_richcmp_`, but I'm not sure what the best solution is in general.",
    "created_at": "2017-12-12T09:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213130",
    "user": "https://github.com/embray"
}
```

As a word of warning, it seems that ``@`total_ordering` does not work with pure Python classes that have a Cython base class that implements `__richcmp__`, as it will inherit all the generated slots from the base class.  For `Element` classes they can implement `_richcmp_`, but I'm not sure what the best solution is in general.



---

archive/issue_comments_213131.json:
```json
{
    "body": "In particular I ran into this with a class that was derived from `WithEqualityById`, which implements `__richcmp__`.  Looking at its `__richcmp__`, though, it really shouldn't have one, and should only implement `__eq__` I think, since the ordering operators are all `NotImplemented` anyways.",
    "created_at": "2017-12-12T09:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213131",
    "user": "https://github.com/embray"
}
```

In particular I ran into this with a class that was derived from `WithEqualityById`, which implements `__richcmp__`.  Looking at its `__richcmp__`, though, it really shouldn't have one, and should only implement `__eq__` I think, since the ordering operators are all `NotImplemented` anyways.



---

archive/issue_comments_213132.json:
```json
{
    "body": "It looks like even if just implementing `__eq__`, CPython adds its own slots for all the comparison operators that override any defined in the base classes.  So that's kind of annoying.",
    "created_at": "2017-12-12T09:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213132",
    "user": "https://github.com/embray"
}
```

It looks like even if just implementing `__eq__`, CPython adds its own slots for all the comparison operators that override any defined in the base classes.  So that's kind of annoying.



---

archive/issue_comments_213133.json:
```json
{
    "body": "Oh well, I forgot Jeroen did `richcmp_method`, even though I think I reviewed it.  That should be preferred over `total_ordering` probably.",
    "created_at": "2017-12-12T11:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213133",
    "user": "https://github.com/embray"
}
```

Oh well, I forgot Jeroen did `richcmp_method`, even though I think I reviewed it.  That should be preferred over `total_ordering` probably.



---

archive/issue_comments_213134.json:
```json
{
    "body": "Replying to [comment:16 embray]:\n> As a word of warning, it seems that ``@`total_ordering` does not work with pure Python classes that have a Cython base class that implements `__richcmp__`, as it will inherit all the generated slots from the base class.\n\n\nWhy does this problem not appear for every (new-style) class then? The base class `object` already has those slots:\n\n```\n>>> object.__lt__\n<method-wrapper '__lt__' of type object at 0x7fe14ebdf0e0>\n```",
    "created_at": "2017-12-12T16:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213134",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 embray]:
> As a word of warning, it seems that ``@`total_ordering` does not work with pure Python classes that have a Cython base class that implements `__richcmp__`, as it will inherit all the generated slots from the base class.


Why does this problem not appear for every (new-style) class then? The base class `object` already has those slots:

```
>>> object.__lt__
<method-wrapper '__lt__' of type object at 0x7fe14ebdf0e0>
```



---

archive/issue_comments_213135.json:
```json
{
    "body": "There remains also `self.cmp_letters = cmp` in `sage/combinat/words/words.py`\n\nEDIT: see #24383 for that",
    "created_at": "2017-12-15T13:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213135",
    "user": "https://github.com/fchapoton"
}
```

There remains also `self.cmp_letters = cmp` in `sage/combinat/words/words.py`

EDIT: see #24383 for that



---

archive/issue_comments_213136.json:
```json
{
    "body": "That's exactly the problem.  The way `total_ordering` implemented it does something like:\n\n```\nfor op in ['__lt__', '__gt__', ...]:\n    if getattr(cls, op, None) is not getattr(object, op, None):\n        # Do something...\n```\n\nSo if there is a built-in base class that is not `object` it fails, even if it's still wrapping the standard implementation of that slot.  I would consider this a bug in Python--it shouldn't be doing identity comparison on the slot wrapper object itself.",
    "created_at": "2017-12-15T13:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213136",
    "user": "https://github.com/embray"
}
```

That's exactly the problem.  The way `total_ordering` implemented it does something like:

```
for op in ['__lt__', '__gt__', ...]:
    if getattr(cls, op, None) is not getattr(object, op, None):
        # Do something...
```

So if there is a built-in base class that is not `object` it fails, even if it's still wrapping the standard implementation of that slot.  I would consider this a bug in Python--it shouldn't be doing identity comparison on the slot wrapper object itself.



---

archive/issue_comments_213137.json:
```json
{
    "body": "Replying to [comment:21 chapoton]:\n> There remains also `self.cmp_letters = cmp` in `sage/combinat/words/words.py`\n\n\nI think my plan was to just remove that outright since it's deprecated for some time and nothing uses it.",
    "created_at": "2017-12-15T13:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213137",
    "user": "https://github.com/embray"
}
```

Replying to [comment:21 chapoton]:
> There remains also `self.cmp_letters = cmp` in `sage/combinat/words/words.py`


I think my plan was to just remove that outright since it's deprecated for some time and nothing uses it.



---

archive/issue_comments_213138.json:
```json
{
    "body": "Sorry, I was wrong. Actually, `object.__eq__` is really the method `type.__eq__` bound to the `object` instance:\n\n```\n>>> object.__eq__(object)\nTrue\n```\nSo the type `object` does *not* have rich comparison slots.",
    "created_at": "2017-12-15T13:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213138",
    "user": "https://github.com/jdemeyer"
}
```

Sorry, I was wrong. Actually, `object.__eq__` is really the method `type.__eq__` bound to the `object` instance:

```
>>> object.__eq__(object)
True
```
So the type `object` does *not* have rich comparison slots.



---

archive/issue_comments_213139.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> Sorry, I was wrong. Actually, `object.__eq__` is really the method `type.__eq__` bound to the `object` instance:\n> \n> ```\n> >>> object.__eq__(object)\n> True\n> ```\n> So the type `object` does *not* have rich comparison slots.\n\n\nTo be clear (and part of the problem) is that there's only *one* rich comparison slot (`tp_richcompare`).  So if even one rich comparison operator is overloaded in a `cdef class` (say, `__eq__`), then all the rich comparison methods get new slot wrappers rather than inheriting them from `object`, even though the implementations for those operators are still the defaults.",
    "created_at": "2017-12-15T14:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213139",
    "user": "https://github.com/embray"
}
```

Replying to [comment:24 jdemeyer]:
> Sorry, I was wrong. Actually, `object.__eq__` is really the method `type.__eq__` bound to the `object` instance:
> 
> ```
> >>> object.__eq__(object)
> True
> ```
> So the type `object` does *not* have rich comparison slots.


To be clear (and part of the problem) is that there's only *one* rich comparison slot (`tp_richcompare`).  So if even one rich comparison operator is overloaded in a `cdef class` (say, `__eq__`), then all the rich comparison methods get new slot wrappers rather than inheriting them from `object`, even though the implementations for those operators are still the defaults.



---

archive/issue_comments_213140.json:
```json
{
    "body": "Replying to [comment:25 embray]:\n> all the rich comparison methods get new slot wrappers rather than inheriting them from `object`\n\n\nAs I said, I was wrong: `object` does not implement rich comparison:\n\n```\n>>> a = object()\n>>> a.__lt__\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nAttributeError: 'object' object has no attribute '__lt__'\n```\nSo rich comparison obviously cannot be inherited from `object`.",
    "created_at": "2017-12-15T14:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213140",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 embray]:
> all the rich comparison methods get new slot wrappers rather than inheriting them from `object`


As I said, I was wrong: `object` does not implement rich comparison:

```
>>> a = object()
>>> a.__lt__
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: 'object' object has no attribute '__lt__'
```
So rich comparison obviously cannot be inherited from `object`.



---

archive/issue_comments_213141.json:
```json
{
    "body": "You must be looking at Python 2. On Python 3 it does.  There's just a slight difference in where it inherits the default behavior from.",
    "created_at": "2017-12-15T14:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213141",
    "user": "https://github.com/embray"
}
```

You must be looking at Python 2. On Python 3 it does.  There's just a slight difference in where it inherits the default behavior from.



---

archive/issue_comments_213142.json:
```json
{
    "body": "Replying to [comment:27 embray]:\n> You must be looking at Python 2. On Python 3 it does.  There's just a slight difference in where it inherits the default behavior from.\n\n\nRight!\n\n```\nPython 3.4.1 (default, Sep  4 2015, 12:50:14) \n[GCC 4.8.4] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> a = object()\n>>> a.__lt__\n<method-wrapper '__lt__' of object object at 0x7f4ccf850070>\n```\n\nOn Python 2, `object` has neither `__cmp__` nor `__eq__`.",
    "created_at": "2017-12-15T14:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213142",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 embray]:
> You must be looking at Python 2. On Python 3 it does.  There's just a slight difference in where it inherits the default behavior from.


Right!

```
Python 3.4.1 (default, Sep  4 2015, 12:50:14) 
[GCC 4.8.4] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> a = object()
>>> a.__lt__
<method-wrapper '__lt__' of object object at 0x7f4ccf850070>
```

On Python 2, `object` has neither `__cmp__` nor `__eq__`.



---

archive/issue_comments_213143.json:
```json
{
    "body": "I must be missing your point. I'm not talking about Python 2.",
    "created_at": "2017-12-15T14:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213143",
    "user": "https://github.com/embray"
}
```

I must be missing your point. I'm not talking about Python 2.



---

archive/issue_comments_213144.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> I'm not talking about Python 2.\n\n\nYes, I understood that now..",
    "created_at": "2017-12-15T14:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213144",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:29 embray]:
> I'm not talking about Python 2.


Yes, I understood that now..



---

archive/issue_comments_213145.json:
```json
{
    "body": "Changing keywords from \"python3\" to \"python3, richcmp\".",
    "created_at": "2018-02-23T13:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213145",
    "user": "https://github.com/embray"
}
```

Changing keywords from "python3" to "python3, richcmp".



---

archive/issue_comments_213146.json:
```json
{
    "body": "Adding a table or tracking modules that still need `__cmp__` work (maybe--this is just based on a grep and has not been closely reviewed).",
    "created_at": "2018-02-23T13:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213146",
    "user": "https://github.com/embray"
}
```

Adding a table or tracking modules that still need `__cmp__` work (maybe--this is just based on a grep and has not been closely reviewed).



---

archive/issue_comments_213147.json:
```json
{
    "body": "For cdef classes in Cython code, this will be slightly easier with Cython 0.28 since that allows using Python methods like `__eq__` instead of `__richcmp__`. That makes sense in particular when you only really want to implement `==` and `!=`.",
    "created_at": "2018-02-26T08:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213147",
    "user": "https://github.com/jdemeyer"
}
```

For cdef classes in Cython code, this will be slightly easier with Cython 0.28 since that allows using Python methods like `__eq__` instead of `__richcmp__`. That makes sense in particular when you only really want to implement `==` and `!=`.



---

archive/issue_comments_213148.json:
```json
{
    "body": "I'm still working on organizing some of these things.  Instead of putting notes in the \"ticket\" column please just put notes in the module column (or a separate column--perhaps I'll do that).\n\nEven \"deprecated\" modules still need a ticket related to removing them if it's deprecated.",
    "created_at": "2018-02-26T14:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213148",
    "user": "https://github.com/embray"
}
```

I'm still working on organizing some of these things.  Instead of putting notes in the "ticket" column please just put notes in the module column (or a separate column--perhaps I'll do that).

Even "deprecated" modules still need a ticket related to removing them if it's deprecated.



---

archive/issue_comments_213149.json:
```json
{
    "body": "Replying to [comment:35 jdemeyer]:\n> For cdef classes in Cython code, this will be slightly easier with Cython 0.28 since that allows using Python methods like `__eq__` instead of `__richcmp__`. That makes sense in particular when you only really want to implement `==` and `!=`.\n\n\nSort of. There's a bug in Cython that makes it impossible to compile such code if the comparison method has a docstring.",
    "created_at": "2018-02-26T14:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213149",
    "user": "https://github.com/embray"
}
```

Replying to [comment:35 jdemeyer]:
> For cdef classes in Cython code, this will be slightly easier with Cython 0.28 since that allows using Python methods like `__eq__` instead of `__richcmp__`. That makes sense in particular when you only really want to implement `==` and `!=`.


Sort of. There's a bug in Cython that makes it impossible to compile such code if the comparison method has a docstring.



---

archive/issue_comments_213150.json:
```json
{
    "body": "Replying to [comment:38 embray]:\n> Sort of. There's a bug in Cython that makes it impossible to compile such code if the comparison method has a docstring.\n\n\nThat's why I said Cython 0.28 :-)",
    "created_at": "2018-02-26T21:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213150",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:38 embray]:
> Sort of. There's a bug in Cython that makes it impossible to compile such code if the comparison method has a docstring.


That's why I said Cython 0.28 :-)



---

archive/issue_comments_213151.json:
```json
{
    "body": "#22349 is a major open issue here.",
    "created_at": "2018-03-29T12:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213151",
    "user": "https://github.com/jdemeyer"
}
```

#22349 is a major open issue here.



---

archive/issue_events_048564.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-21T18:44:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48564"
}
```



---

archive/issue_events_048565.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-21T18:44:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48565"
}
```



---

archive/issue_comments_213152.json:
```json
{
    "body": "update milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213152",
    "user": "https://github.com/videlec"
}
```

update milestone 8.3 -> 8.4



---

archive/issue_events_048566.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48566"
}
```



---

archive/issue_events_048567.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48567"
}
```



---

archive/issue_events_048568.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T19:54:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48568"
}
```



---

archive/issue_events_048569.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T19:54:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48569"
}
```



---

archive/issue_comments_213153.json:
```json
{
    "body": "Ready to close this? With only #22349 left open,\nthe meta-ticket is less useful.",
    "created_at": "2020-09-10T18:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213153",
    "user": "https://github.com/slel"
}
```

Ready to close this? With only #22349 left open,
the meta-ticket is less useful.



---

archive/issue_comments_213154.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-10T18:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213154",
    "user": "https://github.com/slel"
}
```

Changing status from new to needs_review.



---

archive/issue_events_048570.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-09-10T18:05:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48570"
}
```



---

archive/issue_events_048571.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-09-10T18:05:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48571"
}
```



---

archive/issue_comments_213155.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-11T12:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213155",
    "user": "https://github.com/fchapoton"
}
```

Resolution: fixed



---

archive/issue_events_048572.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-09-11T12:17:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16537#event-48572"
}
```



---

archive/issue_comments_213156.json:
```json
{
    "body": "ok, I guess this can be closed. Agreed.",
    "created_at": "2020-09-11T12:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16537#issuecomment-213156",
    "user": "https://github.com/fchapoton"
}
```

ok, I guess this can be closed. Agreed.
