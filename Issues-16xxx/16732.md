# Issue 16732: Fix _maxima_init_evaled_ use, as well as translations of psi etc. to/from maxima.

archive/issues_016495.json:
```json
{
    "body": "Follow-up to #9217. We have some imperfect translations to/from maxima of `psi(x,y)`. The template is:\n\n```\nsage: x,y=var(\"x y\")\nsage: maxima_calculus(psi(x,y))\npsi[x](y)\n```\nThe conversion doesn't seem to recurse on either argument, though:\n\n```\nsage: maxima_calculus(psi(psi(x,y),y))\npsi[psi(x,y)](y)\nsage: maxima_calculus(psi(x,psi(x,y)))\npsi[x](psi(x,y))\n```\n(note that the inner psi does not have the square brackets in either case.)\nPerhaps even worse:\n\n```\nsage: maxima_calculus(psi(x,polylog(3,x)))\npsi[x](polylog(3,x))\nsage: maxima_calculus(polylog(3,x))\nli[3](x)\n```\nAs you see, the polylog doesn't get translated properly! This indicates misimplemented `_maxima_init_evaled_`, and probably those occur in several spots. Perhaps the way `_maxima_init_evaled_` gets called by the translator needs amendment? (the arguments need processing). The problem seems to occur in [sage/symbolic/expression_conversion line 550](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/expression_conversions.py#n550), where the arguments are fed raw into `_maxima_init_evaled_` (compare it to the cases below where the operands do get passed through the interface) and where `_maxima_init_evaled_` is usually implemented as some basic string manipulation.\n\n\nRound-tripping only works for completely numeric first arguments (as per how the responsible regexp is designed):\n\n```\nsage: maxima_calculus(psi(x,y))._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[x](y)' in Sage\n```\n\nThese conversions all go fine with the tree-walking translation of maxima_lib (which gets used for some, but not all calculus operations):\n\n```\nsage: from sage.interfaces.maxima_lib import sr_to_max,max_to_sr\nsage: T=maxima_calculus(sr_to_max(psi(psi(x,y),y))); T\npsi[psi[x](y)](y)\nsage: max_to_sr(T.ecl())\npsi(psi(x, y), y)\n```\nNote that the regex-based \"._sage_()\" conversion will fundamentally have trouble with nested square brackets:\n\n```\nsage: T._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[psi[x](y)](y)' in Sage\n```\nAs a first step we might want to change the regex to accept \"non-]\" inside the square brackets to allow translation with non-numeric parameters. I don't think anybody has seen an expression in the wild yet that has nested square brackets (indeed, mostly the parameter is explicit numeric).\n\nThere are some other maxima functions that use square brackets too. These might benefit from a similar treatment.\n\nCC:  @rwst @kcrisman @burcin\n\nBranch/Commit: c28d9bdcb7ed0023f5eccb31d021207668259ee2\n\nReviewer: Ralf Stephan\n\nAuthor: Nils Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16732\n\n",
    "closed_at": "2014-08-04T16:03:19Z",
    "created_at": "2014-07-29T18:58:35Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Fix _maxima_init_evaled_ use, as well as translations of psi etc. to/from maxima.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16732",
    "user": "https://github.com/nbruin"
}
```
Follow-up to #9217. We have some imperfect translations to/from maxima of `psi(x,y)`. The template is:

```
sage: x,y=var("x y")
sage: maxima_calculus(psi(x,y))
psi[x](y)
```
The conversion doesn't seem to recurse on either argument, though:

```
sage: maxima_calculus(psi(psi(x,y),y))
psi[psi(x,y)](y)
sage: maxima_calculus(psi(x,psi(x,y)))
psi[x](psi(x,y))
```
(note that the inner psi does not have the square brackets in either case.)
Perhaps even worse:

```
sage: maxima_calculus(psi(x,polylog(3,x)))
psi[x](polylog(3,x))
sage: maxima_calculus(polylog(3,x))
li[3](x)
```
As you see, the polylog doesn't get translated properly! This indicates misimplemented `_maxima_init_evaled_`, and probably those occur in several spots. Perhaps the way `_maxima_init_evaled_` gets called by the translator needs amendment? (the arguments need processing). The problem seems to occur in [sage/symbolic/expression_conversion line 550](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/symbolic/expression_conversions.py#n550), where the arguments are fed raw into `_maxima_init_evaled_` (compare it to the cases below where the operands do get passed through the interface) and where `_maxima_init_evaled_` is usually implemented as some basic string manipulation.


Round-tripping only works for completely numeric first arguments (as per how the responsible regexp is designed):

```
sage: maxima_calculus(psi(x,y))._sage_()
TypeError: unable to make sense of Maxima expression 'psi[x](y)' in Sage
```

These conversions all go fine with the tree-walking translation of maxima_lib (which gets used for some, but not all calculus operations):

```
sage: from sage.interfaces.maxima_lib import sr_to_max,max_to_sr
sage: T=maxima_calculus(sr_to_max(psi(psi(x,y),y))); T
psi[psi[x](y)](y)
sage: max_to_sr(T.ecl())
psi(psi(x, y), y)
```
Note that the regex-based "._sage_()" conversion will fundamentally have trouble with nested square brackets:

```
sage: T._sage_()
TypeError: unable to make sense of Maxima expression 'psi[psi[x](y)](y)' in Sage
```
As a first step we might want to change the regex to accept "non-]" inside the square brackets to allow translation with non-numeric parameters. I don't think anybody has seen an expression in the wild yet that has nested square brackets (indeed, mostly the parameter is explicit numeric).

There are some other maxima functions that use square brackets too. These might benefit from a similar treatment.

CC:  @rwst @kcrisman @burcin

Branch/Commit: c28d9bdcb7ed0023f5eccb31d021207668259ee2

Reviewer: Ralf Stephan

Author: Nils Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16732





---

archive/issue_comments_216657.json:
```json
{
    "body": "<a id='comment:2'></a>turns out the issue here lies a little deeper and can really affect conceivably useful expressions, so I'm upgrading to usual \"major\" priority.",
    "created_at": "2014-07-29T20:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216657",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>turns out the issue here lies a little deeper and can really affect conceivably useful expressions, so I'm upgrading to usual "major" priority.



---

archive/issue_comments_216658.json:
```json
{
    "body": "<a id='comment:3'></a>OK, little search:\n\n```\nsage: search_src(\"init_evaled\")\nfunctions/special.py:285:    def _maxima_init_evaled_(self, *args):\nfunctions/special.py:294:            sage: f._maxima_init_evaled_(1/2, 1/2)\nfunctions/special.py:344:        return parent(maxima(\"%s, numer\"%self._maxima_init_evaled_(*args)))\nfunctions/special.py:368:            s = maxima(self._maxima_init_evaled_(*args))\n```\nthe above are fine. They process the arguments.\n\n```\nfunctions/log.py:415:    def _maxima_init_evaled_(self, *args):\nfunctions/log.py:713:    def _maxima_init_evaled_(self, n, z):\nfunctions/other.py:1153:    def _maxima_init_evaled_(self, n, x):\n```\nThe above are bad. They do not process their arguments.\n\n```\nfunctions/orthogonal_polys.py:402:    def _maxima_init_evaled_(self, *args):\nfunctions/orthogonal_polys.py:411:            sage: P._maxima_init_evaled_(2, 5) is None\nfunctions/orthogonal_polys.py:715:    def _maxima_init_evaled_(self, n, x):\nfunctions/orthogonal_polys.py:723:            sage: chebyshev_T._maxima_init_evaled_(1,x)\nfunctions/orthogonal_polys.py:1024:    def _maxima_init_evaled_(self, n, x):\n```\nThese are fine.\n\nSo the only problems are in `polylog`, `lambert_w`, `psi`. They should just call `_maxima_init_()` on all their arguments before stuffing them in the string template.",
    "created_at": "2014-07-29T20:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216658",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>OK, little search:

```
sage: search_src("init_evaled")
functions/special.py:285:    def _maxima_init_evaled_(self, *args):
functions/special.py:294:            sage: f._maxima_init_evaled_(1/2, 1/2)
functions/special.py:344:        return parent(maxima("%s, numer"%self._maxima_init_evaled_(*args)))
functions/special.py:368:            s = maxima(self._maxima_init_evaled_(*args))
```
the above are fine. They process the arguments.

```
functions/log.py:415:    def _maxima_init_evaled_(self, *args):
functions/log.py:713:    def _maxima_init_evaled_(self, n, z):
functions/other.py:1153:    def _maxima_init_evaled_(self, n, x):
```
The above are bad. They do not process their arguments.

```
functions/orthogonal_polys.py:402:    def _maxima_init_evaled_(self, *args):
functions/orthogonal_polys.py:411:            sage: P._maxima_init_evaled_(2, 5) is None
functions/orthogonal_polys.py:715:    def _maxima_init_evaled_(self, n, x):
functions/orthogonal_polys.py:723:            sage: chebyshev_T._maxima_init_evaled_(1,x)
functions/orthogonal_polys.py:1024:    def _maxima_init_evaled_(self, n, x):
```
These are fine.

So the only problems are in `polylog`, `lambert_w`, `psi`. They should just call `_maxima_init_()` on all their arguments before stuffing them in the string template.



---

archive/issue_comments_216659.json:
```json
{
    "body": "<a id='comment:4'></a>For the bracket problem: since we are *removing* the square brackets we CAN actually do the transformations with regexes, if we apply the substitutions repeatedly:\n\n```\nsage: s=\"psi[psi[a](b)](c)\"\nsage: s=maxima_polygamma.sub('psi(\\g<1>,',s);s\n'psi[psi(a,b)](c)'\nsage: s=maxima_polygamma.sub('psi(\\g<1>,',s);s\n'psi(psi(a,b),c)'\n```\nso we could have a little square-bracket replacement loop:\n\n```\nsold = None\nwhile s != sold:\n    sold = s\n    s=maxima_polygamma.sub('psi(\\g<1>,',s)\n    s=maxima_<other square bracket pattern>.sub(...,s)\n    s=maxima_<yet other one>.sub(...,s)\n```\nwe should converge to a fixed point that is square-bracketless if our patterns cover all legitimate uses of square brackets: If there is a square-bracket use, there is an \"innermost\" one (that doesn't contain any square bracket uses itself) and its pattern will trigger and remove it (modifying s).\n\nI'm not claiming this is an *efficient* way of doing it, but it can be done with relatively mild changes to the code.",
    "created_at": "2014-07-30T00:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216659",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>For the bracket problem: since we are *removing* the square brackets we CAN actually do the transformations with regexes, if we apply the substitutions repeatedly:

```
sage: s="psi[psi[a](b)](c)"
sage: s=maxima_polygamma.sub('psi(\g<1>,',s);s
'psi[psi(a,b)](c)'
sage: s=maxima_polygamma.sub('psi(\g<1>,',s);s
'psi(psi(a,b),c)'
```
so we could have a little square-bracket replacement loop:

```
sold = None
while s != sold:
    sold = s
    s=maxima_polygamma.sub('psi(\g<1>,',s)
    s=maxima_<other square bracket pattern>.sub(...,s)
    s=maxima_<yet other one>.sub(...,s)
```
we should converge to a fixed point that is square-bracketless if our patterns cover all legitimate uses of square brackets: If there is a square-bracket use, there is an "innermost" one (that doesn't contain any square bracket uses itself) and its pattern will trigger and remove it (modifying s).

I'm not claiming this is an *efficient* way of doing it, but it can be done with relatively mild changes to the code.



---

archive/issue_comments_216660.json:
```json
{
    "body": "<a id='comment:6'></a>Something along these lines should do the job.\n\n---\nNew commits:",
    "created_at": "2014-07-30T01:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216660",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>Something along these lines should do the job.

---
New commits:



---

archive/issue_comments_216661.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-07-30T01:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216661",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_216662.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-08-04T07:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216662",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_216663.json:
```json
{
    "body": "<a id='comment:8'></a>Looks straightforward and patchbot is happy.",
    "created_at": "2014-08-04T07:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216663",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>Looks straightforward and patchbot is happy.



---

archive/issue_comments_216664.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-08-04T16:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16732#issuecomment-216664",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_049014.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-08-04T16:03:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16732",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16732#event-49014"
}
```
