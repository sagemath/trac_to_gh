# Issue 16629: Improve sage-fix-pkg-checksums

archive/issues_016392.json:
```json
{
    "body": "The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `\"VERSION\"` in `checksums.ini`, which is confusing and not helpful.\n\nThis patch correcly computes the version string and puts it at the right place in `checksums.ini`.\n\nReviewer: Emmanuel Charpentier, Volker Braun, J. H. Palmieri, Jeroen Demeyer\n\nBranch: u/charpent/sage_fix_pkg_checksums_munches_build_pkgs__packagename__checksums\n\nCommit: a0469055a4f293df53e6f6ae42ac9dc0e761f7c8\n\nResolution: wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/16629\n\n",
    "closed_at": "2015-04-23T01:43:56Z",
    "created_at": "2014-07-08T21:12:58Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Improve sage-fix-pkg-checksums",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16629",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `"VERSION"` in `checksums.ini`, which is confusing and not helpful.

This patch correcly computes the version string and puts it at the right place in `checksums.ini`.

Reviewer: Emmanuel Charpentier, Volker Braun, J. H. Palmieri, Jeroen Demeyer

Branch: u/charpent/sage_fix_pkg_checksums_munches_build_pkgs__packagename__checksums

Commit: a0469055a4f293df53e6f6ae42ac9dc0e761f7c8

Resolution: wontfix

Issue created by migration from https://trac.sagemath.org/ticket/16629





---

archive/issue_comments_229192.json:
```json
{
    "body": "<a id='comment:2'></a>The proposed solution needs to be reviewed by someone more knowledgeable in the sage building system than I am.\n\n---\nNew commits:",
    "created_at": "2014-07-08T21:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229192",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:2'></a>The proposed solution needs to be reviewed by someone more knowledgeable in the sage building system than I am.

---
New commits:



---

archive/issue_comments_229193.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-07-08T21:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229193",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_229194.json:
```json
{
    "body": "<a id='comment:3'></a>French commit messages are verboten ;-)",
    "created_at": "2014-07-08T22:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229194",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>French commit messages are verboten ;-)



---

archive/issue_comments_229195.json:
```json
{
    "body": "<a id='comment:4'></a>Hmm \"fubar\"?\n\nHaving old tarballs in upstream/ is normal and shouldn't lead to endless warnings.\n\nIMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.",
    "created_at": "2014-07-08T22:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229195",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>Hmm "fubar"?

Having old tarballs in upstream/ is normal and shouldn't lead to endless warnings.

IMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.



---

archive/issue_comments_229196.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-07-08T22:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229196",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_229197.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 vbraun]:\n> Hmm \"fubar\"?\n\n\nWups. Oversight. Fixed...\n\n> Having old tarballs in upstream/ is normal and shouldn't lead to endless warnings.\n\n\nWhat do you mean ? \n\n> IMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.\n\n\nFix underway : orders rather than suggestions.",
    "created_at": "2014-07-08T22:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229197",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:5'></a>Replying to [comment:4 vbraun]:
> Hmm "fubar"?


Wups. Oversight. Fixed...

> Having old tarballs in upstream/ is normal and shouldn't lead to endless warnings.


What do you mean ? 

> IMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.


Fix underway : orders rather than suggestions.



---

archive/issue_comments_229198.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-08T22:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229198",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229199.json:
```json
{
    "body": "<a id='comment:7'></a>\"Tous vos ordres, Seigneur, seront ex\u00e9cut\u00e9s\" (Jean Racine) [ Hey, it's not a commit message... ]\n\nFollowed Volker's suggestions.",
    "created_at": "2014-07-08T22:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229199",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:7'></a>"Tous vos ordres, Seigneur, seront exécutés" (Jean Racine) [ Hey, it's not a commit message... ]

Followed Volker's suggestions.



---

archive/issue_comments_229200.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-07-08T22:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229200",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_229201.json:
```json
{
    "body": "<a id='comment:8'></a>I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: \n\n```\n(sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums \natlas-3.10.1.20140128.tar.bz2\nVersion mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.\nNewer version ? You must put 3.10.1.20140128.p0 in package-version.txt.\n```",
    "created_at": "2014-07-12T00:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229201",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: 

```
(sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums 
atlas-3.10.1.20140128.tar.bz2
Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
```



---

archive/issue_comments_229202.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 vbraun]:\n> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: \n> \n> ```\n> (sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums \n> atlas-3.10.1.20140128.tar.bz2\n> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.\n> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.\n> ```\nHmmm... Now we have a conflict on intended usage(s) (and therefore designs) :\n* The `builg/pkgs/<pkgname>/...` structure implies at most one version per package name.\n* The relevant snippet of the [Developer's guide](http://www.sagemath.org/doc/developer/packaging.html#checksums) hints at a \"batch\" usage of `src/bin/sage-fix-pkg-checksums.`\nSo far, that's consistent with `upstream/` as **the** set of active (i. e. built by Sage's build system) Sage's external packages source tarballs.\n* Your intended usage amounts to use `upstream/` as **a** cache of potential external packages, the set of **active** Sage external packages being determined otherwise.\n    a. This might be the `build/pkgs/*/package-version.txt` set, in which case the `sage-fix-pkg-checksums` script should loop over this set and try to find a relevant tarball. At most, it might spit a warning (or fail) when no such tarball exists. No automatic rewriting possible.\n    b. It might be an external file listing each package and the relevant version. That makes `build/pkgs/<pkgname>/package-version.txt` redundant (and a possible source of conflicts).\nThe case 1. is consistent, but needs a script like `sage-fix-one-pkg-checksum-Volkers-style` to generate the right checksums. As said before, the current batch-style script should loop on the `build/pkgs/...` tree.\n\nIn any case, it appears that the consistency of the proposed change (use `upstream/` as a cache and not as a reference set) needs modifying the use of this script (and, quite possibly, the rest of the build subsystem for external packages). Since I do not yet know my way in this system, fixing this is, for now, out of my reach. At a minimum, I need advice from someone knowing what it does.\n\nBy the way, what is wrong with an external (`.gitignore`d) directory and `mv` ing the right tarball at the right time ? An even lazier solution is, of course, to symlink the right tarball in `upstream/`, but I doubt one can get `git` to follow this transparently.\n\nSince we are playing redesigning this subsystem, may I ask why we have to have `package-version.txt` and `checksums.ini` to describe different attributes of the same tarball ? Why not one file ?",
    "created_at": "2014-07-12T01:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229202",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:9'></a>Replying to [comment:8 vbraun]:
> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: 
> 
> ```
> (sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums 
> atlas-3.10.1.20140128.tar.bz2
> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
> ```
Hmmm... Now we have a conflict on intended usage(s) (and therefore designs) :
* The `builg/pkgs/<pkgname>/...` structure implies at most one version per package name.
* The relevant snippet of the [Developer's guide](http://www.sagemath.org/doc/developer/packaging.html#checksums) hints at a "batch" usage of `src/bin/sage-fix-pkg-checksums.`
So far, that's consistent with `upstream/` as **the** set of active (i. e. built by Sage's build system) Sage's external packages source tarballs.
* Your intended usage amounts to use `upstream/` as **a** cache of potential external packages, the set of **active** Sage external packages being determined otherwise.
    a. This might be the `build/pkgs/*/package-version.txt` set, in which case the `sage-fix-pkg-checksums` script should loop over this set and try to find a relevant tarball. At most, it might spit a warning (or fail) when no such tarball exists. No automatic rewriting possible.
    b. It might be an external file listing each package and the relevant version. That makes `build/pkgs/<pkgname>/package-version.txt` redundant (and a possible source of conflicts).
The case 1. is consistent, but needs a script like `sage-fix-one-pkg-checksum-Volkers-style` to generate the right checksums. As said before, the current batch-style script should loop on the `build/pkgs/...` tree.

In any case, it appears that the consistency of the proposed change (use `upstream/` as a cache and not as a reference set) needs modifying the use of this script (and, quite possibly, the rest of the build subsystem for external packages). Since I do not yet know my way in this system, fixing this is, for now, out of my reach. At a minimum, I need advice from someone knowing what it does.

By the way, what is wrong with an external (`.gitignore`d) directory and `mv` ing the right tarball at the right time ? An even lazier solution is, of course, to symlink the right tarball in `upstream/`, but I doubt one can get `git` to follow this transparently.

Since we are playing redesigning this subsystem, may I ask why we have to have `package-version.txt` and `checksums.ini` to describe different attributes of the same tarball ? Why not one file ?



---

archive/issue_comments_229203.json:
```json
{
    "body": "<a id='comment:10'></a>The upstream/ directory has always been meant as a cache where possibly multiple versions of tarballs are stored, potentially even shared between different sage installations. This is also how the sage-fix-pkg-checksums script works right now, it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.\n\nThe split package-version.txt and checksums.ini is to make reading the version easier from scripts. I didn't vote for it...",
    "created_at": "2014-07-12T01:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229203",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>The upstream/ directory has always been meant as a cache where possibly multiple versions of tarballs are stored, potentially even shared between different sage installations. This is also how the sage-fix-pkg-checksums script works right now, it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.

The split package-version.txt and checksums.ini is to make reading the version easier from scripts. I didn't vote for it...



---

archive/issue_comments_229204.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 vbraun] with a bit of \"esprit de l'escalier\"...:\n> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. \n\n\nDifferent branches, I suppose ? If so, why not let `git` track the change of tarball ?\n\n> Yet I get: \n> \n> ```\n> (sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums \n> atlas-3.10.1.20140128.tar.bz2\n> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.\n> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.\n> ```",
    "created_at": "2014-07-12T01:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229204",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:11'></a>Replying to [comment:8 vbraun] with a bit of "esprit de l'escalier"...:
> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. 


Different branches, I suppose ? If so, why not let `git` track the change of tarball ?

> Yet I get: 
> 
> ```
> (sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums 
> atlas-3.10.1.20140128.tar.bz2
> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
> ```



---

archive/issue_comments_229205.json:
```json
{
    "body": "<a id='comment:12'></a>I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.",
    "created_at": "2014-07-12T03:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229205",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.



---

archive/issue_comments_229206.json:
```json
{
    "body": "<a id='comment:13'></a>I agree with Volker that nothing in `upstream` should be tracked; we should be free to have tarballs for many versions of each package there. I mean, it might be nice to have a script which cleaned this directory up, deleting all out of date versions, but that would be (1) a very low priority (since you can just delete the whole directory if you have a good internet connection) and (2) for another ticket.",
    "created_at": "2014-07-12T03:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229206",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>I agree with Volker that nothing in `upstream` should be tracked; we should be free to have tarballs for many versions of each package there. I mean, it might be nice to have a script which cleaned this directory up, deleting all out of date versions, but that would be (1) a very low priority (since you can just delete the whole directory if you have a good internet connection) and (2) for another ticket.



---

archive/issue_comments_229207.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:10 vbraun]:\n> ... it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.\n  \nMinus the patchlevel, to be exact.",
    "created_at": "2014-07-12T07:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229207",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>Replying to [comment:10 vbraun]:
> ... it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.
  
Minus the patchlevel, to be exact.



---

archive/issue_comments_229208.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:12 vbraun]:\n> I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.\n> \n\n\nI beg to differ : From the current `sage-fix-pkg-checksum`, (as in the `develop` branch) :\n\n```/usr/bin/env bash\n\n# If any command-line arguments are present, treat them as files to be\n# checksummed. If no arguments are present, all tarballs in\n# $SAGE_ROOT/upstream are checksummed.\nif [ $# -eq 0 ]; then\n    cd \"$SAGE_ROOT\"\n    set upstream/*.tar*\nfi\n```\n\nIn other words, the current version is driven by the content of `upstream/` if no argument is given. If an (some) argument(s) is|are given, it uses the beginning of each argument up to the first dash as a package name and whatever follows `tar` in this argument as the compression method. Therefore, this will produce the expected behaviour IF AND ONLY IF the script is passed tarball filenames.\n\nIt will also produce the expected result if given arguments **containing the package version**. But not with arguments containing the package name only : there is no information available to choose which version is to be documented in `build/pkgs/<pkgname>/package-version.txt|checksums.ini`.\n\nA simple fix is to ignore package version mismatchs (i. e. removing the error message an the abort). In this case, the tarball ultimately documented in `build/pkgs/<pkgname>/checksums.ini` will be the one passed in argument, or the last matching the package name in the `upstream/` file list (lexicographic order).\n\nAnother possibility is to use `build/pkgs` ad the corresponding `package-version.txt` to get the necessary information, and search `upstream/` for a relevant tarball. In this case, one might find one tarball (and process it as before), none (one type of error) or more than one (another type of error).\n\nWhich one do you want ?",
    "created_at": "2014-07-12T08:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229208",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:15'></a>Replying to [comment:12 vbraun]:
> I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.
> 


I beg to differ : From the current `sage-fix-pkg-checksum`, (as in the `develop` branch) :

```/usr/bin/env bash

# If any command-line arguments are present, treat them as files to be
# checksummed. If no arguments are present, all tarballs in
# $SAGE_ROOT/upstream are checksummed.
if [ $# -eq 0 ]; then
    cd "$SAGE_ROOT"
    set upstream/*.tar*
fi
```

In other words, the current version is driven by the content of `upstream/` if no argument is given. If an (some) argument(s) is|are given, it uses the beginning of each argument up to the first dash as a package name and whatever follows `tar` in this argument as the compression method. Therefore, this will produce the expected behaviour IF AND ONLY IF the script is passed tarball filenames.

It will also produce the expected result if given arguments **containing the package version**. But not with arguments containing the package name only : there is no information available to choose which version is to be documented in `build/pkgs/<pkgname>/package-version.txt|checksums.ini`.

A simple fix is to ignore package version mismatchs (i. e. removing the error message an the abort). In this case, the tarball ultimately documented in `build/pkgs/<pkgname>/checksums.ini` will be the one passed in argument, or the last matching the package name in the `upstream/` file list (lexicographic order).

Another possibility is to use `build/pkgs` ad the corresponding `package-version.txt` to get the necessary information, and search `upstream/` for a relevant tarball. In this case, one might find one tarball (and process it as before), none (one type of error) or more than one (another type of error).

Which one do you want ?



---

archive/issue_comments_229209.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 rws]:\n> Minus the patchlevel, to be exact. \n\n\nExactly, which is another reason for why the `package-version.txt` is the authorative version. Also, the Sage build process uses the `package-version.txt` timestamp to determine whether a package needs to be rebuilt, which is why you need to add the patch level here.\n\nThe `sage-fix-pkg-checksum` iterates over upstream/ and then ignores any entries for which there is no corresponding `build/pkgs/*/package-version.txt`. So that it can auto-generate the entire checksums.ini (though it trips over cases). E.g. hashdist has a much more sensible system of caching upstream sources.",
    "created_at": "2014-07-12T13:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229209",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Replying to [comment:14 rws]:
> Minus the patchlevel, to be exact. 


Exactly, which is another reason for why the `package-version.txt` is the authorative version. Also, the Sage build process uses the `package-version.txt` timestamp to determine whether a package needs to be rebuilt, which is why you need to add the patch level here.

The `sage-fix-pkg-checksum` iterates over upstream/ and then ignores any entries for which there is no corresponding `build/pkgs/*/package-version.txt`. So that it can auto-generate the entire checksums.ini (though it trips over cases). E.g. hashdist has a much more sensible system of caching upstream sources.



---

archive/issue_comments_229210.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-12T14:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229210",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229211.json:
```json
{
    "body": "<a id='comment:18'></a>Okay. New commit ==> back to previous behaviour.\n\nI still kept the ability to accept mixed-case tarball names (with no warning).\n\nWhen called without arguments, the script will treat all tarballs. Therefore, for a given package, the last package treated (i. e. last in the lexicographic order) will be the one used for the final `checksums.ini` for that package. Is that what you wanted ?\n\nWhen called with explicit tarball names, these tarballs will generate `checksums.ini`.\n\nStatus still `needs_review`.",
    "created_at": "2014-07-12T14:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229211",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:18'></a>Okay. New commit ==> back to previous behaviour.

I still kept the ability to accept mixed-case tarball names (with no warning).

When called without arguments, the script will treat all tarballs. Therefore, for a given package, the last package treated (i. e. last in the lexicographic order) will be the one used for the final `checksums.ini` for that package. Is that what you wanted ?

When called with explicit tarball names, these tarballs will generate `checksums.ini`.

Status still `needs_review`.



---

archive/issue_comments_229212.json:
```json
{
    "body": "<a id='comment:19'></a>No, the last in lex order is wrong. Version 3.9 is older than 3.10. Really, you need to get the version from the `package-version.txt` file.",
    "created_at": "2014-07-13T05:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229212",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>No, the last in lex order is wrong. Version 3.9 is older than 3.10. Really, you need to get the version from the `package-version.txt` file.



---

archive/issue_comments_229213.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-13T07:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229213",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229214.json:
```json
{
    "body": "<a id='comment:21'></a>Done. I hope I've guessed the specs right this time...",
    "created_at": "2014-07-13T07:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229214",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:21'></a>Done. I hope I've guessed the specs right this time...



---

archive/issue_comments_229215.json:
```json
{
    "body": "<a id='comment:22'></a>The \"fubar\" file is still in the branch...",
    "created_at": "2014-07-16T19:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229215",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>The "fubar" file is still in the branch...



---

archive/issue_comments_229216.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-16T20:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229216",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229217.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 vbraun]:\n> The \"fubar\" file is still in the branch...\n\n\nRe-wups ! I didn't saw **that** when I checked before committing/pushing. Should be good now.",
    "created_at": "2014-07-16T20:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229217",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:24'></a>Replying to [comment:22 vbraun]:
> The "fubar" file is still in the branch...


Re-wups ! I didn't saw **that** when I checked before committing/pushing. Should be good now.



---

archive/issue_events_048769.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16629#event-48769"
}
```



---

archive/issue_comments_229218.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-17T10:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229218",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_229219.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,4 @@\n-The current (as of sage-6.3.beta5) version of sage-fix-pkg-checksums replaces the package version in build/pkgs/<package-name>/package-version.txt and checksums.ini\n \n-An example of the result can be found in comment 27 of [http://trac.sagemath.org/ticket/16611](http://trac.sagemath.org/ticket/16611). It is also germane to [http://trac.sagemath.org/ticket/16489](http://trac.sagemath.org/ticket/16489).\n \n Comment: 1\n \n```\n",
    "created_at": "2014-09-17T10:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229219",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,4 @@
-The current (as of sage-6.3.beta5) version of sage-fix-pkg-checksums replaces the package version in build/pkgs/<package-name>/package-version.txt and checksums.ini
 
-An example of the result can be found in comment 27 of [http://trac.sagemath.org/ticket/16611](http://trac.sagemath.org/ticket/16611). It is also germane to [http://trac.sagemath.org/ticket/16489](http://trac.sagemath.org/ticket/16489).
 
 Comment: 1
 
```




---

archive/issue_comments_229220.json:
```json
{
    "body": "<a id='comment:26'></a>Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.\n\nAnd fix the indentation please: no TABS, use indents of 4 spaces\n\nAnd I would like to add an additional change:\n\n```\nupstream_pkg_name=${tarball%-*}\n```\nshould become\n\n```\nupstream_pkg_name=${tarball%%-*}\n```\nto allow upstream versions with dashes (package-abc-1 should have package name \"package\" and version \"abc-1\").",
    "created_at": "2014-09-17T10:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.

And fix the indentation please: no TABS, use indents of 4 spaces

And I would like to add an additional change:

```
upstream_pkg_name=${tarball%-*}
```
should become

```
upstream_pkg_name=${tarball%%-*}
```
to allow upstream versions with dashes (package-abc-1 should have package name "package" and version "abc-1").



---

archive/issue_comments_229221.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-01T11:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229222.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:\n> Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.\n\n\nDone\n\n> And fix the indentation please: no TABS, use indents of 4 spaces\n\n\nAlso done. Although I wonder why this recommendation, which is sensible for python (and sage) programs, should apply to shell scripts, which are a horse of a totally different color...\n\n> And I would like to add an additional change:\n> \n> ```\n> upstream_pkg_name=${tarball%-*}\n> ```\n> should become\n> \n> ```\n> upstream_pkg_name=${tarball%%-*}\n> ```\n> to allow upstream versions with dashes (package-abc-1 should have package name \"package\" and version \"abc-1\").\n\n\nAlso done (although I'm not sure of the pertinence...).\n\nHTH,",
    "created_at": "2014-12-01T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229222",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:
> Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.


Done

> And fix the indentation please: no TABS, use indents of 4 spaces


Also done. Although I wonder why this recommendation, which is sensible for python (and sage) programs, should apply to shell scripts, which are a horse of a totally different color...

> And I would like to add an additional change:
> 
> ```
> upstream_pkg_name=${tarball%-*}
> ```
> should become
> 
> ```
> upstream_pkg_name=${tarball%%-*}
> ```
> to allow upstream versions with dashes (package-abc-1 should have package name "package" and version "abc-1").


Also done (although I'm not sure of the pertinence...).

HTH,



---

archive/issue_comments_229223.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The current version of sage-fix-pkg-checksums incorrectly sets the package version to the *litteral* \"VERSION\" in checksums.ini, which is confusing and not helpful. Curiously, this is still (sort of) functional.\n \n+This patch correcly computes the version string and puts it at the right place in checksums.ini.\n \n Comment: 1\n \n```\n",
    "created_at": "2014-12-01T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229223",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The current version of sage-fix-pkg-checksums incorrectly sets the package version to the *litteral* "VERSION" in checksums.ini, which is confusing and not helpful. Curiously, this is still (sort of) functional.
 
+This patch correcly computes the version string and puts it at the right place in checksums.ini.
 
 Comment: 1
 
```




---

archive/issue_comments_229224.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-12-01T11:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229224",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_229225.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `\"VERSION\"` in `checksums.ini`, which is confusing and not helpful.\n \n+This patch correcly computes the version string and puts it at the right place in `checksums.ini`.\n \n Comment: 1\n \n```\n",
    "created_at": "2014-12-01T22:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229225",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `"VERSION"` in `checksums.ini`, which is confusing and not helpful.
 
+This patch correcly computes the version string and puts it at the right place in `checksums.ini`.
 
 Comment: 1
 
```




---

archive/issue_comments_229226.json:
```json
{
    "body": "Replying to [ticket:16629 charpent]:\n> The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `\"VERSION\"` in `checksums.ini`, which is confusing and not helpful.\n\nIt's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.",
    "created_at": "2014-12-01T22:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229226",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:16629 charpent]:
> The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `"VERSION"` in `checksums.ini`, which is confusing and not helpful.

It's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.



---

archive/issue_comments_229227.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-12-01T22:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229227",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_229228.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:29 jdemeyer]:\n> Replying to [ticket:16629 charpent]:\n> > The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `\"VERSION\"` in `checksums.ini`, which is confusing and not helpful.\n\n> It's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.\nSo, you think it's wontfix?",
    "created_at": "2015-04-12T14:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229228",
    "user": "https://github.com/rwst"
}
```

<a id='comment:32'></a>Replying to [comment:29 jdemeyer]:
> Replying to [ticket:16629 charpent]:
> > The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the **literal** `"VERSION"` in `checksums.ini`, which is confusing and not helpful.

> It's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.
So, you think it's wontfix?



---

archive/issue_comments_229229.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-04-12T14:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229229",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_events_048770.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-22T09:31:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16629#event-48770"
}
```



---

archive/issue_events_048771.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-22T09:31:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16629#event-48771"
}
```



---

archive/issue_comments_229230.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2015-04-22T09:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229230",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_events_048772.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-23T01:43:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16629#event-48772"
}
```



---

archive/issue_comments_229231.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2015-04-23T01:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16629#issuecomment-229231",
    "user": "https://github.com/vbraun"
}
```

Resolution: wontfix
