# Issue 16353: A cached_function with selective memory

archive/issues_016116.json:
```json
{
    "body": "Here is a new `input_filter` argument for cached functions which makes it remember only \"some\" output, depending on the input.\n\nNathann\n\nCC:  @dkrenn @videlec\n\nBranch: u/ncohen/16353\n\nStatus: needs_work\n\nCommit: 7eb8f900f1a143c6cc85b9382a365b57a9c42ecc\n\nIssue created by migration from https://trac.sagemath.org/ticket/16353\n\n",
    "created_at": "2014-05-14T14:57:32Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "A cached_function with selective memory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16353",
    "user": "https://github.com/nathanncohen"
}
```
Here is a new `input_filter` argument for cached functions which makes it remember only "some" output, depending on the input.

Nathann

CC:  @dkrenn @videlec

Branch: u/ncohen/16353

Status: needs_work

Commit: 7eb8f900f1a143c6cc85b9382a365b57a9c42ecc

Issue created by migration from https://trac.sagemath.org/ticket/16353





---

archive/issue_comments_268625.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-14T14:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268625",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_268626.json:
```json
{
    "body": "Changing branch from \"\" to \"u/ncohen/16353\"",
    "created_at": "2014-05-14T14:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268626",
    "user": "https://github.com/nathanncohen"
}
```

Changing branch from "" to "u/ncohen/16353"



---

archive/issue_comments_268627.json:
```json
{
    "body": "Changing commit from \"\" to \"e06b947ab12f9f754363847c996b251f5682c125\"",
    "created_at": "2014-05-14T14:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268627",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "e06b947ab12f9f754363847c996b251f5682c125"



---

archive/issue_comments_268628.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-14T14:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268629.json:
```json
{
    "body": "<a id='comment:3'></a>-1 because it isn't needed and only serves to facilitate bad code designs",
    "created_at": "2014-05-14T15:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268629",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>-1 because it isn't needed and only serves to facilitate bad code designs



---

archive/issue_comments_268630.json:
```json
{
    "body": "<a id='comment:4'></a>> -1 because it isn't needed and only serves to facilitate bad code designs\n\n\nDaniel Krenn said on the mailing list that it would help him. -1 to dishonest comments. By the way, I still do not know how to avoid this bad design, but we can continue discussing it on the sage-devel thread, I am genuinely interested.\n\nNathann",
    "created_at": "2014-05-14T15:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268630",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>> -1 because it isn't needed and only serves to facilitate bad code designs


Daniel Krenn said on the mailing list that it would help him. -1 to dishonest comments. By the way, I still do not know how to avoid this bad design, but we can continue discussing it on the sage-devel thread, I am genuinely interested.

Nathann



---

archive/issue_comments_268631.json:
```json
{
    "body": "<a id='comment:5'></a>By the way I don't get how you can say that a feature like \"only cache small results\" is not useful.\n\nNathann",
    "created_at": "2014-05-14T15:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268631",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>By the way I don't get how you can say that a feature like "only cache small results" is not useful.

Nathann



---

archive/issue_comments_268632.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [vbraun](#comment%3A3):\n> -1 because it isn't needed and only serves to facilitate bad code designs\n\n\nCould you argue that? \n\nI could easily imagine some could code which are usually use to compute small things but some crazy researcher could want compute big things (one times) and be exhaustive on those big things...",
    "created_at": "2014-05-14T15:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268632",
    "user": "https://trac.sagemath.org/admin/accounts/users/elixyre"
}
```

<a id='comment:6'></a>Replying to [vbraun](#comment%3A3):
> -1 because it isn't needed and only serves to facilitate bad code designs


Could you argue that? 

I could easily imagine some could code which are usually use to compute small things but some crazy researcher could want compute big things (one times) and be exhaustive on those big things...



---

archive/issue_comments_268633.json:
```json
{
    "body": "<a id='comment:7'></a>-1 for feature creep. People use `cached_function/cached_method` to be *fast*. Adding another parameter/filter slows things down.\n\n-1 for obscuring serious programming logic: in any non-trivial situation, you need a strategy to decide which inputs do need caching and which don't. The strategy there will need tuning and/or may have to change depending on application. Something like that shouldn't be hidden in a decorator that you slap on a function. That strategy could probably do a much better job if it's properly integrated with the rest of the code, and not just has a preview by peeking at the input parameters.\n\nI think it's a code smell when this seems attractive: some things seem worthwhile to cache but generally it's too expensive. The \"worthwhile\" part is coming from your particular application, so THAT is where you should cache or probably more appropriately: where you should build a data structure that stores the required intermediate results.",
    "created_at": "2014-05-14T15:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268633",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>-1 for feature creep. People use `cached_function/cached_method` to be *fast*. Adding another parameter/filter slows things down.

-1 for obscuring serious programming logic: in any non-trivial situation, you need a strategy to decide which inputs do need caching and which don't. The strategy there will need tuning and/or may have to change depending on application. Something like that shouldn't be hidden in a decorator that you slap on a function. That strategy could probably do a much better job if it's properly integrated with the rest of the code, and not just has a preview by peeking at the input parameters.

I think it's a code smell when this seems attractive: some things seem worthwhile to cache but generally it's too expensive. The "worthwhile" part is coming from your particular application, so THAT is where you should cache or probably more appropriately: where you should build a data structure that stores the required intermediate results.



---

archive/issue_comments_268634.json:
```json
{
    "body": "<a id='comment:8'></a>> -1 for feature creep. People use `cached_function/cached_method` to be *fast*. Adding another parameter/filter slows things down.\n\n\nIf there was not a \"key\" parameter to normalize the input I would have agreed with that. Please tell me why this feature is needed and \"clean\" and not mine. I was looking at it while I wrote this patch, and the cost of mine is less important.\n\n> -1 for obscuring serious programming logic: in any non-trivial situation, you need a strategy to decide which inputs do need caching and which don't. The strategy there will need tuning and/or may have to change depending on application. Something like that shouldn't be hidden in a decorator that you slap on a function. That strategy could probably do a much better job if it's properly integrated with the rest of the code, and not just has a preview by peeking at the input parameters.\n\n\nYou can define the filter wherever you want, and make it as long and complicated as you want. And when you have defined it, how do you plan on making \"cached_method\" behave according to it except through the decorator ?\n\n> I think it's a code smell when this seems attractive:\n\n\nCome on guy, caching the output of calls which give a small output does not seem that far fetched. Why can't you see it ?\n\n> some things seem worthwhile to cache but generally it's too expensive.\n\n\nIndeed. I want to filter them out.\n\nNathann",
    "created_at": "2014-05-14T16:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268634",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>> -1 for feature creep. People use `cached_function/cached_method` to be *fast*. Adding another parameter/filter slows things down.


If there was not a "key" parameter to normalize the input I would have agreed with that. Please tell me why this feature is needed and "clean" and not mine. I was looking at it while I wrote this patch, and the cost of mine is less important.

> -1 for obscuring serious programming logic: in any non-trivial situation, you need a strategy to decide which inputs do need caching and which don't. The strategy there will need tuning and/or may have to change depending on application. Something like that shouldn't be hidden in a decorator that you slap on a function. That strategy could probably do a much better job if it's properly integrated with the rest of the code, and not just has a preview by peeking at the input parameters.


You can define the filter wherever you want, and make it as long and complicated as you want. And when you have defined it, how do you plan on making "cached_method" behave according to it except through the decorator ?

> I think it's a code smell when this seems attractive:


Come on guy, caching the output of calls which give a small output does not seem that far fetched. Why can't you see it ?

> some things seem worthwhile to cache but generally it's too expensive.


Indeed. I want to filter them out.

Nathann



---

archive/issue_comments_268635.json:
```json
{
    "body": "<a id='comment:9'></a>If none of what we've suggested so far on sage-devel appears to fit, I still think your algorithm or function(s) isn't designed well, and you can always implement your custom cache explicitly with a few lines of code (including some projective cache which just stores whether a solution exists, but not the solution itself, in case you want to stay with the boolean `existence` parameter).\n\n\n\n\nOtherwise I'd suggest to probabky implement *a different* decorator instead.",
    "created_at": "2014-05-14T18:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268635",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>If none of what we've suggested so far on sage-devel appears to fit, I still think your algorithm or function(s) isn't designed well, and you can always implement your custom cache explicitly with a few lines of code (including some projective cache which just stores whether a solution exists, but not the solution itself, in case you want to stay with the boolean `existence` parameter).




Otherwise I'd suggest to probabky implement *a different* decorator instead.



---

archive/issue_comments_268636.json:
```json
{
    "body": "<a id='comment:10'></a>Just my 2 cents: I could see use cases for this feature. In particular if the caching strategy could be made configurable at runtime by the user:\n\n```\nclass XXX:\n    @cached_method\n    def f(...): ...\n\nXXX.f.set_input_filter(...)\n```\n\nSo if this can be implemented without slowing down the standard use case, I don't see why not?\n\nIf the current implementation is deemed to introduce too large of an overhead (time+memory with the extra slot), an alternative might be to  implement this feature in a subclass, have `set_input_filter` change the class of the cached method to this subclass if needed, and have `__init__` call `set_input_filter` when relevant? If it's all pure Cython maybe changing the class is not an option; in this case we would need to choose the class once for all in the factory function, before `__init__` is called.\n\nCheers,\n                                     Nicolas",
    "created_at": "2014-05-16T15:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268636",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:10'></a>Just my 2 cents: I could see use cases for this feature. In particular if the caching strategy could be made configurable at runtime by the user:

```
class XXX:
    @cached_method
    def f(...): ...

XXX.f.set_input_filter(...)
```

So if this can be implemented without slowing down the standard use case, I don't see why not?

If the current implementation is deemed to introduce too large of an overhead (time+memory with the extra slot), an alternative might be to  implement this feature in a subclass, have `set_input_filter` change the class of the cached method to this subclass if needed, and have `__init__` call `set_input_filter` when relevant? If it's all pure Cython maybe changing the class is not an option; in this case we would need to choose the class once for all in the factory function, before `__init__` is called.

Cheers,
                                     Nicolas



---

archive/issue_comments_268637.json:
```json
{
    "body": "<a id='comment:11'></a>Thats still crazy, decorators are a useful metaprogramming tool but you are essentially creating two function bodies that don't / can't talk to each other. If you really want to have a decorator to help with managing the cache then make the decision to cache available inside the function body. E.g.\n\n```python\n@sometimes_cached_function\ndef bar(x, y, z):\n   w = do_long_computation(x, y, z)\n   if want_to_cache(x, y, z, w):\n      bar.set_cache((x, y, z), w)  \n      # or some variation thereof that uses the original arguments\n   return w\n```\nThough really the advantage over \n\n```python\nbar_cache = dict()\n\ndef bar(x, y, z):\n    try:\n        return bar_cache[(x,y,z)]\n    except KeyError: \n        w = do_long_computation(x, y, z)\n    if want_to_cache(x,y,z,w):\n        bar_cache[(x,y,z)] = w \n    return w\n```\nis pretty slim. You save maybe 2 lines at the expense of making it harder to understand to somebody who doesn't know about the memoization machinery.",
    "created_at": "2014-05-16T23:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268637",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>Thats still crazy, decorators are a useful metaprogramming tool but you are essentially creating two function bodies that don't / can't talk to each other. If you really want to have a decorator to help with managing the cache then make the decision to cache available inside the function body. E.g.

```python
@sometimes_cached_function
def bar(x, y, z):
   w = do_long_computation(x, y, z)
   if want_to_cache(x, y, z, w):
      bar.set_cache((x, y, z), w)  
      # or some variation thereof that uses the original arguments
   return w
```
Though really the advantage over 

```python
bar_cache = dict()

def bar(x, y, z):
    try:
        return bar_cache[(x,y,z)]
    except KeyError: 
        w = do_long_computation(x, y, z)
    if want_to_cache(x,y,z,w):
        bar_cache[(x,y,z)] = w 
    return w
```
is pretty slim. You save maybe 2 lines at the expense of making it harder to understand to somebody who doesn't know about the memoization machinery.



---

archive/issue_comments_268638.json:
```json
{
    "body": "<a id='comment:12'></a>I agree that the fact that the two functions can't talk is a limitation. But on the other hand having two functions that clearly decouples the two logics (how to compute / when to cache) does bring something. Especially if it makes the caching strategy user configurable.",
    "created_at": "2014-05-17T07:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268638",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:12'></a>I agree that the fact that the two functions can't talk is a limitation. But on the other hand having two functions that clearly decouples the two logics (how to compute / when to cache) does bring something. Especially if it makes the caching strategy user configurable.



---

archive/issue_comments_268639.json:
```json
{
    "body": "<a id='comment:13'></a>Here is a new version which creates a new class. This way nobody is hurt and the feature exists !\n\nNathann",
    "created_at": "2014-06-05T15:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268639",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'></a>Here is a new version which creates a new class. This way nobody is hurt and the feature exists !

Nathann



---

archive/issue_comments_268640.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-06-05T15:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_268641.json:
```json
{
    "body": "Changing commit from \"e06b947ab12f9f754363847c996b251f5682c125\" to \"5beca48866f16c29e71a00ae0f9bbfe6eaa80e50\"",
    "created_at": "2014-06-05T15:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268641",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e06b947ab12f9f754363847c996b251f5682c125" to "5beca48866f16c29e71a00ae0f9bbfe6eaa80e50"



---

archive/issue_comments_268642.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-06-05T15:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_268643.json:
```json
{
    "body": "Changing commit from \"5beca48866f16c29e71a00ae0f9bbfe6eaa80e50\" to \"7eb8f900f1a143c6cc85b9382a365b57a9c42ecc\"",
    "created_at": "2014-06-05T15:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268643",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5beca48866f16c29e71a00ae0f9bbfe6eaa80e50" to "7eb8f900f1a143c6cc85b9382a365b57a9c42ecc"



---

archive/issue_comments_268644.json:
```json
{
    "body": "<a id='comment:16'></a>comment:11 still applies",
    "created_at": "2014-06-05T15:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268644",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>comment:11 still applies



---

archive/issue_comments_268645.json:
```json
{
    "body": "<a id='comment:17'></a>> comment:11 still applies\n\n\nYou are welcome to implement what you suggest, for I do not know how to write it. I need the feature I implemented and it is sufficient for my needs. \n\nNathann",
    "created_at": "2014-06-05T15:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268645",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:17'></a>> comment:11 still applies


You are welcome to implement what you suggest, for I do not know how to write it. I need the feature I implemented and it is sufficient for my needs. 

Nathann



---

archive/issue_comments_268646.json:
```json
{
    "body": "<a id='comment:18'></a>What do you need it for? The original use case that you presented on sage-devel is IMHO invalid.",
    "created_at": "2014-06-05T15:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268646",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>What do you need it for? The original use case that you presented on sage-devel is IMHO invalid.



---

archive/issue_comments_268647.json:
```json
{
    "body": "<a id='comment:19'></a>> What do you need it for? The original use case that you presented on sage-devel is IMHO invalid.\n\n\nVolker, aren't you tired of this ? I need this function, you know it can be useful, you know what I need it for, are you going to prevent me from adding a function because of what I want to use it FOR ?\n\nNathann",
    "created_at": "2014-06-05T15:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268647",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'></a>> What do you need it for? The original use case that you presented on sage-devel is IMHO invalid.


Volker, aren't you tired of this ? I need this function, you know it can be useful, you know what I need it for, are you going to prevent me from adding a function because of what I want to use it FOR ?

Nathann



---

archive/issue_comments_268648.json:
```json
{
    "body": "<a id='comment:20'></a>I told you already on sage-devel that you don't need this, the sooner you refactor your code to use sane function names the quicker we can close this ticket as invalid.",
    "created_at": "2014-06-05T15:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268648",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>I told you already on sage-devel that you don't need this, the sooner you refactor your code to use sane function names the quicker we can close this ticket as invalid.



---

archive/issue_comments_268649.json:
```json
{
    "body": "<a id='comment:21'></a>> I told you already on sage-devel that you don't need this, the sooner you refactor your code to use sane function names the quicker we can close this ticket as invalid.\n\n\nThis ticket is not invalid, this ticket implements a feature I need, and a feature that several other developpers acknowledged as being potentially useful. I don't even get how you can honestly deny that filtering what is being cached, even if the two functions \"don't talk\", can be useful.\n\nStop this game and look at the code. It does not slow anything down because it is a new class, it solves my problem and it is clearly the kind of stuff that other persons may need too. There's no reason to refuse it a priori.\n\nNathann",
    "created_at": "2014-06-05T15:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268649",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:21'></a>> I told you already on sage-devel that you don't need this, the sooner you refactor your code to use sane function names the quicker we can close this ticket as invalid.


This ticket is not invalid, this ticket implements a feature I need, and a feature that several other developpers acknowledged as being potentially useful. I don't even get how you can honestly deny that filtering what is being cached, even if the two functions "don't talk", can be useful.

Stop this game and look at the code. It does not slow anything down because it is a new class, it solves my problem and it is clearly the kind of stuff that other persons may need too. There's no reason to refuse it a priori.

Nathann



---

archive/issue_comments_268650.json:
```json
{
    "body": "<a id='comment:22'></a>Even if you would need this functionality (you don't), there is no reason to lock us into a memoization api that (even you agree) isn't good.",
    "created_at": "2014-06-05T16:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268650",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>Even if you would need this functionality (you don't), there is no reason to lock us into a memoization api that (even you agree) isn't good.



---

archive/issue_comments_268651.json:
```json
{
    "body": "<a id='comment:23'></a>> Even if you would need this functionality (you don't), there is no reason to lock us into a memoization api that (even you agree) isn't good.\n\n\nOkay. Now it's my turn. I claim that you are an eagle with 15 arms and 36 beaks, and that you own a pink bright camping-car parked right under the Eiffel Tower. The cops called you yesterday at 10:34, 11:34 and 15:30 and you refused to answer their questions pretending that you had gone mute the day before\n\nTruths:\n\n1) I need this feature. There's nobody that can assert it with more certainty than I. You can say that I don't many times, and truth be told, it changes nothing to the fact that I am still stuck if I can't do that.\n\n2) I have absolutely nothing against the caching method I implement, and I never said that it was not good. I would not write a branch if I thought it was not good and useful for Sage.\n\nStop talking nonsense.\n\nNathann",
    "created_at": "2014-06-05T16:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268651",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:23'></a>> Even if you would need this functionality (you don't), there is no reason to lock us into a memoization api that (even you agree) isn't good.


Okay. Now it's my turn. I claim that you are an eagle with 15 arms and 36 beaks, and that you own a pink bright camping-car parked right under the Eiffel Tower. The cops called you yesterday at 10:34, 11:34 and 15:30 and you refused to answer their questions pretending that you had gone mute the day before

Truths:

1) I need this feature. There's nobody that can assert it with more certainty than I. You can say that I don't many times, and truth be told, it changes nothing to the fact that I am still stuck if I can't do that.

2) I have absolutely nothing against the caching method I implement, and I never said that it was not good. I would not write a branch if I thought it was not good and useful for Sage.

Stop talking nonsense.

Nathann



---

archive/issue_comments_268652.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [ncohen](#comment%3A23):\n> Okay. Now it's my turn. I claim that you are an eagle with 15 arms and 36 beaks, and that you own a pink bright camping-car parked right under the Eiffel Tower. The cops called you yesterday at 10:34, 11:34 and 15:30 and you refused to answer their questions pretending that you had gone mute the day before\n\n\nAaahh I thought that the guy hiding in the shadows looked like you ;-)\n\n> 1) I need this feature.\n\n\nNo. You happen to have a hammer in your hand, and now everything looks vaguely similar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.",
    "created_at": "2014-06-05T16:42:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268652",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>Replying to [ncohen](#comment%3A23):
> Okay. Now it's my turn. I claim that you are an eagle with 15 arms and 36 beaks, and that you own a pink bright camping-car parked right under the Eiffel Tower. The cops called you yesterday at 10:34, 11:34 and 15:30 and you refused to answer their questions pretending that you had gone mute the day before


Aaahh I thought that the guy hiding in the shadows looked like you ;-)

> 1) I need this feature.


No. You happen to have a hammer in your hand, and now everything looks vaguely similar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.



---

archive/issue_comments_268653.json:
```json
{
    "body": "<a id='comment:25'></a>> No. You happen to have a hammer in your hand, and now everything looks vaguely familiar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.\n\n\nReview this patch of write a better code. This branch implements a mechanism to decide which answers will be cached, and it can be used to only cache the most useful answers of a recursive function.\n\nNathann",
    "created_at": "2014-06-05T16:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268653",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:25'></a>> No. You happen to have a hammer in your hand, and now everything looks vaguely familiar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.


Review this patch of write a better code. This branch implements a mechanism to decide which answers will be cached, and it can be used to only cache the most useful answers of a recursive function.

Nathann



---

archive/issue_comments_268654.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-Here is a new `input_filter` argument for cached functions which makes it remember only \"some\" output, depending on the input. This should not be too ressource-consuming.\n+Here is a new `input_filter` argument for cached functions which makes it remember only \"some\" output, depending on the input.\n \n Nathann\n``````\n",
    "created_at": "2014-06-05T16:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268654",
    "user": "https://github.com/nathanncohen"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-Here is a new `input_filter` argument for cached functions which makes it remember only "some" output, depending on the input. This should not be too ressource-consuming.
+Here is a new `input_filter` argument for cached functions which makes it remember only "some" output, depending on the input.
 
 Nathann
``````




---

archive/issue_comments_268655.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [ncohen](#comment%3A25):\n> [snip]... and it can be used to only cache the most useful answers of a recursive function.\n> \n  \nHow do you tell which values are the most useful? Except no-argument functions, I usually don't like the wide spread of cached_method in Sage. One caching strategy that I find useful in practice for recursive functions is LRU (least recently used) cache. In Python 3 it is implement in the functools module: https://docs.python.org/3/library/functools.html#functools.lru_cache and for Python 2 there are already several implementations, like the backport at http://code.activestate.com/recipes/578078-py26-and-py30-backport-of-python-33s-lru-cache/.",
    "created_at": "2014-06-05T21:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268655",
    "user": "https://github.com/mathzeta"
}
```

<a id='comment:27'></a>Replying to [ncohen](#comment%3A25):
> [snip]... and it can be used to only cache the most useful answers of a recursive function.
> 
  
How do you tell which values are the most useful? Except no-argument functions, I usually don't like the wide spread of cached_method in Sage. One caching strategy that I find useful in practice for recursive functions is LRU (least recently used) cache. In Python 3 it is implement in the functools module: https://docs.python.org/3/library/functools.html#functools.lru_cache and for Python 2 there are already several implementations, like the backport at http://code.activestate.com/recipes/578078-py26-and-py30-backport-of-python-33s-lru-cache/.



---

archive/issue_comments_268656.json:
```json
{
    "body": "<a id='comment:28'></a>Yo !\n\n> How do you tell which values are the most useful?\n\n\nI do not know in general, it depends on the function you are decorating.\n\nNathann",
    "created_at": "2014-06-06T09:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268656",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:28'></a>Yo !

> How do you tell which values are the most useful?


I do not know in general, it depends on the function you are decorating.

Nathann



---

archive/issue_comments_268657.json:
```json
{
    "body": "<a id='comment:29'></a>> > 1) I need this feature.\n\n> \n> No. You happen to have a hammer in your hand, and now everything looks vaguely similar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.\n\n\nThen write the more elegant solution.  I agree that we can have feature creep at times, and I'm sure ncohen does too, based on many comments on sage-devel.  But if there is some canonical way to do some specific example of Nathann's (obviously not the toy cases in the doctest here) then let's add *that* to the documentation, so that when other people who want to do what he does show up, they can look at a well-annotated example of why it's so horrible to do this filtering.  There's no need to browbeat.\n\n> I don't even get how you can honestly deny that filtering what is being cached, even if the two functions \"don't talk\", can be useful.\n\n\nYeah, I'm not sure why this can't be useful either, even if for some reason it doesn't need a new decorator.  As a non-cache-expert, I guess Volker's suggestion of\n\n```\nbar_cache = dict()\n\ndef bar(x, y, z):\n    try:\n        return bar_cache[(x,y,z)]\n    except KeyError: \n        w = do_long_computation(x, y, z)\n    if want_to_cache(x,y,z,w):\n        bar_cache[(x,y,z)] = w \n    return w\n```\nseems fine too, especially if documented somewhere.  There has to be some compromise here; it's not *that* important.  (As opposed to rewriting Sage in Ruby or something.)  \n\n---\n\nNaturally, I have no ball in the technicalities of this game.  I **do** have a ball in the game of people getting along enough to not squabble and get personal over this stuff.  [\"The open source community is just so fricking nice\"](https://plus.google.com/110464871801965858778/posts/LTnYFQg1fnc) is what we want people to think about when they think of Sage community.",
    "created_at": "2014-06-06T14:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268657",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:29'></a>> > 1) I need this feature.

> 
> No. You happen to have a hammer in your hand, and now everything looks vaguely similar to nails. Trust me, not everything is a nail and there are more elegant solutions to your problem.


Then write the more elegant solution.  I agree that we can have feature creep at times, and I'm sure ncohen does too, based on many comments on sage-devel.  But if there is some canonical way to do some specific example of Nathann's (obviously not the toy cases in the doctest here) then let's add *that* to the documentation, so that when other people who want to do what he does show up, they can look at a well-annotated example of why it's so horrible to do this filtering.  There's no need to browbeat.

> I don't even get how you can honestly deny that filtering what is being cached, even if the two functions "don't talk", can be useful.


Yeah, I'm not sure why this can't be useful either, even if for some reason it doesn't need a new decorator.  As a non-cache-expert, I guess Volker's suggestion of

```
bar_cache = dict()

def bar(x, y, z):
    try:
        return bar_cache[(x,y,z)]
    except KeyError: 
        w = do_long_computation(x, y, z)
    if want_to_cache(x,y,z,w):
        bar_cache[(x,y,z)] = w 
    return w
```
seems fine too, especially if documented somewhere.  There has to be some compromise here; it's not *that* important.  (As opposed to rewriting Sage in Ruby or something.)  

---

Naturally, I have no ball in the technicalities of this game.  I **do** have a ball in the game of people getting along enough to not squabble and get personal over this stuff.  ["The open source community is just so fricking nice"](https://plus.google.com/110464871801965858778/posts/LTnYFQg1fnc) is what we want people to think about when they think of Sage community.



---

archive/issue_comments_268658.json:
```json
{
    "body": "<a id='comment:30'></a>I did sketch how to organize Nathan's original code already at https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/OswLwqsMJKcJ. I can make the actual change if Nathan doesn't want do it himself... Honestly, the filtering feature proposed here is only useful to enable dummy flags as arguments to functions to change their behaviour:\n\n```\n@cached_function(filter=lambda x,dummy: dummy)\ndef foo(x, dummy=False):\n    if dummy:\n        return bar(x)\n    else:\n        return baz(x)\n```\nIf you want to cache bar and not baz then just provide two different functions. And if you can't split up the function easily because they are multiple-page case switches then you need to refactor them regardless of the caching.",
    "created_at": "2014-06-06T14:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268658",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>I did sketch how to organize Nathan's original code already at https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/OswLwqsMJKcJ. I can make the actual change if Nathan doesn't want do it himself... Honestly, the filtering feature proposed here is only useful to enable dummy flags as arguments to functions to change their behaviour:

```
@cached_function(filter=lambda x,dummy: dummy)
def foo(x, dummy=False):
    if dummy:
        return bar(x)
    else:
        return baz(x)
```
If you want to cache bar and not baz then just provide two different functions. And if you can't split up the function easily because they are multiple-page case switches then you need to refactor them regardless of the caching.



---

archive/issue_comments_268659.json:
```json
{
    "body": "<a id='comment:31'></a>> I did sketch how to organize Nathan's original code already at https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/OswLwqsMJKcJ.\n\n\nWhat I find interesting about this is the quote\n> > No. The tests of the work_for_case_x function go to that function. This ties\n> > the tests much better to the implementation than what you currently have.\n\n> I agree with that and implemented it earlier but it was refused during a review.\nso maybe some of the problem is external to this particular ticket?  Maybe in the other review one could ask for a second opinion from elsewhere, always a reasonable thing to do.\n> designs.orthogonal_array doesn't return some kind of array\n\nProbably that is the real problem.  In the current stable branch,\n\n```\ndef orthogonal_array(k,n,t=2,check=True):\n    r\"\"\"\n    Return an orthogonal array of parameters `k,n,t`.\n```\nAnd I don't see anywhere in the code, or doctested, that you should get a boolean or an integer.  This must be a recent thing (I do see it in 6.3.beta3) and I would definitely agree that was bad design.  It seems that #16286 and #15310 were the culprits, I have found it now.  (Note to Volker - all those git-induced commits made it very, very hard to track down what should have been extremely straightforward in such a new file!  Oh well, I'll get there eventually.)\n\n---\n\nThat doesn't mean one can't have a cache with selective memory, but maybe we can disentangle that from the very strange decision made there.",
    "created_at": "2014-06-06T16:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268659",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:31'></a>> I did sketch how to organize Nathan's original code already at https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/OswLwqsMJKcJ.


What I find interesting about this is the quote
> > No. The tests of the work_for_case_x function go to that function. This ties
> > the tests much better to the implementation than what you currently have.

> I agree with that and implemented it earlier but it was refused during a review.
so maybe some of the problem is external to this particular ticket?  Maybe in the other review one could ask for a second opinion from elsewhere, always a reasonable thing to do.
> designs.orthogonal_array doesn't return some kind of array

Probably that is the real problem.  In the current stable branch,

```
def orthogonal_array(k,n,t=2,check=True):
    r"""
    Return an orthogonal array of parameters `k,n,t`.
```
And I don't see anywhere in the code, or doctested, that you should get a boolean or an integer.  This must be a recent thing (I do see it in 6.3.beta3) and I would definitely agree that was bad design.  It seems that #16286 and #15310 were the culprits, I have found it now.  (Note to Volker - all those git-induced commits made it very, very hard to track down what should have been extremely straightforward in such a new file!  Oh well, I'll get there eventually.)

---

That doesn't mean one can't have a cache with selective memory, but maybe we can disentangle that from the very strange decision made there.



---

archive/issue_comments_268660.json:
```json
{
    "body": "<a id='comment:32'></a>Okay, see [here](https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/NlNpbHG9-sEJ) for some other thoughts on the 'orthogonal' (pun intended) question of this.",
    "created_at": "2014-06-06T16:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268660",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:32'></a>Okay, see [here](https://groups.google.com/d/msg/sage-devel/OPe5VJpBiB4/NlNpbHG9-sEJ) for some other thoughts on the 'orthogonal' (pun intended) question of this.



---

archive/issue_comments_268661.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-06T16:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268661",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_048188.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2014-06-06T16:52:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16353#event-48188"
}
```



---

archive/issue_comments_268662.json:
```json
{
    "body": "<a id='comment:33'></a>Okay guys, you won again ! I will just write three times the same caching mechanism in three different functions, as it is clearly a better design.\n\nNathann",
    "created_at": "2014-06-06T16:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268662",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:33'></a>Okay guys, you won again ! I will just write three times the same caching mechanism in three different functions, as it is clearly a better design.

Nathann



---

archive/issue_events_048189.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2014-06-07T00:53:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16353#event-48189"
}
```



---

archive/issue_events_048190.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2014-06-07T00:53:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16353#event-48190"
}
```



---

archive/issue_comments_268663.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-06-07T00:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268663",
    "user": "https://github.com/kcrisman"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_268664.json:
```json
{
    "body": "<a id='comment:34'></a>> Okay guys, you won again ! I will just write three times the same caching mechanism in three different functions, as it is clearly a better design.\n\n?  I'm just going to point out that I didn't say anything about caching design (just asked naive questions).  Just about finding some compromise.  I'm sure something useful and agreeable will come out of this, even if it's from someone else taking up the code later.",
    "created_at": "2014-06-07T00:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268664",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:34'></a>> Okay guys, you won again ! I will just write three times the same caching mechanism in three different functions, as it is clearly a better design.

?  I'm just going to point out that I didn't say anything about caching design (just asked naive questions).  Just about finding some compromise.  I'm sure something useful and agreeable will come out of this, even if it's from someone else taking up the code later.



---

archive/issue_comments_268665.json:
```json
{
    "body": "<a id='comment:35'></a>Just adding something : unless this ticket is reviewed I will have to implement the caching method manually in 4 different functions.\n\nI also forgot to add another reason for having a function like that :\n\nA cached function cannot (safely) return mutable answers. If you return a list and that the user modifies the list, then it also modifies the list stored in the function's cache.\n\nThus, as my functions return some mutable answers (lists) which I do not want to cache but I am forced to, I have to turn them into tuples before returning them (which again triggers useless copies later). With the 10 lines from this branch I would be able to say that I don't want to cache those answers. Which I never wanted to cache anyway.\n\nJust saying...\n\nNathann",
    "created_at": "2014-06-08T18:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268665",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:35'></a>Just adding something : unless this ticket is reviewed I will have to implement the caching method manually in 4 different functions.

I also forgot to add another reason for having a function like that :

A cached function cannot (safely) return mutable answers. If you return a list and that the user modifies the list, then it also modifies the list stored in the function's cache.

Thus, as my functions return some mutable answers (lists) which I do not want to cache but I am forced to, I have to turn them into tuples before returning them (which again triggers useless copies later). With the 10 lines from this branch I would be able to say that I don't want to cache those answers. Which I never wanted to cache anyway.

Just saying...

Nathann



---

archive/issue_comments_268666.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [ncohen](#comment%3A35):\n> Just adding something : unless this ticket is reviewed I will have to implement the caching method manually in 4 different functions.\n> \n> I also forgot to add another reason for having a function like that :\n> \n> A cached function cannot (safely) return mutable answers. If you return a list and that the user modifies the list, then it also modifies the list stored in the function's cache.\n\n\nYou are right in noting that. You could of course document that the result returned shouldn't be modified (but instead copied if modification is needed), and that is probably the most efficient solution for an internal routine, where the caller can then make a copy only when necessary. And indeed, you can enforce (one level at the time) by using tuples.\n\nIf you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)\n\nIt seems to me that this additional motivation for using the decorator provides another argument *against* the utility and wisdom of the proposed decorator for producing clear, readable, and maintainable code.",
    "created_at": "2014-06-08T19:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268666",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:36'></a>Replying to [ncohen](#comment%3A35):
> Just adding something : unless this ticket is reviewed I will have to implement the caching method manually in 4 different functions.
> 
> I also forgot to add another reason for having a function like that :
> 
> A cached function cannot (safely) return mutable answers. If you return a list and that the user modifies the list, then it also modifies the list stored in the function's cache.


You are right in noting that. You could of course document that the result returned shouldn't be modified (but instead copied if modification is needed), and that is probably the most efficient solution for an internal routine, where the caller can then make a copy only when necessary. And indeed, you can enforce (one level at the time) by using tuples.

If you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)

It seems to me that this additional motivation for using the decorator provides another argument *against* the utility and wisdom of the proposed decorator for producing clear, readable, and maintainable code.



---

archive/issue_comments_268667.json:
```json
{
    "body": "<a id='comment:37'></a>> You are right in noting that. You could of course document that the result returned shouldn't be modified (but instead copied if modification is needed), and that is probably the most efficient solution for an internal routine, where the caller can then make a copy only when necessary. And indeed, you can enforce (one level at the time) by using tuples.\n\n\nIt is not an internal routine.\n\n> If you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)\n\n\nI repeat : I do *NOT* want to cache this output.\n\n> It seems to me that this additional motivation for using the decorator provides another argument *against* the utility and wisdom of the proposed decorator for producing clear, readable, and maintainable code.\n\n\nUnderstand what you want to understand. I am telling you that I will have to implement 4 times the same code in different functions, and that all my problems could be solved with the clear and understandable lines that this branch implements, at absolutely no cost for anybody else.\n\nThe code will less clear because of that, the design files will contain code dedicated to caching that does not belong there, and of course I will be implementing manually what could be done by a decorator.\n\nWaste of time.\n\nNathann",
    "created_at": "2014-06-08T19:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268667",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:37'></a>> You are right in noting that. You could of course document that the result returned shouldn't be modified (but instead copied if modification is needed), and that is probably the most efficient solution for an internal routine, where the caller can then make a copy only when necessary. And indeed, you can enforce (one level at the time) by using tuples.


It is not an internal routine.

> If you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)


I repeat : I do *NOT* want to cache this output.

> It seems to me that this additional motivation for using the decorator provides another argument *against* the utility and wisdom of the proposed decorator for producing clear, readable, and maintainable code.


Understand what you want to understand. I am telling you that I will have to implement 4 times the same code in different functions, and that all my problems could be solved with the clear and understandable lines that this branch implements, at absolutely no cost for anybody else.

The code will less clear because of that, the design files will contain code dedicated to caching that does not belong there, and of course I will be implementing manually what could be done by a decorator.

Waste of time.

Nathann



---

archive/issue_comments_268668.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [ncohen](#comment%3A37):\n> It is not an internal routine.\n> \n> > If you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)\n\n> \n> I repeat : I do *NOT* want to cache this output.\n\n\nHow can you tell from the input parameters whether the caller is going to mutate the result you're returning? Surely a non-internal routine will have uniform input/output specifications, i.e., always return either mutable types or immutable types?",
    "created_at": "2014-06-08T20:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268668",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:38'></a>Replying to [ncohen](#comment%3A37):
> It is not an internal routine.
> 
> > If you want an always-safe-to-mutate result, you would always need to *copy* into cache (or copy the result once it's written into the cache), which is not what is proposed on this ticket. In fact, copying is a complicated, data type dependent operation (think tuple of lists, for instance -- how deep do you have to go with copying?)

> 
> I repeat : I do *NOT* want to cache this output.


How can you tell from the input parameters whether the caller is going to mutate the result you're returning? Surely a non-internal routine will have uniform input/output specifications, i.e., always return either mutable types or immutable types?



---

archive/issue_comments_268669.json:
```json
{
    "body": "<a id='comment:39'></a>> How can you tell from the input parameters whether the caller is going to mutate the result you're returning?\n\n\n`O_O`\n\nIt is simple :\n\n1) If I can use the feature implemented in this branch\n\n--> I can only cache the return values I am interested in caching (they are boolean-->immutable) and I can return other values as mutable types, which is their most natural type.\n\n2) If I cannot use the feature implemented in this branch, I have to use cached_method\n\n--> Thus I have to cache everything that my function returns, and so I cannot return immutables types anymore. And I have to return tuples of tuples instead of lists, which complicated matters uselessly.\n\n> Surely a non-internal routine will have uniform input/output specifications, i.e., always return either mutable types or immutable types?\n\n\nNo. My function returns booleans or lists of lists, depending on what the user asks. If I have to make it tuples of tuples and cache them for naught, it's a waste for everybody.\n\nWith this branch, I can cache only what I want and not have to change what my function returns to fit the cached_method's needs.\n\nNathann",
    "created_at": "2014-06-08T20:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268669",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:39'></a>> How can you tell from the input parameters whether the caller is going to mutate the result you're returning?


`O_O`

It is simple :

1) If I can use the feature implemented in this branch

--> I can only cache the return values I am interested in caching (they are boolean-->immutable) and I can return other values as mutable types, which is their most natural type.

2) If I cannot use the feature implemented in this branch, I have to use cached_method

--> Thus I have to cache everything that my function returns, and so I cannot return immutables types anymore. And I have to return tuples of tuples instead of lists, which complicated matters uselessly.

> Surely a non-internal routine will have uniform input/output specifications, i.e., always return either mutable types or immutable types?


No. My function returns booleans or lists of lists, depending on what the user asks. If I have to make it tuples of tuples and cache them for naught, it's a waste for everybody.

With this branch, I can cache only what I want and not have to change what my function returns to fit the cached_method's needs.

Nathann



---

archive/issue_comments_268670.json:
```json
{
    "body": "<a id='comment:40'></a>(Of course, what I said above is that if I cannot use this branch's code then I will just implement manually the caching mechanism in all 4 functions, because caching everything just isn't a clean solution)",
    "created_at": "2014-06-08T20:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268670",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:40'></a>(Of course, what I said above is that if I cannot use this branch's code then I will just implement manually the caching mechanism in all 4 functions, because caching everything just isn't a clean solution)



---

archive/issue_comments_268671.json:
```json
{
    "body": "<a id='comment:41'></a>This ticket is not really waiting for a review, given that it has been refused in its current form. As Karl-Dieter does not want it to be closed as wontfix, I set it to `needs_work` until somebody changes the implementation. The problem in the combinatorial designs code has been fixed with a specific caching system.\n\nNathann",
    "created_at": "2014-07-05T10:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268671",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:41'></a>This ticket is not really waiting for a review, given that it has been refused in its current form. As Karl-Dieter does not want it to be closed as wontfix, I set it to `needs_work` until somebody changes the implementation. The problem in the combinatorial designs code has been fixed with a specific caching system.

Nathann



---

archive/issue_comments_268672.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-07-05T10:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268672",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_268673.json:
```json
{
    "body": "<a id='comment:42'></a>> This ticket is not really waiting for a review, given that it has been refused in its current form. As Karl-Dieter does not want it to be closed as wontfix, I set it to `needs_work` until somebody changes the implementation. The problem in the combinatorial designs code has been fixed with a specific caching system.\n\nThis seems reasonable.",
    "created_at": "2014-07-05T21:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268673",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:42'></a>> This ticket is not really waiting for a review, given that it has been refused in its current form. As Karl-Dieter does not want it to be closed as wontfix, I set it to `needs_work` until somebody changes the implementation. The problem in the combinatorial designs code has been fixed with a specific caching system.

This seems reasonable.



---

archive/issue_events_048191.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16353#event-48191"
}
```



---

archive/issue_events_048192.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16353#event-48192"
}
```



---

archive/issue_comments_268674.json:
```json
{
    "body": "Changing author from \"Nathann Cohen\" to \"\"",
    "created_at": "2015-01-21T09:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16353#issuecomment-268674",
    "user": "https://github.com/nathanncohen"
}
```

Changing author from "Nathann Cohen" to ""
