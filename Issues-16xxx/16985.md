# Issue 16985: Poset: Faster is_selfdual()

archive/issues_016748.json:
```json
{
    "body": "For now at Poset class the code for `is_selfdual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.\n\nCC:  @nathanncohen\n\nBranch/Commit: 9ca9f8105b780ea9e8fa029e0dace7c12e7c66cc\n\nReviewer: Nathann Cohen\n\nAuthor: Jori M\u00e4ntysalo\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16985\n\n",
    "closed_at": "2014-09-19T15:08:58Z",
    "created_at": "2014-09-15T09:04:15Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Poset: Faster is_selfdual()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16985",
    "user": "https://github.com/jm58660"
}
```
For now at Poset class the code for `is_selfdual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.

CC:  @nathanncohen

Branch/Commit: 9ca9f8105b780ea9e8fa029e0dace7c12e7c66cc

Reviewer: Nathann Cohen

Author: Jori MÃ¤ntysalo

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16985





---

archive/issue_comments_235622.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-For now at Poset class the code for `is_dual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that cardinalities are same, number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.\n+For now at Poset class the code for `is_selfdual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.\n \n Summary: Poset: Faster is_dual()\n \n```\n",
    "created_at": "2014-09-15T09:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235622",
    "user": "https://github.com/jm58660"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-For now at Poset class the code for `is_dual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that cardinalities are same, number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.
+For now at Poset class the code for `is_selfdual()` does just `is_isomorphic(self.dual())`. It of course works, but is quite slow on most cases. Before full isomorphic test one can at least check that number of maximal and minimal elements are same and that sorted lists of in- and out-degrees are same.
 
 Summary: Poset: Faster is_dual()
 
```




---

archive/issue_comments_235623.json:
```json
{
    "body": "<a id='comment:3'></a>Could you provide timings for the latest improvement you added ?\n\nAlso: the code of `Poset.level_sets` is a call to `.hasse_diagram()`, so perhaps you should call that function instead.\n\nNathann\n\n---\nNew commits:",
    "created_at": "2014-09-15T12:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235623",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:3'></a>Could you provide timings for the latest improvement you added ?

Also: the code of `Poset.level_sets` is a call to `.hasse_diagram()`, so perhaps you should call that function instead.

Nathann

---
New commits:



---

archive/issue_comments_235624.json:
```json
{
    "body": "<a id='comment:4'></a>Timings depend on test set. But with all 7-element posets this seems to be about 10-times faster. On the other hand, when testing with 7-element posets that really are duals this runs about 10% slower.\n\nHow should this kind of codes be tested, what kind of random posets to use?",
    "created_at": "2014-09-15T12:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235624",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:4'></a>Timings depend on test set. But with all 7-element posets this seems to be about 10-times faster. On the other hand, when testing with 7-element posets that really are duals this runs about 10% slower.

How should this kind of codes be tested, what kind of random posets to use?



---

archive/issue_comments_235625.json:
```json
{
    "body": "<a id='comment:5'></a>> Timings depend on test set. But with all 7-element posets this seems to be about 10-times faster. On the other hand, when testing with 7-element posets that really are duals this runs about 10% slower.\n\n\nI was only talking of the improvement which uses level sets.\n\n> How should this kind of codes be tested, what kind of random posets to use?\n\n\nHmmmm... With what we have at our disposal I suppose. But I wondered whether computing the label sets was much faster than isomorphism. It probably is, but I wondered `^^;`\n\nNathann",
    "created_at": "2014-09-15T13:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235625",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>> Timings depend on test set. But with all 7-element posets this seems to be about 10-times faster. On the other hand, when testing with 7-element posets that really are duals this runs about 10% slower.


I was only talking of the improvement which uses level sets.

> How should this kind of codes be tested, what kind of random posets to use?


Hmmmm... With what we have at our disposal I suppose. But I wondered whether computing the label sets was much faster than isomorphism. It probably is, but I wondered `^^;`

Nathann



---

archive/issue_comments_235626.json:
```json
{
    "body": "<a id='comment:6'></a>I'm not surprised by the slowdown because extra checks are being done first. However I'd say the slowdown is acceptable in comparison to the speedup because (I believe) most posets are not self-dual. Could you post your before/after timings?\n\nI'd also not use random posets but instead make sure there is a poset which fails each check to make sure the code works (so fails the in-degree -> out-degree comparison and the level sets comparison [but passes the first test]).\n\nOne thing from a quick glance at the code, we're trying to be python3 compliant. So you should change `<>` into `!=`.",
    "created_at": "2014-09-15T16:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235626",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>I'm not surprised by the slowdown because extra checks are being done first. However I'd say the slowdown is acceptable in comparison to the speedup because (I believe) most posets are not self-dual. Could you post your before/after timings?

I'd also not use random posets but instead make sure there is a poset which fails each check to make sure the code works (so fails the in-degree -> out-degree comparison and the level sets comparison [but passes the first test]).

One thing from a quick glance at the code, we're trying to be python3 compliant. So you should change `<>` into `!=`.



---

archive/issue_comments_235627.json:
```json
{
    "body": "<a id='comment:7'></a>Simple test can be done with Sage without coding anything. For example after `L=Posets(6).list()` I just got\n\n`len([P for P in L if P.is_selfdual()])` -> CPU time: 60.21 s,  Wall time: 65.77 s\n\n`len([P for P in L if sorted(P._hasse_diagram.in_degree()) == sorted(P._hasse_diagram.out_degree()) and P.is_selfdual()])` -> CPU time: 38.73 s,  Wall time: 40.53 s\n\n`len([P for P in L if sorted(P._hasse_diagram.in_degree()) == sorted(P._hasse_diagram.out_degree()) and [len(x) for x in P.level_sets()]==[len(x) for x in P.dual().level_sets()] and P.is_selfdual()])` -> CPU time: 28.94 s,  Wall time: 30.20 s\n\nDifference grows bigger wiht `Posets(7)`, and is also bigger when coding this directly to `.py`-file.\n\nThere are 318 posets of size 6. Of those 30 pass first test but fails second, and 12 pass first and second test but fails last one. This is an example of poset passing 1. and 2. test:\n\n`Poset([[0,1,2,3,4,5],[[1, 5], [2, 3], [2, 5], [3, 4]]])`.\n\nI can calculate these numbers for 7- and 8-element posets if needed.",
    "created_at": "2014-09-15T19:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235627",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:7'></a>Simple test can be done with Sage without coding anything. For example after `L=Posets(6).list()` I just got

`len([P for P in L if P.is_selfdual()])` -> CPU time: 60.21 s,  Wall time: 65.77 s

`len([P for P in L if sorted(P._hasse_diagram.in_degree()) == sorted(P._hasse_diagram.out_degree()) and P.is_selfdual()])` -> CPU time: 38.73 s,  Wall time: 40.53 s

`len([P for P in L if sorted(P._hasse_diagram.in_degree()) == sorted(P._hasse_diagram.out_degree()) and [len(x) for x in P.level_sets()]==[len(x) for x in P.dual().level_sets()] and P.is_selfdual()])` -> CPU time: 28.94 s,  Wall time: 30.20 s

Difference grows bigger wiht `Posets(7)`, and is also bigger when coding this directly to `.py`-file.

There are 318 posets of size 6. Of those 30 pass first test but fails second, and 12 pass first and second test but fails last one. This is an example of poset passing 1. and 2. test:

`Poset([[0,1,2,3,4,5],[[1, 5], [2, 3], [2, 5], [3, 4]]])`.

I can calculate these numbers for 7- and 8-element posets if needed.



---

archive/issue_comments_235628.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-15T19:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235629.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:3 ncohen]:\n\n> Also: the code of `Poset.level_sets` is a call to `.hasse_diagram()`, so perhaps you should call that function instead.\n\n\nHmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.",
    "created_at": "2014-09-15T19:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235629",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:9'></a>Replying to [comment:3 ncohen]:

> Also: the code of `Poset.level_sets` is a call to `.hasse_diagram()`, so perhaps you should call that function instead.


Hmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.



---

archive/issue_comments_235630.json:
```json
{
    "body": "<a id='comment:10'></a>> Hmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.\n\n\n```\nsage: Poset(DiGraph({0:[],1:[2]})).level_sets()\n[[1, 0], [2]]\nsage: Poset(DiGraph({0:[],1:[2]})).dual().level_sets()\n[[0, 2], [1]]\n```",
    "created_at": "2014-09-16T09:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235630",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>> Hmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.


```
sage: Poset(DiGraph({0:[],1:[2]})).level_sets()
[[1, 0], [2]]
sage: Poset(DiGraph({0:[],1:[2]})).dual().level_sets()
[[0, 2], [1]]
```



---

archive/issue_comments_235631.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 ncohen]:\n> > Hmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.\n\n> \n> {{{\n> sage: Poset(DiGraph({0:[],1:[2]})).level_sets()\n> [[1, 0], [2]]\n> sage: Poset(DiGraph({0:[],1:[2]})).dual().level_sets()\n> [[0, 2], [1]]\n> }}}\n\n\nI don't understand. Of course we must sometimes do full test for isomorphicity. This is one example of those.\n\nSaying `Poset({'a':['b']})._hasse_diagram.level_sets()` will return `[[0], [1]]`, not `[['a'], ['b']]`. But in any case, code seems to reverse an array, which is unneeded.",
    "created_at": "2014-09-16T10:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235631",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:11'></a>Replying to [comment:10 ncohen]:
> > Hmm, actually it seems that only `reverse()` is needed. There is no need at all to calculate full dual with element labels. Got to think about this tomorrow.

> 
> {{{
> sage: Poset(DiGraph({0:[],1:[2]})).level_sets()
> [[1, 0], [2]]
> sage: Poset(DiGraph({0:[],1:[2]})).dual().level_sets()
> [[0, 2], [1]]
> }}}


I don't understand. Of course we must sometimes do full test for isomorphicity. This is one example of those.

Saying `Poset({'a':['b']})._hasse_diagram.level_sets()` will return `[[0], [1]]`, not `[['a'], ['b']]`. But in any case, code seems to reverse an array, which is unneeded.



---

archive/issue_comments_235632.json:
```json
{
    "body": "<a id='comment:12'></a>> I don't understand. \n\n\nThen I probably misunderstood your comment about \"reverse\", sorry.\n\nNathann",
    "created_at": "2014-09-16T11:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235632",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>> I don't understand. 


Then I probably misunderstood your comment about "reverse", sorry.

Nathann



---

archive/issue_comments_235633.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-16T19:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235633",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_235634.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-16T19:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235634",
    "user": "https://github.com/jm58660"
}
```

Changing status from new to needs_review.



---

archive/issue_events_049494.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2014-09-16T19:57:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16985#event-49494"
}
```



---

archive/issue_comments_235635.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-17T09:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235635",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_235636.json:
```json
{
    "body": "<a id='comment:15'></a>please add your name to the \"Authors\" fields in this ticket.\n\nNathann",
    "created_at": "2014-09-17T09:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235636",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:15'></a>please add your name to the "Authors" fields in this ticket.

Nathann



---

archive/issue_events_049495.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-19T15:08:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16985#event-49495"
}
```



---

archive/issue_comments_235637.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-19T15:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16985#issuecomment-235637",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
