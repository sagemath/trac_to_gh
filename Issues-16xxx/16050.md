# Issue 16050: miscellaneous cleanup/bugfixes for sage.misc.interpreter and sage.misc.sage_extension

archive/issues_015813.json:
```json
{
    "body": "This is just a bit of cleanup+bugfixes that I've done over the past couple weeks. Notable changes:\n\n- remove deprecations from #12719\n- fix iload to actually be able to edit the loaded lines (could still be better, but would require more hacking on ipython internals; probably should just be added to upstream ipython instead)\n- fix weird random bugs encountered with `InterfaceShellTransformer` (e.g. in gap, creating an error will cause future valid lines to error out) -- as far as I can tell, the code was just overthought (and had interface specific things that should belong as part of the appropriate interface)\n- use the IPython shutdown hook rather than customizing `ask_exit`\n- remove some dead and unused code\n- start migrating files out of `sage.misc` and into `sage.repl`\n\nCC:  @jasongrout\n\nBranch/Commit: 12efdd3b2658c881944b48d25a637112bc5ed268\n\nReviewer: Volker Braun\n\nAuthor: R. Andrew Ohana\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16050\n\n",
    "closed_at": "2014-04-14T16:55:35Z",
    "created_at": "2014-04-02T23:48:04Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "miscellaneous cleanup/bugfixes for sage.misc.interpreter and sage.misc.sage_extension",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16050",
    "user": "https://github.com/ohanar"
}
```
This is just a bit of cleanup+bugfixes that I've done over the past couple weeks. Notable changes:

- remove deprecations from #12719
- fix iload to actually be able to edit the loaded lines (could still be better, but would require more hacking on ipython internals; probably should just be added to upstream ipython instead)
- fix weird random bugs encountered with `InterfaceShellTransformer` (e.g. in gap, creating an error will cause future valid lines to error out) -- as far as I can tell, the code was just overthought (and had interface specific things that should belong as part of the appropriate interface)
- use the IPython shutdown hook rather than customizing `ask_exit`
- remove some dead and unused code
- start migrating files out of `sage.misc` and into `sage.repl`

CC:  @jasongrout

Branch/Commit: 12efdd3b2658c881944b48d25a637112bc5ed268

Reviewer: Volker Braun

Author: R. Andrew Ohana

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16050





---

archive/issue_comments_260792.json:
```json
{
    "body": "<a id='comment:1'></a>I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.\n\nAlso, this is just a first step towards cleanup. Certainly more could be done (e.g. stuff surrounding the preparser), but I figured may as well do this gradually rather than as a patchbomb.",
    "created_at": "2014-04-02T23:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260792",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:1'></a>I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.

Also, this is just a first step towards cleanup. Certainly more could be done (e.g. stuff surrounding the preparser), but I figured may as well do this gradually rather than as a patchbomb.



---

archive/issue_comments_260793.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 ohanar]:\n> I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.\n\n\n`sage.shell`? `sage.toplevel`? `sage.repl`?",
    "created_at": "2014-04-03T07:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260793",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:2'></a>Replying to [comment:1 ohanar]:
> I would also like to move most of this code out of `sage.misc` to something like `sage.app`, but I'm not really happy with that package name. Maybe something like `sage.terminal`? Suggestions would be welcome.


`sage.shell`? `sage.toplevel`? `sage.repl`?



---

archive/issue_comments_260794.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 mmezzarobba]:\n> `sage.shell`? `sage.toplevel`? `sage.repl`?\n\nooh, I like `sage.repl` :)",
    "created_at": "2014-04-04T16:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260794",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:3'></a>Replying to [comment:2 mmezzarobba]:
> `sage.shell`? `sage.toplevel`? `sage.repl`?

ooh, I like `sage.repl` :)



---

archive/issue_comments_260795.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-09T21:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260796.json:
```json
{
    "body": "Changing commit from \"4e5822efd20aa702173c2a19fb921de196157de3\" to \"64479d9e2bee27b5f6ba52a3386e030af43e487f\"",
    "created_at": "2014-04-09T21:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260796",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4e5822efd20aa702173c2a19fb921de196157de3" to "64479d9e2bee27b5f6ba52a3386e030af43e487f"



---

archive/issue_comments_260797.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,6 +5,7 @@\n - fix weird random bugs encountered with `InterfaceShellTransformer` (e.g. in gap, creating an error will cause future valid lines to error out) -- as far as I can tell, the code was just overthought (and had interface specific things that should belong as part of the appropriate interface)\n - use the IPython shutdown hook rather than customizing `ask_exit`\n - remove some dead and unused code\n+- start migrating files out of `sage.misc` and into `sage.repl`\n \n Author: R. Andrew Ohana\n \n``````\n",
    "created_at": "2014-04-09T21:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260797",
    "user": "https://github.com/ohanar"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,6 +5,7 @@
 - fix weird random bugs encountered with `InterfaceShellTransformer` (e.g. in gap, creating an error will cause future valid lines to error out) -- as far as I can tell, the code was just overthought (and had interface specific things that should belong as part of the appropriate interface)
 - use the IPython shutdown hook rather than customizing `ask_exit`
 - remove some dead and unused code
+- start migrating files out of `sage.misc` and into `sage.repl`
 
 Author: R. Andrew Ohana
 
``````




---

archive/issue_comments_260798.json:
```json
{
    "body": "Changing commit from \"64479d9e2bee27b5f6ba52a3386e030af43e487f\" to \"9324deb05dbe6fae032d5bbca09e91810696a39d\"",
    "created_at": "2014-04-09T21:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260798",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "64479d9e2bee27b5f6ba52a3386e030af43e487f" to "9324deb05dbe6fae032d5bbca09e91810696a39d"



---

archive/issue_comments_260799.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-09T21:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260799",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260800.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-10T18:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_260801.json:
```json
{
    "body": "Changing commit from \"9324deb05dbe6fae032d5bbca09e91810696a39d\" to \"542dcc9483b8c19be96971512374f3437473cdcf\"",
    "created_at": "2014-04-10T18:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260801",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9324deb05dbe6fae032d5bbca09e91810696a39d" to "542dcc9483b8c19be96971512374f3437473cdcf"



---

archive/issue_comments_260802.json:
```json
{
    "body": "Changing commit from \"542dcc9483b8c19be96971512374f3437473cdcf\" to \"861878435bfeef667669325deca252b5823029f0\"",
    "created_at": "2014-04-10T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260802",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "542dcc9483b8c19be96971512374f3437473cdcf" to "861878435bfeef667669325deca252b5823029f0"



---

archive/issue_comments_260803.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-04-10T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_260804.json:
```json
{
    "body": "<a id='comment:9'></a>(Sorry for the force push, didn't properly copy a symlink.)\n\nI'll make further changes in future tickets (I'll of course fix any regressions here, if they are found), so I'm marking this as needs review.",
    "created_at": "2014-04-10T18:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260804",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:9'></a>(Sorry for the force push, didn't properly copy a symlink.)

I'll make further changes in future tickets (I'll of course fix any regressions here, if they are found), so I'm marking this as needs review.



---

archive/issue_comments_260805.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-10T19:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260805",
    "user": "https://github.com/ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_260806.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2014-04-13T21:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260806",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_260807.json:
```json
{
    "body": "<a id='comment:12'></a>Conflicts with the already-merged (but not released) #15990.\n\nFrom looking at the source it seems that this still suffers from the same problem as #16154, the sage prompt transformer ought to run first and not last. Can you fix it here, then I'll close my ticket.",
    "created_at": "2014-04-13T21:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260807",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Conflicts with the already-merged (but not released) #15990.

From looking at the source it seems that this still suffers from the same problem as #16154, the sage prompt transformer ought to run first and not last. Can you fix it here, then I'll close my ticket.



---

archive/issue_comments_260808.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-04-13T23:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260808",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_260809.json:
```json
{
    "body": "Changing commit from \"861878435bfeef667669325deca252b5823029f0\" to \"df49c8e619080b506d7ac0c2b6a3e0e1ce85e27b\"",
    "created_at": "2014-04-13T23:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260809",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "861878435bfeef667669325deca252b5823029f0" to "df49c8e619080b506d7ac0c2b6a3e0e1ce85e27b"



---

archive/issue_comments_260810.json:
```json
{
    "body": "<a id='comment:14'></a>ok, I added your fix for #16154 and merged in #15990.",
    "created_at": "2014-04-13T23:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260810",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:14'></a>ok, I added your fix for #16154 and merged in #15990.



---

archive/issue_comments_260811.json:
```json
{
    "body": "<a id='comment:15'></a>Can you also fix the module path in the doctests? ;-)\n\n```\nsage -t --long src/sage/repl/ipython_extension.py\n**********************************************************************\nFile \"src/sage/repl/ipython_extension.py\", line 78, in sage.repl.ipython_extension.SageMagics.crun\nFailed example:\n    from sage.misc.interpreter import get_test_shell\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.repl.ipython_extension.SageMagics.crun[0]>\", line 1, in <module>\n        from sage.misc.interpreter import get_test_shell\n    ImportError: cannot import name get_test_shell\n**********************************************************************\nFile \"src/sage/repl/ipython_extension.py\", line 79, in sage.repl.ipython_extension.SageMagics.crun\nFailed example:\n    shell = get_test_shell()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.repl.ipython_extension.SageMagics.crun[1]>\", line 1, in <module>\n        shell = get_test_shell()\n    NameError: name 'get_test_shell' is not defined\n**********************************************************************\n1 item had failures:\n```",
    "created_at": "2014-04-14T09:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260811",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>Can you also fix the module path in the doctests? ;-)

```
sage -t --long src/sage/repl/ipython_extension.py
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 78, in sage.repl.ipython_extension.SageMagics.crun
Failed example:
    from sage.misc.interpreter import get_test_shell
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.repl.ipython_extension.SageMagics.crun[0]>", line 1, in <module>
        from sage.misc.interpreter import get_test_shell
    ImportError: cannot import name get_test_shell
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 79, in sage.repl.ipython_extension.SageMagics.crun
Failed example:
    shell = get_test_shell()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.repl.ipython_extension.SageMagics.crun[1]>", line 1, in <module>
        shell = get_test_shell()
    NameError: name 'get_test_shell' is not defined
**********************************************************************
1 item had failures:
```



---

archive/issue_comments_260812.json:
```json
{
    "body": "Changing branch from \"u/ohanar/terminal_app_cleanup\" to \"u/vbraun/terminal_app_cleanup\"",
    "created_at": "2014-04-14T09:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260812",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/ohanar/terminal_app_cleanup" to "u/vbraun/terminal_app_cleanup"



---

archive/issue_comments_260813.json:
```json
{
    "body": "Changing commit from \"df49c8e619080b506d7ac0c2b6a3e0e1ce85e27b\" to \"12efdd3b2658c881944b48d25a637112bc5ed268\"",
    "created_at": "2014-04-14T09:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260813",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "df49c8e619080b506d7ac0c2b6a3e0e1ce85e27b" to "12efdd3b2658c881944b48d25a637112bc5ed268"



---

archive/issue_comments_260814.json:
```json
{
    "body": "<a id='comment:17'></a>Fixed\n\n---\nNew commits:",
    "created_at": "2014-04-14T09:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260814",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Fixed

---
New commits:



---

archive/issue_comments_260815.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-14T16:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260815",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_047184.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-14T16:55:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16050#event-47184"
}
```



---

archive/issue_comments_260816.json:
```json
{
    "body": "Changing branch from \"u/vbraun/terminal_app_cleanup\" to \"12efdd3b2658c881944b48d25a637112bc5ed268\"",
    "created_at": "2014-04-14T16:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16050#issuecomment-260816",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/vbraun/terminal_app_cleanup" to "12efdd3b2658c881944b48d25a637112bc5ed268"
