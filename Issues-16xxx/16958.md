# Issue 16958: MPolynomial eval mem leak

archive/issues_016721.json:
```json
{
    "body": "When a libsingular polynomial evaluates to a constant we leak the resulting libsingular `poly`. \n\nCC:  @malb jpflori\n\nReviewer: Jean-Pierre Flori\n\nAuthor: Volker Braun\n\nBranch: 377220e947cf36ab019af2d243db89441a64ee7e\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/16958\n\n",
    "closed_at": "2014-12-12T12:29:41Z",
    "created_at": "2014-09-10T13:57:33Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "MPolynomial eval mem leak",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16958",
    "user": "https://github.com/vbraun"
}
```
When a libsingular polynomial evaluates to a constant we leak the resulting libsingular `poly`. 

CC:  @malb jpflori

Reviewer: Jean-Pierre Flori

Author: Volker Braun

Branch: 377220e947cf36ab019af2d243db89441a64ee7e

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/16958





---

archive/issue_comments_220755.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-10T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220755",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_220756.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2014-09-10T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220756",
    "user": "https://github.com/vbraun"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_220757.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2014-09-10T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220757",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_220758.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2014-09-10T14:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220758",
    "user": "https://github.com/vbraun"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_220759.json:
```json
{
    "body": "<a id='comment:3'></a>Can you add a doctest showing the leak is fixed?",
    "created_at": "2014-09-10T14:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220759",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:3'></a>Can you add a doctest showing the leak is fixed?



---

archive/issue_comments_220760.json:
```json
{
    "body": "<a id='comment:4'></a>Mmm got another segfault elsewhere..",
    "created_at": "2014-09-10T14:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220760",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>Mmm got another segfault elsewhere..



---

archive/issue_comments_220761.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-10T14:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220761",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_220762.json:
```json
{
    "body": "<a id='comment:5'></a>Shouldn't those fixes be reported upstream?",
    "created_at": "2014-09-10T15:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220762",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>Shouldn't those fixes be reported upstream?



---

archive/issue_comments_220763.json:
```json
{
    "body": "<a id='comment:6'></a>Ah, sorry, spoke to soon: The leak was in Sage library, not in Singular.",
    "created_at": "2014-09-10T15:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220763",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>Ah, sorry, spoke to soon: The leak was in Sage library, not in Singular.



---

archive/issue_comments_220764.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:4 vbraun]:\n> Mmm got another segfault elsewhere..\n\nThat doesn't surprise me. We tried to properly interface with libsingular's reference counting before and, while we came close, it ended up being a rather nightmarish experience. See #13447.\n\nI am still quite hopeful that this can be fixed *if the right experts get in the same room* for a couple of days (either that or people will find out if libsingular's reference counting is fundamentally broken).\n\n(note that #13447 is about garbage collecting rings, which are probably a little more complicated data structures. Nonetheless, there may well be components in common).",
    "created_at": "2014-09-10T18:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220764",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>Replying to [comment:4 vbraun]:
> Mmm got another segfault elsewhere..

That doesn't surprise me. We tried to properly interface with libsingular's reference counting before and, while we came close, it ended up being a rather nightmarish experience. See #13447.

I am still quite hopeful that this can be fixed *if the right experts get in the same room* for a couple of days (either that or people will find out if libsingular's reference counting is fundamentally broken).

(note that #13447 is about garbage collecting rings, which are probably a little more complicated data structures. Nonetheless, there may well be components in common).



---

archive/issue_comments_220765.json:
```json
{
    "body": "<a id='comment:8'></a>I'm pretty sure I'm doing the right thing, you get a pointer to a poly so duh of course it needs to be deallocated. There are only two doctest failures in Sage, so I'm mildly optimistic. I'm probably uncovering bugs elsewhere...\n\nSimon, did you make any progress towards a debug build?",
    "created_at": "2014-09-10T19:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220765",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>I'm pretty sure I'm doing the right thing, you get a pointer to a poly so duh of course it needs to be deallocated. There are only two doctest failures in Sage, so I'm mildly optimistic. I'm probably uncovering bugs elsewhere...

Simon, did you make any progress towards a debug build?



---

archive/issue_comments_220766.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 vbraun]:\n> Simon, did you make any progress towards a debug build?\n\n\nI got answer from Hans Sch\u00f6nemann. But I don't know yet if it works. To be discussed on the other ticket.",
    "created_at": "2014-09-10T19:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220766",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>Replying to [comment:8 vbraun]:
> Simon, did you make any progress towards a debug build?


I got answer from Hans Sch√∂nemann. But I don't know yet if it works. To be discussed on the other ticket.



---

archive/issue_comments_220767.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-14T12:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220767",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_220768.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-14T12:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_220769.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-14T13:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220769",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_220770.json:
```json
{
    "body": "<a id='comment:12'></a>Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know.",
    "created_at": "2014-09-14T13:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220770",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know.



---

archive/issue_comments_220771.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 vbraun]:\n> Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know. \n\n\nI don't know the answer, maybe ask on [libsingular-devel]?",
    "created_at": "2014-09-23T14:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220771",
    "user": "https://github.com/malb"
}
```

<a id='comment:13'></a>Replying to [comment:12 vbraun]:
> Singular's `fast_map` returns non-normalized values (e.g. rational coefficients are not in standard form). As far as I know, this shouldn't be a problem yet we still segfault in the `p_Delete`. Adding a `p_Normalize` avoids the segfault. Perhaps there is a subtle bug / hidden assumption in `fast_map` that requires the normalization, I don't know. 


I don't know the answer, maybe ask on [libsingular-devel]?



---

archive/issue_comments_220772.json:
```json
{
    "body": "<a id='comment:14'></a>I asked at https://groups.google.com/d/msg/libsingular-devel/NV_j8Fugi4o/a7OdyHQSFf4J but didn't get a reply",
    "created_at": "2014-09-30T11:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220772",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>I asked at https://groups.google.com/d/msg/libsingular-devel/NV_j8Fugi4o/a7OdyHQSFf4J but didn't get a reply



---

archive/issue_comments_220773.json:
```json
{
    "body": "<a id='comment:16'></a>Works fine for me.\nFor sure the need for normalize does not really make sense, but it makes the situation a little better here.",
    "created_at": "2014-12-08T15:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220773",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:16'></a>Works fine for me.
For sure the need for normalize does not really make sense, but it makes the situation a little better here.



---

archive/issue_comments_220774.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-12-08T15:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220774",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049461.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-12-12T12:29:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16958#event-49461"
}
```



---

archive/issue_comments_220775.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-12-12T12:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220775",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_220776.json:
```json
{
    "body": "<a id='comment:18'></a>I wonder if that fixes the memory leak for the letterplace algebra, that I noticed while working on #17435. If it doesn't, I should open a new ticket at some point...",
    "created_at": "2014-12-12T12:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220776",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>I wonder if that fixes the memory leak for the letterplace algebra, that I noticed while working on #17435. If it doesn't, I should open a new ticket at some point...



---

archive/issue_comments_220777.json:
```json
{
    "body": "<a id='comment:19'></a>Why has the commit information been written into the \"branch\" field when Volker closed the ticket? And why has my post resulted in a deletion of the commit field? I didn't touch it!",
    "created_at": "2014-12-12T22:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16958",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16958#issuecomment-220777",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>Why has the commit information been written into the "branch" field when Volker closed the ticket? And why has my post resulted in a deletion of the commit field? I didn't touch it!
