# Issue 16181: inject_shorthands broken since 6.2beta8

archive/issues_015944.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage: NSym = NonCommutativeSymmetricFunctions(QQ)\nsage: NSym.inject_shorthands()\nInjecting S as shorthand for Non-Commutative Symmetric Functions over the Rational Field in the Complete basis\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n<ipython-input-2-458277a04544> in <module>()\n----> 1 NSym.inject_shorthands()\n\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/sets_cat.pyc in inject_shorthands(self, verbose)\n   1318                     if verbose:\n   1319                         print 'Injecting %s as shorthand for %s'%(shorthand, realization)\n-> 1320                     inject_variable(shorthand, realization)\n   1321 \n   1322             def realizations(self):\n\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in inject_variable(name, value)\n   2356     # inject_variable is called not only from the interpreter, but\n   2357     # also from functions in various modules.\n-> 2358     G = get_main_globals()\n   2359     if name in G:\n   2360         warn(\"redefining global value `%s`\"%name, RuntimeWarning, stacklevel = 2)\n\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in get_main_globals()\n   2312     while True:\n   2313         G = sys._getframe(depth).f_globals\n-> 2314         if G[\"__name__\"] == \"__main__\" and G[\"__package__\"] is None:\n   2315             break\n   2316         depth += 1\n\nKeyError: '__package__'\n```\n\nSame for Sym and QSym.\n\nThe `get_main_globals` method hasn't been changed since 2011, so I suspect something else is at fault. The attached branch gets rid of the bug, but I don't understand the code at hand and so it is not really merge-ready. Needs_review is to increase visibility.\n\nCC:  @nthiery @vbraun\n\nComponent: **misc**\n\nKeywords: **globals, inject_shorthands, regression**\n\nAuthor: **Darij Grinberg**\n\nBranch/Commit: **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**\n\nReviewer: **Travis Scrimshaw**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/16181_\n\n",
    "closed_at": "2014-04-20T23:37:13Z",
    "created_at": "2014-04-17T22:30:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "inject_shorthands broken since 6.2beta8",
    "type": "issue",
    "updated_at": "2014-04-20T23:37:13Z",
    "url": "https://github.com/sagemath/sage/issues/16181",
    "user": "https://github.com/darijgr"
}
```

```
sage: NSym = NonCommutativeSymmetricFunctions(QQ)
sage: NSym.inject_shorthands()
Injecting S as shorthand for Non-Commutative Symmetric Functions over the Rational Field in the Complete basis
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-2-458277a04544> in <module>()
----> 1 NSym.inject_shorthands()

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/sets_cat.pyc in inject_shorthands(self, verbose)
   1318                     if verbose:
   1319                         print 'Injecting %s as shorthand for %s'%(shorthand, realization)
-> 1320                     inject_variable(shorthand, realization)
   1321 
   1322             def realizations(self):

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in inject_variable(name, value)
   2356     # inject_variable is called not only from the interpreter, but
   2357     # also from functions in various modules.
-> 2358     G = get_main_globals()
   2359     if name in G:
   2360         warn("redefining global value `%s`"%name, RuntimeWarning, stacklevel = 2)

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in get_main_globals()
   2312     while True:
   2313         G = sys._getframe(depth).f_globals
-> 2314         if G["__name__"] == "__main__" and G["__package__"] is None:
   2315             break
   2316         depth += 1

KeyError: '__package__'
```

Same for Sym and QSym.

The `get_main_globals` method hasn't been changed since 2011, so I suspect something else is at fault. The attached branch gets rid of the bug, but I don't understand the code at hand and so it is not really merge-ready. Needs_review is to increase visibility.

CC:  @nthiery @vbraun

Component: **misc**

Keywords: **globals, inject_shorthands, regression**

Author: **Darij Grinberg**

Branch/Commit: **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**

Reviewer: **Travis Scrimshaw**

_Issue created by migration from https://trac.sagemath.org/ticket/16181_





---

archive/issue_events_228883.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-17T22:30:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228883"
}
```



---

archive/issue_events_228884.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-17T22:30:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228884"
}
```



---

archive/issue_events_228885.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-17T22:30:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228885"
}
```



---

archive/issue_events_228886.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-17T22:30:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228886"
}
```



---

archive/issue_comments_206684.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nOh, and apparently importing any(!) sage file beforehand keeps the bug from happening. Here is an example that does not throw errors:\n\n```\nsage: import sage.combinat.permutation\nsage: NSym = NonCommutativeSymmetricFunctions(QQ)\nsage: NSym.inject_shorthands()\n```",
    "created_at": "2014-04-17T22:37:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206684",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:2" align="right">comment:2</div>

Oh, and apparently importing any(!) sage file beforehand keeps the bug from happening. Here is an example that does not throw errors:

```
sage: import sage.combinat.permutation
sage: NSym = NonCommutativeSymmetricFunctions(QQ)
sage: NSym.inject_shorthands()
```



---

archive/issue_comments_206685.json:
```json
{
    "body": "Changed commit from **[`67855fc`](https://github.com/sagemath/sagetrac-mirror/commit/67855fc66eed143172a9065928e52241d97edefe)** to **[`6e0f42f`](https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a)**",
    "created_at": "2014-04-18T01:59:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206685",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`67855fc`](https://github.com/sagemath/sagetrac-mirror/commit/67855fc66eed143172a9065928e52241d97edefe)** to **[`6e0f42f`](https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a)**



---

archive/issue_comments_206686.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a\"><code>6e0f42f</code></a></td><td><code>Added a doctest.</code></td></tr></table>\n",
    "created_at": "2014-04-18T01:59:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206686",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a"><code>6e0f42f</code></a></td><td><code>Added a doctest.</code></td></tr></table>




---

archive/issue_comments_206687.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nJust doing\n\n```\nsage: sage.misc.misc.inject_variable('a', 0)\n```\n(before an import) is enough to cause the error. If I had to make a WAG, I'd say it's the IPython upgrade. I've added this as a doctest, so if you're happy this (and I'm okay with fixing the symptoms), positive review.",
    "created_at": "2014-04-18T02:00:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206687",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

Just doing

```
sage: sage.misc.misc.inject_variable('a', 0)
```
(before an import) is enough to cause the error. If I had to make a WAG, I'd say it's the IPython upgrade. I've added this as a doctest, so if you're happy this (and I'm okay with fixing the symptoms), positive review.



---

archive/issue_comments_206688.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nUnfortunately this doctest works even without the patch :(\n\nAnd moving it to the very front of the file doesn't help either...",
    "created_at": "2014-04-18T02:02:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206688",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:5" align="right">comment:5</div>

Unfortunately this doctest works even without the patch :(

And moving it to the very front of the file doesn't help either...



---

archive/issue_comments_206689.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nOops, sorry for removing you from cc, Volker (I really should report this as a trac bug -- I started writing my post before you made yours -- but I'm too lazy).",
    "created_at": "2014-04-18T02:03:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206689",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:6" align="right">comment:6</div>

Oops, sorry for removing you from cc, Volker (I really should report this as a trac bug -- I started writing my post before you made yours -- but I'm too lazy).



---

archive/issue_comments_206690.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHmm...there must be something going on within the doctesting framework that prevents this from begin executed before any imports. We can leave it in there as a human warning, but honestly noone is really going to look at that test (much less run it manually)...",
    "created_at": "2014-04-18T02:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206690",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:7" align="right">comment:7</div>

Hmm...there must be something going on within the doctesting framework that prevents this from begin executed before any imports. We can leave it in there as a human warning, but honestly noone is really going to look at that test (much less run it manually)...



---

archive/issue_comments_206691.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nBTW: when I do `sys._getframe(0).f_globals`, I get the following cruft:\n\n```\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.elementary.<tab> instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.<tab> instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.AlcovePath instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.FastRankTwo instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.infinity.Tableaux instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.TensorProductOfKirillovReshetikhinTableaux instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KyotoPathModel instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.Letters instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.DirectSum instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovReshetikhin with model='KR' instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovResetikhin instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.HighestWeight instead\nSee http://trac.sagemath.org/15882 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/core.py:14: ImportWarning: Not importing directory '/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/localedata': missing __init__.py\n  from babel import localedata\n```\n\nAnd this is just the error output. Here is the actual dictionary: https://www.dropbox.com/s/6hzuqm6jf9jo9jt/outtext.txt\n\nI can't believe this all needs to be in the globals?",
    "created_at": "2014-04-18T02:12:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206691",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:8" align="right">comment:8</div>

BTW: when I do `sys._getframe(0).f_globals`, I get the following cruft:

```
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.elementary.<tab> instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.<tab> instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.AlcovePath instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.FastRankTwo instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.infinity.Tableaux instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.TensorProductOfKirillovReshetikhinTableaux instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KyotoPathModel instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.Letters instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.DirectSum instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovReshetikhin with model='KR' instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovResetikhin instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.HighestWeight instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/core.py:14: ImportWarning: Not importing directory '/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/localedata': missing __init__.py
  from babel import localedata
```

And this is just the error output. Here is the actual dictionary: https://www.dropbox.com/s/6hzuqm6jf9jo9jt/outtext.txt

I can't believe this all needs to be in the globals?



---

archive/issue_comments_206692.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThose deprecations are from #15882 (ex. `CrystalOfTableaux`) where I used #14275 to (lazily) import them with a deprecation message and there was no good alternative that I could find (because I didn't want to write some 20 functions where all they did was deprecate something with a [semi]specific message). Moreover, I'd be surprised if they had any bearing on this issue.",
    "created_at": "2014-04-18T02:22:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206692",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:9" align="right">comment:9</div>

Those deprecations are from #15882 (ex. `CrystalOfTableaux`) where I used #14275 to (lazily) import them with a deprecation message and there was no good alternative that I could find (because I didn't want to write some 20 functions where all they did was deprecate something with a [semi]specific message). Moreover, I'd be surprised if they had any bearing on this issue.



---

archive/issue_comments_206693.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nYeah, I now see it's pretty much orthogonal to what we're doing here. Good to know we've got a `delsarte_bound_additive_hamming_space` function in our global namespace, though :)",
    "created_at": "2014-04-18T02:26:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206693",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:10" align="right">comment:10</div>

Yeah, I now see it's pretty much orthogonal to what we're doing here. Good to know we've got a `delsarte_bound_additive_hamming_space` function in our global namespace, though :)



---

archive/issue_comments_206694.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nFrom `sage/doctest/forker.py`:\n\n```\n                # Make the right set of globals available to doctests\n                if basename.startswith(\"sagenb.\"):\n                    import sage.all_notebook as sage_all\n                else:\n                    import sage.all_cmdline as sage_all\n                sage_namespace = RecordingDict(sage_all.__dict__)\n                sage_namespace['__name__'] = '__main__'\n                sage_namespace['__package__'] = None\n                doctests, extras = self.source.create_doctests(sage_namespace)\n                timer = Timer().start()\n```\n\nI'm wondering if we should just axe the line with the `__package__` here?",
    "created_at": "2014-04-18T02:32:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206694",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:11" align="right">comment:11</div>

From `sage/doctest/forker.py`:

```
                # Make the right set of globals available to doctests
                if basename.startswith("sagenb."):
                    import sage.all_notebook as sage_all
                else:
                    import sage.all_cmdline as sage_all
                sage_namespace = RecordingDict(sage_all.__dict__)
                sage_namespace['__name__'] = '__main__'
                sage_namespace['__package__'] = None
                doctests, extras = self.source.create_doctests(sage_namespace)
                timer = Timer().start()
```

I'm wondering if we should just axe the line with the `__package__` here?



---

archive/issue_comments_206695.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOK, axing doesn't work, since this line is there to undo the (apparently Sphinx-specific) setting of `__package__` to `sage`. Let me try `del`...",
    "created_at": "2014-04-18T02:42:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206695",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:12" align="right">comment:12</div>

OK, axing doesn't work, since this line is there to undo the (apparently Sphinx-specific) setting of `__package__` to `sage`. Let me try `del`...



---

archive/issue_comments_206696.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nEDIT: ignore this post.",
    "created_at": "2014-04-18T02:54:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206696",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:13" align="right">comment:13</div>

EDIT: ignore this post.



---

archive/issue_comments_206697.json:
```json
{
    "body": "Changed commit from **[`6e0f42f`](https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a)** to **[`cebac21`](https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada)**",
    "created_at": "2014-04-18T02:58:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206697",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6e0f42f`](https://github.com/sagemath/sagetrac-mirror/commit/6e0f42f336ad394f05040e379252c18c5785967a)** to **[`cebac21`](https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada)**



---

archive/issue_comments_206698.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada\"><code>cebac21</code></a></td><td><code>fixing the broken inject_shorthands methods, and modifying doctest framework so that this fix can be tested for</code></td></tr></table>\n",
    "created_at": "2014-04-18T02:58:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206698",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada"><code>cebac21</code></a></td><td><code>fixing the broken inject_shorthands methods, and modifying doctest framework so that this fix can be tested for</code></td></tr></table>




---

archive/issue_comments_206699.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nOK, forget about the second branch; I've just hijacked the main branch with what I think is a full solution. Warning: forced push!",
    "created_at": "2014-04-18T02:58:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206699",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:15" align="right">comment:15</div>

OK, forget about the second branch; I've just hijacked the main branch with what I think is a full solution. Warning: forced push!



---

archive/issue_comments_206700.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540\"><code>0b8ed45</code></a></td><td><code>same change in toric varieties code</code></td></tr></table>\n",
    "created_at": "2014-04-18T04:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206700",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540"><code>0b8ed45</code></a></td><td><code>same change in toric varieties code</code></td></tr></table>




---

archive/issue_comments_206701.json:
```json
{
    "body": "Changed commit from **[`cebac21`](https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada)** to **[`0b8ed45`](https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540)**",
    "created_at": "2014-04-18T04:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206701",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`cebac21`](https://github.com/sagemath/sagetrac-mirror/commit/cebac21b1ba3372d561760260d24442a40e75ada)** to **[`0b8ed45`](https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540)**



---

archive/issue_comments_206702.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2014-04-19T06:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206702",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_206703.json:
```json
{
    "body": "Author: **Darij Grinberg**",
    "created_at": "2014-04-19T06:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206703",
    "user": "https://github.com/tscrim"
}
```

Author: **Darij Grinberg**



---

archive/issue_events_228887.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-04-19T06:09:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228887"
}
```



---

archive/issue_events_228888.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-04-19T06:09:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228888"
}
```



---

archive/issue_comments_206704.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nLGTM.",
    "created_at": "2014-04-19T06:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206704",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

LGTM.



---

archive/issue_comments_206705.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThank you, Travis!!\n\n*blush* I guess I really should start reviewing...",
    "created_at": "2014-04-19T06:11:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206705",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:18" align="right">comment:18</div>

Thank you, Travis!!

*blush* I guess I really should start reviewing...



---

archive/issue_comments_206706.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\n* Can we not leave commented-out lines lying around?\n\n* IMHO the check should just be \n\n  ```\n  if G.get(\"__name__\", None) == \"__main__\":\n  ```\n  and not look at `__package__`. The topmost `'__main__'` frame is our guy, duh. Also this won't trip over similar issues if some frame doesn't have `__name__`.\n\n* The new doctest is just like doctests that we already have, it doesn't add anything new.",
    "created_at": "2014-04-19T23:31:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206706",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

* Can we not leave commented-out lines lying around?

* IMHO the check should just be 

  ```
  if G.get("__name__", None) == "__main__":
  ```
  and not look at `__package__`. The topmost `'__main__'` frame is our guy, duh. Also this won't trip over similar issues if some frame doesn't have `__name__`.

* The new doctest is just like doctests that we already have, it doesn't add anything new.



---

archive/issue_events_228889.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-19T23:31:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228889"
}
```



---

archive/issue_events_228890.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-19T23:31:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228890"
}
```



---

archive/issue_comments_206707.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c\"><code>94a1e8b</code></a></td><td><code>fixes suggested by Volker</code></td></tr></table>\n",
    "created_at": "2014-04-19T23:56:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206707",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c"><code>94a1e8b</code></a></td><td><code>fixes suggested by Volker</code></td></tr></table>




---

archive/issue_comments_206708.json:
```json
{
    "body": "Changed commit from **[`0b8ed45`](https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540)** to **[`94a1e8b`](https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c)**",
    "created_at": "2014-04-19T23:56:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206708",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0b8ed45`](https://github.com/sagemath/sagetrac-mirror/commit/0b8ed458f20f651b1087da7eae3d182c5801e540)** to **[`94a1e8b`](https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c)**



---

archive/issue_comments_206709.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6\"><code>648da0d</code></a></td><td><code>oops</code></td></tr></table>\n",
    "created_at": "2014-04-19T23:57:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206709",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6"><code>648da0d</code></a></td><td><code>oops</code></td></tr></table>




---

archive/issue_comments_206710.json:
```json
{
    "body": "Changed commit from **[`94a1e8b`](https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c)** to **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**",
    "created_at": "2014-04-19T23:57:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206710",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`94a1e8b`](https://github.com/sagemath/sagetrac-mirror/commit/94a1e8bbb2d67f5474d17aec16bbe83c2884167c)** to **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**



---

archive/issue_comments_206711.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nad 1: True; that was a habit from pre-git times. Removed.\n\nad 2: I have changed it now but I'm not 100% sure (what happens if we are doctesting a package?). I don't have time to run all the doctests now...\n\nad 3: I can't follow this. It is import-less and it stands at the beginning of the file. At least the first of these properties is crucial!",
    "created_at": "2014-04-19T23:58:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206711",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:22" align="right">comment:22</div>

ad 1: True; that was a habit from pre-git times. Removed.

ad 2: I have changed it now but I'm not 100% sure (what happens if we are doctesting a package?). I don't have time to run all the doctests now...

ad 3: I can't follow this. It is import-less and it stands at the beginning of the file. At least the first of these properties is crucial!



---

archive/issue_events_228891.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-20T00:00:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228891"
}
```



---

archive/issue_events_228892.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-04-20T00:00:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228892"
}
```



---

archive/issue_comments_206712.json:
```json
{
    "body": "Changed branch from **[public/combinat/inject_shorthands](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/inject_shorthands)** to **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**",
    "created_at": "2014-04-20T23:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/16181#issuecomment-206712",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/combinat/inject_shorthands](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/inject_shorthands)** to **[`648da0d`](https://github.com/sagemath/sagetrac-mirror/commit/648da0d3ee5d408f210e3f36a66d6c4f5e1bffb6)**



---

archive/issue_events_228893.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-20T23:37:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228893"
}
```



---

archive/issue_events_228894.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d2d18689b0a250fd931d818c398dbad1ab87592c",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-04-20T23:37:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/16181",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/16181#event-228894"
}
```
