# Issue 24468: NTL build with --stdlib=libc++ still uses libstdc++ for ntl_ZZ.so

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2018-02-10 15:22:43

CC:  fbissey simonking jdemeyer


```
ralf`@`ark:~/sage/pynac> ldd /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so
	linux-vdso.so.1 (0x00007ffc8f3f1000)
	libntl.so.33 => /home/ralf/sage/local/lib/libntl.so.33 (0x00007f823f6d7000)
	libgmp.so.23 => /home/ralf/sage/local/lib/libgmp.so.23 (0x00007f823f448000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f823f14b000)
	libstdc++.so.6 => /usr/lib64/libstdc++.so.6 (0x00007f823edc2000)
	libpython2.7.so.1.0 => /home/ralf/sage/local/lib/libpython2.7.so.1.0 (0x00007f823e9d8000)
	libpari-gmp-2.10.so.0 => /home/ralf/sage/local/lib/libpari-gmp-2.10.so.0 (0x00007f823def9000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f823dce2000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f823dac5000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f823d724000)
	libgf2x.so.1 => /home/ralf/sage/local/lib/libgf2x.so.1 (0x00007f823d501000)
	libc++.so.1 => /usr/lib64/libc++.so.1 (0x00007f823ff05000)
	libc++abi.so.1 => /usr/lib64/libc++abi.so.1 (0x00007f823fec2000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f823fdd6000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f823d2fd000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007f823d0fa000)
```



---

Attachment

sagelib is the culprit. It has libstdc++ hardcoded:


```
../logs/pkgs/sagelib-8.2.beta5.log:[212/474] [211/474] clang++ -pthread -shared -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/ntl/ntl_ZZ_pX.o -L/home/ralf/sage/local/lib -L/home/ralf/sage/local/lib -lntl -lgmp -lm -lstdc++ -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/libs/ntl/ntl_ZZ_pX.so -lpari
```



---

Comment by rws created at 2018-02-11 06:47:50

This is the relevant part of `src/setup.py`:

```
        # Libraries: add stdc++ if needed and sort them
        libs = kwds.get('libraries', [])
        if cplusplus:
            libs = libs + ['stdc++']
```



---

Comment by rws created at 2018-02-11 07:10:43

It seems best to add `"--stdlib=libc++"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. 

Testing this manually works, except for `element_givaro.pyx` which still gets compiled without the `"--stdlib=libc++"` directive.


---

Comment by rws created at 2018-02-11 07:15:46

Never mind, I got it compiled, yeah, now testing.


---

Comment by SimonKing created at 2018-02-11 08:48:06

Replying to [comment:4 rws]:
> It seems best to add `"--stdlib=libc++"`(else the libstdc++ is linked) only if it is already in CFLAGS. See also #24705. 

Do you mean #24707?


---

Comment by jdemeyer created at 2018-02-11 08:56:20

Changing component from packages: standard to build.


---

Comment by SimonKing created at 2018-02-11 13:58:57

Replying to [comment:3 rws]:
> This is the relevant part of `src/setup.py`:
> {{{
>         # Libraries: add stdc++ if needed and sort them
>         libs = kwds.get('libraries', [])
>         if cplusplus:
>             libs = libs + ['stdc++']
> }}}

Sorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?


---

Comment by rws created at 2018-02-11 14:22:37

Replying to [comment:10 SimonKing]:
> Replying to [comment:3 rws]:
> > This is the relevant part of `src/setup.py`:
> > {{{
> >         # Libraries: add stdc++ if needed and sort them
> >         libs = kwds.get('libraries', [])
> >         if cplusplus:
> >             libs = libs + ['stdc++']
> > }}}
> 
> Sorry, I don't get it: What would you replace it with, so that the sage library will not use `libstdc++` if `--stdlib=libc++` is provided?

At the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.


---

Comment by SimonKing created at 2018-02-11 14:34:02

Replying to [comment:11 rws]:
> At the moment we're still experimenting with flags, see #24707#comment:9. But I already think that the line above needs to be changed to `libs = libs + ['c++']` in order to get `-lc++` in the link command.

But certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?


---

Comment by rws created at 2018-02-11 14:36:02

Replying to [comment:12 SimonKing]:
> But certainly not unconditionally. Or do we want to build with `-lc++` when using gcc?

Of course (EDIT: not).


---

Comment by rws created at 2018-02-11 16:38:17

This still doesn't catch all ways to smuggle `-lstdc++` in the cython file linking stage of sagelib.
----
New commits:


---

Attachment

I did

```
export CC="clang"
export CXX="clang++ --stdlib=libc++
export CXXFLAGS="$CXXFLAGS -I/usr/include/libcxxabi/ --stdlib=libc++"
export LDFLAGS="$LDFLAGS -lc++ --stdlib=libc++"
make build
```

The build process goes pretty far, however it hangs (for an hour or so) in sagelib. See the attached log.


---

Comment by fbissey created at 2018-02-12 04:43:20

I am a bit late to this party - sorry. I don't have this problem at all with my clang configured to use libc++ by default. Is it possible to have `readelf -d /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ntl/ntl_ZZ.so` on the object initially posted?


---

Comment by rws created at 2018-02-12 07:11:12

So this ticket is wontfix. Use these flags:

```
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
```



---

Comment by rws created at 2018-02-12 07:11:12

Changing status from new to needs_review.


---

Comment by rws created at 2018-02-12 07:12:30

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2018-02-12 07:21:23

Changing status from positive_review to needs_info.


---

Comment by SimonKing created at 2018-02-12 07:21:23

Replying to [comment:19 rws]:
> So this ticket is wontfix. Use these flags:
> {{{
> export CC="clang"
> export CXX="clang++"
> export CLANG_DEFAULT_CXX_STDLIB="libc++"
> }}}

Do you claim that this is enough to override what is written in setup.py???

Recall that Sage's setup.py forces usage of `libstdc++` and not `libc++`.


---

Comment by SimonKing created at 2018-02-12 07:30:54

Replying to [comment:21 SimonKing]:
> Do you claim that this is enough to override what is written in setup.py???

Please let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?


---

Comment by fbissey created at 2018-02-12 07:32:29

`setup.py` adds `-lstdc++` to the flags used for linking but that can still be discarded by the compiler driver used. I can build sage with clang without altering `setup.py` so you should be able to. I am glad that Ralph found that environment variable.


---

Comment by rws created at 2018-02-12 07:46:02

Replying to [comment:22 SimonKing]:
> Replying to [comment:21 SimonKing]:
> > Do you claim that this is enough to override what is written in setup.py???
> 
> Please let me first test whether the given flags are enough to let the branch from #24710 build on ubuntu. Or do you even claim that with your flags scipy will build without modifications?

I do not make such claims without testing first.


---

Attachment


---

Comment by SimonKing created at 2018-02-12 09:16:28

I just tried with the branch from #24710 and with the flags stated in comment:19. But giac fails to build, see attachment:giac-1.4.9.45.p1.log


---

Comment by fbissey created at 2018-02-12 09:23:43

Replying to [comment:25 SimonKing]:
> I just tried with the branch from #24710 and with the flags stated in comment:19. But giac fails to build, see attachment:giac-1.4.9.45.p1.log

It looks like you need #24696


---

Comment by SimonKing created at 2018-02-12 09:30:42

Replying to [comment:26 fbissey]:
> Replying to [comment:25 SimonKing]:
> > I just tried with the branch from #24710 and with the flags stated in comment:19. But giac fails to build, see attachment:giac-1.4.9.45.p1.log
> 
> It looks like you need #24696

OK, trying again with #24710 and #24696


---

Comment by SimonKing created at 2018-02-12 10:45:51

Hooray, it builds now! I didn't run tests though. Anyway, to summarize what I did on ubuntu:

- install clang, clang-dev, libc++abi-dev
- checkout/merge #24710 and #24696
- 
  {{{
export CC="clang"
export CXX="clang++"
export CLANG_DEFAULT_CXX_STDLIB="libc++"
  }}}
- make

So, your finding out about `CLANG_DEFAULT_CXX_STDLIB` was great!

Side-remarks:

- I did not have the impression that building Sage with clang was faster than with gcc.
- I will now do some small timings to see about the performance of the code generated by clang vs. gcc.


---

Comment by SimonKing created at 2018-02-12 10:45:51

Changing status from needs_info to positive_review.


---

Comment by SimonKing created at 2018-02-12 11:02:39

I just realise that using #24710 was supposed to be not needed (it was closed as invalid).

Anyway, a data point concerning timings, after installing meataxe:
- With gcc
  {{{
sage: M = random_matrix(GF(9,'x'), 5000)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: N = random_matrix(GF(9,'x'), 5000)
sage: %timeit _=M-N
10 loops, best of 3: 20.5 ms per loop
sage: %timeit _=M*N
1 loop, best of 3: 46.5 s per loop
  }}}
- With clang:
  {{{
sage: M = random_matrix(GF(9,'x'), 5000)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: N = random_matrix(GF(9,'x'), 5000)
sage: %timeit _=M-N
10 loops, best of 3: 20.5 ms per loop
sage: %timeit _=M*N
1 loop, best of 3: 53.2 s per loop
  }}}

Since meataxe is heavily used in the computations that I _really_ care about (group cohomology), I am not so happy about a slow-down of almost 15%. So, probably I won't use clang in my computations. Nonetheless, it is good for portability that clang can also be used on ubuntu.


---

Comment by SimonKing created at 2018-02-12 11:38:40

I get several segfaults when testing sage.homology. Is that to be expected?


---

Comment by jdemeyer created at 2018-02-12 11:52:22

Should this ticket be closed?


---

Comment by SimonKing created at 2018-02-12 12:22:19

Replying to [comment:31 jdemeyer]:
> Should this ticket be closed?

I think so. Certainly the test failure should be for a different ticket.


---

Comment by jdemeyer created at 2018-02-12 13:17:37

Resolution: wontfix
