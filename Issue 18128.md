# Issue 18128: Definition of LU descomposition of a matrix depends on the base ring

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2015-05-04 15:04:44

CC:  kcrisman @chamanagrawal

As reported on [this ask question](http://ask.sagemath.org/question/26713/lu-descomposition-for-a-matrix/), there is an inconsistency in the definition of the LU decomposition of a matrix depending on its base ring. If a matrix `A` belongs to `ZZ`, `QQ`, `AA`, `QQbar`, `A.LU()` returns a triple `(P,L,U)` such that `A=PLU`. If a matrix `A` belongs to `RDF`, `A.LU()` returns a triple `(P,L,U)` such that `PA=LU`. For example:


```
sage: A = random_matrix(ZZ,4)
sage: A.LU()
(
[0 1 0 0]  [    1     0     0     0]  [   72    -4   -38     0]
[0 0 1 0]  [    0     1     0     0]  [    0    -1    -2    10]
[1 0 0 0]  [ 1/36   8/9     1     0]  [    0     0  17/6 -80/9]
[0 0 0 1], [-1/36   1/9    -1     1], [    0     0     0   -17]
)
sage: B = A.change_ring(RDF)
sage: B.LU()
(
[0.0 0.0 1.0 0.0]
[1.0 0.0 0.0 0.0]
[0.0 1.0 0.0 0.0]
[0.0 0.0 0.0 1.0],

[             1.0              0.0              0.0              0.0]
[             0.0              1.0              0.0              0.0]
[ 0.0277777777778   0.888888888889              1.0              0.0]
[-0.0277777777778   0.111111111111             -1.0              1.0],

[          72.0           -4.0          -38.0            0.0]
[           0.0           -1.0           -2.0           10.0]
[           0.0            0.0  2.83333333333 -8.88888888889]
[           0.0            0.0            0.0          -17.0]
)


sage: B.LU()[0] == A.LU()[0]
False
sage: B.LU()[0] == A.LU()[0].transpose()
True
sage: 
```


The aim of this ticket is to fix this inconsistency and choose a common definition for all rings.



---

Comment by tmonteil created at 2015-05-04 15:17:11

It is worth noticing that the source code for matrices over `RDF` calls `scipy.linalg.lu` which returns a triple `(P,L,U)` such that `A=PLU` and then transpose `P` with the documentation:


```
# Numpy has a different convention than we had with GSL
# So we invert (transpose) the P to match our prior behavior
# TODO: It's an awful waste to store a huge matrix for P, which
# is just a simple permutation, really.
```


So, i guess this extra transposition should be reverted, so that it becomes consistent with both `scipy` and the implementation for exact rings.


---

Comment by kcrisman created at 2019-03-04 20:20:04

Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.


---

Comment by @ChamanAgrawal created at 2019-03-08 11:53:48

New commits:


---

Comment by @ChamanAgrawal created at 2019-03-08 11:53:48

Changing status from new to needs_review.


---

Comment by @ChamanAgrawal created at 2019-03-08 12:05:50

I have removed to the extra copy of the matrix and also reverted the transposing step to maintain consistent behavior with scipy and also with `LU()` in matrices of other class in sagemath.


---

Comment by SimonKing created at 2019-04-01 07:25:40

Replying to [comment:3 kcrisman]:
> Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.

The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?

Do you say that if the `.LU()` method is used for a matrix over RDF then a deprecation warning should be used? That warning would appear also in the case that the user expects the new (not the old) behaviour, i.e., when a warning is inappropriate.


---

Comment by kcrisman created at 2019-04-01 11:51:23

> The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?

Good point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a "silent" change.  But they should agree over all rings, yes.


---

Comment by @ChamanAgrawal created at 2019-04-01 12:04:51

Replying to [comment:7 kcrisman]:
> 
> > The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?
> 
> Good point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a "silent" change.  But they should agree over all rings, yes.

I think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?


---

Comment by SimonKing created at 2019-04-01 12:09:59

Replying to [comment:8 gh-ChamanAgrawal]:
> I think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?

I don't think so. A warning (in the sense of: "If M.LU() is called then a warning is printed") is disturbing, because the mere fact of calling `.LU()` is _not_ a problem. What is a potential problem is whether or not the user expects the output in a particular form. And we cannot guess on the expectation of the user. Hence, certainly it should be written in the documentation that there has been a change, give an example for which that change happens, and insert a link to this ticket. The syntax for such link in the docstrings is

```
See :trac:`18365`.
```

But there should be no warning inserted into the code.


---

Comment by git created at 2019-04-01 13:54:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @ChamanAgrawal created at 2019-04-01 13:57:24

I have added a note for the change as below, any suggestion for change? 

```
.. NOTE::
            The behaviour of ``LU()`` has been changed. Earlier ``LU()`` 
            returned ``P,L,U`` such that ``P*A=L*U``, where ``P`` represents
            the permutation and is the matrix inverse of the ``P`` returned
            by this method. The computation of this matrix inverse can be accomplished
            quickly with just a transpose as the matrix is orthogonal/unitary.
                
            For Details See :trac:`18365`.

        EXAMPLES::

            sage: m = matrix(RDF,4,range(16))
            sage: P,L,U = m.LU()
            sage: P*L*U # rel tol 2e-16
            [ 0.0  1.0  2.0  3.0]
            [ 4.0  5.0  6.0  7.0]
            [ 8.0  9.0 10.0 11.0]
            [12.0 13.0 14.0 15.0]
            
        Below example illustrate the change in behaviour of ``LU()``. ::

            sage: m == P*L*U
            True
            sage: P*m == L*U
            False
```



---

Comment by @mwageringel created at 2020-02-27 22:46:04

I suggest that this gets merged now, despite the backwards incompatibility.


---

Comment by @mwageringel created at 2020-03-08 13:24:29

I have made small formatting changes to the documentation and removed trailing whitespace. I will let the patchbot run on this ticket once more and then set it to positive.
----
New commits:


---

Comment by @mwageringel created at 2020-03-11 18:48:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-03-12 22:48:18

Resolution: fixed
