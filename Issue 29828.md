# Issue 29828: SR.var('x', domain='real') and assume(x, 'real') are very slow

Issue created by migration from https://trac.sagemath.org/ticket/30065

Original creator: mkoeppe

Original creation time: 2020-07-04 18:05:46

CC:  egourgoulhon tmonteil mjo

(from #30061)


---

Comment by mkoeppe created at 2020-07-05 02:02:10


```
sage: %prun for i in range(10000): x = SR.var('x', domain='real')
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  1030001   79.176    0.000   87.914    0.000 maxima_lib.py:412(_eval_line)
   500000    5.826    0.000    6.854    0.000 maxima_lib.py:274(max_to_string)
   230000    1.408    0.000   11.558    0.000 interface.py:1146(_repr_)
   500000    1.027    0.000    1.027    0.000 {method 'python' of 'sage.libs.ecl.EclObject' objects}
   250000    0.944    0.000   14.659    0.000 maxima_abstract.py:1610(__len__)
```



---

Comment by mkoeppe created at 2020-07-05 05:20:52


```
sage: %prun for i in range(3000): x = SR.var('x', domain='real')
   309000   23.496    0.000   26.177    0.000 maxima_lib.py:412(_eval_line)
sage: %prun for i in range(3000): assume(x, 'real')
   309000   29.508    0.000   32.219    0.000 maxima_lib.py:412(_eval_line)
```

Gets slower every time. 

```
sage: %prun for i in range(3000): assume(x, 'real')
   309000   39.085    0.000   42.002    0.000 maxima_lib.py:412(_eval_line)
sage: %prun for i in range(3000): assume(x, 'real')
   309000   54.613    0.000   57.968    0.000 maxima_lib.py:412(_eval_line)
```



---

Comment by mkoeppe created at 2020-07-05 06:15:21

Some low-hanging fruit here.
----
New commits:


---

Comment by mkoeppe created at 2020-07-05 06:15:53


```
sage: %prun for i in range(10000): x = SR.var('x', domain='real')
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    70097    8.210    0.000    8.683    0.000 maxima_lib.py:412(_eval_line)
       25    0.651    0.026    0.651    0.026 {built-in method sage.libs.ecl.ecl_eval}
    10000    0.298    0.000   12.105    0.001 {method 'var' of 'sage.symbolic.ring.SymbolicRing' objects}
    20048    0.273    0.000    0.325    0.000 maxima_lib.py:274(max_to_string)
```



---

Comment by mkoeppe created at 2020-07-05 07:25:40

More can be done by caching `GenericDeclaration`:

```diff
diff --git a/src/sage/symbolic/assumptions.py b/src/sage/symbolic/assumptions.py
index 3e0ca736ba..827ab61b67 100644
--- a/src/sage/symbolic/assumptions.py
+++ b/src/sage/symbolic/assumptions.py
@@ -71,11 +71,13 @@ Assumptions are added and in some cases checked for consistency::
 from sage.structure.sage_object import SageObject
 from sage.rings.all import ZZ, QQ, RR, CC
 from sage.symbolic.ring import is_SymbolicVariable
+from sage.structure.unique_representation import UniqueRepresentation
+
 _assumptions = []
 
 _valid_feature_strings = set()
 
-class GenericDeclaration(SageObject):
+class GenericDeclaration(UniqueRepresentation):
     """
     This class represents generic assumptions, such as a variable being
     an integer or a function being increasing. It passes such
```

... but the semantics of the `assume` and `forget` methods are not very clear...


---

Comment by mkoeppe created at 2020-07-06 02:43:41

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-06 02:43:41

Changing priority from major to minor.


---

Comment by mkoeppe created at 2020-07-06 02:43:41

I'll investigate further improvements on follow-up tickets. Needs review


---

Comment by mkoeppe created at 2020-07-06 06:54:05

Follow-up: #30074


---

Comment by tscrim created at 2020-07-06 08:29:45

Perhaps it would be better to do

```diff
-_valid_feature_strings = set(repr(x).strip() for x in list(maxima("features")))
+_valid_feature_strings.update(repr(x).strip() for x in list(maxima("features")))
```

so it doesn't overwrite the `_valid_feature_strings` but instead just adds to it?


---

Comment by git created at 2020-07-06 12:15:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-06 12:15:57

Good idea, done.


---

Comment by tscrim created at 2020-07-07 00:50:56

Thanks.


---

Comment by tscrim created at 2020-07-07 00:50:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-07 01:27:43

Thank you!


---

Comment by @mjungmath created at 2020-07-14 19:41:06

Patchbot is complaining. Apparently, this is due to the preexisting code (line 971):

https://www.flake8rules.com/rules/E701.html

Should this be fixed right on the fly?


---

Comment by git created at 2020-07-14 19:50:34

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-07-14 19:50:34

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-07-14 19:52:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-14 19:53:06

Actually no, this ticket is already on Volker's branch.


---

Comment by mkoeppe created at 2020-07-14 19:53:06

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-14 19:55:23

I've put the commit on #30074 instead


---

Comment by vbraun created at 2020-07-15 22:25:08

Resolution: fixed
