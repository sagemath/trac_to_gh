# Issue 31348: Wrong result due to integer overflow (in pynac?)

Issue created by migration from https://trac.sagemath.org/ticket/31585

Original creator: @DaveWitteMorris

Original creation time: 2021-03-31 03:21:34

Keywords: integer overflow, pynac

Volker Braun pointed out in ticket:31479#comment:12 that sage gives the following wrong answer on a 32-bit machine after the bug-fix patch of #31479 is applied:

```
sage: a,b,c,d = var("a b c d")
sage: ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36
```

This answer is congruent modulo `2^32` to `d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36`, which is the correct answer, so it seems clear that the problem comes from an integer overflow error. Perhaps the overflow error can also be produced on a 64-bit machine.


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by @DaveWitteMorris created at 2021-06-10 19:19:34

I reproduced the bug by installing sage in a 32-bit debian virtual machine, and found a much simpler example of the overflow:

```
sage: (2*x).subs(x=-2^31)
0
```

More generally:

```
sage: for n in range(10):
....:     print(n, (n*x).subs(x=-2^31)/2^31)
0 0
1 -1
2 0
3 -1
4 0
5 -1
6 0
7 -1
8 0
9 -1
```



---

Comment by @DaveWitteMorris created at 2021-06-10 22:52:37

I think the problem is an incorrect calculation of absolute value:

```
sage: abs(x).subs(x=-2^31)
-2147483648
```

To decide whether a multiplication might cause an overflow, pynac compares the absolute values of the factors to a certain bound. In the example of comment:2, the absolute value of a factor is negative, so it is less than the bound, even though the factor is actually very large.

And I think the incorrect absolute value comes from the C++ `std::labs` function. The documentation of that function says "If the result cannot be represented as a long int (such as labs(LONG_MIN) in an implementation with two's complement signed values), it causes undefined behavior."

I should be able to write a pynac patch soon that tests my theory. Even if it isn't the bug we are looking for, this bug in the absolute value needs to be fixed.


---

Comment by @DaveWitteMorris created at 2021-06-10 23:21:29

The same problem comes up in pynac's `numeric::negative` method, so that will need to be fixed too:

```
sage: (-x).subs(x=-2^31)
-2147483648
```



---

Comment by @DaveWitteMorris created at 2021-06-15 20:01:42

Here is a crash that is caused by the overflow when `-2^31` is divided by `-1`:

```
sage: (1 - 2^31*x)*x
    <snip>
Unhandled SIGFPE: An unhandled floating point exception occurred. ...
```


Patches to fix all of these should be coming soon.


---

Comment by @DaveWitteMorris created at 2021-06-16 15:57:32

The pynac bugs on this ticket do not currently affect 64-bit sage.  (This is because pynac does not store `-2^63` as a `long integer`, even though it could fit into that space on a 64-bit machine.)  However, they will affect 64-bit machines after the branch on #31986 is merged.  (See the explanation and examples there.)  Hence, a 64-bit user can test the PR of this ticket by first merging the branch of #31986 (and executing `sage -f pynac`), and replacing `-2^31` with `-2^63`, as in the examples in the description of #31986.

Followup tickets: #31984 and #31986.

I will try to post this (and my other pynac patches) to the pynac github repository soon.  My previous attempts failed because I know almost nothing about git, but now I understand that I need a fork, instead of a clone, so I hope to be successful.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-06-16 15:57:32

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-06-19 07:58:58

I think this pynac patch also fixes #25688.


---

Comment by tscrim created at 2021-06-20 23:53:04

Merge conflict


---

Comment by tscrim created at 2021-06-20 23:53:04

Changing status from needs_review to needs_work.


---

Comment by @DaveWitteMorris created at 2021-06-28 04:56:16

Rebased on 9.4b3.
----
New commits:


---

Comment by mkoeppe created at 2021-06-28 05:03:42

PR to pynac please


---

Comment by @DaveWitteMorris created at 2021-06-28 05:10:49

Yes, I will try.


---

Comment by @DaveWitteMorris created at 2021-06-28 05:10:49

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-28 07:35:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2021-06-28 07:44:59

I previously neglected to fix the `/=` operator, which can also overflow.

I created [pynac PR #378](https://github.com/pynac/pynac/pull/378). It's my first PR to anywhere other than the trac server, so please let me know if I goofed anything up.


---

Comment by dimpase created at 2021-06-28 08:32:25

Has this been tested on 32-bit?


---

Comment by @DaveWitteMorris created at 2021-06-28 08:59:00

The original patch seemed to be fine, but I haven't tested the final commit yet. I hope to run doctests on my 32-bit debian virtual machine tomorrow. (I had trouble updating to 9.4b3, so I did `make distclean` and it is still building.)


---

Comment by dimpase created at 2021-06-28 09:16:52

OK, it should be made on top of #31694, anyway, no rush. I'll test and update.


---

Comment by dimpase created at 2021-06-28 09:16:52

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-06-28 10:08:09

New commits:


---

Comment by git created at 2021-06-28 10:12:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-28 10:14:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-28 10:58:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-28 11:00:14

OK, all should be ready now for one last look.


---

Comment by dimpase created at 2021-06-28 11:00:14

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-06-28 11:08:48

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-06-28 11:24:37

running GH Actions tests on this https://github.com/sagemath/sagetrac-mirror/actions/runs/978774922
(basically to test #31694)


---

Comment by mkoeppe created at 2021-06-29 00:39:25

PR with standard-conforming code at https://github.com/pynac/pynac/pull/379


---

Comment by mkoeppe created at 2021-06-29 00:43:55

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-06-29 09:30:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-29 09:36:02

tests at https://github.com/sagemath/sagetrac-mirror/actions/runs/982168057


---

Comment by git created at 2021-06-29 11:07:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-29 11:12:49

update - https://github.com/sagemath/sagetrac-mirror/actions/runs/982441436
----
New commits:


---

Comment by mkoeppe created at 2021-06-30 03:15:46

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-30 03:15:46

New commits:


---

Comment by git created at 2021-06-30 03:18:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-30 13:53:22

tests run on https://github.com/sagemath/sagetrac-mirror/actions/runs/986545913


---

Comment by dimpase created at 2021-07-01 13:11:31

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-07-01 13:11:31

lgtm


---

Comment by mkoeppe created at 2021-07-01 16:14:36

Thanks!


---

Comment by vbraun created at 2021-07-06 21:29:40

Resolution: fixed
