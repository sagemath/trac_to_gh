# Issue 29188: local-conda-forge-macos-standard: Build error with numpy

Issue created by migration from https://trac.sagemath.org/ticket/29425

Original creator: mkoeppe

Original creation time: 2020-03-29 14:47:04

CC:  isuruf dimpase jdemeyer embray slelievre vbraun

numpy build fails on macOS with conda-forge (https://github.com/mkoeppe/sage/runs/542501526)

```
Traceback (most recent call last):
  File "numpy/core/setup_common.py", line 241, in check_long_double_representation
    ltype = long_double_representation(pyod(obj))
  File "numpy/core/setup_common.py", line 401, in long_double_representation
    raise ValueError("Could not lock sequences (%s)" % saw)
ValueError: Could not lock sequences (None)
```


This can be tested with #29415:

```
  tox -e local-conda-forge-macos-standard
```



---

Comment by isuruf created at 2020-03-29 20:02:55

Can you try setting `NPY_DISTUTILS_APPEND_FLAGS=1` in the numpy build script?


---

Comment by mkoeppe created at 2020-03-29 22:30:54

This didn't make a difference


---

Comment by mkoeppe created at 2020-03-30 00:29:48

Upgrading numpy to 1.18.2 fixes it; but this will require a Cython upgrade too


---

Comment by mkoeppe created at 2020-03-30 00:54:43

New commits:


---

Comment by mkoeppe created at 2020-03-30 01:10:24

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-30 01:10:56

Tests run at https://github.com/mkoeppe/sage/actions/runs/66127777


---

Comment by isuruf created at 2020-03-30 01:12:45

Cython URL can be set to `https://pypi.io/packages/source/C/Cython/Cython-VERSION.tar.gz`


---

Comment by git created at 2020-03-30 01:58:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-30 01:58:50

Thanks!


---

Comment by isuruf created at 2020-03-30 02:06:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-30 12:19:06

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-03-30 12:19:06

Breaks py2 builds

```
Traceback (most recent call last):
  File "setup.py", line 32, in <module>
    raise RuntimeError("Python version >= 3.5 required.")
RuntimeError: Python version >= 3.5 required.
}}


---

Comment by mkoeppe created at 2020-03-30 12:27:54

Setting milestone to 9.2, which is presumably the first py3-only release


---

Comment by mkoeppe created at 2020-03-30 12:27:54

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2020-03-30 12:33:55

I'll check whether an update to NumPy 1.16.6 (supports py2) also fixes the problem.


---

Comment by mkoeppe created at 2020-03-30 22:52:44

That is #29429 - Upgrade numpy to 1.16.6 (last release supporting py2)


---

Comment by mkoeppe created at 2020-03-31 13:17:42

Changing priority from critical to major.


---

Comment by mkoeppe created at 2020-04-08 20:58:20

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-05-10 20:11:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-05-10 20:12:48

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-05-10 20:12:48

(untested)


---

Comment by enriqueartal created at 2020-05-13 15:04:43

I am trying to use it. I had a first problem, it did not download the required version of cython, solved by downloading and putting it in upstream. The same happened for numpy, but it does not look for the package in upstream and failed. By some reason, giac also fail with a message like "undefined reference to `__gmpn_add_nc'"


---

Comment by mkoeppe created at 2020-05-13 19:53:11

To enable automatic downloads, use `./configure --enable-download-from-upstream-url`.


---

Comment by mkoeppe created at 2020-05-13 19:54:05

The giac build failure - is this in a build from scratch?


---

Comment by enriqueartal created at 2020-05-13 21:50:08

No, maybe it is a problem of mixing gcc9 and gcc10

Replying to [comment:27 mkoeppe]:
> The giac build failure - is this in a build from scratch?


---

Comment by enriqueartal created at 2020-05-14 13:45:17

Both numpy and scipy can be reached, but the following problem appears. If solved, I will try to build from scratch.

Installing scipy-1.4.1
Download error on https://pypi.org/simple/pybind11/: [Errno 110] Connection timed out -- Some packages may not be found!
Couldn't find index page for 'pybind11' (maybe misspelled?)


---

Comment by mkoeppe created at 2020-05-14 18:22:47

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-05-14 18:22:47

Thanks for catching this. This is an additional dependency that we need to ship.
https://github.com/scipy/scipy/blob/master/pyproject.toml


---

Comment by git created at 2020-05-14 19:04:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-14 19:04:53

Changing status from needs_work to needs_review.


---

Comment by enriqueartal created at 2020-05-15 18:49:11

I compiled from scratch using gcc10. Besides the expected  failures of palp and sympow, these are the last lines of the log of scipy. 


    error: Command "gfortran -Wall -g -ffixed-form -fno-second-underscore -fPIC -fPIC -O3 -funroll-loops -Iscipy/sparse/linalg/eigen/arpack/ARPACK/SRC -I/home/artal/sage/local/lib/python3.7/site-packages/numpy/core/include -c -c scipy/sparse/linalg/eigen/arpack/ARPACK/SRC/dsaitr.f -o build/temp.linux-x86_64-3.7/scipy/sparse/linalg/eigen/arpack/ARPACK/SRC/dsaitr.o" failed with exit status 1
    Running setup.py install for scipy: finished with status 'error'
Cleaning up...
  Removing source in /tmp/pip-req-build-yghxywzq
Removed build tracker '/tmp/pip-req-tracker-maw6u14m'
Command "/home/artal/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-yghxywzq/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-axtqqq0z/install-record.txt --single-version-externally-managed --root /home/artal/sage/local/var/tmp/sage/build/scipy-1.4.1/inst --compile" failed with error code 1 in /tmp/pip-req-build-yghxywzq/
Exception information:
Traceback (most recent call last):
  File "/home/artal/sage/local/lib/python3.7/site-packages/pip/_internal/cli/base_command.py", line 143, in main
    status = self.run(options, args)
  File "/home/artal/sage/local/lib/python3.7/site-packages/pip/_internal/commands/install.py", line 366, in run
    use_user_site=options.use_user_site,
  File "/home/artal/sage/local/lib/python3.7/site-packages/pip/_internal/req/__init__.py", line 49, in install_given_reqs
    **kwargs
  File "/home/artal/sage/local/lib/python3.7/site-packages/pip/_internal/req/req_install.py", line 791, in install
    spinner=spinner,
  File "/home/artal/sage/local/lib/python3.7/site-packages/pip/_internal/utils/misc.py", line 705, in call_subprocess
    % (command_desc, proc.returncode, cwd))
pip._internal.exceptions.InstallationError: Command "/home/artal/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-yghxywzq/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-axtqqq0z/install-record.txt --single-version-externally-managed --root /home/artal/sage/local/var/tmp/sage/build/scipy-1.4.1/inst --compile" failed with error code 1 in /tmp/pip-req-build-yghxywzq/
Error: installing with pip3 failed


---

Comment by dimpase created at 2020-05-29 09:12:21

what's the status of here? are we really waiting for gcc10 starting to work?


---

Comment by mkoeppe created at 2020-05-29 15:01:25

No, just waiting for review of this ticket and its dependency #29480.


---

Comment by dimpase created at 2020-05-29 17:30:02

I get doctest errors due to

```
DeprecationWarning: scipy.array is deprecated and will be removed in SciPy 2.0.0, use numpy.array instead
```

namely, 

```
sage -t --warn-long 76.6 src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 9789, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    G.pagerank(algorithm="Scipy") # abs tol 1e-9
Expected:
    {1: 0.16112205885619563,
     2: 0.1619531043247219,
     3: 0.16112205885619563,
     4: 0.2374999999999999,
     5: 0.17775588228760858,
     6: 0.100546895675278}
Got:
    doctest:warning
....
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[7]>", line 1, in <module>
        G.pagerank(algorithm="Scipy") # abs tol 1e-9
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/graphs/generic_graph.py", line 9880, in pagerank
        dangling=dangling)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/networkx/algorithms/link_analysis/pagerank_alg.py", line 429, in pagerank_scipy
        S = scipy.array(M.sum(axis=1)).flatten()
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/scipy/_lib/deprecation.py", line 19, in call
        stacklevel=stacklevel)
      File "/usr/lib64/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    DeprecationWarning: scipy.array is deprecated and will be removed in SciPy 2.0.0, use numpy.array instead
```


it seems that these warnings are coming from scipy itself, or from networkx
(which in turn calls scipy).

Let me see if upgrading networkx helps.


---

Comment by dimpase created at 2020-05-29 17:41:22

No, with networkx 2.4 one still gets these warnings, but they are fixed upstream, just not yet released, see 
https://github.com/networkx/networkx/commit/ea19baaff252468f5a911260430e057393d9637d


---

Comment by dimpase created at 2020-05-29 17:44:20

So we can patch networkx, or modify doctests, or suppress warning somehow (for the latter, I vaguely remember it's possible, but can't find it in docs)


---

Comment by mkoeppe created at 2020-05-29 22:16:15

Filtering out doctest warnings was done on one of the recent glpk tickets


---

Comment by dimpase created at 2020-05-30 22:23:45

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-05-30 22:23:45

Replying to [comment:40 mkoeppe]:
> Filtering out doctest warnings was done on one of the recent glpk tickets
I don't know how to filter multiline warnings with python backtraces.

OK, I've opened #29766 to fix this. This one is good to go, modulo the latter.


---

Comment by dimpase created at 2020-06-01 10:11:10

drop the networkx dependency with the latest patch (and rebase over latest beta).


---

Comment by dimpase created at 2020-06-01 10:11:59

New commits:


---

Comment by dimpase created at 2020-06-01 10:13:35

Replying to [comment:40 mkoeppe]:
> Filtering out doctest warnings was done on one of the recent glpk tickets

added the last commit to suppress the warning in the proper Pythonic way. The rest stays (mod rebase)


---

Comment by vbraun created at 2020-06-04 22:03:39

I'm getting various test failures


---

Comment by vbraun created at 2020-06-04 22:03:39

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-06-04 22:21:17

An upgrade ticket like this really needs to be run on the [GitHub](GitHub) test infrastructure...


---

Comment by dimpase created at 2020-06-04 22:39:07

running GH Actions test here https://github.com/dimpase/sage/pull/9


---

Comment by dimpase created at 2020-06-05 13:09:18

Replying to [comment:47 mkoeppe]:
> An upgrade ticket like this really needs to be run on the [GitHub](GitHub) test infrastructure...
Unfortunately there seem to be problems with runner setups, e.g. here 
https://github.com/dimpase/sage/runs/740349791?check_suite_focus=true
- this is `docker (archlinux-latest, standard-gcc_spkg)`
I see

```
2020-06-04T22:39:01.9688082Z Suggested packages:
2020-06-04T22:39:01.9688790Z   python3-pytest python-setuptools-doc
```

and a lot of 

```
2020-06-05T03:08:41.2134392Z Failure: ModuleNotFoundError (No module named 'pytest') ... ERROR
```

which seems to suggest that `python3-pytest` is a requirement.

Do you know how to fix this?

(there are other errors pointing at internal problems of runners)

Can we easily extend setup to use our own runners?


---

Comment by mkoeppe created at 2020-06-06 04:38:00

Apparently, running the testsuite of networkx requires pytest. Let's discuss this on #29766.

I don't think this has anything to do with [GitHub](GitHub).


---

Comment by mkoeppe created at 2020-06-06 05:25:49

In the meantime, numpy 1.18.5 has appeared


---

Comment by mkoeppe created at 2020-06-06 05:34:32

Tests (with #29766) run at https://github.com/mkoeppe/sage/pull/38/checks
----
New commits:


---

Comment by mkoeppe created at 2020-06-06 05:37:45

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-06 18:54:55

Can this ticket be tested successfully by itself or only as part of the `networkx` upgrade in #29766?  If the latter, then let's close this ticket and merge it into #29766.


---

Comment by dimpase created at 2020-06-06 20:57:13

Replying to [comment:56 mkoeppe]:
> Can this ticket be tested successfully by itself or only as part of the `networkx` upgrade in #29766?  If the latter, then let's close this ticket and merge it into #29766.

no, this one does not need #29766


---

Comment by mkoeppe created at 2020-06-06 21:39:03

OK, running a new test without #29766 at https://github.com/mkoeppe/sage/pull/39/checks


---

Comment by mkoeppe created at 2020-06-07 02:57:46

Replying to [comment:57 dimpase]:
> Replying to [comment:56 mkoeppe]:
> > Can this ticket be tested successfully by itself or only as part of the `networkx` upgrade in #29766?  If the latter, then let's close this ticket and merge it into #29766.
> 
> no, this one does not need #29766

Actually, on `ubuntu-xenial-standard` (https://github.com/mkoeppe/sage/runs/745921419), I see lots of failures from the `networkx` testsuite such as this one:

```
File "/sage/local/var/tmp/sage/build/networkx-2.2/src/networkx/drawing/nx_pylab.py", line 249, in networkx.drawing.nx_pylab.draw_networkx
Failed example:
    nx.draw(G)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/lib/python3.7/doctest.py", line 1329, in __run
        compileflags, 1), test.globs)
      File "<doctest networkx.drawing.nx_pylab.draw_networkx[1]>", line 1, in <module>
        nx.draw(G)
      File "/sage/local/var/tmp/sage/build/networkx-2.2/src/networkx/drawing/nx_pylab.py", line 126, in draw
        draw_networkx(G, pos=pos, ax=ax, **kwds)
      File "/sage/local/var/tmp/sage/build/networkx-2.2/src/networkx/drawing/nx_pylab.py", line 278, in draw_networkx
        edge_collection = draw_networkx_edges(G, pos, arrows=arrows, **kwds)
      File "/sage/local/var/tmp/sage/build/networkx-2.2/src/networkx/drawing/nx_pylab.py", line 611, in draw_networkx_edges
        if cb.is_numlike(alpha):
    AttributeError: module 'matplotlib.cbook' has no attribute 'is_numlike'
```



---

Comment by mkoeppe created at 2020-06-07 03:03:52

Therefore, let's close this ticket and continue on #29766.


---

Comment by dimpase created at 2020-06-11 22:54:47

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-06-20 06:24:41

Resolution: duplicate
