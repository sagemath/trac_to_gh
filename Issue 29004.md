# Issue 29004: gfortran on 32bit: Configure for the same ABI as gcc

archive/issues_029004.json:
```json
{
    "body": "CC:  @dimpase tmonteil @vbraun @jhpalmieri @orlitzky\n\nThe `i386-minimal` targets have build errors compiling `gfortran` (see for example https://github.com/mkoeppe/sage/runs/463683795) because of ABI mismatch. These tests are running 32-bit distributions on a 64-bit kernel. `gfortran` tries to build native (64-bit) but that fails because the corresponding architecture files are missing.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29241\n\n",
    "created_at": "2020-02-24T08:00:12Z",
    "labels": [
        "porting",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "gfortran on 32bit: Configure for the same ABI as gcc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29004",
    "user": "@mkoeppe"
}
```
CC:  @dimpase tmonteil @vbraun @jhpalmieri @orlitzky

The `i386-minimal` targets have build errors compiling `gfortran` (see for example https://github.com/mkoeppe/sage/runs/463683795) because of ABI mismatch. These tests are running 32-bit distributions on a 64-bit kernel. `gfortran` tries to build native (64-bit) but that fails because the corresponding architecture files are missing.



Issue created by migration from https://trac.sagemath.org/ticket/29241





---

archive/issue_comments_410536.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-03T03:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410536",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410537.json:
```json
{
    "body": "Tested on `docker-debian-buster-i386-minimal`, where the gfortran build now succeeds.\nNeeds review.\n----\nNew commits:",
    "created_at": "2020-03-03T03:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410537",
    "user": "@mkoeppe"
}
```

Tested on `docker-debian-buster-i386-minimal`, where the gfortran build now succeeds.
Needs review.
----
New commits:



---

archive/issue_comments_410538.json:
```json
{
    "body": "Anyone interested in reviewing this?",
    "created_at": "2020-03-08T20:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410538",
    "user": "@mkoeppe"
}
```

Anyone interested in reviewing this?



---

archive/issue_comments_410539.json:
```json
{
    "body": "I don't know how to set up an environment where this change matters.",
    "created_at": "2020-03-08T20:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410539",
    "user": "@dimpase"
}
```

I don't know how to set up an environment where this change matters.



---

archive/issue_comments_410540.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-08T22:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410540",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410541.json:
```json
{
    "body": "Will the gfortran `spkg-install` file ever be run on OS X?\n\n```\n$ gcc -print-multiarch\nclang: error: unknown argument: '-print-multiarch'\nclang: error: no input files\n```\n",
    "created_at": "2020-03-09T01:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410541",
    "user": "@jhpalmieri"
}
```

Will the gfortran `spkg-install` file ever be run on OS X?

```
$ gcc -print-multiarch
clang: error: unknown argument: '-print-multiarch'
clang: error: no input files
```




---

archive/issue_comments_410542.json:
```json
{
    "body": "The equivalent option with clang is `gcc -print-target-triple`",
    "created_at": "2020-03-09T01:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410542",
    "user": "@mkoeppe"
}
```

The equivalent option with clang is `gcc -print-target-triple`



---

archive/issue_comments_410543.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-09T01:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410543",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_410544.json:
```json
{
    "body": "Well, on OS X building for i386 no longer works. But I'll add clang support just in case for FreeBSD.",
    "created_at": "2020-03-09T03:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410544",
    "user": "@mkoeppe"
}
```

Well, on OS X building for i386 no longer works. But I'll add clang support just in case for FreeBSD.



---

archive/issue_comments_410545.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-09T03:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410545",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410546.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-09T03:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410546",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_410547.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> I don't know how to set up an environment where this change matters.\nTests ran at https://github.com/mkoeppe/sage/runs/493828325\n\nFixed: `ubuntu-bionic-i386-minimal`, `ubuntu-eoan-i386-minimal`, `debian-buster-i386-minimal`.\n\nRemaining error: `centos-7-i386-minimal` (https://github.com/mkoeppe/sage/runs/493828336)",
    "created_at": "2020-03-09T21:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410547",
    "user": "@mkoeppe"
}
```

Replying to [comment:5 dimpase]:
> I don't know how to set up an environment where this change matters.
Tests ran at https://github.com/mkoeppe/sage/runs/493828325

Fixed: `ubuntu-bionic-i386-minimal`, `ubuntu-eoan-i386-minimal`, `debian-buster-i386-minimal`.

Remaining error: `centos-7-i386-minimal` (https://github.com/mkoeppe/sage/runs/493828336)



---

archive/issue_comments_410548.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-09T21:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410548",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410549.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-10T23:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410549",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410550.json:
```json
{
    "body": "Tests at https://github.com/mkoeppe/sage/actions/runs/53297072",
    "created_at": "2020-03-10T23:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410550",
    "user": "@mkoeppe"
}
```

Tests at https://github.com/mkoeppe/sage/actions/runs/53297072



---

archive/issue_comments_410551.json:
```json
{
    "body": "This fixed the remaining platform `centos-7-i386-minimal`.\n\nReady for review.",
    "created_at": "2020-03-11T18:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410551",
    "user": "@mkoeppe"
}
```

This fixed the remaining platform `centos-7-i386-minimal`.

Ready for review.



---

archive/issue_comments_410552.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-15T23:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410552",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_410553.json:
```json
{
    "body": "I'll have to take your word for it that this fixes the problem. Some implementation nitpicks:\n\n\n```\nARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`\n```\n\n\nThe form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).\n\nAnd if you explicitly want to call GCC here, shouldn't you use \"gcc\" instead of $CC?\n\n\n```\n    x86_64,i[3-6]86*)\n```\n\n\nPersonally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.",
    "created_at": "2020-03-16T00:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410553",
    "user": "@orlitzky"
}
```

I'll have to take your word for it that this fixes the problem. Some implementation nitpicks:


```
ARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`
```


The form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).

And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?


```
    x86_64,i[3-6]86*)
```


Personally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.



---

archive/issue_comments_410554.json:
```json
{
    "body": "Replying to [comment:20 mjo]:\n> I'll have to take your word for it that this fixes the problem. \n\nThe logs on the various machines are available at the links posted.\n\n> Some implementation nitpicks:\n> \n> {{{\n> ARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`\n> }}}\n> \n> The form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).\nOK will do.\n\n> \n> And if you explicitly want to call GCC here, shouldn't you use \"gcc\" instead of $CC?\n\nNo, this needs to run the specific compiler that is configured!\n\n> {{{\n>     x86_64,i[3-6]86*)\n> }}}\n> \n> Personally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.\n\nOK will do.",
    "created_at": "2020-03-16T00:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410554",
    "user": "@mkoeppe"
}
```

Replying to [comment:20 mjo]:
> I'll have to take your word for it that this fixes the problem. 

The logs on the various machines are available at the links posted.

> Some implementation nitpicks:
> 
> {{{
> ARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`
> }}}
> 
> The form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).
OK will do.

> 
> And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?

No, this needs to run the specific compiler that is configured!

> {{{
>     x86_64,i[3-6]86*)
> }}}
> 
> Personally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.

OK will do.



---

archive/issue_comments_410555.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> > And if you explicitly want to call GCC here, shouldn't you use \"gcc\" instead of $CC?\n> \n> No, this needs to run the specific compiler that is configured!\n\nIn particular, this is supposed to work also if CC is configured to be \"gcc -m32\".",
    "created_at": "2020-03-16T00:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410555",
    "user": "@mkoeppe"
}
```

Replying to [comment:21 mkoeppe]:
> > And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?
> 
> No, this needs to run the specific compiler that is configured!

In particular, this is supposed to work also if CC is configured to be "gcc -m32".



---

archive/issue_comments_410556.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-16T00:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410556",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410557.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> \n> In particular, this is supposed to work also if CC is configured to be \"gcc -m32\".\n> \n\nAh, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?",
    "created_at": "2020-03-16T00:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410557",
    "user": "@orlitzky"
}
```

Replying to [comment:22 mkoeppe]:
> 
> In particular, this is supposed to work also if CC is configured to be "gcc -m32".
> 

Ah, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?



---

archive/issue_comments_410558.json:
```json
{
    "body": "Replying to [comment:24 mjo]:\n> Replying to [comment:22 mkoeppe]:\n> > \n> > In particular, this is supposed to work also if CC is configured to be \"gcc -m32\".\n> > \n> \n> Ah, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?\n\nWell, clang supports the `-dumpmachine` option too.\n\nI have not tested with icc; I don't know if Sage is known to build at all with this compiler.",
    "created_at": "2020-03-16T00:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410558",
    "user": "@mkoeppe"
}
```

Replying to [comment:24 mjo]:
> Replying to [comment:22 mkoeppe]:
> > 
> > In particular, this is supposed to work also if CC is configured to be "gcc -m32".
> > 
> 
> Ah, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?

Well, clang supports the `-dumpmachine` option too.

I have not tested with icc; I don't know if Sage is known to build at all with this compiler.



---

archive/issue_comments_410559.json:
```json
{
    "body": "There's some evidence (https://github.com/JuliaLang/julia/issues/9145) that icc supports this option too on Linux (but possibly not on macOS - which is not a problem because 32-bit builds are no longer supported; and the fallback to `unknown` should take care of it).",
    "created_at": "2020-03-16T00:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410559",
    "user": "@mkoeppe"
}
```

There's some evidence (https://github.com/JuliaLang/julia/issues/9145) that icc supports this option too on Linux (but possibly not on macOS - which is not a problem because 32-bit builds are no longer supported; and the fallback to `unknown` should take care of it).



---

archive/issue_comments_410560.json:
```json
{
    "body": "My concern isn't about the `-dumpmachine` flag per se. We need to build gfortran with the same ABI as gcc, because gfortran tries to use headers from GCC and they won't be where gfortran expects them to be if the ABIs are mismatched. But if `CC=clang`, why should we insist that the ABI of clang and gfortran are the same? In that case, you still want to ensure that the ABIs of gfortran/gcc agree, not gfortran/clang.",
    "created_at": "2020-03-16T00:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410560",
    "user": "@orlitzky"
}
```

My concern isn't about the `-dumpmachine` flag per se. We need to build gfortran with the same ABI as gcc, because gfortran tries to use headers from GCC and they won't be where gfortran expects them to be if the ABIs are mismatched. But if `CC=clang`, why should we insist that the ABI of clang and gfortran are the same? In that case, you still want to ensure that the ABIs of gfortran/gcc agree, not gfortran/clang.



---

archive/issue_comments_410561.json:
```json
{
    "body": "Simply because we cannot link 32bit & 64bit into one executable",
    "created_at": "2020-03-16T01:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410561",
    "user": "@mkoeppe"
}
```

Simply because we cannot link 32bit & 64bit into one executable



---

archive/issue_comments_410562.json:
```json
{
    "body": "We need to build gfortran with the same ABI as the C compiler that is used, not some gcc that may be on the system.",
    "created_at": "2020-03-16T01:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410562",
    "user": "@mkoeppe"
}
```

We need to build gfortran with the same ABI as the C compiler that is used, not some gcc that may be on the system.



---

archive/issue_comments_410563.json:
```json
{
    "body": "Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. These are pretty low return-on-investment scenarios, though. Feel free to set positive review if the CI and build bots are happy.",
    "created_at": "2020-03-16T01:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410563",
    "user": "@orlitzky"
}
```

Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. These are pretty low return-on-investment scenarios, though. Feel free to set positive review if the CI and build bots are happy.



---

archive/issue_comments_410564.json:
```json
{
    "body": "Replying to [comment:30 mjo]:\n> Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. \nRight. In this situation, probably we would have to build the full gcc, possibly with bootstrapping. \n\n> These are pretty low return-on-investment scenarios, though. \nI agree. If this ever becomes a problem, this can be fixed separately.\n\n> Feel free to set positive review if the CI and build bots are happy.\nThanks!",
    "created_at": "2020-03-16T01:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410564",
    "user": "@mkoeppe"
}
```

Replying to [comment:30 mjo]:
> Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. 
Right. In this situation, probably we would have to build the full gcc, possibly with bootstrapping. 

> These are pretty low return-on-investment scenarios, though. 
I agree. If this ever becomes a problem, this can be fixed separately.

> Feel free to set positive review if the CI and build bots are happy.
Thanks!



---

archive/issue_comments_410565.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-16T01:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410565",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410566.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-18T22:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29004#issuecomment-410566",
    "user": "@vbraun"
}
```

Resolution: fixed
