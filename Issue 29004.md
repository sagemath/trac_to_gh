# Issue 29004: gfortran on 32bit: Configure for the same ABI as gcc

Issue created by migration from https://trac.sagemath.org/ticket/29241

Original creator: mkoeppe

Original creation time: 2020-02-24 08:00:12

CC:  dimpase tmonteil vbraun jhpalmieri mjo

The `i386-minimal` targets have build errors compiling `gfortran` (see for example https://github.com/mkoeppe/sage/runs/463683795) because of ABI mismatch. These tests are running 32-bit distributions on a 64-bit kernel. `gfortran` tries to build native (64-bit) but that fails because the corresponding architecture files are missing.




---

Comment by mkoeppe created at 2020-03-03 03:27:14

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-03 03:27:14

Tested on `docker-debian-buster-i386-minimal`, where the gfortran build now succeeds.
Needs review.
----
New commits:


---

Comment by mkoeppe created at 2020-03-08 20:37:22

Anyone interested in reviewing this?


---

Comment by dimpase created at 2020-03-08 20:41:56

I don't know how to set up an environment where this change matters.


---

Comment by git created at 2020-03-08 22:36:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-09 01:10:33

Will the gfortran `spkg-install` file ever be run on OS X?

```
$ gcc -print-multiarch
clang: error: unknown argument: '-print-multiarch'
clang: error: no input files
```



---

Comment by mkoeppe created at 2020-03-09 01:27:44

The equivalent option with clang is `gcc -print-target-triple`


---

Comment by mkoeppe created at 2020-03-09 01:31:36

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-03-09 03:35:38

Well, on OS X building for i386 no longer works. But I'll add clang support just in case for FreeBSD.


---

Comment by git created at 2020-03-09 03:37:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-09 03:40:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-09 21:01:40

Replying to [comment:5 dimpase]:
> I don't know how to set up an environment where this change matters.
Tests ran at https://github.com/mkoeppe/sage/runs/493828325

Fixed: `ubuntu-bionic-i386-minimal`, `ubuntu-eoan-i386-minimal`, `debian-buster-i386-minimal`.

Remaining error: `centos-7-i386-minimal` (https://github.com/mkoeppe/sage/runs/493828336)


---

Comment by git created at 2020-03-09 21:25:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-10 23:33:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-10 23:48:12

Tests at https://github.com/mkoeppe/sage/actions/runs/53297072


---

Comment by mkoeppe created at 2020-03-11 18:16:51

This fixed the remaining platform `centos-7-i386-minimal`.

Ready for review.


---

Comment by git created at 2020-03-15 23:51:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2020-03-16 00:18:35

I'll have to take your word for it that this fixes the problem. Some implementation nitpicks:


```
ARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`
```


The form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).

And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?


```
    x86_64,i[3-6]86*)
```


Personally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.


---

Comment by mkoeppe created at 2020-03-16 00:21:14

Replying to [comment:20 mjo]:
> I'll have to take your word for it that this fixes the problem. 

The logs on the various machines are available at the links posted.

> Some implementation nitpicks:
> 
> {{{
> ARCH=`$CC -dumpmachine 2>/dev/null || echo unknown`
> }}}
> 
> The form `$(command)` should be preferred over backticks here (http://mywiki.wooledge.org/BashFAQ/082).
OK will do.

> 
> And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?

No, this needs to run the specific compiler that is configured!

> {{{
>     x86_64,i[3-6]86*)
> }}}
> 
> Personally I would just write `[3456]` there. Ranges in globs are a bash extension, but more importantly they involve the system locale and collation, leading to rare problems that can be avoided by just listing the numbers you want to match.

OK will do.


---

Comment by mkoeppe created at 2020-03-16 00:27:49

Replying to [comment:21 mkoeppe]:
> > And if you explicitly want to call GCC here, shouldn't you use "gcc" instead of $CC?
> 
> No, this needs to run the specific compiler that is configured!

In particular, this is supposed to work also if CC is configured to be "gcc -m32".


---

Comment by git created at 2020-03-16 00:29:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-03-16 00:32:59

Replying to [comment:22 mkoeppe]:
> 
> In particular, this is supposed to work also if CC is configured to be "gcc -m32".
> 

Ah, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?


---

Comment by mkoeppe created at 2020-03-16 00:35:12

Replying to [comment:24 mjo]:
> Replying to [comment:22 mkoeppe]:
> > 
> > In particular, this is supposed to work also if CC is configured to be "gcc -m32".
> > 
> 
> Ah, ok. I was thinking more along the lines of, what if `CC` is e.g. clang or icc?

Well, clang supports the `-dumpmachine` option too.

I have not tested with icc; I don't know if Sage is known to build at all with this compiler.


---

Comment by mkoeppe created at 2020-03-16 00:44:29

There's some evidence (https://github.com/JuliaLang/julia/issues/9145) that icc supports this option too on Linux (but possibly not on macOS - which is not a problem because 32-bit builds are no longer supported; and the fallback to `unknown` should take care of it).


---

Comment by mjo created at 2020-03-16 00:56:12

My concern isn't about the `-dumpmachine` flag per se. We need to build gfortran with the same ABI as gcc, because gfortran tries to use headers from GCC and they won't be where gfortran expects them to be if the ABIs are mismatched. But if `CC=clang`, why should we insist that the ABI of clang and gfortran are the same? In that case, you still want to ensure that the ABIs of gfortran/gcc agree, not gfortran/clang.


---

Comment by mkoeppe created at 2020-03-16 01:02:30

Simply because we cannot link 32bit & 64bit into one executable


---

Comment by mkoeppe created at 2020-03-16 01:04:11

We need to build gfortran with the same ABI as the C compiler that is used, not some gcc that may be on the system.


---

Comment by mjo created at 2020-03-16 01:11:09

Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. These are pretty low return-on-investment scenarios, though. Feel free to set positive review if the CI and build bots are happy.


---

Comment by mkoeppe created at 2020-03-16 01:35:02

Replying to [comment:30 mjo]:
> Ok, that makes sense. I was focusing on the `bits/libc-header-start.h: No such file or directory` errors. I guess we could still get build failures if GCC is 32-bit but someone has built a 64-bit clang and sets `CC=clang`. 
Right. In this situation, probably we would have to build the full gcc, possibly with bootstrapping. 

> These are pretty low return-on-investment scenarios, though. 
I agree. If this ever becomes a problem, this can be fixed separately.

> Feel free to set positive review if the CI and build bots are happy.
Thanks!


---

Comment by mkoeppe created at 2020-03-16 01:35:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-03-18 22:40:44

Resolution: fixed
