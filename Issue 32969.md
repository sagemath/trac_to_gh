# Issue 32969: PDF documentation links in Documentation from Jupyter notebook are broken

Issue created by migration from https://trac.sagemath.org/ticket/33206

Original creator: strogdon

Original creation time: 2022-01-20 03:27:21

CC:  jhpalmieri klee

To replicate the issue:
* ./configure --enable-sagemath_doc_pdf=yes
* make
* ./sage -n jupyter
* select `New -> [SageMath](SageMath) xxxx`
* select `Help -> Sage Documentation`

`Clicking` on any of the PDF icons gives, for example, in the terminal:

```
[W 20:13:44.654 NotebookApp] Kernelspec name pdf cannot be found!
[W 20:13:44.655 NotebookApp] 404 GET /kernelspecs/pdf/en/tutorial/SageTutorial.pdf (::1): Kernel spec pdf not found
[W 20:13:44.656 NotebookApp] 404 GET /kernelspecs/pdf/en/tutorial/SageTutorial.pdf (::1) 2.920000ms referer=http://localhost:8888/kernelspecs/sagemath/doc/index.html
```

with a corresponding `404 : Not Found` browser page

Note:

if Sage is configured with `--enable-sagemath_doc_pdf=no` then PDF documentation icons/links will not appear in the Documentation.


---

Comment by strogdon created at 2022-01-20 03:34:38

The issue seems to arise from the web server not being able to deal with `../..` in code like

```
        <a title="Download PDF" class="pdf" href="../../pdf/en/tutorial/SageTutorial.pdf">
          <img class="icon" src="_static/pdf.png"></img>
        </a>
```

from `src/doc/en/website/templates/index.html`. A work-a-round is to replace `../..` with a symlink `web_pdf -> ../..` and then to add the symlink to Sage.


---

Comment by strogdon created at 2022-01-20 05:34:19

The referenced symlink is created under `sagemath_doc_html/spkg-install` since `src/doc/en/website/templates/index.html` needs to be changed. I have not included a method to remove the created symlink, `web_pdf` as necessary. I'm not sure where that should be done, if needed.
----
New commits:


---

Comment by strogdon created at 2022-01-20 05:35:10

Changing status from new to needs_review.


---

Comment by klee created at 2022-01-21 07:35:55

New commits:


---

Comment by klee created at 2022-01-21 07:42:00

It seems (1) we only need the symlink in the "website" directory, and (2) the symlink creation is the job of the sphinx "website" builder.  

I also removed a deprecated method on the way.


---

Comment by strogdon created at 2022-01-21 17:09:58

Changing status from needs_review to needs_info.


---

Comment by strogdon created at 2022-01-21 17:09:58

Replying to [comment:8 klee]:
> It seems (1) we only need the symlink in the "website" directory, and (2) the symlink creation is the job of the sphinx "website" builder.  
> 
> I also removed a deprecated method on the way.
Unless I'm mistaken, in addition to now creating the `pdf` symlink under the "website" folder the entire `pdf` tree under `local/share/doc/sage/pdf` had been copied to `local/share/doc/sage/html/en/pdf`. Is this intended?


---

Comment by strogdon created at 2022-01-21 18:59:09

OK, so the copied stuff under `local/share/doc/html/en/pdf` are needed for the PDF links to work in the Documentation. Couldn't this be a symlink? I'm not sure what the created symlink under the "website" folder does. If I move `local/share/doc/html/en/pdf` out of the way the links in the Documentation are broken.


---

Comment by git created at 2022-01-21 22:38:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-01-21 22:41:42

Replying to [comment:10 strogdon]:
> Unless I'm mistaken, in addition to now creating the `pdf` symlink under the "website" folder the entire `pdf` tree under `local/share/doc/sage/pdf` had been copied to `local/share/doc/sage/html/en/pdf`. Is this intended?

Never. It was my mistake to put the symlink `pdf` to the website folder, which triggered the whole copy. Now it is put in the folder one level up.


---

Comment by strogdon created at 2022-01-22 01:05:14

Changing status from needs_info to needs_review.


---

Comment by fbissey created at 2022-01-22 02:15:55

The absolute link is a bit of an issue in my opinion. It certainly can lead to problem in distros where `SAGE_DOC` at build time is different from `SAGE_DOC` at runtime once everything is put in place. Vanilla sage builds in place of course so doesn't see that problem.

So my suggestion is something like [https://stackoverflow.com/questions/54825010/why-does-os-symlink-uses-path-relative-to-destination](https://stackoverflow.com/questions/54825010/why-does-os-symlink-uses-path-relative-to-destination)

```
html_output_dir = self._output_dir('html')
pdf_doc_dir = os.path.join(SAGE_DOC, 'pdf')
relpath = os.path.relpath(pdf_doc_dir, os.path.join(html_output_dir, '..', 'pdf'))

try:
      os.symlink(relpath, os.path.join(html_output_dir, '..', 'pdf'))
except FileExistsError:
      pass
```



---

Comment by git created at 2022-01-22 04:19:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-01-22 04:19:36

Replying to [comment:15 fbissey]:
> The absolute link is a bit of an issue in my opinion. It certainly can lead to problem in distros where `SAGE_DOC` at build time is different from `SAGE_DOC` at runtime once everything is put in place. Vanilla sage builds in place of course so doesn't see that problem.

Okay.


---

Comment by strogdon created at 2022-01-22 06:14:00

This does work. 

`@`klee remove me as an author if approprite since you knew where to make the real changes.


---

Comment by strogdon created at 2022-01-22 06:14:00

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-01-22 06:30:37

Replying to [comment:18 strogdon]:
> This does work. 
> 
> `@`klee remove me as an author if approprite since you knew where to make the real changes.

No. You knew that, and I followed you. Thanks.


---

Comment by slelievre created at 2022-01-23 11:39:37

Hope this can get in Sage 9.5.


---

Comment by mkoeppe created at 2022-01-23 18:14:27

Changing priority from major to blocker.


---

Comment by vbraun created at 2022-01-24 20:51:42

Resolution: fixed
