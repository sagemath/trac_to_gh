# Issue 32790: zombie maxima process -  if invoked from a script

archive/issues_032790.json:
```json
{
    "body": "CC:  nbruin vbraun mkoeppe @spaghettisalat\n\ninvoking `maxima` in a Sage script leads to a zombie process. E.g.\nrun the following in terminal\n\n```\necho \"t=maxima('2+2')\" > /tmp/foo.sage && ./sage /tmp/foo.sage\n```\n\nand observe zombie `maxima` process after this terminates.\n\nA slightly shorter\n\n```\necho \"t=maxima('2+2')\" | ./sage\n```\n\ndoes not lead to a zombie - in fact, it prints on exit:\n\n```\nsage: sage: Exiting Sage (CPU time 0m0.08s, Wall time 0m0.67s).\nExiting Maxima with PID 2318 running <SAGEROOT>/local/bin/maxima -p <SAGEROOT>/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp\n```\n\n\nThis was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33027\n\n",
    "created_at": "2021-12-15T13:52:36Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "zombie maxima process -  if invoked from a script",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32790",
    "user": "dimpase"
}
```
CC:  nbruin vbraun mkoeppe @spaghettisalat

invoking `maxima` in a Sage script leads to a zombie process. E.g.
run the following in terminal

```
echo "t=maxima('2+2')" > /tmp/foo.sage && ./sage /tmp/foo.sage
```

and observe zombie `maxima` process after this terminates.

A slightly shorter

```
echo "t=maxima('2+2')" | ./sage
```

does not lead to a zombie - in fact, it prints on exit:

```
sage: sage: Exiting Sage (CPU time 0m0.08s, Wall time 0m0.67s).
Exiting Maxima with PID 2318 running <SAGEROOT>/local/bin/maxima -p <SAGEROOT>/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp
```


This was observed while testing `sagetex` spkg with `SAGE_CHECK=yes make sagetex` on #32887.

Issue created by migration from https://trac.sagemath.org/ticket/33027





---

archive/issue_comments_467582.json:
```json
{
    "body": "Moving this to critical, as it seems to efficiently kill the patchbots.",
    "created_at": "2021-12-15T15:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467582",
    "user": "@kliem"
}
```

Moving this to critical, as it seems to efficiently kill the patchbots.



---

archive/issue_comments_467583.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-12-15T15:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467583",
    "user": "@kliem"
}
```

Changing priority from major to critical.



---

archive/issue_comments_467584.json:
```json
{
    "body": "This might be related to #32167.",
    "created_at": "2022-01-21T10:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467584",
    "user": "mantepse"
}
```

This might be related to #32167.



---

archive/issue_comments_467585.json:
```json
{
    "body": "I think it was observed without fricas installed, too.",
    "created_at": "2022-01-21T10:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467585",
    "user": "dimpase"
}
```

I think it was observed without fricas installed, too.



---

archive/issue_comments_467586.json:
```json
{
    "body": "I've noticed that one gets\n`.sage/maxima/binary/5_45_0/ecl/21_2_1/` created in DOTSAGE. (no matter with the reproducer, or the non-reproducer `echo \"t=maxima('2+2')\" | ./sage`",
    "created_at": "2022-01-21T11:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467586",
    "user": "dimpase"
}
```

I've noticed that one gets
`.sage/maxima/binary/5_45_0/ecl/21_2_1/` created in DOTSAGE. (no matter with the reproducer, or the non-reproducer `echo "t=maxima('2+2')" | ./sage`



---

archive/issue_comments_467587.json:
```json
{
    "body": "This effectively kills the patchbots, thus a blocker, IMHO.\nhttps://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com",
    "created_at": "2022-01-21T11:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467587",
    "user": "dimpase"
}
```

This effectively kills the patchbots, thus a blocker, IMHO.
https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com



---

archive/issue_comments_467588.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2022-01-21T11:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467588",
    "user": "dimpase"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_467589.json:
```json
{
    "body": "what I meant to say is that it might be a similar underlying problem.",
    "created_at": "2022-01-21T11:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467589",
    "user": "mantepse"
}
```

what I meant to say is that it might be a similar underlying problem.



---

archive/issue_comments_467590.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> This effectively kills the patchbots, thus a blocker, IMHO.\n> https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com\n\nApparently a ticket introduced in 9.5beta8 https://groups.google.com/g/sage-release/c/vo_m79EHAVc/m/mMlNPz5sBAAJ introduced this problem. My patchbot worked fine until then and I got contacted by the IT on December 13th (it is a virtual machine and I'm guessing this also affected other people).",
    "created_at": "2022-01-21T11:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467590",
    "user": "@kliem"
}
```

Replying to [comment:7 dimpase]:
> This effectively kills the patchbots, thus a blocker, IMHO.
> https://groups.google.com/d/msgid/sage-devel/997e9f75-8e92-4a67-b43a-1777074cbe45n%40googlegroups.com

Apparently a ticket introduced in 9.5beta8 https://groups.google.com/g/sage-release/c/vo_m79EHAVc/m/mMlNPz5sBAAJ introduced this problem. My patchbot worked fine until then and I got contacted by the IT on December 13th (it is a virtual machine and I'm guessing this also affected other people).



---

archive/issue_comments_467591.json:
```json
{
    "body": "1. Never execute code from a predictable filename under `/tmp` =)\n2. FWIW, I can't reproduce this on rc2.",
    "created_at": "2022-01-21T12:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467591",
    "user": "mjo"
}
```

1. Never execute code from a predictable filename under `/tmp` =)
2. FWIW, I can't reproduce this on rc2.



---

archive/issue_comments_467592.json:
```json
{
    "body": "Replying to [comment:10 mjo]:\n> 1. Never execute code from a predictable filename under `/tmp` =)\n> 2. FWIW, I can't reproduce this on rc2.\n\nPerhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.",
    "created_at": "2022-01-21T13:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467592",
    "user": "dimpase"
}
```

Replying to [comment:10 mjo]:
> 1. Never execute code from a predictable filename under `/tmp` =)
> 2. FWIW, I can't reproduce this on rc2.

Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.



---

archive/issue_comments_467593.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> Replying to [comment:10 mjo]:\n> > 1. Never execute code from a predictable filename under `/tmp` =)\n> > 2. FWIW, I can't reproduce this on rc2.\n> \n> Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.\n\nNo, my config.log states, `already installed as an SPKG`.",
    "created_at": "2022-01-21T14:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467593",
    "user": "@kliem"
}
```

Replying to [comment:11 dimpase]:
> Replying to [comment:10 mjo]:
> > 1. Never execute code from a predictable filename under `/tmp` =)
> > 2. FWIW, I can't reproduce this on rc2.
> 
> Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.

No, my config.log states, `already installed as an SPKG`.



---

archive/issue_comments_467594.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket33027/config.log) by @kliem created at 2022-01-21 14:23:19\n\nA config.log of some debian buster with this problem",
    "created_at": "2022-01-21T14:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467594",
    "user": "@kliem"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket33027/config.log) by @kliem created at 2022-01-21 14:23:19

A config.log of some debian buster with this problem



---

archive/issue_comments_467595.json:
```json
{
    "body": "Replying to [comment:12 gh-kliem]:\n> Replying to [comment:11 dimpase]:\n> > Replying to [comment:10 mjo]:\n> > > 1. Never execute code from a predictable filename under `/tmp` =)\n> > > 2. FWIW, I can't reproduce this on rc2.\n> > \n> > Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.\n> \n> No, my config.log states, `already installed as an SPKG`.\n\nI meant that a system ecl is the reason that Michael cannot reproduce this.",
    "created_at": "2022-01-21T14:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467595",
    "user": "dimpase"
}
```

Replying to [comment:12 gh-kliem]:
> Replying to [comment:11 dimpase]:
> > Replying to [comment:10 mjo]:
> > > 1. Never execute code from a predictable filename under `/tmp` =)
> > > 2. FWIW, I can't reproduce this on rc2.
> > 
> > Perhaps it's due to ecl from the system? I see this on Debian 11 with ecl built by Sage.
> 
> No, my config.log states, `already installed as an SPKG`.

I meant that a system ecl is the reason that Michael cannot reproduce this.



---

archive/issue_comments_467596.json:
```json
{
    "body": "Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.",
    "created_at": "2022-01-21T14:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467596",
    "user": "@kliem"
}
```

Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.



---

archive/issue_comments_467597.json:
```json
{
    "body": "Replying to [comment:14 gh-kliem]:\n> Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n\nYes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.",
    "created_at": "2022-01-21T17:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467597",
    "user": "dimpase"
}
```

Replying to [comment:14 gh-kliem]:
> Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.

Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.



---

archive/issue_comments_467598.json:
```json
{
    "body": "Replying to [comment:15 dimpase]:\n> Replying to [comment:14 gh-kliem]:\n> > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n> \n> Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.\n\nMaybe delete that `write_error.patch` that the SPKG applies, and try again?",
    "created_at": "2022-01-21T18:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467598",
    "user": "mjo"
}
```

Replying to [comment:15 dimpase]:
> Replying to [comment:14 gh-kliem]:
> > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.
> 
> Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.

Maybe delete that `write_error.patch` that the SPKG applies, and try again?



---

archive/issue_comments_467599.json:
```json
{
    "body": "The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.",
    "created_at": "2022-01-21T18:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467599",
    "user": "mjo"
}
```

The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.



---

archive/issue_comments_467600.json:
```json
{
    "body": "Could you check whether using spkg ecl / system ecl also makes the difference for #32167?",
    "created_at": "2022-01-21T18:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467600",
    "user": "mantepse"
}
```

Could you check whether using spkg ecl / system ecl also makes the difference for #32167?



---

archive/issue_comments_467601.json:
```json
{
    "body": "Replying to [comment:18 mjo]:\n> Replying to [comment:15 dimpase]:\n> > Replying to [comment:14 gh-kliem]:\n> > > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.\n> > \n> > Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.\n> \n> Maybe delete that `write_error.patch` that the SPKG applies, and try again?\npatch or no patch, the same picture.",
    "created_at": "2022-01-21T18:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467601",
    "user": "dimpase"
}
```

Replying to [comment:18 mjo]:
> Replying to [comment:15 dimpase]:
> > Replying to [comment:14 gh-kliem]:
> > > Ah yes, this might be the reason. I can also observe this on ubuntu focal with ecl installed as SPKG.
> > 
> > Yes, I can reproduce this - on a Gentoo machine with systemwide ecl there is no zombie, but installing ecl+maxima in Sage leads to zombies.
> 
> Maybe delete that `write_error.patch` that the SPKG applies, and try again?
patch or no patch, the same picture.



---

archive/issue_comments_467602.json:
```json
{
    "body": "accoring to comment:9, something happened in 9.5.beta8, which caused this. Time for `git bisect` I suppose...",
    "created_at": "2022-01-21T18:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467602",
    "user": "dimpase"
}
```

accoring to comment:9, something happened in 9.5.beta8, which caused this. Time for `git bisect` I suppose...



---

archive/issue_comments_467603.json:
```json
{
    "body": "Replying to [comment:19 mjo]:\n> The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.\n\nThis was the correct guess.\nIf I remove `--disable-threads` then no zombies pop up.\n\nCan this also be done on macOS?",
    "created_at": "2022-01-21T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467603",
    "user": "dimpase"
}
```

Replying to [comment:19 mjo]:
> The other obvious difference is that the SPKG is built with `--disable-threads`. But the patch is more suspicious to me.

This was the correct guess.
If I remove `--disable-threads` then no zombies pop up.

Can this also be done on macOS?



---

archive/issue_comments_467604.json:
```json
{
    "body": "posting a branch in a moment",
    "created_at": "2022-01-21T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467604",
    "user": "dimpase"
}
```

posting a branch in a moment



---

archive/issue_comments_467605.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-21T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467605",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467606.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-21T21:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467606",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_467607.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467607",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_467608.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-01-21T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467608",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_467609.json:
```json
{
    "body": "On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.",
    "created_at": "2022-01-22T02:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467609",
    "user": "jhpalmieri"
}
```

On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.



---

archive/issue_comments_467610.json:
```json
{
    "body": "Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.",
    "created_at": "2022-01-22T02:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467610",
    "user": "jhpalmieri"
}
```

Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.



---

archive/issue_comments_467611.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.\n\nmacOS is sufficiently different from Linux, I'm not surprised. I noticed that Homebrew builds ecl with threads enabled, so the change proposed here should be fine on macOS too.\n\nNot sure about cygwin though.",
    "created_at": "2022-01-22T11:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467611",
    "user": "dimpase"
}
```

Replying to [comment:27 jhpalmieri]:
> On OS X, after running `./configure --with-system-ecl=no`, I don't see any zombie maxima processes no matter how many times I run `./sage /path/to/foo.sage`.

macOS is sufficiently different from Linux, I'm not surprised. I noticed that Homebrew builds ecl with threads enabled, so the change proposed here should be fine on macOS too.

Not sure about cygwin though.



---

archive/issue_comments_467612.json:
```json
{
    "body": "Replying to [comment:28 jhpalmieri]:\n> Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.\n\nI even tried reverting it, to no avail.\nPerhaps the behaviour was always there, it's just a test introduced in beta8 that led to these zombie processes?",
    "created_at": "2022-01-22T11:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467612",
    "user": "dimpase"
}
```

Replying to [comment:28 jhpalmieri]:
> Is there any way this is connected to #31796? That's the only obvious ticket merged in 9.5.beta8 which is connected to maxima, but it doesn't look problematic to me.

I even tried reverting it, to no avail.
Perhaps the behaviour was always there, it's just a test introduced in beta8 that led to these zombie processes?



---

archive/issue_comments_467613.json:
```json
{
    "body": "I am fairly certain that this is a race condition and enabling threads will not help in general.\n\nAttaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on. The following script\n\n\n```\nimport atexit\natexit.register(lambda : maxima.quit())\nt=maxima('2+2')\n```\n\n\nworks fine and leaves no maxima zombies.\n\nI don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.",
    "created_at": "2022-01-22T14:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467613",
    "user": "@spaghettisalat"
}
```

I am fairly certain that this is a race condition and enabling threads will not help in general.

Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on. The following script


```
import atexit
atexit.register(lambda : maxima.quit())
t=maxima('2+2')
```


works fine and leaves no maxima zombies.

I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.



---

archive/issue_comments_467614.json:
```json
{
    "body": "Replying to [comment:31 gh-spaghettisalat]:\n> I am fairly certain that this is a race condition and enabling threads will not help in general.\n> \n> Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on.\n\nSounds related to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634?\n\nThe fact that it works with threads enabled could be due to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/129. If that's the case then indeed we shouldn't rely on it.\n\nThe following script\n> \n> {{{\n> import atexit\n> atexit.register(lambda : maxima.quit())\n> t=maxima('2+2')\n> }}}\n> \n> works fine and leaves no maxima zombies.\n> \n> I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.\n\nThe pexpect interface has been deprecated forever, so it's not unlikely. And I don't think adding a `quit()` hook could hurt in any case.",
    "created_at": "2022-01-22T15:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467614",
    "user": "mjo"
}
```

Replying to [comment:31 gh-spaghettisalat]:
> I am fairly certain that this is a race condition and enabling threads will not help in general.
> 
> Attaching a debugger to the maxima zombie process shows that the process hangs in a loop where it tries to flush the standard output, gets an error, tries to report that error to the standard error stream, then gets an error for that and so on.

Sounds related to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/634?

The fact that it works with threads enabled could be due to https://gitlab.com/embeddable-common-lisp/ecl/-/issues/129. If that's the case then indeed we shouldn't rely on it.

The following script
> 
> {{{
> import atexit
> atexit.register(lambda : maxima.quit())
> t=maxima('2+2')
> }}}
> 
> works fine and leaves no maxima zombies.
> 
> I don't have time to dig into the maxima interface code, but I am pretty sure that sage just doesn't shut down maxima properly.

The pexpect interface has been deprecated forever, so it's not unlikely. And I don't think adding a `quit()` hook could hurt in any case.



---

archive/issue_comments_467615.json:
```json
{
    "body": "The patchbots will use the develop branch so there is little to be gained and a lot to potentially screw up by pushing the proposed patch into 9.5",
    "created_at": "2022-01-22T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467615",
    "user": "vbraun"
}
```

The patchbots will use the develop branch so there is little to be gained and a lot to potentially screw up by pushing the proposed patch into 9.5



---

archive/issue_comments_467616.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2022-01-22T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467616",
    "user": "vbraun"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_467617.json:
```json
{
    "body": "Replying to [comment:32 mjo]:\n> The pexpect interface has been deprecated forever\n\nNo, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.",
    "created_at": "2022-01-22T17:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467617",
    "user": "mkoeppe"
}
```

Replying to [comment:32 mjo]:
> The pexpect interface has been deprecated forever

No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.



---

archive/issue_comments_467618.json:
```json
{
    "body": "Replying to [comment:34 mkoeppe]:\n> Replying to [comment:32 mjo]:\n> > The pexpect interface has been deprecated forever\n> \n> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.\n\nI agree that the pexpect interface is not deprecated, but I don't think it's the only interface that's meant to be user-facing. In fact, I expect (no pun intended) that most uses for maxima in sage *are* through the internal one, because the integration with symbolics makes it easier to get the things in/out. For instance `SR(x)._maxima_()` gets you an object through the `maxima_lib` interface.\n\nThe pexpect interface is convenient if you want multiple sessions (managed through different processes) and if you want \"vanilla\" maxima: the maxima_lib one has some tweaks and configurations motivated by its use for SR.",
    "created_at": "2022-01-22T18:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467618",
    "user": "nbruin"
}
```

Replying to [comment:34 mkoeppe]:
> Replying to [comment:32 mjo]:
> > The pexpect interface has been deprecated forever
> 
> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.

I agree that the pexpect interface is not deprecated, but I don't think it's the only interface that's meant to be user-facing. In fact, I expect (no pun intended) that most uses for maxima in sage *are* through the internal one, because the integration with symbolics makes it easier to get the things in/out. For instance `SR(x)._maxima_()` gets you an object through the `maxima_lib` interface.

The pexpect interface is convenient if you want multiple sessions (managed through different processes) and if you want "vanilla" maxima: the maxima_lib one has some tweaks and configurations motivated by its use for SR.



---

archive/issue_comments_467619.json:
```json
{
    "body": "Replying to [comment:34 mkoeppe]:\n> Replying to [comment:32 mjo]:\n> > The pexpect interface has been deprecated forever\n> \n> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.\n\nSemantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be. There are several tickets open to replace pexpect calls and documentation with the library interface. You yourself started to make `maxima()` use the library in #30097.",
    "created_at": "2022-01-22T18:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467619",
    "user": "mjo"
}
```

Replying to [comment:34 mkoeppe]:
> Replying to [comment:32 mjo]:
> > The pexpect interface has been deprecated forever
> 
> No, it's not. We have 2 maxima interfaces. `maxima_calculus` is the unique instance of the library-based interface and is for internal use by symbolics. `maxima` is the user-facing interface and is pexpect-based.

Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be. There are several tickets open to replace pexpect calls and documentation with the library interface. You yourself started to make `maxima()` use the library in #30097.



---

archive/issue_comments_467620.json:
```json
{
    "body": "Yes, that's correct, #30097 would be a solution.",
    "created_at": "2022-01-22T18:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467620",
    "user": "mkoeppe"
}
```

Yes, that's correct, #30097 would be a solution.



---

archive/issue_comments_467621.json:
```json
{
    "body": "Replying to [comment:36 mjo]:\n> Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be.\n\nThat would depend. The pexpect interface could in principle work with, say, maxima on SBCL, which probably would run faster than on ECL. So jobs with maxima that aren't particularly I/O-bound need not be faster through maxima_lib.\n\nStability: sure. pexpect inferfaces have shown to be quite fragile; particular with LISP, which tends to have I/O that isn't particularly compatible with C-type I/O (character devices may be driver really one-character-at-a-time).",
    "created_at": "2022-01-22T19:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467621",
    "user": "nbruin"
}
```

Replying to [comment:36 mjo]:
> Semantics? The *name* `maxima()` isn't deprecated, but the library interface is faster and more robust than pexpect ever can be.

That would depend. The pexpect interface could in principle work with, say, maxima on SBCL, which probably would run faster than on ECL. So jobs with maxima that aren't particularly I/O-bound need not be faster through maxima_lib.

Stability: sure. pexpect inferfaces have shown to be quite fragile; particular with LISP, which tends to have I/O that isn't particularly compatible with C-type I/O (character devices may be driver really one-character-at-a-time).



---

archive/issue_comments_467622.json:
```json
{
    "body": "Replying to [comment:32 mjo]:\n> And I don't think adding a `quit()` hook could hurt in any case.\n\nit's there, no?\n\n```\nsage: maxima._quit_string()\n'quit();'\n```\n",
    "created_at": "2022-01-22T20:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467622",
    "user": "dimpase"
}
```

Replying to [comment:32 mjo]:
> And I don't think adding a `quit()` hook could hurt in any case.

it's there, no?

```
sage: maxima._quit_string()
'quit();'
```




---

archive/issue_comments_467623.json:
```json
{
    "body": "I think I am noticing zombie processes also with the gap3 (optional) interface.",
    "created_at": "2022-01-22T21:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467623",
    "user": "mantepse"
}
```

I think I am noticing zombie processes also with the gap3 (optional) interface.



---

archive/issue_comments_467624.json:
```json
{
    "body": "Replying to [comment:39 dimpase]:\n> Replying to [comment:32 mjo]:\n> > And I don't think adding a `quit()` hook could hurt in any case.\n> \n> it's there, no?\n> {{{\n> sage: maxima._quit_string()\n> 'quit();'\n> }}}\n> \n\nBut when is that string sent to the running maxima process? I meant something like comment:31.\n\nI see now that there's a function called `quit_sage()` in `src/sage/all.py`,\n\n\n```python\ndef quit_sage(verbose=True):\n    \"\"\"                                                                                                                                                                      \n    If you use Sage in library mode, you should call this function                                                                                                           \n    when your application quits.                                                                                                                                             \n                                                                                                                                                                             \n    It makes sure any child processes are also killed, etc.                                                                                                                  \n    \"\"\"\n    ...\n    from sage.interfaces.quit import expect_quitall\n    expect_quitall(verbose=verbose)\n    ...\n```\n\n\nwhich kills all running pexpect processes. And apparently you are supposed to call this function yourself. So, I guess we can blame sagetex for not calling `quit_sage()` at the end of the scripts it generates? =)",
    "created_at": "2022-01-22T22:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467624",
    "user": "mjo"
}
```

Replying to [comment:39 dimpase]:
> Replying to [comment:32 mjo]:
> > And I don't think adding a `quit()` hook could hurt in any case.
> 
> it's there, no?
> {{{
> sage: maxima._quit_string()
> 'quit();'
> }}}
> 

But when is that string sent to the running maxima process? I meant something like comment:31.

I see now that there's a function called `quit_sage()` in `src/sage/all.py`,


```python
def quit_sage(verbose=True):
    """                                                                                                                                                                      
    If you use Sage in library mode, you should call this function                                                                                                           
    when your application quits.                                                                                                                                             
                                                                                                                                                                             
    It makes sure any child processes are also killed, etc.                                                                                                                  
    """
    ...
    from sage.interfaces.quit import expect_quitall
    expect_quitall(verbose=verbose)
    ...
```


which kills all running pexpect processes. And apparently you are supposed to call this function yourself. So, I guess we can blame sagetex for not calling `quit_sage()` at the end of the scripts it generates? =)



---

archive/issue_comments_467625.json:
```json
{
    "body": "shouldn't EOF in a .sage script trigger `quit_sage()`?",
    "created_at": "2022-01-22T22:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467625",
    "user": "dimpase"
}
```

shouldn't EOF in a .sage script trigger `quit_sage()`?



---

archive/issue_comments_467626.json:
```json
{
    "body": "Replying to [comment:42 dimpase]:\n> shouldn't EOF in a .sage script trigger `quit_sage()`?\n\nYes, obviously. (Or something like that). I only use sage as a library, and I just learned about that function 20 minutes ago. It's outrageous to expect the user to manually clean up after the library.\n\nHowever I think an atexit hook is a cleaner approach, at least for pexpect processes. They all support `quit()`, and could register their own atexit hook upon being initialized. It won't help with crashes or when killed by a signal, but then, neither does calling `quit_sage()` at EOF.",
    "created_at": "2022-01-22T23:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467626",
    "user": "mjo"
}
```

Replying to [comment:42 dimpase]:
> shouldn't EOF in a .sage script trigger `quit_sage()`?

Yes, obviously. (Or something like that). I only use sage as a library, and I just learned about that function 20 minutes ago. It's outrageous to expect the user to manually clean up after the library.

However I think an atexit hook is a cleaner approach, at least for pexpect processes. They all support `quit()`, and could register their own atexit hook upon being initialized. It won't help with crashes or when killed by a signal, but then, neither does calling `quit_sage()` at EOF.



---

archive/issue_comments_467627.json:
```json
{
    "body": "I'm going to experiment with a cleanup hook for symmetrica on another ticket. Our interface to that library has `start()` and `end()` functions that are supposed to be called manually. The `start()` function gets called when you import `sage.libs.symmetrica.all`, but `end()` never does unless you call `quit_sage()`. So I'm going to have `start()` register a hook that calls `end()`, and remove the corresponding bits from `quit_sage()`. The body of `quit_sage()` isn't very long so we may be able to obsolete it rather quickly.",
    "created_at": "2022-01-22T23:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467627",
    "user": "mjo"
}
```

I'm going to experiment with a cleanup hook for symmetrica on another ticket. Our interface to that library has `start()` and `end()` functions that are supposed to be called manually. The `start()` function gets called when you import `sage.libs.symmetrica.all`, but `end()` never does unless you call `quit_sage()`. So I'm going to have `start()` register a hook that calls `end()`, and remove the corresponding bits from `quit_sage()`. The body of `quit_sage()` isn't very long so we may be able to obsolete it rather quickly.



---

archive/issue_comments_467628.json:
```json
{
    "body": "I posted a branch on #8784 that eliminates `quit_sage()` and puts all of the cleanup chores (including the termination of pexpect processes) into atexit hooks.\n\nIt's a more-invasive change, but the right thing to do if it doesn't cause any subtle new bugs.",
    "created_at": "2022-01-25T22:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467628",
    "user": "mjo"
}
```

I posted a branch on #8784 that eliminates `quit_sage()` and puts all of the cleanup chores (including the termination of pexpect processes) into atexit hooks.

It's a more-invasive change, but the right thing to do if it doesn't cause any subtle new bugs.



---

archive/issue_comments_467629.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-26T12:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467629",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467630.json:
```json
{
    "body": "Let's take the easy route for the 9.5 release and worry about `quit_sage()` afterwards.",
    "created_at": "2022-01-26T12:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467630",
    "user": "mjo"
}
```

Let's take the easy route for the 9.5 release and worry about `quit_sage()` afterwards.



---

archive/issue_comments_467631.json:
```json
{
    "body": "Setting milestone to 9.6 now that 9.5 is out.",
    "created_at": "2022-01-30T15:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467631",
    "user": "slelievre"
}
```

Setting milestone to 9.6 now that 9.5 is out.



---

archive/issue_comments_467632.json:
```json
{
    "body": "With this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. \n\n```\nsage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_abstract.py\", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands\nFailed example:\n    sorted(maxima._commands(verbose=False))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>\", line 1, in <module>\n        sorted(maxima._commands(verbose=False))\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in _commands\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in <listcomp>\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 296, in completions\n        cmd_list = self._eval_line('apropos(\"%s\")'%s, error_check=False)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 814, in _eval_line\n        self._expect_expr(self._display_prompt)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 731, in _expect_expr\n        i = self._expect.expect(expr)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 343, in expect\n        return self.expect_list(compiled_pattern_list,\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n        return exp.expect_loop(timeout)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 179, in expect_loop\n        return self.eof(e)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 122, in eof\n        raise exc\n    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.\n    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp\n    command: /home/release/Sage/local/bin/maxima\n    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']\n    buffer (last 100 chars): b''\n    before (last 100 chars): ''\n    after: <class 'pexpect.exceptions.EOF'>\n    match: None\n    match_index: None\n    exitstatus: None\n    flag_eof: True\n    pid: 1795009\n    child_fd: 20\n    closed: False\n    timeout: None\n    delimiter: <class 'pexpect.exceptions.EOF'>\n    logfile: None\n    logfile_read: None\n    logfile_send: None\n    maxread: 4194304\n    ignorecase: False\n    searchwindowsize: None\n    delaybeforesend: None\n    delayafterclose: 0.1\n    delayafterterminate: 0.1\n    searcher: searcher_re:\n        0: re.compile(b'<sage-display>')\n**********************************************************************\n```\n\nAlways disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.\n\n```\n./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx\n\n```\n",
    "created_at": "2022-01-30T20:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467632",
    "user": "vbraun"
}
```

With this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. 

```
sage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py
**********************************************************************
File "src/sage/interfaces/maxima_abstract.py", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands
Failed example:
    sorted(maxima._commands(verbose=False))
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>", line 1, in <module>
        sorted(maxima._commands(verbose=False))
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in _commands
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in <listcomp>
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 296, in completions
        cmd_list = self._eval_line('apropos("%s")'%s, error_check=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 814, in _eval_line
        self._expect_expr(self._display_prompt)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 731, in _expect_expr
        i = self._expect.expect(expr)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 343, in expect
        return self.expect_list(compiled_pattern_list,
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 372, in expect_list
        return exp.expect_loop(timeout)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 179, in expect_loop
        return self.eof(e)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 122, in eof
        raise exc
    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.
    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp
    command: /home/release/Sage/local/bin/maxima
    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']
    buffer (last 100 chars): b''
    before (last 100 chars): ''
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: None
    flag_eof: True
    pid: 1795009
    child_fd: 20
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile(b'<sage-display>')
**********************************************************************
```

Always disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.

```
./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx

```




---

archive/issue_comments_467633.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-01-30T20:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467633",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_467634.json:
```json
{
    "body": "Actually seems to be due to #32986",
    "created_at": "2022-01-30T23:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467634",
    "user": "vbraun"
}
```

Actually seems to be due to #32986



---

archive/issue_comments_467635.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-31T13:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467635",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_467636.json:
```json
{
    "body": "I have just been hit by this problem on the patchbot as well. For me, running ptestlong now leaves about 47 maxima processes running at around 130% cpu usage on average, as well as two ecl and several fricas processes.\n\nWith the current branch, the problem seems to go away.",
    "created_at": "2022-02-07T22:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467636",
    "user": "@mwageringel"
}
```

I have just been hit by this problem on the patchbot as well. For me, running ptestlong now leaves about 47 maxima processes running at around 130% cpu usage on average, as well as two ecl and several fricas processes.

With the current branch, the problem seems to go away.



---

archive/issue_comments_467637.json:
```json
{
    "body": "feel free to give it positive review, again...",
    "created_at": "2022-02-07T22:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467637",
    "user": "dimpase"
}
```

feel free to give it positive review, again...



---

archive/issue_comments_467638.json:
```json
{
    "body": "Longer term we will probably want threads enabled anyway (the upstream and most distros default), even if #8784 goes in, so.",
    "created_at": "2022-02-08T01:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467638",
    "user": "mjo"
}
```

Longer term we will probably want threads enabled anyway (the upstream and most distros default), even if #8784 goes in, so.



---

archive/issue_comments_467639.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-08T01:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467639",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467640.json:
```json
{
    "body": "At first, I thought the branch would disable threads, but actually it is the other way around. If threads had been disabled before, I am surprised the zombie processes use more than 100% cpu.",
    "created_at": "2022-02-08T08:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467640",
    "user": "@mwageringel"
}
```

At first, I thought the branch would disable threads, but actually it is the other way around. If threads had been disabled before, I am surprised the zombie processes use more than 100% cpu.



---

archive/issue_comments_467641.json:
```json
{
    "body": "The patch resulted from an observation that a system-wide `ecl` with threads enabled does not produce zombie processes. Probably `sage-cleaner` works better on them.",
    "created_at": "2022-02-08T09:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467641",
    "user": "dimpase"
}
```

The patch resulted from an observation that a system-wide `ecl` with threads enabled does not produce zombie processes. Probably `sage-cleaner` works better on them.



---

archive/issue_comments_467642.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-13T10:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32790#issuecomment-467642",
    "user": "vbraun"
}
```

Resolution: fixed
