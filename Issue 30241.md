# Issue 30241: Suitesparse build failure with cuda 11. (sage 9.1)

Issue created by migration from https://trac.sagemath.org/ticket/30478

Original creator: johan

Original creation time: 2020-08-31 07:53:17

CC:  fbissey embray dimpase mjo @kliem

Sage 9.1 fails to build with cuda 11, as cuda 11 no longer supports the "architecture" compute_30.

Upstream ticket: https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/56

A fix would be to remove compute_30 from the build commands.


---

Comment by mkoeppe created at 2020-08-31 15:21:24

How to replicate the build failure?


---

Comment by johan created at 2020-09-01 07:56:17

I am not sure what your environment is, but the following is the contents of a small dockerfile to replicate the build failure:


```
FROM nvidia/cuda:11.0-devel-ubuntu20.04

SHELL ["/bin/bash", "-c"]

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install --yes build-essential m4 dpkg-dev gettext automake apt-utils git cmake pkg-config python

RUN adduser user < /dev/null

USER user
WORKDIR /home/user/

RUN mkdir Sage && \
    git clone git://git.sagemath.org/sage.git Sage && \
    cd Sage && \
    git checkout 9.1

RUN cd Sage && \
    make -j 4 |& tee build_log.txt || true
```



After the build, the file /home/user/Sage/logs/pkgs/suitesparse-5.6.0.log contains the following, near the end:


```
/usr/local/cuda/bin/nvcc -I../../AMD/Include -I../../AMD/Source -I../../COLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CCOLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CAMD/Include -I../Include -I../../SuiteSparse_config -I/usr/local/cuda/include/ -Xcompiler -fPIC -O3 -gencode=arch=compute_30,code=sm_30 -gencode=arch=compute_35,code=sm_35 -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_60,code=compute_60 -c ../GPU/cholmod_gpu_kernels.cu
nvcc fatal   : Unsupported gpu architecture 'compute_30'
```


My GPU happens to support compute_60, but the build statement looks very generic, so I assume it might not even matter that I have a GPU, for the purposes of replicating the build failure.


---

Comment by mkoeppe created at 2020-09-01 17:34:52

I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.


---

Comment by mkoeppe created at 2020-09-01 17:35:32

New commits:


---

Comment by mkoeppe created at 2020-09-01 18:35:44

Someone should prepare a pull request for upstream.


---

Comment by johan created at 2021-05-19 13:47:36

There was a new commit to upstream pushed to github yesterday, and it seems to have removed references to compute_30 from the build files.

New contents in the file named "ChangeLog" in the commit:

 May 17, 2021, SuiteSparse 5.10.1

    * CUDA: remove sm_30 from SuiteSparse_config.mk
    * GraphBLAS v5.0.5: minor bug fix
    * minor changes to Makefiles


A rebuild of Sage with SuiteSparse version 5.10.1, or with its master branch (which is currently probably the same), would be interesting.


---

Comment by mkoeppe created at 2021-05-19 15:24:42

Looks like we have to wait for an actual release - https://github.com/DrTimothyAldenDavis/SuiteSparse/releases is still at 5.10.0


---

Comment by johan created at 2021-05-25 09:05:52

The upstream github page your refer to now says that 5.10.1 was released 10 hours ago.


---

Comment by git created at 2021-05-25 16:31:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-05-25 16:35:43

Patches need to be updated or removed.


---

Comment by fbissey created at 2021-05-25 19:57:55

I will try to have a look today.


---

Comment by @KarlMagnusLarsson created at 2021-06-01 16:27:05

I have cuda 11.2 on Debian Testing (Bullseye) and I can no longer build Sage 9.3 or Sage develop branch from git. I get the error reported here: "nvcc fatal   : Unsupported gpu architecture 'compute_30' "

[Johan writes]: "A fix would be to remove compute_30 from the build commands."

How can I temporarily patch Sage develop code to remove compute_30? 

What I want to do is: 

1) pull the latest git source code from develop branch.

2) patch my locally cloned and checked out git develop code, removing compute_30 (I do not need it).

3) ./configure and make to get a working sage again.


---

Comment by fbissey created at 2021-06-08 01:32:23

At long last I fixed the patches to work with this version of suitesparse. Works on local linux box but OS X and windows need to be checked to see if new work is needed on those.
----
New commits:


---

Comment by fbissey created at 2021-06-08 01:32:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-08 05:03:24

Replying to [comment:4 mkoeppe]:
> I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.

With this branch, this now succeeds.

Running it on GH Actions now


---

Comment by mkoeppe created at 2021-06-19 18:30:07

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-06-19 18:30:07

On `ubuntu-trusty-standard` (https://github.com/mkoeppe/sage/runs/2770535461?check_suite_focus=true) and similar:

```
  [suitesparse-5.10.1]   gcc -O2 -g    -O3 -fexceptions -fPIC -fopenmp -I../Include -I../../COLAMD/Include -I../../AMD/Include -I../../SuiteSparse_config  -c ../Source/slip_create_mpfr_array.c
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c: In function 'slip_create_mpfr_array':
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: error: 'for' loop initial declarations are only allowed in C99 mode
  [suitesparse-5.10.1]        for (int64_t i = 0; i < n; i++)
  [suitesparse-5.10.1]        ^
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: note: use option -std=c99 or -std=gnu99 to compile your code
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:39:13: error: 'for' loop initial declarations are only allowed in C99 mode
  [suitesparse-5.10.1]                for (int64_t j = 0; j < n; j++)
  [suitesparse-5.10.1]                ^
  [suitesparse-5.10.1]   make[8]: *** [slip_create_mpfr_array.o] Error 1
```



---

Comment by mkoeppe created at 2021-06-19 18:32:45

On `cygwin-standard` (https://github.com/mkoeppe/sage/runs/2771235514?check_suite_focus=true)

```
( cd /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib ; ln -sf cyglibsliplu-1.dll  )
ln: 'cyglibsliplu-1.dll' and './cyglibsliplu-1.dll' are the same file
make[6]: *** [Makefile:73: /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib/cyglibsliplu-1.dll] Error 1
```



---

Comment by mkoeppe created at 2021-06-19 20:07:06

`@`fbissey - do you have a repo from which you generated the updated patches?


---

Comment by fbissey created at 2021-06-19 21:04:51

Replying to [comment:22 mkoeppe]:
> `@`fbissey - do you have a repo from which you generated the updated patches?

No. Not those. Gentoo has historically split suitesparse, and I have somewhat inherited that effort lately. **It is not a winning strategy so far**. Upstream has somewhat inconsistent upkeep of the versioning of the sub-packages and has done source changes without version bump of the sub-package concerned (because of minor mistake in the original release). I also inherited broken GPU support in cholmod that I haven't ever found the time to fix.

The failure on ubuntu trusty is probably because gcc does not default to C99, that can be fixed but do we really want to continue supporting 14.04?

I have had no hand in writing the original cygwin patch. Someone familiar with it should inspect it.
The updated patch is strictly an update on the sage patches I and other wrote over the years.


---

Comment by fbissey created at 2021-06-19 21:14:33

I see why cygwin failed, there is a new sub-package SLIP_LU that didn't exist before so it isn't patched. It is not used by anything so we could just skip it for now.


---

Comment by mkoeppe created at 2021-06-19 21:35:53

Replying to [comment:23 fbissey]:
> do we really want to continue supporting 14.04?

Yes, I think we still need to support it (and similar systems) for a while - see #31526


---

Comment by fbissey created at 2021-06-19 21:47:10

Replying to [comment:25 mkoeppe]:
> Replying to [comment:23 fbissey]:
> > do we really want to continue supporting 14.04?
> 
> Yes, I think we still need to support it (and similar systems) for a while - see #31526

OK, sage should set up a C99 compiler, I just have to pass it. I think I may be able to ape the cygwin stuff (cross fingers).


---

Comment by mkoeppe created at 2021-06-19 22:41:41

I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true


---

Comment by fbissey created at 2021-06-20 01:18:29

Replying to [comment:27 mkoeppe]:
> I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true

This is most curious. Patch says the top Makefile is not found. Either you are not in right directory or something is cleaning it after the checkout.


---

Comment by git created at 2021-06-20 01:24:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-06-20 01:27:01

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2021-06-20 01:27:01

Ok, this should take care of the two issues spotted in the review workflow. Patching for C99 may be heavy handed, it could be passed to Make.


---

Comment by mkoeppe created at 2021-06-20 05:20:13

Replying to [comment:28 fbissey]:
> Replying to [comment:27 mkoeppe]:
> > our patches do not seem to apply to suitesparse `master`
> 
> This is most curious. Patch says the top Makefile is not found. 

Sorry for the noise - this was just a stupid mistake in my script


---

Comment by mkoeppe created at 2021-06-20 05:58:11

Using suitesparse master, with my corrected workflow run, I see on `debian-stretch-standard` in https://github.com/mkoeppe/SuiteSparse/runs/2867609846?check_suite_focus=true:

```
  [suitesparse-git]   ranlib libsliplu.a
  [suitesparse-git]   SLIP_gmp.o: In function `SLIP_mpfr_get_q':
  [suitesparse-git]   /sage/local/var/tmp/sage/build/suitesparse-git/src/SLIP_LU/Lib/../Source/SLIP_gmp.c:1526: undefined reference to `mpfr_get_q'
  [suitesparse-git]   collect2: error: ld returned 1 exit status
  [suitesparse-git]   Makefile:69: recipe for target '/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2' failed
  [suitesparse-git]   make[6]: *** [/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2] Error 1
  [suitesparse-git]   make[6]: Target 'install' not remade because of errors.
```

Looks like we are missing some dependencies.
(I don't know yet if this also affects the release that we are using.)


---

Comment by mkoeppe created at 2021-06-20 06:11:45

In `SLIP_LU/Lib/Makefile` one can see that it needs `mpfr` and `gmp`


---

Comment by mkoeppe created at 2021-06-20 06:20:32

New commits:


---

Comment by mkoeppe created at 2021-06-20 06:33:35

Upstream PR adding the ci-sage workflow at: https://github.com/DrTimothyAldenDavis/SuiteSparse/pull/95


---

Comment by fbissey created at 2021-06-20 08:14:40

I totally missed that dependency. It didn't connect in my head that suitesparse didn't depend on those so far. Good catch from those workflows.


---

Comment by git created at 2021-06-20 20:40:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-20 20:43:08

Another round of testing on top of the current beta


---

Comment by mkoeppe created at 2021-07-11 16:29:32

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-11 16:29:32

On `macos-homebrew-minimal-default-11.0` (https://github.com/mkoeppe/sage/runs/2870369436?check_suite_focus=true):

```
  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_type.cpp
  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'
  [suitesparse-5.10.1]   make[7]: *** [spqr_type.o] Error 1
  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_tol.cpp
  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'
  [suitesparse-5.10.1]   make[7]: *** [spqr_tol.o] Error 1
```



---

Comment by git created at 2021-07-11 17:45:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-11 17:53:59

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2021-07-11 19:56:58

OK c99 is an own goal. I enabled it that way because it was required for some of the libraries. So a better approach may be to remove the patch `05-c99.patch` and to set `CC="$CC -std-c99"`.


---

Comment by fbissey created at 2021-07-11 19:59:31

OK c99 was needed for ubuntu 14.04 not some libraries.


---

Comment by mkoeppe created at 2021-07-11 20:03:09

Ha, this explains why I didn't find the c99 stuff in upstream github...


---

Comment by git created at 2021-07-11 20:22:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-11 20:30:39

OK, this works on `local-homebrew-macos-minimal`.


---

Comment by dimpase created at 2021-07-18 08:24:27

there are some weird "unable to build wheels" messages, e.g.

```
 [fpylll-0.5.6]   Failed to build fpylll
2843
  [fpylll-0.5.6]   ERROR: Failed to build one or more wheels
```

in https://github.com/mkoeppe/sage/runs/3041607937


---

Comment by dimpase created at 2021-07-18 08:30:17

and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:

```
[pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'
```



---

Comment by mkoeppe created at 2021-07-18 17:19:51

Replying to [comment:52 dimpase]:
> and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:
> {{{
> [pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'
> }}}
That's already broken in 9.4.beta4, see #32001


---

Comment by mkoeppe created at 2021-07-18 17:23:07

Replying to [comment:51 dimpase]:
> there are some weird "unable to build wheels" messages, e.g.
> {{{
>  [fpylll-0.5.6]   Failed to build fpylll
> 2843
>   [fpylll-0.5.6]   ERROR: Failed to build one or more wheels
> }}}
> in https://github.com/mkoeppe/sage/runs/3041607937
That log is from the configuration `homebrew-macos-python3_xcode-nokegonly`, which tests what happens without running `.homebrew-build-env` before the build...


---

Comment by dimpase created at 2021-07-19 17:19:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-07-19 17:19:55

lgtm


---

Comment by mkoeppe created at 2021-07-19 19:36:54

Thanks!


---

Comment by mkoeppe created at 2021-07-19 19:37:13

Changing priority from major to critical.


---

Comment by vbraun created at 2021-07-23 20:11:54

Resolution: fixed


---

Comment by @KarlMagnusLarsson created at 2021-08-07 11:44:51

Sage version 9.4.rc0 works for me with CUDA 11.2, compiled from git develop branch using Linux Debian testing (Bullseye).
