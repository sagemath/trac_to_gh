# Issue 30241: Suitesparse build failure with cuda 11. (sage 9.1)

archive/issues_030241.json:
```json
{
    "body": "CC:  fbissey embray dimpase mjo @kliem\n\nSage 9.1 fails to build with cuda 11, as cuda 11 no longer supports the \"architecture\" compute_30.\n\nUpstream ticket: https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/56\n\nA fix would be to remove compute_30 from the build commands.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30478\n\n",
    "created_at": "2020-08-31T07:53:17Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "Suitesparse build failure with cuda 11. (sage 9.1)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30241",
    "user": "johan"
}
```
CC:  fbissey embray dimpase mjo @kliem

Sage 9.1 fails to build with cuda 11, as cuda 11 no longer supports the "architecture" compute_30.

Upstream ticket: https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/56

A fix would be to remove compute_30 from the build commands.

Issue created by migration from https://trac.sagemath.org/ticket/30478





---

archive/issue_comments_431146.json:
```json
{
    "body": "How to replicate the build failure?",
    "created_at": "2020-08-31T15:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431146",
    "user": "mkoeppe"
}
```

How to replicate the build failure?



---

archive/issue_comments_431147.json:
```json
{
    "body": "I am not sure what your environment is, but the following is the contents of a small dockerfile to replicate the build failure:\n\n\n```\nFROM nvidia/cuda:11.0-devel-ubuntu20.04\n\nSHELL [\"/bin/bash\", \"-c\"]\n\nENV DEBIAN_FRONTEND=noninteractive\n\nRUN apt-get update && apt-get install --yes build-essential m4 dpkg-dev gettext automake apt-utils git cmake pkg-config python\n\nRUN adduser user < /dev/null\n\nUSER user\nWORKDIR /home/user/\n\nRUN mkdir Sage && \\\n    git clone git://git.sagemath.org/sage.git Sage && \\\n    cd Sage && \\\n    git checkout 9.1\n\nRUN cd Sage && \\\n    make -j 4 |& tee build_log.txt || true\n```\n\n\n\nAfter the build, the file /home/user/Sage/logs/pkgs/suitesparse-5.6.0.log contains the following, near the end:\n\n\n```\n/usr/local/cuda/bin/nvcc -I../../AMD/Include -I../../AMD/Source -I../../COLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CCOLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CAMD/Include -I../Include -I../../SuiteSparse_config -I/usr/local/cuda/include/ -Xcompiler -fPIC -O3 -gencode=arch=compute_30,code=sm_30 -gencode=arch=compute_35,code=sm_35 -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_60,code=compute_60 -c ../GPU/cholmod_gpu_kernels.cu\nnvcc fatal   : Unsupported gpu architecture 'compute_30'\n```\n\n\nMy GPU happens to support compute_60, but the build statement looks very generic, so I assume it might not even matter that I have a GPU, for the purposes of replicating the build failure.",
    "created_at": "2020-09-01T07:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431147",
    "user": "johan"
}
```

I am not sure what your environment is, but the following is the contents of a small dockerfile to replicate the build failure:


```
FROM nvidia/cuda:11.0-devel-ubuntu20.04

SHELL ["/bin/bash", "-c"]

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install --yes build-essential m4 dpkg-dev gettext automake apt-utils git cmake pkg-config python

RUN adduser user < /dev/null

USER user
WORKDIR /home/user/

RUN mkdir Sage && \
    git clone git://git.sagemath.org/sage.git Sage && \
    cd Sage && \
    git checkout 9.1

RUN cd Sage && \
    make -j 4 |& tee build_log.txt || true
```



After the build, the file /home/user/Sage/logs/pkgs/suitesparse-5.6.0.log contains the following, near the end:


```
/usr/local/cuda/bin/nvcc -I../../AMD/Include -I../../AMD/Source -I../../COLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CCOLAMD/Include -I/home/user/Sage/local/var/tmp/sage/build/suitesparse-5.6.0/src/CAMD/Include -I../Include -I../../SuiteSparse_config -I/usr/local/cuda/include/ -Xcompiler -fPIC -O3 -gencode=arch=compute_30,code=sm_30 -gencode=arch=compute_35,code=sm_35 -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_53,code=sm_53 -gencode=arch=compute_60,code=compute_60 -c ../GPU/cholmod_gpu_kernels.cu
nvcc fatal   : Unsupported gpu architecture 'compute_30'
```


My GPU happens to support compute_60, but the build statement looks very generic, so I assume it might not even matter that I have a GPU, for the purposes of replicating the build failure.



---

archive/issue_comments_431148.json:
```json
{
    "body": "I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.",
    "created_at": "2020-09-01T17:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431148",
    "user": "mkoeppe"
}
```

I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.



---

archive/issue_comments_431149.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-01T17:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431149",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_431150.json:
```json
{
    "body": "Someone should prepare a pull request for upstream.",
    "created_at": "2020-09-01T18:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431150",
    "user": "mkoeppe"
}
```

Someone should prepare a pull request for upstream.



---

archive/issue_comments_431151.json:
```json
{
    "body": "There was a new commit to upstream pushed to github yesterday, and it seems to have removed references to compute_30 from the build files.\n\nNew contents in the file named \"ChangeLog\" in the commit:\n\n May 17, 2021, SuiteSparse 5.10.1\n\n* CUDA: remove sm_30 from SuiteSparse_config.mk\n* GraphBLAS v5.0.5: minor bug fix\n* minor changes to Makefiles\n\n\nA rebuild of Sage with SuiteSparse version 5.10.1, or with its master branch (which is currently probably the same), would be interesting.",
    "created_at": "2021-05-19T13:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431151",
    "user": "johan"
}
```

There was a new commit to upstream pushed to github yesterday, and it seems to have removed references to compute_30 from the build files.

New contents in the file named "ChangeLog" in the commit:

 May 17, 2021, SuiteSparse 5.10.1

* CUDA: remove sm_30 from SuiteSparse_config.mk
* GraphBLAS v5.0.5: minor bug fix
* minor changes to Makefiles


A rebuild of Sage with SuiteSparse version 5.10.1, or with its master branch (which is currently probably the same), would be interesting.



---

archive/issue_comments_431152.json:
```json
{
    "body": "Looks like we have to wait for an actual release - https://github.com/DrTimothyAldenDavis/SuiteSparse/releases is still at 5.10.0",
    "created_at": "2021-05-19T15:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431152",
    "user": "mkoeppe"
}
```

Looks like we have to wait for an actual release - https://github.com/DrTimothyAldenDavis/SuiteSparse/releases is still at 5.10.0



---

archive/issue_comments_431153.json:
```json
{
    "body": "The upstream github page your refer to now says that 5.10.1 was released 10 hours ago.",
    "created_at": "2021-05-25T09:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431153",
    "user": "johan"
}
```

The upstream github page your refer to now says that 5.10.1 was released 10 hours ago.



---

archive/issue_comments_431154.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-25T16:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431154",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_431155.json:
```json
{
    "body": "Patches need to be updated or removed.",
    "created_at": "2021-05-25T16:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431155",
    "user": "mkoeppe"
}
```

Patches need to be updated or removed.



---

archive/issue_comments_431156.json:
```json
{
    "body": "I will try to have a look today.",
    "created_at": "2021-05-25T19:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431156",
    "user": "fbissey"
}
```

I will try to have a look today.



---

archive/issue_comments_431157.json:
```json
{
    "body": "I have cuda 11.2 on Debian Testing (Bullseye) and I can no longer build Sage 9.3 or Sage develop branch from git. I get the error reported here: \"nvcc fatal   : Unsupported gpu architecture 'compute_30' \"\n\n[Johan writes]: \"A fix would be to remove compute_30 from the build commands.\"\n\nHow can I temporarily patch Sage develop code to remove compute_30? \n\nWhat I want to do is: \n\n1) pull the latest git source code from develop branch.\n\n2) patch my locally cloned and checked out git develop code, removing compute_30 (I do not need it).\n\n3) ./configure and make to get a working sage again.",
    "created_at": "2021-06-01T16:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431157",
    "user": "@KarlMagnusLarsson"
}
```

I have cuda 11.2 on Debian Testing (Bullseye) and I can no longer build Sage 9.3 or Sage develop branch from git. I get the error reported here: "nvcc fatal   : Unsupported gpu architecture 'compute_30' "

[Johan writes]: "A fix would be to remove compute_30 from the build commands."

How can I temporarily patch Sage develop code to remove compute_30? 

What I want to do is: 

1) pull the latest git source code from develop branch.

2) patch my locally cloned and checked out git develop code, removing compute_30 (I do not need it).

3) ./configure and make to get a working sage again.



---

archive/issue_comments_431158.json:
```json
{
    "body": "At long last I fixed the patches to work with this version of suitesparse. Works on local linux box but OS X and windows need to be checked to see if new work is needed on those.\n----\nNew commits:",
    "created_at": "2021-06-08T01:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431158",
    "user": "fbissey"
}
```

At long last I fixed the patches to work with this version of suitesparse. Works on local linux box but OS X and windows need to be checked to see if new work is needed on those.
----
New commits:



---

archive/issue_comments_431159.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-08T01:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431159",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_431160.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.\n\nWith this branch, this now succeeds.\n\nRunning it on GH Actions now",
    "created_at": "2021-06-08T05:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431160",
    "user": "mkoeppe"
}
```

Replying to [comment:4 mkoeppe]:
> I was able to replicate the build error using `tox -e docker-ubuntu-focal-nvidia-cuda-11.0-standard -- suitesparse`.

With this branch, this now succeeds.

Running it on GH Actions now



---

archive/issue_comments_431161.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-19T18:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431161",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_431162.json:
```json
{
    "body": "On `ubuntu-trusty-standard` (https://github.com/mkoeppe/sage/runs/2770535461?check_suite_focus=true) and similar:\n\n```\n  [suitesparse-5.10.1]   gcc -O2 -g    -O3 -fexceptions -fPIC -fopenmp -I../Include -I../../COLAMD/Include -I../../AMD/Include -I../../SuiteSparse_config  -c ../Source/slip_create_mpfr_array.c\n  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c: In function 'slip_create_mpfr_array':\n  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: error: 'for' loop initial declarations are only allowed in C99 mode\n  [suitesparse-5.10.1]        for (int64_t i = 0; i < n; i++)\n  [suitesparse-5.10.1]        ^\n  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: note: use option -std=c99 or -std=gnu99 to compile your code\n  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:39:13: error: 'for' loop initial declarations are only allowed in C99 mode\n  [suitesparse-5.10.1]                for (int64_t j = 0; j < n; j++)\n  [suitesparse-5.10.1]                ^\n  [suitesparse-5.10.1]   make[8]: *** [slip_create_mpfr_array.o] Error 1\n```\n",
    "created_at": "2021-06-19T18:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431162",
    "user": "mkoeppe"
}
```

On `ubuntu-trusty-standard` (https://github.com/mkoeppe/sage/runs/2770535461?check_suite_focus=true) and similar:

```
  [suitesparse-5.10.1]   gcc -O2 -g    -O3 -fexceptions -fPIC -fopenmp -I../Include -I../../COLAMD/Include -I../../AMD/Include -I../../SuiteSparse_config  -c ../Source/slip_create_mpfr_array.c
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c: In function 'slip_create_mpfr_array':
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: error: 'for' loop initial declarations are only allowed in C99 mode
  [suitesparse-5.10.1]        for (int64_t i = 0; i < n; i++)
  [suitesparse-5.10.1]        ^
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:34:5: note: use option -std=c99 or -std=gnu99 to compile your code
  [suitesparse-5.10.1]   ../Source/slip_create_mpfr_array.c:39:13: error: 'for' loop initial declarations are only allowed in C99 mode
  [suitesparse-5.10.1]                for (int64_t j = 0; j < n; j++)
  [suitesparse-5.10.1]                ^
  [suitesparse-5.10.1]   make[8]: *** [slip_create_mpfr_array.o] Error 1
```




---

archive/issue_comments_431163.json:
```json
{
    "body": "On `cygwin-standard` (https://github.com/mkoeppe/sage/runs/2771235514?check_suite_focus=true)\n\n```\n( cd /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib ; ln -sf cyglibsliplu-1.dll  )\nln: 'cyglibsliplu-1.dll' and './cyglibsliplu-1.dll' are the same file\nmake[6]: *** [Makefile:73: /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib/cyglibsliplu-1.dll] Error 1\n```\n",
    "created_at": "2021-06-19T18:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431163",
    "user": "mkoeppe"
}
```

On `cygwin-standard` (https://github.com/mkoeppe/sage/runs/2771235514?check_suite_focus=true)

```
( cd /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib ; ln -sf cyglibsliplu-1.dll  )
ln: 'cyglibsliplu-1.dll' and './cyglibsliplu-1.dll' are the same file
make[6]: *** [Makefile:73: /opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/inst/opt/sage-c532fcc49d77cd3e9b397ae3e38102498967c798/var/tmp/sage/build/suitesparse-5.10.1/src/lib/cyglibsliplu-1.dll] Error 1
```




---

archive/issue_comments_431164.json:
```json
{
    "body": "`@`fbissey - do you have a repo from which you generated the updated patches?",
    "created_at": "2021-06-19T20:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431164",
    "user": "mkoeppe"
}
```

`@`fbissey - do you have a repo from which you generated the updated patches?



---

archive/issue_comments_431165.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> `@`fbissey - do you have a repo from which you generated the updated patches?\n\nNo. Not those. Gentoo has historically split suitesparse, and I have somewhat inherited that effort lately. **It is not a winning strategy so far**. Upstream has somewhat inconsistent upkeep of the versioning of the sub-packages and has done source changes without version bump of the sub-package concerned (because of minor mistake in the original release). I also inherited broken GPU support in cholmod that I haven't ever found the time to fix.\n\nThe failure on ubuntu trusty is probably because gcc does not default to C99, that can be fixed but do we really want to continue supporting 14.04?\n\nI have had no hand in writing the original cygwin patch. Someone familiar with it should inspect it.\nThe updated patch is strictly an update on the sage patches I and other wrote over the years.",
    "created_at": "2021-06-19T21:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431165",
    "user": "fbissey"
}
```

Replying to [comment:22 mkoeppe]:
> `@`fbissey - do you have a repo from which you generated the updated patches?

No. Not those. Gentoo has historically split suitesparse, and I have somewhat inherited that effort lately. **It is not a winning strategy so far**. Upstream has somewhat inconsistent upkeep of the versioning of the sub-packages and has done source changes without version bump of the sub-package concerned (because of minor mistake in the original release). I also inherited broken GPU support in cholmod that I haven't ever found the time to fix.

The failure on ubuntu trusty is probably because gcc does not default to C99, that can be fixed but do we really want to continue supporting 14.04?

I have had no hand in writing the original cygwin patch. Someone familiar with it should inspect it.
The updated patch is strictly an update on the sage patches I and other wrote over the years.



---

archive/issue_comments_431166.json:
```json
{
    "body": "I see why cygwin failed, there is a new sub-package SLIP_LU that didn't exist before so it isn't patched. It is not used by anything so we could just skip it for now.",
    "created_at": "2021-06-19T21:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431166",
    "user": "fbissey"
}
```

I see why cygwin failed, there is a new sub-package SLIP_LU that didn't exist before so it isn't patched. It is not used by anything so we could just skip it for now.



---

archive/issue_comments_431167.json:
```json
{
    "body": "Replying to [comment:23 fbissey]:\n> do we really want to continue supporting 14.04?\n\nYes, I think we still need to support it (and similar systems) for a while - see #31526",
    "created_at": "2021-06-19T21:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431167",
    "user": "mkoeppe"
}
```

Replying to [comment:23 fbissey]:
> do we really want to continue supporting 14.04?

Yes, I think we still need to support it (and similar systems) for a while - see #31526



---

archive/issue_comments_431168.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> Replying to [comment:23 fbissey]:\n> > do we really want to continue supporting 14.04?\n> \n> Yes, I think we still need to support it (and similar systems) for a while - see #31526\n\nOK, sage should set up a C99 compiler, I just have to pass it. I think I may be able to ape the cygwin stuff (cross fingers).",
    "created_at": "2021-06-19T21:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431168",
    "user": "fbissey"
}
```

Replying to [comment:25 mkoeppe]:
> Replying to [comment:23 fbissey]:
> > do we really want to continue supporting 14.04?
> 
> Yes, I think we still need to support it (and similar systems) for a while - see #31526

OK, sage should set up a C99 compiler, I just have to pass it. I think I may be able to ape the cygwin stuff (cross fingers).



---

archive/issue_comments_431169.json:
```json
{
    "body": "I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true",
    "created_at": "2021-06-19T22:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431169",
    "user": "mkoeppe"
}
```

I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true



---

archive/issue_comments_431170.json:
```json
{
    "body": "Replying to [comment:27 mkoeppe]:\n> I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true\n\nThis is most curious. Patch says the top Makefile is not found. Either you are not in right directory or something is cleaning it after the checkout.",
    "created_at": "2021-06-20T01:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431170",
    "user": "fbissey"
}
```

Replying to [comment:27 mkoeppe]:
> I've create a GH Actions workflow for SuiteSparse https://github.com/mkoeppe/SuiteSparse/blob/master/.github/workflows/ci-sage.yml but our patches do not seem to apply to suitesparse `master` - https://github.com/mkoeppe/SuiteSparse/runs/2866504038?check_suite_focus=true

This is most curious. Patch says the top Makefile is not found. Either you are not in right directory or something is cleaning it after the checkout.



---

archive/issue_comments_431171.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-20T01:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431171",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431172.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-20T01:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431172",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_431173.json:
```json
{
    "body": "Ok, this should take care of the two issues spotted in the review workflow. Patching for C99 may be heavy handed, it could be passed to Make.",
    "created_at": "2021-06-20T01:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431173",
    "user": "fbissey"
}
```

Ok, this should take care of the two issues spotted in the review workflow. Patching for C99 may be heavy handed, it could be passed to Make.



---

archive/issue_comments_431174.json:
```json
{
    "body": "Replying to [comment:28 fbissey]:\n> Replying to [comment:27 mkoeppe]:\n> > our patches do not seem to apply to suitesparse `master`\n> \n> This is most curious. Patch says the top Makefile is not found. \n\nSorry for the noise - this was just a stupid mistake in my script",
    "created_at": "2021-06-20T05:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431174",
    "user": "mkoeppe"
}
```

Replying to [comment:28 fbissey]:
> Replying to [comment:27 mkoeppe]:
> > our patches do not seem to apply to suitesparse `master`
> 
> This is most curious. Patch says the top Makefile is not found. 

Sorry for the noise - this was just a stupid mistake in my script



---

archive/issue_comments_431175.json:
```json
{
    "body": "Using suitesparse master, with my corrected workflow run, I see on `debian-stretch-standard` in https://github.com/mkoeppe/SuiteSparse/runs/2867609846?check_suite_focus=true:\n\n```\n  [suitesparse-git]   ranlib libsliplu.a\n  [suitesparse-git]   SLIP_gmp.o: In function `SLIP_mpfr_get_q':\n  [suitesparse-git]   /sage/local/var/tmp/sage/build/suitesparse-git/src/SLIP_LU/Lib/../Source/SLIP_gmp.c:1526: undefined reference to `mpfr_get_q'\n  [suitesparse-git]   collect2: error: ld returned 1 exit status\n  [suitesparse-git]   Makefile:69: recipe for target '/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2' failed\n  [suitesparse-git]   make[6]: *** [/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2] Error 1\n  [suitesparse-git]   make[6]: Target 'install' not remade because of errors.\n```\n\nLooks like we are missing some dependencies.\n(I don't know yet if this also affects the release that we are using.)",
    "created_at": "2021-06-20T05:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431175",
    "user": "mkoeppe"
}
```

Using suitesparse master, with my corrected workflow run, I see on `debian-stretch-standard` in https://github.com/mkoeppe/SuiteSparse/runs/2867609846?check_suite_focus=true:

```
  [suitesparse-git]   ranlib libsliplu.a
  [suitesparse-git]   SLIP_gmp.o: In function `SLIP_mpfr_get_q':
  [suitesparse-git]   /sage/local/var/tmp/sage/build/suitesparse-git/src/SLIP_LU/Lib/../Source/SLIP_gmp.c:1526: undefined reference to `mpfr_get_q'
  [suitesparse-git]   collect2: error: ld returned 1 exit status
  [suitesparse-git]   Makefile:69: recipe for target '/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2' failed
  [suitesparse-git]   make[6]: *** [/sage/local/var/tmp/sage/build/suitesparse-git/inst/sage/local/var/tmp/sage/build/suitesparse-git/src/lib/libsliplu.so.1.0.2] Error 1
  [suitesparse-git]   make[6]: Target 'install' not remade because of errors.
```

Looks like we are missing some dependencies.
(I don't know yet if this also affects the release that we are using.)



---

archive/issue_comments_431176.json:
```json
{
    "body": "In `SLIP_LU/Lib/Makefile` one can see that it needs `mpfr` and `gmp`",
    "created_at": "2021-06-20T06:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431176",
    "user": "mkoeppe"
}
```

In `SLIP_LU/Lib/Makefile` one can see that it needs `mpfr` and `gmp`



---

archive/issue_comments_431177.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-20T06:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431177",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_431178.json:
```json
{
    "body": "Upstream PR adding the ci-sage workflow at: https://github.com/DrTimothyAldenDavis/SuiteSparse/pull/95",
    "created_at": "2021-06-20T06:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431178",
    "user": "mkoeppe"
}
```

Upstream PR adding the ci-sage workflow at: https://github.com/DrTimothyAldenDavis/SuiteSparse/pull/95



---

archive/issue_comments_431179.json:
```json
{
    "body": "I totally missed that dependency. It didn't connect in my head that suitesparse didn't depend on those so far. Good catch from those workflows.",
    "created_at": "2021-06-20T08:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431179",
    "user": "fbissey"
}
```

I totally missed that dependency. It didn't connect in my head that suitesparse didn't depend on those so far. Good catch from those workflows.



---

archive/issue_comments_431180.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-20T20:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431180",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431181.json:
```json
{
    "body": "Another round of testing on top of the current beta",
    "created_at": "2021-06-20T20:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431181",
    "user": "mkoeppe"
}
```

Another round of testing on top of the current beta



---

archive/issue_comments_431182.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-11T16:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431182",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_431183.json:
```json
{
    "body": "On `macos-homebrew-minimal-default-11.0` (https://github.com/mkoeppe/sage/runs/2870369436?check_suite_focus=true):\n\n```\n  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_type.cpp\n  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'\n  [suitesparse-5.10.1]   make[7]: *** [spqr_type.o] Error 1\n  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_tol.cpp\n  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'\n  [suitesparse-5.10.1]   make[7]: *** [spqr_tol.o] Error 1\n```\n",
    "created_at": "2021-07-11T16:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431183",
    "user": "mkoeppe"
}
```

On `macos-homebrew-minimal-default-11.0` (https://github.com/mkoeppe/sage/runs/2870369436?check_suite_focus=true):

```
  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_type.cpp
  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'
  [suitesparse-5.10.1]   make[7]: *** [spqr_type.o] Error 1
  [suitesparse-5.10.1]   g++ -std=gnu++11 -std=c99 -O2 -g -march=native   -O3 -fexceptions -fPIC -fno-common   -DNPARTITION -DNPARTITION -I../../CHOLMOD/Include -I../../SuiteSparse_config -I../Include -c ../Source/spqr_tol.cpp
  [suitesparse-5.10.1]   error: invalid argument '-std=c99' not allowed with 'C++'
  [suitesparse-5.10.1]   make[7]: *** [spqr_tol.o] Error 1
```




---

archive/issue_comments_431184.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-11T17:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431184",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431185.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-11T17:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431185",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_431186.json:
```json
{
    "body": "OK c99 is an own goal. I enabled it that way because it was required for some of the libraries. So a better approach may be to remove the patch `05-c99.patch` and to set `CC=\"$CC -std-c99\"`.",
    "created_at": "2021-07-11T19:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431186",
    "user": "fbissey"
}
```

OK c99 is an own goal. I enabled it that way because it was required for some of the libraries. So a better approach may be to remove the patch `05-c99.patch` and to set `CC="$CC -std-c99"`.



---

archive/issue_comments_431187.json:
```json
{
    "body": "OK c99 was needed for ubuntu 14.04 not some libraries.",
    "created_at": "2021-07-11T19:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431187",
    "user": "fbissey"
}
```

OK c99 was needed for ubuntu 14.04 not some libraries.



---

archive/issue_comments_431188.json:
```json
{
    "body": "Ha, this explains why I didn't find the c99 stuff in upstream github...",
    "created_at": "2021-07-11T20:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431188",
    "user": "mkoeppe"
}
```

Ha, this explains why I didn't find the c99 stuff in upstream github...



---

archive/issue_comments_431189.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-11T20:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431189",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431190.json:
```json
{
    "body": "OK, this works on `local-homebrew-macos-minimal`.",
    "created_at": "2021-07-11T20:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431190",
    "user": "mkoeppe"
}
```

OK, this works on `local-homebrew-macos-minimal`.



---

archive/issue_comments_431191.json:
```json
{
    "body": "there are some weird \"unable to build wheels\" messages, e.g.\n\n```\n [fpylll-0.5.6]   Failed to build fpylll\n2843\n  [fpylll-0.5.6]   ERROR: Failed to build one or more wheels\n```\n\nin https://github.com/mkoeppe/sage/runs/3041607937",
    "created_at": "2021-07-18T08:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431191",
    "user": "dimpase"
}
```

there are some weird "unable to build wheels" messages, e.g.

```
 [fpylll-0.5.6]   Failed to build fpylll
2843
  [fpylll-0.5.6]   ERROR: Failed to build one or more wheels
```

in https://github.com/mkoeppe/sage/runs/3041607937



---

archive/issue_comments_431192.json:
```json
{
    "body": "and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:\n\n```\n[pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'\n```\n",
    "created_at": "2021-07-18T08:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431192",
    "user": "dimpase"
}
```

and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:

```
[pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'
```




---

archive/issue_comments_431193.json:
```json
{
    "body": "Replying to [comment:52 dimpase]:\n> and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:\n> {{{\n> [pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'\n> }}}\nThat's already broken in 9.4.beta4, see #32001",
    "created_at": "2021-07-18T17:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431193",
    "user": "mkoeppe"
}
```

Replying to [comment:52 dimpase]:
> and on cygwin (https://github.com/mkoeppe/sage/actions/runs/1020782726) it fails in pynac:
> {{{
> [pynac-0.7.29]   /opt/sage-eabc953c0be7b71fd331c182a8fb31b31c3310b0/var/tmp/sage/build/pynac-0.7.29/src/ginac/mpoly-singular.cpp:92: undefined reference to `operator-(CanonicalForm const&)'
> }}}
That's already broken in 9.4.beta4, see #32001



---

archive/issue_comments_431194.json:
```json
{
    "body": "Replying to [comment:51 dimpase]:\n> there are some weird \"unable to build wheels\" messages, e.g.\n> {{{\n>  [fpylll-0.5.6]   Failed to build fpylll\n> 2843\n>   [fpylll-0.5.6]   ERROR: Failed to build one or more wheels\n> }}}\n> in https://github.com/mkoeppe/sage/runs/3041607937\nThat log is from the configuration `homebrew-macos-python3_xcode-nokegonly`, which tests what happens without running `.homebrew-build-env` before the build...",
    "created_at": "2021-07-18T17:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431194",
    "user": "mkoeppe"
}
```

Replying to [comment:51 dimpase]:
> there are some weird "unable to build wheels" messages, e.g.
> {{{
>  [fpylll-0.5.6]   Failed to build fpylll
> 2843
>   [fpylll-0.5.6]   ERROR: Failed to build one or more wheels
> }}}
> in https://github.com/mkoeppe/sage/runs/3041607937
That log is from the configuration `homebrew-macos-python3_xcode-nokegonly`, which tests what happens without running `.homebrew-build-env` before the build...



---

archive/issue_comments_431195.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-19T17:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431195",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_431196.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-07-19T17:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431196",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_431197.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-07-19T19:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431197",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_431198.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-19T19:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431198",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_431199.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431199",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_431200.json:
```json
{
    "body": "Sage version 9.4.rc0 works for me with CUDA 11.2, compiled from git develop branch using Linux Debian testing (Bullseye).",
    "created_at": "2021-08-07T11:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30241#issuecomment-431200",
    "user": "@KarlMagnusLarsson"
}
```

Sage version 9.4.rc0 works for me with CUDA 11.2, compiled from git develop branch using Linux Debian testing (Bullseye).
