# Issue 5839: MPolynomialRing_libsingular __dealloc__ is buggy, can lead to crash

archive/issues_005839.json:
```json
{
    "assignees": [],
    "body": "In `__dealloc__`, if currRing is NULL on entry, then currRing will be the ring we just deleted on exit.  The patch fixes this bug, so that currRing never points to freed memory.\n\nIt took me quite a while to come up with a small reproducible test case for the problem; here it is.  (This test case is also in the patch, as a doctest.)\n\n```\nimport gc\nfrom sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular\nR1 = MPolynomialRing_libsingular(GF(5), 2, ('x', 'y'), TermOrder('degrevlex', 2))\nR2 = MPolynomialRing_libsingular(GF(11), 2, ('x', 'y'), TermOrder('degrevlex', 2))\nR3 = MPolynomialRing_libsingular(GF(13), 2, ('x', 'y'), TermOrder('degrevlex', 2))\ngc.collect()\nfoo = R1.gen(0)\ndel foo\ndel R1\ngc.collect()\ndel R2\ngc.collect()\ndel R3\ngc.collect()\n```\n\n\nAssignee: **cwitty**\n\nCC:  @malb\n\n_Issue created by migration from https://trac.sagemath.org/ticket/5839_\n\n",
    "closed_at": "2009-05-14T05:16:49Z",
    "created_at": "2009-04-20T22:22:09Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "MPolynomialRing_libsingular __dealloc__ is buggy, can lead to crash",
    "type": "issue",
    "updated_at": "2009-05-14T05:16:49Z",
    "url": "https://github.com/sagemath/sage/issues/5839",
    "user": "https://github.com/sagetrac-cwitty"
}
```
In `__dealloc__`, if currRing is NULL on entry, then currRing will be the ring we just deleted on exit.  The patch fixes this bug, so that currRing never points to freed memory.

It took me quite a while to come up with a small reproducible test case for the problem; here it is.  (This test case is also in the patch, as a doctest.)

```
import gc
from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular
R1 = MPolynomialRing_libsingular(GF(5), 2, ('x', 'y'), TermOrder('degrevlex', 2))
R2 = MPolynomialRing_libsingular(GF(11), 2, ('x', 'y'), TermOrder('degrevlex', 2))
R3 = MPolynomialRing_libsingular(GF(13), 2, ('x', 'y'), TermOrder('degrevlex', 2))
gc.collect()
foo = R1.gen(0)
del foo
del R1
gc.collect()
del R2
gc.collect()
del R3
gc.collect()
```


Assignee: **cwitty**

CC:  @malb

_Issue created by migration from https://trac.sagemath.org/ticket/5839_





---

archive/issue_events_060906.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-20T22:22:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "milestone_number": null,
    "milestone_title": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60906"
}
```



---

archive/issue_events_060907.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-20T22:22:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
    "label_color": "0000ff",
    "label_name": "component: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60907"
}
```



---

archive/issue_events_060908.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-20T22:22:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60908"
}
```



---

archive/issue_events_060909.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-20T22:22:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60909"
}
```



---

archive/issue_events_060910.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-20T22:22:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60910"
}
```



---

archive/issue_events_060911.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2009-04-21T09:13:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60911"
}
```



---

archive/issue_comments_038695.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nAttachment: **[fix-mp-libsingular-dealloc.patch.gz](https://github.com/sagemath/sage/files/ticket5839/fix-mp-libsingular-dealloc.patch.gz)**\n\nDoctests pass, patch reads good.",
    "created_at": "2009-04-21T09:13:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38695",
    "user": "https://github.com/malb"
}
```

<a id='comment:1'>Comment 1:</a>
Attachment: **[fix-mp-libsingular-dealloc.patch.gz](https://github.com/sagemath/sage/files/ticket5839/fix-mp-libsingular-dealloc.patch.gz)**

Doctests pass, patch reads good.



---

archive/issue_events_060912.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-21T22:37:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "milestone_number": null,
    "milestone_title": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60912"
}
```



---

archive/issue_events_060913.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-21T22:37:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "milestone_number": null,
    "milestone_title": "sage-3.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60913"
}
```



---

archive/issue_comments_038696.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nMerged in Sage 3.4.2.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T07:27:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38696",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:3'>Comment 3:</a>
Merged in Sage 3.4.2.alpha0.

Cheers,

Michael



---

archive/issue_events_060914.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T07:27:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60914"
}
```



---

archive/issue_events_060915.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T07:27:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60915"
}
```



---

archive/issue_comments_038697.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nMmmh, I seem to be seeing random doctest failure with 3.4.1 + only this patch merged, so I am reopening this ticket for now. Can someone do extensive testing on sage.math to see if they can reproduce it?\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T07:47:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38697",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:4'>Comment 4:</a>
Mmmh, I seem to be seeing random doctest failure with 3.4.1 + only this patch merged, so I am reopening this ticket for now. Can someone do extensive testing on sage.math to see if they can reproduce it?

Cheers,

Michael



---

archive/issue_comments_038698.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nOk, given that this causes issues for me I am changing it to 'needs work' for now.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T18:35:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38698",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:5'>Comment 5:</a>
Ok, given that this causes issues for me I am changing it to 'needs work' for now.

Cheers,

Michael



---

archive/issue_events_060916.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T18:35:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60916"
}
```



---

archive/issue_comments_038699.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nWhat sort of errors?  (Crashes?  Wrong answers?  Any particular files?)",
    "created_at": "2009-04-22T19:13:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38699",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<a id='comment:7'>Comment 7:</a>
What sort of errors?  (Crashes?  Wrong answers?  Any particular files?)



---

archive/issue_comments_038700.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI have come to believe that the issues I saw were due to other issues, so I am reinstating the positive review. But I will do some more extensive testing before merging this. Sorry for the noise.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-08T00:49:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38700",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:8'>Comment 8:</a>
I have come to believe that the issues I saw were due to other issues, so I am reinstating the positive review. But I will do some more extensive testing before merging this. Sorry for the noise.

Cheers,

Michael



---

archive/issue_events_060917.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-08T00:49:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60917"
}
```



---

archive/issue_events_060918.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-08T00:49:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60918"
}
```



---

archive/issue_comments_038701.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nMerged in Sage 4.0.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-14T05:16:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5839#issuecomment-38701",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:9'>Comment 9:</a>
Merged in Sage 4.0.alpha0.

Cheers,

Michael



---

archive/issue_events_060919.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "milestone_number": null,
    "milestone_title": "sage-4.0.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60919"
}
```



---

archive/issue_events_060920.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "milestone_number": null,
    "milestone_title": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60920"
}
```



---

archive/issue_events_060921.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60921"
}
```



---

archive/issue_events_060922.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5839",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5839#event-60922"
}
```
