# Issue 5839: MPolynomialRing_libsingular __dealloc__ is buggy, can lead to crash

archive/issues_005839.json:
```json
{
    "body": "In `__dealloc__`, if currRing is NULL on entry, then currRing will be the ring we just deleted on exit.  The patch fixes this bug, so that currRing never points to freed memory.\n\nIt took me quite a while to come up with a small reproducible test case for the problem; here it is.  (This test case is also in the patch, as a doctest.)\n\n```\nimport gc\nfrom sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular\nR1 = MPolynomialRing_libsingular(GF(5), 2, ('x', 'y'), TermOrder('degrevlex', 2))\nR2 = MPolynomialRing_libsingular(GF(11), 2, ('x', 'y'), TermOrder('degrevlex', 2))\nR3 = MPolynomialRing_libsingular(GF(13), 2, ('x', 'y'), TermOrder('degrevlex', 2))\ngc.collect()\nfoo = R1.gen(0)\ndel foo\ndel R1\ngc.collect()\ndel R2\ngc.collect()\ndel R3\ngc.collect()\n```\n\n\nAssignee: cwitty\n\nCC:  @malb\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/5839\n\n",
    "closed_at": "2009-05-14T05:16:49Z",
    "created_at": "2009-04-20T22:22:09Z",
    "labels": [
        "component: commutative algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.0",
    "title": "MPolynomialRing_libsingular __dealloc__ is buggy, can lead to crash",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5839",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```
In `__dealloc__`, if currRing is NULL on entry, then currRing will be the ring we just deleted on exit.  The patch fixes this bug, so that currRing never points to freed memory.

It took me quite a while to come up with a small reproducible test case for the problem; here it is.  (This test case is also in the patch, as a doctest.)

```
import gc
from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular
R1 = MPolynomialRing_libsingular(GF(5), 2, ('x', 'y'), TermOrder('degrevlex', 2))
R2 = MPolynomialRing_libsingular(GF(11), 2, ('x', 'y'), TermOrder('degrevlex', 2))
R3 = MPolynomialRing_libsingular(GF(13), 2, ('x', 'y'), TermOrder('degrevlex', 2))
gc.collect()
foo = R1.gen(0)
del foo
del R1
gc.collect()
del R2
gc.collect()
del R3
gc.collect()
```


Assignee: cwitty

CC:  @malb

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/5839





---

archive/issue_comments_055420.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-04-21T09:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55420",
    "user": "https://github.com/malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_055421.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [fix-mp-libsingular-dealloc.patch](tarball://root/attachments/some-uuid/ticket5839/fix-mp-libsingular-dealloc.patch) by @malb created at 2009-04-21 09:13:14\n\nDoctests pass, patch reads good.",
    "created_at": "2009-04-21T09:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55421",
    "user": "https://github.com/malb"
}
```

<a id='comment:1'></a>
Attachment [fix-mp-libsingular-dealloc.patch](tarball://root/attachments/some-uuid/ticket5839/fix-mp-libsingular-dealloc.patch) by @malb created at 2009-04-21 09:13:14

Doctests pass, patch reads good.



---

archive/issue_events_017732.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-21T22:37:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "milestone": "sage-3.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5839#event-17732"
}
```



---

archive/issue_comments_055422.json:
```json
{
    "body": "Changing status from positive_review to positive_review.",
    "created_at": "2009-04-22T07:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55422",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing status from positive_review to positive_review.



---

archive/issue_comments_055423.json:
```json
{
    "body": "<a id='comment:3'></a>\nMerged in Sage 3.4.2.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T07:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55423",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:3'></a>
Merged in Sage 3.4.2.alpha0.

Cheers,

Michael



---

archive/issue_comments_055424.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-04-22T07:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55424",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_events_017733.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-22T07:27:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5839#event-17733"
}
```



---

archive/issue_comments_055425.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2009-04-22T07:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55425",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_055426.json:
```json
{
    "body": "<a id='comment:4'></a>\nMmmh, I seem to be seeing random doctest failure with 3.4.1 + only this patch merged, so I am reopening this ticket for now. Can someone do extensive testing on sage.math to see if they can reproduce it?\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T07:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55426",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
Mmmh, I seem to be seeing random doctest failure with 3.4.1 + only this patch merged, so I am reopening this ticket for now. Can someone do extensive testing on sage.math to see if they can reproduce it?

Cheers,

Michael



---

archive/issue_comments_055427.json:
```json
{
    "body": "Changing status from closed to reopened.",
    "created_at": "2009-04-22T07:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55427",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing status from closed to reopened.



---

archive/issue_comments_055428.json:
```json
{
    "body": "<a id='comment:5'></a>\nOk, given that this causes issues for me I am changing it to 'needs work' for now.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T18:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55428",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:5'></a>
Ok, given that this causes issues for me I am changing it to 'needs work' for now.

Cheers,

Michael



---

archive/issue_comments_055429.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2009-04-22T18:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55429",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_055430.json:
```json
{
    "body": "<a id='comment:7'></a>\nWhat sort of errors?  (Crashes?  Wrong answers?  Any particular files?)",
    "created_at": "2009-04-22T19:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55430",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:7'></a>
What sort of errors?  (Crashes?  Wrong answers?  Any particular files?)



---

archive/issue_comments_055431.json:
```json
{
    "body": "<a id='comment:8'></a>\nI have come to believe that the issues I saw were due to other issues, so I am reinstating the positive review. But I will do some more extensive testing before merging this. Sorry for the noise.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-08T00:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55431",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
I have come to believe that the issues I saw were due to other issues, so I am reinstating the positive review. But I will do some more extensive testing before merging this. Sorry for the noise.

Cheers,

Michael



---

archive/issue_comments_055432.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2009-05-08T00:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55432",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_055433.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-05-14T05:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55433",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_055434.json:
```json
{
    "body": "<a id='comment:9'></a>\nMerged in Sage 4.0.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-14T05:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5839#issuecomment-55434",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:9'></a>
Merged in Sage 4.0.alpha0.

Cheers,

Michael



---

archive/issue_events_017734.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "milestone": "sage-3.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5839#event-17734"
}
```



---

archive/issue_events_017735.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "milestone": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5839#event-17735"
}
```



---

archive/issue_events_017736.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-14T05:16:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5839",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5839#event-17736"
}
```
