# Issue 5673: [with new patch] Enhanced handling of elliptic curve twists

archive/issues_005673.json:
```json
{
    "body": "The patch does the following related things:\n\n1. Implements in ell_generic functions is_quadratic_twist(), is_quartic_twist(), is_sextic_twist(), which detect twists between curves (returning the appropriate twisting paramenter)\n2. Deprecates the EllipticCurve(j) constructor, replacing it with EllipticCurve_from_j(j).  Over Q this gives the minimal twist, i.e. a curve with the correct j and minimal conductor.\n3. Rewrites the function minimal_quadratic_twist() introduced in #4667 to use the previous function, with extra work in case j=0, 1728 since we need the minimal __quadratic__ twist, not the minimal twist.\n\nThere is likely to be a necessary change to documentation (pages 38 and 39 of the tutorial) which have not yet been made.\n\nThe patch is based on 3.4.1.alpha0 + patches at #4667.\nI have tested all files in sage/schemes/elliptic_curves.  There are two failures in sha_tate which I do not understand, so I am posting the patch anyway.\n\n\nAssignee: @williamstein\n\nCC:  @categorie\n\nKeywords: elliptic curve twist\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/5673\n\n",
    "closed_at": "2009-04-16T12:06:09Z",
    "created_at": "2009-04-03T11:07:49Z",
    "labels": [
        "component: number theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.4.1",
    "title": "[with new patch] Enhanced handling of elliptic curve twists",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5673",
    "user": "https://github.com/JohnCremona"
}
```
The patch does the following related things:

1. Implements in ell_generic functions is_quadratic_twist(), is_quartic_twist(), is_sextic_twist(), which detect twists between curves (returning the appropriate twisting paramenter)
2. Deprecates the EllipticCurve(j) constructor, replacing it with EllipticCurve_from_j(j).  Over Q this gives the minimal twist, i.e. a curve with the correct j and minimal conductor.
3. Rewrites the function minimal_quadratic_twist() introduced in #4667 to use the previous function, with extra work in case j=0, 1728 since we need the minimal __quadratic__ twist, not the minimal twist.

There is likely to be a necessary change to documentation (pages 38 and 39 of the tutorial) which have not yet been made.

The patch is based on 3.4.1.alpha0 + patches at #4667.
I have tested all files in sage/schemes/elliptic_curves.  There are two failures in sha_tate which I do not understand, so I am posting the patch anyway.


Assignee: @williamstein

CC:  @categorie

Keywords: elliptic curve twist

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/5673





---

archive/issue_comments_053357.json:
```json
{
    "body": "Attachment [twist.patch](tarball://root/attachments/some-uuid/ticket5673/twist.patch) by @JohnCremona created at 2009-04-03 11:08:27\n\napply to 3.4.1.alpha0 + #4667 patches",
    "created_at": "2009-04-03T11:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53357",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [twist.patch](tarball://root/attachments/some-uuid/ticket5673/twist.patch) by @JohnCremona created at 2009-04-03 11:08:27

apply to 3.4.1.alpha0 + #4667 patches



---

archive/issue_comments_053358.json:
```json
{
    "body": "Attachment [5673-j-keyword.patch](tarball://root/attachments/some-uuid/ticket5673/5673-j-keyword.patch) by @robertwb created at 2009-04-03 22:48:37\n\napply after last patch",
    "created_at": "2009-04-03T22:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53358",
    "user": "https://github.com/robertwb"
}
```

Attachment [5673-j-keyword.patch](tarball://root/attachments/some-uuid/ticket5673/5673-j-keyword.patch) by @robertwb created at 2009-04-03 22:48:37

apply after last patch



---

archive/issue_comments_053359.json:
```json
{
    "body": "Attachment [5673-j-keyword.2.patch](tarball://root/attachments/some-uuid/ticket5673/5673-j-keyword.2.patch) by @JohnCremona created at 2009-04-06 10:41:30\n\nreplaces previous (fixes typo)",
    "created_at": "2009-04-06T10:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53359",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [5673-j-keyword.2.patch](tarball://root/attachments/some-uuid/ticket5673/5673-j-keyword.2.patch) by @JohnCremona created at 2009-04-06 10:41:30

replaces previous (fixes typo)



---

archive/issue_comments_053360.json:
```json
{
    "body": "<a id='comment:1'></a>\nrobertwb,  Thanks for your patch (which needs a typo fixing: change 3 to 2 in line 113 or the test does not pass! -- I have attached a fixed patch).  I am happy to give your patch a positive review, but did you review mine?",
    "created_at": "2009-04-06T10:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53360",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
robertwb,  Thanks for your patch (which needs a typo fixing: change 3 to 2 in line 113 or the test does not pass! -- I have attached a fixed patch).  I am happy to give your patch a positive review, but did you review mine?



---

archive/issue_comments_053361.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt looks good (and works) for me.",
    "created_at": "2009-04-12T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53361",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:2'></a>
It looks good (and works) for me.



---

archive/issue_comments_053362.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-04-12T09:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53362",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_053363.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe only suggestion I have is that it might be better to return `False` rather than `0` for non-twists.",
    "created_at": "2009-04-12T09:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53363",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:3'></a>
The only suggestion I have is that it might be better to return `False` rather than `0` for non-twists.



---

archive/issue_comments_053364.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [robertwb](#comment%3A3):\n> The only suggestion I have is that it might be better to return `False` rather than `0` for non-twists. \n\n\nI did that since I wanted the return type to be the same whatever.  But that stopped me doing the right thing in char. 2 when twists are additive (so a twist parameter of 0 means isomorphic).\n\nIt's the usual thing:  ideally I would want to return either (True, param) or False, but that is not allowed in Sage.  We could go for a more complicated function which by default just returns True/False, or if an optional parameter \"return_parameter\" is set to True returns a tuple either (True, param) or (False,).\n\nOne advantage of the current setup is that if you do not need the parameter you can use the output as if it were a bool with 0 converting to False.  I think.",
    "created_at": "2009-04-12T09:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53364",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>
Replying to [robertwb](#comment%3A3):
> The only suggestion I have is that it might be better to return `False` rather than `0` for non-twists. 


I did that since I wanted the return type to be the same whatever.  But that stopped me doing the right thing in char. 2 when twists are additive (so a twist parameter of 0 means isomorphic).

It's the usual thing:  ideally I would want to return either (True, param) or False, but that is not allowed in Sage.  We could go for a more complicated function which by default just returns True/False, or if an optional parameter "return_parameter" is set to True returns a tuple either (True, param) or (False,).

One advantage of the current setup is that if you do not need the parameter you can use the output as if it were a bool with 0 converting to False.  I think.



---

archive/issue_comments_053365.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [cremona](#comment%3A4):\n> \n> I did that since I wanted the return type to be the same whatever.  But that stopped me doing the right thing in char. 2 when twists are additive (so a twist parameter of 0 means isomorphic).\n> \n> It's the usual thing:  ideally I would want to return either (True, param) or False, but that is not allowed in Sage.  We could go for a more complicated function which by default just returns True/False, or if an optional parameter \"return_parameter\" is set to True returns a tuple either (True, param) or (False,).\n\n\nOne could do this, but then it gets really messy to use. \n \n> One advantage of the current setup is that if you do not need the parameter you can use the output as if it were a bool with 0 converting to False.  I think.\n\n\nYes, that will work. Actually, I think the most Pythonic thing to do here would perhaps be to return None, but I think the current behavior is fine as well.",
    "created_at": "2009-04-12T10:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53365",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:5'></a>
Replying to [cremona](#comment%3A4):
> 
> I did that since I wanted the return type to be the same whatever.  But that stopped me doing the right thing in char. 2 when twists are additive (so a twist parameter of 0 means isomorphic).
> 
> It's the usual thing:  ideally I would want to return either (True, param) or False, but that is not allowed in Sage.  We could go for a more complicated function which by default just returns True/False, or if an optional parameter "return_parameter" is set to True returns a tuple either (True, param) or (False,).


One could do this, but then it gets really messy to use. 
 
> One advantage of the current setup is that if you do not need the parameter you can use the output as if it were a bool with 0 converting to False.  I think.


Yes, that will work. Actually, I think the most Pythonic thing to do here would perhaps be to return None, but I think the current behavior is fine as well.



---

archive/issue_comments_053366.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2009-04-13T07:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53366",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_053367.json:
```json
{
    "body": "<a id='comment:6'></a>\nUnfortunately there are a few doctest failures in \n\n```\nsage -t -long devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 1 doctests failed\nsage -t -long devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 2 doctests failed\nsage -t -long devel/sage/doc/en/tutorial/tour_advanced.rst # 2 doctests failed\nsage -t -long devel/sage/doc/fr/tutorial/tour_advanced.rst # 2 doctests failed\n```\nOne issue here is certainly that **make check** does not doctest the ReST documentation - see #5702 for the ticket for that problem which I intend to fix before 3.4.1 is done. \n\nTo test **everything** run \n\n```\nsage -tp 1 devel/sage\n```\nwhich is what I use :)\n\nCheers,\n\nMichael",
    "created_at": "2009-04-13T07:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53367",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
Unfortunately there are a few doctest failures in 

```
sage -t -long devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 1 doctests failed
sage -t -long devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 2 doctests failed
sage -t -long devel/sage/doc/en/tutorial/tour_advanced.rst # 2 doctests failed
sage -t -long devel/sage/doc/fr/tutorial/tour_advanced.rst # 2 doctests failed
```
One issue here is certainly that **make check** does not doctest the ReST documentation - see #5702 for the ticket for that problem which I intend to fix before 3.4.1 is done. 

To test **everything** run 

```
sage -tp 1 devel/sage
```
which is what I use :)

Cheers,

Michael



---

archive/issue_comments_053368.json:
```json
{
    "body": "<a id='comment:7'></a>\nI am about to start fixing the rst failures which should not take long.\n\nNB the sha_tate failures were there when I posted this, and (via a message to sage-nt) I had hoped that Chris Wuthrich might have helped track that down.  I'll have a go myself now anyway.",
    "created_at": "2009-04-13T16:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53368",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>
I am about to start fixing the rst failures which should not take long.

NB the sha_tate failures were there when I posted this, and (via a message to sage-nt) I had hoped that Chris Wuthrich might have helped track that down.  I'll have a go myself now anyway.



---

archive/issue_comments_053369.json:
```json
{
    "body": "Apply after previous:  fixes rst doc failures in tutorial etc.",
    "created_at": "2009-04-13T17:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53369",
    "user": "https://github.com/JohnCremona"
}
```

Apply after previous:  fixes rst doc failures in tutorial etc.



---

archive/issue_comments_053370.json:
```json
{
    "body": "<a id='comment:8'></a>\nAttachment [trac_5763_rst.patch](tarball://root/attachments/some-uuid/ticket5673/trac_5763_rst.patch) by @JohnCremona created at 2009-04-13 17:20:05\n\nPatch trac_5763_rst.patch fixes the rst failures.  Now for sha_tate....",
    "created_at": "2009-04-13T17:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53370",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>
Attachment [trac_5763_rst.patch](tarball://root/attachments/some-uuid/ticket5673/trac_5763_rst.patch) by @JohnCremona created at 2009-04-13 17:20:05

Patch trac_5763_rst.patch fixes the rst failures.  Now for sha_tate....



---

archive/issue_comments_053371.json:
```json
{
    "body": "Apply after previous (fixes sha_tate doctest failure)",
    "created_at": "2009-04-13T17:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53371",
    "user": "https://github.com/JohnCremona"
}
```

Apply after previous (fixes sha_tate doctest failure)



---

archive/issue_comments_053372.json:
```json
{
    "body": "<a id='comment:9'></a>\nAttachment [trac_5673_review.patch](tarball://root/attachments/some-uuid/ticket5673/trac_5673_review.patch) by @JohnCremona created at 2009-04-13 18:01:11\n\nOK, the problem was that Chris's original minimal_quadratic_twist() function gave back the same curve it it already had minimal conductor, while mine did not, since my function takes the curve with smallest label.  But the padic code could not cope with a non-trivial twist of the same conductor!  (The bad example was '300b2' for which \"my\" minimal twist is '300a2' which is its 5-twist.)\n\nSolution:  if the minimal twist has the same conductor,  I just throw it away and use the original curve, as Chris's code used to do.\n\nThe patch trac_5673_review.patch fixes this.\n\nSorry I made two separate patches to fix the failures -- I was not sure I would succeed with both problems.",
    "created_at": "2009-04-13T18:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53372",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
Attachment [trac_5673_review.patch](tarball://root/attachments/some-uuid/ticket5673/trac_5673_review.patch) by @JohnCremona created at 2009-04-13 18:01:11

OK, the problem was that Chris's original minimal_quadratic_twist() function gave back the same curve it it already had minimal conductor, while mine did not, since my function takes the curve with smallest label.  But the padic code could not cope with a non-trivial twist of the same conductor!  (The bad example was '300b2' for which "my" minimal twist is '300a2' which is its 5-twist.)

Solution:  if the minimal twist has the same conductor,  I just throw it away and use the original curve, as Chris's code used to do.

The patch trac_5673_review.patch fixes this.

Sorry I made two separate patches to fix the failures -- I was not sure I would succeed with both problems.



---

archive/issue_events_017241.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "rename": {
        "from": "Enhanced handling of elliptic curve twists",
        "to": "[with new patch] Enhanced handling of elliptic curve twists"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5673#event-17241"
}
```



---

archive/issue_comments_053373.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2009-04-13T19:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53373",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_053374.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-04-15T08:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53374",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_053375.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks good to me.",
    "created_at": "2009-04-15T08:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53375",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:11'></a>
Looks good to me.



---

archive/issue_events_017242.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-16T12:06:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5673#event-17242"
}
```



---

archive/issue_comments_053376.json:
```json
{
    "body": "<a id='comment:12'></a>\nMerged \n\n* trac_5673_part_1_twist.patch\n* trac_5673_part_2-j-keyword.2.patch\n* trac_5673_part_3_rst.patch\n* trac_5673_part_4_review.patch\n\nin Sage 3.4.1.rc3.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-16T12:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53376",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Merged 

* trac_5673_part_1_twist.patch
* trac_5673_part_2-j-keyword.2.patch
* trac_5673_part_3_rst.patch
* trac_5673_part_4_review.patch

in Sage 3.4.1.rc3.

Cheers,

Michael



---

archive/issue_comments_053377.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-04-16T12:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5673#issuecomment-53377",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_events_017243.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-16T12:06:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5673",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5673#event-17243"
}
```
