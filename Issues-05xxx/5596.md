# Issue 5596: refactor coercion to catch fewer exceptions

archive/issues_005596.json:
```json
{
    "body": "See discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/d2145cd313f92bb8/c3049a540f91bab3?hl=en&lnk=gst&q=coercion#c3049a540f91bab3\n\nAssignee: @robertwb\n\nCC:  @nthiery georgsweber\n\nResolution: fixed\n\nAuthor: Robert Bradshaw\n\nReviewer: Nicolas M. Thi\u00e9ry, Mike Hansen\n\nMerged: sage-4.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/5596\n\n",
    "closed_at": "2009-10-21T05:22:32Z",
    "created_at": "2009-03-24T05:06:32Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.2",
    "title": "refactor coercion to catch fewer exceptions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5596",
    "user": "https://github.com/robertwb"
}
```
See discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/d2145cd313f92bb8/c3049a540f91bab3?hl=en&lnk=gst&q=coercion#c3049a540f91bab3

Assignee: @robertwb

CC:  @nthiery georgsweber

Resolution: fixed

Author: Robert Bradshaw

Reviewer: Nicolas M. Thiéry, Mike Hansen

Merged: sage-4.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/5596





---

archive/issue_events_017034.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber",
    "created_at": "2009-03-24T21:03:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5596#event-17034"
}
```



---

archive/issue_comments_052281.json:
```json
{
    "body": "<a id='comment:2'></a>\nNope, for me the patch failed to apply against Sage 3.4:\n\n```\nsage: hg_sage.apply(\"/home/mvngu/patch/5596/5596-coerce-exceptions.patch\")\ncd \"/home/mvngu/scratch/sage-3.4/devel/sage\" && hg status\ncd \"/home/mvngu/scratch/sage-3.4/devel/sage\" && hg status\ncd \"/home/mvngu/scratch/sage-3.4/devel/sage\" && hg import   \"/home/mvngu/patch/5596/5596-coerce-exceptions.patch\"\napplying /home/mvngu/patch/5596/5596-coerce-exceptions.patch\nabort: malformed patch a/sage/structure/parent_old.pyx @@ -602,39 +496,4 @@\n```",
    "created_at": "2009-03-27T06:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52281",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:2'></a>
Nope, for me the patch failed to apply against Sage 3.4:

```
sage: hg_sage.apply("/home/mvngu/patch/5596/5596-coerce-exceptions.patch")
cd "/home/mvngu/scratch/sage-3.4/devel/sage" && hg status
cd "/home/mvngu/scratch/sage-3.4/devel/sage" && hg status
cd "/home/mvngu/scratch/sage-3.4/devel/sage" && hg import   "/home/mvngu/patch/5596/5596-coerce-exceptions.patch"
applying /home/mvngu/patch/5596/5596-coerce-exceptions.patch
abort: malformed patch a/sage/structure/parent_old.pyx @@ -602,39 +496,4 @@
```



---

archive/issue_comments_052282.json:
```json
{
    "body": "<a id='comment:3'></a>\nAgainst 3.4.1.alpha0, the situation gets even worse:\n\n```\napplying ../../../patches/5596-coerce-exceptions.patch\npatching file sage/rings/infinity.py\nHunk #1 FAILED at 87\nHunk #2 FAILED at 100\n2 out of 2 hunks FAILED -- saving rejects to file sage/rings/infinity.py.rej\nabort: malformed patch a/sage/structure/parent_old.pyx @@ -602,39 +496,4 @@\n\n```\nThe content of infinity.py.rej is essentially that now there are \"ValueErrors\" instead of \"TypeErrors\" to be exchanged.\n\nI don't know where the \"malformed-ness\" already noticed by Minh comes from, but it hits me also from the command line (using the hg from Sage-3.4.1.alpha0).",
    "created_at": "2009-03-30T20:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52282",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

<a id='comment:3'></a>
Against 3.4.1.alpha0, the situation gets even worse:

```
applying ../../../patches/5596-coerce-exceptions.patch
patching file sage/rings/infinity.py
Hunk #1 FAILED at 87
Hunk #2 FAILED at 100
2 out of 2 hunks FAILED -- saving rejects to file sage/rings/infinity.py.rej
abort: malformed patch a/sage/structure/parent_old.pyx @@ -602,39 +496,4 @@

```
The content of infinity.py.rej is essentially that now there are "ValueErrors" instead of "TypeErrors" to be exchanged.

I don't know where the "malformed-ness" already noticed by Minh comes from, but it hits me also from the command line (using the hg from Sage-3.4.1.alpha0).



---

archive/issue_comments_052283.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2009-03-30T20:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52283",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_052284.json:
```json
{
    "body": "<a id='comment:4'></a>\nOK, I'll try and rebase these for 3.4.2",
    "created_at": "2009-04-25T07:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52284",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:4'></a>
OK, I'll try and rebase these for 3.4.2



---

archive/issue_comments_052285.json:
```json
{
    "body": "Attachment [5596-coerce-exceptions-new.patch](tarball://root/attachments/some-uuid/ticket5596/5596-coerce-exceptions-new.patch) by @robertwb created at 2009-09-24 04:25:51\n\nRebased against 4.1.1",
    "created_at": "2009-09-24T04:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52285",
    "user": "https://github.com/robertwb"
}
```

Attachment [5596-coerce-exceptions-new.patch](tarball://root/attachments/some-uuid/ticket5596/5596-coerce-exceptions-new.patch) by @robertwb created at 2009-09-24 04:25:51

Rebased against 4.1.1



---

archive/issue_comments_052286.json:
```json
{
    "body": "<a id='comment:5'></a>\nOK, I finally got around to rebasing this. Don't know what the \"malformed-ness\" was either, but it's gone.",
    "created_at": "2009-09-24T04:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52286",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:5'></a>
OK, I finally got around to rebasing this. Don't know what the "malformed-ness" was either, but it's gone.



---

archive/issue_comments_052287.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2009-09-24T04:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52287",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_052288.json:
```json
{
    "body": "<a id='comment:6'></a>\nThanks for working on this. This will be a big step forward in debuggability or coercion problems!\nIn particular, reducing the amount of poking around \"let's try if this method does not break horribly on this element\" is\ndefinitely going in the right direction. \n\nI just went through the patch, and each change sounds sensible. I haven't checked that they are 100% correct, by lack of expertise.\nIn particular, I haven't checked line by line the big chunks of diffs corresponding to indentation changes (inclusion in a try).\n\nOverall, +1 for setting positive review, but I would prefer if some expert could double check.\n\nI am now on my way to run the tests, and see how this patch interact with the category patches.\n\n\nOne comment:\n\nIn Sage-Combinat, we often have operations which are partially defined, and return None when they are not. How does this fit with the\nchange in the specifications of _mul_ and friends, suggesting to return None rather than raising NotImplemented?\n\nShould \"Returning None indicates that this action is not implemented\" be replaced by something like:\n\n\"Returning None indicates that this action is not defined, or not implemented here, for the given elements\"?\n\nAlternatively, I could possibly suggest to instead check that self._lmul (say) is\nnot the default \"NotImplemented\" implementation of Element, before actually calling it. I guess I am trying to have an analogue of\nthe abstract_method idiom for cpdef methods. Would it be possible to attach some sort of \"abstract method\" flag to a cpdef method,\nthat we could test without actually having to execute the method?\n\nBut I don't mind if this waits for a later patch.",
    "created_at": "2009-09-24T09:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52288",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Thanks for working on this. This will be a big step forward in debuggability or coercion problems!
In particular, reducing the amount of poking around "let's try if this method does not break horribly on this element" is
definitely going in the right direction. 

I just went through the patch, and each change sounds sensible. I haven't checked that they are 100% correct, by lack of expertise.
In particular, I haven't checked line by line the big chunks of diffs corresponding to indentation changes (inclusion in a try).

Overall, +1 for setting positive review, but I would prefer if some expert could double check.

I am now on my way to run the tests, and see how this patch interact with the category patches.


One comment:

In Sage-Combinat, we often have operations which are partially defined, and return None when they are not. How does this fit with the
change in the specifications of _mul_ and friends, suggesting to return None rather than raising NotImplemented?

Should "Returning None indicates that this action is not implemented" be replaced by something like:

"Returning None indicates that this action is not defined, or not implemented here, for the given elements"?

Alternatively, I could possibly suggest to instead check that self._lmul (say) is
not the default "NotImplemented" implementation of Element, before actually calling it. I guess I am trying to have an analogue of
the abstract_method idiom for cpdef methods. Would it be possible to attach some sort of "abstract method" flag to a cpdef method,
that we could test without actually having to execute the method?

But I don't mind if this waits for a later patch.



---

archive/issue_comments_052289.json:
```json
{
    "body": "<a id='comment:7'></a>\nSorry, but\n\n> Overall, +1 for setting positive review, but I would prefer if some expert could double check.\n\n\nalthough it is always a good thing to have \"some expert\" double checking a patch.\nBut who else, but you two, could you think of for reviewing this specific patch?\n\nIf you could point out to me certain \"suspicious\" lines, I would be happy to look at these, and listen to your explanations, and learn something from it, but I fear that's all I can do. There are damn few experts around for programming \"code doing coercions\" ...\n\nCheers,\nGeorg",
    "created_at": "2009-09-24T22:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52289",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

<a id='comment:7'></a>
Sorry, but

> Overall, +1 for setting positive review, but I would prefer if some expert could double check.


although it is always a good thing to have "some expert" double checking a patch.
But who else, but you two, could you think of for reviewing this specific patch?

If you could point out to me certain "suspicious" lines, I would be happy to look at these, and listen to your explanations, and learn something from it, but I fear that's all I can do. There are damn few experts around for programming "code doing coercions" ...

Cheers,
Georg



---

archive/issue_comments_052290.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [nthiery](#comment%3A6):\n\n> I just went through the patch, and each change sounds sensible. I haven't checked that they are 100% correct, by lack of expertise.\n> In particular, I haven't checked line by line the big chunks of diffs corresponding to indentation changes (inclusion in a try).\n> \n> Overall, +1 for setting positive review, but I would prefer if some expert could double check.\n\n\nI'll second Georg's comments, you are as much of an \"expert\" in this area as nearly anyone else (except maybe me, but I can't review it myself...). \n\n> I am now on my way to run the tests, and see how this patch interact with the category patches.\n\n\nI saw some tests failing--looks like easy fixes, I'll try and post a patch later tonight. \n\n> One comment:\n> \n> In Sage-Combinat, we often have operations which are partially defined, and return None when they are not. How does this fit with the\n> change in the specifications of _mul_ and friends, suggesting to return None rather than raising NotImplemented?\n> \n> Should \"Returning None indicates that this action is not implemented\" be replaced by something like:\n> \n> \"Returning None indicates that this action is not defined, or not implemented here, for the given elements\"?\n\n\nI'll change that to say \"not implemented here.\"\n\n> Alternatively, I could possibly suggest to instead check that self._lmul (say) is\n> not the default \"NotImplemented\" implementation of Element, before actually calling it. I guess I am trying to have an analogue of\n> the abstract_method idiom for cpdef methods. Would it be possible to attach some sort of \"abstract method\" flag to a cpdef method,\n> that we could test without actually having to execute the method?\n\n\nThis can be done, kind of, if one knows the baseclass where the \"abstract\" method is implemented, though it's a bit hackish. I think you underestimate how fast calling a c(p)def method can be though. \n\n> But I don't mind if this waits for a later patch.\n\n\nYeah, that'd take some thinking, probably best put off 'till later.",
    "created_at": "2009-09-24T23:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52290",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:8'></a>
Replying to [nthiery](#comment%3A6):

> I just went through the patch, and each change sounds sensible. I haven't checked that they are 100% correct, by lack of expertise.
> In particular, I haven't checked line by line the big chunks of diffs corresponding to indentation changes (inclusion in a try).
> 
> Overall, +1 for setting positive review, but I would prefer if some expert could double check.


I'll second Georg's comments, you are as much of an "expert" in this area as nearly anyone else (except maybe me, but I can't review it myself...). 

> I am now on my way to run the tests, and see how this patch interact with the category patches.


I saw some tests failing--looks like easy fixes, I'll try and post a patch later tonight. 

> One comment:
> 
> In Sage-Combinat, we often have operations which are partially defined, and return None when they are not. How does this fit with the
> change in the specifications of _mul_ and friends, suggesting to return None rather than raising NotImplemented?
> 
> Should "Returning None indicates that this action is not implemented" be replaced by something like:
> 
> "Returning None indicates that this action is not defined, or not implemented here, for the given elements"?


I'll change that to say "not implemented here."

> Alternatively, I could possibly suggest to instead check that self._lmul (say) is
> not the default "NotImplemented" implementation of Element, before actually calling it. I guess I am trying to have an analogue of
> the abstract_method idiom for cpdef methods. Would it be possible to attach some sort of "abstract method" flag to a cpdef method,
> that we could test without actually having to execute the method?


This can be done, kind of, if one knows the baseclass where the "abstract" method is implemented, though it's a bit hackish. I think you underestimate how fast calling a c(p)def method can be though. 

> But I don't mind if this waits for a later patch.


Yeah, that'd take some thinking, probably best put off 'till later.



---

archive/issue_comments_052291.json:
```json
{
    "body": "<a id='comment:9'></a>\nOK, all doctests should pass now.",
    "created_at": "2009-09-25T08:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52291",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:9'></a>
OK, all doctests should pass now.



---

archive/issue_comments_052292.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-09-30T11:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52292",
    "user": "https://github.com/nthiery"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_052293.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [robertwb](#comment%3A8):\n> Replying to [nthiery](#comment%3A6):\n> I'll second Georg's comments, you are as much of an \"expert\" in this area as nearly anyone else (except maybe me, but I can't review it myself...). \n\n\nFair enough :-)\n\n> > I am now on my way to run the tests, and see how this patch interact with the category patches.\n\n> \n> I saw some tests failing--looks like easy fixes, I'll try and post a patch later tonight. \n\n\nArgl. I am always off by one version. I now have to compile a 4.1.2 alpha4\n\n> > Alternatively, I could possibly suggest to instead check that self._lmul (say) is\n> > not the default \"NotImplemented\" implementation of Element, before actually calling it. I guess I am trying to have an analogue of\n> > the abstract_method idiom for cpdef methods. Would it be possible to attach some sort of \"abstract method\" flag to a cpdef method,\n> > that we could test without actually having to execute the method?\n\n> \n> This can be done, kind of, if one knows the baseclass where the \"abstract\" method is implemented, though it's a bit hackish. I think you underestimate how fast calling a c(p)def method can be though. \n\n\nOh, thanks for pointing this.\n\nNo, I am not worried at all about speed, but about semantic and lazyness. Let's say we are investigating whether there is an action of A on B. That's (mostly) a mathematical question about the parents A and B. So it's preferable to \"ask them\", rather than poking around with some of their elements (which could have some special property). Part of it comes from experience with MuPAD telling that lot of trouble can be avoided if a parent does not construct any element unless asked for explicitly; in particular, lazyness helps handling cross-dependent parents. At the same time, a coercion lookup may involve many intermediate parents which will, or not, play a role in the end.\n\nNow: what do I mean by \"ask them\". That can be using introspection, possibly on their element class. Preferably, it would be by having A and B (or some common boss) declare explicitly the action\nto the coercion system. I actually have in my stack of todo's a preliminary implementation of this, as this is needed for symmetric functions and friends.\n\nHmm, that discussion is becoming long. We should move it to sage-devel.\n\n> Yeah, that'd take some thinking, probably best put off 'till later. \n\n\nOk. So I put a positive review, pending confirmation that all tests pass smoothly on 4.1.2 alpha4.\n.",
    "created_at": "2009-09-30T11:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52293",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:10'></a>
Replying to [robertwb](#comment%3A8):
> Replying to [nthiery](#comment%3A6):
> I'll second Georg's comments, you are as much of an "expert" in this area as nearly anyone else (except maybe me, but I can't review it myself...). 


Fair enough :-)

> > I am now on my way to run the tests, and see how this patch interact with the category patches.

> 
> I saw some tests failing--looks like easy fixes, I'll try and post a patch later tonight. 


Argl. I am always off by one version. I now have to compile a 4.1.2 alpha4

> > Alternatively, I could possibly suggest to instead check that self._lmul (say) is
> > not the default "NotImplemented" implementation of Element, before actually calling it. I guess I am trying to have an analogue of
> > the abstract_method idiom for cpdef methods. Would it be possible to attach some sort of "abstract method" flag to a cpdef method,
> > that we could test without actually having to execute the method?

> 
> This can be done, kind of, if one knows the baseclass where the "abstract" method is implemented, though it's a bit hackish. I think you underestimate how fast calling a c(p)def method can be though. 


Oh, thanks for pointing this.

No, I am not worried at all about speed, but about semantic and lazyness. Let's say we are investigating whether there is an action of A on B. That's (mostly) a mathematical question about the parents A and B. So it's preferable to "ask them", rather than poking around with some of their elements (which could have some special property). Part of it comes from experience with MuPAD telling that lot of trouble can be avoided if a parent does not construct any element unless asked for explicitly; in particular, lazyness helps handling cross-dependent parents. At the same time, a coercion lookup may involve many intermediate parents which will, or not, play a role in the end.

Now: what do I mean by "ask them". That can be using introspection, possibly on their element class. Preferably, it would be by having A and B (or some common boss) declare explicitly the action
to the coercion system. I actually have in my stack of todo's a preliminary implementation of this, as this is needed for symmetric functions and friends.

Hmm, that discussion is becoming long. We should move it to sage-devel.

> Yeah, that'd take some thinking, probably best put off 'till later. 


Ok. So I put a positive review, pending confirmation that all tests pass smoothly on 4.1.2 alpha4.
.



---

archive/issue_comments_052294.json:
```json
{
    "body": "<a id='comment:11'></a>\nBTW, there is a `_get_action_` method on Parents themselves. And I *am* worried about speed, or at least the ability to be fast, as this stuff gets invoked for integer arithmetic, etc. :)",
    "created_at": "2009-10-01T07:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52294",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:11'></a>
BTW, there is a `_get_action_` method on Parents themselves. And I *am* worried about speed, or at least the ability to be fast, as this stuff gets invoked for integer arithmetic, etc. :)



---

archive/issue_comments_052295.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [robertwb](#comment%3A11):\n> BTW, there is a `_get_action_` method on Parents themselves.\n\n\nYup.\n\n> And I *am* worried about speed, or at least the ability to be fast, as this stuff gets invoked for integer arithmetic, etc. :)\n\n\nSure:-)\n\n I should have said that my comment about speed was under the assumption that the coercion lookup was cached.",
    "created_at": "2009-10-02T20:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52295",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:12'></a>
Replying to [robertwb](#comment%3A11):
> BTW, there is a `_get_action_` method on Parents themselves.


Yup.

> And I *am* worried about speed, or at least the ability to be fast, as this stuff gets invoked for integer arithmetic, etc. :)


Sure:-)

 I should have said that my comment about speed was under the assumption that the coercion lookup was cached.



---

archive/issue_comments_052296.json:
```json
{
    "body": "<a id='comment:13'></a>\nI get the following failures against 4.1.2:\n\n```\nsage -t  \"devel/sage-main/sage/modules/fg_pid/fgp_module.py\"\n**********************************************************************\nFile \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/devel/sage-main/sage/modules/fg_pid/fgp_module.py\", line 1280:\n    sage: A._hom_from_smith(Sequence([B.0]), B)\nException raised:\n    Traceback (most recent call last):\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_33[7]>\", line 1, in <module>\n        A._hom_from_smith(Sequence([B.gen(0)]), B)###line 1280:\n    sage: A._hom_from_smith(Sequence([B.0]), B)\n      File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1416)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/modules/fg_pid/fgp_morphism.py\", line 131, in _repr_\n        list(self.im_gens()))\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/modules/fg_pid/fgp_morphism.py\", line 149, in im_gens\n        self.__im_gens = tuple([self(x) for x in self.domain().gens()])\n      File \"<doctest __main__.example_32[2]>\", line 3, in gens\n    NameError: global name 'tuple' is not defined\n**********************************************************************\n1 items had failures:\n   1 of   8 in __main__.example_33\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/mhansen/.sage//tmp/.doctest_fgp_module.py\n         [7.6 s]\nexit code: 1024\n\n\nsage -t -long \"devel/sage-main/sage/calculus/wester.py\"     \n**********************************************************************\nFile \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/devel/sage-main/sage/calculus/wester.py\", line 122:\n    sage: bool(f == g)\nException raised:\n    Traceback (most recent call last):\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[36]>\", line 1, in <module>\n        bool(f == g)###line 122:\n    sage: bool(f == g)\n      File \"expression.pyx\", line 1340, in sage.symbolic.expression.Expression.__nonzero__ (sage/symbolic/expression.cpp:7786)\n      File \"expression.pyx\", line 1483, in sage.symbolic.expression.Expression.test_relation (sage/symbolic/expression.cpp:9153)\n      File \"expression.pyx\", line 2807, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:13840)\n      File \"element.pyx\", line 1177, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:9945)\n      File \"coerce.pyx\", line 707, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6096)\n      File \"coerce.pyx\", line 1160, in sage.structure.coerce.CoercionModel_cache_maps.get_action (sage/structure/coerce.c:10589)\n      File \"coerce.pyx\", line 1283, in sage.structure.coerce.CoercionModel_cache_maps.discover_action (sage/structure/coerce.c:11682)\n      File \"parent.pyx\", line 1203, in sage.structure.parent.Parent.get_action (sage/structure/parent.c:10828)\n      File \"parent_old.pyx\", line 478, in sage.structure.parent_old.Parent._get_action_ (sage/structure/parent_old.c:5974)\n      File \"parent_old.pyx\", line 198, in sage.structure.parent_old.Parent.get_action_c (sage/structure/parent_old.c:2757)\n      File \"parent_old.pyx\", line 210, in sage.structure.parent_old.Parent.get_action_impl (sage/structure/parent_old.c:3068)\n      File \"parent_old.pyx\", line 214, in sage.structure.parent_old.Parent.get_action_c_impl (sage/structure/parent_old.c:3118)\n      File \"parent.pyx\", line 1306, in sage.structure.parent.Parent.discover_action (sage/structure/parent.c:12094)\n      File \"coerce_actions.pyx\", line 92, in sage.structure.coerce_actions.ModuleAction.__init__ (sage/structure/coerce_actions.c:3415)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py\", line 692, in pushout\n        return all(Z)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py\", line 64, in __call__\n        R = c(R)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py\", line 406, in __call__\n        return R.completion(self.p, self.prec, self.extras)\n      File \"/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/rings/number_field/number_field.py\", line 1074, in completion\n        return QQ.completion(p, prec, extras).algebraic_closure()\n      File \"ring.pyx\", line 1752, in sage.rings.ring.Field.algebraic_closure (sage/rings/ring.c:9235)\n    NotImplementedError: Algebraic closures of general fields not implemented.\n**********************************************************************\n1 items had failures:\n   1 of 194 in __main__.example_0\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/mhansen/.sage//tmp/.doctest_wester.py\n         [5.3 s]\nexit code: 1024\n```",
    "created_at": "2009-10-15T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52296",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:13'></a>
I get the following failures against 4.1.2:

```
sage -t  "devel/sage-main/sage/modules/fg_pid/fgp_module.py"
**********************************************************************
File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/devel/sage-main/sage/modules/fg_pid/fgp_module.py", line 1280:
    sage: A._hom_from_smith(Sequence([B.0]), B)
Exception raised:
    Traceback (most recent call last):
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_33[7]>", line 1, in <module>
        A._hom_from_smith(Sequence([B.gen(0)]), B)###line 1280:
    sage: A._hom_from_smith(Sequence([B.0]), B)
      File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1416)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/modules/fg_pid/fgp_morphism.py", line 131, in _repr_
        list(self.im_gens()))
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/modules/fg_pid/fgp_morphism.py", line 149, in im_gens
        self.__im_gens = tuple([self(x) for x in self.domain().gens()])
      File "<doctest __main__.example_32[2]>", line 3, in gens
    NameError: global name 'tuple' is not defined
**********************************************************************
1 items had failures:
   1 of   8 in __main__.example_33
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/mhansen/.sage//tmp/.doctest_fgp_module.py
         [7.6 s]
exit code: 1024


sage -t -long "devel/sage-main/sage/calculus/wester.py"     
**********************************************************************
File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/devel/sage-main/sage/calculus/wester.py", line 122:
    sage: bool(f == g)
Exception raised:
    Traceback (most recent call last):
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[36]>", line 1, in <module>
        bool(f == g)###line 122:
    sage: bool(f == g)
      File "expression.pyx", line 1340, in sage.symbolic.expression.Expression.__nonzero__ (sage/symbolic/expression.cpp:7786)
      File "expression.pyx", line 1483, in sage.symbolic.expression.Expression.test_relation (sage/symbolic/expression.cpp:9153)
      File "expression.pyx", line 2807, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:13840)
      File "element.pyx", line 1177, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:9945)
      File "coerce.pyx", line 707, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6096)
      File "coerce.pyx", line 1160, in sage.structure.coerce.CoercionModel_cache_maps.get_action (sage/structure/coerce.c:10589)
      File "coerce.pyx", line 1283, in sage.structure.coerce.CoercionModel_cache_maps.discover_action (sage/structure/coerce.c:11682)
      File "parent.pyx", line 1203, in sage.structure.parent.Parent.get_action (sage/structure/parent.c:10828)
      File "parent_old.pyx", line 478, in sage.structure.parent_old.Parent._get_action_ (sage/structure/parent_old.c:5974)
      File "parent_old.pyx", line 198, in sage.structure.parent_old.Parent.get_action_c (sage/structure/parent_old.c:2757)
      File "parent_old.pyx", line 210, in sage.structure.parent_old.Parent.get_action_impl (sage/structure/parent_old.c:3068)
      File "parent_old.pyx", line 214, in sage.structure.parent_old.Parent.get_action_c_impl (sage/structure/parent_old.c:3118)
      File "parent.pyx", line 1306, in sage.structure.parent.Parent.discover_action (sage/structure/parent.c:12094)
      File "coerce_actions.pyx", line 92, in sage.structure.coerce_actions.ModuleAction.__init__ (sage/structure/coerce_actions.c:3415)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py", line 692, in pushout
        return all(Z)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py", line 64, in __call__
        R = c(R)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/categories/pushout.py", line 406, in __call__
        return R.completion(self.p, self.prec, self.extras)
      File "/scratch/mhansen/release/4.2/alpha0/sage-4.2.alpha0/local/lib/python/site-packages/sage/rings/number_field/number_field.py", line 1074, in completion
        return QQ.completion(p, prec, extras).algebraic_closure()
      File "ring.pyx", line 1752, in sage.rings.ring.Field.algebraic_closure (sage/rings/ring.c:9235)
    NotImplementedError: Algebraic closures of general fields not implemented.
**********************************************************************
1 items had failures:
   1 of 194 in __main__.example_0
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/mhansen/.sage//tmp/.doctest_wester.py
         [5.3 s]
exit code: 1024
```



---

archive/issue_comments_052297.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2009-10-15T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52297",
    "user": "https://github.com/mwhansen"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_052298.json:
```json
{
    "body": "Changing author from \"\" to \"Robert Bradshaw\"",
    "created_at": "2009-10-15T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52298",
    "user": "https://github.com/mwhansen"
}
```

Changing author from "" to "Robert Bradshaw"



---

archive/issue_comments_052299.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2009-10-15T07:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52299",
    "user": "https://github.com/mwhansen"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_052300.json:
```json
{
    "body": "<a id='comment:14'></a>\n\n```\nglobal name 'tuple' is not defined\n```\n\nHuh? \n\nI'll take a look when I upgrade.",
    "created_at": "2009-10-15T07:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52300",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:14'></a>

```
global name 'tuple' is not defined
```

Huh? 

I'll take a look when I upgrade.



---

archive/issue_comments_052301.json:
```json
{
    "body": "<a id='comment:15'></a>\nYeah, it's very weird.",
    "created_at": "2009-10-16T09:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52301",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:15'></a>
Yeah, it's very weird.



---

archive/issue_comments_052302.json:
```json
{
    "body": "<a id='comment:16'></a>\nThe NotImplementedError is an easy fix. I'll look at the other one later today, hopefully to get this into 4.2.",
    "created_at": "2009-10-19T21:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52302",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:16'></a>
The NotImplementedError is an easy fix. I'll look at the other one later today, hopefully to get this into 4.2.



---

archive/issue_comments_052303.json:
```json
{
    "body": "apply on top of previous",
    "created_at": "2009-10-20T05:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52303",
    "user": "https://github.com/robertwb"
}
```

apply on top of previous



---

archive/issue_comments_052304.json:
```json
{
    "body": "<a id='comment:17'></a>\nAttachment [5596-exposure-fixes.patch](tarball://root/attachments/some-uuid/ticket5596/5596-exposure-fixes.patch) by @robertwb created at 2009-10-20 05:31:11\n\nOK, this was one of those weird bugs that was only reproducible in doctests, and an all around pain to track down. Apparently the coercion changes caused some parents to not get garbage collected as eagerly, which exposed a bug when fgp modules are cached and reused. I am still unsure what exactly the bug is (I have a hunch it has to do with parents that are defined in doctests getting reused in other doctests after their environment has been recycled or something) but I have disabled caching for now to get it to work. \n\nI refreshed the exposure-fixes patch, should work fine now.",
    "created_at": "2009-10-20T05:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52304",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:17'></a>
Attachment [5596-exposure-fixes.patch](tarball://root/attachments/some-uuid/ticket5596/5596-exposure-fixes.patch) by @robertwb created at 2009-10-20 05:31:11

OK, this was one of those weird bugs that was only reproducible in doctests, and an all around pain to track down. Apparently the coercion changes caused some parents to not get garbage collected as eagerly, which exposed a bug when fgp modules are cached and reused. I am still unsure what exactly the bug is (I have a hunch it has to do with parents that are defined in doctests getting reused in other doctests after their environment has been recycled or something) but I have disabled caching for now to get it to work. 

I refreshed the exposure-fixes patch, should work fine now.



---

archive/issue_comments_052305.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2009-10-20T05:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52305",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_052306.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2009-10-20T05:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52306",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_052307.json:
```json
{
    "body": "Attachment [trac_5596-minor_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket5596/trac_5596-minor_doctest_fixes.patch) by @mwhansen created at 2009-10-21 05:19:43",
    "created_at": "2009-10-21T05:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52307",
    "user": "https://github.com/mwhansen"
}
```

Attachment [trac_5596-minor_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket5596/trac_5596-minor_doctest_fixes.patch) by @mwhansen created at 2009-10-21 05:19:43



---

archive/issue_comments_052308.json:
```json
{
    "body": "<a id='comment:18'></a>\nI added a small patch which just reworked the doctest since the action of the symmetric group on polynomials from the right already exists.\n\nOther than that, everything looks good to me.",
    "created_at": "2009-10-21T05:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52308",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:18'></a>
I added a small patch which just reworked the doctest since the action of the symmetric group on polynomials from the right already exists.

Other than that, everything looks good to me.



---

archive/issue_comments_052309.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-10-21T05:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52309",
    "user": "https://github.com/mwhansen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_052310.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Nicolas M. Thi\u00e9ry, Mike Hansen\"",
    "created_at": "2009-10-21T05:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52310",
    "user": "https://github.com/mwhansen"
}
```

Changing reviewer from "" to "Nicolas M. Thiéry, Mike Hansen"



---

archive/issue_comments_052311.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-10-21T05:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52311",
    "user": "https://github.com/mwhansen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_052312.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-10-21T05:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52312",
    "user": "https://github.com/mwhansen"
}
```

Resolution: fixed



---

archive/issue_events_017035.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-10-21T05:22:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5596#event-17035"
}
```



---

archive/issue_comments_052313.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.2.alpha1\"",
    "created_at": "2009-10-21T05:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5596",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5596#issuecomment-52313",
    "user": "https://github.com/mwhansen"
}
```

Changing merged from "" to "sage-4.2.alpha1"
