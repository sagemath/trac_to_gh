# Issue 5130: create a prime_pi function that doesn't just compute len(prime_range(n))

archive/issues_005130.json:
```json
{
    "assignees": [
        "https://github.com/williamstein"
    ],
    "body": "The goal of this ticket is to make something eventually competitive with Mathematica's PrimePi.  The first version won't do that, but it is a step in the right direction. \n\nNote that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do `PrimePi[10^14]` in \"about a minute\", but the algorithm there doesn't allow larger input.\n\n```\nIn[11]:= Timing[PrimePi[ 10^13 + 10^8 +10^9]]\nOut[11]= {12., 346102281239}\n\nIn[13]:= Timing[PrimePi[10^14]]\nOut[13]= {59.53, 3204941750802}\n```\n\nThe attached code did `10^14` in just under an hour.   The issue is that Mathematica implements a different sublinear algorithm.\n\nIn Sage, with extra storage usage:\n\n```\nsage: k = 10^13\nsage: time print prime_pi(k,40)\n346065536839\nTime: CPU 219.44 s, Wall: 219.44 s\n```\n\nSo for that one mathematica is 18 times faster. \n\nAnother comparison for smaller input, where this is better:\n\n```\nsage: time prime_pi(10^10,32)\nCPU times: user 0.59 s, sys: 0.04 s, total: 0.63 s\nWall time: 0.63 s\n455052511L\n\n...\n\nwstein@sage:~$ math\nMathematica 6.0 for Linux x86 (64-bit)\nCopyright 1988-2007 Wolfram Research, Inc.\nIn[1]:= Timing[PrimePi[10^10]]\nOut[1]= {0.12, 455052511}\n```\n\nComponent: **number theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/5130_\n\n",
    "closed_at": "2009-04-22T22:18:58Z",
    "created_at": "2009-01-29T21:41:56Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.4.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "create a prime_pi function that doesn't just compute len(prime_range(n))",
    "type": "issue",
    "updated_at": "2009-04-22T22:18:58Z",
    "url": "https://github.com/sagemath/sage/issues/5130",
    "user": "https://github.com/williamstein"
}
```
The goal of this ticket is to make something eventually competitive with Mathematica's PrimePi.  The first version won't do that, but it is a step in the right direction. 

Note that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do `PrimePi[10^14]` in "about a minute", but the algorithm there doesn't allow larger input.

```
In[11]:= Timing[PrimePi[ 10^13 + 10^8 +10^9]]
Out[11]= {12., 346102281239}

In[13]:= Timing[PrimePi[10^14]]
Out[13]= {59.53, 3204941750802}
```

The attached code did `10^14` in just under an hour.   The issue is that Mathematica implements a different sublinear algorithm.

In Sage, with extra storage usage:

```
sage: k = 10^13
sage: time print prime_pi(k,40)
346065536839
Time: CPU 219.44 s, Wall: 219.44 s
```

So for that one mathematica is 18 times faster. 

Another comparison for smaller input, where this is better:

```
sage: time prime_pi(10^10,32)
CPU times: user 0.59 s, sys: 0.04 s, total: 0.63 s
Wall time: 0.63 s
455052511L

...

wstein@sage:~$ math
Mathematica 6.0 for Linux x86 (64-bit)
Copyright 1988-2007 Wolfram Research, Inc.
In[1]:= Timing[PrimePi[10^10]]
Out[1]= {0.12, 455052511}
```

Component: **number theory**

_Issue created by migration from https://trac.sagemath.org/ticket/5130_





---

archive/issue_events_059308.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:41:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "milestone_number": null,
    "milestone_title": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59308"
}
```



---

archive/issue_events_059309.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:41:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "c: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59309"
}
```



---

archive/issue_events_059310.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:41:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59310"
}
```



---

archive/issue_events_059311.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:41:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59311"
}
```



---

archive/issue_events_059312.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:41:56Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "subject": "https://github.com/williamstein",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59312"
}
```



---

archive/issue_comments_031287.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n The goal of this ticket is to make something eventually competitive with Mathematica's PrimePi.  The first version won't do that, but it is a step in the right direction. \n \n-Note that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do PrimePi[10^14] in \"about a minute\", but the algorithm there doesn't allow larger input.\n+Note that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do `PrimePi[10^14]` in \"about a minute\", but the algorithm there doesn't allow larger input.\n \n ```\n In[11]:= Timing[PrimePi[ 10^13 + 10^8 +10^9]]\n``````\n",
    "created_at": "2009-01-29T21:42:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31287",
    "user": "https://github.com/williamstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 The goal of this ticket is to make something eventually competitive with Mathematica's PrimePi.  The first version won't do that, but it is a step in the right direction. 
 
-Note that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do PrimePi[10^14] in "about a minute", but the algorithm there doesn't allow larger input.
+Note that evidently the only program we know of with a fast prime_pi is Mathematica (pari, maple, etc., -- none of them have anything at all).  In contract, Mathematica can do `PrimePi[10^14]` in "about a minute", but the algorithm there doesn't allow larger input.
 
 ```
 In[11]:= Timing[PrimePi[ 10^13 + 10^8 +10^9]]
``````




---

archive/issue_comments_031288.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,3 +22,20 @@\n ```\n \n So for that one mathematica is 18 times faster. \n+\n+Another comparison for smaller input, where this is better:\n+\n+```\n+sage: time prime_pi(10^10,32)\n+CPU times: user 0.59 s, sys: 0.04 s, total: 0.63 s\n+Wall time: 0.63 s\n+455052511L\n+\n+...\n+\n+wstein@sage:~$ math\n+Mathematica 6.0 for Linux x86 (64-bit)\n+Copyright 1988-2007 Wolfram Research, Inc.\n+In[1]:= Timing[PrimePi[10^10]]\n+Out[1]= {0.12, 455052511}\n+```\n``````\n",
    "created_at": "2009-01-29T21:44:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31288",
    "user": "https://github.com/williamstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,3 +22,20 @@
 ```
 
 So for that one mathematica is 18 times faster. 
+
+Another comparison for smaller input, where this is better:
+
+```
+sage: time prime_pi(10^10,32)
+CPU times: user 0.59 s, sys: 0.04 s, total: 0.63 s
+Wall time: 0.63 s
+455052511L
+
+...
+
+wstein@sage:~$ math
+Mathematica 6.0 for Linux x86 (64-bit)
+Copyright 1988-2007 Wolfram Research, Inc.
+In[1]:= Timing[PrimePi[10^10]]
+Out[1]= {0.12, 455052511}
+```
``````




---

archive/issue_events_059313.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:57:50Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "title_is": "create a prime_pi function that doesn't just compute len(prime_range(n))",
    "title_was": "[not ready for review] create a prime_pi function that doesn't just compute len(prime_range(n))",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59313"
}
```



---

archive/issue_events_059314.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-29T21:57:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59314"
}
```



---

archive/issue_events_059315.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-01-30T01:39:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59315"
}
```



---

archive/issue_events_059316.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-01-30T01:39:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59316"
}
```



---

archive/issue_comments_031289.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHi Andrew,\n\nI think the code looks pretty good.  There are two things that I'd like to see added before it goes into Sage.\n\n1. Could you add a reference for the algorithm being used?  As part of this, could you add docstrings to the two cdef functions briefly describing their purpose / maybe relating them to the algorithm in the reference?\n\n2. Could you make a note about whether or not we'll run into any issues with integer overflows or numerical accuracy as the code uses floating point arithmetic (sqrt).\n\n--Mike",
    "created_at": "2009-01-30T01:39:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31289",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:4" align="right">comment:4</div>

Hi Andrew,

I think the code looks pretty good.  There are two things that I'd like to see added before it goes into Sage.

1. Could you add a reference for the algorithm being used?  As part of this, could you add docstrings to the two cdef functions briefly describing their purpose / maybe relating them to the algorithm in the reference?

2. Could you make a note about whether or not we'll run into any issues with integer overflows or numerical accuracy as the code uses floating point arithmetic (sqrt).

--Mike



---

archive/issue_comments_031290.json:
```json
{
    "body": "The algorithm used is Legendre's formula, it has been around for quite a while, so there are many references on it. I used as a reference Hans Riesel's Prime \"Numbers and Computer Methods for Factorization\".\n\n--Andrew",
    "created_at": "2009-01-30T02:04:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31290",
    "user": "https://github.com/ohanar"
}
```

The algorithm used is Legendre's formula, it has been around for quite a while, so there are many references on it. I used as a reference Hans Riesel's Prime "Numbers and Computer Methods for Factorization".

--Andrew



---

archive/issue_comments_031291.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nBy the way, it looks easy to replace a lot of the sqrt's, and to double-check the others.  You can replace a<=sqrt(b) with a*a<=b.  For the others, if you have\n  a=<long long>sqrt(b)\nyou can follow it with:\n  if a*a > b or (a+1)*(a+1) <= b: raise an exception",
    "created_at": "2009-01-30T02:18:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31291",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:6" align="right">comment:6</div>

By the way, it looks easy to replace a lot of the sqrt's, and to double-check the others.  You can replace a<=sqrt(b) with a*a<=b.  For the others, if you have
  a=<long long>sqrt(b)
you can follow it with:
  if a*a > b or (a+1)*(a+1) <= b: raise an exception



---

archive/issue_comments_031292.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAndrew -- We're having a lot of trouble porting wise with code that uses sqrtl.  This code needs to be slightly rewritten to not use it.   \n\nThe sqrt must be rewritten to either use gmp directly or just use the normal sage Python sqrt, which hopefully won't be much slower for this application.",
    "created_at": "2009-02-03T04:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31292",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:7" align="right">comment:7</div>

Andrew -- We're having a lot of trouble porting wise with code that uses sqrtl.  This code needs to be slightly rewritten to not use it.   

The sqrt must be rewritten to either use gmp directly or just use the normal sage Python sqrt, which hopefully won't be much slower for this application.



---

archive/issue_comments_031293.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIt is not \"trouble porting wise\", it is that long double functions are not guaranteed by the C99 standard to have any more precision that the double version of the same function. cwitty pointed out that also double and float implementations commonly return the same result, so if you want guaranteed results use gmp or mpfr - everything else plainly sucks.\n\nCheers,\n\nMichael",
    "created_at": "2009-02-03T04:51:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31293",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:8" align="right">comment:8</div>

It is not "trouble porting wise", it is that long double functions are not guaranteed by the C99 standard to have any more precision that the double version of the same function. cwitty pointed out that also double and float implementations commonly return the same result, so if you want guaranteed results use gmp or mpfr - everything else plainly sucks.

Cheers,

Michael



---

archive/issue_comments_031294.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThe following lines from your update are highly disturbing.\n\n```\n\t104\t        cdef long long m_max = <long long> sqrtl(x) + 1 \n \t105\t        while (m_max-1)*(m_max-1) > x or m_max*m_max <= x: \n \t106\t            m_max = <long long> sqrtl(x) + 1\n```\n\nFactoring out some noise, this simplifies to:\n\n```\na = b\nwhile x:\n   a = b\n```\n\nwhere a,b, and x will *NEVER* change *AT ALL* during the execution of the code.  So if you ever enter the while loop, boom.",
    "created_at": "2009-02-06T19:55:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31294",
    "user": "https://github.com/boothby"
}
```

<div id="comment:9" align="right">comment:9</div>

The following lines from your update are highly disturbing.

```
	104	        cdef long long m_max = <long long> sqrtl(x) + 1 
 	105	        while (m_max-1)*(m_max-1) > x or m_max*m_max <= x: 
 	106	            m_max = <long long> sqrtl(x) + 1
```

Factoring out some noise, this simplifies to:

```
a = b
while x:
   a = b
```

where a,b, and x will *NEVER* change *AT ALL* during the execution of the code.  So if you ever enter the while loop, boom.



---

archive/issue_comments_031295.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\n> The following lines from your update are highly disturbing.\n\nI only looked at this for a second, but I suspect you're reasoning as if the numbers satisfied laws such as commutative, associativity etc.; probably the whole point is they might not since they are just floating point approximations.",
    "created_at": "2009-02-06T19:58:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31295",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:10" align="right">comment:10</div>

> The following lines from your update are highly disturbing.

I only looked at this for a second, but I suspect you're reasoning as if the numbers satisfied laws such as commutative, associativity etc.; probably the whole point is they might not since they are just floating point approximations.



---

archive/issue_comments_031296.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nNo, boothby is right.  There's no commutativity, associativity, etc. involved here.  The only floating point at all is in `<long long>sqrtl(x)`, and that certainly ought to give the exact same result every time you call it on any particular platform (although the results from one platform to another certainly might differ).",
    "created_at": "2009-02-06T21:29:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31296",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:11" align="right">comment:11</div>

No, boothby is right.  There's no commutativity, associativity, etc. involved here.  The only floating point at all is in `<long long>sqrtl(x)`, and that certainly ought to give the exact same result every time you call it on any particular platform (although the results from one platform to another certainly might differ).



---

archive/issue_comments_031297.json:
```json
{
    "body": "this is rebased against 3.4.alpha0 *and* it implements sqrt for long and long long using double and float code from Bill Hart",
    "created_at": "2009-03-03T23:09:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31297",
    "user": "https://github.com/williamstein"
}
```

this is rebased against 3.4.alpha0 *and* it implements sqrt for long and long long using double and float code from Bill Hart



---

archive/issue_events_059317.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-03-03T23:10:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59317"
}
```



---

archive/issue_events_059318.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-03-03T23:10:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59318"
}
```



---

archive/issue_comments_031298.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAttachment: **[trac_5130-final.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-final.patch.gz)**",
    "created_at": "2009-03-03T23:10:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31298",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:12" align="right">comment:12</div>

Attachment: **[trac_5130-final.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-final.patch.gz)**



---

archive/issue_events_059319.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2009-03-18T04:44:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59319"
}
```



---

archive/issue_events_059320.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2009-03-18T04:44:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59320"
}
```



---

archive/issue_comments_031299.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIt would be good to include a reference to the algorithm, and perhaps a bit more documentation in the code itself. For example, what is mem_mult or m_max? \n\nMaybe a the docstring should have an example of computing len(prime_range(...)) to show more explicitly what it's computing. \n\nThe second line of `prime_phi_large`, no need to write `long(N)`, just write N. \n\nI'm not sure what's going on here, but it's not deterministic. \n\n```\nsage: for n in range(90000, 100000, 3):\n....:     if prime_pi(n) != len(prime_range(n+1)):\n....:         print n, prime_pi(n), len(prime_range(n+1));\n....:         \n91587 8855 8855\n91848 8878 8875\n92112 8899 8896\n92373 8924 8921\n92376 8921 8921\n92637 8947 8945\n92901 8979 8976\n92904 8976 8976\n93171 8999 8999\n...\n```\n\n(This is on an OS X 10.4 intel.)",
    "created_at": "2009-03-18T04:44:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31299",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:13" align="right">comment:13</div>

It would be good to include a reference to the algorithm, and perhaps a bit more documentation in the code itself. For example, what is mem_mult or m_max? 

Maybe a the docstring should have an example of computing len(prime_range(...)) to show more explicitly what it's computing. 

The second line of `prime_phi_large`, no need to write `long(N)`, just write N. 

I'm not sure what's going on here, but it's not deterministic. 

```
sage: for n in range(90000, 100000, 3):
....:     if prime_pi(n) != len(prime_range(n+1)):
....:         print n, prime_pi(n), len(prime_range(n+1));
....:         
91587 8855 8855
91848 8878 8875
92112 8899 8896
92373 8924 8921
92376 8921 8921
92637 8947 8945
92901 8979 8976
92904 8976 8976
93171 8999 8999
...
```

(This is on an OS X 10.4 intel.)



---

archive/issue_comments_031300.json:
```json
{
    "body": "this is rebased against 3.4 and should now be deterministic",
    "created_at": "2009-04-13T14:32:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31300",
    "user": "https://github.com/ohanar"
}
```

this is rebased against 3.4 and should now be deterministic



---

archive/issue_comments_031301.json:
```json
{
    "body": "Attachment: **[trac_5130-final.2.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-final.2.patch.gz)**\n\nrebased against 3.4.1.rc2",
    "created_at": "2009-04-14T22:43:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31301",
    "user": "https://github.com/williamstein"
}
```

Attachment: **[trac_5130-final.2.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-final.2.patch.gz)**

rebased against 3.4.1.rc2



---

archive/issue_comments_031302.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nAttachment: **[trac_5130-rebased.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-rebased.patch.gz)**",
    "created_at": "2009-04-14T22:43:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31302",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:14" align="right">comment:14</div>

Attachment: **[trac_5130-rebased.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-rebased.patch.gz)**



---

archive/issue_events_059321.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-04-14T22:43:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59321"
}
```



---

archive/issue_events_059322.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-04-14T22:43:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59322"
}
```



---

archive/issue_events_059323.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-15T04:38:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59323"
}
```



---

archive/issue_events_059324.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-15T04:38:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59324"
}
```



---

archive/issue_comments_031303.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nMajor issue: it needs to raise an exception on an invalid mem_mult, instead of giving the wrong answer:\n\n```\nsage: prime_pi(10^6)\n78498\nsage: prime_pi(10^6, 0)\n228574\n```\n\nMinor issues:\n`allows for use of addition memory` should be `allows for the use of additional memory`\n\nIt looks like the function bisect() is doing some variant on binary search; but it's not the standard algorithm, which makes it harder to understand and review.  Maybe it should be replaced with a real binary search (for example, following the flowchart from http://en.wikipedia.org/wiki/Binary_search).\n\nNote that I've read the code and performed lots of tests (against len(prime_range(n)) for small n, and against Mathematica for n around 2<sup>39</sup>), but I don't understand the algorithm.  With this caveat, I'd be willing to give it a positive review if the major wrong-answer issue were fixed (although fixing the minor issues too would be better, of course).",
    "created_at": "2009-04-15T04:38:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31303",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:15" align="right">comment:15</div>

Major issue: it needs to raise an exception on an invalid mem_mult, instead of giving the wrong answer:

```
sage: prime_pi(10^6)
78498
sage: prime_pi(10^6, 0)
228574
```

Minor issues:
`allows for use of addition memory` should be `allows for the use of additional memory`

It looks like the function bisect() is doing some variant on binary search; but it's not the standard algorithm, which makes it harder to understand and review.  Maybe it should be replaced with a real binary search (for example, following the flowchart from http://en.wikipedia.org/wiki/Binary_search).

Note that I've read the code and performed lots of tests (against len(prime_range(n)) for small n, and against Mathematica for n around 2<sup>39</sup>), but I don't understand the algorithm.  With this caveat, I'd be willing to give it a positive review if the major wrong-answer issue were fixed (although fixing the minor issues too would be better, of course).



---

archive/issue_comments_031304.json:
```json
{
    "body": "rebased against 3.4.1.rc2 and fixes the issues raised by cwitty",
    "created_at": "2009-04-15T10:14:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31304",
    "user": "https://github.com/ohanar"
}
```

rebased against 3.4.1.rc2 and fixes the issues raised by cwitty



---

archive/issue_comments_031305.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAttachment: **[trac_5130-rebased.2.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-rebased.2.patch.gz)**",
    "created_at": "2009-04-15T10:14:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31305",
    "user": "https://github.com/ohanar"
}
```

<div id="comment:16" align="right">comment:16</div>

Attachment: **[trac_5130-rebased.2.patch.gz](https://github.com/sagemath/sage/files/ticket5130/trac_5130-rebased.2.patch.gz)**



---

archive/issue_events_059325.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2009-04-15T10:14:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59325"
}
```



---

archive/issue_events_059326.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2009-04-15T10:14:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59326"
}
```



---

archive/issue_comments_031306.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nCode looks good, doctests pass.  I still don't understand the algorithm, but I'm giving it a positive review anyway.",
    "created_at": "2009-04-18T15:37:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31306",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:17" align="right">comment:17</div>

Code looks good, doctests pass.  I still don't understand the algorithm, but I'm giving it a positive review anyway.



---

archive/issue_events_059327.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-18T15:37:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59327"
}
```



---

archive/issue_events_059328.json:
```json
{
    "actor": "https://github.com/sagetrac-cwitty",
    "created_at": "2009-04-18T15:37:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59328"
}
```



---

archive/issue_comments_031307.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nWell, I am not too happy that there are special long long sqrt() work around function in this file. Since the code is by Bill I think they should be somewhat reliable and they seems to detect numerical precision issues, but I still do not trust them to work reliably, i.e. Sparc. \n\nAnyway, I would like them to be moved to its own file and I would like to see a test that compares and verifies their output for a wide range of inputs against MPFR for example. Even nicer would be the ability to switch away from this function and use MPFR functionality in its place. This is not something that will prevent this code from going in unless the current doctests will get broken on something like Sparc/Solaris where I have detected problems with the number_of_partitions() test that also relies on some sqrtl() function. \n\nCheers,\n\nMichael",
    "created_at": "2009-04-21T23:34:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31307",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:18" align="right">comment:18</div>

Well, I am not too happy that there are special long long sqrt() work around function in this file. Since the code is by Bill I think they should be somewhat reliable and they seems to detect numerical precision issues, but I still do not trust them to work reliably, i.e. Sparc. 

Anyway, I would like them to be moved to its own file and I would like to see a test that compares and verifies their output for a wide range of inputs against MPFR for example. Even nicer would be the ability to switch away from this function and use MPFR functionality in its place. This is not something that will prevent this code from going in unless the current doctests will get broken on something like Sparc/Solaris where I have detected problems with the number_of_partitions() test that also relies on some sqrtl() function. 

Cheers,

Michael



---

archive/issue_comments_031308.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI wouldn't worry about the correctness/portability of sqrt_longlong.  It uses sqrt() (not sqrtl()), which is exactly specified by IEEE floating point (no room for implementation differences in the spec), so it should be portable; and it has a built-in self-test, so if something goes wrong we'll get exceptions.",
    "created_at": "2009-04-22T00:27:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31308",
    "user": "https://github.com/sagetrac-cwitty"
}
```

<div id="comment:19" align="right">comment:19</div>

I wouldn't worry about the correctness/portability of sqrt_longlong.  It uses sqrt() (not sqrtl()), which is exactly specified by IEEE floating point (no room for implementation differences in the spec), so it should be portable; and it has a built-in self-test, so if something goes wrong we'll get exceptions.



---

archive/issue_comments_031309.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@sagetrac-cwitty](#comment:19):\n> I wouldn't worry about the correctness/portability of sqrt_longlong.  It uses sqrt() (not sqrtl()),\n\nYes, I know. I complained initially about sqrtl() in one of the early patches which was the reason long long sqrt() was defined. \n\n>  which is exactly specified by IEEE floating point (no room for implementation differences in the spec), so it should be portable; and it has a built-in self-test, so if something goes wrong we'll get exceptions.\n\nI think my points still stand, i.e.\n \n* There is no reason for the long long sqrt() to be in this file since it will come in useful in some other places, i.e. the number_of_partitions() code since that code currently fails doctests on Sparc/Solaris (it might be completely unrelated to sqrtl(), but as it the code does not compile on FreeBSD 8 due to the use of sqrtl() there)\n* There should be some extensive testing done for that function. I am sure someone using the function and getting back some error message will not be happy that an error was detected, but complain and not see the advantage of detecting the issue in the first place :)\n* If some doctest here fails on Sparc/Solaris for example I will not merge this patch since I don't need any more bugs introduced that in the end someone else (i.e. William or me has to fix). Some of the fixes took a long, long time to hunt down (and we are still not done **now**), so the attitude that someone else will clean up such a mess is not something I am willing to accept, not that any person involved in this ticket has this attitude ;). \n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T00:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31309",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@sagetrac-cwitty](#comment:19):
> I wouldn't worry about the correctness/portability of sqrt_longlong.  It uses sqrt() (not sqrtl()),

Yes, I know. I complained initially about sqrtl() in one of the early patches which was the reason long long sqrt() was defined. 

>  which is exactly specified by IEEE floating point (no room for implementation differences in the spec), so it should be portable; and it has a built-in self-test, so if something goes wrong we'll get exceptions.

I think my points still stand, i.e.
 
* There is no reason for the long long sqrt() to be in this file since it will come in useful in some other places, i.e. the number_of_partitions() code since that code currently fails doctests on Sparc/Solaris (it might be completely unrelated to sqrtl(), but as it the code does not compile on FreeBSD 8 due to the use of sqrtl() there)
* There should be some extensive testing done for that function. I am sure someone using the function and getting back some error message will not be happy that an error was detected, but complain and not see the advantage of detecting the issue in the first place :)
* If some doctest here fails on Sparc/Solaris for example I will not merge this patch since I don't need any more bugs introduced that in the end someone else (i.e. William or me has to fix). Some of the fixes took a long, long time to hunt down (and we are still not done **now**), so the attitude that someone else will clean up such a mess is not something I am willing to accept, not that any person involved in this ticket has this attitude ;). 

Cheers,

Michael



---

archive/issue_comments_031310.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nHi,\n\nI did extensive testing comparing Solaris/Sparc with Linux x86-64, tried to break it some other way, but I failed :). It also builds fine on Solaris 10.\n\nOne question: What is the credit situation here?\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T22:18:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31310",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:21" align="right">comment:21</div>

Hi,

I did extensive testing comparing Solaris/Sparc with Linux x86-64, tried to break it some other way, but I failed :). It also builds fine on Solaris 10.

One question: What is the credit situation here?

Cheers,

Michael



---

archive/issue_comments_031311.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nMerged in Sage 3.4.2.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-22T22:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5130#issuecomment-31311",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:22" align="right">comment:22</div>

Merged in Sage 3.4.2.alpha0.

Cheers,

Michael



---

archive/issue_events_059329.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T22:18:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59329"
}
```



---

archive/issue_events_059330.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T22:18:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59330"
}
```



---

archive/issue_events_059331.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T22:18:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "milestone_number": null,
    "milestone_title": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59331"
}
```



---

archive/issue_events_059332.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-22T22:18:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5130",
    "milestone_number": null,
    "milestone_title": "sage-3.4.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5130#event-59332"
}
```
