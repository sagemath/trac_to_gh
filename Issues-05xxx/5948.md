# Issue 5948: [with patch, positive review] Coleman integrals of df*f

archive/issues_005948.json:
```json
{
    "body": "This is a problem arising from the computation of iterated Coleman integrals. It seems that (single) Coleman integrals of df*f for f coming from the MW-reduction are wrong.\n\nHere's the setup:\n\n```\nsage: R.<x> = QQ['x']\nsage: E= HyperellipticCurve(x^3-4*x+4)\nsage: K = Qp(5,10)\nsage: EK = E.change_ring(K)\nsage: P = EK(2,2)\nsage: Q = EK(-2,-2)\nsage: P = EK.teichmuller(P)\nsage: Q = EK.teichmuller(Q)\nsage: import sage.schemes.elliptic_curves.monsky_washnitzer as monsky_washnitzer\nsage: M_frob, forms = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(EK)\nsage: f = forms[0]\n```\n\nWe know that int(df df,P,Q) = 1/2*int(df,P,Q)<sup>2</sup>, where the integral\non the LHS is iterated and the integral on the RHS is a usual Coleman integral. Using a single Coleman integral to compute this gives\n\n```\nsage: 1/2*EK.coleman_integral(f.diff(),P,Q)^2\n3*5^2 + 5^3 + 5^4 + 5^5 + 4*5^6 + 2*5^7 + 4*5^8 + 5^9 + 3*5^10 + 4*5^11 + O(5^12)\n```\nWe also can expand int(df df,P,Q) = f(Q)*(f(Q)-f(P)) - int(df*f,P,Q) (*)\n\nNow let's check the things on the RHS of (*)\n\n```\nsage: EK.coleman_integral(-f.diff(),P,Q) == f(Q[0],Q[1])-f(P[0],P[1])\nTrue\n```\n\nSo the first term is computed consistently (modulo the minor problem\nwith f.diff() -- see #5947). The second term is the problem, and here's why:\nintegrating by parts, we have\nint(f*df,P,Q) + int(df*f, P,Q) = f<sup>2</sup>(Q)-f<sup>2</sup>(P), which gives\nint(df*f,P, Q) = 1/2*(f<sup>2</sup>(Q)-f<sup>2</sup>(P)).                   (**)\n\nComputing the LHS of (**)  gives:\n\n```\nsage: EK.coleman_integral(-f.diff()*f,P,Q)\n2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 2*5^10 + 3*5^11 + O(5^12)\n```\n\nComputing the RHS of (**) gives\n\n```\nsage: g = f^2\nsage: 1/2*(g(Q[0],Q[1])-g(P[0],P[1]))\n2*5^2 + 2*5^3 + 2*5^6 + 4*5^7 + 3*5^8 + 2*5^9 + 2*5^11 + O(5^12)\n```\n\nSo they're good up to 2 digits, but no more. The RHS is the correct one:\n\n```\nsage: f(Q[0],Q[1])*(f(Q[0],Q[1])-f(P[0],P[1])) -\n1/2*(g(Q[0],Q[1])-g(P[0],P[1])) ==\n1/2*EK.coleman_integral(-f.diff(),P,Q)^2\nTrue\n```\n\nThus the bug is with \n\n```\nEK.coleman_integral(-f0.diff()*f0,P,Q)\n```\n\nI looked at the code briefly, but at first glance, it doesn't look like the coercion into MonskyWashnitzerDifferentialRing changes much :\n\n```\nsage: EK.coleman_integral(-f0.diff()*f0,P,Q,True)         #skipping\nthe coercion step\n2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 5^11 + O(5^12)\nsage: EK.coleman_integral(-f0.diff()*f0,P,Q,False)       #the usual\n2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 2*5^10 + 3*5^11 + O(5^12)\n```\n\nSo maybe it's something with the reduction?\n\nAssignee: @robertwb\n\nCC:  mabshoff @robertwb\n\nResolution: fixed\n\nAuthor: Robert Bradshaw\n\nReviewer: Jen Balakrishnan\n\nMerged: 4.0.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/5948\n\n",
    "closed_at": "2009-06-01T05:33:14Z",
    "created_at": "2009-04-30T15:12:20Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.0.1",
    "title": "[with patch, positive review] Coleman integrals of df*f",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5948",
    "user": "https://github.com/jbalakrishnan"
}
```
This is a problem arising from the computation of iterated Coleman integrals. It seems that (single) Coleman integrals of df*f for f coming from the MW-reduction are wrong.

Here's the setup:

```
sage: R.<x> = QQ['x']
sage: E= HyperellipticCurve(x^3-4*x+4)
sage: K = Qp(5,10)
sage: EK = E.change_ring(K)
sage: P = EK(2,2)
sage: Q = EK(-2,-2)
sage: P = EK.teichmuller(P)
sage: Q = EK.teichmuller(Q)
sage: import sage.schemes.elliptic_curves.monsky_washnitzer as monsky_washnitzer
sage: M_frob, forms = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(EK)
sage: f = forms[0]
```

We know that int(df df,P,Q) = 1/2*int(df,P,Q)<sup>2</sup>, where the integral
on the LHS is iterated and the integral on the RHS is a usual Coleman integral. Using a single Coleman integral to compute this gives

```
sage: 1/2*EK.coleman_integral(f.diff(),P,Q)^2
3*5^2 + 5^3 + 5^4 + 5^5 + 4*5^6 + 2*5^7 + 4*5^8 + 5^9 + 3*5^10 + 4*5^11 + O(5^12)
```
We also can expand int(df df,P,Q) = f(Q)*(f(Q)-f(P)) - int(df*f,P,Q) (*)

Now let's check the things on the RHS of (*)

```
sage: EK.coleman_integral(-f.diff(),P,Q) == f(Q[0],Q[1])-f(P[0],P[1])
True
```

So the first term is computed consistently (modulo the minor problem
with f.diff() -- see #5947). The second term is the problem, and here's why:
integrating by parts, we have
int(f*df,P,Q) + int(df*f, P,Q) = f<sup>2</sup>(Q)-f<sup>2</sup>(P), which gives
int(df*f,P, Q) = 1/2*(f<sup>2</sup>(Q)-f<sup>2</sup>(P)).                   (**)

Computing the LHS of (**)  gives:

```
sage: EK.coleman_integral(-f.diff()*f,P,Q)
2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 2*5^10 + 3*5^11 + O(5^12)
```

Computing the RHS of (**) gives

```
sage: g = f^2
sage: 1/2*(g(Q[0],Q[1])-g(P[0],P[1]))
2*5^2 + 2*5^3 + 2*5^6 + 4*5^7 + 3*5^8 + 2*5^9 + 2*5^11 + O(5^12)
```

So they're good up to 2 digits, but no more. The RHS is the correct one:

```
sage: f(Q[0],Q[1])*(f(Q[0],Q[1])-f(P[0],P[1])) -
1/2*(g(Q[0],Q[1])-g(P[0],P[1])) ==
1/2*EK.coleman_integral(-f.diff(),P,Q)^2
True
```

Thus the bug is with 

```
EK.coleman_integral(-f0.diff()*f0,P,Q)
```

I looked at the code briefly, but at first glance, it doesn't look like the coercion into MonskyWashnitzerDifferentialRing changes much :

```
sage: EK.coleman_integral(-f0.diff()*f0,P,Q,True)         #skipping
the coercion step
2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 5^11 + O(5^12)
sage: EK.coleman_integral(-f0.diff()*f0,P,Q,False)       #the usual
2*5^2 + 2*5^3 + 2*5^4 + 5^6 + 5^7 + 4*5^8 + 2*5^10 + 3*5^11 + O(5^12)
```

So maybe it's something with the reduction?

Assignee: @robertwb

CC:  mabshoff @robertwb

Resolution: fixed

Author: Robert Bradshaw

Reviewer: Jen Balakrishnan

Merged: 4.0.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/5948





---

archive/issue_events_013936.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-01T00:42:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "milestone": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5948#event-13936"
}
```



---

archive/issue_comments_051827.json:
```json
{
    "body": "<a id='comment:2'></a>\nThere already seems to be trouble with tiny integrals. Check this out:\n\n```\nsage: R.<x> = QQ['x']\nsage: E= HyperellipticCurve(x^3-4*x+4)\nsage: K = Qp(5,10)\nsage: EK = E.change_ring(K)\nsage: P = EK(2, 2)\nsage: Q = EK.teichmuller(P)\nsage: import sage.schemes.elliptic_curves.monsky_washnitzer as monsky_washnitzer\nsage: M_frob, forms = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(EK)\nsage: f = forms[0]\nsage: u = f.parent().gens()[0]\nsage: u\nx\nsage: u.diff()\n2*y*1 dx/2y\nsage: EK.coleman_integral(-u.diff(), P, Q)\n5 + 5^2 + 5^3 + 2*5^4 + 5^5 + 3*5^6 + 3*5^7 + 4*5^8 + O(5^10) # wrong\nsage: u(Q[0], Q[1]) - u(P[0], P[1])\n5 + 2*5^2 + 5^3 + 3*5^4 + 4*5^5 + 2*5^6 + 3*5^7 + 3*5^9 + O(5^10) # right",
    "created_at": "2009-05-19T05:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51827",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>
There already seems to be trouble with tiny integrals. Check this out:

```
sage: R.<x> = QQ['x']
sage: E= HyperellipticCurve(x^3-4*x+4)
sage: K = Qp(5,10)
sage: EK = E.change_ring(K)
sage: P = EK(2, 2)
sage: Q = EK.teichmuller(P)
sage: import sage.schemes.elliptic_curves.monsky_washnitzer as monsky_washnitzer
sage: M_frob, forms = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(EK)
sage: f = forms[0]
sage: u = f.parent().gens()[0]
sage: u
x
sage: u.diff()
2*y*1 dx/2y
sage: EK.coleman_integral(-u.diff(), P, Q)
5 + 5^2 + 5^3 + 2*5^4 + 5^5 + 3*5^6 + 3*5^7 + 4*5^8 + O(5^10) # wrong
sage: u(Q[0], Q[1]) - u(P[0], P[1])
5 + 2*5^2 + 5^3 + 3*5^4 + 4*5^5 + 2*5^6 + 3*5^7 + 3*5^9 + O(5^10) # right



---

archive/issue_comments_051828.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think line 65 in hyperelliptic_padic_field:62 should be\n\n```\n            I = sum([f_dt[n]/(n+1) for n in xrange(f_dt.degree()+1)]) # \\int_0^1 f dt\n```\nthough this doesn't solve the issue...",
    "created_at": "2009-05-19T09:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51828",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:3'></a>
I think line 65 in hyperelliptic_padic_field:62 should be

```
            I = sum([f_dt[n]/(n+1) for n in xrange(f_dt.degree()+1)]) # \int_0^1 f dt
```
though this doesn't solve the issue...



---

archive/issue_comments_051829.json:
```json
{
    "body": "<a id='comment:5'></a>\nNegation bug at #5947",
    "created_at": "2009-05-20T06:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51829",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:5'></a>
Negation bug at #5947



---

archive/issue_comments_051830.json:
```json
{
    "body": "Attachment [5948-coleman-reduce-forms.patch](tarball://root/attachments/some-uuid/ticket5948/5948-coleman-reduce-forms.patch) by @robertwb created at 2009-05-20 07:43:06",
    "created_at": "2009-05-20T07:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51830",
    "user": "https://github.com/robertwb"
}
```

Attachment [5948-coleman-reduce-forms.patch](tarball://root/attachments/some-uuid/ticket5948/5948-coleman-reduce-forms.patch) by @robertwb created at 2009-05-20 07:43:06



---

archive/issue_comments_051831.json:
```json
{
    "body": "<a id='comment:6'></a>\nAlso has fix for #5947",
    "created_at": "2009-05-20T07:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51831",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:6'></a>
Also has fix for #5947



---

archive/issue_comments_051832.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe patch looks good and fixes the problems I had with iterated integrals.",
    "created_at": "2009-05-21T06:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51832",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:7'></a>
The patch looks good and fixes the problems I had with iterated integrals.



---

archive/issue_comments_051833.json:
```json
{
    "body": "<a id='comment:8'></a>\nWith this patch applied to my 4.0.rc1 merge tree I get one failure:\n\n```\nmabshoff@sage:/scratch/mabshoff/sage-4.0.rc1$ ./sage -t -long devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py\nsage -t -long \"devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py\"\n**********************************************************************\nFile \"/scratch/mabshoff/sage-4.0.rc1/devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py\", line 2647:\n    sage: y.diff().reduce_fast()\nExpected:\n    (y, (0, 0))\nGot:\n    (y*1, (0, 0))\n**********************************************************************\n1 items had failures:\n   1 of  10 in __main__.example_50\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /scratch/mabshoff/sage-4.0.rc1/tmp/.doctest_monsky_washnitzer.py\n         [10.3 s]\nexit code: 1024\n```\n\nThoughts?\n\nCheers,\n\nMichael",
    "created_at": "2009-05-22T14:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51833",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
With this patch applied to my 4.0.rc1 merge tree I get one failure:

```
mabshoff@sage:/scratch/mabshoff/sage-4.0.rc1$ ./sage -t -long devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py
sage -t -long "devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py"
**********************************************************************
File "/scratch/mabshoff/sage-4.0.rc1/devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py", line 2647:
    sage: y.diff().reduce_fast()
Expected:
    (y, (0, 0))
Got:
    (y*1, (0, 0))
**********************************************************************
1 items had failures:
   1 of  10 in __main__.example_50
***Test Failed*** 1 failures.
For whitespace errors, see the file /scratch/mabshoff/sage-4.0.rc1/tmp/.doctest_monsky_washnitzer.py
         [10.3 s]
exit code: 1024
```

Thoughts?

Cheers,

Michael



---

archive/issue_comments_051834.json:
```json
{
    "body": "<a id='comment:9'></a>\nThinking about this for a minute: This is probably due to new symbolics, but I am still hesitant to merge this until the symbolics issue is resolved. Once it is the positive review should be reinstated.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-22T14:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51834",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:9'></a>
Thinking about this for a minute: This is probably due to new symbolics, but I am still hesitant to merge this until the symbolics issue is resolved. Once it is the positive review should be reinstated.

Cheers,

Michael



---

archive/issue_comments_051835.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis is unrelated to the new symbolics, and the doctest should be changed. (Here the results is an element of the special hyperelliptic quotient ring, which has sub-optimal but still correct printing for trivial elements.)",
    "created_at": "2009-05-22T19:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51835",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:10'></a>
This is unrelated to the new symbolics, and the doctest should be changed. (Here the results is an element of the special hyperelliptic quotient ring, which has sub-optimal but still correct printing for trivial elements.)



---

archive/issue_comments_051836.json:
```json
{
    "body": "<a id='comment:11'></a>\nAttachment [5948-v2.patch](tarball://root/attachments/some-uuid/ticket5948/5948-v2.patch) by @kedlaya created at 2009-05-22 20:48:44\n\nHere's a new patch adding the one-line fix to the doctest.",
    "created_at": "2009-05-22T20:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51836",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:11'></a>
Attachment [5948-v2.patch](tarball://root/attachments/some-uuid/ticket5948/5948-v2.patch) by @kedlaya created at 2009-05-22 20:48:44

Here's a new patch adding the one-line fix to the doctest.



---

archive/issue_comments_051837.json:
```json
{
    "body": "<a id='comment:12'></a>\nLooks great!",
    "created_at": "2009-05-24T23:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51837",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:12'></a>
Looks great!



---

archive/issue_events_013937.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-06-01T05:33:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5948#event-13937"
}
```



---

archive/issue_comments_051838.json:
```json
{
    "body": "<a id='comment:13'></a>\nMerged in 4.0.1.alpha0.",
    "created_at": "2009-06-01T05:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51838",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:13'></a>
Merged in 4.0.1.alpha0.



---

archive/issue_comments_051839.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-06-01T05:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51839",
    "user": "https://github.com/mwhansen"
}
```

Resolution: fixed



---

archive/issue_comments_051840.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jen Balakrishnan\"",
    "created_at": "2009-06-06T22:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51840",
    "user": "https://github.com/mwhansen"
}
```

Changing reviewer from "" to "Jen Balakrishnan"



---

archive/issue_comments_051841.json:
```json
{
    "body": "Changing author from \"\" to \"Robert Bradshaw\"",
    "created_at": "2009-06-06T22:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51841",
    "user": "https://github.com/mwhansen"
}
```

Changing author from "" to "Robert Bradshaw"



---

archive/issue_comments_051842.json:
```json
{
    "body": "Changing merged from \"\" to \"alpha0\"",
    "created_at": "2009-06-06T22:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51842",
    "user": "https://github.com/mwhansen"
}
```

Changing merged from "" to "alpha0"



---

archive/issue_comments_051843.json:
```json
{
    "body": "Changing merged from \"alpha0\" to \"4.0.1.alpha0\"",
    "created_at": "2009-06-27T08:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5948#issuecomment-51843",
    "user": "https://github.com/loefflerd"
}
```

Changing merged from "alpha0" to "4.0.1.alpha0"
