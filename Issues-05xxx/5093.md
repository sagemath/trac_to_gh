# Issue 5093: rewrite fast_float to support more datatypes

archive/issues_005093.json:
```json
{
    "body": "I've mentioned several times over the past months that I'm rewriting fast_float.  Here's a preliminary patch, that shows the direction I'm taking (automatically generate interpreters for each type, by having Python code write C code).\n\nThis version replaces fast_float with the new code, and also adds a new entry point, fast_callable.\n\nfast_callable(EXPR, domain=R)\n\n(where EXPR is a symbolic expression or a polynomial) is essentially equivalent to evaluating EXPR with calls to R() at every node.  There's special fast support for domain=RDF or domain=RealField(n), and there's slowish generic code that should work for arbitrary R.\n\nThe code is not ready for submission... there are very few doctests, and a lot of the documentation is simply wrong.  But if anybody has any comments, I'd be happy to hear them.\n\n**Assignee:** cwitty\n\n**CC:**  @robertwb @jasongrout bober\n\nIssue created by migration from https://trac.sagemath.org/ticket/5093\n\n",
    "closed_at": "2009-03-25T06:24:30Z",
    "created_at": "2009-01-25T03:33:37Z",
    "labels": [
        "component: basic arithmetic",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.4.1",
    "title": "rewrite fast_float to support more datatypes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5093",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```
I've mentioned several times over the past months that I'm rewriting fast_float.  Here's a preliminary patch, that shows the direction I'm taking (automatically generate interpreters for each type, by having Python code write C code).

This version replaces fast_float with the new code, and also adds a new entry point, fast_callable.

fast_callable(EXPR, domain=R)

(where EXPR is a symbolic expression or a polynomial) is essentially equivalent to evaluating EXPR with calls to R() at every node.  There's special fast support for domain=RDF or domain=RealField(n), and there's slowish generic code that should work for arbitrary R.

The code is not ready for submission... there are very few doctests, and a lot of the documentation is simply wrong.  But if anybody has any comments, I'd be happy to hear them.

**Assignee:** cwitty

**CC:**  @robertwb @jasongrout bober

Issue created by migration from https://trac.sagemath.org/ticket/5093





---

archive/issue_comments_041316.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis looks very interesting, and much further reaching than the original fast_float code I mostly wrote on a plane ride home from DC. Wish I had time to review it.",
    "created_at": "2009-01-27T22:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41316",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:1'></a>
This looks very interesting, and much further reaching than the original fast_float code I mostly wrote on a plane ride home from DC. Wish I had time to review it.



---

archive/issue_comments_041317.json:
```json
{
    "body": "**Changing status** from new to assigned.",
    "created_at": "2009-02-24T02:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41317",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

**Changing status** from new to assigned.



---

archive/attachments_005709.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac5093-fast-callable.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket5093/trac5093-fast-callable.patch",
    "created_at": "2009-03-01T05:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```



---

archive/issue_comments_041318.json:
```json
{
    "body": "",
    "created_at": "2009-03-01T05:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41318",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```





---

archive/issue_comments_041319.json:
```json
{
    "body": "<a id='comment:3'></a>\nOK, I've put up a new patch which I think is ready for review.  The big feature here is support for multiple types -- we get accelerated evaluation over `RealField(k)` as well as RDF, and even the unaccelerated Python-object evaluator (which calls `PyNumber_Add` and friends) is still faster than the evaluators for multivariate and univariate polynomials over QQ.\n\nWe're also typically somewhat faster than the old fast_float, but often not by a lot.  (In the three benchmarks below, the speed gain ranges from 2% faster to more than 2x as fast.)  There's still a lot of optimization I can do.\n\nHere are the benchmark details:\n\n```\nsage: set_random_seed(0)\nsage: K.<x,y,z> = QQ[]\nsage: p = K.random_element(10, 20)\nsage: p_rr = p.change_ring(RR)\nsage: p_rdf = p.change_ring(RDF)\nsage: fp_old = fast_float(p, x, y, z, old=True)\nsage: fp_rdf = fast_callable(p, domain=RDF)\nsage: fp_rr = fast_callable(p, domain=RR)\nsage: fp_any = fast_callable(p)\nsage: \nsage: timeit('p(1,2,3)')\n625 loops, best of 3: 369 \u00b5s per loop\nsage: timeit('fp_any(1,2,3)')\n625 loops, best of 3: 115 \u00b5s per loop\nsage: \nsage: timeit('p(1.0,2.0,3.0)')\n625 loops, best of 3: 460 \u00b5s per loop\nsage: timeit('p_rr(1.0,2.0,3.0)')\n625 loops, best of 3: 341 \u00b5s per loop\nsage: timeit('fp_rr(1.0,2.0,3.0)')\n625 loops, best of 3: 121 \u00b5s per loop\nsage: \nsage: timeit('p(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 334 \u00b5s per loop\nsage: timeit('p_rdf(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 101 \u00b5s per loop\nsage: timeit('fp_old(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 4.27 \u00b5s per loop\nsage: timeit('fp_rdf(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 4.18 \u00b5s per loop\nsage: \nsage: set_random_seed(0)\nsage: K.<x> = QQ[]\nsage: p = K.random_element(20)\nsage: p_rr = p.change_ring(RR)\nsage: p_rdf = p.change_ring(RDF)\nsage: fp_old = fast_float(p, x, old=True)\nsage: fp_rdf = fast_callable(p, domain=RDF)\nsage: fp_rr = fast_callable(p, domain=RR)\nsage: fp_any = fast_callable(p)\nsage: \nsage: timeit('p(2)')\n625 loops, best of 3: 53.3 \u00b5s per loop\nsage: timeit('fp_any(2)')\n625 loops, best of 3: 37 \u00b5s per loop\nsage: \nsage: timeit('p(2.0)')\n625 loops, best of 3: 54.9 \u00b5s per loop\nsage: timeit('p_rr(2.0)')\n625 loops, best of 3: 5.76 \u00b5s per loop\nsage: timeit('fp_rr(2.0)')\n625 loops, best of 3: 7.8 \u00b5s per loop\nsage: \nsage: timeit('p(2.0r)')\n625 loops, best of 3: 153 \u00b5s per loop\nsage: timeit('p_rdf(2.0r)')\n625 loops, best of 3: 20.6 \u00b5s per loop\nsage: timeit('fp_old(2.0r)')\n625 loops, best of 3: 973 ns per loop\nsage: timeit('fp_rdf(2.0r)')\n625 loops, best of 3: 403 ns per loop\nsage: \nsage: var('x,y,z')\n(x, y, z)\nsage: v = sin(sqrt(x*x + y^3) + z/4) * (x+y+z^5)\nsage: fv_old = fast_float(v, x, y, z, old=True)\nsage: fv_rdf = fast_callable(v, domain=RDF)\nsage: fv_rr = fast_callable(v, domain=RR)\nsage: fv_any = fast_callable(v)\nsage: \nsage: timeit('v(x=1.0,y=2.0,z=3.0)')\n625 loops, best of 3: 438 \u00b5s per loop\nsage: timeit('fv_rr(1.0,2.0,3.0)')\n625 loops, best of 3: 35.5 \u00b5s per loop\nsage: \nsage: timeit('v(x=2.0r,y=2.0r,z=3.0r)')\n625 loops, best of 3: 400 \u00b5s per loop\nsage: timeit('fv_old(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 680 ns per loop\nsage: timeit('fv_rdf(1.0r,2.0r,3.0r)')\n625 loops, best of 3: 544 ns per loop\n```",
    "created_at": "2009-03-01T05:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41319",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:3'></a>
OK, I've put up a new patch which I think is ready for review.  The big feature here is support for multiple types -- we get accelerated evaluation over `RealField(k)` as well as RDF, and even the unaccelerated Python-object evaluator (which calls `PyNumber_Add` and friends) is still faster than the evaluators for multivariate and univariate polynomials over QQ.

We're also typically somewhat faster than the old fast_float, but often not by a lot.  (In the three benchmarks below, the speed gain ranges from 2% faster to more than 2x as fast.)  There's still a lot of optimization I can do.

Here are the benchmark details:

```
sage: set_random_seed(0)
sage: K.<x,y,z> = QQ[]
sage: p = K.random_element(10, 20)
sage: p_rr = p.change_ring(RR)
sage: p_rdf = p.change_ring(RDF)
sage: fp_old = fast_float(p, x, y, z, old=True)
sage: fp_rdf = fast_callable(p, domain=RDF)
sage: fp_rr = fast_callable(p, domain=RR)
sage: fp_any = fast_callable(p)
sage: 
sage: timeit('p(1,2,3)')
625 loops, best of 3: 369 µs per loop
sage: timeit('fp_any(1,2,3)')
625 loops, best of 3: 115 µs per loop
sage: 
sage: timeit('p(1.0,2.0,3.0)')
625 loops, best of 3: 460 µs per loop
sage: timeit('p_rr(1.0,2.0,3.0)')
625 loops, best of 3: 341 µs per loop
sage: timeit('fp_rr(1.0,2.0,3.0)')
625 loops, best of 3: 121 µs per loop
sage: 
sage: timeit('p(1.0r,2.0r,3.0r)')
625 loops, best of 3: 334 µs per loop
sage: timeit('p_rdf(1.0r,2.0r,3.0r)')
625 loops, best of 3: 101 µs per loop
sage: timeit('fp_old(1.0r,2.0r,3.0r)')
625 loops, best of 3: 4.27 µs per loop
sage: timeit('fp_rdf(1.0r,2.0r,3.0r)')
625 loops, best of 3: 4.18 µs per loop
sage: 
sage: set_random_seed(0)
sage: K.<x> = QQ[]
sage: p = K.random_element(20)
sage: p_rr = p.change_ring(RR)
sage: p_rdf = p.change_ring(RDF)
sage: fp_old = fast_float(p, x, old=True)
sage: fp_rdf = fast_callable(p, domain=RDF)
sage: fp_rr = fast_callable(p, domain=RR)
sage: fp_any = fast_callable(p)
sage: 
sage: timeit('p(2)')
625 loops, best of 3: 53.3 µs per loop
sage: timeit('fp_any(2)')
625 loops, best of 3: 37 µs per loop
sage: 
sage: timeit('p(2.0)')
625 loops, best of 3: 54.9 µs per loop
sage: timeit('p_rr(2.0)')
625 loops, best of 3: 5.76 µs per loop
sage: timeit('fp_rr(2.0)')
625 loops, best of 3: 7.8 µs per loop
sage: 
sage: timeit('p(2.0r)')
625 loops, best of 3: 153 µs per loop
sage: timeit('p_rdf(2.0r)')
625 loops, best of 3: 20.6 µs per loop
sage: timeit('fp_old(2.0r)')
625 loops, best of 3: 973 ns per loop
sage: timeit('fp_rdf(2.0r)')
625 loops, best of 3: 403 ns per loop
sage: 
sage: var('x,y,z')
(x, y, z)
sage: v = sin(sqrt(x*x + y^3) + z/4) * (x+y+z^5)
sage: fv_old = fast_float(v, x, y, z, old=True)
sage: fv_rdf = fast_callable(v, domain=RDF)
sage: fv_rr = fast_callable(v, domain=RR)
sage: fv_any = fast_callable(v)
sage: 
sage: timeit('v(x=1.0,y=2.0,z=3.0)')
625 loops, best of 3: 438 µs per loop
sage: timeit('fv_rr(1.0,2.0,3.0)')
625 loops, best of 3: 35.5 µs per loop
sage: 
sage: timeit('v(x=2.0r,y=2.0r,z=3.0r)')
625 loops, best of 3: 400 µs per loop
sage: timeit('fv_old(1.0r,2.0r,3.0r)')
625 loops, best of 3: 680 ns per loop
sage: timeit('fv_rdf(1.0r,2.0r,3.0r)')
625 loops, best of 3: 544 ns per loop
```



---

archive/issue_events_014872.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "rename": {
        "from": "[with preliminary patch, request comments] rewrite fast_float to support more datatypes",
        "to": "rewrite fast_float to support more datatypes"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5093#event-14872"
}
```



---

archive/issue_comments_041320.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2009-03-01T05:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41320",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

**Changing status** from new to needs_review.



---

archive/issue_events_014873.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/cwitty",
    "created_at": "2009-03-01T05:39:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5093#event-14873"
}
```



---

archive/issue_comments_041321.json:
```json
{
    "body": "<a id='comment:8'></a>\nIs anyone looking at reviewing this ticket?  Lots of people are getting emailed about updates, so apparently there is interest :).\n\nI think it could probably benefit from more than one pair of eyes since it is a major rewrite of a very key piece of functionality.  I might be able to look at at least some of it next week.  Who's with me? :)",
    "created_at": "2009-03-12T23:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41321",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:8'></a>
Is anyone looking at reviewing this ticket?  Lots of people are getting emailed about updates, so apparently there is interest :).

I think it could probably benefit from more than one pair of eyes since it is a major rewrite of a very key piece of functionality.  I might be able to look at at least some of it next week.  Who's with me? :)



---

archive/issue_comments_041322.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'll be happy to help out too. Should we set a time to get together on IRC?",
    "created_at": "2009-03-12T23:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41322",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:9'></a>
I'll be happy to help out too. Should we set a time to get together on IRC?



---

archive/issue_comments_041323.json:
```json
{
    "body": "<a id='comment:10'></a>\nrobertwb: would Monday morning work for you?",
    "created_at": "2009-03-13T17:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41323",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:10'></a>
robertwb: would Monday morning work for you?



---

archive/issue_comments_041324.json:
```json
{
    "body": "<a id='comment:11'></a>\ncwitty says that only the second patch should be applied.",
    "created_at": "2009-03-13T17:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41324",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:11'></a>
cwitty says that only the second patch should be applied.



---

archive/issue_comments_041325.json:
```json
{
    "body": "<a id='comment:12'></a>\n#5413 also affects this ticket...",
    "created_at": "2009-03-13T19:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41325",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:12'></a>
#5413 also affects this ticket...



---

archive/issue_comments_041326.json:
```json
{
    "body": "<a id='comment:13'></a>\n(I mean, *should* affect this patch.)",
    "created_at": "2009-03-13T19:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41326",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:13'></a>
(I mean, *should* affect this patch.)



---

archive/issue_comments_041327.json:
```json
{
    "body": "<a id='comment:14'></a>\nSure, Monday morning would work for me (not too early though...)",
    "created_at": "2009-03-14T01:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41327",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:14'></a>
Sure, Monday morning would work for me (not too early though...)



---

archive/issue_comments_041328.json:
```json
{
    "body": "<a id='comment:15'></a>\nI'm having troubles with the domain option:\n\n```\nipdb> sincospart2\n0.031415926535897932384626433832795028841971693993751058209749445923078164062862090?*u^2 + 128.81577077269348875442992085907054992836460260571058901270931143326149871242219?*u - 903.2497758091134199678561412713008059118088312456679249412429028830613210260356?\nipdb> sincospart2.parent()\nMultivariate Polynomial Ring in u over Real Interval Field with 268 bits of precision\n\nipdb> fast_callable(sincospart2)(-1)\n-1032.0341306552710107899014356965385608113314621573847628957424648703997415743949?\nipdb> fast_callable(sincospart2, domain=sincospart2.base_ring())(-1)\n[.. NaN ..]\n\nipdb> p sincospart2.dumps()\n'x\\x9c\\x9dSmO\\xd4@\\x10\\xf6PA\\n\\x02\\x82\\x08\\xa8\\xc8\\x8a\\xa7\\xde\\x05hzpo\\x184|\\xf0%\\xe6 \\x9a\\x8b\\xfd\\xa4\\xb2\\xd9\\xb6\\xdb\\xeer\\xdb\\x97i\\xb7\\r\\xa8\\x97\\xe8\\x074\\xfe^\\xff\\x80\\xdb\\xe38\\xce\\x0f&\\xca\\x97\\xcd\\xec\\xcc<\\xcf<;;\\xf3u\\xc4N\\x88G\\xf5\\x98\\x07^\\xa2G\\xa18\\x0eB\\x9f\\x13\\xa1\\xfb\\xa9\\x90\\x1c\\x9f;0\\x15\\xd4\\xa7\\x81\\xd4\\xf6\\xdf\\x9e\\xfb\\xf2\\xb0\\xc3m\\xa9A\\xa1\\xfc\\r\\xfe\\x99*\\xcf\\xc0\\x1e\\rh\\xccm-\\r\"nw\\x04\\xc5C\\xc4\\xed\\xa1\\x04\\x9cU4\\xb8\\\\\\x1a\\xe6\\x8e\\xa9\"\\xf1#\\x97k\\x18\\xdb\\xea\")\\xc6m\\xe5{\\x1dH\\x1agD\\xbc\\xe4T88\\xa3q\\xc2\\xc3\\xc0\\xd0\\xe0\\xca\\xfed\\xe1\\xe7\\xf76\\\\m\\x15\\xccBz\\x02\\xa3\\x7f\\x11\\xaa\\xd0>\\x0ec\\x87\\xc6\\xda;e\\xbe\\xe9Y0\\xa6\\x9ev\\xad\\x0b\\xe3%s\\x11\\x0f\\xdc\\x18\\'\\n\\x9d\\n\\x12\\xe3D\\xc6\\xa0\\x99#N\\x04\\x13\\xe6\\xccpF@|\\n\\x93\\xe6\\xb8C\\xbd\\x98f\\x82\\x1e\\xc1us\\x0cc\\'\\xb41\\x86)\\xf3\\x97\\xf6<\\x0fP\\xa4\\x82J*E*\\x83\\xdb\\xa1\\x17\\x93\\x88q\\x1b\\x95\\x06\\xb02\\xca\\x85\\xa1\\x9e0UT\\xd7\\xb4=*QQ\\xc5KG\\x07\\xa4\\x8c\\x9e\"\\x82\\r\\xb4\\x86t]W\\'\\xc1\\x9f\\x83\\x8dJw\\xbd\\x88$\\xa3\\x01*\\xaa\\x14\\xb4\\x83\\x8e\\x0e,\\xb4\\xf3\\xf4\\x19\\x1a\\x80v\\xfa\\xa6U.*fm\\x98\\xed<@\\x02\\x07\\x15?(Y\\x89L> C1 \\xae\\x90\\xc1\\x93\\xb3**\\xdb\\xea\\xd7\\xcb\\xcb\\xaf\\xe7~\\xbev\\xe6\\xcf\\xad\\xdc\\xc5\\xd13u\\xe5zQ\\x83isi\\xb8E>\\xb1\\x89j\\xe2\\xf1f\\xaf\\x8b3\\xe6\\xd8\\xab6\\xcd\\xf6T\\xa7n\\x98\\xb3\\xc3y\\x82\\x06\\x9ed0\\xab>p\\xd4\\x12\\xa1\\xddI`\\x8e\\xe5\\x1fs\\xb3\\x0b\\xf3%\\xa6\\xb1\\t\\xf6G\\xa3o\\xb1)6\\xcdf\\xd8\\r\\xa6 l\\xael\\xce\\xffY\\xd5\\xf3I\\xaf\\xe2\\x829\\xbe\\xda\\xc7\\xac\\xc2bj\\x9d\\xc0\\x12[`\\xca\\x90m\\xb8\\xdd\\x85;\\xe6\\xf2\\xf0X\\x9e\\xed\\x00>3\\xe0\\xee_&i\\xb0\\x18>\\xe9P\\x9c3<\\xef\\xad\\xc9r\\x17\\xee\\x95\\xfe\\t\\xf3\\xe2]\\x1a\\t\\xaa\\xc1J\\xb7UP\\xa3\\x8b\\xfe{\\xfe_\\xf4\\xb5\\x9e\\xaf\\xc1}v\\xd5\\xfc\\xf2~#\\xd1\\x1b\\x8d,\\xecH;\\x8e\\xac\\x0e\\xa7\\xd6\\xa1\\xbb%\\x03\\xe0n\\xdc\\x14\\xec\\x90\\x1f\\x92\\x86\\xbbE\\xea\\xb4\\x11n\\xd6\\x9a$ lS$\\xbcaEUc\\xb7\\xa2\\xbe\\x18]\\x0c\\x1e\\x1a\\n\\xfe\\xb1\\x85~\\xb4a\\x95\\xadt\\xe1A\\xebR\\xab\\x90\\xf4^Vd\\xb9\\xaeO\\xef\\xab\\xba\\x01[V\\xad#\\xa9\\xb1\\xed\\xdb\\xf6v\\x85Vi5\\xdc\\xce8\\xa4\\xae\\x1bZ\\x95&\\x87\\x8a\\xdc\\xce`3r\\x1c+\\xad\\xd4\\x84\\xeb\\xd6S?\\xed\\xcb\\xba\\x10:\\xa8\\x0eT=\\xccU=R\\xaaFNU=f\\xa7\\xdd\\xaa\\xe8F\\xcd\\xc9x\\xd3\\xe2\\xb4N\\xeb\\x91\\xd1\\x902\\xde\\xf2|\\x11\\xb9U\\x03\\x1a\\xb1\\xa8\\xd6\\xa2\\xcc\\xf3,;\\x12P\\xb7djd^\\x95\\xc8\\x0eo\\xeen\\xf4d]\\x0c~h(\\xf8\\xa9\\xaeRz\\xd2\\x86r\\xf2\\xdd\\xd2\\x7f\\x03\\xd6\\r\\xef\\xde'\n```\n\nPerhaps that loads/dumps string can help.",
    "created_at": "2009-03-17T00:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41328",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:15'></a>
I'm having troubles with the domain option:

```
ipdb> sincospart2
0.031415926535897932384626433832795028841971693993751058209749445923078164062862090?*u^2 + 128.81577077269348875442992085907054992836460260571058901270931143326149871242219?*u - 903.2497758091134199678561412713008059118088312456679249412429028830613210260356?
ipdb> sincospart2.parent()
Multivariate Polynomial Ring in u over Real Interval Field with 268 bits of precision

ipdb> fast_callable(sincospart2)(-1)
-1032.0341306552710107899014356965385608113314621573847628957424648703997415743949?
ipdb> fast_callable(sincospart2, domain=sincospart2.base_ring())(-1)
[.. NaN ..]

ipdb> p sincospart2.dumps()
'x\x9c\x9dSmO\xd4@\x10\xf6PA\n\x02\x82\x08\xa8\xc8\x8a\xa7\xde\x05hzpo\x184|\xf0%\xe6 \x9a\x8b\xfd\xa4\xb2\xd9\xb6\xdb\xeer\xdb\x97i\xb7\r\xa8\x97\xe8\x074\xfe^\xff\x80\xdb\xe38\xce\x0f&\xca\x97\xcd\xec\xcc<\xcf<;;\xf3u\xc4N\x88G\xf5\x98\x07^\xa2G\xa18\x0eB\x9f\x13\xa1\xfb\xa9\x90\x1c\x9f;0\x15\xd4\xa7\x81\xd4\xf6\xdf\x9e\xfb\xf2\xb0\xc3m\xa9A\xa1\xfc\r\xfe\x99*\xcf\xc0\x1e\rh\xccm-\r"nw\x04\xc5C\xc4\xed\xa1\x04\x9cU4\xb8\\\x1a\xe6\x8e\xa9"\xf1#\x97k\x18\xdb\xea")\xc6m\xe5{\x1dH\x1agD\xbc\xe4T88\xa3q\xc2\xc3\xc0\xd0\xe0\xca\xfed\xe1\xe7\xf76\\m\x15\xccBz\x02\xa3\x7f\x11\xaa\xd0>\x0ec\x87\xc6\xda;e\xbe\xe9Y0\xa6\x9ev\xad\x0b\xe3%s\x11\x0f\xdc\x18\'\n\x9d\n\x12\xe3D\xc6\xa0\x99#N\x04\x13\xe6\xccpF@|\n\x93\xe6\xb8C\xbd\x98f\x82\x1e\xc1us\x0cc\'\xb41\x86)\xf3\x97\xf6<\x0fP\xa4\x82J*E*\x83\xdb\xa1\x17\x93\x88q\x1b\x95\x06\xb02\xca\x85\xa1\x9e0UT\xd7\xb4=*QQ\xc5KG\x07\xa4\x8c\x9e"\x82\r\xb4\x86t]W\'\xc1\x9f\x83\x8dJw\xbd\x88$\xa3\x01*\xaa\x14\xb4\x83\x8e\x0e,\xb4\xf3\xf4\x19\x1a\x80v\xfa\xa6U.*fm\x98\xed<@\x02\x07\x15?(Y\x89L> C1 \xae\x90\xc1\x93\xb3**\xdb\xea\xd7\xcb\xcb\xaf\xe7~\xbev\xe6\xcf\xad\xdc\xc5\xd13u\xe5zQ\x83isi\xb8E>\xb1\x89j\xe2\xf1f\xaf\x8b3\xe6\xd8\xab6\xcd\xf6T\xa7n\x98\xb3\xc3y\x82\x06\x9ed0\xab>p\xd4\x12\xa1\xddI`\x8e\xe5\x1fs\xb3\x0b\xf3%\xa6\xb1\t\xf6G\xa3o\xb1)6\xcdf\xd8\r\xa6 l\xael\xce\xffY\xd5\xf3I\xaf\xe2\x829\xbe\xda\xc7\xac\xc2bj\x9d\xc0\x12[`\xca\x90m\xb8\xdd\x85;\xe6\xf2\xf0X\x9e\xed\x00>3\xe0\xee_&i\xb0\x18>\xe9P\x9c3<\xef\xad\xc9r\x17\xee\x95\xfe\t\xf3\xe2]\x1a\t\xaa\xc1J\xb7UP\xa3\x8b\xfe{\xfe_\xf4\xb5\x9e\xaf\xc1}v\xd5\xfc\xf2~#\xd1\x1b\x8d,\xecH;\x8e\xac\x0e\xa7\xd6\xa1\xbb%\x03\xe0n\xdc\x14\xec\x90\x1f\x92\x86\xbbE\xea\xb4\x11n\xd6\x9a$ lS$\xbcaEUc\xb7\xa2\xbe\x18]\x0c\x1e\x1a\n\xfe\xb1\x85~\xb4a\x95\xadt\xe1A\xebR\xab\x90\xf4^Vd\xb9\xaeO\xef\xab\xba\x01[V\xad#\xa9\xb1\xed\xdb\xf6v\x85Vi5\xdc\xce8\xa4\xae\x1bZ\x95&\x87\x8a\xdc\xce`3r\x1c+\xad\xd4\x84\xeb\xd6S?\xed\xcb\xba\x10:\xa8\x0eT=\xccU=R\xaaFNU=f\xa7\xdd\xaa\xe8F\xcd\xc9x\xd3\xe2\xb4N\xeb\x91\xd1\x902\xde\xf2|\x11\xb9U\x03\x1a\xb1\xa8\xd6\xa2\xcc\xf3,;\x12P\xb7djd^\x95\xc8\x0eo\xeen\xf4d]\x0c~h(\xf8\xa9\xaeRz\xd2\x86r\xf2\xdd\xd2\x7f\x03\xd6\r\xef\xde'
```

Perhaps that loads/dumps string can help.



---

archive/issue_comments_041329.json:
```json
{
    "body": "<a id='comment:16'></a>\nOK, this is due to a missing feature in fast_callable.  I intended to fix things so that domain=... would not affect integral exponents (and actually documented this intention as fact), but didn't actually implement it.\n\nSo the failure is caused from:\n\n```\nsage: RIF(-1)^RIF(1)\n[.. NaN ..]\n```\n\nwhich happens because RIF exponentiation for an exponent that is not an Integer is based on .log()/.exp(), and .log() of a negative RIF is NaN.\n\nThe two easy workarounds are:\n\n1) don't use domain=... (it will probably only slow things down for you anyway; it's useful if there is a specialized interpreter for your type, but RIF doesn't have one yet)\n\n2) use sincospart2.univariate_polynomial() instead; fast_callable for univariate polynomials uses Horner's rule, so it doesn't use exponentiation at all.  This will be faster, too.\n\n(BTW, why do you have a multivariate polynomial ring in one variable?)",
    "created_at": "2009-03-17T00:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41329",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:16'></a>
OK, this is due to a missing feature in fast_callable.  I intended to fix things so that domain=... would not affect integral exponents (and actually documented this intention as fact), but didn't actually implement it.

So the failure is caused from:

```
sage: RIF(-1)^RIF(1)
[.. NaN ..]
```

which happens because RIF exponentiation for an exponent that is not an Integer is based on .log()/.exp(), and .log() of a negative RIF is NaN.

The two easy workarounds are:

1) don't use domain=... (it will probably only slow things down for you anyway; it's useful if there is a specialized interpreter for your type, but RIF doesn't have one yet)

2) use sincospart2.univariate_polynomial() instead; fast_callable for univariate polynomials uses Horner's rule, so it doesn't use exponentiation at all.  This will be faster, too.

(BTW, why do you have a multivariate polynomial ring in one variable?)



---

archive/issue_comments_041330.json:
```json
{
    "body": "<a id='comment:17'></a>\nShouldn't this work?\n\n```\nsage: fast_callable(0,domain=RDF)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/home/jason/.sage/temp/littleone/22491/_home_jason__sage_init_sage_0.py in <module>()\n\n/home/jason/sage/local/lib/python2.5/site-packages/sage/ext/fast_callable.so in sage.ext.fast_callable.fast_callable (sage/ext/fast_callable.c:2350)()\n\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'variables'\nsage: fast_callable(0,vars=('x'),domain=RDF)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/home/jason/.sage/temp/littleone/22491/_home_jason__sage_init_sage_0.py in <module>()\n\n/home/jason/sage/local/lib/python2.5/site-packages/sage/ext/fast_callable.so in sage.ext.fast_callable.fast_callable (sage/ext/fast_callable.c:2569)()\n\nAttributeError: 'sage.rings.integer.Integer' object has no attribute '_fast_callable_'\n```",
    "created_at": "2009-03-17T02:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41330",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:17'></a>
Shouldn't this work?

```
sage: fast_callable(0,domain=RDF)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/jason/.sage/temp/littleone/22491/_home_jason__sage_init_sage_0.py in <module>()

/home/jason/sage/local/lib/python2.5/site-packages/sage/ext/fast_callable.so in sage.ext.fast_callable.fast_callable (sage/ext/fast_callable.c:2350)()

AttributeError: 'sage.rings.integer.Integer' object has no attribute 'variables'
sage: fast_callable(0,vars=('x'),domain=RDF)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/jason/.sage/temp/littleone/22491/_home_jason__sage_init_sage_0.py in <module>()

/home/jason/sage/local/lib/python2.5/site-packages/sage/ext/fast_callable.so in sage.ext.fast_callable.fast_callable (sage/ext/fast_callable.c:2569)()

AttributeError: 'sage.rings.integer.Integer' object has no attribute '_fast_callable_'
```



---

archive/issue_comments_041331.json:
```json
{
    "body": "<a id='comment:18'></a>\nFor Jason Grout, the problems I'm having with types and zero:\n\n```\nipdb> p sincospart2\n0\nipdb> p type(sincospart2)\n<class 'sage.rings.polynomial.multi_polynomial_element.MPolynomial_polydict'>\nipdb> p sincospart2.parent()\nMultivariate Polynomial Ring in u over Real Interval Field with 268 bits of precision\nipdb> fast_callable(sincospart2)(-1)\n0\nipdb> type(fast_callable(sincospart2)(-1))\n<type 'int'>\nipdb> (sincospart2)(-1)\n0\nipdb> type((sincospart2)(-1))\n<type 'sage.rings.real_mpfi.RealIntervalFieldElement'>\nipdb> dumps(sincospart2)\n'x\\x9c\\x8dSMo\\xd3@\\x10U\\n4d[\\xda\\xb4\\xa5\\xb4\\x05\\n\\xab\\xca\\x87D-V\\xca\\x11\\xa5=U D+\\x90\\xc5\\xde\\xaa\\xae\\xd6\\xf6\\xe0]\\xc5^gl\\'J\\x85\"\\xc1!\\x95\\xf8\\xbd\\xfc\\x01\\xc6Q>\\xdcC%.\\xd6\\xec\\x9b\\xf7\\xde\\x8cgw~\\xad\\x04\\xb9\\x8a\\xc0\\xcd\\x8c\\x8dr\\xb7\\x9f\\xc6\\xb76M\\x8c\\x8a\\xddd\\x10\\x17F.\\x01\\t1$`\\x0bv\\xf5m\\x89\\x95\\xe9\\xd0\\x04\\x05\\xc3Z\\xfb7\\xfe\\xb7U\\xc9\\x90\\x11X\\xc8L\\xc0\\x06\\xb6o\\x82^\\x0c\\xb2b\\xecU\\x08rx\\xca\\xf0Q\\xab\\xea\\x9d\\x01\\x99$\\xfd\\x1f\\x86I\\x19\\xd0\\xa1\\x00)=\\xc2>\\xdb\\x02\\xb2\\xa1\\x8a?\\x1a\\x88C9\\x84,7\\xa9\\xed0||\\xb5^\\xfbs\\xe7\\xe1\\x93/5Q\\x1bLp\\xf5\\x81FI\\x9d\\xc84\\x0b!c\\xdf)\\xfc:\\x8d\\xb0N\\xbf\\xf6t\\x8c\\x8d\\x96\\xd8\\x97\\x0bX\\xca\\x9c\\xd4\\x83Xe2/2db%\\xec\\xe3\\x9ahV\\x19V%\\x80\\xeb\\xa2\\x11B\\x94\\xc10\\x86\\x11>\\x13u)\\xc34\\x90\\x127\\xc4_vQ&\\x80S\\x92Z\\x05N\\x0c\\x13\\xa4Q\\xa6\\xfa\\xda\\x04\\xbc\\xb5\\x90\\xb5y\\xd9\\x18\\x9f6FE]\\xc6.\\xa1\\xe0\\x0e\\xe5[\\xa3\\x1b\\xd5\\xe6g\\\\\\xc9\\x0e?\\xe6\\xae\\xeb\\xd2W\\xc9\\x9f\\xf6\\xdd\\xe9\\xf8\\xc4\\xe1\\x85\\x06\\xcb\\x1d\\xa2\\xf0.\\x1f\\xdd\\xf8\\xbc{v\\xce\\x17\\xa2\\xee,\\xf4\\xdb\\x0e9\\xb3\\xaa\\xdb2\\xa1l\\xc8\\x9dkj+/\\xf2k\\xde!\\x07nHi?\\xcc\\xab\\x10\\xdb\\x9f\\xd5+\\xcb\\x9f\\x94\\xb89\\x9e\\xe3eTB\\x86\\x9f\\xd3\\xd1\\xb8\\x0e\\xc3MqP\\x1dQ\\xa2\\x02EC\\xbc}?\\x9dbS\\xd4?y0\\xbc\\xa4Im\\x89\\xed*/\\x06\\x1b\\x15\\x1a\\xb7\\xe9\\x02W\\xfd8\\rz9\\xee\\xe8\\xf2b\\x9e\\x8fq\\xb7\\xa5\\x99^\\xd3\\xf7\\x06\\xfdBo\\xe8M\\xdd\\xd4[\\x9a$z\\xa7-v\\xefW\\x8d\\x125\\xad\\xb8\\'\\x1aG3\\xcd\\x11\\xee\\x0f\\xfc\\t\\x1e\\xe8=MA\\xe1\\xe1\\xcb1\\xbe\\x12\\x87\\xd5g9\\xdf\\x019\\x0f\\xf0\\xf5\\x03/i\\xb1\\x18\\x89\\xea\\x81,\\x1d.\\xa6kr8\\xc67\\x13\\x0f\\xdf\\xe6w\\xbe\\xfb\\x0f\\x14^3!'\n```",
    "created_at": "2009-03-17T02:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41331",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:18'></a>
For Jason Grout, the problems I'm having with types and zero:

```
ipdb> p sincospart2
0
ipdb> p type(sincospart2)
<class 'sage.rings.polynomial.multi_polynomial_element.MPolynomial_polydict'>
ipdb> p sincospart2.parent()
Multivariate Polynomial Ring in u over Real Interval Field with 268 bits of precision
ipdb> fast_callable(sincospart2)(-1)
0
ipdb> type(fast_callable(sincospart2)(-1))
<type 'int'>
ipdb> (sincospart2)(-1)
0
ipdb> type((sincospart2)(-1))
<type 'sage.rings.real_mpfi.RealIntervalFieldElement'>
ipdb> dumps(sincospart2)
'x\x9c\x8dSMo\xd3@\x10U\n4d[\xda\xb4\xa5\xb4\x05\n\xab\xca\x87D-V\xca\x11\xa5=U D+\x90\xc5\xde\xaa\xae\xd6\xf6\xe0]\xc5^gl\'J\x85"\xc1!\x95\xf8\xbd\xfc\x01\xc6Q>\xdcC%.\xd6\xec\x9b\xf7\xde\x8cgw~\xad\x04\xb9\x8a\xc0\xcd\x8c\x8dr\xb7\x9f\xc6\xb76M\x8c\x8a\xddd\x10\x17F.\x01\t1$`\x0bv\xf5m\x89\x95\xe9\xd0\x04\x05\xc3Z\xfb7\xfe\xb7U\xc9\x90\x11X\xc8L\xc0\x06\xb6o\x82^\x0c\xb2b\xecU\x08rx\xca\xf0Q\xab\xea\x9d\x01\x99$\xfd\x1f\x86I\x19\xd0\xa1\x00)=\xc2>\xdb\x02\xb2\xa1\x8a?\x1a\x88C9\x84,7\xa9\xed0||\xb5^\xfbs\xe7\xe1\x93/5Q\x1bLp\xf5\x81FI\x9d\xc84\x0b!c\xdf)\xfc:\x8d\xb0N\xbf\xf6t\x8c\x8d\x96\xd8\x97\x0bX\xca\x9c\xd4\x83Xe2/2db%\xec\xe3\x9ahV\x19V%\x80\xeb\xa2\x11B\x94\xc10\x86\x11>\x13u)\xc34\x90\x127\xc4_vQ&\x80S\x92Z\x05N\x0c\x13\xa4Q\xa6\xfa\xda\x04\xbc\xb5\x90\xb5y\xd9\x18\x9f6FE]\xc6.\xa1\xe0\x0e\xe5[\xa3\x1b\xd5\xe6g\\\xc9\x0e?\xe6\xae\xeb\xd2W\xc9\x9f\xf6\xdd\xe9\xf8\xc4\xe1\x85\x06\xcb\x1d\xa2\xf0.\x1f\xdd\xf8\xbc{v\xce\x17\xa2\xee,\xf4\xdb\x0e9\xb3\xaa\xdb2\xa1l\xc8\x9dkj+/\xf2k\xde!\x07nHi?\xcc\xab\x10\xdb\x9f\xd5+\xcb\x9f\x94\xb89\x9e\xe3eTB\x86\x9f\xd3\xd1\xb8\x0e\xc3MqP\x1dQ\xa2\x02EC\xbc}?\x9dbS\xd4?y0\xbc\xa4Im\x89\xed*/\x06\x1b\x15\x1a\xb7\xe9\x02W\xfd8\rz9\xee\xe8\xf2b\x9e\x8fq\xb7\xa5\x99^\xd3\xf7\x06\xfdBo\xe8M\xdd\xd4[\x9a$z\xa7-v\xefW\x8d\x125\xad\xb8\'\x1aG3\xcd\x11\xee\x0f\xfc\t\x1e\xe8=MA\xe1\xe1\xcb1\xbe\x12\x87\xd5g9\xdf\x019\x0f\xf0\xf5\x03/i\xb1\x18\x89\xea\x81,\x1d.\xa6kr8\xc67\x13\x0f\xdf\xe6w\xbe\xfb\x0f\x14^3!'
```



---

archive/issue_comments_041332.json:
```json
{
    "body": "<a id='comment:19'></a>\nOK, I can't fix this so that fast_callable matches the behavior of multivariate polynomials while keeping my code generic, because Singular-based polynomials return values of their base_ring in this case and polydict polynomials return values with the same parent as their first argument (falling back to the base ring if the argument has no parent).\n\n```\nK.<x,y> = QQ[]\ntype(K(0)(0, 0))\ntype(K(0)(0r, 0r))\ntype(K(0)(RIF(0), RIF(0)))\ntype(K(0)(0.0, 0.0))\nK.<x,y> = RIF[]\ntype(K(0)(0, 0))\ntype(K(0)(0r, 0r))\ntype(K(0)(RIF(0), RIF(0)))\ntype(K(0)(0.0, 0.0))\n```\nMy plan is to use the former behavior for all multivariate polynomials, so it won't exactly match polydict polynomials; is that good enough?  (That's much easier to implement.)",
    "created_at": "2009-03-17T03:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41332",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:19'></a>
OK, I can't fix this so that fast_callable matches the behavior of multivariate polynomials while keeping my code generic, because Singular-based polynomials return values of their base_ring in this case and polydict polynomials return values with the same parent as their first argument (falling back to the base ring if the argument has no parent).

```
K.<x,y> = QQ[]
type(K(0)(0, 0))
type(K(0)(0r, 0r))
type(K(0)(RIF(0), RIF(0)))
type(K(0)(0.0, 0.0))
K.<x,y> = RIF[]
type(K(0)(0, 0))
type(K(0)(0r, 0r))
type(K(0)(RIF(0), RIF(0)))
type(K(0)(0.0, 0.0))
```
My plan is to use the former behavior for all multivariate polynomials, so it won't exactly match polydict polynomials; is that good enough?  (That's much easier to implement.)



---

archive/issue_comments_041333.json:
```json
{
    "body": "<a id='comment:20'></a>\nI've ready most of the patch, it looks really good, and works on all my examples. I'm still digesting it all... One comment I have is that \n\n```\nsage: from sage.ext.fast_callable import ExpressionTreeBuilder\nsage: etb = ExpressionTreeBuilder(vars=['x','y'])\nsage:  etb.var('z')\nTraceback (most recent call last):\n  File \"<ipython console>\", line 1, in <module>\n  File \"fast_callable.pyx\", line 555, in sage.ext.fast_callable.ExpressionTreeBuilder.var (sage/ext/fast_callable.c:3720)\nValueError: list.index(x): x not in list\n```\n\ncould have a better error. \n\nSomething else that would be really nice is an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not. \n\nFor elements, we can use the `_xxx_` arithmetic operators, skipping coercion. Also, PY_TYPE_CHECK(x, Element) is potentially slow--it would be nice to have a \"generic\" element of the domain so you can do \"type(x) == type(generic_element) or PY_TYPE_CHECK(x, Element). But perhaps this is optimization for a later day.",
    "created_at": "2009-03-17T06:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41333",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:20'></a>
I've ready most of the patch, it looks really good, and works on all my examples. I'm still digesting it all... One comment I have is that 

```
sage: from sage.ext.fast_callable import ExpressionTreeBuilder
sage: etb = ExpressionTreeBuilder(vars=['x','y'])
sage:  etb.var('z')
Traceback (most recent call last):
  File "<ipython console>", line 1, in <module>
  File "fast_callable.pyx", line 555, in sage.ext.fast_callable.ExpressionTreeBuilder.var (sage/ext/fast_callable.c:3720)
ValueError: list.index(x): x not in list
```

could have a better error. 

Something else that would be really nice is an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not. 

For elements, we can use the `_xxx_` arithmetic operators, skipping coercion. Also, PY_TYPE_CHECK(x, Element) is potentially slow--it would be nice to have a "generic" element of the domain so you can do "type(x) == type(generic_element) or PY_TYPE_CHECK(x, Element). But perhaps this is optimization for a later day.



---

archive/issue_comments_041334.json:
```json
{
    "body": "<a id='comment:21'></a>\n*Something else that would be really nice is an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not.*\n\nAny suggestions for syntax for this?  I'm coming up with things like (..., domain=RIF, ignore_domain_if_no_specialized_interpreter_exists=True), which seems cumbersome :) (I'm probably being too picky about being precise in my parameter names).\n\nI've vaguely planned to use `_xxx_` arithmetic, but didn't do it for this version because I don't know how to call Cython methods from C.  Help would be appreciated :)\n\nThe type(x)==type(generic_element) is a good idea.  I'll implement it eventually.  (Then if I could access the _parent field from C, probably almost all of the element interpreter slowdown would be gone; in conjunction with `_xxx_` arithmetic, it might actually be faster than the generic Python interpreter.)",
    "created_at": "2009-03-17T15:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41334",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:21'></a>
*Something else that would be really nice is an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not.*

Any suggestions for syntax for this?  I'm coming up with things like (..., domain=RIF, ignore_domain_if_no_specialized_interpreter_exists=True), which seems cumbersome :) (I'm probably being too picky about being precise in my parameter names).

I've vaguely planned to use `_xxx_` arithmetic, but didn't do it for this version because I don't know how to call Cython methods from C.  Help would be appreciated :)

The type(x)==type(generic_element) is a good idea.  I'll implement it eventually.  (Then if I could access the _parent field from C, probably almost all of the element interpreter slowdown would be gone; in conjunction with `_xxx_` arithmetic, it might actually be faster than the generic Python interpreter.)



---

archive/issue_comments_041335.json:
```json
{
    "body": "<a id='comment:22'></a>\nI've attached a patch (fast-callable-cleanup.patch, to be applied after trac5093-fast-callable.patch) that fixes many of the issues raised, including everything I considered to be a serious bug.\n\nFixed:\n\n* fast_callable functions with domain=RDF used to return a Python float; now they correctly return an element of RDF.  (If you want a Python float, you can now use domain=float; this is the default for fast_float.)\n\n* Power expressions with constant integer exponents are handled specially; this fixes Nick's problem with RIF expressions returning NaN (and probably lots of other problems).\n\n* fast_callable of a zero multivariate polynomial now returns a zero in the base ring, instead of a Python int 0.\n\n* some docstrings in sphinxified files were not sphinxified\n\n* misc documentation typos/minor rewording\n\nNot fixed:\n\n* Robert's suggestion: *an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not* (I don't mind the idea, and the implementation is easy; what should the syntax be?  Part of my problem picking a syntax is that I don't want to promise that a specialized interpreter is always faster than the Python-object interpreter, so I don't particularly want to use the word \"fast\" in any option names.)\n\n* fast_callable on list,tuple,vector,matrix arguments\n\n* any interaction with #5413 (my plan is to wait until either #5093 or #5413 gets a positive review, then fix the other one to match)\n\n* fast_callable on constant arguments (waiting for a spec from Jason!)\n\n* fast_callable of a zero multivariate polynomial returns a zero of the base ring, without paying attention to the types of the arguments\n\nI'm hoping the reviewers will agree that the unfixed issues can wait until later.",
    "created_at": "2009-03-18T15:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41335",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:22'></a>
I've attached a patch (fast-callable-cleanup.patch, to be applied after trac5093-fast-callable.patch) that fixes many of the issues raised, including everything I considered to be a serious bug.

Fixed:

* fast_callable functions with domain=RDF used to return a Python float; now they correctly return an element of RDF.  (If you want a Python float, you can now use domain=float; this is the default for fast_float.)

* Power expressions with constant integer exponents are handled specially; this fixes Nick's problem with RIF expressions returning NaN (and probably lots of other problems).

* fast_callable of a zero multivariate polynomial now returns a zero in the base ring, instead of a Python int 0.

* some docstrings in sphinxified files were not sphinxified

* misc documentation typos/minor rewording

Not fixed:

* Robert's suggestion: *an option that uses a fast domain, if it's there, but ignores the domain parameter if it's not* (I don't mind the idea, and the implementation is easy; what should the syntax be?  Part of my problem picking a syntax is that I don't want to promise that a specialized interpreter is always faster than the Python-object interpreter, so I don't particularly want to use the word "fast" in any option names.)

* fast_callable on list,tuple,vector,matrix arguments

* any interaction with #5413 (my plan is to wait until either #5093 or #5413 gets a positive review, then fix the other one to match)

* fast_callable on constant arguments (waiting for a spec from Jason!)

* fast_callable of a zero multivariate polynomial returns a zero of the base ring, without paying attention to the types of the arguments

I'm hoping the reviewers will agree that the unfixed issues can wait until later.



---

archive/attachments_005710.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac5093-fast-callable-cleanup.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket5093/trac5093-fast-callable-cleanup.patch",
    "created_at": "2009-03-18T17:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```



---

archive/issue_comments_041336.json:
```json
{
    "body": "",
    "created_at": "2009-03-18T17:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41336",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```





---

archive/issue_comments_041337.json:
```json
{
    "body": "<a id='comment:23'></a>\nfast-callable-cleanup.patch had issues (I got confused from developing on two different machines, and based it on the wrong version).  So I deleted it, and posted trac5093-fast-callable-cleanup.patch to replace it.  (Thanks to Jason for pointing out the problem!)",
    "created_at": "2009-03-18T17:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41337",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:23'></a>
fast-callable-cleanup.patch had issues (I got confused from developing on two different machines, and based it on the wrong version).  So I deleted it, and posted trac5093-fast-callable-cleanup.patch to replace it.  (Thanks to Jason for pointing out the problem!)



---

archive/issue_comments_041338.json:
```json
{
    "body": "<a id='comment:24'></a>\nWith the cleanup patch, I am finding the following doctest error:\n\n```\n-*- mode: sage-test; default-directory: \"~/sage-3.4.rc0/devel/sage-main/sage/ext/\" -*-\nsage-test started at Wed Mar 18 12:43:18\n\n/Users/ncalexan/bin/sage -b >/dev/null && /Users/ncalexan/bin/sage -tp 4 /Users/ncalexan/sage-3.4.rc0/devel/sage-main/sage/ext/fast_callable.pyx\n\nreal\t0m1.816s\nuser\t0m1.313s\nsys\t0m0.493s\nGlobal iterations: 1\nFile iterations: 1\nUsing cached timings.\nDoctesting 1 files doing 4 jobs in parallel\nsage -t  fast_callable.pyx\n**********************************************************************\nFile \"/Users/ncalexan/sage-3.4.rc0/devel/sage-main/sage/ext/fast_callable.pyx\", line 1570:\n    sage: fc(-3)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: math domain error\nGot:\n    nan\n**********************************************************************\n1 items had failures:\n   1 of  90 in __main__.example_55\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /Users/ncalexan/sage-3.4.rc0/tmp/.doctest_fast_callable.py\n\t [6.3 s]\n \n----------------------------------------------------------------------\n\nThe following tests failed:\n\n\tsage -t  devel/sage-main/sage/ext/fast_callable.pyx # 1 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 6.4 seconds\n\nsage-test finished (all test passed) at Wed Mar 18 12:43:26\n```",
    "created_at": "2009-03-18T19:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41338",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:24'></a>
With the cleanup patch, I am finding the following doctest error:

```
-*- mode: sage-test; default-directory: "~/sage-3.4.rc0/devel/sage-main/sage/ext/" -*-
sage-test started at Wed Mar 18 12:43:18

/Users/ncalexan/bin/sage -b >/dev/null && /Users/ncalexan/bin/sage -tp 4 /Users/ncalexan/sage-3.4.rc0/devel/sage-main/sage/ext/fast_callable.pyx

real	0m1.816s
user	0m1.313s
sys	0m0.493s
Global iterations: 1
File iterations: 1
Using cached timings.
Doctesting 1 files doing 4 jobs in parallel
sage -t  fast_callable.pyx
**********************************************************************
File "/Users/ncalexan/sage-3.4.rc0/devel/sage-main/sage/ext/fast_callable.pyx", line 1570:
    sage: fc(-3)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: math domain error
Got:
    nan
**********************************************************************
1 items had failures:
   1 of  90 in __main__.example_55
***Test Failed*** 1 failures.
For whitespace errors, see the file /Users/ncalexan/sage-3.4.rc0/tmp/.doctest_fast_callable.py
	 [6.3 s]
 
----------------------------------------------------------------------

The following tests failed:

	sage -t  devel/sage-main/sage/ext/fast_callable.pyx # 1 doctests failed
----------------------------------------------------------------------
Total time for all tests: 6.4 seconds

sage-test finished (all test passed) at Wed Mar 18 12:43:26
```



---

archive/issue_comments_041339.json:
```json
{
    "body": "<a id='comment:25'></a>\nI think your list of unfixed issues are fine postponing 'till later, though perhaps we should open followup tickets for them.",
    "created_at": "2009-03-18T20:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41339",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:25'></a>
I think your list of unfixed issues are fine postponing 'till later, though perhaps we should open followup tickets for them.



---

archive/attachments_005711.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac5093-fast-callable-api.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket5093/trac5093-fast-callable-api.patch",
    "created_at": "2009-03-19T04:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```



---

archive/issue_comments_041340.json:
```json
{
    "body": "",
    "created_at": "2009-03-19T04:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41340",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```





---

archive/issue_comments_041341.json:
```json
{
    "body": "<a id='comment:26'></a>\nOne more patch (hopefully the last for this ticket).  I changed my mind about whether to incorporate #5413-style deprecation; if I make sure the functionality is disabled at the start, then I don't have to worry about \"deprecation\" later.  (And if we decide we actually do want some of this functionality, it can safely be added later without backward-compatibility worries.)\n\nThis also hopefully fixes Nick's OSX doctest failure.",
    "created_at": "2009-03-19T04:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41341",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:26'></a>
One more patch (hopefully the last for this ticket).  I changed my mind about whether to incorporate #5413-style deprecation; if I make sure the functionality is disabled at the start, then I don't have to worry about "deprecation" later.  (And if we decide we actually do want some of this functionality, it can safely be added later without backward-compatibility worries.)

This also hopefully fixes Nick's OSX doctest failure.



---

archive/issue_comments_041342.json:
```json
{
    "body": "<a id='comment:27'></a>\nI agree with merging this now, and addressing the above list of unfixed things in other tickets.  I give this positive review based on the following.\n\n* I've spent a fair amount of time browsing the code and trying examples.\n* Some design issues raised are being addressed in other tickets\n* The current fast_float is falling back to the old implementation for non-implemented features (e.g., arbitrary callables, integers, etc.)\n* This thing is being doctested all over the place.  Nearly every plotting command is calling it through fast_float, as well as a lot of other code.  Doctests in plot/*.py, plot3d/*.py[x] and fast_callable.pyx all pass for me on Ubuntu 32-bit and run in roughly the same time as before the patch (so no serious speed regressions).\n* Carl generally writes very good code and is very responsive to fix issues if they crop up.\n* The code is very well documented and doctested\n* We will have some time before the next release in which to hammer this code with a lot more people to expose any other issues.\n\nSo with that, positive review!  However, it'd be great if robertwb and ncalexan, at least, could give their approval.",
    "created_at": "2009-03-19T22:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41342",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:27'></a>
I agree with merging this now, and addressing the above list of unfixed things in other tickets.  I give this positive review based on the following.

* I've spent a fair amount of time browsing the code and trying examples.
* Some design issues raised are being addressed in other tickets
* The current fast_float is falling back to the old implementation for non-implemented features (e.g., arbitrary callables, integers, etc.)
* This thing is being doctested all over the place.  Nearly every plotting command is calling it through fast_float, as well as a lot of other code.  Doctests in plot/*.py, plot3d/*.py[x] and fast_callable.pyx all pass for me on Ubuntu 32-bit and run in roughly the same time as before the patch (so no serious speed regressions).
* Carl generally writes very good code and is very responsive to fix issues if they crop up.
* The code is very well documented and doctested
* We will have some time before the next release in which to hammer this code with a lot more people to expose any other issues.

So with that, positive review!  However, it'd be great if robertwb and ncalexan, at least, could give their approval.



---

archive/issue_comments_041343.json:
```json
{
    "body": "<a id='comment:28'></a>\nokay, if at least one of robertwb or ncalexan also gives this a positive review, please change the title of the ticket to reflect it (unless you want further review)",
    "created_at": "2009-03-19T22:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41343",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:28'></a>
okay, if at least one of robertwb or ncalexan also gives this a positive review, please change the title of the ticket to reflect it (unless you want further review)



---

archive/issue_comments_041344.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2009-03-19T23:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41344",
    "user": "https://github.com/robertwb"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_041345.json:
```json
{
    "body": "<a id='comment:29'></a>\nI am of the same opinion--I have also read most of the code and tried a lot of things and it works great for me. \n\nFollowup at #5572.",
    "created_at": "2009-03-19T23:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41345",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:29'></a>
I am of the same opinion--I have also read most of the code and tried a lot of things and it works great for me. 

Followup at #5572.



---

archive/issue_comments_041346.json:
```json
{
    "body": "<a id='comment:30'></a>\nLate to the party, but I agree -- merge now.  I have used it for computing Riemann theta functions and it works well for me.",
    "created_at": "2009-03-20T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41346",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:30'></a>
Late to the party, but I agree -- merge now.  I have used it for computing Riemann theta functions and it works well for me.



---

archive/issue_comments_041347.json:
```json
{
    "body": "<a id='comment:31'></a>\ncwitty: could you specify which patches to apply and in what order?",
    "created_at": "2009-03-24T21:53:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41347",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:31'></a>
cwitty: could you specify which patches to apply and in what order?



---

archive/issue_comments_041348.json:
```json
{
    "body": "<a id='comment:32'></a>\nI've deleted the obsolete preliminary patch, so: apply all three posted patches, in the order posted.",
    "created_at": "2009-03-24T22:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41348",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:32'></a>
I've deleted the obsolete preliminary patch, so: apply all three posted patches, in the order posted.



---

archive/issue_comments_041349.json:
```json
{
    "body": "<a id='comment:33'></a>\nMerged all three patches in Sage 3.4.1.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-03-25T06:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5093#issuecomment-41349",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:33'></a>
Merged all three patches in Sage 3.4.1.alpha0.

Cheers,

Michael



---

archive/issue_events_014874.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-25T06:24:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5093#event-14874"
}
```



---

archive/issue_events_014875.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-25T06:24:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5093#event-14875"
}
```



---

archive/issue_events_014876.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-25T06:24:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5093",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5093#event-14876"
}
```
