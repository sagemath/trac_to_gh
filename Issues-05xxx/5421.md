# Issue 5421: Speedup is_isomorphic

archive/issues_005421.json:
```json
{
    "body": "Based on the thread at\n\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/1e3928bc2bffe9a6?pli=1\n\nseveral speedups have been implemented:\n\n1. Graphs which can be switched to `c_graph` are automatically switched before isomorphism testing (see thread).\n\n2. Several cheap imports have been moved to module level.\n\n3. One unnecessary step was removed.\n\nBenchmark: Take a list of all isomorphism classes of graphs on 7 vertices. Take one representative from each, and test each unordered pair for isomorphism. With underlying `c_graph` implementation, previously was 31.11 seconds, is now 10.71 seconds.\n\nThis patch also enables the `implementation` syntax in the graph generators.\n\n**Assignee:** @rlmill\n\n**CC:**  @mwhansen\n\nIssue created by migration from https://trac.sagemath.org/ticket/5421\n\n",
    "closed_at": "2009-03-08T06:52:58Z",
    "created_at": "2009-03-02T18:36:52Z",
    "labels": [
        "component: graph theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.4",
    "title": "Speedup is_isomorphic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5421",
    "user": "https://github.com/rlmill"
}
```
Based on the thread at

http://groups.google.com/group/sage-devel/browse_thread/thread/1e3928bc2bffe9a6?pli=1

several speedups have been implemented:

1. Graphs which can be switched to `c_graph` are automatically switched before isomorphism testing (see thread).

2. Several cheap imports have been moved to module level.

3. One unnecessary step was removed.

Benchmark: Take a list of all isomorphism classes of graphs on 7 vertices. Take one representative from each, and test each unordered pair for isomorphism. With underlying `c_graph` implementation, previously was 31.11 seconds, is now 10.71 seconds.

This patch also enables the `implementation` syntax in the graph generators.

**Assignee:** @rlmill

**CC:**  @mwhansen

Issue created by migration from https://trac.sagemath.org/ticket/5421





---

archive/issue_comments_035673.json:
```json
{
    "body": "**Description changed:**\n``````diff\n\n``````\n",
    "created_at": "2009-03-02T18:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35673",
    "user": "https://github.com/rlmill"
}
```

**Description changed:**
``````diff

``````




---

archive/issue_comments_035674.json:
```json
{
    "body": "<a id='comment:2'></a>\nOne comment: note the deletion of the step checking whether the sorted degree sequences are the same. This is now an intrinsic part of the algorithm used for isomorphism checking, so this is redundant effort.",
    "created_at": "2009-03-02T18:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35674",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:2'></a>
One comment: note the deletion of the step checking whether the sorted degree sequences are the same. This is now an intrinsic part of the algorithm used for isomorphism checking, so this is redundant effort.



---

archive/issue_events_034710.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-03-02T19:26:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34710"
}
```



---

archive/issue_comments_035675.json:
```json
{
    "body": "<a id='comment:4'></a>\nNote: this is a patch based on Sage-3.3, so the documentation is still pre-reST",
    "created_at": "2009-03-02T19:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35675",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:4'></a>
Note: this is a patch based on Sage-3.3, so the documentation is still pre-reST



---

archive/issue_events_034711.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-02T19:59:13Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "rename": {
        "from": "Speedup is_isomorphic",
        "to": "[needs rebase] Speedup is_isomorphic"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34711"
}
```



---

archive/issue_comments_035676.json:
```json
{
    "body": "<a id='comment:5'></a>\nYep, the patch definitely needs a rebase:\n\n```\nmabshoff@sage:/scratch/mabshoff/sage-3.4.alpha1/devel/sage$ patch -p1 --dry-run < trac_5421.patch \npatching file sage/graphs/graph.py\nHunk #1 succeeded at 335 (offset 70 lines).\nHunk #2 succeeded at 7587 (offset 664 lines).\npatching file sage/graphs/graph_generators.py\nHunk #1 FAILED at 242.\nHunk #2 FAILED at 258.\nHunk #3 succeeded at 3111 with fuzz 2 (offset 308 lines).\nHunk #4 FAILED at 3143.\nHunk #5 succeeded at 3199 (offset 325 lines).\nHunk #6 FAILED at 3324.\nHunk #7 FAILED at 3338.\nHunk #8 succeeded at 3660 with fuzz 2 (offset 386 lines).\nHunk #9 FAILED at 3686.\nHunk #10 succeeded at 3739 with fuzz 1 (offset 403 lines).\nHunk #11 succeeded at 3870 (offset 419 lines).\nHunk #12 succeeded at 3894 (offset 419 lines).\nHunk #13 succeeded at 3907 (offset 419 lines).\nHunk #14 succeeded at 3952 with fuzz 1 (offset 421 lines).\nHunk #15 succeeded at 4092 (offset 434 lines).\nHunk #16 succeeded at 4111 (offset 434 lines).\n6 out of 16 hunks FAILED -- saving rejects to file sage/graphs/graph_generators.py.rej\n```\n\nCheers,\n\nMichael",
    "created_at": "2009-03-02T19:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35676",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:5'></a>
Yep, the patch definitely needs a rebase:

```
mabshoff@sage:/scratch/mabshoff/sage-3.4.alpha1/devel/sage$ patch -p1 --dry-run < trac_5421.patch 
patching file sage/graphs/graph.py
Hunk #1 succeeded at 335 (offset 70 lines).
Hunk #2 succeeded at 7587 (offset 664 lines).
patching file sage/graphs/graph_generators.py
Hunk #1 FAILED at 242.
Hunk #2 FAILED at 258.
Hunk #3 succeeded at 3111 with fuzz 2 (offset 308 lines).
Hunk #4 FAILED at 3143.
Hunk #5 succeeded at 3199 (offset 325 lines).
Hunk #6 FAILED at 3324.
Hunk #7 FAILED at 3338.
Hunk #8 succeeded at 3660 with fuzz 2 (offset 386 lines).
Hunk #9 FAILED at 3686.
Hunk #10 succeeded at 3739 with fuzz 1 (offset 403 lines).
Hunk #11 succeeded at 3870 (offset 419 lines).
Hunk #12 succeeded at 3894 (offset 419 lines).
Hunk #13 succeeded at 3907 (offset 419 lines).
Hunk #14 succeeded at 3952 with fuzz 1 (offset 421 lines).
Hunk #15 succeeded at 4092 (offset 434 lines).
Hunk #16 succeeded at 4111 (offset 434 lines).
6 out of 16 hunks FAILED -- saving rejects to file sage/graphs/graph_generators.py.rej
```

Cheers,

Michael



---

archive/issue_events_034712.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-03-02T20:18:49Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "rename": {
        "from": "[needs rebase] Speedup is_isomorphic",
        "to": "Speedup is_isomorphic"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34712"
}
```



---

archive/attachments_006127.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_5421.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket5421/trac_5421.patch",
    "created_at": "2009-03-02T20:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/rlmill"
}
```



---

archive/issue_comments_035677.json:
```json
{
    "body": "<a id='comment:6'></a>\nI rebased the patch to 3.4.alpha0, but I don't have a built copy yet, so I couldn't test. But I'm pretty sure it should work. What could go wrong?",
    "created_at": "2009-03-02T20:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35677",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:6'></a>
I rebased the patch to 3.4.alpha0, but I don't have a built copy yet, so I couldn't test. But I'm pretty sure it should work. What could go wrong?



---

archive/issue_comments_035678.json:
```json
{
    "body": "<a id='comment:7'></a>\nOne doctest failure:\n\n```\nmabshoff@sage:/scratch/mabshoff/sage-3.4.alpha1$ ./sage -t -long devel/sage/sage/combinat/words/suffix_trees.py\nsage -t -long \"devel/sage/sage/combinat/words/suffix_trees.py\"\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.alpha1/devel/sage/sage/combinat/words/suffix_trees.py\", line 1263:\n    sage: t.uncompactify().is_isomorphic(s.to_digraph())\nException raised:\n    Traceback (most recent call last):\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_38[6]>\", line 1, in <module>\n        t.uncompactify().is_isomorphic(s.to_digraph())###line 1263:\n    sage: t.uncompactify().is_isomorphic(s.to_digraph())\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py\", line 7631, in is_isomorphic\n        G2 = G2.copy(implementation='c_graph')\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py\", line 707, in copy\n        G = DiGraph(self, name=self.name(), pos=copy(self._pos), boundary=copy(self._boundary), implementation=implementation, sparse=sparse)\n      File \"/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py\", line 9859, in __init__\n        self._backend.add_edge(u,v,l,True)\n      File \"sparse_graph.pyx\", line 1171, in sage.graphs.base.sparse_graph.SparseGraphBackend.add_edge (sage/graphs/base/sparse_graph.c:9597)\n      File \"sparse_graph.pyx\", line 515, in sage.graphs.base.sparse_graph.SparseGraph.add_arc_label (sage/graphs/base/sparse_graph.c:3980)\n    TypeError: an integer is required\n**********************************************************************\n1 items had failures:\n   1 of   7 in __main__.example_38\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /scratch/mabshoff/sage-3.4.alpha1/tmp/.doctest_suffix_trees.py\n         [2.9 s]\n```\n\nCheers,\n\nMichael",
    "created_at": "2009-03-02T23:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35678",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:7'></a>
One doctest failure:

```
mabshoff@sage:/scratch/mabshoff/sage-3.4.alpha1$ ./sage -t -long devel/sage/sage/combinat/words/suffix_trees.py
sage -t -long "devel/sage/sage/combinat/words/suffix_trees.py"
**********************************************************************
File "/scratch/mabshoff/sage-3.4.alpha1/devel/sage/sage/combinat/words/suffix_trees.py", line 1263:
    sage: t.uncompactify().is_isomorphic(s.to_digraph())
Exception raised:
    Traceback (most recent call last):
      File "/scratch/mabshoff/sage-3.4.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/scratch/mabshoff/sage-3.4.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/scratch/mabshoff/sage-3.4.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_38[6]>", line 1, in <module>
        t.uncompactify().is_isomorphic(s.to_digraph())###line 1263:
    sage: t.uncompactify().is_isomorphic(s.to_digraph())
      File "/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py", line 7631, in is_isomorphic
        G2 = G2.copy(implementation='c_graph')
      File "/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py", line 707, in copy
        G = DiGraph(self, name=self.name(), pos=copy(self._pos), boundary=copy(self._boundary), implementation=implementation, sparse=sparse)
      File "/scratch/mabshoff/sage-3.4.alpha1/local/lib/python2.5/site-packages/sage/graphs/graph.py", line 9859, in __init__
        self._backend.add_edge(u,v,l,True)
      File "sparse_graph.pyx", line 1171, in sage.graphs.base.sparse_graph.SparseGraphBackend.add_edge (sage/graphs/base/sparse_graph.c:9597)
      File "sparse_graph.pyx", line 515, in sage.graphs.base.sparse_graph.SparseGraph.add_arc_label (sage/graphs/base/sparse_graph.c:3980)
    TypeError: an integer is required
**********************************************************************
1 items had failures:
   1 of   7 in __main__.example_38
***Test Failed*** 1 failures.
For whitespace errors, see the file /scratch/mabshoff/sage-3.4.alpha1/tmp/.doctest_suffix_trees.py
         [2.9 s]
```

Cheers,

Michael



---

archive/issue_comments_035679.json:
```json
{
    "body": "<a id='comment:8'></a>\nLooks like that second patch is not ready yet...",
    "created_at": "2009-03-03T07:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35679",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:8'></a>
Looks like that second patch is not ready yet...



---

archive/issue_events_034713.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-03-03T07:23:22Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "rename": {
        "from": "Speedup is_isomorphic",
        "to": "[not ready] Speedup is_isomorphic"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34713"
}
```



---

archive/attachments_006128.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_5421-b.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket5421/trac_5421-b.patch",
    "created_at": "2009-03-04T20:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/rlmill"
}
```



---

archive/issue_comments_035680.json:
```json
{
    "body": "",
    "created_at": "2009-03-04T20:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35680",
    "user": "https://github.com/rlmill"
}
```





---

archive/issue_comments_035681.json:
```json
{
    "body": "<a id='comment:9'></a>\nI forgot one line in patch b, now all is well.",
    "created_at": "2009-03-04T20:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35681",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:9'></a>
I forgot one line in patch b, now all is well.



---

archive/issue_events_034714.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-03-04T20:03:22Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "rename": {
        "from": "[not ready] Speedup is_isomorphic",
        "to": "Speedup is_isomorphic"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34714"
}
```



---

archive/issue_comments_035682.json:
```json
{
    "body": "<a id='comment:10'></a>\nMike: Can you give this patch a review? \n\nCheers,\n\nMichael",
    "created_at": "2009-03-08T05:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35682",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>
Mike: Can you give this patch a review? 

Cheers,

Michael



---

archive/issue_comments_035683.json:
```json
{
    "body": "<a id='comment:11'></a>\nmabshoff has doctested.  I can't guarantee this speeds up {all,any} cases and I have only read over the modified code -- this is so deeply nested that I can only give a 3/4 thumbs up.",
    "created_at": "2009-03-08T06:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35683",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:11'></a>
mabshoff has doctested.  I can't guarantee this speeds up {all,any} cases and I have only read over the modified code -- this is so deeply nested that I can only give a 3/4 thumbs up.



---

archive/issue_events_034715.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-03-08T06:35:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34715"
}
```



---

archive/issue_events_034716.json:
```json
{
    "actor": "https://github.com/ncalexan",
    "created_at": "2009-03-08T06:35:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34716"
}
```



---

archive/issue_comments_035684.json:
```json
{
    "body": "<a id='comment:12'></a>\nMerged both patches in Sage 3.4.rc1.\n\nCheers,\n\nMichael",
    "created_at": "2009-03-08T06:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5421#issuecomment-35684",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Merged both patches in Sage 3.4.rc1.

Cheers,

Michael



---

archive/issue_events_034717.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-08T06:52:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34717"
}
```



---

archive/issue_events_034718.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-08T06:52:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34718"
}
```



---

archive/issue_events_034719.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-09T19:43:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34719"
}
```



---

archive/issue_events_034720.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-03-09T19:43:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5421",
    "milestone": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5421#event-34720"
}
```
