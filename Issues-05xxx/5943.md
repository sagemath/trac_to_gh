# Issue 5943: Sage 3.4.2.a0: len(prime_range(2^50)) segfaults

archive/issues_005943.json:
```json
{
    "body": "This ticket used to be about prime_pi() segfaulting, but due to a mixup of versions used and switching to a new algorithm in 3.4.2.a0 the cause is the following:\n\n```\nmabshoff@sage:/scratch/mabshoff/sage-3.4.2.final$ ./sage\n----------------------------------------------------------------------\n| Sage Version 3.4.2.rc0, Release Date: 2009-04-30                   |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: len(prime_range(2^50))\n/scratch/mabshoff/sage-3.4.2.final/local/bin/sage-sage: line 198: 13833 Segmentation fault      sage-ipython \"$@\" -i\n```\n\nAlex's comments are about the old ticket. This problem with wrong results has been moved to #5963.\n\nCheers,\n\nMichael\n\n---\n\nFixed in #11741.\n\n\n\n**Assignee:** @williamstein\n\n**CC:**  boothby @orlitzky\n\n**Reviewer:** Michael Orlitzky, Keshav Kini, Volker Braun\n\nIssue created by migration from https://trac.sagemath.org/ticket/5943\n\n",
    "closed_at": "2012-04-22T19:53:54Z",
    "created_at": "2009-04-29T22:45:19Z",
    "labels": [
        "component: number theory",
        "critical",
        "bug",
        "worksforme",
        "invalid"
    ],
    "title": "Sage 3.4.2.a0: len(prime_range(2^50)) segfaults",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/5943",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```
This ticket used to be about prime_pi() segfaulting, but due to a mixup of versions used and switching to a new algorithm in 3.4.2.a0 the cause is the following:

```
mabshoff@sage:/scratch/mabshoff/sage-3.4.2.final$ ./sage
----------------------------------------------------------------------
| Sage Version 3.4.2.rc0, Release Date: 2009-04-30                   |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: len(prime_range(2^50))
/scratch/mabshoff/sage-3.4.2.final/local/bin/sage-sage: line 198: 13833 Segmentation fault      sage-ipython "$@" -i
```

Alex's comments are about the old ticket. This problem with wrong results has been moved to #5963.

Cheers,

Michael

---

Fixed in #11741.



**Assignee:** @williamstein

**CC:**  boothby @orlitzky

**Reviewer:** Michael Orlitzky, Keshav Kini, Volker Braun

Issue created by migration from https://trac.sagemath.org/ticket/5943





---

archive/issue_comments_039795.json:
```json
{
    "body": "<a id='comment:1'></a>\nHmm, the back trace looks pretty bad:\n\n```\nmabshoff@sage:~$ sage -gdb\n----------------------------------------------------------------------\n| Sage Version 3.4.1, Release Date: 2009-04-21                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n/usr/local/sage/local/bin/sage-ipython\nGNU gdb 6.8-debian\nCopyright (C) 2008 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\"...\n[Thread debugging using libthread_db enabled]\nPython 2.5.2 (r252:60911, Mar 11 2009, 22:18:38) \n[GCC 4.2.4 (Ubuntu 4.2.4-1ubuntu3)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n[New Thread 0x7fe3285456e0 (LWP 11010)]\nsage: prime_pi(2^50)\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7fe3285456e0 (LWP 11010)]\n0x00007fe32776bf4e in ?? () from /lib/libc.so.6\n(gdb) bt\n#0  0x00007fe32776bf4e in ?? () from /lib/libc.so.6\n#1  0x00fc73d0eb623c9b in ?? ()\nCannot access memory at address 0xff0ff3d0eb624364\n(gdb) \n```",
    "created_at": "2009-04-29T22:48:16Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39795",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:1'></a>
Hmm, the back trace looks pretty bad:

```
mabshoff@sage:~$ sage -gdb
----------------------------------------------------------------------
| Sage Version 3.4.1, Release Date: 2009-04-21                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
/usr/local/sage/local/bin/sage-ipython
GNU gdb 6.8-debian
Copyright (C) 2008 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu"...
[Thread debugging using libthread_db enabled]
Python 2.5.2 (r252:60911, Mar 11 2009, 22:18:38) 
[GCC 4.2.4 (Ubuntu 4.2.4-1ubuntu3)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
[New Thread 0x7fe3285456e0 (LWP 11010)]
sage: prime_pi(2^50)

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fe3285456e0 (LWP 11010)]
0x00007fe32776bf4e in ?? () from /lib/libc.so.6
(gdb) bt
#0  0x00007fe32776bf4e in ?? () from /lib/libc.so.6
#1  0x00fc73d0eb623c9b in ?? ()
Cannot access memory at address 0xff0ff3d0eb624364
(gdb) 
```



---

archive/issue_comments_039796.json:
```json
{
    "body": "<a id='comment:2'></a>\nI can't get this to segfault.  I tried on sage.math and on my laptop (macbook running 32-bit archlinux).  The problem is that the two machines get different answers after a while (I hope the table is clear -- the last column is a function that's \"known\" to be a good approximation to prime_pi):\n\n```\nx     prime_pi(x) on sage.math     prime_pi(x) on my laptop     Li(x)-Li(sqrt(x))/2\n2^46   2280998753949                2280998753949               2.28099863535e+12\n2^47   4461632979717                4454203917918               4.46163280359e+12\n2^48   8731188863470                8612800813048               8.73118897751e+12\n2^49  17094432576778               15793194017311               1.70944327138e+13\n2^50  33483379603407               21969300962685               3.34833795774e+13\n```\n\nSo it seems that the problem starts somewhere between `2^46` and `2^47`, and that the sage.math output is most likely correct.",
    "created_at": "2009-05-02T11:15:04Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39796",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:2'></a>
I can't get this to segfault.  I tried on sage.math and on my laptop (macbook running 32-bit archlinux).  The problem is that the two machines get different answers after a while (I hope the table is clear -- the last column is a function that's "known" to be a good approximation to prime_pi):

```
x     prime_pi(x) on sage.math     prime_pi(x) on my laptop     Li(x)-Li(sqrt(x))/2
2^46   2280998753949                2280998753949               2.28099863535e+12
2^47   4461632979717                4454203917918               4.46163280359e+12
2^48   8731188863470                8612800813048               8.73118897751e+12
2^49  17094432576778               15793194017311               1.70944327138e+13
2^50  33483379603407               21969300962685               3.34833795774e+13
```

So it seems that the problem starts somewhere between `2^46` and `2^47`, and that the sage.math output is most likely correct.



---

archive/issue_events_038191.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-02T20:16:14Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "rename": {
        "from": "Sage 3.4.2.a0: prime_pi(2^50) segfaults",
        "to": "Sage 3.4.2.a0: len(prime_range(2^50)) segfaults"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38191"
}
```



---

archive/issue_comments_039797.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n-This is *bad*.\n+This ticket used to be about prime_pi() segfaulting, but due to a mixup of versions used and switching to a new algorithm in 3.4.2.a0 the cause is the following:\n+\n+```\n+mabshoff@sage:/scratch/mabshoff/sage-3.4.2.final$ ./sage\n+----------------------------------------------------------------------\n+| Sage Version 3.4.2.rc0, Release Date: 2009-04-30                   |\n+| Type notebook() for the GUI, and license() for information.        |\n+----------------------------------------------------------------------\n+sage: len(prime_range(2^50))\n+/scratch/mabshoff/sage-3.4.2.final/local/bin/sage-sage: line 198: 13833 Segmentation fault      sage-ipython \"$@\" -i\n+```\n+\n+Alex's comments are about the old ticket. This problem with wrong results has been moved to #5963.\n \n Cheers,\n \n``````\n",
    "created_at": "2009-05-02T20:16:14Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39797",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,16 @@
-This is *bad*.
+This ticket used to be about prime_pi() segfaulting, but due to a mixup of versions used and switching to a new algorithm in 3.4.2.a0 the cause is the following:
+
+```
+mabshoff@sage:/scratch/mabshoff/sage-3.4.2.final$ ./sage
+----------------------------------------------------------------------
+| Sage Version 3.4.2.rc0, Release Date: 2009-04-30                   |
+| Type notebook() for the GUI, and license() for information.        |
+----------------------------------------------------------------------
+sage: len(prime_range(2^50))
+/scratch/mabshoff/sage-3.4.2.final/local/bin/sage-sage: line 198: 13833 Segmentation fault      sage-ipython "$@" -i
+```
+
+Alex's comments are about the old ticket. This problem with wrong results has been moved to #5963.
 
 Cheers,
 
``````




---

archive/issue_comments_039798.json:
```json
{
    "body": "<a id='comment:4'></a>\nWe might want to either implement this ourselves or just put reasonable limit on this:\n\n```\nsage\" len(prime_range(2^35))\n/home/mabshoff/.sage/temp/sage.math.washington.edu/10069/_home_mabshoff__sage_init_sage_0.py in <module>()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/IPython/iplib.pyc in ipmagic(self, arg_s)\n    951         else:\n    952             magic_args = self.var_expand(magic_args,1)\n--> 953             return fn(magic_args)\n    954 \n    955     def ipalias(self,arg_s):\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/IPython/Magic.pyc in magic_time(self, parameter_s)\n   1905         if mode=='eval':\n   1906             st = clk()\n-> 1907             out = eval(code,glob)\n   1908             end = clk()\n   1909         else:\n\n/home/mabshoff/.sage/temp/sage.math.washington.edu/10069/_home_mabshoff__sage_init_sage_0.py in <module>()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3772)()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3458)()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.PariInstance.primes_up_to_n (sage/libs/pari/gen.c:40660)()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:44402)()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.PariInstance.allocatemem (sage/libs/pari/gen.c:40001)()\n\n/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.init_stack (sage/libs/pari/gen.c:43371)()\n\nMemoryError: Unable to allocate 131072000000 bytes memory for PARI.\n```",
    "created_at": "2009-05-03T00:29:40Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39798",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
We might want to either implement this ourselves or just put reasonable limit on this:

```
sage" len(prime_range(2^35))
/home/mabshoff/.sage/temp/sage.math.washington.edu/10069/_home_mabshoff__sage_init_sage_0.py in <module>()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/IPython/iplib.pyc in ipmagic(self, arg_s)
    951         else:
    952             magic_args = self.var_expand(magic_args,1)
--> 953             return fn(magic_args)
    954 
    955     def ipalias(self,arg_s):

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/IPython/Magic.pyc in magic_time(self, parameter_s)
   1905         if mode=='eval':
   1906             st = clk()
-> 1907             out = eval(code,glob)
   1908             end = clk()
   1909         else:

/home/mabshoff/.sage/temp/sage.math.washington.edu/10069/_home_mabshoff__sage_init_sage_0.py in <module>()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3772)()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3458)()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.PariInstance.primes_up_to_n (sage/libs/pari/gen.c:40660)()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:44402)()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.PariInstance.allocatemem (sage/libs/pari/gen.c:40001)()

/scratch/mabshoff/sage-3.4.2.final/local/lib/python2.5/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen.init_stack (sage/libs/pari/gen.c:43371)()

MemoryError: Unable to allocate 131072000000 bytes memory for PARI.
```



---

archive/issue_events_038192.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-06-15T23:28:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38192"
}
```



---

archive/issue_events_038193.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-06-15T23:28:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38193"
}
```



---

archive/issue_comments_039799.json:
```json
{
    "body": "<a id='comment:6'></a>\nI get now (in sage 4.2.1)\n\n```\nlen(prime_range(2^50))\n\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"_sage_input_4.py\", line 5, in <module>\n    len(prime_range(_sage_const_2 **_sage_const_50 ))\n  File \"\", line 1, in <module>\n    \n  File \"fast_arith.pyx\", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3822)\n  File \"fast_arith.pyx\", line 100, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3508)\n  File \"gen.pyx\", line 8663, in sage.libs.pari.gen.PariInstance.primes_up_to_n (sage/libs/pari/gen.c:41327)\nOverflowError: long int too large to convert to int\n```\n\nwhich is the same problem as #7017.",
    "created_at": "2009-12-03T14:49:34Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39799",
    "user": "https://github.com/categorie"
}
```

<a id='comment:6'></a>
I get now (in sage 4.2.1)

```
len(prime_range(2^50))

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_4.py", line 5, in <module>
    len(prime_range(_sage_const_2 **_sage_const_50 ))
  File "", line 1, in <module>
    
  File "fast_arith.pyx", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3822)
  File "fast_arith.pyx", line 100, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3508)
  File "gen.pyx", line 8663, in sage.libs.pari.gen.PariInstance.primes_up_to_n (sage/libs/pari/gen.c:41327)
OverflowError: long int too large to convert to int
```

which is the same problem as #7017.



---

archive/issue_comments_039800.json:
```json
{
    "body": "<a id='comment:7'></a>\nIn Sage 4.7.2.alpha3, I get the following:\n\n```\nsage: len(prime_range(2^50))\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n\n/home/keshav/<ipython console> in <module>()\n\n/home/keshav/sage/local/lib/python2.6/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4082)()\n\n/home/keshav/sage/local/lib/python2.6/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3717)()\n\n/home/keshav/sage/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47679)()\n\nPariError: not enough memory (28)\n```\n\nIs there something wrong with this, or should this ticket be closed?",
    "created_at": "2011-10-15T09:07:45Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39800",
    "user": "https://github.com/kini"
}
```

<a id='comment:7'></a>
In Sage 4.7.2.alpha3, I get the following:

```
sage: len(prime_range(2^50))
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)

/home/keshav/<ipython console> in <module>()

/home/keshav/sage/local/lib/python2.6/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4082)()

/home/keshav/sage/local/lib/python2.6/site-packages/sage/rings/fast_arith.so in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3717)()

/home/keshav/sage/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47679)()

PariError: not enough memory (28)
```

Is there something wrong with this, or should this ticket be closed?



---

archive/issue_comments_039801.json:
```json
{
    "body": "Patch doctesting the correct behaviour",
    "created_at": "2011-12-12T02:14:55Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39801",
    "user": "https://github.com/orlitzky"
}
```

Patch doctesting the correct behaviour



---

archive/attachments_007129.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage-trac_5943-doctest.patch",
    "asset_url": "tarball://root/attachments/ticket5943/sage-trac_5943-doctest.patch",
    "created_at": "2011-12-12T02:18:51Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch",
    "user": "https://github.com/orlitzky"
}
```



---

archive/issue_comments_039802.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Attachment:** [sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch)\n\nI think the current behavior is desirable given the alternatives.\nThe slower algorithm falls on its face just as hard if you choose an upper bound that will cause out-of-memory, so there's no sense in falling back to that after we catch the exception.",
    "created_at": "2011-12-12T02:18:51Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39802",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:8'></a>
**Attachment:** [sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch)

I think the current behavior is desirable given the alternatives.
The slower algorithm falls on its face just as hard if you choose an upper bound that will cause out-of-memory, so there's no sense in falling back to that after we catch the exception.



---

archive/issue_events_038194.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2011-12-12T02:18:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38194"
}
```



---

archive/issue_comments_039803.json:
```json
{
    "body": "**Author:** Michael Orlitzky",
    "created_at": "2011-12-12T02:29:33Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39803",
    "user": "https://github.com/kini"
}
```

**Author:** Michael Orlitzky



---

archive/issue_events_038195.json:
```json
{
    "actor": "https://github.com/kini",
    "created_at": "2011-12-12T02:29:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38195"
}
```



---

archive/issue_events_038196.json:
```json
{
    "actor": "https://github.com/kini",
    "created_at": "2011-12-12T02:29:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38196"
}
```



---

archive/issue_comments_039804.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,3 +15,7 @@\n Cheers,\n \n Michael\n+\n+---\n+\n+Apply [attachment:sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch) to `$SAGE_ROOT/devel/sage`.\n``````\n",
    "created_at": "2011-12-12T02:29:33Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39804",
    "user": "https://github.com/kini"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,3 +15,7 @@
 Cheers,
 
 Michael
+
+---
+
+Apply [attachment:sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch) to `$SAGE_ROOT/devel/sage`.
``````




---

archive/issue_comments_039805.json:
```json
{
    "body": "<a id='comment:9'></a>\nSounds good to me.",
    "created_at": "2011-12-12T02:29:33Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39805",
    "user": "https://github.com/kini"
}
```

<a id='comment:9'></a>
Sounds good to me.



---

archive/issue_comments_039806.json:
```json
{
    "body": "**Reviewer:** Keshav Kini",
    "created_at": "2011-12-12T02:29:33Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39806",
    "user": "https://github.com/kini"
}
```

**Reviewer:** Keshav Kini



---

archive/issue_events_038197.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-17T09:12:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38197"
}
```



---

archive/issue_events_038198.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-17T09:12:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38198"
}
```



---

archive/issue_comments_039807.json:
```json
{
    "body": "**Merged:** sage-4.8.alpha5",
    "created_at": "2011-12-17T09:12:40Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39807",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.8.alpha5



---

archive/issue_comments_039808.json:
```json
{
    "body": "**Changing merged** from \"sage-4.8.alpha5\" to \"\".",
    "created_at": "2011-12-21T09:18:30Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39808",
    "user": "https://github.com/jdemeyer"
}
```

**Changing merged** from "sage-4.8.alpha5" to "".



---

archive/issue_comments_039809.json:
```json
{
    "body": "<a id='comment:11'></a>\nOn hawk (OpenSolaris 06.2009-32):\n\n```\nsage -t -long  -force_lib devel/sage/sage/rings/fast_arith.pyx\n**********************************************************************\nFile \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/devel/sage-main/sage/rings/fast_arith.pyx\", line 122:\n    sage: prime_range(sys.maxint)\nExpected:\n    Traceback (most recent call last):\n    ...\n    PariError: not enough memory (28)\nGot:\n    Traceback (most recent call last):\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_1[16]>\", line 1, in <module>\n        prime_range(sys.maxint)###line 122:\n    sage: prime_range(sys.maxint)\n      File \"fast_arith.pyx\", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4149)\n        cpdef prime_range(start, stop=None, algorithm=\"pari_primes\", bint py_ints=False):\n      File \"fast_arith.pyx\", line 161, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3929)\n        res.append(z)\n    MemoryError\n**********************************************************************\n```",
    "created_at": "2011-12-21T09:18:30Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39809",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
On hawk (OpenSolaris 06.2009-32):

```
sage -t -long  -force_lib devel/sage/sage/rings/fast_arith.pyx
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/devel/sage-main/sage/rings/fast_arith.pyx", line 122:
    sage: prime_range(sys.maxint)
Expected:
    Traceback (most recent call last):
    ...
    PariError: not enough memory (28)
Got:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.8.alpha5/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_1[16]>", line 1, in <module>
        prime_range(sys.maxint)###line 122:
    sage: prime_range(sys.maxint)
      File "fast_arith.pyx", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4149)
        cpdef prime_range(start, stop=None, algorithm="pari_primes", bint py_ints=False):
      File "fast_arith.pyx", line 161, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3929)
        res.append(z)
    MemoryError
**********************************************************************
```



---

archive/issue_comments_039810.json:
```json
{
    "body": "<a id='comment:12'></a>\nHmm. For comparison, on x86_64, within a doctest:\n\n```\nExpected:\n    Traceback (most recent call last):\n    ...\n    PariError: not enough memory (28)\n    xyzzy\nGot:\n    Traceback (most recent call last):\n      File \"/opt/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/opt/sage-4.8.alpha4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/opt/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_1[16]>\", line 1, in <module>\n        prime_range(sys.maxint)###line 122:_sage_    >>> prime_range(sys.maxint)\n      File \"fast_arith.pyx\", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4149)\n      File \"fast_arith.pyx\", line 150, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3795)\n      File \"gen.pyx\", line 10262, in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:49373)\n    PariError: not enough memory (28)\n```\n\nWhat's `sys.maxint` on hawk? I don't have an account there. On my machine:\n\n```\nsage: sys.maxint\n9223372036854775807\n```\n\nMaybe the doctest should test a specific number to avoid vagaries of various platforms? Or maybe we should dig around in the code to find out why there are two different code paths that run out of memory in this operation with two different error messages.",
    "created_at": "2011-12-21T09:30:23Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39810",
    "user": "https://github.com/kini"
}
```

<a id='comment:12'></a>
Hmm. For comparison, on x86_64, within a doctest:

```
Expected:
    Traceback (most recent call last):
    ...
    PariError: not enough memory (28)
    xyzzy
Got:
    Traceback (most recent call last):
      File "/opt/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/opt/sage-4.8.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/opt/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_1[16]>", line 1, in <module>
        prime_range(sys.maxint)###line 122:_sage_    >>> prime_range(sys.maxint)
      File "fast_arith.pyx", line 56, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:4149)
      File "fast_arith.pyx", line 150, in sage.rings.fast_arith.prime_range (sage/rings/fast_arith.c:3795)
      File "gen.pyx", line 10262, in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:49373)
    PariError: not enough memory (28)
```

What's `sys.maxint` on hawk? I don't have an account there. On my machine:

```
sage: sys.maxint
9223372036854775807
```

Maybe the doctest should test a specific number to avoid vagaries of various platforms? Or maybe we should dig around in the code to find out why there are two different code paths that run out of memory in this operation with two different error messages.



---

archive/issue_comments_039811.json:
```json
{
    "body": "<a id='comment:13'></a>\nSorry, the sys.maxint was (apparently not so) carefully chosen to prevent an overflow error on 32-bit systems (see #11741 and #7017). My reasoning was that it should also be large enough to cause the not-enough-memory error on any 32-bit system, but I've been outsmarted.\n\nIt looks like Pari actually created a list of `(2^32 - 1)` primes? I think I still have an OpenSolaris VM somewhere I can test on.",
    "created_at": "2011-12-21T16:35:55Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39811",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>
Sorry, the sys.maxint was (apparently not so) carefully chosen to prevent an overflow error on 32-bit systems (see #11741 and #7017). My reasoning was that it should also be large enough to cause the not-enough-memory error on any 32-bit system, but I've been outsmarted.

It looks like Pari actually created a list of `(2^32 - 1)` primes? I think I still have an OpenSolaris VM somewhere I can test on.



---

archive/issue_comments_039812.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [kini](#comment%3A12):\n> What's `sys.maxint` on hawk? I don't have an account there.\n\n\n```\n sage: sys.maxint\n 2147483647\n sage: 2**31 -1\n 2147483647\n```",
    "created_at": "2011-12-22T12:40:33Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39812",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [kini](#comment%3A12):
> What's `sys.maxint` on hawk? I don't have an account there.


```
 sage: sys.maxint
 2147483647
 sage: 2**31 -1
 2147483647
```



---

archive/issue_comments_039813.json:
```json
{
    "body": "<a id='comment:15'></a>\nOn 32-bit machines with PAE and a lot of memory, `sys.maxint` is smaller than the number of primes that Pari can compute (and `sys.maxint` is the biggest one we can ask for without triggering the OverflowError). Trying to append those primes to a python list requires more memory than Pari does, so it's possible to get a MemoryError there.\n\nI think that trying to test for the not-enough-memory condition here on x32 is probably doomed. The patch for #11741 has the right idea: on 64-bit machines, we know that we can't compute close to `sys.maxint` primes regardless of how much memory is in the machine. On 32-bit machines, just sidestep the issue and cause a predictable failure.\n\nThe actual bug is still fixed: you get python errors instead of segfaults now. That leaves only the question of whether #11741 is a sufficient doctest.",
    "created_at": "2011-12-22T15:36:10Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39813",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>
On 32-bit machines with PAE and a lot of memory, `sys.maxint` is smaller than the number of primes that Pari can compute (and `sys.maxint` is the biggest one we can ask for without triggering the OverflowError). Trying to append those primes to a python list requires more memory than Pari does, so it's possible to get a MemoryError there.

I think that trying to test for the not-enough-memory condition here on x32 is probably doomed. The patch for #11741 has the right idea: on 64-bit machines, we know that we can't compute close to `sys.maxint` primes regardless of how much memory is in the machine. On 32-bit machines, just sidestep the issue and cause a predictable failure.

The actual bug is still fixed: you get python errors instead of segfaults now. That leaves only the question of whether #11741 is a sufficient doctest.



---

archive/issue_events_038199.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-04-19T16:39:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38199"
}
```



---

archive/issue_comments_039814.json:
```json
{
    "body": "<a id='comment:16'></a>\nMichael wrote on sage-devel: So if someone else agrees that the doctest in #11741 is sufficient, we can close #5943. (I don't have access to my trac account right now)",
    "created_at": "2012-04-19T16:39:55Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39814",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
Michael wrote on sage-devel: So if someone else agrees that the doctest in #11741 is sufficient, we can close #5943. (I don't have access to my trac account right now)



---

archive/issue_comments_039815.json:
```json
{
    "body": "**Changing reviewer** from \"Keshav Kini\" to \"Keshav Kini, Volker Braun\".",
    "created_at": "2012-04-19T16:41:37Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39815",
    "user": "https://github.com/vbraun"
}
```

**Changing reviewer** from "Keshav Kini" to "Keshav Kini, Volker Braun".



---

archive/issue_events_038200.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-04-19T16:41:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38200"
}
```



---

archive/issue_events_038201.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-04-19T16:41:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38201"
}
```



---

archive/issue_comments_039816.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -18,4 +18,6 @@\n \n ---\n \n-Apply [attachment:sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch) to `$SAGE_ROOT/devel/sage`.\n+Fixed in #11741.\n+\n+\n``````\n",
    "created_at": "2012-04-19T16:41:37Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39816",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -18,4 +18,6 @@
 
 ---
 
-Apply [attachment:sage-trac_5943-doctest.patch](https://github.com/sagemath/sage/files/ticket5943/sage-trac_5943-doctest.patch) to `$SAGE_ROOT/devel/sage`.
+Fixed in #11741.
+
+
``````




---

archive/issue_events_038202.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2012-04-19T16:55:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38202"
}
```



---

archive/issue_comments_039817.json:
```json
{
    "body": "<a id='comment:19'></a>\nOr did you mean the doctest from #11741 is *not* sufficient?",
    "created_at": "2012-04-19T16:56:35Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39817",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:19'></a>
Or did you mean the doctest from #11741 is *not* sufficient?



---

archive/issue_comments_039818.json:
```json
{
    "body": "<a id='comment:20'></a>\n#11741 is sufficient, as I wrote in the ticket description.",
    "created_at": "2012-04-19T17:00:47Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39818",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
#11741 is sufficient, as I wrote in the ticket description.



---

archive/issue_comments_039819.json:
```json
{
    "body": "**Changing author** from \"Michael Orlitzky\" to \"\".",
    "created_at": "2012-04-22T19:53:54Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39819",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Michael Orlitzky" to "".



---

archive/issue_events_038203.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-22T19:53:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "worksforme",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38203"
}
```



---

archive/issue_comments_039820.json:
```json
{
    "body": "**Changing reviewer** from \"Keshav Kini, Volker Braun\" to \"Michael Orlitzky, Keshav Kini, Volker Braun\".",
    "created_at": "2012-04-22T19:53:54Z",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5943#issuecomment-39820",
    "user": "https://github.com/jdemeyer"
}
```

**Changing reviewer** from "Keshav Kini, Volker Braun" to "Michael Orlitzky, Keshav Kini, Volker Braun".



---

archive/issue_events_038204.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-22T19:53:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38204"
}
```



---

archive/issue_events_038205.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-22T19:53:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5943",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5943#event-38205"
}
```
