# Issue 5513: Enhanced support for number field unit groups

archive/issues_005513.json:
```json
{
    "assignees": [
        "https://github.com/williamstein"
    ],
    "body": "The attached patch (based on 3.4) implements a new class UnitGroup for the unit group of a number field.  As before, the units are computed using the pari library, but now it is easier (for example) to obtain all generators of the unit group.  Also, I have added a wrapping for the pari function bnfisunit() which implements a discrete log function to express any unit in terms of the generators.\n\nAs well as all the documented code and examples in unit_group.py there are added functions in number_field.py.\n\nCC:  @loefflerd\n\nKeywords: **number field unit group**\n\nComponent: **number theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/5513_\n\n",
    "closed_at": "2009-04-03T00:45:04Z",
    "created_at": "2009-03-13T22:02:06Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.4.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Enhanced support for number field unit groups",
    "type": "issue",
    "updated_at": "2009-04-03T00:45:04Z",
    "url": "https://github.com/sagemath/sage/issues/5513",
    "user": "https://github.com/JohnCremona"
}
```
The attached patch (based on 3.4) implements a new class UnitGroup for the unit group of a number field.  As before, the units are computed using the pari library, but now it is easier (for example) to obtain all generators of the unit group.  Also, I have added a wrapping for the pari function bnfisunit() which implements a discrete log function to express any unit in terms of the generators.

As well as all the documented code and examples in unit_group.py there are added functions in number_field.py.

CC:  @loefflerd

Keywords: **number field unit group**

Component: **number theory**

_Issue created by migration from https://trac.sagemath.org/ticket/5513_





---

archive/issue_events_065352.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-13T22:02:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "milestone_number": null,
    "milestone_title": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65352"
}
```



---

archive/issue_events_065353.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-13T22:02:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "c: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65353"
}
```



---

archive/issue_events_065354.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-13T22:02:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65354"
}
```



---

archive/issue_events_065355.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-13T22:02:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65355"
}
```



---

archive/issue_events_065356.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-03-13T22:02:06Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "subject": "https://github.com/JohnCremona",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65356"
}
```



---

archive/issue_comments_034446.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[units.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units.patch.gz)**",
    "created_at": "2009-03-14T20:36:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34446",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[units.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units.patch.gz)**



---

archive/issue_events_065357.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-14T20:36:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65357"
}
```



---

archive/issue_comments_034447.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis seems to work fine, with some exceptions for relative number fields.  \nFor example, with my current favourite extension,\n\n```\nPQ.<X> = QQ[]\nF.<a, b> = NumberField([X^2 - 2, X^2 - 3])\nPF.<Y> = F[]\nK.<c> = F.extension(Y^2 - (1 + a)*(a + b)*a*b)\nK.unit_group()\n```\nfails.\n\nBut the cause lies beyond this patch.  There are many problems with the\nexisting code for relative number fields, some addressed in my patch in\n#5508, others to follow soon in a revised patch.\n\nIn this case the culprit is the use of `pari_bnf` in the line `pK = K.pari_bnf(proof)` \nat line 145 of `unit_group.py`.  For in `pari_bnf`,\nthe lines\n\n```\nif self.polynomial().denominator() != 1:\n    raise TypeError, \"Unable to coerce number field defined by ...\"\n```  \nexclude extensions like `K`.  The solution is, of course, to use \n`self.absolute_polynomial()`; this change could be included \nin the patch.\n\nSo my review is positive, subject to some small changes listed below,\nwith the expectation that forthcoming changes to other functions will make\nthe code work for all (sufficiently small) relative number fields.\n\n## Minor points\n\n* Three times:\n   \"but we do use if it is already known\"\n   should surely be\n   \"but we do use it if it is already known\"\n\n* In `zeta`,\n\n      ```\n              z = self.primitive_root_of_unity() ** (N//n)`\n   ```\n  would be more consistently written as\n\n     ```\n              z = K.primitive_root_of_unity() ** (N//n)`\n  ```\n\n\n* In `roots_of_unity` \n\n      ```\n              n = z.multiplicative_order()\n   ```\n  would surely be better as\n\n     ```\n              n = self.zeta_order()\n  ```\n\n## Further remark\n\nWhile we're working on units, one thing that should be fixed is the \nfollowing:\n\n```\nsage: K.<b> = NumberField([x^2 - 3])\nsage: K.zeta(5)\nTraceback (most recent call last)\n...\nArithmeticError: There are no roots of unity of order 5 in this unit group\n```\ncompared to\n\n```\nsage: C.<z> = CyclotomicField(20)\nsage: C.zeta(7)\nTraceback (most recent call last)\n...\nValueError: n (=7) does not divide order of generator\n```\nThere seems to be no reason why the error type should be different, and I \nfound an example where a function failed for cyclotomic fields because of \nthis disparity.",
    "created_at": "2009-03-16T14:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34447",
    "user": "https://github.com/sagetrac-fwclarke"
}
```

<div id="comment:2" align="right">comment:2</div>

This seems to work fine, with some exceptions for relative number fields.  
For example, with my current favourite extension,

```
PQ.<X> = QQ[]
F.<a, b> = NumberField([X^2 - 2, X^2 - 3])
PF.<Y> = F[]
K.<c> = F.extension(Y^2 - (1 + a)*(a + b)*a*b)
K.unit_group()
```
fails.

But the cause lies beyond this patch.  There are many problems with the
existing code for relative number fields, some addressed in my patch in
#5508, others to follow soon in a revised patch.

In this case the culprit is the use of `pari_bnf` in the line `pK = K.pari_bnf(proof)` 
at line 145 of `unit_group.py`.  For in `pari_bnf`,
the lines

```
if self.polynomial().denominator() != 1:
    raise TypeError, "Unable to coerce number field defined by ..."
```  
exclude extensions like `K`.  The solution is, of course, to use 
`self.absolute_polynomial()`; this change could be included 
in the patch.

So my review is positive, subject to some small changes listed below,
with the expectation that forthcoming changes to other functions will make
the code work for all (sufficiently small) relative number fields.

## Minor points

* Three times:
   "but we do use if it is already known"
   should surely be
   "but we do use it if it is already known"

* In `zeta`,

      ```
              z = self.primitive_root_of_unity() ** (N//n)`
   ```
  would be more consistently written as

     ```
              z = K.primitive_root_of_unity() ** (N//n)`
  ```


* In `roots_of_unity` 

      ```
              n = z.multiplicative_order()
   ```
  would surely be better as

     ```
              n = self.zeta_order()
  ```

## Further remark

While we're working on units, one thing that should be fixed is the 
following:

```
sage: K.<b> = NumberField([x^2 - 3])
sage: K.zeta(5)
Traceback (most recent call last)
...
ArithmeticError: There are no roots of unity of order 5 in this unit group
```
compared to

```
sage: C.<z> = CyclotomicField(20)
sage: C.zeta(7)
Traceback (most recent call last)
...
ValueError: n (=7) does not divide order of generator
```
There seems to be no reason why the error type should be different, and I 
found an example where a function failed for cyclotomic fields because of 
this disparity.



---

archive/issue_events_065358.json:
```json
{
    "actor": "https://github.com/sagetrac-fwclarke",
    "created_at": "2009-03-16T14:34:25Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "[positive review subject to minor alterations] Enhanced support for number field unit groups",
    "title_was": "Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65358"
}
```



---

archive/issue_comments_034448.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThanks a lot Francis!  I will sort out those things and upload a new patch shortly.  John",
    "created_at": "2009-03-16T14:49:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34448",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:3" align="right">comment:3</div>

Thanks a lot Francis!  I will sort out those things and upload a new patch shortly.  John



---

archive/issue_comments_034449.json:
```json
{
    "body": "REPLACES the earlier patch",
    "created_at": "2009-03-16T15:35:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34449",
    "user": "https://github.com/JohnCremona"
}
```

REPLACES the earlier patch



---

archive/issue_comments_034450.json:
```json
{
    "body": "Attachment: **[trac_5513.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513.patch.gz)**\n\nApply after the earlier patch",
    "created_at": "2009-03-16T15:36:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34450",
    "user": "https://github.com/JohnCremona"
}
```

Attachment: **[trac_5513.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513.patch.gz)**

Apply after the earlier patch



---

archive/issue_comments_034451.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAttachment: **[trac_5513.2.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513.2.patch.gz)**\n\nI have fixed all the issues raised in the review in the new patch trac_5513.patch.  I added a doctest in unit_group.py to show that the relative example now works.  I tested all in sage/rings/number_field.\n\nApologies for the confusion:  I thought that my new patch (called trac_5513.patch) replaced the origianl one because I was using mercurial queues, but (as usual) I was wrong.  You need to apply the original units.patch and then the new one (trac_5513.patch) which appear twice on trac, once with the worng message and once with the right one.  I hope that is clear.",
    "created_at": "2009-03-16T15:38:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34451",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:4" align="right">comment:4</div>

Attachment: **[trac_5513.2.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513.2.patch.gz)**

I have fixed all the issues raised in the review in the new patch trac_5513.patch.  I added a doctest in unit_group.py to show that the relative example now works.  I tested all in sage/rings/number_field.

Apologies for the confusion:  I thought that my new patch (called trac_5513.patch) replaced the origianl one because I was using mercurial queues, but (as usual) I was wrong.  You need to apply the original units.patch and then the new one (trac_5513.patch) which appear twice on trac, once with the worng message and once with the right one.  I hope that is clear.



---

archive/issue_events_065359.json:
```json
{
    "actor": "https://github.com/sagetrac-fwclarke",
    "created_at": "2009-03-16T20:08:52Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "Enhanced support for number field unit groups",
    "title_was": "[positive review subject to minor alterations] Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65359"
}
```



---

archive/issue_events_065360.json:
```json
{
    "actor": "https://github.com/sagetrac-fwclarke",
    "created_at": "2009-03-16T20:08:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65360"
}
```



---

archive/issue_events_065361.json:
```json
{
    "actor": "https://github.com/sagetrac-fwclarke",
    "created_at": "2009-03-16T20:08:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65361"
}
```



---

archive/issue_comments_034452.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nA couple more things: \n* two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.\n\n* units can have norm -1.\n\nWith the third patch everything works.",
    "created_at": "2009-03-16T20:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34452",
    "user": "https://github.com/sagetrac-fwclarke"
}
```

<div id="comment:5" align="right">comment:5</div>

A couple more things: 
* two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.

* units can have norm -1.

With the third patch everything works.



---

archive/issue_comments_034453.json:
```json
{
    "body": "apply after the other two",
    "created_at": "2009-03-16T20:11:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34453",
    "user": "https://github.com/sagetrac-fwclarke"
}
```

apply after the other two



---

archive/issue_comments_034454.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAttachment: **[trac_5513_third.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513_third.patch.gz)**\n\nReplying to [@sagetrac-fwclarke](#comment:5):\n> A couple more things: \n> * two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.\n> \n> * units can have norm -1.\n> \n> With the third patch everything works.\n\nThanks a lot -- for what it's worth, I am (more than) happy with the third patch, also a little red-faced about the norms!",
    "created_at": "2009-03-16T20:36:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34454",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:6" align="right">comment:6</div>

Attachment: **[trac_5513_third.patch.gz](https://github.com/sagemath/sage/files/ticket5513/trac_5513_third.patch.gz)**

Replying to [@sagetrac-fwclarke](#comment:5):
> A couple more things: 
> * two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.
> 
> * units can have norm -1.
> 
> With the third patch everything works.

Thanks a lot -- for what it's worth, I am (more than) happy with the third patch, also a little red-faced about the norms!



---

archive/issue_comments_034455.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@JohnCremona](#comment:6):\n> Replying to [@sagetrac-fwclarke](#comment:5):\n> > A couple more things: \n> > * two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.\n> > \n> > * units can have norm -1.\n> > \n> > With the third patch everything works.\n\n> \n> Thanks a lot -- for what it's worth, I am (more than) happy with the third patch, also a little red-faced about the norms!\n\nPS Francis, if yo ufancied looking at #5518 too you can have the satisfaction of adding .norm() in a similar place.  It's a lot simpler and shorter than this one.",
    "created_at": "2009-03-16T20:42:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34455",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@JohnCremona](#comment:6):
> Replying to [@sagetrac-fwclarke](#comment:5):
> > A couple more things: 
> > * two more replacements of `defining_polynomial` by `absolute_polynomial` are needed.
> > 
> > * units can have norm -1.
> > 
> > With the third patch everything works.

> 
> Thanks a lot -- for what it's worth, I am (more than) happy with the third patch, also a little red-faced about the norms!

PS Francis, if yo ufancied looking at #5518 too you can have the satisfaction of adding .norm() in a similar place.  It's a lot simpler and shorter than this one.



---

archive/issue_events_065362.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-03-25T09:28:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "[needs rebase] Enhanced support for number field unit groups",
    "title_was": "Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65362"
}
```



---

archive/issue_comments_034456.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThis patch set no longer applies after merging #5508.\n\nFrancis: Can you rebase this patch set? Once it is rebased the positive review should be reinstated provided the changes are minimal, otherwise we should have another review.\n\nCheers,\n\nMichael",
    "created_at": "2009-03-25T09:28:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34456",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:8" align="right">comment:8</div>

This patch set no longer applies after merging #5508.

Francis: Can you rebase this patch set? Once it is rebased the positive review should be reinstated provided the changes are minimal, otherwise we should have another review.

Cheers,

Michael



---

archive/issue_comments_034457.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nOoops, I guess John should do the rebase here :)\n\nCheers,\n\nMichael",
    "created_at": "2009-03-25T09:29:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34457",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:9" align="right">comment:9</div>

Ooops, I guess John should do the rebase here :)

Cheers,

Michael



---

archive/issue_comments_034458.json:
```json
{
    "body": "Replaces all above, reabsed to 3.4 + sage-5508.3.patch",
    "created_at": "2009-03-28T16:31:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34458",
    "user": "https://github.com/JohnCremona"
}
```

Replaces all above, reabsed to 3.4 + sage-5508.3.patch



---

archive/issue_events_065363.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-28T16:33:29Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "[with rebased patch, needs review (quick)] Enhanced support for number field unit groups",
    "title_was": "[needs rebase] Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65363"
}
```



---

archive/issue_comments_034459.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nAttachment: **[units_rebase.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebase.patch.gz)**\n\nI have attached a single patch which replaces all previous ones and is rebased on 3.4 + sage-5508.3.patch, as requested.",
    "created_at": "2009-03-28T16:33:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34459",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:10" align="right">comment:10</div>

Attachment: **[units_rebase.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebase.patch.gz)**

I have attached a single patch which replaces all previous ones and is rebased on 3.4 + sage-5508.3.patch, as requested.



---

archive/issue_events_065364.json:
```json
{
    "actor": "https://github.com/sagetrac-fwclarke",
    "created_at": "2009-03-29T19:58:14Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "[with rebased patch, and positive review] Enhanced support for number field unit groups",
    "title_was": "[with rebased patch, needs review (quick)] Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65364"
}
```



---

archive/issue_comments_034460.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nLooks fine to me.  Positive review.",
    "created_at": "2009-03-29T19:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34460",
    "user": "https://github.com/sagetrac-fwclarke"
}
```

<div id="comment:11" align="right">comment:11</div>

Looks fine to me.  Positive review.



---

archive/issue_comments_034461.json:
```json
{
    "body": "Alternaitve, rebased to 3.4 + #550 + #5159",
    "created_at": "2009-03-30T09:02:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34461",
    "user": "https://github.com/JohnCremona"
}
```

Alternaitve, rebased to 3.4 + #550 + #5159



---

archive/issue_comments_034462.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAttachment: **[units_rebased2.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebased2.patch.gz)**\n\nThanks, Francis.   For ease of merging I have also provided another rebased patch which applies to 3.4 + sage-5508.3.patch + the patches at #5159 since I hope/expect that one to be merged shortly and now the whole lot are compatible.",
    "created_at": "2009-03-30T09:05:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34462",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:12" align="right">comment:12</div>

Attachment: **[units_rebased2.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebased2.patch.gz)**

Thanks, Francis.   For ease of merging I have also provided another rebased patch which applies to 3.4 + sage-5508.3.patch + the patches at #5159 since I hope/expect that one to be merged shortly and now the whole lot are compatible.



---

archive/issue_events_065365.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-03-31T07:47:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "Enhanced support for number field unit groups",
    "title_was": "[with rebased patch, and positive review] Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65365"
}
```



---

archive/issue_comments_034463.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\n[CCing David]\n\nI am waiting to see if #5159 will have all its issues fixed in the next 12 to 24 hours, otherwise I will merge the rebased patch that only depends on 3.4 + #5508.\n\nCheers,\n\nMichael",
    "created_at": "2009-03-31T07:47:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34463",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:13" align="right">comment:13</div>

[CCing David]

I am waiting to see if #5159 will have all its issues fixed in the next 12 to 24 hours, otherwise I will merge the rebased patch that only depends on 3.4 + #5508.

Cheers,

Michael



---

archive/issue_comments_034464.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nunits_rebase.patch by itself does not apply for me to 3.4.1.alpha0 (which includes #5508), so I am waiting on #5159 to go in before trying again. Does this patch depend on anything else?\n\nCheers,\n\nMichael",
    "created_at": "2009-03-31T08:06:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34464",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:14" align="right">comment:14</div>

units_rebase.patch by itself does not apply for me to 3.4.1.alpha0 (which includes #5508), so I am waiting on #5159 to go in before trying again. Does this patch depend on anything else?

Cheers,

Michael



---

archive/issue_comments_034465.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@sagetrac-mabshoff](#comment:14):\n> units_rebase.patch by itself does not apply for me to 3.4.1.alpha0 (which includes #5508), so I am waiting on #5159 to go in before trying again. Does this patch depend on anything else?\n\nIt shouldn't do, but I did not have a working 3.4.1.alpha0 until late yesterday.  I'll look into that right now, as well as #5159.\n\n> \n> Cheers,\n> \n> Michael",
    "created_at": "2009-03-31T08:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34465",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@sagetrac-mabshoff](#comment:14):
> units_rebase.patch by itself does not apply for me to 3.4.1.alpha0 (which includes #5508), so I am waiting on #5159 to go in before trying again. Does this patch depend on anything else?

It shouldn't do, but I did not have a working 3.4.1.alpha0 until late yesterday.  I'll look into that right now, as well as #5159.

> 
> Cheers,
> 
> Michael



---

archive/issue_comments_034466.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI cloned a freshly built 3.4.1.alpha0 and (using hg_sage.apply()) successfully applied units_rebase.patch to it.  No warnings.  No problems with sage -br.   BUT then doing sage -t on sage/rings/number_field threw up a large number of very weird errors I have never seen before:  example:\n\n```\n\nsage -t  \"local/sage-3.4.1.alpha0/devel/sage-5513a/sage/rings/number_field/number_field.py\"\n  File \"./number_field.py\", line 18\n    from local/sage-3.4.1.alpha0/devel/sage-5513a/sage/rings/number_field/number_field import *\n              ^\nSyntaxError: invalid syntax\n\n         [0.4 s]\nexit code: 1024\n\n```\n\nWhat is that about?   Something seems to have inserts forward slashes into a python file instead of dots.",
    "created_at": "2009-03-31T08:43:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34466",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:16" align="right">comment:16</div>

I cloned a freshly built 3.4.1.alpha0 and (using hg_sage.apply()) successfully applied units_rebase.patch to it.  No warnings.  No problems with sage -br.   BUT then doing sage -t on sage/rings/number_field threw up a large number of very weird errors I have never seen before:  example:

```

sage -t  "local/sage-3.4.1.alpha0/devel/sage-5513a/sage/rings/number_field/number_field.py"
  File "./number_field.py", line 18
    from local/sage-3.4.1.alpha0/devel/sage-5513a/sage/rings/number_field/number_field import *
              ^
SyntaxError: invalid syntax

         [0.4 s]
exit code: 1024

```

What is that about?   Something seems to have inserts forward slashes into a python file instead of dots.



---

archive/issue_comments_034467.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI've been seeing this too: there's been some changes in the doctesting mechanism in 3.4.1.alpha0 that seem to have broken it almost completely.",
    "created_at": "2009-03-31T08:46:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34467",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:17" align="right">comment:17</div>

I've been seeing this too: there's been some changes in the doctesting mechanism in 3.4.1.alpha0 that seem to have broken it almost completely.



---

archive/issue_comments_034468.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@loefflerd](#comment:17):\n> I've been seeing this too: there's been some changes in the doctesting mechanism in 3.4.1.alpha0 that seem to have broken it almost completely. \n\nI cannot reproduce this - but I did not try to apply this patch set. What I tried:\n\n* use -tp\n* use -t from inside the Sage tree\n* use -t from outside the Sage tree\n\nCan someone give me exact instructions on how to reproduce this?\n\nCheers,\n\nMichael",
    "created_at": "2009-03-31T09:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34468",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@loefflerd](#comment:17):
> I've been seeing this too: there's been some changes in the doctesting mechanism in 3.4.1.alpha0 that seem to have broken it almost completely. 

I cannot reproduce this - but I did not try to apply this patch set. What I tried:

* use -tp
* use -t from inside the Sage tree
* use -t from outside the Sage tree

Can someone give me exact instructions on how to reproduce this?

Cheers,

Michael



---

archive/issue_comments_034469.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nCan you try reverting #2129 and see if the problem goes away? That seem to be the only patch I would suspect here to cause trouble.\n\nCheers,\n\nMichael",
    "created_at": "2009-03-31T09:13:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34469",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:19" align="right">comment:19</div>

Can you try reverting #2129 and see if the problem goes away? That seem to be the only patch I would suspect here to cause trouble.

Cheers,

Michael



---

archive/issue_comments_034470.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI have posted in sage-devel about this. The problem comes up when you use sage -t from within the sage tree.",
    "created_at": "2009-03-31T09:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34470",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:20" align="right">comment:20</div>

I have posted in sage-devel about this. The problem comes up when you use sage -t from within the sage tree.



---

archive/issue_events_065366.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-03-31T09:56:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65366"
}
```



---

archive/issue_events_065367.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-03-31T09:56:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65367"
}
```



---

archive/issue_comments_034471.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nUsing units_rebased2.patch there are a bunch of probably 32 vs. 64 bit doctest failures:\n\n```\nsage -t -long devel/sage/sage/rings/number_field/unit_group.py\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 11:\n    sage: UK.gens()\nExpected:\n    [1/12*a^3 - 1/6*a, 1/24*a^3 + 1/4*a^2 - 1/12*a - 1]\nGot:\n    [1/12*a^3 - 1/6*a, 1/24*a^3 - 7/12*a - 1/2]\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 31:\n    sage: UK.fundamental_units()\nExpected:\n    [1/24*a^3 + 1/4*a^2 - 1/12*a - 1]\nGot:\n    [1/24*a^3 - 7/12*a - 1/2]\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 43:\n    sage: u = UK.exp([13,10]); u\nExpected:\n    -41/8*a^3 - 55/4*a^2 + 41/4*a + 55\nGot:\n    41/8*a^3 + 55/4*a^2 - 41/4*a - 55\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 64:\n    sage: UL.gens()\nExpected:\n    [-b^3*a - b^3, -b^3*a + b, (-b^3 - b^2 - b)*a - b - 1, (-b^3 - 1)*a - b^2 + b - 1]\nGot:\n    [-b^3*a - b^3, -b^3*a + b, a - b^3 + 1, (-b^2 - b)*a - b^3 - b^2 + 1]\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 374:\n    sage: U.torsion_generator()\nExpected:\n    -1/4*a^3 - 1/4*a + 1/2\nGot:\n    1/4*a^3 + 1/4*a + 1/2\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 164:\n    sage: UK.gens()\nExpected:\n    [-z^11, z^5 + z^3, z^6 + z^5, z^9 + z^7 + z^5, z^9 + z^5 + z^4 + 1, z^5 + z]\nGot:\n    [-z^3, z^5 + z^3, z^6 + z^5, z^9 + z^7 + z^5, z^9 + z^5 + z^4 + 1, z^5 + z]\n**********************************************************************\nFile \"/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py\", line 303:\n    sage: UK.gen(0)\nExpected:\n    -z^11\nGot:\n    -z^3\n**********************************************************************\n4 items had failures:\n   4 of  35 in __main__.example_0\n   1 of   6 in __main__.example_12\n   1 of  12 in __main__.example_2\n   1 of  11 in __main__.example_8\n***Test Failed*** 7 failures.\nFor whitespace errors, see the file /scratch/mabshoff/sage-3.4.1.rc0/tmp/.doctest_unit_group.py\n\t [2.0 s]\n```\n\nCheers,\n\nMichael",
    "created_at": "2009-03-31T09:56:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34471",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:21" align="right">comment:21</div>

Using units_rebased2.patch there are a bunch of probably 32 vs. 64 bit doctest failures:

```
sage -t -long devel/sage/sage/rings/number_field/unit_group.py
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 11:
    sage: UK.gens()
Expected:
    [1/12*a^3 - 1/6*a, 1/24*a^3 + 1/4*a^2 - 1/12*a - 1]
Got:
    [1/12*a^3 - 1/6*a, 1/24*a^3 - 7/12*a - 1/2]
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 31:
    sage: UK.fundamental_units()
Expected:
    [1/24*a^3 + 1/4*a^2 - 1/12*a - 1]
Got:
    [1/24*a^3 - 7/12*a - 1/2]
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 43:
    sage: u = UK.exp([13,10]); u
Expected:
    -41/8*a^3 - 55/4*a^2 + 41/4*a + 55
Got:
    41/8*a^3 + 55/4*a^2 - 41/4*a - 55
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 64:
    sage: UL.gens()
Expected:
    [-b^3*a - b^3, -b^3*a + b, (-b^3 - b^2 - b)*a - b - 1, (-b^3 - 1)*a - b^2 + b - 1]
Got:
    [-b^3*a - b^3, -b^3*a + b, a - b^3 + 1, (-b^2 - b)*a - b^3 - b^2 + 1]
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 374:
    sage: U.torsion_generator()
Expected:
    -1/4*a^3 - 1/4*a + 1/2
Got:
    1/4*a^3 + 1/4*a + 1/2
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 164:
    sage: UK.gens()
Expected:
    [-z^11, z^5 + z^3, z^6 + z^5, z^9 + z^7 + z^5, z^9 + z^5 + z^4 + 1, z^5 + z]
Got:
    [-z^3, z^5 + z^3, z^6 + z^5, z^9 + z^7 + z^5, z^9 + z^5 + z^4 + 1, z^5 + z]
**********************************************************************
File "/scratch/mabshoff/sage-3.4.1.rc0/devel/sage-main/sage/rings/number_field/unit_group.py", line 303:
    sage: UK.gen(0)
Expected:
    -z^11
Got:
    -z^3
**********************************************************************
4 items had failures:
   4 of  35 in __main__.example_0
   1 of   6 in __main__.example_12
   1 of  12 in __main__.example_2
   1 of  11 in __main__.example_8
***Test Failed*** 7 failures.
For whitespace errors, see the file /scratch/mabshoff/sage-3.4.1.rc0/tmp/.doctest_unit_group.py
	 [2.0 s]
```

Cheers,

Michael



---

archive/issue_comments_034472.json:
```json
{
    "body": "replace previous",
    "created_at": "2009-03-31T09:59:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34472",
    "user": "https://github.com/JohnCremona"
}
```

replace previous



---

archive/issue_events_065368.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-03-31T10:04:26Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "[with new patch, needs review (again)] Enhanced support for number field unit groups",
    "title_was": "Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65368"
}
```



---

archive/issue_comments_034473.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nAttachment: **[units_rebased3.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebased3.patch.gz)**\n\nok -- see newest patch (units_rebased3.patch, to replace units_rebased2.patch).\n\nI took the lazy way out and added #random to all the outputs which return actual units.  It may be a 32/64 issue, but not just that since when testing this patch on one machine I kept on getting different generating units out of pari.  I seem to remember that there is a way to \"reset\" pari in doctests  to avoid this random-ness.\n\nMathematically this is not so unreasonable since any f.g. abelian group will lots (infinitely many) sets of generators and there is no way to pick one canonically.  (William and I thought about this for elliptic curve generators and came up against an unsolved problem which prevents this being possible even in principle!).",
    "created_at": "2009-03-31T10:04:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34473",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:22" align="right">comment:22</div>

Attachment: **[units_rebased3.patch.gz](https://github.com/sagemath/sage/files/ticket5513/units_rebased3.patch.gz)**

ok -- see newest patch (units_rebased3.patch, to replace units_rebased2.patch).

I took the lazy way out and added #random to all the outputs which return actual units.  It may be a 32/64 issue, but not just that since when testing this patch on one machine I kept on getting different generating units out of pari.  I seem to remember that there is a way to "reset" pari in doctests  to avoid this random-ness.

Mathematically this is not so unreasonable since any f.g. abelian group will lots (infinitely many) sets of generators and there is no way to pick one canonically.  (William and I thought about this for elliptic curve generators and came up against an unsolved problem which prevents this being possible even in principle!).



---

archive/issue_comments_034474.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@JohnCremona](#comment:22):\n> ok -- see newest patch (units_rebased3.patch, to replace units_rebased2.patch).\n> \n> I took the lazy way out and added #random to all the outputs which return actual units.  It may be a 32/64 issue, but not just that since when testing this patch on one machine I kept on getting different generating units out of pari.  I seem to remember that there is a way to \"reset\" pari in doctests  to avoid this random-ness.\n> \n> Mathematically this is not so unreasonable since any f.g. abelian group will lots (infinitely many) sets of generators and there is no way to pick one canonically.  (William and I thought about this for elliptic curve generators and came up against an unsolved problem which prevents this being possible even in principle!).\n\nMichael,\n\nsince all I did here was to add #random to the problem tests, does this need more review or could it be merged now?",
    "created_at": "2009-04-02T09:42:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34474",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@JohnCremona](#comment:22):
> ok -- see newest patch (units_rebased3.patch, to replace units_rebased2.patch).
> 
> I took the lazy way out and added #random to all the outputs which return actual units.  It may be a 32/64 issue, but not just that since when testing this patch on one machine I kept on getting different generating units out of pari.  I seem to remember that there is a way to "reset" pari in doctests  to avoid this random-ness.
> 
> Mathematically this is not so unreasonable since any f.g. abelian group will lots (infinitely many) sets of generators and there is no way to pick one canonically.  (William and I thought about this for elliptic curve generators and came up against an unsolved problem which prevents this being possible even in principle!).

Michael,

since all I did here was to add #random to the problem tests, does this need more review or could it be merged now?



---

archive/issue_events_065369.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-03T00:43:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "title_is": "Enhanced support for number field unit groups",
    "title_was": "[with new patch, needs review (again)] Enhanced support for number field unit groups",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65369"
}
```



---

archive/issue_events_065370.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-03T00:43:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65370"
}
```



---

archive/issue_events_065371.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-03T00:43:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65371"
}
```



---

archive/issue_comments_034475.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nJohn,\n\nWilliam has given his \"thumbs up\" to this patch and the latest changes, so let's make this a positive review. This patch also passes doctests with my current 3.4.1.rc0 merge tree.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-03T00:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34475",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:24" align="right">comment:24</div>

John,

William has given his "thumbs up" to this patch and the latest changes, so let's make this a positive review. This patch also passes doctests with my current 3.4.1.rc0 merge tree.

Cheers,

Michael



---

archive/issue_events_065372.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-03T00:45:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65372"
}
```



---

archive/issue_events_065373.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-04-03T00:45:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/5513#event-65373"
}
```



---

archive/issue_comments_034476.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nMerged units_rebased3.patch in Sage 3.4.1.rc0.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-03T00:45:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/5513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/5513#issuecomment-34476",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:25" align="right">comment:25</div>

Merged units_rebased3.patch in Sage 3.4.1.rc0.

Cheers,

Michael
