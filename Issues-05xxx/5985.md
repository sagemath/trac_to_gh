# Issue 5985: [with spkg, with positive review] cPickle: adds support for class pickling customization

archive/issues_005985.json:
```json
{
    "body": "Original implementation:\n\nThe first patch imports the vanilla cPickle.c and test_cpickle.py\nfrom python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the\ncPickle imports throughout the sage library.\n\nThe second patch makes a very small modification to cPickle to allow\nfor customizing how class are pickled via metaclasses.\n\nFinal implementation: adds the second patch to the python spkg\n\nSee discussions on:\n- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/\n- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/\n\nThanks to Mike, Burcin, and Carl for suggestions on how to handle this.\n\nAssignee: @nthiery\n\nCC:  sage-combinat cwitty @saliola @burcin @craigcitro\n\nKeywords: cPickle, pickling classes\n\nResolution: fixed\n\nAuthor: Craig Citro, Nicolas M. Thi\u00e9ry\n\nReviewer: Craig Citro, Nicolas M. Thi\u00e9ry\n\nMerged: sage-4.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/5985\n\n",
    "closed_at": "2009-10-15T06:56:06Z",
    "created_at": "2009-05-05T05:54:04Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.2",
    "title": "[with spkg, with positive review] cPickle: adds support for class pickling customization",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/5985",
    "user": "https://github.com/nthiery"
}
```
Original implementation:

The first patch imports the vanilla cPickle.c and test_cpickle.py
from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the
cPickle imports throughout the sage library.

The second patch makes a very small modification to cPickle to allow
for customizing how class are pickled via metaclasses.

Final implementation: adds the second patch to the python spkg

See discussions on:
- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/
- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/

Thanks to Mike, Burcin, and Carl for suggestions on how to handle this.

Assignee: @nthiery

CC:  sage-combinat cwitty @saliola @burcin @craigcitro

Keywords: cPickle, pickling classes

Resolution: fixed

Author: Craig Citro, Nicolas M. Thiéry

Reviewer: Craig Citro, Nicolas M. Thiéry

Merged: sage-4.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/5985





---

archive/issue_comments_052434.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+The first patch imports the vanilla cPickle.c and test_cpickle.py\n+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the\n+cPickle imports throughout the sage library.\n+\n+The second patch makes a very small modification to cPickle to allow\n+for customizing how class are pickled via metaclasses.\n+\n+See discussions on:\n+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/\n+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/\n+\n \n \n Summary: cPickle: adds support for class pickling customizing  and for nested classes\n``````\n",
    "created_at": "2009-05-05T07:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52434",
    "user": "https://github.com/nthiery"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+The first patch imports the vanilla cPickle.c and test_cpickle.py
+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the
+cPickle imports throughout the sage library.
+
+The second patch makes a very small modification to cPickle to allow
+for customizing how class are pickled via metaclasses.
+
+See discussions on:
+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/
+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/
+
 
 
 Summary: cPickle: adds support for class pickling customizing  and for nested classes
``````




---

archive/issue_events_014041.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-05-05T07:12:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "milestone": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5985#event-14041"
}
```



---

archive/issue_comments_052435.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,15 @@\n+The first patch imports the vanilla cPickle.c and test_cpickle.py\n+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the\n+cPickle imports throughout the sage library.\n \n+The second patch makes a very small modification to cPickle to allow\n+for customizing how class are pickled via metaclasses.\n+\n+See discussions on:\n+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/\n+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/\n+\n+Thanks to Mike, Burcin, and Carl for suggestions on how to handle this.\n \n Summary: cPickle: adds support for class pickling customizing  and for nested classes\n \n``````\n",
    "created_at": "2009-05-05T22:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52435",
    "user": "https://github.com/nthiery"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,15 @@
+The first patch imports the vanilla cPickle.c and test_cpickle.py
+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the
+cPickle imports throughout the sage library.
 
+The second patch makes a very small modification to cPickle to allow
+for customizing how class are pickled via metaclasses.
+
+See discussions on:
+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/
+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/
+
+Thanks to Mike, Burcin, and Carl for suggestions on how to handle this.
 
 Summary: cPickle: adds support for class pickling customizing  and for nested classes
 
``````




---

archive/issue_comments_052436.json:
```json
{
    "body": "<a id='comment:6'></a>I just rebased the first patch upon 3.4.2 final. Please ignore (or better delete) the old version  cPickle-5985-import.patch",
    "created_at": "2009-05-06T23:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52436",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>I just rebased the first patch upon 3.4.2 final. Please ignore (or better delete) the old version  cPickle-5985-import.patch



---

archive/issue_comments_052437.json:
```json
{
    "body": "<a id='comment:7'></a>Note: the cPickle imports in dsage will need to be updated as well.",
    "created_at": "2009-05-07T01:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52437",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:7'></a>Note: the cPickle imports in dsage will need to be updated as well.



---

archive/issue_comments_052438.json:
```json
{
    "body": "<a id='comment:8'></a>Updated patch:\n- Fixes a trivially failing doctest (don't know why I did not see them earlier)\n- Adds some more doctest",
    "created_at": "2009-05-12T22:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52438",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:8'></a>Updated patch:
- Fixes a trivially failing doctest (don't know why I did not see them earlier)
- Adds some more doctest



---

archive/issue_comments_052439.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2009-05-19T06:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52439",
    "user": "https://github.com/nthiery"
}
```

Changing status from new to assigned.



---

archive/issue_comments_052440.json:
```json
{
    "body": "<a id='comment:10'></a>This patch needs an explicit addition of sage/misc/cPickle.c to MANIFEST.in for -sdist to work. It is also listed to have a positive review in the [CategoriesRoadMap](CategoriesRoadMap), but it isn't on the ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-22T14:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52440",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>This patch needs an explicit addition of sage/misc/cPickle.c to MANIFEST.in for -sdist to work. It is also listed to have a positive review in the [CategoriesRoadMap](CategoriesRoadMap), but it isn't on the ticket.

Cheers,

Michael



---

archive/issue_comments_052441.json:
```json
{
    "body": "<a id='comment:11'></a>Followup at #5986",
    "created_at": "2009-05-22T23:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52441",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:11'></a>Followup at #5986



---

archive/issue_comments_052442.json:
```json
{
    "body": "Attachment [cPickle-5985-import-submitted.patch](tarball://root/attachments/some-uuid/ticket5985/cPickle-5985-import-submitted.patch) by @nthiery created at 2009-05-23 07:42:38",
    "created_at": "2009-05-23T07:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52442",
    "user": "https://github.com/nthiery"
}
```

Attachment [cPickle-5985-import-submitted.patch](tarball://root/attachments/some-uuid/ticket5985/cPickle-5985-import-submitted.patch) by @nthiery created at 2009-05-23 07:42:38



---

archive/issue_comments_052443.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 mabshoff]:\n> This patch needs an explicit addition of sage/misc/cPickle.c to MANIFEST.in for -sdist to work.\n\n\nThe updated patch hopefully fixes this (please double check).\n\n> It is also listed to have a positive review in the [CategoriesRoadMap](CategoriesRoadMap), but it isn't on the ticket.\n\n\nOops, fixed. Someone was supposed to give a positive review, but apparently this has not occurred yet.",
    "created_at": "2009-05-23T07:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52443",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:12'></a>Replying to [comment:10 mabshoff]:
> This patch needs an explicit addition of sage/misc/cPickle.c to MANIFEST.in for -sdist to work.


The updated patch hopefully fixes this (please double check).

> It is also listed to have a positive review in the [CategoriesRoadMap](CategoriesRoadMap), but it isn't on the ticket.


Oops, fixed. Someone was supposed to give a positive review, but apparently this has not occurred yet.



---

archive/issue_comments_052444.json:
```json
{
    "body": "<a id='comment:13'></a>I've rolled an spkg with the patch by Nicolas incorporated -- it's here:\n\n  http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg\n\nIt's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. \n\nI should have more time to look at this tonight (and give it a review, assuming it works).",
    "created_at": "2009-07-08T22:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52444",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:13'></a>I've rolled an spkg with the patch by Nicolas incorporated -- it's here:

  http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg

It's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. 

I should have more time to look at this tonight (and give it a review, assuming it works).



---

archive/issue_comments_052445.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 craigcitro]:\n> I've rolled an spkg with the patch by Nicolas incorporated -- it's here:\n> \n>   http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg\n> \n> It's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. \n> \n> I should have more time to look at this tonight (and give it a review, assuming it works).\n\n\nThanks for working on this!\n\nThe patch cPickle-5985-copy_reg_classes-submitted.patch includes a fairly complete testsuite (see the addition to sage/misc/test_cpickle_sage.py)",
    "created_at": "2009-07-09T10:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52445",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:14'></a>Replying to [comment:13 craigcitro]:
> I've rolled an spkg with the patch by Nicolas incorporated -- it's here:
> 
>   http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg
> 
> It's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. 
> 
> I should have more time to look at this tonight (and give it a review, assuming it works).


Thanks for working on this!

The patch cPickle-5985-copy_reg_classes-submitted.patch includes a fairly complete testsuite (see the addition to sage/misc/test_cpickle_sage.py)



---

archive/issue_comments_052446.json:
```json
{
    "body": "<a id='comment:15'></a>Attachment [cPickle-5985-copy_reg_classes-submitted.patch](tarball://root/attachments/some-uuid/ticket5985/cPickle-5985-copy_reg_classes-submitted.patch) by @nthiery created at 2009-07-11 22:48:25\n\nReplying to [comment:14 nthiery]:\n> Replying to [comment:13 craigcitro]:\n> > I've rolled an spkg with the patch by Nicolas incorporated -- it's here:\n> > \n> >   http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg\n> > \n> > It's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. \n> > \n> > I should have more time to look at this tonight (and give it a review, assuming it works).\n\n> \n> Thanks for working on this!\n> \n> The patch cPickle-5985-copy_reg_classes-submitted.patch includes a fairly complete testsuite (see the addition to sage/misc/test_cpickle_sage.py)\n\n\nOops, this testsuite used type.__new__(...) which apparently does not work anymore with Python 2.6. I just rewrote the testsuite so that it does not use this feature anymore. See attached patch.\n\nLuckily enough, the real applications of this patch readily did not use this feature anymore!",
    "created_at": "2009-07-11T22:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52446",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:15'></a>Attachment [cPickle-5985-copy_reg_classes-submitted.patch](tarball://root/attachments/some-uuid/ticket5985/cPickle-5985-copy_reg_classes-submitted.patch) by @nthiery created at 2009-07-11 22:48:25

Replying to [comment:14 nthiery]:
> Replying to [comment:13 craigcitro]:
> > I've rolled an spkg with the patch by Nicolas incorporated -- it's here:
> > 
> >   http://sage.math.washington.edu/home/craigcitro/four-one/python-2.6.2.p2.spkg
> > 
> > It's not ready to be merged (I need to commit the changes in hg), but I'd like Nicolas to confirm that it still works before I play with it too much. Or, if there's an easy testcase, post that and I'll play with it. 
> > 
> > I should have more time to look at this tonight (and give it a review, assuming it works).

> 
> Thanks for working on this!
> 
> The patch cPickle-5985-copy_reg_classes-submitted.patch includes a fairly complete testsuite (see the addition to sage/misc/test_cpickle_sage.py)


Oops, this testsuite used type.__new__(...) which apparently does not work anymore with Python 2.6. I just rewrote the testsuite so that it does not use this feature anymore. See attached patch.

Luckily enough, the real applications of this patch readily did not use this feature anymore!



---

archive/issue_comments_052447.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 nthiery]:\n> Oops, this testsuite used type.__new__(...) which apparently does not work anymore with Python 2.6. I just rewrote the testsuite so that it does not use this feature anymore. See attached patch.\n\n\nFor the record:\n\nzephyr-/opt/sage-4.0.2>./sage\n\n---\n| Sage Version 4.0.2, Release Date: 2009-06-18                       |\n| Type notebook() for the GUI, and license() for information.        |\n---\nLoading Sage library. Current Mercurial branch is: combinat           \nsage: class metaclass(type):\n....:     def __new__(cls):\n....:         return type.__new__(cls, \"bla\", (object,), dict())\n....:\nsage: metaclass()                                                                                                     \n<class '__main__.bla'>\n\nzephyr-~>sage\n\n---\n| Sage Version 4.1, Release Date: 2009-07-09                         |\n| Type notebook() for the GUI, and license() for information.        |\n---\nLoading Sage library. Current Mercurial branch is: combinat\nsage: class metaclass(type):\n....:     def __new__(cls):\n....:         return type.__new__(cls, \"bla\", (object,), dict())\n....:\nsage: metaclass()\n\n---\nTraceback (most recent call last):\n  File \"<ipython console>\", line 1, in <module>\nTypeError: type.__init__() takes 1 or 3 arguments\n\nApparently type.__new__ now calls type.__init__. And I assume that can only be a change in python, not in Sage.",
    "created_at": "2009-07-11T22:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52447",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:16'></a>Replying to [comment:15 nthiery]:
> Oops, this testsuite used type.__new__(...) which apparently does not work anymore with Python 2.6. I just rewrote the testsuite so that it does not use this feature anymore. See attached patch.


For the record:

zephyr-/opt/sage-4.0.2>./sage

---
| Sage Version 4.0.2, Release Date: 2009-06-18                       |
| Type notebook() for the GUI, and license() for information.        |
---
Loading Sage library. Current Mercurial branch is: combinat           
sage: class metaclass(type):
....:     def __new__(cls):
....:         return type.__new__(cls, "bla", (object,), dict())
....:
sage: metaclass()                                                                                                     
<class '__main__.bla'>

zephyr-~>sage

---
| Sage Version 4.1, Release Date: 2009-07-09                         |
| Type notebook() for the GUI, and license() for information.        |
---
Loading Sage library. Current Mercurial branch is: combinat
sage: class metaclass(type):
....:     def __new__(cls):
....:         return type.__new__(cls, "bla", (object,), dict())
....:
sage: metaclass()

---
Traceback (most recent call last):
  File "<ipython console>", line 1, in <module>
TypeError: type.__init__() takes 1 or 3 arguments

Apparently type.__new__ now calls type.__init__. And I assume that can only be a change in python, not in Sage.



---

archive/issue_comments_052448.json:
```json
{
    "body": "<a id='comment:17'></a>I'm uploading a new python spkg, which is the same as the previous one I posted, but based on the most recent python spkg in Sage. It's here:\n\n  http://sage.math.washington.edu/home/craigcitro/python-2.6.2.p4.spkg\n\nThis fixes the issue by patching the files in our python spkg instead of importing and using our own copy of `cPickle`. It also makes the corresponding changes to `pickle`.",
    "created_at": "2009-10-09T08:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52448",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:17'></a>I'm uploading a new python spkg, which is the same as the previous one I posted, but based on the most recent python spkg in Sage. It's here:

  http://sage.math.washington.edu/home/craigcitro/python-2.6.2.p4.spkg

This fixes the issue by patching the files in our python spkg instead of importing and using our own copy of `cPickle`. It also makes the corresponding changes to `pickle`.



---

archive/issue_comments_052449.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2009-10-11T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52449",
    "user": "https://github.com/nthiery"
}
```

Changing priority from major to critical.



---

archive/issue_events_014042.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-10-11T08:44:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "milestone": "sage-4.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5985#event-14042"
}
```



---

archive/issue_events_014043.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2009-10-11T08:44:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "milestone": "sage-4.1.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5985#event-14043"
}
```



---

archive/issue_comments_052450.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 craigcitro]:\n> I'm uploading a new python spkg, which is the same as the previous one I posted, but based on the most recent python spkg in Sage. It's here:\n> \n>   http://sage.math.washington.edu/home/craigcitro/python-2.6.2.p4.spkg\n> \n> This fixes the issue by patching the files in our python spkg instead of importing and using our own copy of `cPickle`. It also makes the corresponding changes to `pickle`. \n\n\nSounds good to me! Positive review, up to someone double checking the new patch I attached which imports the test file from the original version of the patch.\n\nCarl, Craig, Robert, please do it soon! William is ok integrating this in 4.1.2 (see IRC).\nI set back the release to 4.1.2\n\nFor the author / reviewer, I don't know exactly what to do since I wrote the first version, Craig reviewed it, wrote the second version which I reviewed :-) Please set whatever you feel appropriate",
    "created_at": "2009-10-11T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52450",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:18'></a>Replying to [comment:17 craigcitro]:
> I'm uploading a new python spkg, which is the same as the previous one I posted, but based on the most recent python spkg in Sage. It's here:
> 
>   http://sage.math.washington.edu/home/craigcitro/python-2.6.2.p4.spkg
> 
> This fixes the issue by patching the files in our python spkg instead of importing and using our own copy of `cPickle`. It also makes the corresponding changes to `pickle`. 


Sounds good to me! Positive review, up to someone double checking the new patch I attached which imports the test file from the original version of the patch.

Carl, Craig, Robert, please do it soon! William is ok integrating this in 4.1.2 (see IRC).
I set back the release to 4.1.2

For the author / reviewer, I don't know exactly what to do since I wrote the first version, Craig reviewed it, wrote the second version which I reviewed :-) Please set whatever you feel appropriate



---

archive/issue_comments_052451.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,19 @@\n+Original implementation:\n \n+The first patch imports the vanilla cPickle.c and test_cpickle.py\n+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the\n+cPickle imports throughout the sage library.\n+\n+The second patch makes a very small modification to cPickle to allow\n+for customizing how class are pickled via metaclasses.\n+\n+Final implementation: adds the second patch to the python spkg\n+\n+See discussions on:\n+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/\n+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/\n+\n+Thanks to Mike, Burcin, and Carl for suggestions on how to handle this.\n \n Summary: cPickle: adds support for class pickling customizing  and for nested classes\n \n``````\n",
    "created_at": "2009-10-11T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52451",
    "user": "https://github.com/nthiery"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,19 @@
+Original implementation:
 
+The first patch imports the vanilla cPickle.c and test_cpickle.py
+from python 2.5.2.p9 as sage.misc.cPickle, and updates accordingly the
+cPickle imports throughout the sage library.
+
+The second patch makes a very small modification to cPickle to allow
+for customizing how class are pickled via metaclasses.
+
+Final implementation: adds the second patch to the python spkg
+
+See discussions on:
+- http://groups.google.com/group/comp.lang.python/browse_thread/thread/66c282afc04aa39c/
+- http://groups.google.com/group/sage-devel/browse_thread/thread/583048dc7d373d6a/
+
+Thanks to Mike, Burcin, and Carl for suggestions on how to handle this.
 
 Summary: cPickle: adds support for class pickling customizing  and for nested classes
 
``````




---

archive/issue_comments_052452.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Craig Citro, Nicolas M. Thi\u00e9ry\"",
    "created_at": "2009-10-11T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52452",
    "user": "https://github.com/nthiery"
}
```

Changing reviewer from "" to "Craig Citro, Nicolas M. Thiéry"



---

archive/issue_comments_052453.json:
```json
{
    "body": "Changing author from \"\" to \"Craig Citro, Nicolas M. Thi\u00e9ry\"",
    "created_at": "2009-10-11T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52453",
    "user": "https://github.com/nthiery"
}
```

Changing author from "" to "Craig Citro, Nicolas M. Thiéry"



---

archive/issue_comments_052454.json:
```json
{
    "body": "<a id='comment:19'></a>I'm happy with Nicolas's patch to test the new python spkg -- let's finally get this merged! Yay!",
    "created_at": "2009-10-15T06:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52454",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:19'></a>I'm happy with Nicolas's patch to test the new python spkg -- let's finally get this merged! Yay!



---

archive/issue_comments_052455.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-10-15T06:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52455",
    "user": "https://github.com/craigcitro"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_052456.json:
```json
{
    "body": "Attachment [trac_5985_test_class_pickling.patch](tarball://root/attachments/some-uuid/ticket5985/trac_5985_test_class_pickling.patch) by @mwhansen created at 2009-10-15 06:55:09\n\nApply only this patch, after updating the python spkg linked to below",
    "created_at": "2009-10-15T06:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52456",
    "user": "https://github.com/mwhansen"
}
```

Attachment [trac_5985_test_class_pickling.patch](tarball://root/attachments/some-uuid/ticket5985/trac_5985_test_class_pickling.patch) by @mwhansen created at 2009-10-15 06:55:09

Apply only this patch, after updating the python spkg linked to below



---

archive/issue_comments_052457.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-10-15T06:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52457",
    "user": "https://github.com/mwhansen"
}
```

Resolution: fixed



---

archive/issue_comments_052458.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.2.alpha0\"",
    "created_at": "2009-10-15T06:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52458",
    "user": "https://github.com/mwhansen"
}
```

Changing merged from "" to "sage-4.2.alpha0"



---

archive/issue_events_014044.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-10-15T06:56:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/5985#event-14044"
}
```



---

archive/issue_comments_052459.json:
```json
{
    "body": "<a id='comment:20'></a>I updated the patch to do \"import cPickle\" instead of importing it from sage.misc.  After that, everything passes.",
    "created_at": "2009-10-15T06:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/5985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/5985#issuecomment-52459",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:20'></a>I updated the patch to do "import cPickle" instead of importing it from sage.misc.  After that, everything passes.
