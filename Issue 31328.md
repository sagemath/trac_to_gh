# Issue 31328: Build still non-portable despite SAGE_FAT_BINARY=yes because of numpy

Issue created by migration from https://trac.sagemath.org/ticket/31565

Original creator: mkoeppe

Original creation time: 2021-03-26 16:24:28

CC:  embray @kliem dimpase vbraun fbissey slelievre

Follow-up from #29537, #31521.

Observed on `cygwin-standard` but likely also affects the Docker images.


---

Comment by fbissey created at 2021-03-29 03:31:53

What are the symptoms? I don't really do cygwin but I may do docker one day.


---

Comment by mkoeppe created at 2021-04-03 01:33:40

The symptom is that something you build on one machine does not run on another machine, aborting with SIGILL.


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by mkoeppe created at 2021-06-04 18:38:18

Changing priority from critical to blocker.


---

Comment by @kliem created at 2021-06-04 18:40:26

I guess we need to unwind #31521 now??


---

Comment by mkoeppe created at 2021-06-04 20:22:52

Ah, that's right!


---

Comment by mkoeppe created at 2021-06-19 18:42:53

New commits:


---

Comment by mkoeppe created at 2021-06-19 18:42:53

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-06-19 20:48:41

Thanks for taking care of this.


---

Comment by mkoeppe created at 2021-06-20 15:52:29

The `cygwin-standard` build looked rather promising (no "baseline optimizations" message, no crash when just importing numpy) but I am getting crashes again https://github.com/mkoeppe/sage/runs/2867645468 when the doctests do any plotting.


---

Comment by mkoeppe created at 2021-06-20 15:57:39

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-20 15:57:39

The other runs at https://github.com/mkoeppe/sage/runs/2865933225?check_suite_focus=true look clean.

So I consider this ticket already an improvement. We'll have to chase the crash on cygwin when switching CPUs between build stages in ... yet another ... follow-up ticket.


---

Comment by dimpase created at 2021-06-21 12:30:15

More numpy-related trouble, looking as e.g. from  https://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com. (there are more reports like this)

```
[sagelib-9.4.beta2]   File "/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py", line 7, in <module>
[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (
[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: 
[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:
[sagelib-9.4.beta2] (POPCNT).
```

So somehow CPU changes its state, and refuses to say yes to features tested as yes during the Numpy build?!
Is it due to some CPU flags manipulations happening during sagelib build?


---

Comment by dimpase created at 2021-06-21 12:39:50

I've opened #32021 to deal with that `RuntimeError: NumPy was built with baseline optimizations:` thing.


---

Comment by @kliem created at 2021-06-22 11:30:58

Acutally the definition of `cpu-dispatch` in `NUMPY_FCONFIG` isn't clean. However, only the vallue will be passed and not the variable `NUMPY_FCONFIG`.


---

Comment by @kliem created at 2021-06-22 18:16:54

This doesn't work. See #32021#comment:10.

It's a build option not a configure option.


---

Comment by @kliem created at 2021-06-22 18:16:54

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2021-06-22 19:51:23

Actually the place to do it is correct however:

> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.

So this does not work for `bdist_wheel` and this is what we use.


---

Comment by mkoeppe created at 2021-06-22 20:03:06

You can do `setup.py bdist_wheel build [...build-options...]`, see for example build/pkgs/jupyter_jsmol/spkg-install.in


---

Comment by @kliem created at 2021-06-22 20:15:18

Thanks. This seems to do the trick.

Actually this itself might even work for this ticket here.


---

Comment by @kliem created at 2021-06-23 11:24:06

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-06-23 11:24:06

New commits:


---

Comment by @kliem created at 2021-06-23 11:25:54

https://github.com/kliem/sage/pull/46/checks


---

Comment by mkoeppe created at 2021-07-19 03:05:49

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2021-07-19 03:05:49

Unclear whether this is still needed now that #32021 is merged in 9.4.beta5


---

Comment by mkoeppe created at 2021-07-21 22:58:29

With #32021 and the `pynac` build failure fixed by #32257, we are back to being able to build and run the testsuite on Cygwin. https://github.com/mkoeppe/sage/runs/3126612760?check_suite_focus=true

Numerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.

I'll try out the branch of the present ticket on top of #32257.


---

Comment by git created at 2021-07-21 22:59:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-07-21 23:30:10

That's now running at https://github.com/mkoeppe/sage/actions/runs/1054288431


---

Comment by mkoeppe created at 2021-07-22 14:55:36

Replying to [comment:28 mkoeppe]:
> Numerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.
> 
> I'll try out the branch of the present ticket on top of #32257.

Same issues as before.


---

Comment by mkoeppe created at 2021-07-22 15:30:28

Testing with #32080 merged at https://github.com/mkoeppe/sage/actions/runs/1056686451


---

Comment by mkoeppe created at 2021-07-23 22:45:00

Also with #32080 no change. Segfaults on every plot.

Next step would be to try to reproduce this in a local installation in Cygwin.


---

Comment by mkoeppe created at 2021-07-23 22:45:00

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2021-07-26 17:05:53

Changing priority from blocker to critical.


---

Comment by mkoeppe created at 2021-07-26 17:06:43

Reduced to critical - see https://groups.google.com/g/sage-release/c/91CGN0cra2k/m/1WwPZNshBQAJ


---

Comment by tmonteil created at 2021-08-03 10:03:56

Changing keywords from "" to "sdl".


---

Comment by tmonteil created at 2021-08-03 10:03:56

I confirm that this branch fixes SSE2 bug for numpy in a quemulated Pentium 3. Note however that the error appeared at run time not build time.

As this will allow me to rebuild 32bit patchbots and a new SDL for bullseye release (which i did not do for a while), i am +1 for setting this ticket a blocker and get it merged in 9.4.


---

Comment by tmonteil created at 2021-08-03 21:23:19

Changing status from needs_work to positive_review.


---

Comment by tmonteil created at 2021-08-03 21:23:19

Changing priority from critical to blocker.


---

Comment by tmonteil created at 2021-08-03 21:23:19

If nobody complains.


---

Comment by vbraun created at 2021-08-08 15:37:02

Resolution: fixed
