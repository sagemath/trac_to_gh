# Issue 31328: Build still non-portable despite SAGE_FAT_BINARY=yes because of numpy

archive/issues_031328.json:
```json
{
    "body": "CC:  @embray @kliem @dimpase @vbraun @kiwifb @slel\n\nFollow-up from #29537, #31521.\n\nObserved on `cygwin-standard` but likely also affects the Docker images.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31565\n\n",
    "created_at": "2021-03-26T16:24:28Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Build still non-portable despite SAGE_FAT_BINARY=yes because of numpy",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31328",
    "user": "@mkoeppe"
}
```
CC:  @embray @kliem @dimpase @vbraun @kiwifb @slel

Follow-up from #29537, #31521.

Observed on `cygwin-standard` but likely also affects the Docker images.

Issue created by migration from https://trac.sagemath.org/ticket/31565





---

archive/issue_comments_448028.json:
```json
{
    "body": "What are the symptoms? I don't really do cygwin but I may do docker one day.",
    "created_at": "2021-03-29T03:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448028",
    "user": "@kiwifb"
}
```

What are the symptoms? I don't really do cygwin but I may do docker one day.



---

archive/issue_comments_448029.json:
```json
{
    "body": "The symptom is that something you build on one machine does not run on another machine, aborting with SIGILL.",
    "created_at": "2021-04-03T01:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448029",
    "user": "@mkoeppe"
}
```

The symptom is that something you build on one machine does not run on another machine, aborting with SIGILL.



---

archive/issue_comments_448030.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448030",
    "user": "@mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_448031.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-06-04T18:38:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448031",
    "user": "@mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_448032.json:
```json
{
    "body": "I guess we need to unwind #31521 now??",
    "created_at": "2021-06-04T18:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448032",
    "user": "@kliem"
}
```

I guess we need to unwind #31521 now??



---

archive/issue_comments_448033.json:
```json
{
    "body": "Ah, that's right!",
    "created_at": "2021-06-04T20:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448033",
    "user": "@mkoeppe"
}
```

Ah, that's right!



---

archive/issue_comments_448034.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-19T18:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448034",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_448035.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-19T18:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448035",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448036.json:
```json
{
    "body": "Thanks for taking care of this.",
    "created_at": "2021-06-19T20:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448036",
    "user": "@kliem"
}
```

Thanks for taking care of this.



---

archive/issue_comments_448037.json:
```json
{
    "body": "The `cygwin-standard` build looked rather promising (no \"baseline optimizations\" message, no crash when just importing numpy) but I am getting crashes again https://github.com/mkoeppe/sage/runs/2867645468 when the doctests do any plotting.",
    "created_at": "2021-06-20T15:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448037",
    "user": "@mkoeppe"
}
```

The `cygwin-standard` build looked rather promising (no "baseline optimizations" message, no crash when just importing numpy) but I am getting crashes again https://github.com/mkoeppe/sage/runs/2867645468 when the doctests do any plotting.



---

archive/issue_comments_448038.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-20T15:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448038",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448039.json:
```json
{
    "body": "The other runs at https://github.com/mkoeppe/sage/runs/2865933225?check_suite_focus=true look clean.\n\nSo I consider this ticket already an improvement. We'll have to chase the crash on cygwin when switching CPUs between build stages in ... yet another ... follow-up ticket.",
    "created_at": "2021-06-20T15:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448039",
    "user": "@mkoeppe"
}
```

The other runs at https://github.com/mkoeppe/sage/runs/2865933225?check_suite_focus=true look clean.

So I consider this ticket already an improvement. We'll have to chase the crash on cygwin when switching CPUs between build stages in ... yet another ... follow-up ticket.



---

archive/issue_comments_448040.json:
```json
{
    "body": "More numpy-related trouble, looking as e.g. from  https://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com. (there are more reports like this)\n\n```\n[sagelib-9.4.beta2]   File \"/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py\", line 7, in <module>\n[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (\n[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: \n[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:\n[sagelib-9.4.beta2] (POPCNT).\n```\n\nSo somehow CPU changes its state, and refuses to say yes to features tested as yes during the Numpy build?!\nIs it due to some CPU flags manipulations happening during sagelib build?",
    "created_at": "2021-06-21T12:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448040",
    "user": "@dimpase"
}
```

More numpy-related trouble, looking as e.g. from  https://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com. (there are more reports like this)

```
[sagelib-9.4.beta2]   File "/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py", line 7, in <module>
[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (
[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: 
[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:
[sagelib-9.4.beta2] (POPCNT).
```

So somehow CPU changes its state, and refuses to say yes to features tested as yes during the Numpy build?!
Is it due to some CPU flags manipulations happening during sagelib build?



---

archive/issue_comments_448041.json:
```json
{
    "body": "I've opened #32021 to deal with that `RuntimeError: NumPy was built with baseline optimizations:` thing.",
    "created_at": "2021-06-21T12:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448041",
    "user": "@dimpase"
}
```

I've opened #32021 to deal with that `RuntimeError: NumPy was built with baseline optimizations:` thing.



---

archive/issue_comments_448042.json:
```json
{
    "body": "Acutally the definition of `cpu-dispatch` in `NUMPY_FCONFIG` isn't clean. However, only the vallue will be passed and not the variable `NUMPY_FCONFIG`.",
    "created_at": "2021-06-22T11:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448042",
    "user": "@kliem"
}
```

Acutally the definition of `cpu-dispatch` in `NUMPY_FCONFIG` isn't clean. However, only the vallue will be passed and not the variable `NUMPY_FCONFIG`.



---

archive/issue_comments_448043.json:
```json
{
    "body": "This doesn't work. See #32021#comment:10.\n\nIt's a build option not a configure option.",
    "created_at": "2021-06-22T18:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448043",
    "user": "@kliem"
}
```

This doesn't work. See #32021#comment:10.

It's a build option not a configure option.



---

archive/issue_comments_448044.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-06-22T18:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448044",
    "user": "@kliem"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_448045.json:
```json
{
    "body": "Actually the place to do it is correct however:\n\n> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.\n\nSo this does not work for `bdist_wheel` and this is what we use.",
    "created_at": "2021-06-22T19:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448045",
    "user": "@kliem"
}
```

Actually the place to do it is correct however:

> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.

So this does not work for `bdist_wheel` and this is what we use.



---

archive/issue_comments_448046.json:
```json
{
    "body": "You can do `setup.py bdist_wheel build [...build-options...]`, see for example build/pkgs/jupyter_jsmol/spkg-install.in",
    "created_at": "2021-06-22T20:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448046",
    "user": "@mkoeppe"
}
```

You can do `setup.py bdist_wheel build [...build-options...]`, see for example build/pkgs/jupyter_jsmol/spkg-install.in



---

archive/issue_comments_448047.json:
```json
{
    "body": "Thanks. This seems to do the trick.\n\nActually this itself might even work for this ticket here.",
    "created_at": "2021-06-22T20:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448047",
    "user": "@kliem"
}
```

Thanks. This seems to do the trick.

Actually this itself might even work for this ticket here.



---

archive/issue_comments_448048.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-23T11:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448048",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_448049.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-23T11:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448049",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_448050.json:
```json
{
    "body": "https://github.com/kliem/sage/pull/46/checks",
    "created_at": "2021-06-23T11:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448050",
    "user": "@kliem"
}
```

https://github.com/kliem/sage/pull/46/checks



---

archive/issue_comments_448051.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-07-19T03:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448051",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_448052.json:
```json
{
    "body": "Unclear whether this is still needed now that #32021 is merged in 9.4.beta5",
    "created_at": "2021-07-19T03:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448052",
    "user": "@mkoeppe"
}
```

Unclear whether this is still needed now that #32021 is merged in 9.4.beta5



---

archive/issue_comments_448053.json:
```json
{
    "body": "With #32021 and the `pynac` build failure fixed by #32257, we are back to being able to build and run the testsuite on Cygwin. https://github.com/mkoeppe/sage/runs/3126612760?check_suite_focus=true\n\nNumerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.\n\nI'll try out the branch of the present ticket on top of #32257.",
    "created_at": "2021-07-21T22:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448053",
    "user": "@mkoeppe"
}
```

With #32021 and the `pynac` build failure fixed by #32257, we are back to being able to build and run the testsuite on Cygwin. https://github.com/mkoeppe/sage/runs/3126612760?check_suite_focus=true

Numerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.

I'll try out the branch of the present ticket on top of #32257.



---

archive/issue_comments_448054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-21T22:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448054",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448055.json:
```json
{
    "body": "That's now running at https://github.com/mkoeppe/sage/actions/runs/1054288431",
    "created_at": "2021-07-21T23:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448055",
    "user": "@mkoeppe"
}
```

That's now running at https://github.com/mkoeppe/sage/actions/runs/1054288431



---

archive/issue_comments_448056.json:
```json
{
    "body": "Replying to [comment:28 mkoeppe]:\n> Numerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.\n> \n> I'll try out the branch of the present ticket on top of #32257.\n\nSame issues as before.",
    "created_at": "2021-07-22T14:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448056",
    "user": "@mkoeppe"
}
```

Replying to [comment:28 mkoeppe]:
> Numerous SIGSEGVs whenever plotting is involved point to more trouble with numpy.
> 
> I'll try out the branch of the present ticket on top of #32257.

Same issues as before.



---

archive/issue_comments_448057.json:
```json
{
    "body": "Testing with #32080 merged at https://github.com/mkoeppe/sage/actions/runs/1056686451",
    "created_at": "2021-07-22T15:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448057",
    "user": "@mkoeppe"
}
```

Testing with #32080 merged at https://github.com/mkoeppe/sage/actions/runs/1056686451



---

archive/issue_comments_448058.json:
```json
{
    "body": "Also with #32080 no change. Segfaults on every plot.\n\nNext step would be to try to reproduce this in a local installation in Cygwin.",
    "created_at": "2021-07-23T22:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448058",
    "user": "@mkoeppe"
}
```

Also with #32080 no change. Segfaults on every plot.

Next step would be to try to reproduce this in a local installation in Cygwin.



---

archive/issue_comments_448059.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-07-23T22:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448059",
    "user": "@mkoeppe"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_448060.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2021-07-26T17:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448060",
    "user": "@mkoeppe"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_448061.json:
```json
{
    "body": "Reduced to critical - see https://groups.google.com/g/sage-release/c/91CGN0cra2k/m/1WwPZNshBQAJ",
    "created_at": "2021-07-26T17:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448061",
    "user": "@mkoeppe"
}
```

Reduced to critical - see https://groups.google.com/g/sage-release/c/91CGN0cra2k/m/1WwPZNshBQAJ



---

archive/issue_comments_448062.json:
```json
{
    "body": "Changing keywords from \"\" to \"sdl\".",
    "created_at": "2021-08-03T10:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448062",
    "user": "tmonteil"
}
```

Changing keywords from "" to "sdl".



---

archive/issue_comments_448063.json:
```json
{
    "body": "I confirm that this branch fixes SSE2 bug for numpy in a quemulated Pentium 3. Note however that the error appeared at run time not build time.\n\nAs this will allow me to rebuild 32bit patchbots and a new SDL for bullseye release (which i did not do for a while), i am +1 for setting this ticket a blocker and get it merged in 9.4.",
    "created_at": "2021-08-03T10:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448063",
    "user": "tmonteil"
}
```

I confirm that this branch fixes SSE2 bug for numpy in a quemulated Pentium 3. Note however that the error appeared at run time not build time.

As this will allow me to rebuild 32bit patchbots and a new SDL for bullseye release (which i did not do for a while), i am +1 for setting this ticket a blocker and get it merged in 9.4.



---

archive/issue_comments_448064.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-08-03T21:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448064",
    "user": "tmonteil"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_448065.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-08-03T21:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448065",
    "user": "tmonteil"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_448066.json:
```json
{
    "body": "If nobody complains.",
    "created_at": "2021-08-03T21:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448066",
    "user": "tmonteil"
}
```

If nobody complains.



---

archive/issue_comments_448067.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-08-08T15:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31328#issuecomment-448067",
    "user": "@vbraun"
}
```

Resolution: fixed
