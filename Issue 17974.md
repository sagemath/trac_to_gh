# Issue 17974: Computing Ehrhart polynomials with LattE

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-04-15 19:53:50

CC:  chapoton bedutra mkoeppe vbraun ncohen

We just call LattE (command `count`) through the command line to get the Ehrhard polynomial of a lattice polytope.


---

Comment by vdelecroix created at 2015-04-15 19:54:31

Changing status from new to needs_review.


---

Comment by git created at 2015-04-15 19:54:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2015-04-15 20:16:19

This looks great to me. 

In the docstring, could you fix the spelling: "LattE integral" -> "LattE integrale"

Also, LattE has many options that control the type of algorithm used. 
For example, for many examples "--maxdet=1000" will make the calculation much faster.  
Is there a way to allow the user to pass such options to LattE?


---

Comment by vdelecroix created at 2015-04-15 20:25:16

Hello Matthias,

Replying to [comment:3 mkoeppe]:
> This looks great to me. 
> 
> In the docstring, could you fix the spelling: "LattE integral" -> "LattE integrale"

Will do. Thanks. I was not sure if I needed to cite people for LattE contribution, should I?
  
> Also, LattE has many options that control the type of algorithm used. 
> For example, for many examples "--maxdet=1000" will make the calculation much faster.  
> Is there a way to allow the user to pass such options to LattE?

Yes, whatever you want. The function `Popen` of python is flexible to send any option to the command line. Could you describe the set of option that will be interesting to have?

(I am currently testing the new method on the Sage library of polytopes... and I found plenty of bugs!)

Vincent


---

Comment by vdelecroix created at 2015-04-15 20:25:30

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2015-04-15 20:31:05

Error checking would be nice. Probably just use `subprocess.check_output`


---

Comment by vdelecroix created at 2015-04-15 20:50:45

Replying to [comment:7 vbraun]:
> Error checking would be nice. Probably just use `subprocess.check_output`

Is `check_output` compatible with `Popen`? Is the following ok

```
latte_proc = Popen(*args)
ans, err = latte_proc.communicate()
ret_code = latte_proc.poll()
if ret_code:
    raise ValueError
```



---

Comment by git created at 2015-04-15 21:31:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-15 21:33:50

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-15 21:33:50

All right, LattE is correctly spelled, output is checked and options are taken into account! Needs review again.

Vincent


---

Comment by vdelecroix created at 2015-04-15 21:43:53

By the way, I am not sure about the place where I put the code. It is currently in `base_ZZ.py` which means that the polytope has to be defined with equations with coefficients in `ZZ`. But it might be that some polyhedron with coefficients in `QQ` actually give a lattice polytope. If anybody has an idea about that.


---

Comment by mkoeppe created at 2015-04-15 21:50:36

The LattE command line options need to be written with dashes, not underscores:

--irrational_primal --> --irrational-primal
--irrational_all_primal --> --irrational-all-primal

The docstring mentions no_decomposition, but it is not handled in the code


---

Comment by vdelecroix created at 2015-04-15 21:53:50

Replying to [comment:12 mkoeppe]:
> The LattE command line options need to be written with dashes, not underscores:
> 
> --irrational_primal --> --irrational-primal
> --irrational_all_primal --> --irrational-all-primal

Right... LattE did not complain very hard.

> The docstring mentions no_decomposition, but it is not handled in the code

Will do.

If you have time, could you provide more details about the command line option. I found the LattE documentation quite cryptic to that respect.

Vincent


---

Comment by git created at 2015-04-15 22:00:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2015-04-16 00:45:41

For complete argument checking, it should probably say "if maxdet is not None".


---

Comment by jdemeyer created at 2015-04-16 06:07:24

Instead of using `is_package_installed()`, I would prefer the more Pythonic

```
try:
    latte_proc = Popen(args, stdin = PIPE, stdout=PIPE, stderr=PIPE)
except OSError:
    raise ValueError("The package latte_int must be installed!\n" + package_mesg())
```



---

Comment by ncohen created at 2015-04-16 10:55:45

Is this `if maxdet` ok or should it be `if maxdet is not None` ? I am wondering about the case `maxdet=0` (if it makes any sense).


---

Comment by ncohen created at 2015-04-16 11:08:42

(oops sorry mkoeppe. I had not noticed you had made this comment already)

I get a broken doctest about a parent:


```
File "polyhedron/base_ZZ.py", line 191, in sage.geometry.polyhedron.base_ZZ.Polyhedron_ZZ.?
Failed example:
    parent(_)
Expected:
    Univariate Polynomial Ring in t over Rational Field
Got:
    <type 'int'>
```


This is apparently solved with a `optional - latte_int`


---

Comment by ncohen created at 2015-04-16 11:31:56

Once the package is installed, I get another broken doctest

```
File "polyhedron/library.py", line 179, in sage.geometry.polyhedron.library.Polytopes.Birkhoff_polytope
Failed example:
    p3 = b3.ehrhart_polynomial()     # optional - latte_int
Expected:
    1/8*t^4 + 3/4*t^3 + 15/8*t^2 + 9/4*t + 1
Got:
    <BLANKLINE>
```


I have a question about the way you call the process, however. The way it is done, it seems that no output is being printed before the process has ended. If the user asked for verbosity, wouldn't it be better to just let the process print to stdout so that one can get some info on the process *while* it is running? 

It seems that you only need to do `stdout=(None if verbose else PIPE)`.

Nathann


---

Comment by git created at 2015-04-16 13:49:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-16 13:51:39

`count` is annoying as it always creates the two files `latte_stats` and `totalTime`. And possibly: `tri.ead`, `tri.ecd`, `tri.ext`, `tri.iad`, `tri.icd`, `tri.ine` depending on the options... I modified the execution path to be `SAGE_TMP` (the option `cwd` in `Popen`).

I also sorted out all other comments except [comment:20 comment:20]. If I set `stderr` or `stdout` to something else than `PIPE` then I am not able to get the result of the command back when doing `process.communicate()`.


---

Comment by ncohen created at 2015-04-16 14:12:14

> I also sorted out all other comments except [comment:20 comment:20]. If I set `stderr` or `stdout` to something else than `PIPE` then I am not able to get the result of the command back when doing `process.communicate()`.

God. I had not noticed that you were reading the result from the output `:-D`

With the code from [1] you can do whatever you want with the output:

```
sage: from subprocess import Popen, PIPE
sage: p = Popen("ls",stdout=PIPE)
sage: for line in iter(p.stdout.readline,''):
....:     print line.strip()
```


And to check that it does not wait for the process to end, you can run a 'tail -f' on some (existing) temporary file


```
sage: p = Popen(["tail","-f","/tmp/eee"],stdout=PIPE)
sage: for line in iter(p.stdout.readline,''):
....:     print line.strip()
```


A new line appears in python every time you type "echo artartaert >> /tmp/eee" in a terminal.

[1] http://stackoverflow.com/questions/2804543/read-subprocess-stdout-line-by-line


---

Comment by vdelecroix created at 2015-04-16 14:30:28

Replying to [comment:23 ncohen]:
> > I also sorted out all other comments except [comment:20 comment:20]. If I set `stderr` or `stdout` to something else than `PIPE` then I am not able to get the result of the command back when doing `process.communicate()`.
> 
> God. I had not noticed that you were reading the result from the output `:-D`
> 
> With the code from [1] you can do whatever you want with the output:

Thoug, I do not find it very usable in the current context.


---

Comment by ncohen created at 2015-04-16 14:31:50

> Thoug, I do not find it very usable in the current context.

What's the problem?


---

Comment by vdelecroix created at 2015-04-16 14:38:49

Replying to [comment:26 ncohen]:
> > Thoug, I do not find it very usable in the current context.
> 
> What's the problem?

The Ehrhart polynomial appears on `stdout` (it is not the last line but the one before). While most of the information about the computation appears on `stderr`. I do not see how to achieve what you suggests in less then 10 unreadable lines. But feel free to have a try on top of commit `b877932`.


---

Comment by ncohen created at 2015-04-16 14:39:51

Then why don't you just let stderr be printed to the screen and only intercept stdout ?

Nathann


---

Comment by git created at 2015-04-16 14:46:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-16 14:47:17

Replying to [comment:28 ncohen]:
> Then why don't you just let stderr be printed to the screen and only intercept stdout ?

right right right! see last commit! Thanks.


---

Comment by ncohen created at 2015-04-16 15:10:00

Hello !

There was still a (very unimportant) problem when `verbose=True` and the process returns with an error. In this case the exception displays an (empty) variable `err`.

I fixed this nonexisting problem at public/18211, though I have not been able to make the process return with an error. Even when I changed "--cdd" with "--crghalruhaldd" it returned 'normaly' `:-P`

Nathann


---

Comment by ncohen created at 2015-04-16 15:11:16

P.S. : you probably got a 10000x speedup with the replacement in `Birkhoff_polytope` `:-P`


---

Comment by ncohen created at 2015-04-16 15:22:22

(just added another commits with 'seealsos')


---

Comment by vdelecroix created at 2015-04-16 15:26:51

I do not want your `SEEALSO` here. Could we postpone it to #18213?


---

Comment by ncohen created at 2015-04-16 15:28:47

> I do not want your `SEEALSO` here.

`O_o`

Sorry?


---

Comment by vdelecroix created at 2015-04-16 15:31:13

Replying to [comment:35 ncohen]:
> > I do not want your `SEEALSO` here.
> 
> `O_o`
> 
> Sorry?

By "here" I meant "in this ticket". Your commit is likely to create a conflict with #18213. It would be easier to move your changes on top of #18213.


---

Comment by ncohen created at 2015-04-16 15:32:02

> By "here" I meant "in this ticket". Your commit is likely to create a conflict with #18213. It would be easier to move your changes on top of #18213.

Oh. Well, yeah no problem: just cherry-pick it on the top of your other branch if it is easier.

Nathann


---

Comment by git created at 2015-04-16 15:32:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-16 15:36:15

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-16 15:37:05

Replying to [comment:37 ncohen]:
> > By "here" I meant "in this ticket". Your commit is likely to create a conflict with #18213. It would be easier to move your changes on top of #18213.
> 
> Oh. Well, yeah no problem: just cherry-pick it on the top of your other branch if it is easier.

done!


---

Comment by vdelecroix created at 2015-04-16 15:38:41

Thanks for the review! (I added Matthias to the reviewer list too)


---

Comment by mkoeppe created at 2015-04-16 15:52:54

This looks great, thanks a lot for your work.

There are, however, quite a few more LattE options that are useful, at least for expert users. 
Below I list the ones (this is cut and paste from "count --help") that make sense for the "--ehrhart-polynomial" mode.


```
  --compute-vertex-cones={cdd,lrs,4ti2}    Use this method for computing vertex cones
  --smith-form={ilio,lidia}
  --dualization={cdd,4ti2}
  --triangulation={cddlib,4ti2,topcom,...}
  --triangulation-max-height=HEIGHT        Use a uniform distribution of height from 1 to HEIGHT.
```



---

Comment by vdelecroix created at 2015-04-16 15:55:03

will add it... (sorry Nathann)


---

Comment by vdelecroix created at 2015-04-16 15:55:03

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-16 16:13:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-16 16:14:34

All right, you can now send whatever option you like to `count` even if its not documented!


---

Comment by vdelecroix created at 2015-04-16 16:14:34

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-16 16:21:40

But now you really have a problem with the error code returned by 'count'


```
sage: P.ehrhart_polynomial(argaerh=3)
...
IndexError: list index out of range
```



---

Comment by mkoeppe created at 2015-04-16 16:23:32

And also now there is no tab completion for the known keyword arguments any more, which is inconvenient


---

Comment by git created at 2015-04-16 16:28:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-16 16:40:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-16 16:41:47

Replying to [comment:47 mkoeppe]:
> And also now there is no tab completion for the known keyword arguments any more, which is inconvenient

corrected in 3c075b2


---

Comment by git created at 2015-04-16 16:43:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-16 16:45:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-16 16:45:55

Replying to [comment:50 vdelecroix]:
> Replying to [comment:47 mkoeppe]:
> > And also now there is no tab completion for the known keyword arguments any more, which is inconvenient
> 
> corrected in 3c075b2

Much better with 7215956


---

Comment by ncohen created at 2015-04-16 17:22:24

I added a commit at public/18211. If it's fine for you, you can change the status.

Nathann


---

Comment by ncohen created at 2015-04-16 17:24:04

About the error message: instead of the dictionary it prints the actual command. It may help debug things a bit better than the dictionary, in particular with the '_' -> '-' replacement.


---

Comment by git created at 2015-04-16 17:30:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-16 17:30:35

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-16 17:30:35

Nice! Thanks!


---

Comment by mkoeppe created at 2015-04-16 17:41:18

Has the question of ZZ vs. QQ been resolved? 

Perhaps more examples should be added that make uses of some of LattE's options. 
For example, an Ehrhart polynomial of a cross-polytope, which benefits from irrational_all_primal.


---

Comment by vdelecroix created at 2015-04-16 19:23:48

Replying to [comment:58 mkoeppe]:
> Has the question of ZZ vs. QQ been resolved? 

Actually, in the current state there is not much to do about this. The method `self.cdd_Hrepresentation` is only available for polytopes defined over ZZ.

> Perhaps more examples should be added that make uses of some of LattE's options. 
> For example, an Ehrhart polynomial of a cross-polytope, which benefits from irrational_all_primal.

That would be good indeed. You can propose a commit on top of what I did on the ticket #18213.

Vincent


---

Comment by mkoeppe created at 2015-04-16 22:27:30

In the doctests, is it wise to hard-code the version number of LattE?
Looks like this could cause trouble whenever the package is updated?


```
            sage: p = P.ehrhart_polynomial(irrational_primal=True, verbose=True)   # optional - latte_int
            This is LattE integrale 1.7.2
            ...
            Invocation: count --ehrhart-polynomial '--redundancy-check=none' --irrational-primal --cdd ...
            ...
            sage: p   # optional - latte_int
            1/2*t^2 + 3/2*t + 1

```



---

Comment by vdelecroix created at 2015-04-16 22:55:17

Replying to [comment:60 mkoeppe]:
> In the doctests, is it wise to hard-code the version number of LattE?
> Looks like this could cause trouble whenever the package is updated?

I hope that in the next version of LattE we will have a better return code than 0 in case of errors. So anyway, this code will be partly rewritten. The code is very much adapted to the current LattE, so it is good that when the package will be updated, people take care of this.


---

Comment by mkoeppe created at 2015-04-16 23:18:40

I see...  The return code 0 on errors is a regression in LattE's count, introduced in a recent version.  I was not aware of this.

We'll fix this in the next release of LattE.


---

Comment by vdelecroix created at 2015-04-17 11:52:18

Replying to [comment:62 mkoeppe]:
> I see...  The return code 0 on errors is a regression in LattE's count, introduced in a recent version.  I was not aware of this.
> 
> We'll fix this in the next release of LattE.

Nice!


---

Comment by kcrisman created at 2015-04-17 18:54:28

Does this then replicate some of the functionality of polymake?  (I'm never quite sure of the relationship between the two programs.)


---

Comment by mkoeppe created at 2015-04-18 00:44:09

Replying to [comment:64 kcrisman]:
> Does this then replicate some of the functionality of polymake?  (I'm never quite sure of the relationship between the two programs.)

Just like Sage, polymake interfaces with many libraries and programs. polymake does have a LattE interface for a subset of LattE's features.


---

Comment by vdelecroix created at 2015-04-18 09:13:31

A doctest fails. Am I allowed to correct it?


---

Comment by git created at 2015-04-18 09:27:46

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2015-04-18 09:27:46

Changing status from positive_review to needs_review.


---

Comment by ncohen created at 2015-04-18 10:14:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-19 01:52:07

Resolution: fixed
