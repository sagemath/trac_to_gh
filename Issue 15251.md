# Issue 15251: Fix misplaced sig_on() inside try

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-12-06 09:44:37

Many of these are my own fault, but

```
try:
    sig_on()
    ...
finally:
    sig_off()
```

should become

```
sig_on()
try:
    ...
finally:
    sig_off()
```



---

Comment by jdemeyer created at 2013-12-06 22:41:11

Changing status from new to needs_review.


---

Attachment


---

Comment by ncohen created at 2013-12-08 12:55:52

Hellooooooo Jeroen !

I have two questions about your patch:
* Why do you create two layers of try/catch in ppl.pyx around `rel.thisptr = new_relation_with(self.thisptr[0], g.thisptr[0])`
* Why do you replace `ValueError` by `BaseException` ?

Thaaaaaaaaaaaaaaaaaanks !

Nathann


---

Comment by ncohen created at 2013-12-08 12:55:52

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2013-12-08 13:15:21

Replying to [comment:2 ncohen]:
> * Why do you create two layers of try/catch?
Because there is no other way to achieve the same result with only one `try`/`finally` ;-)

> * Why do you replace `ValueError` by `BaseException` ?
Because the only purpose of that `except` branch is to put the object in a consistent state before re-raising the exception. I guess the "putting the object in a consistent state" part should also be done when other exceptions happen.


---

Comment by jdemeyer created at 2013-12-08 13:15:44

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2013-12-08 13:17:15

Yooooooooooooo !!

Thanks for your answer, but I still need to know more about the first question. In which case does your code behave differently from the former one ? Why didn't you just move the sig_off out ?

Nathann


---

Comment by jdemeyer created at 2013-12-08 13:41:55

Replying to [comment:5 ncohen]:
> In which case does your code behave differently from the former one ?
In the case that `sig_on()` raises an exception. Then `sig_off()` should not be called but setting `rel.thisptr` to a sensible value should happen.


---

Comment by pbruin created at 2013-12-08 14:46:46

Replying to [comment:3 jdemeyer]:
> > * Why do you replace `ValueError` by `BaseException` ?
> Because the only purpose of that `except` branch is to put the object in a consistent state before re-raising the exception. I guess the "putting the object in a consistent state" part should also be done when other exceptions happen.
And `except BaseException:` is equivalent to `except:`, since all exceptions derive from `BaseException`, don't they?  The second form looks slightly clearer to me.


---

Comment by pbruin created at 2013-12-08 14:53:11

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 ncohen]:
> > In which case does your code behave differently from the former one ?
> In the case that `sig_on()` raises an exception. Then `sig_off()` should not be called but setting `rel.thisptr` to a sensible value should happen.
It looks as if another way to solve this is to check if `self.thisptr != NULL` in `___dealloc__()`.  This is how a similar problem was fixed in #12888.  (Note: Cython initialises attributes to `NULL`.)


---

Comment by jdemeyer created at 2013-12-08 17:08:31

Replying to [comment:7 pbruin]:
> And `except BaseException:` is equivalent to `except:`, since all exceptions derive from `BaseException`, don't they?  The second form looks slightly clearer to me.
Explicit is better than implicit (see [The Zen of Python](http://www.python.org/dev/peps/pep-0020/)). I prefer `except BaseException:` because it's explicit that I really want to catch all exceptions.

In almost all cases where I saw `except:`, it was by mistake. In fact, as release manager, I simply rejected any patches containing `except:`.


---

Comment by vbraun created at 2013-12-09 00:13:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-12-09 00:13:30

lgtm

Replying to [comment:8 pbruin]:
> It looks as if another way to solve this is to check if `self.thisptr != NULL` in `___dealloc__()`. 

Yes, there is more than one way to solve this.


---

Comment by pbruin created at 2013-12-09 01:16:09

Replying to [comment:10 vbraun]:
> Yes, there is more than one way to solve this.

More wisdom from The Zen of Python (see above):

```
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
```

Not meant as an objection to this patch or to the positive review!


---

Comment by jdemeyer created at 2013-12-10 08:38:44

Resolution: fixed


---

Comment by jdemeyer created at 2013-12-10 08:38:44

Thanks for the quick review!
