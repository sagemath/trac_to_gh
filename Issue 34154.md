# Issue 34154: Upgrade: GAP 4.12

Issue created by migration from https://trac.sagemath.org/ticket/34391

Original creator: slelievre

Original creation time: 2022-08-20 05:46:21

CC:  arojas dimpase slelievre tornaria fbissey @collares tscrim

Keywords: spkg, upgrade, gap, libsemigroups

GAP 4.12.0 was released in August 2022.

- [GAP 4.12.0 release announcement](https://lists.uni-kl.de/gap/arc/forum/2022-08/msg00031.html)
- [GAP 4.12.0 release page](https://www.gap-system.org/Releases/4.12.0.html)
- [GAP 4.12.0: changes since GAP 4.11.1](https://github.com/gap-system/gap/blob/master/CHANGES.md#gap-4120-august-2022)

We should upgrade our corresponding spkgs:

- gap
- gap_packages
- libsemigroups

Previous upgrades:

- #31498: GAP 4.11.1
- #29314: GAP 4.11, libsemigroup 1.0.9


---

Comment by arojas created at 2022-08-29 21:12:23

Having upgraded downstream, here is a list of issues:

1) Build fails because a garbage collector needs to be specified via a preprocessor macro when using gap's headers. This is included in the CPPFLAGS in gap's own `sysinfo.gap`, but Sage doesn't read it when building.

2) Build fails due to API changes in `OpenOutputStream` and `CloseOutput`

3) Colored prompt is on by default, which breaks the pexpect interface.

4) The `NaturalHomomorphism` function, used in `groups.abelian_gps.abelian_group_gap`, has been removed.

5) The functions `IsPrimitive` and `IsTransitive` changed behavior and now return false if the group does not act on the given set, breaking some tests:

```
File "/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py", line 4363, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_transitive
Failed example:
    G.is_transitive([1,4,5])
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py", line 4428, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_primitive
Failed example:
    G.is_primitive([1,2,3])
Expected:
    True
Got:
    False
```


6) Computation of permutation group generators has changed, breaking some tests. In particular, using `algorithm=smaller` now does not make any difference in many examples.

7) Several trivial test failures due to different choice of generators or minor syntax changes.


---

Comment by arojas created at 2022-08-29 21:24:17

The branch fixes (2), (3), (4) and (7). For (5), we need to decide whether we want to follow the new behavior in GAP, or reimplement the old behavior in some other way. For (6), some tests need to be updated or removed.
----
New commits:


---

Comment by dimpase created at 2022-08-30 08:44:06

regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group _action_ on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.
(perhaps we should have a deprecation, in case False is returned, printing a warning about the change in behavior) 

How about (1) - should `spkg-install` source `sysinfo.gap` ?


---

Comment by fbissey created at 2022-08-30 08:56:33

Replying to [comment:6 dimpase]:
> regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group _action_ on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.
> 
> How about (1) - should `spkg-install` source `sysinfo.gap` ?

I think that is fine for gap packages but not for downstream packages. I guess it is a stop gap, but a standard way of setting the flags should be provided. A .pc file or at least a config utility. You shouldn't have to search for settings in an obscure internal file. This is a genuine upstream defect in my opinion.


---

Comment by dimpase created at 2022-08-30 09:04:26

By the way, `sysinfo.gap` is not in the tarball, it is generated by doing `make sysinfo.gap`, so this should be easy to incorporate. But it has `GAP_CPPFLAGS` rather than `CPPFLAGS`, at least on an install I'm trying this.

So this looks that our build somehow manages to avoid running `make sysinfo.gap`.


---

Comment by @collares created at 2022-09-23 21:18:35

I am seeing a bunch of segfaults on aarch64 with GAP 4.12.0 and this branch. The following patch, which copies the output string before calling `GAP_Leave`, seems to fix almost all of the segfaults, but not 100% of them (see https://github.com/NixOS/nixpkgs/pull/192548#issuecomment-1256686607 for more details):


```diff
diff --git a/src/sage/libs/gap/element.pxd b/src/sage/libs/gap/element.pxd
index a1bf8118d4..9a28de87ca 100644
--- a/src/sage/libs/gap/element.pxd
+++ b/src/sage/libs/gap/element.pxd
@@ -29,9 +29,9 @@ cdef GapElement_Boolean make_GapElement_Boolean(parent, Obj obj)
 cdef GapElement_Function make_GapElement_Function(parent, Obj obj)
 cdef GapElement_Permutation make_GapElement_Permutation(parent, Obj obj)
 
-cdef char *capture_stdout(Obj, Obj)
-cdef char *gap_element_str(Obj)
-cdef char *gap_element_repr(Obj)
+cdef str capture_stdout(Obj, Obj)
+cdef str gap_element_str(Obj)
+cdef str gap_element_repr(Obj)
 
 
 cdef class GapElement(RingElement):
diff --git a/src/sage/libs/gap/element.pyx b/src/sage/libs/gap/element.pyx
index e2681165a2..482f74bbcf 100644
--- a/src/sage/libs/gap/element.pyx
+++ b/src/sage/libs/gap/element.pyx
@@ -120,7 +120,7 @@ cdef Obj make_gap_matrix(sage_list, gap_ring) except NULL:
     return l.value
 
 
-cdef char *capture_stdout(Obj func, Obj obj):
+cdef str capture_stdout(Obj func, Obj obj):
     """
     Call a single-argument GAP function ``func`` with the argument ``obj``
     and return the stdout from that function call.
@@ -152,12 +152,12 @@ cdef char *capture_stdout(Obj func, Obj obj):
 
         CALL_1ARGS(func, obj)
         CloseOutput(&output)
-        return CSTR_STRING(s)
+        return char_to_str(CSTR_STRING(s))
     finally:
         GAP_Leave()
 
 
-cdef char *gap_element_repr(Obj obj):
+cdef str gap_element_repr(Obj obj):
     """
     Implement ``repr()`` of ``GapElement``s using the ``ViewObj()`` function,
     which is by default closest to what you get when displaying an object in
@@ -169,7 +169,7 @@ cdef char *gap_element_repr(Obj obj):
     return capture_stdout(func, obj)
 
 
-cdef char *gap_element_str(Obj obj):
+cdef str gap_element_str(Obj obj):
     """
     Implement ``str()`` of ``GapElement``s using the ``Print()`` function.
 
@@ -761,7 +761,7 @@ cdef class GapElement(RingElement):
         if  self.value == NULL:
             return 'NULL'
 
-        s = char_to_str(gap_element_str(self.value))
+        s = gap_element_str(self.value)
         return s.strip()
 
     def _repr_(self):
@@ -783,7 +783,7 @@ cdef class GapElement(RingElement):
         if  self.value == NULL:
             return 'NULL'
 
-        s = char_to_str(gap_element_repr(self.value))
+        s = gap_element_repr(self.value)
         return s.strip()
 
     cpdef _set_compare_by_id(self):
```



---

Comment by @collares created at 2022-09-23 23:13:09

I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. 

As a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).


---

Comment by arojas created at 2022-09-30 16:36:37

Replying to [comment:12 Mauricio Collares]:
> I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. 
> 
> As a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).

Feel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.


---

Comment by git created at 2022-09-30 17:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tornaria created at 2022-10-17 04:22:36

I have tested the last commmit (a6c293d) using system gap 4.12.0, on x86_64, x86_64-musl and i686 (void linux) with all long tests passing.

I don't have aarch64 to test.


---

Comment by dimpase created at 2022-10-17 12:44:14

this branch should bump up the version of GAP, etc


---

Comment by dimpase created at 2022-10-17 12:48:52


```diff
diff --git a/build/pkgs/gap/checksums.ini b/build/pkgs/gap/checksums.ini
index 066e943308..7f083710ca 100644
--- a/build/pkgs/gap/checksums.ini
+++ b/build/pkgs/gap/checksums.ini
@@ -1,5 +1,5 @@
 tarball=gap-VERSION.tar.gz
-sha1=4ecdd281b8f430282fb9b12690b06e0a26abde10
-md5=85dc9e459d5b6c66fcad9f468afd3e3e
-cksum=1351843158
+sha1=b8b2d803c43dc6ea4413b5a378689a2087c3658a
+md5=6772845916c31de880792c7bb1672f81
+cksum=3760719912
 upstream_url=https://github.com/gap-system/gap/releases/download/vVERSION/gap-VERSION.tar.gz
diff --git a/build/pkgs/gap/package-version.txt b/build/pkgs/gap/package-version.txt
index d782fca8f6..815588ef14 100644
--- a/build/pkgs/gap/package-version.txt
+++ b/build/pkgs/gap/package-version.txt
@@ -1 +1 @@
-4.11.1
+4.12.0
```



---

Comment by arojas created at 2022-10-17 12:59:00

We should wait for 4.12.1 which will include a fix for issue (1) and additional fixes for `make install` so we can switch `spkg-install` to use it.


---

Comment by dimpase created at 2022-10-17 14:35:05

meanwhile, rebased over the latest beta, and all the fixes for spkg-install needed so far.
----
New commits:


---

Comment by dimpase created at 2022-10-17 14:38:13

running tests on Apple M1 (aka aarch64).


---

Comment by dimpase created at 2022-10-17 15:21:20

I'm getting

```
    In file included from sage/coding/codecan/codecan.c:5227:
    /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/include/gap/gasman_intern.h:17:2: error: #error This file must only be included if GASMAN is used
       17 | #error This file must only be included if GASMAN is used
```

what's the fix here?


---

Comment by arojas created at 2022-10-17 15:26:07

That's precisely issue (1). Fixed upstream in https://github.com/gap-system/gap/commit/276eb56919400aab91f9e00abb94ddc41a0ffabc


---

Comment by dimpase created at 2022-10-17 15:59:11

OK, one needs to patch GAP, as in https://patch-diff.githubusercontent.com/raw/gap-system/gap/pull/5077.diff


---

Comment by git created at 2022-10-17 16:10:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-10-17 16:41:11

we also need to upgrade libsemigroups, and gap_packages. I'm doing this now.


---

Comment by git created at 2022-10-17 20:23:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-10-17 20:29:55

not yet done, as local/share/gap/sysinfo.gap needed a manual addition of 
`-I$SAGE_LOCAL/include/gap` to `GAC_CFLAGS`.


---

Comment by git created at 2022-10-17 20:34:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-10-17 21:19:53

There are also failing doctests in `sage/algebras/quantum_groups/quantum_group_gap.py`, like this:


```
sage -t --warn-long 37.8 --random-seed=5244030565037623767917974460011040182 src/sage/algebras/quantum_groups/quantum_group_gap.py
**********************************************************************
File "src/sage/algebras/quantum_groups/quantum_group_gap.py", line 1812, in sage.algebras.quantum_groups.quantum_group_gap.TensorProductOfHighestWeightModules.__init__
Failed example:
    TestSuite(T).run()  # optional - gap_packages
Expected nothing
Got:
    doctest:warning
      File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/src/bin/sage-runtests", line 154, in <module>
        err = DC.run()
... 
    DeprecationWarning: implementations of Modules().TensorProducts() now must define the method tensor_factors
```



---

Comment by dimpase created at 2022-10-17 21:22:57

Perhaps Travis can fix these missing methods `tensor_factors`  in `sage/algebras/quantum_groups/quantum_group_gap.py`, so that there won't be a need to patch these doctests.


---

Comment by mkoeppe created at 2022-10-17 21:23:37

see #34635


---

Comment by dimpase created at 2022-10-19 14:50:00

wip on simplifying spkg-install


---

Attachment

with this, and https://github.com/gap-system/gap/pull/5091 it mostly works (package installation is broken though) We'll wait for 4.12.1, where also needed package upgrades are done.


---

Comment by tornaria created at 2022-10-19 15:16:15

In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:

https://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches

I think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.

Note also that:
 a. package names have changed (at least the name of the directories changed case and removed version numbers)
 b. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.

Sagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.


---

Comment by @collares created at 2022-10-19 15:31:08

The atlasrep issue is https://github.com/gap-system/gap/issues/5015 and will also be fixed in GAP 4.12.1.


---

Comment by dimpase created at 2022-10-19 16:12:12

Replying to [comment:34 Gonzalo Tornaría]:
> In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:
> 
> https://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches
> 
> I think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.
> 
> Note also that:
>  a. package names have changed (at least the name of the directories changed case and removed version numbers)
>  b. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.

For Sage's installed GAP, this will be `$SAGE_LOCAL/lib/gap/`


> 
> Sagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.

Try packages which build executables and/or GAP kernel extensions (the latter need `gac`)
E.g. `grape` and `crypting`.


---

Comment by dimpase created at 2022-10-21 09:52:41

update tp 4.12.1
----
New commits:


---

Comment by dimpase created at 2022-10-21 14:30:24

GAP package `liepring` now depends on a GAP package `singular`, so we should be installing it ahead of `liepring`.


---

Comment by git created at 2022-10-21 14:33:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-10-21 14:59:33

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-10-21 14:59:33

while more simplifications may be done on spkg-install files for `gap`, and `gap_packages`, this branch appears to work just fine.


---

Comment by arojas created at 2022-10-21 17:52:18

`utils` and `autodoc` are now dependencies of `atlasrep` so they need to move from `gap_packages` to `gap`.


---

Comment by arojas created at 2022-10-21 17:52:18

Changing status from needs_review to needs_work.


---

Comment by @collares created at 2022-10-21 18:09:14

Max Horn also pointed out that `radiroot` is now a dependency of `polenta`, one of the autoloaded packages. Also, although not strictly necessary, `atlasrep` uses `io` as the preferred method for fetching files over the network (but it will fall back to running wget if that's not available).


---

Comment by git created at 2022-10-23 19:03:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-10-23 19:04:06

done what's requested in comment:41 and comment:42, please review.


---

Comment by dimpase created at 2022-10-23 19:04:06

Changing status from needs_work to needs_review.


---

Comment by @collares created at 2022-10-28 21:45:40

Replying to [comment:13 Antonio Rojas]:
> Feel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.

I think I will submit my changes in a separate ticket, since the present update seems ready and does not make things any worse on aarch64 as far as I can tell. What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.

Edit: Opened #34701, sorry for the noise!


---

Comment by dimpase created at 2022-10-28 22:25:21

Replying to [comment:45 Mauricio Collares]:
> What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.

yes, that's how this is normally done.


---

Comment by @collares created at 2022-10-29 01:07:34

Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.


---

Comment by arojas created at 2022-10-31 08:48:33

Replying to [comment:47 Mauricio Collares]:
> Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.

This will solve itself once we switch to `make install`. Let's get this is as is and move that to a follow-up ticket (there are some non-trivial adjustments needed for `gap-packages`, and probably the `GAP_ROOT` variable should be rethought or removed completely)


---

Comment by dimpase created at 2022-10-31 15:38:04

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-10-31 15:38:04

In #34711 we will switch to using GAP's `make install`. Meanwhile I'm giving this a positive review.


---

Comment by dimpase created at 2022-11-03 12:49:54

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2022-11-03 12:49:54

I spoke too soon - tested with unclean SAGE_LOCAL :-(

With everything clean, while building `gap_packages`, I get

```
gcc -g -O2 -fPIC -MQ gen/src/crypting.o -MMD -MP -MF gen/src/crypting.d -g -O2 -Wno-implicit-function-declaration -Wno-implicit-function-declaration -o gen/src/crypting.o -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/build -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap -DUSE_GASMAN=1 -c src/crypting.c
In file included from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/gap_all.h:51,
                 from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/compiled.h:26,
                 from src/crypting.c:5:
/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/modules.h:19:10: fatal error: version.h: No such file or directory
   19 | #include "version.h"
      |          ^~~~~~~~~~~
compilation terminated.
```

The problem is that `version.h` gets installed into `SAGE_LOCAL/include/gap` - a location unknown to `crypting` package makefile.


---

Comment by git created at 2022-11-04 13:54:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2022-11-04 13:56:52

rebased over latest beta, 9.8.beta3


---

Comment by git created at 2022-11-04 14:03:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-11-04 14:05:18

the current issue is to fix gap's `spkg-check` - currently broken due to a mess
in some GAP's packages we install, see 
https://github.com/gap-packages/crypting/issues/21#issuecomment-1303503670


---

Comment by dimpase created at 2022-11-04 14:05:18

Changing status from needs_work to needs_review.


---

Comment by arojas created at 2022-11-04 18:11:35

libgap doesn't find any package

```
sage: from sage.tests.gap_packages import all_installed_packages
sage: all_installed_packages()
()
```



---

Comment by arojas created at 2022-11-04 18:11:35

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2022-11-04 19:30:36

Ideally libgap should know where to look for its files without needing to pass the paths with `-l`, but apparently that's not the case (it works fine in the gap command line though, `GAPInfo.RootPaths` returns both paths, `lib` and `share`).
----
New commits:


---

Comment by arojas created at 2022-11-04 19:35:38

There's still one test failure

```
sage -t --long --random-seed=259290265121646386777269003923470404522 src/sage/tests/gap_packages.py
**********************************************************************
File "src/sage/tests/gap_packages.py", line 8, in sage.tests.gap_packages
Failed example:
    test_packages(pkgs, only_failures=True)    # optional - gap_packages
Exception raised:
    Traceback (most recent call last):
      File "/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.gap_packages[2]>", line 1, in <module>
        test_packages(pkgs, only_failures=True)    # optional - gap_packages
      File "/home/antonio/Software/sage/sage-gap/src/sage/tests/gap_packages.py", line 71, in test_packages
        output = libgap.LoadPackage(pkg)
      File "sage/libs/gap/element.pyx", line 2524, in sage.libs.gap.element.GapElement_Function.__call__
        sig_on()
    sage.libs.gap.util.GAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments
    The 1st argument is 'fail' which might point to an earlier problem
    Error, was not in any namespace
    Error, was not in any namespace
**********************************************************************
```

It happens when libgap tries to load the `packagemanager` package

```
sage: libgap.LoadPackage("packagemanager")
---------------------------------------------------------------------------
GAPError                                  Traceback (most recent call last)
Input In [1], in <cell line: 1>()
----> 1 libgap.LoadPackage("packagemanager")

File ~/Software/sage/sage-gap/src/sage/libs/gap/element.pyx:2524, in sage.libs.gap.element.GapElement_Function.__call__()
   2522 try:
   2523     sig_GAP_Enter()
-> 2524     sig_on()
   2525     if n == 0:
   2526         result = CALL_0ARGS(self.value)

GAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments
The 1st argument is 'fail' which might point to an earlier problem
Error, was not in any namespace
Error, was not in any namespace
```

It (seems to) work fine the second time

```
sage: libgap.LoadPackage("packagemanager")
true
```



---

Comment by dimpase created at 2022-11-04 19:50:06

Do you need to look for packages in `share/gap`? There should not be any.
That's why I doubt your line from `​16c2ccb`:

```
s = str_to_bytes(sage.env.GAP_LIB_DIR + ";" + sage.env.GAP_SHARE_DIR, FS_ENCODING, "surrogateescape")
```



---

Comment by arojas created at 2022-11-04 19:59:40

Replying to [comment:59 Dima Pasechnik]:
> Do you need to look for packages in `share/gap`? There should not be any.
> That's why I doubt your line from `​16c2ccb`:

That is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.


---

Comment by arojas created at 2022-11-04 20:02:40

Replying to [comment:58 Antonio Rojas]:
> It happens when libgap tries to load the `packagemanager` package

Looks like `packagemanager` expects a `lib/gap/bin` dir to exist, which is not created by `make install`

https://github.com/gap-packages/PackageManager/blob/master/gap/PackageManager.gd#L294

Simply creating an empty `bin` subdir fixes the test.


---

Comment by git created at 2022-11-04 20:43:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-11-04 20:44:49

Changing status from needs_work to needs_review.


---

Comment by arojas created at 2022-11-04 20:44:49

Reported upstream

https://github.com/gap-packages/PackageManager/issues/105


---

Comment by dimpase created at 2022-11-04 21:05:56

Something is fishy with PackageManager in another way, too:  https://github.com/gap-packages/PackageManager/issues/106


---

Comment by dimpase created at 2022-11-04 21:06:31

Replying to [comment:62 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||

but we don't need lib/gap/bin, it's an upstream bug.


---

Comment by arojas created at 2022-11-04 21:09:06

Replying to [comment:65 Dima Pasechnik]:
> Replying to [comment:62 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||
> 
> but we don't need lib/gap/bin, it's an upstream bug.

It breaks a test. We either need to work around this, or we need to stop testing loading the package.


---

Comment by fbissey created at 2022-11-04 21:48:36

Replying to [comment:60 Antonio Rojas]:
> Replying to [comment:59 Dima Pasechnik]:
> > Do you need to look for packages in `share/gap`? There should not be any.
> > That's why I doubt your line from `​16c2ccb`:
> 
> That is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.


I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.


---

Comment by arojas created at 2022-11-04 21:55:13

Replying to [comment:67 François Bissey]:

> I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.

Technically it is the correct place. Arch-independent files belong in `share`.


---

Comment by fbissey created at 2022-11-04 22:05:05

Replying to [comment:68 Antonio Rojas]:
> Replying to [comment:67 François Bissey]:
> 
> > I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.
> 
> Technically it is the correct place. Arch-independent files belong in `share`.

I cannot argue with that. I know I had complaint that in previous gap version, gap packages installed binaries and libraries under `share` which is not right of course. But gap packages are a mixed bag. Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. Python does it, that's a big example to follow.


---

Comment by arojas created at 2022-11-04 23:25:31

Actually, the `bin/gap` script created by `make install` contains both paths

https://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582

My commit is just replicating that for the `libgap` call in sage.


> Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. 

This is something for upstream to figure out when they integrate package installation in `make install`, which I believe is planned. Until then every distro will manually install packages where they choose to, so we need to search both paths.


---

Comment by fbissey created at 2022-11-04 23:40:40

Replying to [comment:70 Antonio Rojas]:
> Actually, the `bin/gap` script created by `make install` contains both paths
> 
> https://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582
> 

That, I noticed when I packaged 4.12.0. I only thought of it as a backward compatible move though. It didn't quite percolate into my brain that it would be needed for the stuff that ship with gap itself.


---

Comment by dimpase created at 2022-11-05 00:39:01

another issue is that `make gap-clean` does not seem to work.


---

Comment by dimpase created at 2022-11-05 00:45:53

And installing GAP with `SAGE_CHECK=yes` hangs for me at `gap-4.12.1/src/tst/testinstall/grp/basic.tst`


---

Comment by @collares created at 2022-11-05 00:51:10

Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.


---

Comment by tornaria created at 2022-11-05 01:33:30

Replying to [comment:74 Mauricio Collares]:
> Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.

This might be useful: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch


---

Comment by mkoeppe created at 2022-11-12 23:00:56

Replying to [comment:72 Dima Pasechnik]:
> another issue is that `make gap-clean` does not seem to work.

The install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)


---

Comment by dimpase created at 2022-11-12 23:37:03

Replying to [comment:76 Matthias Köppe]:
> Replying to [comment:72 Dima Pasechnik]:
> > another issue is that `make gap-clean` does not seem to work.
> 
> The install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)

hmm, is this a GAP bug then? Or a Sage bug?


---

Comment by mkoeppe created at 2022-11-13 02:06:00

Try changing `sdh_make install` to `sdh_make_install`.


---

Comment by dimpase created at 2022-11-13 19:54:48

Replying to [comment:78 Matthias Köppe]:
> Try changing `sdh_make install` to `sdh_make_install`.
right, thanks - this worked after I removed build/pkgs/gap/spkg-prerm.in as well. I'll post a new branch.


---

Comment by dimpase created at 2022-11-13 20:02:02

New commits:


---

Comment by dimpase created at 2022-11-13 22:08:06

With gap_packages, cleaning is still not 100% right. Namely, _compiled_ GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`. It's harmless in this particular case though.

Let's leave this to another ticket.


---

Comment by git created at 2022-11-13 23:30:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-11-13 23:32:31

Now `SAGE_CHECK= yes make gap` passes. All good, as far as I can see.

Anyone wants to give this a positive review?


---

Comment by mkoeppe created at 2022-11-13 23:35:36

Replying to [comment:82 Dima Pasechnik]:
> With gap_packages, cleaning is still not 100% right. Namely, _compiled_ GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.

Likely a defect in the build system of upstream


---

Comment by dimpase created at 2022-11-13 23:59:04

Replying to [comment:85 Matthias Köppe]:
> Replying to [comment:82 Dima Pasechnik]:
> > With gap_packages, cleaning is still not 100% right. Namely, _compiled_ GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.
> 
> Likely a defect in the build system of upstream

I must say I've no idea what's going on there. I don't even know any more where Sage stores info on installed by `sdh_install` data.


---

Comment by mkoeppe created at 2022-11-14 00:03:14

The upstream build system likely forgets to use `$(DESTDIR)` in some `mkdir` commands. We've seen this before in other packages.


---

Comment by mkoeppe created at 2022-11-14 00:08:22

The staging manifests are in $SAGE_LOCAL/var/lib/sage/installed/


---

Comment by tornaria created at 2022-11-14 00:37:54

Replying to [comment:83 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[97dc1ea](https://git.sagemath.org/sage.git/commit/?id=97dc1ea93e313c3d6c0e7bf3868dbb2143fceef8)||`with SAGE_CHECK=yes, one needs io installed to prevent hangs`||

Note that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.

An alternative is to configure atlasrep to not hit the network by default
(very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).

I'm not sure what's better for sage.


---

Comment by @collares created at 2022-11-14 01:22:43

I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?


---

Comment by tornaria created at 2022-11-14 01:45:55

Replying to [comment:90 Mauricio Collares]:
> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?

That takes less than a second for me:

```
gap> t:=time;; Length(MaximalSubgroupClassReps(SimpleGroup("M24"))); time-t;
9
684
```



---

Comment by dimpase created at 2022-11-14 10:14:34

Replying to [comment:90 Mauricio Collares]:
> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?

no, what I see is a total hang, nothing happens, CPUs don't do anything, etc.


---

Comment by dimpase created at 2022-11-14 10:43:53

Replying to [comment:89 Gonzalo Tornaría]:

> Note that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.
> 
> An alternative is to configure atlasrep to not hit the network by default
> (very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).

It's not `atlastrep` here, it's other packages that use parallel computation facilities of `io` in their testsuites. Note that we're running tests on whatever is in the GAP tarball, not on the installed configuration. I think it's an upstream bug, I'll open an issue in this regard, but I think it can wait for another ticket, it's not a regression.


---

Comment by dimpase created at 2022-11-21 12:26:00

ping?


---

Comment by git created at 2022-11-23 18:36:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2022-11-23 20:07:11

rebased over 9.8.beta4


---

Comment by dimpase created at 2022-11-30 18:07:43

I'm hitting a snag while testing with `gap_packages` installed on macOS 13.0.1.

```
File "src/sage/libs/gap/libgap.pyx", line 11, in sage.libs.gap.libgap
Failed example:
    a = libgap(10)
Expected nothing
Got:
    Error, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap\
    /pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\
    ware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, \
    0x0005): Symbol not found: _AssGVar
      Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software\
    /sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so
      Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/\
    Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python
    Error, was not in any namespace
    Syntax warning: Unbound global variable in /Users/dima/software/sage/local/sha\
    re/gap/lib/init.g:740
        ColorPrompt( UserPreference( "UseColorPrompt" ) );
        ^^^^^^^^^^^
    Error, SetGasmanMessageStatus: function is not yet defined
    Error, Variable: 'L1_IMMUTABLE_ERROR' must have a value
```


Not sure whether this is reproducible on older macOS - everything is fine on Linux. Note that package `io` has a "GAP kernel module", i.e. a special dynamic library which extends GAP capabilities (not dissimilar to Python extension modules with, say, parts written in C).

I can also reproduce this at the Sage prompt (after I remove pre-built GAP images):

```
$ rm -rf ~/.sage 
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta4, Release Date: 2022-11-21               │
│ Using Python 3.11.0. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: libgap(10)
Error, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\
ware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, 0x0005): Symbol not found: _AssGVar
  Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so
  Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python
Error, was not in any namespace
Syntax warning: Unbound global variable in /Users/dima/software/sage/local/share/gap/lib/init.g:740
    ColorPrompt( UserPreference( "UseColorPrompt" ) );
    ^^^^^^^^^^^
Error, SetGasmanMessageStatus: function is not yet defined
Error, Variable: 'L1_IMMUTABLE_ERROR' must have a value
10
```



---

Comment by fbissey created at 2022-11-30 19:49:20

Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.


---

Comment by dimpase created at 2022-11-30 20:40:45

Replying to [comment:98 François Bissey]:
> Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.

it's not, and this is by design. it's meant to be loaded by libgap, not the other way around.
It's probably a race condition of some kind.


---

Comment by dimpase created at 2022-11-30 21:07:40

see https://github.com/gap-system/gap/issues/5232 for an upstream report. Fortunately it can be reproduced within GAP's testsuite.


---

Comment by @fingolfin created at 2022-12-01 15:03:33

Dima pointed me here.

I already communicated various comments to him on our (GAP's) issue tracker. But I also just had a look at the overall diff for the changes so far. Some remarks:

We have a new helper function `CALL_WITH_STREAM` which you could use to rewrite your `capture_stdout` with pure GAP. As an example, in `GAP.jl` (Julia interface to GAP), I use these two helpers; adapting that code to match `capture_stdout` is straight-forward. Note that I use `SetPrintFormattingStatus` there to avoid diffs caused by the width of the user's terminal; but if you want to 100% faithfully reproduce what GAP does, then leave that out.

```
BindGlobal( "StringDisplayObj",
function(obj)
  local str, out;
  str := "";
  out := OutputTextString(str, false);
  SetPrintFormattingStatus(out, false);
  CALL_WITH_STREAM(out, Display, [obj]);
  CloseStream(out);
  return str;
end );

BindGlobal( "StringViewObj",
function(obj)
  local str, out;
  str := "";
  out := OutputTextString(str, false);
  SetPrintFormattingStatus(out, false);
  CALL_WITH_STREAM(out, ViewObj, [obj]);
  CloseStream(out);
  return str;
end );
```

This is of course in the end equivalent to what `capture_stdout` does, but while `CALL_WITH_STREAM` is also undocumented, it'll be more stable than calling internal kernel functions like  `OpenOutputStream`. We could also eventually offer a documented, high-level version of it as `CallWithStream`; the main reason that's not yet there is that I first wanted to validate the design. If Sage also finds it useful, that would be a strong motivation to provide a fully documented `CallWithStream` in GAP 4.13. In addition or alternatively, functions like `StringViewObj` or `StringPrint` could be provided, but there it is already less clear that we can agree on a common version (see `SetPrintFormattingStatus` ...) ?



- Another point: you could replace your uses of `GVarName` and `AssGVar` by `GAP_AssignGlobalVariable` (the performance overhead of re-calling `GVarName` should be miniscule; if `hold_reference` ever is called in a tight loop, that code likely has more serious problems than that...

- alternatively just remove `hold_reference` (nothing uses it?)

- remove `NewBag` and `CallbackForAllBags` from `gap_includes.pxd` ?

- there are a lot of other things that could be replaced by "official" libgap API usage, e.g. `IS_INT` -> `GAP_IsInt`, `IS_INTOBJ` -> `GAP_IsSmallInt`, `SUM` -> `GAP_SUM`, `VAL_MACFLOAT` -> `GAP_ValueMacFloat`, etc. -- most of these were added specifically for use by Sage years ago but apparently are not actually used by Sage? Overall I would expect that a majority of the imports from outside `libgap-api.h` can be replaced. If someone wants to work on that and needs help to figure out what replaces what, I'll be happy to assist


---

Comment by @fingolfin created at 2022-12-01 17:15:51

I just noticed you do this, so I am guessing you will want to also use `SetPrintFormattingStatus` as mentioned above, as a better alternative to that hack


```
    argv[8] = "-x"    # set the "screen" width so that GAP is less likely to
    argv[9] = "4096"  # insert newlines when printing objects
                      # 4096 unfortunately is the hard-coded max, but should
                      # be long enough for most cases

```


You also have the following:


```
    argv[1] = "-l"
    s = str_to_bytes(gap_root(), FS_ENCODING, "surrogateescape")
    argv[2] = s

```


This shouldn't be necessary anymore in 4.12.2 (due in ~2 weeks), thanks to https://github.com/gap-system/gap/pull/5193


---

Comment by dimpase created at 2022-12-01 17:25:46

This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.

We are still hoping that https://pypi.org/project/gappy-system/ (also https://github.com/embray/gappy) will be a proper replacement for our libgap interface, but unfortunately gappy is  stalled, as `@`embray is at greener pastures nowadays.


---

Comment by git created at 2022-12-01 17:36:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-12-01 23:15:44

Replying to [comment:104 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[29383be](https://git.sagemath.org/sage.git/commit/?id=29383be9dbea4e49004ed57d5f23e34155174548)||`backport GAP PR 5235`||

this fixes the issue in comment:100.

Ready for review, again.


---

Comment by @fingolfin created at 2022-12-19 08:47:58

> This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.

That makes perfect sense. So, view this as an offer: if someone would like to tackle cleaning up some of these things, feel free to contact me for assistance.


In other news, as some of you are probably already aware, we just release GAP 4.12.2 which should make some of the patches here unnecessary.


---

Comment by dimpase created at 2022-12-19 09:20:24

Yes, we'll definitely use 4.12.2


---

Comment by dimpase created at 2022-12-19 09:20:24

Changing status from needs_review to needs_work.
