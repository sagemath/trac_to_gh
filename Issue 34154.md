# Issue 34154: Upgrade: GAP 4.12

archive/issues_034154.json:
```json
{
    "body": "CC:  @antonio-rojas @dimpase @slel @tornaria @kiwifb @collares @tscrim\n\nKeywords: spkg, upgrade, gap, libsemigroups\n\nGAP 4.12.0 was released in August 2022.\n\n- [GAP 4.12.0 release announcement](https://lists.uni-kl.de/gap/arc/forum/2022-08/msg00031.html)\n- [GAP 4.12.0 release page](https://www.gap-system.org/Releases/4.12.0.html)\n- [GAP 4.12.0: changes since GAP 4.11.1](https://github.com/gap-system/gap/blob/master/CHANGES.md#gap-4120-august-2022)\n\nWe should upgrade our corresponding spkgs:\n\n- gap\n- gap_packages\n- libsemigroups\n\nPrevious upgrades:\n\n- #31498: GAP 4.11.1\n- #29314: GAP 4.11, libsemigroup 1.0.9\n\nIssue created by migration from https://trac.sagemath.org/ticket/34391\n\n",
    "created_at": "2022-08-20T05:46:21Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Upgrade: GAP 4.12",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34154",
    "user": "@slel"
}
```
CC:  @antonio-rojas @dimpase @slel @tornaria @kiwifb @collares @tscrim

Keywords: spkg, upgrade, gap, libsemigroups

GAP 4.12.0 was released in August 2022.

- [GAP 4.12.0 release announcement](https://lists.uni-kl.de/gap/arc/forum/2022-08/msg00031.html)
- [GAP 4.12.0 release page](https://www.gap-system.org/Releases/4.12.0.html)
- [GAP 4.12.0: changes since GAP 4.11.1](https://github.com/gap-system/gap/blob/master/CHANGES.md#gap-4120-august-2022)

We should upgrade our corresponding spkgs:

- gap
- gap_packages
- libsemigroups

Previous upgrades:

- #31498: GAP 4.11.1
- #29314: GAP 4.11, libsemigroup 1.0.9

Issue created by migration from https://trac.sagemath.org/ticket/34391





---

archive/issue_comments_484604.json:
```json
{
    "body": "Having upgraded downstream, here is a list of issues:\n\n1) Build fails because a garbage collector needs to be specified via a preprocessor macro when using gap's headers. This is included in the CPPFLAGS in gap's own `sysinfo.gap`, but Sage doesn't read it when building.\n\n2) Build fails due to API changes in `OpenOutputStream` and `CloseOutput`\n\n3) Colored prompt is on by default, which breaks the pexpect interface.\n\n4) The `NaturalHomomorphism` function, used in `groups.abelian_gps.abelian_group_gap`, has been removed.\n\n5) The functions `IsPrimitive` and `IsTransitive` changed behavior and now return false if the group does not act on the given set, breaking some tests:\n\n```\nFile \"/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py\", line 4363, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_transitive\nFailed example:\n    G.is_transitive([1,4,5])\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py\", line 4428, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_primitive\nFailed example:\n    G.is_primitive([1,2,3])\nExpected:\n    True\nGot:\n    False\n```\n\n\n6) Computation of permutation group generators has changed, breaking some tests. In particular, using `algorithm=smaller` now does not make any difference in many examples.\n\n7) Several trivial test failures due to different choice of generators or minor syntax changes.",
    "created_at": "2022-08-29T21:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484604",
    "user": "@antonio-rojas"
}
```

Having upgraded downstream, here is a list of issues:

1) Build fails because a garbage collector needs to be specified via a preprocessor macro when using gap's headers. This is included in the CPPFLAGS in gap's own `sysinfo.gap`, but Sage doesn't read it when building.

2) Build fails due to API changes in `OpenOutputStream` and `CloseOutput`

3) Colored prompt is on by default, which breaks the pexpect interface.

4) The `NaturalHomomorphism` function, used in `groups.abelian_gps.abelian_group_gap`, has been removed.

5) The functions `IsPrimitive` and `IsTransitive` changed behavior and now return false if the group does not act on the given set, breaking some tests:

```
File "/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py", line 4363, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_transitive
Failed example:
    G.is_transitive([1,4,5])
Expected:
    True
Got:
    False
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/groups/perm_gps/permgroup.py", line 4428, in sage.groups.perm_gps.permgroup.PermutationGroup_generic.is_primitive
Failed example:
    G.is_primitive([1,2,3])
Expected:
    True
Got:
    False
```


6) Computation of permutation group generators has changed, breaking some tests. In particular, using `algorithm=smaller` now does not make any difference in many examples.

7) Several trivial test failures due to different choice of generators or minor syntax changes.



---

archive/issue_comments_484605.json:
```json
{
    "body": "The branch fixes (2), (3), (4) and (7). For (5), we need to decide whether we want to follow the new behavior in GAP, or reimplement the old behavior in some other way. For (6), some tests need to be updated or removed.\n----\nNew commits:",
    "created_at": "2022-08-29T21:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484605",
    "user": "@antonio-rojas"
}
```

The branch fixes (2), (3), (4) and (7). For (5), we need to decide whether we want to follow the new behavior in GAP, or reimplement the old behavior in some other way. For (6), some tests need to be updated or removed.
----
New commits:



---

archive/issue_comments_484606.json:
```json
{
    "body": "regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group *action* on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.\n(perhaps we should have a deprecation, in case False is returned, printing a warning about the change in behavior) \n\nHow about (1) - should `spkg-install` source `sysinfo.gap` ?",
    "created_at": "2022-08-30T08:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484606",
    "user": "@dimpase"
}
```

regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group *action* on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.
(perhaps we should have a deprecation, in case False is returned, printing a warning about the change in behavior) 

How about (1) - should `spkg-install` source `sysinfo.gap` ?



---

archive/issue_comments_484607.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group *action* on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.\n> \n> How about (1) - should `spkg-install` source `sysinfo.gap` ?\n\nI think that is fine for gap packages but not for downstream packages. I guess it is a stop gap, but a standard way of setting the flags should be provided. A .pc file or at least a config utility. You shouldn't have to search for settings in an obscure internal file. This is a genuine upstream defect in my opinion.",
    "created_at": "2022-08-30T08:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484607",
    "user": "@kiwifb"
}
```

Replying to [comment:6 dimpase]:
> regarding (5), I don't think we need to reimplement, as `transitive` and `primitive` are dealing with group *action* on a domain, and are not defined, mathematically, for arbitrary subsets of the domain.
> 
> How about (1) - should `spkg-install` source `sysinfo.gap` ?

I think that is fine for gap packages but not for downstream packages. I guess it is a stop gap, but a standard way of setting the flags should be provided. A .pc file or at least a config utility. You shouldn't have to search for settings in an obscure internal file. This is a genuine upstream defect in my opinion.



---

archive/issue_comments_484608.json:
```json
{
    "body": "By the way, `sysinfo.gap` is not in the tarball, it is generated by doing `make sysinfo.gap`, so this should be easy to incorporate. But it has `GAP_CPPFLAGS` rather than `CPPFLAGS`, at least on an install I'm trying this.\n\nSo this looks that our build somehow manages to avoid running `make sysinfo.gap`.",
    "created_at": "2022-08-30T09:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484608",
    "user": "@dimpase"
}
```

By the way, `sysinfo.gap` is not in the tarball, it is generated by doing `make sysinfo.gap`, so this should be easy to incorporate. But it has `GAP_CPPFLAGS` rather than `CPPFLAGS`, at least on an install I'm trying this.

So this looks that our build somehow manages to avoid running `make sysinfo.gap`.



---

archive/issue_comments_484609.json:
```json
{
    "body": "I am seeing a bunch of segfaults on aarch64 with GAP 4.12.0 and this branch. The following patch, which copies the output string before calling `GAP_Leave`, seems to fix almost all of the segfaults, but not 100% of them (see https://github.com/NixOS/nixpkgs/pull/192548#issuecomment-1256686607 for more details):\n\n\n```diff\ndiff --git a/src/sage/libs/gap/element.pxd b/src/sage/libs/gap/element.pxd\nindex a1bf8118d4..9a28de87ca 100644\n--- a/src/sage/libs/gap/element.pxd\n+++ b/src/sage/libs/gap/element.pxd\n@@ -29,9 +29,9 @@ cdef GapElement_Boolean make_GapElement_Boolean(parent, Obj obj)\n cdef GapElement_Function make_GapElement_Function(parent, Obj obj)\n cdef GapElement_Permutation make_GapElement_Permutation(parent, Obj obj)\n \n-cdef char *capture_stdout(Obj, Obj)\n-cdef char *gap_element_str(Obj)\n-cdef char *gap_element_repr(Obj)\n+cdef str capture_stdout(Obj, Obj)\n+cdef str gap_element_str(Obj)\n+cdef str gap_element_repr(Obj)\n \n \n cdef class GapElement(RingElement):\ndiff --git a/src/sage/libs/gap/element.pyx b/src/sage/libs/gap/element.pyx\nindex e2681165a2..482f74bbcf 100644\n--- a/src/sage/libs/gap/element.pyx\n+++ b/src/sage/libs/gap/element.pyx\n@@ -120,7 +120,7 @@ cdef Obj make_gap_matrix(sage_list, gap_ring) except NULL:\n     return l.value\n \n \n-cdef char *capture_stdout(Obj func, Obj obj):\n+cdef str capture_stdout(Obj func, Obj obj):\n     \"\"\"\n     Call a single-argument GAP function ``func`` with the argument ``obj``\n     and return the stdout from that function call.\n@@ -152,12 +152,12 @@ cdef char *capture_stdout(Obj func, Obj obj):\n \n         CALL_1ARGS(func, obj)\n         CloseOutput(&output)\n-        return CSTR_STRING(s)\n+        return char_to_str(CSTR_STRING(s))\n     finally:\n         GAP_Leave()\n \n \n-cdef char *gap_element_repr(Obj obj):\n+cdef str gap_element_repr(Obj obj):\n     \"\"\"\n     Implement ``repr()`` of ``GapElement``s using the ``ViewObj()`` function,\n     which is by default closest to what you get when displaying an object in\n@@ -169,7 +169,7 @@ cdef char *gap_element_repr(Obj obj):\n     return capture_stdout(func, obj)\n \n \n-cdef char *gap_element_str(Obj obj):\n+cdef str gap_element_str(Obj obj):\n     \"\"\"\n     Implement ``str()`` of ``GapElement``s using the ``Print()`` function.\n \n@@ -761,7 +761,7 @@ cdef class GapElement(RingElement):\n         if  self.value == NULL:\n             return 'NULL'\n \n-        s = char_to_str(gap_element_str(self.value))\n+        s = gap_element_str(self.value)\n         return s.strip()\n \n     def _repr_(self):\n@@ -783,7 +783,7 @@ cdef class GapElement(RingElement):\n         if  self.value == NULL:\n             return 'NULL'\n \n-        s = char_to_str(gap_element_repr(self.value))\n+        s = gap_element_repr(self.value)\n         return s.strip()\n \n     cpdef _set_compare_by_id(self):\n```\n",
    "created_at": "2022-09-23T21:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484609",
    "user": "@collares"
}
```

I am seeing a bunch of segfaults on aarch64 with GAP 4.12.0 and this branch. The following patch, which copies the output string before calling `GAP_Leave`, seems to fix almost all of the segfaults, but not 100% of them (see https://github.com/NixOS/nixpkgs/pull/192548#issuecomment-1256686607 for more details):


```diff
diff --git a/src/sage/libs/gap/element.pxd b/src/sage/libs/gap/element.pxd
index a1bf8118d4..9a28de87ca 100644
--- a/src/sage/libs/gap/element.pxd
+++ b/src/sage/libs/gap/element.pxd
@@ -29,9 +29,9 @@ cdef GapElement_Boolean make_GapElement_Boolean(parent, Obj obj)
 cdef GapElement_Function make_GapElement_Function(parent, Obj obj)
 cdef GapElement_Permutation make_GapElement_Permutation(parent, Obj obj)
 
-cdef char *capture_stdout(Obj, Obj)
-cdef char *gap_element_str(Obj)
-cdef char *gap_element_repr(Obj)
+cdef str capture_stdout(Obj, Obj)
+cdef str gap_element_str(Obj)
+cdef str gap_element_repr(Obj)
 
 
 cdef class GapElement(RingElement):
diff --git a/src/sage/libs/gap/element.pyx b/src/sage/libs/gap/element.pyx
index e2681165a2..482f74bbcf 100644
--- a/src/sage/libs/gap/element.pyx
+++ b/src/sage/libs/gap/element.pyx
@@ -120,7 +120,7 @@ cdef Obj make_gap_matrix(sage_list, gap_ring) except NULL:
     return l.value
 
 
-cdef char *capture_stdout(Obj func, Obj obj):
+cdef str capture_stdout(Obj func, Obj obj):
     """
     Call a single-argument GAP function ``func`` with the argument ``obj``
     and return the stdout from that function call.
@@ -152,12 +152,12 @@ cdef char *capture_stdout(Obj func, Obj obj):
 
         CALL_1ARGS(func, obj)
         CloseOutput(&output)
-        return CSTR_STRING(s)
+        return char_to_str(CSTR_STRING(s))
     finally:
         GAP_Leave()
 
 
-cdef char *gap_element_repr(Obj obj):
+cdef str gap_element_repr(Obj obj):
     """
     Implement ``repr()`` of ``GapElement``s using the ``ViewObj()`` function,
     which is by default closest to what you get when displaying an object in
@@ -169,7 +169,7 @@ cdef char *gap_element_repr(Obj obj):
     return capture_stdout(func, obj)
 
 
-cdef char *gap_element_str(Obj obj):
+cdef str gap_element_str(Obj obj):
     """
     Implement ``str()`` of ``GapElement``s using the ``Print()`` function.
 
@@ -761,7 +761,7 @@ cdef class GapElement(RingElement):
         if  self.value == NULL:
             return 'NULL'
 
-        s = char_to_str(gap_element_str(self.value))
+        s = gap_element_str(self.value)
         return s.strip()
 
     def _repr_(self):
@@ -783,7 +783,7 @@ cdef class GapElement(RingElement):
         if  self.value == NULL:
             return 'NULL'
 
-        s = char_to_str(gap_element_repr(self.value))
+        s = gap_element_repr(self.value)
         return s.strip()
 
     cpdef _set_compare_by_id(self):
```




---

archive/issue_comments_484610.json:
```json
{
    "body": "I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. \n\nAs a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).",
    "created_at": "2022-09-23T23:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484610",
    "user": "@collares"
}
```

I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. 

As a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).



---

archive/issue_comments_484611.json:
```json
{
    "body": "Replying to [comment:12 Mauricio Collares]:\n> I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. \n> \n> As a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).\n\nFeel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.",
    "created_at": "2022-09-30T16:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484611",
    "user": "@antonio-rojas"
}
```

Replying to [comment:12 Mauricio Collares]:
> I think the other segfaults happen because `gap_element_repr` and `gap_element_str` (the two `capture_stdout` callers) call `GAP_ValueGlobalVariable` but don't use `GAP_Enter`/`GAP_Leave`. 
> 
> As a proof of concept, I applied the above patch but also moved the try/GAP_Enter/finally/GAP_Leave block from `capture_stdout` to `gap_element_repr`/`gap_element_str` ([patch](https://github.com/NixOS/nixpkgs/blob/66f857c7c10e24e95fc429fd3c6ebd5676e29b61/pkgs/applications/science/math/sage/patches/copy-string-before-gap-leave.patch)), and I didn't see a single crash in two test runs (it used to happen every time).

Feel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.



---

archive/issue_comments_484612.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-30T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484612",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484613.json:
```json
{
    "body": "I have tested the last commmit (a6c293d) using system gap 4.12.0, on x86_64, x86_64-musl and i686 (void linux) with all long tests passing.\n\nI don't have aarch64 to test.",
    "created_at": "2022-10-17T04:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484613",
    "user": "@tornaria"
}
```

I have tested the last commmit (a6c293d) using system gap 4.12.0, on x86_64, x86_64-musl and i686 (void linux) with all long tests passing.

I don't have aarch64 to test.



---

archive/issue_comments_484614.json:
```json
{
    "body": "this branch should bump up the version of GAP, etc",
    "created_at": "2022-10-17T12:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484614",
    "user": "@dimpase"
}
```

this branch should bump up the version of GAP, etc



---

archive/issue_comments_484615.json:
```json
{
    "body": "\n```diff\ndiff --git a/build/pkgs/gap/checksums.ini b/build/pkgs/gap/checksums.ini\nindex 066e943308..7f083710ca 100644\n--- a/build/pkgs/gap/checksums.ini\n+++ b/build/pkgs/gap/checksums.ini\n@@ -1,5 +1,5 @@\n tarball=gap-VERSION.tar.gz\n-sha1=4ecdd281b8f430282fb9b12690b06e0a26abde10\n-md5=85dc9e459d5b6c66fcad9f468afd3e3e\n-cksum=1351843158\n+sha1=b8b2d803c43dc6ea4413b5a378689a2087c3658a\n+md5=6772845916c31de880792c7bb1672f81\n+cksum=3760719912\n upstream_url=https://github.com/gap-system/gap/releases/download/vVERSION/gap-VERSION.tar.gz\ndiff --git a/build/pkgs/gap/package-version.txt b/build/pkgs/gap/package-version.txt\nindex d782fca8f6..815588ef14 100644\n--- a/build/pkgs/gap/package-version.txt\n+++ b/build/pkgs/gap/package-version.txt\n@@ -1 +1 @@\n-4.11.1\n+4.12.0\n```\n",
    "created_at": "2022-10-17T12:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484615",
    "user": "@dimpase"
}
```


```diff
diff --git a/build/pkgs/gap/checksums.ini b/build/pkgs/gap/checksums.ini
index 066e943308..7f083710ca 100644
--- a/build/pkgs/gap/checksums.ini
+++ b/build/pkgs/gap/checksums.ini
@@ -1,5 +1,5 @@
 tarball=gap-VERSION.tar.gz
-sha1=4ecdd281b8f430282fb9b12690b06e0a26abde10
-md5=85dc9e459d5b6c66fcad9f468afd3e3e
-cksum=1351843158
+sha1=b8b2d803c43dc6ea4413b5a378689a2087c3658a
+md5=6772845916c31de880792c7bb1672f81
+cksum=3760719912
 upstream_url=https://github.com/gap-system/gap/releases/download/vVERSION/gap-VERSION.tar.gz
diff --git a/build/pkgs/gap/package-version.txt b/build/pkgs/gap/package-version.txt
index d782fca8f6..815588ef14 100644
--- a/build/pkgs/gap/package-version.txt
+++ b/build/pkgs/gap/package-version.txt
@@ -1 +1 @@
-4.11.1
+4.12.0
```




---

archive/issue_comments_484616.json:
```json
{
    "body": "We should wait for 4.12.1 which will include a fix for issue (1) and additional fixes for `make install` so we can switch `spkg-install` to use it.",
    "created_at": "2022-10-17T12:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484616",
    "user": "@antonio-rojas"
}
```

We should wait for 4.12.1 which will include a fix for issue (1) and additional fixes for `make install` so we can switch `spkg-install` to use it.



---

archive/issue_comments_484617.json:
```json
{
    "body": "meanwhile, rebased over the latest beta, and all the fixes for spkg-install needed so far.\n----\nNew commits:",
    "created_at": "2022-10-17T14:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484617",
    "user": "@dimpase"
}
```

meanwhile, rebased over the latest beta, and all the fixes for spkg-install needed so far.
----
New commits:



---

archive/issue_comments_484618.json:
```json
{
    "body": "running tests on Apple M1 (aka aarch64).",
    "created_at": "2022-10-17T14:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484618",
    "user": "@dimpase"
}
```

running tests on Apple M1 (aka aarch64).



---

archive/issue_comments_484619.json:
```json
{
    "body": "I'm getting\n\n```\n    In file included from sage/coding/codecan/codecan.c:5227:\n    /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/include/gap/gasman_intern.h:17:2: error: #error This file must only be included if GASMAN is used\n       17 | #error This file must only be included if GASMAN is used\n```\n\nwhat's the fix here?",
    "created_at": "2022-10-17T15:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484619",
    "user": "@dimpase"
}
```

I'm getting

```
    In file included from sage/coding/codecan/codecan.c:5227:
    /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/include/gap/gasman_intern.h:17:2: error: #error This file must only be included if GASMAN is used
       17 | #error This file must only be included if GASMAN is used
```

what's the fix here?



---

archive/issue_comments_484620.json:
```json
{
    "body": "That's precisely issue (1). Fixed upstream in https://github.com/gap-system/gap/commit/276eb56919400aab91f9e00abb94ddc41a0ffabc",
    "created_at": "2022-10-17T15:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484620",
    "user": "@antonio-rojas"
}
```

That's precisely issue (1). Fixed upstream in https://github.com/gap-system/gap/commit/276eb56919400aab91f9e00abb94ddc41a0ffabc



---

archive/issue_comments_484621.json:
```json
{
    "body": "OK, one needs to patch GAP, as in https://patch-diff.githubusercontent.com/raw/gap-system/gap/pull/5077.diff",
    "created_at": "2022-10-17T15:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484621",
    "user": "@dimpase"
}
```

OK, one needs to patch GAP, as in https://patch-diff.githubusercontent.com/raw/gap-system/gap/pull/5077.diff



---

archive/issue_comments_484622.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T16:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484622",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484623.json:
```json
{
    "body": "we also need to upgrade libsemigroups, and gap_packages. I'm doing this now.",
    "created_at": "2022-10-17T16:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484623",
    "user": "@dimpase"
}
```

we also need to upgrade libsemigroups, and gap_packages. I'm doing this now.



---

archive/issue_comments_484624.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T20:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484624",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484625.json:
```json
{
    "body": "not yet done, as local/share/gap/sysinfo.gap needed a manual addition of \n`-I$SAGE_LOCAL/include/gap` to `GAC_CFLAGS`.",
    "created_at": "2022-10-17T20:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484625",
    "user": "@dimpase"
}
```

not yet done, as local/share/gap/sysinfo.gap needed a manual addition of 
`-I$SAGE_LOCAL/include/gap` to `GAC_CFLAGS`.



---

archive/issue_comments_484626.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T20:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484626",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484627.json:
```json
{
    "body": "There are also failing doctests in `sage/algebras/quantum_groups/quantum_group_gap.py`, like this:\n\n\n```\nsage -t --warn-long 37.8 --random-seed=5244030565037623767917974460011040182 src/sage/algebras/quantum_groups/quantum_group_gap.py\n**********************************************************************\nFile \"src/sage/algebras/quantum_groups/quantum_group_gap.py\", line 1812, in sage.algebras.quantum_groups.quantum_group_gap.TensorProductOfHighestWeightModules.__init__\nFailed example:\n    TestSuite(T).run()  # optional - gap_packages\nExpected nothing\nGot:\n    doctest:warning\n      File \"/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/src/bin/sage-runtests\", line 154, in <module>\n        err = DC.run()\n... \n    DeprecationWarning: implementations of Modules().TensorProducts() now must define the method tensor_factors\n```\n",
    "created_at": "2022-10-17T21:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484627",
    "user": "@dimpase"
}
```

There are also failing doctests in `sage/algebras/quantum_groups/quantum_group_gap.py`, like this:


```
sage -t --warn-long 37.8 --random-seed=5244030565037623767917974460011040182 src/sage/algebras/quantum_groups/quantum_group_gap.py
**********************************************************************
File "src/sage/algebras/quantum_groups/quantum_group_gap.py", line 1812, in sage.algebras.quantum_groups.quantum_group_gap.TensorProductOfHighestWeightModules.__init__
Failed example:
    TestSuite(T).run()  # optional - gap_packages
Expected nothing
Got:
    doctest:warning
      File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/src/bin/sage-runtests", line 154, in <module>
        err = DC.run()
... 
    DeprecationWarning: implementations of Modules().TensorProducts() now must define the method tensor_factors
```




---

archive/issue_comments_484628.json:
```json
{
    "body": "Perhaps Travis can fix these missing methods `tensor_factors`  in `sage/algebras/quantum_groups/quantum_group_gap.py`, so that there won't be a need to patch these doctests.",
    "created_at": "2022-10-17T21:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484628",
    "user": "@dimpase"
}
```

Perhaps Travis can fix these missing methods `tensor_factors`  in `sage/algebras/quantum_groups/quantum_group_gap.py`, so that there won't be a need to patch these doctests.



---

archive/issue_comments_484629.json:
```json
{
    "body": "see #34635",
    "created_at": "2022-10-17T21:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484629",
    "user": "@mkoeppe"
}
```

see #34635



---

archive/issue_comments_484630.json:
```json
{
    "body": "wip on simplifying spkg-install",
    "created_at": "2022-10-19T14:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484630",
    "user": "@dimpase"
}
```

wip on simplifying spkg-install



---

archive/issue_comments_484631.json:
```json
{
    "body": "Attachment [s.patch](tarball://root/attachments/some-uuid/ticket34391/s.patch) by @dimpase created at 2022-10-19 14:51:44\n\nwith this, and https://github.com/gap-system/gap/pull/5091 it mostly works (package installation is broken though) We'll wait for 4.12.1, where also needed package upgrades are done.",
    "created_at": "2022-10-19T14:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484631",
    "user": "@dimpase"
}
```

Attachment [s.patch](tarball://root/attachments/some-uuid/ticket34391/s.patch) by @dimpase created at 2022-10-19 14:51:44

with this, and https://github.com/gap-system/gap/pull/5091 it mostly works (package installation is broken though) We'll wait for 4.12.1, where also needed package upgrades are done.



---

archive/issue_comments_484632.json:
```json
{
    "body": "In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:\n\nhttps://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches\n\nI think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.\n\nNote also that:\na. package names have changed (at least the name of the directories changed case and removed version numbers)\nb. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.\n\nSagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.",
    "created_at": "2022-10-19T15:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484632",
    "user": "@tornaria"
}
```

In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:

https://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches

I think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.

Note also that:
a. package names have changed (at least the name of the directories changed case and removed version numbers)
b. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.

Sagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.



---

archive/issue_comments_484633.json:
```json
{
    "body": "The atlasrep issue is https://github.com/gap-system/gap/issues/5015 and will also be fixed in GAP 4.12.1.",
    "created_at": "2022-10-19T15:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484633",
    "user": "@collares"
}
```

The atlasrep issue is https://github.com/gap-system/gap/issues/5015 and will also be fixed in GAP 4.12.1.



---

archive/issue_comments_484634.json:
```json
{
    "body": "Replying to [comment:34 Gonzalo Tornar\u00eda]:\n> In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:\n> \n> https://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches\n> \n> I think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.\n> \n> Note also that:\n>  a. package names have changed (at least the name of the directories changed case and removed version numbers)\n>  b. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.\n\nFor Sage's installed GAP, this will be `$SAGE_LOCAL/lib/gap/`\n\n\n> \n> Sagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.\n\nTry packages which build executables and/or GAP kernel extensions (the latter need `gac`)\nE.g. `grape` and `crypting`.",
    "created_at": "2022-10-19T16:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484634",
    "user": "@dimpase"
}
```

Replying to [comment:34 Gonzalo Tornaría]:
> In case it's useful, here are the patches I had to use for gap 4.12.0 on void linux:
> 
> https://github.com/void-linux/void-packages/tree/ed7862591d1ff3a617b58ecbe2efdbb5343d508b/srcpkgs/gap/patches
> 
> I think two of those are PR 5077 and PR 5091 already mentioned in this ticket. The third patch I needed to fix something in atlasrep package.
> 
> Note also that:
>  a. package names have changed (at least the name of the directories changed case and removed version numbers)
>  b. `sysinfo.gap` used to be installed in `/usr/share/gap` and now is installed in `/usr/lib/gap`.

For Sage's installed GAP, this will be `$SAGE_LOCAL/lib/gap/`


> 
> Sagemath (9.7 and 9.8.beta2) is working fine with this, but note I only install the minimal set of packages that are standard in sage.

Try packages which build executables and/or GAP kernel extensions (the latter need `gac`)
E.g. `grape` and `crypting`.



---

archive/issue_comments_484635.json:
```json
{
    "body": "update tp 4.12.1\n----\nNew commits:",
    "created_at": "2022-10-21T09:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484635",
    "user": "@dimpase"
}
```

update tp 4.12.1
----
New commits:



---

archive/issue_comments_484636.json:
```json
{
    "body": "GAP package `liepring` now depends on a GAP package `singular`, so we should be installing it ahead of `liepring`.",
    "created_at": "2022-10-21T14:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484636",
    "user": "@dimpase"
}
```

GAP package `liepring` now depends on a GAP package `singular`, so we should be installing it ahead of `liepring`.



---

archive/issue_comments_484637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-21T14:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484637",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484638.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-10-21T14:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484638",
    "user": "@dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_484639.json:
```json
{
    "body": "while more simplifications may be done on spkg-install files for `gap`, and `gap_packages`, this branch appears to work just fine.",
    "created_at": "2022-10-21T14:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484639",
    "user": "@dimpase"
}
```

while more simplifications may be done on spkg-install files for `gap`, and `gap_packages`, this branch appears to work just fine.



---

archive/issue_comments_484640.json:
```json
{
    "body": "`utils` and `autodoc` are now dependencies of `atlasrep` so they need to move from `gap_packages` to `gap`.",
    "created_at": "2022-10-21T17:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484640",
    "user": "@antonio-rojas"
}
```

`utils` and `autodoc` are now dependencies of `atlasrep` so they need to move from `gap_packages` to `gap`.



---

archive/issue_comments_484641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-10-21T17:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484641",
    "user": "@antonio-rojas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_484642.json:
```json
{
    "body": "Max Horn also pointed out that `radiroot` is now a dependency of `polenta`, one of the autoloaded packages. Also, although not strictly necessary, `atlasrep` uses `io` as the preferred method for fetching files over the network (but it will fall back to running wget if that's not available).",
    "created_at": "2022-10-21T18:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484642",
    "user": "@collares"
}
```

Max Horn also pointed out that `radiroot` is now a dependency of `polenta`, one of the autoloaded packages. Also, although not strictly necessary, `atlasrep` uses `io` as the preferred method for fetching files over the network (but it will fall back to running wget if that's not available).



---

archive/issue_comments_484643.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-23T19:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484643",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484644.json:
```json
{
    "body": "done what's requested in comment:41 and comment:42, please review.",
    "created_at": "2022-10-23T19:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484644",
    "user": "@dimpase"
}
```

done what's requested in comment:41 and comment:42, please review.



---

archive/issue_comments_484645.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-10-23T19:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484645",
    "user": "@dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_484646.json:
```json
{
    "body": "Replying to [comment:13 Antonio Rojas]:\n> Feel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.\n\nI think I will submit my changes in a separate ticket, since the present update seems ready and does not make things any worse on aarch64 as far as I can tell. What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.\n\nEdit: Opened #34701, sorry for the noise!",
    "created_at": "2022-10-28T21:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484646",
    "user": "@collares"
}
```

Replying to [comment:13 Antonio Rojas]:
> Feel free to push your changes, I can only test on x86_64 where I haven't seen any such issue so far.

I think I will submit my changes in a separate ticket, since the present update seems ready and does not make things any worse on aarch64 as far as I can tell. What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.

Edit: Opened #34701, sorry for the noise!



---

archive/issue_comments_484647.json:
```json
{
    "body": "Replying to [comment:45 Mauricio Collares]:\n> What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.\n\nyes, that's how this is normally done.",
    "created_at": "2022-10-28T22:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484647",
    "user": "@dimpase"
}
```

Replying to [comment:45 Mauricio Collares]:
> What is the best way to submit a ticket/change which depends on an open one and touches the same lines of code? I think I will just branch off this one and mark the ticket as a dependency.

yes, that's how this is normally done.



---

archive/issue_comments_484648.json:
```json
{
    "body": "Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.",
    "created_at": "2022-10-29T01:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484648",
    "user": "@collares"
}
```

Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.



---

archive/issue_comments_484649.json:
```json
{
    "body": "Replying to [comment:47 Mauricio Collares]:\n> Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.\n\nThis will solve itself once we switch to `make install`. Let's get this is as is and move that to a follow-up ticket (there are some non-trivial adjustments needed for `gap-packages`, and probably the `GAP_ROOT` variable should be rethought or removed completely)",
    "created_at": "2022-10-31T08:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484649",
    "user": "@antonio-rojas"
}
```

Replying to [comment:47 Mauricio Collares]:
> Forwarding another suggestion from Max Horn (in https://github.com/NixOS/nixpkgs/pull/192548#discussion_r989552690): `config.h` is not meant to be installed anymore. The corresponding line in `spkg-install.in` can just be removed, I think.

This will solve itself once we switch to `make install`. Let's get this is as is and move that to a follow-up ticket (there are some non-trivial adjustments needed for `gap-packages`, and probably the `GAP_ROOT` variable should be rethought or removed completely)



---

archive/issue_comments_484650.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-10-31T15:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484650",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_484651.json:
```json
{
    "body": "In #34711 we will switch to using GAP's `make install`. Meanwhile I'm giving this a positive review.",
    "created_at": "2022-10-31T15:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484651",
    "user": "@dimpase"
}
```

In #34711 we will switch to using GAP's `make install`. Meanwhile I'm giving this a positive review.



---

archive/issue_comments_484652.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-11-03T12:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484652",
    "user": "@dimpase"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_484653.json:
```json
{
    "body": "I spoke too soon - tested with unclean SAGE_LOCAL :-(\n\nWith everything clean, while building `gap_packages`, I get\n\n```\ngcc -g -O2 -fPIC -MQ gen/src/crypting.o -MMD -MP -MF gen/src/crypting.d -g -O2 -Wno-implicit-function-declaration -Wno-implicit-function-declaration -o gen/src/crypting.o -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/build -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap -DUSE_GASMAN=1 -c src/crypting.c\nIn file included from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/gap_all.h:51,\n                 from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/compiled.h:26,\n                 from src/crypting.c:5:\n/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/modules.h:19:10: fatal error: version.h: No such file or directory\n   19 | #include \"version.h\"\n      |          ^~~~~~~~~~~\ncompilation terminated.\n```\n\nThe problem is that `version.h` gets installed into `SAGE_LOCAL/include/gap` - a location unknown to `crypting` package makefile.",
    "created_at": "2022-11-03T12:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484653",
    "user": "@dimpase"
}
```

I spoke too soon - tested with unclean SAGE_LOCAL :-(

With everything clean, while building `gap_packages`, I get

```
gcc -g -O2 -fPIC -MQ gen/src/crypting.o -MMD -MP -MF gen/src/crypting.d -g -O2 -Wno-implicit-function-declaration -Wno-implicit-function-declaration -o gen/src/crypting.o -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/build -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap -DUSE_GASMAN=1 -c src/crypting.c
In file included from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/gap_all.h:51,
                 from /home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/compiled.h:26,
                 from src/crypting.c:5:
/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/share/gap/src/modules.h:19:10: fatal error: version.h: No such file or directory
   19 | #include "version.h"
      |          ^~~~~~~~~~~
compilation terminated.
```

The problem is that `version.h` gets installed into `SAGE_LOCAL/include/gap` - a location unknown to `crypting` package makefile.



---

archive/issue_comments_484654.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-11-04T13:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484654",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_484655.json:
```json
{
    "body": "rebased over latest beta, 9.8.beta3",
    "created_at": "2022-11-04T13:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484655",
    "user": "@dimpase"
}
```

rebased over latest beta, 9.8.beta3



---

archive/issue_comments_484656.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-04T14:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484656",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484657.json:
```json
{
    "body": "the current issue is to fix gap's `spkg-check` - currently broken due to a mess\nin some GAP's packages we install, see \nhttps://github.com/gap-packages/crypting/issues/21#issuecomment-1303503670",
    "created_at": "2022-11-04T14:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484657",
    "user": "@dimpase"
}
```

the current issue is to fix gap's `spkg-check` - currently broken due to a mess
in some GAP's packages we install, see 
https://github.com/gap-packages/crypting/issues/21#issuecomment-1303503670



---

archive/issue_comments_484658.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-11-04T14:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484658",
    "user": "@dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_484659.json:
```json
{
    "body": "libgap doesn't find any package\n\n```\nsage: from sage.tests.gap_packages import all_installed_packages\nsage: all_installed_packages()\n()\n```\n",
    "created_at": "2022-11-04T18:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484659",
    "user": "@antonio-rojas"
}
```

libgap doesn't find any package

```
sage: from sage.tests.gap_packages import all_installed_packages
sage: all_installed_packages()
()
```




---

archive/issue_comments_484660.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-11-04T18:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484660",
    "user": "@antonio-rojas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_484661.json:
```json
{
    "body": "Ideally libgap should know where to look for its files without needing to pass the paths with `-l`, but apparently that's not the case (it works fine in the gap command line though, `GAPInfo.RootPaths` returns both paths, `lib` and `share`).\n----\nNew commits:",
    "created_at": "2022-11-04T19:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484661",
    "user": "@antonio-rojas"
}
```

Ideally libgap should know where to look for its files without needing to pass the paths with `-l`, but apparently that's not the case (it works fine in the gap command line though, `GAPInfo.RootPaths` returns both paths, `lib` and `share`).
----
New commits:



---

archive/issue_comments_484662.json:
```json
{
    "body": "There's still one test failure\n\n```\nsage -t --long --random-seed=259290265121646386777269003923470404522 src/sage/tests/gap_packages.py\n**********************************************************************\nFile \"src/sage/tests/gap_packages.py\", line 8, in sage.tests.gap_packages\nFailed example:\n    test_packages(pkgs, only_failures=True)    # optional - gap_packages\nException raised:\n    Traceback (most recent call last):\n      File \"/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.gap_packages[2]>\", line 1, in <module>\n        test_packages(pkgs, only_failures=True)    # optional - gap_packages\n      File \"/home/antonio/Software/sage/sage-gap/src/sage/tests/gap_packages.py\", line 71, in test_packages\n        output = libgap.LoadPackage(pkg)\n      File \"sage/libs/gap/element.pyx\", line 2524, in sage.libs.gap.element.GapElement_Function.__call__\n        sig_on()\n    sage.libs.gap.util.GAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments\n    The 1st argument is 'fail' which might point to an earlier problem\n    Error, was not in any namespace\n    Error, was not in any namespace\n**********************************************************************\n```\n\nIt happens when libgap tries to load the `packagemanager` package\n\n```\nsage: libgap.LoadPackage(\"packagemanager\")\n---------------------------------------------------------------------------\nGAPError                                  Traceback (most recent call last)\nInput In [1], in <cell line: 1>()\n----> 1 libgap.LoadPackage(\"packagemanager\")\n\nFile ~/Software/sage/sage-gap/src/sage/libs/gap/element.pyx:2524, in sage.libs.gap.element.GapElement_Function.__call__()\n   2522 try:\n   2523     sig_GAP_Enter()\n-> 2524     sig_on()\n   2525     if n == 0:\n   2526         result = CALL_0ARGS(self.value)\n\nGAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments\nThe 1st argument is 'fail' which might point to an earlier problem\nError, was not in any namespace\nError, was not in any namespace\n```\n\nIt (seems to) work fine the second time\n\n```\nsage: libgap.LoadPackage(\"packagemanager\")\ntrue\n```\n",
    "created_at": "2022-11-04T19:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484662",
    "user": "@antonio-rojas"
}
```

There's still one test failure

```
sage -t --long --random-seed=259290265121646386777269003923470404522 src/sage/tests/gap_packages.py
**********************************************************************
File "src/sage/tests/gap_packages.py", line 8, in sage.tests.gap_packages
Failed example:
    test_packages(pkgs, only_failures=True)    # optional - gap_packages
Exception raised:
    Traceback (most recent call last):
      File "/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/antonio/Software/sage/sage-gap/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.gap_packages[2]>", line 1, in <module>
        test_packages(pkgs, only_failures=True)    # optional - gap_packages
      File "/home/antonio/Software/sage/sage-gap/src/sage/tests/gap_packages.py", line 71, in test_packages
        output = libgap.LoadPackage(pkg)
      File "sage/libs/gap/element.pyx", line 2524, in sage.libs.gap.element.GapElement_Function.__call__
        sig_on()
    sage.libs.gap.util.GAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments
    The 1st argument is 'fail' which might point to an earlier problem
    Error, was not in any namespace
    Error, was not in any namespace
**********************************************************************
```

It happens when libgap tries to load the `packagemanager` package

```
sage: libgap.LoadPackage("packagemanager")
---------------------------------------------------------------------------
GAPError                                  Traceback (most recent call last)
Input In [1], in <cell line: 1>()
----> 1 libgap.LoadPackage("packagemanager")

File ~/Software/sage/sage-gap/src/sage/libs/gap/element.pyx:2524, in sage.libs.gap.element.GapElement_Function.__call__()
   2522 try:
   2523     sig_GAP_Enter()
-> 2524     sig_on()
   2525     if n == 0:
   2526         result = CALL_0ARGS(self.value)

GAPError: Error, no method found! Error, no 1st choice method found for `Filename' on 2 arguments
The 1st argument is 'fail' which might point to an earlier problem
Error, was not in any namespace
Error, was not in any namespace
```

It (seems to) work fine the second time

```
sage: libgap.LoadPackage("packagemanager")
true
```




---

archive/issue_comments_484663.json:
```json
{
    "body": "Do you need to look for packages in `share/gap`? There should not be any.\nThat's why I doubt your line from `\u200b16c2ccb`:\n\n```\ns = str_to_bytes(sage.env.GAP_LIB_DIR + \";\" + sage.env.GAP_SHARE_DIR, FS_ENCODING, \"surrogateescape\")\n```\n",
    "created_at": "2022-11-04T19:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484663",
    "user": "@dimpase"
}
```

Do you need to look for packages in `share/gap`? There should not be any.
That's why I doubt your line from `​16c2ccb`:

```
s = str_to_bytes(sage.env.GAP_LIB_DIR + ";" + sage.env.GAP_SHARE_DIR, FS_ENCODING, "surrogateescape")
```




---

archive/issue_comments_484664.json:
```json
{
    "body": "Replying to [comment:59 Dima Pasechnik]:\n> Do you need to look for packages in `share/gap`? There should not be any.\n> That's why I doubt your line from `\u200b16c2ccb`:\n\nThat is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.",
    "created_at": "2022-11-04T19:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484664",
    "user": "@antonio-rojas"
}
```

Replying to [comment:59 Dima Pasechnik]:
> Do you need to look for packages in `share/gap`? There should not be any.
> That's why I doubt your line from `​16c2ccb`:

That is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.



---

archive/issue_comments_484665.json:
```json
{
    "body": "Replying to [comment:58 Antonio Rojas]:\n> It happens when libgap tries to load the `packagemanager` package\n\nLooks like `packagemanager` expects a `lib/gap/bin` dir to exist, which is not created by `make install`\n\nhttps://github.com/gap-packages/PackageManager/blob/master/gap/PackageManager.gd#L294\n\nSimply creating an empty `bin` subdir fixes the test.",
    "created_at": "2022-11-04T20:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484665",
    "user": "@antonio-rojas"
}
```

Replying to [comment:58 Antonio Rojas]:
> It happens when libgap tries to load the `packagemanager` package

Looks like `packagemanager` expects a `lib/gap/bin` dir to exist, which is not created by `make install`

https://github.com/gap-packages/PackageManager/blob/master/gap/PackageManager.gd#L294

Simply creating an empty `bin` subdir fixes the test.



---

archive/issue_comments_484666.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-04T20:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484666",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484667.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-11-04T20:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484667",
    "user": "@antonio-rojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_484668.json:
```json
{
    "body": "Reported upstream\n\nhttps://github.com/gap-packages/PackageManager/issues/105",
    "created_at": "2022-11-04T20:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484668",
    "user": "@antonio-rojas"
}
```

Reported upstream

https://github.com/gap-packages/PackageManager/issues/105



---

archive/issue_comments_484669.json:
```json
{
    "body": "Something is fishy with PackageManager in another way, too:  https://github.com/gap-packages/PackageManager/issues/106",
    "created_at": "2022-11-04T21:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484669",
    "user": "@dimpase"
}
```

Something is fishy with PackageManager in another way, too:  https://github.com/gap-packages/PackageManager/issues/106



---

archive/issue_comments_484670.json:
```json
{
    "body": "Replying to [comment:62 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||\n\nbut we don't need lib/gap/bin, it's an upstream bug.",
    "created_at": "2022-11-04T21:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484670",
    "user": "@dimpase"
}
```

Replying to [comment:62 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||

but we don't need lib/gap/bin, it's an upstream bug.



---

archive/issue_comments_484671.json:
```json
{
    "body": "Replying to [comment:65 Dima Pasechnik]:\n> Replying to [comment:62 git]:\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n> > ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||\n> \n> but we don't need lib/gap/bin, it's an upstream bug.\n\nIt breaks a test. We either need to work around this, or we need to stop testing loading the package.",
    "created_at": "2022-11-04T21:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484671",
    "user": "@antonio-rojas"
}
```

Replying to [comment:65 Dima Pasechnik]:
> Replying to [comment:62 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[3abfbd0](https://git.sagemath.org/sage.git/commit/?id=3abfbd014f80dbda16db0f99d6c81486a1f4cf01)||`Create lib/gap/bin on install`||
> 
> but we don't need lib/gap/bin, it's an upstream bug.

It breaks a test. We either need to work around this, or we need to stop testing loading the package.



---

archive/issue_comments_484672.json:
```json
{
    "body": "Replying to [comment:60 Antonio Rojas]:\n> Replying to [comment:59 Dima Pasechnik]:\n> > Do you need to look for packages in `share/gap`? There should not be any.\n> > That's why I doubt your line from `\u200b16c2ccb`:\n> \n> That is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.\n\n\nI feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.",
    "created_at": "2022-11-04T21:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484672",
    "user": "@kiwifb"
}
```

Replying to [comment:60 Antonio Rojas]:
> Replying to [comment:59 Dima Pasechnik]:
> > Do you need to look for packages in `share/gap`? There should not be any.
> > That's why I doubt your line from `​16c2ccb`:
> 
> That is not only for packages. Without this, `libgap` can't find the `lib/init.g` file which is installed under `share/gap` and just crashes on initialization.


I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.



---

archive/issue_comments_484673.json:
```json
{
    "body": "Replying to [comment:67 Fran\u00e7ois Bissey]:\n\n> I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.\n\nTechnically it is the correct place. Arch-independent files belong in `share`.",
    "created_at": "2022-11-04T21:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484673",
    "user": "@antonio-rojas"
}
```

Replying to [comment:67 François Bissey]:

> I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.

Technically it is the correct place. Arch-independent files belong in `share`.



---

archive/issue_comments_484674.json:
```json
{
    "body": "Replying to [comment:68 Antonio Rojas]:\n> Replying to [comment:67 Fran\u00e7ois Bissey]:\n> \n> > I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.\n> \n> Technically it is the correct place. Arch-independent files belong in `share`.\n\nI cannot argue with that. I know I had complaint that in previous gap version, gap packages installed binaries and libraries under `share` which is not right of course. But gap packages are a mixed bag. Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. Python does it, that's a big example to follow.",
    "created_at": "2022-11-04T22:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484674",
    "user": "@kiwifb"
}
```

Replying to [comment:68 Antonio Rojas]:
> Replying to [comment:67 François Bissey]:
> 
> > I feel like it is an oversight upstream. They should move that code under lib/gap too to be consistent. It is probably just a matter of fixing the install target in the makefile.
> 
> Technically it is the correct place. Arch-independent files belong in `share`.

I cannot argue with that. I know I had complaint that in previous gap version, gap packages installed binaries and libraries under `share` which is not right of course. But gap packages are a mixed bag. Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. Python does it, that's a big example to follow.



---

archive/issue_comments_484675.json:
```json
{
    "body": "Actually, the `bin/gap` script created by `make install` contains both paths\n\nhttps://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582\n\nMy commit is just replicating that for the `libgap` call in sage.\n\n\n> Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. \n\nThis is something for upstream to figure out when they integrate package installation in `make install`, which I believe is planned. Until then every distro will manually install packages where they choose to, so we need to search both paths.",
    "created_at": "2022-11-04T23:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484675",
    "user": "@antonio-rojas"
}
```

Actually, the `bin/gap` script created by `make install` contains both paths

https://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582

My commit is just replicating that for the `libgap` call in sage.


> Do we need to sort them out or to make sure only the binary bits get shipped under `lib`? It may become complicated very fast. I feel like the right decision is just to put everything under `lib`. 

This is something for upstream to figure out when they integrate package installation in `make install`, which I believe is planned. Until then every distro will manually install packages where they choose to, so we need to search both paths.



---

archive/issue_comments_484676.json:
```json
{
    "body": "Replying to [comment:70 Antonio Rojas]:\n> Actually, the `bin/gap` script created by `make install` contains both paths\n> \n> https://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582\n> \n\nThat, I noticed when I packaged 4.12.0. I only thought of it as a backward compatible move though. It didn't quite percolate into my brain that it would be needed for the stuff that ship with gap itself.",
    "created_at": "2022-11-04T23:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484676",
    "user": "@kiwifb"
}
```

Replying to [comment:70 Antonio Rojas]:
> Actually, the `bin/gap` script created by `make install` contains both paths
> 
> https://github.com/gap-system/gap/blob/v4.12.1/Makefile.rules#L582
> 

That, I noticed when I packaged 4.12.0. I only thought of it as a backward compatible move though. It didn't quite percolate into my brain that it would be needed for the stuff that ship with gap itself.



---

archive/issue_comments_484677.json:
```json
{
    "body": "another issue is that `make gap-clean` does not seem to work.",
    "created_at": "2022-11-05T00:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484677",
    "user": "@dimpase"
}
```

another issue is that `make gap-clean` does not seem to work.



---

archive/issue_comments_484678.json:
```json
{
    "body": "And installing GAP with `SAGE_CHECK=yes` hangs for me at `gap-4.12.1/src/tst/testinstall/grp/basic.tst`",
    "created_at": "2022-11-05T00:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484678",
    "user": "@dimpase"
}
```

And installing GAP with `SAGE_CHECK=yes` hangs for me at `gap-4.12.1/src/tst/testinstall/grp/basic.tst`



---

archive/issue_comments_484679.json:
```json
{
    "body": "Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.",
    "created_at": "2022-11-05T00:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484679",
    "user": "@collares"
}
```

Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.



---

archive/issue_comments_484680.json:
```json
{
    "body": "Replying to [comment:74 Mauricio Collares]:\n> Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.\n\nThis might be useful: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch",
    "created_at": "2022-11-05T01:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484680",
    "user": "@tornaria"
}
```

Replying to [comment:74 Mauricio Collares]:
> Does it hang if you disable your internet connection? `atlasgrp` fetches precomputed data from the network (using either the `io` GAP package or the `wget` binary) if available, so connection failures/slowness may cause hangs occasionally. It falls back to local computation if there's no internet access.

This might be useful: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch



---

archive/issue_comments_484681.json:
```json
{
    "body": "Replying to [comment:72 Dima Pasechnik]:\n> another issue is that `make gap-clean` does not seem to work.\n\nThe install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)",
    "created_at": "2022-11-12T23:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484681",
    "user": "@mkoeppe"
}
```

Replying to [comment:72 Dima Pasechnik]:
> another issue is that `make gap-clean` does not seem to work.

The install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)



---

archive/issue_comments_484682.json:
```json
{
    "body": "Replying to [comment:76 Matthias K\u00f6ppe]:\n> Replying to [comment:72 Dima Pasechnik]:\n> > another issue is that `make gap-clean` does not seem to work.\n> \n> The install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)\n\nhmm, is this a GAP bug then? Or a Sage bug?",
    "created_at": "2022-11-12T23:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484682",
    "user": "@dimpase"
}
```

Replying to [comment:76 Matthias Köppe]:
> Replying to [comment:72 Dima Pasechnik]:
> > another issue is that `make gap-clean` does not seem to work.
> 
> The install script does not use DESTDIR staging (`sdh_make install` installs directly into the prefix)

hmm, is this a GAP bug then? Or a Sage bug?



---

archive/issue_comments_484683.json:
```json
{
    "body": "Try changing `sdh_make install` to `sdh_make_install`.",
    "created_at": "2022-11-13T02:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484683",
    "user": "@mkoeppe"
}
```

Try changing `sdh_make install` to `sdh_make_install`.



---

archive/issue_comments_484684.json:
```json
{
    "body": "Replying to [comment:78 Matthias K\u00f6ppe]:\n> Try changing `sdh_make install` to `sdh_make_install`.\nright, thanks - this worked after I removed build/pkgs/gap/spkg-prerm.in as well. I'll post a new branch.",
    "created_at": "2022-11-13T19:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484684",
    "user": "@dimpase"
}
```

Replying to [comment:78 Matthias Köppe]:
> Try changing `sdh_make install` to `sdh_make_install`.
right, thanks - this worked after I removed build/pkgs/gap/spkg-prerm.in as well. I'll post a new branch.



---

archive/issue_comments_484685.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-13T20:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484685",
    "user": "@dimpase"
}
```

New commits:



---

archive/issue_comments_484686.json:
```json
{
    "body": "With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`. It's harmless in this particular case though.\n\nLet's leave this to another ticket.",
    "created_at": "2022-11-13T22:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484686",
    "user": "@dimpase"
}
```

With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`. It's harmless in this particular case though.

Let's leave this to another ticket.



---

archive/issue_comments_484687.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-13T23:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484687",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484688.json:
```json
{
    "body": "Now `SAGE_CHECK= yes make gap` passes. All good, as far as I can see.\n\nAnyone wants to give this a positive review?",
    "created_at": "2022-11-13T23:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484688",
    "user": "@dimpase"
}
```

Now `SAGE_CHECK= yes make gap` passes. All good, as far as I can see.

Anyone wants to give this a positive review?



---

archive/issue_comments_484689.json:
```json
{
    "body": "Replying to [comment:82 Dima Pasechnik]:\n> With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.\n\nLikely a defect in the build system of upstream",
    "created_at": "2022-11-13T23:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484689",
    "user": "@mkoeppe"
}
```

Replying to [comment:82 Dima Pasechnik]:
> With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.

Likely a defect in the build system of upstream



---

archive/issue_comments_484690.json:
```json
{
    "body": "Replying to [comment:85 Matthias K\u00f6ppe]:\n> Replying to [comment:82 Dima Pasechnik]:\n> > With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.\n> \n> Likely a defect in the build system of upstream\n\nI must say I've no idea what's going on there. I don't even know any more where Sage stores info on installed by `sdh_install` data.",
    "created_at": "2022-11-13T23:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484690",
    "user": "@dimpase"
}
```

Replying to [comment:85 Matthias Köppe]:
> Replying to [comment:82 Dima Pasechnik]:
> > With gap_packages, cleaning is still not 100% right. Namely, *compiled* GAP packages, e.g. `cohomolo`, leave a skeleton directory after `make gap_packages-clean`.
> 
> Likely a defect in the build system of upstream

I must say I've no idea what's going on there. I don't even know any more where Sage stores info on installed by `sdh_install` data.



---

archive/issue_comments_484691.json:
```json
{
    "body": "The upstream build system likely forgets to use `$(DESTDIR)` in some `mkdir` commands. We've seen this before in other packages.",
    "created_at": "2022-11-14T00:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484691",
    "user": "@mkoeppe"
}
```

The upstream build system likely forgets to use `$(DESTDIR)` in some `mkdir` commands. We've seen this before in other packages.



---

archive/issue_comments_484692.json:
```json
{
    "body": "The staging manifests are in $SAGE_LOCAL/var/lib/sage/installed/",
    "created_at": "2022-11-14T00:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484692",
    "user": "@mkoeppe"
}
```

The staging manifests are in $SAGE_LOCAL/var/lib/sage/installed/



---

archive/issue_comments_484693.json:
```json
{
    "body": "Replying to [comment:83 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[97dc1ea](https://git.sagemath.org/sage.git/commit/?id=97dc1ea93e313c3d6c0e7bf3868dbb2143fceef8)||`with SAGE_CHECK=yes, one needs io installed to prevent hangs`||\n\nNote that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.\n\nAn alternative is to configure atlasrep to not hit the network by default\n(very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).\n\nI'm not sure what's better for sage.",
    "created_at": "2022-11-14T00:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484693",
    "user": "@tornaria"
}
```

Replying to [comment:83 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[97dc1ea](https://git.sagemath.org/sage.git/commit/?id=97dc1ea93e313c3d6c0e7bf3868dbb2143fceef8)||`with SAGE_CHECK=yes, one needs io installed to prevent hangs`||

Note that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.

An alternative is to configure atlasrep to not hit the network by default
(very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).

I'm not sure what's better for sage.



---

archive/issue_comments_484694.json:
```json
{
    "body": "I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?",
    "created_at": "2022-11-14T01:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484694",
    "user": "@collares"
}
```

I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?



---

archive/issue_comments_484695.json:
```json
{
    "body": "Replying to [comment:90 Mauricio Collares]:\n> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?\n\nThat takes less than a second for me:\n\n```\ngap> t:=time;; Length(MaximalSubgroupClassReps(SimpleGroup(\"M24\"))); time-t;\n9\n684\n```\n",
    "created_at": "2022-11-14T01:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484695",
    "user": "@tornaria"
}
```

Replying to [comment:90 Mauricio Collares]:
> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?

That takes less than a second for me:

```
gap> t:=time;; Length(MaximalSubgroupClassReps(SimpleGroup("M24"))); time-t;
9
684
```




---

archive/issue_comments_484696.json:
```json
{
    "body": "Replying to [comment:90 Mauricio Collares]:\n> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?\n\nno, what I see is a total hang, nothing happens, CPUs don't do anything, etc.",
    "created_at": "2022-11-14T10:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484696",
    "user": "@dimpase"
}
```

Replying to [comment:90 Mauricio Collares]:
> I forgot to mention that GAP's `make check` contains one test (https://github.com/gap-system/gap/blob/v4.12.0/tst/testinstall/grpperm.tst#L67) that takes a really long time (at least ten minutes) to run if you disable usage of precomputed data. Maybe that's the hang reported above?

no, what I see is a total hang, nothing happens, CPUs don't do anything, etc.



---

archive/issue_comments_484697.json:
```json
{
    "body": "Replying to [comment:89 Gonzalo Tornar\u00eda]:\n\n> Note that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.\n> \n> An alternative is to configure atlasrep to not hit the network by default\n> (very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).\n\nIt's not `atlastrep` here, it's other packages that use parallel computation facilities of `io` in their testsuites. Note that we're running tests on whatever is in the GAP tarball, not on the installed configuration. I think it's an upstream bug, I'll open an issue in this regard, but I think it can wait for another ticket, it's not a regression.",
    "created_at": "2022-11-14T10:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484697",
    "user": "@dimpase"
}
```

Replying to [comment:89 Gonzalo Tornaría]:

> Note that, if I'm not mistaken, `io` is needed for `atlasrep` and only to hit the network in the absence of `curl` and `wget`.
> 
> An alternative is to configure atlasrep to not hit the network by default
> (very easy: https://github.com/void-linux/void-packages/blob/master/srcpkgs/gap/patches/atlasrep-dont_use_network_by_default.patch).

It's not `atlastrep` here, it's other packages that use parallel computation facilities of `io` in their testsuites. Note that we're running tests on whatever is in the GAP tarball, not on the installed configuration. I think it's an upstream bug, I'll open an issue in this regard, but I think it can wait for another ticket, it's not a regression.



---

archive/issue_comments_484698.json:
```json
{
    "body": "ping?",
    "created_at": "2022-11-21T12:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484698",
    "user": "@dimpase"
}
```

ping?



---

archive/issue_comments_484699.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-11-23T18:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484699",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_484700.json:
```json
{
    "body": "rebased over 9.8.beta4",
    "created_at": "2022-11-23T20:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484700",
    "user": "@dimpase"
}
```

rebased over 9.8.beta4



---

archive/issue_comments_484701.json:
```json
{
    "body": "I'm hitting a snag while testing with `gap_packages` installed on macOS 13.0.1.\n\n```\nFile \"src/sage/libs/gap/libgap.pyx\", line 11, in sage.libs.gap.libgap\nFailed example:\n    a = libgap(10)\nExpected nothing\nGot:\n    Error, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap\\\n    /pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\\\n    ware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, \\\n    0x0005): Symbol not found: _AssGVar\n      Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software\\\n    /sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so\n      Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/\\\n    Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python\n    Error, was not in any namespace\n    Syntax warning: Unbound global variable in /Users/dima/software/sage/local/sha\\\n    re/gap/lib/init.g:740\n        ColorPrompt( UserPreference( \"UseColorPrompt\" ) );\n        ^^^^^^^^^^^\n    Error, SetGasmanMessageStatus: function is not yet defined\n    Error, Variable: 'L1_IMMUTABLE_ERROR' must have a value\n```\n\n\nNot sure whether this is reproducible on older macOS - everything is fine on Linux. Note that package `io` has a \"GAP kernel module\", i.e. a special dynamic library which extends GAP capabilities (not dissimilar to Python extension modules with, say, parts written in C).\n\nI can also reproduce this at the Sage prompt (after I remove pre-built GAP images):\n\n```\n$ rm -rf ~/.sage \n$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.8.beta4, Release Date: 2022-11-21               \u2502\n\u2502 Using Python 3.11.0. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: libgap(10)\nError, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\\\nware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, 0x0005): Symbol not found: _AssGVar\n  Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so\n  Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python\nError, was not in any namespace\nSyntax warning: Unbound global variable in /Users/dima/software/sage/local/share/gap/lib/init.g:740\n    ColorPrompt( UserPreference( \"UseColorPrompt\" ) );\n    ^^^^^^^^^^^\nError, SetGasmanMessageStatus: function is not yet defined\nError, Variable: 'L1_IMMUTABLE_ERROR' must have a value\n10\n```\n",
    "created_at": "2022-11-30T18:07:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484701",
    "user": "@dimpase"
}
```

I'm hitting a snag while testing with `gap_packages` installed on macOS 13.0.1.

```
File "src/sage/libs/gap/libgap.pyx", line 11, in sage.libs.gap.libgap
Failed example:
    a = libgap(10)
Expected nothing
Got:
    Error, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap\
    /pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\
    ware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, \
    0x0005): Symbol not found: _AssGVar
      Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software\
    /sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so
      Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/\
    Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python
    Error, was not in any namespace
    Syntax warning: Unbound global variable in /Users/dima/software/sage/local/sha\
    re/gap/lib/init.g:740
        ColorPrompt( UserPreference( "UseColorPrompt" ) );
        ^^^^^^^^^^^
    Error, SetGasmanMessageStatus: function is not yet defined
    Error, Variable: 'L1_IMMUTABLE_ERROR' must have a value
```


Not sure whether this is reproducible on older macOS - everything is fine on Linux. Note that package `io` has a "GAP kernel module", i.e. a special dynamic library which extends GAP capabilities (not dissimilar to Python extension modules with, say, parts written in C).

I can also reproduce this at the Sage prompt (after I remove pre-built GAP images):

```
$ rm -rf ~/.sage 
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta4, Release Date: 2022-11-21               │
│ Using Python 3.11.0. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: libgap(10)
Error, LOAD_DYN: failed to load kernel module /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, dlopen(/Users/dima/soft\
ware/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so, 0x0005): Symbol not found: _AssGVar
  Referenced from: <19D7E0D8-C31C-3325-B693-D1B981EBA814> /Users/dima/software/sage/local/lib/gap/pkg/io/bin/x86_64-apple-darwin22-default64-kv8/io.so
  Expected in:     <BE7F0B90-13D6-39B8-AE6C-1DB05808B5AF> /Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/Contents/MacOS/Python
Error, was not in any namespace
Syntax warning: Unbound global variable in /Users/dima/software/sage/local/share/gap/lib/init.g:740
    ColorPrompt( UserPreference( "UseColorPrompt" ) );
    ^^^^^^^^^^^
Error, SetGasmanMessageStatus: function is not yet defined
Error, Variable: 'L1_IMMUTABLE_ERROR' must have a value
10
```




---

archive/issue_comments_484702.json:
```json
{
    "body": "Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.",
    "created_at": "2022-11-30T19:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484702",
    "user": "@kiwifb"
}
```

Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.



---

archive/issue_comments_484703.json:
```json
{
    "body": "Replying to [comment:98 Fran\u00e7ois Bissey]:\n> Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.\n\nit's not, and this is by design. it's meant to be loaded by libgap, not the other way around.\nIt's probably a race condition of some kind.",
    "created_at": "2022-11-30T20:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484703",
    "user": "@dimpase"
}
```

Replying to [comment:98 François Bissey]:
> Can you check that the `io.so` dynamic object is properly linked to libgap? With the right path.

it's not, and this is by design. it's meant to be loaded by libgap, not the other way around.
It's probably a race condition of some kind.



---

archive/issue_comments_484704.json:
```json
{
    "body": "see https://github.com/gap-system/gap/issues/5232 for an upstream report. Fortunately it can be reproduced within GAP's testsuite.",
    "created_at": "2022-11-30T21:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484704",
    "user": "@dimpase"
}
```

see https://github.com/gap-system/gap/issues/5232 for an upstream report. Fortunately it can be reproduced within GAP's testsuite.



---

archive/issue_comments_484705.json:
```json
{
    "body": "Dima pointed me here.\n\nI already communicated various comments to him on our (GAP's) issue tracker. But I also just had a look at the overall diff for the changes so far. Some remarks:\n\nWe have a new helper function `CALL_WITH_STREAM` which you could use to rewrite your `capture_stdout` with pure GAP. As an example, in `GAP.jl` (Julia interface to GAP), I use these two helpers; adapting that code to match `capture_stdout` is straight-forward. Note that I use `SetPrintFormattingStatus` there to avoid diffs caused by the width of the user's terminal; but if you want to 100% faithfully reproduce what GAP does, then leave that out.\n\n```\nBindGlobal( \"StringDisplayObj\",\nfunction(obj)\n  local str, out;\n  str := \"\";\n  out := OutputTextString(str, false);\n  SetPrintFormattingStatus(out, false);\n  CALL_WITH_STREAM(out, Display, [obj]);\n  CloseStream(out);\n  return str;\nend );\n\nBindGlobal( \"StringViewObj\",\nfunction(obj)\n  local str, out;\n  str := \"\";\n  out := OutputTextString(str, false);\n  SetPrintFormattingStatus(out, false);\n  CALL_WITH_STREAM(out, ViewObj, [obj]);\n  CloseStream(out);\n  return str;\nend );\n```\n\nThis is of course in the end equivalent to what `capture_stdout` does, but while `CALL_WITH_STREAM` is also undocumented, it'll be more stable than calling internal kernel functions like  `OpenOutputStream`. We could also eventually offer a documented, high-level version of it as `CallWithStream`; the main reason that's not yet there is that I first wanted to validate the design. If Sage also finds it useful, that would be a strong motivation to provide a fully documented `CallWithStream` in GAP 4.13. In addition or alternatively, functions like `StringViewObj` or `StringPrint` could be provided, but there it is already less clear that we can agree on a common version (see `SetPrintFormattingStatus` ...) ?\n\n\n\n- Another point: you could replace your uses of `GVarName` and `AssGVar` by `GAP_AssignGlobalVariable` (the performance overhead of re-calling `GVarName` should be miniscule; if `hold_reference` ever is called in a tight loop, that code likely has more serious problems than that...\n\n- alternatively just remove `hold_reference` (nothing uses it?)\n\n- remove `NewBag` and `CallbackForAllBags` from `gap_includes.pxd` ?\n\n- there are a lot of other things that could be replaced by \"official\" libgap API usage, e.g. `IS_INT` -> `GAP_IsInt`, `IS_INTOBJ` -> `GAP_IsSmallInt`, `SUM` -> `GAP_SUM`, `VAL_MACFLOAT` -> `GAP_ValueMacFloat`, etc. -- most of these were added specifically for use by Sage years ago but apparently are not actually used by Sage? Overall I would expect that a majority of the imports from outside `libgap-api.h` can be replaced. If someone wants to work on that and needs help to figure out what replaces what, I'll be happy to assist",
    "created_at": "2022-12-01T15:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484705",
    "user": "@fingolfin"
}
```

Dima pointed me here.

I already communicated various comments to him on our (GAP's) issue tracker. But I also just had a look at the overall diff for the changes so far. Some remarks:

We have a new helper function `CALL_WITH_STREAM` which you could use to rewrite your `capture_stdout` with pure GAP. As an example, in `GAP.jl` (Julia interface to GAP), I use these two helpers; adapting that code to match `capture_stdout` is straight-forward. Note that I use `SetPrintFormattingStatus` there to avoid diffs caused by the width of the user's terminal; but if you want to 100% faithfully reproduce what GAP does, then leave that out.

```
BindGlobal( "StringDisplayObj",
function(obj)
  local str, out;
  str := "";
  out := OutputTextString(str, false);
  SetPrintFormattingStatus(out, false);
  CALL_WITH_STREAM(out, Display, [obj]);
  CloseStream(out);
  return str;
end );

BindGlobal( "StringViewObj",
function(obj)
  local str, out;
  str := "";
  out := OutputTextString(str, false);
  SetPrintFormattingStatus(out, false);
  CALL_WITH_STREAM(out, ViewObj, [obj]);
  CloseStream(out);
  return str;
end );
```

This is of course in the end equivalent to what `capture_stdout` does, but while `CALL_WITH_STREAM` is also undocumented, it'll be more stable than calling internal kernel functions like  `OpenOutputStream`. We could also eventually offer a documented, high-level version of it as `CallWithStream`; the main reason that's not yet there is that I first wanted to validate the design. If Sage also finds it useful, that would be a strong motivation to provide a fully documented `CallWithStream` in GAP 4.13. In addition or alternatively, functions like `StringViewObj` or `StringPrint` could be provided, but there it is already less clear that we can agree on a common version (see `SetPrintFormattingStatus` ...) ?



- Another point: you could replace your uses of `GVarName` and `AssGVar` by `GAP_AssignGlobalVariable` (the performance overhead of re-calling `GVarName` should be miniscule; if `hold_reference` ever is called in a tight loop, that code likely has more serious problems than that...

- alternatively just remove `hold_reference` (nothing uses it?)

- remove `NewBag` and `CallbackForAllBags` from `gap_includes.pxd` ?

- there are a lot of other things that could be replaced by "official" libgap API usage, e.g. `IS_INT` -> `GAP_IsInt`, `IS_INTOBJ` -> `GAP_IsSmallInt`, `SUM` -> `GAP_SUM`, `VAL_MACFLOAT` -> `GAP_ValueMacFloat`, etc. -- most of these were added specifically for use by Sage years ago but apparently are not actually used by Sage? Overall I would expect that a majority of the imports from outside `libgap-api.h` can be replaced. If someone wants to work on that and needs help to figure out what replaces what, I'll be happy to assist



---

archive/issue_comments_484706.json:
```json
{
    "body": "I just noticed you do this, so I am guessing you will want to also use `SetPrintFormattingStatus` as mentioned above, as a better alternative to that hack\n\n\n```\n    argv[8] = \"-x\"    # set the \"screen\" width so that GAP is less likely to\n    argv[9] = \"4096\"  # insert newlines when printing objects\n                      # 4096 unfortunately is the hard-coded max, but should\n                      # be long enough for most cases\n\n```\n\n\nYou also have the following:\n\n\n```\n    argv[1] = \"-l\"\n    s = str_to_bytes(gap_root(), FS_ENCODING, \"surrogateescape\")\n    argv[2] = s\n\n```\n\n\nThis shouldn't be necessary anymore in 4.12.2 (due in ~2 weeks), thanks to https://github.com/gap-system/gap/pull/5193",
    "created_at": "2022-12-01T17:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484706",
    "user": "@fingolfin"
}
```

I just noticed you do this, so I am guessing you will want to also use `SetPrintFormattingStatus` as mentioned above, as a better alternative to that hack


```
    argv[8] = "-x"    # set the "screen" width so that GAP is less likely to
    argv[9] = "4096"  # insert newlines when printing objects
                      # 4096 unfortunately is the hard-coded max, but should
                      # be long enough for most cases

```


You also have the following:


```
    argv[1] = "-l"
    s = str_to_bytes(gap_root(), FS_ENCODING, "surrogateescape")
    argv[2] = s

```


This shouldn't be necessary anymore in 4.12.2 (due in ~2 weeks), thanks to https://github.com/gap-system/gap/pull/5193



---

archive/issue_comments_484707.json:
```json
{
    "body": "This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.\n\nWe are still hoping that https://pypi.org/project/gappy-system/ (also https://github.com/embray/gappy) will be a proper replacement for our libgap interface, but unfortunately gappy is  stalled, as `@`embray is at greener pastures nowadays.",
    "created_at": "2022-12-01T17:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484707",
    "user": "@dimpase"
}
```

This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.

We are still hoping that https://pypi.org/project/gappy-system/ (also https://github.com/embray/gappy) will be a proper replacement for our libgap interface, but unfortunately gappy is  stalled, as `@`embray is at greener pastures nowadays.



---

archive/issue_comments_484708.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-01T17:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484708",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_484709.json:
```json
{
    "body": "Replying to [comment:104 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[29383be](https://git.sagemath.org/sage.git/commit/?id=29383be9dbea4e49004ed57d5f23e34155174548)||`backport GAP PR 5235`||\n\nthis fixes the issue in comment:100.\n\nReady for review, again.",
    "created_at": "2022-12-01T23:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484709",
    "user": "@dimpase"
}
```

Replying to [comment:104 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[29383be](https://git.sagemath.org/sage.git/commit/?id=29383be9dbea4e49004ed57d5f23e34155174548)||`backport GAP PR 5235`||

this fixes the issue in comment:100.

Ready for review, again.



---

archive/issue_comments_484710.json:
```json
{
    "body": "> This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.\n\nThat makes perfect sense. So, view this as an offer: if someone would like to tackle cleaning up some of these things, feel free to contact me for assistance.\n\n\nIn other news, as some of you are probably already aware, we just release GAP 4.12.2 which should make some of the patches here unnecessary.",
    "created_at": "2022-12-19T08:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484710",
    "user": "@fingolfin"
}
```

> This ticket is just an effort to get the ball rolling towards upgrading to GAP 4.12. Improvements to the intetface to libgap should not take place here, it's heavy enough as it is.

That makes perfect sense. So, view this as an offer: if someone would like to tackle cleaning up some of these things, feel free to contact me for assistance.


In other news, as some of you are probably already aware, we just release GAP 4.12.2 which should make some of the patches here unnecessary.



---

archive/issue_comments_484711.json:
```json
{
    "body": "Yes, we'll definitely use 4.12.2",
    "created_at": "2022-12-19T09:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484711",
    "user": "@dimpase"
}
```

Yes, we'll definitely use 4.12.2



---

archive/issue_comments_484712.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-12-19T09:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34154#issuecomment-484712",
    "user": "@dimpase"
}
```

Changing status from needs_review to needs_work.
