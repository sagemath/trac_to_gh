# Issue 15944: inject_shorthands broken since 6.2beta8

Issue created by migration from Trac.

Original creator: darij

Original creation time: 2014-04-17 22:30:26

CC:  nthiery vbraun

Keywords: globals, inject_shorthands, regression,


```
sage: NSym = NonCommutativeSymmetricFunctions(QQ)
sage: NSym.inject_shorthands()
Injecting S as shorthand for Non-Commutative Symmetric Functions over the Rational Field in the Complete basis
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-2-458277a04544> in <module>()
----> 1 NSym.inject_shorthands()

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/sets_cat.pyc in inject_shorthands(self, verbose)
   1318                     if verbose:
   1319                         print 'Injecting %s as shorthand for %s'%(shorthand, realization)
-> 1320                     inject_variable(shorthand, realization)
   1321 
   1322             def realizations(self):

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in inject_variable(name, value)
   2356     # inject_variable is called not only from the interpreter, but
   2357     # also from functions in various modules.
-> 2358     G = get_main_globals()
   2359     if name in G:
   2360         warn("redefining global value `%s`"%name, RuntimeWarning, stacklevel = 2)

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/misc.pyc in get_main_globals()
   2312     while True:
   2313         G = sys._getframe(depth).f_globals
-> 2314         if G["__name__"] == "__main__" and G["__package__"] is None:
   2315             break
   2316         depth += 1

KeyError: '__package__'
```


Same for Sym and QSym.

The `get_main_globals` method hasn't been changed since 2011, so I suspect something else is at fault. The attached branch gets rid of the bug, but I don't understand the code at hand and so it is not really merge-ready. Needs_review is to increase visibility.


---

Comment by darij created at 2014-04-17 22:30:36

Changing status from new to needs_review.


---

Comment by darij created at 2014-04-17 22:37:56

Oh, and apparently importing any(!) sage file beforehand keeps the bug from happening. Here is an example that does not throw errors:

```
sage: import sage.combinat.permutation
sage: NSym = NonCommutativeSymmetricFunctions(QQ)
sage: NSym.inject_shorthands()
```



---

Comment by git created at 2014-04-18 01:59:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-04-18 02:00:38

Just doing

```
sage: sage.misc.misc.inject_variable('a', 0)
```

(before an import) is enough to cause the error. If I had to make a WAG, I'd say it's the IPython upgrade. I've added this as a doctest, so if you're happy this (and I'm okay with fixing the symptoms), positive review.


---

Comment by darij created at 2014-04-18 02:02:40

Unfortunately this doctest works even without the patch :(

And moving it to the very front of the file doesn't help either...


---

Comment by darij created at 2014-04-18 02:03:32

Oops, sorry for removing you from cc, Volker (I really should report this as a trac bug -- I started writing my post before you made yours -- but I'm too lazy).


---

Comment by tscrim created at 2014-04-18 02:08:44

Hmm...there must be something going on within the doctesting framework that prevents this from begin executed before any imports. We can leave it in there as a human warning, but honestly noone is really going to look at that test (much less run it manually)...


---

Comment by darij created at 2014-04-18 02:12:33

BTW: when I do `sys._getframe(0).f_globals`, I get the following cruft:


```
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.elementary.<tab> instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.<tab> instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.AlcovePath instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.FastRankTwo instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.infinity.Tableaux instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.TensorProductOfKirillovReshetikhinTableaux instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KyotoPathModel instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.Letters instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.DirectSum instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovReshetikhin with model='KR' instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.KirillovResetikhin instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2834: DeprecationWarning: this is being removed from the global namespace. Use crystals.HighestWeight instead
See http://trac.sagemath.org/15882 for details.
  exec code_obj in self.user_global_ns, self.user_ns
/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/core.py:14: ImportWarning: Not importing directory '/home/darij/gitsage6.2/local/lib/python2.7/site-packages/Babel-1.3-py2.7.egg/babel/localedata': missing __init__.py
  from babel import localedata
```


And this is just the error output. Here is the actual dictionary: https://www.dropbox.com/s/6hzuqm6jf9jo9jt/outtext.txt

I can't believe this all needs to be in the globals?


---

Comment by tscrim created at 2014-04-18 02:22:07

Those deprecations are from #15882 (ex. `CrystalOfTableaux`) where I used #14275 to (lazily) import them with a deprecation message and there was no good alternative that I could find (because I didn't want to write some 20 functions where all they did was deprecate something with a [semi]specific message). Moreover, I'd be surprised if they had any bearing on this issue.


---

Comment by darij created at 2014-04-18 02:26:51

Yeah, I now see it's pretty much orthogonal to what we're doing here. Good to know we've got a `delsarte_bound_additive_hamming_space` function in our global namespace, though :)


---

Comment by darij created at 2014-04-18 02:32:03

From `sage/doctest/forker.py`:


```
                # Make the right set of globals available to doctests
                if basename.startswith("sagenb."):
                    import sage.all_notebook as sage_all
                else:
                    import sage.all_cmdline as sage_all
                sage_namespace = RecordingDict(sage_all.__dict__)
                sage_namespace['__name__'] = '__main__'
                sage_namespace['__package__'] = None
                doctests, extras = self.source.create_doctests(sage_namespace)
                timer = Timer().start()
```


I'm wondering if we should just axe the line with the `__package__` here?


---

Comment by darij created at 2014-04-18 02:42:31

OK, axing doesn't work, since this line is there to undo the (apparently Sphinx-specific) setting of `__package__` to `sage`. Let me try `del`...


---

Comment by darij created at 2014-04-18 02:54:00

EDIT: ignore this post.


---

Comment by git created at 2014-04-18 02:58:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by darij created at 2014-04-18 02:58:59

OK, forget about the second branch; I've just hijacked the main branch with what I think is a full solution. Warning: forced push!


---

Comment by git created at 2014-04-18 04:07:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-04-19 06:09:09

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-04-19 06:09:09

LGTM.


---

Comment by darij created at 2014-04-19 06:11:05

Thank you, Travis!!

*blush* I guess I really should start reviewing...


---

Comment by vbraun created at 2014-04-19 23:31:12

* Can we not leave commented-out lines lying around?

* IMHO the check should just be 
  {{{
  if G.get("__name__", None) == "__main__":
  }}}
  and not look at `__package__`. The topmost `'__main__'` frame is our guy, duh. Also this won't trip over similar issues if some frame doesn't have `__name__`.

* The new doctest is just like doctests that we already have, it doesn't add anything new.


---

Comment by vbraun created at 2014-04-19 23:31:12

Changing status from positive_review to needs_info.


---

Comment by git created at 2014-04-19 23:56:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-19 23:57:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-04-19 23:58:26

ad 1: True; that was a habit from pre-git times. Removed.

ad 2: I have changed it now but I'm not 100% sure (what happens if we are doctesting a package?). I don't have time to run all the doctests now...

ad 3: I can't follow this. It is import-less and it stands at the beginning of the file. At least the first of these properties is crucial!


---

Comment by darij created at 2014-04-20 00:00:05

Changing status from needs_info to needs_review.


---

Comment by vbraun created at 2014-04-20 23:37:13

Resolution: fixed
