# Issue 16131: Build of libm4ri autodetects system libpng instead of sage libpng

Issue created by migration from Trac.

Original creator: stephen

Original creation time: 2014-05-16 20:41:36

When building sage-6.2 under FreeBSD, the configure script in libm4ri links to the system libpng rather than the sage libpng.  If the system libpng is a different version (e.g. in FreeBSD it is version 1.5 instead of 1.2), then many of the tests fail.

It can be fixed by this simple patch, which tells the configure script where to find libpng.pc.


```
--- build/pkgs/libm4ri/spkg-install-orig        2014-05-16 18:34:53.000000000 +0000
+++ build/pkgs/libm4ri/spkg-install     2014-05-16 18:48:25.000000000 +0000
`@``@` -54,6 +54,7 `@``@`

 cd $ROOT_DIR/src/

+env PKG_CONFIG_LIBDIR=$SAGE_LOCAL/lib/pkgconfig \
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" $ENABLE_DEBUG $DISABLE_SSE2

 if [ $? -ne 0 ]; then
```



---

Comment by leif created at 2014-05-16 23:39:45

We should IMHO repurpose this ticket to either make many if not almost all packages depend on `pkgconf` (which currently also creates the `pkg-config` wrapper script in `$SAGE_LOCAL/bin/`), or to reenable setting `PKG_CONFIG_PATH` in `sage-env`.


---

Comment by leif created at 2014-05-16 23:44:55

Changing priority from major to critical.


---

Comment by leif created at 2014-05-16 23:44:55

Changing keywords from "" to "pkg-config pkgconfig".


---

Comment by leif created at 2014-05-16 23:44:55

Changing component from porting: BSD to build.


---

Comment by vbraun created at 2014-05-17 10:21:23

Enabling `PKG_CONFIG_PATH` would still break on OSX, we need to get the dependencies right.


---

Comment by vbraun created at 2014-05-17 19:33:25

I've grepped the logs for "pkg-config" and added the relevant dependencies. 

Also, whitespace fix. In fact I'm surprised that spaces before the tab in make rules are not a hard error.
----
New commits:


---

Comment by vbraun created at 2014-05-17 20:30:48

Full rebuild worked and now all log entries point to our pkg-config.


---

Comment by vbraun created at 2014-05-17 20:30:48

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-05-19 10:22:25

Changing priority from critical to blocker.


---

Comment by malb created at 2014-05-23 15:21:21

Changing status from needs_review to positive_review.


---

Comment by malb created at 2014-05-23 15:21:21

Looks okay to me.


---

Comment by jhpalmieri created at 2014-05-23 17:28:02

Should ncurses install .pc files in `SAGE_LOCAL/lib/pkgconfig`? If that's a good idea, I can create a followup ticket to do that.


---

Comment by vbraun created at 2014-05-23 17:56:31

Yes, please do!


---

Comment by jhpalmieri created at 2014-05-23 23:04:36

See #16392.


---

Comment by vbraun created at 2014-05-25 10:09:22

Resolution: fixed
