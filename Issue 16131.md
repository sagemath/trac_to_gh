# Issue 16131: Build of libm4ri autodetects system libpng instead of sage libpng

archive/issues_016131.json:
```json
{
    "body": "When building sage-6.2 under FreeBSD, the configure script in libm4ri links to the system libpng rather than the sage libpng.  If the system libpng is a different version (e.g. in FreeBSD it is version 1.5 instead of 1.2), then many of the tests fail.\n\nIt can be fixed by this simple patch, which tells the configure script where to find libpng.pc.\n\n\n```\n--- build/pkgs/libm4ri/spkg-install-orig        2014-05-16 18:34:53.000000000 +0000\n+++ build/pkgs/libm4ri/spkg-install     2014-05-16 18:48:25.000000000 +0000\n@@ -54,6 +54,7 @@\n\n cd $ROOT_DIR/src/\n\n+env PKG_CONFIG_LIBDIR=$SAGE_LOCAL/lib/pkgconfig \\\n ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" $ENABLE_DEBUG $DISABLE_SSE2\n\n if [ $? -ne 0 ]; then\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16368\n\n",
    "created_at": "2014-05-16T20:41:36Z",
    "labels": [
        "component: porting: bsd",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Build of libm4ri autodetects system libpng instead of sage libpng",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16131",
    "user": "https://trac.sagemath.org/admin/accounts/users/stephen"
}
```
When building sage-6.2 under FreeBSD, the configure script in libm4ri links to the system libpng rather than the sage libpng.  If the system libpng is a different version (e.g. in FreeBSD it is version 1.5 instead of 1.2), then many of the tests fail.

It can be fixed by this simple patch, which tells the configure script where to find libpng.pc.


```
--- build/pkgs/libm4ri/spkg-install-orig        2014-05-16 18:34:53.000000000 +0000
+++ build/pkgs/libm4ri/spkg-install     2014-05-16 18:48:25.000000000 +0000
@@ -54,6 +54,7 @@

 cd $ROOT_DIR/src/

+env PKG_CONFIG_LIBDIR=$SAGE_LOCAL/lib/pkgconfig \
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" $ENABLE_DEBUG $DISABLE_SSE2

 if [ $? -ne 0 ]; then
```


Issue created by migration from https://trac.sagemath.org/ticket/16368





---

archive/issue_comments_210260.json:
```json
{
    "body": "We should IMHO repurpose this ticket to either make many if not almost all packages depend on `pkgconf` (which currently also creates the `pkg-config` wrapper script in `$SAGE_LOCAL/bin/`), or to reenable setting `PKG_CONFIG_PATH` in `sage-env`.",
    "created_at": "2014-05-16T23:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210260",
    "user": "https://github.com/nexttime"
}
```

We should IMHO repurpose this ticket to either make many if not almost all packages depend on `pkgconf` (which currently also creates the `pkg-config` wrapper script in `$SAGE_LOCAL/bin/`), or to reenable setting `PKG_CONFIG_PATH` in `sage-env`.



---

archive/issue_comments_210261.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2014-05-16T23:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210261",
    "user": "https://github.com/nexttime"
}
```

Changing priority from major to critical.



---

archive/issue_comments_210262.json:
```json
{
    "body": "Changing keywords from \"\" to \"pkg-config pkgconfig\".",
    "created_at": "2014-05-16T23:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210262",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "" to "pkg-config pkgconfig".



---

archive/issue_comments_210263.json:
```json
{
    "body": "Changing component from porting: BSD to build.",
    "created_at": "2014-05-16T23:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210263",
    "user": "https://github.com/nexttime"
}
```

Changing component from porting: BSD to build.



---

archive/issue_comments_210264.json:
```json
{
    "body": "Enabling `PKG_CONFIG_PATH` would still break on OSX, we need to get the dependencies right.",
    "created_at": "2014-05-17T10:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210264",
    "user": "https://github.com/vbraun"
}
```

Enabling `PKG_CONFIG_PATH` would still break on OSX, we need to get the dependencies right.



---

archive/issue_comments_210265.json:
```json
{
    "body": "I've grepped the logs for \"pkg-config\" and added the relevant dependencies. \n\nAlso, whitespace fix. In fact I'm surprised that spaces before the tab in make rules are not a hard error.\n----\nNew commits:",
    "created_at": "2014-05-17T19:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210265",
    "user": "https://github.com/vbraun"
}
```

I've grepped the logs for "pkg-config" and added the relevant dependencies. 

Also, whitespace fix. In fact I'm surprised that spaces before the tab in make rules are not a hard error.
----
New commits:



---

archive/issue_comments_210266.json:
```json
{
    "body": "Full rebuild worked and now all log entries point to our pkg-config.",
    "created_at": "2014-05-17T20:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210266",
    "user": "https://github.com/vbraun"
}
```

Full rebuild worked and now all log entries point to our pkg-config.



---

archive/issue_comments_210267.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-17T20:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210267",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_210268.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2014-05-19T10:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210268",
    "user": "https://github.com/vbraun"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_210269.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-23T15:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210269",
    "user": "https://github.com/malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_210270.json:
```json
{
    "body": "Looks okay to me.",
    "created_at": "2014-05-23T15:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210270",
    "user": "https://github.com/malb"
}
```

Looks okay to me.



---

archive/issue_comments_210271.json:
```json
{
    "body": "Should ncurses install .pc files in `SAGE_LOCAL/lib/pkgconfig`? If that's a good idea, I can create a followup ticket to do that.",
    "created_at": "2014-05-23T17:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210271",
    "user": "https://github.com/jhpalmieri"
}
```

Should ncurses install .pc files in `SAGE_LOCAL/lib/pkgconfig`? If that's a good idea, I can create a followup ticket to do that.



---

archive/issue_comments_210272.json:
```json
{
    "body": "Yes, please do!",
    "created_at": "2014-05-23T17:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210272",
    "user": "https://github.com/vbraun"
}
```

Yes, please do!



---

archive/issue_comments_210273.json:
```json
{
    "body": "See #16392.",
    "created_at": "2014-05-23T23:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210273",
    "user": "https://github.com/jhpalmieri"
}
```

See #16392.



---

archive/issue_comments_210274.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-25T10:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16131",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16131#issuecomment-210274",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
