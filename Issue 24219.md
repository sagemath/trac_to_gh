# Issue 24219: class for the field of real number

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2018-01-01 16:17:45

CC:  rws tscrim egourgoulhon @mjungmath

We create a (mostly abstract) class to model the set of real numbers.


---

Comment by tscrim created at 2018-01-01 17:38:11

+1


---

Comment by vdelecroix created at 2018-01-01 17:40:59

:-) pushing in a minute...


---

Comment by vdelecroix created at 2018-01-01 18:34:18

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-01-01 18:34:18

New commits:


---

Comment by vdelecroix created at 2018-01-01 21:57:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-01-01 22:02:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-01-01 22:03:12

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-01-02 07:04:18

For me this looks fine (I can now create the object and use it in formal expressions) and patchbot is green. If you think this is not enough for a review then please set back to "needs review".


---

Comment by rws created at 2018-01-02 07:04:18

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2018-01-02 14:31:39

Changing status from positive_review to needs_review.


---

Comment by rws created at 2018-01-02 16:49:29

Thanks. I also had a question turning up while working on #24457. The code here does not support `RealField(prec)` anymore---the init method only has self argument, is this intended? Since `real_mpfr.RealField()` will be renamed should `create_RealField(prec)` be used everywhere instead?


---

Comment by vdelecroix created at 2018-01-02 16:59:28

Replying to [comment:12 rws]:
> Thanks. I also had a question turning up while working on #24457. The code here does not support `RealField(prec)` anymore---the init method only has self argument, is this intended? 

It is intended: _the field of real number is the field of real number_ (see e.g. [wikipedia](https://en.wikipedia.org/wiki/Real_number)). The code provided in the branch `u/vdelecroix/24456` is new, so it never used to support anything.

> Since `real_mpfr.RealField()` will be renamed should `create_RealField(prec)` be used everywhere instead?

No. `create_RealField` is a convenience to handle options for the completion functor. There is no reason to use it directly.

The `real_field.RealField` in this branch has (almost) nothing to do with `real_mpfr.RealField`.


---

Comment by tscrim created at 2018-01-03 00:20:06

Some comments:

- I think the completion of `ZZ` should be in a separate ticket for better granularity.
- Similarly for changing the output of `CompletionFunctor` to have `prec`.
- Should be "field of real numbers".
- Why the check for façade sets in those tests? Are tests failing otherwise? I don't think they should be necessary...
- It would be nice if `RealField` could be a common ABC for all classes that model *R*, but that is not possible because it inherits from `Singleton` (IMO, is a shortcoming of that class, but that is a different issue).


---

Comment by jdemeyer created at 2018-01-03 08:58:55

I don't quite understand the purpose of this new `RealField`. Maybe it would be good to elaborate on that.

Why is this thing a `Parent`? Given that it doesn't have Elements (in the Sage sense), it probably should be a `CategoryObject` and not a `Parent`.


---

Comment by jdemeyer created at 2018-01-03 08:59:06

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-01-03 11:36:23

Replying to [comment:15 jdemeyer]:
> I don't quite understand the purpose of this new `RealField`. Maybe it would be good to elaborate on that.

#24171 depends on this.


---

Comment by jdemeyer created at 2018-01-03 14:46:34

OK, I sort of see where this is going. But it doesn't explain why it is a `Parent`.


---

Comment by vdelecroix created at 2018-01-03 15:14:49

I am fine making it a `CategoryObject` with category `Fields().Infinite()`.


---

Comment by tscrim created at 2018-01-03 16:35:14

This is initialized as a facade parent, so it should not have an `Element` class.


---

Comment by jdemeyer created at 2018-01-03 16:53:25

Replying to [comment:21 tscrim]:
> This is initialized as a facade parent

Why? As I said above, I don't see why this should be a `Parent` in the first place.

Also, it would be good to replace the `coerce_map_from` method by a real [PEP 3119](https://www.python.org/dev/peps/pep-3119/) check like

```
sage: R = RealField()  # abstract real numbers
sage: issubclass(RR, R)
True
```

Is that in line with what you have in mind?


---

Comment by vdelecroix created at 2018-01-03 17:07:59

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 tscrim]:
> > This is initialized as a facade parent
> 
> Why? As I said above, I don't see why this should be a `Parent` in the first place.
> 
> Also, it would be good to replace the `coerce_map_from` method by a real [PEP 3119](https://www.python.org/dev/peps/pep-3119/) check like
> {{{
> sage: R = RealField()  # abstract real numbers
> sage: issubclass(RR, R)
> True
> }}}
> Is that in line with what you have in mind?

This is the kind of purposes I want this class for. `RealField()` should know about all ways of modelling concretely real numbers in Sage (but how?) and it should be possible to query it about real number questions, like the example you mentioned (but how?). The main problem I have is how to handle the distinction between exact subrings (e.g. QQ) versus approximations (e.g. RDF).

Note that in your example we might also want to make the following works

```
sage: import numbers
sage: isinstance(RR.element_class, numbers.Real)
```



---

Comment by jdemeyer created at 2018-01-04 10:40:36

Replying to [comment:23 vdelecroix]:
> This is the kind of purposes I want this class for.

Excellent! A big +1 from me.


---

Comment by jdemeyer created at 2018-01-04 10:44:14

Replying to [comment:23 vdelecroix]:
> {{{
> sage: import numbers
> sage: isinstance(RR.element_class, numbers.Real)
> }}}

This already works except for the fact that `RR` doesn't have an `element_class` attribute:

```
sage: import numbers
sage: isinstance(RR.an_element(), numbers.Real)
True
```


But I'd really like it to work on the _parent_ since it's the parent which models the real numbers. Also, the coercion framework mostly works with parents, so this could be useful there too.


---

Comment by egourgoulhon created at 2018-01-04 15:38:33

It would be nice if this could serve as the base field for real manifolds. 
For the moment we have:

```
sage: M = Manifold(3, 'M', field='real'); M
3-dimensional differentiable manifold M
sage: M.base_field()
Real Field with 53 bits of precision
sage: M.base_field() is RR
True
```

which is a bit awkward, since all subsequent calculus on `M` has nothing to do with `RR`. Actually `RR` is used as a proxy for the field of real numbers, so it would be very nice to replace it by something closer to the actual field of real numbers, as the new `RealField` proposed here (as far as I understand).


---

Comment by tmonteil created at 2018-01-05 01:03:25

Sorry for being mute, i did not have time to write something when i put this ticket back on needs-review, but i did not want it to be merged that way. Blitzkrieg is not the way, there have been too much projects within Sage dying because of a lack of consensus, and i do not want the idea of a "genuine" real field to end like this.

Of course i am in favor of having such an abstraction and i am happy that some people support this as well, however when i promoted such an idea in various sage days, tutorials, discussions, tickets, it was clear from that experience that there was no consensus about that question, at all.

Hence, i think that a collectively approved decision on such subject should happen before code. For example, the proposed branch implies behaviors such as (random undocumented examples):


```
sage: R = QQ.completion(infinity, infinity) ; R
Real Field

sage: QQbar(sqrt(2)).parent()
Algebraic Field
sage: R(QQbar(sqrt(2))).parent()
Algebraic Real Field

sage: QQbar(sqrt(1)).parent()
Algebraic Field
sage: R(QQbar(sqrt(1))).parent()
Rational Field

sage: 0.1 in R
False

sage: R(RDF(0.1))
1/10

sage: R(pi)
ValueError: Can't coerce `pi` in any parent `Real Field` is a facade for

sage: R(ZZ(1)).parent()
Rational Field
```


Which behavior do we want for this ? Which interplay with existing representations of real numbers ? What are the implications in the whole Sage ? How do we ensure a smooth transition from the current ill-named `RR` and a genuine `RR` corresponding to the field of real numbers ? Since real numbers are everywhere, we should think about the consequences before being tied with wrong design and the imperative of backward compatibility.

All this to say that we need to have a plan with a boarder view, on which the community agrees.

Note that Ralf opened a ticket on that subject, and since ticket #17713 already has some debates on this subject and a similar purpose, let me suggest to continue the discussion there (so that we collect every input in a single place), and make it a task with appropriate subtickets once we reach a consensus.


---

Comment by rws created at 2018-01-05 07:13:01

The depending ticket #24171 could work with `numbers.*` as well, as the objects are used only internally.


---

Comment by rws created at 2018-01-05 07:21:18

Replying to [comment:29 rws]:
> The depending ticket #24171 could work with `numbers.*` as well, as the objects are used only internally.

Ah no, the numbers classes are abstract, sorry.


---

Comment by vdelecroix created at 2018-01-05 10:24:13

Replying to [comment:28 tmonteil]:
> For example, the proposed branch implies behaviors such as (random undocumented examples):

The current `RealField` as it is in the branch is a [facade](http://doc.sagemath.org/html/en/reference/categories/sage/categories/sets_cat.html#facade-sets). Which means that it does not have any element of its own. The sets for which it is a facade are _concrete_ subrings/subfields of the set of real numbers. In the current branch it is only `QQ` and `AA`. Beyond adding more subrings/subfields, I don't see how it could be otherwise.

All the examples you mention come from the way `_element_constructor_` is designed for facade sets. For each set for which it is a facade the element constructor tries a conversion to this set. The behavior might be wrong, I am just explaining the mechanic.

> sage: QQbar(sqrt(2)).parent()
> Algebraic Field
> sage: R(QQbar(sqrt(2))).parent()
> Algebraic Real Field

This is because `AA(QQbar(sqrt(2)))` is the first to succeed (`QQ(QQbar(sqrt(2)))` does not).

> sage: QQbar(sqrt(1)).parent()
> Algebraic Field
> sage: R(QQbar(sqrt(1))).parent()
> Rational Field

This is because `QQ(QQbar(sqrt(1)))` does succeed.

> sage: 0.1 in R
> False

As it should be!

> sage: R(RDF(0.1))
> 1/10

Because `QQ(RDF(0.1))` works that way.

> sage: R(pi)
> ValueError: Can't coerce `pi` in any parent `Real Field` is a facade for

Because there is not yet any subset of the real numbers handling pi. As soon as there is one, it should be added to the facades and the above will work.

> sage: R(ZZ(1)).parent()
> Rational Field

This is because `QQ(ZZ(1))` is the first to succeed (we might add `ZZ` to the list of facades).

> Which behavior do we want for this?

For me, the current behavior of element construction is close to what it should be. To make things smoother, we might want to modify the `QQbar -> QQ` to a `QQbar -> AA`. This can be achieved by using a friend complex field on which we could call `.real()`. More precisely

```
def _element_constructor_(self, x):
    if parent(x) in self.facade_for():
        return x

    CC = ComplexField()   # the genuine one of course
    try:
        z = CC(x)
    except (ValueError,TypeError):
        pass
    else:
        if z.is_real():   # does not currently work for QQbar
            return z.real()

    raise ValueError("x not recognized as a real number")
```


> Which interplay with existing representations of real numbers?

This is precisely the question in [comment:23] that you are not helping with by asking it again.

> What are the implications in the whole Sage?

Just new features. To be able to do

- mathematical construction relying on an (abstract) field of real numbers (such as manifolds, see [comment:27])
- querries like "is parent X is a model for real numbers" (see [comment:22] and follow-up)

> How do we ensure a smooth transition from the current ill-named `RR` and a genuine `RR` corresponding to the field of real numbers?

This question is beyond the scope of this ticket. But see #24457.

> Since real numbers are everywhere, we should think about the consequences before being tied with wrong design and the imperative of backward compatibility.
>
> All this to say that we need to have a plan with a boarder view, on which the community agrees.
> 
> Note that Ralf opened a ticket on that subject, and since ticket #17713 already has some debates on this subject and a similar purpose, let me suggest to continue the discussion there (so that we collect every input in a single place), and make it a task with appropriate subtickets once we reach a consensus.

To balance, let me add that ticket #17713 was opened 3 years ago, contains three messages and no concrete proposal. It refers to another ticket #15944 that was untouched during 4 years. This ticket on the other hand, started with a concrete proposal and 4 people expressed their opinions. I am about to propose a new version taking into account all comments. We are also not likely to merge it soon as the discussion is going on.

Tickets are also dying because of absence of action. Status-quo is not the way to go either.


---

Comment by jdemeyer created at 2018-01-07 13:39:46

Replying to [comment:28 tmonteil]:
> {{{
> sage: R(QQbar(sqrt(2))).parent()
> Algebraic Real Field
> 
> sage: R(QQbar(sqrt(1))).parent()
> Rational Field
> 
> sage: R(RDF(0.1))
> 1/10
> 
> sage: R(pi)
> ValueError: Can't coerce `pi` in any parent `Real Field` is a facade for
> 
> sage: R(ZZ(1)).parent()
> Rational Field
> }}}

All of these could be fixed by simply not letting `R` be a `Parent` and disallowing `R(anything)`. As I said in some comments above, I don't see why `R` should be a `Parent` (facade or not).


---

Comment by jdemeyer created at 2018-01-07 13:42:01

Replying to [comment:31 vdelecroix]:
> > {{{
> > sage: 0.1 in R
> > False
> > }}}
> 
> As it should be!

If you think that `0.1` should not be contained in the field of real numbers, you'll need to justify that better. For me, it is obvious that `0.1` is a real number, such that `0.1 in R` must be `True`.


---

Comment by jdemeyer created at 2018-01-07 13:49:47

Replying to [comment:28 tmonteil]:
> Hence, i think that a collectively approved decision on such subject should happen before code.

+1

It is clear that people support the idea of having a true "real field" object in Sage. However, it is not clear at all what kind of object this should be and how it should be used.


---

Comment by jdemeyer created at 2018-01-07 14:01:02

Maybe we should start by thinking about possible use cases for this "real field":

1. As some placeholder object to denote the field of real numbers, for example as output of `QQ.completion(oo)`. This implies that it should be a unique object.

2. As a Sage analogy to [PEP 3141](https://www.python.org/dev/peps/pep-3141/): it should provide a way to ask "is `x` a real number" or "is `X` a substructure of the reals" or maybe "does parent `X` represent the real numbers". Note that Sage already has partial support for PEP 3141 but only for elements (not parents).


---

Comment by vdelecroix created at 2018-01-08 09:35:26

Replying to [comment:36 jdemeyer]:
> Maybe we should start by thinking about possible use cases for this "real field":
> 
> 1. As some placeholder object to denote the field of real numbers, for example as output of `QQ.completion(oo)`. This implies that it should be a unique object.

Agreed.

> 2. As a Sage analogy to [PEP 3141](https://www.python.org/dev/peps/pep-3141/): it should provide a way to ask "is `x` a real number" or "is `X` a substructure of the reals" or maybe "does parent `X` represent the real numbers". Note that Sage already has partial support for PEP 3141 but only for elements (not parents).

I want to be able distinguish between exact subrings and non-exact approximations. This is for coercion reasons: _each exact subring coerces into all non-exact approximations_. This is also why I claimed that `0.1 in R` should be `False`.

Let me add

3. As a way to check for `is x an exact real number?` and `is x a non-exact real number?`. We should specify clearly that `isinstance(x, numbers.Real)` means exact real *or* non-exact real (I take that as given because both `issubclass(int, numbers.Real)` and `issubclass(float, numbers.Real)` are `True`).

4. As a pointers to all real field implementations (exact subrings and non-exact approximations). In particular it should contain a class factory for all concrete real fields (e.g. the `create_RealField` function that is currently used for non-exact approximations).


---

Comment by tscrim created at 2018-01-08 16:20:56

If you want to ask about exact reals, you should have a 2', where you have a subclass of generic all reals class for the exact reals.


---

Comment by vdelecroix created at 2018-01-09 09:48:01

Concerning approximations (like floating point numbers), there are often the three special values `NaN`, `+inf` and `-inf` which are not real numbers (in the mathematical sense). For `-inf` and `+inf` one can still argue that they approximate very negative and very positive reals. But `NaN` is not an approximation of anything. This is one more argument for having `RealField()` to mean _exact real numbers_.

On the other hand, Python `numbers.Real` means both floating and exact. Having different semantic for `RealField()` and `numbers.Real` might be disturbing.


---

Comment by jdemeyer created at 2018-01-10 10:15:42

Replying to [comment:39 vdelecroix]:
> This is also why I claimed that `0.1 in R` should be `False`.

I still don't get this. Please elaborate...


---

Comment by jdemeyer created at 2018-01-10 10:22:01

Replying to [comment:39 vdelecroix]:
> 4. As a pointers to all real field implementations (exact subrings and non-exact approximations). In particular *it* should contain a class factory for all concrete real fields (e.g. the `create_RealField` function that is currently used for non-exact approximations).

What is the *it* in this last sentence?


---

Comment by vdelecroix created at 2018-01-10 10:27:57

Replying to [comment:42 jdemeyer]:
> Replying to [comment:39 vdelecroix]:
> > This is also why I claimed that `0.1 in R` should be `False`.
> 
> I still don't get this. Please elaborate...

For me `RealField` means the field of real numbers in the mathematical sense together with its exact operations `+`, `-`, `log`, `exp`, etc. Floating-point numbers do not respect exactness of operations and for me do not qualify as being real numbers. I agree that you can think of a floating point number in two ways. As an approximation of a real number "m ± 2<sup>-e</sup>" or as a diadic number "p 2<sup>-n</sup>". The latter is the actual datastructure but it is mostly useless to think of it this way when doing mathematics. This is moreover how it works in Sage: `QQ` coerces into `RealField(prec)` and not the contrary even though `RealField(prec)` is formally a subset of `QQ`.


---

Comment by vdelecroix created at 2018-01-10 10:28:41

Replying to [comment:44 jdemeyer]:
> Replying to [comment:39 vdelecroix]:
> > 4. As a pointers to all real field implementations (exact subrings and non-exact approximations). In particular *it* should contain a class factory for all concrete real fields (e.g. the `create_RealField` function that is currently used for non-exact approximations).
> 
> What is the *it* in this last sentence?

I meant the genuine real field that we are trying to design.


---

Comment by jdemeyer created at 2018-01-10 10:31:13

Replying to [comment:46 vdelecroix]:
> I meant the genuine real field that we are trying to design.

OK, so what would it mean for a Python object (representing the real field) to "contain a class factory"? Do you want something like

```
sage: R = RealField()
sage: R.create(prec=53, implementation="mpfr")
Real Floating-point field with 53 bits of precision
```

or maybe

```
sage: R = RealField()
sage: R(prec=53, implementation="mpfr")
Real Floating-point field with 53 bits of precision
```



---

Comment by jdemeyer created at 2018-01-10 10:39:26

Replying to [comment:45 vdelecroix]:
> For me `RealField` means the field of real numbers in the mathematical sense together with its exact operations `+`, `-`, `log`, `exp`, etc. Floating-point numbers do not respect exactness of operations and for me do not qualify as being real numbers.

That point of view is technically mathematically true but also completely useless. Clearly, the real floating-point field is meant to model the real numbers. For technical reasons, the operations are not exact. But that is an implementation detail and not a mathematical property. For practical purposes, it behaves as a field.

I do agree that it makes sense to differentiate between exact real fields and approximate real fields, but both are real fields.


---

Comment by vdelecroix created at 2018-01-10 10:45:29

Replying to [comment:48 jdemeyer]:
> Replying to [comment:45 vdelecroix]:
> > For me `RealField` means the field of real numbers in the mathematical sense together with its exact operations `+`, `-`, `log`, `exp`, etc. Floating-point numbers do not respect exactness of operations and for me do not qualify as being real numbers.
> 
> That point of view is technically mathematically true but also completely useless. Clearly, the real floating-point field is meant to model the real numbers.

Indeed!

> For technical reasons, the operations are not exact. But that is an implementation detail and not a mathematical property. For practical purposes, it behaves as a field.

It is not associative! Equality dramatically fails! This is not a *detail*.

> I do agree that it makes sense to differentiate between exact real fields and approximate real fields, but both are real fields.

I also agree and IMHO, for consistency with `numbers.Real`, the genuine `RealField` should be both used for approximate (= projection) and exact (= subset). And this should be very clearly stated.


---

Comment by rws created at 2018-02-23 16:59:38

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-02-23 16:59:38

Rebased on the dependency.
----
New commits:


---

Comment by dkrenn created at 2019-03-28 08:52:20

Does not apply anymore.


---

Comment by dkrenn created at 2019-03-28 08:52:20

Changing status from needs_review to needs_work.


---

Comment by @mjungmath created at 2020-10-08 12:09:28

I think, this is a splendid idea. What can be done to stress this forward? Can I help?


---

Comment by vdelecroix created at 2020-10-08 15:10:16

Replying to [comment:54 gh-mjungmath]:
> I think, this is a splendid idea. What can be done to stress this forward? Can I help?

Indeed, it was a terrible design from the start. The main obstruction to change it is backward compatibility... You can work on any of #24483, #24489 and #24457 that are prerequisite for this ticket.
