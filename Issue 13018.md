# Issue 13018: make sage use setuptools instead of distutils

Issue created by migration from Trac.

Original creator: ohanar

Original creation time: 2012-07-01 10:06:03

Assignee: GeorgSWeber

CC:  kini jdemeyer robertwb kcrisman mhansen jhpalmieri embray dimpase fbissey

Currently the sage library uses distutils. Switching to setuptools will give us the `setup.py develop` command, which bypasses the need to rebuild the sage library when modifying python files.


---

Comment by ohanar created at 2012-07-01 10:13:31

Changing status from new to needs_review.


---

Comment by mhansen created at 2012-07-01 10:44:06

I would imagine that you get problems similar to #12659 .   Have you tried this out?


---

Comment by ohanar created at 2012-07-01 19:29:23

Replying to [comment:3 mhansen]:
> I would imagine that you get problems similar to #12659 .   Have you tried this out?

Do you mean the sdist issues? No, I have not tried them yet, but I wouldn't doubt that there may be issues with them. Also, as noted in deps, there is an issue with parallel instances of setuptools, so either deps has to be hacked to force sage into the serial build, or we depend on #12994 (my vote is the later, since it is cleaner).


---

Comment by ohanar created at 2012-07-03 21:56:15

I've decided to make #12994 a dependency -- makes it much easier to add setuptool packages to the build system.


---

Comment by ohanar created at 2012-07-03 22:47:45

There are some issues with using relative paths with setuptools (which we want for relocation purposes). #13197 fixes these issues.


---

Comment by jdemeyer created at 2012-08-31 08:17:19

I am a bit lost on the inter-relations between the tickets #12994, #13190, #13201, #13197 (and perhaps #12659).  Could you please clarify the dependencies?

Also, I personally think it would be better to split this in two tickets:
 A. Use setuptools
 B. Use setup.py develop


---

Comment by ohanar created at 2012-09-04 20:43:50

Replying to [comment:9 jdemeyer]:
> I am a bit lost on the inter-relations between the tickets #12994, #13190, #13201, #13197 (and perhaps #12659).  Could you please clarify the dependencies?
> 
> Also, I personally think it would be better to split this in two tickets:
>  A. Use setuptools
This should only require #13031.
>  B. Use setup.py develop
This is more or less #12659 after switching to setuptools, and is where the other dependencies creep up (they aren't strictly necessary, but the alternative is to hack around setuptools, which is less preferable than patching it IMO).

I'll rework the patch to only do A once we have a 5.4 beta (mainly because #13031 more or less needs to be rebased with every development release).


---

Comment by ohanar created at 2012-09-05 22:34:10

apply to root repo


---

Attachment

apply to scripts repo


---

Comment by ohanar created at 2012-09-05 22:36:51

ok, rebased and only does the switch to setuptools (doesn't switch to `setup.py develop` anymore). Dependencies are now accurate.


---

Attachment

apply to sage library


---

Comment by roed created at 2013-09-06 16:09:56

Are we trying to make this happen before the git transition or afterward?


---

Comment by roed created at 2013-09-06 16:09:56

Changing status from needs_review to needs_info.


---

Comment by ohanar created at 2013-09-06 16:49:25

Certainly after, although I'm not currently convinced that we should proceed in this direction.


---

Comment by embray created at 2016-02-24 10:29:21

Any thoughts on this?  It hasn't been touched in quite some time despite there being (a likely outdated by now) patch. I can take this issue over and see it to completion if desired.


---

Comment by jdemeyer created at 2016-02-24 10:38:32

There is at least one problem: `setuptools` does not support `setup(data_files=...)`, see [setuptools #130](https://bitbucket.org/pypa/setuptools/issues/130/install_data-doesnt-respect-prefix). It's a good reason to avoid setuptools.

I'm not sure that we need `data_files` for the Sage library though. Maybe we could use `package_data` instead. But then that is something which should be investigated.


---

Comment by embray created at 2016-02-24 10:46:01

I don't know what files need to be installed with the `sage` package.  For the majority of Python-based projects `package_data` is preferred, but of course Sage is 'special'.

Let me look into what files are installed with the sage package, and I can worry about the details.


---

Comment by jdemeyer created at 2016-02-24 10:48:01

Hang on, I'm looking at it.


---

Comment by jdemeyer created at 2016-02-24 10:49:37

I created a new ticket for using `package_data`.


---

Comment by jdemeyer created at 2018-06-08 15:05:13

Replying to [comment:19 jdemeyer]:
> There is at least one problem: `setuptools` does not support `setup(data_files=...)`, see [setuptools #130](https://bitbucket.org/pypa/setuptools/issues/130/install_data-doesnt-respect-prefix). It's a good reason to avoid setuptools.

I recently learned about the (almost undocumented) setuptools options `--old-and-unmanageable`. It forces a non-egg build which is exactly what we want. So that would make this ticket possible again.


---

Comment by jdemeyer created at 2018-06-08 18:40:26

Also, it seems that Sage is no longer using either `data_files` or `package_data`. So that discussion has also disappeared.


---

Comment by embray created at 2018-06-27 14:38:31

I forget, what is the difference between `--old-and-unmanageable` and `--single-version-externally-managed`, where I thought the latter should be sufficient...

Also I do want to use `package_data` for Sage (see e.g. #21732) but I don't see what the problem is.


---

Comment by jdemeyer created at 2018-06-27 15:03:10

Replying to [comment:27 embray]:
> Also I do want to use `package_data` for Sage (see e.g. #21732) but I don't see what the problem is.

There is no problem with `package_data` if you want to use it in the way that it was intended to be used (which may not align with actual use cases).

There *is* a problem with `data_files`: setuptools still doesn't really support that. One of the reasons that this ticket stalled was because Sage was using `data_files` at the time to install Cython-related files. You suggested that it would be easy to use `package_data` instead (#20108). That didn't actually work, but now we are using custom code (neither `data_files` not `package_data`, see #21600) to install those files.


---

Comment by jdemeyer created at 2018-06-27 15:05:51

Replying to [comment:27 embray]:
> I forget, what is the difference between `--old-and-unmanageable` and `--single-version-externally-managed`

Mainly that the latter requires a `--record` argument also.


---

Comment by mkoeppe created at 2020-06-04 17:59:14

Time to revive this ancient ticket.


---

Comment by mkoeppe created at 2020-06-04 17:59:28

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2020-06-05 04:39:21

Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-28 19:17:59

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-28 19:17:59

This ticket is superseded by #29950 and can be closed.


---

Comment by dimpase created at 2020-06-29 14:39:26

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-08-15 10:23:09

Resolution: invalid
