# Issue 14824: Pari can't handle all polynomial resultants

Issue created by migration from https://trac.sagemath.org/ticket/15061

Original creator: robharron

Original creation time: 2013-08-19 01:04:32

Keywords: pari, resultant, sylvester matrix

Consider the following:



```
sage: R.<T> = PowerSeriesRing(QQ)                                                                                                                          
sage: F = R([1,1],2)                                                                                                                                       
sage: F                                                                                                                                                    
1 + T + O(T^2)                                                                                                                                             
sage: RP.<x> = PolynomialRing(R)                                                                                                                           
sage: P = x^2 - F                                                                                                                                                                                                                                                     
sage: P.resultant(P.derivative())
ValueError: series precision must be finite for conversion to pari object.
```

In particular, sage is incapable of computing the discriminant of this *quadratic* polynomial! I'll shortly post a patch that catches this error and uses the sylvester matrix instead.


---

Comment by robharron created at 2013-08-19 01:34:20

Changing status from new to needs_review.


---

Comment by robharron created at 2013-08-19 03:13:59

Changing status from needs_review to needs_work.


---

Comment by robharron created at 2013-08-19 03:13:59

There's something wrong with the patch because of some whitespace issues. I'll fix this soon.


---

Attachment


---

Comment by pbruin created at 2014-01-01 21:26:53

I noticed that this problem is also solved by #15601, which implements conversion to PARI for power series with infinite precision by converting them to polynomials.

There are probably other base rings that cannot be converted to PARI, so using `sylvester_matrix()` as a last resort is probably still useful.  It would be good to have another example that still fails after applying #15601.


---

Comment by pbruin created at 2014-01-01 21:26:53

Changing status from needs_work to needs_info.


---

Comment by gagern created at 2014-03-27 06:34:25

My changes from ticket:16014#comment:2 make `P.discriminant()` work.


---

Comment by gagern created at 2014-04-17 15:06:43

Replying to [comment:4 pbruin]:
> It would be good to have another example that still fails after applying #15601.


```
sage: R.<x> = AA[]
sage: (2*x^2 + 3*x + 5).discriminant()
TypeError: no conversion of this ring to a Singular ring defined
```


Does this help, even though it's singular here and not pari? `RIF` does the same. I haven't worked out yet which resultants get computed by pari and which by singular.


---

Comment by pbruin created at 2014-04-21 09:43:57

Replying to [comment:7 gagern]:
> Replying to [comment:4 pbruin]:
> > It would be good to have another example that still fails after applying #15601.
> 
> {{{
> sage: R.<x> = AA[]
> sage: (2*x^2 + 3*x + 5).discriminant()
> TypeError: no conversion of this ring to a Singular ring defined
> }}}
> 
> Does this help, even though it's singular here and not pari? `RIF` does the same. I haven't worked out yet which resultants get computed by pari and which by singular.
This example still fails with the patch applied.  There seems to be a different problem here, namely that the class of that polynomial inherits from `Polynomial_singular_repr`, even though the base field does not have a conversion to Singular.  The same error occurs when you replace `PowerSeriesRing` by `LaurentSeriesRing` in the original example.


---

Comment by gagern created at 2014-05-02 01:23:04

Replying to [comment:8 pbruin]:
> There seems to be a different problem here, namely that the class of that polynomial inherits from `Polynomial_singular_repr`, even though the base field does not have a conversion to Singular.

`polynomial_element_generic.Polynomial_generic_field` inherits from `polynomial_singular_interface.Polynomial_singular_repr`. That inheritance was introduced in [35bb3ea](http://git.sagemath.org/sage.git/commit/?id=35bb3ea22b07ee4477ce70906a4aa7439cdf7bd6) from 2007. Unfortunately I can't see what kind of bug this was supposed to fix. It seems like a bad move to me, though, since that class clearly assumes that you can convert to singular without further checks.


---

Comment by pbruin created at 2014-05-02 17:12:42

Replying to [comment:9 gagern]:
> Replying to [comment:8 pbruin]:
> > There seems to be a different problem here, namely that the class of that polynomial inherits from `Polynomial_singular_repr`, even though the base field does not have a conversion to Singular.
> 
> `polynomial_element_generic.Polynomial_generic_field` inherits from `polynomial_singular_interface.Polynomial_singular_repr`. That inheritance was introduced in [35bb3ea](http://git.sagemath.org/sage.git/commit/?id=35bb3ea22b07ee4477ce70906a4aa7439cdf7bd6) from 2007.
That commit only changed the order of the superclasses; the inheritance was there before.
> Unfortunately I can't see what kind of bug this was supposed to fix. It seems like a bad move to me, though, since that class clearly assumes that you can convert to singular without further checks.
I agree that it is strange for polynomials over arbitrary fields to inherit from that class.  An alternative would be to "manually" prescribe this inheritance for polynomials over fields that support conversion to Singular, but that doesn't sound very attractive.  Another alternative would be to move `resultant()` to a more generic polynomial class that first tries to use Singular and uses a generic Python implementation in case that fails.


---

Comment by gagern created at 2014-05-02 23:14:37

Replying to [comment:10 pbruin]:
> That commit only changed the order of the superclasses; the inheritance was there before.

Thanks, I missed that fact.

> I agree that it is strange for polynomials over arbitrary fields to inherit from that class.  An alternative would be to "manually" prescribe this inheritance for polynomials over fields that support conversion to Singular, but that doesn't sound very attractive.

I see how [the constructor of PolynomialRing_field](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/polynomial_ring.py?id=6.2.rc1#n1467) checks for singular support and sets the `_has_singular` property accordingly. We could use that place to change `element_class` in a suitable way. But if we wanted to handle this using different classes, we'd add one more point to the already dense network of generic vs. special, domain vs. field, sparse vs. dense. Not sure I like that either.

> Another alternative would be to move `resultant()` to a more generic polynomial class that first tries to use Singular and uses a generic Python implementation in case that fails.

Sounds good. As a first step, we could change [Polynomial_singular_repr](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/polynomial_singular_interface.py?id=6.2.rc1#n372) to check `self.parent()._has_singular` and call `super` if that isn't set. We could then make sure that [Polynomial.resultant](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/polynomial_element.pyx?id=6.2.rc1#n4798) falls back to `sylvester_matrix` if PARI doesn't work. Although I don't know yet for which rings PARI *will* work. Messy business…


---

Comment by pbruin created at 2014-05-03 12:10:47

I think I have found a solution that will solve most of these problems.  In this branch:
- Rob Harron's patch, with minor modifications.
- Remove `lcm()` and `resultant()` from `Polynomial_singular_repr`.  For `lcm()`, delete the code and move the doctests to the existing `MPolynomial_libsingular.lcm()`; for `resultant()`, move the code and doctests to the new `MPolynomial_polydict.resultant()`.
- In `MPolynomial_polydict.resultant()`, fall back on Sylvester matrices if the ring has no Singular implementation.
- Various cosmetic fixes.


---

Comment by pbruin created at 2014-05-03 12:10:47

Changing status from needs_info to needs_review.


---

Comment by git created at 2014-05-03 12:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gagern created at 2014-05-03 12:51:35

Judging from the timestamps, your system clock is wrong. Apart from that, I like the code, from what I can tell at first glance. Thanks! Will pull and run tests soon.


---

Comment by pbruin created at 2014-05-03 12:58:09

Replying to [comment:14 gagern]:
> Judging from the timestamps, your system clock is wrong.
I know, but it is a system that I am not the administrator of.
> Apart from that, I like the code, from what I can tell at first glance. Thanks! Will pull and run tests soon.
OK, thanks!


---

Comment by gagern created at 2014-05-03 15:12:35

> Will pull and run tests soon.

All tests in `src/sage/rings` passed here. And the code still looks sane at second glance. Am I qualified to give this a positive review?


---

Comment by pbruin created at 2014-05-03 15:43:42

Replying to [comment:16 gagern]:
> All tests in `src/sage/rings` passed here. And the code still looks sane at second glance. Am I qualified to give this a positive review?
You can probably judge yourself if you have done the things suggested in ["Reviewing Patches"](http://www.sagemath.org/doc/developer/trac.html#reviewing-patches) in the developer guide.  (Note in particular that you are supposed to run all doctests; things can really break in unexpected places.)


---

Comment by gagern created at 2014-05-04 01:42:40

Replying to [comment:17 pbruin]:
> You can probably judge yourself if you have done the things suggested in ["Reviewing Patches"](http://www.sagemath.org/doc/developer/trac.html#reviewing-patches) in the developer guide.

* `./sage -t --all --long`: done, no new errors
* `make` including documentation: done
* `./sage -docbuild reference pdf`: done
* `./sage -coverage src/sage/rings/polynomial/*.py{,x}`: Diff shows that this now has 6 things less to complain about, and no new ones

I wonder whether the docs for `resultant` regarding “Implemented using PARI’s polresultant function.” should get adjusted. On the other hand, I doubt that detailing the possible choices of algorithm is worth the effort.

> (Note in particular that you are supposed to run all doctests; things can really break in unexpected places.)

Did so, and found #16285 in the process. But that's reproducible without your change, so not your fault.

Shouldn't running the testsuite be handled by patchbot? Or hasn't that been migrated to the git workflow yet?


---

Comment by gagern created at 2014-05-04 01:42:40

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-05-05 09:23:46

Replying to [comment:18 gagern]:
> Shouldn't running the testsuite be handled by patchbot? Or hasn't that been migrated to the git workflow yet?
It has, but not enough people are running patchbots, and I think there are also some glitches that sometimes prevent it from doing its job.


---

Comment by vbraun created at 2014-05-06 23:03:10

Resolution: fixed
