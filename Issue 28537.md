# Issue 28537: Embed QuadraticField into algebraic numbers by default

Issue created by migration from https://trac.sagemath.org/ticket/28774

Original creator: @kliem

Original creation time: 2019-11-20 08:33:11

Keywords: quadratic field, embeddings, coercion

Currently, quadratic fields are embedded into the reals or complex numbers by default.

Number fields in turn, allow pushouts only, when fields are embedded into `AA`. Therefore, the following results in a `TypeError`:


```
sage: f1 = QuadraticField(2)
sage: f2 = QuadraticField(3)
sage: f1.gen() + f2.gen()
```


We embed the `QuadraticField` into `AA` or `QQbar` by default and therefore fix this for the real algebraic case.

Possible follow ups:
- It still does not work in the non-real case, but this should be taken care of in `NumberField` instead.
- Also, one could argue, whether the coercion should really go all the way to `AA`, but this is also not an issue of `QuadraticField`.


---

Comment by @kliem created at 2019-11-20 08:40:09

New commits:


---

Comment by @kliem created at 2019-11-20 08:40:59

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-11-23 14:32:11

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-11-23 14:32:11

Many failing tests and various places.


---

Comment by git created at 2019-11-25 08:13:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-11-25 09:05:01

Changing type from enhancement to defect.


---

Comment by @kliem created at 2019-11-25 09:05:01

Changing status from needs_work to needs_info.


---

Comment by vbraun created at 2019-11-29 00:01:15

This seems like it would be a good idea to post to sage-devel if only just to understand the rationale of the current state.


---

Comment by @kliem created at 2019-12-05 14:30:56

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-12-06 13:43:23

Perhaps a more useful error message could be given here?  The hint about using composite fields seems especially helpful.


---

Comment by @kliem created at 2019-12-06 13:45:35

Yes, I was thinking about this as well. Wasn't sure where to put this.

I could give such a message in the `_pushout_` method of number fields. This method will be called for sure and I think its also the last hope for coercion to work in case of number fields.


---

Comment by @kliem created at 2019-12-06 14:24:58

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-12-06 20:35:56

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-12-06 20:35:56

This is the best I can come up with.

To my understanding coercion of two number fields is only possible, if they are both embedded into `AA` (or `QQbar` with #28778) or if there is an embedding (discovered by `_internal_coerce_map_from`).

Raising an error or a warning does not work, as it is being suppressed.

This depends on #28778 now, as this fixes an error (along the way), where the pushout of two number fields embedded into `RLF` is `AA`. This ticket relies on the method `_pushout_` to return `None` in this case.
----
New commits:


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by slabbe created at 2020-08-15 14:46:40

Patchbot says:

```
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/schemes/elliptic_curves/gal_reps_number_field.py  # 4 doctests failed
sage -t --long --random-seed=0 src/sage/categories/pushout.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/libs/flint/nmod_poly_linkage.pxi  # Timed out (and interrupt failed)
----------------------------------------------------------------------
```

in particular:

```
sage -t --long --random-seed=0 src/sage/categories/pushout.py
**********************************************************************
File "src/sage/categories/pushout.py", line 3164, in sage.categories.pushout.AlgebraicExtensionFunctor.merge
Failed example:
    c1+c2; parent(c1+c2)    #indirect doctest
Expected:
    -b^6 + b^4 - 1
    Number Field in b with defining polynomial x^8 - x^4 + 1 with b = -0.2588190451025208? + 0.9659258262890683?*I
Got:
    common parent not found; the method ``composite_fields`` might be useful to find a common parent for number fields
    common parent not found; the method ``composite_fields`` might be useful to find a common parent for number fields
    -b^6 + b^4 - 1
    Number Field in b with defining polynomial x^8 - x^4 + 1 with b = -0.2588190451025208? + 0.9659258262890683?*I
**********************************************************************
1 item had failures:
   1 of  24 in sage.categories.pushout.AlgebraicExtensionFunctor.merge
    [876 tests, 1 failure, 12.84 s]
```

and

```
sage -t --long --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3303, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.?
Failed example:
    rho.reducible_primes()
Expected:
    [2, 3]
Got:
    common parent not found; the method ``composite_fields`` might be useful to find a common parent for number fields
    common parent not found; the method ``composite_fields`` might be useful to find a common parent for number fields
    [2, 3]
**********************************************************************
1 item had failures:
   1 of  84 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.?
    [814 tests, 1 failure, 176.43 s]
```

and the patchbot also says pyflakes warnings:

```
========== pyflakes ==========
git checkout patchbot/ticket_merged
Already on 'patchbot/ticket_merged'
src/sage/rings/number_field/number_field.py:9708:42 '...' % ... has 1 placeholder(s) but 2 substitution(s)

found 1 pyflakes errors in the modified files
Traceback (most recent call last):
  File "/home/sagemath/.local/lib/python3.7/site-packages/sage_patchbot/patchbot.py", line 1109, in test_a_ticket
    baseline=baseline, **kwds)
  File "/home/sagemath/.local/lib/python3.7/site-packages/sage_patchbot/plugins.py", line 281, in pyflakes
    raise ValueError(full_msg)
ValueError: found 1 pyflakes errors in the modified files
pyflakes -- 0 seconds
========== end pyflakes ==========
```

and `pycodestyle` warnings:

```
========== pycodestyle ==========
git checkout patchbot/ticket_merged
Already on 'patchbot/ticket_merged'
src/sage/rings/number_field/number_field.py:5038:34: E702 multiple statements on one line (semicolon)
src/sage/rings/number_field/number_field.py:5061:25: E702 multiple statements on one line (semicolon)
src/sage/rings/number_field/number_field.py:5062:25: E702 multiple statements on one line (semicolon)
found 3 invalid escape sequences in the modified files
Traceback (most recent call last):
  File "/home/sagemath/.local/lib/python3.7/site-packages/sage_patchbot/patchbot.py", line 1109, in test_a_ticket
    baseline=baseline, **kwds)
  File "/home/sagemath/.local/lib/python3.7/site-packages/sage_patchbot/plugins.py", line 344, in pycodestyle
    raise ValueError(full_msg)
ValueError: found 3 invalid escape sequences in the modified files
pycodestyle -- 0 seconds
========== end pycodestyle ==========
```



---

Comment by slabbe created at 2020-08-15 14:46:40

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-08-16 05:36:23

I posted about this on sage-devel https://groups.google.com/d/msg/sage-devel/oSFceE75pWU/K-akRxS6BAAJ.

At the moment it looks like there isn't much interest. I'll wait a day and if nothing shows up, we can just close this here as invalid.


---

Comment by @kliem created at 2020-08-17 05:24:19

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-08-18 12:36:26

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2020-08-18 12:36:26

ok


---

Comment by slelievre created at 2020-10-11 16:49:10

Resolution: invalid
