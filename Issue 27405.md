# Issue 27405: Re-run configure+make after installing an SPKG with sage -i

Issue created by migration from https://trac.sagemath.org/ticket/27642

Original creator: embray

Original creation time: 2019-04-11 10:49:22

CC:  dimpase

This is an idea for fixing #27373.

As explained in [comment:73:ticket:27373 comment#73] on that ticket, after installing a new package it is really necessary to re-run `configure` after installing a new package, whether it was an optional package that was not previously installed, or a standard package that was not previously installed (due to a configure-time check determining that it was not needed).

This is to ensure that files generated by `configure` reflect the new system configuration, in terms of what SPKGs are installed.

Further, it is advisable to re-run `make all-build` in case the `sage -i` installed packages whose dependents need to be rebuilt.

This also needs to ensure that if an SPKG is installed for some standard package, that we account for that when re-running `configure`: It must not try again to check the system for that dependency, and just reflect that the SPKG is installed.  For example, from #27373, if Sage is first built using GMP/MPIR from the system, then we run `sage -i mpir`, the system configuration must be updated to reflect that we are now using the mpir SPKG instead of GMP/MPIR from the system.  It's also necessary to rebuilt any of its dependent packages.


---

Comment by embray created at 2019-04-11 10:56:08

This branch mostly fixes the bug in #27373 for me.

As noted in the commit message this does not yet preserve arguments previously passed to `configure`.  I think we can fix that by running `./config.status --config` but I need to test that a bit more.
----
Last 10 new commits:


---

Comment by dimpase created at 2019-04-24 13:38:15

could you rebase it?


---

Comment by dimpase created at 2019-05-03 14:46:34

New commits:


---

Comment by dimpase created at 2019-05-03 14:50:03

Trying this with `./configure` leaves gmp not marked as an not to be installed, while mpir is marked as not to be installed. (to be fixed on #27641).


---

Comment by dimpase created at 2019-05-03 14:50:03

Changing status from new to needs_review.


---

Comment by git created at 2019-05-03 17:13:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-05-03 17:14:28

rebased over updated  #27641


---

Comment by dimpase created at 2019-05-03 17:20:06

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-05-03 17:20:06

now this branch leaves gmp not marked as an not to be installed, while mpir is marked as not to be installed, despite being fixed on #27641...


---

Comment by embray created at 2019-05-06 16:58:15

Your rebasing did not apparently include the fixes I made to #27641 (compare gmp/spkg-configure.m4)


---

Comment by dimpase created at 2019-05-06 17:16:36

`gmp/spkg-configure.m4` was not touched on #27641, have a look at `git show 1c24df1`.
`


---

Comment by dimpase created at 2019-05-06 17:20:35

More precisely, you overwrote this change in #27641#comment:15


---

Comment by embray created at 2019-05-07 16:12:28

Right. That was intentional.  It should _not_ be changed.


---

Comment by dimpase created at 2019-05-07 16:32:25

Replying to [comment:11 embray]:
> Right. That was intentional.  It should _not_ be changed.

Should I re-create the un-rebased branch and try again, or it's simply removing the changes to `gmp/spkg-configure.m4` that would do?


---

Comment by git created at 2019-05-08 10:07:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-05-08 10:08:31

Changing status from needs_work to positive_review.


---

Comment by embray created at 2019-05-10 11:00:37

This is a bit of a mess.  I just need to rebase on top of the final version of #27641, not add spurious new commits.


---

Comment by embray created at 2019-05-10 11:00:37

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-05-10 11:05:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-05-10 11:06:29

Updated to the final version of #27641.  Still need to kick around a bit with making sure it can preserve previous configure flags.


---

Comment by vbraun created at 2019-05-12 21:31:11

Too late, a previous version of this branch was released in 8.8.beta5


---

Comment by vbraun created at 2019-05-12 21:31:11

Resolution: fixed


---

Comment by dimpase created at 2019-05-12 21:49:50

I am afraid it has to be reverted. It's not good as it is now.


---

Comment by dimpase created at 2019-05-13 09:28:21

See #27820


---

Comment by embray created at 2019-05-13 09:53:16

I'm confused.  How was it merged?  It was not set to positive review, and you never replaced the branch with the merge commit as in your usual process?


---

Comment by dimpase created at 2019-05-13 10:01:30

Replying to [comment:21 embray]:
> I'm confused.  How was it merged?  It was not set to positive review,

it was, see comment:14 

I gather it wasn't merged in the usual way as it didn't come with a (formally) needed configure bump


---

Comment by dimpase created at 2019-06-11 10:46:26

I can confirm that this branch is merged in 8.8.rc0.
So this is done and dusted.
