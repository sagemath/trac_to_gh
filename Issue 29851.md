# Issue 29851: Fix "make sdist", add test run to GitHub Actions

Issue created by migration from https://trac.sagemath.org/ticket/30088

Original creator: mkoeppe

Original creation time: 2020-07-08 02:25:48

CC:  vbraun jhpalmieri mjo

`make sdist` is currently broken.

https://github.com/mkoeppe/sage/runs/848070855

```
Finished cloning Sage sources
make[1]: Entering directory '/home/runner/work/sage/sage/build/make'
env SAGE_INSTALL_FETCH_ONLY=yes make -B SAGERUNTIME= \
	alabaster appnope arb babel bleach boost_cropped brial bzip2 cddlib c....
...
cd '/home/runner/work/sage/sage/build/pkgs/sage_conf' && . '/home/runner/work/sage/sage/src/bin/sage-env' && . '/home/runner/work/sage/sage/build/bin/sage-build-env-config' && sage-logger -p '/home/runner/work/sage/sage/build/pkgs/sage_conf/spkg-install' '/home/runner/work/sage/sage/logs/pkgs/sage_conf-none.log'
[sage_conf-none] Installing 
[sage_conf-none] Error: Tried to use Sage's Python which was not yet installed.
[sage_conf-none] If this was called from an spkg-install script for another 
[sage_conf-none] package you should add $(PYTHON) as a dependency in 
[sage_conf-none] build/pkgs/<pkg>/dependencies
[sage_conf-none] Error: could not determine package name
[sage_conf-none] ********************************************************************************
[sage_conf-none] Error installing
[sage_conf-none] *
```


On this ticket we fix it and add a test run to GH Actions so that it does not get broken again.


---

Comment by mkoeppe created at 2020-07-13 01:48:43

Changing priority from major to critical.


---

Comment by mjo created at 2020-07-13 02:26:19

Could you leave a comment in there explaining what's going on? It just took me about 20 minutes to figure out that this was failing on sage_conf because it's a standard package (which are usually incuded in SAGE_SDIST_PACKAGES) but not one whose sources need to be downloaded before being included with the source tarball (which is what the misnomer SAGE_SDIST_PACKAGES actually contains a list of). All script/pip packages should be similar, according to this change.

Also, per the description, I think we need a tox thingy.


---

Comment by mkoeppe created at 2020-07-13 04:02:17

I'm working on it currently


---

Comment by mkoeppe created at 2020-07-13 04:05:09

`sage_conf` currently is the only package that is `type=standard`, `source=script`.
All other `source=script` packages are `type=optional`.


---

Comment by git created at 2020-07-13 04:52:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-13 05:17:47

Tests running at https://github.com/mkoeppe/sage/runs/864159160


---

Comment by mkoeppe created at 2020-07-13 15:00:37

Changing status from new to needs_review.


---

Comment by mjo created at 2020-07-13 21:42:37

OK with an added comment? Otherwise, LGTM.
----
New commits:


---

Comment by mkoeppe created at 2020-07-13 22:46:47

Thank you!

I'm still waiting for the test run to finish


---

Comment by jhpalmieri created at 2020-07-13 23:17:50

Re "the only standard script package is sage_conf": sagelib is also a script package, isn't it? Or is that changing? (It is listed in `build/bin/Makefile` under `SCRIPT_PACKAGES`.)


---

Comment by mkoeppe created at 2020-07-13 23:54:07

You are right, I forgot that the ticket that made sagelib a script package was already merged.


---

Comment by mkoeppe created at 2020-07-14 00:01:36

The successful test run of the new `dist` workflow job can be seen at https://github.com/mkoeppe/sage/runs/864159160

It is possible that I may need to make some adjustments to the new `local-macos-nohomebrew-nobootstrap` tests, but I'll do that in #29929 as a follow up.

OK to set it to positive review?
----
New commits:


---

Comment by mjo created at 2020-07-14 00:52:15

Ok, you fixed the comment already. Yeah it's good now. John, please add yourself as a reviewer if you want some credit/blame here.


---

Comment by mjo created at 2020-07-14 00:52:15

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-07-14 01:21:30

I will confirm that, not only does `mske dist` work, but I turned off the internet on my computer and built Sage successfully from that tarball.


---

Comment by mkoeppe created at 2020-07-14 01:38:25

Thanks a lot!


---

Comment by vbraun created at 2020-07-19 07:24:36

Resolution: fixed
