# Issue 23898: Clean up in coerce_dict

archive/issues_023898.json:
```json
{
    "body": "CC:  simonking @nbruin @tscrim @fchapoton\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24135\n\n",
    "created_at": "2017-10-31T14:21:39Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Clean up in coerce_dict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23898",
    "user": "https://github.com/jdemeyer"
}
```
CC:  simonking @nbruin @tscrim @fchapoton



Issue created by migration from https://trac.sagemath.org/ticket/24135





---

archive/issue_comments_334619.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-10-31T22:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334619",
    "user": "https://github.com/tscrim"
}
```

New commits:



---

archive/issue_comments_334620.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-01T17:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334620",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334621.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-01T17:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334621",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334622.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-01T17:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334623.json:
```json
{
    "body": "cc chapoton because this is also relevant for Python 3.",
    "created_at": "2017-11-01T17:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334623",
    "user": "https://github.com/jdemeyer"
}
```

cc chapoton because this is also relevant for Python 3.



---

archive/issue_comments_334624.json:
```json
{
    "body": "Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.\n\nMaybe I am too traditional, but why remove the explicit return values?\n\n```diff\ndiff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx\nindex bbd1ca7..cc2d04f 100644\n--- a/src/sage/structure/coerce_dict.pyx\n+++ b/src/sage/structure/coerce_dict.pyx\n@@ -821,16 +869,15 @@ cdef class MonoDict:\n #on cyclic GC)\n \n cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):\n-    if op.table == NULL:\n+    if op.table is NULL:\n         return 0\n     Py_VISIT3(<PyObject*>op.eraser, visit, arg)\n     cdef size_t i\n     for i in range(op.mask + 1):\n         cursor = &op.table[i]\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             Py_VISIT3(cursor.key_weakref, visit, arg)\n             Py_VISIT3(cursor.value, visit, arg)\n-    return 0\n@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):\n     del tmp\n     for i in range(mask+1):\n         cursor = &(table[i])\n-        if cursor.key_id != NULL and cursor.key_id != dummy:\n+        if valid(cursor.key_id):\n             cursor.key_id = dummy\n             Py_XDECREF(cursor.key_weakref)\n             Py_XDECREF(cursor.value)\n-    PyMem_Free(table)\n-    return 0\n+    sig_free(table)\n+\n \n (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)\n (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)\n \n+\n cdef class TripleDictEraser:\n     \"\"\"\n     Erases items from a :class:`TripleDict` when a weak reference becomes\n```\n\n\nI am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\nTrivial and I know you essentially simply moved it, but only 2 spaces instead of 4:\n\n```\n    sage: K.<t> = GF(2^55)\n    sage: for i in range(50):\n    ....:   a = K.random_element()\n    ....:   E = EllipticCurve(j=a)\n    ....:   P = E.random_point()\n    ....:   Q = 2*P\n```\n\nAlso with its new placement, it does not need an `#indirect doctest`.",
    "created_at": "2017-11-01T22:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334624",
    "user": "https://github.com/tscrim"
}
```

Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.

Maybe I am too traditional, but why remove the explicit return values?

```diff
diff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx
index bbd1ca7..cc2d04f 100644
--- a/src/sage/structure/coerce_dict.pyx
+++ b/src/sage/structure/coerce_dict.pyx
@@ -821,16 +869,15 @@ cdef class MonoDict:
 #on cyclic GC)
 
 cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):
-    if op.table == NULL:
+    if op.table is NULL:
         return 0
     Py_VISIT3(<PyObject*>op.eraser, visit, arg)
     cdef size_t i
     for i in range(op.mask + 1):
         cursor = &op.table[i]
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             Py_VISIT3(cursor.key_weakref, visit, arg)
             Py_VISIT3(cursor.value, visit, arg)
-    return 0
@@ -859,16 +906,17 @@ cdef int MonoDict_clear(MonoDict op):
     del tmp
     for i in range(mask+1):
         cursor = &(table[i])
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             cursor.key_id = dummy
             Py_XDECREF(cursor.key_weakref)
             Py_XDECREF(cursor.value)
-    PyMem_Free(table)
-    return 0
+    sig_free(table)
+
 
 (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)
 (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)
 
+
 cdef class TripleDictEraser:
     """
     Erases items from a :class:`TripleDict` when a weak reference becomes
```


I am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Trivial and I know you essentially simply moved it, but only 2 spaces instead of 4:

```
    sage: K.<t> = GF(2^55)
    sage: for i in range(50):
    ....:   a = K.random_element()
    ....:   E = EllipticCurve(j=a)
    ....:   P = E.random_point()
    ....:   Q = 2*P
```

Also with its new placement, it does not need an `#indirect doctest`.



---

archive/issue_comments_334625.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> Maybe I am too traditional, but why remove the explicit return values?\n\nConceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.",
    "created_at": "2017-11-02T11:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334625",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 tscrim]:
> Maybe I am too traditional, but why remove the explicit return values?

Conceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.



---

archive/issue_comments_334626.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-02T15:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334626",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334627.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> Can you also justify 8 a little too?\n\nThe new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the ``@`cython.freelist()` should make it extremely fast too.",
    "created_at": "2017-11-02T15:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334627",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 tscrim]:
> Can you also justify 8 a little too?

The new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the ``@`cython.freelist()` should make it extremely fast too.



---

archive/issue_comments_334628.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> I am assuming 5 is for better consistency with Python3.\n\nObviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.\n\n> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).\n\nDone.",
    "created_at": "2017-11-02T15:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334628",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 tscrim]:
> I am assuming 5 is for better consistency with Python3.

Obviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.

> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Done.



---

archive/issue_comments_334629.json:
```json
{
    "body": "I ended up doing a lot more cleanup in this version. Please review.",
    "created_at": "2017-11-02T15:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334629",
    "user": "https://github.com/jdemeyer"
}
```

I ended up doing a lot more cleanup in this version. Please review.



---

archive/issue_comments_334630.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-02T18:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334630",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334631.json:
```json
{
    "body": "Thank you for the explanations. All of the changes make sense to me.\n\nHowever, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.",
    "created_at": "2017-11-02T22:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334631",
    "user": "https://github.com/tscrim"
}
```

Thank you for the explanations. All of the changes make sense to me.

However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.



---

archive/issue_comments_334632.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-02T22:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334632",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_334633.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-02T22:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334633",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_334634.json:
```json
{
    "body": "Replying to [comment:21 tscrim]:\n> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n\nI know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\nBy the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\nIf there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.",
    "created_at": "2017-11-02T22:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334634",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 tscrim]:
> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.

I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.



---

archive/issue_comments_334635.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Replying to [comment:21 tscrim]:\n> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.\n> \n> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.\n\nAh, I see. I couldn't quite tell if the patchbot reports were current or not.\n\n> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.\n\nIt's good to get things done.\n\n> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.\n\nI think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.",
    "created_at": "2017-11-02T22:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334635",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 tscrim]:
> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.
> 
> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

It's good to get things done.

> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.

I think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.



---

archive/issue_comments_334636.json:
```json
{
    "body": "Replying to [comment:23 tscrim]:\n> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n\nI believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.",
    "created_at": "2017-11-02T22:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334636",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 tscrim]:
> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.



---

archive/issue_comments_334637.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> Replying to [comment:23 tscrim]:\n> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.\n> \n> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of \"pending\", meaning that no patchbot has tested this latest version.\n\nI've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.",
    "created_at": "2017-11-02T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334637",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 tscrim]:
> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.
> 
> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.

I've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.



---

archive/issue_comments_334638.json:
```json
{
    "body": "Greenbot.",
    "created_at": "2017-11-03T03:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334638",
    "user": "https://github.com/tscrim"
}
```

Greenbot.



---

archive/issue_comments_334639.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-03T03:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334639",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334640.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-11-03T10:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_334641.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-11-03T10:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334641",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_334642.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-03T10:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334642",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334643.json:
```json
{
    "body": "Added some harmless comments.",
    "created_at": "2017-11-03T10:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334643",
    "user": "https://github.com/jdemeyer"
}
```

Added some harmless comments.



---

archive/issue_comments_334644.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23898#issuecomment-334644",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_022365.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23898",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23898#event-22365"
}
```
