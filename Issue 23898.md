# Issue 23898: Clean up in coerce_dict

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-10-31 14:21:39

CC:  simonking nbruin tscrim chapoton




---

Comment by tscrim created at 2017-10-31 22:07:56

New commits:


---

Comment by git created at 2017-11-01 17:00:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-01 17:02:16

Changing status from new to needs_review.


---

Comment by git created at 2017-11-01 17:24:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-01 17:52:21

cc chapoton because this is also relevant for Python 3.


---

Comment by tscrim created at 2017-11-01 22:30:53

Can you also justify 8 a little too? I was only able to get a loose understanding from a quick search.

Maybe I am too traditional, but why remove the explicit return values?

```diff
diff --git a/src/sage/structure/coerce_dict.pyx b/src/sage/structure/coerce_dict.pyx
index bbd1ca7..cc2d04f 100644
--- a/src/sage/structure/coerce_dict.pyx
+++ b/src/sage/structure/coerce_dict.pyx
`@``@` -821,16 +869,15 `@``@` cdef class MonoDict:
 #on cyclic GC)
 
 cdef int MonoDict_traverse(MonoDict op, visitproc visit, void *arg):
-    if op.table == NULL:
+    if op.table is NULL:
         return 0
     Py_VISIT3(<PyObject*>op.eraser, visit, arg)
     cdef size_t i
     for i in range(op.mask + 1):
         cursor = &op.table[i]
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             Py_VISIT3(cursor.key_weakref, visit, arg)
             Py_VISIT3(cursor.value, visit, arg)
-    return 0
`@``@` -859,16 +906,17 `@``@` cdef int MonoDict_clear(MonoDict op):
     del tmp
     for i in range(mask+1):
         cursor = &(table[i])
-        if cursor.key_id != NULL and cursor.key_id != dummy:
+        if valid(cursor.key_id):
             cursor.key_id = dummy
             Py_XDECREF(cursor.key_weakref)
             Py_XDECREF(cursor.value)
-    PyMem_Free(table)
-    return 0
+    sig_free(table)
+
 
 (<PyTypeObject*>MonoDict).tp_traverse = <traverseproc>(&MonoDict_traverse)
 (<PyTypeObject*>MonoDict).tp_clear = <inquiry>(&MonoDict_clear)
 
+
 cdef class TripleDictEraser:
     """
     Erases items from a :class:`TripleDict` when a weak reference becomes
```


I am assuming 5 is for better consistency with Python3. Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Trivial and I know you essentially simply moved it, but only 2 spaces instead of 4:

```
    sage: K.<t> = GF(2^55)
    sage: for i in range(50):
    ....:   a = K.random_element()
    ....:   E = EllipticCurve(j=a)
    ....:   P = E.random_point()
    ....:   Q = 2*P
```

Also with its new placement, it does not need an `#indirect doctest`.


---

Comment by jdemeyer created at 2017-11-02 11:15:01

Replying to [comment:11 tscrim]:
> Maybe I am too traditional, but why remove the explicit return values?

Conceptually, these functions do not return anything. It is really analogous to a plain Python function which always returns `None`. The `int` return value exists only for a technical reason, namely exception handling.


---

Comment by git created at 2017-11-02 15:09:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-02 15:11:57

Replying to [comment:11 tscrim]:
> Can you also justify 8 a little too?

The new class `ObjectWrapper` is a simple replacement for a `PyCapsule`. It's simpler because it doesn't need a name, a context or a destructor. It literally just stores a pointer and nothing else. This simplicity and the ``@`cython.freelist()` should make it extremely fast too.


---

Comment by jdemeyer created at 2017-11-02 15:12:44

Replying to [comment:11 tscrim]:
> I am assuming 5 is for better consistency with Python3.

Obviously. If we are implementing a kind of dict, we should use `items()` instead of `iteritems()`.

> Although I think that `items()` should have a least a little one-line description saying that it is an iterator (and not a list/view).

Done.


---

Comment by jdemeyer created at 2017-11-02 15:13:36

I ended up doing a lot more cleanup in this version. Please review.


---

Comment by git created at 2017-11-02 18:24:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-11-02 22:01:53

Thank you for the explanations. All of the changes make sense to me.

However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.


---

Comment by tscrim created at 2017-11-02 22:01:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-02 22:12:08

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-02 22:12:08

Replying to [comment:21 tscrim]:
> However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.

I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.


---

Comment by tscrim created at 2017-11-02 22:22:04

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 tscrim]:
> > However, multiple patchbots are reporting multiple random seg faults. So something seems to be subtly breaking.
> 
> I know, that was because I made a mistake in `__dealloc__`. I fixed that now, so we need to wait for new patchbot reports.

Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

> By the way, I realize that I'm making quite a lot of changes in this ticket. What started as a plan to fix the `iteritems()` calls ended up rewriting most of the `coerce_dict.pyx` file. However, most changes are pretty simple and do not change the functionality at all.

It's good to get things done.

> If there are certain changes that you cannot accept (either because you disagree or you don't understand), I can try to revert those.

I think I understand all of the changes and agree with them (or at least do not have any reason to disagree). So if the latest patchbots come back clean, then it will be a positive review.


---

Comment by jdemeyer created at 2017-11-02 22:59:54

Replying to [comment:23 tscrim]:
> Ah, I see. I couldn't quite tell if the patchbot reports were current or not.

I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.


---

Comment by tscrim created at 2017-11-02 23:21:41

Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 tscrim]:
> > Ah, I see. I couldn't quite tell if the patchbot reports were current or not.
> 
> I believe that the patchbot icon which is displayed on the Trac page (i.e. this page) only considers the up-to-date reports. As I'm writing this comment, I see a status of "pending", meaning that no patchbot has tested this latest version.

I've seen it as pending before when one of them is still working but another has finished and came back green. Although that might have been on a much older version of the patchbot.


---

Comment by tscrim created at 2017-11-03 03:40:08

Greenbot.


---

Comment by tscrim created at 2017-11-03 03:40:08

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-11-03 10:11:57

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-11-03 10:11:57

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2017-11-03 10:12:14

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-11-03 10:12:14

Added some harmless comments.


---

Comment by vbraun created at 2017-12-11 01:03:17

Resolution: fixed
