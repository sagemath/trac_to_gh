# Issue 23864: Implement Katz centrality and related methods for graphs

Issue created by migration from https://trac.sagemath.org/ticket/24101

Original creator: clienkaemper

Original creation time: 2017-10-24 23:11:27

Keywords: sd90

want to be able to compute Katz centrality, use Katz method for link prediction in graphs/networks (https://en.wikipedia.org/wiki/Katz_centrality)




---

Comment by git created at 2017-10-25 23:15:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by clienkaemper created at 2017-10-25 23:17:35

Changing status from new to needs_review.


---

Comment by dcoudert created at 2017-10-26 07:05:05

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2017-10-26 07:05:05

Welcome to Sagemath

I have some comments to help you improving the code.

- unify `nonedges_only` and `nonedgesonly`. Actually, #24094 uses `nonedgesonly`. I don't know which is best, but should be the same.
- `Returns the Katz matrix of G with parameter alpha.` -> `Return the Katz matrix of the graph with parameter alpha.`
- only 1 empty line is needed after `INPUT::`
- ``True`` -> ```True```
- `if true, eliminates common neighbors between adjacent vertices`. Could you add that the value for each edge is set to 0 ?
- `the Katz matrix of the graph self with parameter alpha` -> `the Katz matrix of the graph  with parameter alpha`
- `G1 = Graph({1:[2,3], 2:[1,4], 3:[1,4], 4:[2,3]})` -> `G1 = graphs.CycleGraph(4)` ?
- since you don't have `G2`, you could rename `G1` to `G`
- add a space between `*` and the text in `*:meth:`~katz_centrality`` and the line after
- add an empty line after `TESTS::`
- The examples you give in the `TESTS` could be in the examples section. In a TESTS block, we expect examples raising errors, with the empty graph, etc.
- the test `alpha <= 0` should be made before any other computation
- `if nonedges_only == True:` -> `if nonedges_only:`

in method `def katz_centrality(self, alpha):`
- you could add an optional parameter `u` to return the centrality of a specified vertex. For that, add `u=None` and then the return statement becomes something like `if u is None: return K else: return K[u]`
- you must indent the text in 80 columns mode. Some code editors are really helpful to do that without effort
- You return a list. Wouldn't it be better to return a dictionary keyed by vertices ? How to know which value corresponds to a node ?


---

Comment by @rajat1433 created at 2019-03-08 14:24:07

Set assignee to @rajat1433.


---

Comment by @rajat1433 created at 2019-03-08 14:24:07

I would like to work on it.
Should I work on existing branch or should I create a new one based on latest sage develop version?


---

Comment by dcoudert created at 2019-03-08 16:15:21

You can either rebase this ticket on last develop branch (and fix the merge conflicts), or create a new branch based on last beta.


---

Comment by git created at 2019-03-09 04:04:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-09 04:06:29

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2019-03-09 08:52:34

Several issues (I'm skipping the coding style issues for the moment, but please have a look at http://doc.sagemath.org/html/en/developer/coding_basics.html and check how other methods are written).

In method `katz_matrix`:
- add some explanation of what is a Katz matrix
- please add parameter `vertices` similarly to method `.adjacency_matrix()`. This is important as in the future we will no longer ensure that the list of vertices is sorted (due to Python 3).

In method `katz_centrality`
- add some explanation of what is the Katz centrality, plus a link to relevant wikipedia page
- in the code, choose an order like `verts = list(self)`, and pass it to `katz_matrix`. Here we don't need the list of vertices to be sorted, we just want to know the ordering, so we fix it.
- `u not in self.vertices()` -> `u not in self`
- You can simplify the construction of the dictionary

```diff
-        for i in range(n):
-            Kdict[vert[i]] = katz_values[0][i]
+        Kdict = {u: katz_values[0][i] for i, u in enumerate(verts)}
```

- Do we really need to build dictionary `Kdict` when `u` is not None ?

Do not forget to check that all tests pass and that the documentation builds properly and displays nicely.


---

Comment by git created at 2019-03-09 11:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-09 11:55:31

Thanks for the prompt reply and suggesting the changes.
Done all the improvements mentioned above and also made sure to pass all the tests.
I have done the changes as per required by the documentation in generic_graph.py file. But could not figure out how to view those changes as they will actually be looking in documentation. And is 
there any test command for checking if format is correct for documentation.


---

Comment by git created at 2019-03-09 12:50:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-09 17:20:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-03-09 18:04:42

> I have done the changes as per required by the documentation in generic_graph.py file. But could not figure out how to view those changes as they will actually be looking in documentation. And is 
> there any test command for checking if format is correct for documentation.

See http://doc.sagemath.org/html/en/developer/sage_manuals.html

You can rebuild the full documentation using

```
sage -b && sage --docbuild reference html
```

or rebuild only the documentation of the graph module

```
sage -b && sage --docbuild reference/graphs html
```


Then, you can look at the documentation with your web browser.

```
file://PATH_ON_YOUR_COMPUTER/sage/local/share/doc/sage/html/en/reference/graphs/index.html
```


For the coding style, please try to comply to https://www.python.org/dev/peps/pep-0008


---

Comment by git created at 2019-03-10 19:22:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-10 19:25:41

I have made changes so as to build the documentation properly and also passed all the tests and tried to follow the coding convention. Can you please review the code so that we can finalize it.


---

Comment by dcoudert created at 2019-03-11 08:44:50

- You must ensure that all comments are formatted in 80 columns mode. Some code editors can be configured to ease this task

- minor stylistic issue

```diff
-        - ``nonedgesonly`` -- Boolean (default: ``True``); if True, value for each
-          edge present in the graph is set to zero.
+        - ``nonedgesonly`` -- boolean (default: ``True``); if ``True``, value for each
+          edge present in the graph is set to zero
```


- you can use `for u in self` or `set(self)` or `if u in self`, etc.

```diff
-              set(vertices) != set(self.vertex_iterator())):
+              set(vertices) != set(self)):
```


- pep8

```diff
-        K =  (In - alpha * A.transpose()).inverse()-In
+        K =  (In - alpha * A.transpose()).inverse() - In
```

 
 {{{#!diff
-            Missing = onesmat - A- In
+            Missing = onesmat - A - In
}}}

- Please revise method `katz_centrality`: alignment, ensure that the code is correct, remove useless instructions, etc.


---

Comment by git created at 2019-03-11 09:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-11 09:52:30

Thanks for the review. Its been really a learning experience. I have started following alignment and pep8 seriously and I have fixed the issues above.


---

Comment by dcoudert created at 2019-03-11 15:39:50

Please check carefully your code, that comments are in 80 columns mode, if possible that you follow the PEP8 coding style, that the comments are sufficient and helpful to the user, and that your code is best possible.

for instance, you have apparently not double check this part:

```diff
-        if u :
-            idx = verts.index(u)
-            return katz_values[0][idx]
-
-        Kdict = {}
-        Kdict = {u: katz_values[0][i] for i, u in enumerate(verts)}
-
-        if u is None:
-            return Kdict
-        else :
-            return Kdict[u]
+        if u:
+            return katz_values[0][verts.index(u)]
+        return {u: katz_values[0][i] for i, u in enumerate(verts)}
```



---

Comment by dcoudert created at 2019-03-11 15:39:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-11 16:35:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-11 16:40:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-11 16:59:43

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2019-03-12 08:13:48

- except in the names of the method, use `Katz` and not `katz` everywhere.
- remove trailing white spaces
- you should rephrase the description of method `katz_matrix` to first give the definition of this centrality measure, and then explain what's the returned matrix.
- Avoid having too many empty lines like this. 1 is often enough

```
+
+
+
```

- remove the `.` at the end of error messages
- `if alpha <=  0:` -> `if alpha <= 0:`
- 

```diff
-        We compute katz_centrality for the undirected 4-cycle again (note that 
+        We compute the Katz centrality of a 4-cycle (note that 
```

- 

```diff
-        Return the katz centrality of the vertex u of the graph.
+        Return the Katz centrality of vertex `u`.
```

- there is a `Î±`. It should be ok, but it might be safer to use `\alpha`.


---

Comment by git created at 2019-03-12 09:09:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-12 09:11:50

Thanks for the review , I have fixed the coding style bugs.


---

Comment by dcoudert created at 2019-03-12 10:31:56

- to use latex in the documentation, you must write ``\alpha``, and not only `\alpha`. Using `r"""` and then ``...`` indicates to use latex.

- in `katz_centrality`, when you ask for the centrality of a vertex `u`, you first compute `katz_values = (M*matrix(QQ, n, 1, lambda i, j: 1)).transpose()`. However, if I understand well the definition of the Katz matrix, it suffices to make the some of the values of a particular row (or column), right ? If so, you could avoid the matrix multiplication when asking for a single value.

- also, a `.` and a ` ` to remove

```diff
-          reciprocal of the spectral radius of the graph. (the maximum
-          absolute eigenvalue of the adjacency matrix )
+          reciprocal of the spectral radius of the graph (the maximum
+          absolute eigenvalue of the adjacency matrix)
```



---

Comment by git created at 2019-03-12 10:57:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-12 11:01:14

I have used sum function now and eliminated the multiplication step. I guess it give better complexity now in terms of space and time specially for a single vertex case.


---

Comment by dcoudert created at 2019-03-12 12:13:52

This is much better now. We certainly same some computation time (but see point below). For the space complexity, it remains in `O(n^2)` as we compute the Katz matrix in all cases.

- The test `if u and u not in self:` must be done before computing `verts = list(self)` and more importantly the computation of the Katz matrix.

I have now more algorithmic questions (more interesting than coding style :P):

- What is the expected answer when the graph is not connected ? May be we can save computation time if the answer is always 0 for vertices in different components ?

- Same question for strongly connected digraphs? In the example, vertices 1, 2, 3, 7, 9 have no in-neighbors and vertex 4 has no out-neighbor. When you will get an answer, you should document the example explaining why some values are 0.


---

Comment by @rajat1433 created at 2019-03-12 12:55:27

''What is the expected answer when the graph is not connected ? May be we can save computation time if the answer is always 0 for vertices in different components ? 
''

- When graph is not connected answer for a particular vertex is only dependent on the vertices in its connected component only and not in the other component. So yes we really can do optimize here. Will work on that.


_Same question for strongly connected digraphs? In the example, vertices 1, 2, 3, 7, 9 have no in-neighbors and vertex 4 has no out-neighbor. When you will get an answer, you should document the example explaining why some values are 0._ 


- for strongly connected Digraph the answer will be non zero for every node. Also for any node with in-neighbors 0 the answer will be 0 as its the very essence of katz centrality to measure influence of an actor(node here) in a social network.
Will document the example with reasoning.


---

Comment by git created at 2019-03-12 13:31:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-12 13:50:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-03-13 10:40:31

* You can get the connected component containing vertex u directly using `C = G.connected_component_containing_vertex(u, sort=False)`.

  Then you must compute the Katz matrix of the subgraph, i.e., `self.subgraph(C)`.


```
if u:
    if self.is_connected():
        G = self
    else:
        G = self.subgraph(self.connected_component_containing_vertex(u, sort=False))
        verts = list(G)
    M = G.katz_matrix(alpha, nonedgesonly=False, vertices=verts)
    return sum(M[verts.index(u)])
```


* When you compute the Katz centrality of all vertices, you want the union of the Katz centralities of each subgraph. You can use `self.connected_components_subgraphs()`


---

Comment by git created at 2019-03-13 12:10:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-13 12:11:38

I have optimized the code as per the review.


---

Comment by dcoudert created at 2019-03-13 12:30:46

Please double check your code and test it ! it contains obvious errors.

You can write directly `for g in self.connected_components_subgraphs()`

Add a doctest with a non connected graph, e.g., `graphs.PathGraph(3) + graphs.PathGraph(4)`.


---

Comment by git created at 2019-03-13 14:11:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-13 14:12:37

I am really sorry about the previous errors. Now its fixed and well tested.


---

Comment by dcoudert created at 2019-03-13 14:29:02

Could you change the example to `sage: (graphs.PathGraph(3) + graphs.PathGraph(4)).katz_centrality(1/20)`. This is to show that the values for the vertices in the P3 and in the P4 are the same than in previous examples.


---

Comment by git created at 2019-03-13 15:12:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-03-13 15:13:06

_Could you change the example to sage: (graphs.PathGraph(3) + graphs.PathGraph(4)).katz_centrality(1/20). This is to show that the values for the vertices in the P3 and in the P4 are the same than in previous examples._ 

Done!


---

Comment by dcoudert created at 2019-03-13 17:03:41

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2019-03-13 17:03:41

Further speed up improvements can certainly be obtained, but I don't know how.

For me this patch is good to go.


---

Comment by vbraun created at 2019-03-14 18:13:53

Resolution: fixed
