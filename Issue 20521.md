# Issue 20521: Simplicial complexes: keep the __enlarged cache in add_face

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2016-06-02 10:07:02

CC:  tscrim

The `add_face` method currently deletes the ``__enlarged`` cache, but this is unnecessary.


---

Comment by jhpalmieri created at 2016-06-02 11:43:56

The `_faces` cache was also not treated properly, in both `add_face` and `remove_face`. For `add_face`, for example, you can see this if instead of the change here, you just delete the line `self.__enlarged = {`}: a doctest will fail because of an incorrect homology calculation, because of the wrong cached value for `_faces`.
----
New commits:


---

Comment by jhpalmieri created at 2016-06-02 11:43:56

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2016-06-02 12:11:54

Changing keywords from "" to "days74".


---

Comment by tscrim created at 2016-06-02 12:53:24

If you're okay with my changes, then you can set a positive review.
----
New commits:


---

Comment by jhpalmieri created at 2016-06-02 13:16:49

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2016-06-02 13:16:49

Looks good.


---

Comment by vbraun created at 2016-06-03 21:54:25


```
sage -t --long src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2606, in sage.homology.simplicial_complex.SimplicialComplex.remove_face
Failed example:
    T.remove_face((1,2,3))
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.remove_face[12]>", line 1, in <module>
        T.remove_face((Integer(1),Integer(2),Integer(3)))
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 2659, in remove_face
        if L is None or Simplex(face) not in L:
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 1204, in __contains__
        return x in self.faces()[dim]
    KeyError: 2
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2607, in sage.homology.simplicial_complex.SimplicialComplex.remove_face
Failed example:
    len(T._faces)
Expected:
    2
Got:
    1
**********************************************************************
1 item had failures:
   2 of  17 in sage.homology.simplicial_complex.SimplicialComplex.remove_face
    [581 tests, 2 failures, 10.66 s]
sage -t --long src/sage/interfaces/interface.py
```



---

Comment by jhpalmieri created at 2016-06-04 02:33:16

This is fallout from #20718: in that ticket, we changed from using `self.n_faces(dim)` to using `self.faces()[dim]`, but the former allows values of `dim` greater than the dimension of the complex: it just returns the empty set in that case. So we can continue with the philosophy in #20718, that we want to avoid `n_faces`, or we can restore its use in some cases. The fix is easy either way, we just need to decide what to do. For example, in keeping with the philosophy there:

```diff
diff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py
index fefc90e..1a6cca7 100644
--- a/src/sage/homology/simplicial_complex.py
+++ b/src/sage/homology/simplicial_complex.py
`@``@` -1199,7 +1199,7 `@``@` class SimplicialComplex(Parent, GenericCellComplex):
         if not isinstance(x, Simplex):
             return False
         dim = x.dimension()
-        return x in self.faces()[dim]
+        return dim in self.faces() and x in self.faces()[dim]
 
     def __call__(self, simplex):
         """
`@``@` -1527,9 +1527,11 `@``@` class SimplicialComplex(Parent, GenericCellComplex):
             ...
             ValueError: this simplex is not in this simplicial complex
         """
-        if not simplex in self.faces()[simplex.dimension()]:
+        d = simplex.dimension()
+        if d in self.faces() and simplex in self.faces()[d]:
+            return simplex.face(i)
+        else:
             raise ValueError('this simplex is not in this simplicial complex')
-        return simplex.face(i)
 
     def flip_graph(self):
         """
`@``@` -3220,7 +3222,11 `@``@` class SimplicialComplex(Parent, GenericCellComplex):
             sage: X.set_immutable()
             sage: X.n_skeleton(2)
             Simplicial complex with vertex set (0, 1, 2, 3) and facets {(0, 2, 3), (1, 2, 3), (0, 1)}
+            sage: X.n_skeleton(4)
+            Simplicial complex with vertex set (0, 1, 2, 3) and facets {(0, 2, 3), (1, 2, 3), (0, 1)}
         """
+        if n >= self.dimension():
+            return self
         # make sure it's a list (it will be a tuple if immutable)
         facets = [f for f in self._facets if f.dimension() < n]
         facets.extend(self.faces()[n])
```



---

Comment by jhpalmieri created at 2016-06-04 02:33:16

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2016-06-04 06:42:44

I would say let us use `self.faces()[dim]` to continue to avoid using `n_faces` (the more we scrub it from the code, it is less likely that anyone will use it in the future [in the code]).


---

Comment by jhpalmieri created at 2016-06-04 14:16:45

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2016-06-04 14:16:45

New commits:


---

Comment by vbraun created at 2016-06-04 18:59:56

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2016-06-04 18:59:56


```
sage -t --long src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2606, in sage.homology.simplicial_complex.SimplicialComplex.remove_face
Failed example:
    T.remove_face((1,2,3))
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.remove_face[12]>", line 1, in <module>
        T.remove_face((Integer(1),Integer(2),Integer(3)))
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 2659, in remove_face
        if L is None or Simplex(face) not in L:
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 1204, in __contains__
        return x in self.faces()[dim]
    KeyError: 2
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2607, in sage.homology.simplicial_complex.SimplicialComplex.remove_face
Failed example:
    len(T._faces)
Expected:
    2
Got:
    1
**********************************************************************
1 item had failures:
   2 of  17 in sage.homology.simplicial_complex.SimplicialComplex.remove_face
    [581 tests, 2 failures, 6.66 s]
```



---

Comment by jhpalmieri created at 2016-06-04 20:07:57

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2016-06-04 20:07:57

I don't understand this error. With my branch, there is no line in the entire Sage source tree matching `return x in self.faces()[dim]`. The most recent changes one line (and I think the relevant line, from the `__contains__` method) to

```
return dim in self.faces() and x in self.faces()[dim]
```

so this error should not happen.

All tests pass for me. I started over, checking out the branch all over again, and all tests still pass.


---

Comment by vbraun created at 2016-06-04 20:30:57

Well you wrote that in #20718 ;-)

just wait for the next beta and merge it in, easy.


---

Comment by jhpalmieri created at 2016-06-04 20:43:02

Replying to [comment:12 vbraun]:
> Well you wrote that in #20718 ;-)

Right, and then changed it in the most recent commit on this ticket ([c7bdbcf](http://git.sagemath.org/sage.git/commit/?id=c7bdbcf797859670d9bcb0ce29c7692ea0832f2d)).


---

Comment by vbraun created at 2016-06-04 20:59:47

Which is why you shouldn't switch positively reviewed tickets back and forth...


---

Comment by jhpalmieri created at 2016-06-04 21:40:08

I'm really confused now. You posted a doctest failure here, so I thought it was basically required to undo the positive review. Should I have left it as a positive review?


---

Comment by vbraun created at 2016-06-05 01:05:23

If its fixed then set it back to positive review. 

If you want to avoid the confusion then don't go back after positive review. If it doesn't work then I'll tell you. Now you merged in #20718 but there is no guarantee that that ticket will even be in the next beta. Its likely but it might still get unmerged.


---

Comment by vbraun created at 2016-06-05 01:16:22

Just to be clear: I tested the branch from back when it was "positive review".


---

Comment by jhpalmieri created at 2016-06-05 13:02:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-08 12:29:51

Resolution: fixed
