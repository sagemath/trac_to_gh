# Issue 31039: Tensor Product Method for FiniteRankFreeModule

Issue created by migration from https://trac.sagemath.org/ticket/31276

Original creator: @mjungmath

Original creation time: 2021-01-21 20:47:46

CC:  tscrim egourgoulhon jhpalmieri mkoeppe chapoton

We introduce the methods `tensor_product` and `tensor_power` as per #30373.

Furthermore, we introduce a method `tensor_product`for elements.


---

Comment by @mjungmath created at 2021-01-21 21:08:59

Turns out that this is not as easy as expected.

1. `FiniteRankFreeModule` has no attribute (or method) `tensor_type` in contrast to `TensorFreeModule`. If it had, one could just add the tensor types and return the corresponding module. However, I see no point why `FiniteRankFreeModule` should have such a method/attribute apart from this single purpose.
2. Trying to wrap the patch over, it turns out that `TensorFreeModule` inherits from `FiniteRankFreeModule` and therefore inherits all methods and attributes. So far so good, but as I understand the code, instances of `TensorFreeModule` are not intended to use most of these methods. `FiniteRankFreeModule` is intended to be the "control center" that takes care of things. This leads to somewhat strange (and probably unwanted) behavior:
  {{{
  sage: M = FiniteRankFreeModule(QQ, 3)
  sage: T11 = M.tensor_module(1, 1)
  sage: T11 is M.tensor_module(1, 1)
  True
  sage: T11 is T11.tensor_module(1, 1)
  False
  }}}

  and
  {{{
  sage: M = FiniteRankFreeModule(ZZ, 2)
  sage: e = M.basis('e')
  sage: f = M.basis('f', from_family=(e[0]-e[1], -2*e[0]+3*e[1]))
  sage: M.change_of_basis(e, f)
  Automorphism of the Rank-2 free module over the Integer Ring
  sage: T11 = M.tensor_module(1, 1)
  sage: T11.change_of_basis(e, f)
  Traceback (most recent call last):
  ...
  TypeError: Basis (e_0,e_1) on the Rank-2 free module over the Integer Ring is not a basis of the Free module of type-(1,1) tensors on the Rank-2 free module over the Integer Ring
  }}}
  
  The latter might be acceptable because `e` and `f` are, strictly speaking, no bases of `T11`. However, this methods has then no use in `TensorFreeModule`. Nevertheless, these are just two examples and there is a lot more. Furthermore, `TensorFreeModule` initializes a bunch of dictionaries, sets and further attributes that are not used anywhere else. I think this should be changed.


---

Comment by egourgoulhon created at 2021-01-21 23:09:57

Replying to [comment:1 gh-mjungmath]:
> 
> 2. Trying to wrap the patch over, it turns out that `TensorFreeModule` inherits from `FiniteRankFreeModule` and therefore inherits all methods and attributes. So far so good, but as I understand the code, instances of `TensorFreeModule` are not intended to use most of these methods.

Indeed, so maybe a better inheritance structure should be devised.

> `FiniteRankFreeModule` is intended to be the "control center" that takes care of things. 

Yes. This avoids information redundancy, in particular regarding the bases.

>This leads to somewhat strange (and probably unwanted) behavior:
>   {{{
>   sage: M = FiniteRankFreeModule(QQ, 3)
>   sage: T11 = M.tensor_module(1, 1)
>   sage: T11 is M.tensor_module(1, 1)
>   True
>   sage: T11 is T11.tensor_module(1, 1)
>   False
>   }}}

Why do you call this strange behavior? Both answers, `True` and `False`, are mathematically correct.

>   and
>   {{{
>   sage: M = FiniteRankFreeModule(ZZ, 2)
>   sage: e = M.basis('e')
>   sage: f = M.basis('f', from_family=(e[0]-e[1], -2*e[0]+3*e[1]))
>   sage: M.change_of_basis(e, f)
>   Automorphism of the Rank-2 free module over the Integer Ring
>   sage: T11 = M.tensor_module(1, 1)
>   sage: T11.change_of_basis(e, f)
>   Traceback (most recent call last):
>   ...
>   TypeError: Basis (e_0,e_1) on the Rank-2 free module over the Integer Ring is not a basis of the Free module of type-(1,1) tensors on the Rank-2 free module over the Integer Ring
>   }}}
>   
>   The latter might be acceptable because `e` and `f` are, strictly speaking, no bases of `T11`. 

Yes, the `TypeError` sounds correct here.

>However, this methods has then no use in `TensorFreeModule`. Nevertheless, these are just two examples and there is a lot more. Furthermore, `TensorFreeModule` initializes a bunch of dictionaries, sets and further attributes that are not used anywhere else.

You mean those attributes inherited from `FiniteRankFreeModule`?


---

Comment by @mjungmath created at 2021-01-21 23:29:09

Replying to [comment:2 egourgoulhon]:
> Why do you call this strange behavior? Both answers, `True` and `False`, are mathematically correct.

Of course, right, it's the tensor module of the tensor module. But we also have:


```
sage: T22 = T11.tensor_module(1, 1)
sage: T22 is M.tensor_module(1, 1)
False
```


But one could argue here that these objects are different mathematical entities which are just isomorphic. On the other hand, they behave exactly the same as instances of `TensorFreeModule`.


> 
> You mean those attributes inherited from `FiniteRankFreeModule`?
> 

Indeed. At least those that are not needed in `TensorFreeModule`.


---

Comment by egourgoulhon created at 2021-01-22 10:18:47

Replying to [comment:3 gh-mjungmath]:
> Replying to [comment:2 egourgoulhon]:
> > Why do you call this strange behavior? Both answers, `True` and `False`, are mathematically correct.
> 
> Of course, right, it's the tensor module of the tensor module. But we also have:
> 
> {{{
> sage: T22 = T11.tensor_module(1, 1)
> sage: T22 is M.tensor_module(1, 1)
> False
> }}}
> 
I guess you mean 

```
sage: T22 = T11.tensor_module(1, 1)
sage: T22 is M.tensor_module(2, 2)
False
```

What would be the purpose to implement such an identification? Do you have a use case in mind?


---

Comment by @mjungmath created at 2021-01-22 11:37:56

Replying to [comment:4 egourgoulhon]:
> I guess you mean 
> {{{
> sage: T22 = T11.tensor_module(1, 1)
> sage: T22 is M.tensor_module(2, 2)
> False
> }}}

Yes, indeed...it was late yesterday..

> What would be the purpose to implement such an identification? Do you have a use case in mind?

Alright, it should be fine. I totally missed the tensor module inception going on here. Then, it would be nice to have at least the canonical isomorphism from `T11.tensor_module(1, 1)` to `M.tensor_module(2, 2)` implemented, in particular make the following work:


```
sage: t = T11.tensor((1,1))
sage: M.tensor_module(2,2)(t)
Traceback (most recent call last):
...
StopIteration:
```


and the other way around.

Nevertheless, what do we do about my first point in comment:1? An `instanceof` check for each object coming in?


---

Comment by egourgoulhon created at 2021-01-22 17:04:27

Replying to [comment:5 gh-mjungmath]:
> Replying to [comment:4 egourgoulhon]:
> 
> Nevertheless, what do we do about my first point in comment:1? An `instanceof` check for each object coming in? 

I see no reason why `FiniteRankFreeModule` should not have a `tensor_type()` method (returning `(1, 0)`), as `TensorFreeModule`.


---

Comment by @mjungmath created at 2021-01-22 17:28:44

Alright, then let's do this. This method would also be beneficial to introduce the above coercion.


---

Comment by mkoeppe created at 2021-01-22 19:22:31

Relevant previous discussions: #30241, #30229#comment:6


---

Comment by egourgoulhon created at 2021-01-22 19:54:19

Replying to [comment:9 mkoeppe]:
> Relevant previous discussions: #30241, #30229#comment:6

Thanks for pointing out this! Especially the [comment:2](https://trac.sagemath.org/ticket/30229#comment:2) in the second ticket provides details for the _"Yes. This avoids information redundancy, in particular regarding the bases"_ in comment:2 of the current ticket.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-08-23 06:34:54

Narrowed the ticket description to parent methods only, not element methods


---

Comment by mkoeppe created at 2022-08-23 06:50:01

Replying to [comment:6 egourgoulhon]:
> I see no reason why `FiniteRankFreeModule` should not have a `tensor_type()` method (returning `(1, 0)`), as `TensorFreeModule`. 

Done now
----
New commits:


---

Comment by git created at 2022-08-23 07:09:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-23 07:15:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-23 07:16:07

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-08-23 09:22:45

Thanks for this enhancement. LGTM.


---

Comment by egourgoulhon created at 2022-08-23 09:22:45

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-08-23 13:12:37

Thanks!


---

Comment by vbraun created at 2022-08-29 11:24:12

Resolution: fixed


---

Comment by egourgoulhon created at 2022-09-01 10:11:02

See #34471 for a follow-up.
