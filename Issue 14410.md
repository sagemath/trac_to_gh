# Issue 14410: Improved is_triangle_free using bitfileds?

Issue created by migration from Trac.

Original creator: azi

Original creation time: 2013-05-19 08:31:47

Assignee: jason, ncohen, rlm

CC:  slani stefan azi dimpase ncohen

Test (and potentially) implement a faster is_triangle_free method using the data structure from #14589






---

Comment by azi created at 2013-05-19 08:32:44

Nathann,  you're probably in the best position to test this?


---

Attachment


---

Comment by ncohen created at 2013-05-19 12:33:51

Here's a patch. But it's almost like what we already have, sooooooooo...Fail `:-P`

Nathann


---

Comment by ncohen created at 2013-05-19 12:34:41

(it's not documented, but that's because I don't see a reason to include it in Sage)

Nathann


---

Comment by azi created at 2013-05-19 12:58:28

So what are the timings now?


---

Comment by azi created at 2013-05-19 12:59:58

Btw why you need three nested loops? Is there no way to have a row of neighbors for each vector?


---

Comment by ncohen created at 2013-05-19 13:02:21

The same... Give it a try ! I don't really know what to test this on, though `:-)`

There's a small difference for those ones... But honestly... `:-P`

```
sage: g = graphs.Grid2dGraph(20,20)                    
sage: %time g.is_triangle_free()   
CPU times: user 0.14 s, sys: 0.00 s, total: 0.14 s
Wall time: 0.15 s
True
sage: %time g.is_triangle_free(algorithm="dense_graph")
CPU times: user 0.02 s, sys: 0.00 s, total: 0.02 s
Wall time: 0.01 s
True
```


Nathann


---

Comment by ncohen created at 2013-05-19 13:02:45

Well, do you see a way around ? Each row is a sequence of "long" fields...

Nathann


---

Comment by azi created at 2013-05-19 13:12:19

Oh, I thought that was somehow abstractly packed to allow arbitrarily long rows..

Anyways, I think the main reason this is not faster is that we first need to build the matrix and then do the checking...

It would be neat if our new backend had bitsets of neihbors (along whatever data structure we may choose to keep). I think this would then constitute a major improvement, perhaps by having a method neighbors_intersection(v_1,...,v_k) to the new list of backend functions..


---

Comment by ncohen created at 2013-05-19 13:18:27

Helloooooooooooo !!

> Oh, I thought that was somehow abstractly packed to allow arbitrarily long rows..
> 
> Anyways, I think the main reason this is not faster is that we first need to build the matrix and then do the checking...

Hmmm... Yeah, probably. It would be nice to have instances in which the algorithm really has `n^3` complexity.

....

Stupid guy. Ok, I'll give it a try on a complete bipartite graph `:-P`


```
sage: g = graphs.CompleteBipartiteGraph(200,200)       
sage: %time g.is_triangle_free()                       
CPU times: user 0.68 s, sys: 0.00 s, total: 0.68 s
Wall time: 0.69 s
True
sage: %time g.is_triangle_free(algorithm="dense_graph")
CPU times: user 0.18 s, sys: 0.00 s, total: 0.18 s
Wall time: 0.18 s
True
```


Well, ...

> It would be neat if our new backend had bitsets of neihbors (along whatever data structure we may choose to keep). I think this would then constitute a major improvement, perhaps by having a method neighbors_intersection(v_1,...,v_k) to the new list of backend functions..

I really like to have access to a thing as basic as an array of "long" fields, though. But we could definitely has something similar, at a slightly higher level. An array of Python bitsets ?...

The problem of this data structure is addition/removal of vertices.

Nathann


---

Comment by dcoudert created at 2019-09-22 12:55:06

Another proposal using `static_dense_graph` that is significantly faster than other methods.

```
sage: g = graphs.Grid2dGraph(20,20)
sage: %time g.is_triangle_free(algorithm='dense_graph')
CPU times: user 994 µs, sys: 50 µs, total: 1.04 ms
Wall time: 1.05 ms
True
sage: %time g.is_triangle_free(algorithm='bitset')
CPU times: user 70 ms, sys: 1.1 ms, total: 71.1 ms
Wall time: 70.6 ms
True
sage: %time g.is_triangle_free(algorithm='matrix')
CPU times: user 84.1 ms, sys: 2.45 ms, total: 86.6 ms
Wall time: 85.8 ms
True
```



```
sage: g = graphs.CompleteBipartiteGraph(200,200)
sage: %time g.is_triangle_free(algorithm='dense_graph')
CPU times: user 16.1 ms, sys: 140 µs, total: 16.2 ms
Wall time: 16.2 ms
True
sage: %time g.is_triangle_free(algorithm='bitset')
CPU times: user 102 ms, sys: 1.5 ms, total: 104 ms
Wall time: 103 ms
True
sage: %time g.is_triangle_free(algorithm='matrix')
CPU times: user 130 ms, sys: 11.6 ms, total: 141 ms
Wall time: 141 ms
True
```

----
New commits:


---

Comment by dcoudert created at 2019-09-22 12:55:06

Changing status from new to needs_review.


---

Comment by git created at 2019-09-22 16:18:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-09-22 16:19:00

Allow to return a certificate when `algorithm` is `dense_graph` or `bitset`, and improve method `bitset` (faster but still slower than `dense_graph`).

```
sage: g = graphs.Grid2dGraph(20,20)
sage: %time g.is_triangle_free(algorithm='dense_graph')
CPU times: user 903 µs, sys: 48 µs, total: 951 µs
Wall time: 955 µs
True
sage: %time g.is_triangle_free(algorithm='bitset')
CPU times: user 2.17 ms, sys: 48 µs, total: 2.22 ms
Wall time: 2.23 ms
True
sage: %time g.is_triangle_free(algorithm='matrix')
CPU times: user 84.7 ms, sys: 5.37 ms, total: 90 ms
Wall time: 86.4 ms
True
sage: g = graphs.CompleteBipartiteGraph(200,200)
sage: %time g.is_triangle_free(algorithm='dense_graph')
CPU times: user 15.6 ms, sys: 178 µs, total: 15.8 ms
Wall time: 15.8 ms
True
sage: %time g.is_triangle_free(algorithm='bitset')
CPU times: user 51.6 ms, sys: 1.23 ms, total: 52.8 ms
Wall time: 52.2 ms
True
sage: %time g.is_triangle_free(algorithm='matrix')
CPU times: user 131 ms, sys: 11.4 ms, total: 143 ms
Wall time: 142 ms
True
```



---

Comment by dimpase created at 2019-09-22 23:35:34

looks good - I'm slightly concerned by warnings emitted by C compiler.


---

Comment by dcoudert created at 2019-09-23 07:31:17

I see 3 warnings when I compile without this branch, but I'm not sure where these warnings come from. How can I find them ? the messages are not so clear.


---

Comment by dimpase created at 2019-09-23 07:38:45

if you look at the C file in src/build/... mentioned there, they contain (in comments next to the C code lines) the cython code that it was obtained from.


---

Comment by dimpase created at 2019-09-23 08:35:54

the following gets rid of one of them:


```diff
--- a/src/sage/data_structures/bitset.pxi
+++ b/src/sage/data_structures/bitset.pxi
`@``@` -426,13 +426,14 `@``@` cdef inline long bitset_first_in_complement(bitset_t a):
     Calculate the index of the first element not in the set. If the set
     is full, returns -1.
     """
-    cdef mp_size_t i, j
+    cdef mp_size_t i
+    cdef mp_bitcnt_t j
     for i from 0 <= i < a.limbs:
         if ~a.bits[i]:
             j = (i << index_shift) | _bitset_first_in_limb_nonzero(~a.bits[i])
             if j >= a.size:
-                j = -1
-            return j
+                return -1
+            return <mp_size_t>j
     return -1
 
 cdef inline long bitset_pop(bitset_t a) except -1:
```


Should I appy this and get rid of the remaining ones too?


---

Comment by dcoudert created at 2019-09-23 09:07:45

Sure. Thank you.


---

Comment by git created at 2019-09-23 09:10:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-09-23 09:12:34

OK, done. Does this supress these warnings on MacOS too?


---

Comment by dcoudert created at 2019-09-23 09:27:19

Yes, I don't see warnings anymore for `static_dense_graph`. However, among the 40 files that are compiled, I have warnings in 19 of them (many in graphs...). May be we should make a specific ticket ?


---

Comment by dimpase created at 2019-09-23 10:24:27

OK, let's do the rest elsewhere.


---

Comment by dimpase created at 2019-09-23 10:24:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-03 17:58:40

Resolution: fixed
