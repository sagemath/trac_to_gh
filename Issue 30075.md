# Issue 30075: Graphs: more classical parameters distance regular graphs

Issue created by migration from https://trac.sagemath.org/ticket/30312

Original creator: @Ivo-Maffei

Original creation time: 2020-08-07 14:29:03

CC:  dimpase

Added three families of distance regular graphs, they are based, respectively, on bilinear forms, alternating forms and hermitian forms.

Also moved `AztecDiamondGraph` to families of graphs rather than basic structures.


---

Comment by @Ivo-Maffei created at 2020-08-07 14:45:06

Last 10 new commits:


---

Comment by @Ivo-Maffei created at 2020-08-07 14:45:06

Changing status from new to needs_review.


---

Comment by @Ivo-Maffei created at 2020-08-11 10:22:43

Changing status from needs_review to needs_work.


---

Comment by @Ivo-Maffei created at 2020-08-11 10:22:43

Remainder to update once #30303 and #29886 are sorted


---

Comment by dimpase created at 2020-08-11 10:53:53

`..FormGraph` should be `..FormsGraph`, as these are graphs with vertex sets being sets of forms, right?


---

Comment by @Ivo-Maffei created at 2020-08-11 12:44:55

Yes, I've changed it and also merged #30303 (with the update to 9.2.beta8).
If #29886 will take too much time, I could remove the dependency and generate the needed matrices with the `...FormsGraph` method.
This is what I initially did ages ago.

Of course as soon as #29886 or something similar gets fixed, I can change back these functions to something neater.


---

Comment by git created at 2020-08-11 13:14:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-12 13:52:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-12 13:53:33

Now this should work without #29886.
It's much slower but it should do for now.


---

Comment by @Ivo-Maffei created at 2020-08-12 13:53:33

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-08-22 11:48:03

very long doctests that need more than 1 minute, say, should be tagged as `# not tested` - by the way, on my machine some long doctests with meataxe used crash with `Memory Error`, while complete if run at the sage prompt (due to doctest parallelism I guess).  

Also, there is a typo: `bilienar` -> `bilinear`


---

Comment by dimpase created at 2020-08-22 11:48:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-22 12:30:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-22 12:32:55

Changing status from needs_work to needs_review.


---

Comment by @Ivo-Maffei created at 2020-08-22 12:32:55

I added the `# not tested` flag and run all doctests with and without the `--long` flag.
They all pass in roughly 2 min.


---

Comment by dimpase created at 2020-08-22 13:06:54

more typos

- adjecent -> adjacent
- aprime -> a prime


---

Comment by dimpase created at 2020-08-22 13:11:13

I also think that the Hermitian case should take not q=r<sup>2</sup> as input, but r itself.


---

Comment by dimpase created at 2020-08-22 13:15:14

As you are on the forms graph here, let's add the missing case of the symmetric 3x3 forms graph, as
discussed in [BCN] corrections: https://www.win.tue.nl/~aeb/drg/ch9

```
For $n = 3$ we find a distance-regular graph with intersection array
$"{"q sup 3 -1 , q sup 3 -q , q sup 3 -q sup 2 + 1 ;~ 1,q,q sup 2 -1"}"$
(in the diagram on p. 286, merge the balloons for the forms of rank 3 and
the alternating forms of rank 2).
```



---

Comment by dimpase created at 2020-08-22 13:27:21

Having the latter should allow a more economic definition of the Hermitian case, as a product of the symmetric forms graph over GF(r) and alternating forms graph over GF(r).

It's the product, in the sense that vertices are pairs, 2 vertices (a,b) and (c,d) are adjacent iff 
rk(a-c+i(b-d))=1, where i is a generator of GF(q) over GF(r).
(If I'm not mistaken, rk(a-c+i(b-d))=1 may be expressed as "either rk(a-c)+rk(b-d)<2, or
rk(a-c)=rk(b-d)=1, Ker(a-c)=Ker(b-d).)


---

Comment by @Ivo-Maffei created at 2020-08-22 14:17:46

Replying to [comment:13 dimpase]:
> As you are on the forms graph here, let's add the missing case of the symmetric 3x3 forms graph, as
> discussed in [BCN] corrections: https://www.win.tue.nl/~aeb/drg/ch9
> {{{
> For $n = 3$ we find a distance-regular graph with intersection array
> $"{"q sup 3 -1 , q sup 3 -q , q sup 3 -q sup 2 + 1 ;~ 1,q,q sup 2 -1"}"$
> (in the diagram on p. 286, merge the balloons for the forms of rank 3 and
> the alternating forms of rank 2).
> }}}
I think these graphs have the same intersection array of the Brouwer-Pasechnik graph (https://arxiv.org/abs/1107.0475).
You definitely know if I'm wrong.

The construction given for that graph is easy and works in O(E), so I chose that one over the symmetric matrices one.
Of course we could have both if you wish.


---

Comment by @Ivo-Maffei created at 2020-08-22 14:25:11

Replying to [comment:14 dimpase]:
> Having the latter should allow a more economic definition of the Hermitian case, as a product of the symmetric forms graph over GF(r) and alternating forms graph over GF(r).
> 
> It's the product, in the sense that vertices are pairs, 2 vertices (a,b) and (c,d) are adjacent iff 
> rk(a-c+i(b-d))=1, where i is a generator of GF(q) over GF(r).
> (If I'm not mistaken, rk(a-c+i(b-d))=1 may be expressed as "either rk(a-c)+rk(b-d)<2, or
> rk(a-c)=rk(b-d)=1, Ker(a-c)=Ker(b-d).)
I'll still try this construction. Could you clarify what you mean by "a generator of GF(q) over GF(r)"?
Do you mean $i \in GF(q)$ s.t. $i$ generated $GF(q) / GF(r)$ as vector spaces over $GF(r)$?


---

Comment by dimpase created at 2020-08-23 08:35:51

Replying to [comment:15 gh-Ivo-Maffei]:
> Replying to [comment:13 dimpase]:
> > As you are on the forms graph here, let's add the missing case of the symmetric 3x3 forms graph, as
> > discussed in [BCN] corrections: https://www.win.tue.nl/~aeb/drg/ch9
> > {{{
> > For $n = 3$ we find a distance-regular graph with intersection array
> > $"{"q sup 3 -1 , q sup 3 -q , q sup 3 -q sup 2 + 1 ;~ 1,q,q sup 2 -1"}"$
> > (in the diagram on p. 286, merge the balloons for the forms of rank 3 and
> > the alternating forms of rank 2).
> > }}}
> I think these graphs have the same intersection array of the Brouwer-Pasechnik graph (https://arxiv.org/abs/1107.0475).
> You definitely know if I'm wrong.
> 
> The construction given for that graph is easy and works in O(E), so I chose that one over the symmetric matrices one.
> Of course we could have both if you wish.

in fact, yes, sure, https://arxiv.org/abs/1107.0475 points out to https://www.win.tue.nl/~aeb/drg/ch9 and discusses the relation between the two. There is something with q being even or odd there, so beware of details.


---

Comment by dimpase created at 2020-08-23 08:42:53

Replying to [comment:16 gh-Ivo-Maffei]:

> I'll still try this construction. Could you clarify what you mean by "a generator of GF(q) over GF(r)"?
> Do you mean $i \in GF(q)$ s.t. $i$ generated $GF(q) / GF(r)$ as vector spaces over $GF(r)$?
yes. That is, any i in GF(q)\GF(r) will do.


---

Comment by dimpase created at 2020-08-23 09:27:59

at the moment `graphs.HermitianFormsGraph(2,9)` is horribly slow. 

E.g. it could in part be due to slowness in computing the below-diagonal part. Taking to `r`-th power is perhaps the worst possible way to compute the map in question. Instead, choose `i` as above, compute `i`<sup>r</sup> (once), then for a,b in GF(r) one has (a+ib)<sup>r</sup>= a+i<sup>r</sup>b.

Another place is rank 1 Hermitian matrices. Each such nxn matrix has form vv<sup>*</sup>, for v in GF(q)<sup>n</sup>,
and * denoting the map induced by taking to r-th power. So no need to compute ranks and filter on rank 1.


---

Comment by dimpase created at 2020-08-23 09:27:59

Changing status from needs_review to needs_work.


---

Comment by @Ivo-Maffei created at 2020-08-23 10:18:23

Replying to [comment:19 dimpase]:
> at the moment `graphs.HermitianFormsGraph(2,9)` is horribly slow. 
Totally agree, also `graphs.AlternatingFormsGraph` is too slow.

I thought that the "product" construction was meant to solve the issue with the `HermitianFormsGraph`.


---

Comment by dimpase created at 2020-08-23 10:50:00

The "product" boils down pretty much to modifications I just explained, anyway.
Also, there seems to be no need to even construct matrices (I think the only place you needed them is to compute rank, but this can be skipped, as we just saw) - just keep everything as vectors.


---

Comment by git created at 2020-08-23 17:03:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-23 17:08:33

Now the function is quite fast. I wish `AlternatingFormsGraph` could be as fast.


---

Comment by @Ivo-Maffei created at 2020-08-23 17:08:33

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-08-23 17:42:06

Hermitean forms tests don't need to be tagged by `# meataxe`.
There is also a typo `tow` -> `two`.


---

Comment by dimpase created at 2020-08-23 18:00:38

It seems to me that any alternating rank 2 nxn form  can be obtained from two n-vectors v,u, as
vu<sup>T</sup> - uv<sup>T</sup>. This way alternating forms graphs can be dealt with in a similar way as Hermitean, without using meataxe and matrix spaces.


---

Comment by git created at 2020-08-24 13:24:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-24 13:28:16

The `AlternatingFormsGraph` still builds some redundant rank 2 matrices. 
For instance, `AlternatingFormsGraph(4, 3)` builds 2080 rank 2 matrices, but only 260 of them are distinct.


---

Comment by dimpase created at 2020-08-24 13:42:44

You can normalise one of the vectors, say u, to have the 1st non-zero coordinate equal to 1.


---

Comment by @Ivo-Maffei created at 2020-08-24 14:10:50

There is still quite a lot of redundancy:
`AlternatingFormsGraph(4, 3)` builds 1040 instead of 260 and
`AlternatingFormsGraph(3, 4)` builds 315 instead of 63.

If getting the exact number is too complex, then I won't push further.


---

Comment by git created at 2020-08-24 14:11:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-24 14:40:41

it seems that for `AlternatingFormsGraph(4, 3)` one somehow gets one rank 2 matrix in 4 different ways. Could you post an example?


---

Comment by @Ivo-Maffei created at 2020-08-24 15:13:26

For instance:

```sage                                                                                                                                                                                                                                     
[0 2 2 1]
[1 0 0 1]
[1 0 0 1]
[2 2 2 0]
# the above is obtained by the following 4 pairs (v, u)
[((2, 2, 2, 0), (0, 1, 1, 2)),
 ((2, 1, 1, 1), (0, 1, 1, 2)),
 ((2, 0, 0, 2), (0, 1, 1, 2)),
 ((0, 1, 1, 2), (1, 0, 0, 1))]
```


Not all matrices are constructed by pairs where 1 vectors is in all pairs (above (0, 1, 1, 2)):

```sage
[0 1 2 0]
[2 0 0 2]
[1 0 0 1]
[0 1 2 0]
#given by
[((0, 2, 1, 0), (1, 0, 0, 1)),
 ((1, 0, 0, 1), (0, 1, 2, 0)),
 ((1, 2, 1, 1), (0, 1, 2, 0)),
 ((1, 1, 2, 1), (0, 1, 2, 0))]
```

This time the vector (0, 1, 2, 0) in multiplied by 2 when it appears as v


---

Comment by dimpase created at 2020-08-24 15:49:56

One further optimisation would be to take unordered pairs of u,v, both with 1st non-zero coordinates equal to 1, remove duplicates, and then scale the resulting matrices by the non-zero elements of GF(q).
This would cut the duplication by 2, I believe.

I give up on further improving this for the time being (this seems to be a non-trivial maths question). 

I believe for our purposes it is fast enough.


---

Comment by git created at 2020-08-24 16:22:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 16:26:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-24 16:46:45

Can we also get rid of meataxe in BilinearFormsGraph ? Again, the idea is that every rank 1 mxn matrix can be written as uv<sup>T</sup>, for m-vector u and n-vector v, and so the adjacency may be computed without actually doing through matrices and their ranks.


---

Comment by @Ivo-Maffei created at 2020-08-24 17:20:14

Replying to [comment:36 dimpase]:
> Can we also get rid of meataxe in BilinearFormsGraph ? Again, the idea is that every rank 1 mxn matrix can be written as uv<sup>T</sup>, for m-vector u and n-vector v, and so the adjacency may be computed without actually doing through matrices and their ranks.
I can avoid computing ranks, but while in `AlternatingFormsGraph` and `HermitianFormsGraph` I was representing a form by the vector of the upper triangular entries, in `BilinearFormsGraph` I need the whole matrix.

I can try using the MatrixSpace without `implementation=meataxe` or "flattening" all matrices to vectors, but we'll lose speed.


---

Comment by dimpase created at 2020-08-25 07:44:16

In any event, please remove the rank computation there.


---

Comment by dimpase created at 2020-08-25 08:45:35

Otherwise, it looks good, great speedups!


---

Comment by git created at 2020-08-25 08:57:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-25 08:58:27

Using integer vectors to iterate over the matrices cuts all times to half respect to the initial implementation with meataxe.


---

Comment by dimpase created at 2020-08-25 10:22:38

not sure how you encode elements of GF(q) as integers, in particular for nonprime q


---

Comment by @Ivo-Maffei created at 2020-08-25 10:40:34

I use integers only in `matricesOverq` and the encoding is given by `Fqelems` which maps integers to elements of GF(q).
The inverse GF(q) -> Int is not needed but it is given by `toInt = {n: x for n, x in enumerate(Fqelems)}`.
All arithmetic is done with elements of GF(q). The integers are only used to speed up the iteration `for m1 in matricesOverq`.


---

Comment by dimpase created at 2020-08-25 16:54:13

by the way, nothing prevents you from trying to use the meataxe backend for matrices, and falling back on the default one if it's not available.


---

Comment by dimpase created at 2020-08-25 20:16:24

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-25 20:16:24

If you like to add the meataxe speed up option, please do, else it's good as it is.


---

Comment by @Ivo-Maffei created at 2020-08-26 06:33:00

Replying to [comment:45 dimpase]:
> If you like to add the meataxe speed up option, please do, else it's good as it is.
The current code is faster than any previous version that used meataxe
I'm not sure how to speed things up more with meataxe


---

Comment by vbraun created at 2020-08-30 08:38:59

Resolution: fixed


---

Comment by vbraun created at 2020-08-30 10:12:25

Resolution changed from fixed to 


---

Comment by vbraun created at 2020-08-30 10:12:25

Changing status from closed to new.


---

Comment by vbraun created at 2020-08-30 10:13:12


```
**********************************************************************
File "src/sage/graphs/generators/distance_regular.pyx", line 629, in sage.graphs.generators.distance_regular.BilinearFormsGraph
Failed example:
    G = graphs.BilinearFormsGraph(3,3,3)  # long time (20 s)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.distance_regular.BilinearFormsGraph[2]>", line 1, in <module>
        G = graphs.BilinearFormsGraph(Integer(3),Integer(3),Integer(3))  # long time (20 s)
      File "sage/graphs/generators/distance_regular.pyx", line 679, in sage.graphs.generators.distance_regular.BilinearFormsGraph (build/cythonized/sage/graphs/generators/distance_regular.c:11661)
        m3 = tuple([m1[i] + m2[i] for i in range(d*e)])
    MemoryError
**********************************************************************
File "src/sage/graphs/generators/distance_regular.pyx", line 630, in sage.graphs.generators.distance_regular.BilinearFormsGraph
Failed example:
    G.order()  # long time (due to above)
Expected:
    19683
Got:
    512
**********************************************************************
```



---

Comment by @Ivo-Maffei created at 2020-08-30 14:17:19

Changing status from new to needs_review.


---

Comment by @Ivo-Maffei created at 2020-08-30 14:17:19

I made the same changes of #30337 commit 59776810db8b3352985cc688c82b9ea6e48a70dc


---

Comment by git created at 2020-09-03 08:57:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-03 20:03:46

some tests should still be tagged long:

```
Trying (line 388):    G = graphs.distance_3_doubly_truncated_Golay_code_graph()
Expecting nothing
ok [10.27 s]
...

Trying (line 582):    G = graphs.UstimenkoGraph(5, 2)
Expecting nothing
ok [22.18 s]
Trying (line 583):    G.order()
Expecting:
    2295
ok [0.00 s]
Trying (line 585):    G.is_distance_regular(True)
Expecting:
    ([310, 224, None], [None, 1, 35])
ok [11.42 s]

Trying (line 633):    G.is_distance_regular(True)
Expecting:
    ([105, 84, 48, None], [None, 1, 6, 28])
ok [17.22 s]

```



---

Comment by git created at 2020-09-04 08:35:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-04 08:44:00

`#long` tag missing on line 588, leading to a failing doctest:

```
File "src/sage/graphs/generators/distance_regular.pyx", line 588, in sage.graphs.generators.distance_regular.UstimenkoGraph
Failed example:
    G.is_distance_regular(True)
Expected:
    ([390, 243, None], [None, 1, 130])
Got:
    ([70, 32, None], [None, 1, 35])
```



---

Comment by git created at 2020-09-04 08:48:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-04 09:27:35

long tests are still a bit too long to my taste, but OK.


---

Comment by dimpase created at 2020-09-04 09:27:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-15 21:58:33

Resolution: fixed
