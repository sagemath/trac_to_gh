# Issue 28940: No transformation matrix returns from echelon_form(transformation=True)

Issue created by migration from https://trac.sagemath.org/ticket/29177

Original creator: klee

Original creation time: 2020-02-11 00:38:16

CC:  slelievre

Contrary to user expectation, we get:

```
sage: m = matrix(GF(5), 3, [1,2,3,4,5,6,7,8,9])
sage: m
[1 2 3]
[4 0 1]
[2 3 4]
sage: m.echelon_form(transformation=True)
[1 0 4]
[0 1 2]
[0 0 0]
sage: m = matrix(QQ, 3, [1,2,3,4,5,6,7,8,9])
sage: m.echelon_form(transformation=True)
[ 1  0 -1]
[ 0  1  2]
[ 0  0  0]
```

No transformation matrix is returned. The docstring of echelon_form() says

   * "transformation" -- boolean. Whether to also return the
     transformation matrix. Some matrix backends do not provide this
     information, in which case this option is ignored.

So the chosen algorithm by default does not produce a transformation matrix! 

The correct behavior of `echelon_form(transformation=True)` is to choose a backend algorithm that actually produce a transformation matrix and provide one, instead of ignoring the user's expectation. 

And if a user chooses a wrong combination of "backend" and "transformation" an error should be raised.


---

Comment by nbruin created at 2020-02-11 01:16:40

As remarked before, if one augments the matrix on the right with an identity matrix, then that keeps track of the row operations and hence the transformation matrix. A default strategy to get the transformation matrix is to do this augmentation trick. You can override this with other tracking strategies for backends that support it. It's probably worth doing some timings to see what the penalty of this augmentation is. I suspect that it's going to be better to use a good backend and augment than to switch to a backend that produces the transformation matrix via other means.


---

Comment by klee created at 2020-02-11 01:27:13

Replying to [comment:1 nbruin]:
>  I suspect that it's going to be better to use a good backend and augment than to switch to a backend that produces the transformation matrix via other means.

I agree. So we can make backend choice independent from `transformation=True`.


---

Comment by nbruin created at 2020-02-11 02:39:58

Replying to [comment:2 klee]:
> I agree. So we can make backend choice independent from `transformation=True`.
Well ... it means that if `backend=auto` (or whatever the default option is), a good choice for the base ring should be made that takes into account the value of `transformation`.


---

Comment by klee created at 2020-02-11 05:05:29

Replying to [comment:3 nbruin]:
> Replying to [comment:2 klee]:
> > I agree. So we can make backend choice independent from `transformation=True`.
> Well ... it means that if `backend=auto` (or whatever the default option is), a good choice for the base ring should be made that takes into account the value of `transformation`.

I tried to early detect whether a backend supports transformation matrix. Each backend that does not compute tansformation matrix may raise an exception when given the `transformation=True` argument. If such an exception is raised, then we resort to the default strategy using`extended_echelon_form()` method. But this would add overhead of not much worth to each backend...


---

Comment by nbruin created at 2020-02-11 23:24:45

Replying to [comment:4 klee]:
> I tried to early detect whether a backend supports transformation matrix. Each backend that does not compute tansformation matrix may raise an exception when given the `transformation=True` argument. If such an exception is raised, then we resort to the default strategy using`extended_echelon_form()` method. But this would add overhead of not much worth to each backend...

It looks to me that this routine gets overridden on a lot of matrix classes, in which the various backends (or "algorithms") are implemented case-by-case. For instance, the one on integer matrices seems to cast an error for certain algorithms if transformation matrix is not specified.

Given that the minimal interface seems to be that transformation matrices are *not* supported, I guess the "generic" routine could just do this by augmenting. You'll have to go through all the special cases anyway, and since the backends are explicitly known there, you can just tune for each if augmentation or asking for a transformation matrix is the right thing to do.


---

Comment by klee created at 2020-02-12 06:52:01

Replying to [comment:5 nbruin]:
> It looks to me that this routine gets overridden on a lot of matrix classes, in which the various backends (or "algorithms") are implemented case-by-case. For instance, the one on integer matrices seems to cast an error for certain algorithms if transformation matrix is not specified.

Right.

> Given that the minimal interface seems to be that transformation matrices are *not* supported, I guess the "generic" routine could just do this by augmenting. You'll have to go through all the special cases anyway, and since the backends are explicitly known there, you can just tune for each if augmentation or asking for a transformation matrix is the right thing to do.

I looked through all `echelon_form()` definitions in 

- `matrix_gf2e_dense`
- `matrix_mod2_dense`
- `matrix_modn_dense_template`
- `matrix_cyclo_dense`
- `matrix_integer_dense`
- `matrix_mpolynomial_dense`
- `matrix_rational_dense`
- `matrix_rational_sparse`

My conclusion is that `echelon_form()` basically does not support `transformation` option, except matrices over `ZZ` and uncommon rings.

So I decided to just clarify the misleading docstring.


---

Comment by git created at 2020-02-12 06:56:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2020-02-12 06:58:37

Changing status from new to needs_review.


---

Comment by klee created at 2020-02-13 00:44:26

For your information:

|         |                    |                     |
|---------|--------------------|---------------------|
| module  | has echelonize()?  | has echelon_form()? |
|matrix2  | O| O|
|matrix_gf2e_dense | O| X|
|matrix_mod2_dense | O| X|
|matrix_modn_dense_template | O| X|
|matrix_cyclo_dense | X| O| 
|matrix_integer_dense | X| O|
|matrix_mpolynomial_dense | O| O|
|matrix_rational_dense | O| O|
|matrix_rational_sparse | O| O|
`matrix2` support `echelon_form(transformation=True)` for matrices over non-field rings.

`matrix_integer_dense` support `echelon_form(transformation=True)`for flint and padic backends.


---

Comment by klee created at 2020-02-13 00:44:26

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
