# Issue 23735: do not silently delete non-matching tarball in upstream/

Issue created by migration from https://trac.sagemath.org/ticket/23972

Original creator: dimpase

Original creation time: 2017-10-06 06:58:30

CC:  jdemeyer

If a tarball does not match the checksums, it is silently deleted by `sage -i`. This is very confusing. A warning should be shown prominently. 

We see this over an over again, e.g. on #23898.


---

Comment by embray created at 2017-10-06 07:53:10

+1 I have also been bitten by this.  I don't see why it should be deleted as long as it isn't installed.


---

Comment by jdemeyer created at 2017-10-06 08:02:26

First of all, it's not _silently_ deleted, there is a message:

```
[zlib-1.2.11] Found local metadata for zlib-1.2.11
[zlib-1.2.11] Invalid checksum for cached file /usr/local/src/sage-config/upstream/zlib-1.2.11.tar.gz, deleting
```


I think the auto-deleting was implemented by Volker to make things easier for bots. If a bot has a wrong tarball in `upstream` for some reason, then it's easiest to simply re-download it.

Maybe the best solution would be to only delete the existing tarball when a correct one was successfully downloaded.


---

Comment by vbraun created at 2017-10-06 14:02:31

If the bots don't auto-delete files with incorrect checksums then it'll be easy to foobar all patchbots with one incorrect ticket...


---

Comment by jdemeyer created at 2017-10-06 14:12:40

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-10-06 14:12:40

I think this solution works: do not _delete_ the bad tarball, just ignore it and download a new version replacing the bad version.

If the tarball does exist on the mirrors, the result should be the same as now. If the tarball does _not_ exist on the mirrors, it is simply left in place.
----
New commits:


---

Comment by vklein created at 2018-06-22 08:56:17

Note that your commit doesn't seems to solve the case encountered in #23898. 
Your tarball is not deleted but is crushed by the following download. 

I still think this ticket is usefull when you are upgrading a package version or creating a new package.


---

Comment by vklein created at 2018-06-22 09:08:20

It works. 
Tests have been done on top of sage 8.3.beta6 version


---

Comment by vklein created at 2018-06-22 09:08:20

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-06-22 09:30:51

Replying to [comment:6 vklein]:
> Note that your commit doesn't seems to solve the case encountered in #23898.

What precisely is "the case encountered in #23898"?


---

Comment by vklein created at 2018-06-22 09:45:58

I am refering to that #23898#comment:22

My point was that the package replacement is as "silent" as before with this ticket. But reading again [comment 2](https://trac.sagemath.org/ticket/23972#comment:2) you're well aware of that.


---

Comment by vbraun created at 2018-06-23 19:58:55

Resolution: fixed
