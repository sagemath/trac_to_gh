# Issue 21088: k-regular sequences: subsequences, forward/backward difference

archive/issues_021088.json:
```json
{
    "body": "CC:  @galipnik\n\nImplement subsequences and forward/backward differences\n\nIssue created by migration from https://trac.sagemath.org/ticket/21325\n\n",
    "created_at": "2016-08-24T08:56:30Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "k-regular sequences: subsequences, forward/backward difference",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21088",
    "user": "https://github.com/dkrenn"
}
```
CC:  @galipnik

Implement subsequences and forward/backward differences

Issue created by migration from https://trac.sagemath.org/ticket/21325





---

archive/issue_comments_291825.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2016-08-24T08:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291825",
    "user": "https://github.com/dkrenn"
}
```

Last 10 new commits:



---

archive/issue_comments_291826.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-25T10:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291827.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-25T11:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291827",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291828.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-25T11:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291828",
    "user": "https://github.com/dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_291829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-26T11:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291829",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-26T11:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291830",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291831.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-05T12:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291831",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_291832.json:
```json
{
    "body": "patchbot python3 plugin fails",
    "created_at": "2017-01-05T12:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291832",
    "user": "https://github.com/cheuberg"
}
```

patchbot python3 plugin fails



---

archive/issue_comments_291833.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-01-24T13:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291833",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_291834.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-24T13:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291834",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_291835.json:
```json
{
    "body": "Replying to [comment:8 cheuberg]:\n> patchbot python3 plugin fails\n\nFixed.",
    "created_at": "2017-01-24T13:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291835",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:8 cheuberg]:
> patchbot python3 plugin fails

Fixed.



---

archive/issue_comments_291836.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-06T07:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291836",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291837.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-29T08:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291838.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-05-11T14:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_291839.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-25T11:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291839",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-25T12:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291840",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291841.json:
```json
{
    "body": "Merged dependencies and adapted code due to changes in these dependencies.",
    "created_at": "2021-06-25T12:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291841",
    "user": "https://github.com/dkrenn"
}
```

Merged dependencies and adapted code due to changes in these dependencies.



---

archive/issue_comments_291842.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-09T10:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291842",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_291843.json:
```json
{
    "body": "1. `pad_right`: One-sentence description: the syntax ```zero``s` does not yield the desired formatting: The output is `zero``s to have at least the given ``length.`\n\n2. `pad_right`: PEP8: Missing spaces after commas in input of examples and tests.\n\n3. `subsequence`: Description of the input parameter `b`: The meaning of `c_j(a_n+b_j)` is unclear to me.\n\n4. `subsequence`: First example: I think that it might be more intuitive to have a simpler linear representation for the sequence `(n)_{n\\ge 0}`. The current representation corresponds to the vector `(n, 2n+1)`; a representation corresponding to the vector `(n, 1)` would be simpler. It might also be helpful to state the vector explicitly.\n\n5. `subsequence`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.\n\n6. `subsequence`: For the example `C.subsequence(3, 1)`, it might be helpful to document that this does what it should do by adding some tests of the shape\n   {{{\n   #!python\n   sage: var('n')\n   sage: def v(n):\n   ....:     return vector([3*n + 1, 6*n + 1])\n   sage: S.mu[0] * v(n) == v(2*n)\n   True\n   sage: S.mu[1] * v(n) == v(2*n + 1)\n   True\n   }}}\n   Similar tests would be welcome in other examples, too, e.g. for `C.subsequence(1, -1)`, the vector is something like `[n -1 + delta_0(n), 2*n - 1 + delta_0(n), 4*n + 1]` where `delta_0(n)` corresponds to `int(n == 0)`:\n   {{{\n   #!python\n   sage: function('delta_0')\n   sage: def v(n):\n   ....:     return vector([n -1 + delta_0(n), 2*n - 1 + delta_0(n), 4*n + 1])\n   sage: def simplify_delta(expr):\n   ....:     return expr.subs({delta_0(2*n): delta_0(n), delta_0(2*n + 1): 0})\n   sage: simplify_delta(v(2*n) - S.mu[0]*v(n)).is_zero()\n   True\n   sage: simplify_delta(v(2*n + 1) - S.mu[1]*v(n)).is_zero()\n   True\n   }}}\n   or, for `S = C.subsequence(1, {0: 1, -1: -1})`:\n   {{{\n   #!python\n   sage: def v(n):\n   ....:     return vector([1 - delta_0(n), 1])\n   }}}\n\n7. `subsequence`: is there are a particular reason to write `lines = dict((r, []) for r in A)` instead of `lines = {r: [] for r in A}`\n\n8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.\n\n9. `subsequence`: I think that in the block calling `mu_line`, a comment stating that we now compute the contributions of `v(an+c)[an\\ge 0]` to the linear representation by using `v(a(kn+r)+c)[a(kn+r)+c\\ge 0] = v(kan+ar+c)[kan+ar+c\\ge 0] = v(k(an+d)+f)[an+d\\ge 0]=mu[f]v(an+d)[an+d\\ge 0]` where `v(n) = self.__getitem__(n, multiply_left=False)` would be helpful.\n\n10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n\n21. `subsequence`: I think that the construction of the new left vector could be simplified by constructing it as a \"block vector\" instead of an actual sum of padded tuples:\n    {{{\n    #!python\n    vector(sum((tuple(b.get(c, 0)*self.left) for c in kernel), tuple()))\n    }}}\n\n32. `partial_sums`: The description of the parameter `include_n` is rendered incompletely because ``n`th` is not formatted appropriately.\n\n43. `partial_sums`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.\n\n54. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?\n\n65. `partial_sums`: `dict((r, W.augment((-B[r+1]).stack(self.mu[r]))) for r in A)` vs. `{r: ... for r in A}`\n\n76. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.\n\n87. The patchbot notes two issues raised by pyflakes; one of them can probably be fixed by merging the latest version of #21318\n\n98. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.\n\n109. I am curios why there are no methods `shift_left` and `shift_right`; they could easily be implemented via `subsequence`.\n\n20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.",
    "created_at": "2021-07-09T10:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291843",
    "user": "https://github.com/cheuberg"
}
```

1. `pad_right`: One-sentence description: the syntax ```zero``s` does not yield the desired formatting: The output is `zero``s to have at least the given ``length.`

2. `pad_right`: PEP8: Missing spaces after commas in input of examples and tests.

3. `subsequence`: Description of the input parameter `b`: The meaning of `c_j(a_n+b_j)` is unclear to me.

4. `subsequence`: First example: I think that it might be more intuitive to have a simpler linear representation for the sequence `(n)_{n\ge 0}`. The current representation corresponds to the vector `(n, 2n+1)`; a representation corresponding to the vector `(n, 1)` would be simpler. It might also be helpful to state the vector explicitly.

5. `subsequence`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.

6. `subsequence`: For the example `C.subsequence(3, 1)`, it might be helpful to document that this does what it should do by adding some tests of the shape
   {{{
   #!python
   sage: var('n')
   sage: def v(n):
   ....:     return vector([3*n + 1, 6*n + 1])
   sage: S.mu[0] * v(n) == v(2*n)
   True
   sage: S.mu[1] * v(n) == v(2*n + 1)
   True
   }}}
   Similar tests would be welcome in other examples, too, e.g. for `C.subsequence(1, -1)`, the vector is something like `[n -1 + delta_0(n), 2*n - 1 + delta_0(n), 4*n + 1]` where `delta_0(n)` corresponds to `int(n == 0)`:
   {{{
   #!python
   sage: function('delta_0')
   sage: def v(n):
   ....:     return vector([n -1 + delta_0(n), 2*n - 1 + delta_0(n), 4*n + 1])
   sage: def simplify_delta(expr):
   ....:     return expr.subs({delta_0(2*n): delta_0(n), delta_0(2*n + 1): 0})
   sage: simplify_delta(v(2*n) - S.mu[0]*v(n)).is_zero()
   True
   sage: simplify_delta(v(2*n + 1) - S.mu[1]*v(n)).is_zero()
   True
   }}}
   or, for `S = C.subsequence(1, {0: 1, -1: -1})`:
   {{{
   #!python
   sage: def v(n):
   ....:     return vector([1 - delta_0(n), 1])
   }}}

7. `subsequence`: is there are a particular reason to write `lines = dict((r, []) for r in A)` instead of `lines = {r: [] for r in A}`

8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.

9. `subsequence`: I think that in the block calling `mu_line`, a comment stating that we now compute the contributions of `v(an+c)[an\ge 0]` to the linear representation by using `v(a(kn+r)+c)[a(kn+r)+c\ge 0] = v(kan+ar+c)[kan+ar+c\ge 0] = v(k(an+d)+f)[an+d\ge 0]=mu[f]v(an+d)[an+d\ge 0]` where `v(n) = self.__getitem__(n, multiply_left=False)` would be helpful.

10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.

21. `subsequence`: I think that the construction of the new left vector could be simplified by constructing it as a "block vector" instead of an actual sum of padded tuples:
    {{{
    #!python
    vector(sum((tuple(b.get(c, 0)*self.left) for c in kernel), tuple()))
    }}}

32. `partial_sums`: The description of the parameter `include_n` is rendered incompletely because ``n`th` is not formatted appropriately.

43. `partial_sums`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.

54. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?

65. `partial_sums`: `dict((r, W.augment((-B[r+1]).stack(self.mu[r]))) for r in A)` vs. `{r: ... for r in A}`

76. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.

87. The patchbot notes two issues raised by pyflakes; one of them can probably be fixed by merging the latest version of #21318

98. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.

109. I am curios why there are no methods `shift_left` and `shift_right`; they could easily be implemented via `subsequence`.

20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.



---

archive/issue_comments_291844.json:
```json
{
    "body": "Following the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk), here are two minor remarks:\n\nReplying to [comment:18 cheuberg]:\n> 18. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.\nOne can use Python's [itertools.chain](https://docs.python.org/3/library/itertools.html#itertools.chain) or [chain.from_iterable](https://docs.python.org/3/library/itertools.html#itertools.chain.from_iterable) where appropriate. For example:\n\n\n```python\nsage: from itertools import chain\nsage: vector(chain([1,2,3], [4,5,6]))\n(1, 2, 3, 4, 5, 6) \n```\n\n\n> 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?\n>\nI think the number of additions is quadratic, where it can be linear. Creating such partial sums with linear number of additions has many implementations: [itertools.accumulate](https://docs.python.org/3/library/itertools.html#itertools.accumulate), [numpy.cumsum](https://numpy.org/doc/1.21/reference/generated/numpy.cumsum.html#numpy.cumsum), and not long ago I discovered that Sage have the function [running_total](https://doc.sagemath.org/html/en/reference/misc/sage/misc/misc_c.html#sage.misc.misc_c.running_total). If this is premature optimization (e.g. the size of `A` is always small), then please ignore.\n\nI do not know much about k-regular sequences, but from a quick read it seems great to have them implementated in Sage.",
    "created_at": "2021-07-12T00:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291844",
    "user": "https://github.com/mathzeta"
}
```

Following the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk), here are two minor remarks:

Replying to [comment:18 cheuberg]:
> 18. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.
One can use Python's [itertools.chain](https://docs.python.org/3/library/itertools.html#itertools.chain) or [chain.from_iterable](https://docs.python.org/3/library/itertools.html#itertools.chain.from_iterable) where appropriate. For example:


```python
sage: from itertools import chain
sage: vector(chain([1,2,3], [4,5,6]))
(1, 2, 3, 4, 5, 6) 
```


> 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?
>
I think the number of additions is quadratic, where it can be linear. Creating such partial sums with linear number of additions has many implementations: [itertools.accumulate](https://docs.python.org/3/library/itertools.html#itertools.accumulate), [numpy.cumsum](https://numpy.org/doc/1.21/reference/generated/numpy.cumsum.html#numpy.cumsum), and not long ago I discovered that Sage have the function [running_total](https://doc.sagemath.org/html/en/reference/misc/sage/misc/misc_c.html#sage.misc.misc_c.running_total). If this is premature optimization (e.g. the size of `A` is always small), then please ignore.

I do not know much about k-regular sequences, but from a quick read it seems great to have them implementated in Sage.



---

archive/issue_comments_291845.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-01-05T14:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291845",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_291846.json:
```json
{
    "body": "Replying to [comment:18 cheuberg]:\n> 1. `pad_right`: One-sentence description: the syntax ```zero``s` does not yield the desired formatting: The output is `zero``s to have at least the given ``length.`\n\nDone.\n\n> 2. `pad_right`: PEP8: Missing spaces after commas in input of examples and tests.\n\nDone.\n\n> 3. `subsequence`: Description of the input parameter `b`: The meaning of `c_j(a_n+b_j)` is unclear to me.\n\nIndeed, this was incorrect. Changed now.\n\n> 4. `subsequence`: First example: I think that it might be more intuitive to have a simpler linear representation for the sequence `(n)_{n\\ge 0}`. The current representation corresponds to the vector `(n, 2n+1)`; a representation corresponding to the vector `(n, 1)` would be simpler. It might also be helpful to state the vector explicitly.\n\nYes, indeed we should use the simpler linear representation; changed.\nVector explicitly added (in separate commit).\n\n> 5. `subsequence`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.\n\nDone.\n\n> 6. `subsequence`: For the example `C.subsequence(3, 1)`, it might be helpful to document that this does what it should do by adding some tests of the shape [...]\n\nTests added in the `TESTS` section to not pollute the examples section in terms of readability.\n\n> 7. `subsequence`: is there are a particular reason to write `lines = dict((r, []) for r in A)` instead of `lines = {r: [] for r in A}`\n\nI vaguely remember that an older Python version didn't support this and parts of the code are quite old in terms of Python versions. Nevertheless, changed, as this is clearly an improvement.\n\n> 8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.\n\nChanged. However, I am not fully convinced that this rewriting made it that much better/easier to read as hoped; nevertheless, it think it made it somehow easier to understand what is going on. The loop over i, for sure, needed to be pulled out, even without the change to block matrices.\n\n> 9. `subsequence`: I think that in the block calling `mu_line`, a comment stating that we now compute the contributions of `v(an+c)[an\\ge 0]` to the linear representation by using `v(a(kn+r)+c)[a(kn+r)+c\\ge 0] = v(kan+ar+c)[kan+ar+c\\ge 0] = v(k(an+d)+f)[an+d\\ge 0]=mu[f]v(an+d)[an+d\\ge 0]` where `v(n) = self.__getitem__(n, multiply_left=False)` would be helpful.\n\nComment (as stated) added.\n\n> 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n\nOk.\n\n> 11. `subsequence`: I think that the construction of the new left vector could be simplified by constructing it as a \"block vector\" instead of an actual sum of padded tuples:\n>     {{{\n>     #!python\n>     vector(sum((tuple(b.get(c, 0)*self.left) for c in kernel), tuple()))\n>     }}}\n\nThis is indeed much simpler; changed.\n\n> 12. `partial_sums`: The description of the parameter `include_n` is rendered incompletely because ``n`th` is not formatted appropriately.\n\nDone.\n\n> 13. `partial_sums`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.\n\nUsed now.\n\n> 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?\n\nDone.\n\n> 15. `partial_sums`: `dict((r, W.augment((-B[r+1]).stack(self.mu[r]))) for r in A)` vs. `{r: ... for r in A}`\n\nDone.\n\n> 16. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.\n\nAgreed; changed.\n\nDo we mind, that now the output of the linear representation sometimes is a displayed as block matrix? I guess not...\n\n> 17. The patchbot notes two issues raised by pyflakes; one of them can probably be fixed by merging the latest version of #21318\n\nI think this should be fixed already. Let's see what the patchbot reports.\n\n> 18. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.\n\nChanged to `vector(chain(...))` as discussed on the mailing list and ticket.\n\n> 19. I am curios why there are no methods `shift_left` and `shift_right`; they could easily be implemented via `subsequence`.\n\nSimply because not implemented. Done now.\n\n> 20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.\n\nI agree that this should be done on a follow-up ticket.",
    "created_at": "2022-01-05T14:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291846",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:18 cheuberg]:
> 1. `pad_right`: One-sentence description: the syntax ```zero``s` does not yield the desired formatting: The output is `zero``s to have at least the given ``length.`

Done.

> 2. `pad_right`: PEP8: Missing spaces after commas in input of examples and tests.

Done.

> 3. `subsequence`: Description of the input parameter `b`: The meaning of `c_j(a_n+b_j)` is unclear to me.

Indeed, this was incorrect. Changed now.

> 4. `subsequence`: First example: I think that it might be more intuitive to have a simpler linear representation for the sequence `(n)_{n\ge 0}`. The current representation corresponds to the vector `(n, 2n+1)`; a representation corresponding to the vector `(n, 1)` would be simpler. It might also be helpful to state the vector explicitly.

Yes, indeed we should use the simpler linear representation; changed.
Vector explicitly added (in separate commit).

> 5. `subsequence`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.

Done.

> 6. `subsequence`: For the example `C.subsequence(3, 1)`, it might be helpful to document that this does what it should do by adding some tests of the shape [...]

Tests added in the `TESTS` section to not pollute the examples section in terms of readability.

> 7. `subsequence`: is there are a particular reason to write `lines = dict((r, []) for r in A)` instead of `lines = {r: [] for r in A}`

I vaguely remember that an older Python version didn't support this and parts of the code are quite old in terms of Python versions. Nevertheless, changed, as this is clearly an improvement.

> 8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.

Changed. However, I am not fully convinced that this rewriting made it that much better/easier to read as hoped; nevertheless, it think it made it somehow easier to understand what is going on. The loop over i, for sure, needed to be pulled out, even without the change to block matrices.

> 9. `subsequence`: I think that in the block calling `mu_line`, a comment stating that we now compute the contributions of `v(an+c)[an\ge 0]` to the linear representation by using `v(a(kn+r)+c)[a(kn+r)+c\ge 0] = v(kan+ar+c)[kan+ar+c\ge 0] = v(k(an+d)+f)[an+d\ge 0]=mu[f]v(an+d)[an+d\ge 0]` where `v(n) = self.__getitem__(n, multiply_left=False)` would be helpful.

Comment (as stated) added.

> 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.

Ok.

> 11. `subsequence`: I think that the construction of the new left vector could be simplified by constructing it as a "block vector" instead of an actual sum of padded tuples:
>     {{{
>     #!python
>     vector(sum((tuple(b.get(c, 0)*self.left) for c in kernel), tuple()))
>     }}}

This is indeed much simpler; changed.

> 12. `partial_sums`: The description of the parameter `include_n` is rendered incompletely because ``n`th` is not formatted appropriately.

Done.

> 13. `partial_sums`: the new method `linear_representation` implemented in the review phase of a precursor ticket could be used instead of manually extracting the information.

Used now.

> 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?

Done.

> 15. `partial_sums`: `dict((r, W.augment((-B[r+1]).stack(self.mu[r]))) for r in A)` vs. `{r: ... for r in A}`

Done.

> 16. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.

Agreed; changed.

Do we mind, that now the output of the linear representation sometimes is a displayed as block matrix? I guess not...

> 17. The patchbot notes two issues raised by pyflakes; one of them can probably be fixed by merging the latest version of #21318

I think this should be fixed already. Let's see what the patchbot reports.

> 18. It seems that there is no function `block_vector` in [SageMath](SageMath). I think that always constructing them via conversion to tuples, adding tuples, converting back to a vector is not very readable. I posted about `block_vector` on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk/m/0iRDn28eAAAJ). If no such function is introduced in appropriate places, I suggest to have a local function in `recognizable_series.py`.

Changed to `vector(chain(...))` as discussed on the mailing list and ticket.

> 19. I am curios why there are no methods `shift_left` and `shift_right`; they could easily be implemented via `subsequence`.

Simply because not implemented. Done now.

> 20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.

I agree that this should be done on a follow-up ticket.



---

archive/issue_comments_291847.json:
```json
{
    "body": "Replying to [comment:19 mathzeta2]:\n> Following the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk), here are two minor remarks:\n> One can use Python's [itertools.chain](https://docs.python.org/3/library/itertools.html#itertools.chain) or [chain.from_iterable](https://docs.python.org/3/library/itertools.html#itertools.chain.from_iterable) where appropriate. For example:\n\n\nDone.\n\n> > 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?\n> >\n> I think the number of additions is quadratic, where it can be linear. Creating such partial sums with linear number of additions has many implementations: [itertools.accumulate](https://docs.python.org/3/library/itertools.html#itertools.accumulate), [numpy.cumsum](https://numpy.org/doc/1.21/reference/generated/numpy.cumsum.html#numpy.cumsum), and not long ago I discovered that Sage have the function [running_total](https://doc.sagemath.org/html/en/reference/misc/sage/misc/misc_c.html#sage.misc.misc_c.running_total). If this is premature optimization (e.g. the size of `A` is always small), then please ignore.\n\nYes, indeed the size of `A` is small compared to everything else. Nevertheless I gave it a try. One would need something like\n\n```diff\n-        B = {r: sum(self.mu[a] for a in A[r:]) for r in A}\n+        B = dict(zip(reversed(A), accumulate(self.mu[r] for r in reversed(A))))\n```\n\nwhich makes it much less readable, so rejected this change.",
    "created_at": "2022-01-05T14:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291847",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:19 mathzeta2]:
> Following the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/X0a-ENF6LNk), here are two minor remarks:
> One can use Python's [itertools.chain](https://docs.python.org/3/library/itertools.html#itertools.chain) or [chain.from_iterable](https://docs.python.org/3/library/itertools.html#itertools.chain.from_iterable) where appropriate. For example:


Done.

> > 14. `partial_sums`: is there are a particular reason to write `B = dict((r, sum(self.mu[a] for a in A[r:])) for r in A)` instead of `B = {r: sum(self.mu[a] for a in A[r:]) for r in A)`?
> >
> I think the number of additions is quadratic, where it can be linear. Creating such partial sums with linear number of additions has many implementations: [itertools.accumulate](https://docs.python.org/3/library/itertools.html#itertools.accumulate), [numpy.cumsum](https://numpy.org/doc/1.21/reference/generated/numpy.cumsum.html#numpy.cumsum), and not long ago I discovered that Sage have the function [running_total](https://doc.sagemath.org/html/en/reference/misc/sage/misc/misc_c.html#sage.misc.misc_c.running_total). If this is premature optimization (e.g. the size of `A` is always small), then please ignore.

Yes, indeed the size of `A` is small compared to everything else. Nevertheless I gave it a try. One would need something like

```diff
-        B = {r: sum(self.mu[a] for a in A[r:]) for r in A}
+        B = dict(zip(reversed(A), accumulate(self.mu[r] for r in reversed(A))))
```

which makes it much less readable, so rejected this change.



---

archive/issue_comments_291848.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-05T14:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291848",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_291849.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-01-06T15:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291849",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_291850.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-06T16:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291850",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291851.json:
```json
{
    "body": "Thank you, I reviewed the changes and added a few reviewer commits (sorry for messing up the history on trac here by mistyping my branch name; the last five commits are new).\n\nReplying to [comment:23 dkrenn]:\n> Replying to [comment:18 cheuberg]:\n> > 8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.\n> \n> Changed. However, I am not fully convinced that this rewriting made it that much better/easier to read as hoped; nevertheless, it think it made it somehow easier to understand what is going on. The loop over i, for sure, needed to be pulled out, even without the change to block matrices.\n\nI propose another variant in branch `u/cheuberg/21325-variant` (not linked to this ticket) where I try to avoid padding and indices.\n\nThe essential lines are\n\n```python\n        kernel = list(b)\n\n        zero_M = self.mu[0].parent().zero()\n        zero_R = self.right.parent().zero()\n        # Let v(n) = self.__getitem__(n, multiply_left=False)\n        rule = {}\n        # We will construct `kernel` and `rule` in such a way that for all\n        # c in `kernel`,\n        #     rule[r, c] = (f, d)\n        # holds for some 0 <= f < r and some d in `kernel` such that\n        #     v(a(kn+r)+c) [a(kn+r) +c >= 0] = mu[f] v(an+d) [an+d >= 0].\n\n        ci = 0\n        while ci < len(kernel):\n            c = kernel[ci]\n            for r in A:\n                # We now compute the contributions of v(an+c)[an >= 0] to\n                # the linear representation by using\n                #   v(a(kn+r)+c) [a(kn+r)+c >= 0]\n                #   = v(kan+ar+c) [kan+ar+c >= 0]\n                #   = v(k(an+d)+f) [an+d >= 0]\n                #   = mu[f] v(an+d) [an+d >= 0].\n                d, f = (a*r + c).quo_rem(k)\n                if d not in kernel:\n                    kernel.append(d)\n                rule[r, c] = (d, f)\n            ci += 1\n\n        def matrix_row(r, c):\n            d, f = rule[r, c]\n            return [self.mu[f] if d == j else zero_M for j in kernel]\n\n        result = P.element_class(\n            P,\n            {r: Matrix.block([matrix_row(r, c) for c in kernel])\n             for r in A},\n            vector(chain.from_iterable(\n                b.get(c, 0)*self.left\n                for c in kernel)),\n            vector(chain.from_iterable(\n                (self.__getitem__(c, multiply_left=False) if c >= 0 else zero_R)\n                for c in kernel)))\n```\n\n\n> > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> \n> Ok.\n\nI propose to remove or amend the comment.\n\n> > 16. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.\n> \n> Agreed; changed.\n> \n> Do we mind, that now the output of the linear representation sometimes is a displayed as block matrix? I guess not...\n\nI do not mind.\n\n> > 20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.\n> \n> I agree that this should be done on a follow-up ticket.\n\nOk. Let us just keep it on this list for the moment.",
    "created_at": "2022-01-06T16:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291851",
    "user": "https://github.com/cheuberg"
}
```

Thank you, I reviewed the changes and added a few reviewer commits (sorry for messing up the history on trac here by mistyping my branch name; the last five commits are new).

Replying to [comment:23 dkrenn]:
> Replying to [comment:18 cheuberg]:
> > 8. `subsequence`: I think that the code could be simplified by constructing the matrices of the new linear representation as block matrices in terms of the original matrices. For instance, the loop over `i in srange(dim)` and then extracting the `i`-th row of `self.mu[f]` could be omitted (with the additional benefit of not computing `d` and `f` in `mu_line` for all values of `i`); the index computation `(di*dim)*(0,)` in `pad` could be replaced by taking the zero matrix of the parent of `self.mu[f]` (or create that zero matrix once, instead of the current `zero`), `ndim` would be unnecessary.
> 
> Changed. However, I am not fully convinced that this rewriting made it that much better/easier to read as hoped; nevertheless, it think it made it somehow easier to understand what is going on. The loop over i, for sure, needed to be pulled out, even without the change to block matrices.

I propose another variant in branch `u/cheuberg/21325-variant` (not linked to this ticket) where I try to avoid padding and indices.

The essential lines are

```python
        kernel = list(b)

        zero_M = self.mu[0].parent().zero()
        zero_R = self.right.parent().zero()
        # Let v(n) = self.__getitem__(n, multiply_left=False)
        rule = {}
        # We will construct `kernel` and `rule` in such a way that for all
        # c in `kernel`,
        #     rule[r, c] = (f, d)
        # holds for some 0 <= f < r and some d in `kernel` such that
        #     v(a(kn+r)+c) [a(kn+r) +c >= 0] = mu[f] v(an+d) [an+d >= 0].

        ci = 0
        while ci < len(kernel):
            c = kernel[ci]
            for r in A:
                # We now compute the contributions of v(an+c)[an >= 0] to
                # the linear representation by using
                #   v(a(kn+r)+c) [a(kn+r)+c >= 0]
                #   = v(kan+ar+c) [kan+ar+c >= 0]
                #   = v(k(an+d)+f) [an+d >= 0]
                #   = mu[f] v(an+d) [an+d >= 0].
                d, f = (a*r + c).quo_rem(k)
                if d not in kernel:
                    kernel.append(d)
                rule[r, c] = (d, f)
            ci += 1

        def matrix_row(r, c):
            d, f = rule[r, c]
            return [self.mu[f] if d == j else zero_M for j in kernel]

        result = P.element_class(
            P,
            {r: Matrix.block([matrix_row(r, c) for c in kernel])
             for r in A},
            vector(chain.from_iterable(
                b.get(c, 0)*self.left
                for c in kernel)),
            vector(chain.from_iterable(
                (self.__getitem__(c, multiply_left=False) if c >= 0 else zero_R)
                for c in kernel)))
```


> > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> 
> Ok.

I propose to remove or amend the comment.

> > 16. `partial_sums` I think that using `block_matrix([[B[0], -B[r-1]], [Z, self.mu[r]]])` would be more readable than constructing the block matrix via `stack` and `augment`; I do not think that reusing the same first block column in all matrices is worth the effort.
> 
> Agreed; changed.
> 
> Do we mind, that now the output of the linear representation sometimes is a displayed as block matrix? I guess not...

I do not mind.

> > 20. The methods `partial_sums` and the difference methods are mostly inverse to each other. It would be nice to check the obvious relations between these methods (as well as the shift methods from 19) using a random k-regular sequence. See also the discussion on [sage-devel](https://groups.google.com/g/sage-devel/c/3rOts1PjynU/m/vR5VMqmgAQAJ) concerning testing of random elements. This is probably something for a follow-up because equality checking would be useful.
> 
> I agree that this should be done on a follow-up ticket.

Ok. Let us just keep it on this list for the moment.



---

archive/issue_comments_291852.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-06T16:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291852",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_291853.json:
```json
{
    "body": "Replying to [comment:29 cheuberg]:\n> Thank you, I reviewed the changes and added a few reviewer commits\n\nLGTM, thank you.\n\n> I propose another variant in branch `u/cheuberg/21325-variant` (not linked to this ticket) where I try to avoid padding and indices.\n> \n> The essential lines are [...]\n\nLGTM, so merged in for this ticket.\n\n> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> > \n> > Ok.\n> \n> I propose to remove or amend the comment.\n\nShould the `f` in `-|b| \\le f \\le max(a, |b|)` be a `d`?\n----\nNew commits:",
    "created_at": "2022-01-07T09:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291853",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:29 cheuberg]:
> Thank you, I reviewed the changes and added a few reviewer commits

LGTM, thank you.

> I propose another variant in branch `u/cheuberg/21325-variant` (not linked to this ticket) where I try to avoid padding and indices.
> 
> The essential lines are [...]

LGTM, so merged in for this ticket.

> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> > 
> > Ok.
> 
> I propose to remove or amend the comment.

Should the `f` in `-|b| \le f \le max(a, |b|)` be a `d`?
----
New commits:



---

archive/issue_comments_291854.json:
```json
{
    "body": "Replying to [comment:31 dkrenn]:\n> Replying to [comment:29 cheuberg]:\n> > > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> > > \n> > > Ok.\n> > \n> > I propose to remove or amend the comment.\n> \n> Should the `f` in `-|b| \\le f \\le max(a, |b|)` be a `d`?\n\nYes. Sorry.",
    "created_at": "2022-01-08T09:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291854",
    "user": "https://github.com/cheuberg"
}
```

Replying to [comment:31 dkrenn]:
> Replying to [comment:29 cheuberg]:
> > > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> > > 
> > > Ok.
> > 
> > I propose to remove or amend the comment.
> 
> Should the `f` in `-|b| \le f \le max(a, |b|)` be a `d`?

Yes. Sorry.



---

archive/issue_comments_291855.json:
```json
{
    "body": "Replying to [comment:32 cheuberg]:\n> Replying to [comment:31 dkrenn]:\n> > Should the `f` in `-|b| \\le f \\le max(a, |b|)` be a `d`?\n> Yes. Sorry.\n\nCan you explain how you come to this estimate? (I am asking, because from the line `d, f = (a*r + c).quo_rem(k)`, I only get a weaker upper bound)",
    "created_at": "2022-01-09T15:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291855",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:32 cheuberg]:
> Replying to [comment:31 dkrenn]:
> > Should the `f` in `-|b| \le f \le max(a, |b|)` be a `d`?
> Yes. Sorry.

Can you explain how you come to this estimate? (I am asking, because from the line `d, f = (a*r + c).quo_rem(k)`, I only get a weaker upper bound)



---

archive/issue_comments_291856.json:
```json
{
    "body": "Replying to [comment:33 dkrenn]:\n> Replying to [comment:32 cheuberg]:\n> > Replying to [comment:31 dkrenn]:\n> > > Should the `f` in `-|b| \\le f \\le max(a, |b|)` be a `d`?\n> > Yes. Sorry.\n> \n> Can you explain how you come to this estimate? (I am asking, because from the line `d, f = (a*r + c).quo_rem(k)`, I only get a weaker upper bound)\n\nSorry for the noise, fine for me now; I understand.",
    "created_at": "2022-01-09T15:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291856",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:33 dkrenn]:
> Replying to [comment:32 cheuberg]:
> > Replying to [comment:31 dkrenn]:
> > > Should the `f` in `-|b| \le f \le max(a, |b|)` be a `d`?
> > Yes. Sorry.
> 
> Can you explain how you come to this estimate? (I am asking, because from the line `d, f = (a*r + c).quo_rem(k)`, I only get a weaker upper bound)

Sorry for the noise, fine for me now; I understand.



---

archive/issue_comments_291857.json:
```json
{
    "body": "Replying to [comment:29 cheuberg]:\n> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> > \n> > Ok.\n> \n> I propose to remove or amend the comment.\n\nComment removed now.",
    "created_at": "2022-01-09T15:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291857",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:29 cheuberg]:
> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> > 
> > Ok.
> 
> I propose to remove or amend the comment.

Comment removed now.



---

archive/issue_comments_291858.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-09T15:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291858",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_291859.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-09T15:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291859",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291860.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-12T16:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291860",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291861.json:
```json
{
    "body": "Replying to [comment:29 cheuberg]:\n> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> > \n> > Ok.\n> \n> I propose to remove or amend the comment.\n\nI have now amended a comment. Please have a look.",
    "created_at": "2022-01-12T16:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291861",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:29 cheuberg]:
> > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> > 
> > Ok.
> 
> I propose to remove or amend the comment.

I have now amended a comment. Please have a look.



---

archive/issue_comments_291862.json:
```json
{
    "body": "Replying to [comment:38 dkrenn]:\n> Replying to [comment:29 cheuberg]:\n> > > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \\le f \\le max(a, |b|)` always holds which implies termination.\n> > > \n> > > Ok.\n> > \n> > I propose to remove or amend the comment.\n> \n> I have now amended a comment. Please have a look.\n\nThank you, LGTM.\n\nThe docbuild failure of the patchbot seems to be unrelated.",
    "created_at": "2022-01-15T06:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291862",
    "user": "https://github.com/cheuberg"
}
```

Replying to [comment:38 dkrenn]:
> Replying to [comment:29 cheuberg]:
> > > > 10. `subsequence`: I am not so sure about the comment on the various ranges (and consequently, the tests testing that the range of `c` is large enough): It seems that no predefined range is used (anymore?), everything is generated dynamically. The only thing which actually matters is termination of the procedure, and if I am not mistaken, then `-|b| \le f \le max(a, |b|)` always holds which implies termination.
> > > 
> > > Ok.
> > 
> > I propose to remove or amend the comment.
> 
> I have now amended a comment. Please have a look.

Thank you, LGTM.

The docbuild failure of the patchbot seems to be unrelated.



---

archive/issue_comments_291863.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-15T06:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291863",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291864.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2022-01-17T07:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291864",
    "user": "https://github.com/cheuberg"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_291865.json:
```json
{
    "body": "While reviewing #32921, I had one more look at this ticket, and found one more item to discuss.\n\n21. I think that the last commits here removed all usage of the new function `pad_right` introduced in this ticket, so we might as well delete that function.",
    "created_at": "2022-01-17T07:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291865",
    "user": "https://github.com/cheuberg"
}
```

While reviewing #32921, I had one more look at this ticket, and found one more item to discuss.

21. I think that the last commits here removed all usage of the new function `pad_right` introduced in this ticket, so we might as well delete that function.



---

archive/issue_comments_291866.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-23T16:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291867.json:
```json
{
    "body": "Replying to [comment:40 cheuberg]:\n> 21. I think that the last commits here removed all usage of the new function `pad_right` introduced in this ticket, so we might as well delete that function.\n\nRemoved.",
    "created_at": "2022-01-23T16:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291867",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:40 cheuberg]:
> 21. I think that the last commits here removed all usage of the new function `pad_right` introduced in this ticket, so we might as well delete that function.

Removed.



---

archive/issue_comments_291868.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-01-23T16:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291868",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_291869.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-24T10:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291869",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291870.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-31T23:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21088#issuecomment-291870",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_019980.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-31T23:31:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21088",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21088#event-19980"
}
```
