# Issue 28787: spkg-configure.m4 for singular

Issue created by migration from https://trac.sagemath.org/ticket/29024

Original creator: mkoeppe

Original creation time: 2020-01-16 01:50:10

CC:  dimpase fbissey slelievre isuruf mjo @tobiasdiez arojas @dkwo

This ticket adds an `spkg-configure.m4` for `singular`.

For singular, the location of the dynamic variable needs to be communicated to the sage runtime, either by adding to `src/bin/sage-env-config.in` or (with #29022) to `src/sage/env_config.py.in`. See also #29013.


---

Comment by mkoeppe created at 2020-01-16 03:08:03

Which versions of singular are good?


---

Comment by @mwageringel created at 2020-01-16 07:59:08

Replying to [comment:1 mkoeppe]:
> Which versions of singular are good?

Sage does not currently work correctly with any version of Singular, see #25993.


---

Comment by dimpase created at 2020-01-16 11:16:29

well, Debian does have a Singular version which is compatible with their Sage package (v8.6 or so, I guess).


---

Comment by mkoeppe created at 2020-01-16 16:00:15

Thanks for the info. I'll check back when #25993 is done.


---

Comment by @thierry-FreeBSD created at 2020-04-16 12:32:09

This ticket should be listed in #27330 (ATM singular is listed in "No Tickets yet").


---

Comment by mkoeppe created at 2020-04-16 13:42:33

Replying to [comment:5 gh-thierry-FreeBSD]:
> This ticket should be listed in #27330 (ATM singular is listed in "No Tickets yet").
I've added it


---

Comment by dimpase created at 2020-04-16 14:55:17

Changing component from packages: standard to build: configure.


---

Attachment

spkg-configure.m4 to be put under /build/pkgs/singular/


---

Comment by @thierry-FreeBSD created at 2020-04-17 16:04:40

[Copying elements from #29024]

- my 1st problem was a build failure with Singular taken from an external package: to solve it, Singular must be built `--with-ntl`: it would be fine to add this check to `spkg-configure.m4` (but I do not know how!)

- my 2nd error was when building dochtml: `NameError: Singular library 'freegb.lib' not found`. To solve it, `src/sage/env.py` and `src/bin/sage-env` must be modified so that `SINGULARPATH` is set to singlar's share dir (and not `SAGE_SHARE` / `DESTDIR`), and `SINGULAR_EXECUTABLE` is set to the real Singular and not under the `DESTDIR` directory.

Now it is OK for me (on FreeBSD).


---

Comment by dimpase created at 2020-09-11 16:44:42

the error message

```
        raise RuntimeError(
            "libSingular not found--a working Singular install in $SAGE_LOCAL "
            "is required for Sage to work")
```

should be modified, too.
Perhaps just remove `in $SAGE_LOCAL `


---

Comment by mkoeppe created at 2020-09-11 16:50:59

Moving this ticket forward is great, but note that it is unrelated to the build problem on homebrew reported on sage-devel... and it is also unlikely that the homebrew version of singular actually works for us (homebrew does not like to patch).

As I explained in https://groups.google.com/d/msg/sage-devel/KXK_zxzfhIQ/RO3FryYWAwAJ, on the reporter's system the computed order of `-I` options is wrong -- something that I was not able reproduce on my system.


---

Comment by dimpase created at 2020-09-11 17:15:48

Replying to [comment:8 gh-thierry-FreeBSD]:
> [Copying elements from #29024]
> 
> - my 1st problem was a build failure with Singular taken from an external package: to solve it, Singular must be built `--with-ntl`: it would be fine to add this check to `spkg-configure.m4` (but I do not know how!)
> 
> - my 2nd error was when building dochtml: `NameError: Singular library 'freegb.lib' not found`. To solve it, `src/sage/env.py` and `src/bin/sage-env` must be modified so that `SINGULARPATH` is set to singlar's share dir (and not `SAGE_SHARE` / `DESTDIR`), and `SINGULAR_EXECUTABLE` is set to the real Singular and not under the `DESTDIR` directory.
> 
> Now it is OK for me (on FreeBSD).

The fix in [SageMath](SageMath) needs some programming - specifically, the code in singular.pyx calls dlopen on SINGULAR_SO,
which is computed by _get_shared_lib_filename dynamically in env.py, and assuming that it is in SAGE_LOCAL.
So this probably can instead by handled using cython_aliases from the same module (which does compute
all the needed info for Singular, it seems).
Or by fixing _get_shared_lib_filename so that it also searches elsewhere.


---

Comment by mkoeppe created at 2020-09-11 17:23:49

Is it known whether this comment added in 2009 to singular.pyx is still valid:

```
    This initializes the SINGULAR library. This is a hack to some
    extent.

    SINGULAR has a concept of compiled extension modules similar to
    Sage. For this, the compiled modules need to see the symbols from
    the main program. However, SINGULAR is a shared library in this
    context these symbols are not known globally. The work around so
    far is to load the library again and to specify ``RTLD_GLOBAL``.
```



---

Comment by dimpase created at 2020-09-11 17:38:19

Someone working on innards of Singular might know.
(I'd be surprised if it was changed).

Singular is not alone - this hack is also applied to libgap.
I'm inclined to fix `_get_shared_lib_filename` so that it can accept other libdirs, not only
SAGE_LOCAL/lib


---

Attachment


---

Comment by mkoeppe created at 2020-09-12 02:17:41

Replying to [comment:16 dimpase]:
> I'm inclined to fix `_get_shared_lib_filename` so that it can accept other libdirs, not only
> SAGE_LOCAL/lib

Yes, this function certainly would need changing if we continue to use it. 
For example, `sysconfig.get_config_var('LIBDIR')` gives a directory of the system python, not of the current venv.

But I think better solution would be to wrap loading of modules that are linked to singular by [sys.setdlopenflags](https://docs.python.org/3/library/sys.html#sys.setdlopenflags).

This is what pytorch does when it has to use RTLD_GLOBAL (see https://github.com/pytorch/pytorch/blob/master/torch/__init__.py#L132)


---

Comment by mkoeppe created at 2020-09-12 02:32:04

Same at https://github.com/tensorflow/tensorflow/blob/9590c4c32dd4346ea5c35673336f5912c6072bf2/tensorflow/python/pywrap_dlopen_global_flags.py
and https://github.com/tensorflow/tensorflow/blob/9590c4c32dd4346ea5c35673336f5912c6072bf2/tensorflow/python/pywrap_tensorflow.py


---

Comment by mkoeppe created at 2020-09-12 02:55:12

I have opened #30561 for this


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-05-27 22:12:26

With #31642 taking us to a released version of Singular, it is time to work on an `spkg-configure.m4` for using system singular.  Arch already has the latest version (https://repology.org/project/singular/versions)


---

Comment by mjo created at 2021-07-18 22:17:26

The `SINGULARPATH` is being used to find the singular's docdir so that sage can manually parse its GNU info file and retrieve the docstring for Singular functions.

Currently the help file is mis-named (https://github.com/Singular/Singular/issues/1107), but even so, there's a much more reliable way to get this information without parsing the file ourselves (and therefore, without `SINGULARPATH`):


```
$ info "(singular.hlp)align" | tail -n+2

5.1.1 align
-----------

`*Syntax:*'
     `align (' vector_expression, int_expression `)'
     `align (' module_expression, int_expression `)'

`*Type:*'
     type of the first argument

`*Purpose:*'
     maps module generators `gen(i)' to `gen(i+s)' for all i.

`*Example:*'
            ring r=0,(x,y,z),(c,dp);
            align([1,2,3],3);
          ==> [0,0,0,1,2,3]
            align([0,0,1,2,3],-1);
          ==> [0,1,2,3]
            align(freemodule(2),1);
          ==> _[1]=[0,1]
          ==> _[2]=[0,0,1]

```



---

Comment by mjo created at 2021-07-19 04:03:31

This branch is only half-baked, but it already eliminates problems 2, 3, and 4 from the description at the cost of requiring GNU Info to be installed.

Can the first issue be avoided as well? Why are we using `dlopen` to load `SINGULAR_SO` instead of just linking to it?


---

Comment by mkoeppe created at 2021-07-19 04:08:16

Replying to [comment:32 mjo]:
> Why are we using `dlopen` to load `SINGULAR_SO` instead of just linking to it?
See #30561


---

Comment by mjo created at 2021-08-19 13:14:24

Changing status from new to needs_review.


---

Comment by mjo created at 2021-08-19 13:14:24

I've left the `dlopen()` alone because I don't feel like trying to eliminate it. This branch uses autoconf to find out the extension of shared libraries on the system (`SHLIBEXT`), and then tries to `dlopen("libSingular.$SHLIBEXT")`. If it works, we use the system copy, and use the same `dlopen()` strategy in `singular.pyx`. Otherwise we fall back to the SPKG and pass the full `SAGE_LOCAL` path to `dlopen()`. Works well enough on Gentoo.
----
New commits:


---

Comment by dimpase created at 2021-08-20 09:00:20

by the way, why there is no hint for `pkgconfig` in `build/pkgs/pkgconfig/distros/gentoo.txt` (and for many other obvious distros)?

I only notices as Gentoo's `emerge` was telling be about the switch to `dev-util/pkgconf`.


---

Comment by dimpase created at 2021-08-20 10:09:50

OK, what's this:

```
[dochtml] make doc-inventory--Bug
[dochtml] cd /mnt/opt/Sage/sage-dev && ./sage --docbuild --no-pdf-links Bug inventory 
[dochtml] Bug >>Could not get expanded executable from "libSingular.so"<< at feResource.cc:434
[dochtml] 'Bug' is not a recognized document. Type 'sage --docbuild -D' for a list
[dochtml] of documents, or 'sage --docbuild --help' for more help.
[dochtml] make[5]: *** [Makefile:20: doc-inventory--Bug] Error 1
```

also, 

```
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4.rc2, Release Date: 2021-08-12                 │
│ Using Python 3.8.9. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Bug >>Could not get expanded executable from "libSingular.so"<< at feResource.cc:434
sage: 2+2                                                                                                                            
4
sage:           
```



---

Comment by dimpase created at 2021-08-20 11:01:20

Can this be coming from Gentoo's Singular install? Weird.


---

Comment by mjo created at 2021-08-20 12:41:37

Replying to [comment:42 dimpase]:
> Can this be coming from Gentoo's Singular install? Weird.

Oh, right, I saw that too. Singular is trying to guess the path of its own executable and is failing. It doesn't hurt anything (that I noticed...), and is an upstream bug like the message says. I'll dig deeper as this gets closer to being merged and figure out what to report upstream.


---

Comment by mjo created at 2021-08-20 12:45:13

Replying to [comment:40 dimpase]:
> by the way, why there is no hint for `pkgconfig` in `build/pkgs/pkgconfig/distros/gentoo.txt` (and for many other obvious distros)?
> 
> I only notices as Gentoo's `emerge` was telling be about the switch to `dev-util/pkgconf`.

The Sage "pkgconfig" package is a python module and not the tool itself. There's nothing we can do with it yet, but eventually it's dev-python/pkgconfig.


---

Comment by mjo created at 2021-08-20 13:43:38

You can make the BUG warning go away with,


```
$ SINGULAR_BIN_DIR=$(dirname $(type -P Singular)) sage
```


but hopefully that is not needed long-term.


---

Comment by mjo created at 2021-08-20 18:33:03

Upstream bug: https://github.com/Singular/Singular/issues/1113


---

Comment by mkoeppe created at 2021-08-20 22:56:45

Replying to [comment:44 mjo]:
> The Sage "pkgconfig" package is a python module and not the tool itself. There's nothing we can do with it yet, but eventually it's dev-python/pkgconfig.

`build/pkgs/pkgconf/distros` also does not have an entry for gentoo (and neither for arch)


---

Comment by mkoeppe created at 2021-08-20 23:22:52

`build/pkgs/singular/distros` looks like it needs more entries for some distributions


---

Comment by mjo created at 2021-08-20 23:28:12

Replying to [comment:47 mkoeppe]:
> Replying to [comment:44 mjo]:
> > The Sage "pkgconfig" package is a python module and not the tool itself. There's nothing we can do with it yet, but eventually it's dev-python/pkgconfig.
> 
> `build/pkgs/pkgconf/distros` also does not have an entry for gentoo (and neither for arch)

You can't bootstrap without pkgconf and you would be hard-pressed to find a Gentoo machine without it (being source-based), but it certainly can't hurt. The message that Dima saw says that we are getting rid of the old implementation, so now there's only `dev-util/pkgconf` to put in gentoo.txt.


---

Comment by slelievre created at 2021-08-21 18:15:07

Here are Singular distro files for Arch Linux, Cygwin and Fedora.

Revert to your branch if those are not helping.
----
New commits:


---

Comment by mkoeppe created at 2021-08-21 20:13:21


```
-# As of 2021-03-20, build of homebrew's singular from source fails
+# [2021-03-20] building from source with Homebrew's singular fails
```

this rewording changes the meaning. What failed at this time was really the from-source build of the homebrew package (via `brew install -s`, or implied when using `brew` with a non-standard prefix)


---

Comment by git created at 2021-08-21 23:14:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-08-22 00:42:58

Replying to [comment:41 dimpase]:
> OK, what's this:
> {{{
> [dochtml] make doc-inventory--Bug
> }}}

This is likely caused by unexpected output (on stdout!) from the command `./sage --docbuild --all-documents reference`


---

Comment by mkoeppe created at 2021-08-28 01:33:15

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-09-10 14:54:04

We probably also need to do something with `SINGULARPATH`, a variable hold, if needed, paths to Singular's .lib files, something that may be installed by Sage's optional packages - it is done e.g. by `p_group_cohomology`. So to make the latter work with system-wide Singular one needs to export `SINGULARPATH=$SAGE_LOCAL/share/singular/LIB`.


---

Comment by mjo created at 2021-09-11 21:27:48

Replying to [comment:55 dimpase]:
> We probably also need to do something with `SINGULARPATH`, a variable hold, if needed, paths to Singular's .lib files, something that may be installed by Sage's optional packages - it is done e.g. by `p_group_cohomology`. So to make the latter work with system-wide Singular one needs to export `SINGULARPATH=$SAGE_LOCAL/share/singular/LIB`.

What we really need is a system for optional packages to set their own environment variables, so we don't have to set every possible environment variable (for an unknowable number of optional packages) in sage-env. Of course Gentoo and everyone else already figured this out 20 years ago. We can have sage-env source any files in `local/etc/env.d`, and then tell optional packages to install what they need (e.g. a script that exports `SINGULARPATH`) there.

I guess I will waste my time reimplementing that so that some day I can stop wasting my time rebuilding the same copy of singular that I already have installed.


---

Comment by mkoeppe created at 2021-09-11 21:54:34

Best to plan to move away from any such dependence on setting environment variables.

Instead, it should be set at runtime when initializing the singular interface / libsingular.


---

Comment by mkoeppe created at 2021-09-11 21:56:19

(see #30818, #21707)


---

Comment by mkoeppe created at 2021-09-11 22:07:18

In fact, do we actually install any custom Singular packages in `SAGE_LOCAL/share/singular/LIB`? I don't think we do.

`src/sage/rings/function_field/function_field.py` uses the correct approach -- it loads its custom Singular library using a fully qualified path to the library, which is just in the installed package data of the Sage library.

If the `p_group_cohomology` Sage code relies on `SINGULARPATH`, it should be changed so it uses the same approach.


---

Comment by dimpase created at 2021-09-12 08:08:45

Replying to [comment:59 mkoeppe]:
> In fact, do we actually install any custom Singular packages in `SAGE_LOCAL/share/singular/LIB`? I don't think we do.

Not sure what "we" is here, but
`p_group_cohomology` does install a custom Singular lib, called `dickson.lib`,
and it ends up in `$SAGE_LOCAL/share/singular/LIB`, as `spkg-install` has

```
sdh_install singular_helper/dickson.lib "$SAGE_SHARE/singular/LIB/"
```

- which is fine if Singular is built by Sage, but not with the external Singular.

> 
> `src/sage/rings/function_field/function_field.py` uses the correct approach -- it loads its custom Singular library using a fully qualified path to the library, which is just in the installed package data of the Sage library.
> 
> If the `p_group_cohomology` Sage code relies on `SINGULARPATH`, it should be changed so it uses the same approach.

It doesn't rely on `SINGULARPATH` is seems to me. `SINGULARPATH` can be used by Singular,
and system-wide Singular  doesn't know about `$SAGE_LOCAL/share/singular/LIB`, obviously, unless something is done.

Should `p_group_cohomology` be using `$SAGE_SHARE/singular/LIB/` to install `dickson.lib`, or some
other location?

Regarding `src/sage/ext_data/singular/function_field/core.lib`,  one sees

```
            from sage.env import SAGE_EXTCODE
            lib(SAGE_EXTCODE + '/singular/function_field/core.lib')
```

but

```
$ find . -name core.lib
./pkgs/sagemath-standard/build/lib.linux-x86_64-3.8/sage/ext_data/singular/function_field/core.lib
./src/sage/ext_data/singular/function_field/core.lib
./local/lib/python3.8/site-packages/sage/ext_data/singular/function_field/core.lib
```

so it also gets installed into site-packages. Is it a bug?


---

Comment by mkoeppe created at 2021-09-12 08:23:50

Replying to [comment:60 dimpase]:
> Regarding `src/sage/ext_data/singular/function_field/core.lib`,  one sees
> {{{
>             from sage.env import SAGE_EXTCODE
>             lib(SAGE_EXTCODE + '/singular/function_field/core.lib')
> }}}
> but
> {{{
> $ find . -name core.lib
> ./pkgs/sagemath-standard/build/lib.linux-x86_64-3.8/sage/ext_data/singular/function_field/core.lib
> ./src/sage/ext_data/singular/function_field/core.lib
> ./local/lib/python3.8/site-packages/sage/ext_data/singular/function_field/core.lib
> }}}
> so it also gets installed into site-packages.

`core.lib` is `package_data` of the distribution package `sagemath-standard`.
As such it gets installed alongside the Python files, in `site-packages`.

This works as designed.


---

Comment by mkoeppe created at 2021-09-12 08:27:48

Replying to [comment:60 dimpase]:
> Replying to [comment:59 mkoeppe]:
> > In fact, do we actually install any custom Singular packages in `SAGE_LOCAL/share/singular/LIB`? I don't think we do.
> 
> Not sure what "we" is here

... any package in the Sage distribution ...

> Should `p_group_cohomology` be using `$SAGE_SHARE/singular/LIB/` to install `dickson.lib`, or some
> other location?

As I said, this should be changed to follow the same model as `src/sage/ext_data/singular/function_field/core.lib`


---

Comment by mkoeppe created at 2021-09-12 08:30:41

Is there any code that actually loads `dickson.lib`?


---

Comment by dimpase created at 2021-09-12 10:13:16

Replying to [comment:63 mkoeppe]:
> Is there any code that actually loads `dickson.lib`? 

`sage  -t src/sage/tests/modular_group_cohomology.py` will trigger loading it, if `p_group_cohomology` is installed.


---

Comment by dimpase created at 2021-09-12 10:40:46

Replying to [comment:62 mkoeppe]:
> Replying to [comment:60 dimpase]:
> > Replying to [comment:59 mkoeppe]:
> > > In fact, do we actually install any custom Singular packages in `SAGE_LOCAL/share/singular/LIB`? I don't think we do.
> > 
> > Not sure what "we" is here
> 
> ... any package in the Sage distribution ...
> 
> > Should `p_group_cohomology` be using `$SAGE_SHARE/singular/LIB/` to install `dickson.lib`, or some
> > other location?
> 
> As I said, this should be changed to follow the same model as `src/sage/ext_data/singular/function_field/core.lib`

I've opened https://github.com/sagemath/p_group_cohomology/issues/5 for this


---

Comment by mkoeppe created at 2021-09-12 16:58:53

As `p_group_cohomology` is broken since Sage 9.4 anyway (https://github.com/sagemath/p_group_cohomology/issues/4), I think we can proceed here on the ticket without worrying about `SINGULARPATH`.


---

Comment by dimpase created at 2021-09-14 14:54:01

So are we waiting for the upstream fix here, or proceed with making sure that

```
export SINGULAR_BIN_DIR=$(dirname $(type -P Singular))
```

is added at the correct place?


---

Comment by mjo created at 2021-09-14 16:32:12

I think we'll have to add it. Upstream started to work on the issue but we're nowhere near having a complete fix in a released version of Singular. The BUG warning is harmless I think; but if we don't hide it, we're going to have to deal with a million bug reports about it.

I'll add the workaround and create a ticket to remove it whenever the fix is in an upstream release.


---

Comment by mjo created at 2021-09-14 16:43:10

Actually, I just looked at the upstream issue and see that I missed a notification about a new commit. Let me go test it. We may still want to add the workaround for a few months until a new release is made and distros catch up.


---

Comment by mkoeppe created at 2021-09-14 17:02:25

Replying to [comment:67 dimpase]:
> So are we waiting for the upstream fix here, or proceed with making sure that
> {{{
> export SINGULAR_BIN_DIR=$(dirname $(type -P Singular))
> }}}
> is added at the correct place?

Can we put this environment setting in `src/sage/libs/singular/singular.pyx` (`init_libsingular`)?


---

Comment by mjo created at 2021-09-15 01:56:10

Replying to [comment:70 mkoeppe]:
> Replying to [comment:67 dimpase]:
> > So are we waiting for the upstream fix here, or proceed with making sure that
> > {{{
> > export SINGULAR_BIN_DIR=$(dirname $(type -P Singular))
> > }}}
> > is added at the correct place?
> 
> Can we put this environment setting in `src/sage/libs/singular/singular.pyx` (`init_libsingular`)? 

Both `type -P` and `command -v` are shell built-ins on my system, making them a bit hard to use from python code. Does putting it in sage-env cause a problem I've overlooked, or are you just thinking it would be more appropriate in `init_singular()`? I don't disagree -- but considering that this is a temporary workaround, it might just be easier to add the one line in sage-env instead of the python code to launch a full-blown shell and parse its output.


---

Comment by mkoeppe created at 2021-09-15 02:06:33

Replying to [comment:71 mjo]:
> Does putting it in sage-env cause a problem I've overlooked

Yes, we are working on making sage pip-installable and importable into normal Python environments (`import sage.all`), and for this depending on `sage-env` needs to be removed


---

Comment by mkoeppe created at 2021-09-15 02:07:36

Replying to [comment:71 mjo]:
> temporary workaround
Well, versions of singular that need this workaround may be in relevant distributions for years...


---

Comment by mkoeppe created at 2021-09-15 02:10:03

And I think this just https://docs.python.org/3/library/shutil.html#shutil.which


---

Comment by mjo created at 2021-09-15 02:27:00

Replying to [comment:74 mkoeppe]:
> And I think this just https://docs.python.org/3/library/shutil.html#shutil.which

Yep, here's an untested branch. It's going to take me all night to rebuild sage after the rebase but I'll make sure it works in the morning. And report back to upstream... that last commit looks strange to me.
----
New commits:


---

Comment by mjo created at 2021-09-15 13:40:01

It works.


---

Comment by mkoeppe created at 2021-09-15 19:51:32

Ready for review?


---

Comment by mjo created at 2021-09-15 20:09:09

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-09-15 20:51:05

This will need a GH Actions run


---

Comment by dimpase created at 2021-09-16 08:42:02

I've started https://github.com/sagemath/sagetrac-mirror/actions/runs/1240853423


---

Comment by mkoeppe created at 2021-09-18 02:17:14

Doesn't accept singular on `cygwin-standard` (https://github.com/mkoeppe/sage/runs/3625055086)

```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG singular...
checking whether any of gmp mpir ntl flint readline mpfr cddlib is installed as or will be installed as SPKG... no
checking for Singular... /usr/bin/Singular
checking for SINGULAR... no
checking if we can dlopen(libSingular.dll)... configure: no suitable system package found for SPKG singular
```



---

Comment by mkoeppe created at 2021-09-18 02:21:03

Works OK on `archlinux-latest-standard` (https://github.com/mkoeppe/sage/runs/3625059112)

```
----------------------------------------------------------------------------
Checking whether SageMath should install SPKG singular...
checking whether any of gmp mpir ntl flint readline mpfr cddlib is installed as or will be installed as SPKG... no
checking for Singular... /usr/sbin/Singular
checking for SINGULAR... yes
checking if we can dlopen(libSingular.so)... configure: will use system package and not install SPKG singular
```


(but looks like an `AC_MSG_RESULT` is missing)


---

Comment by mkoeppe created at 2021-09-18 02:24:21

Also OK (as expected) on `gentoo-standard`

No luck on `debian`, `fedora`, and `homebrew` because of the `cddlib` dependency. It works correctly but does not accept system singular.


---

Comment by mjo created at 2021-09-18 03:28:10

Replying to [comment:82 mkoeppe]:
> Doesn't accept singular on `cygwin-standard` (https://github.com/mkoeppe/sage/runs/3625055086)

I think that's expected, since it has an older version of Singular than the pkg-config test looks for.


---

Comment by git created at 2021-09-18 03:36:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-18 04:06:32

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-18 17:39:49

Actually this needs more work on Cygwin:
https://github.com/mkoeppe/sage/runs/3638292833?check_suite_focus=true

```
./sage -t -p --all --logfile=logs/ptest.log
no stored timings available
Running doctests with ID 2021-09-18-08-09-52-cb78f982.
Git branch: HEAD
Using --optional=build,cygwin,dochtml,pip,sage,sage_spkg
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 4363 files using 3 threads.
Traceback (most recent call last):
  File "/cygdrive/d/a/sage/sage/src/bin/sage-runtests", line 144, in <module>
    err = DC.run()
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/doctest/control.py", line 1207, in run
    self.run_doctests()
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/doctest/control.py", line 904, in run_doctests
    self.dispatcher = DocTestDispatcher(self)
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/doctest/forker.py", line 1624, in __init__
    init_sage(controller)
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/doctest/forker.py", line 192, in init_sage
    controller.load_environment()
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/doctest/control.py", line 525, in load_environment
    return import_module(self.options.environment)
  File "/usr/lib/python3.8/importlib/__init__.py", line 127, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
  File "<frozen importlib._bootstrap>", line 1014, in _gcd_import
  File "<frozen importlib._bootstrap>", line 991, in _find_and_load
  File "<frozen importlib._bootstrap>", line 975, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 671, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 848, in exec_module
  File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/repl/ipython_kernel/all_jupyter.py", line 5, in <module>
    from sage.all_cmdline import *
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/all_cmdline.py", line 19, in <module>
    from sage.all import *
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/all.py", line 141, in <module>
    from sage.rings.all      import *
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/rings/all.py", line 83, in <module>
    from .polynomial.all import *
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/rings/polynomial/all.py", line 42, in <module>
    from sage.rings.polynomial.laurent_polynomial_ring import LaurentPolynomialRing
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/rings/polynomial/laurent_polynomial_ring.py", line 50, in <module>
    from sage.rings.polynomial.laurent_polynomial import LaurentPolynomial_mpair, LaurentPolynomial_univariate
  File "sage/rings/polynomial/laurent_polynomial.pyx", line 1, in init sage.rings.polynomial.laurent_polynomial (build/cythonized/sage/rings/polynomial/laurent_polynomial.c:40817)
  File "sage/matrix/matrix0.pyx", line 28, in init sage.matrix.matrix0 (build/cythonized/sage/matrix/matrix0.c:44570)
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/modules/free_module.py", line 167, in <module>
    import sage.matrix.matrix_space
  File "/opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/python3.8/site-packages/sage/matrix/matrix_space.py", line 55, in <module>
    from . import matrix_mpolynomial_dense
  File "sage/matrix/matrix_mpolynomial_dense.pyx", line 1, in init sage.matrix.matrix_mpolynomial_dense (build/cythonized/sage/matrix/matrix_mpolynomial_dense.cpp:8666)
  File "sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 1, in init sage.rings.polynomial.multi_polynomial_libsingular (build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:49840)
  File "sage/libs/singular/singular.pyx", line 808, in init sage.libs.singular.singular (build/cythonized/sage/libs/singular/singular.cpp:11287)
  File "sage/libs/singular/singular.pyx", line 785, in sage.libs.singular.singular.init_libsingular (build/cythonized/sage/libs/singular/singular.cpp:8697)
ImportError: cannot load Singular library from /opt/sage-032178416da49f83f86c3b8ce2797134fbb97bd8/lib/libSingular.dll (b'No such file or directory')
make: *** [Makefile:233: ptest-nodoc] Error 1
```


Note that on cygwin, dlls are installed in `bin/`, not in `lib/`


---

Comment by mkoeppe created at 2021-09-18 17:39:49

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-09-20 01:43:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-09-20 02:00:23

I think that will fix it. I thought about eliminating `SINGULAR_LIB_BASE` entirely, but I can't say for sure that we won't encounter a platform where `dlopen()` does not search the library path, so I've left it in and invented a way to reference the libdir.

The hacks in sage_conf are starting to pile up, so I've opened #32540 with a proposal to refactor things.


---

Comment by mjo created at 2021-09-20 02:00:23

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-09-20 02:55:18

Have you tested this on Cygwin?


---

Comment by mkoeppe created at 2021-09-20 03:19:11

Asking because the situation with DLLs on Cygwin is not really related to anything "LIBDIR". Only the naked DLLs end up in `bin/` on the platform, but `lib/` is still used for `.a` and `.dll.a` files


---

Comment by dimpase created at 2021-09-20 09:48:36

Homebrew's Singular needs some fixes; 1st of all,

```diff
--- a/.homebrew-build-env
+++ b/.homebrew-build-env
@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH
 LIBRARY_PATH="$HOMEBREW/lib$LIBRARY_PATH"
 [ -z "$CPATH" ] || CPATH=":${CPATH}"
 CPATH="$HOMEBREW/include$CPATH"
-for l in readline bzip2 ntl; do
+for l in readline bzip2 ntl singular; do
     if [ -d "$HOMEBREW/opt/$l/lib" ]; then
         LIBRARY_PATH="$HOMEBREW/opt/$l/lib:$LIBRARY_PATH"
     fi
```


Then, it appears that `dlopen()` call in `singular.pyx` needs a full path to .dylib on macOS.
(it might be a Cython bug, or the plarform limitation, I don't know).
That is, if I make sure that

```
SINGULAR_LIB_BASE = "/usr/local/opt/singular/lib/libSingular"
```

in `sage_conf.py` then everything works. I am not sure how to achieve the latter automatically. 
One way might be to export a special env. var. in  `.homebrew-build-env` and use it to set up the proper
`SINGULAR_LIB_BASE` in `spkg-configure.m4` - but there could be a better way.


---

Comment by dimpase created at 2021-09-20 09:50:14

Once the latter is fixed, we should apply

```diff
--- a/build/pkgs/singular/distros/homebrew.txt
+++ b/build/pkgs/singular/distros/homebrew.txt
@@ -1,5 +1 @@
-# [2021-03-20] Homebrew's Singular can be built from source
-# (via `brew install -s`, or implied when using `brew` with
-# a non-standard prefix), but that currently fails.
-
-#singular
+singular
```



---

Comment by arojas created at 2021-09-20 11:23:49

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2021-09-20 11:23:49

This breaks distro installs without `sage_conf`. Please keep the old `_get_shared_lib_path` code path as a fallback in case `sage_conf` gives an `ImportError`.


---

Comment by dimpase created at 2021-09-20 12:01:44

Replying to [comment:95 arojas]:
> This breaks distro installs without `sage_conf`. Please keep the old `_get_shared_lib_path` code path as a fallback in case `sage_conf` gives an `ImportError`.

Do distros use env. vars from `env.py`? (That's where the change was, the env. var. there is not computed any more.


---

Comment by arojas created at 2021-09-20 12:05:11

Replying to [comment:96 dimpase]:
> Replying to [comment:95 arojas]:
> > This breaks distro installs without `sage_conf`. Please keep the old `_get_shared_lib_path` code path as a fallback in case `sage_conf` gives an `ImportError`.
> 
> Do distros use env. vars from `env.py`? (That's where the change was, the env. var. there is not computed any more.
> 

Yes, `env.py` is part of sagelib. Actually, a simple fallback to `SINGULAR_LIB_PATH="libSingular.so"` would be fine for me (if any distro modifies the default library name, I guess it's their job to patch sage accordingly or provide a custom sage_conf)


---

Comment by mjo created at 2021-09-20 12:15:58

Replying to [comment:92 mkoeppe]:
> Asking because the situation with DLLs on Cygwin is not really related to anything "LIBDIR". Only the naked DLLs end up in `bin/` on the platform, but `lib/` is still used for `.a` and `.dll.a` files 

No, I haven't tested yet. I'll have to run it on GH.

Even if $libdir isn't being used... at some point, the build system is deciding to put those dlls into a $directory, and $directory=bin on cygwin while $directory=lib everywhere else, no? I don't suppose you know where that decision is made?


---

Comment by mjo created at 2021-09-20 12:31:57

Replying to [comment:93 dimpase]:
> Then, it appears that `dlopen()` call in `singular.pyx` needs a full path to .dylib on macOS.
> (it might be a Cython bug, or the plarform limitation, I don't know).

This was a conscious choice, as da802ef now makes explicit. POSIX doesn't say what will happen if you use a filename without a path in `dlopen()`, so the SPKG is still used as a fallback on systems where it doesn't work.

There are a couple options to improve this, of varying difficulty:

* We could try to get the libdir from Singular itself. The `feResource.cc` file provides a bunch of other configuration information, but not the bare libdir at the moment. We could provide a patch upstream that lets us obtain its libdir. (However, the cygwin discussion is suggesting that libdir may not always be the right place?)
* We can eliminate the `dlopen()`, if possible. We already link directly to libSingular and that's easy to do portably with `-lSingular`. I'm not entirely sure why `dlopen()` is needed, but the `init_libsingular()` documentation says

```python
"""                                                                                                                                                                      
This initializes the SINGULAR library. This is a hack to some                                                                                                            
extent.                                                                                                                                                                  
                                                                                                                                                                             
SINGULAR has a concept of compiled extension modules similar to                                                                                                          
Sage. For this, the compiled modules need to see the symbols from                                                                                                        
the main program. However, SINGULAR is a shared library in this                                                                                                          
context these symbols are not known globally. The work around so                                                                                                         
far is to load the library again and to specify ``RTLD_GLOBAL``.                                                                                                         
"""
```

* We can invent some hacks that guess the right location on most of the platforms we support.


---

Comment by dimpase created at 2021-09-20 12:43:16

Replying to [comment:98 mjo]:

> Even if $libdir isn't being used... at some point, the build system is deciding to put those dlls into a $directory, and $directory=bin on cygwin while $directory=lib everywhere else, no? I don't suppose you know where that decision is made?

I think it has to do with cygwin fork() design, Windows address space, rebasing... DLL needs to get a fixed memory address allocation, for fork() to work), and so `bin/` is what's beging scanned by the corresponding Cygwin utility `rebaseall`.

Not running away screaming yet?


---

Comment by dimpase created at 2021-09-20 12:56:45

Replying to [comment:99 mjo]:
> Replying to [comment:93 dimpase]:
> > Then, it appears that `dlopen()` call in `singular.pyx` needs a full path to .dylib on macOS.
> > (it might be a Cython bug, or the plarform limitation, I don't know).
> 
> This was a conscious choice, as da802ef now makes explicit. POSIX doesn't say what will happen if you use a filename without a path in `dlopen()`, so the SPKG is still used as a fallback on systems where it doesn't work.

This does not explain why no-full-path `dlopen()` succeeds in the test

```
configure:40299: checking if we can dlopen(libSingular.dylib)
configure:40330: gcc -o conftest -g -O2   -Ddarwin -I/usr/local/opt/gmp/include  -I/usr/local/Cellar/ecl/21.2.1/include  conftest.c -lmpfi -lmpc -lnauty -lglpk -lpari -lncurses -lcurl -lcddgmp -lbz2 -larb -lflint -lmpfr -lgmp -lm  -lntl  -lppl -lgmpxx -lgmp -ldl >&5
configure:40330: $? = 0
configure:40330: ./conftest
configure:40330: $? = 0
configure:40333: result: yes
```


but fails in `singular.pyx`.


---

Comment by mjo created at 2021-09-20 13:07:24

Replying to [comment:100 dimpase]:
> Replying to [comment:98 mjo]:
> 
> > Even if $libdir isn't being used... at some point, the build system is deciding to put those dlls into a $directory, and $directory=bin on cygwin while $directory=lib everywhere else, no? I don't suppose you know where that decision is made?
> 
> I think it has to do with cygwin fork() design, Windows address space, rebasing... DLL needs to get a fixed memory address allocation, for fork() to work), and so `bin/` is what's beging scanned by the corresponding Cygwin utility `rebaseall`.
> 
> Not running away screaming yet?

Is that an option? Can I wrap the whole thing in `if [ $(whoami) = "mjo" ]`?

The rebaseall thing makes some amount of sense to me (I used cygwin back when Windows XP was around), but I'm still not sure exactly when the dlls either get installed directly to bin, or moved from lib to bin.


---

Comment by mjo created at 2021-09-20 13:12:20

Replying to [comment:101 dimpase]:
> 
> This does not explain why no-full-path `dlopen()` succeeds in the test... but fails in `singular.pyx`.
> 

Oh, no. That's interesting. What error message does it give you?


---

Comment by dimpase created at 2021-09-20 13:22:52

Replying to [comment:103 mjo]:
> Replying to [comment:101 dimpase]:
> > 
> > This does not explain why no-full-path `dlopen()` succeeds in the test... but fails in `singular.pyx`.
> > 
> 
> Oh, no. That's interesting. What error message does it give you?

```
...
--> 808 init_libsingular()
...
    782     handle = dlopen(lib, RTLD_GLOBAL|RTLD_LAZY)
    783     if not handle:
    784         err = dlerror()
--> 785         raise ImportError(f"cannot load Singular library from {SINGULAR_LIB_PATH} ({err})")
        global ImportError = undefined
    786 
    787     # load SINGULAR
    788     siInit(lib)
    789 
...
ImportError: cannot load Singular library from libSingular.dylib (b'dlopen(libSingular.dylib, 9): image not found')
```


I tried setting LD_LIBRARY_PATH or DYLD_FALLBACK_LIBRARY_PATH (cf. Apple's manpage on dlopen()), to no effect.

PS. related reading https://developer.apple.com/forums/thread/13161 sounds as if Apple broke the latter stuff in the name of "security"...


---

Comment by mjo created at 2021-09-20 14:24:40

The cygwin magic happens in `libtool.m4`:


```sh
cygwin* | mingw* | pw32* | cegcc*)
...
  # DLL is installed to $(libdir)/../bin by postinstall_cmds                                                                                                               
  postinstall_cmds='base_file=`basename \$file`~
    dlpath=`$SHELL 2>&1 -c '\''. $dir/'\''\$base_file'\''i; echo \$dlname'\''`~
    dldir=$destdir/`dirname \$dlpath`~
    test -d \$dldir || mkdir -p \$dldir~
    $install_prog $dir/$dlname \$dldir/$dlname~
    chmod a+x \$dldir/$dlname~
    if test -n '\''$stripme'\'' && test -n '\''$striplib'\''; then
      eval '\''$striplib \$dldir/$dlname'\'' || exit \$?;
    fi'
```


I guess I'll just undo the last few commits and special-case `cygwin*`.


---

Comment by dimpase created at 2021-09-20 14:51:15

As far as I know, on Cygwin dlopen() looks up things in `$PATH` rather than `$LD_...`, so this appears to be good as it is, no?

Although Conda and macOS still need an action.


---

Comment by git created at 2021-09-20 14:52:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-09-20 14:54:13

On cygwin the SPKG will always be used because its Singular is too old. But even that was failing, because the absolute path involving "lib" was wrong. It should be fixed now.

Remaining questions:

1. Do I need to use "cygSingular" as the library name on Cygwin?
2. WTF is happening on macOS?


---

Comment by dimpase created at 2021-09-20 15:38:21

Replying to [comment:108 mjo]:
> On cygwin the SPKG will always be used because its Singular is too old.
I've asked for an update: https://cygwin.com/pipermail/cygwin/2021-September/249449.html

> But even that was failing, because the absolute path involving "lib" was wrong. It should be fixed now.
> 
> Remaining questions:
> 
> 1. Do I need to use "cygSingular" as the library name on Cygwin?
Yes, I think so. 

> 2. WTF is happening on macOS?
I suppose we need to supply the full path to DLL (.e.g. .dylib), via an env. var in `.homebrew-build-env` and forget about it.
(Not sure about Conda).

One discrepancy I noticed is that that singular.pyx is compiled as C++,
while the test in spkg-configure is done with plain C; I tried with C++, saw no difference.


---

Comment by dimpase created at 2021-09-20 17:24:15

Homebrew fix
----
New commits:


---

Comment by mkoeppe created at 2021-09-20 17:41:39

This is not a good change.

```
--- a/.homebrew-build-env
+++ b/.homebrew-build-env
@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH
 LIBRARY_PATH="$HOMEBREW/lib$LIBRARY_PATH"
 [ -z "$CPATH" ] || CPATH=":${CPATH}"
 CPATH="$HOMEBREW/include$CPATH"
-for l in readline bzip2 ntl; do
+for l in readline bzip2 ntl singular; do
     if [ -d "$HOMEBREW/opt/$l/lib" ]; then
         LIBRARY_PATH="$HOMEBREW/opt/$l/lib:$LIBRARY_PATH"
     fi
```

Adding to LIBRARY_PATH is only needed for "keg-only" packages.
`singular` is a regular package, linked into `/usr/local`.

```
@@ -45,3 +45,5 @@ for l in gettext; do
     fi
 done
 export ACLOCAL_PATH
+SINGULAR_HOMEBREW_LIBDIR="$HOMEBREW/opt/singular/lib/"
+export SINGULAR_HOMEBREW_LIBDIR
```

Pretty sure you can find the information you need during configure using `pkg-config`.


---

Comment by dimpase created at 2021-09-20 18:21:56

Indeed, we can instead call `PKG_CHECK_VAR([SINGULAR_LIBDIR], [Singular], [libdir])` to get `SINGULAR_LIBDIR`.
I suppose, to be on the safe side we should prepend it to `SINGULAR_LIB_BASE` unconditionally, not only on macOS.


---

Comment by git created at 2021-09-20 19:32:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-09-20 19:39:29

I was working on this at the same time =(

https://git.sagemath.org/sage.git/commit/?h=u/mjo/ticket/29024&id=5a494d5a6b96949c5744239a0c8f866f3c2d9ac2

I've simplified the variables a bit, so the "base" and extension are no longer separate. I also added the special-case for cygwin into the system-singular code branch.


---

Comment by git created at 2021-09-21 19:11:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-21 19:12:41

Replying to [comment:114 mjo]:
> I was working on this at the same time =(
> 
> https://git.sagemath.org/sage.git/commit/?h=u/mjo/ticket/29024&id=5a494d5a6b96949c5744239a0c8f866f3c2d9ac2
> 
> I've simplified the variables a bit, so the "base" and extension are no longer separate. I also added the special-case for cygwin into the system-singular code branch.

I'll try to merge your improvements


---

Comment by dimpase created at 2021-09-27 16:07:14

there is also #32549 removing `mpir` spkg, so `mpir` should disappear in `spkg-config.m4`


---

Comment by git created at 2021-10-01 11:47:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-10-14 09:54:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-10-14 09:59:45

so what's exactly is different in functionality in the current ticket branch, `u/dimpase/ticket/29024` vs 
`u/mjo/ticket/29024` ?


---

Comment by mjo created at 2021-10-14 12:39:25

Now that we're just asking pkg-config for the correct location, the two variables `SINGULAR_LIB_BASE` and `SINGULAR_LIB_FILE` are redundant. (The "base" variable would be left empty in the past to let `dlopen()` search for the library.) I think the main difference in my branch is that I've refactored things to use only a single variable, `LIBSINGULAR_PATH`. The rest should be cosmetic.


---

Comment by dimpase created at 2021-10-14 20:31:57

you do non-nested calls where they can and should be nested. slows down `./configure` for no reason.


---

Comment by mjo created at 2021-10-14 22:37:31

Replying to [comment:125 dimpase]:
> you do non-nested calls where they can and should be nested. slows down `./configure` for no reason.

I find the logic much easier to understand when the "else" branch of a test is not separated from the test by an entire page. Ideally I would be able to put something like `return;` after each `sage_spkg_install_singular=yes`, but I don't know of a reliable way to accomplish that.

Running "make" takes many hours, so an extra second or two on systems without Singular didn't seem like a huge problem. And those of us who work on the build system and run `./configure` repeatedly should be clever enough to install it. But I could still nest them if that's a deal-breaker for you.


---

Comment by dimpase created at 2021-10-18 08:46:00

Replying to [comment:126 mjo]:
> Replying to [comment:125 dimpase]:
> > you do non-nested calls where they can and should be nested. slows down `./configure` for no reason.
> 
> I find the logic much easier to understand when the "else" branch of a test is not separated from the test by an entire page. 

Do some coding in Lisp, then, for the training purposes ;-)

> Ideally I would be able to put something like `return;` after each `sage_spkg_install_singular=yes`, but I don't know of a reliable way to accomplish that.
> 
> Running "make" takes many hours, so an extra second or two on systems without Singular didn't seem like a huge problem. And those of us who work on the build system and run `./configure` repeatedly should be clever enough to install it. But I could still nest them if that's a deal-breaker for you.

Also, nesting makes sure that the output in case of errors is meaningful - it just errors on the 1st failing place, and that's it.


---

Comment by dimpase created at 2021-10-18 09:03:28

I'm willing to review a branch with nesting - or, you can review my branch...


---

Comment by mjo created at 2021-10-19 01:30:57

Here it is fully nested. I cherry-picked your fix for `fedora.txt`, but I left "gmp" in the DEPCHECK because it's easier to just list them all than it is to try to keep track of which DEPCHECKs need to be modified when e.g. mpfr loses a dependency.
----
Last 10 new commits:


---

Comment by mjo created at 2021-10-19 01:30:57

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-19 09:27:50

`build/pkgs/singular/distros/homebrew.txt` should be like in my branch:

```diff
--- a/build/pkgs/singular/distros/homebrew.txt
+++ b/build/pkgs/singular/distros/homebrew.txt
@@ -1,5 +1 @@
-# [2021-03-20] Homebrew's Singular can be built from source
-# (via `brew install -s`, or implied when using `brew` with
-# a non-standard prefix), but that currently fails.
-
-#singular
+singular
```



---

Comment by git created at 2021-10-19 11:18:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-10-19 14:59:19

lgtm


---

Comment by dimpase created at 2021-10-19 14:59:19

Changing status from needs_review to positive_review.


---

Comment by arojas created at 2021-10-19 16:02:04

comment:95 hasn't been addressed. This breaks `sage_conf`-less installs.


---

Comment by arojas created at 2021-10-19 16:02:04

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2021-10-19 16:17:40

Replying to [comment:133 arojas]:
> comment:95 hasn't been addressed. This breaks `sage_conf`-less installs.

Please open a followup ticket. It's not clear to me how or what exactly needs to be be fixed.


---

Comment by dimpase created at 2021-10-19 16:17:40

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2021-10-19 16:58:47

Replying to [comment:131 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[a3c5305](https://git.sagemath.org/sage.git/commit/?id=a3c53051a5961226700bdb8a40f831092f8dffcd)||`Trac #29024: re-enable the system singular hint on homebrew.`||

This needs testing on GH Actions.


---

Comment by mkoeppe created at 2021-10-19 16:58:47

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2021-10-19 17:01:21

needs _work_ ? On what exactly?


---

Comment by dimpase created at 2021-10-19 17:04:43

I suggest we run tests on the followup ticket for `sage_conf`-less installs.

The most one might need to adjust here is the list of distros on which this works.


---

Comment by arojas created at 2021-10-19 17:55:43

Replying to [comment:134 dimpase]:
> It's not clear to me how or what exactly needs to be be fixed.

This unconditionally imports `sage_conf` so it breaks on systems without it. As I said in comment:97 adding a simple fallback should fix it, here is a patch that works for me

```diff
diff --git a/src/sage/libs/singular/singular.pyx b/src/sage/libs/singular/singular.pyx
index ea6d0ab01d..8dfa490de5 100644
--- a/src/sage/libs/singular/singular.pyx
+++ b/src/sage/libs/singular/singular.pyx
@@ -768,7 +768,11 @@ cdef init_libsingular():
 
     cdef void *handle = NULL
 
-    from sage_conf import LIBSINGULAR_PATH
+    try:
+        from sage_conf import LIBSINGULAR_PATH
+    except ImportError:
+    # No sage_conf, assume everything is properly set up by the distro
+        LIBSINGULAR_PATH="libSingular.so"
     lib = str_to_bytes(LIBSINGULAR_PATH, FS_ENCODING, "surrogateescape")
 
     # This is a workaround for https://github.com/Singular/Singular/issues/1113
```



---

Comment by dimpase created at 2021-10-19 17:57:45

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-19 17:57:45

see https://github.com/sagemath/sagetrac-mirror/actions/runs/1360343429


---

Comment by mkoeppe created at 2021-10-19 18:00:46

Replying to [comment:138 arojas]:
> Replying to [comment:134 dimpase]:
> > It's not clear to me how or what exactly needs to be be fixed.
> 
> This unconditionally imports `sage_conf` so it breaks on systems without it. As I said in comment:97 adding a simple fallback should fix it, here is a patch that works for me
> {{{#!diff
> diff --git a/src/sage/libs/singular/singular.pyx b/src/sage/libs/singular/singular.pyx
> index ea6d0ab01d..8dfa490de5 100644
> --- a/src/sage/libs/singular/singular.pyx
> +++ b/src/sage/libs/singular/singular.pyx
> `@``@` -768,7 +768,11 `@``@` cdef init_libsingular():
>  
>      cdef void *handle = NULL
>  
> -    from sage_conf import LIBSINGULAR_PATH
> +    try:
> +        from sage_conf import LIBSINGULAR_PATH
> +    except ImportError:
> +    # No sage_conf, assume everything is properly set up by the distro
> +        LIBSINGULAR_PATH="libSingular.so"
>      lib = str_to_bytes(LIBSINGULAR_PATH, FS_ENCODING, "surrogateescape")
>  
>      # This is a workaround for https://github.com/Singular/Singular/issues/1113
> }}}


Actually this should be rewritten so that it goes through a variable declared in `sage.env` instead of using `sage_conf` directly.

`sage.env` already takes care of conditional import from `sage_conf`.


---

Comment by mkoeppe created at 2021-10-19 18:00:46

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-10-22 09:45:37

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-22 09:45:37

Please either propose a concrete patch, or move this over to a followup tiket.


---

Comment by @tobiasdiez created at 2021-10-22 10:25:27

I think what he means is that one should keep using `sage.env` instead of `sage_conf` here
https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mjo/ticket/29024#diff-25a6d752c56f179f8798c63d0938849853c5c6d61b21a171aae63bee0f6eb6cfL771-R773

I'm not sure about the conventions but for cblas pkgconfig is used in `sage.env` and not in in the spk_configure script, see https://github.com/sagemath/sage/blob/056b8d4e7bcdc936af39a33d3885925f1c850f80/src/sage/env.py#L401-L407. I guess the latter is more flexible as it would also work outside of sage's build environment, i.e. without LIBSINGULAR_PATH set.


---

Comment by dimpase created at 2021-10-22 10:43:13

This sounds more and more like "move this over to a followup ticket" --- for pkg-config and its generated files are a special can of worms to open.


---

Comment by git created at 2021-10-22 11:09:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-10-22 11:12:56

arojas, does this work?


---

Comment by arojas created at 2021-10-22 11:33:28

Replying to [comment:145 mjo]:
> arojas, does this work?

All good now. Thank you!


---

Comment by dimpase created at 2021-10-22 12:39:05

By the way, while trying to combine this and `u/mkoeppe/spkg_configure_m4_for_polymake`
on Arch I see some messages about conflicting BLAS for Polymake (BLAS) and Singular (OpenBLAS). Is this normal?


---

Comment by dimpase created at 2021-10-22 16:43:30

OK, good, thanks.


---

Comment by dimpase created at 2021-10-22 16:43:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-24 17:10:37

Replying to [comment:135 mkoeppe]:
> Replying to [comment:131 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[a3c5305](https://git.sagemath.org/sage.git/commit/?id=a3c53051a5961226700bdb8a40f831092f8dffcd)||`Trac #29024: re-enable the system singular hint on homebrew.`||
> 
> This needs testing on GH Actions.

In the cited commit, you removed the comment that explained why the `singular` package was not included on homebrew. Unless homebrew packaging of `singular` has changed in the meantime, this will break all of our automated tests on homebrew.

This is what would have needed testing.


---

Comment by mkoeppe created at 2021-10-24 17:18:33

Replying to [comment:144 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[f01ff1f](https://git.sagemath.org/sage.git/commit/?id=f01ff1f0f076fe550ffb6a6a657c5fda9dc0a023)||`Trac #29024: obtain LIBSINGULAR_PATH from sage.env instead of sage_conf.`||

Thanks for rewriting it "so that it goes through a variable declared in `sage.env` instead of using `sage_conf` directly", as suggested in comment:140.

This is exactly what I meant.


---

Comment by mkoeppe created at 2021-10-24 17:19:42

Replying to [comment:147 dimpase]:
> By the way, while trying to combine this and `u/mkoeppe/spkg_configure_m4_for_polymake`
> on Arch I see some messages about conflicting BLAS for Polymake (BLAS) and Singular (OpenBLAS). Is this normal?

What messages are these, and when are they issued?


---

Comment by mjo created at 2021-10-24 17:28:58

Replying to [comment:149 mkoeppe]:
> 
> In the cited commit, you removed the comment that explained why the `singular` package was not included on homebrew. Unless homebrew packaging of `singular` has changed in the meantime, this will break all of our automated tests on homebrew.
> 
> This is what would have needed testing.

The impetus for the last round of major changes was comment:93 which found that homebrew worked with some modification -- particularly using the full path to libSingular.


---

Comment by vbraun created at 2021-10-24 18:39:14

Resolution: fixed


---

Comment by mkoeppe created at 2021-10-24 20:03:38

Replying to [comment:152 mjo]:
> Replying to [comment:149 mkoeppe]:
> > 
> > In the cited commit, you removed the comment that explained why the `singular` package was not included on homebrew. Unless homebrew packaging of `singular` has changed in the meantime, this will break all of our automated tests on homebrew.
> > 
> > This is what would have needed testing.
> 
> The impetus for the last round of major changes was comment:93 which found that homebrew worked with some modification -- particularly using the full path to libSingular.

I don't have a comment on using the homebrew singular package; I haven't tested this ticket. 

The issue lies in *installing* the singular package on homebrew when a non-standard prefix (= not /usr/local) is in use -- which is what our testing workflows on GH Actions do.


---

Comment by dimpase created at 2021-10-24 20:25:32

using Homebrew with non-standard prefix is  not something the upstream is keen on supporting.


---

Comment by mkoeppe created at 2021-10-24 20:29:59

This is true, but for us it is a valuable mechanism to test homebrew configurations.


---

Comment by dimpase created at 2021-10-26 20:56:17

well, one ends up running into homebrew bugs for no good reason this way.

(I must say I looked at tox.ini and stuff in .github, and failed to see how this is done)


---

Comment by mkoeppe created at 2021-10-26 21:20:17

Let me explain the purpose in case it is really unclear: By using a local installation of homebrew, a developer can actually do testing against different homebrew package configurations without compromising the normal environment on one's machine that one uses for ... you know ... other work.


---

Comment by mkoeppe created at 2021-10-26 21:23:09

Replying to [comment:157 dimpase]:
> (I must say I looked at tox.ini and stuff in .github, and failed to see how this is done)

There are 2 lines around line 512 in tox.ini,
which just follow the instructions at https://docs.brew.sh/Installation


---

Comment by dimpase created at 2021-10-26 22:25:38

well, yes, what I don't understand is the purpose of having a nonstandard Homebrew location (as well as what this location actually is).


---

Comment by mjo created at 2021-10-26 23:21:43

Replying to [comment:154 mkoeppe]:
> 
> I don't have a comment on using the homebrew singular package; I haven't tested this ticket. 
> 
> The issue lies in *installing* the singular package on homebrew when a non-standard prefix (= not /usr/local) is in use -- which is what our testing workflows on GH Actions do.
> 

The homebrew docs pretty clearly say "Pick another prefix at your peril!"

If singular works well in a supported homebrew configuration, it's mean to hide the system package suggestion from everyone for the sake of an unsupported, non-user-facing test scenario.

Can't we add a `sed "/singular/d"` somewhere in that GH action, closer to where the problem originates, to fix it?


---

Comment by mkoeppe created at 2021-10-26 23:58:46

Yes, this is a solution that I would support.


---

Comment by dimpase created at 2021-10-28 09:45:25

On Debian 11 (a.k.a. bullseye, stable) Singular's libs have different names, and are failing to be picked up: they all are installed in `/usr/lib/x86_64-linux-gnu/` and we have the following: I add Sage's names next to their

```
Debian                             Sage

libsingular-factory.so             libfactory.so
libsingular-gfan.so                ???
libsingular-omalloc.so             libomalloc.so
libsingular-polys.so               libpolys.so
libsingular-resources.so           libsingular_resources.so
libsingular-Singular.so            libSingular.so            
```


While it's not hard to test for `libsingular-Singular.so` in place of `libSingular.so`, it's some more work to use it.

Library names may be obtained from `$ pkg-config --libs-only-l singular`, which on Debian produces

```
-lsingular-Singular -ldl -lsingular-polys -lntl -lgmp -ldl -lsingular-factory -lntl -lgmp -lsingular-omalloc -lsingular-resources
```


I suppose this needs a followup ticket.


---

Comment by mjo created at 2021-10-28 11:45:22

Replying to [comment:163 dimpase]:
> 
> While it's not hard to test for `libsingular-Singular.so` in place of `libSingular.so`, it's some more work to use it.
> 

File a bug? Sometimes, people are going to want to use non-debian packages on debian. The name of the library is libSingular, and that's what everyone will (and should) try to use. It's as fundamental to the API as anything can be.

There's probably a name conflict with some other library that is better avoided some other way, e.g. by having the two packages with conflicting files block each other. Or at the very least, by renaming only the problematic library. I doubt some other package is installing `libSingular.so`.


---

Comment by dimpase created at 2021-10-28 12:19:22

other packages may be installing `libfactory.so` - I guess they wanted to prefix all the libs produced by Singular with `singular-`.

bug report or not, knowing Debian pace it ought to be fixed regardless.


---

Comment by mjo created at 2021-10-29 00:42:23

Replying to [comment:165 dimpase]:
> other packages may be installing `libfactory.so` - I guess they wanted to prefix all the libs produced by Singular with `singular-`.
> 
> bug report or not, knowing Debian pace it ought to be fixed regardless.

Looks like a pre-emptive change:

https://sources.debian.org/src/singular/1:4.1.1-p2+ds-4/debian/patches/debianization-rename-libraries.patch/


---

Comment by mkoeppe created at 2021-10-29 02:39:31

I have opened #32789 for the follow up. 
I'd suggest to give up on trying to educate Debian on doing things in the same that Gentoo does. This is not a viable approach for our project.


---

Comment by jhpalmieri created at 2021-11-15 23:44:35

On an OS X machine I used `homebrew` to install `cddlib` (ignoring the comment in `build/pkgs/cddlib/distros/homebrew.txt`) and `singular`, and now Sage does not build them anymore. I get a related doctest failure, though:

```
File "src/sage/env.py", line 280, in sage.env._get_shared_lib_path
Failed example:
    fnmatch(str(lib_filename), pattern)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   8 in sage.env._get_shared_lib_path
    [47 tests, 1 failure, 2.57 s]
```

This is because `lib_filename` is defined by `lib_filename = _get_shared_lib_path("Singular", "singular-Singular")`, and on my machine it ends up being `None`. On other platforms that use an external Singular installation, how does this doctest pass?


---

Comment by dimpase created at 2021-11-16 00:35:49

could this be due to the path to `libsingular.dylib` not being added to `LIBRARY_PATH` in `.homebrew_env_config`?


---

Comment by mjo created at 2021-11-16 01:22:11

Replying to [comment:168 jhpalmieri]:
> On other platforms that use an external Singular installation, how does this doctest pass?

Accidentally, like anything that uses `_get_shared_lib_path`. It's not a good function. This doctest should be replaced with one that looks for libgap, since we no longer care if it can find libSingular (the full path to libSingular is contained in `LIBSINGULAR_PATH`). Since GAP  -- at least for the moment -- is guaranteed to come from our SPKG, an analogous test has some chance of passing.


---

Comment by mkoeppe created at 2021-11-16 01:22:57

Replying to [comment:169 dimpase]:
> could this be due to the path to `libsingular.dylib` not being added to `LIBRARY_PATH` in `.homebrew_env_config`?
`.homebrew-build-env` is for build time, not for run time


---

Comment by mjo created at 2021-11-16 01:30:47

Will fix it in #32880.


---

Comment by jhpalmieri created at 2021-11-16 03:59:53

Replying to [comment:172 mjo]:
> Will fix it in #32880.

Great, thank you.
