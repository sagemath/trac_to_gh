# Issue 12277: Improve the gamma function

Issue created by migration from https://trac.sagemath.org/ticket/12449

Original creator: bober

Original creation time: 2012-02-05 21:53:23

Assignee: bober

CC:  snark eviatarbach

Keywords: gamma function

There are numerical inaccuracies in the gamma function on python floats on some platforms. See, e.g. 
http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c

Also, the current implementation is slower than it should be on basic types:


```
sage: timeit('gamma(6.0r)')
625 loops, best of 3: 32 µs per loop
sage: timeit('gamma(6r)')
625 loops, best of 3: 44.3 µs per loop
sage: timeit('gamma(6.0)')
625 loops, best of 3: 22.9 µs per loop
sage: timeit('gamma(6)')
625 loops, best of 3: 3.29 µs per loop
```



---

Comment by bober created at 2012-02-08 00:06:24

Changing status from new to needs_review.


---

Comment by bober created at 2012-02-08 00:06:24

Changing component from basic arithmetic to symbolics.


---

Comment by burcin created at 2012-02-08 12:28:11

Changing status from needs_review to needs_work.


---

Comment by burcin created at 2012-02-08 12:28:11

Thanks for the patch. I agree that considering float and complex types separately in the fast evaluation path makes sense for speed. However, this causes inconsistencies with the results you get when a value is substituted into the expression.

We still need to modify the `py_tgamma()` function in `sage/symbolic/pynac.pyx` to fix this:


```
sage: gamma(x).subs(x=6.r)          
120.0
```


AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.

This would be a good occasion to merge my patch from attachment:trac_1173-move_call.patch:ticket:1173. I'll try to rebase your patch on top of that.


---

Comment by burcin created at 2012-02-08 12:45:48

Replying to [comment:2 burcin]:

> AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.

Sorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.

Regarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?


---

Comment by bober created at 2012-02-08 12:51:33

Replying to [comment:3 burcin]:
> Replying to [comment:2 burcin]:
> 
> > AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.
> 
> Sorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.
> 
> Regarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?

For the gamma function, at least, python has its own implementation. Of course, that function itself might call some underlying libc functions, so maybe it won't be entirely consistent, now that I think about it.

In the bit of testing that I did, math.gamma was less accurate than tgammal on my computer, but much more accurate than gsl's gamma function.


---

Comment by burcin created at 2012-02-13 11:08:57

Changing status from needs_work to needs_review.


---

Comment by burcin created at 2012-02-13 11:08:57

It turns out that Python implements the gamma function itself:

http://hg.python.org/cpython/file/58bd6a58365d/Modules/mathmodule.c#l226

I uploaded a new patch that changes `py_tgamma()` in `sage/symbolic/pynac.pyx` to use Python's gamma implementation.

I give a positive review to attachment:12449.patch. If someone can review my patch we can switch this to positive review.

BTW, this will fix #9162. We should close that as a duplicate.


---

Comment by burcin created at 2012-02-13 14:31:41

I uploaded a new version of my patch since the previous function had a typo that make doctests fail.


---

Comment by bober created at 2012-02-15 06:17:21

Well, I suppose that I will just go ahead and give it a positive review, since your changes are simple and orthogonal to mine (and I checked that all tests still pass on my machine). I would like to get some confirmation that this fixes things on ARM, but I suppose that we'll find that out eventually; that's a secondary point as far as this patch goes, though, so it isn't that important.


---

Comment by bober created at 2012-02-15 06:17:21

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-24 08:34:47

This should be rebased to #4498 + #12507 + #9130.


---

Comment by jdemeyer created at 2012-02-24 08:34:47

Changing status from positive_review to needs_work.


---

Comment by bober created at 2012-02-28 01:03:56

I've attached a patch rebased to 5.0-beta5. I had no problem applying the patches, so I just made sure all tests still pass.

Maybe I should just go ahead and put it back to positive review, but I'll give Burcin a day or so to take a look at it.


---

Comment by bober created at 2012-02-28 01:03:56

Changing status from needs_work to needs_review.


---

Comment by burcin created at 2012-02-28 07:57:07

Changing status from needs_review to positive_review.


---

Comment by burcin created at 2012-02-28 07:57:07

Looks good to me.


---

Comment by jdemeyer created at 2012-02-28 21:36:35

Rebasing to sage-5.0.beta5 isn't sufficient, since #9130 was only merged in sage-5.0.beta*6*.  So, this patch still needs an extra rebase.


---

Comment by jdemeyer created at 2012-02-28 21:36:35

Changing status from positive_review to needs_work.


---

Comment by bober created at 2012-02-28 23:11:53

Oops. I guess that explains why I didn't actually need to do anything to rebase. I'll try to remember to update this later today.


---

Comment by bober created at 2012-03-06 07:23:06

Changing status from needs_work to positive_review.


---

Comment by bober created at 2012-03-06 07:23:06

Ok, now it is rebased to 5.0beta7.


---

Comment by jdemeyer created at 2012-03-12 12:58:13

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-03-12 12:58:13

There is numerical noise.  On hawk (OpenSolaris 06.2009-32):

```
sage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx
Warning: divide by zero encountered in divide
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx", line 185:
    sage: cot(complex(1,2))
Expected:
    (0.03279775553375259-0.9843292264581908j)
Got:
    (0.03279775553375261-0.9843292264581911j)
**********************************************************************
sage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py
Warning: divide by zero encountered in divide
Warning: divide by zero encountered in divide
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py", line 543:
    sage: float(arccoth(2))
Expected:
    0.5493061443340548
Got:
    0.5493061443340549
**********************************************************************
```



---

Comment by jdemeyer created at 2012-03-12 13:00:31

On bsd (OS X 10.6 64-bit):

```
sage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py
Warning: divide by zero encountered in divide
Warning: divide by zero encountered in divide
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py", line 543:
    sage: float(arccoth(2))
Expected:
    0.5493061443340548
Got:
    0.5493061443340549
**********************************************************************
```



---

Comment by jdemeyer created at 2012-03-12 20:54:32

On iras (ia64):

```
sage -t  --long -force_lib devel/sage/sage/rings/arith.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py", line 3066:
    sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r
Expected:
    True
Got:
    False
**********************************************************************
```



---

Comment by Snark created at 2012-03-13 06:57:31

Replying to [comment:17 jdemeyer]:
> On iras (ia64):
> {{{
> sage -t  --long -force_lib devel/sage/sage/rings/arith.py
> **********************************************************************
> File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py", line 3066:
>     sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> }}}

Three remarks:
 1. that test is also one that is failing on ARM ; and there's a trac ticket about binomial's implementation being pretty wrong (#12448).
 2. should that test use "#tol abs" instead of doing the computation itself?
 3. shouldn't it be even a "#tol rel" ?


---

Comment by jdemeyer created at 2012-03-13 12:44:48

On cicero (Linux i386):

```
sage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx
Warning: divide by zero encountered in divide
**********************************************************************
File "/home/buildbot/build/sage/cicero-1/cicero_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx", line 185:
    sage: cot(complex(1,2))
Expected:
    (0.03279775553375259-0.9843292264581908j)
Got:
    (0.032797755533752596-0.9843292264581911j)
**********************************************************************
```



---

Comment by bober created at 2012-05-25 03:11:47

Changing status from needs_work to needs_review.


---

Comment by bober created at 2012-05-25 03:13:47

Ok, here is a version that should quiet those numerical errors. I'm leaving this as need review for the moment instead of putting it back to positive review in case someone wants to revisit the issue of whether or not we might want to make sure that we don't return different results on different machines.


---

Comment by jdemeyer created at 2012-05-25 05:07:52

I think it's better to use `RR` (= `RealField(53)`) or `CC` (=`ComplexField(53)`) instead of `RDF` or `CDF`.  That should give more consistent results.


---

Comment by dsm created at 2012-05-25 17:55:06

Missing "-":


```
            sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 
```



---

Comment by bober created at 2012-05-27 21:27:30

Replying to [comment:23 dsm]:
> Missing "-":
> 
> {{{
>             sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 
> }}}

Oops. That is fixed, and the 16 is changed to a 15, since 16 is actually too large, I think. I also took the opportunity to write a better commit message. 

Of course, I'm still not sure if this is the right way to do things.


---

Comment by bober created at 2012-05-31 22:28:47

Changing status from needs_review to positive_review.


---

Attachment

Ok, after a brief discussion at SD 40.5 (after Jeroen went to sleep and wasn't there to complain) I'm restoring this to positive review. A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.

I hope that all the tests actually pass now. Also, I've twice updated the patch to remove trailing whitespace, so I hope that I actually got it all this time.

(Of course, Jeroen will still have an opportunity to object...)


---

Comment by jdemeyer created at 2012-06-01 08:51:44

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-06-01 08:51:44

Replying to [comment:25 bober]:
> A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.

Obviously the following comment doesn't apply then:

```
# It is more accurate than gsl's gamma function and 
# should provide consistant results across platforms. 
```


Also: you should add tests for the infinity stuff that you added.


---

Comment by jdemeyer created at 2013-04-17 16:17:45

** ping **

The issues I mentioned in the last comment are fairly trivial.


---

Comment by rws created at 2015-02-02 15:05:06

The patch actually contains code that switches FP `sage_tgamma1` from GSL to `python_gamma` which might be a good thing, but requires a separate ticket. The timings are identical, so I suspect that the implementation might be too.


---

Comment by rws created at 2015-02-02 15:57:40

`@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?


---

Comment by rws created at 2015-02-02 15:58:00

Changing status from needs_work to needs_info.


---

Comment by jdemeyer created at 2015-02-02 16:37:16

Replying to [comment:34 rws]:
> `@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?
No, this overlaps a lot with #17130.


---

Comment by rws created at 2018-03-16 07:45:47

Changing status from needs_info to needs_review.


---

Comment by rws created at 2018-03-16 07:45:47

The original issue seems resolved:

```
sage: %timeit('exp(6.0r)')
100000000 loops, best of 3: 7.31 ns per loop
sage: %timeit('math.exp(6.0r)')
100000000 loops, best of 3: 7.28 ns per loop
```



---

Comment by embray created at 2018-08-14 17:43:26

Resolution: worksforme
