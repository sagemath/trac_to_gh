# Issue 30002: TensorField.__call__ alters zero

Issue created by migration from https://trac.sagemath.org/ticket/30239

Original creator: @mjungmath

Original creation time: 2020-07-28 13:46:07

CC:  egourgoulhon tscrim mkoeppe


```
sage: M = Manifold(3, 'M', start_index=1)
sage: X.<x,y,z> = M.chart()
sage: omega = M.diff_form(1, 'omega')
sage: omega[:] = [0, 0, 0]
sage: omega(X.frame()[1])
Scalar field omega(d/dx) on the 3-dimensional differentiable manifold M
M.zero_scalar_field()
Scalar field omega(d/dx) on the 3-dimensional differentiable manifold M
```



---

Comment by @mjungmath created at 2020-07-28 14:37:31

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2020-07-28 14:37:31

New commits:


---

Comment by egourgoulhon created at 2020-07-28 18:14:04

Changing status from needs_review to needs_work.


---

Comment by egourgoulhon created at 2020-07-28 18:14:04

Good catch!

However the proposed fix 

```
            if omega == 0 or vv == 0:
                return self.base_ring().zero()
```

is not acceptable, because the comparison with `0` can be very slow for complicated expressions. 
Also, this does not fix the root of the bug, which results from the `+=` operator acting on the zero element. It should be fixed per se, because it can lead to other errors.
FWIW, this bug was introduced in Sage 9.0 (everything is OK in earlier versions of Sage).


---

Comment by egourgoulhon created at 2020-07-28 18:15:05

Sorry the author name was deleted by mistake.


---

Comment by @mjungmath created at 2020-07-28 18:30:34

Replying to [comment:4 egourgoulhon]:
> Good catch!
> 
> However the proposed fix 
> {{{
>             if omega == 0 or vv == 0:
>                 return self.base_ring().zero()
> }}}
> is not acceptable, because the comparison with `0` can be very slow for complicated expressions. 

I was afraid that you say that. :D
I haven't found a fast check for components. Is there any?

> Also, this does not fix the root of the bug, which results from the `+=` operator acting on the zero element. It should be fixed per se, because it can lead to other errors.
> FWIW, this bug was introduced in Sage 9.0 (everything is OK in earlier versions of Sage). 

I suspect the root is #28562. However, the operator `+=` should not be a problem here. When two elements are added from which one is the zero element, the other element is returned. Due to ticket #28562, altering the components of the zero element is not even possible and would result in an error. The only thing happening here is that the zero element is renamed.


---

Comment by egourgoulhon created at 2020-07-30 18:26:48

Replying to [comment:7 gh-mjungmath]:
>
> I was afraid that you say that. :D
> I haven't found a fast check for components. Is there any?
>

No, `is_trivial_zero` is not implemented there. 

> > Also, this does not fix the root of the bug, which results from the `+=` operator acting on the zero element. It should be fixed per se, because it can lead to other errors.
> > FWIW, this bug was introduced in Sage 9.0 (everything is OK in earlier versions of Sage). 
> 
> I suspect the root is #28562. However, the operator `+=` should not be a problem here. When two elements are added from which one is the zero element, the other element is returned. Due to ticket #28562, altering the components of the zero element is not even possible and would result in an error. The only thing happening here is that the zero element is renamed.

You are right, `+=` is not the problem here. A way to fix the issue is then to check whether the computed result is the zero of the base ring (I guess by something like `resu is self._fmodule.base().zero()`), before changing its name at the end of the `__call__` method.


---

Comment by git created at 2020-07-30 19:31:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-07-30 19:31:41

What about this?


---

Comment by @mjungmath created at 2020-07-30 19:31:41

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-07-30 19:35:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-30 19:49:35

I think #30181 (Immutable elements of `FreeModuleTensor`) could provide a systematic solution


---

Comment by egourgoulhon created at 2020-07-30 21:09:36

Thanks for covering the case of `one()` as well. Seems OK to me. Waiting for the patchbot green light...


---

Comment by egourgoulhon created at 2020-07-31 20:45:20

Changing status from needs_review to needs_work.


---

Comment by egourgoulhon created at 2020-07-31 20:45:20

There is a doctest error in `src/sage/manifolds/differentiable/chart.py` and some pycodestyle error in `src/sage/tensor/modules/free_module_tensor.py`.


---

Comment by git created at 2020-08-01 14:10:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-01 14:11:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-01 23:03:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-01 23:22:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-08-01 23:22:53

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-08-02 09:25:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-08-02 09:27:24

Replying to [comment:14 egourgoulhon]:
> There is a doctest error in `src/sage/manifolds/differentiable/chart.py` and some pycodestyle error in `src/sage/tensor/modules/free_module_tensor.py`. 

Both have been fixed. Wait for green bot.


---

Comment by git created at 2020-08-02 09:50:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2020-08-03 08:46:20

LGTM. Waiting for a positive review of the dependency (#30266).


---

Comment by git created at 2020-08-03 22:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-08-03 23:02:57

What about `try...finally` instead of `try...except`? I think this should be even faster, right?


---

Comment by tscrim created at 2020-08-03 23:55:38

I doubt it. Plus it makes the code a little harder to understand IMO.


---

Comment by @mjungmath created at 2020-08-04 00:08:55

You're right, there is no difference. And I agree with you regarding the readability. I'll change it back.


---

Comment by git created at 2020-08-04 00:10:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-08-04 00:11:18

There we go.


---

Comment by git created at 2020-08-05 12:12:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-05 16:25:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-05 22:33:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @mjungmath created at 2020-08-05 22:52:04

Changing status from needs_review to needs_info.


---

Comment by @mjungmath created at 2020-08-05 22:52:04

Changing the doctest outputs, especially in `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst` left my aesthetic devil inside of me rebelling. A uniform output would be indeed nice.

If I remember correctly, our original argument for this behavior was that elements of modules/rings are usually treated immutable and that we should recover this behavior as far as possible. But thanks to Matthias with #30181, and the resulting changes in #30261, our elements are now undoubtfully viewed as mutable elements until they are stated immutable.

So, what about keeping the checks and always returning copies after each operation instead? This has also the great advantage that the results are again mutable (i.e. consistent behavior). Since we use fast checks that don't depend on particular elements now, this should also not affect the performance and would fit into the framework.

If we decide for the "return-copy-behavior", this ticket would become obsolete. Thus, I hope for a quick response so that I can work further on either one.


---

Comment by mkoeppe created at 2020-08-05 23:16:34

FWIW, `FreeModule` returns a mutable copy even on trivial operations such as `w = v + 0`, so implementing this behavior would be compatible.


---

Comment by @mjungmath created at 2020-08-06 07:39:20

Replying to [comment:37 mkoeppe]:
> FWIW, `FreeModule` returns a mutable copy even on trivial operations such as `w = v + 0`, so implementing this behavior would be compatible.

That's good to know. Thanks. Do you also have an opinion which behavior is more suitable?


---

Comment by @mjungmath created at 2020-08-06 10:00:32

I've opened another ticket #30302 for this discussion.


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
