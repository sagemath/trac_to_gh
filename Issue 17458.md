# Issue 17458: Slightly fasten is_cyclotomic()

Issue created by migration from Trac.

Original creator: bruno

Original creation time: 2015-01-30 10:55:24

CC:  chapoton

In `src/sage/rings/polynomial/polynomial_element.pyx`, the method `is_cyclotomic()` begins with checking the irreducibility of the input polynomial, and then checks the leading and constant coefficients. I simply propose to invert those tests to fasten a bit the test for polynomials that are not monic or whose constant coefficient is not `1`.


---

Comment by bruno created at 2015-01-30 13:38:39

Changing keywords from "" to "cyclotomic polynomials".


---

Comment by bruno created at 2015-01-30 13:38:39

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-01-30 15:56:41

Hello Bruno,

Actually, I discussed this with Karim Belabas in Bordeaux few weeks ago. We should either call Pari or stick to their implementation. It is much faster:

```
sage: p = cyclotomic_polynomial(150)
sage: pp = p._gp_()
sage: timeit("pp.poliscyclo()")
625 loops, best of 3: 697 µs per loop
sage: timeit("p.is_cyclotomic()")
125 loops, best of 3: 2.78 ms per loop
```

Moreover they do have the function `poliscycloprod` that checks if all roots are roots of unity (which is even faster).

Vincent


---

Comment by bruno created at 2015-01-31 13:29:17

Replying to [comment:3 vdelecroix]:
> Hello Bruno,
> 
> Actually, I discussed this with Karim Belabas in Bordeaux few weeks ago. We should either call Pari or stick to their implementation. It is much faster:
> {{{
> sage: p = cyclotomic_polynomial(150)
> sage: pp = p._gp_()
> sage: timeit("pp.poliscyclo()")
> 625 loops, best of 3: 697 µs per loop
> sage: timeit("p.is_cyclotomic()")
> 125 loops, best of 3: 2.78 ms per loop
> }}}
> Moreover they do have the function `poliscycloprod` that checks if all roots are roots of unity (which is even faster).
> 
> Vincent

It is not surprising indeed that Pari is faster for this. I don't understand what you mean by
> either call Pari or stick to their implementation.
Do you mean there are two ways to use Pari's implementation?


---

Comment by vdelecroix created at 2015-01-31 14:20:02

Replying to [comment:5 bruno]:
> Replying to [comment:3 vdelecroix]:
> It is not surprising indeed that Pari is faster for this. I don't understand what you mean by
> > either call Pari or stick to their implementation.
> Do you mean there are two ways to use Pari's implementation? 

Nope. Either we should copy their implementation within Sage (I do not think this is justified) or just call Pari.

And by the way there are two ways of using pari. Either with `gp` (this is a pexpect interface with a lot of latency in communication) and with `libpari` (which is very efficient in C). But sadly there is not yet `poliscyclo` and `poliscycloprod` in the libpari interface (i.e. in the file `libs/pari/gen.pyx`). I guess that we should wait for #17631 and not modify `gen.pyx` directly.

Vincent


---

Comment by chapoton created at 2015-02-02 13:49:44

A side remark:

I would like to have a certificate (something like : this is the cyclotomic polynomial Phi_20)

Is this allowed by the pari function ?


---

Comment by vdelecroix created at 2015-02-04 13:09:34

Replying to [comment:7 chapoton]:
> A side remark:
> 
> I would like to have a certificate (something like : this is the cyclotomic polynomial Phi_20)
> 
> Is this allowed by the pari function ?

Of course ;-) From pari documentation

```
poliscyclo(f): returns 0 if f is not a cyclotomic polynomial,
               and n > 0 if f = Phi_n, the n-th cyclotomic polynomial.
```


and you can already use it

```
sage: R.<x> = ZZ[]
sage: (x^2+x+1)._gp_().poliscyclo()
3
sage: (x^2-1)._gp_().poliscyclo()
0
```


Vincent


---

Comment by bruno created at 2015-02-04 13:56:01

Replying to [comment:6 vdelecroix]:
> Replying to [comment:5 bruno]:
> > Replying to [comment:3 vdelecroix]:
> > It is not surprising indeed that Pari is faster for this. I don't understand what you mean by
> > > either call Pari or stick to their implementation.
> > Do you mean there are two ways to use Pari's implementation? 
> 
> Nope. Either we should copy their implementation within Sage (I do not think this is justified) or just call Pari.
> 
> And by the way there are two ways of using pari. Either with `gp` (this is a pexpect interface with a lot of latency in communication) and with `libpari` (which is very efficient in C). But sadly there is not yet `poliscyclo` and `poliscycloprod` in the libpari interface (i.e. in the file `libs/pari/gen.pyx`). I guess that we should wait for #17631 and not modify `gen.pyx` directly.
> 
> Vincent


For concreteness, what do you propose to do now? If I understand correctly, you propose to wait for #17631 and then make `is_cyclotomic()` directly call the pari functions, and not introduce the tiny change I made? I am fine with that, just wanted to be sure!


---

Comment by vdelecroix created at 2015-02-04 14:17:07

Replying to [comment:9 bruno]:
> For concreteness, what do you propose to do now? If I understand correctly, you propose to wait for #17631 and then make `is_cyclotomic()` directly call the pari functions, and not introduce the tiny change I made? I am fine with that, just wanted to be sure!

For now, we can already do the thing I proposed with the gp interface (and return the certificate instead of `True`/`False`). And we can also add a `TODO` section in the documentation saying that we should move to the pari interface as soon as #17631 is ready.

Vincent


---

Comment by bruno created at 2015-02-04 14:32:13

Replying to [comment:10 vdelecroix]:
> Replying to [comment:9 bruno]:
> > For concreteness, what do you propose to do now? If I understand correctly, you propose to wait for #17631 and then make `is_cyclotomic()` directly call the pari functions, and not introduce the tiny change I made? I am fine with that, just wanted to be sure!
> 
> For now, we can already do the thing I proposed with the gp interface (and return the certificate instead of `True`/`False`). And we can also add a `TODO` section in the documentation saying that we should move to the pari interface as soon as #17631 is ready.

I am not sure to agree since it actually makes the function slower:

```python
sage: p = cyclotomic_polynomial(150)
sage: %timeit p.is_cyclotomic()
100 loops, best of 3: 2.75 ms per loop
sage: %timeit p._gp_().poliscyclo()
100 loops, best of 3: 3.96 ms per loop
```


As an aside, isn't it a problem for a method named `is_cyclotomic()` to return an integer rather than a boolean? Of course, the certificate is interesting to have, and one can still test with `is_cyclotomic()` as before. It is just that I expect a method `is_...()` to return a boolean. Maybe I am wrong...


---

Comment by vdelecroix created at 2015-02-04 15:42:22

Replying to [comment:11 bruno]:
> Replying to [comment:10 vdelecroix]:
> > Replying to [comment:9 bruno]:
> > > For concreteness, what do you propose to do now? If I understand correctly, you propose to wait for #17631 and then make `is_cyclotomic()` directly call the pari functions, and not introduce the tiny change I made? I am fine with that, just wanted to be sure!
> > 
> > For now, we can already do the thing I proposed with the gp interface (and return the certificate instead of `True`/`False`). And we can also add a `TODO` section in the documentation saying that we should move to the pari interface as soon as #17631 is ready.
> 
> I am not sure to agree since it actually makes the function slower:
> {{{#!python
> sage: p = cyclotomic_polynomial(150)
> sage: %timeit p.is_cyclotomic()
> 100 loops, best of 3: 2.75 ms per loop
> sage: %timeit p._gp_().poliscyclo()
> 100 loops, best of 3: 3.96 ms per loop
> }}}

Right. Most of the time seems to be lost in the conversion

```
sage: l = [cyclotomic_polynomial(i) for i in range(2,50)]
sage: timeit("for p in l: _ = p.is_cyclotomic()")
5 loops, best of 3: 51.7 ms per loop
sage: timeit("for p in l: _ = p._gp_().poliscyclo()")
5 loops, best of 3: 303 ms per loop
sage: lgp = [p._gp_() for p in l]
sage: timeit("for p in lgp: _ = p.poliscyclo()")
25 loops, best of 3: 34.8 ms per loop
```


> As an aside, isn't it a problem for a method named `is_cyclotomic()` to return an integer rather than a boolean? Of course, the certificate is interesting to have, and one can still test with `is_cyclotomic()` as before. It is just that I expect a method `is_...()` to return a boolean. Maybe I am wrong...

You are right. The best option would be:

```
def is_cyclotomic(self, certificate=False):
    ...
    return ans if certificate else bool(ans)
```



A compromise can be:
- add the keyword `certificate` (if it is `True` we use `self._gp_().polisyclco()`)
- do your initial suggested change
- add a `TODO` to the documentation to switch from gp to pari (and open a ticket for it). We will then consider the fact of making it the default.

Vincent


---

Comment by bruno created at 2015-02-04 15:52:03

Replying to [comment:12 vdelecroix]:
> A compromise can be:
> - add the keyword `certificate` (if it is `True` we use `self._gp_().polisyclco()`)
> - do your initial suggested change
> - add a `TODO` to the documentation to switch from gp to pari (and open a ticket for it). We will then consider the fact of making it the default.

I like this proposition, I'll do it.


---

Comment by git created at 2015-02-04 21:06:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-04 21:13:56

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-02-04 21:13:56

Just typographical comment. The `TODO` block must be indented. In other words

```
.. TODO::

    As soon as #XYZ is finished we should do blih and blah.
```

Have a look to [Docstring section of the developer manual](http://sagemath.org/doc/developer/coding_basics.html#docstring-markup-with-rest-and-sphinx).

It is `_gp_()` and not `__gp__()` (i.e. one underscore).

I would move the `._gp_().poliscyclo()` below the tests for characteristic.

Vincent


---

Comment by bruno created at 2015-02-04 21:16:23

I pushed too fast, and noticed my mistake on `__gp__()`. Actually, there are other ones. I'm correcting this.

Thanks anyway for the feedback, and especially for the documentation!


---

Comment by git created at 2015-02-04 21:40:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-02-04 21:41:11

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-02-04 22:00:53

One more thing for the doc: for trac tickets you should use `:trac:`17730``. That will create automatically a link in the compiled documentation.

More seriously, we definitely do *not* want to test irreducibility at the beginning. You can possibly add this test in between step 2 and 3. That would prevent some useless factorization. But if you do so, I want to see some benchmarks first.

Vincent


---

Comment by vdelecroix created at 2015-02-04 22:02:04

Changing status from needs_review to needs_work.


---

Comment by bruno created at 2015-02-04 22:14:28

Replying to [comment:19 vdelecroix]:
> One more thing for the doc: for trac tickets you should use `:trac:`17730``. That will create automatically a link in the compiled documentation.

OK.
 
> More seriously, we definitely do *not* want to test irreducibility at the beginning. You can possibly add this test in between step 2 and 3. That would prevent some useless factorization. But if you do so, I want to see some benchmarks first.

I do not understand your remark: irreducibility was tested as the first step before, and moving this test later is precisely the purpose of my ticket.


---

Comment by vdelecroix created at 2015-02-04 22:20:37

Replying to [comment:21 bruno]:
> > More seriously, we definitely do *not* want to test irreducibility at the beginning. You can possibly add this test in between step 2 and 3. That would prevent some useless factorization. But if you do so, I want to see some benchmarks first.
> 
> I do not understand your remark: irreducibility was tested as the first step before, and moving this test later is precisely the purpose of my ticket.

Right ;-) I will try a bit more optimization on my side.


---

Comment by git created at 2015-02-04 22:24:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-02-04 22:25:16

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-02-04 23:07:38

Actually, the factor at the end is overkill as we only want a square root. I did have a look at the method `.is_square()` and it was dirty enough to be slow. So I just make it simpler/clearer. The speedup is very small and concerns mostly positive cases.

I am happy with your commits. Just review mine.

Vincent
----
New commits:


---

Comment by bruno created at 2015-02-06 13:08:50

Replying to [comment:25 vdelecroix]:
> Actually, the factor at the end is overkill as we only want a square root. I did have a look at the method `.is_square()` and it was dirty enough to be slow. So I just make it simpler/clearer. The speedup is very small and concerns mostly positive cases.
> 
> I am happy with your commits. Just review mine.

I am fine with your commit too, but for one typo that I've corrected in the docstring of `is_square()`:

```diff
 def is_square(self, root=False):
"""
Returns whether or not polynomial is square. If the optional
- argument ``root`` is set to ``True, then also returns the square root
+ argument ``root`` is set to ``True``, then also returns the square root
(or ``None``, if the polynomial is not square).
```


I do not know whether it is acceptable for me to set "positive review". I let you do so if you consider everything's OK. Thanks for the patient feedback!
----
New commits:


---

Comment by chapoton created at 2015-02-06 20:26:05

Looks good to me. I have just made a few typographical changes, so I allow myself to put this into positive review.
----
New commits:


---

Comment by chapoton created at 2015-02-06 20:26:05

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-02-06 20:33:10

Ho great! Nice catch!

Vincent


---

Comment by vbraun created at 2015-02-18 08:53:14

Resolution: fixed
