# Issue 33610: Bug in h_star_vector for polytopes with the normaliz backend

Issue created by migration from https://trac.sagemath.org/ticket/33847

Original creator: yzh

Original creation time: 2022-05-12 21:43:39

CC:  @braunmath selia jipilab chapoton winfried vdelecroix mkoeppe

Keywords: polytopes, normaliz

Dr. Ben Braun reported the following error.

The h-star-vector records the coefficients of the polynomial in the
numerator of the Ehrhart series of a lattice polytope.
The method h_star_vector() for polytopes with the normaliz backend was implemented in #28413. 
The implementation seems to have an error, namely that it drops internal zeros from the vector.

Example:

```
sage: L = [[1, 0, 0, 0, 0, 0], [1, 1, 0, 0, 0, 0], [1, 0, 1, 0, 0, 0], [1, 0, 0,
....:  1, 0, 0], [1, 0, 0, 0, 1, 0], [1, 0, 0, 1, 2, 3]]
sage: P = Polyhedron(vertices=L,backend='normaliz')
sage: P.ehrhart_series().numerator()
2*t^2 + 1
sage: P.h_star_vector()
[1, 2]
```


Actually, the correct return should be `[1, 0, 2]`. 

This bug is caused by the line 1314 of `src/sage/geometry/polyhedron/backend_normaliz.py`, which forgets to pass `sparse=False` into `self.ehrhart_series().numerator().coefficients()`.

We fix the bug by changing this line to
`return self.ehrhart_series().numerator().list()`.


---

Comment by yzh created at 2022-05-12 21:59:53

New commits:


---

Comment by yzh created at 2022-05-12 21:59:53

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-05-13 00:10:02

Output is missing in the new doctest


---

Comment by mkoeppe created at 2022-05-13 00:10:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-13 05:27:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by yzh created at 2022-05-13 05:27:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2022-05-13 09:01:18

please fill the "Authors" box


---

Comment by yzh created at 2022-05-13 15:28:00

Patchbot reports one doctest failure, as follows. I'm not sure if it is related.

```
File "sage/parallel/map_reduce.py", line 1151, in sage.parallel.map_reduce.RESetMapReduce.start_workers
Failed example:
    all(not w.is_alive() for w in S._workers)
Expected:
    True
Got:
    False
```



---

Comment by mkoeppe created at 2022-05-13 15:36:18

unrelated, that's #33834


---

Comment by mkoeppe created at 2022-05-13 23:29:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-05-24 22:44:55

Resolution: fixed
