# Issue 25750: Sagemath translation problem with lambert_w when using Fricas and giac

Issue created by migration from Trac.

Original creator: @nasser1

Original creation time: 2018-08-02 02:53:49

CC:  rws slelievre

Keywords: lambert_w,fricas,giac


It does not look like Sagemath is translating lambert_w to Fricas and Giac syntax as I get an error when using fricas and giac but not with sympy.

in Fricas, lambert_w(x) is lambertW(x)

http://fricas.github.io/api/FunctionalSpecialFunction.html

Using  [SageMath](SageMath) version 8.3.rc2, Release Date: 2018-07-22


```
sage: var('x')
x
sage: integrate(lambert_w(x), x)
(lambert_w(x)^2 - lambert_w(x) + 1)*x/lambert_w(x)

sage: integrate(lambert_w(x), x,algorithm="fricas")
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-9-106b0d350e34> in <module>()
----> 1 integrate(lambert_w(x), x,algorithm="fricas")

/usr/lib/python2.7/site-packages/sage/misc/functional.py in integral(x, *args, **kwds)
    751     """
    752     if hasattr(x, 'integral'):
--> 753         return x.integral(*args, **kwds)
    754     else:
    755         from sage.symbolic.ring import SR

/usr/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:69759)()
  12364                     R = ring.SR
  12365             return R(integral(f, v, a, b, **kwds))
> 12366         return integral(self, *args, **kwds)
  12367 
  12368     integrate = integral

/usr/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)
    814         if not integrator:
    815             raise ValueError("Unknown algorithm: %s" % algorithm)
--> 816         return integrator(expression, v, a, b)
    817     if a is None:
    818         return indefinite_integral(expression, v, hold=hold)

/usr/lib/python2.7/site-packages/sage/symbolic/integration/external.py in fricas_integrator(expression, v, a, b, noPole)
    173 
    174     from sage.interfaces.fricas import fricas
--> 175     ex = fricas(expression)
    176 
    177     if a is None:

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    280             return cls(self, x, name=name)
    281         try:
--> 282             return self._coerce_from_special_method(x)
    283         except TypeError:
    284             raise

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in _coerce_from_special_method(self, x)
    306             s = '_gp_'
    307         try:
--> 308             return (x.__getattribute__(s))(self)
    309         except AttributeError:
    310             return self(x._interface_init_())

/usr/lib/python2.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._fricas_ (build/cythonized/sage/structure/sage_object.c:7729)()
    807             import sage.interfaces.fricas
    808             G = sage.interfaces.fricas.fricas
--> 809         return self._interface_(G)
    810 
    811     def _fricas_init_(self):

/usr/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._interface_ (build/cythonized/sage/symbolic/expression.cpp:7825)()
    792         if is_a_constant(self._gobj):
    793             return self.pyobject()._interface_(I)
--> 794         return super(Expression, self)._interface_(I)
    795 
    796     def _maxima_(self, session=None):

/usr/lib/python2.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5895)()
    741             except Exception:
    742                 raise NotImplementedError("coercion of object %s to %s not implemented:\n%s\n%s" % (repr(self), I))
--> 743         X = I(s)
    744         if c:
    745             try:

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    278 
    279         if isinstance(x, string_types):
--> 280             return cls(self, x, name=name)
    281         try:
    282             return self._coerce_from_special_method(x)

/usr/lib/python2.7/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1443             except (RuntimeError, ValueError) as x:
   1444                 self._session_number = -1
-> 1445                 raise_(TypeError, TypeError(*x.args), sys.exc_info()[2])
   1446             except BaseException:
   1447                 self._session_number = -1

/usr/lib/python2.7/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1438         else:
   1439             try:
-> 1440                 self._name = parent._create(value, name=name)
   1441             # Convert ValueError and RuntimeError to TypeError for
   1442             # coercion to work properly.

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    474     def _create(self, value, name=None):
    475         name = self._next_var_name() if name is None else name
--> 476         self.set(name, value)
    477         return name
    478 

/usr/lib/python2.7/site-packages/sage/interfaces/fricas.py in set(self, var, value)
    544         cmd = '%s%s%s;'%(var,self._assign_symbol(), value)
    545         output = self.eval(cmd, reformat=False)
--> 546         self._check_errors(value, output)
    547 
    548     def get(self, var):

/usr/lib/python2.7/site-packages/sage/interfaces/fricas.py in _check_errors(self, line, output)
    518             for old, new in replacements:
    519                 output = output.replace(old, new)
--> 520             raise RuntimeError("An error occurred when FriCAS evaluated '%s':\n%s" % (line, output))
    521 
    522         # or even an error

TypeError: An error occurred when FriCAS evaluated 'lambert_w(0,x)':
   There are no library operations named lambert_w 
      Use HyperDoc Browse or issue
                               )what op lambert_w
      to learn if there is any operation containing " lambert_w " in its 
      name.

 
   Cannot find a definition or applicable library operation named 
      lambert_w with argument type(s) 
                               NonNegativeInteger
                                  Variable(x)
      
      Perhaps you should use "`@`" to indicate the required return type, or 
      "$" to specify which version of the function you need.

```


And with GIAC: (I do not know if giac supports lambert_w)



```
sage: var('x')
x
sage: integrate(lambert_w(x), x, algorithm="giac")
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-ec332005d064> in <module>()
----> 1 integrate(lambert_w(x), x, algorithm="giac")

/usr/lib/python2.7/site-packages/sage/misc/functional.py in integral(x, *args, **kwds)
    751     """
    752     if hasattr(x, 'integral'):
--> 753         return x.integral(*args, **kwds)
    754     else:
    755         from sage.symbolic.ring import SR

/usr/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:69759)()
  12364                     R = ring.SR
  12365             return R(integral(f, v, a, b, **kwds))
> 12366         return integral(self, *args, **kwds)
  12367 
  12368     integrate = integral

/usr/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)
    814         if not integrator:
    815             raise ValueError("Unknown algorithm: %s" % algorithm)
--> 816         return integrator(expression, v, a, b)
    817     if a is None:
    818         return indefinite_integral(expression, v, hold=hold)

/usr/lib/python2.7/site-packages/sage/symbolic/integration/external.py in giac_integrator(expression, v, a, b)
    211     ex = expression._giac_()
    212     if a is None:
--> 213         result = ex.integrate(v._giac_())
    214     else:
    215         result = ex.integrate(v._giac_(), a._giac_(), b._giac_())

/usr/lib/python2.7/site-packages/sage/interfaces/giac.py in integral(self, var, min, max)
   1134         """
   1135         if min is None:
-> 1136             return giac('int(%s,%s)'%(self.name(),var))
   1137         else:
   1138             if max is None:

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    278 
    279         if isinstance(x, string_types):
--> 280             return cls(self, x, name=name)
    281         try:
    282             return self._coerce_from_special_method(x)

/usr/lib/python2.7/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1443             except (RuntimeError, ValueError) as x:
   1444                 self._session_number = -1
-> 1445                 raise_(TypeError, TypeError(*x.args), sys.exc_info()[2])
   1446             except BaseException:
   1447                 self._session_number = -1

/usr/lib/python2.7/site-packages/sage/interfaces/expect.py in __init__(self, parent, value, is_name, name)
   1438         else:
   1439             try:
-> 1440                 self._name = parent._create(value, name=name)
   1441             # Convert ValueError and RuntimeError to TypeError for
   1442             # coercion to work properly.

/usr/lib/python2.7/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    474     def _create(self, value, name=None):
    475         name = self._next_var_name() if name is None else name
--> 476         self.set(name, value)
    477         return name
    478 

/usr/lib/python2.7/site-packages/sage/interfaces/giac.py in set(self, var, value)
    643         """
    644         cmd = '%s:=%s:;'%(var,value)   #if giac is not in maple mode ( maple_mode(0))
--> 645         out = self.eval(cmd)
    646         if out.find("error") != -1:
    647             raise TypeError("Error executing code in Giac\nCODE:\n\t%s\nGiac ERROR:\n\t%s"%(cmd, out))

/usr/lib/python2.7/site-packages/sage/interfaces/giac.py in eval(self, code, strip, **kwds)
    627         if strip:
    628              code = code.replace("\n","").strip()
--> 629         ans = Expect.eval(self, code, strip=strip, **kwds).strip()
    630         return ans
    631 

/usr/lib/python2.7/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1352                 elif split_lines:
   1353                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1354                                         for L in code.split('\n') if L != ''])
   1355                 else:
   1356                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/usr/lib/python2.7/site-packages/sage/interfaces/giac.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    594                     wait_for_prompt=wait_for_prompt)
    595             if z.lower().find("error") != -1:
--> 596                 raise RuntimeError("An error occurred running a Giac command:\nINPUT:\n%s\nOUTPUT:\n%s"%(line, z))
    597         return z
    598 

TypeError: An error occurred running a Giac command:
INPUT:
sage2:=int(sage0,x):;
OUTPUT:
"Expression used like a function diff(lambert_w,1)
You should write subst(diff(lambert_w,1),lambert_w,0,x) Error: Bad Argument Value"
sage: 


```





---

Comment by mantepse created at 2018-08-03 12:22:14

No idea how to deal with giac...


---

Comment by mantepse created at 2018-08-03 12:22:14

Changing status from new to needs_review.


---

Comment by git created at 2018-08-03 17:00:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2018-08-05 10:17:50

Changing keywords from "lambert_w,fricas,giac" to "lambert_w, fricas, giac".


---

Comment by slelievre created at 2018-08-05 10:17:50

Bernard Parisse, the main developer of Giac, tells me the Lambert W function
is not implemented in Giac at this point.


---

Comment by mantepse created at 2018-08-05 10:44:43

OK, so could you review this ticket for the FriCAS part?


---

Comment by chapoton created at 2018-08-20 18:37:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-08-20 18:37:52

branch does not apply


---

Comment by git created at 2018-08-20 20:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-08-20 20:22:14

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-08-22 07:57:00

ok, let it be


---

Comment by chapoton created at 2018-08-22 07:57:00

Changing status from needs_review to positive_review.


---

Comment by git created at 2018-08-22 09:57:18

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-08-22 09:57:18

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mantepse created at 2018-08-22 13:41:58

sorry about that, Frédéric...

Besides, my local pyflakes does not report `src/sage/interfaces/fricas.py:965: undefined name 'long'`


---

Comment by chapoton created at 2018-08-22 14:14:01

the "long" is because pyflakes is running python3..


---

Comment by chapoton created at 2018-08-22 14:14:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-30 23:32:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-08-30 23:32:50

merge conflict


---

Comment by git created at 2018-09-02 09:40:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-09-02 09:40:50

trivial rebase


---

Comment by mantepse created at 2018-09-02 09:41:03

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-09-02 12:32:15

ok


---

Comment by chapoton created at 2018-09-02 12:32:15

Changing status from needs_review to positive_review.


---

Comment by git created at 2018-09-02 19:50:29

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-09-02 19:50:29

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mantepse created at 2018-09-02 19:52:16

I'm sorry Frederic, I forgot another one...


---

Comment by chapoton created at 2018-09-02 19:53:03

indeed..


---

Comment by chapoton created at 2018-09-02 19:53:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-05 16:43:33

Resolution: fixed
