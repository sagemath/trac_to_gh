# Issue 10093: cython and C++

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2010-10-07 12:23:57

Assignee: tbd

CC:  robertwb leif jason craigcitro timdumol mpatel

I still can't build C++ cython modules, even though it should be possible with the cython-0.13. 

```
python `which cython` --embed-positions --directive cdivision=True,autotestdict=False -I/home/vbraun/opt/sage-4.5.3/devel/sage-main -o sage/geometry/ppl.cpp sage/geometry/ppl.pyx

Error converting Pyrex file to C:
------------------------------------------------------------
...
    """   

    cdef Variable *thisptr
      
    def __cinit__(self, dimension_type i):
        thisptr = new Variable(i)
                     ^
------------------------------------------------------------

/home/vbraun/opt/sage-4.5.3/devel/sage-main/sage/geometry/ppl.pyx:19:22: Operation only allowed in c++
```

The problem seems to be that cython expects `--cplus` to enable the new language features. Cython does not derive this from the output file name extension ('cpp').

I've written the obvious patch to `setup.py`, see attachment.


---

Comment by vbraun created at 2010-10-07 12:26:42

Initial patch


---

Attachment


```
python `which cython` --cplus --embed-positions --directive cdivision=True,autotestdict=False -I/home/vbraun/opt/sage-4.5.3/devel/sage-main -o sage/rings/finite_rings/element_givaro.cpp sage/rings/finite_rings/element_givaro.pyx

Error converting Pyrex file to C:
------------------------------------------------------------
...
                    modulus.append(0)
            
        if is_Polynomial(modulus):
            modulus = modulus.list()

        if PY_TYPE_CHECK(modulus, list) or PY_TYPE_CHECK(modulus, tuple):
                       ^
------------------------------------------------------------

/home/vbraun/opt/sage-4.5.3/devel/sage-main/sage/rings/finite_rings/element_givaro.pyx:264:24: ambiguous overloaded method
```

Givaro, one of the C++ extension modules, is very unhappy about `cython --cplus`.


---

Comment by vbraun created at 2010-10-07 13:13:53

Changing status from new to needs_review.


---

Comment by vbraun created at 2010-10-07 13:13:53

The problem is this snippet from `element_givaro.pyx`, where `PY_TYPE_CHECK` is declared a second time. It is then ambiguous with its first declaration.

```
cdef extern from "stdsage.h":
    [...]
    int PY_TYPE_CHECK(object o, object t)
```

Removing this one line works, patch attached. I did a `sage -ba` and had no more troubles.


---

Attachment

Initial patch


---

Comment by vbraun created at 2010-10-07 15:19:45

Final patch for minor doctest breakage. The two doctests fixes to `sageinspect.py` also need to be applied to `local/lib/python2.6/site-packages/sagenb-0.8.2-py2.6.egg/sagenb/misc/sageinspect.py`. I'll put a corresponding comment on #10036.


---

Comment by vbraun created at 2010-10-07 15:20:18

Initial patch


---

Attachment

The colormaps doctest is fixed in the patch on the matplotlib upgrade ticket, and shouldn't be included in this patch (it is already merged).


---

Comment by jason created at 2010-10-07 15:47:08

Should we apply all three patches?


---

Comment by jason created at 2010-10-07 15:52:11

I think the sagenb issue is already fixed as well: http://trac.sagemath.org/sage_trac/attachment/ticket/9828/trac_9828-sagenb_cython_0_13.patch


---

Comment by jason created at 2010-10-07 15:55:04

So I guess my point is that trac_10094_fix_doctests.patch is not needed, as those fixes are already merged on #10036 (the notebook issue) and the matplotlib upgrade to 1.0.


---

Comment by vbraun created at 2010-10-07 15:59:47

Oh, I didn't know that the doctest fixes are already included elsewhere. So, just to be sure, apply
  1. `trac_10094_add_cplus_command_line_option.patch`
  2. `trac_10094_fix_givaro.patch`


---

Comment by jason created at 2010-10-07 16:19:19

robertwb: can you comment on this ticket?  Does --cplus switch on the capability, or does it force c++ generation (i.e., should --cplus be enabled for all files??)


---

Comment by jason created at 2010-10-07 16:20:27

Can you not just declare the language to be c++ in the module_list.py file, instead of modifying the command-line switch for everything?


---

Comment by jason created at 2010-10-07 16:22:16

In fact, it seems that lots of modules in module_list.py already switch on the C++ features by doing language="c++"


---

Comment by vbraun created at 2010-10-07 16:45:55

Initially I of course used `language="c++"`, this does not work. If you look at the original patch, all that does is switch the output file name extension to `cpp`. And cython then still relies on the `--cplus` switch. I don't know if thats a cython bug or intentional design. Robert, you should be able to tell us?

Also, note that the patch only adds `--cplus` if `language="c++"` in `module_list.py`


---

Comment by jason created at 2010-10-07 16:49:20

Replying to [comment:12 vbraun]:


> 
> Also, note that the patch only adds `--cplus` if `language="c++"` in `module_list.py`


Okay, thanks for the clarification.


---

Comment by robertwb created at 2010-10-07 20:03:45

The --cplus is needed to use C++ features in the Cython file, and language="c++" is needed to invoke the C++ compiler. We should not enable --cplus for all files, as it may (now or in the future) emit C++ code. The reason we need to specify the flag manually is that we're manually invoking Cython (for good reason) rather than trying to let distutils do it for us. I thought, however, that this setting would be inferred from the output file extension, apparently not (yet/anymore?).

In any case, positive review to trac_10094_add_cplus_command_line_option.patch


---

Comment by jdemeyer created at 2010-11-01 23:07:11

Patches `trac_10094_fix_givaro.patch` and `trac_10094_fix_doctests.patch` give patch errors.  I will check to see whether they are still needed.


---

Comment by vbraun created at 2010-11-02 01:42:23

The givaro patch is obsoleted by #10089 which removed even more unnecessary includes.


---

Attachment

Updated doctest patch


---

Comment by jdemeyer created at 2010-11-02 12:02:29

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2010-11-02 15:28:14

Can somebody review 10094_fix_doctests.2.patch, then we have a full positive_review.


---

Comment by jdemeyer created at 2010-11-02 15:28:14

Changing status from needs_work to needs_review.


---

Comment by robertwb created at 2010-11-03 08:10:46

10094_fix_doctests.2.patch looks good to me.


---

Comment by robertwb created at 2010-11-03 08:10:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2010-11-10 22:20:47

Resolution: fixed
