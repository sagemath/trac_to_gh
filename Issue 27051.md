# Issue 27051: Docker images for Sage missing make

Issue created by migration from https://trac.sagemath.org/ticket/27288

Original creator: embray

Original creation time: 2019-02-15 10:18:18

CC:  saraedum cremona slelievre

For some reason the official `sagemath/sagemath` images don't include `make`, which at a minimum is necessary for installing optional packages within the image (which should be considered essential functionality).


---

Comment by embray created at 2019-02-15 10:23:51

Changing status from new to needs_review.


---

Comment by embray created at 2019-02-15 10:23:51

I think this should do it.

Some optional packages _might_ require some additional system packages (e.g. some `-dev` packages), but most don't.  So those cases can be considered on a case-by-case basis.
----
New commits:


---

Comment by saraedum created at 2019-02-15 10:54:51

I am not sure that this is going to fix it. As I recall, the docker image has been stripped of too much already.

Have you already tried to test this?


---

Comment by saraedum created at 2019-02-15 10:55:02

Changing status from needs_review to needs_info.


---

Comment by embray created at 2019-02-15 11:27:12

Changing status from needs_info to needs_work.


---

Comment by embray created at 2019-02-15 11:27:12

Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.


---

Comment by embray created at 2019-02-15 11:27:48

I made this work at some point for the Windows installer, so it's perfectly do-able, without adding too much additional stuff.


---

Comment by saraedum created at 2019-02-15 11:32:57

Replying to [comment:4 embray]:
> Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.

Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…


---

Comment by cremona created at 2019-02-15 14:56:29

Replying to [comment:6 saraedum]:
> Replying to [comment:4 embray]:
> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.
> 
> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…

Yes please!  Without this I would lose all capability of putting notebooks on binder since I use various optional packages (including database_cremona_ellcurve but not only that).  In the case of that database all the install script does is to copy one file into SAGE_SHARE/cremona so I could fake it.


---

Comment by embray created at 2019-02-20 13:48:34

Replying to [comment:6 saraedum]:
> Replying to [comment:4 embray]:
> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.
> 
> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…

I understand this of course. A couple years ago I would have been making the same argument, and in fact I think I even did have discussions like this with Nicolas where he and I disagreed, when I was first putting together my version of the Docker image for Sage.

In retrospect, however, many many users in the Sage community consider being able to run `sage -i` to be essential functionality, and indeed there have been many cases where not being able to do so was a huge hurdle (b.c. for example they would be teaching some topic-specific workshop that requires some optional packages, and people using the Docker images would be screwed).

It sucks to have to include some of the build toolchain in the Docker images in order to support this, but I would consider it essential, especially for the main "sagemath/sagemath" images.


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by saraedum created at 2019-04-05 19:55:32

Sorry for the late reply. If people need more than `sage -pip`, then they should use `sage-dev`. If that's not clear from the documentation, we should fix that. Otherwise, where do you draw the line? Should every `sage -i` work? Then you need `sage-dev` or am I getting this wrong?


---

Comment by embray created at 2019-04-08 16:17:13

Perhaps you could clarify the difference implied in `sage-dev`.

E.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has _some_ chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.

It also includes a few bare-minimum build dependencies.

It does _not_ imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least _attempting_ to build/install the package will work.

One thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors.


---

Comment by saraedum created at 2019-04-08 17:24:10

Replying to [comment:11 embray]:
> Perhaps you could clarify the difference implied in `sage-dev`.
Do you mean that I should improve the documentation on the docker hub pages?

> E.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has _some_ chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.
> 
> It also includes a few bare-minimum build dependencies.
> 
> It does _not_ imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least _attempting_ to build/install the package will work.
If it's small I would not mind adding it too much of course.

> One thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors. 
I see the point of this of course but it feels like [SageMath](SageMath) would not only try to be Gentoo (allowing to build from source everywhere) but now also Conda (allowing installation of relocatable packages.) Or do you just want this for the docker images? I am not sure this is a good way forward as it means lots of maintenance & support to keep it working nicely. I think it would be much easier in the long run to just package things for conda and use that to phase out SPKGs eventually. You can still build conda recipes from source but most people will be happy to be able to just use binaries. The main missing bits here are some failing doctests and the missing cygwin build of conda but both could be fixed if someone focused on this for a while.

Maybe this discussion should not be had here but on Zulip instead. Feel free to open a thread there if you want to discuss packaging further :)


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by slelievre created at 2019-09-16 00:00:43

Changing keywords from "" to "docker, optional packages".


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-05 19:14:43

See also: #29124 - which collects lists of recommended system packages - which should probably be made available in Docker builds


---

Comment by mkoeppe created at 2020-05-05 19:15:25

(which would also take care of #29153 - Docker images do not contain pandoc)


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by saraedum created at 2021-12-09 00:04:05

Changing component from distribution to docker.
