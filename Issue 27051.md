# Issue 27051: Docker images for Sage missing make

archive/issues_027051.json:
```json
{
    "body": "CC:  @saraedum @JohnCremona @slel\n\nFor some reason the official `sagemath/sagemath` images don't include `make`, which at a minimum is necessary for installing optional packages within the image (which should be considered essential functionality).\n\nIssue created by migration from https://trac.sagemath.org/ticket/27288\n\n",
    "created_at": "2019-02-15T10:18:18Z",
    "labels": [
        "distribution",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Docker images for Sage missing make",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27051",
    "user": "@embray"
}
```
CC:  @saraedum @JohnCremona @slel

For some reason the official `sagemath/sagemath` images don't include `make`, which at a minimum is necessary for installing optional packages within the image (which should be considered essential functionality).

Issue created by migration from https://trac.sagemath.org/ticket/27288





---

archive/issue_comments_381064.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-15T10:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381064",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_381065.json:
```json
{
    "body": "I think this should do it.\n\nSome optional packages *might* require some additional system packages (e.g. some `-dev` packages), but most don't.  So those cases can be considered on a case-by-case basis.\n----\nNew commits:",
    "created_at": "2019-02-15T10:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381065",
    "user": "@embray"
}
```

I think this should do it.

Some optional packages *might* require some additional system packages (e.g. some `-dev` packages), but most don't.  So those cases can be considered on a case-by-case basis.
----
New commits:



---

archive/issue_comments_381066.json:
```json
{
    "body": "I am not sure that this is going to fix it. As I recall, the docker image has been stripped of too much already.\n\nHave you already tried to test this?",
    "created_at": "2019-02-15T10:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381066",
    "user": "@saraedum"
}
```

I am not sure that this is going to fix it. As I recall, the docker image has been stripped of too much already.

Have you already tried to test this?



---

archive/issue_comments_381067.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-02-15T10:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381067",
    "user": "@saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_381068.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-02-15T11:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381068",
    "user": "@embray"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_381069.json:
```json
{
    "body": "Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.",
    "created_at": "2019-02-15T11:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381069",
    "user": "@embray"
}
```

Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.



---

archive/issue_comments_381070.json:
```json
{
    "body": "I made this work at some point for the Windows installer, so it's perfectly do-able, without adding too much additional stuff.",
    "created_at": "2019-02-15T11:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381070",
    "user": "@embray"
}
```

I made this work at some point for the Windows installer, so it's perfectly do-able, without adding too much additional stuff.



---

archive/issue_comments_381071.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.\n\nYes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs\u2026",
    "created_at": "2019-02-15T11:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381071",
    "user": "@saraedum"
}
```

Replying to [comment:4 embray]:
> Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.

Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…



---

archive/issue_comments_381072.json:
```json
{
    "body": "Replying to [comment:6 saraedum]:\n> Replying to [comment:4 embray]:\n> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.\n> \n> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs\u2026\n\nYes please!  Without this I would lose all capability of putting notebooks on binder since I use various optional packages (including database_cremona_ellcurve but not only that).  In the case of that database all the install script does is to copy one file into SAGE_SHARE/cremona so I could fake it.",
    "created_at": "2019-02-15T14:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381072",
    "user": "@JohnCremona"
}
```

Replying to [comment:6 saraedum]:
> Replying to [comment:4 embray]:
> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.
> 
> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…

Yes please!  Without this I would lose all capability of putting notebooks on binder since I use various optional packages (including database_cremona_ellcurve but not only that).  In the case of that database all the install script does is to copy one file into SAGE_SHARE/cremona so I could fake it.



---

archive/issue_comments_381073.json:
```json
{
    "body": "Replying to [comment:6 saraedum]:\n> Replying to [comment:4 embray]:\n> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.\n> \n> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs\u2026\n\nI understand this of course. A couple years ago I would have been making the same argument, and in fact I think I even did have discussions like this with Nicolas where he and I disagreed, when I was first putting together my version of the Docker image for Sage.\n\nIn retrospect, however, many many users in the Sage community consider being able to run `sage -i` to be essential functionality, and indeed there have been many cases where not being able to do so was a huge hurdle (b.c. for example they would be teaching some topic-specific workshop that requires some optional packages, and people using the Docker images would be screwed).\n\nIt sucks to have to include some of the build toolchain in the Docker images in order to support this, but I would consider it essential, especially for the main \"sagemath/sagemath\" images.",
    "created_at": "2019-02-20T13:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381073",
    "user": "@embray"
}
```

Replying to [comment:6 saraedum]:
> Replying to [comment:4 embray]:
> > Apparently it's worse than that.  The `Makefile` and all the tools under `build/` are stripped out of the non-dev image as well.  Unfortunately these bits are necessary (and not so large size-wise) for installing optional packages.
> 
> Yes, this was completely on purpose. The docker image was meant to be absolutely minimal. We might want to think about a third flavour that supports spkg installs…

I understand this of course. A couple years ago I would have been making the same argument, and in fact I think I even did have discussions like this with Nicolas where he and I disagreed, when I was first putting together my version of the Docker image for Sage.

In retrospect, however, many many users in the Sage community consider being able to run `sage -i` to be essential functionality, and indeed there have been many cases where not being able to do so was a huge hurdle (b.c. for example they would be teaching some topic-specific workshop that requires some optional packages, and people using the Docker images would be screwed).

It sucks to have to include some of the build toolchain in the Docker images in order to support this, but I would consider it essential, especially for the main "sagemath/sagemath" images.



---

archive/issue_comments_381074.json:
```json
{
    "body": "Moving all my in-progress tickets to 8.8 milestone.",
    "created_at": "2019-03-25T10:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381074",
    "user": "@embray"
}
```

Moving all my in-progress tickets to 8.8 milestone.



---

archive/issue_comments_381075.json:
```json
{
    "body": "Sorry for the late reply. If people need more than `sage -pip`, then they should use `sage-dev`. If that's not clear from the documentation, we should fix that. Otherwise, where do you draw the line? Should every `sage -i` work? Then you need `sage-dev` or am I getting this wrong?",
    "created_at": "2019-04-05T19:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381075",
    "user": "@saraedum"
}
```

Sorry for the late reply. If people need more than `sage -pip`, then they should use `sage-dev`. If that's not clear from the documentation, we should fix that. Otherwise, where do you draw the line? Should every `sage -i` work? Then you need `sage-dev` or am I getting this wrong?



---

archive/issue_comments_381076.json:
```json
{
    "body": "Perhaps you could clarify the difference implied in `sage-dev`.\n\nE.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has *some* chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.\n\nIt also includes a few bare-minimum build dependencies.\n\nIt does *not* imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least *attempting* to build/install the package will work.\n\nOne thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors.",
    "created_at": "2019-04-08T16:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381076",
    "user": "@embray"
}
```

Perhaps you could clarify the difference implied in `sage-dev`.

E.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has *some* chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.

It also includes a few bare-minimum build dependencies.

It does *not* imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least *attempting* to build/install the package will work.

One thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors.



---

archive/issue_comments_381077.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> Perhaps you could clarify the difference implied in `sage-dev`.\nDo you mean that I should improve the documentation on the docker hub pages?\n\n> E.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has *some* chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.\n> \n> It also includes a few bare-minimum build dependencies.\n> \n> It does *not* imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least *attempting* to build/install the package will work.\nIf it's small I would not mind adding it too much of course.\n\n> One thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors. \nI see the point of this of course but it feels like [SageMath](SageMath) would not only try to be Gentoo (allowing to build from source everywhere) but now also Conda (allowing installation of relocatable packages.) Or do you just want this for the docker images? I am not sure this is a good way forward as it means lots of maintenance & support to keep it working nicely. I think it would be much easier in the long run to just package things for conda and use that to phase out SPKGs eventually. You can still build conda recipes from source but most people will be happy to be able to just use binaries. The main missing bits here are some failing doctests and the missing cygwin build of conda but both could be fixed if someone focused on this for a while.\n\nMaybe this discussion should not be had here but on Zulip instead. Feel free to open a thread there if you want to discuss packaging further :)",
    "created_at": "2019-04-08T17:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381077",
    "user": "@saraedum"
}
```

Replying to [comment:11 embray]:
> Perhaps you could clarify the difference implied in `sage-dev`.
Do you mean that I should improve the documentation on the docker hub pages?

> E.g. for the Windows distribution I strip out almost all build artifacts that are unneeded at runtime.  But so that `sage -i` has *some* chance of succeeding I added back in files like `configure`, `Makefile`, and the entire `build/` directory.  This adds very little to the overall package size.
> 
> It also includes a few bare-minimum build dependencies.
> 
> It does *not* imply that all `sage -i` will work out-of-the-box, as some of those have build dependencies that are not a normal part of the distribution.  But in those cases at least *attempting* to build/install the package will work.
If it's small I would not mind adding it too much of course.

> One thing I want to start having (which was always part of the motivation of #22509) is binary packages, at least for optional dependencies, so that `sage -i` can simply download them from the appropriate source mirror (if a binary tarball exists for the current platform), and unpack it into place.  Then no build crud is necessary.  That's a way's off though.  Adding support for this would be relatively easy to code, but we'd need the additional infrastructure to build binary tarballs for optional packages and upload them to the mirrors. 
I see the point of this of course but it feels like [SageMath](SageMath) would not only try to be Gentoo (allowing to build from source everywhere) but now also Conda (allowing installation of relocatable packages.) Or do you just want this for the docker images? I am not sure this is a good way forward as it means lots of maintenance & support to keep it working nicely. I think it would be much easier in the long run to just package things for conda and use that to phase out SPKGs eventually. You can still build conda recipes from source but most people will be happy to be able to just use binaries. The main missing bits here are some failing doctests and the missing cygwin build of conda but both could be fixed if someone focused on this for a while.

Maybe this discussion should not be had here but on Zulip instead. Feel free to open a thread there if you want to discuss packaging further :)



---

archive/issue_comments_381078.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381078",
    "user": "@embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_381079.json:
```json
{
    "body": "Changing keywords from \"\" to \"docker, optional packages\".",
    "created_at": "2019-09-16T00:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381079",
    "user": "@slel"
}
```

Changing keywords from "" to "docker, optional packages".



---

archive/issue_comments_381080.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381080",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_381081.json:
```json
{
    "body": "See also: #29124 - which collects lists of recommended system packages - which should probably be made available in Docker builds",
    "created_at": "2020-05-05T19:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381081",
    "user": "@mkoeppe"
}
```

See also: #29124 - which collects lists of recommended system packages - which should probably be made available in Docker builds



---

archive/issue_comments_381082.json:
```json
{
    "body": "(which would also take care of #29153 - Docker images do not contain pandoc)",
    "created_at": "2020-05-05T19:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381082",
    "user": "@mkoeppe"
}
```

(which would also take care of #29153 - Docker images do not contain pandoc)



---

archive/issue_comments_381083.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381083",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_381084.json:
```json
{
    "body": "Changing component from distribution to docker.",
    "created_at": "2021-12-09T00:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27051#issuecomment-381084",
    "user": "@saraedum"
}
```

Changing component from distribution to docker.
