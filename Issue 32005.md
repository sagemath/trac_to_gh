# Issue 32005: Use GNU Info (new package) to parse singular's Info file

Issue created by migration from https://trac.sagemath.org/ticket/32242

Original creator: mjo

Original creation time: 2021-07-19 17:39:59

In the description of #29024, a few problems are listed as prerequisites for accepting a system installation of Singular. Basically, they ask that we either use singular in a less crazy manner, or find a way to make our existing hacks work with a system copy of singular.

One of those issues is that the `sage/interfaces/singular.py` is using an environment variable `SINGULARPATH` to guess at the location where Singular's Info file is installed, so that it can be manually parsed.

In the interest of using Singular in a less crazy manner, I propose we add the standalone GNU "info" as a new package, and use it to read Singular's documentation from wherever it is configured to do so. This eliminates two of the problems in #29024.


---

Comment by mjo created at 2021-07-19 17:41:31

New commits:


---

Comment by mjo created at 2021-07-19 17:41:31

Changing status from new to needs_review.


---

Comment by git created at 2021-07-19 17:42:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-07-19 18:33:07

I don't know... shouldn't there be a feature request / PR to Singular to make the docstrings available via API?


---

Comment by mjo created at 2021-07-19 18:41:18

Singular renders its own interactive help using "info" or one of its alternatives: https://www.singular.uni-kl.de/Manual/latest/sing_16.htm

I don't think they can give us an API without making "info" a dependency of Singular itself.


---

Comment by mkoeppe created at 2021-07-19 19:23:44

OK I see.

I still don't get why it's necessary or helpful to replace our parser with calling the `info` program. 

Wouldn't it be much easier to just obtain the help file location from Singular itself?


---

Comment by mkoeppe created at 2021-07-19 19:28:03

I would also think it's pretty problematic from the viewpoint of modularization. We may soon have a pip-installable package for the Sage functionality that uses Singular. The wheel could then vendor `libsingular`. But vendoring the `info` program? That would be rather strange.


---

Comment by mjo created at 2021-07-19 19:40:59

Replying to [comment:5 mkoeppe]:
> OK I see.
> 
> I still don't get why it's necessary or helpful to replace our parser with calling the `info` program. 

The interface gets a lot smaller and simpler.


> Wouldn't it be much easier to just obtain the help file location from Singular itself?

Singular does know where it lives, but how do you propose we get it? Ask them to add a special command-line option to support our outlandish use case?


---

Comment by mjo created at 2021-07-19 19:45:59

Replying to [comment:6 mkoeppe]:
> I would also think it's pretty problematic from the viewpoint of modularization. We may soon have a pip-installable package for the Sage functionality that uses Singular. The wheel could then vendor `libsingular`. But vendoring the `info` program? That would be rather strange.

Leave it as part of the main Sage package, assumed to be there by the Singular wheel? In almost all cases, the system Info will be used anyway. But I don't really know enough about what you're trying to do to make a good suggestion.


---

Comment by mkoeppe created at 2021-07-19 20:10:17

Replying to [comment:7 mjo]:
> Singular does know where it lives, but how do you propose we get it?

Use `feGetResource` in libsingular_resources?


---

Comment by mjo created at 2021-07-19 20:28:03

Replying to [comment:9 mkoeppe]:
> Replying to [comment:7 mjo]:
> > Singular does know where it lives, but how do you propose we get it?
> 
> Use `feGetResource` in libsingular_resources?

Looks like it will work, thanks. I still think it's kinda dumb to poorly reimplement a ubiquitous 300k tool in math software, but it's good to know that we can find the help file if we really need to.


---

Comment by mkoeppe created at 2021-07-19 20:38:16

info is a well-documented, stable, extremely simple file format, I don't think there's anything wrong with doing basic parsing on it in Python.


---

Comment by mjo created at 2021-07-19 20:50:29

Well, we don't really parse it. It's more like a grep:


```
sage: from sage.interfaces.singular import get_docstring                        
sage: get_docstring("Preface")
```


will dutifully pull up the "Preface" node without regard for where in the manual it lives (it's not a function that we wrap and should throw a `KeyError` instead). The current branch oversimplifies a bit here too, checking only that the parent node is "Functions", but you can pass a series of (sub)nodes to `info` to ensure that you're navigating to where you think you are.

It looks like we also install info files for maxima and giac. So not only would having "info" installed allow you to run the interactive help in a `singular_console()`, but it may help somebody read the maxima and giac docs, too.


---

Comment by mkoeppe created at 2021-07-19 21:41:19

I don't really have an objection to adding `info` as a package. Accessing the interactive help in the standalone giac, maxima, singular shipped with Sage is a nice-to-have feature; but I don't think this is a strong argument to making it a "standard" package.

However, I don't support replacing the in-Python code (no issues have been reported with it -- no matter how primitive the code may be) by calling out to the `info` program. This adds a complication that I would really hope to avoid.


---

Comment by mjo created at 2021-07-19 23:08:25

Conversely, I'm only willing to tolerate the new dependency if it eliminates these hacks. It may be true that no issues have been reported with the info parser, but how long have we been waiting for someone to write an spkg-configure.m4 for singular? The only reason no one has done it (singular has a pc file, and is a huge, slow-to-build package) is because everyone is afraid to step into a pile of shit when they open singular.py{,x} =)

Replacing the cruft is its own reward if it makes maintaining the singular interface easier. I'm  unhappy about the dependency myself, but who does it really hurt? Doing _something_ about `SINGULARPATH` is necessary before we can use Singular from the system. Using GNU Info to read the info file is an easy and principled way to get us to a point where everyone on Fedora, Debian, Gentoo, Homebrew, Conda, Nix, etc. can just use Singular (and Info) from their package manager. That's a big gain for what constitutes almost the entirety of our users. And who is penalized by having Info be a standard package? Maybe some BSD installs that aren't currently supported platforms? This should be something like bzip2 that no one ever builds.


---

Comment by mkoeppe created at 2021-07-19 23:13:01

Replying to [comment:14 mjo]:
> who is penalized by having Info be a standard package? 

There is no problem with making `info` a standard package.

But there is a problem in adding an additional non-Python runtime dependency to the Sage library. `info` cannot be installed by `pip`.


---

Comment by mkoeppe created at 2021-07-19 23:59:05

Replying to [comment:14 mjo]:
> how long have we been waiting for someone to write an spkg-configure.m4 for singular? 
This task was waiting for the stalled Singular upgrade ticket #25993.


---

Comment by mjo created at 2021-07-20 11:40:05

One final point for GNU Info:

The Singular manual is now 11MB in singular-4.2.1. The existing implementation loads the entire thing (not just the function documentation, as I've shown) into a global variable that lives forever. This permanently wastes roughly the same amount of memory:


```
sage: from sage.interfaces.singular import generate_docstring_dictionary        
sage: get_memory_usage()                                                        
6467.30859375
sage: generate_docstring_dictionary()                                           
sage: get_memory_usage()                                                        
6479.34765625
```


And that will get worse as the Singular manual grows.


---

Comment by mkoeppe created at 2021-07-20 16:15:47

By the way, this ticket does not solve the original problem at all. If we want to use system Singular on a system that does not have `info`, then the installed `info` from the proposed SPKG does not have information regarding the info file location. So you are only shifting the problem of locating the info file from runtime to build time; *and* you are introducing a new non-Python dependency for the sagelib runtime.


---

Comment by mjo created at 2021-07-20 16:33:17

Replying to [comment:18 mkoeppe]:
> By the way, this ticket does not solve the original problem at all. If we want to use system Singular on a system that does not have `info`, then the installed `info` from the proposed SPKG does not have information regarding the info file location. So you are only shifting the problem of locating the info file from runtime to build time; *and* you are introducing a new non-Python dependency for the sagelib runtime.

While it's possible to put the info files _anywhere_, we can stick a colon on the end of `$INFOPATH` to have the SPKG try the default list as fallbacks: https://git.savannah.gnu.org/cgit/texinfo.git/tree/info/filesys.h#n70

If we manage to find a system that both doesn't have GNU Info and yet still goes out of its way to install info files in a crazy location... then I guess at that point we could use DEPCHECK to ensure that the Singular SPKG gets built on that system.


---

Comment by mkoeppe created at 2021-07-20 16:36:55

Sorry, overall this ticket looks like a solution in search of a problem, and one that will create new problems as a side effect.

The actual problem has a simple solution, comment:9.


---

Comment by mjo created at 2021-07-20 16:39:04

We could always make GNU Info an optional package, and take the same approach to


```
sage: singular.<function>?
```


that we take to


```
sage: singular_console()
> help <function>;
```


That is, it doesn't work unless you have Info installed. The docstring for the sage object would suggest the optional package if it's not available.


---

Comment by mjo created at 2021-07-20 16:40:33

Replying to [comment:20 mkoeppe]:
> Sorry, overall this ticket looks like a solution in search of a problem, and one that will create new problems as a side effect.
> 
> The actual problem has a simple solution, comment:9.
> 

This is only a solution if you insist on keeping our lame python implementation and all of the problems it comes with. It'll get the job done, but I won't be the one to do it.


---

Comment by git created at 2021-07-20 17:00:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-24 18:47:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-29 22:06:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-07-29 22:25:46

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-07-29 22:25:46

New commits:


---

Comment by mjo created at 2021-07-29 22:27:44

It's now completely optional. When "info" is not installed, you'll be prodded to install it:


```
sage: singular.align?                                                           
Signature:   singular.align(*args, **kwds)
Type:        SingularFunction
String form: align
File:        ~/src/sage.git/local/lib/python3.9/site-packages/sage/interfaces/singular.py
Docstring:  
This function is an automatically generated pexpect wrapper around the
Singular function 'align'.

EXAMPLES:

   sage: groebner = singular.groebner
   sage: P.<x, y> = PolynomialRing(QQ)
   sage: I = P.ideal(x^2-y, y+x)
   sage: groebner(singular(I))
   x+y,
   y^2-y

The relevant Singular documentation will be shown here if you install
GNU Texinfo, the stand-alone GNU Info program, or the SageMath "info"
SPKG.
```



---

Comment by mkoeppe created at 2021-08-01 21:08:30

I have opened #32323 for the uncontroversial part "Add GNU info as an optional package".


---

Comment by git created at 2021-12-02 00:59:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
